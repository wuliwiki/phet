// Copyright 2022, University of Colorado Boulder

/**
 * To test connecting to a bluetooth device using web bluetooth. Note this uses Promises (as the
 * bluetooth API works with promises) which is very unusual for simulation code.
 *
 * Prototype code for upcoming student studies, see https://github.com/phetsims/ratio-and-proportion/issues/473
 */

import ratioAndProportion from '../../ratioAndProportion.js';
import TextPushButton from '../../../../sun/js/buttons/TextPushButton.js';
import Utils from '../../../../dot/js/Utils.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import Property from '../../../../axon/js/Property.js';
import RatioTerm from '../model/RatioTerm.js';
import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import StationaryValueTracker from './StationaryValueTracker.js';
import optionize from '../../../../phet-core/js/optionize.js';
import RAPQueryParameters from '../RAPQueryParameters.js';
import PatternStringProperty from '../../../../axon/js/PatternStringProperty.js';
const FONT = new PhetFont({
  size: 16,
  weight: 'bold'
});

// in ms
const TIME_INTERACTED_WITH_MEMORY = 2000;

// Likely can be improved, but we don't have this in the main browser typing.

class RatioAndProportionBluetoothButton extends TextPushButton {
  isBeingInteractedWithProperty = new BooleanProperty(false);
  lastTimeInteractedWith = 0;
  stationaryTracker = new StationaryValueTracker({
    historyLength: RAPQueryParameters.bluetoothHistoryLength,
    stationaryThreshold: RAPQueryParameters.bluetoothStationaryThreshold
  });
  isStationaryProperty = this.stationaryTracker.isStationaryProperty; // pull it out for the public API

  constructor(tupleProperty, ratioTerm, providedOptions) {
    // When next here, we can handle when device does not support bluetooth with bluetooth.getAvailability. https://github.com/phetsims/ratio-and-proportion/issues/473
    // When next here, we can handle when browser does not support bluetooth, presumablue !navigator.bluetooth https://github.com/phetsims/ratio-and-proportion/issues/473

    // Name provided by the bluetooth device creator
    const deviceName = ratioTerm === RatioTerm.ANTECEDENT ? 'nrf52L' : 'nrf52R';

    // button label
    const labelStringProperty = new PatternStringProperty(new Property('BLE {{side}} device'), {
      side: ratioTerm === RatioTerm.ANTECEDENT ? 'left' : 'right'
    });

    // decides which hand to control in the sim
    const term = ratioTerm === RatioTerm.ANTECEDENT ? 'withAntecedent' : 'withConsequent';
    const options = optionize()({
      textNodeOptions: {
        font: FONT
      },
      listener: async () => {
        await this.requestDevice({
          filters: [{
            name: deviceName
          }],
          optionalServices: [0xae6f]
        }, tupleProperty, term);
      }
    }, providedOptions);
    super(labelStringProperty, options);
  }
  async requestDevice(bluetoothConfig, tupleProperty, term) {
    let device; // should be type BluetoothDevice, but it is too experimental for native types

    // @ts-expect-error - navigator.bluetooth is experimental and does not exist in the typing
    if (navigator.bluetooth) {
      // @ts-expect-error - navigator.bluetooth is experimental and does not exist in the typing
      device = await navigator.bluetooth.requestDevice(bluetoothConfig).catch(err => {
        device = null;
      });
      if (device) {
        console.log(device.name);
        console.log(device.id);

        // attempt to connect to the GATT Server.
        const gattServer = await device.gatt.connect().catch(err => {
          console.error(err);
        });
        const primaryService = await gattServer.getPrimaryService(0xae6f).catch(err => {
          console.error(err);
        });
        const characteristic = await primaryService.getCharacteristic(0x2947).catch(err => {
          console.error(err);
        });
        const notifySuccess = await characteristic.startNotifications().catch(err => {
          console.error(err);
        });
        notifySuccess.addEventListener('characteristicvaluechanged', event => {
          this.isBeingInteractedWithProperty.value = true;
          this.lastTimeInteractedWith = Date.now();
          const newValue = RatioAndProportionBluetoothButton.handleCharacteristicValueChanged(event);

          // Keep track of values to see if the current position over time is considered "stationary"
          this.stationaryTracker.update(newValue);
          tupleProperty.value = tupleProperty.value[term](newValue);
        });

        // At this time we can assume that connections are successful
        console.log('connection successful');
      }
    }
  }
  step() {
    if (Date.now() - this.lastTimeInteractedWith > TIME_INTERACTED_WITH_MEMORY) {
      this.isBeingInteractedWithProperty.value = false;
    }
  }

  /**
   * Respond to a characteristicvaluechanged event.
   * The return value must be between 0 and 1.
   */
  static handleCharacteristicValueChanged(event) {
    if (event.target) {
      // @ts-expect-error, event.target is a BluetoothRemoteGATTCharacteristic, but this is too experimental to be the typescript lib.
      const value = event.target.value;
      console.log(value.getFloat32(0, true));
      const floatValue = value.getFloat32(0, true);

      // rounding to 4 decimal places.
      return Utils.toFixedNumber(Utils.clamp(floatValue / 100, 0, 1), 4);
    }
    return 0;
  }
}
ratioAndProportion.register('RatioAndProportionBluetoothButton', RatioAndProportionBluetoothButton);
export default RatioAndProportionBluetoothButton;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyYXRpb0FuZFByb3BvcnRpb24iLCJUZXh0UHVzaEJ1dHRvbiIsIlV0aWxzIiwiUGhldEZvbnQiLCJQcm9wZXJ0eSIsIlJhdGlvVGVybSIsIkJvb2xlYW5Qcm9wZXJ0eSIsIlN0YXRpb25hcnlWYWx1ZVRyYWNrZXIiLCJvcHRpb25pemUiLCJSQVBRdWVyeVBhcmFtZXRlcnMiLCJQYXR0ZXJuU3RyaW5nUHJvcGVydHkiLCJGT05UIiwic2l6ZSIsIndlaWdodCIsIlRJTUVfSU5URVJBQ1RFRF9XSVRIX01FTU9SWSIsIlJhdGlvQW5kUHJvcG9ydGlvbkJsdWV0b290aEJ1dHRvbiIsImlzQmVpbmdJbnRlcmFjdGVkV2l0aFByb3BlcnR5IiwibGFzdFRpbWVJbnRlcmFjdGVkV2l0aCIsInN0YXRpb25hcnlUcmFja2VyIiwiaGlzdG9yeUxlbmd0aCIsImJsdWV0b290aEhpc3RvcnlMZW5ndGgiLCJzdGF0aW9uYXJ5VGhyZXNob2xkIiwiYmx1ZXRvb3RoU3RhdGlvbmFyeVRocmVzaG9sZCIsImlzU3RhdGlvbmFyeVByb3BlcnR5IiwiY29uc3RydWN0b3IiLCJ0dXBsZVByb3BlcnR5IiwicmF0aW9UZXJtIiwicHJvdmlkZWRPcHRpb25zIiwiZGV2aWNlTmFtZSIsIkFOVEVDRURFTlQiLCJsYWJlbFN0cmluZ1Byb3BlcnR5Iiwic2lkZSIsInRlcm0iLCJvcHRpb25zIiwidGV4dE5vZGVPcHRpb25zIiwiZm9udCIsImxpc3RlbmVyIiwicmVxdWVzdERldmljZSIsImZpbHRlcnMiLCJuYW1lIiwib3B0aW9uYWxTZXJ2aWNlcyIsImJsdWV0b290aENvbmZpZyIsImRldmljZSIsIm5hdmlnYXRvciIsImJsdWV0b290aCIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImxvZyIsImlkIiwiZ2F0dFNlcnZlciIsImdhdHQiLCJjb25uZWN0IiwiZXJyb3IiLCJwcmltYXJ5U2VydmljZSIsImdldFByaW1hcnlTZXJ2aWNlIiwiY2hhcmFjdGVyaXN0aWMiLCJnZXRDaGFyYWN0ZXJpc3RpYyIsIm5vdGlmeVN1Y2Nlc3MiLCJzdGFydE5vdGlmaWNhdGlvbnMiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJ2YWx1ZSIsIkRhdGUiLCJub3ciLCJuZXdWYWx1ZSIsImhhbmRsZUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VkIiwidXBkYXRlIiwic3RlcCIsInRhcmdldCIsImdldEZsb2F0MzIiLCJmbG9hdFZhbHVlIiwidG9GaXhlZE51bWJlciIsImNsYW1wIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJSYXRpb0FuZFByb3BvcnRpb25CbHVldG9vdGhCdXR0b24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRvIHRlc3QgY29ubmVjdGluZyB0byBhIGJsdWV0b290aCBkZXZpY2UgdXNpbmcgd2ViIGJsdWV0b290aC4gTm90ZSB0aGlzIHVzZXMgUHJvbWlzZXMgKGFzIHRoZVxyXG4gKiBibHVldG9vdGggQVBJIHdvcmtzIHdpdGggcHJvbWlzZXMpIHdoaWNoIGlzIHZlcnkgdW51c3VhbCBmb3Igc2ltdWxhdGlvbiBjb2RlLlxyXG4gKlxyXG4gKiBQcm90b3R5cGUgY29kZSBmb3IgdXBjb21pbmcgc3R1ZGVudCBzdHVkaWVzLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3JhdGlvLWFuZC1wcm9wb3J0aW9uL2lzc3Vlcy80NzNcclxuICovXHJcblxyXG5pbXBvcnQgcmF0aW9BbmRQcm9wb3J0aW9uIGZyb20gJy4uLy4uL3JhdGlvQW5kUHJvcG9ydGlvbi5qcyc7XHJcbmltcG9ydCBUZXh0UHVzaEJ1dHRvbiwgeyBUZXh0UHVzaEJ1dHRvbk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9zdW4vanMvYnV0dG9ucy9UZXh0UHVzaEJ1dHRvbi5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgUGhldEZvbnQgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1BoZXRGb250LmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUkFQUmF0aW9UdXBsZSBmcm9tICcuLi9tb2RlbC9SQVBSYXRpb1R1cGxlLmpzJztcclxuaW1wb3J0IFJhdGlvVGVybSBmcm9tICcuLi9tb2RlbC9SYXRpb1Rlcm0uanMnO1xyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IFN0YXRpb25hcnlWYWx1ZVRyYWNrZXIgZnJvbSAnLi9TdGF0aW9uYXJ5VmFsdWVUcmFja2VyLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBSQVBRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vUkFQUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IEludGVudGlvbmFsQW55IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9JbnRlbnRpb25hbEFueS5qcyc7XHJcbmltcG9ydCBQYXR0ZXJuU3RyaW5nUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9QYXR0ZXJuU3RyaW5nUHJvcGVydHkuanMnO1xyXG5cclxuY29uc3QgRk9OVCA9IG5ldyBQaGV0Rm9udCggeyBzaXplOiAxNiwgd2VpZ2h0OiAnYm9sZCcgfSApO1xyXG5cclxuLy8gaW4gbXNcclxuY29uc3QgVElNRV9JTlRFUkFDVEVEX1dJVEhfTUVNT1JZID0gMjAwMDtcclxuXHJcbi8vIExpa2VseSBjYW4gYmUgaW1wcm92ZWQsIGJ1dCB3ZSBkb24ndCBoYXZlIHRoaXMgaW4gdGhlIG1haW4gYnJvd3NlciB0eXBpbmcuXHJcbnR5cGUgQmx1ZXRvb3RoQ29uZmlnID0ge1xyXG4gIGZpbHRlcnM6IHsgbmFtZTogc3RyaW5nIH1bXTtcclxuICBvcHRpb25hbFNlcnZpY2VzPzogbnVtYmVyW107XHJcbn07XHJcblxyXG5jbGFzcyBSYXRpb0FuZFByb3BvcnRpb25CbHVldG9vdGhCdXR0b24gZXh0ZW5kcyBUZXh0UHVzaEJ1dHRvbiB7XHJcblxyXG4gIHB1YmxpYyBpc0JlaW5nSW50ZXJhY3RlZFdpdGhQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcbiAgcHJpdmF0ZSBsYXN0VGltZUludGVyYWN0ZWRXaXRoID0gMDtcclxuICBwcml2YXRlIHN0YXRpb25hcnlUcmFja2VyID0gbmV3IFN0YXRpb25hcnlWYWx1ZVRyYWNrZXIoIHtcclxuICAgIGhpc3RvcnlMZW5ndGg6IFJBUFF1ZXJ5UGFyYW1ldGVycy5ibHVldG9vdGhIaXN0b3J5TGVuZ3RoLFxyXG4gICAgc3RhdGlvbmFyeVRocmVzaG9sZDogUkFQUXVlcnlQYXJhbWV0ZXJzLmJsdWV0b290aFN0YXRpb25hcnlUaHJlc2hvbGRcclxuICB9ICk7XHJcblxyXG4gIHB1YmxpYyBpc1N0YXRpb25hcnlQcm9wZXJ0eSA9IHRoaXMuc3RhdGlvbmFyeVRyYWNrZXIuaXNTdGF0aW9uYXJ5UHJvcGVydHk7IC8vIHB1bGwgaXQgb3V0IGZvciB0aGUgcHVibGljIEFQSVxyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHR1cGxlUHJvcGVydHk6IFByb3BlcnR5PFJBUFJhdGlvVHVwbGU+LCByYXRpb1Rlcm06IFJhdGlvVGVybSwgcHJvdmlkZWRPcHRpb25zPzogVGV4dFB1c2hCdXR0b25PcHRpb25zICkge1xyXG5cclxuICAgIC8vIFdoZW4gbmV4dCBoZXJlLCB3ZSBjYW4gaGFuZGxlIHdoZW4gZGV2aWNlIGRvZXMgbm90IHN1cHBvcnQgYmx1ZXRvb3RoIHdpdGggYmx1ZXRvb3RoLmdldEF2YWlsYWJpbGl0eS4gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3JhdGlvLWFuZC1wcm9wb3J0aW9uL2lzc3Vlcy80NzNcclxuICAgIC8vIFdoZW4gbmV4dCBoZXJlLCB3ZSBjYW4gaGFuZGxlIHdoZW4gYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IGJsdWV0b290aCwgcHJlc3VtYWJsdWUgIW5hdmlnYXRvci5ibHVldG9vdGggaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3JhdGlvLWFuZC1wcm9wb3J0aW9uL2lzc3Vlcy80NzNcclxuXHJcbiAgICAvLyBOYW1lIHByb3ZpZGVkIGJ5IHRoZSBibHVldG9vdGggZGV2aWNlIGNyZWF0b3JcclxuICAgIGNvbnN0IGRldmljZU5hbWUgPSByYXRpb1Rlcm0gPT09IFJhdGlvVGVybS5BTlRFQ0VERU5UID8gJ25yZjUyTCcgOiAnbnJmNTJSJztcclxuXHJcbiAgICAvLyBidXR0b24gbGFiZWxcclxuICAgIGNvbnN0IGxhYmVsU3RyaW5nUHJvcGVydHkgPSBuZXcgUGF0dGVyblN0cmluZ1Byb3BlcnR5KCBuZXcgUHJvcGVydHkoICdCTEUge3tzaWRlfX0gZGV2aWNlJyApLCB7XHJcbiAgICAgIHNpZGU6IHJhdGlvVGVybSA9PT0gUmF0aW9UZXJtLkFOVEVDRURFTlQgPyAnbGVmdCcgOiAncmlnaHQnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gZGVjaWRlcyB3aGljaCBoYW5kIHRvIGNvbnRyb2wgaW4gdGhlIHNpbVxyXG4gICAgY29uc3QgdGVybSA9IHJhdGlvVGVybSA9PT0gUmF0aW9UZXJtLkFOVEVDRURFTlQgPyAnd2l0aEFudGVjZWRlbnQnIDogJ3dpdGhDb25zZXF1ZW50JztcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFRleHRQdXNoQnV0dG9uT3B0aW9ucywgRW1wdHlTZWxmT3B0aW9ucywgVGV4dFB1c2hCdXR0b25PcHRpb25zPigpKCB7XHJcbiAgICAgIHRleHROb2RlT3B0aW9uczogeyBmb250OiBGT05UIH0sXHJcbiAgICAgIGxpc3RlbmVyOiBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5yZXF1ZXN0RGV2aWNlKCB7IGZpbHRlcnM6IFsgeyBuYW1lOiBkZXZpY2VOYW1lIH0gXSwgb3B0aW9uYWxTZXJ2aWNlczogWyAweGFlNmYgXSB9LCB0dXBsZVByb3BlcnR5LCB0ZXJtICk7XHJcbiAgICAgIH1cclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG4gICAgc3VwZXIoIGxhYmVsU3RyaW5nUHJvcGVydHksIG9wdGlvbnMgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgcmVxdWVzdERldmljZSggYmx1ZXRvb3RoQ29uZmlnOiBCbHVldG9vdGhDb25maWcsIHR1cGxlUHJvcGVydHk6IFByb3BlcnR5PFJBUFJhdGlvVHVwbGU+LCB0ZXJtOiAnd2l0aENvbnNlcXVlbnQnIHwgJ3dpdGhBbnRlY2VkZW50JyApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGxldCBkZXZpY2U6IG51bGwgfCBJbnRlbnRpb25hbEFueTsgLy8gc2hvdWxkIGJlIHR5cGUgQmx1ZXRvb3RoRGV2aWNlLCBidXQgaXQgaXMgdG9vIGV4cGVyaW1lbnRhbCBmb3IgbmF0aXZlIHR5cGVzXHJcblxyXG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvciAtIG5hdmlnYXRvci5ibHVldG9vdGggaXMgZXhwZXJpbWVudGFsIGFuZCBkb2VzIG5vdCBleGlzdCBpbiB0aGUgdHlwaW5nXHJcbiAgICBpZiAoIG5hdmlnYXRvci5ibHVldG9vdGggKSB7XHJcblxyXG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIC0gbmF2aWdhdG9yLmJsdWV0b290aCBpcyBleHBlcmltZW50YWwgYW5kIGRvZXMgbm90IGV4aXN0IGluIHRoZSB0eXBpbmdcclxuICAgICAgZGV2aWNlID0gYXdhaXQgbmF2aWdhdG9yLmJsdWV0b290aC5yZXF1ZXN0RGV2aWNlKCBibHVldG9vdGhDb25maWcgKS5jYXRjaCggZXJyID0+IHtcclxuICAgICAgICBkZXZpY2UgPSBudWxsO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICBpZiAoIGRldmljZSApIHtcclxuICAgICAgICBjb25zb2xlLmxvZyggZGV2aWNlLm5hbWUgKTtcclxuICAgICAgICBjb25zb2xlLmxvZyggZGV2aWNlLmlkICk7XHJcblxyXG4gICAgICAgIC8vIGF0dGVtcHQgdG8gY29ubmVjdCB0byB0aGUgR0FUVCBTZXJ2ZXIuXHJcbiAgICAgICAgY29uc3QgZ2F0dFNlcnZlciA9IGF3YWl0IGRldmljZS5nYXR0LmNvbm5lY3QoKS5jYXRjaCggKCBlcnI6IERPTUV4Y2VwdGlvbiApID0+IHsgY29uc29sZS5lcnJvciggZXJyICk7IH0gKTtcclxuICAgICAgICBjb25zdCBwcmltYXJ5U2VydmljZSA9IGF3YWl0IGdhdHRTZXJ2ZXIuZ2V0UHJpbWFyeVNlcnZpY2UoIDB4YWU2ZiApLmNhdGNoKCAoIGVycjogRE9NRXhjZXB0aW9uICkgPT4geyBjb25zb2xlLmVycm9yKCBlcnIgKTsgfSApO1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3RlcmlzdGljID0gYXdhaXQgcHJpbWFyeVNlcnZpY2UuZ2V0Q2hhcmFjdGVyaXN0aWMoIDB4Mjk0NyApLmNhdGNoKCAoIGVycjogRE9NRXhjZXB0aW9uICkgPT4geyBjb25zb2xlLmVycm9yKCBlcnIgKTsgfSApO1xyXG4gICAgICAgIGNvbnN0IG5vdGlmeVN1Y2Nlc3MgPSBhd2FpdCBjaGFyYWN0ZXJpc3RpYy5zdGFydE5vdGlmaWNhdGlvbnMoKS5jYXRjaCggKCBlcnI6IERPTUV4Y2VwdGlvbiApID0+IHsgY29uc29sZS5lcnJvciggZXJyICk7IH0gKTtcclxuICAgICAgICBub3RpZnlTdWNjZXNzLmFkZEV2ZW50TGlzdGVuZXIoICdjaGFyYWN0ZXJpc3RpY3ZhbHVlY2hhbmdlZCcsICggZXZlbnQ6IEV2ZW50ICkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5pc0JlaW5nSW50ZXJhY3RlZFdpdGhQcm9wZXJ0eS52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgICB0aGlzLmxhc3RUaW1lSW50ZXJhY3RlZFdpdGggPSBEYXRlLm5vdygpO1xyXG5cclxuICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gUmF0aW9BbmRQcm9wb3J0aW9uQmx1ZXRvb3RoQnV0dG9uLmhhbmRsZUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VkKCBldmVudCApO1xyXG5cclxuICAgICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdmFsdWVzIHRvIHNlZSBpZiB0aGUgY3VycmVudCBwb3NpdGlvbiBvdmVyIHRpbWUgaXMgY29uc2lkZXJlZCBcInN0YXRpb25hcnlcIlxyXG4gICAgICAgICAgdGhpcy5zdGF0aW9uYXJ5VHJhY2tlci51cGRhdGUoIG5ld1ZhbHVlICk7XHJcblxyXG4gICAgICAgICAgdHVwbGVQcm9wZXJ0eS52YWx1ZSA9IHR1cGxlUHJvcGVydHkudmFsdWVbIHRlcm0gXSggbmV3VmFsdWUgKTtcclxuICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgIC8vIEF0IHRoaXMgdGltZSB3ZSBjYW4gYXNzdW1lIHRoYXQgY29ubmVjdGlvbnMgYXJlIHN1Y2Nlc3NmdWxcclxuICAgICAgICBjb25zb2xlLmxvZyggJ2Nvbm5lY3Rpb24gc3VjY2Vzc2Z1bCcgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0ZXAoKTogdm9pZCB7XHJcbiAgICBpZiAoIERhdGUubm93KCkgLSB0aGlzLmxhc3RUaW1lSW50ZXJhY3RlZFdpdGggPiBUSU1FX0lOVEVSQUNURURfV0lUSF9NRU1PUlkgKSB7XHJcbiAgICAgIHRoaXMuaXNCZWluZ0ludGVyYWN0ZWRXaXRoUHJvcGVydHkudmFsdWUgPSBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3BvbmQgdG8gYSBjaGFyYWN0ZXJpc3RpY3ZhbHVlY2hhbmdlZCBldmVudC5cclxuICAgKiBUaGUgcmV0dXJuIHZhbHVlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGhhbmRsZUNoYXJhY3RlcmlzdGljVmFsdWVDaGFuZ2VkKCBldmVudDogRXZlbnQgKTogbnVtYmVyIHtcclxuICAgIGlmICggZXZlbnQudGFyZ2V0ICkge1xyXG5cclxuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciwgZXZlbnQudGFyZ2V0IGlzIGEgQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljLCBidXQgdGhpcyBpcyB0b28gZXhwZXJpbWVudGFsIHRvIGJlIHRoZSB0eXBlc2NyaXB0IGxpYi5cclxuICAgICAgY29uc3QgdmFsdWUgPSBldmVudC50YXJnZXQudmFsdWUgYXMgRGF0YVZpZXc7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyggdmFsdWUuZ2V0RmxvYXQzMiggMCwgdHJ1ZSApICk7XHJcblxyXG4gICAgICBjb25zdCBmbG9hdFZhbHVlID0gdmFsdWUuZ2V0RmxvYXQzMiggMCwgdHJ1ZSApO1xyXG5cclxuICAgICAgLy8gcm91bmRpbmcgdG8gNCBkZWNpbWFsIHBsYWNlcy5cclxuICAgICAgcmV0dXJuIFV0aWxzLnRvRml4ZWROdW1iZXIoIFV0aWxzLmNsYW1wKCBmbG9hdFZhbHVlIC8gMTAwLCAwLCAxICksIDQgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbn1cclxuXHJcbnJhdGlvQW5kUHJvcG9ydGlvbi5yZWdpc3RlciggJ1JhdGlvQW5kUHJvcG9ydGlvbkJsdWV0b290aEJ1dHRvbicsIFJhdGlvQW5kUHJvcG9ydGlvbkJsdWV0b290aEJ1dHRvbiApO1xyXG5leHBvcnQgZGVmYXVsdCBSYXRpb0FuZFByb3BvcnRpb25CbHVldG9vdGhCdXR0b247XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGtCQUFrQixNQUFNLDZCQUE2QjtBQUM1RCxPQUFPQyxjQUFjLE1BQWlDLDhDQUE4QztBQUNwRyxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLFFBQVEsTUFBTSx5Q0FBeUM7QUFDOUQsT0FBT0MsUUFBUSxNQUFNLGlDQUFpQztB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