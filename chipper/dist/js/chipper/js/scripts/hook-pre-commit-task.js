// Copyright 2020-2023, University of Colorado Boulder

/**
 * See hook-pre-commit. This implements each task for that process so they can run in parallel.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

const fs = require('fs');
const puppeteer = require('puppeteer');
const withServer = require('../../../perennial-alias/js/common/withServer');
const execute = require('../../../perennial-alias/js/common/execute');
const getPhetLibs = require('../grunt/getPhetLibs');
const getRepoList = require('../../../perennial-alias/js/common/getRepoList');
const generatePhetioMacroAPI = require('../phet-io/generatePhetioMacroAPI');
const CacheLayer = require('../../../chipper/js/common/CacheLayer');
const phetioCompareAPISets = require('../phet-io/phetioCompareAPISets');
const lint = require('../../../chipper/js/grunt/lint');
const reportMedia = require('../../../chipper/js/grunt/reportMedia');
const puppeteerQUnit = require('../../../aqua/js/local/puppeteerQUnit');
const commandLineArguments = process.argv.slice(2);
const outputToConsole = commandLineArguments.includes('--console');
const getArg = arg => {
  const args = commandLineArguments.filter(commandLineArg => commandLineArg.startsWith(`--${arg}=`));
  if (args.length !== 1) {
    throw new Error(`expected only one arg: ${args}`);
  }
  return args[0].split('=')[1];
};
const command = getArg('command');
const repo = getArg('repo');
(async () => {
  if (command === 'lint') {
    // Run lint tests if they exist in the checked-out SHAs.
    // lint() automatically filters out non-lintable repos
    const lintReturnValue = await lint([repo]);
    outputToConsole && console.log(`Linting passed with results.length: ${lintReturnValue.results.length}`);
    process.exit(lintReturnValue.ok ? 0 : 1);
  } else if (command === 'report-media') {
    // These sims don't have package.json or media that requires checking.
    const optOutOfReportMedia = ['decaf', 'phet-android-app', 'babel', 'phet-info', 'phet-ios-app', 'qa', 'sherpa', 'smithers', 'tasks', 'weddell'];

    // Make sure license.json for images/audio is up-to-date
    if (!optOutOfReportMedia.includes(repo)) {
      const success = await reportMedia(repo);
      process.exit(success ? 0 : 1);
    } else {
      // no need to check
      process.exit(0);
    }
  } else if (command === 'tsc') {
    // Run typescript type checker if it exists in the checked-out shas
    const results = await execute('node', ['../chipper/js/scripts/absolute-tsc.js', '../chipper/tsconfig/all'], '../chipper', {
      errors: 'resolve'
    });
    results.stderr.trim().length > 0 && console.log(results.stderr);
    results.stdout.trim().length > 0 && console.log(results.stdout);
    if (results.code === 0) {
      outputToConsole && console.log('tsc passed');
      process.exit(0);
    } else {
      outputToConsole && console.log('tsc failed');
      process.exit(1);
    }
  } else if (command === 'qunit') {
    // Run qunit tests if puppeteerQUnit exists in the checked-out SHAs and a test HTML exists.
    const qUnitOK = await (async () => {
      const cacheKey = `puppeteerQUnit#${repo}`;
      if (repo !== 'scenery' && repo !== 'phet-io-wrappers') {
        // scenery unit tests take too long, so skip those
        const testFilePath = `${repo}/${repo}-tests.html`;
        const exists = fs.existsSync(`../${testFilePath}`);
        if (exists) {
          if (CacheLayer.isCacheSafe(cacheKey)) {
            return true;
          } else {
            const browser = await puppeteer.launch({
              args: ['--disable-gpu']
            });
            const result = await withServer(async port => {
              return puppeteerQUnit(browser, `http://localhost:${port}/${testFilePath}?ea&brand=phet-io`);
            });
            await browser.close();
            outputToConsole && console.log(`${repo}: ${JSON.stringify(result, null, 2)}`);
            if (!result.ok) {
              console.error(`unit tests failed in ${repo}`, result);
              return false;
            } else {
              CacheLayer.onSuccess(cacheKey);
              return true;
            }
          }
        }
        outputToConsole && console.log('QUnit: no problems detected');
        return true;
      }
      return true;
    })();
    process.exit(qUnitOK ? 0 : 1);
  } else if (command === 'phet-io-api-compare') {
    ////////////////////////////////////////////////////////////////////////////////
    // Compare PhET-iO APIs for this repo and anything that has it as a dependency
    //
    const phetioAPIOK = await (async () => {
      const getCacheKey = repo => `phet-io-api-compare#${repo}`;

      // Test this repo and all phet-io sims that have it as a dependency.  For instance, changing sun would test
      // every phet-io stable sim.
      const phetioAPIStable = getRepoList('phet-io-api-stable');
      const reposToTest = phetioAPIStable.filter(phetioSimRepo => getPhetLibs(phetioSimRepo).includes(repo))

      // Only worry about the ones that are not cached
      .filter(repo => !CacheLayer.isCacheSafe(getCacheKey(repo)));
      if (reposToTest.length > 0) {
        const proposedAPIs = await generatePhetioMacroAPI(reposToTest, {
          showProgressBar: reposToTest.length > 1,
          showMessagesFromSim: false
        });
        const phetioAPIComparisonSuccessful = await phetioCompareAPISets(reposToTest, proposedAPIs);
        if (phetioAPIComparisonSuccessful) {
          reposToTest.forEach(repo => CacheLayer.onSuccess(getCacheKey(repo)));
        }
        return phetioAPIComparisonSuccessful;
      } else {
        return true;
      }
    })();
    process.exit(phetioAPIOK ? 0 : 1);
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwdXBwZXRlZXIiLCJ3aXRoU2VydmVyIiwiZXhlY3V0ZSIsImdldFBoZXRMaWJzIiwiZ2V0UmVwb0xpc3QiLCJnZW5lcmF0ZVBoZXRpb01hY3JvQVBJIiwiQ2FjaGVMYXllciIsInBoZXRpb0NvbXBhcmVBUElTZXRzIiwibGludCIsInJlcG9ydE1lZGlhIiwicHVwcGV0ZWVyUVVuaXQiLCJjb21tYW5kTGluZUFyZ3VtZW50cyIsInByb2Nlc3MiLCJhcmd2Iiwic2xpY2UiLCJvdXRwdXRUb0NvbnNvbGUiLCJpbmNsdWRlcyIsImdldEFyZyIsImFyZyIsImFyZ3MiLCJmaWx0ZXIiLCJjb21tYW5kTGluZUFyZyIsInN0YXJ0c1dpdGgiLCJsZW5ndGgiLCJFcnJvciIsInNwbGl0IiwiY29tbWFuZCIsInJlcG8iLCJsaW50UmV0dXJuVmFsdWUiLCJjb25zb2xlIiwibG9nIiwicmVzdWx0cyIsImV4aXQiLCJvayIsIm9wdE91dE9mUmVwb3J0TWVkaWEiLCJzdWNjZXNzIiwiZXJyb3JzIiwic3RkZXJyIiwidHJpbSIsInN0ZG91dCIsImNvZGUiLCJxVW5pdE9LIiwiY2FjaGVLZXkiLCJ0ZXN0RmlsZVBhdGgiLCJleGlzdHMiLCJleGlzdHNTeW5jIiwiaXNDYWNoZVNhZmUiLCJicm93c2VyIiwibGF1bmNoIiwicmVzdWx0IiwicG9ydCIsImNsb3NlIiwiSlNPTiIsInN0cmluZ2lmeSIsImVycm9yIiwib25TdWNjZXNzIiwicGhldGlvQVBJT0siLCJnZXRDYWNoZUtleSIsInBoZXRpb0FQSVN0YWJsZSIsInJlcG9zVG9UZXN0IiwicGhldGlvU2ltUmVwbyIsInByb3Bvc2VkQVBJcyIsInNob3dQcm9ncmVzc0JhciIsInNob3dNZXNzYWdlc0Zyb21TaW0iLCJwaGV0aW9BUElDb21wYXJpc29uU3VjY2Vzc2Z1bCIsImZvckVhY2giXSwic291cmNlcyI6WyJob29rLXByZS1jb21taXQtdGFzay5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTZWUgaG9vay1wcmUtY29tbWl0LiBUaGlzIGltcGxlbWVudHMgZWFjaCB0YXNrIGZvciB0aGF0IHByb2Nlc3Mgc28gdGhleSBjYW4gcnVuIGluIHBhcmFsbGVsLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuY29uc3QgZnMgPSByZXF1aXJlKCAnZnMnICk7XHJcbmNvbnN0IHB1cHBldGVlciA9IHJlcXVpcmUoICdwdXBwZXRlZXInICk7XHJcbmNvbnN0IHdpdGhTZXJ2ZXIgPSByZXF1aXJlKCAnLi4vLi4vLi4vcGVyZW5uaWFsLWFsaWFzL2pzL2NvbW1vbi93aXRoU2VydmVyJyApO1xyXG5jb25zdCBleGVjdXRlID0gcmVxdWlyZSggJy4uLy4uLy4uL3BlcmVubmlhbC1hbGlhcy9qcy9jb21tb24vZXhlY3V0ZScgKTtcclxuY29uc3QgZ2V0UGhldExpYnMgPSByZXF1aXJlKCAnLi4vZ3J1bnQvZ2V0UGhldExpYnMnICk7XHJcbmNvbnN0IGdldFJlcG9MaXN0ID0gcmVxdWlyZSggJy4uLy4uLy4uL3BlcmVubmlhbC1hbGlhcy9qcy9jb21tb24vZ2V0UmVwb0xpc3QnICk7XHJcbmNvbnN0IGdlbmVyYXRlUGhldGlvTWFjcm9BUEkgPSByZXF1aXJlKCAnLi4vcGhldC1pby9nZW5lcmF0ZVBoZXRpb01hY3JvQVBJJyApO1xyXG5jb25zdCBDYWNoZUxheWVyID0gcmVxdWlyZSggJy4uLy4uLy4uL2NoaXBwZXIvanMvY29tbW9uL0NhY2hlTGF5ZXInICk7XHJcbmNvbnN0IHBoZXRpb0NvbXBhcmVBUElTZXRzID0gcmVxdWlyZSggJy4uL3BoZXQtaW8vcGhldGlvQ29tcGFyZUFQSVNldHMnICk7XHJcbmNvbnN0IGxpbnQgPSByZXF1aXJlKCAnLi4vLi4vLi4vY2hpcHBlci9qcy9ncnVudC9saW50JyApO1xyXG5jb25zdCByZXBvcnRNZWRpYSA9IHJlcXVpcmUoICcuLi8uLi8uLi9jaGlwcGVyL2pzL2dydW50L3JlcG9ydE1lZGlhJyApO1xyXG5jb25zdCBwdXBwZXRlZXJRVW5pdCA9IHJlcXVpcmUoICcuLi8uLi8uLi9hcXVhL2pzL2xvY2FsL3B1cHBldGVlclFVbml0JyApO1xyXG5cclxuY29uc3QgY29tbWFuZExpbmVBcmd1bWVudHMgPSBwcm9jZXNzLmFyZ3Yuc2xpY2UoIDIgKTtcclxuY29uc3Qgb3V0cHV0VG9Db25zb2xlID0gY29tbWFuZExpbmVBcmd1bWVudHMuaW5jbHVkZXMoICctLWNvbnNvbGUnICk7XHJcblxyXG5jb25zdCBnZXRBcmcgPSBhcmcgPT4ge1xyXG4gIGNvbnN0IGFyZ3MgPSBjb21tYW5kTGluZUFyZ3VtZW50cy5maWx0ZXIoIGNvbW1hbmRMaW5lQXJnID0+IGNvbW1hbmRMaW5lQXJnLnN0YXJ0c1dpdGgoIGAtLSR7YXJnfT1gICkgKTtcclxuICBpZiAoIGFyZ3MubGVuZ3RoICE9PSAxICkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCBgZXhwZWN0ZWQgb25seSBvbmUgYXJnOiAke2FyZ3N9YCApO1xyXG4gIH1cclxuICByZXR1cm4gYXJnc1sgMCBdLnNwbGl0KCAnPScgKVsgMSBdO1xyXG59O1xyXG5cclxuY29uc3QgY29tbWFuZCA9IGdldEFyZyggJ2NvbW1hbmQnICk7XHJcbmNvbnN0IHJlcG8gPSBnZXRBcmcoICdyZXBvJyApO1xyXG5cclxuKCBhc3luYyAoKSA9PiB7XHJcblxyXG4gIGlmICggY29tbWFuZCA9PT0gJ2xpbnQnICkge1xyXG5cclxuICAgIC8vIFJ1biBsaW50IHRlc3RzIGlmIHRoZXkgZXhpc3QgaW4gdGhlIGNoZWNrZWQtb3V0IFNIQXMuXHJcbiAgICAvLyBsaW50KCkgYXV0b21hdGljYWxseSBmaWx0ZXJzIG91dCBub24tbGludGFibGUgcmVwb3NcclxuICAgIGNvbnN0IGxpbnRSZXR1cm5WYWx1ZSA9IGF3YWl0IGxpbnQoIFsgcmVwbyBdICk7XHJcbiAgICBvdXRwdXRUb0NvbnNvbGUgJiYgY29uc29sZS5sb2coIGBMaW50aW5nIHBhc3NlZCB3aXRoIHJlc3VsdHMubGVuZ3RoOiAke2xpbnRSZXR1cm5WYWx1ZS5yZXN1bHRzLmxlbmd0aH1gICk7XHJcbiAgICBwcm9jZXNzLmV4aXQoIGxpbnRSZXR1cm5WYWx1ZS5vayA/IDAgOiAxICk7XHJcbiAgfVxyXG5cclxuICBlbHNlIGlmICggY29tbWFuZCA9PT0gJ3JlcG9ydC1tZWRpYScgKSB7XHJcblxyXG4gICAgLy8gVGhlc2Ugc2ltcyBkb24ndCBoYXZlIHBhY2thZ2UuanNvbiBvciBtZWRpYSB0aGF0IHJlcXVpcmVzIGNoZWNraW5nLlxyXG4gICAgY29uc3Qgb3B0T3V0T2ZSZXBvcnRNZWRpYSA9IFtcclxuICAgICAgJ2RlY2FmJyxcclxuICAgICAgJ3BoZXQtYW5kcm9pZC1hcHAnLFxyXG4gICAgICAnYmFiZWwnLFxyXG4gICAgICAncGhldC1pbmZvJyxcclxuICAgICAgJ3BoZXQtaW9zLWFwcCcsXHJcbiAgICAgICdxYScsXHJcbiAgICAgICdzaGVycGEnLFxyXG4gICAgICAnc21pdGhlcnMnLFxyXG4gICAgICAndGFza3MnLFxyXG4gICAgICAnd2VkZGVsbCdcclxuICAgIF07XHJcblxyXG4gICAgLy8gTWFrZSBzdXJlIGxpY2Vuc2UuanNvbiBmb3IgaW1hZ2VzL2F1ZGlvIGlzIHVwLXRvLWRhdGVcclxuICAgIGlmICggIW9wdE91dE9mUmVwb3J0TWVkaWEuaW5jbHVkZXMoIHJlcG8gKSApIHtcclxuXHJcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCByZXBvcnRNZWRpYSggcmVwbyApO1xyXG4gICAgICBwcm9jZXNzLmV4aXQoIHN1Y2Nlc3MgPyAwIDogMSApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICAvLyBubyBuZWVkIHRvIGNoZWNrXHJcbiAgICAgIHByb2Nlc3MuZXhpdCggMCApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZWxzZSBpZiAoIGNvbW1hbmQgPT09ICd0c2MnICkge1xyXG5cclxuXHJcbiAgICAvLyBSdW4gdHlwZXNjcmlwdCB0eXBlIGNoZWNrZXIgaWYgaXQgZXhpc3RzIGluIHRoZSBjaGVja2VkLW91dCBzaGFzXHJcbiAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgZXhlY3V0ZSggJ25vZGUnLCBbICcuLi9jaGlwcGVyL2pzL3NjcmlwdHMvYWJzb2x1dGUtdHNjLmpzJywgJy4uL2NoaXBwZXIvdHNjb25maWcvYWxsJyBdLCAnLi4vY2hpcHBlcicsIHtcclxuICAgICAgZXJyb3JzOiAncmVzb2x2ZSdcclxuICAgIH0gKTtcclxuXHJcbiAgICByZXN1bHRzLnN0ZGVyci50cmltKCkubGVuZ3RoID4gMCAmJiBjb25zb2xlLmxvZyggcmVzdWx0cy5zdGRlcnIgKTtcclxuICAgIHJlc3VsdHMuc3Rkb3V0LnRyaW0oKS5sZW5ndGggPiAwICYmIGNvbnNvbGUubG9nKCByZXN1bHRzLnN0ZG91dCApO1xyXG5cclxuICAgIGlmICggcmVzdWx0cy5jb2RlID09PSAwICkge1xyXG4gICAgICBvdXRwdXRUb0NvbnNvbGUgJiYgY29uc29sZS5sb2coICd0c2MgcGFzc2VkJyApO1xyXG4gICAgICBwcm9jZXNzLmV4aXQoIDAgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBvdXRwdXRUb0NvbnNvbGUgJiYgY29uc29sZS5sb2coICd0c2MgZmFpbGVkJyApO1xyXG4gICAgICBwcm9jZXNzLmV4aXQoIDEgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGVsc2UgaWYgKCBjb21tYW5kID09PSAncXVuaXQnICkge1xyXG5cclxuICAgIC8vIFJ1biBxdW5pdCB0ZXN0cyBpZiBwdXBwZXRlZXJRVW5pdCBleGlzdHMgaW4gdGhlIGNoZWNrZWQtb3V0IFNIQXMgYW5kIGEgdGVzdCBIVE1MIGV4aXN0cy5cclxuICAgIGNvbnN0IHFVbml0T0sgPSBhd2FpdCAoIGFzeW5jICgpID0+IHtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYHB1cHBldGVlclFVbml0IyR7cmVwb31gO1xyXG5cclxuICAgICAgaWYgKCByZXBvICE9PSAnc2NlbmVyeScgJiYgcmVwbyAhPT0gJ3BoZXQtaW8td3JhcHBlcnMnICkgeyAvLyBzY2VuZXJ5IHVuaXQgdGVzdHMgdGFrZSB0b28gbG9uZywgc28gc2tpcCB0aG9zZVxyXG4gICAgICAgIGNvbnN0IHRlc3RGaWxlUGF0aCA9IGAke3JlcG99LyR7cmVwb30tdGVzdHMuaHRtbGA7XHJcbiAgICAgICAgY29uc3QgZXhpc3RzID0gZnMuZXhpc3RzU3luYyggYC4uLyR7dGVzdEZpbGVQYXRofWAgKTtcclxuICAgICAgICBpZiAoIGV4aXN0cyApIHtcclxuXHJcbiAgICAgICAgICBpZiAoIENhY2hlTGF5ZXIuaXNDYWNoZVNhZmUoIGNhY2hlS2V5ICkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJyb3dzZXIgPSBhd2FpdCBwdXBwZXRlZXIubGF1bmNoKCB7XHJcbiAgICAgICAgICAgICAgYXJnczogW1xyXG4gICAgICAgICAgICAgICAgJy0tZGlzYWJsZS1ncHUnXHJcbiAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB3aXRoU2VydmVyKCBhc3luYyBwb3J0ID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gcHVwcGV0ZWVyUVVuaXQoIGJyb3dzZXIsIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vJHt0ZXN0RmlsZVBhdGh9P2VhJmJyYW5kPXBoZXQtaW9gICk7XHJcbiAgICAgICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgICAgIGF3YWl0IGJyb3dzZXIuY2xvc2UoKTtcclxuXHJcbiAgICAgICAgICAgIG91dHB1dFRvQ29uc29sZSAmJiBjb25zb2xlLmxvZyggYCR7cmVwb306ICR7SlNPTi5zdHJpbmdpZnkoIHJlc3VsdCwgbnVsbCwgMiApfWAgKTtcclxuICAgICAgICAgICAgaWYgKCAhcmVzdWx0Lm9rICkge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIGB1bml0IHRlc3RzIGZhaWxlZCBpbiAke3JlcG99YCwgcmVzdWx0ICk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgIENhY2hlTGF5ZXIub25TdWNjZXNzKCBjYWNoZUtleSApO1xyXG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBvdXRwdXRUb0NvbnNvbGUgJiYgY29uc29sZS5sb2coICdRVW5pdDogbm8gcHJvYmxlbXMgZGV0ZWN0ZWQnICk7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9ICkoKTtcclxuXHJcbiAgICBwcm9jZXNzLmV4aXQoIHFVbml0T0sgPyAwIDogMSApO1xyXG4gIH1cclxuXHJcbiAgZWxzZSBpZiAoIGNvbW1hbmQgPT09ICdwaGV0LWlvLWFwaS1jb21wYXJlJyApIHtcclxuXHJcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG4gICAgLy8gQ29tcGFyZSBQaEVULWlPIEFQSXMgZm9yIHRoaXMgcmVwbyBhbmQgYW55dGhpbmcgdGhhdCBoYXMgaXQgYXMgYSBkZXBlbmRlbmN5XHJcbiAgICAvL1xyXG4gICAgY29uc3QgcGhldGlvQVBJT0sgPSBhd2FpdCAoIGFzeW5jICgpID0+IHtcclxuXHJcbiAgICAgIGNvbnN0IGdldENhY2hlS2V5ID0gcmVwbyA9PiBgcGhldC1pby1hcGktY29tcGFyZSMke3JlcG99YDtcclxuXHJcbiAgICAgIC8vIFRlc3QgdGhpcyByZXBvIGFuZCBhbGwgcGhldC1pbyBzaW1zIHRoYXQgaGF2ZSBpdCBhcyBhIGRlcGVuZGVuY3kuICBGb3IgaW5zdGFuY2UsIGNoYW5naW5nIHN1biB3b3VsZCB0ZXN0XHJcbiAgICAgIC8vIGV2ZXJ5IHBoZXQtaW8gc3RhYmxlIHNpbS5cclxuICAgICAgY29uc3QgcGhldGlvQVBJU3RhYmxlID0gZ2V0UmVwb0xpc3QoICdwaGV0LWlvLWFwaS1zdGFibGUnICk7XHJcbiAgICAgIGNvbnN0IHJlcG9zVG9UZXN0ID0gcGhldGlvQVBJU3RhYmxlXHJcbiAgICAgICAgLmZpbHRlciggcGhldGlvU2ltUmVwbyA9PiBnZXRQaGV0TGlicyggcGhldGlvU2ltUmVwbyApLmluY2x1ZGVzKCByZXBvICkgKVxyXG5cclxuICAgICAgICAvLyBPbmx5IHdvcnJ5IGFib3V0IHRoZSBvbmVzIHRoYXQgYXJlIG5vdCBjYWNoZWRcclxuICAgICAgICAuZmlsdGVyKCByZXBvID0+ICFDYWNoZUxheWVyLmlzQ2FjaGVTYWZlKCBnZXRDYWNoZUtleSggcmVwbyApICkgKTtcclxuXHJcbiAgICAgIGlmICggcmVwb3NUb1Rlc3QubGVuZ3RoID4gMCApIHtcclxuXHJcbiAgICAgICAgY29uc3QgcHJvcG9zZWRBUElzID0gYXdhaXQgZ2VuZXJhdGVQaGV0aW9NYWNyb0FQSSggcmVwb3NUb1Rlc3QsIHtcclxuICAgICAgICAgIHNob3dQcm9ncmVzc0JhcjogcmVwb3NUb1Rlc3QubGVuZ3RoID4gMSxcclxuICAgICAgICAgIHNob3dNZXNzYWdlc0Zyb21TaW06IGZhbHNlXHJcbiAgICAgICAgfSApO1xyXG5cclxuICAgICAgICBjb25zdCBwaGV0aW9BUElDb21wYXJpc29uU3VjY2Vzc2Z1bCA9IGF3YWl0IHBoZXRpb0NvbXBhcmVBUElTZXRzKCByZXBvc1RvVGVzdCwgcHJvcG9zZWRBUElzICk7XHJcblxyXG4gICAgICAgIGlmICggcGhldGlvQVBJQ29tcGFyaXNvblN1Y2Nlc3NmdWwgKSB7XHJcbiAgICAgICAgICByZXBvc1RvVGVzdC5mb3JFYWNoKCByZXBvID0+IENhY2hlTGF5ZXIub25TdWNjZXNzKCBnZXRDYWNoZUtleSggcmVwbyApICkgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwaGV0aW9BUElDb21wYXJpc29uU3VjY2Vzc2Z1bDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSApKCk7XHJcblxyXG4gICAgcHJvY2Vzcy5leGl0KCBwaGV0aW9BUElPSyA/IDAgOiAxICk7XHJcbiAgfVxyXG59ICkoKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBRSxJQUFLLENBQUM7QUFDMUIsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUUsV0FBWSxDQUFDO0FBQ3hDLE1BQU1FLFVBQVUsR0FBR0YsT0FBTyxDQUFFLCtDQUFnRCxDQUFDO0FBQzdFLE1BQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFFLDRDQUE2QyxDQUFDO0FBQ3ZFLE1BQU1JLFdBQVcsR0FBR0osT0FBTyxDQUFFLHNCQUF1QixDQUFDO0FBQ3JELE1BQU1LLFdBQVcsR0FBR0wsT0FBTyxDQUFFLGdEQUFpRCxDQUFDO0FBQy9FLE1BQU1NLHNCQUFzQixHQUFHTixPQUFPLENBQUUsbUNBQW9DLENBQUM7QUFDN0UsTUFBTU8sVUFBVSxHQUFHUCxPQUFPLENBQUUsdUNBQXdDLENBQUM7QUFDckUsTUFBTVEsb0JBQW9CLEdBQUdSLE9BQU8sQ0FBRSxpQ0FBa0MsQ0FBQztBQUN6RSxNQUFNUyxJQUFJLEdBQUdULE9BQU8sQ0FBRSxnQ0FBaUMsQ0FBQztBQUN4RCxNQUFNVSxXQUFXLEdBQUdWLE9BQU8sQ0FBRSx1Q0FBd0MsQ0FBQztBQUN0RSxN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