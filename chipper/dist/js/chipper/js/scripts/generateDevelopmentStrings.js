// Copyright 2022, University of Colorado Boulder

/**
 * This script makes a JSON file that combines translations for all locales in a repo. Each locale object has every
 * string key/translated-value pair we have for that locale. This is used when running the unbuilt mode simulation with
 * locales=*
 *
 * @author Liam Mulhall (PhET Interactive Simulations)
 * @author Sam Reid (PhET Interactive Simulations)
 */

// imports
const fs = require('fs');
const path = require('path');

/**
 * @param {string} repo - repo to generate strings for
 */
module.exports = repo => {
  const start = Date.now();
  const rootPath = path.join(__dirname, '..', '..', '..');

  // OS-independent path to babel repo.
  const babelPath = path.join(rootPath, 'babel');

  // Create a file name for the conglomerate string file.
  const conglomerateStringFileName = `${repo}_all.json`;

  // Create an empty object for the conglomerate string file that we will add to later.
  const conglomerateStringObject = {};

  // Get an array of files (string files) in the repo subdirectory.
  const babelRepoPath = path.join(babelPath, repo);

  // Regex for extracting locale from file name.
  const localeRegex = /(?<=_)(.*)(?=.json)/;
  const stringFiles = [];
  try {
    const paths = fs.readdirSync(babelRepoPath);
    stringFiles.push(...paths.map(p => path.join(babelRepoPath, p)));
  } catch (e) {

    // no translations found in babel. But we still must continue in order to generate an (albeit empty) string file.
  }
  const englishStringPath = path.join(rootPath, repo, `${repo}-strings_en.json`);
  if (fs.existsSync(englishStringPath)) {
    stringFiles.push(englishStringPath);
  }

  // Do not generate a file if no translations were found.
  if (stringFiles.length > 0) {
    // For each string file in the repo subdirectory...
    for (const stringFile of stringFiles) {
      // Extract the locale.
      const localeMatches = stringFile.match(localeRegex);
      const locale = localeMatches[0];

      // Get the contents of the string file.
      const stringFileContents = fs.readFileSync(stringFile, 'utf8');

      // Parse the string file contents.
      const parsedStringFileContents = JSON.parse(stringFileContents);

      // Add only the values of the string file to the new conglomerate string file, and ignore other fields, such as
      // the history.
      const objectToAddToLocale = {};
      for (const stringKey of Object.keys(parsedStringFileContents)) {
        objectToAddToLocale[stringKey] = {
          value: parsedStringFileContents[stringKey].value
        };
      }

      // Add the string values to the locale object of the conglomerate string object.
      conglomerateStringObject[locale] = objectToAddToLocale;
    }

    // Make sure the output directory exists.  The name starts with an underscore so that it appears alphabetically
    // first and looks different from the repo names.
    const outputDir = path.join(babelPath, '_generated_development_strings');
    try {
      fs.mkdirSync(outputDir);
    } catch (e) {
      // already exists
    }
    const outputPath = path.join(outputDir, conglomerateStringFileName);
    fs.writeFileSync(outputPath, JSON.stringify(conglomerateStringObject, null, 2));
    const end = Date.now();
    console.log('Wrote ' + outputPath + ' in ' + (end - start) + 'ms');
  } else {
    console.log('no translations found');
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlcG8iLCJzdGFydCIsIkRhdGUiLCJub3ciLCJyb290UGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJiYWJlbFBhdGgiLCJjb25nbG9tZXJhdGVTdHJpbmdGaWxlTmFtZSIsImNvbmdsb21lcmF0ZVN0cmluZ09iamVjdCIsImJhYmVsUmVwb1BhdGgiLCJsb2NhbGVSZWdleCIsInN0cmluZ0ZpbGVzIiwicGF0aHMiLCJyZWFkZGlyU3luYyIsInB1c2giLCJtYXAiLCJwIiwiZSIsImVuZ2xpc2hTdHJpbmdQYXRoIiwiZXhpc3RzU3luYyIsImxlbmd0aCIsInN0cmluZ0ZpbGUiLCJsb2NhbGVNYXRjaGVzIiwibWF0Y2giLCJsb2NhbGUiLCJzdHJpbmdGaWxlQ29udGVudHMiLCJyZWFkRmlsZVN5bmMiLCJwYXJzZWRTdHJpbmdGaWxlQ29udGVudHMiLCJKU09OIiwicGFyc2UiLCJvYmplY3RUb0FkZFRvTG9jYWxlIiwic3RyaW5nS2V5IiwiT2JqZWN0Iiwia2V5cyIsInZhbHVlIiwib3V0cHV0RGlyIiwibWtkaXJTeW5jIiwib3V0cHV0UGF0aCIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJlbmQiLCJjb25zb2xlIiwibG9nIl0sInNvdXJjZXMiOlsiZ2VuZXJhdGVEZXZlbG9wbWVudFN0cmluZ3MuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoaXMgc2NyaXB0IG1ha2VzIGEgSlNPTiBmaWxlIHRoYXQgY29tYmluZXMgdHJhbnNsYXRpb25zIGZvciBhbGwgbG9jYWxlcyBpbiBhIHJlcG8uIEVhY2ggbG9jYWxlIG9iamVjdCBoYXMgZXZlcnlcclxuICogc3RyaW5nIGtleS90cmFuc2xhdGVkLXZhbHVlIHBhaXIgd2UgaGF2ZSBmb3IgdGhhdCBsb2NhbGUuIFRoaXMgaXMgdXNlZCB3aGVuIHJ1bm5pbmcgdGhlIHVuYnVpbHQgbW9kZSBzaW11bGF0aW9uIHdpdGhcclxuICogbG9jYWxlcz0qXHJcbiAqXHJcbiAqIEBhdXRob3IgTGlhbSBNdWxoYWxsIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbi8vIGltcG9ydHNcclxuY29uc3QgZnMgPSByZXF1aXJlKCAnZnMnICk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCAncGF0aCcgKTtcclxuXHJcbi8qKlxyXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVwbyAtIHJlcG8gdG8gZ2VuZXJhdGUgc3RyaW5ncyBmb3JcclxuICovXHJcbm1vZHVsZS5leHBvcnRzID0gcmVwbyA9PiB7XHJcblxyXG4gIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgY29uc3Qgcm9vdFBhdGggPSBwYXRoLmpvaW4oIF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJyApO1xyXG5cclxuICAvLyBPUy1pbmRlcGVuZGVudCBwYXRoIHRvIGJhYmVsIHJlcG8uXHJcbiAgY29uc3QgYmFiZWxQYXRoID0gcGF0aC5qb2luKCByb290UGF0aCwgJ2JhYmVsJyApO1xyXG5cclxuICAvLyBDcmVhdGUgYSBmaWxlIG5hbWUgZm9yIHRoZSBjb25nbG9tZXJhdGUgc3RyaW5nIGZpbGUuXHJcbiAgY29uc3QgY29uZ2xvbWVyYXRlU3RyaW5nRmlsZU5hbWUgPSBgJHtyZXBvfV9hbGwuanNvbmA7XHJcblxyXG4gIC8vIENyZWF0ZSBhbiBlbXB0eSBvYmplY3QgZm9yIHRoZSBjb25nbG9tZXJhdGUgc3RyaW5nIGZpbGUgdGhhdCB3ZSB3aWxsIGFkZCB0byBsYXRlci5cclxuICBjb25zdCBjb25nbG9tZXJhdGVTdHJpbmdPYmplY3QgPSB7fTtcclxuXHJcbiAgLy8gR2V0IGFuIGFycmF5IG9mIGZpbGVzIChzdHJpbmcgZmlsZXMpIGluIHRoZSByZXBvIHN1YmRpcmVjdG9yeS5cclxuICBjb25zdCBiYWJlbFJlcG9QYXRoID0gcGF0aC5qb2luKCBiYWJlbFBhdGgsIHJlcG8gKTtcclxuXHJcbiAgLy8gUmVnZXggZm9yIGV4dHJhY3RpbmcgbG9jYWxlIGZyb20gZmlsZSBuYW1lLlxyXG4gIGNvbnN0IGxvY2FsZVJlZ2V4ID0gLyg/PD1fKSguKikoPz0uanNvbikvO1xyXG5cclxuICBjb25zdCBzdHJpbmdGaWxlcyA9IFtdO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBwYXRocyA9IGZzLnJlYWRkaXJTeW5jKCBiYWJlbFJlcG9QYXRoICk7XHJcbiAgICBzdHJpbmdGaWxlcy5wdXNoKCAuLi5wYXRocy5tYXAoIHAgPT4gcGF0aC5qb2luKCBiYWJlbFJlcG9QYXRoLCBwICkgKSApO1xyXG4gIH1cclxuICBjYXRjaCggZSApIHtcclxuXHJcbiAgICAvLyBubyB0cmFuc2xhdGlvbnMgZm91bmQgaW4gYmFiZWwuIEJ1dCB3ZSBzdGlsbCBtdXN0IGNvbnRpbnVlIGluIG9yZGVyIHRvIGdlbmVyYXRlIGFuIChhbGJlaXQgZW1wdHkpIHN0cmluZyBmaWxlLlxyXG4gIH1cclxuXHJcbiAgY29uc3QgZW5nbGlzaFN0cmluZ1BhdGggPSBwYXRoLmpvaW4oIHJvb3RQYXRoLCByZXBvLCBgJHtyZXBvfS1zdHJpbmdzX2VuLmpzb25gICk7XHJcbiAgaWYgKCBmcy5leGlzdHNTeW5jKCBlbmdsaXNoU3RyaW5nUGF0aCApICkge1xyXG4gICAgc3RyaW5nRmlsZXMucHVzaCggZW5nbGlzaFN0cmluZ1BhdGggKTtcclxuICB9XHJcblxyXG4gIC8vIERvIG5vdCBnZW5lcmF0ZSBhIGZpbGUgaWYgbm8gdHJhbnNsYXRpb25zIHdlcmUgZm91bmQuXHJcbiAgaWYgKCBzdHJpbmdGaWxlcy5sZW5ndGggPiAwICkge1xyXG5cclxuICAgIC8vIEZvciBlYWNoIHN0cmluZyBmaWxlIGluIHRoZSByZXBvIHN1YmRpcmVjdG9yeS4uLlxyXG4gICAgZm9yICggY29uc3Qgc3RyaW5nRmlsZSBvZiBzdHJpbmdGaWxlcyApIHtcclxuXHJcbiAgICAgIC8vIEV4dHJhY3QgdGhlIGxvY2FsZS5cclxuICAgICAgY29uc3QgbG9jYWxlTWF0Y2hlcyA9IHN0cmluZ0ZpbGUubWF0Y2goIGxvY2FsZVJlZ2V4ICk7XHJcbiAgICAgIGNvbnN0IGxvY2FsZSA9IGxvY2FsZU1hdGNoZXNbIDAgXTtcclxuXHJcbiAgICAgIC8vIEdldCB0aGUgY29udGVudHMgb2YgdGhlIHN0cmluZyBmaWxlLlxyXG4gICAgICBjb25zdCBzdHJpbmdGaWxlQ29udGVudHMgPSBmcy5yZWFkRmlsZVN5bmMoIHN0cmluZ0ZpbGUsICd1dGY4JyApO1xyXG5cclxuICAgICAgLy8gUGFyc2UgdGhlIHN0cmluZyBmaWxlIGNvbnRlbnRzLlxyXG4gICAgICBjb25zdCBwYXJzZWRTdHJpbmdGaWxlQ29udGVudHMgPSBKU09OLnBhcnNlKCBzdHJpbmdGaWxlQ29udGVudHMgKTtcclxuXHJcbiAgICAgIC8vIEFkZCBvbmx5IHRoZSB2YWx1ZXMgb2YgdGhlIHN0cmluZyBmaWxlIHRvIHRoZSBuZXcgY29uZ2xvbWVyYXRlIHN0cmluZyBmaWxlLCBhbmQgaWdub3JlIG90aGVyIGZpZWxkcywgc3VjaCBhc1xyXG4gICAgICAvLyB0aGUgaGlzdG9yeS5cclxuICAgICAgY29uc3Qgb2JqZWN0VG9BZGRUb0xvY2FsZSA9IHt9O1xyXG4gICAgICBmb3IgKCBjb25zdCBzdHJpbmdLZXkgb2YgT2JqZWN0LmtleXMoIHBhcnNlZFN0cmluZ0ZpbGVDb250ZW50cyApICkge1xyXG4gICAgICAgIG9iamVjdFRvQWRkVG9Mb2NhbGVbIHN0cmluZ0tleSBdID0ge1xyXG4gICAgICAgICAgdmFsdWU6IHBhcnNlZFN0cmluZ0ZpbGVDb250ZW50c1sgc3RyaW5nS2V5IF0udmFsdWVcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBBZGQgdGhlIHN0cmluZyB2YWx1ZXMgdG8gdGhlIGxvY2FsZSBvYmplY3Qgb2YgdGhlIGNvbmdsb21lcmF0ZSBzdHJpbmcgb2JqZWN0LlxyXG4gICAgICBjb25nbG9tZXJhdGVTdHJpbmdPYmplY3RbIGxvY2FsZSBdID0gb2JqZWN0VG9BZGRUb0xvY2FsZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNYWtlIHN1cmUgdGhlIG91dHB1dCBkaXJlY3RvcnkgZXhpc3RzLiAgVGhlIG5hbWUgc3RhcnRzIHdpdGggYW4gdW5kZXJzY29yZSBzbyB0aGF0IGl0IGFwcGVhcnMgYWxwaGFiZXRpY2FsbHlcclxuICAgIC8vIGZpcnN0IGFuZCBsb29rcyBkaWZmZXJlbnQgZnJvbSB0aGUgcmVwbyBuYW1lcy5cclxuICAgIGNvbnN0IG91dHB1dERpciA9IHBhdGguam9pbiggYmFiZWxQYXRoLCAnX2dlbmVyYXRlZF9kZXZlbG9wbWVudF9zdHJpbmdzJyApO1xyXG4gICAgdHJ5IHtcclxuICAgICAgZnMubWtkaXJTeW5jKCBvdXRwdXREaXIgKTtcclxuICAgIH1cclxuICAgIGNhdGNoKCBlICkge1xyXG4gICAgICAvLyBhbHJlYWR5IGV4aXN0c1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG91dHB1dFBhdGggPSBwYXRoLmpvaW4oIG91dHB1dERpciwgY29uZ2xvbWVyYXRlU3RyaW5nRmlsZU5hbWUgKTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMoIG91dHB1dFBhdGgsIEpTT04uc3RyaW5naWZ5KCBjb25nbG9tZXJhdGVTdHJpbmdPYmplY3QsIG51bGwsIDIgKSApO1xyXG5cclxuICAgIGNvbnN0IGVuZCA9IERhdGUubm93KCk7XHJcbiAgICBjb25zb2xlLmxvZyggJ1dyb3RlICcgKyBvdXRwdXRQYXRoICsgJyBpbiAnICsgKCBlbmQgLSBzdGFydCApICsgJ21zJyApO1xyXG4gIH1cclxuICBlbHNlIHtcclxuICAgIGNvbnNvbGUubG9nKCAnbm8gdHJhbnNsYXRpb25zIGZvdW5kJyApO1xyXG4gIH1cclxufTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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