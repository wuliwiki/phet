// Copyright 2017-2023, University of Colorado Boulder

/**
 * Builds standalone JS deliverables (e.g. dot/kite/scenery)
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

// modules
const assert = require('assert');
const fs = require('fs');
const grunt = require('grunt');
const minify = require('./minify');
const webpackBuild = require('./webpackBuild');
const _ = require('lodash');
const getStringMap = require('./getStringMap');
const ChipperConstants = require('../common/ChipperConstants');
const getLocalesFromRepository = require('./getLocalesFromRepository');
const getPhetLibs = require('./getPhetLibs');

/**
 * Builds standalone JS deliverables (e.g. dot/kite/scenery)
 * @public
 *
 * @param {string} repo
 * @param {Object} providedOptions - Passed directly to minify()
 * @returns {Promise<string>}
 */
module.exports = async function (repo, providedOptions) {
  assert(typeof repo === 'string');
  assert(typeof providedOptions === 'object');
  const options = _.merge({
    isDebug: false,
    // {null|string[]} - if provided, exclude these preloads from the built standalone
    omitPreloads: null,
    // For concurrent builds, provide a unique output dir for the webpack process, default to the repo building
    tempOutputDir: repo
  }, providedOptions);
  const packageObject = grunt.file.readJSON(`../${repo}/package.json`);
  assert(packageObject.phet, '`phet` object expected in package.json');
  const webpackResult = await webpackBuild(repo, 'phet', {
    outputDir: options.tempOutputDir
  });
  const webpackJS = webpackResult.js;
  let includedSources = ['../assert/js/assert.js', '../tandem/js/PhetioIDUtils.js'];

  // add repo-specific preloads from package.json
  if (packageObject.phet.preload) {
    assert(Array.isArray(packageObject.phet.preload), 'preload should be an array');
    includedSources = includedSources.concat(packageObject.phet.preload);

    // NOTE: Should find a better way of handling putting these first
    includedSources.forEach((source, index) => {
      if (source.includes('sherpa/lib/lodash-')) {
        includedSources.splice(index, 1);
        includedSources.unshift(source);
      }
    });
    includedSources.forEach((source, index) => {
      if (source.includes('sherpa/lib/jquery-')) {
        includedSources.splice(index, 1);
        includedSources.unshift(source);
      }
    });
  }
  if (options.omitPreloads) {
    includedSources = includedSources.filter(source => !options.omitPreloads.includes(source));
  }
  let includedJS = includedSources.map(file => fs.readFileSync(file, 'utf8')).join('\n');

  // Checks if lodash exists
  const testLodash = '  if ( !window.hasOwnProperty( \'_\' ) ) {\n' + '    throw new Error( \'Underscore/Lodash not found: _\' );\n' + '  }\n';
  // Checks if jQuery exists
  const testJQuery = '  if ( !window.hasOwnProperty( \'$\' ) ) {\n' + '    throw new Error( \'jQuery not found: $\' );\n' + '  }\n';
  const debugJS = '\nwindow.assertions.enableAssert();\n';
  if (options.isDebug) {
    includedJS += debugJS;
  }
  let fullSource = `${includedJS}\n${webpackJS}`;
  if (packageObject.phet.requiresJQuery) {
    fullSource = testJQuery + fullSource;
  }
  if (packageObject.phet.requiresLodash) {
    fullSource = testLodash + fullSource;
  }

  // include globals assignment
  let globals = 'window.phet=window.phet||{}\n;';
  if (packageObject.name === 'phet-lib') {
    globals += `phet.chipper=phet.chipper||{};\nphet.chipper.packageObject=${JSON.stringify(packageObject)};\n`;
    const subRepos = ['scenery', 'sun', 'scenery-phet', 'twixt', 'mobius'];
    const phetLibs = _.uniq(_.flatten(subRepos.map(subRepo => {
      return getPhetLibs(subRepo);
    })).sort());
    const locales = [ChipperConstants.FALLBACK_LOCALE, ..._.flatten(subRepos.map(subRepo => getLocalesFromRepository(subRepo)))];
    const {
      stringMap,
      stringMetadata
    } = getStringMap(repo, locales, phetLibs, webpackResult.usedModules);
    globals += 'phet.chipper.stringPath = \'../\';\n';
    globals += 'phet.chipper.locale = \'en\';\n';
    globals += 'phet.chipper.loadModules = () => {};\n';
    globals += `phet.chipper.strings = ${JSON.stringify(stringMap, null, options.isDebug ? 2 : '')};\n`;
    globals += `phet.chipper.stringMetadata = ${JSON.stringify(stringMetadata, null, options.isDebug ? 2 : '')};\n`;
  }
  fullSource = `\n${globals}\n${fullSource}`;

  // Wrap with an IIFE
  fullSource = `(function() {\n${fullSource}\n}());`;
  fullSource = minify(fullSource, options);
  return fullSource;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhc3NlcnQiLCJyZXF1aXJlIiwiZnMiLCJncnVudCIsIm1pbmlmeSIsIndlYnBhY2tCdWlsZCIsIl8iLCJnZXRTdHJpbmdNYXAiLCJDaGlwcGVyQ29uc3RhbnRzIiwiZ2V0TG9jYWxlc0Zyb21SZXBvc2l0b3J5IiwiZ2V0UGhldExpYnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVwbyIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJtZXJnZSIsImlzRGVidWciLCJvbWl0UHJlbG9hZHMiLCJ0ZW1wT3V0cHV0RGlyIiwicGFja2FnZU9iamVjdCIsImZpbGUiLCJyZWFkSlNPTiIsInBoZXQiLCJ3ZWJwYWNrUmVzdWx0Iiwib3V0cHV0RGlyIiwid2VicGFja0pTIiwianMiLCJpbmNsdWRlZFNvdXJjZXMiLCJwcmVsb2FkIiwiQXJyYXkiLCJpc0FycmF5IiwiY29uY2F0IiwiZm9yRWFjaCIsInNvdXJjZSIsImluZGV4IiwiaW5jbHVkZXMiLCJzcGxpY2UiLCJ1bnNoaWZ0IiwiZmlsdGVyIiwiaW5jbHVkZWRKUyIsIm1hcCIsInJlYWRGaWxlU3luYyIsImpvaW4iLCJ0ZXN0TG9kYXNoIiwidGVzdEpRdWVyeSIsImRlYnVnSlMiLCJmdWxsU291cmNlIiwicmVxdWlyZXNKUXVlcnkiLCJyZXF1aXJlc0xvZGFzaCIsImdsb2JhbHMiLCJuYW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsInN1YlJlcG9zIiwicGhldExpYnMiLCJ1bmlxIiwiZmxhdHRlbiIsInN1YlJlcG8iLCJzb3J0IiwibG9jYWxlcyIsIkZBTExCQUNLX0xPQ0FMRSIsInN0cmluZ01hcCIsInN0cmluZ01ldGFkYXRhIiwidXNlZE1vZHVsZXMiXSwic291cmNlcyI6WyJidWlsZFN0YW5kYWxvbmUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTctMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQnVpbGRzIHN0YW5kYWxvbmUgSlMgZGVsaXZlcmFibGVzIChlLmcuIGRvdC9raXRlL3NjZW5lcnkpXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5cclxuLy8gbW9kdWxlc1xyXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKCAnYXNzZXJ0JyApO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoICdmcycgKTtcclxuY29uc3QgZ3J1bnQgPSByZXF1aXJlKCAnZ3J1bnQnICk7XHJcbmNvbnN0IG1pbmlmeSA9IHJlcXVpcmUoICcuL21pbmlmeScgKTtcclxuY29uc3Qgd2VicGFja0J1aWxkID0gcmVxdWlyZSggJy4vd2VicGFja0J1aWxkJyApO1xyXG5jb25zdCBfID0gcmVxdWlyZSggJ2xvZGFzaCcgKTtcclxuY29uc3QgZ2V0U3RyaW5nTWFwID0gcmVxdWlyZSggJy4vZ2V0U3RyaW5nTWFwJyApO1xyXG5jb25zdCBDaGlwcGVyQ29uc3RhbnRzID0gcmVxdWlyZSggJy4uL2NvbW1vbi9DaGlwcGVyQ29uc3RhbnRzJyApO1xyXG5jb25zdCBnZXRMb2NhbGVzRnJvbVJlcG9zaXRvcnkgPSByZXF1aXJlKCAnLi9nZXRMb2NhbGVzRnJvbVJlcG9zaXRvcnknICk7XHJcbmNvbnN0IGdldFBoZXRMaWJzID0gcmVxdWlyZSggJy4vZ2V0UGhldExpYnMnICk7XHJcblxyXG4vKipcclxuICogQnVpbGRzIHN0YW5kYWxvbmUgSlMgZGVsaXZlcmFibGVzIChlLmcuIGRvdC9raXRlL3NjZW5lcnkpXHJcbiAqIEBwdWJsaWNcclxuICpcclxuICogQHBhcmFtIHtzdHJpbmd9IHJlcG9cclxuICogQHBhcmFtIHtPYmplY3R9IHByb3ZpZGVkT3B0aW9ucyAtIFBhc3NlZCBkaXJlY3RseSB0byBtaW5pZnkoKVxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiggcmVwbywgcHJvdmlkZWRPcHRpb25zICkge1xyXG4gIGFzc2VydCggdHlwZW9mIHJlcG8gPT09ICdzdHJpbmcnICk7XHJcbiAgYXNzZXJ0KCB0eXBlb2YgcHJvdmlkZWRPcHRpb25zID09PSAnb2JqZWN0JyApO1xyXG5cclxuICBjb25zdCBvcHRpb25zID0gXy5tZXJnZSgge1xyXG4gICAgaXNEZWJ1ZzogZmFsc2UsXHJcblxyXG4gICAgLy8ge251bGx8c3RyaW5nW119IC0gaWYgcHJvdmlkZWQsIGV4Y2x1ZGUgdGhlc2UgcHJlbG9hZHMgZnJvbSB0aGUgYnVpbHQgc3RhbmRhbG9uZVxyXG4gICAgb21pdFByZWxvYWRzOiBudWxsLFxyXG5cclxuICAgIC8vIEZvciBjb25jdXJyZW50IGJ1aWxkcywgcHJvdmlkZSBhIHVuaXF1ZSBvdXRwdXQgZGlyIGZvciB0aGUgd2VicGFjayBwcm9jZXNzLCBkZWZhdWx0IHRvIHRoZSByZXBvIGJ1aWxkaW5nXHJcbiAgICB0ZW1wT3V0cHV0RGlyOiByZXBvXHJcbiAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gIGNvbnN0IHBhY2thZ2VPYmplY3QgPSBncnVudC5maWxlLnJlYWRKU09OKCBgLi4vJHtyZXBvfS9wYWNrYWdlLmpzb25gICk7XHJcbiAgYXNzZXJ0KCBwYWNrYWdlT2JqZWN0LnBoZXQsICdgcGhldGAgb2JqZWN0IGV4cGVjdGVkIGluIHBhY2thZ2UuanNvbicgKTtcclxuXHJcbiAgY29uc3Qgd2VicGFja1Jlc3VsdCA9ICggYXdhaXQgd2VicGFja0J1aWxkKCByZXBvLCAncGhldCcsIHsgb3V0cHV0RGlyOiBvcHRpb25zLnRlbXBPdXRwdXREaXIgfSApICk7XHJcblxyXG4gIGNvbnN0IHdlYnBhY2tKUyA9IHdlYnBhY2tSZXN1bHQuanM7XHJcblxyXG4gIGxldCBpbmNsdWRlZFNvdXJjZXMgPSBbXHJcbiAgICAnLi4vYXNzZXJ0L2pzL2Fzc2VydC5qcycsXHJcbiAgICAnLi4vdGFuZGVtL2pzL1BoZXRpb0lEVXRpbHMuanMnXHJcbiAgXTtcclxuXHJcbiAgLy8gYWRkIHJlcG8tc3BlY2lmaWMgcHJlbG9hZHMgZnJvbSBwYWNrYWdlLmpzb25cclxuICBpZiAoIHBhY2thZ2VPYmplY3QucGhldC5wcmVsb2FkICkge1xyXG4gICAgYXNzZXJ0KCBBcnJheS5pc0FycmF5KCBwYWNrYWdlT2JqZWN0LnBoZXQucHJlbG9hZCApLCAncHJlbG9hZCBzaG91bGQgYmUgYW4gYXJyYXknICk7XHJcbiAgICBpbmNsdWRlZFNvdXJjZXMgPSBpbmNsdWRlZFNvdXJjZXMuY29uY2F0KCBwYWNrYWdlT2JqZWN0LnBoZXQucHJlbG9hZCApO1xyXG5cclxuICAgIC8vIE5PVEU6IFNob3VsZCBmaW5kIGEgYmV0dGVyIHdheSBvZiBoYW5kbGluZyBwdXR0aW5nIHRoZXNlIGZpcnN0XHJcbiAgICBpbmNsdWRlZFNvdXJjZXMuZm9yRWFjaCggKCBzb3VyY2UsIGluZGV4ICkgPT4ge1xyXG4gICAgICBpZiAoIHNvdXJjZS5pbmNsdWRlcyggJ3NoZXJwYS9saWIvbG9kYXNoLScgKSApIHtcclxuICAgICAgICBpbmNsdWRlZFNvdXJjZXMuc3BsaWNlKCBpbmRleCwgMSApO1xyXG4gICAgICAgIGluY2x1ZGVkU291cmNlcy51bnNoaWZ0KCBzb3VyY2UgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gICAgaW5jbHVkZWRTb3VyY2VzLmZvckVhY2goICggc291cmNlLCBpbmRleCApID0+IHtcclxuICAgICAgaWYgKCBzb3VyY2UuaW5jbHVkZXMoICdzaGVycGEvbGliL2pxdWVyeS0nICkgKSB7XHJcbiAgICAgICAgaW5jbHVkZWRTb3VyY2VzLnNwbGljZSggaW5kZXgsIDEgKTtcclxuICAgICAgICBpbmNsdWRlZFNvdXJjZXMudW5zaGlmdCggc291cmNlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICB9XHJcbiAgaWYgKCBvcHRpb25zLm9taXRQcmVsb2FkcyApIHtcclxuICAgIGluY2x1ZGVkU291cmNlcyA9IGluY2x1ZGVkU291cmNlcy5maWx0ZXIoIHNvdXJjZSA9PiAhb3B0aW9ucy5vbWl0UHJlbG9hZHMuaW5jbHVkZXMoIHNvdXJjZSApICk7XHJcbiAgfVxyXG5cclxuICBsZXQgaW5jbHVkZWRKUyA9IGluY2x1ZGVkU291cmNlcy5tYXAoIGZpbGUgPT4gZnMucmVhZEZpbGVTeW5jKCBmaWxlLCAndXRmOCcgKSApLmpvaW4oICdcXG4nICk7XHJcblxyXG4gIC8vIENoZWNrcyBpZiBsb2Rhc2ggZXhpc3RzXHJcbiAgY29uc3QgdGVzdExvZGFzaCA9ICcgIGlmICggIXdpbmRvdy5oYXNPd25Qcm9wZXJ0eSggXFwnX1xcJyApICkge1xcbicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAnICAgIHRocm93IG5ldyBFcnJvciggXFwnVW5kZXJzY29yZS9Mb2Rhc2ggbm90IGZvdW5kOiBfXFwnICk7XFxuJyArXHJcbiAgICAgICAgICAgICAgICAgICAgICcgIH1cXG4nO1xyXG4gIC8vIENoZWNrcyBpZiBqUXVlcnkgZXhpc3RzXHJcbiAgY29uc3QgdGVzdEpRdWVyeSA9ICcgIGlmICggIXdpbmRvdy5oYXNPd25Qcm9wZXJ0eSggXFwnJFxcJyApICkge1xcbicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAnICAgIHRocm93IG5ldyBFcnJvciggXFwnalF1ZXJ5IG5vdCBmb3VuZDogJFxcJyApO1xcbicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAnICB9XFxuJztcclxuXHJcbiAgY29uc3QgZGVidWdKUyA9ICdcXG53aW5kb3cuYXNzZXJ0aW9ucy5lbmFibGVBc3NlcnQoKTtcXG4nO1xyXG4gIGlmICggb3B0aW9ucy5pc0RlYnVnICkge1xyXG4gICAgaW5jbHVkZWRKUyArPSBkZWJ1Z0pTO1xyXG4gIH1cclxuXHJcbiAgbGV0IGZ1bGxTb3VyY2UgPSBgJHtpbmNsdWRlZEpTfVxcbiR7d2VicGFja0pTfWA7XHJcbiAgaWYgKCBwYWNrYWdlT2JqZWN0LnBoZXQucmVxdWlyZXNKUXVlcnkgKSB7XHJcbiAgICBmdWxsU291cmNlID0gdGVzdEpRdWVyeSArIGZ1bGxTb3VyY2U7XHJcbiAgfVxyXG4gIGlmICggcGFja2FnZU9iamVjdC5waGV0LnJlcXVpcmVzTG9kYXNoICkge1xyXG4gICAgZnVsbFNvdXJjZSA9IHRlc3RMb2Rhc2ggKyBmdWxsU291cmNlO1xyXG4gIH1cclxuXHJcbiAgLy8gaW5jbHVkZSBnbG9iYWxzIGFzc2lnbm1lbnRcclxuICBsZXQgZ2xvYmFscyA9ICd3aW5kb3cucGhldD13aW5kb3cucGhldHx8e31cXG47JztcclxuICBpZiAoIHBhY2thZ2VPYmplY3QubmFtZSA9PT0gJ3BoZXQtbGliJyApIHtcclxuICAgIGdsb2JhbHMgKz0gYHBoZXQuY2hpcHBlcj1waGV0LmNoaXBwZXJ8fHt9O1xcbnBoZXQuY2hpcHBlci5wYWNrYWdlT2JqZWN0PSR7SlNPTi5zdHJpbmdpZnkoIHBhY2thZ2VPYmplY3QgKX07XFxuYDtcclxuXHJcbiAgICBjb25zdCBzdWJSZXBvcyA9IFsgJ3NjZW5lcnknLCAnc3VuJywgJ3NjZW5lcnktcGhldCcsICd0d2l4dCcsICdtb2JpdXMnIF07XHJcblxyXG4gICAgY29uc3QgcGhldExpYnMgPSBfLnVuaXEoIF8uZmxhdHRlbiggc3ViUmVwb3MubWFwKCBzdWJSZXBvID0+IHtcclxuICAgICAgcmV0dXJuIGdldFBoZXRMaWJzKCBzdWJSZXBvICk7XHJcbiAgICB9ICkgKS5zb3J0KCkgKTtcclxuICAgIGNvbnN0IGxvY2FsZXMgPSBbXHJcbiAgICAgIENoaXBwZXJDb25zdGFudHMuRkFMTEJBQ0tfTE9DQUxFLFxyXG4gICAgICAuLi5fLmZsYXR0ZW4oIHN1YlJlcG9zLm1hcCggc3ViUmVwbyA9PiBnZXRMb2NhbGVzRnJvbVJlcG9zaXRvcnkoIHN1YlJlcG8gKSApIClcclxuICAgIF07XHJcbiAgICBjb25zdCB7IHN0cmluZ01hcCwgc3RyaW5nTWV0YWRhdGEgfSA9IGdldFN0cmluZ01hcCggcmVwbywgbG9jYWxlcywgcGhldExpYnMsIHdlYnBhY2tSZXN1bHQudXNlZE1vZHVsZXMgKTtcclxuXHJcbiAgICBnbG9iYWxzICs9ICdwaGV0LmNoaXBwZXIuc3RyaW5nUGF0aCA9IFxcJy4uL1xcJztcXG4nO1xyXG4gICAgZ2xvYmFscyArPSAncGhldC5jaGlwcGVyLmxvY2FsZSA9IFxcJ2VuXFwnO1xcbic7XHJcbiAgICBnbG9iYWxzICs9ICdwaGV0LmNoaXBwZXIubG9hZE1vZHVsZXMgPSAoKSA9PiB7fTtcXG4nO1xyXG4gICAgZ2xvYmFscyArPSBgcGhldC5jaGlwcGVyLnN0cmluZ3MgPSAke0pTT04uc3RyaW5naWZ5KCBzdHJpbmdNYXAsIG51bGwsIG9wdGlvbnMuaXNEZWJ1ZyA/IDIgOiAnJyApfTtcXG5gO1xyXG4gICAgZ2xvYmFscyArPSBgcGhldC5jaGlwcGVyLnN0cmluZ01ldGFkYXRhID0gJHtKU09OLnN0cmluZ2lmeSggc3RyaW5nTWV0YWRhdGEsIG51bGwsIG9wdGlvbnMuaXNEZWJ1ZyA/IDIgOiAnJyApfTtcXG5gO1xyXG4gIH1cclxuICBmdWxsU291cmNlID0gYFxcbiR7Z2xvYmFsc31cXG4ke2Z1bGxTb3VyY2V9YDtcclxuXHJcbiAgLy8gV3JhcCB3aXRoIGFuIElJRkVcclxuICBmdWxsU291cmNlID0gYChmdW5jdGlvbigpIHtcXG4ke2Z1bGxTb3VyY2V9XFxufSgpKTtgO1xyXG5cclxuICBmdWxsU291cmNlID0gbWluaWZ5KCBmdWxsU291cmNlLCBvcHRpb25zICk7XHJcblxyXG4gIHJldHVybiBmdWxsU291cmNlO1xyXG59O1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0E7QUFDQSxNQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBRSxRQUFTLENBQUM7QUFDbEMsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUUsSUFBSyxDQUFDO0FBQzFCLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFFLE9BQVEsQ0FBQztBQUNoQyxNQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBRSxVQUFXLENBQUM7QUFDcEMsTUFBTUksWUFBWSxHQUFHSixPQUFPLENBQUUsZ0JBQWlCLENBQUM7QUFDaEQsTUFBTUssQ0FBQyxHQUFHTCxP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