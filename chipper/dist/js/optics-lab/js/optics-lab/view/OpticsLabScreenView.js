// Copyright 2014-2023, University of Colorado Boulder

/**
 * View for the 'Optics Lab' screen.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

// modules
// const ModelViewTransform2 = require( '/phetcommon/js/view/ModelViewTransform2' );
import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import ScreenView from '../../../../joist/js/ScreenView.js';
import ResetAllButton from '../../../../scenery-phet/js/buttons/ResetAllButton.js';
import opticsLab from '../../opticsLab.js';
import ComponentModel from '../model/ComponentModel.js';
import SourceModel from '../model/SourceModel.js';
import Type from '../model/Type.js';
import ComponentNode from './ComponentNode.js';
import ControlPanelManager from './ControlPanelManager.js';
import SourceNode from './SourceNode.js';
import ToolDrawerPanel from './ToolDrawerPanel.js';
class OpticsLabScreenView extends ScreenView {
  /**
   * @param {OpticsLabModel} opticsLabModel
   */
  constructor(opticsLabModel) {
    super({
      layoutBounds: new Bounds2(0, 0, 768, 504)
    });
    this.mainModel = opticsLabModel;
    this.selectedPieceProperty = new Property(null);
    this.controlPanelManager = new ControlPanelManager(this);
    this.addChild(this.controlPanelManager);

    // @public (read-only)
    this.toolDrawerPanel = new ToolDrawerPanel(this);
    this.addChild(this.toolDrawerPanel);

    //Layout
    this.controlPanelManager.left = 40; //this line crashes sim unless controlPanelManager has graphic content
    this.controlPanelManager.top = 10;
    this.toolDrawerPanel.bottom = this.layoutBounds.bottom - 10;
    this.toolDrawerPanel.centerX = this.layoutBounds.centerX;
    const resetAllButton = new ResetAllButton({
      listener: () => {
        opticsLabModel.reset();
      },
      right: this.layoutBounds.right - 20,
      top: this.toolDrawerPanel.top
    });
    this.addChild(resetAllButton);
  } //end constructor

  /**
   *
   * @param {Type} type
   * @param {Vector2} startPosition
   * @returns {SourceNode}
   * @private
   */
  addSource(type, startPosition) {
    let sourceModel;
    if (type === Type.FAN_SOURCE) {
      sourceModel = new SourceModel(this.mainModel, Type.FAN_SOURCE, 10, startPosition, 45, 0);
    } else {
      sourceModel = new SourceModel(this.mainModel, Type.BEAM_SOURCE, 10, startPosition, 0, 50);
    }
    this.mainModel.addSource(sourceModel);
    sourceModel.setPosition(startPosition);
    const sourceNode = new SourceNode(this.mainModel, sourceModel, this);
    this.addChild(sourceNode);
    return sourceNode;
    //sourceNode.addRayNodesToParent( this );
  }

  /**
   *
   * @param {Type} type
   * @param {Vector2} startPosition
   * @returns {ComponentNode}
   * @private
   */
  addComponent(type, startPosition) {
    let componentModel;
    switch (type) {
      case Type.CONVERGING_LENS:
        componentModel = new ComponentModel(this.mainModel, Type.CONVERGING_LENS, 125, 350, 1.8);
        break;
      case Type.DIVERGING_LENS:
        componentModel = new ComponentModel(this.mainModel, Type.DIVERGING_LENS, 125, -300, 1.8);
        break;
      case Type.CONVERGING_MIRROR:
        componentModel = new ComponentModel(this.mainModel, Type.CONVERGING_MIRROR, 125, 300, undefined);
        break;
      case Type.PLANE_MIRROR:
        componentModel = new ComponentModel(this.mainModel, Type.PLANE_MIRROR, 125, undefined, undefined);
        break;
      case Type.DIVERGING_MIRROR:
        componentModel = new ComponentModel(this.mainModel, Type.DIVERGING_MIRROR, 125, -300, undefined);
        break;
      case Type.SIMPLE_MASK:
        componentModel = new ComponentModel(this.mainModel, Type.SIMPLE_MASK, 125, 0, 0);
        break;
      case Type.SLIT_MASK:
        componentModel = new ComponentModel(this.mainModel, Type.SIMPLE_MASK, 100, 0, 0);
        break;
      default:
        throw new Error(`invalid type: ${type}`);
    } //end switch()
    let componentNode;
    if (componentModel !== undefined) {
      this.mainModel.addComponent(componentModel);
      componentNode = new ComponentNode(componentModel, this);
      this.addChild(componentNode);
      componentModel.setPosition(startPosition);
    }
    return componentNode;
  } //end addComponent()

  //A piece is either a source or a component
  /**
   *
   * @param {Type} type
   * @param {Vector2} startPosition
   * @returns {ComponentNode|SourceNode}
   * @public
   */
  addPiece(type, startPosition) {
    let newPiece;
    if (type === Type.FAN_SOURCE || type === Type.BEAM_SOURCE) {
      newPiece = this.addSource(type, startPosition);
    } else {
      newPiece = this.addComponent(type, startPosition);
    }
    //since it is a new piece, have to reset its control panel settings
    const panelIndex = this.controlPanelManager.getIndex(newPiece.type);
    const controlPanelOfThisType = this.controlPanelManager.controlPanels[panelIndex];
    controlPanelOfThisType.resetProperties();

    //this.controlPanelManager.displayControlPanelForNewPiece( newPiece );
    return newPiece;
  } //end AddPiece

  /**
   *
   * @param {SourceNode} sourceNode
   * @private
   */
  removeSource(sourceNode) {
    const sourceModel = sourceNode.pieceModel;

    // add guard see https://github.com/phetsims/optics-lab/issues/37
    if (this.hasChild(sourceNode)) {
      this.removeChild(sourceNode);
    }
    this.mainModel.removeSource(sourceModel);
  }

  /**
   *
   * @param {ComponentNode} componentNode
   * @private
   */
  removeComponent(componentNode) {
    // add guard see https://github.com/phetsims/optics-lab/issues/37
    if (this.hasChild(componentNode)) {
      this.removeChild(componentNode);
    }
    const componentModel = componentNode.pieceModel;
    this.mainModel.removeComponent(componentModel);
  }

  /**
   *
   * @param {SourceNode|ComponentNode} piece
   * @public
   */
  removePiece(piece) {
    const type = piece.type;
    if (type === Type.FAN_SOURCE || type === Type.BEAM_SOURCE) {
      this.removeSource(piece);
    } else {
      this.removeComponent(piece);
    }
  }

  /**
   *
   * @param {SourceNode|ComponentNode} piece
   * @public
   */
  setSelectedPiece(piece) {
    this.selectedPieceProperty.value = piece;
    piece.moveToFront();
  }
}
opticsLab.register('OpticsLabScreenView', OpticsLabScreenView);
export default OpticsLabScreenView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkJvdW5kczIiLCJTY3JlZW5WaWV3IiwiUmVzZXRBbGxCdXR0b24iLCJvcHRpY3NMYWIiLCJDb21wb25lbnRNb2RlbCIsIlNvdXJjZU1vZGVsIiwiVHlwZSIsIkNvbXBvbmVudE5vZGUiLCJDb250cm9sUGFuZWxNYW5hZ2VyIiwiU291cmNlTm9kZSIsIlRvb2xEcmF3ZXJQYW5lbCIsIk9wdGljc0xhYlNjcmVlblZpZXciLCJjb25zdHJ1Y3RvciIsIm9wdGljc0xhYk1vZGVsIiwibGF5b3V0Qm91bmRzIiwibWFpbk1vZGVsIiwic2VsZWN0ZWRQaWVjZVByb3BlcnR5IiwiY29udHJvbFBhbmVsTWFuYWdlciIsImFkZENoaWxkIiwidG9vbERyYXdlclBhbmVsIiwibGVmdCIsInRvcCIsImJvdHRvbSIsImNlbnRlclgiLCJyZXNldEFsbEJ1dHRvbiIsImxpc3RlbmVyIiwicmVzZXQiLCJyaWdodCIsImFkZFNvdXJjZSIsInR5cGUiLCJzdGFydFBvc2l0aW9uIiwic291cmNlTW9kZWwiLCJGQU5fU09VUkNFIiwiQkVBTV9TT1VSQ0UiLCJzZXRQb3NpdGlvbiIsInNvdXJjZU5vZGUiLCJhZGRDb21wb25lbnQiLCJjb21wb25lbnRNb2RlbCIsIkNPTlZFUkdJTkdfTEVOUyIsIkRJVkVSR0lOR19MRU5TIiwiQ09OVkVSR0lOR19NSVJST1IiLCJ1bmRlZmluZWQiLCJQTEFORV9NSVJST1IiLCJESVZFUkdJTkdfTUlSUk9SIiwiU0lNUExFX01BU0siLCJTTElUX01BU0siLCJFcnJvciIsImNvbXBvbmVudE5vZGUiLCJhZGRQaWVjZSIsIm5ld1BpZWNlIiwicGFuZWxJbmRleCIsImdldEluZGV4IiwiY29udHJvbFBhbmVsT2ZUaGlzVHlwZSIsImNvbnRyb2xQYW5lbHMiLCJyZXNldFByb3BlcnRpZXMiLCJyZW1vdmVTb3VyY2UiLCJwaWVjZU1vZGVsIiwiaGFzQ2hpbGQiLCJyZW1vdmVDaGlsZCIsInJlbW92ZUNvbXBvbmVudCIsInJlbW92ZVBpZWNlIiwicGllY2UiLCJzZXRTZWxlY3RlZFBpZWNlIiwidmFsdWUiLCJtb3ZlVG9Gcm9udCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiT3B0aWNzTGFiU2NyZWVuVmlldy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBWaWV3IGZvciB0aGUgJ09wdGljcyBMYWInIHNjcmVlbi5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5cclxuLy8gbW9kdWxlc1xyXG4vLyBjb25zdCBNb2RlbFZpZXdUcmFuc2Zvcm0yID0gcmVxdWlyZSggJy9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMicgKTtcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQm91bmRzMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvQm91bmRzMi5qcyc7XHJcbmltcG9ydCBTY3JlZW5WaWV3IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1NjcmVlblZpZXcuanMnO1xyXG5pbXBvcnQgUmVzZXRBbGxCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvUmVzZXRBbGxCdXR0b24uanMnO1xyXG5pbXBvcnQgb3B0aWNzTGFiIGZyb20gJy4uLy4uL29wdGljc0xhYi5qcyc7XHJcbmltcG9ydCBDb21wb25lbnRNb2RlbCBmcm9tICcuLi9tb2RlbC9Db21wb25lbnRNb2RlbC5qcyc7XHJcbmltcG9ydCBTb3VyY2VNb2RlbCBmcm9tICcuLi9tb2RlbC9Tb3VyY2VNb2RlbC5qcyc7XHJcbmltcG9ydCBUeXBlIGZyb20gJy4uL21vZGVsL1R5cGUuanMnO1xyXG5pbXBvcnQgQ29tcG9uZW50Tm9kZSBmcm9tICcuL0NvbXBvbmVudE5vZGUuanMnO1xyXG5pbXBvcnQgQ29udHJvbFBhbmVsTWFuYWdlciBmcm9tICcuL0NvbnRyb2xQYW5lbE1hbmFnZXIuanMnO1xyXG5pbXBvcnQgU291cmNlTm9kZSBmcm9tICcuL1NvdXJjZU5vZGUuanMnO1xyXG5pbXBvcnQgVG9vbERyYXdlclBhbmVsIGZyb20gJy4vVG9vbERyYXdlclBhbmVsLmpzJztcclxuXHJcbmNsYXNzIE9wdGljc0xhYlNjcmVlblZpZXcgZXh0ZW5kcyBTY3JlZW5WaWV3IHtcclxuICAvKipcclxuICAgKiBAcGFyYW0ge09wdGljc0xhYk1vZGVsfSBvcHRpY3NMYWJNb2RlbFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBvcHRpY3NMYWJNb2RlbCApIHtcclxuXHJcbiAgICBzdXBlciggeyBsYXlvdXRCb3VuZHM6IG5ldyBCb3VuZHMyKCAwLCAwLCA3NjgsIDUwNCApIH0gKTtcclxuXHJcbiAgICB0aGlzLm1haW5Nb2RlbCA9IG9wdGljc0xhYk1vZGVsO1xyXG4gICAgdGhpcy5zZWxlY3RlZFBpZWNlUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIG51bGwgKTtcclxuXHJcbiAgICB0aGlzLmNvbnRyb2xQYW5lbE1hbmFnZXIgPSBuZXcgQ29udHJvbFBhbmVsTWFuYWdlciggdGhpcyApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5jb250cm9sUGFuZWxNYW5hZ2VyICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KVxyXG4gICAgdGhpcy50b29sRHJhd2VyUGFuZWwgPSBuZXcgVG9vbERyYXdlclBhbmVsKCB0aGlzICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLnRvb2xEcmF3ZXJQYW5lbCApO1xyXG5cclxuICAgIC8vTGF5b3V0XHJcbiAgICB0aGlzLmNvbnRyb2xQYW5lbE1hbmFnZXIubGVmdCA9IDQwOyAgICAgICAvL3RoaXMgbGluZSBjcmFzaGVzIHNpbSB1bmxlc3MgY29udHJvbFBhbmVsTWFuYWdlciBoYXMgZ3JhcGhpYyBjb250ZW50XHJcbiAgICB0aGlzLmNvbnRyb2xQYW5lbE1hbmFnZXIudG9wID0gMTA7XHJcbiAgICB0aGlzLnRvb2xEcmF3ZXJQYW5lbC5ib3R0b20gPSB0aGlzLmxheW91dEJvdW5kcy5ib3R0b20gLSAxMDtcclxuICAgIHRoaXMudG9vbERyYXdlclBhbmVsLmNlbnRlclggPSB0aGlzLmxheW91dEJvdW5kcy5jZW50ZXJYO1xyXG5cclxuICAgIGNvbnN0IHJlc2V0QWxsQnV0dG9uID0gbmV3IFJlc2V0QWxsQnV0dG9uKCB7XHJcbiAgICAgICAgbGlzdGVuZXI6ICgpID0+IHtcclxuICAgICAgICAgIG9wdGljc0xhYk1vZGVsLnJlc2V0KCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICByaWdodDogdGhpcy5sYXlvdXRCb3VuZHMucmlnaHQgLSAyMCxcclxuICAgICAgICB0b3A6IHRoaXMudG9vbERyYXdlclBhbmVsLnRvcFxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIHRoaXMuYWRkQ2hpbGQoIHJlc2V0QWxsQnV0dG9uICk7XHJcblxyXG4gIH0vL2VuZCBjb25zdHJ1Y3RvclxyXG5cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7VHlwZX0gdHlwZVxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gc3RhcnRQb3NpdGlvblxyXG4gICAqIEByZXR1cm5zIHtTb3VyY2VOb2RlfVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgYWRkU291cmNlKCB0eXBlLCBzdGFydFBvc2l0aW9uICkge1xyXG4gICAgbGV0IHNvdXJjZU1vZGVsO1xyXG5cclxuICAgIGlmICggdHlwZSA9PT0gVHlwZS5GQU5fU09VUkNFXHJcbiAgICApIHtcclxuICAgICAgc291cmNlTW9kZWwgPSBuZXcgU291cmNlTW9kZWwoIHRoaXMubWFpbk1vZGVsLCBUeXBlLkZBTl9TT1VSQ0UsIDEwLCBzdGFydFBvc2l0aW9uLCA0NSwgMCApO1xyXG4gICAgfVxyXG5cclxuICAgIGVsc2Uge1xyXG4gICAgICBzb3VyY2VNb2RlbCA9IG5ldyBTb3VyY2VNb2RlbCggdGhpcy5tYWluTW9kZWwsIFR5cGUuQkVBTV9TT1VSQ0UsIDEwLCBzdGFydFBvc2l0aW9uLCAwLCA1MCApO1xyXG4gICAgfVxyXG4gICAgdGhpcy5tYWluTW9kZWwuYWRkU291cmNlKCBzb3VyY2VNb2RlbCApO1xyXG4gICAgc291cmNlTW9kZWwuc2V0UG9zaXRpb24oIHN0YXJ0UG9zaXRpb24gKTtcclxuICAgIGNvbnN0IHNvdXJjZU5vZGUgPSBuZXcgU291cmNlTm9kZSggdGhpcy5tYWluTW9kZWwsIHNvdXJjZU1vZGVsLCB0aGlzICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBzb3VyY2VOb2RlICk7XHJcbiAgICByZXR1cm4gc291cmNlTm9kZTtcclxuICAgIC8vc291cmNlTm9kZS5hZGRSYXlOb2Rlc1RvUGFyZW50KCB0aGlzICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7VHlwZX0gdHlwZVxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gc3RhcnRQb3NpdGlvblxyXG4gICAqIEByZXR1cm5zIHtDb21wb25lbnROb2RlfVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgYWRkQ29tcG9uZW50KCB0eXBlLCBzdGFydFBvc2l0aW9uICkge1xyXG4gICAgbGV0IGNvbXBvbmVudE1vZGVsO1xyXG4gICAgc3dpdGNoKCB0eXBlICkge1xyXG4gICAgICBjYXNlIFR5cGUuQ09OVkVSR0lOR19MRU5TOlxyXG4gICAgICAgIGNvbXBvbmVudE1vZGVsID0gbmV3IENvbXBvbmVudE1vZGVsKCB0aGlzLm1haW5Nb2RlbCwgVHlwZS5DT05WRVJHSU5HX0xFTlMsIDEyNSwgMzUwLCAxLjggKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBUeXBlLkRJVkVSR0lOR19MRU5TOlxyXG4gICAgICAgIGNvbXBvbmVudE1vZGVsID0gbmV3IENvbXBvbmVudE1vZGVsKCB0aGlzLm1haW5Nb2RlbCwgVHlwZS5ESVZFUkdJTkdfTEVOUywgMTI1LCAtMzAwLCAxLjggKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBUeXBlLkNPTlZFUkdJTkdfTUlSUk9SOlxyXG4gICAgICAgIGNvbXBvbmVudE1vZGVsID0gbmV3IENvbXBvbmVudE1vZGVsKCB0aGlzLm1haW5Nb2RlbCwgVHlwZS5DT05WRVJHSU5HX01JUlJPUiwgMTI1LCAzMDAsIHVuZGVmaW5lZCApO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIFR5cGUuUExBTkVfTUlSUk9SOlxyXG4gICAgICAgIGNvbXBvbmVudE1vZGVsID0gbmV3IENvbXBvbmVudE1vZGVsKCB0aGlzLm1haW5Nb2RlbCwgVHlwZS5QTEFORV9NSVJST1IsIDEyNSwgdW5kZWZpbmVkLCB1bmRlZmluZWQgKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBUeXBlLkRJVkVSR0lOR19NSVJST1I6XHJcbiAgICAgICAgY29tcG9uZW50TW9kZWwgPSBuZXcgQ29tcG9uZW50TW9kZWwoIHRoaXMubWFpbk1vZGVsLCBUeXBlLkRJVkVSR0lOR19NSVJST1IsIDEyNSwgLTMwMCwgdW5kZWZpbmVkICk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgVHlwZS5TSU1QTEVfTUFTSzpcclxuICAgICAgICBjb21wb25lbnRNb2RlbCA9IG5ldyBDb21wb25lbnRNb2RlbCggdGhpcy5tYWluTW9kZWwsIFR5cGUuU0lNUExFX01BU0ssIDEyNSwgMCwgMCApO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIFR5cGUuU0xJVF9NQVNLOlxyXG4gICAgICAgIGNvbXBvbmVudE1vZGVsID0gbmV3IENvbXBvbmVudE1vZGVsKCB0aGlzLm1haW5Nb2RlbCwgVHlwZS5TSU1QTEVfTUFTSywgMTAwLCAwLCAwICk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCBgaW52YWxpZCB0eXBlOiAke3R5cGV9YCApO1xyXG4gICAgfS8vZW5kIHN3aXRjaCgpXHJcbiAgICBsZXQgY29tcG9uZW50Tm9kZTtcclxuICAgIGlmICggY29tcG9uZW50TW9kZWwgIT09IHVuZGVmaW5lZCApIHtcclxuICAgICAgdGhpcy5tYWluTW9kZWwuYWRkQ29tcG9uZW50KCBjb21wb25lbnRNb2RlbCApO1xyXG4gICAgICBjb21wb25lbnROb2RlID0gbmV3IENvbXBvbmVudE5vZGUoIGNvbXBvbmVudE1vZGVsLCB0aGlzICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIGNvbXBvbmVudE5vZGUgKTtcclxuICAgICAgY29tcG9uZW50TW9kZWwuc2V0UG9zaXRpb24oIHN0YXJ0UG9zaXRpb24gKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjb21wb25lbnROb2RlO1xyXG5cclxuICB9Ly9lbmQgYWRkQ29tcG9uZW50KClcclxuXHJcbiAgLy9BIHBpZWNlIGlzIGVpdGhlciBhIHNvdXJjZSBvciBhIGNvbXBvbmVudFxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtUeXBlfSB0eXBlXHJcbiAgICogQHBhcmFtIHtWZWN0b3IyfSBzdGFydFBvc2l0aW9uXHJcbiAgICogQHJldHVybnMge0NvbXBvbmVudE5vZGV8U291cmNlTm9kZX1cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgYWRkUGllY2UoIHR5cGUsIHN0YXJ0UG9zaXRpb24gKSB7XHJcbiAgICBsZXQgbmV3UGllY2U7XHJcbiAgICBpZiAoIHR5cGUgPT09IFR5cGUuRkFOX1NPVVJDRSB8fCB0eXBlID09PSBUeXBlLkJFQU1fU09VUkNFICkge1xyXG4gICAgICBuZXdQaWVjZSA9IHRoaXMuYWRkU291cmNlKCB0eXBlLCBzdGFydFBvc2l0aW9uICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgbmV3UGllY2UgPSB0aGlzLmFkZENvbXBvbmVudCggdHlwZSwgc3RhcnRQb3NpdGlvbiApO1xyXG4gICAgfVxyXG4gICAgLy9zaW5jZSBpdCBpcyBhIG5ldyBwaWVjZSwgaGF2ZSB0byByZXNldCBpdHMgY29udHJvbCBwYW5lbCBzZXR0aW5nc1xyXG4gICAgY29uc3QgcGFuZWxJbmRleCA9IHRoaXMuY29udHJvbFBhbmVsTWFuYWdlci5nZXRJbmRleCggbmV3UGllY2UudHlwZSApO1xyXG4gICAgY29uc3QgY29udHJvbFBhbmVsT2ZUaGlzVHlwZSA9IHRoaXMuY29udHJvbFBhbmVsTWFuYWdlci5jb250cm9sUGFuZWxzWyBwYW5lbEluZGV4IF07XHJcbiAgICBjb250cm9sUGFuZWxPZlRoaXNUeXBlLnJlc2V0UHJvcGVydGllcygpO1xyXG5cclxuICAgIC8vdGhpcy5jb250cm9sUGFuZWxNYW5hZ2VyLmRpc3BsYXlDb250cm9sUGFuZWxGb3JOZXdQaWVjZSggbmV3UGllY2UgKTtcclxuICAgIHJldHVybiBuZXdQaWVjZTtcclxuICB9Ly9lbmQgQWRkUGllY2VcclxuXHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1NvdXJjZU5vZGV9IHNvdXJjZU5vZGVcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHJlbW92ZVNvdXJjZSggc291cmNlTm9kZSApIHtcclxuICAgIGNvbnN0IHNvdXJjZU1vZGVsID0gc291cmNlTm9kZS5waWVjZU1vZGVsO1xyXG5cclxuICAgIC8vIGFkZCBndWFyZCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL29wdGljcy1sYWIvaXNzdWVzLzM3XHJcbiAgICBpZiAoIHRoaXMuaGFzQ2hpbGQoIHNvdXJjZU5vZGUgKSApIHtcclxuICAgICAgdGhpcy5yZW1vdmVDaGlsZCggc291cmNlTm9kZSApO1xyXG4gICAgfVxyXG4gICAgdGhpcy5tYWluTW9kZWwucmVtb3ZlU291cmNlKCBzb3VyY2VNb2RlbCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge0NvbXBvbmVudE5vZGV9IGNvbXBvbmVudE5vZGVcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHJlbW92ZUNvbXBvbmVudCggY29tcG9uZW50Tm9kZSApIHtcclxuXHJcbiAgICAvLyBhZGQgZ3VhcmQgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9vcHRpY3MtbGFiL2lzc3Vlcy8zN1xyXG4gICAgaWYgKCB0aGlzLmhhc0NoaWxkKCBjb21wb25lbnROb2RlICkgKSB7XHJcbiAgICAgIHRoaXMucmVtb3ZlQ2hpbGQoIGNvbXBvbmVudE5vZGUgKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGNvbXBvbmVudE1vZGVsID0gY29tcG9uZW50Tm9kZS5waWVjZU1vZGVsO1xyXG4gICAgdGhpcy5tYWluTW9kZWwucmVtb3ZlQ29tcG9uZW50KCBjb21wb25lbnRNb2RlbCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1NvdXJjZU5vZGV8Q29tcG9uZW50Tm9kZX0gcGllY2VcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVtb3ZlUGllY2UoIHBpZWNlICkge1xyXG4gICAgY29uc3QgdHlwZSA9IHBpZWNlLnR5cGU7XHJcbiAgICBpZiAoIHR5cGUgPT09IFR5cGUuRkFOX1NPVVJDRSB8fCB0eXBlID09PSBUeXBlLkJFQU1fU09VUkNFICkge1xyXG4gICAgICB0aGlzLnJlbW92ZVNvdXJjZSggcGllY2UgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbW92ZUNvbXBvbmVudCggcGllY2UgKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U291cmNlTm9kZXxDb21wb25lbnROb2RlfSBwaWVjZVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzZXRTZWxlY3RlZFBpZWNlKCBwaWVjZSApIHtcclxuICAgIHRoaXMuc2VsZWN0ZWRQaWVjZVByb3BlcnR5LnZhbHVlID0gcGllY2U7XHJcbiAgICBwaWVjZS5tb3ZlVG9Gcm9udCgpO1xyXG4gIH1cclxufVxyXG5cclxub3B0aWNzTGFiLnJlZ2lzdGVyKCAnT3B0aWNzTGFiU2NyZWVuVmlldycsIE9wdGljc0xhYlNjcmVlblZpZXcgKTtcclxuZXhwb3J0IGRlZmF1bHQgT3B0aWNzTGFiU2NyZWVuVmlldztcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBO0FBQ0E7QUFDQSxPQUFPQSxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsVUFBVSxNQUFNLG9DQUFvQztBQUMzRCxPQUFPQyxjQUFjLE1BQU0sdURBQXVEO0FBQ2xGLE9BQU9DLFNBQVMsTUFBTSxvQkFBb0I7QUFDMUMsT0FBT0MsY0FBYyxNQUFNLDRCQUE0QjtBQUN2RCxPQUFPQyxXQUFXLE1BQU0seUJBQXlCO0FBQ2pELE9BQU9DLElBQUksTUFBTSxrQkFBa0I7QUFDbkMsT0FBT0MsYUFBYSxNQUFNLG9CQUFvQjtBQUM5QyxPQUFPQyxtQkFBbUIsTUFBTSwwQkFBMEI7QUFDMUQsT0FBT0MsVUFBVSxNQUFNLGlCQUFpQjtBQUN4QyxPQUFPQyxlQUFlLE1BQU0sc0JBQXNCO0FBRWxELE1BQU1DLG1CQUFtQixTQUFTVixVQUFVLENBQUM7RUFDM0M7QUFDRjtBQUNBO0VBQ0VXLFdBQVdBLENBQUVDLGNBQWMsRUFBRztJQUU1QixLQUFLLENBQUU7TUFBRUMsWUFBWSxFQUFFLElBQUlkLE9BQU8sQ0FBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFJO0lBQUUsQ0FBRSxDQUFDO0lBRXhELElBQUksQ0FBQ2UsU0FBUyxHQUFHRixjQUFjO0lBQy9CLElBQUksQ0FBQ0cscUJBQXFCLEdBQUcsSUFBSWpCLFFBQVEsQ0FBRSxJQUFLLENBQUM7SUFFakQsSUFBSSxDQUFDa0IsbUJBQW1CLEdBQUcsSUFBSVQsbUJBQW1CLENBQUUsSUFBSyxDQUFDO0lBQzFELElBQUksQ0FBQ1UsUUFBUSxDQUFFLElBQUksQ0FBQ0QsbUJBQW9CLENBQUM7O0lBRXpDO0lBQ0EsSUFBSSxDQUFDRSxl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