// Copyright 2016-2023, University of Colorado Boulder

/**
 * Toolbox from which the user can drag (or otherwise enable) tools.
 * The toolbox includes a measuring tape and a dataProbe tool.
 *
 * @author Andrea Lin (PhET Interactive Simulations)
 */

import ScreenView from '../../../../joist/js/ScreenView.js';
import MeasuringTapeNode from '../../../../scenery-phet/js/MeasuringTapeNode.js';
import { DragListener, HBox } from '../../../../scenery/js/imports.js';
import Panel from '../../../../sun/js/Panel.js';
import projectileMotion from '../../projectileMotion.js';
import DataProbeNode from './DataProbeNode.js';
import optionize from '../../../../phet-core/js/optionize.js';
class ToolboxPanel extends Panel {
  /**
   * @param measuringTape - model for the measuring tape
   * @param dataProbe - model for the dataProbe tool
   * @param measuringTapeNode - view for the measuring tape
   * @param dataProbeNode - view for the dataProbe tool
   */
  constructor(measuringTape, dataProbe, measuringTapeNode, dataProbeNode, transformProperty, providedOptions) {
    // The first object is an empty placeholder so none of the others get mutated
    // The second object is the default, in the constants files
    // The third object is options specific to this panel, which overrides the defaults
    // The fourth object is options given at time of construction, which overrides all the others

    //TODO: Combine with ProjectileMotionConstants.RIGHTSIDE_PANEL_OPTIONS - see https://github.com/phetsims/projectile-motion/issues/306
    const options = optionize()({
      xMargin: 12,
      yMargin: 18,
      fill: 'white',
      minWidth: 200
    }, providedOptions);

    // Create the icon Node for the dataProbe tool
    const dataProbeIconNode = DataProbeNode.createIcon(options.tandem.createTandem('dataProbeIconNode'));
    dataProbeIconNode.cursor = 'pointer';
    dataProbeIconNode.scale(0.4);

    // Create the icon image for the measuringTape
    const measuringTapeIconNode = MeasuringTapeNode.createIcon({
      tandem: options.tandem.createTandem('measuringTapeIconNode')
    });
    measuringTapeIconNode.cursor = 'pointer';
    measuringTapeIconNode.scale(0.8);

    // The content panel with the two icons
    const panelContent = new HBox({
      spacing: 30,
      children: [dataProbeIconNode, measuringTapeIconNode],
      excludeInvisibleChildrenFromBounds: false
    });

    // add the panelContent
    super(panelContent, options);

    // listens to the isUserControlled Property of the dataProbe tool
    // return the dataProbe to the toolboxPanel if not user Controlled and its position is located within the toolbox panel
    dataProbeNode.isUserControlledProperty.lazyLink(isUserControlled => {
      assert && assert(dataProbeNode.parent instanceof ScreenView);
      assert && assert(dataProbeNode.parent === this.parent);
      const dataProbeNodeBounds = dataProbeNode.getJustDataProbeBounds(); //globalToParentBounds( dataProbeNode.getGlobalBounds() );
      const toolboxBounds = dataProbeNode.globalToParentBounds(this.getGlobalBounds());
      if (!isUserControlled && this.visible && toolboxBounds.intersectsBounds(dataProbeNodeBounds.eroded(5))) {
        dataProbe.isActiveProperty.set(false);
      }
    });

    // When pressed, forwards dragging to the actual dataProbe Node
    dataProbeIconNode.addInputListener(DragListener.createForwardingListener(event => {
      dataProbe.isActiveProperty.set(true);

      // offset when pulling out of the toolbox so that the pointer isn't on top of the tool. Convert to parent point
      // because the DataProbeNode's DragListener is applying its pointer offset in the parent coordinate frame (see https://github.com/phetsims/scenery/issues/1014)
      const parentPoint = this.globalToParentPoint(event.pointer.point).plusXY(-180, 0);
      dataProbe.positionProperty.value = transformProperty.value.viewToModelPosition(parentPoint);
      dataProbeNode.dragListener.press(event, dataProbeNode);
    }, {
      allowTouchSnag: true
    }));

    // dataProbe visibility has the opposite visibility of the dataProbeIcon
    dataProbe.isActiveProperty.link(active => {
      dataProbeIconNode.visible = !active;
    });

    // listens to the isUserControlled Property of the measuring tape
    // return the measuring tape to the toolboxPanel if not user Controlled and its position is located within the toolbox panel
    measuringTapeNode.isBaseUserControlledProperty.lazyLink(isUserControlled => {
      assert && assert(measuringTapeNode.parent instanceof ScreenView);
      assert && assert(measuringTapeNode.parent === this.parent);
      const tapeBaseBounds = measuringTapeNode.localToParentBounds(measuringTapeNode.getLocalBaseBounds());
      const toolboxBounds = measuringTapeNode.globalToParentBounds(this.getGlobalBounds());
      if (!isUserControlled && this.visible && toolboxBounds.intersectsBounds(tapeBaseBounds.eroded(5))) {
        measuringTape.isActiveProperty.set(false);
      }
    });

    // determine the distance (in model coordinates) between the tip and the base position of the measuring tape
    const tipToBasePosition = measuringTape.tipPositionProperty.get().minus(measuringTape.basePositionProperty.get());

    // Add the listener that will allow the user to click on this and forward the dragging to the actual measuring tape node
    measuringTapeIconNode.addInputListener(DragListener.createForwardingListener(event => {
      measuringTape.isActiveProperty.set(true);
      const tapeBasePosition = measuringTapeNode.globalToParentPoint(measuringTapeNode.localToGlobalPoint(measuringTapeNode.getLocalBaseCenter()));
      const initialViewPosition = measuringTapeNode.globalToParentPoint(event.pointer.point).minus(tapeBasePosition);
      measuringTape.basePositionProperty.set(transformProperty.get().viewToModelPosition(initialViewPosition));
      measuringTape.tipPositionProperty.set(measuringTape.basePositionProperty.get().plus(tipToBasePosition));
      measuringTapeNode.startBaseDrag(event);
    }, {
      allowTouchSnag: true
    }));

    // measuringTape visibility has the opposite visibility of the measuringTape Icon
    measuringTape.isActiveProperty.link(active => {
      measuringTapeIconNode.visible = !active;
    });

    // Links for the toolboxPanel and its tools last for the lifetime of the sim, so they don't need to be disposed
  }
}

projectileMotion.register('ToolboxPanel', ToolboxPanel);
export default ToolboxPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY3JlZW5WaWV3IiwiTWVhc3VyaW5nVGFwZU5vZGUiLCJEcmFnTGlzdGVuZXIiLCJIQm94IiwiUGFuZWwiLCJwcm9qZWN0aWxlTW90aW9uIiwiRGF0YVByb2JlTm9kZSIsIm9wdGlvbml6ZSIsIlRvb2xib3hQYW5lbCIsImNvbnN0cnVjdG9yIiwibWVhc3VyaW5nVGFwZSIsImRhdGFQcm9iZSIsIm1lYXN1cmluZ1RhcGVOb2RlIiwiZGF0YVByb2JlTm9kZSIsInRyYW5zZm9ybVByb3BlcnR5IiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInhNYXJnaW4iLCJ5TWFyZ2luIiwiZmlsbCIsIm1pbldpZHRoIiwiZGF0YVByb2JlSWNvbk5vZGUiLCJjcmVhdGVJY29uIiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwiY3Vyc29yIiwic2NhbGUiLCJtZWFzdXJpbmdUYXBlSWNvbk5vZGUiLCJwYW5lbENvbnRlbnQiLCJzcGFjaW5nIiwiY2hpbGRyZW4iLCJleGNsdWRlSW52aXNpYmxlQ2hpbGRyZW5Gcm9tQm91bmRzIiwiaXNVc2VyQ29udHJvbGxlZFByb3BlcnR5IiwibGF6eUxpbmsiLCJpc1VzZXJDb250cm9sbGVkIiwiYXNzZXJ0IiwicGFyZW50IiwiZGF0YVByb2JlTm9kZUJvdW5kcyIsImdldEp1c3REYXRhUHJvYmVCb3VuZHMiLCJ0b29sYm94Qm91bmRzIiwiZ2xvYmFsVG9QYXJlbnRCb3VuZHMiLCJnZXRHbG9iYWxCb3VuZHMiLCJ2aXNpYmxlIiwiaW50ZXJzZWN0c0JvdW5kcyIsImVyb2RlZCIsImlzQWN0aXZlUHJvcGVydHkiLCJzZXQiLCJhZGRJbnB1dExpc3RlbmVyIiwiY3JlYXRlRm9yd2FyZGluZ0xpc3RlbmVyIiwiZXZlbnQiLCJwYXJlbnRQb2ludCIsImdsb2JhbFRvUGFyZW50UG9pbnQiLCJwb2ludGVyIiwicG9pbnQiLCJwbHVzWFkiLCJwb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJ2aWV3VG9Nb2RlbFBvc2l0aW9uIiwiZHJhZ0xpc3RlbmVyIiwicHJlc3MiLCJhbGxvd1RvdWNoU25hZyIsImxpbmsiLCJhY3RpdmUiLCJpc0Jhc2VVc2VyQ29udHJvbGxlZFByb3BlcnR5IiwidGFwZUJhc2VCb3VuZHMiLCJsb2NhbFRvUGFyZW50Qm91bmRzIiwiZ2V0TG9jYWxCYXNlQm91bmRzIiwidGlwVG9CYXNlUG9zaXRpb24iLCJ0aXBQb3NpdGlvblByb3BlcnR5IiwiZ2V0IiwibWludXMiLCJiYXNlUG9zaXRpb25Qcm9wZXJ0eSIsInRhcGVCYXNlUG9zaXRpb24iLCJsb2NhbFRvR2xvYmFsUG9pbnQiLCJnZXRMb2NhbEJhc2VDZW50ZXIiLCJpbml0aWFsVmlld1Bvc2l0aW9uIiwicGx1cyIsInN0YXJ0QmFzZURyYWciLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlRvb2xib3hQYW5lbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUb29sYm94IGZyb20gd2hpY2ggdGhlIHVzZXIgY2FuIGRyYWcgKG9yIG90aGVyd2lzZSBlbmFibGUpIHRvb2xzLlxyXG4gKiBUaGUgdG9vbGJveCBpbmNsdWRlcyBhIG1lYXN1cmluZyB0YXBlIGFuZCBhIGRhdGFQcm9iZSB0b29sLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEFuZHJlYSBMaW4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFNjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvU2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCBNZWFzdXJpbmdUYXBlTm9kZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvTWVhc3VyaW5nVGFwZU5vZGUuanMnO1xyXG5pbXBvcnQgeyBEcmFnTGlzdGVuZXIsIEhCb3ggfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgUGFuZWwsIHsgUGFuZWxPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3VuL2pzL1BhbmVsLmpzJztcclxuaW1wb3J0IHByb2plY3RpbGVNb3Rpb24gZnJvbSAnLi4vLi4vcHJvamVjdGlsZU1vdGlvbi5qcyc7XHJcbmltcG9ydCBEYXRhUHJvYmVOb2RlIGZyb20gJy4vRGF0YVByb2JlTm9kZS5qcyc7XHJcbmltcG9ydCBQcm9qZWN0aWxlTW90aW9uTWVhc3VyaW5nVGFwZSBmcm9tICcuLi9tb2RlbC9Qcm9qZWN0aWxlTW90aW9uTWVhc3VyaW5nVGFwZS5qcyc7XHJcbmltcG9ydCBEYXRhUHJvYmUgZnJvbSAnLi4vbW9kZWwvRGF0YVByb2JlLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIHhNYXJnaW4/OiBudW1iZXI7XHJcbiAgeU1hcmdpbj86IG51bWJlcjtcclxuICBmaWxsPzogc3RyaW5nO1xyXG4gIG1pbldpZHRoPzogbnVtYmVyO1xyXG59O1xyXG5cclxudHlwZSBUb29sYm94UGFuZWxPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQYW5lbE9wdGlvbnMgJiBQaWNrUmVxdWlyZWQ8UGFuZWxPcHRpb25zLCAndGFuZGVtJz47XHJcblxyXG5jbGFzcyBUb29sYm94UGFuZWwgZXh0ZW5kcyBQYW5lbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBtZWFzdXJpbmdUYXBlIC0gbW9kZWwgZm9yIHRoZSBtZWFzdXJpbmcgdGFwZVxyXG4gICAqIEBwYXJhbSBkYXRhUHJvYmUgLSBtb2RlbCBmb3IgdGhlIGRhdGFQcm9iZSB0b29sXHJcbiAgICogQHBhcmFtIG1lYXN1cmluZ1RhcGVOb2RlIC0gdmlldyBmb3IgdGhlIG1lYXN1cmluZyB0YXBlXHJcbiAgICogQHBhcmFtIGRhdGFQcm9iZU5vZGUgLSB2aWV3IGZvciB0aGUgZGF0YVByb2JlIHRvb2xcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIG1lYXN1cmluZ1RhcGU6IFByb2plY3RpbGVNb3Rpb25NZWFzdXJpbmdUYXBlLCBkYXRhUHJvYmU6IERhdGFQcm9iZSwgbWVhc3VyaW5nVGFwZU5vZGU6IE1lYXN1cmluZ1RhcGVOb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgZGF0YVByb2JlTm9kZTogRGF0YVByb2JlTm9kZSwgdHJhbnNmb3JtUHJvcGVydHk6IFByb3BlcnR5PE1vZGVsVmlld1RyYW5zZm9ybTI+LCBwcm92aWRlZE9wdGlvbnM/OiBUb29sYm94UGFuZWxPcHRpb25zICkge1xyXG5cclxuICAgIC8vIFRoZSBmaXJzdCBvYmplY3QgaXMgYW4gZW1wdHkgcGxhY2Vob2xkZXIgc28gbm9uZSBvZiB0aGUgb3RoZXJzIGdldCBtdXRhdGVkXHJcbiAgICAvLyBUaGUgc2Vjb25kIG9iamVjdCBpcyB0aGUgZGVmYXVsdCwgaW4gdGhlIGNvbnN0YW50cyBmaWxlc1xyXG4gICAgLy8gVGhlIHRoaXJkIG9iamVjdCBpcyBvcHRpb25zIHNwZWNpZmljIHRvIHRoaXMgcGFuZWwsIHdoaWNoIG92ZXJyaWRlcyB0aGUgZGVmYXVsdHNcclxuICAgIC8vIFRoZSBmb3VydGggb2JqZWN0IGlzIG9wdGlvbnMgZ2l2ZW4gYXQgdGltZSBvZiBjb25zdHJ1Y3Rpb24sIHdoaWNoIG92ZXJyaWRlcyBhbGwgdGhlIG90aGVyc1xyXG5cclxuICAgIC8vVE9ETzogQ29tYmluZSB3aXRoIFByb2plY3RpbGVNb3Rpb25Db25zdGFudHMuUklHSFRTSURFX1BBTkVMX09QVElPTlMgLSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3Byb2plY3RpbGUtbW90aW9uL2lzc3Vlcy8zMDZcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8VG9vbGJveFBhbmVsT3B0aW9ucywgU2VsZk9wdGlvbnMsIFBhbmVsT3B0aW9ucz4oKSgge1xyXG4gICAgICB4TWFyZ2luOiAxMixcclxuICAgICAgeU1hcmdpbjogMTgsXHJcbiAgICAgIGZpbGw6ICd3aGl0ZScsXHJcbiAgICAgIG1pbldpZHRoOiAyMDBcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIC8vIENyZWF0ZSB0aGUgaWNvbiBOb2RlIGZvciB0aGUgZGF0YVByb2JlIHRvb2xcclxuICAgIGNvbnN0IGRhdGFQcm9iZUljb25Ob2RlID0gRGF0YVByb2JlTm9kZS5jcmVhdGVJY29uKCBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkYXRhUHJvYmVJY29uTm9kZScgKSApO1xyXG4gICAgZGF0YVByb2JlSWNvbk5vZGUuY3Vyc29yID0gJ3BvaW50ZXInO1xyXG4gICAgZGF0YVByb2JlSWNvbk5vZGUuc2NhbGUoIDAuNCApO1xyXG5cclxuICAgIC8vIENyZWF0ZSB0aGUgaWNvbiBpbWFnZSBmb3IgdGhlIG1lYXN1cmluZ1RhcGVcclxuICAgIGNvbnN0IG1lYXN1cmluZ1RhcGVJY29uTm9kZSA9IE1lYXN1cmluZ1RhcGVOb2RlLmNyZWF0ZUljb24oIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdtZWFzdXJpbmdUYXBlSWNvbk5vZGUnIClcclxuICAgIH0gKTtcclxuICAgIG1lYXN1cmluZ1RhcGVJY29uTm9kZS5jdXJzb3IgPSAncG9pbnRlcic7XHJcbiAgICBtZWFzdXJpbmdUYXBlSWNvbk5vZGUuc2NhbGUoIDAuOCApO1xyXG5cclxuICAgIC8vIFRoZSBjb250ZW50IHBhbmVsIHdpdGggdGhlIHR3byBpY29uc1xyXG4gICAgY29uc3QgcGFuZWxDb250ZW50ID0gbmV3IEhCb3goIHtcclxuICAgICAgc3BhY2luZzogMzAsXHJcbiAgICAgIGNoaWxkcmVuOiBbIGRhdGFQcm9iZUljb25Ob2RlLCBtZWFzdXJpbmdUYXBlSWNvbk5vZGUgXSxcclxuICAgICAgZXhjbHVkZUludmlzaWJsZUNoaWxkcmVuRnJvbUJvdW5kczogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIHBhbmVsQ29udGVudFxyXG4gICAgc3VwZXIoIHBhbmVsQ29udGVudCwgb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIGxpc3RlbnMgdG8gdGhlIGlzVXNlckNvbnRyb2xsZWQgUHJvcGVydHkgb2YgdGhlIGRhdGFQcm9iZSB0b29sXHJcbiAgICAvLyByZXR1cm4gdGhlIGRhdGFQcm9iZSB0byB0aGUgdG9vbGJveFBhbmVsIGlmIG5vdCB1c2VyIENvbnRyb2xsZWQgYW5kIGl0cyBwb3NpdGlvbiBpcyBsb2NhdGVkIHdpdGhpbiB0aGUgdG9vbGJveCBwYW5lbFxyXG4gICAgZGF0YVByb2JlTm9kZS5pc1VzZXJDb250cm9sbGVkUHJvcGVydHkubGF6eUxpbmsoIGlzVXNlckNvbnRyb2xsZWQgPT4ge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBkYXRhUHJvYmVOb2RlLnBhcmVudCBpbnN0YW5jZW9mIFNjcmVlblZpZXcgKTtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggZGF0YVByb2JlTm9kZS5wYXJlbnQgPT09IHRoaXMucGFyZW50ICk7XHJcblxyXG4gICAgICBjb25zdCBkYXRhUHJvYmVOb2RlQm91bmRzID0gZGF0YVByb2JlTm9kZS5nZXRKdXN0RGF0YVByb2JlQm91bmRzKCk7IC8vZ2xvYmFsVG9QYXJlbnRCb3VuZHMoIGRhdGFQcm9iZU5vZGUuZ2V0R2xvYmFsQm91bmRzKCkgKTtcclxuICAgICAgY29uc3QgdG9vbGJveEJvdW5kcyA9IGRhdGFQcm9iZU5vZGUuZ2xvYmFsVG9QYXJlbnRCb3VuZHMoIHRoaXMuZ2V0R2xvYmFsQm91bmRzKCkgKTtcclxuICAgICAgaWYgKCAhaXNVc2VyQ29udHJvbGxlZCAmJiB0aGlzLnZpc2libGUgJiYgdG9vbGJveEJvdW5kcy5pbnRlcnNlY3RzQm91bmRzKCBkYXRhUHJvYmVOb2RlQm91bmRzLmVyb2RlZCggNSApICkgKSB7XHJcbiAgICAgICAgZGF0YVByb2JlLmlzQWN0aXZlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gV2hlbiBwcmVzc2VkLCBmb3J3YXJkcyBkcmFnZ2luZyB0byB0aGUgYWN0dWFsIGRhdGFQcm9iZSBOb2RlXHJcbiAgICBkYXRhUHJvYmVJY29uTm9kZS5hZGRJbnB1dExpc3RlbmVyKCBEcmFnTGlzdGVuZXIuY3JlYXRlRm9yd2FyZGluZ0xpc3RlbmVyKCBldmVudCA9PiB7XHJcbiAgICAgIGRhdGFQcm9iZS5pc0FjdGl2ZVByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG5cclxuICAgICAgLy8gb2Zmc2V0IHdoZW4gcHVsbGluZyBvdXQgb2YgdGhlIHRvb2xib3ggc28gdGhhdCB0aGUgcG9pbnRlciBpc24ndCBvbiB0b3Agb2YgdGhlIHRvb2wuIENvbnZlcnQgdG8gcGFyZW50IHBvaW50XHJcbiAgICAgIC8vIGJlY2F1c2UgdGhlIERhdGFQcm9iZU5vZGUncyBEcmFnTGlzdGVuZXIgaXMgYXBwbHlpbmcgaXRzIHBvaW50ZXIgb2Zmc2V0IGluIHRoZSBwYXJlbnQgY29vcmRpbmF0ZSBmcmFtZSAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5L2lzc3Vlcy8xMDE0KVxyXG4gICAgICBjb25zdCBwYXJlbnRQb2ludCA9IHRoaXMuZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApLnBsdXNYWSggLTE4MCwgMCApO1xyXG4gICAgICBkYXRhUHJvYmUucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IHRyYW5zZm9ybVByb3BlcnR5LnZhbHVlLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcbiAgICAgIGRhdGFQcm9iZU5vZGUuZHJhZ0xpc3RlbmVyLnByZXNzKCBldmVudCwgZGF0YVByb2JlTm9kZSApO1xyXG4gICAgfSwgeyBhbGxvd1RvdWNoU25hZzogdHJ1ZSB9ICkgKTtcclxuXHJcbiAgICAvLyBkYXRhUHJvYmUgdmlzaWJpbGl0eSBoYXMgdGhlIG9wcG9zaXRlIHZpc2liaWxpdHkgb2YgdGhlIGRhdGFQcm9iZUljb25cclxuICAgIGRhdGFQcm9iZS5pc0FjdGl2ZVByb3BlcnR5LmxpbmsoIGFjdGl2ZSA9PiB7XHJcbiAgICAgIGRhdGFQcm9iZUljb25Ob2RlLnZpc2libGUgPSAhYWN0aXZlO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGxpc3RlbnMgdG8gdGhlIGlzVXNlckNvbnRyb2xsZWQgUHJvcGVydHkgb2YgdGhlIG1lYXN1cmluZyB0YXBlXHJcbiAgICAvLyByZXR1cm4gdGhlIG1lYXN1cmluZyB0YXBlIHRvIHRoZSB0b29sYm94UGFuZWwgaWYgbm90IHVzZXIgQ29udHJvbGxlZCBhbmQgaXRzIHBvc2l0aW9uIGlzIGxvY2F0ZWQgd2l0aGluIHRoZSB0b29sYm94IHBhbmVsXHJcbiAgICBtZWFzdXJpbmdUYXBlTm9kZS5pc0Jhc2VVc2VyQ29udHJvbGxlZFByb3BlcnR5LmxhenlMaW5rKCBpc1VzZXJDb250cm9sbGVkID0+IHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggbWVhc3VyaW5nVGFwZU5vZGUucGFyZW50IGluc3RhbmNlb2YgU2NyZWVuVmlldyApO1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBtZWFzdXJpbmdUYXBlTm9kZS5wYXJlbnQgPT09IHRoaXMucGFyZW50ICk7XHJcblxyXG4gICAgICBjb25zdCB0YXBlQmFzZUJvdW5kcyA9IG1lYXN1cmluZ1RhcGVOb2RlLmxvY2FsVG9QYXJlbnRCb3VuZHMoIG1lYXN1cmluZ1RhcGVOb2RlLmdldExvY2FsQmFzZUJvdW5kcygpICk7XHJcbiAgICAgIGNvbnN0IHRvb2xib3hCb3VuZHMgPSBtZWFzdXJpbmdUYXBlTm9kZS5nbG9iYWxUb1BhcmVudEJvdW5kcyggdGhpcy5nZXRHbG9iYWxCb3VuZHMoKSApO1xyXG4gICAgICBpZiAoICFpc1VzZXJDb250cm9sbGVkICYmIHRoaXMudmlzaWJsZSAmJiB0b29sYm94Qm91bmRzLmludGVyc2VjdHNCb3VuZHMoIHRhcGVCYXNlQm91bmRzLmVyb2RlZCggNSApICkgKSB7XHJcbiAgICAgICAgbWVhc3VyaW5nVGFwZS5pc0FjdGl2ZVByb3BlcnR5LnNldCggZmFsc2UgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGRldGVybWluZSB0aGUgZGlzdGFuY2UgKGluIG1vZGVsIGNvb3JkaW5hdGVzKSBiZXR3ZWVuIHRoZSB0aXAgYW5kIHRoZSBiYXNlIHBvc2l0aW9uIG9mIHRoZSBtZWFzdXJpbmcgdGFwZVxyXG4gICAgY29uc3QgdGlwVG9CYXNlUG9zaXRpb24gPSBtZWFzdXJpbmdUYXBlLnRpcFBvc2l0aW9uUHJvcGVydHkuZ2V0KCkubWludXMoIG1lYXN1cmluZ1RhcGUuYmFzZVBvc2l0aW9uUHJvcGVydHkuZ2V0KCkgKTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIGxpc3RlbmVyIHRoYXQgd2lsbCBhbGxvdyB0aGUgdXNlciB0byBjbGljayBvbiB0aGlzIGFuZCBmb3J3YXJkIHRoZSBkcmFnZ2luZyB0byB0aGUgYWN0dWFsIG1lYXN1cmluZyB0YXBlIG5vZGVcclxuICAgIG1lYXN1cmluZ1RhcGVJY29uTm9kZS5hZGRJbnB1dExpc3RlbmVyKCBEcmFnTGlzdGVuZXIuY3JlYXRlRm9yd2FyZGluZ0xpc3RlbmVyKCBldmVudCA9PiB7XHJcblxyXG4gICAgICBtZWFzdXJpbmdUYXBlLmlzQWN0aXZlUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcblxyXG4gICAgICBjb25zdCB0YXBlQmFzZVBvc2l0aW9uID0gbWVhc3VyaW5nVGFwZU5vZGUuZ2xvYmFsVG9QYXJlbnRQb2ludCggbWVhc3VyaW5nVGFwZU5vZGUubG9jYWxUb0dsb2JhbFBvaW50KCBtZWFzdXJpbmdUYXBlTm9kZS5nZXRMb2NhbEJhc2VDZW50ZXIoKSApICk7XHJcbiAgICAgIGNvbnN0IGluaXRpYWxWaWV3UG9zaXRpb24gPSBtZWFzdXJpbmdUYXBlTm9kZS5nbG9iYWxUb1BhcmVudFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICkubWludXMoIHRhcGVCYXNlUG9zaXRpb24gKTtcclxuICAgICAgbWVhc3VyaW5nVGFwZS5iYXNlUG9zaXRpb25Qcm9wZXJ0eS5zZXQoIHRyYW5zZm9ybVByb3BlcnR5LmdldCgpLnZpZXdUb01vZGVsUG9zaXRpb24oIGluaXRpYWxWaWV3UG9zaXRpb24gKSApO1xyXG4gICAgICBtZWFzdXJpbmdUYXBlLnRpcFBvc2l0aW9uUHJvcGVydHkuc2V0KCBtZWFzdXJpbmdUYXBlLmJhc2VQb3NpdGlvblByb3BlcnR5LmdldCgpLnBsdXMoIHRpcFRvQmFzZVBvc2l0aW9uICkgKTtcclxuXHJcbiAgICAgIG1lYXN1cmluZ1RhcGVOb2RlLnN0YXJ0QmFzZURyYWcoIGV2ZW50ICk7XHJcblxyXG4gICAgfSwgeyBhbGxvd1RvdWNoU25hZzogdHJ1ZSB9ICkgKTtcclxuXHJcbiAgICAvLyBtZWFzdXJpbmdUYXBlIHZpc2liaWxpdHkgaGFzIHRoZSBvcHBvc2l0ZSB2aXNpYmlsaXR5IG9mIHRoZSBtZWFzdXJpbmdUYXBlIEljb25cclxuICAgIG1lYXN1cmluZ1RhcGUuaXNBY3RpdmVQcm9wZXJ0eS5saW5rKCBhY3RpdmUgPT4ge1xyXG4gICAgICBtZWFzdXJpbmdUYXBlSWNvbk5vZGUudmlzaWJsZSA9ICFhY3RpdmU7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gTGlua3MgZm9yIHRoZSB0b29sYm94UGFuZWwgYW5kIGl0cyB0b29scyBsYXN0IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbSwgc28gdGhleSBkb24ndCBuZWVkIHRvIGJlIGRpc3Bvc2VkXHJcbiAgfVxyXG59XHJcblxyXG5wcm9qZWN0aWxlTW90aW9uLnJlZ2lzdGVyKCAnVG9vbGJveFBhbmVsJywgVG9vbGJveFBhbmVsICk7XHJcbmV4cG9ydCBkZWZhdWx0IFRvb2xib3hQYW5lbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxVQUFVLE1BQU0sb0NBQW9DO0FBQzNELE9BQU9DLGlCQUFpQixNQUFNLGtEQUFrRDtBQUNoRixTQUFTQyxZQUFZLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDdEUsT0FBT0MsS0FBSyxNQUF3Qiw2QkFBNkI7QUFDakUsT0FBT0MsZ0JBQWdCLE1BQU0sMkJBQTJCO0FBQ3hELE9BQU9DLGFBQWEsTUFBTSxvQkFBb0I7QUFLOUMsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQVk3RCxNQUFNQyxZQUFZLFNBQVNKLEtBQUssQ0FBQztFQUUvQjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDU0ssV0FBV0EsQ0FBRUMsYUFBNEMsRUFBRUMsU0FBb0IsRUFBRUMsaUJBQW9DLEVBQ3hHQyxhQUE0QixFQUFFQyxpQkFBZ0QsRUFBRUMsZUFBcUMsRUFBRztJQUUxSTtJQUNBO0lBQ0E7SUFDQTs7SUFFQTtJQUNBLE1BQU1DLE9BQU8sR0FBR1QsU0FBUyxDQUFpRCxDQUFDLENBQUU7TUFDM0VVLE9BQU8sRUFBRSxFQUFFO01BQ1hDLE9BQU8sRUFBRSxFQUFFO01BQ1hDLElBQUksRUFBRSxPQUFPO01BQ2JDLFFBQVEsRUFBRTtJQUNaLENBQUMsRUFBRUwsZUFBZ0IsQ0FBQzs7SUFFcEI7SUFDQSxNQUFNTSxpQkFBaUIsR0FBR2YsYUFBYSxDQUFDZ0IsVUFBVSxDQUFFTixPQUFPLENBQUNPLE1BQU0sQ0FBQ0MsWUFBWSxDQUFFLG1CQUFvQixDQUFFLENBQUM7SUFDeEdILGlCQUFpQixDQUFDSSxNQUFNLEdBQUcsU0FBUztJQUNwQ0osaUJBQWlCLENBQUNLLEtBQUssQ0FBRSxHQUFJLENBQUM7O0lBRTlCO0lBQ0EsTUFBTUMscUJBQXFCLEdBQUcxQixp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