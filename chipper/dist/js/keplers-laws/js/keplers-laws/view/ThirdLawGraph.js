// Copyright 2023, University of Colorado Boulder

/**
 * Shows a graph of a vs. T with the data from the orbit
 *
 * @author AgustÃ­n Vallejo
 */

import SolarSystemCommonConstants from '../../../../solar-system-common/js/SolarSystemCommonConstants.js';
import { Circle, Node, Path, RichText } from '../../../../scenery/js/imports.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Utils from '../../../../dot/js/Utils.js';
import ArrowNode from '../../../../scenery-phet/js/ArrowNode.js';
import { combineOptions } from '../../../../phet-core/js/optionize.js';
import Multilink from '../../../../axon/js/Multilink.js';
import { Shape } from '../../../../kite/js/imports.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import KeplersLawsStrings from '../../../../keplers-laws/js/KeplersLawsStrings.js';
import SolarSystemCommonColors from '../../../../solar-system-common/js/SolarSystemCommonColors.js';
import keplersLaws from '../../keplersLaws.js';
import ThirdLawTextUtils from './ThirdLawTextUtils.js';
import TinyProperty from '../../../../axon/js/TinyProperty.js';
const FOREGROUND_COLOR_PROPERTY = SolarSystemCommonColors.foregroundProperty;
export default class ThirdLawGraph extends Node {
  constructor(model, orbit, providedOptions) {
    const options = {
      ...providedOptions
    };
    super(options);
    const axisLength = 120;
    const semiMajorAxisToViewPoint = semiMajorAxis => {
      const period = model.engine.thirdLaw(semiMajorAxis);
      const periodPower = model.selectedPeriodPowerProperty.value;
      const axisPower = model.selectedAxisPowerProperty.value;
      return new Vector2(axisLength * Math.pow(Utils.linear(0, maxSemiMajorAxis, 0, 1, semiMajorAxis), axisPower), -axisLength * Math.pow(Utils.linear(0, maxPeriod, 0, 1, period), periodPower));
    };
    const xAxis = new ArrowNode(0, 0, axisLength, 0, {
      fill: FOREGROUND_COLOR_PROPERTY,
      stroke: FOREGROUND_COLOR_PROPERTY,
      tailWidth: 1
    });
    const yAxis = new ArrowNode(0, 0, 0, -axisLength, {
      fill: FOREGROUND_COLOR_PROPERTY,
      stroke: FOREGROUND_COLOR_PROPERTY,
      tailWidth: 1
    });
    const maxSemiMajorAxis = 500;
    const maxPeriod = model.engine.thirdLaw(maxSemiMajorAxis);
    const dataPoint = new Circle(5, {
      fill: SolarSystemCommonColors.secondBodyColorProperty
    });
    const linePath = new Path(null, {
      stroke: SolarSystemCommonColors.foregroundProperty,
      lineWidth: 2
    });
    const outOfBoundsArrow = new ArrowNode(0, 0, 1, 0, {
      stroke: SolarSystemCommonColors.secondBodyColorProperty,
      fill: SolarSystemCommonColors.secondBodyColorProperty,
      lineWidth: 2,
      boundsMethod: 'none'
    });
    const xAxisLabelStringProperty = ThirdLawTextUtils.createPowerStringProperty(KeplersLawsStrings.symbols.semiMajorAxisStringProperty, model.selectedAxisPowerProperty, new TinyProperty(true));
    const yAxisLabelStringProperty = ThirdLawTextUtils.createPowerStringProperty(KeplersLawsStrings.symbols.periodStringProperty, model.selectedPeriodPowerProperty, new TinyProperty(true));
    const xAxisLabel = new RichText(xAxisLabelStringProperty, combineOptions({
      x: axisLength * 0.4,
      y: 25
    }, SolarSystemCommonConstants.TITLE_OPTIONS));
    const yAxisLabel = new RichText(yAxisLabelStringProperty, combineOptions({
      x: -25,
      y: -axisLength * 0.4
    }, SolarSystemCommonConstants.TITLE_OPTIONS));
    this.children = [xAxis, yAxis, xAxisLabel, yAxisLabel, new Node({
      children: [linePath, dataPoint],
      clipArea: Shape.bounds(new Bounds2(-50, -axisLength, axisLength, 50))
    }), outOfBoundsArrow];
    let minVisitedAxis;
    let maxVisitedAxis;
    const orbitUpdated = () => {
      const pointPosition = semiMajorAxisToViewPoint(orbit.a);
      dataPoint.translation = pointPosition;
      dataPoint.visible = orbit.a < maxSemiMajorAxis;
      if (!model.bodies[0].userControlledMassProperty.value || minVisitedAxis !== maxVisitedAxis) {
        if (orbit.a < minVisitedAxis) {
          minVisitedAxis = orbit.a;
        }
        if (orbit.a > maxVisitedAxis) {
          maxVisitedAxis = orbit.a;
        }
      } else {
        minVisitedAxis = orbit.a;
        maxVisitedAxis = orbit.a;
      }
      const shape = new Shape();
      const outOfBounds = pointPosition.x > axisLength || pointPosition.y < -axisLength;
      let arrowX = null;
      const dx = 5;

      // a is the semimajor axis
      for (let a = minVisitedAxis; a <= maxVisitedAxis; a += 5) {
        const pointToDraw = semiMajorAxisToViewPoint(a);
        shape.lineToPoint(pointToDraw);
        if (!arrowX && outOfBounds && pointToDraw.y < -axisLength + dx) {
          arrowX = a;
        } else if (!arrowX && outOfBounds && pointToDraw.x > axisLength - dx) {
          arrowX = a;
        }
      }
      shape.makeImmutable();
      linePath.shape = shape;
      if (outOfBounds && arrowX) {
        const tail = semiMajorAxisToViewPoint(arrowX);
        const tip = semiMajorAxisToViewPoint(arrowX + 15).minus(tail).setMagnitude(20);
        outOfBoundsArrow.translation = tail;
        outOfBoundsArrow.setTip(tip.x, tip.y);
        outOfBoundsArrow.visible = true;
      } else {
        outOfBoundsArrow.visible = false;
      }
    };
    const resetAxisBoundaries = () => {
      minVisitedAxis = orbit.a;
      maxVisitedAxis = orbit.a;

      // Calling the draw function again to update (delete) the line
      orbitUpdated();
    };
    resetAxisBoundaries();
    Multilink.multilink([model.selectedAxisPowerProperty, model.selectedPeriodPowerProperty], orbitUpdated);
    orbit.changedEmitter.addListener(orbitUpdated);
    orbit.resetEmitter.addListener(resetAxisBoundaries);
  }
}
keplersLaws.register('ThirdLawGraph', ThirdLawGraph);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTb2xhclN5c3RlbUNvbW1vbkNvbnN0YW50cyIsIkNpcmNsZSIsIk5vZGUiLCJQYXRoIiwiUmljaFRleHQiLCJWZWN0b3IyIiwiVXRpbHMiLCJBcnJvd05vZGUiLCJjb21iaW5lT3B0aW9ucyIsIk11bHRpbGluayIsIlNoYXBlIiwiQm91bmRzMiIsIktlcGxlcnNMYXdzU3RyaW5ncyIsIlNvbGFyU3lzdGVtQ29tbW9uQ29sb3JzIiwia2VwbGVyc0xhd3MiLCJUaGlyZExhd1RleHRVdGlscyIsIlRpbnlQcm9wZXJ0eSIsIkZPUkVHUk9VTkRfQ09MT1JfUFJPUEVSVFkiLCJmb3JlZ3JvdW5kUHJvcGVydHkiLCJUaGlyZExhd0dyYXBoIiwiY29uc3RydWN0b3IiLCJtb2RlbCIsIm9yYml0IiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImF4aXNMZW5ndGgiLCJzZW1pTWFqb3JBeGlzVG9WaWV3UG9pbnQiLCJzZW1pTWFqb3JBeGlzIiwicGVyaW9kIiwiZW5naW5lIiwidGhpcmRMYXciLCJwZXJpb2RQb3dlciIsInNlbGVjdGVkUGVyaW9kUG93ZXJQcm9wZXJ0eSIsInZhbHVlIiwiYXhpc1Bvd2VyIiwic2VsZWN0ZWRBeGlzUG93ZXJQcm9wZXJ0eSIsIk1hdGgiLCJwb3ciLCJsaW5lYXIiLCJtYXhTZW1pTWFqb3JBeGlzIiwibWF4UGVyaW9kIiwieEF4aXMiLCJmaWxsIiwic3Ryb2tlIiwidGFpbFdpZHRoIiwieUF4aXMiLCJkYXRhUG9pbnQiLCJzZWNvbmRCb2R5Q29sb3JQcm9wZXJ0eSIsImxpbmVQYXRoIiwibGluZVdpZHRoIiwib3V0T2ZCb3VuZHNBcnJvdyIsImJvdW5kc01ldGhvZCIsInhBeGlzTGFiZWxTdHJpbmdQcm9wZXJ0eSIsImNyZWF0ZVBvd2VyU3RyaW5nUHJvcGVydHkiLCJzeW1ib2xzIiwic2VtaU1ham9yQXhpc1N0cmluZ1Byb3BlcnR5IiwieUF4aXNMYWJlbFN0cmluZ1Byb3BlcnR5IiwicGVyaW9kU3RyaW5nUHJvcGVydHkiLCJ4QXhpc0xhYmVsIiwieCIsInkiLCJUSVRMRV9PUFRJT05TIiwieUF4aXNMYWJlbCIsImNoaWxkcmVuIiwiY2xpcEFyZWEiLCJib3VuZHMiLCJtaW5WaXNpdGVkQXhpcyIsIm1heFZpc2l0ZWRBeGlzIiwib3JiaXRVcGRhdGVkIiwicG9pbnRQb3NpdGlvbiIsImEiLCJ0cmFuc2xhdGlvbiIsInZpc2libGUiLCJib2RpZXMiLCJ1c2VyQ29udHJvbGxlZE1hc3NQcm9wZXJ0eSIsInNoYXBlIiwib3V0T2ZCb3VuZHMiLCJhcnJvd1giLCJkeCIsInBvaW50VG9EcmF3IiwibGluZVRvUG9pbnQiLCJtYWtlSW1tdXRhYmxlIiwidGFpbCIsInRpcCIsIm1pbnVzIiwic2V0TWFnbml0dWRlIiwic2V0VGlwIiwicmVzZXRBeGlzQm91bmRhcmllcyIsIm11bHRpbGluayIsImNoYW5nZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJyZXNldEVtaXR0ZXIiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlRoaXJkTGF3R3JhcGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNob3dzIGEgZ3JhcGggb2YgYSB2cy4gVCB3aXRoIHRoZSBkYXRhIGZyb20gdGhlIG9yYml0XHJcbiAqXHJcbiAqIEBhdXRob3IgQWd1c3TDrW4gVmFsbGVqb1xyXG4gKi9cclxuXHJcbmltcG9ydCBLZXBsZXJzTGF3c01vZGVsIGZyb20gJy4uL21vZGVsL0tlcGxlcnNMYXdzTW9kZWwuanMnO1xyXG5pbXBvcnQgRWxsaXB0aWNhbE9yYml0RW5naW5lIGZyb20gJy4uL21vZGVsL0VsbGlwdGljYWxPcmJpdEVuZ2luZS5qcyc7XHJcbmltcG9ydCBTb2xhclN5c3RlbUNvbW1vbkNvbnN0YW50cyBmcm9tICcuLi8uLi8uLi8uLi9zb2xhci1zeXN0ZW0tY29tbW9uL2pzL1NvbGFyU3lzdGVtQ29tbW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IHsgQ2lyY2xlLCBOb2RlLCBOb2RlT3B0aW9ucywgUGF0aCwgUmljaFRleHQsIFJpY2hUZXh0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBBcnJvd05vZGUgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL0Fycm93Tm9kZS5qcyc7XHJcbmltcG9ydCB7IGNvbWJpbmVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IEtlcGxlcnNMYXdzU3RyaW5ncyBmcm9tICcuLi8uLi8uLi8uLi9rZXBsZXJzLWxhd3MvanMvS2VwbGVyc0xhd3NTdHJpbmdzLmpzJztcclxuaW1wb3J0IFNvbGFyU3lzdGVtQ29tbW9uQ29sb3JzIGZyb20gJy4uLy4uLy4uLy4uL3NvbGFyLXN5c3RlbS1jb21tb24vanMvU29sYXJTeXN0ZW1Db21tb25Db2xvcnMuanMnO1xyXG5pbXBvcnQga2VwbGVyc0xhd3MgZnJvbSAnLi4vLi4va2VwbGVyc0xhd3MuanMnO1xyXG5pbXBvcnQgVGhpcmRMYXdUZXh0VXRpbHMgZnJvbSAnLi9UaGlyZExhd1RleHRVdGlscy5qcyc7XHJcbmltcG9ydCBUaW55UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UaW55UHJvcGVydHkuanMnO1xyXG5cclxuY29uc3QgRk9SRUdST1VORF9DT0xPUl9QUk9QRVJUWSA9IFNvbGFyU3lzdGVtQ29tbW9uQ29sb3JzLmZvcmVncm91bmRQcm9wZXJ0eTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRoaXJkTGF3R3JhcGggZXh0ZW5kcyBOb2RlIHtcclxuICBwdWJsaWMgY29uc3RydWN0b3IoIG1vZGVsOiBLZXBsZXJzTGF3c01vZGVsLCBvcmJpdDogRWxsaXB0aWNhbE9yYml0RW5naW5lLCBwcm92aWRlZE9wdGlvbnM/OiBOb2RlT3B0aW9ucyApIHtcclxuICAgIGNvbnN0IG9wdGlvbnM6IE5vZGVPcHRpb25zID0ge1xyXG4gICAgICAuLi5wcm92aWRlZE9wdGlvbnNcclxuICAgIH07XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICBjb25zdCBheGlzTGVuZ3RoID0gMTIwO1xyXG5cclxuICAgIGNvbnN0IHNlbWlNYWpvckF4aXNUb1ZpZXdQb2ludCA9ICggc2VtaU1ham9yQXhpczogbnVtYmVyICkgPT4ge1xyXG4gICAgICBjb25zdCBwZXJpb2QgPSBtb2RlbC5lbmdpbmUudGhpcmRMYXcoIHNlbWlNYWpvckF4aXMgKTtcclxuICAgICAgY29uc3QgcGVyaW9kUG93ZXIgPSBtb2RlbC5zZWxlY3RlZFBlcmlvZFBvd2VyUHJvcGVydHkudmFsdWU7XHJcbiAgICAgIGNvbnN0IGF4aXNQb3dlciA9IG1vZGVsLnNlbGVjdGVkQXhpc1Bvd2VyUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgICByZXR1cm4gbmV3IFZlY3RvcjIoXHJcbiAgICAgICAgYXhpc0xlbmd0aCAqIE1hdGgucG93KCBVdGlscy5saW5lYXIoXHJcbiAgICAgICAgICAgICAgICAgICAgIDAsIG1heFNlbWlNYWpvckF4aXMsXHJcbiAgICAgICAgICAgICAgICAgICAgIDAsIDEsXHJcbiAgICAgICAgICAgICAgICAgICAgIHNlbWlNYWpvckF4aXMgKSwgYXhpc1Bvd2VyICksXHJcbiAgICAgICAgLWF4aXNMZW5ndGggKiBNYXRoLnBvdyggVXRpbHMubGluZWFyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgMCwgbWF4UGVyaW9kLFxyXG4gICAgICAgICAgICAgICAgICAgICAgMCwgMSxcclxuICAgICAgICAgICAgICAgICAgICAgIHBlcmlvZFxyXG4gICAgICAgICAgICAgICAgICAgICksIHBlcmlvZFBvd2VyIClcclxuICAgICAgKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgeEF4aXMgPSBuZXcgQXJyb3dOb2RlKCAwLCAwLCBheGlzTGVuZ3RoLCAwLCB7XHJcbiAgICAgIGZpbGw6IEZPUkVHUk9VTkRfQ09MT1JfUFJPUEVSVFksXHJcbiAgICAgIHN0cm9rZTogRk9SRUdST1VORF9DT0xPUl9QUk9QRVJUWSxcclxuICAgICAgdGFpbFdpZHRoOiAxXHJcbiAgICB9ICk7XHJcbiAgICBjb25zdCB5QXhpcyA9IG5ldyBBcnJvd05vZGUoIDAsIDAsIDAsIC1heGlzTGVuZ3RoLCB7XHJcbiAgICAgIGZpbGw6IEZPUkVHUk9VTkRfQ09MT1JfUFJPUEVSVFksXHJcbiAgICAgIHN0cm9rZTogRk9SRUdST1VORF9DT0xPUl9QUk9QRVJUWSxcclxuICAgICAgdGFpbFdpZHRoOiAxXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgbWF4U2VtaU1ham9yQXhpcyA9IDUwMDtcclxuICAgIGNvbnN0IG1heFBlcmlvZCA9IG1vZGVsLmVuZ2luZS50aGlyZExhdyggbWF4U2VtaU1ham9yQXhpcyApO1xyXG5cclxuICAgIGNvbnN0IGRhdGFQb2ludCA9IG5ldyBDaXJjbGUoIDUsIHtcclxuICAgICAgZmlsbDogU29sYXJTeXN0ZW1Db21tb25Db2xvcnMuc2Vjb25kQm9keUNvbG9yUHJvcGVydHlcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBsaW5lUGF0aCA9IG5ldyBQYXRoKCBudWxsLCB7XHJcbiAgICAgIHN0cm9rZTogU29sYXJTeXN0ZW1Db21tb25Db2xvcnMuZm9yZWdyb3VuZFByb3BlcnR5LFxyXG4gICAgICBsaW5lV2lkdGg6IDJcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IG91dE9mQm91bmRzQXJyb3cgPSBuZXcgQXJyb3dOb2RlKCAwLCAwLCAxLCAwLCB7XHJcbiAgICAgIHN0cm9rZTogU29sYXJTeXN0ZW1Db21tb25Db2xvcnMuc2Vjb25kQm9keUNvbG9yUHJvcGVydHksXHJcbiAgICAgIGZpbGw6IFNvbGFyU3lzdGVtQ29tbW9uQ29sb3JzLnNlY29uZEJvZHlDb2xvclByb3BlcnR5LFxyXG4gICAgICBsaW5lV2lkdGg6IDIsXHJcbiAgICAgIGJvdW5kc01ldGhvZDogJ25vbmUnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgeEF4aXNMYWJlbFN0cmluZ1Byb3BlcnR5ID0gVGhpcmRMYXdUZXh0VXRpbHMuY3JlYXRlUG93ZXJTdHJpbmdQcm9wZXJ0eShcclxuICAgICAgS2VwbGVyc0xhd3NTdHJpbmdzLnN5bWJvbHMuc2VtaU1ham9yQXhpc1N0cmluZ1Byb3BlcnR5LFxyXG4gICAgICBtb2RlbC5zZWxlY3RlZEF4aXNQb3dlclByb3BlcnR5LFxyXG4gICAgICBuZXcgVGlueVByb3BlcnR5PGJvb2xlYW4+KCB0cnVlIClcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgeUF4aXNMYWJlbFN0cmluZ1Byb3BlcnR5ID0gVGhpcmRMYXdUZXh0VXRpbHMuY3JlYXRlUG93ZXJTdHJpbmdQcm9wZXJ0eShcclxuICAgICAgS2VwbGVyc0xhd3NTdHJpbmdzLnN5bWJvbHMucGVyaW9kU3RyaW5nUHJvcGVydHksXHJcbiAgICAgIG1vZGVsLnNlbGVjdGVkUGVyaW9kUG93ZXJQcm9wZXJ0eSxcclxuICAgICAgbmV3IFRpbnlQcm9wZXJ0eTxib29sZWFuPiggdHJ1ZSApXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IHhBeGlzTGFiZWwgPSBuZXcgUmljaFRleHQoXHJcbiAgICAgIHhBeGlzTGFiZWxTdHJpbmdQcm9wZXJ0eSxcclxuICAgICAgY29tYmluZU9wdGlvbnM8UmljaFRleHRPcHRpb25zPigge1xyXG4gICAgICAgIHg6IGF4aXNMZW5ndGggKiAwLjQsIHk6IDI1XHJcbiAgICAgIH0sIFNvbGFyU3lzdGVtQ29tbW9uQ29uc3RhbnRzLlRJVExFX09QVElPTlMgKSApO1xyXG4gICAgY29uc3QgeUF4aXNMYWJlbCA9IG5ldyBSaWNoVGV4dChcclxuICAgICAgeUF4aXNMYWJlbFN0cmluZ1Byb3BlcnR5LFxyXG4gICAgICBjb21iaW5lT3B0aW9uczxSaWNoVGV4dE9wdGlvbnM+KCB7XHJcbiAgICAgICAgeDogLTI1LCB5OiAtYXhpc0xlbmd0aCAqIDAuNFxyXG4gICAgICB9LCBTb2xhclN5c3RlbUNvbW1vbkNvbnN0YW50cy5USVRMRV9PUFRJT05TICkgKTtcclxuXHJcbiAgICB0aGlzLmNoaWxkcmVuID0gW1xyXG4gICAgICB4QXhpcyxcclxuICAgICAgeUF4aXMsXHJcbiAgICAgIHhBeGlzTGFiZWwsXHJcbiAgICAgIHlBeGlzTGFiZWwsXHJcbiAgICAgIG5ldyBOb2RlKCB7XHJcbiAgICAgICAgY2hpbGRyZW46IFsgbGluZVBhdGgsIGRhdGFQb2ludCBdLFxyXG4gICAgICAgIGNsaXBBcmVhOiBTaGFwZS5ib3VuZHMoIG5ldyBCb3VuZHMyKCAtNTAsIC1heGlzTGVuZ3RoLCBheGlzTGVuZ3RoLCA1MCApIClcclxuICAgICAgfSApLFxyXG4gICAgICBvdXRPZkJvdW5kc0Fycm93XHJcbiAgICBdO1xyXG5cclxuICAgIGxldCBtaW5WaXNpdGVkQXhpczogbnVtYmVyO1xyXG4gICAgbGV0IG1heFZpc2l0ZWRBeGlzOiBudW1iZXI7XHJcblxyXG4gICAgY29uc3Qgb3JiaXRVcGRhdGVkID0gKCkgPT4ge1xyXG4gICAgICBjb25zdCBwb2ludFBvc2l0aW9uID0gc2VtaU1ham9yQXhpc1RvVmlld1BvaW50KCBvcmJpdC5hICk7XHJcbiAgICAgIGRhdGFQb2ludC50cmFuc2xhdGlvbiA9IHBvaW50UG9zaXRpb247XHJcbiAgICAgIGRhdGFQb2ludC52aXNpYmxlID0gb3JiaXQuYSA8IG1heFNlbWlNYWpvckF4aXM7XHJcblxyXG4gICAgICBpZiAoICFtb2RlbC5ib2RpZXNbIDAgXS51c2VyQ29udHJvbGxlZE1hc3NQcm9wZXJ0eS52YWx1ZSB8fCBtaW5WaXNpdGVkQXhpcyAhPT0gbWF4VmlzaXRlZEF4aXMgKSB7XHJcbiAgICAgICAgaWYgKCBvcmJpdC5hIDwgbWluVmlzaXRlZEF4aXMgKSB7XHJcbiAgICAgICAgICBtaW5WaXNpdGVkQXhpcyA9IG9yYml0LmE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIG9yYml0LmEgPiBtYXhWaXNpdGVkQXhpcyApIHtcclxuICAgICAgICAgIG1heFZpc2l0ZWRBeGlzID0gb3JiaXQuYTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgbWluVmlzaXRlZEF4aXMgPSBvcmJpdC5hO1xyXG4gICAgICAgIG1heFZpc2l0ZWRBeGlzID0gb3JiaXQuYTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgc2hhcGUgPSBuZXcgU2hhcGUoKTtcclxuXHJcbiAgICAgIGNvbnN0IG91dE9mQm91bmRzID0gcG9pbnRQb3NpdGlvbi54ID4gYXhpc0xlbmd0aCB8fCBwb2ludFBvc2l0aW9uLnkgPCAtYXhpc0xlbmd0aDtcclxuICAgICAgbGV0IGFycm93WCA9IG51bGw7XHJcbiAgICAgIGNvbnN0IGR4ID0gNTtcclxuXHJcbiAgICAgIC8vIGEgaXMgdGhlIHNlbWltYWpvciBheGlzXHJcbiAgICAgIGZvciAoIGxldCBhID0gbWluVmlzaXRlZEF4aXM7IGEgPD0gbWF4VmlzaXRlZEF4aXM7IGEgKz0gNSApIHtcclxuICAgICAgICBjb25zdCBwb2ludFRvRHJhdyA9IHNlbWlNYWpvckF4aXNUb1ZpZXdQb2ludCggYSApO1xyXG4gICAgICAgIHNoYXBlLmxpbmVUb1BvaW50KCBwb2ludFRvRHJhdyApO1xyXG5cclxuICAgICAgICBpZiAoICFhcnJvd1ggJiYgb3V0T2ZCb3VuZHMgJiYgcG9pbnRUb0RyYXcueSA8IC1heGlzTGVuZ3RoICsgZHggKSB7XHJcbiAgICAgICAgICBhcnJvd1ggPSBhO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICggIWFycm93WCAmJiBvdXRPZkJvdW5kcyAmJiBwb2ludFRvRHJhdy54ID4gYXhpc0xlbmd0aCAtIGR4ICkge1xyXG4gICAgICAgICAgYXJyb3dYID0gYTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgc2hhcGUubWFrZUltbXV0YWJsZSgpO1xyXG5cclxuICAgICAgbGluZVBhdGguc2hhcGUgPSBzaGFwZTtcclxuXHJcbiAgICAgIGlmICggb3V0T2ZCb3VuZHMgJiYgYXJyb3dYICkge1xyXG4gICAgICAgIGNvbnN0IHRhaWwgPSBzZW1pTWFqb3JBeGlzVG9WaWV3UG9pbnQoIGFycm93WCApO1xyXG4gICAgICAgIGNvbnN0IHRpcCA9IHNlbWlNYWpvckF4aXNUb1ZpZXdQb2ludCggYXJyb3dYICsgMTUgKS5taW51cyggdGFpbCApLnNldE1hZ25pdHVkZSggMjAgKTtcclxuICAgICAgICBvdXRPZkJvdW5kc0Fycm93LnRyYW5zbGF0aW9uID0gdGFpbDtcclxuICAgICAgICBvdXRPZkJvdW5kc0Fycm93LnNldFRpcCggdGlwLngsIHRpcC55ICk7XHJcbiAgICAgICAgb3V0T2ZCb3VuZHNBcnJvdy52aXNpYmxlID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBvdXRPZkJvdW5kc0Fycm93LnZpc2libGUgPSBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCByZXNldEF4aXNCb3VuZGFyaWVzID0gKCkgPT4ge1xyXG4gICAgICBtaW5WaXNpdGVkQXhpcyA9IG9yYml0LmE7XHJcbiAgICAgIG1heFZpc2l0ZWRBeGlzID0gb3JiaXQuYTtcclxuXHJcbiAgICAgIC8vIENhbGxpbmcgdGhlIGRyYXcgZnVuY3Rpb24gYWdhaW4gdG8gdXBkYXRlIChkZWxldGUpIHRoZSBsaW5lXHJcbiAgICAgIG9yYml0VXBkYXRlZCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXNldEF4aXNCb3VuZGFyaWVzKCk7XHJcblxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayhcclxuICAgICAgW1xyXG4gICAgICAgIG1vZGVsLnNlbGVjdGVkQXhpc1Bvd2VyUHJvcGVydHksXHJcbiAgICAgICAgbW9kZWwuc2VsZWN0ZWRQZXJpb2RQb3dlclByb3BlcnR5XHJcbiAgICAgIF0sIG9yYml0VXBkYXRlZCApO1xyXG5cclxuICAgIG9yYml0LmNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCBvcmJpdFVwZGF0ZWQgKTtcclxuICAgIG9yYml0LnJlc2V0RW1pdHRlci5hZGRMaXN0ZW5lciggcmVzZXRBeGlzQm91bmRhcmllcyApO1xyXG4gIH1cclxufVxyXG5cclxua2VwbGVyc0xhd3MucmVnaXN0ZXIoICdUaGlyZExhd0dyYXBoJywgVGhpcmRMYXdHcmFwaCApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFJQSxPQUFPQSwwQkFBMEIsTUFBTSxrRUFBa0U7QUFDekcsU0FBU0MsTUFBTSxFQUFFQyxJQUFJLEVBQWVDLElBQUksRUFBRUMsUUFBUSxRQUF5QixtQ0FBbUM7QUFDOUcsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLFNBQVMsTUFBTSwwQ0FBMEM7QUFDaEUsU0FBU0MsY0FBYyxRQUFRLHVDQUF1QztBQUN0RSxPQUFPQyxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELFNBQVNDLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxrQkFBa0IsTUFBTSxtREFBbUQ7QUFDbEYsT0FBT0MsdUJBQXVCLE1BQU0sK0RBQStEO0FBQ25HLE9BQU9DLFdBQVcsTUFBTSxzQkFBc0I7QUFDOUMsT0FBT0MsaUJBQWlCLE1BQU0sd0JBQXdCO0FBQ3RELE9BQU9DLFlBQVksTUFBTSxx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