// Copyright 2013-2022, University of Colorado Boulder

/**
 * This class defines a Scenery node that represents a model element in the view, and the particular model element
 * itself contains an image that is used as the primary representation.
 *
 * @author John Blanco
 */

import Matrix3 from '../../../../dot/js/Matrix3.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Image, Node, Text } from '../../../../scenery/js/imports.js';
import defaultImage_png from '../../../images/defaultImage_png.js';
import balancingAct from '../../balancingAct.js';
import BalancingActStrings from '../../BalancingActStrings.js';
import BAQueryParameters from '../BAQueryParameters.js';
import ColumnState from '../model/ColumnState.js';
import MassDragHandler from './MassDragHandler.js';
const kgString = BalancingActStrings.kg;
const pattern0Value1UnitsString = BalancingActStrings.pattern0Value1Units;
const unknownMassLabelString = BalancingActStrings.unknownMassLabel;
class ImageMassNode extends Node {
  /**
   * @param imageMass
   * @param modelViewTransform
   * @param {boolean} isLabeled - Flag that controls whether this note include a textual label of the mass
   * @param massLabelVisibleProperty
   * @param {boolean} draggable
   * @param {EnumerationDeprecatedProperty.<ColumnState>} columnStateProperty
   */
  constructor(imageMass, modelViewTransform, isLabeled, massLabelVisibleProperty, draggable, columnStateProperty) {
    super({
      cursor: 'pointer'
    });
    BAQueryParameters.stanford && columnStateProperty.link(columnState => {
      this.cursor = columnState === ColumnState.DOUBLE_COLUMNS ? 'pointer' : 'default';
      this.pickable = columnState === ColumnState.DOUBLE_COLUMNS;
    });
    const self = this;
    let massLabel;
    if (isLabeled) {
      // Add the mass indicator label.  Note that it is positioned elsewhere.
      const massLabelText = imageMass.isMystery ? unknownMassLabelString : StringUtils.format(pattern0Value1UnitsString, imageMass.massValue, kgString);
      massLabel = new Text(massLabelText, {
        font: new PhetFont(12)
      });
      this.addChild(massLabel);

      // Observe changes to mass indicator label visibility.
      massLabelVisibleProperty.link(visible => {
        massLabel.visible = visible;
      });
    }
    const imageNode = new Image(defaultImage_png);

    // Observe image changes.
    imageMass.imageProperty.link(image => {
      imageNode.setScaleMagnitude(1);
      imageNode.setImage(image);

      // Flip the image if reversed, or un-reverse it if it shouldn't be reversed.
      if (imageMass.reverseImage && imageNode.matrix.getDeterminant() > 0 || !imageMass.reverseImage && imageNode.matrix.getDeterminant() < 0) {
        imageNode.matrix = imageNode.matrix.timesMatrix(Matrix3.scaling(-1, 1));
      }
      const scalingFactor = Math.abs(modelViewTransform.modelToViewDeltaY(imageMass.heightProperty.get())) / imageNode.height;
      imageNode.scale(scalingFactor);
      imageNode.centerX = 0;
      if (isLabeled) {
        massLabel.maxWidth = imageNode.width;
        massLabel.centerX = imageNode.centerX + modelViewTransform.modelToViewDeltaX(imageMass.centerOfMassXOffset);
        massLabel.bottom = imageNode.top;
      }
      updatePositionAndAngle();
    });

    // Function for updating position and angle, used in multiple places below.
    function updatePositionAndAngle() {
      if (self.bounds.isFinite()) {
        self.rotation = 0;
        const imageMassPosition = imageMass.positionProperty.get();

        // Set overall position.  Recall that positions in the model are defined as the center bottom of the item.
        self.centerX = modelViewTransform.modelToViewX(imageMassPosition.x - imageMass.centerOfMassXOffset);
        self.bottom = modelViewTransform.modelToViewY(imageMassPosition.y);

        // Set the rotation.  Rotation point is the center bottom.
        self.rotateAround(new Vector2(modelViewTransform.modelToViewX(imageMassPosition.x), modelViewTransform.modelToViewY(imageMassPosition.y)), -imageMass.rotationAngleProperty.get());
      }
    }

    // Add the image node.
    this.addChild(imageNode);

    // Make the image node visible to descendant classes for layout purposes.
    this.imageNode = imageNode;

    // Observe height changes.
    imageMass.heightProperty.link(newHeight => {
      imageNode.setScaleMagnitude(1);
      const scalingFactor = Math.abs(modelViewTransform.modelToViewDeltaY(newHeight)) / imageNode.height;
      imageNode.scale(scalingFactor);
      updatePositionAndAngle();
    });

    // Observe position changes.
    imageMass.positionProperty.link(() => {
      updatePositionAndAngle();
    });

    // Observe rotational angle changes.
    imageMass.rotationAngleProperty.link(() => {
      updatePositionAndAngle();
    });

    // Make this non-pickable when animating so that users can't grab it mid-flight.
    imageMass.animatingProperty.link(animating => {
      this.pickable = !animating;
    });

    // Add the mouse event handler if this is intended to be draggable.
    if (draggable) {
      // @public (read-only) {MassDragHandler} - drag handler, made available for use by creator nodes
      this.dragHandler = new MassDragHandler(imageMass, modelViewTransform);
      this.addInputListener(this.dragHandler);
    }
  }
}
balancingAct.register('ImageMassNode', ImageMassNode);
export default ImageMassNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNYXRyaXgzIiwiVmVjdG9yMiIsIlN0cmluZ1V0aWxzIiwiUGhldEZvbnQiLCJJbWFnZSIsIk5vZGUiLCJUZXh0IiwiZGVmYXVsdEltYWdlX3BuZyIsImJhbGFuY2luZ0FjdCIsIkJhbGFuY2luZ0FjdFN0cmluZ3MiLCJCQVF1ZXJ5UGFyYW1ldGVycyIsIkNvbHVtblN0YXRlIiwiTWFzc0RyYWdIYW5kbGVyIiwia2dTdHJpbmciLCJrZyIsInBhdHRlcm4wVmFsdWUxVW5pdHNTdHJpbmciLCJwYXR0ZXJuMFZhbHVlMVVuaXRzIiwidW5rbm93bk1hc3NMYWJlbFN0cmluZyIsInVua25vd25NYXNzTGFiZWwiLCJJbWFnZU1hc3NOb2RlIiwiY29uc3RydWN0b3IiLCJpbWFnZU1hc3MiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJpc0xhYmVsZWQiLCJtYXNzTGFiZWxWaXNpYmxlUHJvcGVydHkiLCJkcmFnZ2FibGUiLCJjb2x1bW5TdGF0ZVByb3BlcnR5IiwiY3Vyc29yIiwic3RhbmZvcmQiLCJsaW5rIiwiY29sdW1uU3RhdGUiLCJET1VCTEVfQ09MVU1OUyIsInBpY2thYmxlIiwic2VsZiIsIm1hc3NMYWJlbCIsIm1hc3NMYWJlbFRleHQiLCJpc015c3RlcnkiLCJmb3JtYXQiLCJtYXNzVmFsdWUiLCJmb250IiwiYWRkQ2hpbGQiLCJ2aXNpYmxlIiwiaW1hZ2VOb2RlIiwiaW1hZ2VQcm9wZXJ0eSIsImltYWdlIiwic2V0U2NhbGVNYWduaXR1ZGUiLCJzZXRJbWFnZSIsInJldmVyc2VJbWFnZSIsIm1hdHJpeCIsImdldERldGVybWluYW50IiwidGltZXNNYXRyaXgiLCJzY2FsaW5nIiwic2NhbGluZ0ZhY3RvciIsIk1hdGgiLCJhYnMiLCJtb2RlbFRvVmlld0RlbHRhWSIsImhlaWdodFByb3BlcnR5IiwiZ2V0IiwiaGVpZ2h0Iiwic2NhbGUiLCJjZW50ZXJYIiwibWF4V2lkdGgiLCJ3aWR0aCIsIm1vZGVsVG9WaWV3RGVsdGFYIiwiY2VudGVyT2ZNYXNzWE9mZnNldCIsImJvdHRvbSIsInRvcCIsInVwZGF0ZVBvc2l0aW9uQW5kQW5nbGUiLCJib3VuZHMiLCJpc0Zpbml0ZSIsInJvdGF0aW9uIiwiaW1hZ2VNYXNzUG9zaXRpb24iLCJwb3NpdGlvblByb3BlcnR5IiwibW9kZWxUb1ZpZXdYIiwieCIsIm1vZGVsVG9WaWV3WSIsInkiLCJyb3RhdGVBcm91bmQiLCJyb3RhdGlvbkFuZ2xlUHJvcGVydHkiLCJuZXdIZWlnaHQiLCJhbmltYXRpbmdQcm9wZXJ0eSIsImFuaW1hdGluZyIsImRyYWdIYW5kbGVyIiwiYWRkSW5wdXRMaXN0ZW5lciIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiSW1hZ2VNYXNzTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUaGlzIGNsYXNzIGRlZmluZXMgYSBTY2VuZXJ5IG5vZGUgdGhhdCByZXByZXNlbnRzIGEgbW9kZWwgZWxlbWVudCBpbiB0aGUgdmlldywgYW5kIHRoZSBwYXJ0aWN1bGFyIG1vZGVsIGVsZW1lbnRcclxuICogaXRzZWxmIGNvbnRhaW5zIGFuIGltYWdlIHRoYXQgaXMgdXNlZCBhcyB0aGUgcHJpbWFyeSByZXByZXNlbnRhdGlvbi5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKi9cclxuXHJcbmltcG9ydCBNYXRyaXgzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9NYXRyaXgzLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgU3RyaW5nVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy91dGlsL1N0cmluZ1V0aWxzLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IEltYWdlLCBOb2RlLCBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGRlZmF1bHRJbWFnZV9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL2RlZmF1bHRJbWFnZV9wbmcuanMnO1xyXG5pbXBvcnQgYmFsYW5jaW5nQWN0IGZyb20gJy4uLy4uL2JhbGFuY2luZ0FjdC5qcyc7XHJcbmltcG9ydCBCYWxhbmNpbmdBY3RTdHJpbmdzIGZyb20gJy4uLy4uL0JhbGFuY2luZ0FjdFN0cmluZ3MuanMnO1xyXG5pbXBvcnQgQkFRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vQkFRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgQ29sdW1uU3RhdGUgZnJvbSAnLi4vbW9kZWwvQ29sdW1uU3RhdGUuanMnO1xyXG5pbXBvcnQgTWFzc0RyYWdIYW5kbGVyIGZyb20gJy4vTWFzc0RyYWdIYW5kbGVyLmpzJztcclxuXHJcbmNvbnN0IGtnU3RyaW5nID0gQmFsYW5jaW5nQWN0U3RyaW5ncy5rZztcclxuY29uc3QgcGF0dGVybjBWYWx1ZTFVbml0c1N0cmluZyA9IEJhbGFuY2luZ0FjdFN0cmluZ3MucGF0dGVybjBWYWx1ZTFVbml0cztcclxuY29uc3QgdW5rbm93bk1hc3NMYWJlbFN0cmluZyA9IEJhbGFuY2luZ0FjdFN0cmluZ3MudW5rbm93bk1hc3NMYWJlbDtcclxuXHJcbmNsYXNzIEltYWdlTWFzc05vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGltYWdlTWFzc1xyXG4gICAqIEBwYXJhbSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzTGFiZWxlZCAtIEZsYWcgdGhhdCBjb250cm9scyB3aGV0aGVyIHRoaXMgbm90ZSBpbmNsdWRlIGEgdGV4dHVhbCBsYWJlbCBvZiB0aGUgbWFzc1xyXG4gICAqIEBwYXJhbSBtYXNzTGFiZWxWaXNpYmxlUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGRyYWdnYWJsZVxyXG4gICAqIEBwYXJhbSB7RW51bWVyYXRpb25EZXByZWNhdGVkUHJvcGVydHkuPENvbHVtblN0YXRlPn0gY29sdW1uU3RhdGVQcm9wZXJ0eVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBpbWFnZU1hc3MsIG1vZGVsVmlld1RyYW5zZm9ybSwgaXNMYWJlbGVkLCBtYXNzTGFiZWxWaXNpYmxlUHJvcGVydHksIGRyYWdnYWJsZSwgY29sdW1uU3RhdGVQcm9wZXJ0eSApIHtcclxuICAgIHN1cGVyKCB7IGN1cnNvcjogJ3BvaW50ZXInIH0gKTtcclxuICAgIEJBUXVlcnlQYXJhbWV0ZXJzLnN0YW5mb3JkICYmIGNvbHVtblN0YXRlUHJvcGVydHkubGluayggY29sdW1uU3RhdGUgPT4ge1xyXG4gICAgICB0aGlzLmN1cnNvciA9IGNvbHVtblN0YXRlID09PSBDb2x1bW5TdGF0ZS5ET1VCTEVfQ09MVU1OUyA/ICdwb2ludGVyJyA6ICdkZWZhdWx0JztcclxuICAgICAgdGhpcy5waWNrYWJsZSA9IGNvbHVtblN0YXRlID09PSBDb2x1bW5TdGF0ZS5ET1VCTEVfQ09MVU1OUztcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGxldCBtYXNzTGFiZWw7XHJcbiAgICBpZiAoIGlzTGFiZWxlZCApIHtcclxuXHJcbiAgICAgIC8vIEFkZCB0aGUgbWFzcyBpbmRpY2F0b3IgbGFiZWwuICBOb3RlIHRoYXQgaXQgaXMgcG9zaXRpb25lZCBlbHNld2hlcmUuXHJcbiAgICAgIGNvbnN0IG1hc3NMYWJlbFRleHQgPSBpbWFnZU1hc3MuaXNNeXN0ZXJ5ID8gdW5rbm93bk1hc3NMYWJlbFN0cmluZyA6IFN0cmluZ1V0aWxzLmZvcm1hdChcclxuICAgICAgICBwYXR0ZXJuMFZhbHVlMVVuaXRzU3RyaW5nLCBpbWFnZU1hc3MubWFzc1ZhbHVlLCBrZ1N0cmluZyApO1xyXG4gICAgICBtYXNzTGFiZWwgPSBuZXcgVGV4dCggbWFzc0xhYmVsVGV4dCwgeyBmb250OiBuZXcgUGhldEZvbnQoIDEyICkgfSApO1xyXG4gICAgICB0aGlzLmFkZENoaWxkKCBtYXNzTGFiZWwgKTtcclxuXHJcbiAgICAgIC8vIE9ic2VydmUgY2hhbmdlcyB0byBtYXNzIGluZGljYXRvciBsYWJlbCB2aXNpYmlsaXR5LlxyXG4gICAgICBtYXNzTGFiZWxWaXNpYmxlUHJvcGVydHkubGluayggdmlzaWJsZSA9PiB7XHJcbiAgICAgICAgbWFzc0xhYmVsLnZpc2libGUgPSB2aXNpYmxlO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaW1hZ2VOb2RlID0gbmV3IEltYWdlKCBkZWZhdWx0SW1hZ2VfcG5nICk7XHJcblxyXG4gICAgLy8gT2JzZXJ2ZSBpbWFnZSBjaGFuZ2VzLlxyXG4gICAgaW1hZ2VNYXNzLmltYWdlUHJvcGVydHkubGluayggaW1hZ2UgPT4ge1xyXG4gICAgICBpbWFnZU5vZGUuc2V0U2NhbGVNYWduaXR1ZGUoIDEgKTtcclxuICAgICAgaW1hZ2VOb2RlLnNldEltYWdlKCBpbWFnZSApO1xyXG5cclxuICAgICAgLy8gRmxpcCB0aGUgaW1hZ2UgaWYgcmV2ZXJzZWQsIG9yIHVuLXJldmVyc2UgaXQgaWYgaXQgc2hvdWxkbid0IGJlIHJldmVyc2VkLlxyXG4gICAgICBpZiAoICggaW1hZ2VNYXNzLnJldmVyc2VJbWFnZSAmJiBpbWFnZU5vZGUubWF0cml4LmdldERldGVybWluYW50KCkgPiAwICkgfHxcclxuICAgICAgICAgICAoICFpbWFnZU1hc3MucmV2ZXJzZUltYWdlICYmIGltYWdlTm9kZS5tYXRyaXguZ2V0RGV0ZXJtaW5hbnQoKSA8IDAgKSApIHtcclxuICAgICAgICBpbWFnZU5vZGUubWF0cml4ID0gaW1hZ2VOb2RlLm1hdHJpeC50aW1lc01hdHJpeCggTWF0cml4My5zY2FsaW5nKCAtMSwgMSApICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHNjYWxpbmdGYWN0b3IgPSBNYXRoLmFicyggbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFZKCBpbWFnZU1hc3MuaGVpZ2h0UHJvcGVydHkuZ2V0KCkgKSApIC9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlTm9kZS5oZWlnaHQ7XHJcbiAgICAgIGltYWdlTm9kZS5zY2FsZSggc2NhbGluZ0ZhY3RvciApO1xyXG4gICAgICBpbWFnZU5vZGUuY2VudGVyWCA9IDA7XHJcbiAgICAgIGlmICggaXNMYWJlbGVkICkge1xyXG4gICAgICAgIG1hc3NMYWJlbC5tYXhXaWR0aCA9IGltYWdlTm9kZS53aWR0aDtcclxuICAgICAgICBtYXNzTGFiZWwuY2VudGVyWCA9IGltYWdlTm9kZS5jZW50ZXJYICsgbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFYKCBpbWFnZU1hc3MuY2VudGVyT2ZNYXNzWE9mZnNldCApO1xyXG4gICAgICAgIG1hc3NMYWJlbC5ib3R0b20gPSBpbWFnZU5vZGUudG9wO1xyXG4gICAgICB9XHJcbiAgICAgIHVwZGF0ZVBvc2l0aW9uQW5kQW5nbGUoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBGdW5jdGlvbiBmb3IgdXBkYXRpbmcgcG9zaXRpb24gYW5kIGFuZ2xlLCB1c2VkIGluIG11bHRpcGxlIHBsYWNlcyBiZWxvdy5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVBvc2l0aW9uQW5kQW5nbGUoKSB7XHJcbiAgICAgIGlmICggc2VsZi5ib3VuZHMuaXNGaW5pdGUoKSApIHtcclxuXHJcbiAgICAgICAgc2VsZi5yb3RhdGlvbiA9IDA7XHJcbiAgICAgICAgY29uc3QgaW1hZ2VNYXNzUG9zaXRpb24gPSBpbWFnZU1hc3MucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKTtcclxuXHJcbiAgICAgICAgLy8gU2V0IG92ZXJhbGwgcG9zaXRpb24uICBSZWNhbGwgdGhhdCBwb3NpdGlvbnMgaW4gdGhlIG1vZGVsIGFyZSBkZWZpbmVkIGFzIHRoZSBjZW50ZXIgYm90dG9tIG9mIHRoZSBpdGVtLlxyXG4gICAgICAgIHNlbGYuY2VudGVyWCA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1goIGltYWdlTWFzc1Bvc2l0aW9uLnggLSBpbWFnZU1hc3MuY2VudGVyT2ZNYXNzWE9mZnNldCApO1xyXG4gICAgICAgIHNlbGYuYm90dG9tID0gbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WSggaW1hZ2VNYXNzUG9zaXRpb24ueSApO1xyXG5cclxuICAgICAgICAvLyBTZXQgdGhlIHJvdGF0aW9uLiAgUm90YXRpb24gcG9pbnQgaXMgdGhlIGNlbnRlciBib3R0b20uXHJcbiAgICAgICAgc2VsZi5yb3RhdGVBcm91bmQoXHJcbiAgICAgICAgICBuZXcgVmVjdG9yMihcclxuICAgICAgICAgICAgbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WCggaW1hZ2VNYXNzUG9zaXRpb24ueCApLFxyXG4gICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCBpbWFnZU1hc3NQb3NpdGlvbi55IClcclxuICAgICAgICAgICksXHJcbiAgICAgICAgICAtaW1hZ2VNYXNzLnJvdGF0aW9uQW5nbGVQcm9wZXJ0eS5nZXQoKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBBZGQgdGhlIGltYWdlIG5vZGUuXHJcbiAgICB0aGlzLmFkZENoaWxkKCBpbWFnZU5vZGUgKTtcclxuXHJcbiAgICAvLyBNYWtlIHRoZSBpbWFnZSBub2RlIHZpc2libGUgdG8gZGVzY2VuZGFudCBjbGFzc2VzIGZvciBsYXlvdXQgcHVycG9zZXMuXHJcbiAgICB0aGlzLmltYWdlTm9kZSA9IGltYWdlTm9kZTtcclxuXHJcbiAgICAvLyBPYnNlcnZlIGhlaWdodCBjaGFuZ2VzLlxyXG4gICAgaW1hZ2VNYXNzLmhlaWdodFByb3BlcnR5LmxpbmsoIG5ld0hlaWdodCA9PiB7XHJcbiAgICAgIGltYWdlTm9kZS5zZXRTY2FsZU1hZ25pdHVkZSggMSApO1xyXG4gICAgICBjb25zdCBzY2FsaW5nRmFjdG9yID0gTWF0aC5hYnMoIG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWSggbmV3SGVpZ2h0ICkgKSAvIGltYWdlTm9kZS5oZWlnaHQ7XHJcbiAgICAgIGltYWdlTm9kZS5zY2FsZSggc2NhbGluZ0ZhY3RvciApO1xyXG4gICAgICB1cGRhdGVQb3NpdGlvbkFuZEFuZ2xlKCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gT2JzZXJ2ZSBwb3NpdGlvbiBjaGFuZ2VzLlxyXG4gICAgaW1hZ2VNYXNzLnBvc2l0aW9uUHJvcGVydHkubGluayggKCkgPT4ge1xyXG4gICAgICB1cGRhdGVQb3NpdGlvbkFuZEFuZ2xlKCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gT2JzZXJ2ZSByb3RhdGlvbmFsIGFuZ2xlIGNoYW5nZXMuXHJcbiAgICBpbWFnZU1hc3Mucm90YXRpb25BbmdsZVByb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgdXBkYXRlUG9zaXRpb25BbmRBbmdsZSgpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE1ha2UgdGhpcyBub24tcGlja2FibGUgd2hlbiBhbmltYXRpbmcgc28gdGhhdCB1c2VycyBjYW4ndCBncmFiIGl0IG1pZC1mbGlnaHQuXHJcbiAgICBpbWFnZU1hc3MuYW5pbWF0aW5nUHJvcGVydHkubGluayggYW5pbWF0aW5nID0+IHtcclxuICAgICAgdGhpcy5waWNrYWJsZSA9ICFhbmltYXRpbmc7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQWRkIHRoZSBtb3VzZSBldmVudCBoYW5kbGVyIGlmIHRoaXMgaXMgaW50ZW5kZWQgdG8gYmUgZHJhZ2dhYmxlLlxyXG4gICAgaWYgKCBkcmFnZ2FibGUgKSB7XHJcblxyXG4gICAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtNYXNzRHJhZ0hhbmRsZXJ9IC0gZHJhZyBoYW5kbGVyLCBtYWRlIGF2YWlsYWJsZSBmb3IgdXNlIGJ5IGNyZWF0b3Igbm9kZXNcclxuICAgICAgdGhpcy5kcmFnSGFuZGxlciA9IG5ldyBNYXNzRHJhZ0hhbmRsZXIoIGltYWdlTWFzcywgbW9kZWxWaWV3VHJhbnNmb3JtICk7XHJcblxyXG4gICAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIHRoaXMuZHJhZ0hhbmRsZXIgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmJhbGFuY2luZ0FjdC5yZWdpc3RlciggJ0ltYWdlTWFzc05vZGUnLCBJbWFnZU1hc3NOb2RlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBJbWFnZU1hc3NOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxXQUFXLE1BQU0sK0NBQStDO0FBQ3ZFLE9BQU9DLFFBQVEsTUFBTSx5Q0FBeUM7QUFDOUQsU0FBU0MsS0FBSyxFQUFFQyxJQUFJLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDckUsT0FBT0MsZ0JBQWdCLE1BQU0scUNBQXFDO0FBQ2xFLE9BQU9DLFlBQVksTUFBTSx1QkFBdUI7QUFDaEQsT0FBT0MsbUJBQW1CLE1BQU0sOEJBQThCO0FBQzlELE9BQU9DLGlCQUFpQixNQUFNLHlCQUF5QjtBQUN2RCxPQUFPQyxXQUFXLE1BQU0seUJBQXlCO0FBQ2pELE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFFbEQsTUFBTUMsUUFBUSxHQUFHSixtQkFBbUIsQ0FBQ0ssRUFBRTtBQUN2QyxNQUFNQyx5QkFBeUIsR0FBR04sbUJBQW1CLENBQUNPLG1CQUFtQjtBQUN6RSxNQUFNQyxzQkFBc0IsR0FBR1IsbUJBQW1CLENBQUNTLGdCQUFnQjtBQUVuRSxNQUFNQyxhQUFhLFNBQVNkLElBQUksQ0FBQztFQUUvQjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VlLFdBQVdBLENBQUVDLFNBQVMsRUFBRUMsa0JBQWtCLEVBQUVDLFNBQVMsRUFBRUMsd0JBQXdCLEVBQUVDLFNBQVMs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