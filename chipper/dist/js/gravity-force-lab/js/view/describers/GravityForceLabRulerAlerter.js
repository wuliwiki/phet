// Copyright 2019-2023, University of Colorado Boulder

/**
 * This describer is responsible for the descriptions associated with the movable ruler. Unlike other describers, this
 * type also alerts based on the movement of the ruler. This is a bit non-traditional, but made sense based on the
 * modularity of ruler specific content.
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import ISLCQueryParameters from '../../../../inverse-square-law-common/js/ISLCQueryParameters.js';
import ISLCDescriber from '../../../../inverse-square-law-common/js/view/describers/ISLCDescriber.js';
import ISLCObjectEnum from '../../../../inverse-square-law-common/js/model/ISLCObjectEnum.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import Alerter from '../../../../scenery-phet/js/accessibility/describers/Alerter.js';
import Utterance from '../../../../utterance-queue/js/Utterance.js';
import gravityForceLab from '../../gravityForceLab.js';
import GravityForceLabStrings from '../../GravityForceLabStrings.js';
const grabbedAlertPatternString = GravityForceLabStrings.a11y.ruler.grabbedAlertPattern;
const regionAndDistancePatternString = GravityForceLabStrings.a11y.ruler.regionAndDistancePattern;
const releaseAndExploreHintString = GravityForceLabStrings.a11y.ruler.releaseAndExploreHint;
const hintPatternString = GravityForceLabStrings.a11y.ruler.hintPattern;
const grabbedJumpKeyboardHintString = GravityForceLabStrings.a11y.ruler.grabbedJumpKeyboardHint;
const jumpCenterKeyboardHintString = GravityForceLabStrings.a11y.ruler.jumpCenterKeyboardHint;
const gestureHintString = GravityForceLabStrings.a11y.ruler.gestureHint;
const keyboardReleaseHintString = GravityForceLabStrings.a11y.ruler.keyboardReleaseHint;
const jumpCenterMassAlertString = GravityForceLabStrings.a11y.ruler.jumpCenterMassAlert;
const coveringM2String = GravityForceLabStrings.a11y.ruler.positions.coveringM2;
const coveringM1String = GravityForceLabStrings.a11y.ruler.positions.coveringM1;
const justAboveCentersString = GravityForceLabStrings.a11y.ruler.positions.justAboveCenters;
const coveringCentersString = GravityForceLabStrings.a11y.ruler.positions.coveringCenters;
const justBelowCentersString = GravityForceLabStrings.a11y.ruler.positions.justBelowCenters;
const inHomePositionString = GravityForceLabStrings.a11y.ruler.positions.inHomePosition;
const behindMassControlsString = GravityForceLabStrings.a11y.ruler.positions.behindMassControls;

// constants
const RULER_VERTICAL_REGIONS = [coveringM2String, coveringM1String, justAboveCentersString, coveringCentersString, justBelowCentersString, inHomePositionString, behindMassControlsString];
const SHOW_RULER_REGIONS = ISLCQueryParameters.showRulerRegions;
class GravityForceLabRulerAlerter extends Alerter {
  /**
   * @param {GravityForceLabModel} model
   * @param {string} object1Label
   * @param {string} object2Label
   * @param {ModelViewTransform2} modelViewTransform
   * @param {Array.<number>} viewYPositions - a list of Y positions, least (top) to greatest (bottom)
   * @param {PositionDescriber} positionDescriber
   * @param {Object} [options]
   */
  constructor(model, object1Label, object2Label, modelViewTransform, viewYPositions, positionDescriber, options) {
    assert && assert(RULER_VERTICAL_REGIONS.length === viewYPositions.length, 'Unexpected number of y positions');
    super(options);

    // @private
    this.rulerPositionProperty = model.rulerPositionProperty;
    this.modelViewTransform = modelViewTransform;
    this.positionDescriber = positionDescriber;
    this.viewYPositions = viewYPositions;
    this.grabbedCount = 0; // for grabbed alert
    this.horizontalDistanceThisGrab = 0; // for horizontal movement alerts
    this.previousVerticalRegionIndex = this.getVerticalRegionIndex(); // for vertical movement alerts
    this.previousRulerPosition = this.rulerPositionProperty.value;
    this.justMovementAlerted = false;

    // Used as a utility for getting either object label with only a reference to the other
    this.islcDescriber = new ISLCDescriber(model, object1Label, object2Label);

    // @private - alerts for different ruler specific alerts
    this.jumpCenterUtterance = new Utterance();
    this.movementUtterance = new Utterance(); // utterance to alert vertical and horizontal movement alerts
    this.releaseAndExploreUtterance = new Utterance({
      alert: releaseAndExploreHintString,
      predicate: () => this.releaseAndExploreUtterance.numberOfTimesAlerted < 2 // only alert for the first two time.
    });

    // @private - This alert follows a change in focus (release of the ruler) and "Release" alert - give
    // VoiceOver time to describe these before the jump alert so that no alerts get skipped, see
    // https://github.com/phetsims/gravity-force-lab/issues/225
    this.jumpHomeUtterance = new Utterance({
      alertStableDelay: 1000
    });

    // Don't need to unlink
    SHOW_RULER_REGIONS && this.rulerPositionProperty.link(() => console.log(this.getCurrentVerticalRegion()));
  }

  /**
   * Callback for when the ruler has just been dragged.
   * @public
   */
  onDrag() {
    // if the previous drag triggered a movement alert, then alert the release hint now.
    if (this.justMovementAlerted) {
      this.alertDescriptionUtterance(this.releaseAndExploreUtterance);
      this.justMovementAlerted = false;
    }

    // handle horizontal case
    this.horizontalDistanceThisGrab += Math.abs(this.previousRulerPosition.minus(this.rulerPositionProperty.value).x);
    if (this.horizontalDistanceThisGrab >= 1) {
      this.alertRulerMovement();
      this.horizontalDistanceThisGrab = 0;
    }
    this.previousRulerPosition = this.rulerPositionProperty.value;

    // handle vertical case
    const currentVerticalRegionIndex = this.getVerticalRegionIndex();
    if (this.previousVerticalRegionIndex !== currentVerticalRegionIndex) {
      this.alertRulerMovement();
      this.previousVerticalRegionIndex = currentVerticalRegionIndex;
    }
  }

  /**
   * This alert is for whenever the ruler is moved around normally (not when moved with jumping shortcuts)
   * @private
   */
  alertRulerMovement() {
    this.movementUtterance.alert = this.getRegionAndDistance();
    this.alertDescriptionUtterance(this.movementUtterance);
    this.justMovementAlerted = true;
  }

  /**
   * @private
   * @returns {string}
   */
  getGrabbedHint() {
    // No hints on or after the third grab
    if (this.grabbedCount >= 3) {
      return '';
    }

    // gesture hint
    if (phet.joist.sim.supportsGestureDescription) {
      return gestureHintString;
    }

    // keyboard hint
    return StringUtils.fillIn(hintPatternString, {
      playHint: grabbedJumpKeyboardHintString,
      releaseHint: keyboardReleaseHintString
    });
  }

  /**
   * Get the region and distance string.
   * @public
   * @returns {string}.
   */
  getRegionAndDistance() {
    return StringUtils.fillIn(regionAndDistancePatternString, {
      verticalRegion: this.getCurrentVerticalRegion(),
      centersApart: this.positionDescriber.getCentersApartDistance()
    });
  }

  /**
   * This should only be called after `onGrab` to make sure that ruler describer state is in sync
   * @public
   * @returns {string} - the alert for successfully grabbing the ruler.
   */
  getRulerGrabbedAlertable() {
    return StringUtils.fillIn(grabbedAlertPatternString, {
      regionAndDistance: this.getRegionAndDistance(),
      supplementalHint: this.getGrabbedHint()
    });
  }

  /**
   * Callback for when the ruler is grabbed, to update the state internal to this describer. This should be called
   * whenever the ruler is grabbed.
   * @public
   */
  onGrab() {
    this.grabbedCount++;
    this.horizontalDistanceThisGrab = 0; // reset
  }

  /**
   * @private
   * @returns {number} - integer index of the region
   */
  getVerticalRegionIndex() {
    const viewY = this.modelViewTransform.modelToViewY(this.rulerPositionProperty.value.y);
    for (let i = 0; i < this.viewYPositions.length; i++) {
      if (viewY <= this.viewYPositions[i]) {
        return i;
      }
    }
    throw new Error('value out of range: ' + viewY);
  }

  /**
   * @private
   * @returns {*}
   */
  getCurrentVerticalRegion() {
    return RULER_VERTICAL_REGIONS[this.getVerticalRegionIndex()];
  }

  /**
   * Get current vertical position when in home position. Should only be called when the ruler is currently in home
   * position.
   * @private
   */
  getHomePositionString() {
    const currentRegion = this.getCurrentVerticalRegion();
    assert && assert(currentRegion === inHomePositionString, 'getHomePositionString called when ruler not in home position');
    return currentRegion;
  }

  /**
   * @public
   * Alert that the ruler has jumped to the home position
   */
  alertJumpHome() {
    this.jumpHomeUtterance.alert = this.getHomePositionString();
    this.alertDescriptionUtterance(this.jumpHomeUtterance);
  }

  /**
   * @public
   * @returns {string}
   */
  getJumpCenterMassAlert() {
    return StringUtils.fillIn(jumpCenterMassAlertString, {
      centersApart: this.positionDescriber.getCentersApartDistance(),
      object1: this.islcDescriber.getObjectLabelFromEnum(ISLCObjectEnum.OBJECT_ONE),
      supplementalHint: this.jumpCenterUtterance.numberOfTimesAlerted < 2 ? jumpCenterKeyboardHintString : ''
    });
  }

  /**
   * @public
   * Alert that the ruler has jumped to the center of a mass
   */
  alertJumpCenterMass() {
    this.jumpCenterUtterance.alert = this.getJumpCenterMassAlert();
    this.alertDescriptionUtterance(this.jumpCenterUtterance);
  }

  /**
   * Expected to be called after the model is reset
   * @public
   */
  reset() {
    // reset local state
    this.grabbedCount = 0;
    this.horizontalDistanceThisGrab = 0;
    this.previousVerticalRegionIndex = this.getVerticalRegionIndex();
    this.previousRulerPosition = this.rulerPositionProperty.value;
    this.justMovementAlerted = false;

    // reset utterances
    this.releaseAndExploreUtterance.reset();
    this.jumpCenterUtterance.reset();
    this.jumpHomeUtterance.reset();
    this.movementUtterance.reset();
  }
}
gravityForceLab.register('GravityForceLabRulerAlerter', GravityForceLabRulerAlerter);
export default GravityForceLabRulerAlerter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJJU0xDUXVlcnlQYXJhbWV0ZXJzIiwiSVNMQ0Rlc2NyaWJlciIsIklTTENPYmplY3RFbnVtIiwiU3RyaW5nVXRpbHMiLCJBbGVydGVyIiwiVXR0ZXJhbmNlIiwiZ3Jhdml0eUZvcmNlTGFiIiwiR3Jhdml0eUZvcmNlTGFiU3RyaW5ncyIsImdyYWJiZWRBbGVydFBhdHRlcm5TdHJpbmciLCJhMTF5IiwicnVsZXIiLCJncmFiYmVkQWxlcnRQYXR0ZXJuIiwicmVnaW9uQW5kRGlzdGFuY2VQYXR0ZXJuU3RyaW5nIiwicmVnaW9uQW5kRGlzdGFuY2VQYXR0ZXJuIiwicmVsZWFzZUFuZEV4cGxvcmVIaW50U3RyaW5nIiwicmVsZWFzZUFuZEV4cGxvcmVIaW50IiwiaGludFBhdHRlcm5TdHJpbmciLCJoaW50UGF0dGVybiIsImdyYWJiZWRKdW1wS2V5Ym9hcmRIaW50U3RyaW5nIiwiZ3JhYmJlZEp1bXBLZXlib2FyZEhpbnQiLCJqdW1wQ2VudGVyS2V5Ym9hcmRIaW50U3RyaW5nIiwianVtcENlbnRlcktleWJvYXJkSGludCIsImdlc3R1cmVIaW50U3RyaW5nIiwiZ2VzdHVyZUhpbnQiLCJrZXlib2FyZFJlbGVhc2VIaW50U3RyaW5nIiwia2V5Ym9hcmRSZWxlYXNlSGludCIsImp1bXBDZW50ZXJNYXNzQWxlcnRTdHJpbmciLCJqdW1wQ2VudGVyTWFzc0FsZXJ0IiwiY292ZXJpbmdNMlN0cmluZyIsInBvc2l0aW9ucyIsImNvdmVyaW5nTTIiLCJjb3ZlcmluZ00xU3RyaW5nIiwiY292ZXJpbmdNMSIsImp1c3RBYm92ZUNlbnRlcnNTdHJpbmciLCJqdXN0QWJvdmVDZW50ZXJzIiwiY292ZXJpbmdDZW50ZXJzU3RyaW5nIiwiY292ZXJpbmdDZW50ZXJzIiwianVzdEJlbG93Q2VudGVyc1N0cmluZyIsImp1c3RCZWxvd0NlbnRlcnMiLCJpbkhvbWVQb3NpdGlvblN0cmluZyIsImluSG9tZVBvc2l0aW9uIiwiYmVoaW5kTWFzc0NvbnRyb2xzU3RyaW5nIiwiYmVoaW5kTWFzc0NvbnRyb2xzIiwiUlVMRVJfVkVSVElDQUxfUkVHSU9OUyIsIlNIT1dfUlVMRVJfUkVHSU9OUyIsInNob3dSdWxlclJlZ2lvbnMiLCJHcmF2aXR5Rm9yY2VMYWJSdWxlckFsZXJ0ZXIiLCJjb25zdHJ1Y3RvciIsIm1vZGVsIiwib2JqZWN0MUxhYmVsIiwib2JqZWN0MkxhYmVsIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwidmlld1lQb3NpdGlvbnMiLCJwb3NpdGlvbkRlc2NyaWJlciIsIm9wdGlvbnMiLCJhc3NlcnQiLCJsZW5ndGgiLCJydWxlclBvc2l0aW9uUHJvcGVydHkiLCJncmFiYmVkQ291bnQiLCJob3Jpem9udGFsRGlzdGFuY2VUaGlzR3JhYiIsInByZXZpb3VzVmVydGljYWxSZWdpb25JbmRleCIsImdldFZlcnRpY2FsUmVnaW9uSW5kZXgiLCJwcmV2aW91c1J1bGVyUG9zaXRpb24iLCJ2YWx1ZSIsImp1c3RNb3ZlbWVudEFsZXJ0ZWQiLCJpc2xjRGVzY3JpYmVyIiwianVtcENlbnRlclV0dGVyYW5jZSIsIm1vdmVtZW50VXR0ZXJhbmNlIiwicmVsZWFzZUFuZEV4cGxvcmVVdHRlcmFuY2UiLCJhbGVydCIsInByZWRpY2F0ZSIsIm51bWJlck9mVGltZXNBbGVydGVkIiwianVtcEhvbWVVdHRlcmFuY2UiLCJhbGVydFN0YWJsZURlbGF5IiwibGluayIsImNvbnNvbGUiLCJsb2ciLCJnZXRDdXJyZW50VmVydGljYWxSZWdpb24iLCJvbkRyYWciLCJhbGVydERlc2NyaXB0aW9uVXR0ZXJhbmNlIiwiTWF0aCIsImFicyIsIm1pbnVzIiwieCIsImFsZXJ0UnVsZXJNb3ZlbWVudCIsImN1cnJlbnRWZXJ0aWNhbFJlZ2lvbkluZGV4IiwiZ2V0UmVnaW9uQW5kRGlzdGFuY2UiLCJnZXRHcmFiYmVkSGludCIsInBoZXQiLCJqb2lzdCIsInNpbSIsInN1cHBvcnRzR2VzdHVyZURlc2NyaXB0aW9uIiwiZmlsbEluIiwicGxheUhpbnQiLCJyZWxlYXNlSGludCIsInZlcnRpY2FsUmVnaW9uIiwiY2VudGVyc0FwYXJ0IiwiZ2V0Q2VudGVyc0FwYXJ0RGlzdGFuY2UiLCJnZXRSdWxlckdyYWJiZWRBbGVydGFibGUiLCJyZWdpb25BbmREaXN0YW5jZSIsInN1cHBsZW1lbnRhbEhpbnQiLCJvbkdyYWIiLCJ2aWV3WSIsIm1vZGVsVG9WaWV3WSIsInkiLCJpIiwiRXJyb3IiLCJnZXRIb21lUG9zaXRpb25TdHJpbmciLCJjdXJyZW50UmVnaW9uIiwiYWxlcnRKdW1wSG9tZSIsImdldEp1bXBDZW50ZXJNYXNzQWxlcnQiLCJvYmplY3QxIiwiZ2V0T2JqZWN0TGFiZWxGcm9tRW51bSIsIk9CSkVDVF9PTkUiLCJhbGVydEp1bXBDZW50ZXJNYXNzIiwicmVzZXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkdyYXZpdHlGb3JjZUxhYlJ1bGVyQWxlcnRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUaGlzIGRlc2NyaWJlciBpcyByZXNwb25zaWJsZSBmb3IgdGhlIGRlc2NyaXB0aW9ucyBhc3NvY2lhdGVkIHdpdGggdGhlIG1vdmFibGUgcnVsZXIuIFVubGlrZSBvdGhlciBkZXNjcmliZXJzLCB0aGlzXHJcbiAqIHR5cGUgYWxzbyBhbGVydHMgYmFzZWQgb24gdGhlIG1vdmVtZW50IG9mIHRoZSBydWxlci4gVGhpcyBpcyBhIGJpdCBub24tdHJhZGl0aW9uYWwsIGJ1dCBtYWRlIHNlbnNlIGJhc2VkIG9uIHRoZVxyXG4gKiBtb2R1bGFyaXR5IG9mIHJ1bGVyIHNwZWNpZmljIGNvbnRlbnQuXHJcbiAqXHJcbiAqIEBhdXRob3IgTWljaGFlbCBLYXV6bWFubiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgSVNMQ1F1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi8uLi8uLi9pbnZlcnNlLXNxdWFyZS1sYXctY29tbW9uL2pzL0lTTENRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgSVNMQ0Rlc2NyaWJlciBmcm9tICcuLi8uLi8uLi8uLi9pbnZlcnNlLXNxdWFyZS1sYXctY29tbW9uL2pzL3ZpZXcvZGVzY3JpYmVycy9JU0xDRGVzY3JpYmVyLmpzJztcclxuaW1wb3J0IElTTENPYmplY3RFbnVtIGZyb20gJy4uLy4uLy4uLy4uL2ludmVyc2Utc3F1YXJlLWxhdy1jb21tb24vanMvbW9kZWwvSVNMQ09iamVjdEVudW0uanMnO1xyXG5pbXBvcnQgU3RyaW5nVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy91dGlsL1N0cmluZ1V0aWxzLmpzJztcclxuaW1wb3J0IEFsZXJ0ZXIgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2FjY2Vzc2liaWxpdHkvZGVzY3JpYmVycy9BbGVydGVyLmpzJztcclxuaW1wb3J0IFV0dGVyYW5jZSBmcm9tICcuLi8uLi8uLi8uLi91dHRlcmFuY2UtcXVldWUvanMvVXR0ZXJhbmNlLmpzJztcclxuaW1wb3J0IGdyYXZpdHlGb3JjZUxhYiBmcm9tICcuLi8uLi9ncmF2aXR5Rm9yY2VMYWIuanMnO1xyXG5pbXBvcnQgR3Jhdml0eUZvcmNlTGFiU3RyaW5ncyBmcm9tICcuLi8uLi9HcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmpzJztcclxuXHJcbmNvbnN0IGdyYWJiZWRBbGVydFBhdHRlcm5TdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIuZ3JhYmJlZEFsZXJ0UGF0dGVybjtcclxuY29uc3QgcmVnaW9uQW5kRGlzdGFuY2VQYXR0ZXJuU3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLnJlZ2lvbkFuZERpc3RhbmNlUGF0dGVybjtcclxuY29uc3QgcmVsZWFzZUFuZEV4cGxvcmVIaW50U3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLnJlbGVhc2VBbmRFeHBsb3JlSGludDtcclxuY29uc3QgaGludFBhdHRlcm5TdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIuaGludFBhdHRlcm47XHJcbmNvbnN0IGdyYWJiZWRKdW1wS2V5Ym9hcmRIaW50U3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLmdyYWJiZWRKdW1wS2V5Ym9hcmRIaW50O1xyXG5jb25zdCBqdW1wQ2VudGVyS2V5Ym9hcmRIaW50U3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLmp1bXBDZW50ZXJLZXlib2FyZEhpbnQ7XHJcbmNvbnN0IGdlc3R1cmVIaW50U3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLmdlc3R1cmVIaW50O1xyXG5jb25zdCBrZXlib2FyZFJlbGVhc2VIaW50U3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLmtleWJvYXJkUmVsZWFzZUhpbnQ7XHJcbmNvbnN0IGp1bXBDZW50ZXJNYXNzQWxlcnRTdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIuanVtcENlbnRlck1hc3NBbGVydDtcclxuXHJcbmNvbnN0IGNvdmVyaW5nTTJTdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIucG9zaXRpb25zLmNvdmVyaW5nTTI7XHJcbmNvbnN0IGNvdmVyaW5nTTFTdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIucG9zaXRpb25zLmNvdmVyaW5nTTE7XHJcbmNvbnN0IGp1c3RBYm92ZUNlbnRlcnNTdHJpbmcgPSBHcmF2aXR5Rm9yY2VMYWJTdHJpbmdzLmExMXkucnVsZXIucG9zaXRpb25zLmp1c3RBYm92ZUNlbnRlcnM7XHJcbmNvbnN0IGNvdmVyaW5nQ2VudGVyc1N0cmluZyA9IEdyYXZpdHlGb3JjZUxhYlN0cmluZ3MuYTExeS5ydWxlci5wb3NpdGlvbnMuY292ZXJpbmdDZW50ZXJzO1xyXG5jb25zdCBqdXN0QmVsb3dDZW50ZXJzU3RyaW5nID0gR3Jhdml0eUZvcmNlTGFiU3RyaW5ncy5hMTF5LnJ1bGVyLnBvc2l0aW9ucy5qdXN0QmVsb3dDZW50ZXJzO1xyXG5jb25zdCBpbkhvbWVQb3NpdGlvblN0cmluZyA9IEdyYXZpdHlGb3JjZUxhYlN0cmluZ3MuYTExeS5ydWxlci5wb3NpdGlvbnMuaW5Ib21lUG9zaXRpb247XHJcbmNvbnN0IGJlaGluZE1hc3NDb250cm9sc1N0cmluZyA9IEdyYXZpdHlGb3JjZUxhYlN0cmluZ3MuYTExeS5ydWxlci5wb3NpdGlvbnMuYmVoaW5kTWFzc0NvbnRyb2xzO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFJVTEVSX1ZFUlRJQ0FMX1JFR0lPTlMgPSBbXHJcbiAgY292ZXJpbmdNMlN0cmluZyxcclxuICBjb3ZlcmluZ00xU3RyaW5nLFxyXG4gIGp1c3RBYm92ZUNlbnRlcnNTdHJpbmcsXHJcbiAgY292ZXJpbmdDZW50ZXJzU3RyaW5nLFxyXG4gIGp1c3RCZWxvd0NlbnRlcnNTdHJpbmcsXHJcbiAgaW5Ib21lUG9zaXRpb25TdHJpbmcsXHJcbiAgYmVoaW5kTWFzc0NvbnRyb2xzU3RyaW5nXHJcbl07XHJcbmNvbnN0IFNIT1dfUlVMRVJfUkVHSU9OUyA9IElTTENRdWVyeVBhcmFtZXRlcnMuc2hvd1J1bGVyUmVnaW9ucztcclxuXHJcbmNsYXNzIEdyYXZpdHlGb3JjZUxhYlJ1bGVyQWxlcnRlciBleHRlbmRzIEFsZXJ0ZXIge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge0dyYXZpdHlGb3JjZUxhYk1vZGVsfSBtb2RlbFxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvYmplY3QxTGFiZWxcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gb2JqZWN0MkxhYmVsXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge0FycmF5LjxudW1iZXI+fSB2aWV3WVBvc2l0aW9ucyAtIGEgbGlzdCBvZiBZIHBvc2l0aW9ucywgbGVhc3QgKHRvcCkgdG8gZ3JlYXRlc3QgKGJvdHRvbSlcclxuICAgKiBAcGFyYW0ge1Bvc2l0aW9uRGVzY3JpYmVyfSBwb3NpdGlvbkRlc2NyaWJlclxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbW9kZWwsIG9iamVjdDFMYWJlbCwgb2JqZWN0MkxhYmVsLCBtb2RlbFZpZXdUcmFuc2Zvcm0sIHZpZXdZUG9zaXRpb25zLCBwb3NpdGlvbkRlc2NyaWJlciwgb3B0aW9ucyApIHtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBSVUxFUl9WRVJUSUNBTF9SRUdJT05TLmxlbmd0aCA9PT0gdmlld1lQb3NpdGlvbnMubGVuZ3RoLCAnVW5leHBlY3RlZCBudW1iZXIgb2YgeSBwb3NpdGlvbnMnICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5ydWxlclBvc2l0aW9uUHJvcGVydHkgPSBtb2RlbC5ydWxlclBvc2l0aW9uUHJvcGVydHk7XHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IG1vZGVsVmlld1RyYW5zZm9ybTtcclxuICAgIHRoaXMucG9zaXRpb25EZXNjcmliZXIgPSBwb3NpdGlvbkRlc2NyaWJlcjtcclxuICAgIHRoaXMudmlld1lQb3NpdGlvbnMgPSB2aWV3WVBvc2l0aW9ucztcclxuICAgIHRoaXMuZ3JhYmJlZENvdW50ID0gMDsgLy8gZm9yIGdyYWJiZWQgYWxlcnRcclxuICAgIHRoaXMuaG9yaXpvbnRhbERpc3RhbmNlVGhpc0dyYWIgPSAwOyAvLyBmb3IgaG9yaXpvbnRhbCBtb3ZlbWVudCBhbGVydHNcclxuICAgIHRoaXMucHJldmlvdXNWZXJ0aWNhbFJlZ2lvbkluZGV4ID0gdGhpcy5nZXRWZXJ0aWNhbFJlZ2lvbkluZGV4KCk7IC8vIGZvciB2ZXJ0aWNhbCBtb3ZlbWVudCBhbGVydHNcclxuICAgIHRoaXMucHJldmlvdXNSdWxlclBvc2l0aW9uID0gdGhpcy5ydWxlclBvc2l0aW9uUHJvcGVydHkudmFsdWU7XHJcbiAgICB0aGlzLmp1c3RNb3ZlbWVudEFsZXJ0ZWQgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBVc2VkIGFzIGEgdXRpbGl0eSBmb3IgZ2V0dGluZyBlaXRoZXIgb2JqZWN0IGxhYmVsIHdpdGggb25seSBhIHJlZmVyZW5jZSB0byB0aGUgb3RoZXJcclxuICAgIHRoaXMuaXNsY0Rlc2NyaWJlciA9IG5ldyBJU0xDRGVzY3JpYmVyKCBtb2RlbCwgb2JqZWN0MUxhYmVsLCBvYmplY3QyTGFiZWwgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIGFsZXJ0cyBmb3IgZGlmZmVyZW50IHJ1bGVyIHNwZWNpZmljIGFsZXJ0c1xyXG4gICAgdGhpcy5qdW1wQ2VudGVyVXR0ZXJhbmNlID0gbmV3IFV0dGVyYW5jZSgpO1xyXG4gICAgdGhpcy5tb3ZlbWVudFV0dGVyYW5jZSA9IG5ldyBVdHRlcmFuY2UoKTsgLy8gdXR0ZXJhbmNlIHRvIGFsZXJ0IHZlcnRpY2FsIGFuZCBob3Jpem9udGFsIG1vdmVtZW50IGFsZXJ0c1xyXG4gICAgdGhpcy5yZWxlYXNlQW5kRXhwbG9yZVV0dGVyYW5jZSA9IG5ldyBVdHRlcmFuY2UoIHtcclxuICAgICAgYWxlcnQ6IHJlbGVhc2VBbmRFeHBsb3JlSGludFN0cmluZyxcclxuICAgICAgcHJlZGljYXRlOiAoKSA9PiB0aGlzLnJlbGVhc2VBbmRFeHBsb3JlVXR0ZXJhbmNlLm51bWJlck9mVGltZXNBbGVydGVkIDwgMiAvLyBvbmx5IGFsZXJ0IGZvciB0aGUgZmlyc3QgdHdvIHRpbWUuXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBUaGlzIGFsZXJ0IGZvbGxvd3MgYSBjaGFuZ2UgaW4gZm9jdXMgKHJlbGVhc2Ugb2YgdGhlIHJ1bGVyKSBhbmQgXCJSZWxlYXNlXCIgYWxlcnQgLSBnaXZlXHJcbiAgICAvLyBWb2ljZU92ZXIgdGltZSB0byBkZXNjcmliZSB0aGVzZSBiZWZvcmUgdGhlIGp1bXAgYWxlcnQgc28gdGhhdCBubyBhbGVydHMgZ2V0IHNraXBwZWQsIHNlZVxyXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2dyYXZpdHktZm9yY2UtbGFiL2lzc3Vlcy8yMjVcclxuICAgIHRoaXMuanVtcEhvbWVVdHRlcmFuY2UgPSBuZXcgVXR0ZXJhbmNlKCB7IGFsZXJ0U3RhYmxlRGVsYXk6IDEwMDAgfSApO1xyXG5cclxuICAgIC8vIERvbid0IG5lZWQgdG8gdW5saW5rXHJcbiAgICBTSE9XX1JVTEVSX1JFR0lPTlMgJiYgdGhpcy5ydWxlclBvc2l0aW9uUHJvcGVydHkubGluayggKCkgPT4gY29uc29sZS5sb2coIHRoaXMuZ2V0Q3VycmVudFZlcnRpY2FsUmVnaW9uKCkgKSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FsbGJhY2sgZm9yIHdoZW4gdGhlIHJ1bGVyIGhhcyBqdXN0IGJlZW4gZHJhZ2dlZC5cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgb25EcmFnKCkge1xyXG5cclxuICAgIC8vIGlmIHRoZSBwcmV2aW91cyBkcmFnIHRyaWdnZXJlZCBhIG1vdmVtZW50IGFsZXJ0LCB0aGVuIGFsZXJ0IHRoZSByZWxlYXNlIGhpbnQgbm93LlxyXG4gICAgaWYgKCB0aGlzLmp1c3RNb3ZlbWVudEFsZXJ0ZWQgKSB7XHJcbiAgICAgIHRoaXMuYWxlcnREZXNjcmlwdGlvblV0dGVyYW5jZSggdGhpcy5yZWxlYXNlQW5kRXhwbG9yZVV0dGVyYW5jZSApO1xyXG4gICAgICB0aGlzLmp1c3RNb3ZlbWVudEFsZXJ0ZWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBoYW5kbGUgaG9yaXpvbnRhbCBjYXNlXHJcbiAgICB0aGlzLmhvcml6b250YWxEaXN0YW5jZVRoaXNHcmFiICs9IE1hdGguYWJzKCB0aGlzLnByZXZpb3VzUnVsZXJQb3NpdGlvbi5taW51cyggdGhpcy5ydWxlclBvc2l0aW9uUHJvcGVydHkudmFsdWUgKS54ICk7XHJcbiAgICBpZiAoIHRoaXMuaG9yaXpvbnRhbERpc3RhbmNlVGhpc0dyYWIgPj0gMSApIHtcclxuICAgICAgdGhpcy5hbGVydFJ1bGVyTW92ZW1lbnQoKTtcclxuICAgICAgdGhpcy5ob3Jpem9udGFsRGlzdGFuY2VUaGlzR3JhYiA9IDA7XHJcbiAgICB9XHJcbiAgICB0aGlzLnByZXZpb3VzUnVsZXJQb3NpdGlvbiA9IHRoaXMucnVsZXJQb3NpdGlvblByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgIC8vIGhhbmRsZSB2ZXJ0aWNhbCBjYXNlXHJcbiAgICBjb25zdCBjdXJyZW50VmVydGljYWxSZWdpb25JbmRleCA9IHRoaXMuZ2V0VmVydGljYWxSZWdpb25JbmRleCgpO1xyXG4gICAgaWYgKCB0aGlzLnByZXZpb3VzVmVydGljYWxSZWdpb25JbmRleCAhPT0gY3VycmVudFZlcnRpY2FsUmVnaW9uSW5kZXggKSB7XHJcbiAgICAgIHRoaXMuYWxlcnRSdWxlck1vdmVtZW50KCk7XHJcbiAgICAgIHRoaXMucHJldmlvdXNWZXJ0aWNhbFJlZ2lvbkluZGV4ID0gY3VycmVudFZlcnRpY2FsUmVnaW9uSW5kZXg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUaGlzIGFsZXJ0IGlzIGZvciB3aGVuZXZlciB0aGUgcnVsZXIgaXMgbW92ZWQgYXJvdW5kIG5vcm1hbGx5IChub3Qgd2hlbiBtb3ZlZCB3aXRoIGp1bXBpbmcgc2hvcnRjdXRzKVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgYWxlcnRSdWxlck1vdmVtZW50KCkge1xyXG4gICAgdGhpcy5tb3ZlbWVudFV0dGVyYW5jZS5hbGVydCA9IHRoaXMuZ2V0UmVnaW9uQW5kRGlzdGFuY2UoKTtcclxuICAgIHRoaXMuYWxlcnREZXNjcmlwdGlvblV0dGVyYW5jZSggdGhpcy5tb3ZlbWVudFV0dGVyYW5jZSApO1xyXG4gICAgdGhpcy5qdXN0TW92ZW1lbnRBbGVydGVkID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICogQHJldHVybnMge3N0cmluZ31cclxuICAgKi9cclxuICBnZXRHcmFiYmVkSGludCgpIHtcclxuXHJcbiAgICAvLyBObyBoaW50cyBvbiBvciBhZnRlciB0aGUgdGhpcmQgZ3JhYlxyXG4gICAgaWYgKCB0aGlzLmdyYWJiZWRDb3VudCA+PSAzICkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZ2VzdHVyZSBoaW50XHJcbiAgICBpZiAoIHBoZXQuam9pc3Quc2ltLnN1cHBvcnRzR2VzdHVyZURlc2NyaXB0aW9uICkge1xyXG4gICAgICByZXR1cm4gZ2VzdHVyZUhpbnRTdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8ga2V5Ym9hcmQgaGludFxyXG4gICAgcmV0dXJuIFN0cmluZ1V0aWxzLmZpbGxJbiggaGludFBhdHRlcm5TdHJpbmcsIHtcclxuICAgICAgcGxheUhpbnQ6IGdyYWJiZWRKdW1wS2V5Ym9hcmRIaW50U3RyaW5nLFxyXG4gICAgICByZWxlYXNlSGludDoga2V5Ym9hcmRSZWxlYXNlSGludFN0cmluZ1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSByZWdpb24gYW5kIGRpc3RhbmNlIHN0cmluZy5cclxuICAgKiBAcHVibGljXHJcbiAgICogQHJldHVybnMge3N0cmluZ30uXHJcbiAgICovXHJcbiAgZ2V0UmVnaW9uQW5kRGlzdGFuY2UoKSB7XHJcbiAgICByZXR1cm4gU3RyaW5nVXRpbHMuZmlsbEluKCByZWdpb25BbmREaXN0YW5jZVBhdHRlcm5TdHJpbmcsIHtcclxuICAgICAgdmVydGljYWxSZWdpb246IHRoaXMuZ2V0Q3VycmVudFZlcnRpY2FsUmVnaW9uKCksXHJcbiAgICAgIGNlbnRlcnNBcGFydDogdGhpcy5wb3NpdGlvbkRlc2NyaWJlci5nZXRDZW50ZXJzQXBhcnREaXN0YW5jZSgpXHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBhZnRlciBgb25HcmFiYCB0byBtYWtlIHN1cmUgdGhhdCBydWxlciBkZXNjcmliZXIgc3RhdGUgaXMgaW4gc3luY1xyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIHRoZSBhbGVydCBmb3Igc3VjY2Vzc2Z1bGx5IGdyYWJiaW5nIHRoZSBydWxlci5cclxuICAgKi9cclxuICBnZXRSdWxlckdyYWJiZWRBbGVydGFibGUoKSB7XHJcbiAgICByZXR1cm4gU3RyaW5nVXRpbHMuZmlsbEluKCBncmFiYmVkQWxlcnRQYXR0ZXJuU3RyaW5nLCB7XHJcbiAgICAgIHJlZ2lvbkFuZERpc3RhbmNlOiB0aGlzLmdldFJlZ2lvbkFuZERpc3RhbmNlKCksXHJcbiAgICAgIHN1cHBsZW1lbnRhbEhpbnQ6IHRoaXMuZ2V0R3JhYmJlZEhpbnQoKVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FsbGJhY2sgZm9yIHdoZW4gdGhlIHJ1bGVyIGlzIGdyYWJiZWQsIHRvIHVwZGF0ZSB0aGUgc3RhdGUgaW50ZXJuYWwgdG8gdGhpcyBkZXNjcmliZXIuIFRoaXMgc2hvdWxkIGJlIGNhbGxlZFxyXG4gICAqIHdoZW5ldmVyIHRoZSBydWxlciBpcyBncmFiYmVkLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBvbkdyYWIoKSB7XHJcbiAgICB0aGlzLmdyYWJiZWRDb3VudCsrO1xyXG4gICAgdGhpcy5ob3Jpem9udGFsRGlzdGFuY2VUaGlzR3JhYiA9IDA7IC8vIHJlc2V0XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHByaXZhdGVcclxuICAgKiBAcmV0dXJucyB7bnVtYmVyfSAtIGludGVnZXIgaW5kZXggb2YgdGhlIHJlZ2lvblxyXG4gICAqL1xyXG4gIGdldFZlcnRpY2FsUmVnaW9uSW5kZXgoKSB7XHJcbiAgICBjb25zdCB2aWV3WSA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WSggdGhpcy5ydWxlclBvc2l0aW9uUHJvcGVydHkudmFsdWUueSApO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3WVBvc2l0aW9ucy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgaWYgKCB2aWV3WSA8PSB0aGlzLnZpZXdZUG9zaXRpb25zWyBpIF0gKSB7XHJcbiAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRocm93IG5ldyBFcnJvciggJ3ZhbHVlIG91dCBvZiByYW5nZTogJyArIHZpZXdZICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqIEByZXR1cm5zIHsqfVxyXG4gICAqL1xyXG4gIGdldEN1cnJlbnRWZXJ0aWNhbFJlZ2lvbigpIHtcclxuICAgIHJldHVybiBSVUxFUl9WRVJUSUNBTF9SRUdJT05TWyB0aGlzLmdldFZlcnRpY2FsUmVnaW9uSW5kZXgoKSBdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGN1cnJlbnQgdmVydGljYWwgcG9zaXRpb24gd2hlbiBpbiBob21lIHBvc2l0aW9uLiBTaG91bGQgb25seSBiZSBjYWxsZWQgd2hlbiB0aGUgcnVsZXIgaXMgY3VycmVudGx5IGluIGhvbWVcclxuICAgKiBwb3NpdGlvbi5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGdldEhvbWVQb3NpdGlvblN0cmluZygpIHtcclxuICAgIGNvbnN0IGN1cnJlbnRSZWdpb24gPSB0aGlzLmdldEN1cnJlbnRWZXJ0aWNhbFJlZ2lvbigpO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggY3VycmVudFJlZ2lvbiA9PT0gaW5Ib21lUG9zaXRpb25TdHJpbmcsICdnZXRIb21lUG9zaXRpb25TdHJpbmcgY2FsbGVkIHdoZW4gcnVsZXIgbm90IGluIGhvbWUgcG9zaXRpb24nICk7XHJcbiAgICByZXR1cm4gY3VycmVudFJlZ2lvbjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBBbGVydCB0aGF0IHRoZSBydWxlciBoYXMganVtcGVkIHRvIHRoZSBob21lIHBvc2l0aW9uXHJcbiAgICovXHJcbiAgYWxlcnRKdW1wSG9tZSgpIHtcclxuICAgIHRoaXMuanVtcEhvbWVVdHRlcmFuY2UuYWxlcnQgPSB0aGlzLmdldEhvbWVQb3NpdGlvblN0cmluZygpO1xyXG4gICAgdGhpcy5hbGVydERlc2NyaXB0aW9uVXR0ZXJhbmNlKCB0aGlzLmp1bXBIb21lVXR0ZXJhbmNlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQHJldHVybnMge3N0cmluZ31cclxuICAgKi9cclxuICBnZXRKdW1wQ2VudGVyTWFzc0FsZXJ0KCkge1xyXG4gICAgcmV0dXJuIFN0cmluZ1V0aWxzLmZpbGxJbigganVtcENlbnRlck1hc3NBbGVydFN0cmluZywge1xyXG4gICAgICBjZW50ZXJzQXBhcnQ6IHRoaXMucG9zaXRpb25EZXNjcmliZXIuZ2V0Q2VudGVyc0FwYXJ0RGlzdGFuY2UoKSxcclxuICAgICAgb2JqZWN0MTogdGhpcy5pc2xjRGVzY3JpYmVyLmdldE9iamVjdExhYmVsRnJvbUVudW0oIElTTENPYmplY3RFbnVtLk9CSkVDVF9PTkUgKSxcclxuICAgICAgc3VwcGxlbWVudGFsSGludDogdGhpcy5qdW1wQ2VudGVyVXR0ZXJhbmNlLm51bWJlck9mVGltZXNBbGVydGVkIDwgMiA/IGp1bXBDZW50ZXJLZXlib2FyZEhpbnRTdHJpbmcgOiAnJ1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEFsZXJ0IHRoYXQgdGhlIHJ1bGVyIGhhcyBqdW1wZWQgdG8gdGhlIGNlbnRlciBvZiBhIG1hc3NcclxuICAgKi9cclxuICBhbGVydEp1bXBDZW50ZXJNYXNzKCkge1xyXG4gICAgdGhpcy5qdW1wQ2VudGVyVXR0ZXJhbmNlLmFsZXJ0ID0gdGhpcy5nZXRKdW1wQ2VudGVyTWFzc0FsZXJ0KCk7XHJcbiAgICB0aGlzLmFsZXJ0RGVzY3JpcHRpb25VdHRlcmFuY2UoIHRoaXMuanVtcENlbnRlclV0dGVyYW5jZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRXhwZWN0ZWQgdG8gYmUgY2FsbGVkIGFmdGVyIHRoZSBtb2RlbCBpcyByZXNldFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZXNldCgpIHtcclxuXHJcbiAgICAvLyByZXNldCBsb2NhbCBzdGF0ZVxyXG4gICAgdGhpcy5ncmFiYmVkQ291bnQgPSAwO1xyXG4gICAgdGhpcy5ob3Jpem9udGFsRGlzdGFuY2VUaGlzR3JhYiA9IDA7XHJcbiAgICB0aGlzLnByZXZpb3VzVmVydGljYWxSZWdpb25JbmRleCA9IHRoaXMuZ2V0VmVydGljYWxSZWdpb25JbmRleCgpO1xyXG4gICAgdGhpcy5wcmV2aW91c1J1bGVyUG9zaXRpb24gPSB0aGlzLnJ1bGVyUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZTtcclxuICAgIHRoaXMuanVzdE1vdmVtZW50QWxlcnRlZCA9IGZhbHNlO1xyXG5cclxuICAgIC8vIHJlc2V0IHV0dGVyYW5jZXNcclxuICAgIHRoaXMucmVsZWFzZUFuZEV4cGxvcmVVdHRlcmFuY2UucmVzZXQoKTtcclxuICAgIHRoaXMuanVtcENlbnRlclV0dGVyYW5jZS5yZXNldCgpO1xyXG4gICAgdGhpcy5qdW1wSG9tZVV0dGVyYW5jZS5yZXNldCgpO1xyXG4gICAgdGhpcy5tb3ZlbWVudFV0dGVyYW5jZS5yZXNldCgpO1xyXG4gIH1cclxufVxyXG5cclxuZ3Jhdml0eUZvcmNlTGFiLnJlZ2lzdGVyKCAnR3Jhdml0eUZvcmNlTGFiUnVsZXJBbGVydGVyJywgR3Jhdml0eUZvcmNlTGFiUnVsZXJBbGVydGVyICk7XHJcbmV4cG9ydCBkZWZhdWx0IEdyYXZpdHlGb3JjZUxhYlJ1bGVyQWxlcnRlcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLG1CQUFtQixNQUFNLGlFQUFpRTtBQUNqRyxPQUFP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