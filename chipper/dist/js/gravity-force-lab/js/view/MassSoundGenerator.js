// Copyright 2019-2021, University of Colorado Boulder

/**
 * sound generator for mass changes
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import merge from '../../../phet-core/js/merge.js';
import SoundClip from '../../../tambo/js/sound-generators/SoundClip.js';
import rubberBand_v3_mp3 from '../../sounds/rubberBand_v3_mp3.js';
import gravityForceLab from '../gravityForceLab.js';

// constants
const PITCH_RANGE_IN_SEMI_TONES = 30;
class MassSoundGenerator extends SoundClip {
  /**
   * @param {NumberProperty} massProperty
   * @param {Range} massRange
   * @param {BooleanProperty} resetInProgressProperty
   * @param {Object} [options]
   * @constructor
   */
  constructor(massProperty, massRange, resetInProgressProperty, options) {
    options = merge({
      // {BooleanProperty} - When true, sounds are only played when a threshold is reached or crossed instead of on
      // every change of the massProperty value.  If used, the threshold values must also be provided.
      playBasedOnThresholdsProperty: null,
      // {number[]} - threshold value where sound should be played if playBasedOnThresholdsProperty's value is true
      thresholdValues: [],
      // pass through options
      rateChangesAffectPlayingSounds: false
    }, options);

    // parameter checking
    assert && assert(options.rateChangesAffectPlayingSounds === false, 'rate changes should not affect playing mass sounds');
    if (options.playBasedOnThresholdsProperty) {
      assert && assert(options.thresholdValues.length > 0, 'must supply thresholds if providing property');
    }

    // if no property is provided, create one that is always false so that sounds are played on every change
    const playBasedOnThresholdsProperty = options.playBasedOnThresholdsProperty || new BooleanProperty(false);
    super(rubberBand_v3_mp3, options);

    // function for playing the mass sound
    const massListener = (mass, previousMass) => {
      // range checking
      assert && assert(massRange.contains(mass), 'mass value out of range');
      if (!resetInProgressProperty.value) {
        let playForThisChange;
        if (playBasedOnThresholdsProperty.value) {
          // only play if a threshold has been reached or crossed
          playForThisChange = _.some(options.thresholdValues, thresholdValue => {
            return mass === thresholdValue || mass > thresholdValue && previousMass < thresholdValue || mass < thresholdValue && previousMass > thresholdValue;
          });
        } else {
          // play the sound on every change in this case
          playForThisChange = true;
        }
        if (playForThisChange) {
          // determine a playback rate based on the mass, see the design document for an explanation
          const normalizedMass = (mass - massRange.min) / (massRange.max - massRange.min);
          const centerAndFlippedNormMass = 1 - normalizedMass - 0.5;
          const midiNote = PITCH_RANGE_IN_SEMI_TONES / 2 * centerAndFlippedNormMass;
          const playbackRate = Math.pow(2, midiNote / 12);
          this.setPlaybackRate(playbackRate);
          this.play();
        }
      }
    };
    massProperty.lazyLink(massListener);

    // @private {function}
    this.disposeMassSoundGenerator = () => {
      massProperty.unlink(massListener);
    };
  }

  /**
   * @public
   */
  dispose() {
    this.disposeMassSoundGenerator();
    super.dispose();
  }
}
gravityForceLab.register('MassSoundGenerator', MassSoundGenerator);
export default MassSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJtZXJnZSIsIlNvdW5kQ2xpcCIsInJ1YmJlckJhbmRfdjNfbXAzIiwiZ3Jhdml0eUZvcmNlTGFiIiwiUElUQ0hfUkFOR0VfSU5fU0VNSV9UT05FUyIsIk1hc3NTb3VuZEdlbmVyYXRvciIsImNvbnN0cnVjdG9yIiwibWFzc1Byb3BlcnR5IiwibWFzc1JhbmdlIiwicmVzZXRJblByb2dyZXNzUHJvcGVydHkiLCJvcHRpb25zIiwicGxheUJhc2VkT25UaHJlc2hvbGRzUHJvcGVydHkiLCJ0aHJlc2hvbGRWYWx1ZXMiLCJyYXRlQ2hhbmdlc0FmZmVjdFBsYXlpbmdTb3VuZHMiLCJhc3NlcnQiLCJsZW5ndGgiLCJtYXNzTGlzdGVuZXIiLCJtYXNzIiwicHJldmlvdXNNYXNzIiwiY29udGFpbnMiLCJ2YWx1ZSIsInBsYXlGb3JUaGlzQ2hhbmdlIiwiXyIsInNvbWUiLCJ0aHJlc2hvbGRWYWx1ZSIsIm5vcm1hbGl6ZWRNYXNzIiwibWluIiwibWF4IiwiY2VudGVyQW5kRmxpcHBlZE5vcm1NYXNzIiwibWlkaU5vdGUiLCJwbGF5YmFja1JhdGUiLCJNYXRoIiwicG93Iiwic2V0UGxheWJhY2tSYXRlIiwicGxheSIsImxhenlMaW5rIiwiZGlzcG9zZU1hc3NTb3VuZEdlbmVyYXRvciIsInVubGluayIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk1hc3NTb3VuZEdlbmVyYXRvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIxLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBzb3VuZCBnZW5lcmF0b3IgZm9yIG1hc3MgY2hhbmdlc1xyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFNvdW5kQ2xpcCBmcm9tICcuLi8uLi8uLi90YW1iby9qcy9zb3VuZC1nZW5lcmF0b3JzL1NvdW5kQ2xpcC5qcyc7XHJcbmltcG9ydCBydWJiZXJCYW5kX3YzX21wMyBmcm9tICcuLi8uLi9zb3VuZHMvcnViYmVyQmFuZF92M19tcDMuanMnO1xyXG5pbXBvcnQgZ3Jhdml0eUZvcmNlTGFiIGZyb20gJy4uL2dyYXZpdHlGb3JjZUxhYi5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgUElUQ0hfUkFOR0VfSU5fU0VNSV9UT05FUyA9IDMwO1xyXG5cclxuY2xhc3MgTWFzc1NvdW5kR2VuZXJhdG9yIGV4dGVuZHMgU291bmRDbGlwIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtOdW1iZXJQcm9wZXJ0eX0gbWFzc1Byb3BlcnR5XHJcbiAgICogQHBhcmFtIHtSYW5nZX0gbWFzc1JhbmdlXHJcbiAgICogQHBhcmFtIHtCb29sZWFuUHJvcGVydHl9IHJlc2V0SW5Qcm9ncmVzc1Byb3BlcnR5XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqIEBjb25zdHJ1Y3RvclxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBtYXNzUHJvcGVydHksIG1hc3NSYW5nZSwgcmVzZXRJblByb2dyZXNzUHJvcGVydHksIG9wdGlvbnMgKSB7XHJcblxyXG4gICAgb3B0aW9ucyA9IG1lcmdlKCB7XHJcblxyXG4gICAgICAvLyB7Qm9vbGVhblByb3BlcnR5fSAtIFdoZW4gdHJ1ZSwgc291bmRzIGFyZSBvbmx5IHBsYXllZCB3aGVuIGEgdGhyZXNob2xkIGlzIHJlYWNoZWQgb3IgY3Jvc3NlZCBpbnN0ZWFkIG9mIG9uXHJcbiAgICAgIC8vIGV2ZXJ5IGNoYW5nZSBvZiB0aGUgbWFzc1Byb3BlcnR5IHZhbHVlLiAgSWYgdXNlZCwgdGhlIHRocmVzaG9sZCB2YWx1ZXMgbXVzdCBhbHNvIGJlIHByb3ZpZGVkLlxyXG4gICAgICBwbGF5QmFzZWRPblRocmVzaG9sZHNQcm9wZXJ0eTogbnVsbCxcclxuXHJcbiAgICAgIC8vIHtudW1iZXJbXX0gLSB0aHJlc2hvbGQgdmFsdWUgd2hlcmUgc291bmQgc2hvdWxkIGJlIHBsYXllZCBpZiBwbGF5QmFzZWRPblRocmVzaG9sZHNQcm9wZXJ0eSdzIHZhbHVlIGlzIHRydWVcclxuICAgICAgdGhyZXNob2xkVmFsdWVzOiBbXSxcclxuXHJcbiAgICAgIC8vIHBhc3MgdGhyb3VnaCBvcHRpb25zXHJcbiAgICAgIHJhdGVDaGFuZ2VzQWZmZWN0UGxheWluZ1NvdW5kczogZmFsc2VcclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBwYXJhbWV0ZXIgY2hlY2tpbmdcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoXHJcbiAgICAgIG9wdGlvbnMucmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzID09PSBmYWxzZSxcclxuICAgICAgJ3JhdGUgY2hhbmdlcyBzaG91bGQgbm90IGFmZmVjdCBwbGF5aW5nIG1hc3Mgc291bmRzJ1xyXG4gICAgKTtcclxuICAgIGlmICggb3B0aW9ucy5wbGF5QmFzZWRPblRocmVzaG9sZHNQcm9wZXJ0eSApIHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy50aHJlc2hvbGRWYWx1ZXMubGVuZ3RoID4gMCwgJ211c3Qgc3VwcGx5IHRocmVzaG9sZHMgaWYgcHJvdmlkaW5nIHByb3BlcnR5JyApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGlmIG5vIHByb3BlcnR5IGlzIHByb3ZpZGVkLCBjcmVhdGUgb25lIHRoYXQgaXMgYWx3YXlzIGZhbHNlIHNvIHRoYXQgc291bmRzIGFyZSBwbGF5ZWQgb24gZXZlcnkgY2hhbmdlXHJcbiAgICBjb25zdCBwbGF5QmFzZWRPblRocmVzaG9sZHNQcm9wZXJ0eSA9IG9wdGlvbnMucGxheUJhc2VkT25UaHJlc2hvbGRzUHJvcGVydHkgfHwgbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuXHJcbiAgICBzdXBlciggcnViYmVyQmFuZF92M19tcDMsIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBmdW5jdGlvbiBmb3IgcGxheWluZyB0aGUgbWFzcyBzb3VuZFxyXG4gICAgY29uc3QgbWFzc0xpc3RlbmVyID0gKCBtYXNzLCBwcmV2aW91c01hc3MgKSA9PiB7XHJcblxyXG4gICAgICAvLyByYW5nZSBjaGVja2luZ1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBtYXNzUmFuZ2UuY29udGFpbnMoIG1hc3MgKSwgJ21hc3MgdmFsdWUgb3V0IG9mIHJhbmdlJyApO1xyXG5cclxuICAgICAgaWYgKCAhcmVzZXRJblByb2dyZXNzUHJvcGVydHkudmFsdWUgKSB7XHJcblxyXG4gICAgICAgIGxldCBwbGF5Rm9yVGhpc0NoYW5nZTtcclxuICAgICAgICBpZiAoIHBsYXlCYXNlZE9uVGhyZXNob2xkc1Byb3BlcnR5LnZhbHVlICkge1xyXG5cclxuICAgICAgICAgIC8vIG9ubHkgcGxheSBpZiBhIHRocmVzaG9sZCBoYXMgYmVlbiByZWFjaGVkIG9yIGNyb3NzZWRcclxuICAgICAgICAgIHBsYXlGb3JUaGlzQ2hhbmdlID0gXy5zb21lKCBvcHRpb25zLnRocmVzaG9sZFZhbHVlcywgdGhyZXNob2xkVmFsdWUgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbWFzcyA9PT0gdGhyZXNob2xkVmFsdWUgfHxcclxuICAgICAgICAgICAgICAgICAgICggbWFzcyA+IHRocmVzaG9sZFZhbHVlICYmIHByZXZpb3VzTWFzcyA8IHRocmVzaG9sZFZhbHVlICkgfHxcclxuICAgICAgICAgICAgICAgICAgICggbWFzcyA8IHRocmVzaG9sZFZhbHVlICYmIHByZXZpb3VzTWFzcyA+IHRocmVzaG9sZFZhbHVlICk7XHJcbiAgICAgICAgICB9ICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIHBsYXkgdGhlIHNvdW5kIG9uIGV2ZXJ5IGNoYW5nZSBpbiB0aGlzIGNhc2VcclxuICAgICAgICAgIHBsYXlGb3JUaGlzQ2hhbmdlID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICggcGxheUZvclRoaXNDaGFuZ2UgKSB7XHJcblxyXG4gICAgICAgICAgLy8gZGV0ZXJtaW5lIGEgcGxheWJhY2sgcmF0ZSBiYXNlZCBvbiB0aGUgbWFzcywgc2VlIHRoZSBkZXNpZ24gZG9jdW1lbnQgZm9yIGFuIGV4cGxhbmF0aW9uXHJcbiAgICAgICAgICBjb25zdCBub3JtYWxpemVkTWFzcyA9ICggbWFzcyAtIG1hc3NSYW5nZS5taW4gKSAvICggbWFzc1JhbmdlLm1heCAtIG1hc3NSYW5nZS5taW4gKTtcclxuICAgICAgICAgIGNvbnN0IGNlbnRlckFuZEZsaXBwZWROb3JtTWFzcyA9ICggKCAxIC0gbm9ybWFsaXplZE1hc3MgKSAtIDAuNSApO1xyXG4gICAgICAgICAgY29uc3QgbWlkaU5vdGUgPSBQSVRDSF9SQU5HRV9JTl9TRU1JX1RPTkVTIC8gMiAqIGNlbnRlckFuZEZsaXBwZWROb3JtTWFzcztcclxuICAgICAgICAgIGNvbnN0IHBsYXliYWNrUmF0ZSA9IE1hdGgucG93KCAyLCBtaWRpTm90ZSAvIDEyICk7XHJcbiAgICAgICAgICB0aGlzLnNldFBsYXliYWNrUmF0ZSggcGxheWJhY2tSYXRlICk7XHJcbiAgICAgICAgICB0aGlzLnBsYXkoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBtYXNzUHJvcGVydHkubGF6eUxpbmsoIG1hc3NMaXN0ZW5lciApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtmdW5jdGlvbn1cclxuICAgIHRoaXMuZGlzcG9zZU1hc3NTb3VuZEdlbmVyYXRvciA9ICgpID0+IHsgbWFzc1Byb3BlcnR5LnVubGluayggbWFzc0xpc3RlbmVyICk7IH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIHRoaXMuZGlzcG9zZU1hc3NTb3VuZEdlbmVyYXRvcigpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuZ3Jhdml0eUZvcmNlTGFiLnJlZ2lzdGVyKCAnTWFzc1NvdW5kR2VuZXJhdG9yJywgTWFzc1NvdW5kR2VuZXJhdG9yICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBNYXNzU291bmRHZW5lcmF0b3I7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSxxQ0FBcUM7QUFDakUsT0FBT0MsS0FBSyxNQUFNLGdDQUFnQztBQUNsRCxPQUFPQyxTQUFTLE1BQU0saURBQWlEO0FBQ3ZFLE9BQU9DLGlCQUFpQixNQUFNLG1DQUFtQztBQUNqRSxPQUFPQyxlQUFlLE1BQU0sdUJBQXVCOztBQUVuRDtBQUNBLE1BQU1DLHlCQUF5QixHQUFHLEVBQUU7QUFFcEMsTUFBTUMsa0JBQWtCLFNBQVNKLFNBQVMsQ0FBQztFQUV6QztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFSyxXQUFXQSxDQUFFQyxZQUFZLEVBQUVDLFNBQVMsRUFBRUMsdUJBQXVCLEVBQUVDLE9BQU8sRUFBRztJQUV2RUEsT0FBTyxHQUFHVixLQUFLLENBQUU7TUFFZjtNQUNBO01BQ0FXLDZCQUE2QixFQUFFLElBQUk7TUFFbkM7TUFDQUMsZUFBZSxFQUFFLEVBQUU7TUFFbkI7TUFDQUMsOEJBQThCLEVBQUU7SUFDbEMsQ0FBQyxFQUFFSCxPQUFRLENBQUM7O0lBRVo7SUFDQUksTUFBTSxJQUFJQSxNQUFNLENBQ2RKLE9BQU8sQ0FBQ0csOEJBQThCLEtBQUssS0FBSyxFQUNoRCxvREFDRixDQUFDO0lBQ0QsSUFBS0gsT0FBTyxDQUFDQyw2QkFBNkIsRUFBRztNQUMzQ0csTUFBTSxJQUFJQSxNQUFNLENBQUVKLE9BQU8sQ0FBQ0UsZUFBZSxDQUFDRyxNQUFNLEdBQUcsQ0FBQyxFQUFFLDhDQUErQyxDQUFDO0lBQ3hHOztJQUVBO0lBQ0EsTUFBTUosNkJBQTZCLEdBQUdELE9BQU8sQ0FBQ0MsNkJBQTZCLElBQUksSUFBSVosZUFBZSxDQUFFLEtBQU0sQ0FBQztJQUUzRyxLQUFLLENBQUVHLGlCQUFpQixFQUFFUSxPQUFRLENBQUM7O0lBRW5DO0lBQ0EsTUFBTU0sWUFBWSxHQUFHQSxDQUFFQyxJQUFJLEVBQUVDLFlBQVksS0FBTTtNQUU3QztNQUNBSixNQUFNLElBQUlBLE1BQU0sQ0FBRU4sU0FBUyxDQUFDVyxRQUFRLENBQUVGLElBQUssQ0FBQyxFQUFFLHlCQUEwQixDQUFDO01BRXpFLElBQUssQ0FBQ1IsdUJBQXVCLENBQUNXLEtBQUssRUFBRztRQUVwQyxJQUFJQyxpQkFBaUI7UUFDckIsSUFBS1YsNkJBQTZCLENBQUNTLEtBQUssRUFBRztVQUV6QztVQUNBQyxpQkFBaUIsR0FBR0MsQ0FBQyxDQUFDQyxJQUFJLENBQUViLE9BQU8sQ0FBQ0UsZUFBZSxFQUFFWSxjQUFjLElBQUk7WUFDckUsT0FBT1AsSUFBSSxLQUFLTyxjQUFjLElBQ3JCUCxJQUFJLEdBQUdPLGNBQWMsSUFBSU4sWUFBWSxHQUFHTSxjQUFnQixJQUN4RFAsSUFBSSxHQUFHTyxjQUFjLElBQUlOLFlBQVksR0FBR00sY0FBZ0I7VUFDbkUsQ0FBRSxDQUFDO1FBQ0wsQ0FBQyxNQUNJO1VBRUg7VUFDQUgsaUJBQWlCLEdBQUcsSUFBSTtRQUMxQjtRQUVBLElBQUtBLGlCQUFpQixFQUFHO1VBRXZCO1VBQ0EsTUFBTUksY0FBYyxHQUFHLENBQUVSLElBQUksR0FBR1QsU0FBUyxDQUFDa0IsR0FBRyxLQUFPbEIsU0FBUyxDQUFDbUIsR0FBRyxHQUFHbkIsU0FBUyxDQUFDa0IsR0FBRyxDQUFFO1VBQ25GLE1BQU1FLHdCQUF3QixHQUFPLENBQUMsR0FBR0gsY0FBYyxHQUFLLEdBQUs7VUFDakUsTUFBTUksUUFBUSxHQUFHekIseUJBQXlCLEdBQUcsQ0FBQyxHQUFHd0Isd0JBQXdCO1VBQ3pFLE1BQU1FLFlBQVksR0FBR0MsSUFBSSxDQUFDQyxHQUFHLENBQUUsQ0FBQyxFQUFFSCxRQUFRLEdBQUcsRUFBRyxDQUFDO1VBQ2pELElBQUksQ0FBQ0ksZUFBZSxDQUFFSCxZQUFhLENBQUM7VUFDcEMsSUFBSSxDQUFDSSxJQUFJLENBQUMsQ0FBQztRQUNiO01BQ0Y7SUFDRixDQUFDO0lBQ0QzQixZQUFZLENBQUM0QixRQUFRLENBQUVuQixZQUFhLENBQUM7O0lBRXJDO0lBQ0EsSUFBSSxDQUFDb0IseUJBQXlCLEdBQUcsTUFBTTtNQUFFN0IsWUFBWSxDQUFDOEIsTUFBTSxDQUFFckIsWUFBYSxDQUFDO0lBQUUsQ0FBQztFQUNqRjs7RUFFQTtBQUNGO0FBQ0E7RUFDRXNCLE9BQU9BLENBQUEsRUFBRztJQUNSLElBQUksQ0FBQ0YseUJBQXlCLENBQUMsQ0FBQztJQUNoQyxLQUFLLENBQUNFLE9BQU8sQ0FBQyxDQUFDO0VBQ2pCO0FBQ0Y7QUFFQW5DLGVBQWUsQ0FBQ29DLFFBQVEsQ0FBRSxvQkFBb0IsRUFBRWxDLGtCQUFtQixDQUFDO0FBRXBFLGVBQWVBLGtCQUFrQiJ9