// Copyright 2021-2022, University of Colorado Boulder

/**
 * BalloonRubbingSoundGenerator is used to produces a sound effect for when a balloon is rubbing on the something.  It
 * is meant to be somewhat realistic as opposed to "cartoonish", so it uses a filtered noise generator.
 *
 * @author John Blanco
 */

import Multilink from '../../../../axon/js/Multilink.js';
import LinearFunction from '../../../../dot/js/LinearFunction.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Vector2Property from '../../../../dot/js/Vector2Property.js';
import merge from '../../../../phet-core/js/merge.js';
import NoiseGenerator from '../../../../tambo/js/sound-generators/NoiseGenerator.js';
import balloonsAndStaticElectricity from '../../balloonsAndStaticElectricity.js';

// constants
const DEFAULT_CENTER_FREQUENCY = 800; // Hz
const FREQUENCY_CHANGE_WITH_DIRECTION = 100; // Hz
const SMOOTHED_VELOCITY_TAPER_RATE = 1; // model units per second, empirically determined
const MAX_TAPER_TIME = 0.2; // in seconds
const MAX_SMOOTHED_SPEED = SMOOTHED_VELOCITY_TAPER_RATE * MAX_TAPER_TIME;
const MAP_SMOOTHED_SPEED_TO_OUTPUT_LEVEL = new LinearFunction(0, MAX_SMOOTHED_SPEED, 0, 1, true);
class BalloonRubbingSoundGenerator extends NoiseGenerator {
  /**
   * {Property.<number>} dragVelocityProperty - velocity of the balloon drag
   * {Property.<boolean>} onSweaterProperty - whether the balloon is on the sweater
   * {Property.<boolean>} touchingWallProperty - whether the balloon is touching the wall
   * {Object} [options]
   */
  constructor(dragVelocityProperty, onSweaterProperty, touchingWallProperty, options) {
    options = merge({
      noiseType: 'brown',
      centerFrequency: DEFAULT_CENTER_FREQUENCY,
      qFactor: 2,
      // {number} - The amount of sound produced by this sound generator varies based on what's going on with the input
      //            properties, and this value sets the maximum.
      maxOutputLevel: 0.3
    }, options);
    super(options);

    // @private - A Property that moves up instantly with the drag velocity but tapers off more slowly, used to prevent
    // the sound generator from doing a bunch of stops and starts during drag operations.  This is also clamped so that
    // it doesn't get so large that it takes a long time to taper off.
    this.clampedSmoothedDragVelocityProperty = new Vector2Property(Vector2.ZERO);

    // a vector that is reused when evaluating drag velocity changes, used to reduce memory allocations.
    const clampedDragVelocity = new Vector2(0, 0);

    // Watch for sudden increases in the drag velocity and bump up the smoothed velocity when they occur.  Limit the
    // max so that the sound generator doesn't end up running to too long.
    dragVelocityProperty.link(dragVelocity => {
      clampedDragVelocity.set(dragVelocity);
      if (clampedDragVelocity.magnitude > MAX_SMOOTHED_SPEED) {
        clampedDragVelocity.setMagnitude(MAX_SMOOTHED_SPEED);
      }
      if (clampedDragVelocity.magnitude > this.clampedSmoothedDragVelocityProperty.value.magnitude) {
        this.clampedSmoothedDragVelocityProperty.set(clampedDragVelocity);
      }
    });

    // Use the smoothed velocity with the on-sweater and on-wall information to set the volume and pitch of the output.
    Multilink.multilink([dragVelocityProperty, this.clampedSmoothedDragVelocityProperty, onSweaterProperty, touchingWallProperty], (dragVelocity, smoothedDragVelocity, onSweater, touchingWall) => {
      // Test whether the balloon is being dragged over the sweater or against the wall.
      if (smoothedDragVelocity.magnitude > 0 && onSweater || Math.abs(smoothedDragVelocity.y) > 0 && Math.abs(smoothedDragVelocity.x) === 0 && touchingWall) {
        // Start the production of the sound if it's not already playing.
        if (!this.isPlaying) {
          this.start();
        }

        // Set the output level based on the drag speed.
        this.setOutputLevel(MAP_SMOOTHED_SPEED_TO_OUTPUT_LEVEL.evaluate(smoothedDragVelocity.magnitude) * options.maxOutputLevel);

        // Set the pitch based on the direction in which the balloon is being dragged.
        let sign = 1;
        if (Math.abs(dragVelocity.x) > Math.abs(dragVelocity.y)) {
          if (dragVelocity.x < 0) {
            sign = -1;
          }
        } else if (dragVelocity.y < 0) {
          sign = -1;
        }
        this.setBandpassFilterCenterFrequency(options.centerFrequency + sign * FREQUENCY_CHANGE_WITH_DIRECTION);
      } else if ((smoothedDragVelocity.magnitude === 0 || !(onSweater || touchingWall)) && this.isPlaying) {
        // The smoothed velocity has dropped to zero, turn off sound production.
        this.stop();
      }
    });
  }

  /**
   * @param {number} dt - time change in seconds
   * @public
   */
  step(dt) {
    if (this.clampedSmoothedDragVelocityProperty.value.magnitude > 0) {
      const taperedMagnitude = Math.max(this.clampedSmoothedDragVelocityProperty.value.magnitude - dt * SMOOTHED_VELOCITY_TAPER_RATE, 0);
      this.clampedSmoothedDragVelocityProperty.set(this.clampedSmoothedDragVelocityProperty.value.withMagnitude(taperedMagnitude));
    }
  }
}

// statics
BalloonRubbingSoundGenerator.DEFAULT_CENTER_FREQUENCY = DEFAULT_CENTER_FREQUENCY;
balloonsAndStaticElectricity.register('BalloonRubbingSoundGenerator', BalloonRubbingSoundGenerator);
export default BalloonRubbingSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJMaW5lYXJGdW5jdGlvbiIsIlZlY3RvcjIiLCJWZWN0b3IyUHJvcGVydHkiLCJtZXJnZSIsIk5vaXNlR2VuZXJhdG9yIiwiYmFsbG9vbnNBbmRTdGF0aWNFbGVjdHJpY2l0eSIsIkRFRkFVTFRfQ0VOVEVSX0ZSRVFVRU5DWSIsIkZSRVFVRU5DWV9DSEFOR0VfV0lUSF9ESVJFQ1RJT04iLCJTTU9PVEhFRF9WRUxPQ0lUWV9UQVBFUl9SQVRFIiwiTUFYX1RBUEVSX1RJTUUiLCJNQVhfU01PT1RIRURfU1BFRUQiLCJNQVBfU01PT1RIRURfU1BFRURfVE9fT1VUUFVUX0xFVkVMIiwiQmFsbG9vblJ1YmJpbmdTb3VuZEdlbmVyYXRvciIsImNvbnN0cnVjdG9yIiwiZHJhZ1ZlbG9jaXR5UHJvcGVydHkiLCJvblN3ZWF0ZXJQcm9wZXJ0eSIsInRvdWNoaW5nV2FsbFByb3BlcnR5Iiwib3B0aW9ucyIsIm5vaXNlVHlwZSIsImNlbnRlckZyZXF1ZW5jeSIsInFGYWN0b3IiLCJtYXhPdXRwdXRMZXZlbCIsImNsYW1wZWRTbW9vdGhlZERyYWdWZWxvY2l0eVByb3BlcnR5IiwiWkVSTyIsImNsYW1wZWREcmFnVmVsb2NpdHkiLCJsaW5rIiwiZHJhZ1ZlbG9jaXR5Iiwic2V0IiwibWFnbml0dWRlIiwic2V0TWFnbml0dWRlIiwidmFsdWUiLCJtdWx0aWxpbmsiLCJzbW9vdGhlZERyYWdWZWxvY2l0eSIsIm9uU3dlYXRlciIsInRvdWNoaW5nV2FsbCIsIk1hdGgiLCJhYnMiLCJ5IiwieCIsImlzUGxheWluZyIsInN0YXJ0Iiwic2V0T3V0cHV0TGV2ZWwiLCJldmFsdWF0ZSIsInNpZ24iLCJzZXRCYW5kcGFzc0ZpbHRlckNlbnRlckZyZXF1ZW5jeSIsInN0b3AiLCJzdGVwIiwiZHQiLCJ0YXBlcmVkTWFnbml0dWRlIiwibWF4Iiwid2l0aE1hZ25pdHVkZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQmFsbG9vblJ1YmJpbmdTb3VuZEdlbmVyYXRvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBCYWxsb29uUnViYmluZ1NvdW5kR2VuZXJhdG9yIGlzIHVzZWQgdG8gcHJvZHVjZXMgYSBzb3VuZCBlZmZlY3QgZm9yIHdoZW4gYSBiYWxsb29uIGlzIHJ1YmJpbmcgb24gdGhlIHNvbWV0aGluZy4gIEl0XHJcbiAqIGlzIG1lYW50IHRvIGJlIHNvbWV3aGF0IHJlYWxpc3RpYyBhcyBvcHBvc2VkIHRvIFwiY2FydG9vbmlzaFwiLCBzbyBpdCB1c2VzIGEgZmlsdGVyZWQgbm9pc2UgZ2VuZXJhdG9yLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBMaW5lYXJGdW5jdGlvbiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvTGluZWFyRnVuY3Rpb24uanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBWZWN0b3IyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgTm9pc2VHZW5lcmF0b3IgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvc291bmQtZ2VuZXJhdG9ycy9Ob2lzZUdlbmVyYXRvci5qcyc7XHJcbmltcG9ydCBiYWxsb29uc0FuZFN0YXRpY0VsZWN0cmljaXR5IGZyb20gJy4uLy4uL2JhbGxvb25zQW5kU3RhdGljRWxlY3RyaWNpdHkuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IERFRkFVTFRfQ0VOVEVSX0ZSRVFVRU5DWSA9IDgwMDsgLy8gSHpcclxuY29uc3QgRlJFUVVFTkNZX0NIQU5HRV9XSVRIX0RJUkVDVElPTiA9IDEwMDsgLy8gSHpcclxuY29uc3QgU01PT1RIRURfVkVMT0NJVFlfVEFQRVJfUkFURSA9IDE7IC8vIG1vZGVsIHVuaXRzIHBlciBzZWNvbmQsIGVtcGlyaWNhbGx5IGRldGVybWluZWRcclxuY29uc3QgTUFYX1RBUEVSX1RJTUUgPSAwLjI7IC8vIGluIHNlY29uZHNcclxuY29uc3QgTUFYX1NNT09USEVEX1NQRUVEID0gU01PT1RIRURfVkVMT0NJVFlfVEFQRVJfUkFURSAqIE1BWF9UQVBFUl9USU1FO1xyXG5jb25zdCBNQVBfU01PT1RIRURfU1BFRURfVE9fT1VUUFVUX0xFVkVMID0gbmV3IExpbmVhckZ1bmN0aW9uKCAwLCBNQVhfU01PT1RIRURfU1BFRUQsIDAsIDEsIHRydWUgKTtcclxuXHJcbmNsYXNzIEJhbGxvb25SdWJiaW5nU291bmRHZW5lcmF0b3IgZXh0ZW5kcyBOb2lzZUdlbmVyYXRvciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIHtQcm9wZXJ0eS48bnVtYmVyPn0gZHJhZ1ZlbG9jaXR5UHJvcGVydHkgLSB2ZWxvY2l0eSBvZiB0aGUgYmFsbG9vbiBkcmFnXHJcbiAgICoge1Byb3BlcnR5Ljxib29sZWFuPn0gb25Td2VhdGVyUHJvcGVydHkgLSB3aGV0aGVyIHRoZSBiYWxsb29uIGlzIG9uIHRoZSBzd2VhdGVyXHJcbiAgICoge1Byb3BlcnR5Ljxib29sZWFuPn0gdG91Y2hpbmdXYWxsUHJvcGVydHkgLSB3aGV0aGVyIHRoZSBiYWxsb29uIGlzIHRvdWNoaW5nIHRoZSB3YWxsXHJcbiAgICoge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGRyYWdWZWxvY2l0eVByb3BlcnR5LCBvblN3ZWF0ZXJQcm9wZXJ0eSwgdG91Y2hpbmdXYWxsUHJvcGVydHksIG9wdGlvbnMgKSB7XHJcblxyXG4gICAgb3B0aW9ucyA9IG1lcmdlKCB7XHJcbiAgICAgIG5vaXNlVHlwZTogJ2Jyb3duJyxcclxuICAgICAgY2VudGVyRnJlcXVlbmN5OiBERUZBVUxUX0NFTlRFUl9GUkVRVUVOQ1ksXHJcbiAgICAgIHFGYWN0b3I6IDIsXHJcblxyXG4gICAgICAvLyB7bnVtYmVyfSAtIFRoZSBhbW91bnQgb2Ygc291bmQgcHJvZHVjZWQgYnkgdGhpcyBzb3VuZCBnZW5lcmF0b3IgdmFyaWVzIGJhc2VkIG9uIHdoYXQncyBnb2luZyBvbiB3aXRoIHRoZSBpbnB1dFxyXG4gICAgICAvLyAgICAgICAgICAgIHByb3BlcnRpZXMsIGFuZCB0aGlzIHZhbHVlIHNldHMgdGhlIG1heGltdW0uXHJcbiAgICAgIG1heE91dHB1dExldmVsOiAwLjNcclxuXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIEEgUHJvcGVydHkgdGhhdCBtb3ZlcyB1cCBpbnN0YW50bHkgd2l0aCB0aGUgZHJhZyB2ZWxvY2l0eSBidXQgdGFwZXJzIG9mZiBtb3JlIHNsb3dseSwgdXNlZCB0byBwcmV2ZW50XHJcbiAgICAvLyB0aGUgc291bmQgZ2VuZXJhdG9yIGZyb20gZG9pbmcgYSBidW5jaCBvZiBzdG9wcyBhbmQgc3RhcnRzIGR1cmluZyBkcmFnIG9wZXJhdGlvbnMuICBUaGlzIGlzIGFsc28gY2xhbXBlZCBzbyB0aGF0XHJcbiAgICAvLyBpdCBkb2Vzbid0IGdldCBzbyBsYXJnZSB0aGF0IGl0IHRha2VzIGEgbG9uZyB0aW1lIHRvIHRhcGVyIG9mZi5cclxuICAgIHRoaXMuY2xhbXBlZFNtb290aGVkRHJhZ1ZlbG9jaXR5UHJvcGVydHkgPSBuZXcgVmVjdG9yMlByb3BlcnR5KCBWZWN0b3IyLlpFUk8gKTtcclxuXHJcbiAgICAvLyBhIHZlY3RvciB0aGF0IGlzIHJldXNlZCB3aGVuIGV2YWx1YXRpbmcgZHJhZyB2ZWxvY2l0eSBjaGFuZ2VzLCB1c2VkIHRvIHJlZHVjZSBtZW1vcnkgYWxsb2NhdGlvbnMuXHJcbiAgICBjb25zdCBjbGFtcGVkRHJhZ1ZlbG9jaXR5ID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuXHJcbiAgICAvLyBXYXRjaCBmb3Igc3VkZGVuIGluY3JlYXNlcyBpbiB0aGUgZHJhZyB2ZWxvY2l0eSBhbmQgYnVtcCB1cCB0aGUgc21vb3RoZWQgdmVsb2NpdHkgd2hlbiB0aGV5IG9jY3VyLiAgTGltaXQgdGhlXHJcbiAgICAvLyBtYXggc28gdGhhdCB0aGUgc291bmQgZ2VuZXJhdG9yIGRvZXNuJ3QgZW5kIHVwIHJ1bm5pbmcgdG8gdG9vIGxvbmcuXHJcbiAgICBkcmFnVmVsb2NpdHlQcm9wZXJ0eS5saW5rKCBkcmFnVmVsb2NpdHkgPT4ge1xyXG4gICAgICBjbGFtcGVkRHJhZ1ZlbG9jaXR5LnNldCggZHJhZ1ZlbG9jaXR5ICk7XHJcbiAgICAgIGlmICggY2xhbXBlZERyYWdWZWxvY2l0eS5tYWduaXR1ZGUgPiBNQVhfU01PT1RIRURfU1BFRUQgKSB7XHJcbiAgICAgICAgY2xhbXBlZERyYWdWZWxvY2l0eS5zZXRNYWduaXR1ZGUoIE1BWF9TTU9PVEhFRF9TUEVFRCApO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICggY2xhbXBlZERyYWdWZWxvY2l0eS5tYWduaXR1ZGUgPiB0aGlzLmNsYW1wZWRTbW9vdGhlZERyYWdWZWxvY2l0eVByb3BlcnR5LnZhbHVlLm1hZ25pdHVkZSApIHtcclxuICAgICAgICB0aGlzLmNsYW1wZWRTbW9vdGhlZERyYWdWZWxvY2l0eVByb3BlcnR5LnNldCggY2xhbXBlZERyYWdWZWxvY2l0eSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXNlIHRoZSBzbW9vdGhlZCB2ZWxvY2l0eSB3aXRoIHRoZSBvbi1zd2VhdGVyIGFuZCBvbi13YWxsIGluZm9ybWF0aW9uIHRvIHNldCB0aGUgdm9sdW1lIGFuZCBwaXRjaCBvZiB0aGUgb3V0cHV0LlxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayhcclxuICAgICAgWyBkcmFnVmVsb2NpdHlQcm9wZXJ0eSwgdGhpcy5jbGFtcGVkU21vb3RoZWREcmFnVmVsb2NpdHlQcm9wZXJ0eSwgb25Td2VhdGVyUHJvcGVydHksIHRvdWNoaW5nV2FsbFByb3BlcnR5IF0sXHJcbiAgICAgICggZHJhZ1ZlbG9jaXR5LCBzbW9vdGhlZERyYWdWZWxvY2l0eSwgb25Td2VhdGVyLCB0b3VjaGluZ1dhbGwgKSA9PiB7XHJcblxyXG4gICAgICAgIC8vIFRlc3Qgd2hldGhlciB0aGUgYmFsbG9vbiBpcyBiZWluZyBkcmFnZ2VkIG92ZXIgdGhlIHN3ZWF0ZXIgb3IgYWdhaW5zdCB0aGUgd2FsbC5cclxuICAgICAgICBpZiAoICggc21vb3RoZWREcmFnVmVsb2NpdHkubWFnbml0dWRlID4gMCAmJiBvblN3ZWF0ZXIgKSB8fFxyXG4gICAgICAgICAgICAgKCBNYXRoLmFicyggc21vb3RoZWREcmFnVmVsb2NpdHkueSApID4gMCAmJiBNYXRoLmFicyggc21vb3RoZWREcmFnVmVsb2NpdHkueCApID09PSAwICYmIHRvdWNoaW5nV2FsbCApICkge1xyXG5cclxuICAgICAgICAgIC8vIFN0YXJ0IHRoZSBwcm9kdWN0aW9uIG9mIHRoZSBzb3VuZCBpZiBpdCdzIG5vdCBhbHJlYWR5IHBsYXlpbmcuXHJcbiAgICAgICAgICBpZiAoICF0aGlzLmlzUGxheWluZyApIHtcclxuICAgICAgICAgICAgdGhpcy5zdGFydCgpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIFNldCB0aGUgb3V0cHV0IGxldmVsIGJhc2VkIG9uIHRoZSBkcmFnIHNwZWVkLlxyXG4gICAgICAgICAgdGhpcy5zZXRPdXRwdXRMZXZlbChcclxuICAgICAgICAgICAgTUFQX1NNT09USEVEX1NQRUVEX1RPX09VVFBVVF9MRVZFTC5ldmFsdWF0ZSggc21vb3RoZWREcmFnVmVsb2NpdHkubWFnbml0dWRlICkgKiBvcHRpb25zLm1heE91dHB1dExldmVsXHJcbiAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgIC8vIFNldCB0aGUgcGl0Y2ggYmFzZWQgb24gdGhlIGRpcmVjdGlvbiBpbiB3aGljaCB0aGUgYmFsbG9vbiBpcyBiZWluZyBkcmFnZ2VkLlxyXG4gICAgICAgICAgbGV0IHNpZ24gPSAxO1xyXG4gICAgICAgICAgaWYgKCBNYXRoLmFicyggZHJhZ1ZlbG9jaXR5LnggKSA+IE1hdGguYWJzKCBkcmFnVmVsb2NpdHkueSApICkge1xyXG4gICAgICAgICAgICBpZiAoIGRyYWdWZWxvY2l0eS54IDwgMCApIHtcclxuICAgICAgICAgICAgICBzaWduID0gLTE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2UgaWYgKCBkcmFnVmVsb2NpdHkueSA8IDAgKSB7XHJcbiAgICAgICAgICAgIHNpZ24gPSAtMTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMuc2V0QmFuZHBhc3NGaWx0ZXJDZW50ZXJGcmVxdWVuY3koIG9wdGlvbnMuY2VudGVyRnJlcXVlbmN5ICsgc2lnbiAqIEZSRVFVRU5DWV9DSEFOR0VfV0lUSF9ESVJFQ1RJT04gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoICggc21vb3RoZWREcmFnVmVsb2NpdHkubWFnbml0dWRlID09PSAwIHx8ICEoIG9uU3dlYXRlciB8fCB0b3VjaGluZ1dhbGwgKSApICYmIHRoaXMuaXNQbGF5aW5nICkge1xyXG5cclxuICAgICAgICAgIC8vIFRoZSBzbW9vdGhlZCB2ZWxvY2l0eSBoYXMgZHJvcHBlZCB0byB6ZXJvLCB0dXJuIG9mZiBzb3VuZCBwcm9kdWN0aW9uLlxyXG4gICAgICAgICAgdGhpcy5zdG9wKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0IC0gdGltZSBjaGFuZ2UgaW4gc2Vjb25kc1xyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzdGVwKCBkdCApIHtcclxuICAgIGlmICggdGhpcy5jbGFtcGVkU21vb3RoZWREcmFnVmVsb2NpdHlQcm9wZXJ0eS52YWx1ZS5tYWduaXR1ZGUgPiAwICkge1xyXG4gICAgICBjb25zdCB0YXBlcmVkTWFnbml0dWRlID0gTWF0aC5tYXgoXHJcbiAgICAgICAgdGhpcy5jbGFtcGVkU21vb3RoZWREcmFnVmVsb2NpdHlQcm9wZXJ0eS52YWx1ZS5tYWduaXR1ZGUgLSBkdCAqIFNNT09USEVEX1ZFTE9DSVRZX1RBUEVSX1JBVEUsXHJcbiAgICAgICAgMFxyXG4gICAgICApO1xyXG4gICAgICB0aGlzLmNsYW1wZWRTbW9vdGhlZERyYWdWZWxvY2l0eVByb3BlcnR5LnNldChcclxuICAgICAgICB0aGlzLmNsYW1wZWRTbW9vdGhlZERyYWdWZWxvY2l0eVByb3BlcnR5LnZhbHVlLndpdGhNYWduaXR1ZGUoIHRhcGVyZWRNYWduaXR1ZGUgKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8gc3RhdGljc1xyXG5CYWxsb29uUnViYmluZ1NvdW5kR2VuZXJhdG9yLkRFRkFVTFRfQ0VOVEVSX0ZSRVFVRU5DWSA9IERFRkFVTFRfQ0VOVEVSX0ZSRVFVRU5DWTtcclxuXHJcbmJhbGxvb25zQW5kU3RhdGljRWxlY3RyaWNpdHkucmVnaXN0ZXIoICdCYWxsb29uUnViYmluZ1NvdW5kR2VuZXJhdG9yJywgQmFsbG9vblJ1YmJpbmdTb3VuZEdlbmVyYXRvciApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgQmFsbG9vblJ1YmJpbmdTb3VuZEdlbmVyYXRvcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLGNBQWMsTUFBTSxzQ0FBc0M7QUFDakUsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxlQUFlLE1BQU0sdUNBQXVDO0FBQ25FLE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsT0FBT0MsY0FBYyxNQUFNLHlEQUF5RDtBQUNwRixPQUFPQyw0QkFBNEIsTUFB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