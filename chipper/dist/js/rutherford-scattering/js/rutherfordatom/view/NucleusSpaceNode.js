// Copyright 2016-2022, University of Colorado Boulder

/**
 * NucleusSpaceNode is the space in which atoms and alpha particles are rendered.  In this
 * representation, the space has a single nucleus.
 *
 * @author Dave Schmitz (Schmitzware)
 */

import merge from '../../../../phet-core/js/merge.js';
import required from '../../../../phet-core/js/required.js';
import ParticleSpaceNode from '../../common/view/ParticleSpaceNode.js';
import rutherfordScattering from '../../rutherfordScattering.js';
import RutherfordScatteringStrings from '../../RutherfordScatteringStrings.js';
import RutherfordNucleusNode from './RutherfordNucleusNode.js';

// constants
const observationWindowString = RutherfordScatteringStrings.a11y.observationWindow;
const nucleusSpaceDescriptionString = RutherfordScatteringStrings.a11y.nucleusSpaceDescription;
class NucleusSpaceNode extends ParticleSpaceNode {
  /**
   * @param {RSBaseModel} model
   * @param {Property.<boolean>} showAlphaTraceProperty
   * @param {ModelViewTransform2} modelViewTransform - model to view transform
   * @param {Object} config - must provide {Bounds2} canvasBounds
   */
  constructor(model, showAlphaTraceProperty, modelViewTransform, config) {
    config = merge({
      // {Bounds2}
      canvasBounds: required(config.canvasBounds),
      // pdom
      tagName: 'div',
      labelTagName: 'h3',
      labelContent: observationWindowString,
      descriptionContent: nucleusSpaceDescriptionString,
      appendDescription: true
    }, config);
    super(model.nucleusSpace, showAlphaTraceProperty, modelViewTransform, config);

    // @private - atom image generator
    this.atomNode = new RutherfordNucleusNode(model.userInteractionProperty, model.protonCountProperty, model.neutronCountProperty, model.nucleusSpace.rutherfordNucleus);
    this.invalidatePaint();

    // workaround for an issue where the asynchronous images for the RutherfordNuclues weren't getting
    // updated correctly - when marked as 'dirty', the atom node will be explicitly redrawn to ensure that
    // it looks correct in the space
    // does not need to be unlinked, space will exist for life of sim
    model.stepEmitter.addListener(dt => {
      if (this.atomNode.isDirty) {
        if (dt) {
          this.atomNode.timeSinceDirty += dt;
          this.atomNode.updateAtomImage();
          this.atomNode.invalidatePaint();
          if (this.atomNode.timeSinceDirty > 1) {
            this.atomNode.isDirty = false;
          }
        }
      }
    });
  }

  /**
   * @param {CanvasRenderingContext2D} context
   * @override
   * @protected
   */
  paintSpace(context) {
    // Slight chance the image used isn't available. In that case, return & try again on next frame
    if (this.atomNode.image === null) {
      return;
    }
    const x = this.centerX - this.atomNode.image.width / 2;
    const y = this.centerY - this.atomNode.image.height / 2;
    context.drawImage(this.atomNode.image, x, y, this.atomNode.image.width, this.atomNode.image.height);
  }
}
rutherfordScattering.register('NucleusSpaceNode', NucleusSpaceNode);
export default NucleusSpaceNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtZXJnZSIsInJlcXVpcmVkIiwiUGFydGljbGVTcGFjZU5vZGUiLCJydXRoZXJmb3JkU2NhdHRlcmluZyIsIlJ1dGhlcmZvcmRTY2F0dGVyaW5nU3RyaW5ncyIsIlJ1dGhlcmZvcmROdWNsZXVzTm9kZSIsIm9ic2VydmF0aW9uV2luZG93U3RyaW5nIiwiYTExeSIsIm9ic2VydmF0aW9uV2luZG93IiwibnVjbGV1c1NwYWNlRGVzY3JpcHRpb25TdHJpbmciLCJudWNsZXVzU3BhY2VEZXNjcmlwdGlvbiIsIk51Y2xldXNTcGFjZU5vZGUiLCJjb25zdHJ1Y3RvciIsIm1vZGVsIiwic2hvd0FscGhhVHJhY2VQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImNvbmZpZyIsImNhbnZhc0JvdW5kcyIsInRhZ05hbWUiLCJsYWJlbFRhZ05hbWUiLCJsYWJlbENvbnRlbnQiLCJkZXNjcmlwdGlvbkNvbnRlbnQiLCJhcHBlbmREZXNjcmlwdGlvbiIsIm51Y2xldXNTcGFjZSIsImF0b21Ob2RlIiwidXNlckludGVyYWN0aW9uUHJvcGVydHkiLCJwcm90b25Db3VudFByb3BlcnR5IiwibmV1dHJvbkNvdW50UHJvcGVydHkiLCJydXRoZXJmb3JkTnVjbGV1cyIsImludmFsaWRhdGVQYWludCIsInN0ZXBFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJkdCIsImlzRGlydHkiLCJ0aW1lU2luY2VEaXJ0eSIsInVwZGF0ZUF0b21JbWFnZSIsInBhaW50U3BhY2UiLCJjb250ZXh0IiwiaW1hZ2UiLCJ4IiwiY2VudGVyWCIsIndpZHRoIiwieSIsImNlbnRlclkiLCJoZWlnaHQiLCJkcmF3SW1hZ2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk51Y2xldXNTcGFjZU5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTnVjbGV1c1NwYWNlTm9kZSBpcyB0aGUgc3BhY2UgaW4gd2hpY2ggYXRvbXMgYW5kIGFscGhhIHBhcnRpY2xlcyBhcmUgcmVuZGVyZWQuICBJbiB0aGlzXHJcbiAqIHJlcHJlc2VudGF0aW9uLCB0aGUgc3BhY2UgaGFzIGEgc2luZ2xlIG51Y2xldXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgRGF2ZSBTY2htaXR6IChTY2htaXR6d2FyZSlcclxuICovXHJcblxyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IHJlcXVpcmVkIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9yZXF1aXJlZC5qcyc7XHJcbmltcG9ydCBQYXJ0aWNsZVNwYWNlTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9QYXJ0aWNsZVNwYWNlTm9kZS5qcyc7XHJcbmltcG9ydCBydXRoZXJmb3JkU2NhdHRlcmluZyBmcm9tICcuLi8uLi9ydXRoZXJmb3JkU2NhdHRlcmluZy5qcyc7XHJcbmltcG9ydCBSdXRoZXJmb3JkU2NhdHRlcmluZ1N0cmluZ3MgZnJvbSAnLi4vLi4vUnV0aGVyZm9yZFNjYXR0ZXJpbmdTdHJpbmdzLmpzJztcclxuaW1wb3J0IFJ1dGhlcmZvcmROdWNsZXVzTm9kZSBmcm9tICcuL1J1dGhlcmZvcmROdWNsZXVzTm9kZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3Qgb2JzZXJ2YXRpb25XaW5kb3dTdHJpbmcgPSBSdXRoZXJmb3JkU2NhdHRlcmluZ1N0cmluZ3MuYTExeS5vYnNlcnZhdGlvbldpbmRvdztcclxuY29uc3QgbnVjbGV1c1NwYWNlRGVzY3JpcHRpb25TdHJpbmcgPSBSdXRoZXJmb3JkU2NhdHRlcmluZ1N0cmluZ3MuYTExeS5udWNsZXVzU3BhY2VEZXNjcmlwdGlvbjtcclxuXHJcbmNsYXNzIE51Y2xldXNTcGFjZU5vZGUgZXh0ZW5kcyBQYXJ0aWNsZVNwYWNlTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7UlNCYXNlTW9kZWx9IG1vZGVsXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Ym9vbGVhbj59IHNob3dBbHBoYVRyYWNlUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge01vZGVsVmlld1RyYW5zZm9ybTJ9IG1vZGVsVmlld1RyYW5zZm9ybSAtIG1vZGVsIHRvIHZpZXcgdHJhbnNmb3JtXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyAtIG11c3QgcHJvdmlkZSB7Qm91bmRzMn0gY2FudmFzQm91bmRzXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsLCBzaG93QWxwaGFUcmFjZVByb3BlcnR5LCBtb2RlbFZpZXdUcmFuc2Zvcm0sIGNvbmZpZyApIHtcclxuICAgIGNvbmZpZyA9IG1lcmdlKCB7XHJcblxyXG4gICAgICAvLyB7Qm91bmRzMn1cclxuICAgICAgY2FudmFzQm91bmRzOiByZXF1aXJlZCggY29uZmlnLmNhbnZhc0JvdW5kcyApLFxyXG5cclxuICAgICAgLy8gcGRvbVxyXG4gICAgICB0YWdOYW1lOiAnZGl2JyxcclxuICAgICAgbGFiZWxUYWdOYW1lOiAnaDMnLFxyXG4gICAgICBsYWJlbENvbnRlbnQ6IG9ic2VydmF0aW9uV2luZG93U3RyaW5nLFxyXG4gICAgICBkZXNjcmlwdGlvbkNvbnRlbnQ6IG51Y2xldXNTcGFjZURlc2NyaXB0aW9uU3RyaW5nLFxyXG4gICAgICBhcHBlbmREZXNjcmlwdGlvbjogdHJ1ZVxyXG4gICAgfSwgY29uZmlnICk7XHJcblxyXG4gICAgc3VwZXIoIG1vZGVsLm51Y2xldXNTcGFjZSwgc2hvd0FscGhhVHJhY2VQcm9wZXJ0eSwgbW9kZWxWaWV3VHJhbnNmb3JtLCBjb25maWcgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIGF0b20gaW1hZ2UgZ2VuZXJhdG9yXHJcbiAgICB0aGlzLmF0b21Ob2RlID0gbmV3IFJ1dGhlcmZvcmROdWNsZXVzTm9kZSggbW9kZWwudXNlckludGVyYWN0aW9uUHJvcGVydHksIG1vZGVsLnByb3RvbkNvdW50UHJvcGVydHksXHJcbiAgICAgIG1vZGVsLm5ldXRyb25Db3VudFByb3BlcnR5LCBtb2RlbC5udWNsZXVzU3BhY2UucnV0aGVyZm9yZE51Y2xldXMgKTtcclxuXHJcbiAgICB0aGlzLmludmFsaWRhdGVQYWludCgpO1xyXG5cclxuICAgIC8vIHdvcmthcm91bmQgZm9yIGFuIGlzc3VlIHdoZXJlIHRoZSBhc3luY2hyb25vdXMgaW1hZ2VzIGZvciB0aGUgUnV0aGVyZm9yZE51Y2x1ZXMgd2VyZW4ndCBnZXR0aW5nXHJcbiAgICAvLyB1cGRhdGVkIGNvcnJlY3RseSAtIHdoZW4gbWFya2VkIGFzICdkaXJ0eScsIHRoZSBhdG9tIG5vZGUgd2lsbCBiZSBleHBsaWNpdGx5IHJlZHJhd24gdG8gZW5zdXJlIHRoYXRcclxuICAgIC8vIGl0IGxvb2tzIGNvcnJlY3QgaW4gdGhlIHNwYWNlXHJcbiAgICAvLyBkb2VzIG5vdCBuZWVkIHRvIGJlIHVubGlua2VkLCBzcGFjZSB3aWxsIGV4aXN0IGZvciBsaWZlIG9mIHNpbVxyXG4gICAgbW9kZWwuc3RlcEVtaXR0ZXIuYWRkTGlzdGVuZXIoIGR0ID0+IHtcclxuICAgICAgaWYgKCB0aGlzLmF0b21Ob2RlLmlzRGlydHkgKSB7XHJcbiAgICAgICAgaWYgKCBkdCApIHtcclxuICAgICAgICAgIHRoaXMuYXRvbU5vZGUudGltZVNpbmNlRGlydHkgKz0gZHQ7XHJcbiAgICAgICAgICB0aGlzLmF0b21Ob2RlLnVwZGF0ZUF0b21JbWFnZSgpO1xyXG4gICAgICAgICAgdGhpcy5hdG9tTm9kZS5pbnZhbGlkYXRlUGFpbnQoKTtcclxuICAgICAgICAgIGlmICggdGhpcy5hdG9tTm9kZS50aW1lU2luY2VEaXJ0eSA+IDEgKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYXRvbU5vZGUuaXNEaXJ0eSA9IGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0XHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICogQHByb3RlY3RlZFxyXG4gICAqL1xyXG4gIHBhaW50U3BhY2UoIGNvbnRleHQgKSB7XHJcblxyXG4gICAgLy8gU2xpZ2h0IGNoYW5jZSB0aGUgaW1hZ2UgdXNlZCBpc24ndCBhdmFpbGFibGUuIEluIHRoYXQgY2FzZSwgcmV0dXJuICYgdHJ5IGFnYWluIG9uIG5leHQgZnJhbWVcclxuICAgIGlmICggdGhpcy5hdG9tTm9kZS5pbWFnZSA9PT0gbnVsbCApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHggPSB0aGlzLmNlbnRlclggLSB0aGlzLmF0b21Ob2RlLmltYWdlLndpZHRoIC8gMjtcclxuICAgIGNvbnN0IHkgPSB0aGlzLmNlbnRlclkgLSB0aGlzLmF0b21Ob2RlLmltYWdlLmhlaWdodCAvIDI7XHJcbiAgICBjb250ZXh0LmRyYXdJbWFnZSggdGhpcy5hdG9tTm9kZS5pbWFnZSwgeCwgeSwgdGhpcy5hdG9tTm9kZS5pbWFnZS53aWR0aCwgdGhpcy5hdG9tTm9kZS5pbWFnZS5oZWlnaHQgKTtcclxuICB9XHJcbn1cclxuXHJcbnJ1dGhlcmZvcmRTY2F0dGVyaW5nLnJlZ2lzdGVyKCAnTnVjbGV1c1NwYWNlTm9kZScsIE51Y2xldXNTcGFjZU5vZGUgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IE51Y2xldXNTcGFjZU5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxRQUFRLE1BQU0sc0NBQXNDO0FBQzNELE9BQU9DLGlCQUFpQixNQUFNLHdDQUF3QztBQUN0RSxPQUFPQyxvQkFBb0IsTUFBTSwrQkFBK0I7QUFDaEUsT0FBT0MsMkJBQTJCLE1BQU0sc0NBQXNDO0FBQzlFLE9BQU9DLHFCQUFxQixNQUFNLDRCQUE0Qjs7QUFFOUQ7QUFDQSxNQUFNQyx1QkFBdUIsR0FB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