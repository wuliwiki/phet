// Copyright 2016-2021, University of Colorado Boulder

/**
 * Gun is the model of a gun that can fire alpha particles.
 *
 * @author Dave Schmitz (Schmitzware)
 */

import Property from '../../../../axon/js/Property.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import LinearFunction from '../../../../dot/js/LinearFunction.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import rutherfordScattering from '../../rutherfordScattering.js';
import AlphaParticle from './AlphaParticle.js';

// constants
const MAX_PARTICLES = 20;
const GUN_INTENSITY = 1;
const X0_MIN_FRACTION = 0.04; // closest particle can get horizontally to atom as a fraction of atomic bounds

class Gun {
  /**
   * {RSBaseModel} model
   */
  constructor(model) {
    // @private
    this.model = model;

    // @private
    this.dtSinceGunFired = 0;

    // function to correct the initial position of the particle if necessary
    // the trajectory algorithm fails if particle is too close to nucleus,
    // so this correction ensure that this does not happen
    // map values determined empirically
    // @private - to prevent function instantiation every animation frame
    const width1 = 20;
    const width2 = this.model.bounds.width;
    const correction1 = 2;
    const correction2 = 10;
    this.correctionFunction = new LinearFunction(width1, width2, correction1, correction2);

    // @public {boolean} is the gun on?
    this.onProperty = new Property(false);
  }

  /**
   * {number} dt - time step
   * @public
   */
  step(dt) {
    const initialSpeed = this.model.alphaParticleEnergyProperty.get();
    this.dtSinceGunFired += GUN_INTENSITY * dt;
    this.dtPerGunFired = this.model.bounds.width / initialSpeed / MAX_PARTICLES;
    if (this.onProperty.get() && this.dtSinceGunFired >= this.dtPerGunFired) {
      const ySign = dotRandom.nextDouble() < 0.5 ? 1 : -1;

      // random position withing model bounds
      const rand = dotRandom.nextDouble();
      let particleX = ySign * rand * this.model.bounds.width / 2;

      // make sure that the particle was not directly fired at an atom to prevent trajectory failure
      const xMin = X0_MIN_FRACTION * this.model.bounds.width;
      this.model.getVisibleSpace().atoms.forEach(atom => {
        if (Math.abs(particleX - atom.position.x) < xMin) {
          const correction = this.correctionFunction.evaluate(atom.boundingRect.bounds.width);
          if (particleX > atom.position.x) {
            // particle is to the right of nucleus, push it farther away
            particleX += correction;
          } else {
            particleX -= correction;
          }
        }
      });
      const particleY = this.model.bounds.minY;
      const initialPosition = new Vector2(particleX, particleY);
      const alphaParticle = new AlphaParticle({
        speed: initialSpeed,
        defaultSpeed: initialSpeed,
        position: initialPosition
      });
      this.model.addParticle(alphaParticle);
      this.dtSinceGunFired = this.dtSinceGunFired % this.dtPerGunFired;
    }
  }

  /**
   * Reset the gun to its initial state, which is off
   * @public
   */
  reset() {
    this.onProperty.reset();
  }
}
rutherfordScattering.register('Gun', Gun);
export default Gun;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImRvdFJhbmRvbSIsIkxpbmVhckZ1bmN0aW9uIiwiVmVjdG9yMiIsInJ1dGhlcmZvcmRTY2F0dGVyaW5nIiwiQWxwaGFQYXJ0aWNsZSIsIk1BWF9QQVJUSUNMRVMiLCJHVU5fSU5URU5TSVRZIiwiWDBfTUlOX0ZSQUNUSU9OIiwiR3VuIiwiY29uc3RydWN0b3IiLCJtb2RlbCIsImR0U2luY2VHdW5GaXJlZCIsIndpZHRoMSIsIndpZHRoMiIsImJvdW5kcyIsIndpZHRoIiwiY29ycmVjdGlvbjEiLCJjb3JyZWN0aW9uMiIsImNvcnJlY3Rpb25GdW5jdGlvbiIsIm9uUHJvcGVydHkiLCJzdGVwIiwiZHQiLCJpbml0aWFsU3BlZWQiLCJhbHBoYVBhcnRpY2xlRW5lcmd5UHJvcGVydHkiLCJnZXQiLCJkdFBlckd1bkZpcmVkIiwieVNpZ24iLCJuZXh0RG91YmxlIiwicmFuZCIsInBhcnRpY2xlWCIsInhNaW4iLCJnZXRWaXNpYmxlU3BhY2UiLCJhdG9tcyIsImZvckVhY2giLCJhdG9tIiwiTWF0aCIsImFicyIsInBvc2l0aW9uIiwieCIsImNvcnJlY3Rpb24iLCJldmFsdWF0ZSIsImJvdW5kaW5nUmVjdCIsInBhcnRpY2xlWSIsIm1pblkiLCJpbml0aWFsUG9zaXRpb24iLCJhbHBoYVBhcnRpY2xlIiwic3BlZWQiLCJkZWZhdWx0U3BlZWQiLCJhZGRQYXJ0aWNsZSIsInJlc2V0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJHdW4uanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMSwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogR3VuIGlzIHRoZSBtb2RlbCBvZiBhIGd1biB0aGF0IGNhbiBmaXJlIGFscGhhIHBhcnRpY2xlcy5cclxuICpcclxuICogQGF1dGhvciBEYXZlIFNjaG1pdHogKFNjaG1pdHp3YXJlKVxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IExpbmVhckZ1bmN0aW9uIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9MaW5lYXJGdW5jdGlvbi5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHJ1dGhlcmZvcmRTY2F0dGVyaW5nIGZyb20gJy4uLy4uL3J1dGhlcmZvcmRTY2F0dGVyaW5nLmpzJztcclxuaW1wb3J0IEFscGhhUGFydGljbGUgZnJvbSAnLi9BbHBoYVBhcnRpY2xlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBNQVhfUEFSVElDTEVTID0gMjA7XHJcbmNvbnN0IEdVTl9JTlRFTlNJVFkgPSAxO1xyXG5jb25zdCBYMF9NSU5fRlJBQ1RJT04gPSAwLjA0OyAvLyBjbG9zZXN0IHBhcnRpY2xlIGNhbiBnZXQgaG9yaXpvbnRhbGx5IHRvIGF0b20gYXMgYSBmcmFjdGlvbiBvZiBhdG9taWMgYm91bmRzXHJcblxyXG5jbGFzcyBHdW4ge1xyXG5cclxuICAvKipcclxuICAgKiB7UlNCYXNlTW9kZWx9IG1vZGVsXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsICkge1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLm1vZGVsID0gbW9kZWw7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuZHRTaW5jZUd1bkZpcmVkID0gMDtcclxuXHJcbiAgICAvLyBmdW5jdGlvbiB0byBjb3JyZWN0IHRoZSBpbml0aWFsIHBvc2l0aW9uIG9mIHRoZSBwYXJ0aWNsZSBpZiBuZWNlc3NhcnlcclxuICAgIC8vIHRoZSB0cmFqZWN0b3J5IGFsZ29yaXRobSBmYWlscyBpZiBwYXJ0aWNsZSBpcyB0b28gY2xvc2UgdG8gbnVjbGV1cyxcclxuICAgIC8vIHNvIHRoaXMgY29ycmVjdGlvbiBlbnN1cmUgdGhhdCB0aGlzIGRvZXMgbm90IGhhcHBlblxyXG4gICAgLy8gbWFwIHZhbHVlcyBkZXRlcm1pbmVkIGVtcGlyaWNhbGx5XHJcbiAgICAvLyBAcHJpdmF0ZSAtIHRvIHByZXZlbnQgZnVuY3Rpb24gaW5zdGFudGlhdGlvbiBldmVyeSBhbmltYXRpb24gZnJhbWVcclxuICAgIGNvbnN0IHdpZHRoMSA9IDIwO1xyXG4gICAgY29uc3Qgd2lkdGgyID0gdGhpcy5tb2RlbC5ib3VuZHMud2lkdGg7XHJcbiAgICBjb25zdCBjb3JyZWN0aW9uMSA9IDI7XHJcbiAgICBjb25zdCBjb3JyZWN0aW9uMiA9IDEwO1xyXG4gICAgdGhpcy5jb3JyZWN0aW9uRnVuY3Rpb24gPSBuZXcgTGluZWFyRnVuY3Rpb24oIHdpZHRoMSwgd2lkdGgyLCBjb3JyZWN0aW9uMSwgY29ycmVjdGlvbjIgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtib29sZWFufSBpcyB0aGUgZ3VuIG9uP1xyXG4gICAgdGhpcy5vblByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBmYWxzZSApO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIHtudW1iZXJ9IGR0IC0gdGltZSBzdGVwXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGR0ICkge1xyXG5cclxuICAgIGNvbnN0IGluaXRpYWxTcGVlZCA9IHRoaXMubW9kZWwuYWxwaGFQYXJ0aWNsZUVuZXJneVByb3BlcnR5LmdldCgpO1xyXG5cclxuICAgIHRoaXMuZHRTaW5jZUd1bkZpcmVkICs9ICggR1VOX0lOVEVOU0lUWSAqIGR0ICk7XHJcbiAgICB0aGlzLmR0UGVyR3VuRmlyZWQgPSAoIHRoaXMubW9kZWwuYm91bmRzLndpZHRoIC8gaW5pdGlhbFNwZWVkICkgLyBNQVhfUEFSVElDTEVTO1xyXG5cclxuICAgIGlmICggdGhpcy5vblByb3BlcnR5LmdldCgpICYmIHRoaXMuZHRTaW5jZUd1bkZpcmVkID49IHRoaXMuZHRQZXJHdW5GaXJlZCApIHtcclxuXHJcbiAgICAgIGNvbnN0IHlTaWduID0gKCBkb3RSYW5kb20ubmV4dERvdWJsZSgpIDwgMC41ID8gMSA6IC0xICk7XHJcblxyXG4gICAgICAvLyByYW5kb20gcG9zaXRpb24gd2l0aGluZyBtb2RlbCBib3VuZHNcclxuICAgICAgY29uc3QgcmFuZCA9IGRvdFJhbmRvbS5uZXh0RG91YmxlKCk7XHJcbiAgICAgIGxldCBwYXJ0aWNsZVggPSB5U2lnbiAqIHJhbmQgKiB0aGlzLm1vZGVsLmJvdW5kcy53aWR0aCAvIDI7XHJcblxyXG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgcGFydGljbGUgd2FzIG5vdCBkaXJlY3RseSBmaXJlZCBhdCBhbiBhdG9tIHRvIHByZXZlbnQgdHJhamVjdG9yeSBmYWlsdXJlXHJcbiAgICAgIGNvbnN0IHhNaW4gPSBYMF9NSU5fRlJBQ1RJT04gKiB0aGlzLm1vZGVsLmJvdW5kcy53aWR0aDtcclxuICAgICAgdGhpcy5tb2RlbC5nZXRWaXNpYmxlU3BhY2UoKS5hdG9tcy5mb3JFYWNoKCBhdG9tID0+IHtcclxuICAgICAgICBpZiAoIE1hdGguYWJzKCBwYXJ0aWNsZVggLSBhdG9tLnBvc2l0aW9uLnggKSA8IHhNaW4gKSB7XHJcbiAgICAgICAgICBjb25zdCBjb3JyZWN0aW9uID0gdGhpcy5jb3JyZWN0aW9uRnVuY3Rpb24uZXZhbHVhdGUoIGF0b20uYm91bmRpbmdSZWN0LmJvdW5kcy53aWR0aCApO1xyXG4gICAgICAgICAgaWYgKCBwYXJ0aWNsZVggPiBhdG9tLnBvc2l0aW9uLnggKSB7XHJcbiAgICAgICAgICAgIC8vIHBhcnRpY2xlIGlzIHRvIHRoZSByaWdodCBvZiBudWNsZXVzLCBwdXNoIGl0IGZhcnRoZXIgYXdheVxyXG4gICAgICAgICAgICBwYXJ0aWNsZVggKz0gY29ycmVjdGlvbjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBwYXJ0aWNsZVggLT0gY29ycmVjdGlvbjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuICAgICAgY29uc3QgcGFydGljbGVZID0gdGhpcy5tb2RlbC5ib3VuZHMubWluWTtcclxuXHJcbiAgICAgIGNvbnN0IGluaXRpYWxQb3NpdGlvbiA9IG5ldyBWZWN0b3IyKCBwYXJ0aWNsZVgsIHBhcnRpY2xlWSApO1xyXG4gICAgICBjb25zdCBhbHBoYVBhcnRpY2xlID0gbmV3IEFscGhhUGFydGljbGUoIHtcclxuICAgICAgICBzcGVlZDogaW5pdGlhbFNwZWVkLFxyXG4gICAgICAgIGRlZmF1bHRTcGVlZDogaW5pdGlhbFNwZWVkLFxyXG4gICAgICAgIHBvc2l0aW9uOiBpbml0aWFsUG9zaXRpb25cclxuICAgICAgfSApO1xyXG4gICAgICB0aGlzLm1vZGVsLmFkZFBhcnRpY2xlKCBhbHBoYVBhcnRpY2xlICk7XHJcblxyXG4gICAgICB0aGlzLmR0U2luY2VHdW5GaXJlZCA9IHRoaXMuZHRTaW5jZUd1bkZpcmVkICUgdGhpcy5kdFBlckd1bkZpcmVkO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXQgdGhlIGd1biB0byBpdHMgaW5pdGlhbCBzdGF0ZSwgd2hpY2ggaXMgb2ZmXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5vblByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG59XHJcblxyXG5ydXRoZXJmb3JkU2NhdHRlcmluZy5yZWdpc3RlciggJ0d1bicsIEd1biApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgR3VuOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUFDdkQsT0FBT0MsY0FBYyxNQUFNLHNDQUFzQztBQUNqRSxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLG9CQUFvQixN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