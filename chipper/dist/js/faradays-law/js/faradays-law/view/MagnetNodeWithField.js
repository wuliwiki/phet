// Copyright 2014-2022, University of Colorado Boulder

/**
 * Magnet Node with field lines, draggable.
 *
 * @author Vasily Shakhov (MLearner)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Dimension2 from '../../../../dot/js/Dimension2.js';
import GrabDragInteraction from '../../../../scenery-phet/js/accessibility/GrabDragInteraction.js';
import { animatedPanZoomSingleton, DragListener, FocusHighlightFromNode, InteractiveHighlightingNode, KeyboardUtils, Node } from '../../../../scenery/js/imports.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import soundManager from '../../../../tambo/js/soundManager.js';
import grabMagnet_mp3 from '../../../sounds/grabMagnet_mp3.js';
import releaseMagnet_mp3 from '../../../sounds/releaseMagnet_mp3.js';
import faradaysLaw from '../../faradaysLaw.js';
import FaradaysLawStrings from '../../FaradaysLawStrings.js';
import FaradaysLawAlertManager from './FaradaysLawAlertManager.js';
import FaradaysLawKeyboardDragListener from './FaradaysLawKeyboardDragListener.js';
import JumpMagnitudeArrowNode from './JumpMagnitudeArrowNode.js';
import MagnetAutoSlideKeyboardListener from './MagnetAutoSlideKeyboardListener.js';
import MagnetDescriber from './MagnetDescriber.js';
import MagnetDescriptionNode from './MagnetDescriptionNode.js';
import MagnetFieldLines from './MagnetFieldLines.js';
import MagnetMovementArrowsNode from './MagnetMovementArrowsNode.js';
import MagnetNode from './MagnetNode.js';
import MagnetRegionManager from './MagnetRegionManager.js';

// constants
const barMagnetString = FaradaysLawStrings.a11y.barMagnet;
const GRAB_RELEASE_SOUND_LEVEL = 0.2; // empirically determined

/**
 * @param {FaradaysLawModel} model
 * @param {Tandem} tandem
 * @constructor
 */
class MagnetNodeWithField extends Node {
  /**
   * @param {FaradaysLawModel} model
   * @param {Tandem} tandem
   */
  constructor(model, tandem) {
    super();
    const self = this;

    // magnet
    this.magnetNode = createMagnetNode(model.magnet);

    // field lines
    this.addChild(new MagnetFieldLines(model.magnet, tandem.createTandem('fieldLinesNode')));

    // pdom
    // create the focus highlight to pass as an option
    const draggableNodeFocusHighlight = new FocusHighlightFromNode(this.magnetNode); // overridden once the draggableNode is fully constructed

    // the draggable container for the magnet and arrows
    const draggableNode = new InteractiveHighlightingNode({
      cursor: 'pointer',
      // The parent (MagnetNodeWithField) isn't instrumented, and this is the interactive node, so instrument this as
      // the "parent" magnet instances, see https://github.com/phetsims/faradays-law/issues/116.
      // NOTE: this assumes that tandem is not passed into a mutate or Node.call() in the MagnetNodeWithField type.
      tandem: tandem,
      phetioDocumentation: 'The draggable container for the magnet and arrows',
      // pdom
      tagName: 'div',
      ariaRole: 'application',
      focusable: true,
      innerContent: barMagnetString,
      focusHighlightLayerable: true,
      focusHighlight: draggableNodeFocusHighlight
    });
    this.addChild(draggableNode);
    this.addChild(draggableNodeFocusHighlight);

    // add the magnet to the draggable node
    draggableNode.addChild(this.magnetNode);

    // add the hint that will provide a clue to the user about how the magnet can be moved
    this.addChild(new MagnetMovementArrowsNode(new Dimension2(this.magnetNode.width, this.magnetNode.height), {
      visibleProperty: model.magnetArrowsVisibleProperty
    }));

    // magnet slide target - a node to indicate the future position when sliding the magnet
    this.magnetSlideTargetNode = createMagnetNode(model.magnet);
    this.addChild(this.magnetSlideTargetNode);
    this.magnetSlideTargetNode.opacity = 0.5;
    this.magnetSlideTargetNode.visible = false;

    // pdom descriptions - generates text content and alerts for magnet interactions
    const regionManager = new MagnetRegionManager(model);
    const describer = new MagnetDescriber(model, regionManager, tandem);
    const alertManager = new FaradaysLawAlertManager(this, describer);

    // sound generation
    const grabMagnetSoundPlayer = new SoundClip(grabMagnet_mp3, {
      initialOutputLevel: GRAB_RELEASE_SOUND_LEVEL
    });
    soundManager.addSoundGenerator(grabMagnetSoundPlayer);
    const releaseMagnetSoundPlayer = new SoundClip(releaseMagnet_mp3, {
      initialOutputLevel: GRAB_RELEASE_SOUND_LEVEL
    });
    soundManager.addSoundGenerator(releaseMagnetSoundPlayer);

    // handler
    let magnetOffset = null; // {Vector2|null}
    const dragListener = new DragListener({
      tandem: tandem.createTandem('dragListener'),
      phetioDocumentation: 'Emits events when dragged by the user',
      // When dragging across it in a mobile device, pick it up
      allowTouchSnag: true,
      start(event) {
        model.magnet.isDraggingProperty.set(true);
        magnetOffset = self.globalToParentPoint(event.pointer.point).minus(self.translation);
      },
      // Translate on drag events
      drag(event) {
        model.magnetArrowsVisibleProperty.set(false);
        const parentPoint = self.globalToParentPoint(event.pointer.point);
        const desiredPosition = parentPoint.minus(magnetOffset);
        model.moveMagnetToPosition(desiredPosition);
      },
      end() {
        model.magnet.isDraggingProperty.set(false);
        alertManager.movementEndAlert();
      }
    });
    draggableNode.addInputListener(dragListener);
    model.magnet.positionProperty.linkAttribute(this, 'translation');

    // @private - drag handler for keyboard navigation
    const keyboardDragListener = new FaradaysLawKeyboardDragListener(model, regionManager, alertManager, {
      tandem: tandem.createTandem('keyboardDragListener')
    });

    // arrows displayed before initiating the sliding/jumping movement
    const leftJumpArrows = new JumpMagnitudeArrowNode('left');
    const rightJumpArrows = new JumpMagnitudeArrowNode('right');
    leftJumpArrows.setKeyPositions(this.magnetNode.bounds);
    rightJumpArrows.setKeyPositions(this.magnetNode.bounds);
    this.addChild(leftJumpArrows);
    this.addChild(rightJumpArrows);

    // handler for jump/slide interactions
    const magnetJumpKeyboardListener = new MagnetAutoSlideKeyboardListener(model, {
      onKeyDown(event) {
        const domEvent = event.domEvent;

        // event.code is the unique value of the key pressed
        // we want to ensure that we're only listening for the 1,2, and 3 keys
        if (KeyboardUtils.isAnyKeyEvent(domEvent, [KeyboardUtils.KEY_1, KeyboardUtils.KEY_2, KeyboardUtils.KEY_3]) && !isKeyModified(domEvent)) {
          self.magnetSlideTargetNode.visible = true;
          model.magnetArrowsVisibleProperty.set(false);
          const magnitude = KeyboardUtils.getNumberFromCode(domEvent);
          assert && assert(typeof magnitude === 'number', 'should be a number');
          if (model.magnet.positionProperty.get().x < magnetJumpKeyboardListener.slideTargetPositionProperty.value.x) {
            rightJumpArrows.showCue(magnitude);
          } else {
            leftJumpArrows.showCue(magnitude);
          }
        }
        if (magnetJumpKeyboardListener.isAnimatingProperty.get()) {
          regionManager.stopMagnetAnimationWithKeyboard();
        }
      },
      onKeyUp(event) {
        if (KeyboardUtils.isNumberKey(event.domEvent)) {
          self.magnetSlideTargetNode.visible = false;
        }
        rightJumpArrows.hideCue();
        leftJumpArrows.hideCue();
      }
    });

    // flag that tracks whether the magnet has been dragged since initial load or since a reset
    let magnetDragged = false;
    model.magnet.positionProperty.lazyLink(() => {
      if (!model.resetInProgressProperty.value) {
        magnetDragged = true;
      }
    });

    // listener to watch for when this node gets focus through the keyboard nav system
    const focusListener = {
      focus: () => {
        // Turn off the movement hint when this item gets focus.
        model.magnetArrowsVisibleProperty.set(false);
      }
    };

    // Set up keyboard grab/drag interaction.  Note that, while GrabDragInteraction supports management of the drag cue,
    // this capability is not used here, and the drag cue is managed elsewhere.  That's because the drag cue (the four
    // arrows) needed to be visible at times that were not entirely under the control of GrabDragInteraction.
    const grabDragInteraction = new GrabDragInteraction(draggableNode, keyboardDragListener, {
      objectToGrabString: barMagnetString,
      listenersForDragState: [magnetJumpKeyboardListener],
      listenersForGrabState: [focusListener],
      grabCueOptions: {
        // position the grab cue directly above the magnet and centered
        centerX: 0,
        bottom: -this.magnetNode.height * 0.7
      },
      onGrab: () => {
        if (!magnetDragged) {
          model.magnetArrowsVisibleProperty.set(true);
        }
        grabMagnetSoundPlayer.play();
      },
      onRelease: () => {
        self.magnetSlideTargetNode.visible = false;
        rightJumpArrows.hideCue();
        leftJumpArrows.hideCue();
        magnetJumpKeyboardListener.released();
        releaseMagnetSoundPlayer.play();
      },
      tandem: tandem.createTandem('grabDragInteraction')
    });

    // listener to position the target node
    const setSlideTargetNodeCenter = position => {
      this.magnetSlideTargetNode.center = this.parentToLocalPoint(position);
    };

    // observers
    model.magnet.orientationProperty.link(() => {
      this.magnetNode.detach();
      this.magnetNode = createMagnetNode(model.magnet);
      draggableNode.addChild(this.magnetNode);

      // ensure poles on the slide target magnet match that of the original
      this.magnetSlideTargetNode.detach();
      this.magnetSlideTargetNode = createMagnetNode(model.magnet);
      this.addChild(this.magnetSlideTargetNode);
      this.magnetSlideTargetNode.opacity = 0.5;
      this.magnetSlideTargetNode.visible = false;
      setSlideTargetNodeCenter(magnetJumpKeyboardListener.slideTargetPositionProperty.get());
    });
    magnetJumpKeyboardListener.slideTargetPositionProperty.link(setSlideTargetNodeCenter);
    const pdomNode = new MagnetDescriptionNode(model, describer);
    this.addChild(pdomNode);
    model.magnet.orientationProperty.lazyLink(orientation => {
      alertManager.flipMagnetAlert(orientation);
    });

    // @a11y
    magnetJumpKeyboardListener.isAnimatingProperty.link(isAnimating => {
      regionManager.setMagnetIsAnimating(isAnimating);
    });

    // while the magnet is being moved from the MagnetAutoSlideKeyboardListener,
    // make sure that it remains within the displayed bounds with the pan and zoom
    // feature
    model.magnet.positionProperty.link(position => {
      if (magnetJumpKeyboardListener.isAnimatingProperty.get()) {
        animatedPanZoomSingleton.listener.panToNode(draggableNode);
      }
    });
    this.regionManager = regionManager;

    // monitor the model for a reset, perform any local resetting that is necessary
    model.resetInProgressProperty.lazyLink(resetInProgress => {
      if (resetInProgress) {
        magnetDragged = false;
        grabDragInteraction.reset();
      }
    });
  }
}

/**
 * Creates the magnet node
 * @param {Magnet} magnet
 * @returns {MagnetNode}
 */
const createMagnetNode = magnet => {
  return new MagnetNode(magnet.orientationProperty.get(), {
    width: magnet.width,
    height: magnet.height,
    showArrows: true
  });
};

/**
 * Helper function to check a DOM event for whether the key is modified.  This does not check for all modifier keys,
 * just the ones that we care about for magnet node manipulation.
 * @returns {boolean}
 */
const isKeyModified = domEvent => {
  return domEvent.getModifierState('Control') || domEvent.getModifierState('Alt');
};
faradaysLaw.register('MagnetNodeWithField', MagnetNodeWithField);
export default MagnetNodeWithField;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEaW1lbnNpb24yIiwiR3JhYkRyYWdJbnRlcmFjdGlvbiIsImFuaW1hdGVkUGFuWm9vbVNpbmdsZXRvbiIsIkRyYWdMaXN0ZW5lciIsIkZvY3VzSGlnaGxpZ2h0RnJvbU5vZGUiLCJJbnRlcmFjdGl2ZUhpZ2hsaWdodGluZ05vZGUiLCJLZXlib2FyZFV0aWxzIiwiTm9kZSIsIlNvdW5kQ2xpcCIsInNvdW5kTWFuYWdlciIsImdyYWJNYWduZXRfbXAzIiwicmVsZWFzZU1hZ25ldF9tcDMiLCJmYXJhZGF5c0xhdyIsIkZhcmFkYXlzTGF3U3RyaW5ncyIsIkZhcmFkYXlzTGF3QWxlcnRNYW5hZ2VyIiwiRmFyYWRheXNMYXdLZXlib2FyZERyYWdMaXN0ZW5lciIsIkp1bXBNYWduaXR1ZGVBcnJvd05vZGUiLCJNYWduZXRBdXRvU2xpZGVLZXlib2FyZExpc3RlbmVyIiwiTWFnbmV0RGVzY3JpYmVyIiwiTWFnbmV0RGVzY3JpcHRpb25Ob2RlIiwiTWFnbmV0RmllbGRMaW5lcyIsIk1hZ25ldE1vdmVtZW50QXJyb3dzTm9kZSIsIk1hZ25ldE5vZGUiLCJNYWduZXRSZWdpb25NYW5hZ2VyIiwiYmFyTWFnbmV0U3RyaW5nIiwiYTExeSIsImJhck1hZ25ldCIsIkdSQUJfUkVMRUFTRV9TT1VORF9MRVZFTCIsIk1hZ25ldE5vZGVXaXRoRmllbGQiLCJjb25zdHJ1Y3RvciIsIm1vZGVsIiwidGFuZGVtIiwic2VsZiIsIm1hZ25ldE5vZGUiLCJjcmVhdGVNYWduZXROb2RlIiwibWFnbmV0IiwiYWRkQ2hpbGQiLCJjcmVhdGVUYW5kZW0iLCJkcmFnZ2FibGVOb2RlRm9jdXNIaWdobGlnaHQiLCJkcmFnZ2FibGVOb2RlIiwiY3Vyc29yIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInRhZ05hbWUiLCJhcmlhUm9sZSIsImZvY3VzYWJsZSIsImlubmVyQ29udGVudCIsImZvY3VzSGlnaGxpZ2h0TGF5ZXJhYmxlIiwiZm9jdXNIaWdobGlnaHQiLCJ3aWR0aCIsImhlaWdodCIsInZpc2libGVQcm9wZXJ0eSIsIm1hZ25ldEFycm93c1Zpc2libGVQcm9wZXJ0eSIsIm1hZ25ldFNsaWRlVGFyZ2V0Tm9kZSIsIm9wYWNpdHkiLCJ2aXNpYmxlIiwicmVnaW9uTWFuYWdlciIsImRlc2NyaWJlciIsImFsZXJ0TWFuYWdlciIsImdyYWJNYWduZXRTb3VuZFBsYXllciIsImluaXRpYWxPdXRwdXRMZXZlbCIsImFkZFNvdW5kR2VuZXJhdG9yIiwicmVsZWFzZU1hZ25ldFNvdW5kUGxheWVyIiwibWFnbmV0T2Zmc2V0IiwiZHJhZ0xpc3RlbmVyIiwiYWxsb3dUb3VjaFNuYWciLCJzdGFydCIsImV2ZW50IiwiaXNEcmFnZ2luZ1Byb3BlcnR5Iiwic2V0IiwiZ2xvYmFsVG9QYXJlbnRQb2ludCIsInBvaW50ZXIiLCJwb2ludCIsIm1pbnVzIiwidHJhbnNsYXRpb24iLCJkcmFnIiwicGFyZW50UG9pbnQiLCJkZXNpcmVkUG9zaXRpb24iLCJtb3ZlTWFnbmV0VG9Qb3NpdGlvbiIsImVuZCIsIm1vdmVtZW50RW5kQWxlcnQiLCJhZGRJbnB1dExpc3RlbmVyIiwicG9zaXRpb25Qcm9wZXJ0eSIsImxpbmtBdHRyaWJ1dGUiLCJrZXlib2FyZERyYWdMaXN0ZW5lciIsImxlZnRKdW1wQXJyb3dzIiwicmlnaHRKdW1wQXJyb3dzIiwic2V0S2V5UG9zaXRpb25zIiwiYm91bmRzIiwibWFnbmV0SnVtcEtleWJvYXJkTGlzdGVuZXIiLCJvbktleURvd24iLCJkb21FdmVudCIsImlzQW55S2V5RXZlbnQiLCJLRVlfMSIsIktFWV8yIiwiS0VZXzMiLCJpc0tleU1vZGlmaWVkIiwibWFnbml0dWRlIiwiZ2V0TnVtYmVyRnJvbUNvZGUiLCJhc3NlcnQiLCJnZXQiLCJ4Iiwic2xpZGVUYXJnZXRQb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJzaG93Q3VlIiwiaXNBbmltYXRpbmdQcm9wZXJ0eSIsInN0b3BNYWduZXRBbmltYXRpb25XaXRoS2V5Ym9hcmQiLCJvbktleVVwIiwiaXNOdW1iZXJLZXkiLCJoaWRlQ3VlIiwibWFnbmV0RHJhZ2dlZCIsImxhenlMaW5rIiwicmVzZXRJblByb2dyZXNzUHJvcGVydHkiLCJmb2N1c0xpc3RlbmVyIiwiZm9jdXMiLCJncmFiRHJhZ0ludGVyYWN0aW9uIiwib2JqZWN0VG9HcmFiU3RyaW5nIiwibGlzdGVuZXJzRm9yRHJhZ1N0YXRlIiwibGlzdGVuZXJzRm9yR3JhYlN0YXRlIiwiZ3JhYkN1ZU9wdGlvbnMiLCJjZW50ZXJYIiwiYm90dG9tIiwib25HcmFiIiwicGxheSIsIm9uUmVsZWFzZSIsInJlbGVhc2VkIiwic2V0U2xpZGVUYXJnZXROb2RlQ2VudGVyIiwicG9zaXRpb24iLCJjZW50ZXIiLCJwYXJlbnRUb0xvY2FsUG9pbnQiLCJvcmllbnRhdGlvblByb3BlcnR5IiwibGluayIsImRldGFjaCIsInBkb21Ob2RlIiwib3JpZW50YXRpb24iLCJmbGlwTWFnbmV0QWxlcnQiLCJpc0FuaW1hdGluZyIsInNldE1hZ25ldElzQW5pbWF0aW5nIiwibGlzdGVuZXIiLCJwYW5Ub05vZGUiLCJyZXNldEluUHJvZ3Jlc3MiLCJyZXNldCIsInNob3dBcnJvd3MiLCJnZXRNb2RpZmllclN0YXRlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNYWduZXROb2RlV2l0aEZpZWxkLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1hZ25ldCBOb2RlIHdpdGggZmllbGQgbGluZXMsIGRyYWdnYWJsZS5cclxuICpcclxuICogQGF1dGhvciBWYXNpbHkgU2hha2hvdiAoTUxlYXJuZXIpXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IERpbWVuc2lvbjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0RpbWVuc2lvbjIuanMnO1xyXG5pbXBvcnQgR3JhYkRyYWdJbnRlcmFjdGlvbiBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvYWNjZXNzaWJpbGl0eS9HcmFiRHJhZ0ludGVyYWN0aW9uLmpzJztcclxuaW1wb3J0IHsgYW5pbWF0ZWRQYW5ab29tU2luZ2xldG9uLCBEcmFnTGlzdGVuZXIsIEZvY3VzSGlnaGxpZ2h0RnJvbU5vZGUsIEludGVyYWN0aXZlSGlnaGxpZ2h0aW5nTm9kZSwgS2V5Ym9hcmRVdGlscywgTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBTb3VuZENsaXAgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvc291bmQtZ2VuZXJhdG9ycy9Tb3VuZENsaXAuanMnO1xyXG5pbXBvcnQgc291bmRNYW5hZ2VyIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kTWFuYWdlci5qcyc7XHJcbmltcG9ydCBncmFiTWFnbmV0X21wMyBmcm9tICcuLi8uLi8uLi9zb3VuZHMvZ3JhYk1hZ25ldF9tcDMuanMnO1xyXG5pbXBvcnQgcmVsZWFzZU1hZ25ldF9tcDMgZnJvbSAnLi4vLi4vLi4vc291bmRzL3JlbGVhc2VNYWduZXRfbXAzLmpzJztcclxuaW1wb3J0IGZhcmFkYXlzTGF3IGZyb20gJy4uLy4uL2ZhcmFkYXlzTGF3LmpzJztcclxuaW1wb3J0IEZhcmFkYXlzTGF3U3RyaW5ncyBmcm9tICcuLi8uLi9GYXJhZGF5c0xhd1N0cmluZ3MuanMnO1xyXG5pbXBvcnQgRmFyYWRheXNMYXdBbGVydE1hbmFnZXIgZnJvbSAnLi9GYXJhZGF5c0xhd0FsZXJ0TWFuYWdlci5qcyc7XHJcbmltcG9ydCBGYXJhZGF5c0xhd0tleWJvYXJkRHJhZ0xpc3RlbmVyIGZyb20gJy4vRmFyYWRheXNMYXdLZXlib2FyZERyYWdMaXN0ZW5lci5qcyc7XHJcbmltcG9ydCBKdW1wTWFnbml0dWRlQXJyb3dOb2RlIGZyb20gJy4vSnVtcE1hZ25pdHVkZUFycm93Tm9kZS5qcyc7XHJcbmltcG9ydCBNYWduZXRBdXRvU2xpZGVLZXlib2FyZExpc3RlbmVyIGZyb20gJy4vTWFnbmV0QXV0b1NsaWRlS2V5Ym9hcmRMaXN0ZW5lci5qcyc7XHJcbmltcG9ydCBNYWduZXREZXNjcmliZXIgZnJvbSAnLi9NYWduZXREZXNjcmliZXIuanMnO1xyXG5pbXBvcnQgTWFnbmV0RGVzY3JpcHRpb25Ob2RlIGZyb20gJy4vTWFnbmV0RGVzY3JpcHRpb25Ob2RlLmpzJztcclxuaW1wb3J0IE1hZ25ldEZpZWxkTGluZXMgZnJvbSAnLi9NYWduZXRGaWVsZExpbmVzLmpzJztcclxuaW1wb3J0IE1hZ25ldE1vdmVtZW50QXJyb3dzTm9kZSBmcm9tICcuL01hZ25ldE1vdmVtZW50QXJyb3dzTm9kZS5qcyc7XHJcbmltcG9ydCBNYWduZXROb2RlIGZyb20gJy4vTWFnbmV0Tm9kZS5qcyc7XHJcbmltcG9ydCBNYWduZXRSZWdpb25NYW5hZ2VyIGZyb20gJy4vTWFnbmV0UmVnaW9uTWFuYWdlci5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgYmFyTWFnbmV0U3RyaW5nID0gRmFyYWRheXNMYXdTdHJpbmdzLmExMXkuYmFyTWFnbmV0O1xyXG5jb25zdCBHUkFCX1JFTEVBU0VfU09VTkRfTEVWRUwgPSAwLjI7IC8vIGVtcGlyaWNhbGx5IGRldGVybWluZWRcclxuXHJcbi8qKlxyXG4gKiBAcGFyYW0ge0ZhcmFkYXlzTGF3TW9kZWx9IG1vZGVsXHJcbiAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICogQGNvbnN0cnVjdG9yXHJcbiAqL1xyXG5jbGFzcyBNYWduZXROb2RlV2l0aEZpZWxkIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7RmFyYWRheXNMYXdNb2RlbH0gbW9kZWxcclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsLCB0YW5kZW0gKSB7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAvLyBtYWduZXRcclxuICAgIHRoaXMubWFnbmV0Tm9kZSA9IGNyZWF0ZU1hZ25ldE5vZGUoIG1vZGVsLm1hZ25ldCApO1xyXG5cclxuICAgIC8vIGZpZWxkIGxpbmVzXHJcbiAgICB0aGlzLmFkZENoaWxkKCBuZXcgTWFnbmV0RmllbGRMaW5lcyggbW9kZWwubWFnbmV0LCB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnZmllbGRMaW5lc05vZGUnICkgKSApO1xyXG5cclxuICAgIC8vIHBkb21cclxuICAgIC8vIGNyZWF0ZSB0aGUgZm9jdXMgaGlnaGxpZ2h0IHRvIHBhc3MgYXMgYW4gb3B0aW9uXHJcbiAgICBjb25zdCBkcmFnZ2FibGVOb2RlRm9jdXNIaWdobGlnaHQgPSBuZXcgRm9jdXNIaWdobGlnaHRGcm9tTm9kZSggdGhpcy5tYWduZXROb2RlICk7IC8vIG92ZXJyaWRkZW4gb25jZSB0aGUgZHJhZ2dhYmxlTm9kZSBpcyBmdWxseSBjb25zdHJ1Y3RlZFxyXG5cclxuICAgIC8vIHRoZSBkcmFnZ2FibGUgY29udGFpbmVyIGZvciB0aGUgbWFnbmV0IGFuZCBhcnJvd3NcclxuICAgIGNvbnN0IGRyYWdnYWJsZU5vZGUgPSBuZXcgSW50ZXJhY3RpdmVIaWdobGlnaHRpbmdOb2RlKCB7XHJcbiAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxyXG5cclxuICAgICAgLy8gVGhlIHBhcmVudCAoTWFnbmV0Tm9kZVdpdGhGaWVsZCkgaXNuJ3QgaW5zdHJ1bWVudGVkLCBhbmQgdGhpcyBpcyB0aGUgaW50ZXJhY3RpdmUgbm9kZSwgc28gaW5zdHJ1bWVudCB0aGlzIGFzXHJcbiAgICAgIC8vIHRoZSBcInBhcmVudFwiIG1hZ25ldCBpbnN0YW5jZXMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZmFyYWRheXMtbGF3L2lzc3Vlcy8xMTYuXHJcbiAgICAgIC8vIE5PVEU6IHRoaXMgYXNzdW1lcyB0aGF0IHRhbmRlbSBpcyBub3QgcGFzc2VkIGludG8gYSBtdXRhdGUgb3IgTm9kZS5jYWxsKCkgaW4gdGhlIE1hZ25ldE5vZGVXaXRoRmllbGQgdHlwZS5cclxuICAgICAgdGFuZGVtOiB0YW5kZW0sXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdUaGUgZHJhZ2dhYmxlIGNvbnRhaW5lciBmb3IgdGhlIG1hZ25ldCBhbmQgYXJyb3dzJyxcclxuXHJcbiAgICAgIC8vIHBkb21cclxuICAgICAgdGFnTmFtZTogJ2RpdicsXHJcbiAgICAgIGFyaWFSb2xlOiAnYXBwbGljYXRpb24nLFxyXG4gICAgICBmb2N1c2FibGU6IHRydWUsXHJcbiAgICAgIGlubmVyQ29udGVudDogYmFyTWFnbmV0U3RyaW5nLFxyXG4gICAgICBmb2N1c0hpZ2hsaWdodExheWVyYWJsZTogdHJ1ZSxcclxuICAgICAgZm9jdXNIaWdobGlnaHQ6IGRyYWdnYWJsZU5vZGVGb2N1c0hpZ2hsaWdodFxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYWRkQ2hpbGQoIGRyYWdnYWJsZU5vZGUgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGRyYWdnYWJsZU5vZGVGb2N1c0hpZ2hsaWdodCApO1xyXG5cclxuICAgIC8vIGFkZCB0aGUgbWFnbmV0IHRvIHRoZSBkcmFnZ2FibGUgbm9kZVxyXG4gICAgZHJhZ2dhYmxlTm9kZS5hZGRDaGlsZCggdGhpcy5tYWduZXROb2RlICk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBoaW50IHRoYXQgd2lsbCBwcm92aWRlIGEgY2x1ZSB0byB0aGUgdXNlciBhYm91dCBob3cgdGhlIG1hZ25ldCBjYW4gYmUgbW92ZWRcclxuICAgIHRoaXMuYWRkQ2hpbGQoIG5ldyBNYWduZXRNb3ZlbWVudEFycm93c05vZGUoXHJcbiAgICAgIG5ldyBEaW1lbnNpb24yKCB0aGlzLm1hZ25ldE5vZGUud2lkdGgsIHRoaXMubWFnbmV0Tm9kZS5oZWlnaHQgKSwge1xyXG4gICAgICAgIHZpc2libGVQcm9wZXJ0eTogbW9kZWwubWFnbmV0QXJyb3dzVmlzaWJsZVByb3BlcnR5XHJcbiAgICAgIH1cclxuICAgICkgKTtcclxuXHJcbiAgICAvLyBtYWduZXQgc2xpZGUgdGFyZ2V0IC0gYSBub2RlIHRvIGluZGljYXRlIHRoZSBmdXR1cmUgcG9zaXRpb24gd2hlbiBzbGlkaW5nIHRoZSBtYWduZXRcclxuICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlID0gY3JlYXRlTWFnbmV0Tm9kZSggbW9kZWwubWFnbmV0ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLm1hZ25ldFNsaWRlVGFyZ2V0Tm9kZSApO1xyXG4gICAgdGhpcy5tYWduZXRTbGlkZVRhcmdldE5vZGUub3BhY2l0eSA9IDAuNTtcclxuICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlLnZpc2libGUgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBwZG9tIGRlc2NyaXB0aW9ucyAtIGdlbmVyYXRlcyB0ZXh0IGNvbnRlbnQgYW5kIGFsZXJ0cyBmb3IgbWFnbmV0IGludGVyYWN0aW9uc1xyXG4gICAgY29uc3QgcmVnaW9uTWFuYWdlciA9IG5ldyBNYWduZXRSZWdpb25NYW5hZ2VyKCBtb2RlbCApO1xyXG4gICAgY29uc3QgZGVzY3JpYmVyID0gbmV3IE1hZ25ldERlc2NyaWJlciggbW9kZWwsIHJlZ2lvbk1hbmFnZXIsIHRhbmRlbSApO1xyXG4gICAgY29uc3QgYWxlcnRNYW5hZ2VyID0gbmV3IEZhcmFkYXlzTGF3QWxlcnRNYW5hZ2VyKCB0aGlzLCBkZXNjcmliZXIgKTtcclxuXHJcbiAgICAvLyBzb3VuZCBnZW5lcmF0aW9uXHJcbiAgICBjb25zdCBncmFiTWFnbmV0U291bmRQbGF5ZXIgPSBuZXcgU291bmRDbGlwKCBncmFiTWFnbmV0X21wMywge1xyXG4gICAgICBpbml0aWFsT3V0cHV0TGV2ZWw6IEdSQUJfUkVMRUFTRV9TT1VORF9MRVZFTFxyXG4gICAgfSApO1xyXG4gICAgc291bmRNYW5hZ2VyLmFkZFNvdW5kR2VuZXJhdG9yKCBncmFiTWFnbmV0U291bmRQbGF5ZXIgKTtcclxuICAgIGNvbnN0IHJlbGVhc2VNYWduZXRTb3VuZFBsYXllciA9IG5ldyBTb3VuZENsaXAoIHJlbGVhc2VNYWduZXRfbXAzLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogR1JBQl9SRUxFQVNFX1NPVU5EX0xFVkVMXHJcbiAgICB9ICk7XHJcbiAgICBzb3VuZE1hbmFnZXIuYWRkU291bmRHZW5lcmF0b3IoIHJlbGVhc2VNYWduZXRTb3VuZFBsYXllciApO1xyXG5cclxuICAgIC8vIGhhbmRsZXJcclxuICAgIGxldCBtYWduZXRPZmZzZXQgPSBudWxsOyAvLyB7VmVjdG9yMnxudWxsfVxyXG4gICAgY29uc3QgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG5cclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnZHJhZ0xpc3RlbmVyJyApLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnRW1pdHMgZXZlbnRzIHdoZW4gZHJhZ2dlZCBieSB0aGUgdXNlcicsXHJcblxyXG4gICAgICAvLyBXaGVuIGRyYWdnaW5nIGFjcm9zcyBpdCBpbiBhIG1vYmlsZSBkZXZpY2UsIHBpY2sgaXQgdXBcclxuICAgICAgYWxsb3dUb3VjaFNuYWc6IHRydWUsXHJcblxyXG4gICAgICBzdGFydCggZXZlbnQgKSB7XHJcbiAgICAgICAgbW9kZWwubWFnbmV0LmlzRHJhZ2dpbmdQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgICBtYWduZXRPZmZzZXQgPSBzZWxmLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKS5taW51cyggc2VsZi50cmFuc2xhdGlvbiApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgLy8gVHJhbnNsYXRlIG9uIGRyYWcgZXZlbnRzXHJcbiAgICAgIGRyYWcoIGV2ZW50ICkge1xyXG4gICAgICAgIG1vZGVsLm1hZ25ldEFycm93c1Zpc2libGVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgICAgY29uc3QgcGFyZW50UG9pbnQgPSBzZWxmLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKTtcclxuICAgICAgICBjb25zdCBkZXNpcmVkUG9zaXRpb24gPSBwYXJlbnRQb2ludC5taW51cyggbWFnbmV0T2Zmc2V0ICk7XHJcbiAgICAgICAgbW9kZWwubW92ZU1hZ25ldFRvUG9zaXRpb24oIGRlc2lyZWRQb3NpdGlvbiApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgZW5kKCkge1xyXG4gICAgICAgIG1vZGVsLm1hZ25ldC5pc0RyYWdnaW5nUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICAgIGFsZXJ0TWFuYWdlci5tb3ZlbWVudEVuZEFsZXJ0KCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICAgIGRyYWdnYWJsZU5vZGUuYWRkSW5wdXRMaXN0ZW5lciggZHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgbW9kZWwubWFnbmV0LnBvc2l0aW9uUHJvcGVydHkubGlua0F0dHJpYnV0ZSggdGhpcywgJ3RyYW5zbGF0aW9uJyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gZHJhZyBoYW5kbGVyIGZvciBrZXlib2FyZCBuYXZpZ2F0aW9uXHJcbiAgICBjb25zdCBrZXlib2FyZERyYWdMaXN0ZW5lciA9IG5ldyBGYXJhZGF5c0xhd0tleWJvYXJkRHJhZ0xpc3RlbmVyKCBtb2RlbCwgcmVnaW9uTWFuYWdlciwgYWxlcnRNYW5hZ2VyLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2tleWJvYXJkRHJhZ0xpc3RlbmVyJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gYXJyb3dzIGRpc3BsYXllZCBiZWZvcmUgaW5pdGlhdGluZyB0aGUgc2xpZGluZy9qdW1waW5nIG1vdmVtZW50XHJcbiAgICBjb25zdCBsZWZ0SnVtcEFycm93cyA9IG5ldyBKdW1wTWFnbml0dWRlQXJyb3dOb2RlKCAnbGVmdCcgKTtcclxuICAgIGNvbnN0IHJpZ2h0SnVtcEFycm93cyA9IG5ldyBKdW1wTWFnbml0dWRlQXJyb3dOb2RlKCAncmlnaHQnICk7XHJcbiAgICBsZWZ0SnVtcEFycm93cy5zZXRLZXlQb3NpdGlvbnMoIHRoaXMubWFnbmV0Tm9kZS5ib3VuZHMgKTtcclxuICAgIHJpZ2h0SnVtcEFycm93cy5zZXRLZXlQb3NpdGlvbnMoIHRoaXMubWFnbmV0Tm9kZS5ib3VuZHMgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGxlZnRKdW1wQXJyb3dzICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCByaWdodEp1bXBBcnJvd3MgKTtcclxuXHJcbiAgICAvLyBoYW5kbGVyIGZvciBqdW1wL3NsaWRlIGludGVyYWN0aW9uc1xyXG4gICAgY29uc3QgbWFnbmV0SnVtcEtleWJvYXJkTGlzdGVuZXIgPSBuZXcgTWFnbmV0QXV0b1NsaWRlS2V5Ym9hcmRMaXN0ZW5lciggbW9kZWwsIHtcclxuICAgICAgb25LZXlEb3duKCBldmVudCApIHtcclxuICAgICAgICBjb25zdCBkb21FdmVudCA9IGV2ZW50LmRvbUV2ZW50O1xyXG5cclxuICAgICAgICAvLyBldmVudC5jb2RlIGlzIHRoZSB1bmlxdWUgdmFsdWUgb2YgdGhlIGtleSBwcmVzc2VkXHJcbiAgICAgICAgLy8gd2Ugd2FudCB0byBlbnN1cmUgdGhhdCB3ZSdyZSBvbmx5IGxpc3RlbmluZyBmb3IgdGhlIDEsMiwgYW5kIDMga2V5c1xyXG4gICAgICAgIGlmICggS2V5Ym9hcmRVdGlscy5pc0FueUtleUV2ZW50KCBkb21FdmVudCwgWyBLZXlib2FyZFV0aWxzLktFWV8xLCBLZXlib2FyZFV0aWxzLktFWV8yLCBLZXlib2FyZFV0aWxzLktFWV8zIF0gKSAmJlxyXG4gICAgICAgICAgICAgIWlzS2V5TW9kaWZpZWQoIGRvbUV2ZW50ICkgKSB7XHJcblxyXG4gICAgICAgICAgc2VsZi5tYWduZXRTbGlkZVRhcmdldE5vZGUudmlzaWJsZSA9IHRydWU7XHJcbiAgICAgICAgICBtb2RlbC5tYWduZXRBcnJvd3NWaXNpYmxlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG5cclxuICAgICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IEtleWJvYXJkVXRpbHMuZ2V0TnVtYmVyRnJvbUNvZGUoIGRvbUV2ZW50ICk7XHJcbiAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0eXBlb2YgbWFnbml0dWRlID09PSAnbnVtYmVyJywgJ3Nob3VsZCBiZSBhIG51bWJlcicgKTtcclxuXHJcbiAgICAgICAgICBpZiAoIG1vZGVsLm1hZ25ldC5wb3NpdGlvblByb3BlcnR5LmdldCgpLnggPCBtYWduZXRKdW1wS2V5Ym9hcmRMaXN0ZW5lci5zbGlkZVRhcmdldFBvc2l0aW9uUHJvcGVydHkudmFsdWUueCApIHtcclxuICAgICAgICAgICAgcmlnaHRKdW1wQXJyb3dzLnNob3dDdWUoIG1hZ25pdHVkZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGxlZnRKdW1wQXJyb3dzLnNob3dDdWUoIG1hZ25pdHVkZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCBtYWduZXRKdW1wS2V5Ym9hcmRMaXN0ZW5lci5pc0FuaW1hdGluZ1Byb3BlcnR5LmdldCgpICkge1xyXG4gICAgICAgICAgcmVnaW9uTWFuYWdlci5zdG9wTWFnbmV0QW5pbWF0aW9uV2l0aEtleWJvYXJkKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICBvbktleVVwKCBldmVudCApIHtcclxuICAgICAgICBpZiAoIEtleWJvYXJkVXRpbHMuaXNOdW1iZXJLZXkoIGV2ZW50LmRvbUV2ZW50ICkgKSB7XHJcbiAgICAgICAgICBzZWxmLm1hZ25ldFNsaWRlVGFyZ2V0Tm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJpZ2h0SnVtcEFycm93cy5oaWRlQ3VlKCk7XHJcbiAgICAgICAgbGVmdEp1bXBBcnJvd3MuaGlkZUN1ZSgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gZmxhZyB0aGF0IHRyYWNrcyB3aGV0aGVyIHRoZSBtYWduZXQgaGFzIGJlZW4gZHJhZ2dlZCBzaW5jZSBpbml0aWFsIGxvYWQgb3Igc2luY2UgYSByZXNldFxyXG4gICAgbGV0IG1hZ25ldERyYWdnZWQgPSBmYWxzZTtcclxuICAgIG1vZGVsLm1hZ25ldC5wb3NpdGlvblByb3BlcnR5LmxhenlMaW5rKCAoKSA9PiB7XHJcbiAgICAgIGlmICggIW1vZGVsLnJlc2V0SW5Qcm9ncmVzc1Byb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICAgIG1hZ25ldERyYWdnZWQgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gbGlzdGVuZXIgdG8gd2F0Y2ggZm9yIHdoZW4gdGhpcyBub2RlIGdldHMgZm9jdXMgdGhyb3VnaCB0aGUga2V5Ym9hcmQgbmF2IHN5c3RlbVxyXG4gICAgY29uc3QgZm9jdXNMaXN0ZW5lciA9IHtcclxuICAgICAgZm9jdXM6ICgpID0+IHtcclxuXHJcbiAgICAgICAgLy8gVHVybiBvZmYgdGhlIG1vdmVtZW50IGhpbnQgd2hlbiB0aGlzIGl0ZW0gZ2V0cyBmb2N1cy5cclxuICAgICAgICBtb2RlbC5tYWduZXRBcnJvd3NWaXNpYmxlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFNldCB1cCBrZXlib2FyZCBncmFiL2RyYWcgaW50ZXJhY3Rpb24uICBOb3RlIHRoYXQsIHdoaWxlIEdyYWJEcmFnSW50ZXJhY3Rpb24gc3VwcG9ydHMgbWFuYWdlbWVudCBvZiB0aGUgZHJhZyBjdWUsXHJcbiAgICAvLyB0aGlzIGNhcGFiaWxpdHkgaXMgbm90IHVzZWQgaGVyZSwgYW5kIHRoZSBkcmFnIGN1ZSBpcyBtYW5hZ2VkIGVsc2V3aGVyZS4gIFRoYXQncyBiZWNhdXNlIHRoZSBkcmFnIGN1ZSAodGhlIGZvdXJcclxuICAgIC8vIGFycm93cykgbmVlZGVkIHRvIGJlIHZpc2libGUgYXQgdGltZXMgdGhhdCB3ZXJlIG5vdCBlbnRpcmVseSB1bmRlciB0aGUgY29udHJvbCBvZiBHcmFiRHJhZ0ludGVyYWN0aW9uLlxyXG4gICAgY29uc3QgZ3JhYkRyYWdJbnRlcmFjdGlvbiA9IG5ldyBHcmFiRHJhZ0ludGVyYWN0aW9uKCBkcmFnZ2FibGVOb2RlLCBrZXlib2FyZERyYWdMaXN0ZW5lciwge1xyXG4gICAgICBvYmplY3RUb0dyYWJTdHJpbmc6IGJhck1hZ25ldFN0cmluZyxcclxuICAgICAgbGlzdGVuZXJzRm9yRHJhZ1N0YXRlOiBbIG1hZ25ldEp1bXBLZXlib2FyZExpc3RlbmVyIF0sXHJcbiAgICAgIGxpc3RlbmVyc0ZvckdyYWJTdGF0ZTogWyBmb2N1c0xpc3RlbmVyIF0sXHJcbiAgICAgIGdyYWJDdWVPcHRpb25zOiB7XHJcblxyXG4gICAgICAgIC8vIHBvc2l0aW9uIHRoZSBncmFiIGN1ZSBkaXJlY3RseSBhYm92ZSB0aGUgbWFnbmV0IGFuZCBjZW50ZXJlZFxyXG4gICAgICAgIGNlbnRlclg6IDAsXHJcbiAgICAgICAgYm90dG9tOiAtdGhpcy5tYWduZXROb2RlLmhlaWdodCAqIDAuN1xyXG4gICAgICB9LFxyXG4gICAgICBvbkdyYWI6ICgpID0+IHtcclxuICAgICAgICBpZiAoICFtYWduZXREcmFnZ2VkICkge1xyXG4gICAgICAgICAgbW9kZWwubWFnbmV0QXJyb3dzVmlzaWJsZVByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBncmFiTWFnbmV0U291bmRQbGF5ZXIucGxheSgpO1xyXG4gICAgICB9LFxyXG4gICAgICBvblJlbGVhc2U6ICgpID0+IHtcclxuICAgICAgICBzZWxmLm1hZ25ldFNsaWRlVGFyZ2V0Tm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgcmlnaHRKdW1wQXJyb3dzLmhpZGVDdWUoKTtcclxuICAgICAgICBsZWZ0SnVtcEFycm93cy5oaWRlQ3VlKCk7XHJcbiAgICAgICAgbWFnbmV0SnVtcEtleWJvYXJkTGlzdGVuZXIucmVsZWFzZWQoKTtcclxuICAgICAgICByZWxlYXNlTWFnbmV0U291bmRQbGF5ZXIucGxheSgpO1xyXG4gICAgICB9LFxyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdncmFiRHJhZ0ludGVyYWN0aW9uJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gbGlzdGVuZXIgdG8gcG9zaXRpb24gdGhlIHRhcmdldCBub2RlXHJcbiAgICBjb25zdCBzZXRTbGlkZVRhcmdldE5vZGVDZW50ZXIgPSBwb3NpdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlLmNlbnRlciA9IHRoaXMucGFyZW50VG9Mb2NhbFBvaW50KCBwb3NpdGlvbiApO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBvYnNlcnZlcnNcclxuICAgIG1vZGVsLm1hZ25ldC5vcmllbnRhdGlvblByb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgdGhpcy5tYWduZXROb2RlLmRldGFjaCgpO1xyXG4gICAgICB0aGlzLm1hZ25ldE5vZGUgPSBjcmVhdGVNYWduZXROb2RlKCBtb2RlbC5tYWduZXQgKTtcclxuICAgICAgZHJhZ2dhYmxlTm9kZS5hZGRDaGlsZCggdGhpcy5tYWduZXROb2RlICk7XHJcblxyXG4gICAgICAvLyBlbnN1cmUgcG9sZXMgb24gdGhlIHNsaWRlIHRhcmdldCBtYWduZXQgbWF0Y2ggdGhhdCBvZiB0aGUgb3JpZ2luYWxcclxuICAgICAgdGhpcy5tYWduZXRTbGlkZVRhcmdldE5vZGUuZGV0YWNoKCk7XHJcbiAgICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlID0gY3JlYXRlTWFnbmV0Tm9kZSggbW9kZWwubWFnbmV0ICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlICk7XHJcbiAgICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlLm9wYWNpdHkgPSAwLjU7XHJcbiAgICAgIHRoaXMubWFnbmV0U2xpZGVUYXJnZXROb2RlLnZpc2libGUgPSBmYWxzZTtcclxuICAgICAgc2V0U2xpZGVUYXJnZXROb2RlQ2VudGVyKCBtYWduZXRKdW1wS2V5Ym9hcmRMaXN0ZW5lci5zbGlkZVRhcmdldFBvc2l0aW9uUHJvcGVydHkuZ2V0KCkgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBtYWduZXRKdW1wS2V5Ym9hcmRMaXN0ZW5lci5zbGlkZVRhcmdldFBvc2l0aW9uUHJvcGVydHkubGluayggc2V0U2xpZGVUYXJnZXROb2RlQ2VudGVyICk7XHJcblxyXG4gICAgY29uc3QgcGRvbU5vZGUgPSBuZXcgTWFnbmV0RGVzY3JpcHRpb25Ob2RlKCBtb2RlbCwgZGVzY3JpYmVyICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBwZG9tTm9kZSApO1xyXG5cclxuICAgIG1vZGVsLm1hZ25ldC5vcmllbnRhdGlvblByb3BlcnR5LmxhenlMaW5rKCBvcmllbnRhdGlvbiA9PiB7XHJcbiAgICAgIGFsZXJ0TWFuYWdlci5mbGlwTWFnbmV0QWxlcnQoIG9yaWVudGF0aW9uICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQGExMXlcclxuICAgIG1hZ25ldEp1bXBLZXlib2FyZExpc3RlbmVyLmlzQW5pbWF0aW5nUHJvcGVydHkubGluayggaXNBbmltYXRpbmcgPT4ge1xyXG4gICAgICByZWdpb25NYW5hZ2VyLnNldE1hZ25ldElzQW5pbWF0aW5nKCBpc0FuaW1hdGluZyApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHdoaWxlIHRoZSBtYWduZXQgaXMgYmVpbmcgbW92ZWQgZnJvbSB0aGUgTWFnbmV0QXV0b1NsaWRlS2V5Ym9hcmRMaXN0ZW5lcixcclxuICAgIC8vIG1ha2Ugc3VyZSB0aGF0IGl0IHJlbWFpbnMgd2l0aGluIHRoZSBkaXNwbGF5ZWQgYm91bmRzIHdpdGggdGhlIHBhbiBhbmQgem9vbVxyXG4gICAgLy8gZmVhdHVyZVxyXG4gICAgbW9kZWwubWFnbmV0LnBvc2l0aW9uUHJvcGVydHkubGluayggcG9zaXRpb24gPT4ge1xyXG4gICAgICBpZiAoIG1hZ25ldEp1bXBLZXlib2FyZExpc3RlbmVyLmlzQW5pbWF0aW5nUHJvcGVydHkuZ2V0KCkgKSB7XHJcbiAgICAgICAgYW5pbWF0ZWRQYW5ab29tU2luZ2xldG9uLmxpc3RlbmVyLnBhblRvTm9kZSggZHJhZ2dhYmxlTm9kZSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5yZWdpb25NYW5hZ2VyID0gcmVnaW9uTWFuYWdlcjtcclxuXHJcbiAgICAvLyBtb25pdG9yIHRoZSBtb2RlbCBmb3IgYSByZXNldCwgcGVyZm9ybSBhbnkgbG9jYWwgcmVzZXR0aW5nIHRoYXQgaXMgbmVjZXNzYXJ5XHJcbiAgICBtb2RlbC5yZXNldEluUHJvZ3Jlc3NQcm9wZXJ0eS5sYXp5TGluayggcmVzZXRJblByb2dyZXNzID0+IHtcclxuICAgICAgaWYgKCByZXNldEluUHJvZ3Jlc3MgKSB7XHJcbiAgICAgICAgbWFnbmV0RHJhZ2dlZCA9IGZhbHNlO1xyXG4gICAgICAgIGdyYWJEcmFnSW50ZXJhY3Rpb24ucmVzZXQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgdGhlIG1hZ25ldCBub2RlXHJcbiAqIEBwYXJhbSB7TWFnbmV0fSBtYWduZXRcclxuICogQHJldHVybnMge01hZ25ldE5vZGV9XHJcbiAqL1xyXG5jb25zdCBjcmVhdGVNYWduZXROb2RlID0gbWFnbmV0ID0+IHtcclxuICByZXR1cm4gbmV3IE1hZ25ldE5vZGUoIG1hZ25ldC5vcmllbnRhdGlvblByb3BlcnR5LmdldCgpLCB7XHJcbiAgICB3aWR0aDogbWFnbmV0LndpZHRoLFxyXG4gICAgaGVpZ2h0OiBtYWduZXQuaGVpZ2h0LFxyXG4gICAgc2hvd0Fycm93czogdHJ1ZVxyXG4gIH0gKTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gY2hlY2sgYSBET00gZXZlbnQgZm9yIHdoZXRoZXIgdGhlIGtleSBpcyBtb2RpZmllZC4gIFRoaXMgZG9lcyBub3QgY2hlY2sgZm9yIGFsbCBtb2RpZmllciBrZXlzLFxyXG4gKiBqdXN0IHRoZSBvbmVzIHRoYXQgd2UgY2FyZSBhYm91dCBmb3IgbWFnbmV0IG5vZGUgbWFuaXB1bGF0aW9uLlxyXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cclxuICovXHJcbmNvbnN0IGlzS2V5TW9kaWZpZWQgPSBkb21FdmVudCA9PiB7XHJcbiAgcmV0dXJuIGRvbUV2ZW50LmdldE1vZGlmaWVyU3RhdGUoICdDb250cm9sJyApIHx8IGRvbUV2ZW50LmdldE1vZGlmaWVyU3RhdGUoICdBbHQnICk7XHJcbn07XHJcblxyXG5mYXJhZGF5c0xhdy5yZWdpc3RlciggJ01hZ25ldE5vZGVXaXRoRmllbGQnLCBNYWduZXROb2RlV2l0aEZpZWxkICk7XHJcbmV4cG9ydCBkZWZhdWx0IE1hZ25ldE5vZGVXaXRoRmllbGQ7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsVUFBVSxNQUFNLGtDQUFrQztBQUN6RCxPQUFPQyxtQkFBbUIsTUFBTSxrRUFBa0U7QUFDbEcsU0FBU0Msd0JBQXdCLEVBQUVDLFlBQVksRUFBRUMsc0JBQXNCLEVBQUVDLDJCQUEyQixFQUFFQyxhQUFhLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDcEssT0FBT0MsU0FBUyxNQUFNLG9EQUFvRDtBQUMxRSxPQUFPQyxZQUFZLE1BQU0sc0NBQXNDO0FBQy9ELE9BQU9DLGNBQWMsTUFBTSxtQ0FBbUM7QUFDOUQsT0FBT0MsaUJBQWlCLE1BQU0sc0NBQXNDO0FBQ3BFLE9BQU9DLFdBQVcsTUFBTSxzQkFBc0I7QUFDOUMsT0FBT0Msa0JBQWtCLE1BQU0sNkJBQTZCO0FBQzVELE9BQU9DLHVCQUF1QixNQUFNLDhCQUE4QjtBQUNsRSxPQUFPQywrQkFBK0IsTUFBTSxzQ0FBc0M7QUFDbEYsT0FBT0Msc0JBQXNCLE1BQU0sNkJBQTZCO0FBQ2hFLE9BQU9DLCtCQUErQixNQUFNLHNDQUFzQztBQUNsRixPQUFPQyxlQUFlLE1BQU0sc0JBQXNCO0FBQ2xELE9BQU9DLHFCQUFxQixNQUFNLDRCQUE0QjtBQUM5RCxPQUFPQyxnQkFBZ0IsTUFBTSx1QkFBdUI7QUFDcEQsT0FBT0Msd0JBQXdCLE1BQU0sK0JBQStCO0FBQ3BFLE9BQU9DLFVBQVUsTUFBTSxpQkFBaUI7QUFDeEMsT0FBT0MsbUJBQW1CLE1BQU0sMEJBQTBCOztBQUUxRDtBQUNBLE1BQU1DLGVBQWUsR0FBR1gsa0JBQWtCLENBQUNZLElBQUksQ0FBQ0MsU0FBUztBQUN6RCxNQUFNQyx3QkFBd0IsR0FBRyxHQUFHLENBQUMsQ0FBQzs7QUFFdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLG1CQUFtQixTQUFTckIsSUFBSSxDQUFDO0VBRXJDO0FBQ0Y7QUFDQTtBQUNBO0VBQ0VzQixXQUFXQSxDQUFFQyxLQUFLLEVBQUVDLE1BQU0sRUFBRztJQUUzQixLQUFLLENBQUMsQ0FBQztJQUVQLE1BQU1DLElBQUksR0FBRyxJQUFJOztJQUVqQjtJQUNBLElBQUksQ0FBQ0MsVUFBVSxHQUFHQyxnQkFBZ0IsQ0FBRUosS0FBSyxDQUFDSyxNQUFPLENBQUM7O0lBRWxEO0lBQ0EsSUFBSSxDQUFDQyxRQUFRLENBQUUsSUFBSWhCLGdCQUFnQixDQUFFVSxLQUFLLENBQUNLLE1BQU0sRUFBRUosTUFBTSxDQUFDTSxZQUFZLENBQUUsZ0JBQWlCLENBQUUsQ0FBRSxDQUFDOztJQUU5RjtJQUNBO0lBQ0EsTUFBTUMsMkJBQTJCLEdBQUcsSUFBSWxDLHNCQUFzQixDQUFFLElBQUksQ0FBQzZCLFVBQVcsQ0FBQyxDQUFDLENBQUM7O0lBRW5GO0lBQ0EsTUFBTU0sYUFBYSxHQUFHLElBQUlsQywyQkFBMkIsQ0FBRTtNQUNyRG1DLE1BQU0sRUFBRSxTQUFTO01BRWpCO01BQ0E7TUFDQTtNQUNBVCxNQUFNLEVBQUVBLE1BQU07TUFDZFUsbUJBQW1CLEVBQUUsbURBQW1EO01BRXhFO01BQ0FDLE9BQU8sRUFBRSxLQUFLO01BQ2RDLFFBQVEsRUFBRSxhQUFhO01BQ3ZCQyxTQUFTLEVBQUUsSUFBSTtNQUNmQyxZQUFZLEVBQUVyQixlQUFlO01BQzdCc0IsdUJBQXVCLEVBQUUsSUFBSTtNQUM3QkMsY0FBYyxFQUFFVDtJQUNsQixDQUFFLENBQUM7SUFFSCxJQUFJLENBQUNGLFFBQVEsQ0FBRUcsYUFBYyxDQUFDO0lBQzlCLElBQUksQ0FBQ0gsUUFBUSxDQUFFRSwyQkFBNEIsQ0FBQzs7SUFFNUM7SUFDQUMsYUFBYSxDQUFDSCxRQUFRLENBQUUsSUFBSSxDQUFDSCxVQUFXLENBQUM7O0lBRXpDO0lBQ0EsSUFBSSxDQUFDRyxRQUFRLENBQUUsSUFBSWYsd0JBQXdCLENBQ3pDLElBQUlyQixVQUFVLENBQUUsSUFBSSxDQUFDaUMsVUFBVSxDQUFDZSxLQUFLLEVBQUUsSUFBSSxDQUFDZixVQUFVLENBQUNnQixNQUFPLENBQUMsRUFBRTtNQUMvREMsZUFBZSxFQUFFcEIsS0FBSyxDQUFDcUI7SUFDekIsQ0FDRixDQUFFLENBQUM7O0lBRUg7SUFDQSxJQUFJLENBQUNDLHFCQUFxQixHQUFHbEIsZ0JBQWdCLENBQUVKLEtBQUssQ0FBQ0ssTUFBTyxDQUFDO0lBQzdELElBQUksQ0FBQ0MsUUFBUSxDQUFFLElBQUksQ0FBQ2dCLHFCQUFzQixDQUFDO0lBQzNDLElBQUksQ0FBQ0EscUJBQXFCLENBQUNDLE9BQU8sR0FBRyxHQUFHO0lBQ3hDLElBQUksQ0FBQ0QscUJBQXFCLENBQUNFLE9BQU8sR0FBRyxLQUFLOztJQUUxQztJQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUFJaEMsbUJBQW1CLENBQUVPLEtBQU0sQ0FBQztJQUN0RCxNQUFNMEIsU0FBUyxHQUFHLElBQUl0QyxlQUFlLENBQUVZLEtBQUssRUFBRXlCLGFBQWEsRUFBRXhCLE1BQU8sQ0FBQztJQUNyRSxNQUFNMEIsWUFBWSxHQUFHLElBQUkzQyx1QkFBdUIsQ0FBRSxJQUFJLEVBQUUwQyxTQUFVLENBQUM7O0lBRW5FO0lBQ0EsTUFBTUUscUJBQXFCLEdBQUcsSUFBSWxELFNBQVMsQ0FBRUUsY0FBYyxFQUFFO01BQzNEaUQsa0JBQWtCLEVBQUVoQztJQUN0QixDQUFFLENBQUM7SUFDSGxCLFlBQVksQ0FBQ21ELGlCQUFpQixDQUFFRixxQkFBc0IsQ0FBQztJQUN2RCxNQUFNRyx3QkFBd0IsR0FBRyxJQUFJckQsU0FBUyxDQUFFRyxpQkFBaUIsRUFBRTtNQUNqRWdELGtCQUFrQixFQUFFaEM7SUFDdEIsQ0FBRSxDQUFDO0lBQ0hsQixZQUFZLENBQUNtRCxpQkFBaUIsQ0FBRUMsd0JBQXlCLENBQUM7O0lBRTFEO0lBQ0EsSUFBSUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ3pCLE1BQU1DLFlBQVksR0FBRyxJQUFJNUQsWUFBWSxDQUFFO01BRXJDNEIsTUFBTSxFQUFFQSxNQUFNLENBQUNNLFlBQVksQ0FBRSxjQUFlLENBQUM7TUFDN0NJLG1CQUFtQixFQUFFLHVDQUF1QztNQUU1RDtNQUNBdUIsY0FBYyxFQUFFLElBQUk7TUFFcEJDLEtBQUtBLENBQUVDLEtBQUssRUFBRztRQUNicEMsS0FBSyxDQUFDSyxNQUFNLENBQUNnQyxrQkFBa0IsQ0FBQ0MsR0FBRyxDQUFFLElBQUssQ0FBQztRQUMzQ04sWUFBWSxHQUFHOUIsSUFBSSxDQUFDcUMsbUJBQW1CLENBQUVILEtBQUssQ0FBQ0ksT0FBTyxDQUFDQyxLQUFNLENBQUMsQ0FBQ0MsS0FBSyxDQUFFeEMsSUFBSSxDQUFDeUMsV0FBWSxDQUFDO01BQzFGLENBQUM7TUFFRDtNQUNBQyxJQUFJQSxDQUFFUixLQUFLLEVBQUc7UUFDWnBDLEtBQUssQ0FBQ3FCLDJCQUEyQixDQUFDaUIsR0FBRyxDQUFFLEtBQU0sQ0FBQztRQUM5QyxNQUFNTyxXQUFXLEdBQUczQyxJQUFJLENBQUNxQyxtQkFBbUIsQ0FBRUgsS0FBSyxDQUFDSSxPQUFPLENBQUNDLEtBQU0sQ0FBQztRQUNuRSxNQUFNSyxlQUFlLEdBQUdELFdBQVcsQ0FBQ0gsS0FBSyxDQUFFVixZQUFhLENBQUM7UUFDekRoQyxLQUFLLENBQUMrQyxvQkFBb0IsQ0FBRUQsZUFBZ0IsQ0FBQztNQUMvQyxDQUFDO01BRURFLEdBQUdBLENBQUEsRUFBRztRQUNKaEQsS0FBSyxDQUFDSyxNQUFNLENBQUNnQyxrQkFBa0IsQ0FBQ0MsR0FBRyxDQUFFLEtBQU0sQ0FBQztRQUM1Q1gsWUFBWSxDQUFDc0IsZ0JBQWdCLENBQUMsQ0FBQztNQUNqQztJQUNGLENBQUUsQ0FBQztJQUNIeEMsYUFBYSxDQUFDeUMsZ0JBQWdCLENBQUVqQixZQUFhLENBQUM7SUFFOUNqQyxLQUFLLENBQUNLLE1BQU0sQ0FBQzhDLGdCQUFnQixDQUFDQyxhQUFhLENBQUUsSUFBSSxFQUFFLGFBQWMsQ0FBQzs7SUFFbEU7SUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxJQUFJcEUsK0JBQStCLENBQUVlLEtBQUssRUFBRXlCLGFBQWEsRUFBRUUsWUFBWSxFQUFFO01BQ3BHMUIsTUFBTSxFQUFFQSxNQUFNLENBQUNNLFlBQVksQ0FBRSxzQkFBdUI7SUFDdEQsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTStDLGNBQWMsR0FBRyxJQUFJcEUsc0JBQXNCLENBQUUsTUFBTyxDQUFDO0lBQzNELE1BQU1xRSxlQUFlLEdBQUcsSUFBSXJFLHNCQUFzQixDQUFFLE9BQVEsQ0FBQztJQUM3RG9FLGNBQWMsQ0FBQ0UsZUFBZSxDQUFFLElBQUksQ0FBQ3JELFVBQVUsQ0FBQ3NELE1BQU8sQ0FBQztJQUN4REYsZUFBZSxDQUFDQyxlQUFlLENBQUUsSUFBSSxDQUFDckQsVUFBVSxDQUFDc0QsTUFBTyxDQUFDO0lBQ3pELElBQUksQ0FBQ25ELFFBQVEsQ0FBRWdELGNBQWUsQ0FBQztJQUMvQixJQUFJLENBQUNoRCxRQUFRLENBQUVpRCxlQUFnQixDQUFDOztJQUVoQztJQUNBLE1BQU1HLDBCQUEwQixHQUFHLElBQUl2RSwrQkFBK0IsQ0FBRWEsS0FBSyxFQUFFO01BQzdFMkQsU0FBU0EsQ0FBRXZCLEtBQUssRUFBRztRQUNqQixNQUFNd0IsUUFBUSxHQUFHeEIsS0FBSyxDQUFDd0IsUUFBUTs7UUFFL0I7UUFDQTtRQUNBLElBQUtwRixhQUFhLENBQUNxRixhQUFhLENBQUVELFFBQVEsRUFBRSxDQUFFcEYsYUFBYSxDQUFDc0YsS0FBSyxFQUFFdEYsYUFBYSxDQUFDdUYsS0FBSyxFQUFFdkYsYUFBYSxDQUFDd0YsS0FBSyxDQUFHLENBQUMsSUFDMUcsQ0FBQ0MsYUFBYSxDQUFFTCxRQUFTLENBQUMsRUFBRztVQUVoQzFELElBQUksQ0FBQ29CLHFCQUFxQixDQUFDRSxPQUFPLEdBQUcsSUFBSTtVQUN6Q3hCLEtBQUssQ0FBQ3FCLDJCQUEyQixDQUFDaUIsR0FBRyxDQUFFLEtBQU0sQ0FBQztVQUU5QyxNQUFNNEIsU0FBUyxHQUFHMUYsYUFBYSxDQUFDMkYsaUJBQWlCLENBQUVQLFFBQVMsQ0FBQztVQUM3RFEsTUFBTSxJQUFJQSxNQUFNLENBQUUsT0FBT0YsU0FBUyxLQUFLLFFBQVEsRUFBRSxvQkFBcUIsQ0FBQztVQUV2RSxJQUFLbEUsS0FBSyxDQUFDSyxNQUFNLENBQUM4QyxnQkFBZ0IsQ0FBQ2tCLEdBQUcsQ0FBQyxDQUFDLENBQUNDLENBQUMsR0FBR1osMEJBQTBCLENBQUNhLDJCQUEyQixDQUFDQyxLQUFLLENBQUNGLENBQUMsRUFBRztZQUM1R2YsZUFBZSxDQUFDa0IsT0FBTyxDQUFFUCxTQUFVLENBQUM7VUFDdEMsQ0FBQyxNQUNJO1lBQ0haLGNBQWMsQ0FBQ21CLE9BQU8sQ0FBRVAsU0FBVSxDQUFDO1VBQ3JDO1FBQ0Y7UUFFQSxJQUFLUiwwQkFBMEIsQ0FBQ2dCLG1CQUFtQixDQUFDTCxHQUFHLENBQUMsQ0FBQyxFQUFHO1VBQzFENUMsYUFBYSxDQUFDa0QsK0JBQStCLENBQUMsQ0FBQztRQUNqRDtNQUNGLENBQUM7TUFDREMsT0FBT0EsQ0FBRXhDLEtBQUssRUFBRztRQUNmLElBQUs1RCxhQUFhLENBQUNxRyxXQUFXLENBQUV6QyxLQUFLLENBQUN3QixRQUFTLENBQUMsRUFBRztVQUNqRDFELElBQUksQ0FBQ29CLHFCQUFxQixDQUFDRSxPQUFPLEdBQUcsS0FBSztRQUM1QztRQUNBK0IsZUFBZSxDQUFDdUIsT0FBTyxDQUFDLENBQUM7UUFDekJ4QixjQUFjLENBQUN3QixPQUFPLENBQUMsQ0FBQztNQUMxQjtJQUNGLENBQUUsQ0FBQzs7SUFFSDtJQUNBLElBQUlDLGFBQWEsR0FBRyxLQUFLO0lBQ3pCL0UsS0FBSyxDQUFDSyxNQUFNLENBQUM4QyxnQkFBZ0IsQ0FBQzZCLFFBQVEsQ0FBRSxNQUFNO01BQzVDLElBQUssQ0FBQ2hGLEtBQUssQ0FBQ2lGLHVCQUF1QixDQUFDVCxLQUFLLEVBQUc7UUFDMUNPLGFBQWEsR0FBRyxJQUFJO01BQ3RCO0lBQ0YsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTUcsYUFBYSxHQUFHO01BQ3BCQyxLQUFLLEVBQUVBLENBQUEsS0FBTTtRQUVYO1FBQ0FuRixLQUFLLENBQUNxQiwyQkFBMkIsQ0FBQ2lCLEdBQUcsQ0FBRSxLQUFNLENBQUM7TUFDaEQ7SUFDRixDQUFDOztJQUVEO0lBQ0E7SUFDQTtJQUNBLE1BQU04QyxtQkFBbUIsR0FBRyxJQUFJakgsbUJBQW1CLENBQUVzQyxhQUFhLEVBQUU0QyxvQkFBb0IsRUFBRTtNQUN4RmdDLGtCQUFrQixFQUFFM0YsZUFBZTtNQUNuQzRGLHFCQUFxQixFQUFFLENBQUU1QiwwQkFBMEIsQ0FBRTtNQUNyRDZCLHFCQUFxQixFQUFFLENBQUVMLGFBQWEsQ0FBRTtNQUN4Q00sY0FBYyxFQUFFO1FBRWQ7UUFDQUMsT0FBTyxFQUFFLENBQUM7UUFDVkMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDdkYsVUFBVSxDQUFDZ0IsTUFBTSxHQUFHO01BQ3BDLENBQUM7TUFDRHdFLE1BQU0sRUFBRUEsQ0FBQSxLQUFNO1FBQ1osSUFBSyxDQUFDWixhQUFhLEVBQUc7VUFDcEIvRSxLQUFLLENBQUNxQiwyQkFBMkIsQ0FBQ2lCLEdBQUcsQ0FBRSxJQUFLLENBQUM7UUFDL0M7UUFDQVYscUJBQXFCLENBQUNnRSxJQUFJLENBQUMsQ0FBQztNQUM5QixDQUFDO01BQ0RDLFNBQVMsRUFBRUEsQ0FBQSxLQUFNO1FBQ2YzRixJQUFJLENBQUNvQixxQkFBcUIsQ0FBQ0UsT0FBTyxHQUFHLEtBQUs7UUFDMUMrQixlQUFlLENBQUN1QixPQUFPLENBQUMsQ0FBQztRQUN6QnhCLGNBQWMsQ0FBQ3dCLE9BQU8sQ0FBQyxDQUFDO1FBQ3hCcEIsMEJBQTBCLENBQUNvQyxRQUFRLENBQUMsQ0FBQztRQUNyQy9ELHdCQUF3QixDQUFDNkQsSUFBSSxDQUFDLENBQUM7TUFDakMsQ0FBQztNQUNEM0YsTUFBTSxFQUFFQSxNQUFNLENBQUNNLFlBQVksQ0FBRSxxQkFBc0I7SUFDckQsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTXdGLHdCQUF3QixHQUFHQyxRQUFRLElBQUk7TUFDM0MsSUFBSSxDQUFDMUUscUJBQXFCLENBQUMyRSxNQUFNLEdBQUcsSUFBSSxDQUFDQyxrQkFBa0IsQ0FBRUYsUUFBUyxDQUFDO0lBQ3pFLENBQUM7O0lBRUQ7SUFDQWhHLEtBQUssQ0FBQ0ssTUFBTSxDQUFDOEYsbUJBQW1CLENBQUNDLElBQUksQ0FBRSxNQUFNO01BQzNDLElBQUksQ0FBQ2pHLFVBQVUsQ0FBQ2tHLE1BQU0sQ0FBQyxDQUFDO01BQ3hCLElBQUksQ0FBQ2xHLFVBQVUsR0FBR0MsZ0JBQWdCLENBQUVKLEtBQUssQ0FBQ0ssTUFBTyxDQUFDO01BQ2xESSxhQUFhLENBQUNILFFBQVEsQ0FBRSxJQUFJLENBQUNILFVBQVcsQ0FBQzs7TUFFekM7TUFDQSxJQUFJLENBQUNtQixxQkFBcUIsQ0FBQytFLE1BQU0sQ0FBQyxDQUFDO01BQ25DLElBQUksQ0FBQy9FLHFCQUFxQixHQUFHbEIsZ0JBQWdCLENBQUVKLEtBQUssQ0FBQ0ssTUFBTyxDQUFDO01BQzdELElBQUksQ0FBQ0MsUUFBUSxDQUFFLElBQUksQ0FBQ2dCLHFCQUFzQixDQUFDO01BQzNDLElBQUksQ0FBQ0EscUJBQXFCLENBQUNDLE9BQU8sR0FBRyxHQUFHO01BQ3hDLElBQUksQ0FBQ0QscUJBQXFCLENBQUNFLE9BQU8sR0FBRyxLQUFLO01BQzFDdUUsd0JBQXdCLENBQUVyQywwQkFBMEIsQ0FBQ2EsMkJBQTJCLENBQUNGLEdBQUcsQ0FBQyxDQUFFLENBQUM7SUFDMUYsQ0FBRSxDQUFDO0lBRUhYLDBCQUEwQixDQUFDYSwyQkFBMkIsQ0FBQzZCLElBQUksQ0FBRUwsd0JBQXlCLENBQUM7SUFFdkYsTUFBTU8sUUFBUSxHQUFHLElBQUlqSCxxQkFBcUIsQ0FBRVcsS0FBSyxFQUFFMEIsU0FBVSxDQUFDO0lBQzlELElBQUksQ0FBQ3BCLFFBQVEsQ0FBRWdHLFFBQVMsQ0FBQztJQUV6QnRHLEtBQUssQ0FBQ0ssTUFBTSxDQUFDOEYsbUJBQW1CLENBQUNuQixRQUFRLENBQUV1QixXQUFXLElBQUk7TUFDeEQ1RSxZQUFZLENBQUM2RSxlQUFlLENBQUVELFdBQVksQ0FBQztJQUM3QyxDQUFFLENBQUM7O0lBRUg7SUFDQTdDLDBCQUEwQixDQUFDZ0IsbUJBQW1CLENBQUMwQixJQUFJLENBQUVLLFdBQVcsSUFBSTtNQUNsRWhGLGFBQWEsQ0FBQ2lGLG9CQUFvQixDQUFFRCxXQUFZLENBQUM7SUFDbkQsQ0FBRSxDQUFDOztJQUVIO0lBQ0E7SUFDQTtJQUNBekcsS0FBSyxDQUFDSyxNQUFNLENBQUM4QyxnQkFBZ0IsQ0FBQ2lELElBQUksQ0FBRUosUUFBUSxJQUFJO01BQzlDLElBQUt0QywwQkFBMEIsQ0FBQ2dCLG1CQUFtQixDQUFDTCxHQUFHLENBQUMsQ0FBQyxFQUFHO1FBQzFEakcsd0JBQXdCLENBQUN1SSxRQUFRLENBQUNDLFNBQVMsQ0FBRW5HLGFBQWMsQ0FBQztNQUM5RDtJQUNGLENBQUUsQ0FBQztJQUVILElBQUksQ0FBQ2dCLGFBQWEsR0FBR0EsYUFBYTs7SUFFbEM7SUFDQXpCLEtBQUssQ0FBQ2lGLHVCQUF1QixDQUFDRCxRQUFRLENBQUU2QixlQUFlLElBQUk7TUFDekQsSUFBS0EsZUFBZSxFQUFHO1FBQ3JCOUIsYUFBYSxHQUFHLEtBQUs7UUFDckJLLG1CQUFtQixDQUFDMEIsS0FBSyxDQUFDLENBQUM7TUFDN0I7SUFDRixDQUFFLENBQUM7RUFDTDtBQUNGOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNMUcsZ0JBQWdCLEdBQUdDLE1BQU0sSUFBSTtFQUNqQyxPQUFPLElBQUliLFVBQVUsQ0FBRWEsTUFBTSxDQUFDOEYsbUJBQW1CLENBQUM5QixHQUFHLENBQUMsQ0FBQyxFQUFFO0lBQ3ZEbkQsS0FBSyxFQUFFYixNQUFNLENBQUNhLEtBQUs7SUFDbkJDLE1BQU0sRUFBRWQsTUFBTSxDQUFDYyxNQUFNO0lBQ3JCNEYsVUFBVSxFQUFFO0VBQ2QsQ0FBRSxDQUFDO0FBQ0wsQ0FBQzs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTlDLGFBQWEsR0FBR0wsUUFBUSxJQUFJO0VBQ2hDLE9BQU9BLFFBQVEsQ0FBQ29ELGdCQUFnQixDQUFFLFNBQVUsQ0FBQyxJQUFJcEQsUUFBUSxDQUFDb0QsZ0JBQWdCLENBQUUsS0FBTSxDQUFDO0FBQ3JGLENBQUM7QUFFRGxJLFdBQVcsQ0FBQ21JLFFBQVEsQ0FBRSxxQkFBcUIsRUFBRW5ILG1CQUFvQixDQUFDO0FBQ2xFLGVBQWVBLG1CQUFtQiJ9