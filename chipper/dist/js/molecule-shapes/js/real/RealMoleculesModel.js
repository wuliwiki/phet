// Copyright 2014-2022, University of Colorado Boulder

/**
 * Model for the 'Real' screen.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import Property from '../../../axon/js/Property.js';
import Vector3 from '../../../dot/js/Vector3.js';
import Tandem from '../../../tandem/js/Tandem.js';
import BooleanIO from '../../../tandem/js/types/BooleanIO.js';
import IOType from '../../../tandem/js/types/IOType.js';
import AttractorModel from '../common/model/AttractorModel.js';
import LocalShape from '../common/model/LocalShape.js';
import MoleculeShapesModel from '../common/model/MoleculeShapesModel.js';
import PairGroup from '../common/model/PairGroup.js';
import RealMolecule from '../common/model/RealMolecule.js';
import RealMoleculeShape from '../common/model/RealMoleculeShape.js';
import VSEPRConfiguration from '../common/model/VSEPRConfiguration.js';
import VSEPRMolecule from '../common/model/VSEPRMolecule.js';
import moleculeShapes from '../moleculeShapes.js';
class RealMoleculesModel extends MoleculeShapesModel {
  /**
   * @param {boolean} isBasicsVersion - Whether this is the Basics sim or not
   * @param {Tandem} tandem
   */
  constructor(isBasicsVersion, tandem) {
    const validMoleculeShapes = isBasicsVersion ? RealMoleculeShape.TAB_2_BASIC_MOLECULES : RealMoleculeShape.TAB_2_MOLECULES;
    const startingMoleculeShape = validMoleculeShapes[0];
    const startingMolecule = new RealMolecule(startingMoleculeShape);
    super(isBasicsVersion, {
      initialMolecule: startingMolecule,
      phetioType: RealMoleculesModelIO
    }, tandem);

    // @public {Property.<RealMoleculeShape>}
    this.realMoleculeShapeProperty = new Property(startingMoleculeShape, {
      tandem: tandem.createTandem('realMoleculeShapeProperty'),
      phetioValueType: RealMoleculeShape.RealMoleculeShapeIO,
      validValues: validMoleculeShapes,
      phetioState: false
    });

    // @public {Property.<boolean>} whether the "Real" or "Model" view is shown
    this.showRealViewProperty = new BooleanProperty(true, {
      tandem: isBasicsVersion ? Tandem.OPT_OUT : tandem.createTandem('showRealViewProperty'),
      phetioState: false
    });
    this.showRealViewProperty.lazyLink(() => this.rebuildMolecule(false));
    this.realMoleculeShapeProperty.lazyLink(() => {
      this.rebuildMolecule(true);
      this.moleculeQuaternionProperty.reset();
    });
  }

  /**
   * @public
   */
  reset() {
    super.reset();
    this.realMoleculeShapeProperty.reset();
    this.showRealViewProperty.reset();
    this.rebuildMolecule(true);
  }

  /*
   * Rebuilds our model molecule based on the possibly new "showRealView" or "realMoleculeShape".
   * @private
   *
   * @param {boolean} switchedRealMolecule - If false, we orient the new (model/real) view to the best match of the
   *                                         old (real/model) view. If true, the molecule type changed, so we don't
   *                                         do any matching of orientation.
   */
  rebuildMolecule(switchedRealMolecule) {
    const molecule = this.moleculeProperty.value;
    const numRadialAtoms = this.realMoleculeShapeProperty.value.centralAtomCount;
    const numRadialLonePairs = this.realMoleculeShapeProperty.value.centralAtom.lonePairCount;
    const vseprConfiguration = VSEPRConfiguration.getConfiguration(numRadialAtoms, numRadialLonePairs);

    // get a copy of what might be the "old" molecule into whose space we need to rotate into
    let mappingMolecule;
    if (switchedRealMolecule) {
      // rebuild from scratch
      mappingMolecule = new RealMolecule(this.realMoleculeShapeProperty.value);
    } else {
      // base the rotation on our original
      mappingMolecule = molecule;
    }
    let newMolecule;
    let mapping;
    if (this.showRealViewProperty.value) {
      newMolecule = new RealMolecule(this.realMoleculeShapeProperty.value);
      if (!switchedRealMolecule) {
        // NOTE: this might miss a couple improper mappings?

        // compute the mapping from our "ideal" to our "old" molecule
        const groups = new RealMolecule(this.realMoleculeShapeProperty.value).radialGroups;
        mapping = AttractorModel.findClosestMatchingConfiguration(AttractorModel.getOrientationsFromOrigin(mappingMolecule.radialGroups), _.map(groups, pair => pair.orientation), LocalShape.vseprPermutations(mappingMolecule.radialGroups));
        _.each(newMolecule.groups, group => {
          if (group !== newMolecule.centralAtom) {
            group.positionProperty.value = mapping.rotateVector(group.positionProperty.value);
          }
        });
      }
    } else {
      mapping = vseprConfiguration.getIdealGroupRotationToPositions(mappingMolecule.radialGroups);
      const permutation = mapping.permutation.inverted();
      const idealUnitVectors = vseprConfiguration.allOrientations;
      newMolecule = new VSEPRMolecule();
      const newCentralAtom = new PairGroup(new Vector3(0, 0, 0), false);
      newMolecule.addCentralAtom(newCentralAtom);
      for (let i = 0; i < numRadialAtoms + numRadialLonePairs; i++) {
        const unitVector = mapping.rotateVector(idealUnitVectors[i]);
        if (i < numRadialLonePairs) {
          newMolecule.addGroupAndBond(new PairGroup(unitVector.times(PairGroup.LONE_PAIR_DISTANCE), true), newCentralAtom, 0);
        } else {
          // we need to dig the bond order out of the mapping molecule, and we need to pick the right one (thus the permutation being applied, at an offset)
          const oldRadialGroup = mappingMolecule.radialAtoms[permutation.apply(i) - numRadialLonePairs];
          const bond = mappingMolecule.getParentBond(oldRadialGroup);
          const group = new PairGroup(unitVector.times(bond.length), false);
          newMolecule.addGroupAndBond(group, newCentralAtom, bond.order, bond.length);
          newMolecule.addTerminalLonePairs(group, _.filter(mappingMolecule.getNeighbors(oldRadialGroup), group => group.isLonePair).length);
        }
      }
    }
    if (!switchedRealMolecule) {
      newMolecule.lastMidpoint = molecule.lastMidpoint;
    }
    this.moleculeProperty.value = newMolecule;
  }
}

// Suptype IO-type so we can set the state of realMoleculeShape/showRealView BEFORE we set the rest of the molecule data
// state.
const RealMoleculesModelIO = new IOType('RealMoleculesModelIO', {
  supertype: MoleculeShapesModel.MoleculeShapesModelIO,
  valueType: RealMoleculesModel,
  stateSchema: {
    realMoleculeShape: RealMoleculeShape.RealMoleculeShapeIO,
    showRealView: BooleanIO
  },
  toStateObject: model => {
    const result = MoleculeShapesModel.MoleculeShapesModelIO.toStateObject(model);
    result.realMoleculeShape = RealMoleculeShape.RealMoleculeShapeIO.toStateObject(model.realMoleculeShapeProperty.value);
    result.showRealView = model.showRealViewProperty.value;
    return result;
  },
  applyState: (model, stateObject) => {
    model.realMoleculeShapeProperty.value = RealMoleculeShape.RealMoleculeShapeIO.fromStateObject(stateObject.realMoleculeShape);
    model.showRealViewProperty.value = stateObject.showRealView;
    MoleculeShapesModel.MoleculeShapesModelIO.applyState(model, stateObject);
  }
});

// @public {IOType}
RealMoleculesModel.RealMoleculesModelIO = RealMoleculesModelIO;
moleculeShapes.register('RealMoleculesModel', RealMoleculesModel);
export default RealMoleculesModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJQcm9wZXJ0eSIsIlZlY3RvcjMiLCJUYW5kZW0iLCJCb29sZWFuSU8iLCJJT1R5cGUiLCJBdHRyYWN0b3JNb2RlbCIsIkxvY2FsU2hhcGUiLCJNb2xlY3VsZVNoYXBlc01vZGVsIiwiUGFpckdyb3VwIiwiUmVhbE1vbGVjdWxlIiwiUmVhbE1vbGVjdWxlU2hhcGUiLCJWU0VQUkNvbmZpZ3VyYXRpb24iLCJWU0VQUk1vbGVjdWxlIiwibW9sZWN1bGVTaGFwZXMiLCJSZWFsTW9sZWN1bGVzTW9kZWwiLCJjb25zdHJ1Y3RvciIsImlzQmFzaWNzVmVyc2lvbiIsInRhbmRlbSIsInZhbGlkTW9sZWN1bGVTaGFwZXMiLCJUQUJfMl9CQVNJQ19NT0xFQ1VMRVMiLCJUQUJfMl9NT0xFQ1VMRVMiLCJzdGFydGluZ01vbGVjdWxlU2hhcGUiLCJzdGFydGluZ01vbGVjdWxlIiwiaW5pdGlhbE1vbGVjdWxlIiwicGhldGlvVHlwZSIsIlJlYWxNb2xlY3VsZXNNb2RlbElPIiwicmVhbE1vbGVjdWxlU2hhcGVQcm9wZXJ0eSIsImNyZWF0ZVRhbmRlbSIsInBoZXRpb1ZhbHVlVHlwZSIsIlJlYWxNb2xlY3VsZVNoYXBlSU8iLCJ2YWxpZFZhbHVlcyIsInBoZXRpb1N0YXRlIiwic2hvd1JlYWxWaWV3UHJvcGVydHkiLCJPUFRfT1VUIiwibGF6eUxpbmsiLCJyZWJ1aWxkTW9sZWN1bGUiLCJtb2xlY3VsZVF1YXRlcm5pb25Qcm9wZXJ0eSIsInJlc2V0Iiwic3dpdGNoZWRSZWFsTW9sZWN1bGUiLCJtb2xlY3VsZSIsIm1vbGVjdWxlUHJvcGVydHkiLCJ2YWx1ZSIsIm51bVJhZGlhbEF0b21zIiwiY2VudHJhbEF0b21Db3VudCIsIm51bVJhZGlhbExvbmVQYWlycyIsImNlbnRyYWxBdG9tIiwibG9uZVBhaXJDb3VudCIsInZzZXByQ29uZmlndXJhdGlvbiIsImdldENvbmZpZ3VyYXRpb24iLCJtYXBwaW5nTW9sZWN1bGUiLCJuZXdNb2xlY3VsZSIsIm1hcHBpbmciLCJncm91cHMiLCJyYWRpYWxHcm91cHMiLCJmaW5kQ2xvc2VzdE1hdGNoaW5nQ29uZmlndXJhdGlvbiIsImdldE9yaWVudGF0aW9uc0Zyb21PcmlnaW4iLCJfIiwibWFwIiwicGFpciIsIm9yaWVudGF0aW9uIiwidnNlcHJQZXJtdXRhdGlvbnMiLCJlYWNoIiwiZ3JvdXAiLCJwb3NpdGlvblByb3BlcnR5Iiwicm90YXRlVmVjdG9yIiwiZ2V0SWRlYWxHcm91cFJvdGF0aW9uVG9Qb3NpdGlvbnMiLCJwZXJtdXRhdGlvbiIsImludmVydGVkIiwiaWRlYWxVbml0VmVjdG9ycyIsImFsbE9yaWVudGF0aW9ucyIsIm5ld0NlbnRyYWxBdG9tIiwiYWRkQ2VudHJhbEF0b20iLCJpIiwidW5pdFZlY3RvciIsImFkZEdyb3VwQW5kQm9uZCIsInRpbWVzIiwiTE9ORV9QQUlSX0RJU1RBTkNFIiwib2xkUmFkaWFsR3JvdXAiLCJyYWRpYWxBdG9tcyIsImFwcGx5IiwiYm9uZCIsImdldFBhcmVudEJvbmQiLCJsZW5ndGgiLCJvcmRlciIsImFkZFRlcm1pbmFsTG9uZVBhaXJzIiwiZmlsdGVyIiwiZ2V0TmVpZ2hib3JzIiwiaXNMb25lUGFpciIsImxhc3RNaWRwb2ludCIsInN1cGVydHlwZSIsIk1vbGVjdWxlU2hhcGVzTW9kZWxJTyIsInZhbHVlVHlwZSIsInN0YXRlU2NoZW1hIiwicmVhbE1vbGVjdWxlU2hhcGUiLCJzaG93UmVhbFZpZXciLCJ0b1N0YXRlT2JqZWN0IiwibW9kZWwiLCJyZXN1bHQiLCJhcHBseVN0YXRlIiwic3RhdGVPYmplY3QiLCJmcm9tU3RhdGVPYmplY3QiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlJlYWxNb2xlY3VsZXNNb2RlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNb2RlbCBmb3IgdGhlICdSZWFsJyBzY3JlZW4uXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVmVjdG9yMyBmcm9tICcuLi8uLi8uLi9kb3QvanMvVmVjdG9yMy5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBCb29sZWFuSU8gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0Jvb2xlYW5JTy5qcyc7XHJcbmltcG9ydCBJT1R5cGUgZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0lPVHlwZS5qcyc7XHJcbmltcG9ydCBBdHRyYWN0b3JNb2RlbCBmcm9tICcuLi9jb21tb24vbW9kZWwvQXR0cmFjdG9yTW9kZWwuanMnO1xyXG5pbXBvcnQgTG9jYWxTaGFwZSBmcm9tICcuLi9jb21tb24vbW9kZWwvTG9jYWxTaGFwZS5qcyc7XHJcbmltcG9ydCBNb2xlY3VsZVNoYXBlc01vZGVsIGZyb20gJy4uL2NvbW1vbi9tb2RlbC9Nb2xlY3VsZVNoYXBlc01vZGVsLmpzJztcclxuaW1wb3J0IFBhaXJHcm91cCBmcm9tICcuLi9jb21tb24vbW9kZWwvUGFpckdyb3VwLmpzJztcclxuaW1wb3J0IFJlYWxNb2xlY3VsZSBmcm9tICcuLi9jb21tb24vbW9kZWwvUmVhbE1vbGVjdWxlLmpzJztcclxuaW1wb3J0IFJlYWxNb2xlY3VsZVNoYXBlIGZyb20gJy4uL2NvbW1vbi9tb2RlbC9SZWFsTW9sZWN1bGVTaGFwZS5qcyc7XHJcbmltcG9ydCBWU0VQUkNvbmZpZ3VyYXRpb24gZnJvbSAnLi4vY29tbW9uL21vZGVsL1ZTRVBSQ29uZmlndXJhdGlvbi5qcyc7XHJcbmltcG9ydCBWU0VQUk1vbGVjdWxlIGZyb20gJy4uL2NvbW1vbi9tb2RlbC9WU0VQUk1vbGVjdWxlLmpzJztcclxuaW1wb3J0IG1vbGVjdWxlU2hhcGVzIGZyb20gJy4uL21vbGVjdWxlU2hhcGVzLmpzJztcclxuXHJcbmNsYXNzIFJlYWxNb2xlY3VsZXNNb2RlbCBleHRlbmRzIE1vbGVjdWxlU2hhcGVzTW9kZWwge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNCYXNpY3NWZXJzaW9uIC0gV2hldGhlciB0aGlzIGlzIHRoZSBCYXNpY3Mgc2ltIG9yIG5vdFxyXG4gICAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggaXNCYXNpY3NWZXJzaW9uLCB0YW5kZW0gKSB7XHJcblxyXG4gICAgY29uc3QgdmFsaWRNb2xlY3VsZVNoYXBlcyA9IGlzQmFzaWNzVmVyc2lvbiA/IFJlYWxNb2xlY3VsZVNoYXBlLlRBQl8yX0JBU0lDX01PTEVDVUxFUyA6IFJlYWxNb2xlY3VsZVNoYXBlLlRBQl8yX01PTEVDVUxFUztcclxuICAgIGNvbnN0IHN0YXJ0aW5nTW9sZWN1bGVTaGFwZSA9IHZhbGlkTW9sZWN1bGVTaGFwZXNbIDAgXTtcclxuICAgIGNvbnN0IHN0YXJ0aW5nTW9sZWN1bGUgPSBuZXcgUmVhbE1vbGVjdWxlKCBzdGFydGluZ01vbGVjdWxlU2hhcGUgKTtcclxuXHJcbiAgICBzdXBlciggaXNCYXNpY3NWZXJzaW9uLCB7XHJcbiAgICAgIGluaXRpYWxNb2xlY3VsZTogc3RhcnRpbmdNb2xlY3VsZSxcclxuICAgICAgcGhldGlvVHlwZTogUmVhbE1vbGVjdWxlc01vZGVsSU9cclxuICAgIH0sIHRhbmRlbSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge1Byb3BlcnR5LjxSZWFsTW9sZWN1bGVTaGFwZT59XHJcbiAgICB0aGlzLnJlYWxNb2xlY3VsZVNoYXBlUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIHN0YXJ0aW5nTW9sZWN1bGVTaGFwZSwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdyZWFsTW9sZWN1bGVTaGFwZVByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9WYWx1ZVR5cGU6IFJlYWxNb2xlY3VsZVNoYXBlLlJlYWxNb2xlY3VsZVNoYXBlSU8sXHJcbiAgICAgIHZhbGlkVmFsdWVzOiB2YWxpZE1vbGVjdWxlU2hhcGVzLFxyXG4gICAgICBwaGV0aW9TdGF0ZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtQcm9wZXJ0eS48Ym9vbGVhbj59IHdoZXRoZXIgdGhlIFwiUmVhbFwiIG9yIFwiTW9kZWxcIiB2aWV3IGlzIHNob3duXHJcbiAgICB0aGlzLnNob3dSZWFsVmlld1Byb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSwge1xyXG4gICAgICB0YW5kZW06IGlzQmFzaWNzVmVyc2lvbiA/IFRhbmRlbS5PUFRfT1VUIDogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Nob3dSZWFsVmlld1Byb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9TdGF0ZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnNob3dSZWFsVmlld1Byb3BlcnR5LmxhenlMaW5rKCAoKSA9PiB0aGlzLnJlYnVpbGRNb2xlY3VsZSggZmFsc2UgKSApO1xyXG5cclxuICAgIHRoaXMucmVhbE1vbGVjdWxlU2hhcGVQcm9wZXJ0eS5sYXp5TGluayggKCkgPT4ge1xyXG4gICAgICB0aGlzLnJlYnVpbGRNb2xlY3VsZSggdHJ1ZSApO1xyXG4gICAgICB0aGlzLm1vbGVjdWxlUXVhdGVybmlvblByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVzZXQoKSB7XHJcbiAgICBzdXBlci5yZXNldCgpO1xyXG5cclxuICAgIHRoaXMucmVhbE1vbGVjdWxlU2hhcGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5zaG93UmVhbFZpZXdQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5yZWJ1aWxkTW9sZWN1bGUoIHRydWUgKTtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogUmVidWlsZHMgb3VyIG1vZGVsIG1vbGVjdWxlIGJhc2VkIG9uIHRoZSBwb3NzaWJseSBuZXcgXCJzaG93UmVhbFZpZXdcIiBvciBcInJlYWxNb2xlY3VsZVNoYXBlXCIuXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc3dpdGNoZWRSZWFsTW9sZWN1bGUgLSBJZiBmYWxzZSwgd2Ugb3JpZW50IHRoZSBuZXcgKG1vZGVsL3JlYWwpIHZpZXcgdG8gdGhlIGJlc3QgbWF0Y2ggb2YgdGhlXHJcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZCAocmVhbC9tb2RlbCkgdmlldy4gSWYgdHJ1ZSwgdGhlIG1vbGVjdWxlIHR5cGUgY2hhbmdlZCwgc28gd2UgZG9uJ3RcclxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gYW55IG1hdGNoaW5nIG9mIG9yaWVudGF0aW9uLlxyXG4gICAqL1xyXG4gIHJlYnVpbGRNb2xlY3VsZSggc3dpdGNoZWRSZWFsTW9sZWN1bGUgKSB7XHJcbiAgICBjb25zdCBtb2xlY3VsZSA9IHRoaXMubW9sZWN1bGVQcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICBjb25zdCBudW1SYWRpYWxBdG9tcyA9IHRoaXMucmVhbE1vbGVjdWxlU2hhcGVQcm9wZXJ0eS52YWx1ZS5jZW50cmFsQXRvbUNvdW50O1xyXG4gICAgY29uc3QgbnVtUmFkaWFsTG9uZVBhaXJzID0gdGhpcy5yZWFsTW9sZWN1bGVTaGFwZVByb3BlcnR5LnZhbHVlLmNlbnRyYWxBdG9tLmxvbmVQYWlyQ291bnQ7XHJcbiAgICBjb25zdCB2c2VwckNvbmZpZ3VyYXRpb24gPSBWU0VQUkNvbmZpZ3VyYXRpb24uZ2V0Q29uZmlndXJhdGlvbiggbnVtUmFkaWFsQXRvbXMsIG51bVJhZGlhbExvbmVQYWlycyApO1xyXG5cclxuICAgIC8vIGdldCBhIGNvcHkgb2Ygd2hhdCBtaWdodCBiZSB0aGUgXCJvbGRcIiBtb2xlY3VsZSBpbnRvIHdob3NlIHNwYWNlIHdlIG5lZWQgdG8gcm90YXRlIGludG9cclxuICAgIGxldCBtYXBwaW5nTW9sZWN1bGU7XHJcbiAgICBpZiAoIHN3aXRjaGVkUmVhbE1vbGVjdWxlICkge1xyXG4gICAgICAvLyByZWJ1aWxkIGZyb20gc2NyYXRjaFxyXG4gICAgICBtYXBwaW5nTW9sZWN1bGUgPSBuZXcgUmVhbE1vbGVjdWxlKCB0aGlzLnJlYWxNb2xlY3VsZVNoYXBlUHJvcGVydHkudmFsdWUgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAvLyBiYXNlIHRoZSByb3RhdGlvbiBvbiBvdXIgb3JpZ2luYWxcclxuICAgICAgbWFwcGluZ01vbGVjdWxlID0gbW9sZWN1bGU7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG5ld01vbGVjdWxlO1xyXG4gICAgbGV0IG1hcHBpbmc7XHJcbiAgICBpZiAoIHRoaXMuc2hvd1JlYWxWaWV3UHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgIG5ld01vbGVjdWxlID0gbmV3IFJlYWxNb2xlY3VsZSggdGhpcy5yZWFsTW9sZWN1bGVTaGFwZVByb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgIGlmICggIXN3aXRjaGVkUmVhbE1vbGVjdWxlICkge1xyXG4gICAgICAgIC8vIE5PVEU6IHRoaXMgbWlnaHQgbWlzcyBhIGNvdXBsZSBpbXByb3BlciBtYXBwaW5ncz9cclxuXHJcbiAgICAgICAgLy8gY29tcHV0ZSB0aGUgbWFwcGluZyBmcm9tIG91ciBcImlkZWFsXCIgdG8gb3VyIFwib2xkXCIgbW9sZWN1bGVcclxuICAgICAgICBjb25zdCBncm91cHMgPSBuZXcgUmVhbE1vbGVjdWxlKCB0aGlzLnJlYWxNb2xlY3VsZVNoYXBlUHJvcGVydHkudmFsdWUgKS5yYWRpYWxHcm91cHM7XHJcbiAgICAgICAgbWFwcGluZyA9IEF0dHJhY3Rvck1vZGVsLmZpbmRDbG9zZXN0TWF0Y2hpbmdDb25maWd1cmF0aW9uKFxyXG4gICAgICAgICAgQXR0cmFjdG9yTW9kZWwuZ2V0T3JpZW50YXRpb25zRnJvbU9yaWdpbiggbWFwcGluZ01vbGVjdWxlLnJhZGlhbEdyb3VwcyApLFxyXG4gICAgICAgICAgXy5tYXAoIGdyb3VwcywgcGFpciA9PiBwYWlyLm9yaWVudGF0aW9uICksXHJcbiAgICAgICAgICBMb2NhbFNoYXBlLnZzZXByUGVybXV0YXRpb25zKCBtYXBwaW5nTW9sZWN1bGUucmFkaWFsR3JvdXBzICkgKTtcclxuICAgICAgICBfLmVhY2goIG5ld01vbGVjdWxlLmdyb3VwcywgZ3JvdXAgPT4ge1xyXG4gICAgICAgICAgaWYgKCBncm91cCAhPT0gbmV3TW9sZWN1bGUuY2VudHJhbEF0b20gKSB7XHJcbiAgICAgICAgICAgIGdyb3VwLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBtYXBwaW5nLnJvdGF0ZVZlY3RvciggZ3JvdXAucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIG1hcHBpbmcgPSB2c2VwckNvbmZpZ3VyYXRpb24uZ2V0SWRlYWxHcm91cFJvdGF0aW9uVG9Qb3NpdGlvbnMoIG1hcHBpbmdNb2xlY3VsZS5yYWRpYWxHcm91cHMgKTtcclxuICAgICAgY29uc3QgcGVybXV0YXRpb24gPSBtYXBwaW5nLnBlcm11dGF0aW9uLmludmVydGVkKCk7XHJcbiAgICAgIGNvbnN0IGlkZWFsVW5pdFZlY3RvcnMgPSB2c2VwckNvbmZpZ3VyYXRpb24uYWxsT3JpZW50YXRpb25zO1xyXG5cclxuICAgICAgbmV3TW9sZWN1bGUgPSBuZXcgVlNFUFJNb2xlY3VsZSgpO1xyXG5cclxuICAgICAgY29uc3QgbmV3Q2VudHJhbEF0b20gPSBuZXcgUGFpckdyb3VwKCBuZXcgVmVjdG9yMyggMCwgMCwgMCApLCBmYWxzZSApO1xyXG4gICAgICBuZXdNb2xlY3VsZS5hZGRDZW50cmFsQXRvbSggbmV3Q2VudHJhbEF0b20gKTtcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgbnVtUmFkaWFsQXRvbXMgKyBudW1SYWRpYWxMb25lUGFpcnM7IGkrKyApIHtcclxuICAgICAgICBjb25zdCB1bml0VmVjdG9yID0gbWFwcGluZy5yb3RhdGVWZWN0b3IoIGlkZWFsVW5pdFZlY3RvcnNbIGkgXSApO1xyXG4gICAgICAgIGlmICggaSA8IG51bVJhZGlhbExvbmVQYWlycyApIHtcclxuICAgICAgICAgIG5ld01vbGVjdWxlLmFkZEdyb3VwQW5kQm9uZCggbmV3IFBhaXJHcm91cCggdW5pdFZlY3Rvci50aW1lcyggUGFpckdyb3VwLkxPTkVfUEFJUl9ESVNUQU5DRSApLCB0cnVlICksIG5ld0NlbnRyYWxBdG9tLCAwICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgLy8gd2UgbmVlZCB0byBkaWcgdGhlIGJvbmQgb3JkZXIgb3V0IG9mIHRoZSBtYXBwaW5nIG1vbGVjdWxlLCBhbmQgd2UgbmVlZCB0byBwaWNrIHRoZSByaWdodCBvbmUgKHRodXMgdGhlIHBlcm11dGF0aW9uIGJlaW5nIGFwcGxpZWQsIGF0IGFuIG9mZnNldClcclxuICAgICAgICAgIGNvbnN0IG9sZFJhZGlhbEdyb3VwID0gbWFwcGluZ01vbGVjdWxlLnJhZGlhbEF0b21zWyBwZXJtdXRhdGlvbi5hcHBseSggaSApIC0gbnVtUmFkaWFsTG9uZVBhaXJzIF07XHJcbiAgICAgICAgICBjb25zdCBib25kID0gbWFwcGluZ01vbGVjdWxlLmdldFBhcmVudEJvbmQoIG9sZFJhZGlhbEdyb3VwICk7XHJcbiAgICAgICAgICBjb25zdCBncm91cCA9IG5ldyBQYWlyR3JvdXAoIHVuaXRWZWN0b3IudGltZXMoIGJvbmQubGVuZ3RoICksIGZhbHNlICk7XHJcbiAgICAgICAgICBuZXdNb2xlY3VsZS5hZGRHcm91cEFuZEJvbmQoIGdyb3VwLCBuZXdDZW50cmFsQXRvbSwgYm9uZC5vcmRlciwgYm9uZC5sZW5ndGggKTtcclxuXHJcbiAgICAgICAgICBuZXdNb2xlY3VsZS5hZGRUZXJtaW5hbExvbmVQYWlycyggZ3JvdXAsIF8uZmlsdGVyKCBtYXBwaW5nTW9sZWN1bGUuZ2V0TmVpZ2hib3JzKCBvbGRSYWRpYWxHcm91cCApLCBncm91cCA9PiBncm91cC5pc0xvbmVQYWlyICkubGVuZ3RoICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCAhc3dpdGNoZWRSZWFsTW9sZWN1bGUgKSB7XHJcbiAgICAgIG5ld01vbGVjdWxlLmxhc3RNaWRwb2ludCA9IG1vbGVjdWxlLmxhc3RNaWRwb2ludDtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLm1vbGVjdWxlUHJvcGVydHkudmFsdWUgPSBuZXdNb2xlY3VsZTtcclxuICB9XHJcbn1cclxuXHJcbi8vIFN1cHR5cGUgSU8tdHlwZSBzbyB3ZSBjYW4gc2V0IHRoZSBzdGF0ZSBvZiByZWFsTW9sZWN1bGVTaGFwZS9zaG93UmVhbFZpZXcgQkVGT1JFIHdlIHNldCB0aGUgcmVzdCBvZiB0aGUgbW9sZWN1bGUgZGF0YVxyXG4vLyBzdGF0ZS5cclxuY29uc3QgUmVhbE1vbGVjdWxlc01vZGVsSU8gPSBuZXcgSU9UeXBlKCAnUmVhbE1vbGVjdWxlc01vZGVsSU8nLCB7XHJcbiAgc3VwZXJ0eXBlOiBNb2xlY3VsZVNoYXBlc01vZGVsLk1vbGVjdWxlU2hhcGVzTW9kZWxJTyxcclxuICB2YWx1ZVR5cGU6IFJlYWxNb2xlY3VsZXNNb2RlbCxcclxuICBzdGF0ZVNjaGVtYToge1xyXG4gICAgcmVhbE1vbGVjdWxlU2hhcGU6IFJlYWxNb2xlY3VsZVNoYXBlLlJlYWxNb2xlY3VsZVNoYXBlSU8sXHJcbiAgICBzaG93UmVhbFZpZXc6IEJvb2xlYW5JT1xyXG4gIH0sXHJcbiAgdG9TdGF0ZU9iamVjdDogbW9kZWwgPT4ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gTW9sZWN1bGVTaGFwZXNNb2RlbC5Nb2xlY3VsZVNoYXBlc01vZGVsSU8udG9TdGF0ZU9iamVjdCggbW9kZWwgKTtcclxuXHJcbiAgICByZXN1bHQucmVhbE1vbGVjdWxlU2hhcGUgPSBSZWFsTW9sZWN1bGVTaGFwZS5SZWFsTW9sZWN1bGVTaGFwZUlPLnRvU3RhdGVPYmplY3QoIG1vZGVsLnJlYWxNb2xlY3VsZVNoYXBlUHJvcGVydHkudmFsdWUgKTtcclxuICAgIHJlc3VsdC5zaG93UmVhbFZpZXcgPSBtb2RlbC5zaG93UmVhbFZpZXdQcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH0sXHJcbiAgYXBwbHlTdGF0ZTogKCBtb2RlbCwgc3RhdGVPYmplY3QgKSA9PiB7XHJcbiAgICBtb2RlbC5yZWFsTW9sZWN1bGVTaGFwZVByb3BlcnR5LnZhbHVlID0gUmVhbE1vbGVjdWxlU2hhcGUuUmVhbE1vbGVjdWxlU2hhcGVJTy5mcm9tU3RhdGVPYmplY3QoIHN0YXRlT2JqZWN0LnJlYWxNb2xlY3VsZVNoYXBlICk7XHJcbiAgICBtb2RlbC5zaG93UmVhbFZpZXdQcm9wZXJ0eS52YWx1ZSA9IHN0YXRlT2JqZWN0LnNob3dSZWFsVmlldztcclxuXHJcbiAgICBNb2xlY3VsZVNoYXBlc01vZGVsLk1vbGVjdWxlU2hhcGVzTW9kZWxJTy5hcHBseVN0YXRlKCBtb2RlbCwgc3RhdGVPYmplY3QgKTtcclxuICB9XHJcbn0gKTtcclxuXHJcbi8vIEBwdWJsaWMge0lPVHlwZX1cclxuUmVhbE1vbGVjdWxlc01vZGVsLlJlYWxNb2xlY3VsZXNNb2RlbElPID0gUmVhbE1vbGVjdWxlc01vZGVsSU87XHJcblxyXG5tb2xlY3VsZVNoYXBlcy5yZWdpc3RlciggJ1JlYWxNb2xlY3VsZXNNb2RlbCcsIFJlYWxNb2xlY3VsZXNNb2RlbCApO1xyXG5leHBvcnQgZGVmYXVsdCBSZWFsTW9sZWN1bGVzTW9kZWw7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7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