// Copyright 2016-2022, University of Colorado Boulder

/**
 * Shows a group of apples which are all the same color (green or red)
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Multilink from '../../../../../axon/js/Multilink.js';
import Utils from '../../../../../dot/js/Utils.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import { Shape } from '../../../../../kite/js/imports.js';
import StringUtils from '../../../../../phetcommon/js/util/StringUtils.js';
import { AlignBox, Image, Line, Node, Path, Text, VBox } from '../../../../../scenery/js/imports.js';
import appleRed_png from '../../../../mipmaps/appleRed_png.js';
import coin_png from '../../../../mipmaps/coin_png.js';
import crateBack_png from '../../../../mipmaps/crateBack_png.js';
import crateFront_png from '../../../../mipmaps/crateFront_png.js';
import proportionPlayground from '../../../proportionPlayground.js';
import ProportionPlaygroundStrings from '../../../ProportionPlaygroundStrings.js';
import ProportionPlaygroundConstants from '../../ProportionPlaygroundConstants.js';
import ProportionPlaygroundColors from '../ProportionPlaygroundColors.js';
import SceneRatioNode from '../SceneRatioNode.js';
const appleString = ProportionPlaygroundStrings.apple;
const pricePatternString = ProportionPlaygroundStrings.pricePattern;

// constants
const APPLE_IMAGE_SCALE = 0.35; // Reduction factor for showing the image
const COIN_IMAGE_SCALE = 0.5; // Reduction factor for showing the image
const APPLES_PER_ROW = 5;
class AppleGroupNode extends SceneRatioNode {
  /**
   * @param {AppleGroup} appleGroup - the model for the apple group
   * @param {Property.<boolean>} showCostPerAppleProperty - indicates whether the price tag should be shown
   */
  constructor(appleGroup, showCostPerAppleProperty) {
    super(appleGroup);
    const priceTagLayer = new Node();

    // Show/hide the price tag
    showCostPerAppleProperty.linkAttribute(priceTagLayer, 'visible');

    // {Image}
    const appleImageNode = new Image(appleRed_png, {
      scale: APPLE_IMAGE_SCALE
    });
    const coinImageNode = new Image(coin_png, {
      scale: COIN_IMAGE_SCALE
    });

    // {Array.<Array.<Node>>} - Array of rows, each of which is an array of apple nodes
    const appleRows = _.range(0, ProportionPlaygroundConstants.APPLE_COUNT_RANGE.max / APPLES_PER_ROW).map(row => _.range(0, APPLES_PER_ROW).map(column => new Node({
      children: [appleImageNode],
      x: (APPLES_PER_ROW - column) * appleImageNode.width * 0.8 - row * appleImageNode.width * 0.15,
      y: row * appleImageNode.height * 0.55
    })));
    const appleNodes = _.flatten(appleRows);
    const stackedAppleNodes = _.flatten(appleRows.map(row => row.slice().reverse()));
    const crateImageOffset = new Vector2(-7, -15);

    // @public {Node} - Exposed so we can properly align controls with the apples
    this.appleCrate = new Node({
      children: [new Image(crateBack_png, {
        translation: crateImageOffset
      })].concat(stackedAppleNodes).concat([new Image(crateFront_png, {
        translation: crateImageOffset
      })])
    });
    const coinNodes = _.range(0, ProportionPlaygroundConstants.APPLE_TOTAL_COST_RANGE.max).map(coinNumber => new Node({
      children: [coinImageNode],
      y: -coinNumber * coinImageNode.height / 10
    }));

    // @public {Node} - Exposed so we can properly align controls with the coins
    this.coinStack = new Node({
      children: coinNodes
    });

    // Show the grid of apples
    appleGroup.numberOfApplesProperty.link(numberOfApples => {
      appleNodes.forEach((appleNode, index) => {
        appleNode.visible = ProportionPlaygroundConstants.APPLE_COUNT_RANGE.max - index <= numberOfApples;
      });
    });

    // Show the stack of coins
    appleGroup.totalCostProperty.link(totalCost => {
      coinNodes.forEach((coinNode, index) => {
        coinNode.visible = index < totalCost;
      });
    });

    // Update the price tag
    Multilink.multilink([appleGroup.totalCostProperty, appleGroup.numberOfApplesProperty], (totalCost, numberOfApples) => {
      const pricePerApple = totalCost / numberOfApples;
      let fixed = Utils.toFixed(pricePerApple, 2);
      if (numberOfApples === 0) {
        fixed = '?';
      } else {
        fixed = StringUtils.fillIn(pricePatternString, {
          price: fixed
        });
      }
      const textOptions = {
        font: ProportionPlaygroundConstants.APPLE_PRICE_FONT,
        fill: ProportionPlaygroundColors.applePriceTagTextProperty,
        maxWidth: 200
      };
      const labelBox = new AlignBox(new VBox({
        spacing: 4,
        children: [new Text(fixed, textOptions), new Line(0, 0, 100, 0, {
          lineWidth: 2,
          stroke: ProportionPlaygroundColors.applePriceTagTextProperty
        }), new Text(appleString, textOptions)]
      }), {
        xMargin: 12,
        yMargin: 5
      });
      const labelRadius = 14;
      const labelShape = new Shape().arc(labelBox.left, labelBox.top, labelRadius, Math.PI / 2, 0, true).arc(labelBox.right, labelBox.top, labelRadius, Math.PI, Math.PI / 2, true).arc(labelBox.right, labelBox.bottom, labelRadius, -Math.PI / 2, -Math.PI, true).arc(labelBox.left, labelBox.bottom, labelRadius, 0, -Math.PI / 2, true).close();
      priceTagLayer.children = [new Path(labelShape, {
        fill: ProportionPlaygroundColors.applePriceTagBackgroundProperty,
        stroke: ProportionPlaygroundColors.applePriceTagBorderProperty,
        lineWidth: 1.5
      }), labelBox];
    });
    this.appleCrate.left = this.coinStack.right + 35;
    priceTagLayer.centerX = this.appleCrate.centerX - 20;
    this.appleCrate.bottom = this.coinStack.bottom;
    priceTagLayer.centerY = this.appleCrate.bottom - 46.5;
    this.children = [this.coinStack, this.appleCrate, priceTagLayer];
  }
}
proportionPlayground.register('AppleGroupNode', AppleGroupNode);
export default AppleGroupNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJVdGlscyIsIlZlY3RvcjIiLCJTaGFwZSIsIlN0cmluZ1V0aWxzIiwiQWxpZ25Cb3giLCJJbWFnZSIsIkxpbmUiLCJOb2RlIiwiUGF0aCIsIlRleHQiLCJWQm94IiwiYXBwbGVSZWRfcG5nIiwiY29pbl9wbmciLCJjcmF0ZUJhY2tfcG5nIiwiY3JhdGVGcm9udF9wbmciLCJwcm9wb3J0aW9uUGxheWdyb3VuZCIsIlByb3BvcnRpb25QbGF5Z3JvdW5kU3RyaW5ncyIsIlByb3BvcnRpb25QbGF5Z3JvdW5kQ29uc3RhbnRzIiwiUHJvcG9ydGlvblBsYXlncm91bmRDb2xvcnMiLCJTY2VuZVJhdGlvTm9kZSIsImFwcGxlU3RyaW5nIiwiYXBwbGUiLCJwcmljZVBhdHRlcm5TdHJpbmciLCJwcmljZVBhdHRlcm4iLCJBUFBMRV9JTUFHRV9TQ0FMRSIsIkNPSU5fSU1BR0VfU0NBTEUiLCJBUFBMRVNfUEVSX1JPVyIsIkFwcGxlR3JvdXBOb2RlIiwiY29uc3RydWN0b3IiLCJhcHBsZUdyb3VwIiwic2hvd0Nvc3RQZXJBcHBsZVByb3BlcnR5IiwicHJpY2VUYWdMYXllciIsImxpbmtBdHRyaWJ1dGUiLCJhcHBsZUltYWdlTm9kZSIsInNjYWxlIiwiY29pbkltYWdlTm9kZSIsImFwcGxlUm93cyIsIl8iLCJyYW5nZSIsIkFQUExFX0NPVU5UX1JBTkdFIiwibWF4IiwibWFwIiwicm93IiwiY29sdW1uIiwiY2hpbGRyZW4iLCJ4Iiwid2lkdGgiLCJ5IiwiaGVpZ2h0IiwiYXBwbGVOb2RlcyIsImZsYXR0ZW4iLCJzdGFja2VkQXBwbGVOb2RlcyIsInNsaWNlIiwicmV2ZXJzZSIsImNyYXRlSW1hZ2VPZmZzZXQiLCJhcHBsZUNyYXRlIiwidHJhbnNsYXRpb24iLCJjb25jYXQiLCJjb2luTm9kZXMiLCJBUFBMRV9UT1RBTF9DT1NUX1JBTkdFIiwiY29pbk51bWJlciIsImNvaW5TdGFjayIsIm51bWJlck9mQXBwbGVzUHJvcGVydHkiLCJsaW5rIiwibnVtYmVyT2ZBcHBsZXMiLCJmb3JFYWNoIiwiYXBwbGVOb2RlIiwiaW5kZXgiLCJ2aXNpYmxlIiwidG90YWxDb3N0UHJvcGVydHkiLCJ0b3RhbENvc3QiLCJjb2luTm9kZSIsIm11bHRpbGluayIsInByaWNlUGVyQXBwbGUiLCJmaXhlZCIsInRvRml4ZWQiLCJmaWxsSW4iLCJwcmljZSIsInRleHRPcHRpb25zIiwiZm9udCIsIkFQUExFX1BSSUNFX0ZPTlQiLCJmaWxsIiwiYXBwbGVQcmljZVRhZ1RleHRQcm9wZXJ0eSIsIm1heFdpZHRoIiwibGFiZWxCb3giLCJzcGFjaW5nIiwibGluZVdpZHRoIiwic3Ryb2tlIiwieE1hcmdpbiIsInlNYXJnaW4iLCJsYWJlbFJhZGl1cyIsImxhYmVsU2hhcGUiLCJhcmMiLCJsZWZ0IiwidG9wIiwiTWF0aCIsIlBJIiwicmlnaHQiLCJib3R0b20iLCJjbG9zZSIsImFwcGxlUHJpY2VUYWdCYWNrZ3JvdW5kUHJvcGVydHkiLCJhcHBsZVByaWNlVGFnQm9yZGVyUHJvcGVydHkiLCJjZW50ZXJYIiwiY2VudGVyWSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQXBwbGVHcm91cE5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogU2hvd3MgYSBncm91cCBvZiBhcHBsZXMgd2hpY2ggYXJlIGFsbCB0aGUgc2FtZSBjb2xvciAoZ3JlZW4gb3IgcmVkKVxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBTdHJpbmdVdGlscyBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3V0aWwvU3RyaW5nVXRpbHMuanMnO1xyXG5pbXBvcnQgeyBBbGlnbkJveCwgSW1hZ2UsIExpbmUsIE5vZGUsIFBhdGgsIFRleHQsIFZCb3ggfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYXBwbGVSZWRfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvYXBwbGVSZWRfcG5nLmpzJztcclxuaW1wb3J0IGNvaW5fcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvY29pbl9wbmcuanMnO1xyXG5pbXBvcnQgY3JhdGVCYWNrX3BuZyBmcm9tICcuLi8uLi8uLi8uLi9taXBtYXBzL2NyYXRlQmFja19wbmcuanMnO1xyXG5pbXBvcnQgY3JhdGVGcm9udF9wbmcgZnJvbSAnLi4vLi4vLi4vLi4vbWlwbWFwcy9jcmF0ZUZyb250X3BuZy5qcyc7XHJcbmltcG9ydCBwcm9wb3J0aW9uUGxheWdyb3VuZCBmcm9tICcuLi8uLi8uLi9wcm9wb3J0aW9uUGxheWdyb3VuZC5qcyc7XHJcbmltcG9ydCBQcm9wb3J0aW9uUGxheWdyb3VuZFN0cmluZ3MgZnJvbSAnLi4vLi4vLi4vUHJvcG9ydGlvblBsYXlncm91bmRTdHJpbmdzLmpzJztcclxuaW1wb3J0IFByb3BvcnRpb25QbGF5Z3JvdW5kQ29uc3RhbnRzIGZyb20gJy4uLy4uL1Byb3BvcnRpb25QbGF5Z3JvdW5kQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFByb3BvcnRpb25QbGF5Z3JvdW5kQ29sb3JzIGZyb20gJy4uL1Byb3BvcnRpb25QbGF5Z3JvdW5kQ29sb3JzLmpzJztcclxuaW1wb3J0IFNjZW5lUmF0aW9Ob2RlIGZyb20gJy4uL1NjZW5lUmF0aW9Ob2RlLmpzJztcclxuXHJcbmNvbnN0IGFwcGxlU3RyaW5nID0gUHJvcG9ydGlvblBsYXlncm91bmRTdHJpbmdzLmFwcGxlO1xyXG5jb25zdCBwcmljZVBhdHRlcm5TdHJpbmcgPSBQcm9wb3J0aW9uUGxheWdyb3VuZFN0cmluZ3MucHJpY2VQYXR0ZXJuO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEFQUExFX0lNQUdFX1NDQUxFID0gMC4zNTsgLy8gUmVkdWN0aW9uIGZhY3RvciBmb3Igc2hvd2luZyB0aGUgaW1hZ2VcclxuY29uc3QgQ09JTl9JTUFHRV9TQ0FMRSA9IDAuNTsgLy8gUmVkdWN0aW9uIGZhY3RvciBmb3Igc2hvd2luZyB0aGUgaW1hZ2VcclxuY29uc3QgQVBQTEVTX1BFUl9ST1cgPSA1O1xyXG5cclxuY2xhc3MgQXBwbGVHcm91cE5vZGUgZXh0ZW5kcyBTY2VuZVJhdGlvTm9kZSB7XHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtBcHBsZUdyb3VwfSBhcHBsZUdyb3VwIC0gdGhlIG1vZGVsIGZvciB0aGUgYXBwbGUgZ3JvdXBcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5Ljxib29sZWFuPn0gc2hvd0Nvc3RQZXJBcHBsZVByb3BlcnR5IC0gaW5kaWNhdGVzIHdoZXRoZXIgdGhlIHByaWNlIHRhZyBzaG91bGQgYmUgc2hvd25cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggYXBwbGVHcm91cCwgc2hvd0Nvc3RQZXJBcHBsZVByb3BlcnR5ICkge1xyXG4gICAgc3VwZXIoIGFwcGxlR3JvdXAgKTtcclxuXHJcbiAgICBjb25zdCBwcmljZVRhZ0xheWVyID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICAvLyBTaG93L2hpZGUgdGhlIHByaWNlIHRhZ1xyXG4gICAgc2hvd0Nvc3RQZXJBcHBsZVByb3BlcnR5LmxpbmtBdHRyaWJ1dGUoIHByaWNlVGFnTGF5ZXIsICd2aXNpYmxlJyApO1xyXG5cclxuICAgIC8vIHtJbWFnZX1cclxuICAgIGNvbnN0IGFwcGxlSW1hZ2VOb2RlID0gbmV3IEltYWdlKCBhcHBsZVJlZF9wbmcsIHsgc2NhbGU6IEFQUExFX0lNQUdFX1NDQUxFIH0gKTtcclxuICAgIGNvbnN0IGNvaW5JbWFnZU5vZGUgPSBuZXcgSW1hZ2UoIGNvaW5fcG5nLCB7IHNjYWxlOiBDT0lOX0lNQUdFX1NDQUxFIH0gKTtcclxuXHJcbiAgICAvLyB7QXJyYXkuPEFycmF5LjxOb2RlPj59IC0gQXJyYXkgb2Ygcm93cywgZWFjaCBvZiB3aGljaCBpcyBhbiBhcnJheSBvZiBhcHBsZSBub2Rlc1xyXG4gICAgY29uc3QgYXBwbGVSb3dzID0gXy5yYW5nZSggMCwgUHJvcG9ydGlvblBsYXlncm91bmRDb25zdGFudHMuQVBQTEVfQ09VTlRfUkFOR0UubWF4IC8gQVBQTEVTX1BFUl9ST1cgKS5tYXAoIHJvdyA9PiBfLnJhbmdlKCAwLCBBUFBMRVNfUEVSX1JPVyApLm1hcCggY29sdW1uID0+IG5ldyBOb2RlKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIGFwcGxlSW1hZ2VOb2RlIF0sXHJcbiAgICAgIHg6ICggQVBQTEVTX1BFUl9ST1cgLSBjb2x1bW4gKSAqIGFwcGxlSW1hZ2VOb2RlLndpZHRoICogMC44IC1cclxuICAgICAgICAgcm93ICogYXBwbGVJbWFnZU5vZGUud2lkdGggKiAwLjE1LFxyXG4gICAgICB5OiByb3cgKiBhcHBsZUltYWdlTm9kZS5oZWlnaHQgKiAwLjU1XHJcbiAgICB9ICkgKSApO1xyXG5cclxuICAgIGNvbnN0IGFwcGxlTm9kZXMgPSBfLmZsYXR0ZW4oIGFwcGxlUm93cyApO1xyXG5cclxuICAgIGNvbnN0IHN0YWNrZWRBcHBsZU5vZGVzID0gXy5mbGF0dGVuKCBhcHBsZVJvd3MubWFwKCByb3cgPT4gcm93LnNsaWNlKCkucmV2ZXJzZSgpICkgKTtcclxuXHJcbiAgICBjb25zdCBjcmF0ZUltYWdlT2Zmc2V0ID0gbmV3IFZlY3RvcjIoIC03LCAtMTUgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtOb2RlfSAtIEV4cG9zZWQgc28gd2UgY2FuIHByb3Blcmx5IGFsaWduIGNvbnRyb2xzIHdpdGggdGhlIGFwcGxlc1xyXG4gICAgdGhpcy5hcHBsZUNyYXRlID0gbmV3IE5vZGUoIHtcclxuICAgICAgY2hpbGRyZW46IFtcclxuICAgICAgICBuZXcgSW1hZ2UoIGNyYXRlQmFja19wbmcsIHtcclxuICAgICAgICAgIHRyYW5zbGF0aW9uOiBjcmF0ZUltYWdlT2Zmc2V0XHJcbiAgICAgICAgfSApXHJcbiAgICAgIF0uY29uY2F0KCBzdGFja2VkQXBwbGVOb2RlcyApLmNvbmNhdCggW1xyXG4gICAgICAgIG5ldyBJbWFnZSggY3JhdGVGcm9udF9wbmcsIHtcclxuICAgICAgICAgIHRyYW5zbGF0aW9uOiBjcmF0ZUltYWdlT2Zmc2V0XHJcbiAgICAgICAgfSApXHJcbiAgICAgIF0gKVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGNvaW5Ob2RlcyA9IF8ucmFuZ2UoIDAsIFByb3BvcnRpb25QbGF5Z3JvdW5kQ29uc3RhbnRzLkFQUExFX1RPVEFMX0NPU1RfUkFOR0UubWF4ICkubWFwKCBjb2luTnVtYmVyID0+IG5ldyBOb2RlKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIGNvaW5JbWFnZU5vZGUgXSxcclxuICAgICAgeTogLWNvaW5OdW1iZXIgKiBjb2luSW1hZ2VOb2RlLmhlaWdodCAvIDEwXHJcbiAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtOb2RlfSAtIEV4cG9zZWQgc28gd2UgY2FuIHByb3Blcmx5IGFsaWduIGNvbnRyb2xzIHdpdGggdGhlIGNvaW5zXHJcbiAgICB0aGlzLmNvaW5TdGFjayA9IG5ldyBOb2RlKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBjb2luTm9kZXNcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBTaG93IHRoZSBncmlkIG9mIGFwcGxlc1xyXG4gICAgYXBwbGVHcm91cC5udW1iZXJPZkFwcGxlc1Byb3BlcnR5LmxpbmsoIG51bWJlck9mQXBwbGVzID0+IHtcclxuICAgICAgYXBwbGVOb2Rlcy5mb3JFYWNoKCAoIGFwcGxlTm9kZSwgaW5kZXggKSA9PiB7XHJcbiAgICAgICAgYXBwbGVOb2RlLnZpc2libGUgPSBQcm9wb3J0aW9uUGxheWdyb3VuZENvbnN0YW50cy5BUFBMRV9DT1VOVF9SQU5HRS5tYXggLSBpbmRleCA8PSBudW1iZXJPZkFwcGxlcztcclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFNob3cgdGhlIHN0YWNrIG9mIGNvaW5zXHJcbiAgICBhcHBsZUdyb3VwLnRvdGFsQ29zdFByb3BlcnR5LmxpbmsoIHRvdGFsQ29zdCA9PiB7XHJcbiAgICAgIGNvaW5Ob2Rlcy5mb3JFYWNoKCAoIGNvaW5Ob2RlLCBpbmRleCApID0+IHtcclxuICAgICAgICBjb2luTm9kZS52aXNpYmxlID0gaW5kZXggPCB0b3RhbENvc3Q7XHJcbiAgICAgIH0gKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHByaWNlIHRhZ1xyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBhcHBsZUdyb3VwLnRvdGFsQ29zdFByb3BlcnR5LCBhcHBsZUdyb3VwLm51bWJlck9mQXBwbGVzUHJvcGVydHkgXSwgKCB0b3RhbENvc3QsIG51bWJlck9mQXBwbGVzICkgPT4ge1xyXG4gICAgICBjb25zdCBwcmljZVBlckFwcGxlID0gdG90YWxDb3N0IC8gbnVtYmVyT2ZBcHBsZXM7XHJcbiAgICAgIGxldCBmaXhlZCA9IFV0aWxzLnRvRml4ZWQoIHByaWNlUGVyQXBwbGUsIDIgKTtcclxuICAgICAgaWYgKCBudW1iZXJPZkFwcGxlcyA9PT0gMCApIHtcclxuICAgICAgICBmaXhlZCA9ICc/JztcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBmaXhlZCA9IFN0cmluZ1V0aWxzLmZpbGxJbiggcHJpY2VQYXR0ZXJuU3RyaW5nLCB7XHJcbiAgICAgICAgICBwcmljZTogZml4ZWRcclxuICAgICAgICB9ICk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdGV4dE9wdGlvbnMgPSB7XHJcbiAgICAgICAgZm9udDogUHJvcG9ydGlvblBsYXlncm91bmRDb25zdGFudHMuQVBQTEVfUFJJQ0VfRk9OVCxcclxuICAgICAgICBmaWxsOiBQcm9wb3J0aW9uUGxheWdyb3VuZENvbG9ycy5hcHBsZVByaWNlVGFnVGV4dFByb3BlcnR5LFxyXG4gICAgICAgIG1heFdpZHRoOiAyMDBcclxuICAgICAgfTtcclxuICAgICAgY29uc3QgbGFiZWxCb3ggPSBuZXcgQWxpZ25Cb3goIG5ldyBWQm94KCB7XHJcbiAgICAgICAgc3BhY2luZzogNCxcclxuICAgICAgICBjaGlsZHJlbjogW1xyXG4gICAgICAgICAgbmV3IFRleHQoIGZpeGVkLCB0ZXh0T3B0aW9ucyApLFxyXG4gICAgICAgICAgbmV3IExpbmUoIDAsIDAsIDEwMCwgMCwge1xyXG4gICAgICAgICAgICBsaW5lV2lkdGg6IDIsXHJcbiAgICAgICAgICAgIHN0cm9rZTogUHJvcG9ydGlvblBsYXlncm91bmRDb2xvcnMuYXBwbGVQcmljZVRhZ1RleHRQcm9wZXJ0eVxyXG4gICAgICAgICAgfSApLFxyXG4gICAgICAgICAgbmV3IFRleHQoIGFwcGxlU3RyaW5nLCB0ZXh0T3B0aW9ucyApXHJcbiAgICAgICAgXVxyXG4gICAgICB9ICksIHtcclxuICAgICAgICB4TWFyZ2luOiAxMixcclxuICAgICAgICB5TWFyZ2luOiA1XHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAgIGNvbnN0IGxhYmVsUmFkaXVzID0gMTQ7XHJcbiAgICAgIGNvbnN0IGxhYmVsU2hhcGUgPSBuZXcgU2hhcGUoKS5hcmMoIGxhYmVsQm94LmxlZnQsIGxhYmVsQm94LnRvcCwgbGFiZWxSYWRpdXMsIE1hdGguUEkgLyAyLCAwLCB0cnVlIClcclxuICAgICAgICAuYXJjKCBsYWJlbEJveC5yaWdodCwgbGFiZWxCb3gudG9wLCBsYWJlbFJhZGl1cywgTWF0aC5QSSwgTWF0aC5QSSAvIDIsIHRydWUgKVxyXG4gICAgICAgIC5hcmMoIGxhYmVsQm94LnJpZ2h0LCBsYWJlbEJveC5ib3R0b20sIGxhYmVsUmFkaXVzLCAtTWF0aC5QSSAvIDIsIC1NYXRoLlBJLCB0cnVlIClcclxuICAgICAgICAuYXJjKCBsYWJlbEJveC5sZWZ0LCBsYWJlbEJveC5ib3R0b20sIGxhYmVsUmFkaXVzLCAwLCAtTWF0aC5QSSAvIDIsIHRydWUgKVxyXG4gICAgICAgIC5jbG9zZSgpO1xyXG4gICAgICBwcmljZVRhZ0xheWVyLmNoaWxkcmVuID0gW1xyXG4gICAgICAgIG5ldyBQYXRoKCBsYWJlbFNoYXBlLCB7XHJcbiAgICAgICAgICBmaWxsOiBQcm9wb3J0aW9uUGxheWdyb3VuZENvbG9ycy5hcHBsZVByaWNlVGFnQmFja2dyb3VuZFByb3BlcnR5LFxyXG4gICAgICAgICAgc3Ryb2tlOiBQcm9wb3J0aW9uUGxheWdyb3VuZENvbG9ycy5hcHBsZVByaWNlVGFnQm9yZGVyUHJvcGVydHksXHJcbiAgICAgICAgICBsaW5lV2lkdGg6IDEuNVxyXG4gICAgICAgIH0gKSxcclxuICAgICAgICBsYWJlbEJveFxyXG4gICAgICBdO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYXBwbGVDcmF0ZS5sZWZ0ID0gdGhpcy5jb2luU3RhY2sucmlnaHQgKyAzNTtcclxuICAgIHByaWNlVGFnTGF5ZXIuY2VudGVyWCA9IHRoaXMuYXBwbGVDcmF0ZS5jZW50ZXJYIC0gMjA7XHJcbiAgICB0aGlzLmFwcGxlQ3JhdGUuYm90dG9tID0gdGhpcy5jb2luU3RhY2suYm90dG9tO1xyXG4gICAgcHJpY2VUYWdMYXllci5jZW50ZXJZID0gdGhpcy5hcHBsZUNyYXRlLmJvdHRvbSAtIDQ2LjU7XHJcblxyXG4gICAgdGhpcy5jaGlsZHJlbiA9IFsgdGhpcy5jb2luU3RhY2ssIHRoaXMuYXBwbGVDcmF0ZSwgcHJpY2VUYWdMYXllciBdO1xyXG4gIH1cclxufVxyXG5cclxucHJvcG9ydGlvblBsYXlncm91bmQucmVnaXN0ZXIoICdBcHBsZUdyb3VwTm9kZScsIEFwcGxlR3JvdXBOb2RlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBBcHBsZUdyb3VwTm9kZTsi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