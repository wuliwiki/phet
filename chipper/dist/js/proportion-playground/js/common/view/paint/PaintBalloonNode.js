// Copyright 2016-2023, University of Colorado Boulder

/**
 * A balloon filled with paint.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import dotRandom from '../../../../../dot/js/dotRandom.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import { Image, Node } from '../../../../../scenery/js/imports.js';
import blackBalloon1_png from '../../../../mipmaps/blackBalloon1_png.js';
import blackBalloon2_png from '../../../../mipmaps/blackBalloon2_png.js';
import blackBalloon3_png from '../../../../mipmaps/blackBalloon3_png.js';
import blueBalloon1_png from '../../../../mipmaps/blueBalloon1_png.js';
import blueBalloon2_png from '../../../../mipmaps/blueBalloon2_png.js';
import blueBalloon3_png from '../../../../mipmaps/blueBalloon3_png.js';
import redBalloon1_png from '../../../../mipmaps/redBalloon1_png.js';
import redBalloon2_png from '../../../../mipmaps/redBalloon2_png.js';
import redBalloon3_png from '../../../../mipmaps/redBalloon3_png.js';
import whiteBalloon1_png from '../../../../mipmaps/whiteBalloon1_png.js';
import whiteBalloon2_png from '../../../../mipmaps/whiteBalloon2_png.js';
import whiteBalloon3_png from '../../../../mipmaps/whiteBalloon3_png.js';
import yellowBalloon1_png from '../../../../mipmaps/yellowBalloon1_png.js';
import yellowBalloon2_png from '../../../../mipmaps/yellowBalloon2_png.js';
import yellowBalloon3_png from '../../../../mipmaps/yellowBalloon3_png.js';
import proportionPlayground from '../../../proportionPlayground.js';
import PaintChoice from '../../model/paint/PaintChoice.js';
import SplotchNode from './SplotchNode.js';

// Balloon images (color and orientation)

// Persistent {Vector2} instances, so that we don't churn GC as much
const scratchStartVector = new Vector2(0, 0);
const scratchEndVector = new Vector2(0, 0);
const scratchPosition = new Vector2(0, 0);

// {number}
const SPLOTCH_AREA = SplotchNode.getSingleSplotchArea();
const BALLOON_RADIUS = Math.sqrt(SPLOTCH_AREA / Math.PI); // A = pi * r^2, r = sqrt( A / pi )
const BALLON_IMAGE_SCALE = 2 * BALLOON_RADIUS / 130; // Assuming the balloons in the images have a diameter of 130px

// After construction, will map color.paintId => phet.scenery.Image, which will be scaled and centered around the origin.
const balloonImageMap = {};
balloonImageMap[PaintChoice.BLACK.paintId] = [blackBalloon1_png, blackBalloon2_png, blackBalloon3_png];
balloonImageMap[PaintChoice.BLUE.paintId] = [blueBalloon1_png, blueBalloon2_png, blueBalloon3_png];
balloonImageMap[PaintChoice.RED.paintId] = [redBalloon1_png, redBalloon2_png, redBalloon3_png];
balloonImageMap[PaintChoice.WHITE.paintId] = [whiteBalloon1_png, whiteBalloon2_png, whiteBalloon3_png];
balloonImageMap[PaintChoice.YELLOW.paintId] = [yellowBalloon1_png, yellowBalloon2_png, yellowBalloon3_png];
_.each(PaintChoice.COLORS, paintColor => {
  balloonImageMap[paintColor.paintId] = balloonImageMap[paintColor.paintId].map(imageElement => new Image(imageElement, {
    centerX: 0,
    centerY: 0,
    scale: BALLON_IMAGE_SCALE
  }));
});

// {number} Controls how the balloons rotate (from +halfRotation to -halfRotation or the opposite)
const HALF_ROTATION = Math.PI / 8;
class PaintBalloonNode extends Node {
  /**
   * @param {PaintBalloon} paintBalloon - Our paint balloon
   * @param {Property.<PaintChoice>} paintChoiceProperty - The current paint choice
   * @param {Vector2} startOffset - Offset from the typical starting position
   * @param {Vector2} endOffset - Offset from the typical ending position
   */
  constructor(paintBalloon, paintChoiceProperty, startOffset, endOffset) {
    super();

    // @public {PaintBalloon}
    this.paintBalloon = paintBalloon;

    // @private
    this.paintChoiceProperty = paintChoiceProperty;
    this.startOffset = startOffset;
    this.endOffset = endOffset;

    // @private {boolean} - Which direction should this balloon rotate?
    this.rotationDirection = dotRandom.nextBoolean() ? -1 : 1;

    // @private - Stored for disposal
    this.colorChoiceListener = this.updateBalloonColor.bind(this);
    this.paintChoiceProperty.link(this.colorChoiceListener);
  }

  /**
   * Positions the balloon given its start (off the screen) and end (center of splotch), with a gravity-like arc
   * @public
   *
   * @param {Vector2} startPosition
   * @param {Vector2} endPosition
   */
  position(startPosition, endPosition) {
    const ratio = this.paintBalloon.getRatioToEnd();

    // rotate from -half to half, possibly reversed
    this.rotation = this.rotationDirection * (-HALF_ROTATION + ratio * 2 * HALF_ROTATION);

    // random offsets to the start/end for realism
    startPosition = scratchStartVector.set(startPosition).add(this.startOffset);
    endPosition = scratchEndVector.set(endPosition).add(this.endOffset);

    // pseudo gravity-like acceleration
    const baseX = startPosition.x + Math.pow(ratio, 0.8) * (endPosition.x - startPosition.x);
    const baseY = startPosition.y + ratio * (endPosition.y - startPosition.y);
    const elevationY = ratio - ratio * ratio;
    scratchPosition.setXY(baseX, baseY + -600 * elevationY);
    this.center = scratchPosition;

    // fake "make the balloon look farther away", from 1/4 distance to full distance
    const distanceRatio = 0.25 + 0.75 * ratio;
    this.setScaleMagnitude(1 / distanceRatio);
  }

  /**
   * Updates the balloon's color based on the paintChoice
   * @private
   *
   * @param {PaintChoice} paintChoice
   */
  updateBalloonColor(paintChoice) {
    const colorProperty = paintChoice.getColorProperty(this.paintBalloon.side);
    this.children = [balloonImageMap[colorProperty.paintId][this.paintBalloon.balloonType]];
  }

  /**
   * Releases references.
   * @public
   * @override
   */
  dispose() {
    this.paintChoiceProperty.unlink(this.colorChoiceListener);
    super.dispose();
  }
}
proportionPlayground.register('PaintBalloonNode', PaintBalloonNode);
export default PaintBalloonNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3RSYW5kb20iLCJWZWN0b3IyIiwiSW1hZ2UiLCJOb2RlIiwiYmxhY2tCYWxsb29uMV9wbmciLCJibGFja0JhbGxvb24yX3BuZyIsImJsYWNrQmFsbG9vbjNfcG5nIiwiYmx1ZUJhbGxvb24xX3BuZyIsImJsdWVCYWxsb29uMl9wbmciLCJibHVlQmFsbG9vbjNfcG5nIiwicmVkQmFsbG9vbjFfcG5nIiwicmVkQmFsbG9vbjJfcG5nIiwicmVkQmFsbG9vbjNfcG5nIiwid2hpdGVCYWxsb29uMV9wbmciLCJ3aGl0ZUJhbGxvb24yX3BuZyIsIndoaXRlQmFsbG9vbjNfcG5nIiwieWVsbG93QmFsbG9vbjFfcG5nIiwieWVsbG93QmFsbG9vbjJfcG5nIiwieWVsbG93QmFsbG9vbjNfcG5nIiwicHJvcG9ydGlvblBsYXlncm91bmQiLCJQYWludENob2ljZSIsIlNwbG90Y2hOb2RlIiwic2NyYXRjaFN0YXJ0VmVjdG9yIiwic2NyYXRjaEVuZFZlY3RvciIsInNjcmF0Y2hQb3NpdGlvbiIsIlNQTE9UQ0hfQVJFQSIsImdldFNpbmdsZVNwbG90Y2hBcmVhIiwiQkFMTE9PTl9SQURJVVMiLCJNYXRoIiwic3FydCIsIlBJIiwiQkFMTE9OX0lNQUdFX1NDQUxFIiwiYmFsbG9vbkltYWdlTWFwIiwiQkxBQ0siLCJwYWludElkIiwiQkxVRSIsIlJFRCIsIldISVRFIiwiWUVMTE9XIiwiXyIsImVhY2giLCJDT0xPUlMiLCJwYWludENvbG9yIiwibWFwIiwiaW1hZ2VFbGVtZW50IiwiY2VudGVyWCIsImNlbnRlclkiLCJzY2FsZSIsIkhBTEZfUk9UQVRJT04iLCJQYWludEJhbGxvb25Ob2RlIiwiY29uc3RydWN0b3IiLCJwYWludEJhbGxvb24iLCJwYWludENob2ljZVByb3BlcnR5Iiwic3RhcnRPZmZzZXQiLCJlbmRPZmZzZXQiLCJyb3RhdGlvbkRpcmVjdGlvbiIsIm5leHRCb29sZWFuIiwiY29sb3JDaG9pY2VMaXN0ZW5lciIsInVwZGF0ZUJhbGxvb25Db2xvciIsImJpbmQiLCJsaW5rIiwicG9zaXRpb24iLCJzdGFydFBvc2l0aW9uIiwiZW5kUG9zaXRpb24iLCJyYXRpbyIsImdldFJhdGlvVG9FbmQiLCJyb3RhdGlvbiIsInNldCIsImFkZCIsImJhc2VYIiwieCIsInBvdyIsImJhc2VZIiwieSIsImVsZXZhdGlvblkiLCJzZXRYWSIsImNlbnRlciIsImRpc3RhbmNlUmF0aW8iLCJzZXRTY2FsZU1hZ25pdHVkZSIsInBhaW50Q2hvaWNlIiwiY29sb3JQcm9wZXJ0eSIsImdldENvbG9yUHJvcGVydHkiLCJzaWRlIiwiY2hpbGRyZW4iLCJiYWxsb29uVHlwZSIsImRpc3Bvc2UiLCJ1bmxpbmsiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBhaW50QmFsbG9vbk5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBiYWxsb29uIGZpbGxlZCB3aXRoIHBhaW50LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBJbWFnZSwgTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBibGFja0JhbGxvb24xX3BuZyBmcm9tICcuLi8uLi8uLi8uLi9taXBtYXBzL2JsYWNrQmFsbG9vbjFfcG5nLmpzJztcclxuaW1wb3J0IGJsYWNrQmFsbG9vbjJfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvYmxhY2tCYWxsb29uMl9wbmcuanMnO1xyXG5pbXBvcnQgYmxhY2tCYWxsb29uM19wbmcgZnJvbSAnLi4vLi4vLi4vLi4vbWlwbWFwcy9ibGFja0JhbGxvb24zX3BuZy5qcyc7XHJcbmltcG9ydCBibHVlQmFsbG9vbjFfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvYmx1ZUJhbGxvb24xX3BuZy5qcyc7XHJcbmltcG9ydCBibHVlQmFsbG9vbjJfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvYmx1ZUJhbGxvb24yX3BuZy5qcyc7XHJcbmltcG9ydCBibHVlQmFsbG9vbjNfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvYmx1ZUJhbGxvb24zX3BuZy5qcyc7XHJcbmltcG9ydCByZWRCYWxsb29uMV9wbmcgZnJvbSAnLi4vLi4vLi4vLi4vbWlwbWFwcy9yZWRCYWxsb29uMV9wbmcuanMnO1xyXG5pbXBvcnQgcmVkQmFsbG9vbjJfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvcmVkQmFsbG9vbjJfcG5nLmpzJztcclxuaW1wb3J0IHJlZEJhbGxvb24zX3BuZyBmcm9tICcuLi8uLi8uLi8uLi9taXBtYXBzL3JlZEJhbGxvb24zX3BuZy5qcyc7XHJcbmltcG9ydCB3aGl0ZUJhbGxvb24xX3BuZyBmcm9tICcuLi8uLi8uLi8uLi9taXBtYXBzL3doaXRlQmFsbG9vbjFfcG5nLmpzJztcclxuaW1wb3J0IHdoaXRlQmFsbG9vbjJfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMvd2hpdGVCYWxsb29uMl9wbmcuanMnO1xyXG5pbXBvcnQgd2hpdGVCYWxsb29uM19wbmcgZnJvbSAnLi4vLi4vLi4vLi4vbWlwbWFwcy93aGl0ZUJhbGxvb24zX3BuZy5qcyc7XHJcbmltcG9ydCB5ZWxsb3dCYWxsb29uMV9wbmcgZnJvbSAnLi4vLi4vLi4vLi4vbWlwbWFwcy95ZWxsb3dCYWxsb29uMV9wbmcuanMnO1xyXG5pbXBvcnQgeWVsbG93QmFsbG9vbjJfcG5nIGZyb20gJy4uLy4uLy4uLy4uL21pcG1hcHMveWVsbG93QmFsbG9vbjJfcG5nLmpzJztcclxuaW1wb3J0IHllbGxvd0JhbGxvb24zX3BuZyBmcm9tICcuLi8uLi8uLi8uLi9taXBtYXBzL3llbGxvd0JhbGxvb24zX3BuZy5qcyc7XHJcbmltcG9ydCBwcm9wb3J0aW9uUGxheWdyb3VuZCBmcm9tICcuLi8uLi8uLi9wcm9wb3J0aW9uUGxheWdyb3VuZC5qcyc7XHJcbmltcG9ydCBQYWludENob2ljZSBmcm9tICcuLi8uLi9tb2RlbC9wYWludC9QYWludENob2ljZS5qcyc7XHJcbmltcG9ydCBTcGxvdGNoTm9kZSBmcm9tICcuL1NwbG90Y2hOb2RlLmpzJztcclxuXHJcbi8vIEJhbGxvb24gaW1hZ2VzIChjb2xvciBhbmQgb3JpZW50YXRpb24pXHJcblxyXG4vLyBQZXJzaXN0ZW50IHtWZWN0b3IyfSBpbnN0YW5jZXMsIHNvIHRoYXQgd2UgZG9uJ3QgY2h1cm4gR0MgYXMgbXVjaFxyXG5jb25zdCBzY3JhdGNoU3RhcnRWZWN0b3IgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG5jb25zdCBzY3JhdGNoRW5kVmVjdG9yID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuY29uc3Qgc2NyYXRjaFBvc2l0aW9uID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuXHJcbi8vIHtudW1iZXJ9XHJcbmNvbnN0IFNQTE9UQ0hfQVJFQSA9IFNwbG90Y2hOb2RlLmdldFNpbmdsZVNwbG90Y2hBcmVhKCk7XHJcbmNvbnN0IEJBTExPT05fUkFESVVTID0gTWF0aC5zcXJ0KCBTUExPVENIX0FSRUEgLyBNYXRoLlBJICk7IC8vIEEgPSBwaSAqIHJeMiwgciA9IHNxcnQoIEEgLyBwaSApXHJcbmNvbnN0IEJBTExPTl9JTUFHRV9TQ0FMRSA9IDIgKiBCQUxMT09OX1JBRElVUyAvIDEzMDsgLy8gQXNzdW1pbmcgdGhlIGJhbGxvb25zIGluIHRoZSBpbWFnZXMgaGF2ZSBhIGRpYW1ldGVyIG9mIDEzMHB4XHJcblxyXG4vLyBBZnRlciBjb25zdHJ1Y3Rpb24sIHdpbGwgbWFwIGNvbG9yLnBhaW50SWQgPT4gcGhldC5zY2VuZXJ5LkltYWdlLCB3aGljaCB3aWxsIGJlIHNjYWxlZCBhbmQgY2VudGVyZWQgYXJvdW5kIHRoZSBvcmlnaW4uXHJcbmNvbnN0IGJhbGxvb25JbWFnZU1hcCA9IHt9O1xyXG5iYWxsb29uSW1hZ2VNYXBbIFBhaW50Q2hvaWNlLkJMQUNLLnBhaW50SWQgXSA9IFsgYmxhY2tCYWxsb29uMV9wbmcsIGJsYWNrQmFsbG9vbjJfcG5nLCBibGFja0JhbGxvb24zX3BuZyBdO1xyXG5iYWxsb29uSW1hZ2VNYXBbIFBhaW50Q2hvaWNlLkJMVUUucGFpbnRJZCBdID0gWyBibHVlQmFsbG9vbjFfcG5nLCBibHVlQmFsbG9vbjJfcG5nLCBibHVlQmFsbG9vbjNfcG5nIF07XHJcbmJhbGxvb25JbWFnZU1hcFsgUGFpbnRDaG9pY2UuUkVELnBhaW50SWQgXSA9IFsgcmVkQmFsbG9vbjFfcG5nLCByZWRCYWxsb29uMl9wbmcsIHJlZEJhbGxvb24zX3BuZyBdO1xyXG5iYWxsb29uSW1hZ2VNYXBbIFBhaW50Q2hvaWNlLldISVRFLnBhaW50SWQgXSA9IFsgd2hpdGVCYWxsb29uMV9wbmcsIHdoaXRlQmFsbG9vbjJfcG5nLCB3aGl0ZUJhbGxvb24zX3BuZyBdO1xyXG5iYWxsb29uSW1hZ2VNYXBbIFBhaW50Q2hvaWNlLllFTExPVy5wYWludElkIF0gPSBbIHllbGxvd0JhbGxvb24xX3BuZywgeWVsbG93QmFsbG9vbjJfcG5nLCB5ZWxsb3dCYWxsb29uM19wbmcgXTtcclxuXy5lYWNoKCBQYWludENob2ljZS5DT0xPUlMsIHBhaW50Q29sb3IgPT4ge1xyXG4gIGJhbGxvb25JbWFnZU1hcFsgcGFpbnRDb2xvci5wYWludElkIF0gPSBiYWxsb29uSW1hZ2VNYXBbIHBhaW50Q29sb3IucGFpbnRJZCBdLm1hcCggaW1hZ2VFbGVtZW50ID0+IG5ldyBJbWFnZSggaW1hZ2VFbGVtZW50LCB7XHJcbiAgICBjZW50ZXJYOiAwLFxyXG4gICAgY2VudGVyWTogMCxcclxuICAgIHNjYWxlOiBCQUxMT05fSU1BR0VfU0NBTEVcclxuICB9ICkgKTtcclxufSApO1xyXG5cclxuLy8ge251bWJlcn0gQ29udHJvbHMgaG93IHRoZSBiYWxsb29ucyByb3RhdGUgKGZyb20gK2hhbGZSb3RhdGlvbiB0byAtaGFsZlJvdGF0aW9uIG9yIHRoZSBvcHBvc2l0ZSlcclxuY29uc3QgSEFMRl9ST1RBVElPTiA9IE1hdGguUEkgLyA4O1xyXG5cclxuY2xhc3MgUGFpbnRCYWxsb29uTm9kZSBleHRlbmRzIE5vZGUge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7UGFpbnRCYWxsb29ufSBwYWludEJhbGxvb24gLSBPdXIgcGFpbnQgYmFsbG9vblxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPFBhaW50Q2hvaWNlPn0gcGFpbnRDaG9pY2VQcm9wZXJ0eSAtIFRoZSBjdXJyZW50IHBhaW50IGNob2ljZVxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gc3RhcnRPZmZzZXQgLSBPZmZzZXQgZnJvbSB0aGUgdHlwaWNhbCBzdGFydGluZyBwb3NpdGlvblxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gZW5kT2Zmc2V0IC0gT2Zmc2V0IGZyb20gdGhlIHR5cGljYWwgZW5kaW5nIHBvc2l0aW9uXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHBhaW50QmFsbG9vbiwgcGFpbnRDaG9pY2VQcm9wZXJ0eSwgc3RhcnRPZmZzZXQsIGVuZE9mZnNldCApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7UGFpbnRCYWxsb29ufVxyXG4gICAgdGhpcy5wYWludEJhbGxvb24gPSBwYWludEJhbGxvb247XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMucGFpbnRDaG9pY2VQcm9wZXJ0eSA9IHBhaW50Q2hvaWNlUHJvcGVydHk7XHJcbiAgICB0aGlzLnN0YXJ0T2Zmc2V0ID0gc3RhcnRPZmZzZXQ7XHJcbiAgICB0aGlzLmVuZE9mZnNldCA9IGVuZE9mZnNldDtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Ym9vbGVhbn0gLSBXaGljaCBkaXJlY3Rpb24gc2hvdWxkIHRoaXMgYmFsbG9vbiByb3RhdGU/XHJcbiAgICB0aGlzLnJvdGF0aW9uRGlyZWN0aW9uID0gZG90UmFuZG9tLm5leHRCb29sZWFuKCkgPyAtMSA6IDE7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBTdG9yZWQgZm9yIGRpc3Bvc2FsXHJcbiAgICB0aGlzLmNvbG9yQ2hvaWNlTGlzdGVuZXIgPSB0aGlzLnVwZGF0ZUJhbGxvb25Db2xvci5iaW5kKCB0aGlzICk7XHJcbiAgICB0aGlzLnBhaW50Q2hvaWNlUHJvcGVydHkubGluayggdGhpcy5jb2xvckNob2ljZUxpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQb3NpdGlvbnMgdGhlIGJhbGxvb24gZ2l2ZW4gaXRzIHN0YXJ0IChvZmYgdGhlIHNjcmVlbikgYW5kIGVuZCAoY2VudGVyIG9mIHNwbG90Y2gpLCB3aXRoIGEgZ3Jhdml0eS1saWtlIGFyY1xyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gc3RhcnRQb3NpdGlvblxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gZW5kUG9zaXRpb25cclxuICAgKi9cclxuICBwb3NpdGlvbiggc3RhcnRQb3NpdGlvbiwgZW5kUG9zaXRpb24gKSB7XHJcbiAgICBjb25zdCByYXRpbyA9IHRoaXMucGFpbnRCYWxsb29uLmdldFJhdGlvVG9FbmQoKTtcclxuXHJcbiAgICAvLyByb3RhdGUgZnJvbSAtaGFsZiB0byBoYWxmLCBwb3NzaWJseSByZXZlcnNlZFxyXG4gICAgdGhpcy5yb3RhdGlvbiA9IHRoaXMucm90YXRpb25EaXJlY3Rpb24gKiAoIC1IQUxGX1JPVEFUSU9OICsgcmF0aW8gKiAyICogSEFMRl9ST1RBVElPTiApO1xyXG5cclxuICAgIC8vIHJhbmRvbSBvZmZzZXRzIHRvIHRoZSBzdGFydC9lbmQgZm9yIHJlYWxpc21cclxuICAgIHN0YXJ0UG9zaXRpb24gPSBzY3JhdGNoU3RhcnRWZWN0b3Iuc2V0KCBzdGFydFBvc2l0aW9uICkuYWRkKCB0aGlzLnN0YXJ0T2Zmc2V0ICk7XHJcbiAgICBlbmRQb3NpdGlvbiA9IHNjcmF0Y2hFbmRWZWN0b3Iuc2V0KCBlbmRQb3NpdGlvbiApLmFkZCggdGhpcy5lbmRPZmZzZXQgKTtcclxuXHJcbiAgICAvLyBwc2V1ZG8gZ3Jhdml0eS1saWtlIGFjY2VsZXJhdGlvblxyXG4gICAgY29uc3QgYmFzZVggPSBzdGFydFBvc2l0aW9uLnggKyBNYXRoLnBvdyggcmF0aW8sIDAuOCApICogKCBlbmRQb3NpdGlvbi54IC0gc3RhcnRQb3NpdGlvbi54ICk7XHJcbiAgICBjb25zdCBiYXNlWSA9IHN0YXJ0UG9zaXRpb24ueSArIHJhdGlvICogKCBlbmRQb3NpdGlvbi55IC0gc3RhcnRQb3NpdGlvbi55ICk7XHJcbiAgICBjb25zdCBlbGV2YXRpb25ZID0gcmF0aW8gLSByYXRpbyAqIHJhdGlvO1xyXG4gICAgc2NyYXRjaFBvc2l0aW9uLnNldFhZKCBiYXNlWCwgYmFzZVkgKyAtNjAwICogZWxldmF0aW9uWSApO1xyXG5cclxuICAgIHRoaXMuY2VudGVyID0gc2NyYXRjaFBvc2l0aW9uO1xyXG5cclxuICAgIC8vIGZha2UgXCJtYWtlIHRoZSBiYWxsb29uIGxvb2sgZmFydGhlciBhd2F5XCIsIGZyb20gMS80IGRpc3RhbmNlIHRvIGZ1bGwgZGlzdGFuY2VcclxuICAgIGNvbnN0IGRpc3RhbmNlUmF0aW8gPSAwLjI1ICsgMC43NSAqIHJhdGlvO1xyXG4gICAgdGhpcy5zZXRTY2FsZU1hZ25pdHVkZSggMSAvIGRpc3RhbmNlUmF0aW8gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhlIGJhbGxvb24ncyBjb2xvciBiYXNlZCBvbiB0aGUgcGFpbnRDaG9pY2VcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtQYWludENob2ljZX0gcGFpbnRDaG9pY2VcclxuICAgKi9cclxuICB1cGRhdGVCYWxsb29uQ29sb3IoIHBhaW50Q2hvaWNlICkge1xyXG4gICAgY29uc3QgY29sb3JQcm9wZXJ0eSA9IHBhaW50Q2hvaWNlLmdldENvbG9yUHJvcGVydHkoIHRoaXMucGFpbnRCYWxsb29uLnNpZGUgKTtcclxuICAgIHRoaXMuY2hpbGRyZW4gPSBbIGJhbGxvb25JbWFnZU1hcFsgY29sb3JQcm9wZXJ0eS5wYWludElkIF1bIHRoaXMucGFpbnRCYWxsb29uLmJhbGxvb25UeXBlIF0gXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbGVhc2VzIHJlZmVyZW5jZXMuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLnBhaW50Q2hvaWNlUHJvcGVydHkudW5saW5rKCB0aGlzLmNvbG9yQ2hvaWNlTGlzdGVuZXIgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbnByb3BvcnRpb25QbGF5Z3JvdW5kLnJlZ2lzdGVyKCAnUGFpbnRCYWxsb29uTm9kZScsIFBhaW50QmFsbG9vbk5vZGUgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFBhaW50QmFsbG9vbk5vZGU7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0sb0NBQW9DO0FBQzFELE9BQU9DLE9BQU8sTUFBTSxrQ0FBa0M7QUFDdEQsU0FBU0MsS0FBSyxFQUFFQyxJQUFJLFFBQVEsc0NBQXNDO0FBQ2xFLE9BQU9DLGlCQUFpQixNQUFNLDBDQUEwQztBQUN4RSxPQUFPQyxpQkFBaUIsTUFBTSwwQ0FBMEM7QUFDeEUsT0FBT0MsaUJBQWlCLE1BQU0sMENBQTBDO0FBQ3hFLE9BQU9DLGdCQUFnQixNQUFNLHlDQUF5QztBQUN0RSxPQUFPQyxnQkFBZ0IsTUFBTSx5Q0FBeUM7QUFDdEUsT0FBT0MsZ0JBQWdCLE1BQU0seUNBQXlDO0FBQ3RFLE9BQU9DLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxl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