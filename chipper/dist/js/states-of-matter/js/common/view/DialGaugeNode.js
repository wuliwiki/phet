// Copyright 2014-2023, University of Colorado Boulder

/**
 * This class represents a node that displays a dial gauge, which is a circular instrument that can be used to portray
 * measurements of temperature, pressure, etc.
 *
 * @author John Blanco
 * @author Siddhartha Chinthapally (Actual Concepts)
 */

import stepTimer from '../../../../axon/js/stepTimer.js';
import Range from '../../../../dot/js/Range.js';
import Utils from '../../../../dot/js/Utils.js';
import { Shape } from '../../../../kite/js/imports.js';
import GaugeNode from '../../../../scenery-phet/js/GaugeNode.js';
import PhetColorScheme from '../../../../scenery-phet/js/PhetColorScheme.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { LinearGradient, Node, Path, Rectangle, Text } from '../../../../scenery/js/imports.js';
import statesOfMatter from '../../statesOfMatter.js';
import StatesOfMatterStrings from '../../StatesOfMatterStrings.js';

// strings
const pressureOverloadString = StatesOfMatterStrings.pressureOverload;
const pressureStringProperty = StatesOfMatterStrings.pressureStringProperty;
const pressureUnitsInAtmString = StatesOfMatterStrings.pressureUnitsInAtm;

// constants
const CONNECTOR_LENGTH_PROPORTION = 1; // Length of non-elbowed connector wrt overall diameter.
const CONNECTOR_WIDTH_PROPORTION = 0.2; // Width of connector wrt overall diameter.
const MAX_PRESSURE = 200; // in atm units
const ELBOW_WIDTH = CONNECTOR_WIDTH_PROPORTION * 30;
const ELBOW_LENGTH = CONNECTOR_LENGTH_PROPORTION * 60;
const PRESSURE_UPDATE_PERIOD = 100; // in milliseconds

class DialGaugeNode extends Node {
  /**
   * @param {MultipleParticleModel} multipleParticleModel - model of the simulation
   * @param {Tandem} tandem
   */
  constructor(multipleParticleModel, tandem) {
    super({
      tandem: tandem
    });
    this.elbowHeight = 0; // @private, set through accessor methods

    const gaugeNode = new GaugeNode(multipleParticleModel.pressureProperty, pressureStringProperty, new Range(0, MAX_PRESSURE), {
      scale: 0.5,
      radius: 80,
      backgroundLineWidth: 3,
      tandem: tandem.createTandem('gaugeNode')
    });

    // Add the textual readout display.
    const readoutNode = new Rectangle(0, 0, 80, 15, 2, 2, {
      fill: 'white',
      stroke: 'black',
      centerX: gaugeNode.centerX,
      top: gaugeNode.bottom - 15,
      tandem: tandem.createTandem('readoutNode')
    });
    const readoutText = new Text('0', {
      font: new PhetFont(12),
      fill: 'black',
      maxWidth: readoutNode.width * 0.9,
      centerX: readoutNode.width / 2,
      centerY: readoutNode.height / 2
    });
    readoutNode.addChild(readoutText);

    // Create a link to pressureProperty so it's easier to find in Studio.
    this.addLinkedElement(multipleParticleModel.pressureProperty, {
      tandem: readoutNode.tandem.createTandem('pressureProperty')
    });

    // To accurately reproduce the previous version (which consisted of a path stroked with lineWidth 10), we need to
    // include the stroke width effects (where it had a default lineCap of butt). We have a part that doesn't change
    // shape (the connector) which includes the left part and the curve, and then an overlapping dynamic rectangle
    // (the connectorExtension) whose height is adjusted to be the elbowHeight. This reduces the overhead significantly.
    const halfStroke = 5;
    const connector = new Path(new Shape().moveTo(0, -halfStroke).lineTo(ELBOW_LENGTH + ELBOW_WIDTH / 2, -halfStroke).quadraticCurveTo(ELBOW_LENGTH + ELBOW_WIDTH + halfStroke, -halfStroke, ELBOW_LENGTH + ELBOW_WIDTH + halfStroke, ELBOW_WIDTH / 2).lineTo(ELBOW_LENGTH - halfStroke, ELBOW_WIDTH + halfStroke).lineTo(0, ELBOW_WIDTH + halfStroke).close(), {
      fill: '#ddd'
    });
    this.connectorExtension = new Rectangle(ELBOW_LENGTH - halfStroke, ELBOW_WIDTH / 2, ELBOW_WIDTH + 2 * halfStroke, 0, {
      fill: '#ddd'
    });
    connector.addChild(this.connectorExtension);
    const connectorCollar = new Rectangle(0, 0, 30, 25, 2, 2, {
      fill: new LinearGradient(0, 0, 0, 25).addColorStop(0, 'rgb( 120, 120, 120 )').addColorStop(0.3, 'rgb( 220, 220, 220 )').addColorStop(0.5, 'rgb( 220, 220, 220 )').addColorStop(1, 'rgb( 100, 100, 100 )')
    });
    connectorCollar.centerY = gaugeNode.centerY;
    connectorCollar.left = gaugeNode.right - 10;
    const dialComponentsNode = new Node({
      children: [connector, connectorCollar, gaugeNode, readoutNode]
    });

    // Keep track of the previous pressure value so that we can determine when changes have occurred.
    let previousPressure = -1;

    // closure to update the readout text
    const updateReadoutText = () => {
      const pressure = multipleParticleModel.pressureProperty.get();
      if (pressure !== previousPressure) {
        if (pressure < MAX_PRESSURE) {
          readoutText.setString(`${Utils.toFixed(pressure, 1)} ${pressureUnitsInAtmString}`);
          readoutText.fill = 'black';
        } else {
          readoutText.setString(pressureOverloadString);
          readoutText.fill = PhetColorScheme.RED_COLORBLIND;
        }
        previousPressure = pressure;
      }
      readoutText.centerX = readoutNode.width / 2;
    };

    // Do the initial update of the readout.
    updateReadoutText();

    // Update the pressure readout at regular intervals.  This was done rather than listening to the pressure property
    // because the readout changes too quickly in that case.
    stepTimer.setInterval(updateReadoutText, PRESSURE_UPDATE_PERIOD);

    // If state is being set via phet-io, then it is necessary to update the readout when  pressureProperty changes since
    // the timer may not be running.
    multipleParticleModel.pressureProperty.link(() => {
      if (phet.joist.sim.isSettingPhetioStateProperty.value) {
        updateReadoutText();
      }
    });

    // position the connector
    connector.setTranslation(connectorCollar.centerX + connectorCollar.width / 2, connectorCollar.centerY - CONNECTOR_WIDTH_PROPORTION * 30 / 2);

    // Do the initial update of the connector.
    this.updateConnector();

    // Add the dial as a child of the main node.
    this.addChild(dialComponentsNode);
  }

  /**
   * Set the height of the elbow.  Height is specified with respect to the vertical center of the node.
   * @param {number} height
   * @public
   */
  setElbowHeight(height) {
    this.elbowHeight = height;
    this.updateConnector();
  }

  /**
   * @public
   */
  updateConnector() {
    this.connectorExtension.rectHeight = this.elbowHeight;
  }
}
statesOfMatter.register('DialGaugeNode', DialGaugeNode);
export default DialGaugeNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdGVwVGltZXIiLCJSYW5nZSIsIlV0aWxzIiwiU2hhcGUiLCJHYXVnZU5vZGUiLCJQaGV0Q29sb3JTY2hlbWUiLCJQaGV0Rm9udCIsIkxpbmVhckdyYWRpZW50IiwiTm9kZSIsIlBhdGgiLCJSZWN0YW5nbGUiLCJUZXh0Iiwic3RhdGVzT2ZNYXR0ZXIiLCJTdGF0ZXNPZk1hdHRlclN0cmluZ3MiLCJwcmVzc3VyZU92ZXJsb2FkU3RyaW5nIiwicHJlc3N1cmVPdmVybG9hZCIsInByZXNzdXJlU3RyaW5nUHJvcGVydHkiLCJwcmVzc3VyZVVuaXRzSW5BdG1TdHJpbmciLCJwcmVzc3VyZVVuaXRzSW5BdG0iLCJDT05ORUNUT1JfTEVOR1RIX1BST1BPUlRJT04iLCJDT05ORUNUT1JfV0lEVEhfUFJPUE9SVElPTiIsIk1BWF9QUkVTU1VSRSIsIkVMQk9XX1dJRFRIIiwiRUxCT1dfTEVOR1RIIiwiUFJFU1NVUkVfVVBEQVRFX1BFUklPRCIsIkRpYWxHYXVnZU5vZGUiLCJjb25zdHJ1Y3RvciIsIm11bHRpcGxlUGFydGljbGVNb2RlbCIsInRhbmRlbSIsImVsYm93SGVpZ2h0IiwiZ2F1Z2VOb2RlIiwicHJlc3N1cmVQcm9wZXJ0eSIsInNjYWxlIiwicmFkaXVzIiwiYmFja2dyb3VuZExpbmVXaWR0aCIsImNyZWF0ZVRhbmRlbSIsInJlYWRvdXROb2RlIiwiZmlsbCIsInN0cm9rZSIsImNlbnRlclgiLCJ0b3AiLCJib3R0b20iLCJyZWFkb3V0VGV4dCIsImZvbnQiLCJtYXhXaWR0aCIsIndpZHRoIiwiY2VudGVyWSIsImhlaWdodCIsImFkZENoaWxkIiwiYWRkTGlua2VkRWxlbWVudCIsImhhbGZTdHJva2UiLCJjb25uZWN0b3IiLCJtb3ZlVG8iLCJsaW5lVG8iLCJxdWFkcmF0aWNDdXJ2ZVRvIiwiY2xvc2UiLCJjb25uZWN0b3JFeHRlbnNpb24iLCJjb25uZWN0b3JDb2xsYXIiLCJhZGRDb2xvclN0b3AiLCJsZWZ0IiwicmlnaHQiLCJkaWFsQ29tcG9uZW50c05vZGUiLCJjaGlsZHJlbiIsInByZXZpb3VzUHJlc3N1cmUiLCJ1cGRhdGVSZWFkb3V0VGV4dCIsInByZXNzdXJlIiwiZ2V0Iiwic2V0U3RyaW5nIiwidG9GaXhlZCIsIlJFRF9DT0xPUkJMSU5EIiwic2V0SW50ZXJ2YWwiLCJsaW5rIiwicGhldCIsImpvaXN0Iiwic2ltIiwiaXNTZXR0aW5nUGhldGlvU3RhdGVQcm9wZXJ0eSIsInZhbHVlIiwic2V0VHJhbnNsYXRpb24iLCJ1cGRhdGVDb25uZWN0b3IiLCJzZXRFbGJvd0hlaWdodCIsInJlY3RIZWlnaHQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkRpYWxHYXVnZU5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVGhpcyBjbGFzcyByZXByZXNlbnRzIGEgbm9kZSB0aGF0IGRpc3BsYXlzIGEgZGlhbCBnYXVnZSwgd2hpY2ggaXMgYSBjaXJjdWxhciBpbnN0cnVtZW50IHRoYXQgY2FuIGJlIHVzZWQgdG8gcG9ydHJheVxyXG4gKiBtZWFzdXJlbWVudHMgb2YgdGVtcGVyYXR1cmUsIHByZXNzdXJlLCBldGMuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY29cclxuICogQGF1dGhvciBTaWRkaGFydGhhIENoaW50aGFwYWxseSAoQWN0dWFsIENvbmNlcHRzKVxyXG4gKi9cclxuXHJcbmltcG9ydCBzdGVwVGltZXIgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9zdGVwVGltZXIuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IEdhdWdlTm9kZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvR2F1Z2VOb2RlLmpzJztcclxuaW1wb3J0IFBoZXRDb2xvclNjaGVtZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldENvbG9yU2NoZW1lLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IExpbmVhckdyYWRpZW50LCBOb2RlLCBQYXRoLCBSZWN0YW5nbGUsIFRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgc3RhdGVzT2ZNYXR0ZXIgZnJvbSAnLi4vLi4vc3RhdGVzT2ZNYXR0ZXIuanMnO1xyXG5pbXBvcnQgU3RhdGVzT2ZNYXR0ZXJTdHJpbmdzIGZyb20gJy4uLy4uL1N0YXRlc09mTWF0dGVyU3RyaW5ncy5qcyc7XHJcblxyXG4vLyBzdHJpbmdzXHJcbmNvbnN0IHByZXNzdXJlT3ZlcmxvYWRTdHJpbmcgPSBTdGF0ZXNPZk1hdHRlclN0cmluZ3MucHJlc3N1cmVPdmVybG9hZDtcclxuY29uc3QgcHJlc3N1cmVTdHJpbmdQcm9wZXJ0eSA9IFN0YXRlc09mTWF0dGVyU3RyaW5ncy5wcmVzc3VyZVN0cmluZ1Byb3BlcnR5O1xyXG5jb25zdCBwcmVzc3VyZVVuaXRzSW5BdG1TdHJpbmcgPSBTdGF0ZXNPZk1hdHRlclN0cmluZ3MucHJlc3N1cmVVbml0c0luQXRtO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IENPTk5FQ1RPUl9MRU5HVEhfUFJPUE9SVElPTiA9IDE7IC8vIExlbmd0aCBvZiBub24tZWxib3dlZCBjb25uZWN0b3Igd3J0IG92ZXJhbGwgZGlhbWV0ZXIuXHJcbmNvbnN0IENPTk5FQ1RPUl9XSURUSF9QUk9QT1JUSU9OID0gMC4yOyAvLyBXaWR0aCBvZiBjb25uZWN0b3Igd3J0IG92ZXJhbGwgZGlhbWV0ZXIuXHJcbmNvbnN0IE1BWF9QUkVTU1VSRSA9IDIwMDsgLy8gaW4gYXRtIHVuaXRzXHJcbmNvbnN0IEVMQk9XX1dJRFRIID0gKCBDT05ORUNUT1JfV0lEVEhfUFJPUE9SVElPTiAqIDMwICk7XHJcbmNvbnN0IEVMQk9XX0xFTkdUSCA9ICggQ09OTkVDVE9SX0xFTkdUSF9QUk9QT1JUSU9OICogNjAgKTtcclxuY29uc3QgUFJFU1NVUkVfVVBEQVRFX1BFUklPRCA9IDEwMDsgLy8gaW4gbWlsbGlzZWNvbmRzXHJcblxyXG5jbGFzcyBEaWFsR2F1Z2VOb2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7TXVsdGlwbGVQYXJ0aWNsZU1vZGVsfSBtdWx0aXBsZVBhcnRpY2xlTW9kZWwgLSBtb2RlbCBvZiB0aGUgc2ltdWxhdGlvblxyXG4gICAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbXVsdGlwbGVQYXJ0aWNsZU1vZGVsLCB0YW5kZW0gKSB7XHJcblxyXG4gICAgc3VwZXIoIHsgdGFuZGVtOiB0YW5kZW0gfSApO1xyXG4gICAgdGhpcy5lbGJvd0hlaWdodCA9IDA7IC8vIEBwcml2YXRlLCBzZXQgdGhyb3VnaCBhY2Nlc3NvciBtZXRob2RzXHJcblxyXG4gICAgY29uc3QgZ2F1Z2VOb2RlID0gbmV3IEdhdWdlTm9kZShcclxuICAgICAgbXVsdGlwbGVQYXJ0aWNsZU1vZGVsLnByZXNzdXJlUHJvcGVydHksXHJcbiAgICAgIHByZXNzdXJlU3RyaW5nUHJvcGVydHksXHJcbiAgICAgIG5ldyBSYW5nZSggMCwgTUFYX1BSRVNTVVJFICksXHJcbiAgICAgIHtcclxuICAgICAgICBzY2FsZTogMC41LFxyXG4gICAgICAgIHJhZGl1czogODAsXHJcbiAgICAgICAgYmFja2dyb3VuZExpbmVXaWR0aDogMyxcclxuICAgICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdnYXVnZU5vZGUnIClcclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIHRleHR1YWwgcmVhZG91dCBkaXNwbGF5LlxyXG4gICAgY29uc3QgcmVhZG91dE5vZGUgPSBuZXcgUmVjdGFuZ2xlKCAwLCAwLCA4MCwgMTUsIDIsIDIsIHtcclxuICAgICAgZmlsbDogJ3doaXRlJyxcclxuICAgICAgc3Ryb2tlOiAnYmxhY2snLFxyXG4gICAgICBjZW50ZXJYOiBnYXVnZU5vZGUuY2VudGVyWCxcclxuICAgICAgdG9wOiBnYXVnZU5vZGUuYm90dG9tIC0gMTUsXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3JlYWRvdXROb2RlJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgcmVhZG91dFRleHQgPSBuZXcgVGV4dCggJzAnLCB7XHJcbiAgICAgIGZvbnQ6IG5ldyBQaGV0Rm9udCggMTIgKSxcclxuICAgICAgZmlsbDogJ2JsYWNrJyxcclxuICAgICAgbWF4V2lkdGg6IHJlYWRvdXROb2RlLndpZHRoICogMC45LFxyXG4gICAgICBjZW50ZXJYOiByZWFkb3V0Tm9kZS53aWR0aCAvIDIsXHJcbiAgICAgIGNlbnRlclk6IHJlYWRvdXROb2RlLmhlaWdodCAvIDJcclxuICAgIH0gKTtcclxuICAgIHJlYWRvdXROb2RlLmFkZENoaWxkKCByZWFkb3V0VGV4dCApO1xyXG5cclxuICAgIC8vIENyZWF0ZSBhIGxpbmsgdG8gcHJlc3N1cmVQcm9wZXJ0eSBzbyBpdCdzIGVhc2llciB0byBmaW5kIGluIFN0dWRpby5cclxuICAgIHRoaXMuYWRkTGlua2VkRWxlbWVudCggbXVsdGlwbGVQYXJ0aWNsZU1vZGVsLnByZXNzdXJlUHJvcGVydHksIHtcclxuICAgICAgdGFuZGVtOiByZWFkb3V0Tm9kZS50YW5kZW0uY3JlYXRlVGFuZGVtKCAncHJlc3N1cmVQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFRvIGFjY3VyYXRlbHkgcmVwcm9kdWNlIHRoZSBwcmV2aW91cyB2ZXJzaW9uICh3aGljaCBjb25zaXN0ZWQgb2YgYSBwYXRoIHN0cm9rZWQgd2l0aCBsaW5lV2lkdGggMTApLCB3ZSBuZWVkIHRvXHJcbiAgICAvLyBpbmNsdWRlIHRoZSBzdHJva2Ugd2lkdGggZWZmZWN0cyAod2hlcmUgaXQgaGFkIGEgZGVmYXVsdCBsaW5lQ2FwIG9mIGJ1dHQpLiBXZSBoYXZlIGEgcGFydCB0aGF0IGRvZXNuJ3QgY2hhbmdlXHJcbiAgICAvLyBzaGFwZSAodGhlIGNvbm5lY3Rvcikgd2hpY2ggaW5jbHVkZXMgdGhlIGxlZnQgcGFydCBhbmQgdGhlIGN1cnZlLCBhbmQgdGhlbiBhbiBvdmVybGFwcGluZyBkeW5hbWljIHJlY3RhbmdsZVxyXG4gICAgLy8gKHRoZSBjb25uZWN0b3JFeHRlbnNpb24pIHdob3NlIGhlaWdodCBpcyBhZGp1c3RlZCB0byBiZSB0aGUgZWxib3dIZWlnaHQuIFRoaXMgcmVkdWNlcyB0aGUgb3ZlcmhlYWQgc2lnbmlmaWNhbnRseS5cclxuICAgIGNvbnN0IGhhbGZTdHJva2UgPSA1O1xyXG4gICAgY29uc3QgY29ubmVjdG9yID0gbmV3IFBhdGgoXHJcbiAgICAgIG5ldyBTaGFwZSgpLm1vdmVUbyggMCwgLWhhbGZTdHJva2UgKVxyXG4gICAgICAgIC5saW5lVG8oIEVMQk9XX0xFTkdUSCArIEVMQk9XX1dJRFRIIC8gMiwgLWhhbGZTdHJva2UgKVxyXG4gICAgICAgIC5xdWFkcmF0aWNDdXJ2ZVRvKCBFTEJPV19MRU5HVEggKyBFTEJPV19XSURUSCArIGhhbGZTdHJva2UsIC1oYWxmU3Ryb2tlLCBFTEJPV19MRU5HVEggKyBFTEJPV19XSURUSCArIGhhbGZTdHJva2UsIEVMQk9XX1dJRFRIIC8gMiApXHJcbiAgICAgICAgLmxpbmVUbyggRUxCT1dfTEVOR1RIIC0gaGFsZlN0cm9rZSwgRUxCT1dfV0lEVEggKyBoYWxmU3Ryb2tlIClcclxuICAgICAgICAubGluZVRvKCAwLCBFTEJPV19XSURUSCArIGhhbGZTdHJva2UgKVxyXG4gICAgICAgIC5jbG9zZSgpLFxyXG4gICAgICB7IGZpbGw6ICcjZGRkJyB9XHJcbiAgICApO1xyXG4gICAgdGhpcy5jb25uZWN0b3JFeHRlbnNpb24gPSBuZXcgUmVjdGFuZ2xlKCBFTEJPV19MRU5HVEggLSBoYWxmU3Ryb2tlLCBFTEJPV19XSURUSCAvIDIsIEVMQk9XX1dJRFRIICsgMiAqIGhhbGZTdHJva2UsIDAsIHtcclxuICAgICAgZmlsbDogJyNkZGQnXHJcbiAgICB9ICk7XHJcbiAgICBjb25uZWN0b3IuYWRkQ2hpbGQoIHRoaXMuY29ubmVjdG9yRXh0ZW5zaW9uICk7XHJcblxyXG4gICAgY29uc3QgY29ubmVjdG9yQ29sbGFyID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMzAsIDI1LCAyLCAyLCB7XHJcbiAgICAgIGZpbGw6IG5ldyBMaW5lYXJHcmFkaWVudCggMCwgMCwgMCwgMjUgKVxyXG4gICAgICAgIC5hZGRDb2xvclN0b3AoIDAsICdyZ2IoIDEyMCwgMTIwLCAxMjAgKScgKVxyXG4gICAgICAgIC5hZGRDb2xvclN0b3AoIDAuMywgJ3JnYiggMjIwLCAyMjAsIDIyMCApJyApXHJcbiAgICAgICAgLmFkZENvbG9yU3RvcCggMC41LCAncmdiKCAyMjAsIDIyMCwgMjIwICknIClcclxuICAgICAgICAuYWRkQ29sb3JTdG9wKCAxLCAncmdiKCAxMDAsIDEwMCwgMTAwICknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25uZWN0b3JDb2xsYXIuY2VudGVyWSA9IGdhdWdlTm9kZS5jZW50ZXJZO1xyXG4gICAgY29ubmVjdG9yQ29sbGFyLmxlZnQgPSBnYXVnZU5vZGUucmlnaHQgLSAxMDtcclxuICAgIGNvbnN0IGRpYWxDb21wb25lbnRzTm9kZSA9IG5ldyBOb2RlKCB7XHJcbiAgICAgICAgY2hpbGRyZW46IFsgY29ubmVjdG9yLCBjb25uZWN0b3JDb2xsYXIsIGdhdWdlTm9kZSwgcmVhZG91dE5vZGUgXVxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIHByZXZpb3VzIHByZXNzdXJlIHZhbHVlIHNvIHRoYXQgd2UgY2FuIGRldGVybWluZSB3aGVuIGNoYW5nZXMgaGF2ZSBvY2N1cnJlZC5cclxuICAgIGxldCBwcmV2aW91c1ByZXNzdXJlID0gLTE7XHJcblxyXG4gICAgLy8gY2xvc3VyZSB0byB1cGRhdGUgdGhlIHJlYWRvdXQgdGV4dFxyXG4gICAgY29uc3QgdXBkYXRlUmVhZG91dFRleHQgPSAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHByZXNzdXJlID0gbXVsdGlwbGVQYXJ0aWNsZU1vZGVsLnByZXNzdXJlUHJvcGVydHkuZ2V0KCk7XHJcbiAgICAgIGlmICggcHJlc3N1cmUgIT09IHByZXZpb3VzUHJlc3N1cmUgKSB7XHJcbiAgICAgICAgaWYgKCBwcmVzc3VyZSA8IE1BWF9QUkVTU1VSRSApIHtcclxuICAgICAgICAgIHJlYWRvdXRUZXh0LnNldFN0cmluZyggYCR7VXRpbHMudG9GaXhlZCggcHJlc3N1cmUsIDEgKX0gJHtwcmVzc3VyZVVuaXRzSW5BdG1TdHJpbmd9YCApO1xyXG4gICAgICAgICAgcmVhZG91dFRleHQuZmlsbCA9ICdibGFjayc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgcmVhZG91dFRleHQuc2V0U3RyaW5nKCBwcmVzc3VyZU92ZXJsb2FkU3RyaW5nICk7XHJcbiAgICAgICAgICByZWFkb3V0VGV4dC5maWxsID0gUGhldENvbG9yU2NoZW1lLlJFRF9DT0xPUkJMSU5EO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwcmV2aW91c1ByZXNzdXJlID0gcHJlc3N1cmU7XHJcbiAgICAgIH1cclxuICAgICAgcmVhZG91dFRleHQuY2VudGVyWCA9IHJlYWRvdXROb2RlLndpZHRoIC8gMjtcclxuICAgIH07XHJcblxyXG4gICAgLy8gRG8gdGhlIGluaXRpYWwgdXBkYXRlIG9mIHRoZSByZWFkb3V0LlxyXG4gICAgdXBkYXRlUmVhZG91dFRleHQoKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHByZXNzdXJlIHJlYWRvdXQgYXQgcmVndWxhciBpbnRlcnZhbHMuICBUaGlzIHdhcyBkb25lIHJhdGhlciB0aGFuIGxpc3RlbmluZyB0byB0aGUgcHJlc3N1cmUgcHJvcGVydHlcclxuICAgIC8vIGJlY2F1c2UgdGhlIHJlYWRvdXQgY2hhbmdlcyB0b28gcXVpY2tseSBpbiB0aGF0IGNhc2UuXHJcbiAgICBzdGVwVGltZXIuc2V0SW50ZXJ2YWwoIHVwZGF0ZVJlYWRvdXRUZXh0LCBQUkVTU1VSRV9VUERBVEVfUEVSSU9EICk7XHJcblxyXG4gICAgLy8gSWYgc3RhdGUgaXMgYmVpbmcgc2V0IHZpYSBwaGV0LWlvLCB0aGVuIGl0IGlzIG5lY2Vzc2FyeSB0byB1cGRhdGUgdGhlIHJlYWRvdXQgd2hlbiAgcHJlc3N1cmVQcm9wZXJ0eSBjaGFuZ2VzIHNpbmNlXHJcbiAgICAvLyB0aGUgdGltZXIgbWF5IG5vdCBiZSBydW5uaW5nLlxyXG4gICAgbXVsdGlwbGVQYXJ0aWNsZU1vZGVsLnByZXNzdXJlUHJvcGVydHkubGluayggKCkgPT4ge1xyXG4gICAgICBpZiAoIHBoZXQuam9pc3Quc2ltLmlzU2V0dGluZ1BoZXRpb1N0YXRlUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgICAgdXBkYXRlUmVhZG91dFRleHQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHBvc2l0aW9uIHRoZSBjb25uZWN0b3JcclxuICAgIGNvbm5lY3Rvci5zZXRUcmFuc2xhdGlvbihcclxuICAgICAgY29ubmVjdG9yQ29sbGFyLmNlbnRlclggKyBjb25uZWN0b3JDb2xsYXIud2lkdGggLyAyLFxyXG4gICAgICBjb25uZWN0b3JDb2xsYXIuY2VudGVyWSAtIENPTk5FQ1RPUl9XSURUSF9QUk9QT1JUSU9OICogMzAgLyAyXHJcbiAgICApO1xyXG5cclxuICAgIC8vIERvIHRoZSBpbml0aWFsIHVwZGF0ZSBvZiB0aGUgY29ubmVjdG9yLlxyXG4gICAgdGhpcy51cGRhdGVDb25uZWN0b3IoKTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIGRpYWwgYXMgYSBjaGlsZCBvZiB0aGUgbWFpbiBub2RlLlxyXG4gICAgdGhpcy5hZGRDaGlsZCggZGlhbENvbXBvbmVudHNOb2RlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgdGhlIGhlaWdodCBvZiB0aGUgZWxib3cuICBIZWlnaHQgaXMgc3BlY2lmaWVkIHdpdGggcmVzcGVjdCB0byB0aGUgdmVydGljYWwgY2VudGVyIG9mIHRoZSBub2RlLlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHRcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgc2V0RWxib3dIZWlnaHQoIGhlaWdodCApIHtcclxuICAgIHRoaXMuZWxib3dIZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICB0aGlzLnVwZGF0ZUNvbm5lY3RvcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHVwZGF0ZUNvbm5lY3RvcigpIHtcclxuICAgIHRoaXMuY29ubmVjdG9yRXh0ZW5zaW9uLnJlY3RIZWlnaHQgPSB0aGlzLmVsYm93SGVpZ2h0O1xyXG4gIH1cclxufVxyXG5cclxuc3RhdGVzT2ZNYXR0ZXIucmVnaXN0ZXIoICdEaWFsR2F1Z2VOb2RlJywgRGlhbEdhdWdlTm9kZSApO1xyXG5leHBvcnQgZGVmYXVsdCBEaWFsR2F1Z2VOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsU0FBU0MsS0FBSyxRQUFRLGdDQUFnQztBQUN0RCxPQUFPQyxTQUFTLE1BQU0sMENBQTBDO0FBQ2hFLE9BQU9DLGVBQWUsTUFBTSxnREFBZ0Q7QUFDNUUsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUM5RCxTQUFTQyxjQUFjLEVBQUVDLElBQUksRUFBRUMsSUFBSSxFQUFFQyxTQUFTLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDL0YsT0FBT0MsY0FB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