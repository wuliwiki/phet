// Copyright 2016-2021, University of Colorado Boulder

/**
 * A particle layer rendered on canvas that uses images rather than calling context.arc for improved performance.
 *
 * @author John Blanco
 */

import { CanvasNode } from '../../../../scenery/js/imports.js';
import statesOfMatter from '../../statesOfMatter.js';
import AtomType from '../model/AtomType.js';
import SOMConstants from '../SOMConstants.js';
import SOMColors from './SOMColors.js';

// constants
const PARTICLE_IMAGE_CANVAS_LENGTH = 32; // amount of canvas used to create a particle image, will be squared 

// set up the association between atom types and the colors used to represent them
const PARTICLE_COLOR_TABLE = {};
PARTICLE_COLOR_TABLE[AtomType.ARGON] = SOMConstants.ARGON_COLOR.toCSS();
PARTICLE_COLOR_TABLE[AtomType.NEON] = SOMConstants.NEON_COLOR.toCSS();
PARTICLE_COLOR_TABLE[AtomType.OXYGEN] = SOMConstants.OXYGEN_COLOR.toCSS();
PARTICLE_COLOR_TABLE[AtomType.HYDROGEN] = SOMConstants.HYDROGEN_COLOR.toCSS();
PARTICLE_COLOR_TABLE[AtomType.ADJUSTABLE] = SOMConstants.ADJUSTABLE_ATTRACTION_COLOR.toCSS();

// set up the association between atom types and their radii in the model
const PARTICLE_RADIUS_TABLE = {};
PARTICLE_RADIUS_TABLE[AtomType.ARGON] = SOMConstants.ARGON_RADIUS;
PARTICLE_RADIUS_TABLE[AtomType.NEON] = SOMConstants.NEON_RADIUS;
PARTICLE_RADIUS_TABLE[AtomType.OXYGEN] = SOMConstants.OXYGEN_RADIUS;
PARTICLE_RADIUS_TABLE[AtomType.HYDROGEN] = SOMConstants.HYDROGEN_RADIUS;
PARTICLE_RADIUS_TABLE[AtomType.ADJUSTABLE] = SOMConstants.ADJUSTABLE_ATTRACTION_DEFAULT_RADIUS;
class ParticleImageCanvasNode extends CanvasNode {
  /**
   * @param {ObservableArrayDef.<Particle>} particles that need to be rendered on the canvas
   * @param {ModelViewTransform2} modelViewTransform to convert between model and view coordinate frames
   * @param {Object} [options] that can be passed on to the underlying node
   */
  constructor(particles, modelViewTransform, options) {
    super(options);

    // @private
    this.particles = particles;
    this.modelViewTransform = modelViewTransform;

    // @private canvas where particle images will reside, one row with strokes and one row without
    this.particleImageCanvas = document.createElement('canvas');
    this.particleImageCanvas.width = Object.getOwnPropertyNames(AtomType).length * PARTICLE_IMAGE_CANVAS_LENGTH;
    this.particleImageCanvas.height = PARTICLE_IMAGE_CANVAS_LENGTH * 2;

    // @private create a map of particle types to position in the particle image canvas, will be populated below
    this.mapAtomTypeToImageXPosition = {};

    // @private create a table of particle view radii so they don't have to keep being recalculated, populated below
    this.particleRadii = {};

    // Draw the particles on the canvas, top row is without black stroke, the bottom row is with black stroke (for
    // projector mode).
    const context = this.particleImageCanvas.getContext('2d');
    let index = 0;
    for (const atomType in AtomType) {
      if (!AtomType.hasOwnProperty(atomType)) {
        // skip prototype properties
        continue;
      }

      // draw particle with stroke that matches the fill
      context.strokeStyle = PARTICLE_COLOR_TABLE[atomType];
      context.fillStyle = PARTICLE_COLOR_TABLE[atomType];
      context.lineWidth = 1;
      context.beginPath();
      context.arc(PARTICLE_IMAGE_CANVAS_LENGTH * index + PARTICLE_IMAGE_CANVAS_LENGTH / 2, PARTICLE_IMAGE_CANVAS_LENGTH / 2, PARTICLE_IMAGE_CANVAS_LENGTH / 2 * 0.95, 0, Math.PI * 2);
      context.fill();
      context.stroke();

      // draw particle with dark stroke
      context.strokeStyle = 'black';
      context.beginPath();
      context.arc(PARTICLE_IMAGE_CANVAS_LENGTH * index + PARTICLE_IMAGE_CANVAS_LENGTH / 2, PARTICLE_IMAGE_CANVAS_LENGTH * 1.5, PARTICLE_IMAGE_CANVAS_LENGTH / 2 * 0.95, 0, Math.PI * 2);
      context.fill();
      context.stroke();

      // populate the map for this atom type
      this.mapAtomTypeToImageXPosition[atomType] = index * PARTICLE_IMAGE_CANVAS_LENGTH;

      // set the radius for this atom type
      this.particleRadii[atomType] = modelViewTransform.modelToViewDeltaX(PARTICLE_RADIUS_TABLE[atomType]);
      index++;
    }

    // initiate the first paint
    this.invalidatePaint();
    SOMColors.particleStrokeProperty.link(color => {
      this.useStrokedParticles = color.toCSS() !== 'rgb(255,255,255)';
    });
    this.mutate(options);
  }

  /**
   * @private
   */
  renderParticle(context, particle) {
    const particleViewRadius = this.particleRadii[particle.getType()];
    context.drawImage(this.particleImageCanvas, this.mapAtomTypeToImageXPosition[particle.getType()], this.useStrokedParticles ? PARTICLE_IMAGE_CANVAS_LENGTH : 0, PARTICLE_IMAGE_CANVAS_LENGTH, PARTICLE_IMAGE_CANVAS_LENGTH, this.modelViewTransform.modelToViewX(particle.getX()) - particleViewRadius, this.modelViewTransform.modelToViewY(particle.getY()) - particleViewRadius, particleViewRadius * 2, particleViewRadius * 2);
  }

  /**
   * Paints the particles on the canvas node.
   * @param {CanvasRenderingContext2D} context
   * @public
   */
  paintCanvas(context) {
    let particle;
    let i;

    // Paint all atoms with a flag indicating that they should be in back first first.  This is done so that when
    // water is rendered, some of the hydrogen ends up in the back and some ends up in front so that there is
    // variation in the appearance of the molecules.  OPTIMIZATION NOTE: At the time of this writing, it is only
    // hydrogen atoms that will ever have this flag set, so several context values are set prior to the loop rather
    // than inside of it.
    for (i = 0; i < this.particles.length; i++) {
      particle = this.particles.get(i);
      if (particle.renderBelowOxygen) {
        this.renderParticle(context, particle);
      }
    }

    // Paint the non-flagged particles.
    for (i = 0; i < this.particles.length; i++) {
      particle = this.particles.get(i);
      if (!particle.renderBelowOxygen) {
        this.renderParticle(context, particle);
      }
    }
  }

  /**
   * @param {number} dt
   * @public
   */
  step(dt) {
    this.invalidatePaint();
  }
}
statesOfMatter.register('ParticleImageCanvasNode', ParticleImageCanvasNode);
export default ParticleImageCanvasNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDYW52YXNOb2RlIiwic3RhdGVzT2ZNYXR0ZXIiLCJBdG9tVHlwZSIsIlNPTUNvbnN0YW50cyIsIlNPTUNvbG9ycyIsIlBBUlRJQ0xFX0lNQUdFX0NBTlZBU19MRU5HVEgiLCJQQVJUSUNMRV9DT0xPUl9UQUJMRSIsIkFSR09OIiwiQVJHT05fQ09MT1IiLCJ0b0NTUyIsIk5FT04iLCJORU9OX0NPTE9SIiwiT1hZR0VOIiwiT1hZR0VOX0NPTE9SIiwiSFlEUk9HRU4iLCJIWURST0dFTl9DT0xPUiIsIkFESlVTVEFCTEUiLCJBREpVU1RBQkxFX0FUVFJBQ1RJT05fQ09MT1IiLCJQQVJUSUNMRV9SQURJVVNfVEFCTEUiLCJBUkdPTl9SQURJVVMiLCJORU9OX1JBRElVUyIsIk9YWUdFTl9SQURJVVMiLCJIWURST0dFTl9SQURJVVMiLCJBREpVU1RBQkxFX0FUVFJBQ1RJT05fREVGQVVMVF9SQURJVVMiLCJQYXJ0aWNsZUltYWdlQ2FudmFzTm9kZSIsImNvbnN0cnVjdG9yIiwicGFydGljbGVzIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwib3B0aW9ucyIsInBhcnRpY2xlSW1hZ2VDYW52YXMiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsIk9iamVjdCIsImdldE93blByb3BlcnR5TmFtZXMiLCJsZW5ndGgiLCJoZWlnaHQiLCJtYXBBdG9tVHlwZVRvSW1hZ2VYUG9zaXRpb24iLCJwYXJ0aWNsZVJhZGlpIiwiY29udGV4dCIsImdldENvbnRleHQiLCJpbmRleCIsImF0b21UeXBlIiwiaGFzT3duUHJvcGVydHkiLCJzdHJva2VTdHlsZSIsImZpbGxTdHlsZSIsImxpbmVXaWR0aCIsImJlZ2luUGF0aCIsImFyYyIsIk1hdGgiLCJQSSIsImZpbGwiLCJzdHJva2UiLCJtb2RlbFRvVmlld0RlbHRhWCIsImludmFsaWRhdGVQYWludCIsInBhcnRpY2xlU3Ryb2tlUHJvcGVydHkiLCJsaW5rIiwiY29sb3IiLCJ1c2VTdHJva2VkUGFydGljbGVzIiwibXV0YXRlIiwicmVuZGVyUGFydGljbGUiLCJwYXJ0aWNsZSIsInBhcnRpY2xlVmlld1JhZGl1cyIsImdldFR5cGUiLCJkcmF3SW1hZ2UiLCJtb2RlbFRvVmlld1giLCJnZXRYIiwibW9kZWxUb1ZpZXdZIiwiZ2V0WSIsInBhaW50Q2FudmFzIiwiaSIsImdldCIsInJlbmRlckJlbG93T3h5Z2VuIiwic3RlcCIsImR0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQYXJ0aWNsZUltYWdlQ2FudmFzTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIxLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHBhcnRpY2xlIGxheWVyIHJlbmRlcmVkIG9uIGNhbnZhcyB0aGF0IHVzZXMgaW1hZ2VzIHJhdGhlciB0aGFuIGNhbGxpbmcgY29udGV4dC5hcmMgZm9yIGltcHJvdmVkIHBlcmZvcm1hbmNlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQ2FudmFzTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBzdGF0ZXNPZk1hdHRlciBmcm9tICcuLi8uLi9zdGF0ZXNPZk1hdHRlci5qcyc7XHJcbmltcG9ydCBBdG9tVHlwZSBmcm9tICcuLi9tb2RlbC9BdG9tVHlwZS5qcyc7XHJcbmltcG9ydCBTT01Db25zdGFudHMgZnJvbSAnLi4vU09NQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFNPTUNvbG9ycyBmcm9tICcuL1NPTUNvbG9ycy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCA9IDMyOyAvLyBhbW91bnQgb2YgY2FudmFzIHVzZWQgdG8gY3JlYXRlIGEgcGFydGljbGUgaW1hZ2UsIHdpbGwgYmUgc3F1YXJlZCBcclxuXHJcbi8vIHNldCB1cCB0aGUgYXNzb2NpYXRpb24gYmV0d2VlbiBhdG9tIHR5cGVzIGFuZCB0aGUgY29sb3JzIHVzZWQgdG8gcmVwcmVzZW50IHRoZW1cclxuY29uc3QgUEFSVElDTEVfQ09MT1JfVEFCTEUgPSB7fTtcclxuUEFSVElDTEVfQ09MT1JfVEFCTEVbIEF0b21UeXBlLkFSR09OIF0gPSBTT01Db25zdGFudHMuQVJHT05fQ09MT1IudG9DU1MoKTtcclxuUEFSVElDTEVfQ09MT1JfVEFCTEVbIEF0b21UeXBlLk5FT04gXSA9IFNPTUNvbnN0YW50cy5ORU9OX0NPTE9SLnRvQ1NTKCk7XHJcblBBUlRJQ0xFX0NPTE9SX1RBQkxFWyBBdG9tVHlwZS5PWFlHRU4gXSA9IFNPTUNvbnN0YW50cy5PWFlHRU5fQ09MT1IudG9DU1MoKTtcclxuUEFSVElDTEVfQ09MT1JfVEFCTEVbIEF0b21UeXBlLkhZRFJPR0VOIF0gPSBTT01Db25zdGFudHMuSFlEUk9HRU5fQ09MT1IudG9DU1MoKTtcclxuUEFSVElDTEVfQ09MT1JfVEFCTEVbIEF0b21UeXBlLkFESlVTVEFCTEUgXSA9IFNPTUNvbnN0YW50cy5BREpVU1RBQkxFX0FUVFJBQ1RJT05fQ09MT1IudG9DU1MoKTtcclxuXHJcbi8vIHNldCB1cCB0aGUgYXNzb2NpYXRpb24gYmV0d2VlbiBhdG9tIHR5cGVzIGFuZCB0aGVpciByYWRpaSBpbiB0aGUgbW9kZWxcclxuY29uc3QgUEFSVElDTEVfUkFESVVTX1RBQkxFID0ge307XHJcblBBUlRJQ0xFX1JBRElVU19UQUJMRVsgQXRvbVR5cGUuQVJHT04gXSA9IFNPTUNvbnN0YW50cy5BUkdPTl9SQURJVVM7XHJcblBBUlRJQ0xFX1JBRElVU19UQUJMRVsgQXRvbVR5cGUuTkVPTiBdID0gU09NQ29uc3RhbnRzLk5FT05fUkFESVVTO1xyXG5QQVJUSUNMRV9SQURJVVNfVEFCTEVbIEF0b21UeXBlLk9YWUdFTiBdID0gU09NQ29uc3RhbnRzLk9YWUdFTl9SQURJVVM7XHJcblBBUlRJQ0xFX1JBRElVU19UQUJMRVsgQXRvbVR5cGUuSFlEUk9HRU4gXSA9IFNPTUNvbnN0YW50cy5IWURST0dFTl9SQURJVVM7XHJcblBBUlRJQ0xFX1JBRElVU19UQUJMRVsgQXRvbVR5cGUuQURKVVNUQUJMRSBdID0gU09NQ29uc3RhbnRzLkFESlVTVEFCTEVfQVRUUkFDVElPTl9ERUZBVUxUX1JBRElVUztcclxuXHJcbmNsYXNzIFBhcnRpY2xlSW1hZ2VDYW52YXNOb2RlIGV4dGVuZHMgQ2FudmFzTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7T2JzZXJ2YWJsZUFycmF5RGVmLjxQYXJ0aWNsZT59IHBhcnRpY2xlcyB0aGF0IG5lZWQgdG8gYmUgcmVuZGVyZWQgb24gdGhlIGNhbnZhc1xyXG4gICAqIEBwYXJhbSB7TW9kZWxWaWV3VHJhbnNmb3JtMn0gbW9kZWxWaWV3VHJhbnNmb3JtIHRvIGNvbnZlcnQgYmV0d2VlbiBtb2RlbCBhbmQgdmlldyBjb29yZGluYXRlIGZyYW1lc1xyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gdGhhdCBjYW4gYmUgcGFzc2VkIG9uIHRvIHRoZSB1bmRlcmx5aW5nIG5vZGVcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggcGFydGljbGVzLCBtb2RlbFZpZXdUcmFuc2Zvcm0sIG9wdGlvbnMgKSB7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5wYXJ0aWNsZXMgPSBwYXJ0aWNsZXM7XHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IG1vZGVsVmlld1RyYW5zZm9ybTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSBjYW52YXMgd2hlcmUgcGFydGljbGUgaW1hZ2VzIHdpbGwgcmVzaWRlLCBvbmUgcm93IHdpdGggc3Ryb2tlcyBhbmQgb25lIHJvdyB3aXRob3V0XHJcbiAgICB0aGlzLnBhcnRpY2xlSW1hZ2VDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnY2FudmFzJyApO1xyXG4gICAgdGhpcy5wYXJ0aWNsZUltYWdlQ2FudmFzLndpZHRoID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoIEF0b21UeXBlICkubGVuZ3RoICogUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSDtcclxuICAgIHRoaXMucGFydGljbGVJbWFnZUNhbnZhcy5oZWlnaHQgPSBQQVJUSUNMRV9JTUFHRV9DQU5WQVNfTEVOR1RIICogMjtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSBjcmVhdGUgYSBtYXAgb2YgcGFydGljbGUgdHlwZXMgdG8gcG9zaXRpb24gaW4gdGhlIHBhcnRpY2xlIGltYWdlIGNhbnZhcywgd2lsbCBiZSBwb3B1bGF0ZWQgYmVsb3dcclxuICAgIHRoaXMubWFwQXRvbVR5cGVUb0ltYWdlWFBvc2l0aW9uID0ge307XHJcblxyXG4gICAgLy8gQHByaXZhdGUgY3JlYXRlIGEgdGFibGUgb2YgcGFydGljbGUgdmlldyByYWRpaSBzbyB0aGV5IGRvbid0IGhhdmUgdG8ga2VlcCBiZWluZyByZWNhbGN1bGF0ZWQsIHBvcHVsYXRlZCBiZWxvd1xyXG4gICAgdGhpcy5wYXJ0aWNsZVJhZGlpID0ge307XHJcblxyXG4gICAgLy8gRHJhdyB0aGUgcGFydGljbGVzIG9uIHRoZSBjYW52YXMsIHRvcCByb3cgaXMgd2l0aG91dCBibGFjayBzdHJva2UsIHRoZSBib3R0b20gcm93IGlzIHdpdGggYmxhY2sgc3Ryb2tlIChmb3JcclxuICAgIC8vIHByb2plY3RvciBtb2RlKS5cclxuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLnBhcnRpY2xlSW1hZ2VDYW52YXMuZ2V0Q29udGV4dCggJzJkJyApO1xyXG4gICAgbGV0IGluZGV4ID0gMDtcclxuICAgIGZvciAoIGNvbnN0IGF0b21UeXBlIGluIEF0b21UeXBlICkge1xyXG5cclxuICAgICAgaWYgKCAhQXRvbVR5cGUuaGFzT3duUHJvcGVydHkoIGF0b21UeXBlICkgKSB7XHJcbiAgICAgICAgLy8gc2tpcCBwcm90b3R5cGUgcHJvcGVydGllc1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBkcmF3IHBhcnRpY2xlIHdpdGggc3Ryb2tlIHRoYXQgbWF0Y2hlcyB0aGUgZmlsbFxyXG4gICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gUEFSVElDTEVfQ09MT1JfVEFCTEVbIGF0b21UeXBlIF07XHJcbiAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gUEFSVElDTEVfQ09MT1JfVEFCTEVbIGF0b21UeXBlIF07XHJcbiAgICAgIGNvbnRleHQubGluZVdpZHRoID0gMTtcclxuICAgICAgY29udGV4dC5iZWdpblBhdGgoKTtcclxuICAgICAgY29udGV4dC5hcmMoXHJcbiAgICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCAqIGluZGV4ICsgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCAvIDIsXHJcbiAgICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCAvIDIsXHJcbiAgICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCAvIDIgKiAwLjk1LFxyXG4gICAgICAgIDAsXHJcbiAgICAgICAgTWF0aC5QSSAqIDJcclxuICAgICAgKTtcclxuICAgICAgY29udGV4dC5maWxsKCk7XHJcbiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7XHJcblxyXG4gICAgICAvLyBkcmF3IHBhcnRpY2xlIHdpdGggZGFyayBzdHJva2VcclxuICAgICAgY29udGV4dC5zdHJva2VTdHlsZSA9ICdibGFjayc7XHJcbiAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7XHJcbiAgICAgIGNvbnRleHQuYXJjKFxyXG4gICAgICAgIFBBUlRJQ0xFX0lNQUdFX0NBTlZBU19MRU5HVEggKiBpbmRleCArIFBBUlRJQ0xFX0lNQUdFX0NBTlZBU19MRU5HVEggLyAyLFxyXG4gICAgICAgIFBBUlRJQ0xFX0lNQUdFX0NBTlZBU19MRU5HVEggKiAxLjUsXHJcbiAgICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCAvIDIgKiAwLjk1LFxyXG4gICAgICAgIDAsXHJcbiAgICAgICAgTWF0aC5QSSAqIDJcclxuICAgICAgKTtcclxuICAgICAgY29udGV4dC5maWxsKCk7XHJcbiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7XHJcblxyXG4gICAgICAvLyBwb3B1bGF0ZSB0aGUgbWFwIGZvciB0aGlzIGF0b20gdHlwZVxyXG4gICAgICB0aGlzLm1hcEF0b21UeXBlVG9JbWFnZVhQb3NpdGlvblsgYXRvbVR5cGUgXSA9IGluZGV4ICogUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSDtcclxuXHJcbiAgICAgIC8vIHNldCB0aGUgcmFkaXVzIGZvciB0aGlzIGF0b20gdHlwZVxyXG4gICAgICB0aGlzLnBhcnRpY2xlUmFkaWlbIGF0b21UeXBlIF0gPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIFBBUlRJQ0xFX1JBRElVU19UQUJMRVsgYXRvbVR5cGUgXSApO1xyXG5cclxuICAgICAgaW5kZXgrKztcclxuICAgIH1cclxuXHJcbiAgICAvLyBpbml0aWF0ZSB0aGUgZmlyc3QgcGFpbnRcclxuICAgIHRoaXMuaW52YWxpZGF0ZVBhaW50KCk7XHJcblxyXG4gICAgU09NQ29sb3JzLnBhcnRpY2xlU3Ryb2tlUHJvcGVydHkubGluayggY29sb3IgPT4ge1xyXG4gICAgICB0aGlzLnVzZVN0cm9rZWRQYXJ0aWNsZXMgPSBjb2xvci50b0NTUygpICE9PSAncmdiKDI1NSwyNTUsMjU1KSc7XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICByZW5kZXJQYXJ0aWNsZSggY29udGV4dCwgcGFydGljbGUgKSB7XHJcbiAgICBjb25zdCBwYXJ0aWNsZVZpZXdSYWRpdXMgPSB0aGlzLnBhcnRpY2xlUmFkaWlbIHBhcnRpY2xlLmdldFR5cGUoKSBdO1xyXG4gICAgY29udGV4dC5kcmF3SW1hZ2UoXHJcbiAgICAgIHRoaXMucGFydGljbGVJbWFnZUNhbnZhcyxcclxuICAgICAgdGhpcy5tYXBBdG9tVHlwZVRvSW1hZ2VYUG9zaXRpb25bIHBhcnRpY2xlLmdldFR5cGUoKSBdLFxyXG4gICAgICB0aGlzLnVzZVN0cm9rZWRQYXJ0aWNsZXMgPyBQQVJUSUNMRV9JTUFHRV9DQU5WQVNfTEVOR1RIIDogMCxcclxuICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCxcclxuICAgICAgUEFSVElDTEVfSU1BR0VfQ0FOVkFTX0xFTkdUSCxcclxuICAgICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYKCBwYXJ0aWNsZS5nZXRYKCkgKSAtIHBhcnRpY2xlVmlld1JhZGl1cyxcclxuICAgICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCBwYXJ0aWNsZS5nZXRZKCkgKSAtIHBhcnRpY2xlVmlld1JhZGl1cyxcclxuICAgICAgcGFydGljbGVWaWV3UmFkaXVzICogMixcclxuICAgICAgcGFydGljbGVWaWV3UmFkaXVzICogMlxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBhaW50cyB0aGUgcGFydGljbGVzIG9uIHRoZSBjYW52YXMgbm9kZS5cclxuICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBwYWludENhbnZhcyggY29udGV4dCApIHtcclxuICAgIGxldCBwYXJ0aWNsZTtcclxuICAgIGxldCBpO1xyXG5cclxuICAgIC8vIFBhaW50IGFsbCBhdG9tcyB3aXRoIGEgZmxhZyBpbmRpY2F0aW5nIHRoYXQgdGhleSBzaG91bGQgYmUgaW4gYmFjayBmaXJzdCBmaXJzdC4gIFRoaXMgaXMgZG9uZSBzbyB0aGF0IHdoZW5cclxuICAgIC8vIHdhdGVyIGlzIHJlbmRlcmVkLCBzb21lIG9mIHRoZSBoeWRyb2dlbiBlbmRzIHVwIGluIHRoZSBiYWNrIGFuZCBzb21lIGVuZHMgdXAgaW4gZnJvbnQgc28gdGhhdCB0aGVyZSBpc1xyXG4gICAgLy8gdmFyaWF0aW9uIGluIHRoZSBhcHBlYXJhbmNlIG9mIHRoZSBtb2xlY3VsZXMuICBPUFRJTUlaQVRJT04gTk9URTogQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nLCBpdCBpcyBvbmx5XHJcbiAgICAvLyBoeWRyb2dlbiBhdG9tcyB0aGF0IHdpbGwgZXZlciBoYXZlIHRoaXMgZmxhZyBzZXQsIHNvIHNldmVyYWwgY29udGV4dCB2YWx1ZXMgYXJlIHNldCBwcmlvciB0byB0aGUgbG9vcCByYXRoZXJcclxuICAgIC8vIHRoYW4gaW5zaWRlIG9mIGl0LlxyXG4gICAgZm9yICggaSA9IDA7IGkgPCB0aGlzLnBhcnRpY2xlcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgcGFydGljbGUgPSB0aGlzLnBhcnRpY2xlcy5nZXQoIGkgKTtcclxuICAgICAgaWYgKCBwYXJ0aWNsZS5yZW5kZXJCZWxvd094eWdlbiApIHtcclxuICAgICAgICB0aGlzLnJlbmRlclBhcnRpY2xlKCBjb250ZXh0LCBwYXJ0aWNsZSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGFpbnQgdGhlIG5vbi1mbGFnZ2VkIHBhcnRpY2xlcy5cclxuICAgIGZvciAoIGkgPSAwOyBpIDwgdGhpcy5wYXJ0aWNsZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHBhcnRpY2xlID0gdGhpcy5wYXJ0aWNsZXMuZ2V0KCBpICk7XHJcbiAgICAgIGlmICggIXBhcnRpY2xlLnJlbmRlckJlbG93T3h5Z2VuICkge1xyXG4gICAgICAgIHRoaXMucmVuZGVyUGFydGljbGUoIGNvbnRleHQsIHBhcnRpY2xlICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBkdFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzdGVwKCBkdCApIHtcclxuICAgIHRoaXMuaW52YWxpZGF0ZVBhaW50KCk7XHJcbiAgfVxyXG59XHJcblxyXG5zdGF0ZXNPZk1hdHRlci5yZWdpc3RlciggJ1BhcnRpY2xlSW1hZ2VDYW52YXNOb2RlJywgUGFydGljbGVJbWFnZUNhbnZhc05vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgUGFydGljbGVJbWFnZUNhbnZhc05vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQVNBLFVBQVUsUUFBUSxtQ0FBbUM7QUFDOUQsT0FBT0MsY0FBYyxNQUFNLHlCQUF5QjtBQUNwRCxPQUFPQyxRQUFRLE1BQU0sc0JBQXNCO0FBQzNDLE9BQU9DLFlBQVksTUFBTSxvQkFBb0I7QUFDN0MsT0FBT0MsU0FBUyxNQUFNLGdCQUFnQjs7QUFFdEM7QUFDQSxNQUFNQyw0QkFBNEIsR0FBRyxFQUFFLENBQUMsQ0FBQzs7QUFFekM7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxDQUFDLENBQUM7QUFDL0JBLG9CQUFvQixDQUFFSixRQUFRLENBQUNLLEtBQUssQ0FBRSxHQUFHSixZQUFZLENBQUNLLFdBQVcsQ0FBQ0MsS0FBSyxDQUFDLENBQUM7QUFDekVILG9CQUFvQixDQUFFSixRQUFRLENBQUNRLElBQUksQ0FBRSxHQUFHUCxZQUFZLENBQUNRLFVBQVUsQ0FBQ0YsS0FBSyxDQUFDLENBQUM7QUFDdkVILG9CQUFvQixDQUFFSixRQUFRLENBQUNVLE1BQU0sQ0FBRSxHQUFHVCxZQUFZLENBQUNVLFlBQVksQ0FBQ0osS0FBSyxDQUFDLENBQUM7QUFDM0VILG9CQUFvQixDQUFFSixRQUFRLENBQUNZLFFBQVEsQ0FBRSxHQUFHWCxZQUFZLENBQUNZLGNBQWMsQ0FBQ04sS0FBSyxDQUFDLENBQUM7QUFDL0VILG9CQUFvQixDQUFFSixRQUFRLENBQUNjLFVBQVUsQ0FBRSxHQUFHYixZQUFZLENBQUNjLDJCQUEyQixDQUFDUixLQUFLLENBQUMsQ0FBQzs7QUFFOUY7QUFDQSxNQUFNUyxxQkFBcUIsR0FBRyxDQUFDLENBQUM7QUFDaENBLHFCQUFxQixDQUFFaEIsUUFBUSxDQUFDSyxLQUFLLENBQUUsR0FBR0osWUFBWSxD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