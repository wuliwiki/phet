// Copyright 2018-2022, University of Colorado Boulder

/**
 * A sound generator that plays pre-recorded sounds, either as a one-shot or as a loop.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import audioContextStateChangeMonitor from '../audioContextStateChangeMonitor.js';
import soundConstants from '../soundConstants.js';
import SoundUtils from '../SoundUtils.js';
import tambo from '../tambo.js';
import SoundGenerator from './SoundGenerator.js';
import optionize from '../../../phet-core/js/optionize.js';
// constants
const MAX_PLAY_DEFER_TIME = 0.2; // seconds, max time to defer a play request while waiting for audio context state change
const DEFAULT_TC = soundConstants.DEFAULT_PARAM_CHANGE_TIME_CONSTANT;
const DEFAULT_STOP_DELAY = 0.1;
class SoundClip extends SoundGenerator {
  // an object containing the audio buffer and flag that indicates readiness, i.e. whether it is fully loaded

  // flag that controls whether this is a one-shot or loop sound

  // flag that controls whether changes to the playback rate affects in-progress sounds

  // Controls whether this clip can be initiated when it is disabled, see description in options type definition above.
  // This is part of the API and can be changed if needed, though such a need is generally quite rare.
  // start point for playback of the sound data
  // stop or wrap around point for playback of the sound data
  // A list of active source buffer nodes, used so that this clip can be played multiple times without each initiation
  // interfering with the other.
  // a gain node that is used to prevent clicks when stopping the sound
  // The rate at which clip is being played back, 1 is normal, above 1 is faster, below 1 is slower.  See online docs
  // for AudioBufferSourceNode.playbackRate for more information.
  // indicates whether the sound is being played
  // time at which a deferred play request occurred, in milliseconds since epoch
  // callback for when audio context isn't in 'running' state, see usage
  constructor(wrappedAudioBuffer, providedOptions) {
    const options = optionize()({
      loop: false,
      trimSilence: true,
      initialPlaybackRate: 1,
      initiateWhenDisabled: false,
      rateChangesAffectPlayingSounds: true
    }, providedOptions);
    super(options);

    // initialize local state
    this.wrappedAudioBuffer = wrappedAudioBuffer;
    this.loop = options.loop;
    this.rateChangesAffectPlayingSounds = options.rateChangesAffectPlayingSounds;
    this.initiateWhenDisabled = options.initiateWhenDisabled;
    this.soundStart = 0;
    this.soundEnd = null;
    if (options.trimSilence) {
      // For sounds that are created statically during the module load phase, this listener will interpret the audio
      // data once the load of that data has completed.  For all sounds constructed after the module load phase has
      // completed, this will process right away.
      const setStartAndEndPoints = audioBuffer => {
        if (audioBuffer) {
          const loopBoundsInfo = SoundUtils.detectSoundBounds(audioBuffer);
          this.soundStart = loopBoundsInfo.soundStart;
          this.soundEnd = loopBoundsInfo.soundEnd;
          this.wrappedAudioBuffer.audioBufferProperty.unlink(setStartAndEndPoints);
        }
      };
      this.wrappedAudioBuffer.audioBufferProperty.link(setStartAndEndPoints);
    }
    this.activeBufferSources = [];
    this.localGainNode = this.audioContext.createGain();
    this.localGainNode.connect(this.soundSourceDestination);
    this._playbackRate = options.initialPlaybackRate;
    this.isPlayingProperty = new BooleanProperty(false);
    this.timeOfDeferredPlayRequest = Number.NEGATIVE_INFINITY;

    // callback for when audio context isn't in 'running' state, see usage
    this.audioContextStateChangeListener = state => {
      if (state === 'running') {
        // initiate deferred play if this is a loop or if it hasn't been too long since the request was made
        if (this.loop || (Date.now() - this.timeOfDeferredPlayRequest) / 1000 < MAX_PLAY_DEFER_TIME) {
          // Play the sound, but with a little bit of delay.  The delay was found to be needed because otherwise on
          // some browsers the sound would be somewhat muted, probably due to some sort of fade in of the audio levels
          // that the browser does automatically to avoid having the web page's sound start too abruptly.  The amount of
          // delay was empirically determined by testing on multiple browsers.
          this.play(0.1);
        }

        // automatically remove after firing
        audioContextStateChangeMonitor.removeStateChangeListener(this.audioContext, this.audioContextStateChangeListener);
      }
    };

    // listen to the Property that indicates whether we are fully enabled and stop one-shot sounds when it goes false
    this.fullyEnabledProperty.lazyLink(fullyEnabled => {
      if (!this.loop && !fullyEnabled) {
        this.stop();
      }
    });
  }

  /**
   * Start playing the sound.
   */
  play(delay = 0) {
    if (this.audioContext.state === 'running' && this.wrappedAudioBuffer.audioBufferProperty.value) {
      const now = this.audioContext.currentTime;
      if (this.loop && !this.isPlayingProperty.get() || !this.loop && (this.fullyEnabled || this.initiateWhenDisabled)) {
        // create an audio buffer source node that uses the previously decoded audio data
        const bufferSource = this.audioContext.createBufferSource();
        bufferSource.buffer = this.wrappedAudioBuffer.audioBufferProperty.value;
        bufferSource.loop = this.loop;
        bufferSource.loopStart = this.soundStart;
        if (this.soundEnd) {
          bufferSource.loopEnd = this.soundEnd;
        }

        // make sure the local gain is set to unity value
        this.localGainNode.gain.cancelScheduledValues(now);
        this.localGainNode.gain.setValueAtTime(1, now);
        bufferSource.connect(this.soundSourceDestination);

        // add this to the list of active sources so that it can be stopped if necessary
        this.activeBufferSources.push(bufferSource);
        if (!this.loop) {
          // add a handler for when the sound finishes playing
          bufferSource.onended = () => {
            // remove the source from the list of active sources
            const indexOfSource = this.activeBufferSources.indexOf(bufferSource);
            if (indexOfSource > -1) {
              this.activeBufferSources.splice(indexOfSource, 1);
            }
            this.isPlayingProperty.value = this.activeBufferSources.length > 0;
          };
        }

        // set the playback rate and start playback
        bufferSource.playbackRate.setValueAtTime(this._playbackRate, now);
        bufferSource.start(now + delay, this.soundStart);
        this.isPlayingProperty.value = true;
      }
    } else if (this.audioContext.state === 'suspended') {
      // The play method was called when the audio context was not yet running, so add a listener to play if and when
      // the audio context state changes.  This will start any loops, and will also play a one-shot sound if the time
      // between the request and the state change isn't too great.  Note that this does NOT queue up more than one
      // individual sound to be played.
      this.timeOfDeferredPlayRequest = Date.now();
      if (!audioContextStateChangeMonitor.hasListener(this.audioContext, this.audioContextStateChangeListener)) {
        audioContextStateChangeMonitor.addStateChangeListener(this.audioContext, this.audioContextStateChangeListener);
      }
    }
  }

  /**
   * Stop playing the sound.
   *
   * Note: Doing rapid stops and starts of a loop using this method can cause sound glitches.  If you have a need to
   * do that, use volume fades combined with zero delay stops.
   *
   * @param [delay] - The amount of time to wait before stopping, generally used to prevent sudden stops, which can
   * cause audible clicks.  If greater than zero, which it is by default, this method will try to fade out the sound
   * fully prior to stopping the audio playback.
   */
  stop(delay = DEFAULT_STOP_DELAY) {
    // Calculate a time constant to fade output level by 99% by the stop time, see Web Audio time constant information
    // to understand this calculation.
    const fadeTimeConstant = delay > 0 ? delay / 4.61 : soundConstants.DEFAULT_PARAM_CHANGE_TIME_CONSTANT;

    // Simply calling stop() on the buffer source frequently causes an audible click, so we use a gain node and turn
    // down the gain, effectively doing a fade out, and then stopping playback.
    const now = this.audioContext.currentTime;
    const stopTime = now + delay;
    this.localGainNode.gain.cancelScheduledValues(now);
    this.localGainNode.gain.setTargetAtTime(0, now, fadeTimeConstant);
    this.activeBufferSources.forEach(source => {
      source.stop(stopTime);
    });

    // The WebAudio spec is a bit unclear about whether stopping a sound will trigger an onended event.  In testing
    // on Chrome in September 2018, I (jbphet) found that onended was NOT being fired when stop() was called, so the
    // code below is needed to clear the array of all active buffer sources.
    this.activeBufferSources.length = 0;

    // clear the flag
    this.isPlayingProperty.value = false;
    if (audioContextStateChangeMonitor.hasListener(this.audioContext, this.audioContextStateChangeListener)) {
      // remove the state change listener that was going to do a deferred play, since the sound has now been stopped
      audioContextStateChangeMonitor.removeStateChangeListener(this.audioContext, this.audioContextStateChangeListener);
    }
  }

  /**
   * Set the playback rate.  Based on the way this SoundClip was created, this may or may not affect in-progress sounds.
   */
  setPlaybackRate(playbackRate, timeConstant = DEFAULT_TC) {
    assert && assert(playbackRate > 0);
    if (this.rateChangesAffectPlayingSounds) {
      const now = this.audioContext.currentTime;
      this.activeBufferSources.forEach(bufferSource => {
        bufferSource.playbackRate.cancelScheduledValues(now);
        bufferSource.playbackRate.setTargetAtTime(playbackRate, now, timeConstant);
      });
    }
    this._playbackRate = playbackRate;
  }

  /**
   * Get the current playback rate.  Note that it is possible that there are audio buffers that are playing that are not
   * playing at the returned rate if the rate was recently changed.
   */
  getPlaybackRate() {
    return this._playbackRate;
  }

  /**
   * ES5 getter for playback rate
   */
  get playbackRate() {
    return this.getPlaybackRate();
  }

  /**
   * Get a value that indicates whether sound is currently being played.
   */
  get isPlaying() {
    return this.isPlayingProperty.value;
  }

  /**
   * Get the number of instances of the audio buffer that are currently playing.  This can be greater than one because
   * SoundClip supports multiple buffers playing at the same time.  This method is generally used to limit the number
   * of instances that are playing at the same time.
   */
  getNumberOfPlayingInstances() {
    return this.activeBufferSources.length;
  }
}
tambo.register('SoundClip', SoundClip);
export default SoundClip;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJhdWRpb0NvbnRleHRTdGF0ZUNoYW5nZU1vbml0b3IiLCJzb3VuZENvbnN0YW50cyIsIlNvdW5kVXRpbHMiLCJ0YW1ibyIsIlNvdW5kR2VuZXJhdG9yIiwib3B0aW9uaXplIiwiTUFYX1BMQVlfREVGRVJfVElNRSIsIkRFRkFVTFRfVEMiLCJERUZBVUxUX1BBUkFNX0NIQU5HRV9USU1FX0NPTlNUQU5UIiwiREVGQVVMVF9TVE9QX0RFTEFZIiwiU291bmRDbGlwIiwiY29uc3RydWN0b3IiLCJ3cmFwcGVkQXVkaW9CdWZmZXIiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwibG9vcCIsInRyaW1TaWxlbmNlIiwiaW5pdGlhbFBsYXliYWNrUmF0ZSIsImluaXRpYXRlV2hlbkRpc2FibGVkIiwicmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzIiwic291bmRTdGFydCIsInNvdW5kRW5kIiwic2V0U3RhcnRBbmRFbmRQb2ludHMiLCJhdWRpb0J1ZmZlciIsImxvb3BCb3VuZHNJbmZvIiwiZGV0ZWN0U291bmRCb3VuZHMiLCJhdWRpb0J1ZmZlclByb3BlcnR5IiwidW5saW5rIiwibGluayIsImFjdGl2ZUJ1ZmZlclNvdXJjZXMiLCJsb2NhbEdhaW5Ob2RlIiwiYXVkaW9Db250ZXh0IiwiY3JlYXRlR2FpbiIsImNvbm5lY3QiLCJzb3VuZFNvdXJjZURlc3RpbmF0aW9uIiwiX3BsYXliYWNrUmF0ZSIsImlzUGxheWluZ1Byb3BlcnR5IiwidGltZU9mRGVmZXJyZWRQbGF5UmVxdWVzdCIsIk51bWJlciIsIk5FR0FUSVZFX0lORklOSVRZIiwiYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lciIsInN0YXRlIiwiRGF0ZSIsIm5vdyIsInBsYXkiLCJyZW1vdmVTdGF0ZUNoYW5nZUxpc3RlbmVyIiwiZnVsbHlFbmFibGVkUHJvcGVydHkiLCJsYXp5TGluayIsImZ1bGx5RW5hYmxlZCIsInN0b3AiLCJkZWxheSIsInZhbHVlIiwiY3VycmVudFRpbWUiLCJnZXQiLCJidWZmZXJTb3VyY2UiLCJjcmVhdGVCdWZmZXJTb3VyY2UiLCJidWZmZXIiLCJsb29wU3RhcnQiLCJsb29wRW5kIiwiZ2FpbiIsImNhbmNlbFNjaGVkdWxlZFZhbHVlcyIsInNldFZhbHVlQXRUaW1lIiwicHVzaCIsIm9uZW5kZWQiLCJpbmRleE9mU291cmNlIiwiaW5kZXhPZiIsInNwbGljZSIsImxlbmd0aCIsInBsYXliYWNrUmF0ZSIsInN0YXJ0IiwiaGFzTGlzdGVuZXIiLCJhZGRTdGF0ZUNoYW5nZUxpc3RlbmVyIiwiZmFkZVRpbWVDb25zdGFudCIsInN0b3BUaW1lIiwic2V0VGFyZ2V0QXRUaW1lIiwiZm9yRWFjaCIsInNvdXJjZSIsInNldFBsYXliYWNrUmF0ZSIsInRpbWVDb25zdGFudCIsImFzc2VydCIsImdldFBsYXliYWNrUmF0ZSIsImlzUGxheWluZyIsImdldE51bWJlck9mUGxheWluZ0luc3RhbmNlcyIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiU291bmRDbGlwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgc291bmQgZ2VuZXJhdG9yIHRoYXQgcGxheXMgcHJlLXJlY29yZGVkIHNvdW5kcywgZWl0aGVyIGFzIGEgb25lLXNob3Qgb3IgYXMgYSBsb29wLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VNb25pdG9yIGZyb20gJy4uL2F1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTW9uaXRvci5qcyc7XHJcbmltcG9ydCBzb3VuZENvbnN0YW50cyBmcm9tICcuLi9zb3VuZENvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBTb3VuZFV0aWxzIGZyb20gJy4uL1NvdW5kVXRpbHMuanMnO1xyXG5pbXBvcnQgdGFtYm8gZnJvbSAnLi4vdGFtYm8uanMnO1xyXG5pbXBvcnQgU291bmRHZW5lcmF0b3IsIHsgU291bmRHZW5lcmF0b3JPcHRpb25zIH0gZnJvbSAnLi9Tb3VuZEdlbmVyYXRvci5qcyc7XHJcbmltcG9ydCBXcmFwcGVkQXVkaW9CdWZmZXIgZnJvbSAnLi4vV3JhcHBlZEF1ZGlvQnVmZmVyLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuXHJcbiAgLy8gY29udHJvbHMgd2hldGhlciB0aGlzIHNvdW5kIHdpbGwgd3JhcCBhcm91bmQgYW5kIHN0YXJ0IG92ZXIgd2hlbiBkb25lIG9yIGp1c3QgYmUgcGxheWVkIG9uY2VcclxuICBsb29wPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gY29udHJvbHMgd2hldGhlciB0aGUgc2lsZW5jZSBhdCB0aGUgYmVnaW5uaW5nIGFuZCAoaW4gdGhlIGNhc2Ugb2YgbG9vcHMpIHRoZSBlbmQgaXMgb21pdHRlZCB3aGVuIHNvdW5kIGlzIHBsYXllZFxyXG4gIHRyaW1TaWxlbmNlPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gSW5pdGlhbCBwbGF5YmFjayByYXRlIGZvciB0aGlzIGNsaXAuICBUaGlzIHZhbHVlIGlzIGEgbXVsdGlwbGllciwgc28gMSBpcyB0aGUgbm9taW5hbCBwbGF5YmFjayByYXRlLCAwLjUgaXMgaGFsZlxyXG4gIC8vIHNwZWVkIChvciBhbiBvY3RhdmUgbG93ZXIgaW4gbXVzaWNhbCB0ZXJtcykgYW5kIGEgdmFsdWUgb2YgMiBpcyB0d2ljZSBub3JtYWwgc3BlZWQgKG9yIGFuIG9jdGF2ZSBoaWdoZXIgaW4gbXVzaWNhbFxyXG4gIC8vIHRlcm1zKS4gIFRoZSBwbGF5YmFjayByYXRlIGNhbiBiZSBjaGFuZ2VkIGFmdGVyIGNvbnN0cnVjdGlvbiB2aWEgdGhlIEFQSS5cclxuICBpbml0aWFsUGxheWJhY2tSYXRlPzogbnVtYmVyO1xyXG5cclxuICAvLyBDb250cm9scyB3aGV0aGVyIHNvdW5kIGdlbmVyYXRpb24gY2FuIGJlIGluaXRpYXRlZCB3aGVuIHRoaXMgc291bmQgZ2VuZXJhdG9yIGlzIGRpc2FibGVkLiAgVGhpcyBpcyB1c2VmdWwgZm9yIGFcclxuICAvLyBvbmUtc2hvdCBzb3VuZCB0aGF0IGlzIGxvbmcsIHNvIGlmIHRoZSB1c2VyIGRvZXMgc29tZXRoaW5nIHRoYXQgZ2VuZXJhbGx5IHdvdWxkIGNhdXNlIGEgc291bmQsIGJ1dCBzb3VuZCBpc1xyXG4gIC8vIGRpc2FibGVkLCBidXQgdGhlbiB0aGV5IGltbWVkaWF0ZWx5IHJlLWVuYWJsZSBzb3VuZCwgdGhlIFwidGFpbFwiIG9mIHRoaXMgc291bmQgd291bGQgYmUgaGVhcmQuICBUaGlzIG9wdGlvbiBpc1xyXG4gIC8vIGlnbm9yZWQgZm9yIGxvb3BzLCBzaW5jZSBsb29wcyBhbHdheXMgYWxsb3cgaW5pdGlhdGlvbiB3aGVuIGRpc2FibGVkLlxyXG4gIGluaXRpYXRlV2hlbkRpc2FibGVkPzogYm9vbGVhbjtcclxuXHJcbiAgLy8gQ29udHJvbHMgd2hldGhlciBjaGFuZ2VzIHRvIHRoZSBwbGF5YmFjayByYXRlIHZpYSB0aGUgQVBJIGNhdXNlcyBjaGFuZ2VzIHRvIHRoZSBzb3VuZHMgdGhhdCBhcmUgYWxyZWFkeSBiZWluZ1xyXG4gIC8vIHBsYXllZCBhcyBvcHBvc2VkIHRvIG9ubHkgc291bmRzIHRoYXQgYXJlIHN0YXJ0ZWQgYWZ0ZXIgdGhlIHBsYXliYWNrIHJhdGUgaXMgY2hhbmdlZC4gIFRoaXMgaXMgcmVsZXZhbnQgZm9yIGJvdGhcclxuICAvLyBsb29wcyBhbmQgb25lLXNob3Qgc291bmRzLCBzaW5jZSBhIG9uZS1zaG90IHNvdW5kIChlc3BlY2lhbGx5IG9uZSB0aGF0IGlzIGZhaXJseSBsb25nKSBjb3VsZCBiZSBpbiB0aGUgcHJvY2VzcyBvZlxyXG4gIC8vIHBsYXlpbmcgd2hlbiBhIHBsYXliYWNrIHJhdGUgY2hhbmdlIG9jY3Vycy5cclxuICByYXRlQ2hhbmdlc0FmZmVjdFBsYXlpbmdTb3VuZHM/OiBib29sZWFuO1xyXG59O1xyXG5leHBvcnQgdHlwZSBTb3VuZENsaXBPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBTb3VuZEdlbmVyYXRvck9wdGlvbnM7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgTUFYX1BMQVlfREVGRVJfVElNRSA9IDAuMjsgLy8gc2Vjb25kcywgbWF4IHRpbWUgdG8gZGVmZXIgYSBwbGF5IHJlcXVlc3Qgd2hpbGUgd2FpdGluZyBmb3IgYXVkaW8gY29udGV4dCBzdGF0ZSBjaGFuZ2VcclxuY29uc3QgREVGQVVMVF9UQyA9IHNvdW5kQ29uc3RhbnRzLkRFRkFVTFRfUEFSQU1fQ0hBTkdFX1RJTUVfQ09OU1RBTlQ7XHJcbmNvbnN0IERFRkFVTFRfU1RPUF9ERUxBWSA9IDAuMTtcclxuXHJcbmNsYXNzIFNvdW5kQ2xpcCBleHRlbmRzIFNvdW5kR2VuZXJhdG9yIHtcclxuXHJcbiAgLy8gYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGF1ZGlvIGJ1ZmZlciBhbmQgZmxhZyB0aGF0IGluZGljYXRlcyByZWFkaW5lc3MsIGkuZS4gd2hldGhlciBpdCBpcyBmdWxseSBsb2FkZWRcclxuICBwcml2YXRlIHJlYWRvbmx5IHdyYXBwZWRBdWRpb0J1ZmZlcjogV3JhcHBlZEF1ZGlvQnVmZmVyO1xyXG5cclxuICAvLyBmbGFnIHRoYXQgY29udHJvbHMgd2hldGhlciB0aGlzIGlzIGEgb25lLXNob3Qgb3IgbG9vcCBzb3VuZFxyXG4gIHB1YmxpYyByZWFkb25seSBsb29wOiBib29sZWFuO1xyXG5cclxuICAvLyBmbGFnIHRoYXQgY29udHJvbHMgd2hldGhlciBjaGFuZ2VzIHRvIHRoZSBwbGF5YmFjayByYXRlIGFmZmVjdHMgaW4tcHJvZ3Jlc3Mgc291bmRzXHJcbiAgcHJpdmF0ZSByZWFkb25seSByYXRlQ2hhbmdlc0FmZmVjdFBsYXlpbmdTb3VuZHM6IGJvb2xlYW47XHJcblxyXG4gIC8vIENvbnRyb2xzIHdoZXRoZXIgdGhpcyBjbGlwIGNhbiBiZSBpbml0aWF0ZWQgd2hlbiBpdCBpcyBkaXNhYmxlZCwgc2VlIGRlc2NyaXB0aW9uIGluIG9wdGlvbnMgdHlwZSBkZWZpbml0aW9uIGFib3ZlLlxyXG4gIC8vIFRoaXMgaXMgcGFydCBvZiB0aGUgQVBJIGFuZCBjYW4gYmUgY2hhbmdlZCBpZiBuZWVkZWQsIHRob3VnaCBzdWNoIGEgbmVlZCBpcyBnZW5lcmFsbHkgcXVpdGUgcmFyZS5cclxuICBwdWJsaWMgaW5pdGlhdGVXaGVuRGlzYWJsZWQ6IGJvb2xlYW47XHJcblxyXG4gIC8vIHN0YXJ0IHBvaW50IGZvciBwbGF5YmFjayBvZiB0aGUgc291bmQgZGF0YVxyXG4gIHByaXZhdGUgc291bmRTdGFydDogbnVtYmVyO1xyXG5cclxuICAvLyBzdG9wIG9yIHdyYXAgYXJvdW5kIHBvaW50IGZvciBwbGF5YmFjayBvZiB0aGUgc291bmQgZGF0YVxyXG4gIHByaXZhdGUgc291bmRFbmQ6IG51bWJlciB8IG51bGw7XHJcblxyXG4gIC8vIEEgbGlzdCBvZiBhY3RpdmUgc291cmNlIGJ1ZmZlciBub2RlcywgdXNlZCBzbyB0aGF0IHRoaXMgY2xpcCBjYW4gYmUgcGxheWVkIG11bHRpcGxlIHRpbWVzIHdpdGhvdXQgZWFjaCBpbml0aWF0aW9uXHJcbiAgLy8gaW50ZXJmZXJpbmcgd2l0aCB0aGUgb3RoZXIuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBhY3RpdmVCdWZmZXJTb3VyY2VzOiBBdWRpb0J1ZmZlclNvdXJjZU5vZGVbXTtcclxuXHJcbiAgLy8gYSBnYWluIG5vZGUgdGhhdCBpcyB1c2VkIHRvIHByZXZlbnQgY2xpY2tzIHdoZW4gc3RvcHBpbmcgdGhlIHNvdW5kXHJcbiAgcHJpdmF0ZSByZWFkb25seSBsb2NhbEdhaW5Ob2RlOiBHYWluTm9kZTtcclxuXHJcbiAgLy8gVGhlIHJhdGUgYXQgd2hpY2ggY2xpcCBpcyBiZWluZyBwbGF5ZWQgYmFjaywgMSBpcyBub3JtYWwsIGFib3ZlIDEgaXMgZmFzdGVyLCBiZWxvdyAxIGlzIHNsb3dlci4gIFNlZSBvbmxpbmUgZG9jc1xyXG4gIC8vIGZvciBBdWRpb0J1ZmZlclNvdXJjZU5vZGUucGxheWJhY2tSYXRlIGZvciBtb3JlIGluZm9ybWF0aW9uLlxyXG4gIHByaXZhdGUgX3BsYXliYWNrUmF0ZTogbnVtYmVyO1xyXG5cclxuICAvLyBpbmRpY2F0ZXMgd2hldGhlciB0aGUgc291bmQgaXMgYmVpbmcgcGxheWVkXHJcbiAgcHVibGljIHJlYWRvbmx5IGlzUGxheWluZ1Byb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gdGltZSBhdCB3aGljaCBhIGRlZmVycmVkIHBsYXkgcmVxdWVzdCBvY2N1cnJlZCwgaW4gbWlsbGlzZWNvbmRzIHNpbmNlIGVwb2NoXHJcbiAgcHJpdmF0ZSB0aW1lT2ZEZWZlcnJlZFBsYXlSZXF1ZXN0OiBudW1iZXI7XHJcblxyXG4gIC8vIGNhbGxiYWNrIGZvciB3aGVuIGF1ZGlvIGNvbnRleHQgaXNuJ3QgaW4gJ3J1bm5pbmcnIHN0YXRlLCBzZWUgdXNhZ2VcclxuICBwcml2YXRlIHJlYWRvbmx5IGF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTGlzdGVuZXI6ICggc3RhdGU6IHN0cmluZyApID0+IHZvaWQ7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvciggd3JhcHBlZEF1ZGlvQnVmZmVyOiBXcmFwcGVkQXVkaW9CdWZmZXIsIHByb3ZpZGVkT3B0aW9ucz86IFNvdW5kQ2xpcE9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxTb3VuZENsaXBPcHRpb25zLCBTZWxmT3B0aW9ucywgU291bmRHZW5lcmF0b3JPcHRpb25zPigpKCB7XHJcbiAgICAgIGxvb3A6IGZhbHNlLFxyXG4gICAgICB0cmltU2lsZW5jZTogdHJ1ZSxcclxuICAgICAgaW5pdGlhbFBsYXliYWNrUmF0ZTogMSxcclxuICAgICAgaW5pdGlhdGVXaGVuRGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICByYXRlQ2hhbmdlc0FmZmVjdFBsYXlpbmdTb3VuZHM6IHRydWVcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gaW5pdGlhbGl6ZSBsb2NhbCBzdGF0ZVxyXG4gICAgdGhpcy53cmFwcGVkQXVkaW9CdWZmZXIgPSB3cmFwcGVkQXVkaW9CdWZmZXI7XHJcbiAgICB0aGlzLmxvb3AgPSBvcHRpb25zLmxvb3A7XHJcbiAgICB0aGlzLnJhdGVDaGFuZ2VzQWZmZWN0UGxheWluZ1NvdW5kcyA9IG9wdGlvbnMucmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzO1xyXG4gICAgdGhpcy5pbml0aWF0ZVdoZW5EaXNhYmxlZCA9IG9wdGlvbnMuaW5pdGlhdGVXaGVuRGlzYWJsZWQ7XHJcbiAgICB0aGlzLnNvdW5kU3RhcnQgPSAwO1xyXG4gICAgdGhpcy5zb3VuZEVuZCA9IG51bGw7XHJcbiAgICBpZiAoIG9wdGlvbnMudHJpbVNpbGVuY2UgKSB7XHJcblxyXG4gICAgICAvLyBGb3Igc291bmRzIHRoYXQgYXJlIGNyZWF0ZWQgc3RhdGljYWxseSBkdXJpbmcgdGhlIG1vZHVsZSBsb2FkIHBoYXNlLCB0aGlzIGxpc3RlbmVyIHdpbGwgaW50ZXJwcmV0IHRoZSBhdWRpb1xyXG4gICAgICAvLyBkYXRhIG9uY2UgdGhlIGxvYWQgb2YgdGhhdCBkYXRhIGhhcyBjb21wbGV0ZWQuICBGb3IgYWxsIHNvdW5kcyBjb25zdHJ1Y3RlZCBhZnRlciB0aGUgbW9kdWxlIGxvYWQgcGhhc2UgaGFzXHJcbiAgICAgIC8vIGNvbXBsZXRlZCwgdGhpcyB3aWxsIHByb2Nlc3MgcmlnaHQgYXdheS5cclxuICAgICAgY29uc3Qgc2V0U3RhcnRBbmRFbmRQb2ludHMgPSAoIGF1ZGlvQnVmZmVyOiBBdWRpb0J1ZmZlciB8IG51bGwgKSA9PiB7XHJcbiAgICAgICAgaWYgKCBhdWRpb0J1ZmZlciApIHtcclxuICAgICAgICAgIGNvbnN0IGxvb3BCb3VuZHNJbmZvID0gU291bmRVdGlscy5kZXRlY3RTb3VuZEJvdW5kcyggYXVkaW9CdWZmZXIgKTtcclxuICAgICAgICAgIHRoaXMuc291bmRTdGFydCA9IGxvb3BCb3VuZHNJbmZvLnNvdW5kU3RhcnQ7XHJcbiAgICAgICAgICB0aGlzLnNvdW5kRW5kID0gbG9vcEJvdW5kc0luZm8uc291bmRFbmQ7XHJcbiAgICAgICAgICB0aGlzLndyYXBwZWRBdWRpb0J1ZmZlci5hdWRpb0J1ZmZlclByb3BlcnR5LnVubGluayggc2V0U3RhcnRBbmRFbmRQb2ludHMgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMud3JhcHBlZEF1ZGlvQnVmZmVyLmF1ZGlvQnVmZmVyUHJvcGVydHkubGluayggc2V0U3RhcnRBbmRFbmRQb2ludHMgKTtcclxuICAgIH1cclxuICAgIHRoaXMuYWN0aXZlQnVmZmVyU291cmNlcyA9IFtdO1xyXG4gICAgdGhpcy5sb2NhbEdhaW5Ob2RlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlR2FpbigpO1xyXG4gICAgdGhpcy5sb2NhbEdhaW5Ob2RlLmNvbm5lY3QoIHRoaXMuc291bmRTb3VyY2VEZXN0aW5hdGlvbiApO1xyXG4gICAgdGhpcy5fcGxheWJhY2tSYXRlID0gb3B0aW9ucy5pbml0aWFsUGxheWJhY2tSYXRlO1xyXG4gICAgdGhpcy5pc1BsYXlpbmdQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcbiAgICB0aGlzLnRpbWVPZkRlZmVycmVkUGxheVJlcXVlc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7XHJcblxyXG4gICAgLy8gY2FsbGJhY2sgZm9yIHdoZW4gYXVkaW8gY29udGV4dCBpc24ndCBpbiAncnVubmluZycgc3RhdGUsIHNlZSB1c2FnZVxyXG4gICAgdGhpcy5hdWRpb0NvbnRleHRTdGF0ZUNoYW5nZUxpc3RlbmVyID0gc3RhdGUgPT4ge1xyXG5cclxuICAgICAgaWYgKCBzdGF0ZSA9PT0gJ3J1bm5pbmcnICkge1xyXG5cclxuICAgICAgICAvLyBpbml0aWF0ZSBkZWZlcnJlZCBwbGF5IGlmIHRoaXMgaXMgYSBsb29wIG9yIGlmIGl0IGhhc24ndCBiZWVuIHRvbyBsb25nIHNpbmNlIHRoZSByZXF1ZXN0IHdhcyBtYWRlXHJcbiAgICAgICAgaWYgKCB0aGlzLmxvb3AgfHwgKCBEYXRlLm5vdygpIC0gdGhpcy50aW1lT2ZEZWZlcnJlZFBsYXlSZXF1ZXN0ICkgLyAxMDAwIDwgTUFYX1BMQVlfREVGRVJfVElNRSApIHtcclxuXHJcbiAgICAgICAgICAvLyBQbGF5IHRoZSBzb3VuZCwgYnV0IHdpdGggYSBsaXR0bGUgYml0IG9mIGRlbGF5LiAgVGhlIGRlbGF5IHdhcyBmb3VuZCB0byBiZSBuZWVkZWQgYmVjYXVzZSBvdGhlcndpc2Ugb25cclxuICAgICAgICAgIC8vIHNvbWUgYnJvd3NlcnMgdGhlIHNvdW5kIHdvdWxkIGJlIHNvbWV3aGF0IG11dGVkLCBwcm9iYWJseSBkdWUgdG8gc29tZSBzb3J0IG9mIGZhZGUgaW4gb2YgdGhlIGF1ZGlvIGxldmVsc1xyXG4gICAgICAgICAgLy8gdGhhdCB0aGUgYnJvd3NlciBkb2VzIGF1dG9tYXRpY2FsbHkgdG8gYXZvaWQgaGF2aW5nIHRoZSB3ZWIgcGFnZSdzIHNvdW5kIHN0YXJ0IHRvbyBhYnJ1cHRseS4gIFRoZSBhbW91bnQgb2ZcclxuICAgICAgICAgIC8vIGRlbGF5IHdhcyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIGJ5IHRlc3Rpbmcgb24gbXVsdGlwbGUgYnJvd3NlcnMuXHJcbiAgICAgICAgICB0aGlzLnBsYXkoIDAuMSApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gYXV0b21hdGljYWxseSByZW1vdmUgYWZ0ZXIgZmlyaW5nXHJcbiAgICAgICAgYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VNb25pdG9yLnJlbW92ZVN0YXRlQ2hhbmdlTGlzdGVuZXIoXHJcbiAgICAgICAgICB0aGlzLmF1ZGlvQ29udGV4dCxcclxuICAgICAgICAgIHRoaXMuYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lclxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gbGlzdGVuIHRvIHRoZSBQcm9wZXJ0eSB0aGF0IGluZGljYXRlcyB3aGV0aGVyIHdlIGFyZSBmdWxseSBlbmFibGVkIGFuZCBzdG9wIG9uZS1zaG90IHNvdW5kcyB3aGVuIGl0IGdvZXMgZmFsc2VcclxuICAgIHRoaXMuZnVsbHlFbmFibGVkUHJvcGVydHkubGF6eUxpbmsoIGZ1bGx5RW5hYmxlZCA9PiB7XHJcbiAgICAgIGlmICggIXRoaXMubG9vcCAmJiAhZnVsbHlFbmFibGVkICkge1xyXG4gICAgICAgIHRoaXMuc3RvcCgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGFydCBwbGF5aW5nIHRoZSBzb3VuZC5cclxuICAgKi9cclxuICBwdWJsaWMgcGxheSggZGVsYXkgPSAwICk6IHZvaWQge1xyXG5cclxuICAgIGlmICggdGhpcy5hdWRpb0NvbnRleHQuc3RhdGUgPT09ICdydW5uaW5nJyAmJiB0aGlzLndyYXBwZWRBdWRpb0J1ZmZlci5hdWRpb0J1ZmZlclByb3BlcnR5LnZhbHVlICkge1xyXG5cclxuICAgICAgY29uc3Qgbm93ID0gdGhpcy5hdWRpb0NvbnRleHQuY3VycmVudFRpbWU7XHJcblxyXG4gICAgICBpZiAoICggdGhpcy5sb29wICYmICF0aGlzLmlzUGxheWluZ1Byb3BlcnR5LmdldCgpICkgfHxcclxuICAgICAgICAgICAoICF0aGlzLmxvb3AgJiYgKCB0aGlzLmZ1bGx5RW5hYmxlZCB8fCB0aGlzLmluaXRpYXRlV2hlbkRpc2FibGVkICkgKSApIHtcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGFuIGF1ZGlvIGJ1ZmZlciBzb3VyY2Ugbm9kZSB0aGF0IHVzZXMgdGhlIHByZXZpb3VzbHkgZGVjb2RlZCBhdWRpbyBkYXRhXHJcbiAgICAgICAgY29uc3QgYnVmZmVyU291cmNlID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7XHJcbiAgICAgICAgYnVmZmVyU291cmNlLmJ1ZmZlciA9IHRoaXMud3JhcHBlZEF1ZGlvQnVmZmVyLmF1ZGlvQnVmZmVyUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgYnVmZmVyU291cmNlLmxvb3AgPSB0aGlzLmxvb3A7XHJcbiAgICAgICAgYnVmZmVyU291cmNlLmxvb3BTdGFydCA9IHRoaXMuc291bmRTdGFydDtcclxuICAgICAgICBpZiAoIHRoaXMuc291bmRFbmQgKSB7XHJcbiAgICAgICAgICBidWZmZXJTb3VyY2UubG9vcEVuZCA9IHRoaXMuc291bmRFbmQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIGxvY2FsIGdhaW4gaXMgc2V0IHRvIHVuaXR5IHZhbHVlXHJcbiAgICAgICAgdGhpcy5sb2NhbEdhaW5Ob2RlLmdhaW4uY2FuY2VsU2NoZWR1bGVkVmFsdWVzKCBub3cgKTtcclxuICAgICAgICB0aGlzLmxvY2FsR2Fpbk5vZGUuZ2Fpbi5zZXRWYWx1ZUF0VGltZSggMSwgbm93ICk7XHJcblxyXG4gICAgICAgIGJ1ZmZlclNvdXJjZS5jb25uZWN0KCB0aGlzLnNvdW5kU291cmNlRGVzdGluYXRpb24gKTtcclxuXHJcbiAgICAgICAgLy8gYWRkIHRoaXMgdG8gdGhlIGxpc3Qgb2YgYWN0aXZlIHNvdXJjZXMgc28gdGhhdCBpdCBjYW4gYmUgc3RvcHBlZCBpZiBuZWNlc3NhcnlcclxuICAgICAgICB0aGlzLmFjdGl2ZUJ1ZmZlclNvdXJjZXMucHVzaCggYnVmZmVyU291cmNlICk7XHJcblxyXG4gICAgICAgIGlmICggIXRoaXMubG9vcCApIHtcclxuXHJcbiAgICAgICAgICAvLyBhZGQgYSBoYW5kbGVyIGZvciB3aGVuIHRoZSBzb3VuZCBmaW5pc2hlcyBwbGF5aW5nXHJcbiAgICAgICAgICBidWZmZXJTb3VyY2Uub25lbmRlZCA9ICgpID0+IHtcclxuXHJcbiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgc291cmNlIGZyb20gdGhlIGxpc3Qgb2YgYWN0aXZlIHNvdXJjZXNcclxuICAgICAgICAgICAgY29uc3QgaW5kZXhPZlNvdXJjZSA9IHRoaXMuYWN0aXZlQnVmZmVyU291cmNlcy5pbmRleE9mKCBidWZmZXJTb3VyY2UgKTtcclxuICAgICAgICAgICAgaWYgKCBpbmRleE9mU291cmNlID4gLTEgKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5hY3RpdmVCdWZmZXJTb3VyY2VzLnNwbGljZSggaW5kZXhPZlNvdXJjZSwgMSApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkudmFsdWUgPSB0aGlzLmFjdGl2ZUJ1ZmZlclNvdXJjZXMubGVuZ3RoID4gMDtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBzZXQgdGhlIHBsYXliYWNrIHJhdGUgYW5kIHN0YXJ0IHBsYXliYWNrXHJcbiAgICAgICAgYnVmZmVyU291cmNlLnBsYXliYWNrUmF0ZS5zZXRWYWx1ZUF0VGltZSggdGhpcy5fcGxheWJhY2tSYXRlLCBub3cgKTtcclxuICAgICAgICBidWZmZXJTb3VyY2Uuc3RhcnQoIG5vdyArIGRlbGF5LCB0aGlzLnNvdW5kU3RhcnQgKTtcclxuICAgICAgICB0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIHRoaXMuYXVkaW9Db250ZXh0LnN0YXRlID09PSAnc3VzcGVuZGVkJyApIHtcclxuXHJcbiAgICAgIC8vIFRoZSBwbGF5IG1ldGhvZCB3YXMgY2FsbGVkIHdoZW4gdGhlIGF1ZGlvIGNvbnRleHQgd2FzIG5vdCB5ZXQgcnVubmluZywgc28gYWRkIGEgbGlzdGVuZXIgdG8gcGxheSBpZiBhbmQgd2hlblxyXG4gICAgICAvLyB0aGUgYXVkaW8gY29udGV4dCBzdGF0ZSBjaGFuZ2VzLiAgVGhpcyB3aWxsIHN0YXJ0IGFueSBsb29wcywgYW5kIHdpbGwgYWxzbyBwbGF5IGEgb25lLXNob3Qgc291bmQgaWYgdGhlIHRpbWVcclxuICAgICAgLy8gYmV0d2VlbiB0aGUgcmVxdWVzdCBhbmQgdGhlIHN0YXRlIGNoYW5nZSBpc24ndCB0b28gZ3JlYXQuICBOb3RlIHRoYXQgdGhpcyBkb2VzIE5PVCBxdWV1ZSB1cCBtb3JlIHRoYW4gb25lXHJcbiAgICAgIC8vIGluZGl2aWR1YWwgc291bmQgdG8gYmUgcGxheWVkLlxyXG4gICAgICB0aGlzLnRpbWVPZkRlZmVycmVkUGxheVJlcXVlc3QgPSBEYXRlLm5vdygpO1xyXG4gICAgICBpZiAoICFhdWRpb0NvbnRleHRTdGF0ZUNoYW5nZU1vbml0b3IuaGFzTGlzdGVuZXIoIHRoaXMuYXVkaW9Db250ZXh0LCB0aGlzLmF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTGlzdGVuZXIgKSApIHtcclxuICAgICAgICBhdWRpb0NvbnRleHRTdGF0ZUNoYW5nZU1vbml0b3IuYWRkU3RhdGVDaGFuZ2VMaXN0ZW5lcihcclxuICAgICAgICAgIHRoaXMuYXVkaW9Db250ZXh0LFxyXG4gICAgICAgICAgdGhpcy5hdWRpb0NvbnRleHRTdGF0ZUNoYW5nZUxpc3RlbmVyXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RvcCBwbGF5aW5nIHRoZSBzb3VuZC5cclxuICAgKlxyXG4gICAqIE5vdGU6IERvaW5nIHJhcGlkIHN0b3BzIGFuZCBzdGFydHMgb2YgYSBsb29wIHVzaW5nIHRoaXMgbWV0aG9kIGNhbiBjYXVzZSBzb3VuZCBnbGl0Y2hlcy4gIElmIHlvdSBoYXZlIGEgbmVlZCB0b1xyXG4gICAqIGRvIHRoYXQsIHVzZSB2b2x1bWUgZmFkZXMgY29tYmluZWQgd2l0aCB6ZXJvIGRlbGF5IHN0b3BzLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIFtkZWxheV0gLSBUaGUgYW1vdW50IG9mIHRpbWUgdG8gd2FpdCBiZWZvcmUgc3RvcHBpbmcsIGdlbmVyYWxseSB1c2VkIHRvIHByZXZlbnQgc3VkZGVuIHN0b3BzLCB3aGljaCBjYW5cclxuICAgKiBjYXVzZSBhdWRpYmxlIGNsaWNrcy4gIElmIGdyZWF0ZXIgdGhhbiB6ZXJvLCB3aGljaCBpdCBpcyBieSBkZWZhdWx0LCB0aGlzIG1ldGhvZCB3aWxsIHRyeSB0byBmYWRlIG91dCB0aGUgc291bmRcclxuICAgKiBmdWxseSBwcmlvciB0byBzdG9wcGluZyB0aGUgYXVkaW8gcGxheWJhY2suXHJcbiAgICovXHJcbiAgcHVibGljIHN0b3AoIGRlbGF5OiBudW1iZXIgPSBERUZBVUxUX1NUT1BfREVMQVkgKTogdm9pZCB7XHJcblxyXG4gICAgLy8gQ2FsY3VsYXRlIGEgdGltZSBjb25zdGFudCB0byBmYWRlIG91dHB1dCBsZXZlbCBieSA5OSUgYnkgdGhlIHN0b3AgdGltZSwgc2VlIFdlYiBBdWRpbyB0aW1lIGNvbnN0YW50IGluZm9ybWF0aW9uXHJcbiAgICAvLyB0byB1bmRlcnN0YW5kIHRoaXMgY2FsY3VsYXRpb24uXHJcbiAgICBjb25zdCBmYWRlVGltZUNvbnN0YW50ID0gZGVsYXkgPiAwID8gZGVsYXkgLyA0LjYxIDogc291bmRDb25zdGFudHMuREVGQVVMVF9QQVJBTV9DSEFOR0VfVElNRV9DT05TVEFOVDtcclxuXHJcbiAgICAvLyBTaW1wbHkgY2FsbGluZyBzdG9wKCkgb24gdGhlIGJ1ZmZlciBzb3VyY2UgZnJlcXVlbnRseSBjYXVzZXMgYW4gYXVkaWJsZSBjbGljaywgc28gd2UgdXNlIGEgZ2FpbiBub2RlIGFuZCB0dXJuXHJcbiAgICAvLyBkb3duIHRoZSBnYWluLCBlZmZlY3RpdmVseSBkb2luZyBhIGZhZGUgb3V0LCBhbmQgdGhlbiBzdG9wcGluZyBwbGF5YmFjay5cclxuICAgIGNvbnN0IG5vdyA9IHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lO1xyXG4gICAgY29uc3Qgc3RvcFRpbWUgPSBub3cgKyBkZWxheTtcclxuICAgIHRoaXMubG9jYWxHYWluTm9kZS5nYWluLmNhbmNlbFNjaGVkdWxlZFZhbHVlcyggbm93ICk7XHJcbiAgICB0aGlzLmxvY2FsR2Fpbk5vZGUuZ2Fpbi5zZXRUYXJnZXRBdFRpbWUoIDAsIG5vdywgZmFkZVRpbWVDb25zdGFudCApO1xyXG4gICAgdGhpcy5hY3RpdmVCdWZmZXJTb3VyY2VzLmZvckVhY2goIHNvdXJjZSA9PiB7IHNvdXJjZS5zdG9wKCBzdG9wVGltZSApOyB9ICk7XHJcblxyXG4gICAgLy8gVGhlIFdlYkF1ZGlvIHNwZWMgaXMgYSBiaXQgdW5jbGVhciBhYm91dCB3aGV0aGVyIHN0b3BwaW5nIGEgc291bmQgd2lsbCB0cmlnZ2VyIGFuIG9uZW5kZWQgZXZlbnQuICBJbiB0ZXN0aW5nXHJcbiAgICAvLyBvbiBDaHJvbWUgaW4gU2VwdGVtYmVyIDIwMTgsIEkgKGpicGhldCkgZm91bmQgdGhhdCBvbmVuZGVkIHdhcyBOT1QgYmVpbmcgZmlyZWQgd2hlbiBzdG9wKCkgd2FzIGNhbGxlZCwgc28gdGhlXHJcbiAgICAvLyBjb2RlIGJlbG93IGlzIG5lZWRlZCB0byBjbGVhciB0aGUgYXJyYXkgb2YgYWxsIGFjdGl2ZSBidWZmZXIgc291cmNlcy5cclxuICAgIHRoaXMuYWN0aXZlQnVmZmVyU291cmNlcy5sZW5ndGggPSAwO1xyXG5cclxuICAgIC8vIGNsZWFyIHRoZSBmbGFnXHJcbiAgICB0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnZhbHVlID0gZmFsc2U7XHJcblxyXG4gICAgaWYgKCBhdWRpb0NvbnRleHRTdGF0ZUNoYW5nZU1vbml0b3IuaGFzTGlzdGVuZXIoIHRoaXMuYXVkaW9Db250ZXh0LCB0aGlzLmF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTGlzdGVuZXIgKSApIHtcclxuXHJcbiAgICAgIC8vIHJlbW92ZSB0aGUgc3RhdGUgY2hhbmdlIGxpc3RlbmVyIHRoYXQgd2FzIGdvaW5nIHRvIGRvIGEgZGVmZXJyZWQgcGxheSwgc2luY2UgdGhlIHNvdW5kIGhhcyBub3cgYmVlbiBzdG9wcGVkXHJcbiAgICAgIGF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTW9uaXRvci5yZW1vdmVTdGF0ZUNoYW5nZUxpc3RlbmVyKFxyXG4gICAgICAgIHRoaXMuYXVkaW9Db250ZXh0LFxyXG4gICAgICAgIHRoaXMuYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lclxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IHRoZSBwbGF5YmFjayByYXRlLiAgQmFzZWQgb24gdGhlIHdheSB0aGlzIFNvdW5kQ2xpcCB3YXMgY3JlYXRlZCwgdGhpcyBtYXkgb3IgbWF5IG5vdCBhZmZlY3QgaW4tcHJvZ3Jlc3Mgc291bmRzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRQbGF5YmFja1JhdGUoIHBsYXliYWNrUmF0ZTogbnVtYmVyLCB0aW1lQ29uc3RhbnQ6IG51bWJlciA9IERFRkFVTFRfVEMgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBwbGF5YmFja1JhdGUgPiAwICk7XHJcbiAgICBpZiAoIHRoaXMucmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzICkge1xyXG4gICAgICBjb25zdCBub3cgPSB0aGlzLmF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcclxuICAgICAgdGhpcy5hY3RpdmVCdWZmZXJTb3VyY2VzLmZvckVhY2goIGJ1ZmZlclNvdXJjZSA9PiB7XHJcbiAgICAgICAgYnVmZmVyU291cmNlLnBsYXliYWNrUmF0ZS5jYW5jZWxTY2hlZHVsZWRWYWx1ZXMoIG5vdyApO1xyXG4gICAgICAgIGJ1ZmZlclNvdXJjZS5wbGF5YmFja1JhdGUuc2V0VGFyZ2V0QXRUaW1lKCBwbGF5YmFja1JhdGUsIG5vdywgdGltZUNvbnN0YW50ICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICAgIHRoaXMuX3BsYXliYWNrUmF0ZSA9IHBsYXliYWNrUmF0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB0aGUgY3VycmVudCBwbGF5YmFjayByYXRlLiAgTm90ZSB0aGF0IGl0IGlzIHBvc3NpYmxlIHRoYXQgdGhlcmUgYXJlIGF1ZGlvIGJ1ZmZlcnMgdGhhdCBhcmUgcGxheWluZyB0aGF0IGFyZSBub3RcclxuICAgKiBwbGF5aW5nIGF0IHRoZSByZXR1cm5lZCByYXRlIGlmIHRoZSByYXRlIHdhcyByZWNlbnRseSBjaGFuZ2VkLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQbGF5YmFja1JhdGUoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9wbGF5YmFja1JhdGU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBFUzUgZ2V0dGVyIGZvciBwbGF5YmFjayByYXRlXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBwbGF5YmFja1JhdGUoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLmdldFBsYXliYWNrUmF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGEgdmFsdWUgdGhhdCBpbmRpY2F0ZXMgd2hldGhlciBzb3VuZCBpcyBjdXJyZW50bHkgYmVpbmcgcGxheWVkLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgaXNQbGF5aW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkudmFsdWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgdGhlIG51bWJlciBvZiBpbnN0YW5jZXMgb2YgdGhlIGF1ZGlvIGJ1ZmZlciB0aGF0IGFyZSBjdXJyZW50bHkgcGxheWluZy4gIFRoaXMgY2FuIGJlIGdyZWF0ZXIgdGhhbiBvbmUgYmVjYXVzZVxyXG4gICAqIFNvdW5kQ2xpcCBzdXBwb3J0cyBtdWx0aXBsZSBidWZmZXJzIHBsYXlpbmcgYXQgdGhlIHNhbWUgdGltZS4gIFRoaXMgbWV0aG9kIGlzIGdlbmVyYWxseSB1c2VkIHRvIGxpbWl0IHRoZSBudW1iZXJcclxuICAgKiBvZiBpbnN0YW5jZXMgdGhhdCBhcmUgcGxheWluZyBhdCB0aGUgc2FtZSB0aW1lLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXROdW1iZXJPZlBsYXlpbmdJbnN0YW5jZXMoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLmFjdGl2ZUJ1ZmZlclNvdXJjZXMubGVuZ3RoO1xyXG4gIH1cclxufVxyXG5cclxudGFtYm8ucmVnaXN0ZXIoICdTb3VuZENsaXAnLCBTb3VuZENsaXAgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFNvdW5kQ2xpcDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHFDQUFxQztBQUNqRSxPQUFPQyw4QkFBOEIsTUFBTSxzQ0FBc0M7QUFDakYsT0FBT0MsY0FBYyxNQUFNLHNCQUFzQjtBQUNqRCxPQUFPQyxVQUFVLE1BQU0sa0JBQWtCO0FBQ3pDLE9BQU9DLEtBQUssTUFBTSxhQUFhO0FBQy9CLE9BQU9DLGNBQWMsTUFBaUMscUJBQXFCO0FBRTNFLE9BQU9DLFNBQVMsTUFBTSxvQ0FBb0M7QUE4QjFEO0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFDakMsTUFBTUMsVUFBVSxHQUFHTixjQUFjLENBQUNPLGtDQUFrQztBQUNwRSxNQUFNQyxrQkFBa0IsR0FBRyxHQUFHO0FBRTlCLE1BQU1DLFNBQVMsU0FBU04sY0FBYyxDQUFDO0VBRXJDOztFQUdBOztFQUdBOztFQUdBO0VBQ0E7RUFHQTtFQUdBO0VBR0E7RUFDQTtFQUdBO0VBR0E7RUFDQTtFQUdBO0VBR0E7RUFHQTtFQUdPTyxXQUFXQSxDQUFFQyxrQkFBc0MsRUFBRUMsZUFBa0MsRUFBRztJQUUvRixNQUFNQyxPQUFPLEdBQUdULFNBQVMsQ0FBdUQsQ0FBQyxDQUFFO01BQ2pGVSxJQUFJLEVBQUUsS0FBSztNQUNYQyxXQUFXLEVBQUUsSUFBSTtNQUNqQkMsbUJBQW1CLEVBQUUsQ0FBQztNQUN0QkMsb0JB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