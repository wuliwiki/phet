// Copyright 2019-2022, University of Colorado Boulder

/**
 * A singleton instance that allows clients to register listeners that get fired on state changes for an audio context.
 * This exists because an audio context has a single "onstatechange" property, and we had the need to register multiple
 * listeners.
 */

import tambo from './tambo.js';

// type definition for audio context state change listeners

// A list of the audio contexts being monitored. In the code below, contexts should only be added, never deleted, and
// this array should never be reordered.
const monitoredAudioContexts = [];

// a two-dimensional list of listeners, indexed by the position of the corresponding audio context in the array above
const stateChangeListenerArrays = [];

// the definition of the singleton instance
const audioContextStateChangeMonitor = {
  /**
   * add a listener that will be fired on state changes for the provided audio context
   */
  addStateChangeListener(audioContext, listener) {
    // Find the audio context in the list of those being monitored, or add it if not found.
    let audioContextIndex = monitoredAudioContexts.indexOf(audioContext);
    let listenerArray;
    if (audioContextIndex === -1) {
      monitoredAudioContexts.push(audioContext);
      audioContextIndex = monitoredAudioContexts.length - 1;
      listenerArray = []; // create a new listener array
      stateChangeListenerArrays.push(listenerArray);

      // make sure there isn't something already listening to this context's state change
      assert && assert(!audioContext.onstatechange, 'a listener function is already registered for this context');

      // hook up a function that will fire all listeners on a state change
      audioContext.onstatechange = () => {
        _.clone(listenerArray).forEach(listener => {
          listener(audioContext.state);
        });
      };
    } else {
      listenerArray = stateChangeListenerArrays[audioContextIndex];
    }
    listenerArray.push(listener);
  },
  /**
   * remove the state change listener for the specified audio context
   */
  removeStateChangeListener(audioContext, listener) {
    // remove the listener for the listener array, checking for various problems along the way
    const audioContextIndex = monitoredAudioContexts.indexOf(audioContext);
    assert && assert(audioContextIndex >= 0, 'audio context not found');
    const listenerArray = stateChangeListenerArrays[audioContextIndex];
    const listenerIndex = listenerArray.indexOf(listener);
    assert && assert(listenerIndex >= 0, 'listener not found for specified audio context');
    listenerArray.splice(listenerIndex, 1);
  },
  /**
   * test if the provided listener is present for the specified audio context
   */
  hasListener(audioContext, listener) {
    let found = false;
    const audioContextIndex = monitoredAudioContexts.indexOf(audioContext);
    if (audioContextIndex >= 0) {
      const listenerArray = stateChangeListenerArrays[audioContextIndex];
      if (listenerArray) {
        found = listenerArray.includes(listener);
      }
    }
    return found;
  }
};
tambo.register('audioContextStateChangeMonitor', audioContextStateChangeMonitor);
export default audioContextStateChangeMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0YW1ibyIsIm1vbml0b3JlZEF1ZGlvQ29udGV4dHMiLCJzdGF0ZUNoYW5nZUxpc3RlbmVyQXJyYXlzIiwiYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VNb25pdG9yIiwiYWRkU3RhdGVDaGFuZ2VMaXN0ZW5lciIsImF1ZGlvQ29udGV4dCIsImxpc3RlbmVyIiwiYXVkaW9Db250ZXh0SW5kZXgiLCJpbmRleE9mIiwibGlzdGVuZXJBcnJheSIsInB1c2giLCJsZW5ndGgiLCJhc3NlcnQiLCJvbnN0YXRlY2hhbmdlIiwiXyIsImNsb25lIiwiZm9yRWFjaCIsInN0YXRlIiwicmVtb3ZlU3RhdGVDaGFuZ2VMaXN0ZW5lciIsImxpc3RlbmVySW5kZXgiLCJzcGxpY2UiLCJoYXNMaXN0ZW5lciIsImZvdW5kIiwiaW5jbHVkZXMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbImF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTW9uaXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHNpbmdsZXRvbiBpbnN0YW5jZSB0aGF0IGFsbG93cyBjbGllbnRzIHRvIHJlZ2lzdGVyIGxpc3RlbmVycyB0aGF0IGdldCBmaXJlZCBvbiBzdGF0ZSBjaGFuZ2VzIGZvciBhbiBhdWRpbyBjb250ZXh0LlxyXG4gKiBUaGlzIGV4aXN0cyBiZWNhdXNlIGFuIGF1ZGlvIGNvbnRleHQgaGFzIGEgc2luZ2xlIFwib25zdGF0ZWNoYW5nZVwiIHByb3BlcnR5LCBhbmQgd2UgaGFkIHRoZSBuZWVkIHRvIHJlZ2lzdGVyIG11bHRpcGxlXHJcbiAqIGxpc3RlbmVycy5cclxuICovXHJcblxyXG5pbXBvcnQgdGFtYm8gZnJvbSAnLi90YW1iby5qcyc7XHJcblxyXG4vLyB0eXBlIGRlZmluaXRpb24gZm9yIGF1ZGlvIGNvbnRleHQgc3RhdGUgY2hhbmdlIGxpc3RlbmVyc1xyXG50eXBlIEF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTGlzdGVuZXIgPSAoICggc3RhdGU6IEF1ZGlvQ29udGV4dFN0YXRlICkgPT4gdm9pZCApO1xyXG5cclxuLy8gQSBsaXN0IG9mIHRoZSBhdWRpbyBjb250ZXh0cyBiZWluZyBtb25pdG9yZWQuIEluIHRoZSBjb2RlIGJlbG93LCBjb250ZXh0cyBzaG91bGQgb25seSBiZSBhZGRlZCwgbmV2ZXIgZGVsZXRlZCwgYW5kXHJcbi8vIHRoaXMgYXJyYXkgc2hvdWxkIG5ldmVyIGJlIHJlb3JkZXJlZC5cclxuY29uc3QgbW9uaXRvcmVkQXVkaW9Db250ZXh0czogQXVkaW9Db250ZXh0W10gPSBbXTtcclxuXHJcbi8vIGEgdHdvLWRpbWVuc2lvbmFsIGxpc3Qgb2YgbGlzdGVuZXJzLCBpbmRleGVkIGJ5IHRoZSBwb3NpdGlvbiBvZiB0aGUgY29ycmVzcG9uZGluZyBhdWRpbyBjb250ZXh0IGluIHRoZSBhcnJheSBhYm92ZVxyXG5jb25zdCBzdGF0ZUNoYW5nZUxpc3RlbmVyQXJyYXlzOiBBdWRpb0NvbnRleHRTdGF0ZUNoYW5nZUxpc3RlbmVyW11bXSA9IFtdO1xyXG5cclxuLy8gdGhlIGRlZmluaXRpb24gb2YgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZVxyXG5jb25zdCBhdWRpb0NvbnRleHRTdGF0ZUNoYW5nZU1vbml0b3IgPSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIGFkZCBhIGxpc3RlbmVyIHRoYXQgd2lsbCBiZSBmaXJlZCBvbiBzdGF0ZSBjaGFuZ2VzIGZvciB0aGUgcHJvdmlkZWQgYXVkaW8gY29udGV4dFxyXG4gICAqL1xyXG4gIGFkZFN0YXRlQ2hhbmdlTGlzdGVuZXIoIGF1ZGlvQ29udGV4dDogQXVkaW9Db250ZXh0LCBsaXN0ZW5lcjogQXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lciApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBGaW5kIHRoZSBhdWRpbyBjb250ZXh0IGluIHRoZSBsaXN0IG9mIHRob3NlIGJlaW5nIG1vbml0b3JlZCwgb3IgYWRkIGl0IGlmIG5vdCBmb3VuZC5cclxuICAgIGxldCBhdWRpb0NvbnRleHRJbmRleCA9IG1vbml0b3JlZEF1ZGlvQ29udGV4dHMuaW5kZXhPZiggYXVkaW9Db250ZXh0ICk7XHJcbiAgICBsZXQgbGlzdGVuZXJBcnJheTogQXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lcltdO1xyXG4gICAgaWYgKCBhdWRpb0NvbnRleHRJbmRleCA9PT0gLTEgKSB7XHJcbiAgICAgIG1vbml0b3JlZEF1ZGlvQ29udGV4dHMucHVzaCggYXVkaW9Db250ZXh0ICk7XHJcbiAgICAgIGF1ZGlvQ29udGV4dEluZGV4ID0gbW9uaXRvcmVkQXVkaW9Db250ZXh0cy5sZW5ndGggLSAxO1xyXG4gICAgICBsaXN0ZW5lckFycmF5ID0gW107IC8vIGNyZWF0ZSBhIG5ldyBsaXN0ZW5lciBhcnJheVxyXG4gICAgICBzdGF0ZUNoYW5nZUxpc3RlbmVyQXJyYXlzLnB1c2goIGxpc3RlbmVyQXJyYXkgKTtcclxuXHJcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGVyZSBpc24ndCBzb21ldGhpbmcgYWxyZWFkeSBsaXN0ZW5pbmcgdG8gdGhpcyBjb250ZXh0J3Mgc3RhdGUgY2hhbmdlXHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoICFhdWRpb0NvbnRleHQub25zdGF0ZWNoYW5nZSwgJ2EgbGlzdGVuZXIgZnVuY3Rpb24gaXMgYWxyZWFkeSByZWdpc3RlcmVkIGZvciB0aGlzIGNvbnRleHQnICk7XHJcblxyXG4gICAgICAvLyBob29rIHVwIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGZpcmUgYWxsIGxpc3RlbmVycyBvbiBhIHN0YXRlIGNoYW5nZVxyXG4gICAgICBhdWRpb0NvbnRleHQub25zdGF0ZWNoYW5nZSA9ICgpID0+IHtcclxuICAgICAgICBfLmNsb25lKCBsaXN0ZW5lckFycmF5ICkuZm9yRWFjaCggbGlzdGVuZXIgPT4ge1xyXG4gICAgICAgICAgbGlzdGVuZXIoIGF1ZGlvQ29udGV4dC5zdGF0ZSApO1xyXG4gICAgICAgIH0gKTtcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBsaXN0ZW5lckFycmF5ID0gc3RhdGVDaGFuZ2VMaXN0ZW5lckFycmF5c1sgYXVkaW9Db250ZXh0SW5kZXggXTtcclxuICAgIH1cclxuXHJcbiAgICBsaXN0ZW5lckFycmF5LnB1c2goIGxpc3RlbmVyICk7XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICogcmVtb3ZlIHRoZSBzdGF0ZSBjaGFuZ2UgbGlzdGVuZXIgZm9yIHRoZSBzcGVjaWZpZWQgYXVkaW8gY29udGV4dFxyXG4gICAqL1xyXG4gIHJlbW92ZVN0YXRlQ2hhbmdlTGlzdGVuZXIoIGF1ZGlvQ29udGV4dDogQXVkaW9Db250ZXh0LCBsaXN0ZW5lcjogQXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VMaXN0ZW5lciApOiB2b2lkIHtcclxuXHJcbiAgICAvLyByZW1vdmUgdGhlIGxpc3RlbmVyIGZvciB0aGUgbGlzdGVuZXIgYXJyYXksIGNoZWNraW5nIGZvciB2YXJpb3VzIHByb2JsZW1zIGFsb25nIHRoZSB3YXlcclxuICAgIGNvbnN0IGF1ZGlvQ29udGV4dEluZGV4ID0gbW9uaXRvcmVkQXVkaW9Db250ZXh0cy5pbmRleE9mKCBhdWRpb0NvbnRleHQgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGF1ZGlvQ29udGV4dEluZGV4ID49IDAsICdhdWRpbyBjb250ZXh0IG5vdCBmb3VuZCcgKTtcclxuICAgIGNvbnN0IGxpc3RlbmVyQXJyYXkgPSBzdGF0ZUNoYW5nZUxpc3RlbmVyQXJyYXlzWyBhdWRpb0NvbnRleHRJbmRleCBdO1xyXG4gICAgY29uc3QgbGlzdGVuZXJJbmRleCA9IGxpc3RlbmVyQXJyYXkuaW5kZXhPZiggbGlzdGVuZXIgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGxpc3RlbmVySW5kZXggPj0gMCwgJ2xpc3RlbmVyIG5vdCBmb3VuZCBmb3Igc3BlY2lmaWVkIGF1ZGlvIGNvbnRleHQnICk7XHJcbiAgICBsaXN0ZW5lckFycmF5LnNwbGljZSggbGlzdGVuZXJJbmRleCwgMSApO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIHRlc3QgaWYgdGhlIHByb3ZpZGVkIGxpc3RlbmVyIGlzIHByZXNlbnQgZm9yIHRoZSBzcGVjaWZpZWQgYXVkaW8gY29udGV4dFxyXG4gICAqL1xyXG4gIGhhc0xpc3RlbmVyKCBhdWRpb0NvbnRleHQ6IEF1ZGlvQ29udGV4dCwgbGlzdGVuZXI6IEF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTGlzdGVuZXIgKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgZm91bmQgPSBmYWxzZTtcclxuICAgIGNvbnN0IGF1ZGlvQ29udGV4dEluZGV4ID0gbW9uaXRvcmVkQXVkaW9Db250ZXh0cy5pbmRleE9mKCBhdWRpb0NvbnRleHQgKTtcclxuICAgIGlmICggYXVkaW9Db250ZXh0SW5kZXggPj0gMCApIHtcclxuICAgICAgY29uc3QgbGlzdGVuZXJBcnJheSA9IHN0YXRlQ2hhbmdlTGlzdGVuZXJBcnJheXNbIGF1ZGlvQ29udGV4dEluZGV4IF07XHJcbiAgICAgIGlmICggbGlzdGVuZXJBcnJheSApIHtcclxuICAgICAgICBmb3VuZCA9IGxpc3RlbmVyQXJyYXkuaW5jbHVkZXMoIGxpc3RlbmVyICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmb3VuZDtcclxuICB9XHJcbn07XHJcblxyXG50YW1iby5yZWdpc3RlciggJ2F1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTW9uaXRvcicsIGF1ZGlvQ29udGV4dFN0YXRlQ2hhbmdlTW9uaXRvciApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgYXVkaW9Db250ZXh0U3RhdGVDaGFuZ2VNb25pdG9yOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxLQUFLLE1BQU0sWUFBWTs7QUFFOUI7O0FBR0E7QUFDQTtBQUNBLE1BQU1DLHNCQUFzQyxHQUFHLEVBQUU7O0FBRWpEO0FBQ0EsTUFBTUMseUJBQThELEdBQUcsRUFBRTs7QUFFekU7QUFDQSxNQUFNQyw4QkFBOEIsR0FBRztFQUVyQztBQUNGO0FBQ0E7RUFDRUMsc0JBQXNCQSxDQUFFQyxZQUEwQixFQUFFQyxRQUF5QyxFQUFTO0lBRXBHO0lBQ0EsSUFBSUMsaUJBQWlCLEdBQUdOLHNCQUFzQixDQUFDTyxPQUFPLENBQUVILFlBQWEsQ0FBQztJQUN0RSxJQUFJSSxhQUFnRDtJQUNwRCxJQUFLRixpQkFBaUIsS0FBSyxDQUFDLENBQUMsRUFBRztNQUM5Qk4sc0JBQXNCLENBQUNTLElBQUksQ0FBRUwsWUFBYSxDQUFDO01BQzNDRSxpQkFBaUIsR0FBR04sc0JBQXNCLENBQUNVLE1BQU0sR0FBRyxDQUFDO01BQ3JERixhQUFhLEdBQUcsRUFBRSxDQUFDLENBQUM7TUFDcEJQLHlCQUF5QixDQUFDUSxJQUFJLENBQUVELGFBQWMsQ0FBQzs7TUFFL0M7TUFDQUcsTUFBTSxJQUFJQSxNQUFNLENBQUUsQ0FBQ1AsWUFBWSxDQUFDUSxhQUFhLEVBQUUsNERBQTZELENBQUM7O01BRTdHO01BQ0FSLFlBQVksQ0FBQ1EsYUFBYSxHQUFHLE1BQU07UUFDakNDLENBQUMsQ0FBQ0MsS0FBSyxDQUFFTixhQUFjLENBQUMsQ0FBQ08sT0FBTyxDQUFFVixRQUFRLElBQUk7VUFDNUNBLFFBQVEsQ0FBRUQsWUFBWSxDQUFDWSxLQUFNLENBQUM7UUFDaEMsQ0FBRSxDQUFDO01BQ0wsQ0FBQztJQUNILENBQUMsTUFDSTtNQUNIUixhQUFhLEdBQUdQLHlCQUF5QixDQUFFSyxpQkFBaUIsQ0FBRTtJQUNoRTtJQUVBRSxhQUFhLENBQUNDLElBQUksQ0FBRUosUUFBUyxDQUFDO0VBQ2hDLENBQUM7RUFFRDtBQUNGO0FBQ0E7RUFDRVkseUJBQXlCQSxDQUFFYixZQUEwQixFQUFFQyxRQUF5QyxFQUFTO0lBRXZHO0lBQ0EsTUFBTUMsaUJBQWlCLEdBQUdOLHNCQUFzQixDQUFDTyxPQUFPLENBQUVILFlBQWEsQ0FBQztJQUN4RU8sTUFBTSxJQUFJQSxNQUFNLENBQUVMLGlCQUFpQixJQUFJLENBQUMsRUFBRSx5QkFBMEIsQ0FBQztJQUNyRSxNQUFNRSxhQUFhLEdBQUdQLHlCQUF5QixDQUFFSyxpQkFBaUIsQ0FBRTtJQUNwRSxNQUFNWSxhQUFhLEdBQUdWLGFBQWEsQ0FBQ0QsT0FBTyxDQUFFRixRQUFTLENBQUM7SUFDdkRNLE1BQU0sSUFBSUEsTUFBTSxDQUFFTyxhQUFhLElBQUksQ0FBQyxFQUFFLGdEQUFpRCxDQUFDO0lBQ3hGVixhQUFhLENBQUNXLE1BQU0sQ0FBRUQsYUFBYSxFQUFFLENBQUUsQ0FBQztFQUMxQyxDQUFDO0VBRUQ7QUFDRjtBQUNBO0VBQ0VFLFdBQVdBLENBQUVoQixZQUEwQixFQUFFQyxRQUF5QyxFQUFZO0lBQzVGLElBQUlnQixLQUFLLEdBQUcsS0FBSztJQUNqQixNQUFNZixpQkFBaUIsR0FBR04sc0JBQXNCLENBQUNPLE9BQU8sQ0FBRUgsWUFBYSxDQUFDO0lBQ3hFLElBQUtFLGlCQUFpQixJQUFJLENBQUMsRUFBRztNQUM1QixNQUFNRSxhQUFhLEdBQUdQLHlCQUF5QixDQUFFSyxpQkFBaUIsQ0FBRTtNQUNwRSxJQUFLRSxhQUFhLEVBQUc7UUFDbkJhLEtBQUssR0FBR2IsYUFBYSxDQUFDYyxRQUFRLENBQUVqQixRQUFTLENBQUM7TUFDNUM7SUFDRjtJQUNBLE9BQU9nQixLQUFLO0VBQ2Q7QUFDRixDQUFDO0FBRUR0QixLQUFLLENBQUN3QixRQUFRLENBQUUsZ0NBQWdDLEVBQUVyQiw4QkFBK0IsQ0FBQztBQUVsRixlQUFlQSw4QkFBOEIifQ==