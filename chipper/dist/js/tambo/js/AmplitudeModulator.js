// Copyright 2020-2022, University of Colorado Boulder

/**
 * AmplitudeModulator instances can be used to create low-frequency amplitude oscillation effects on a loop, oscillator,
 * or other steady sound source.  It is not a sound generator itself, and is instead intended to be used as a component
 * within a sound generator.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import NumberProperty from '../../axon/js/NumberProperty.js';
import EnabledComponent from '../../axon/js/EnabledComponent.js';
import phetAudioContext from './phetAudioContext.js';
import tambo from './tambo.js';
import optionize from '../../phet-core/js/optionize.js';
import Property from '../../axon/js/Property.js';
// constants
const DEFAULT_FREQUENCY = 5; // Hz
const DEFAULT_DEPTH = 0.9; // proportion
const DEFAULT_WAVEFORM = 'sine'; // proportion

class AmplitudeModulator extends EnabledComponent {
  // frequency of the oscillation, generally pretty low, like 1 to 20 or so

  // depth of modulation, 0 for none, 1 for full modulation

  // Web Audio oscillator type

  // the main gain node that is modulated in order to produce the amplitude modulation effect

  // dispose function

  constructor(providedOptions) {
    const options = optionize()({
      frequencyProperty: null,
      depthProperty: null,
      waveformProperty: null
    }, providedOptions);
    super(options);
    assert && assert(this.enabledProperty instanceof Property, 'enabledProperty must be of type Property');
    this.myEnabledProperty = this.enabledProperty;
    this.frequencyProperty = options.frequencyProperty || new NumberProperty(DEFAULT_FREQUENCY);
    this.depthProperty = options.depthProperty || new NumberProperty(DEFAULT_DEPTH);
    this.waveformProperty = options.waveformProperty || new Property(DEFAULT_WAVEFORM);
    this.modulatedGainNode = phetAudioContext.createGain();
    this.modulatedGainNode.gain.value = 0.5; // this value is added to the attenuated LFO output value

    // A gain node that attenuates the output of the LFO.  This modifies the oscillator output to range from a max
    // range of -0.5 to 0.5, which is shifted up later in the chain to go from 0 to 1.
    const lfoAttenuator = phetAudioContext.createGain();
    lfoAttenuator.connect(this.modulatedGainNode.gain);
    let lowFrequencyOscillator = null;

    // hook up the LFO-control properties
    const enabledListener = enabled => {
      const now = phetAudioContext.currentTime;
      if (enabled) {
        // state checking
        assert && assert(!lowFrequencyOscillator, 'LFO should\'t exist yet on transition to enabled');

        // set up the modulation
        const depth = this.depthProperty.value;
        lfoAttenuator.gain.setValueAtTime(depth / 2, phetAudioContext.currentTime);
        this.modulatedGainNode.gain.setValueAtTime(1 - depth / 2, phetAudioContext.currentTime);

        // create, configure, and start the LFO
        lowFrequencyOscillator = phetAudioContext.createOscillator();
        lowFrequencyOscillator.frequency.setValueAtTime(this.frequencyProperty.value, now);
        lowFrequencyOscillator.type = this.waveformProperty.value;
        lowFrequencyOscillator.connect(lfoAttenuator);
        lowFrequencyOscillator.start();
      } else {
        // Stop the oscillator.  According to the spec, there is no need to disconnect - it's automatic.
        lowFrequencyOscillator.stop();
        lowFrequencyOscillator = null;

        // Set the gain to 1 so that this will act as a pass-through with no effect on the signal.
        this.modulatedGainNode.gain.setValueAtTime(1, now);
      }
    };
    this.enabledProperty.link(enabledListener);
    const depthListener = depth => {
      if (lowFrequencyOscillator) {
        lfoAttenuator.gain.setValueAtTime(depth / 2, phetAudioContext.currentTime);
        this.modulatedGainNode.gain.setValueAtTime(1 - depth / 2, phetAudioContext.currentTime);
      }
    };
    this.depthProperty.link(depthListener);
    const waveformListener = waveform => {
      if (lowFrequencyOscillator) {
        lowFrequencyOscillator.type = waveform;
      }
    };
    this.waveformProperty.link(waveformListener);
    const frequencyListener = frequency => {
      if (lowFrequencyOscillator) {
        lowFrequencyOscillator.frequency.setValueAtTime(frequency, phetAudioContext.currentTime);
      }
    };
    this.frequencyProperty.link(frequencyListener);

    // dispose function
    this.disposeAmplitudeModulator = () => {
      this.enabledProperty.unlink(enabledListener);
      this.depthProperty.unlink(depthListener);
      this.waveformProperty.unlink(waveformListener);
      this.frequencyProperty.unlink(frequencyListener);
    };
  }

  /**
   * Clean up memory references to avoid memory leaks.
   */
  dispose() {
    this.disposeAmplitudeModulator();
    super.dispose();
  }

  /**
   * Get the gain node to which connections should occur.
   */
  getConnectionPoint() {
    return this.modulatedGainNode;
  }

  /**
   * Connect the output of this modulator to a destination.
   */
  connect(destination) {
    this.modulatedGainNode.connect(destination);
  }
}
tambo.register('AmplitudeModulator', AmplitudeModulator);
export default AmplitudeModulator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOdW1iZXJQcm9wZXJ0eSIsIkVuYWJsZWRDb21wb25lbnQiLCJwaGV0QXVkaW9Db250ZXh0IiwidGFtYm8iLCJvcHRpb25pemUiLCJQcm9wZXJ0eSIsIkRFRkFVTFRfRlJFUVVFTkNZIiwiREVGQVVMVF9ERVBUSCIsIkRFRkFVTFRfV0FWRUZPUk0iLCJBbXBsaXR1ZGVNb2R1bGF0b3IiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJmcmVxdWVuY3lQcm9wZXJ0eSIsImRlcHRoUHJvcGVydHkiLCJ3YXZlZm9ybVByb3BlcnR5IiwiYXNzZXJ0IiwiZW5hYmxlZFByb3BlcnR5IiwibXlFbmFibGVkUHJvcGVydHkiLCJtb2R1bGF0ZWRHYWluTm9kZSIsImNyZWF0ZUdhaW4iLCJnYWluIiwidmFsdWUiLCJsZm9BdHRlbnVhdG9yIiwiY29ubmVjdCIsImxvd0ZyZXF1ZW5jeU9zY2lsbGF0b3IiLCJlbmFibGVkTGlzdGVuZXIiLCJlbmFibGVkIiwibm93IiwiY3VycmVudFRpbWUiLCJkZXB0aCIsInNldFZhbHVlQXRUaW1lIiwiY3JlYXRlT3NjaWxsYXRvciIsImZyZXF1ZW5jeSIsInR5cGUiLCJzdGFydCIsInN0b3AiLCJsaW5rIiwiZGVwdGhMaXN0ZW5lciIsIndhdmVmb3JtTGlzdGVuZXIiLCJ3YXZlZm9ybSIsImZyZXF1ZW5jeUxpc3RlbmVyIiwiZGlzcG9zZUFtcGxpdHVkZU1vZHVsYXRvciIsInVubGluayIsImRpc3Bvc2UiLCJnZXRDb25uZWN0aW9uUG9pbnQiLCJkZXN0aW5hdGlvbiIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQW1wbGl0dWRlTW9kdWxhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEFtcGxpdHVkZU1vZHVsYXRvciBpbnN0YW5jZXMgY2FuIGJlIHVzZWQgdG8gY3JlYXRlIGxvdy1mcmVxdWVuY3kgYW1wbGl0dWRlIG9zY2lsbGF0aW9uIGVmZmVjdHMgb24gYSBsb29wLCBvc2NpbGxhdG9yLFxyXG4gKiBvciBvdGhlciBzdGVhZHkgc291bmQgc291cmNlLiAgSXQgaXMgbm90IGEgc291bmQgZ2VuZXJhdG9yIGl0c2VsZiwgYW5kIGlzIGluc3RlYWQgaW50ZW5kZWQgdG8gYmUgdXNlZCBhcyBhIGNvbXBvbmVudFxyXG4gKiB3aXRoaW4gYSBzb3VuZCBnZW5lcmF0b3IuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY28gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IE51bWJlclByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvTnVtYmVyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRW5hYmxlZENvbXBvbmVudCwgeyBFbmFibGVkQ29tcG9uZW50T3B0aW9ucyB9IGZyb20gJy4uLy4uL2F4b24vanMvRW5hYmxlZENvbXBvbmVudC5qcyc7XHJcbmltcG9ydCBwaGV0QXVkaW9Db250ZXh0IGZyb20gJy4vcGhldEF1ZGlvQ29udGV4dC5qcyc7XHJcbmltcG9ydCB0YW1ibyBmcm9tICcuL3RhbWJvLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgU3RyaWN0T21pdCBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvU3RyaWN0T21pdC5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBjb250cm9scyB0aGUgZnJlcXVlbmN5IG9mIG1vZHVsYXRpb24sIGNyZWF0ZWQgaWYgbm90IHN1cHBsaWVkXHJcbiAgZnJlcXVlbmN5UHJvcGVydHk/OiBOdW1iZXJQcm9wZXJ0eSB8IG51bGw7XHJcblxyXG4gIC8vIGNvbnRyb2xzIHRoZSBkZXB0aCBvZiBtb2R1bGF0aW9uLCAwIG1lYW5zIG5vIG1vZHVsYXRpb24sIDEgaXMgdGhlIG1heCwgY3JlYXRlZCBpZiBub3Qgc3VwcGxpZWRcclxuICBkZXB0aFByb3BlcnR5PzogTnVtYmVyUHJvcGVydHkgfCBudWxsO1xyXG5cclxuICAvLyBDb250cm9scyB0aGUgdHlwZSBvZiB3YXZlZm9ybSBiZWluZyB1c2VkIGZvciB0aGUgbW9kdWxhdGlvbiwgc2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBXZWIgQXVkaW8gT3NjaWxsYXRvck5vZGUgZm9yXHJcbiAgLy8gdGhlIGF2YWlsYWJsZSB0eXBlcy4gIENyZWF0ZWQgaWYgbm90IHN1cHBsaWVkLlxyXG4gIHdhdmVmb3JtUHJvcGVydHk/OiBQcm9wZXJ0eTxPc2NpbGxhdG9yVHlwZT4gfCBudWxsO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgQW1wbGl0dWRlTW9kdWxhdG9yT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgU3RyaWN0T21pdDxFbmFibGVkQ29tcG9uZW50T3B0aW9ucywgJ2VuYWJsZWRQcm9wZXJ0eSc+O1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IERFRkFVTFRfRlJFUVVFTkNZID0gNTsgLy8gSHpcclxuY29uc3QgREVGQVVMVF9ERVBUSCA9IDAuOTsgLy8gcHJvcG9ydGlvblxyXG5jb25zdCBERUZBVUxUX1dBVkVGT1JNID0gJ3NpbmUnOyAvLyBwcm9wb3J0aW9uXHJcblxyXG5jbGFzcyBBbXBsaXR1ZGVNb2R1bGF0b3IgZXh0ZW5kcyBFbmFibGVkQ29tcG9uZW50IHtcclxuXHJcbiAgLy8gZnJlcXVlbmN5IG9mIHRoZSBvc2NpbGxhdGlvbiwgZ2VuZXJhbGx5IHByZXR0eSBsb3csIGxpa2UgMSB0byAyMCBvciBzb1xyXG4gIHB1YmxpYyByZWFkb25seSBmcmVxdWVuY3lQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHk7XHJcblxyXG4gIC8vIGRlcHRoIG9mIG1vZHVsYXRpb24sIDAgZm9yIG5vbmUsIDEgZm9yIGZ1bGwgbW9kdWxhdGlvblxyXG4gIHB1YmxpYyByZWFkb25seSBkZXB0aFByb3BlcnR5OiBOdW1iZXJQcm9wZXJ0eTtcclxuXHJcbiAgLy8gV2ViIEF1ZGlvIG9zY2lsbGF0b3IgdHlwZVxyXG4gIHB1YmxpYyByZWFkb25seSB3YXZlZm9ybVByb3BlcnR5OiBQcm9wZXJ0eTxPc2NpbGxhdG9yVHlwZT47XHJcblxyXG4gIC8vIHRoZSBtYWluIGdhaW4gbm9kZSB0aGF0IGlzIG1vZHVsYXRlZCBpbiBvcmRlciB0byBwcm9kdWNlIHRoZSBhbXBsaXR1ZGUgbW9kdWxhdGlvbiBlZmZlY3RcclxuICBwcml2YXRlIHJlYWRvbmx5IG1vZHVsYXRlZEdhaW5Ob2RlOiBHYWluTm9kZTtcclxuXHJcbiAgLy8gZGlzcG9zZSBmdW5jdGlvblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zZUFtcGxpdHVkZU1vZHVsYXRvcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IG15RW5hYmxlZFByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcm92aWRlZE9wdGlvbnM/OiBBbXBsaXR1ZGVNb2R1bGF0b3JPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8QW1wbGl0dWRlTW9kdWxhdG9yT3B0aW9ucywgU2VsZk9wdGlvbnMsIEVuYWJsZWRDb21wb25lbnRPcHRpb25zPigpKCB7XHJcbiAgICAgIGZyZXF1ZW5jeVByb3BlcnR5OiBudWxsLFxyXG4gICAgICBkZXB0aFByb3BlcnR5OiBudWxsLFxyXG4gICAgICB3YXZlZm9ybVByb3BlcnR5OiBudWxsXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMuZW5hYmxlZFByb3BlcnR5IGluc3RhbmNlb2YgUHJvcGVydHksICdlbmFibGVkUHJvcGVydHkgbXVzdCBiZSBvZiB0eXBlIFByb3BlcnR5JyApO1xyXG4gICAgdGhpcy5teUVuYWJsZWRQcm9wZXJ0eSA9IHRoaXMuZW5hYmxlZFByb3BlcnR5IGFzIFByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAgIHRoaXMuZnJlcXVlbmN5UHJvcGVydHkgPSBvcHRpb25zLmZyZXF1ZW5jeVByb3BlcnR5IHx8IG5ldyBOdW1iZXJQcm9wZXJ0eSggREVGQVVMVF9GUkVRVUVOQ1kgKTtcclxuICAgIHRoaXMuZGVwdGhQcm9wZXJ0eSA9IG9wdGlvbnMuZGVwdGhQcm9wZXJ0eSB8fCBuZXcgTnVtYmVyUHJvcGVydHkoIERFRkFVTFRfREVQVEggKTtcclxuICAgIHRoaXMud2F2ZWZvcm1Qcm9wZXJ0eSA9IG9wdGlvbnMud2F2ZWZvcm1Qcm9wZXJ0eSB8fCBuZXcgUHJvcGVydHk8T3NjaWxsYXRvclR5cGU+KCBERUZBVUxUX1dBVkVGT1JNICk7XHJcbiAgICB0aGlzLm1vZHVsYXRlZEdhaW5Ob2RlID0gcGhldEF1ZGlvQ29udGV4dC5jcmVhdGVHYWluKCk7XHJcbiAgICB0aGlzLm1vZHVsYXRlZEdhaW5Ob2RlLmdhaW4udmFsdWUgPSAwLjU7IC8vIHRoaXMgdmFsdWUgaXMgYWRkZWQgdG8gdGhlIGF0dGVudWF0ZWQgTEZPIG91dHB1dCB2YWx1ZVxyXG5cclxuICAgIC8vIEEgZ2FpbiBub2RlIHRoYXQgYXR0ZW51YXRlcyB0aGUgb3V0cHV0IG9mIHRoZSBMRk8uICBUaGlzIG1vZGlmaWVzIHRoZSBvc2NpbGxhdG9yIG91dHB1dCB0byByYW5nZSBmcm9tIGEgbWF4XHJcbiAgICAvLyByYW5nZSBvZiAtMC41IHRvIDAuNSwgd2hpY2ggaXMgc2hpZnRlZCB1cCBsYXRlciBpbiB0aGUgY2hhaW4gdG8gZ28gZnJvbSAwIHRvIDEuXHJcbiAgICBjb25zdCBsZm9BdHRlbnVhdG9yID0gcGhldEF1ZGlvQ29udGV4dC5jcmVhdGVHYWluKCk7XHJcbiAgICBsZm9BdHRlbnVhdG9yLmNvbm5lY3QoIHRoaXMubW9kdWxhdGVkR2Fpbk5vZGUuZ2FpbiApO1xyXG5cclxuICAgIGxldCBsb3dGcmVxdWVuY3lPc2NpbGxhdG9yOiBPc2NpbGxhdG9yTm9kZSB8IG51bGwgPSBudWxsO1xyXG5cclxuICAgIC8vIGhvb2sgdXAgdGhlIExGTy1jb250cm9sIHByb3BlcnRpZXNcclxuICAgIGNvbnN0IGVuYWJsZWRMaXN0ZW5lciA9ICggZW5hYmxlZDogYm9vbGVhbiApID0+IHtcclxuICAgICAgY29uc3Qgbm93ID0gcGhldEF1ZGlvQ29udGV4dC5jdXJyZW50VGltZTtcclxuICAgICAgaWYgKCBlbmFibGVkICkge1xyXG5cclxuICAgICAgICAvLyBzdGF0ZSBjaGVja2luZ1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoICFsb3dGcmVxdWVuY3lPc2NpbGxhdG9yLCAnTEZPIHNob3VsZFxcJ3QgZXhpc3QgeWV0IG9uIHRyYW5zaXRpb24gdG8gZW5hYmxlZCcgKTtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVwIHRoZSBtb2R1bGF0aW9uXHJcbiAgICAgICAgY29uc3QgZGVwdGggPSB0aGlzLmRlcHRoUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgbGZvQXR0ZW51YXRvci5nYWluLnNldFZhbHVlQXRUaW1lKCBkZXB0aCAvIDIsIHBoZXRBdWRpb0NvbnRleHQuY3VycmVudFRpbWUgKTtcclxuICAgICAgICB0aGlzLm1vZHVsYXRlZEdhaW5Ob2RlLmdhaW4uc2V0VmFsdWVBdFRpbWUoIDEgLSBkZXB0aCAvIDIsIHBoZXRBdWRpb0NvbnRleHQuY3VycmVudFRpbWUgKTtcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlLCBjb25maWd1cmUsIGFuZCBzdGFydCB0aGUgTEZPXHJcbiAgICAgICAgbG93RnJlcXVlbmN5T3NjaWxsYXRvciA9IHBoZXRBdWRpb0NvbnRleHQuY3JlYXRlT3NjaWxsYXRvcigpO1xyXG4gICAgICAgIGxvd0ZyZXF1ZW5jeU9zY2lsbGF0b3IuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKCB0aGlzLmZyZXF1ZW5jeVByb3BlcnR5LnZhbHVlLCBub3cgKTtcclxuICAgICAgICBsb3dGcmVxdWVuY3lPc2NpbGxhdG9yLnR5cGUgPSB0aGlzLndhdmVmb3JtUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgbG93RnJlcXVlbmN5T3NjaWxsYXRvci5jb25uZWN0KCBsZm9BdHRlbnVhdG9yICk7XHJcbiAgICAgICAgbG93RnJlcXVlbmN5T3NjaWxsYXRvci5zdGFydCgpO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBTdG9wIHRoZSBvc2NpbGxhdG9yLiAgQWNjb3JkaW5nIHRvIHRoZSBzcGVjLCB0aGVyZSBpcyBubyBuZWVkIHRvIGRpc2Nvbm5lY3QgLSBpdCdzIGF1dG9tYXRpYy5cclxuICAgICAgICBsb3dGcmVxdWVuY3lPc2NpbGxhdG9yIS5zdG9wKCk7XHJcbiAgICAgICAgbG93RnJlcXVlbmN5T3NjaWxsYXRvciA9IG51bGw7XHJcblxyXG4gICAgICAgIC8vIFNldCB0aGUgZ2FpbiB0byAxIHNvIHRoYXQgdGhpcyB3aWxsIGFjdCBhcyBhIHBhc3MtdGhyb3VnaCB3aXRoIG5vIGVmZmVjdCBvbiB0aGUgc2lnbmFsLlxyXG4gICAgICAgIHRoaXMubW9kdWxhdGVkR2Fpbk5vZGUuZ2Fpbi5zZXRWYWx1ZUF0VGltZSggMSwgbm93ICk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLmVuYWJsZWRQcm9wZXJ0eS5saW5rKCBlbmFibGVkTGlzdGVuZXIgKTtcclxuXHJcbiAgICBjb25zdCBkZXB0aExpc3RlbmVyID0gKCBkZXB0aDogbnVtYmVyICkgPT4ge1xyXG4gICAgICBpZiAoIGxvd0ZyZXF1ZW5jeU9zY2lsbGF0b3IgKSB7XHJcbiAgICAgICAgbGZvQXR0ZW51YXRvci5nYWluLnNldFZhbHVlQXRUaW1lKCBkZXB0aCAvIDIsIHBoZXRBdWRpb0NvbnRleHQuY3VycmVudFRpbWUgKTtcclxuICAgICAgICB0aGlzLm1vZHVsYXRlZEdhaW5Ob2RlLmdhaW4uc2V0VmFsdWVBdFRpbWUoIDEgLSBkZXB0aCAvIDIsIHBoZXRBdWRpb0NvbnRleHQuY3VycmVudFRpbWUgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHRoaXMuZGVwdGhQcm9wZXJ0eS5saW5rKCBkZXB0aExpc3RlbmVyICk7XHJcblxyXG4gICAgY29uc3Qgd2F2ZWZvcm1MaXN0ZW5lciA9ICggd2F2ZWZvcm06IE9zY2lsbGF0b3JUeXBlICkgPT4ge1xyXG4gICAgICBpZiAoIGxvd0ZyZXF1ZW5jeU9zY2lsbGF0b3IgKSB7XHJcbiAgICAgICAgbG93RnJlcXVlbmN5T3NjaWxsYXRvci50eXBlID0gd2F2ZWZvcm07XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLndhdmVmb3JtUHJvcGVydHkubGluayggd2F2ZWZvcm1MaXN0ZW5lciApO1xyXG5cclxuICAgIGNvbnN0IGZyZXF1ZW5jeUxpc3RlbmVyID0gKCBmcmVxdWVuY3k6IG51bWJlciApID0+IHtcclxuICAgICAgaWYgKCBsb3dGcmVxdWVuY3lPc2NpbGxhdG9yICkge1xyXG4gICAgICAgIGxvd0ZyZXF1ZW5jeU9zY2lsbGF0b3IuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKCBmcmVxdWVuY3ksIHBoZXRBdWRpb0NvbnRleHQuY3VycmVudFRpbWUgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHRoaXMuZnJlcXVlbmN5UHJvcGVydHkubGluayggZnJlcXVlbmN5TGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBkaXNwb3NlIGZ1bmN0aW9uXHJcbiAgICB0aGlzLmRpc3Bvc2VBbXBsaXR1ZGVNb2R1bGF0b3IgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMuZW5hYmxlZFByb3BlcnR5LnVubGluayggZW5hYmxlZExpc3RlbmVyICk7XHJcbiAgICAgIHRoaXMuZGVwdGhQcm9wZXJ0eS51bmxpbmsoIGRlcHRoTGlzdGVuZXIgKTtcclxuICAgICAgdGhpcy53YXZlZm9ybVByb3BlcnR5LnVubGluayggd2F2ZWZvcm1MaXN0ZW5lciApO1xyXG4gICAgICB0aGlzLmZyZXF1ZW5jeVByb3BlcnR5LnVubGluayggZnJlcXVlbmN5TGlzdGVuZXIgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhbiB1cCBtZW1vcnkgcmVmZXJlbmNlcyB0byBhdm9pZCBtZW1vcnkgbGVha3MuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3Bvc2VBbXBsaXR1ZGVNb2R1bGF0b3IoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB0aGUgZ2FpbiBub2RlIHRvIHdoaWNoIGNvbm5lY3Rpb25zIHNob3VsZCBvY2N1ci5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Q29ubmVjdGlvblBvaW50KCk6IEdhaW5Ob2RlIHtcclxuICAgIHJldHVybiB0aGlzLm1vZHVsYXRlZEdhaW5Ob2RlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29ubmVjdCB0aGUgb3V0cHV0IG9mIHRoaXMgbW9kdWxhdG9yIHRvIGEgZGVzdGluYXRpb24uXHJcbiAgICovXHJcbiAgcHVibGljIGNvbm5lY3QoIGRlc3RpbmF0aW9uOiBBdWRpb05vZGUgfCBBdWRpb1BhcmFtICk6IHZvaWQge1xyXG4gICAgdGhpcy5tb2R1bGF0ZWRHYWluTm9kZS5jb25uZWN0KCBkZXN0aW5hdGlvbiBhcyBBdWRpb05vZGUgKTtcclxuICB9XHJcbn1cclxuXHJcbnRhbWJvLnJlZ2lzdGVyKCAnQW1wbGl0dWRlTW9kdWxhdG9yJywgQW1wbGl0dWRlTW9kdWxhdG9yICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBBbXBsaXR1ZGVNb2R1bGF0b3I7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxjQUFjLE1BQU0saUNBQWlDO0FBQzVELE9BQU9DLGdCQUFnQixNQUFtQyxtQ0FBbUM7QUFDN0YsT0FBT0MsZ0JBQWdCLE1B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