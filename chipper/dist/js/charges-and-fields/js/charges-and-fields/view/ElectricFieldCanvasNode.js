// Copyright 2016-2021, University of Colorado Boulder

/**
 * View for the electric field arrows that uses Canvas
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { CanvasNode } from '../../../../scenery/js/imports.js';
import chargesAndFields from '../../chargesAndFields.js';
import ChargesAndFieldsColors from '../ChargesAndFieldsColors.js';
import ChargesAndFieldsConstants from '../ChargesAndFieldsConstants.js';
import ChargeTracker from './ChargeTracker.js';
import ElectricFieldArrowCanvas from './ElectricFieldArrowCanvas.js';

// Spacing in the model coordinate frame.
const ELECTRIC_FIELD_SENSOR_SPACING = ChargesAndFieldsConstants.ELECTRIC_FIELD_SENSOR_SPACING;
const MIN_VISIBLE_ELECTRIC_FIELD_MAG = 1e-9; // V/m

const scratchVector = new Vector2(0, 0);
class ElectricFieldCanvasNode extends CanvasNode {
  /**
   * @param {ObservableArrayDef.<ChargedParticle>} chargedParticles - only chargedParticles that active are in this array
   * @param {ModelViewTransform2} modelViewTransform
   * @param {Bounds2} modelBounds - The bounds in the model that need to be drawn
   * @param {Property.<boolean>} isElectricFieldDirectionOnlyProperty
   * @param {Property.<boolean>} isVisibleProperty
   */
  constructor(chargedParticles, modelViewTransform, modelBounds, isElectricFieldDirectionOnlyProperty, isVisibleProperty) {
    super({
      canvasBounds: modelViewTransform.modelToViewBounds(modelBounds)
    });
    this.chargeTracker = new ChargeTracker(chargedParticles);
    this.modelViewTransform = modelViewTransform;
    this.modelBounds = modelBounds;
    this.viewBounds = this.modelViewTransform.modelToViewBounds(modelBounds);
    this.isElectricFieldDirectionOnlyProperty = isElectricFieldDirectionOnlyProperty;
    this.isVisibleProperty = isVisibleProperty;

    // Invalidate paint on a bunch of changes
    const invalidateSelfListener = this.invalidatePaint.bind(this);
    ChargesAndFieldsColors.electricFieldGridSaturationProperty.link(invalidateSelfListener); // color change

    isVisibleProperty.link(invalidateSelfListener); // visibility change

    isElectricFieldDirectionOnlyProperty.link(invalidateSelfListener); // visibility change

    chargedParticles.addItemAddedListener(particle => particle.positionProperty.link(invalidateSelfListener)); // particle added

    chargedParticles.addItemRemovedListener(particle => {
      invalidateSelfListener();
      particle.positionProperty.unlink(invalidateSelfListener);
    }); // particle removed

    isVisibleProperty.linkAttribute(this, 'visible');
    this.modelPositions = []; // {Array.<Vector2>}
    const width = modelBounds.width;
    const height = modelBounds.height;
    const numHorizontal = Math.ceil(width / ELECTRIC_FIELD_SENSOR_SPACING);
    const numVertical = Math.ceil(height / ELECTRIC_FIELD_SENSOR_SPACING);
    for (let row = 0; row < numVertical; row++) {
      const y = modelBounds.minY + (row + 0.5) * height / numVertical;
      for (let col = 0; col < numHorizontal; col++) {
        const x = modelBounds.minX + (col + 0.5) * width / numHorizontal;
        this.modelPositions.push(new Vector2(x, y));
      }
    }

    // {Array.<Vector2>}
    this.viewPositions = this.modelPositions.map(position => modelViewTransform.modelToViewPosition(position));

    // {Array.<Vector2>}, where electricField[ i ] is the 2D field at positions[ i ]
    this.electricField = this.modelPositions.map(() => new Vector2(0, 0));
    this.disposeElectricFieldCanvasNode = () => {
      isVisibleProperty.unlink(invalidateSelfListener); // visibility change
      isElectricFieldDirectionOnlyProperty.unlink(invalidateSelfListener); // visibility change
    };
  }

  /**
   * @private
   */
  updateElectricPotentials() {
    const kConstant = ChargesAndFieldsConstants.K_CONSTANT;
    const numChanges = this.chargeTracker.queue.length;
    for (let i = 0; i < numChanges; i++) {
      const item = this.chargeTracker.queue[i];
      const oldPosition = item.oldPosition;
      const newPosition = item.newPosition;
      const charge = item.charge;
      for (let j = 0; j < this.modelPositions.length; j++) {
        const position = this.modelPositions[j];
        const electricField = this.electricField[j];
        if (oldPosition) {
          const oldDistanceSquared = position.distanceSquared(oldPosition);
          if (oldDistanceSquared !== 0) {
            electricField.subtract(scratchVector.set(position).subtract(oldPosition).multiplyScalar(kConstant * charge / Math.pow(oldDistanceSquared, 1.5)));
          }
        }
        if (newPosition) {
          const newDistanceSquared = position.distanceSquared(newPosition);
          if (newDistanceSquared !== 0) {
            electricField.add(scratchVector.set(position).subtract(newPosition).multiplyScalar(kConstant * charge / Math.pow(newDistanceSquared, 1.5)));
          }
        }
      }
    }
    this.chargeTracker.clear();
  }

  /**
   * Function responsible for painting electric field arrows
   * @override
   * @public
   * @param {CanvasRenderingContext2D} context
   */
  paintCanvas(context) {
    this.updateElectricPotentials();
    const isDirectionOnly = this.isElectricFieldDirectionOnlyProperty.get();
    const maxMagnitude = ChargesAndFieldsConstants.EFIELD_COLOR_SAT_MAGNITUDE;
    for (let i = 0; i < this.viewPositions.length; i++) {
      const viewPosition = this.viewPositions[i];
      const electricField = this.electricField[i];
      context.save();
      context.globalAlpha = Utils.clamp(electricField.magnitude / maxMagnitude, 0, 1);
      if (isDirectionOnly && electricField.magnitude > MIN_VISIBLE_ELECTRIC_FIELD_MAG) {
        context.globalAlpha = 1.0;
      }
      context.translate(viewPosition.x, viewPosition.y);
      context.rotate(-electricField.angle);
      context.scale(1 / ElectricFieldArrowCanvas.scale, 1 / ElectricFieldArrowCanvas.scale);
      context.translate(ElectricFieldArrowCanvas.xOffset, ElectricFieldArrowCanvas.yOffset);
      context.drawImage(ElectricFieldArrowCanvas.canvas, 0, 0);
      context.restore();
    }
  }

  /**
   * Releases references
   * @public
   */
  dispose() {
    this.disposeElectricFieldCanvasNode();
  }
}
chargesAndFields.register('ElectricFieldCanvasNode', ElectricFieldCanvasNode);
export default ElectricFieldCanvasNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlZlY3RvcjIiLCJDYW52YXNOb2RlIiwiY2hhcmdlc0FuZEZpZWxkcyIsIkNoYXJnZXNBbmRGaWVsZHNDb2xvcnMiLCJDaGFyZ2VzQW5kRmllbGRzQ29uc3RhbnRzIiwiQ2hhcmdlVHJhY2tlciIsIkVsZWN0cmljRmllbGRBcnJvd0NhbnZhcyIsIkVMRUNUUklDX0ZJRUxEX1NFTlNPUl9TUEFDSU5HIiwiTUlOX1ZJU0lCTEVfRUxFQ1RSSUNfRklFTERfTUFHIiwic2NyYXRjaFZlY3RvciIsIkVsZWN0cmljRmllbGRDYW52YXNOb2RlIiwiY29uc3RydWN0b3IiLCJjaGFyZ2VkUGFydGljbGVzIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwibW9kZWxCb3VuZHMiLCJpc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHkiLCJpc1Zpc2libGVQcm9wZXJ0eSIsImNhbnZhc0JvdW5kcyIsIm1vZGVsVG9WaWV3Qm91bmRzIiwiY2hhcmdlVHJhY2tlciIsInZpZXdCb3VuZHMiLCJpbnZhbGlkYXRlU2VsZkxpc3RlbmVyIiwiaW52YWxpZGF0ZVBhaW50IiwiYmluZCIsImVsZWN0cmljRmllbGRHcmlkU2F0dXJhdGlvblByb3BlcnR5IiwibGluayIsImFkZEl0ZW1BZGRlZExpc3RlbmVyIiwicGFydGljbGUiLCJwb3NpdGlvblByb3BlcnR5IiwiYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciIsInVubGluayIsImxpbmtBdHRyaWJ1dGUiLCJtb2RlbFBvc2l0aW9ucyIsIndpZHRoIiwiaGVpZ2h0IiwibnVtSG9yaXpvbnRhbCIsIk1hdGgiLCJjZWlsIiwibnVtVmVydGljYWwiLCJyb3ciLCJ5IiwibWluWSIsImNvbCIsIngiLCJtaW5YIiwicHVzaCIsInZpZXdQb3NpdGlvbnMiLCJtYXAiLCJwb3NpdGlvbiIsIm1vZGVsVG9WaWV3UG9zaXRpb24iLCJlbGVjdHJpY0ZpZWxkIiwiZGlzcG9zZUVsZWN0cmljRmllbGRDYW52YXNOb2RlIiwidXBkYXRlRWxlY3RyaWNQb3RlbnRpYWxzIiwia0NvbnN0YW50IiwiS19DT05TVEFOVCIsIm51bUNoYW5nZXMiLCJxdWV1ZSIsImxlbmd0aCIsImkiLCJpdGVtIiwib2xkUG9zaXRpb24iLCJuZXdQb3NpdGlvbiIsImNoYXJnZSIsImoiLCJvbGREaXN0YW5jZVNxdWFyZWQiLCJkaXN0YW5jZVNxdWFyZWQiLCJzdWJ0cmFjdCIsInNldCIsIm11bHRpcGx5U2NhbGFyIiwicG93IiwibmV3RGlzdGFuY2VTcXVhcmVkIiwiYWRkIiwiY2xlYXIiLCJwYWludENhbnZhcyIsImNvbnRleHQiLCJpc0RpcmVjdGlvbk9ubHkiLCJnZXQiLCJtYXhNYWduaXR1ZGUiLCJFRklFTERfQ09MT1JfU0FUX01BR05JVFVERSIsInZpZXdQb3NpdGlvbiIsInNhdmUiLCJnbG9iYWxBbHBoYSIsImNsYW1wIiwibWFnbml0dWRlIiwidHJhbnNsYXRlIiwicm90YXRlIiwiYW5nbGUiLCJzY2FsZSIsInhPZmZzZXQiLCJ5T2Zmc2V0IiwiZHJhd0ltYWdlIiwiY2FudmFzIiwicmVzdG9yZSIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVsZWN0cmljRmllbGRDYW52YXNOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZpZXcgZm9yIHRoZSBlbGVjdHJpYyBmaWVsZCBhcnJvd3MgdGhhdCB1c2VzIENhbnZhc1xyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHsgQ2FudmFzTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBjaGFyZ2VzQW5kRmllbGRzIGZyb20gJy4uLy4uL2NoYXJnZXNBbmRGaWVsZHMuanMnO1xyXG5pbXBvcnQgQ2hhcmdlc0FuZEZpZWxkc0NvbG9ycyBmcm9tICcuLi9DaGFyZ2VzQW5kRmllbGRzQ29sb3JzLmpzJztcclxuaW1wb3J0IENoYXJnZXNBbmRGaWVsZHNDb25zdGFudHMgZnJvbSAnLi4vQ2hhcmdlc0FuZEZpZWxkc0NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBDaGFyZ2VUcmFja2VyIGZyb20gJy4vQ2hhcmdlVHJhY2tlci5qcyc7XHJcbmltcG9ydCBFbGVjdHJpY0ZpZWxkQXJyb3dDYW52YXMgZnJvbSAnLi9FbGVjdHJpY0ZpZWxkQXJyb3dDYW52YXMuanMnO1xyXG5cclxuLy8gU3BhY2luZyBpbiB0aGUgbW9kZWwgY29vcmRpbmF0ZSBmcmFtZS5cclxuY29uc3QgRUxFQ1RSSUNfRklFTERfU0VOU09SX1NQQUNJTkcgPSBDaGFyZ2VzQW5kRmllbGRzQ29uc3RhbnRzLkVMRUNUUklDX0ZJRUxEX1NFTlNPUl9TUEFDSU5HO1xyXG5cclxuY29uc3QgTUlOX1ZJU0lCTEVfRUxFQ1RSSUNfRklFTERfTUFHID0gMWUtOTsgLy8gVi9tXHJcblxyXG5jb25zdCBzY3JhdGNoVmVjdG9yID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuXHJcbmNsYXNzIEVsZWN0cmljRmllbGRDYW52YXNOb2RlIGV4dGVuZHMgQ2FudmFzTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7T2JzZXJ2YWJsZUFycmF5RGVmLjxDaGFyZ2VkUGFydGljbGU+fSBjaGFyZ2VkUGFydGljbGVzIC0gb25seSBjaGFyZ2VkUGFydGljbGVzIHRoYXQgYWN0aXZlIGFyZSBpbiB0aGlzIGFycmF5XHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge0JvdW5kczJ9IG1vZGVsQm91bmRzIC0gVGhlIGJvdW5kcyBpbiB0aGUgbW9kZWwgdGhhdCBuZWVkIHRvIGJlIGRyYXduXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Ym9vbGVhbj59IGlzRWxlY3RyaWNGaWVsZERpcmVjdGlvbk9ubHlQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPGJvb2xlYW4+fSBpc1Zpc2libGVQcm9wZXJ0eVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBjaGFyZ2VkUGFydGljbGVzLFxyXG4gICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm0sXHJcbiAgICAgICAgICAgICAgIG1vZGVsQm91bmRzLFxyXG4gICAgICAgICAgICAgICBpc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHksXHJcbiAgICAgICAgICAgICAgIGlzVmlzaWJsZVByb3BlcnR5ICkge1xyXG5cclxuICAgIHN1cGVyKCB7XHJcbiAgICAgIGNhbnZhc0JvdW5kczogbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3Qm91bmRzKCBtb2RlbEJvdW5kcyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5jaGFyZ2VUcmFja2VyID0gbmV3IENoYXJnZVRyYWNrZXIoIGNoYXJnZWRQYXJ0aWNsZXMgKTtcclxuXHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IG1vZGVsVmlld1RyYW5zZm9ybTtcclxuICAgIHRoaXMubW9kZWxCb3VuZHMgPSBtb2RlbEJvdW5kcztcclxuICAgIHRoaXMudmlld0JvdW5kcyA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3Qm91bmRzKCBtb2RlbEJvdW5kcyApO1xyXG4gICAgdGhpcy5pc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHkgPSBpc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHk7XHJcbiAgICB0aGlzLmlzVmlzaWJsZVByb3BlcnR5ID0gaXNWaXNpYmxlUHJvcGVydHk7XHJcblxyXG4gICAgLy8gSW52YWxpZGF0ZSBwYWludCBvbiBhIGJ1bmNoIG9mIGNoYW5nZXNcclxuICAgIGNvbnN0IGludmFsaWRhdGVTZWxmTGlzdGVuZXIgPSB0aGlzLmludmFsaWRhdGVQYWludC5iaW5kKCB0aGlzICk7XHJcblxyXG4gICAgQ2hhcmdlc0FuZEZpZWxkc0NvbG9ycy5lbGVjdHJpY0ZpZWxkR3JpZFNhdHVyYXRpb25Qcm9wZXJ0eS5saW5rKCBpbnZhbGlkYXRlU2VsZkxpc3RlbmVyICk7IC8vIGNvbG9yIGNoYW5nZVxyXG5cclxuICAgIGlzVmlzaWJsZVByb3BlcnR5LmxpbmsoIGludmFsaWRhdGVTZWxmTGlzdGVuZXIgKTsgLy8gdmlzaWJpbGl0eSBjaGFuZ2VcclxuXHJcbiAgICBpc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHkubGluayggaW52YWxpZGF0ZVNlbGZMaXN0ZW5lciApOyAvLyB2aXNpYmlsaXR5IGNoYW5nZVxyXG5cclxuICAgIGNoYXJnZWRQYXJ0aWNsZXMuYWRkSXRlbUFkZGVkTGlzdGVuZXIoIHBhcnRpY2xlID0+IHBhcnRpY2xlLnBvc2l0aW9uUHJvcGVydHkubGluayggaW52YWxpZGF0ZVNlbGZMaXN0ZW5lciApICk7IC8vIHBhcnRpY2xlIGFkZGVkXHJcblxyXG4gICAgY2hhcmdlZFBhcnRpY2xlcy5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCBwYXJ0aWNsZSA9PiB7XHJcbiAgICAgIGludmFsaWRhdGVTZWxmTGlzdGVuZXIoKTtcclxuICAgICAgcGFydGljbGUucG9zaXRpb25Qcm9wZXJ0eS51bmxpbmsoIGludmFsaWRhdGVTZWxmTGlzdGVuZXIgKTtcclxuICAgIH0gKTsgLy8gcGFydGljbGUgcmVtb3ZlZFxyXG5cclxuICAgIGlzVmlzaWJsZVByb3BlcnR5LmxpbmtBdHRyaWJ1dGUoIHRoaXMsICd2aXNpYmxlJyApO1xyXG5cclxuICAgIHRoaXMubW9kZWxQb3NpdGlvbnMgPSBbXTsgLy8ge0FycmF5LjxWZWN0b3IyPn1cclxuICAgIGNvbnN0IHdpZHRoID0gbW9kZWxCb3VuZHMud2lkdGg7XHJcbiAgICBjb25zdCBoZWlnaHQgPSBtb2RlbEJvdW5kcy5oZWlnaHQ7XHJcbiAgICBjb25zdCBudW1Ib3Jpem9udGFsID0gTWF0aC5jZWlsKCB3aWR0aCAvIEVMRUNUUklDX0ZJRUxEX1NFTlNPUl9TUEFDSU5HICk7XHJcbiAgICBjb25zdCBudW1WZXJ0aWNhbCA9IE1hdGguY2VpbCggaGVpZ2h0IC8gRUxFQ1RSSUNfRklFTERfU0VOU09SX1NQQUNJTkcgKTtcclxuICAgIGZvciAoIGxldCByb3cgPSAwOyByb3cgPCBudW1WZXJ0aWNhbDsgcm93KysgKSB7XHJcbiAgICAgIGNvbnN0IHkgPSBtb2RlbEJvdW5kcy5taW5ZICsgKCByb3cgKyAwLjUgKSAqIGhlaWdodCAvIG51bVZlcnRpY2FsO1xyXG5cclxuICAgICAgZm9yICggbGV0IGNvbCA9IDA7IGNvbCA8IG51bUhvcml6b250YWw7IGNvbCsrICkge1xyXG4gICAgICAgIGNvbnN0IHggPSBtb2RlbEJvdW5kcy5taW5YICsgKCBjb2wgKyAwLjUgKSAqIHdpZHRoIC8gbnVtSG9yaXpvbnRhbDtcclxuXHJcbiAgICAgICAgdGhpcy5tb2RlbFBvc2l0aW9ucy5wdXNoKCBuZXcgVmVjdG9yMiggeCwgeSApICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyB7QXJyYXkuPFZlY3RvcjI+fVxyXG4gICAgdGhpcy52aWV3UG9zaXRpb25zID0gdGhpcy5tb2RlbFBvc2l0aW9ucy5tYXAoIHBvc2l0aW9uID0+IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCBwb3NpdGlvbiApICk7XHJcblxyXG4gICAgLy8ge0FycmF5LjxWZWN0b3IyPn0sIHdoZXJlIGVsZWN0cmljRmllbGRbIGkgXSBpcyB0aGUgMkQgZmllbGQgYXQgcG9zaXRpb25zWyBpIF1cclxuICAgIHRoaXMuZWxlY3RyaWNGaWVsZCA9IHRoaXMubW9kZWxQb3NpdGlvbnMubWFwKCAoKSA9PiBuZXcgVmVjdG9yMiggMCwgMCApICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlRWxlY3RyaWNGaWVsZENhbnZhc05vZGUgPSAoKSA9PiB7XHJcbiAgICAgIGlzVmlzaWJsZVByb3BlcnR5LnVubGluayggaW52YWxpZGF0ZVNlbGZMaXN0ZW5lciApOyAvLyB2aXNpYmlsaXR5IGNoYW5nZVxyXG4gICAgICBpc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHkudW5saW5rKCBpbnZhbGlkYXRlU2VsZkxpc3RlbmVyICk7IC8vIHZpc2liaWxpdHkgY2hhbmdlXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgdXBkYXRlRWxlY3RyaWNQb3RlbnRpYWxzKCkge1xyXG4gICAgY29uc3Qga0NvbnN0YW50ID0gQ2hhcmdlc0FuZEZpZWxkc0NvbnN0YW50cy5LX0NPTlNUQU5UO1xyXG5cclxuICAgIGNvbnN0IG51bUNoYW5nZXMgPSB0aGlzLmNoYXJnZVRyYWNrZXIucXVldWUubGVuZ3RoO1xyXG5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IG51bUNoYW5nZXM7IGkrKyApIHtcclxuICAgICAgY29uc3QgaXRlbSA9IHRoaXMuY2hhcmdlVHJhY2tlci5xdWV1ZVsgaSBdO1xyXG4gICAgICBjb25zdCBvbGRQb3NpdGlvbiA9IGl0ZW0ub2xkUG9zaXRpb247XHJcbiAgICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gaXRlbS5uZXdQb3NpdGlvbjtcclxuICAgICAgY29uc3QgY2hhcmdlID0gaXRlbS5jaGFyZ2U7XHJcblxyXG4gICAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLm1vZGVsUG9zaXRpb25zLmxlbmd0aDsgaisrICkge1xyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5tb2RlbFBvc2l0aW9uc1sgaiBdO1xyXG4gICAgICAgIGNvbnN0IGVsZWN0cmljRmllbGQgPSB0aGlzLmVsZWN0cmljRmllbGRbIGogXTtcclxuXHJcbiAgICAgICAgaWYgKCBvbGRQb3NpdGlvbiApIHtcclxuICAgICAgICAgIGNvbnN0IG9sZERpc3RhbmNlU3F1YXJlZCA9IHBvc2l0aW9uLmRpc3RhbmNlU3F1YXJlZCggb2xkUG9zaXRpb24gKTtcclxuICAgICAgICAgIGlmICggb2xkRGlzdGFuY2VTcXVhcmVkICE9PSAwICkge1xyXG4gICAgICAgICAgICBlbGVjdHJpY0ZpZWxkLnN1YnRyYWN0KCBzY3JhdGNoVmVjdG9yLnNldCggcG9zaXRpb24gKVxyXG4gICAgICAgICAgICAgIC5zdWJ0cmFjdCggb2xkUG9zaXRpb24gKVxyXG4gICAgICAgICAgICAgIC5tdWx0aXBseVNjYWxhcigga0NvbnN0YW50ICogY2hhcmdlIC8gTWF0aC5wb3coIG9sZERpc3RhbmNlU3F1YXJlZCwgMS41ICkgKSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCBuZXdQb3NpdGlvbiApIHtcclxuICAgICAgICAgIGNvbnN0IG5ld0Rpc3RhbmNlU3F1YXJlZCA9IHBvc2l0aW9uLmRpc3RhbmNlU3F1YXJlZCggbmV3UG9zaXRpb24gKTtcclxuICAgICAgICAgIGlmICggbmV3RGlzdGFuY2VTcXVhcmVkICE9PSAwICkge1xyXG4gICAgICAgICAgICBlbGVjdHJpY0ZpZWxkLmFkZCggc2NyYXRjaFZlY3Rvci5zZXQoIHBvc2l0aW9uIClcclxuICAgICAgICAgICAgICAuc3VidHJhY3QoIG5ld1Bvc2l0aW9uIClcclxuICAgICAgICAgICAgICAubXVsdGlwbHlTY2FsYXIoIGtDb25zdGFudCAqIGNoYXJnZSAvIE1hdGgucG93KCBuZXdEaXN0YW5jZVNxdWFyZWQsIDEuNSApICkgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNoYXJnZVRyYWNrZXIuY2xlYXIoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZ1bmN0aW9uIHJlc3BvbnNpYmxlIGZvciBwYWludGluZyBlbGVjdHJpYyBmaWVsZCBhcnJvd3NcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKiBAcHVibGljXHJcbiAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHRcclxuICAgKi9cclxuICBwYWludENhbnZhcyggY29udGV4dCApIHtcclxuICAgIHRoaXMudXBkYXRlRWxlY3RyaWNQb3RlbnRpYWxzKCk7XHJcblxyXG4gICAgY29uc3QgaXNEaXJlY3Rpb25Pbmx5ID0gdGhpcy5pc0VsZWN0cmljRmllbGREaXJlY3Rpb25Pbmx5UHJvcGVydHkuZ2V0KCk7XHJcbiAgICBjb25zdCBtYXhNYWduaXR1ZGUgPSBDaGFyZ2VzQW5kRmllbGRzQ29uc3RhbnRzLkVGSUVMRF9DT0xPUl9TQVRfTUFHTklUVURFO1xyXG5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMudmlld1Bvc2l0aW9ucy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgY29uc3Qgdmlld1Bvc2l0aW9uID0gdGhpcy52aWV3UG9zaXRpb25zWyBpIF07XHJcbiAgICAgIGNvbnN0IGVsZWN0cmljRmllbGQgPSB0aGlzLmVsZWN0cmljRmllbGRbIGkgXTtcclxuXHJcbiAgICAgIGNvbnRleHQuc2F2ZSgpO1xyXG4gICAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gVXRpbHMuY2xhbXAoIGVsZWN0cmljRmllbGQubWFnbml0dWRlIC8gbWF4TWFnbml0dWRlLCAwLCAxICk7XHJcbiAgICAgIGlmICggaXNEaXJlY3Rpb25Pbmx5ICYmIGVsZWN0cmljRmllbGQubWFnbml0dWRlID4gTUlOX1ZJU0lCTEVfRUxFQ1RSSUNfRklFTERfTUFHICkge1xyXG4gICAgICAgIGNvbnRleHQuZ2xvYmFsQWxwaGEgPSAxLjA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnRleHQudHJhbnNsYXRlKCB2aWV3UG9zaXRpb24ueCwgdmlld1Bvc2l0aW9uLnkgKTtcclxuICAgICAgY29udGV4dC5yb3RhdGUoIC1lbGVjdHJpY0ZpZWxkLmFuZ2xlICk7XHJcbiAgICAgIGNvbnRleHQuc2NhbGUoIDEgLyBFbGVjdHJpY0ZpZWxkQXJyb3dDYW52YXMuc2NhbGUsIDEgLyBFbGVjdHJpY0ZpZWxkQXJyb3dDYW52YXMuc2NhbGUgKTtcclxuICAgICAgY29udGV4dC50cmFuc2xhdGUoIEVsZWN0cmljRmllbGRBcnJvd0NhbnZhcy54T2Zmc2V0LCBFbGVjdHJpY0ZpZWxkQXJyb3dDYW52YXMueU9mZnNldCApO1xyXG4gICAgICBjb250ZXh0LmRyYXdJbWFnZSggRWxlY3RyaWNGaWVsZEFycm93Q2FudmFzLmNhbnZhcywgMCwgMCApO1xyXG5cclxuICAgICAgY29udGV4dC5yZXN0b3JlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZWxlYXNlcyByZWZlcmVuY2VzXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2VFbGVjdHJpY0ZpZWxkQ2FudmFzTm9kZSgpO1xyXG4gIH1cclxufVxyXG5cclxuY2hhcmdlc0FuZEZpZWxkcy5yZWdpc3RlciggJ0VsZWN0cmljRmllbGRDYW52YXNOb2RlJywgRWxlY3RyaWNGaWVsZENhbnZhc05vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgRWxlY3RyaWNGaWVsZENhbnZhc05vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxTQUFTQyxVQUFVLFFBQVEsbUNBQW1DO0FBQzlELE9BQU9DLGdCQUFnQixNQUFNLDJCQUEyQjtBQUN4RCxPQUFPQyxzQkFBc0IsTUFBTSw4QkFBOEI7QUFDakUsT0FBT0MseUJBQXlCLE1BQU0saUNBQWlDO0FBQ3ZFLE9BQU9DLGFBQWEsTUFBTSxvQkFBb0I7QUFDOUMsT0FBT0Msd0JBQXdCLE1BQU0sK0JBQStCOztBQUVwRTtBQUNBLE1BQU1DLDZCQUE2QixHQUFH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