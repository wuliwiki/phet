// Copyright 2021-2023, University of Colorado Boulder

/**
 * GOModel is the base class for this simulation's top-level model.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import geometricOptics from '../../geometricOptics.js';
import GOConstants from '../GOConstants.js';
import { RaysTypeValues } from './RaysType.js';
import GORuler from './tools/GORuler.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import FramedScene from './FramedScene.js';
import OpticalObjectChoice from './OpticalObjectChoice.js';
import ArrowScene from './ArrowScene.js';
import LightScene from './LightScene.js';
import Lens from '../../lens/model/Lens.js';
import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import optionize from '../../../../phet-core/js/optionize.js';
import PositionMarker from './tools/PositionMarker.js';
import GOColors from '../GOColors.js';
import StringUnionProperty from '../../../../axon/js/StringUnionProperty.js';
export default class GOModel {
  // choice of optical object

  // representation used for rays

  // whether light propagation is enabled

  // model of the optic, shared with all scenes

  // scenes

  // optional, supported by the Lens screen
  // rulers
  // position markers
  // Resets things that are specific to this class.
  /**
   * @param optic - the optic, shared by all scenes in the model
   * @param providedOptions
   */
  constructor(optic, providedOptions) {
    const options = optionize()({
      // SelfOptions
      lightObject1Position: Vector2.ZERO,
      lightObject2Position: Vector2.ZERO
    }, providedOptions);
    this.opticalObjectChoiceProperty = new EnumerationProperty(options.opticalObjectChoices[0], {
      validValues: options.opticalObjectChoices,
      tandem: options.tandem.createTandem('opticalObjectChoiceProperty'),
      phetioFeatured: true
    });
    this.optic = optic;
    this.raysTypeProperty = new StringUnionProperty('marginal', {
      validValues: RaysTypeValues,
      tandem: options.tandem.createTandem('raysTypeProperty'),
      phetioFeatured: true
    });
    this.lightPropagationEnabledProperty = new BooleanProperty(true, {
      tandem: providedOptions.tandem.createTandem('lightPropagationEnabledProperty'),
      phetioFeatured: true,
      phetioDocumentation: 'Turns light propagation on (true) and off (false) to support predictive questioning.<br>' + 'When off, the following things are not visible:' + '<ul>' + '<li>rays (real and virtual)' + '<li>images (real and virtual)' + '<li>light spots on the projection screen' + '</ul>'
    });

    // Scenes are grouped under this tandem.
    const scenesTandem = options.tandem.createTandem('scenes');
    this.scenes = [];
    this.arrowScene = new ArrowScene(this.optic, this.raysTypeProperty, {
      arrowObject1Position: options.arrowObject1Position,
      arrowObject2Position: options.arrowObject2Position,
      tandem: scenesTandem.createTandem('arrowScene')
    });
    this.scenes.push(this.arrowScene);
    this.framedScene = new FramedScene(this.opticalObjectChoiceProperty, this.optic, this.raysTypeProperty, {
      framedObjectPosition: options.framedObjectPosition,
      tandem: scenesTandem.createTandem('framedScene')
    });
    this.scenes.push(this.framedScene);

    // Note that while the Light scene is specific to the Mirror screen, it was more straightforward to handle it
    // as an optional part of this base class.
    if (options.opticalObjectChoices.includes(OpticalObjectChoice.LIGHT)) {
      assert && assert(this.optic instanceof Lens, 'Light is only supported by the Lens screen');
      this.lightScene = new LightScene(this.optic, this.raysTypeProperty, {
        lightObject1Position: options.lightObject1Position,
        lightObject2Position: options.lightObject2Position,
        tandem: scenesTandem.createTandem('lightScene')
      });
      this.scenes.push(this.lightScene);
    }

    // Tools are grouped under this tandem.
    const toolsTandem = options.tandem.createTandem('tools');
    this.horizontalRuler = new GORuler({
      orientation: 'horizontal',
      length: GOConstants.HORIZONTAL_RULER_LENGTH,
      tandem: toolsTandem.createTandem('horizontalRuler')
    });
    this.verticalRuler = new GORuler({
      orientation: 'vertical',
      length: GOConstants.VERTICAL_RULER_LENGTH,
      tandem: toolsTandem.createTandem('verticalRuler')
    });
    this.positionMarker1 = new PositionMarker({
      fill: GOColors.positionMarker1FillProperty,
      stroke: GOColors.positionMarker1StrokeProperty,
      tandem: toolsTandem.createTandem('positionMarker1')
    });
    this.positionMarker2 = new PositionMarker({
      fill: GOColors.positionMarker2FillProperty,
      stroke: GOColors.positionMarker2StrokeProperty,
      tandem: toolsTandem.createTandem('positionMarker2')
    });
    this.resetGOModel = () => {
      // client provided the optic, and is responsible for resetting the optic!
      this.opticalObjectChoiceProperty.reset();
      this.raysTypeProperty.reset();
      this.lightPropagationEnabledProperty.reset();
      this.scenes.forEach(scene => scene.reset());
      this.horizontalRuler.reset();
      this.verticalRuler.reset();
      this.positionMarker1.reset();
      this.positionMarker2.reset();
    };
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }
  reset() {
    this.resetGOModel();
  }

  /**
   * Steps the model.
   * @param dt - time step, in seconds
   */
  step(dt) {
    if (this.lightPropagationEnabledProperty.value && this.raysTypeProperty.value !== 'none') {
      this.scenes.forEach(scene => scene.stepLightRays(dt));
    }
  }

  /**
   * Causes the rays animation to begin.
   */
  beginLightRaysAnimation() {
    this.scenes.forEach(scene => scene.beginLightRaysAnimation());
  }
}
geometricOptics.register('GOModel', GOModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbnVtZXJhdGlvblByb3BlcnR5IiwiZ2VvbWV0cmljT3B0aWNzIiwiR09Db25zdGFudHMiLCJSYXlzVHlwZVZhbHVlcyIsIkdPUnVsZXIiLCJWZWN0b3IyIiwiRnJhbWVkU2NlbmUiLCJPcHRpY2FsT2JqZWN0Q2hvaWNlIiwiQXJyb3dTY2VuZSIsIkxpZ2h0U2NlbmUiLCJMZW5zIiwiQm9vbGVhblByb3BlcnR5Iiwib3B0aW9uaXplIiwiUG9zaXRpb25NYXJrZXIiLCJHT0NvbG9ycyIsIlN0cmluZ1VuaW9uUHJvcGVydHkiLCJHT01vZGVsIiwiY29uc3RydWN0b3IiLCJvcHRpYyIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJsaWdodE9iamVjdDFQb3NpdGlvbiIsIlpFUk8iLCJsaWdodE9iamVjdDJQb3NpdGlvbiIsIm9wdGljYWxPYmplY3RDaG9pY2VQcm9wZXJ0eSIsIm9wdGljYWxPYmplY3RDaG9pY2VzIiwidmFsaWRWYWx1ZXMiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9GZWF0dXJlZCIsInJheXNUeXBlUHJvcGVydHkiLCJsaWdodFByb3BhZ2F0aW9uRW5hYmxlZFByb3BlcnR5IiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInNjZW5lc1RhbmRlbSIsInNjZW5lcyIsImFycm93U2NlbmUiLCJhcnJvd09iamVjdDFQb3NpdGlvbiIsImFycm93T2JqZWN0MlBvc2l0aW9uIiwicHVzaCIsImZyYW1lZFNjZW5lIiwiZnJhbWVkT2JqZWN0UG9zaXRpb24iLCJpbmNsdWRlcyIsIkxJR0hUIiwiYXNzZXJ0IiwibGlnaHRTY2VuZSIsInRvb2xzVGFuZGVtIiwiaG9yaXpvbnRhbFJ1bGVyIiwib3JpZW50YXRpb24iLCJsZW5ndGgiLCJIT1JJWk9OVEFMX1JVTEVSX0xFTkdUSCIsInZlcnRpY2FsUnVsZXIiLCJWRVJUSUNBTF9SVUxFUl9MRU5HVEgiLCJwb3NpdGlvbk1hcmtlcjEiLCJmaWxsIiwicG9zaXRpb25NYXJrZXIxRmlsbFByb3BlcnR5Iiwic3Ryb2tlIiwicG9zaXRpb25NYXJrZXIxU3Ryb2tlUHJvcGVydHkiLCJwb3NpdGlvbk1hcmtlcjIiLCJwb3NpdGlvbk1hcmtlcjJGaWxsUHJvcGVydHkiLCJwb3NpdGlvbk1hcmtlcjJTdHJva2VQcm9wZXJ0eSIsInJlc2V0R09Nb2RlbCIsInJlc2V0IiwiZm9yRWFjaCIsInNjZW5lIiwiZGlzcG9zZSIsInN0ZXAiLCJkdCIsInZhbHVlIiwic3RlcExpZ2h0UmF5cyIsImJlZ2luTGlnaHRSYXlzQW5pbWF0aW9uIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJHT01vZGVsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEdPTW9kZWwgaXMgdGhlIGJhc2UgY2xhc3MgZm9yIHRoaXMgc2ltdWxhdGlvbidzIHRvcC1sZXZlbCBtb2RlbC5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBnZW9tZXRyaWNPcHRpY3MgZnJvbSAnLi4vLi4vZ2VvbWV0cmljT3B0aWNzLmpzJztcclxuaW1wb3J0IEdPQ29uc3RhbnRzIGZyb20gJy4uL0dPQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IE9wdGljIGZyb20gJy4vT3B0aWMuanMnO1xyXG5pbXBvcnQgeyBSYXlzVHlwZSwgUmF5c1R5cGVWYWx1ZXMgfSBmcm9tICcuL1JheXNUeXBlLmpzJztcclxuaW1wb3J0IEdPUnVsZXIgZnJvbSAnLi90b29scy9HT1J1bGVyLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgRnJhbWVkU2NlbmUgZnJvbSAnLi9GcmFtZWRTY2VuZS5qcyc7XHJcbmltcG9ydCBPcHRpY2FsT2JqZWN0Q2hvaWNlIGZyb20gJy4vT3B0aWNhbE9iamVjdENob2ljZS5qcyc7XHJcbmltcG9ydCBBcnJvd1NjZW5lIGZyb20gJy4vQXJyb3dTY2VuZS5qcyc7XHJcbmltcG9ydCBMaWdodFNjZW5lIGZyb20gJy4vTGlnaHRTY2VuZS5qcyc7XHJcbmltcG9ydCBHT1NjZW5lIGZyb20gJy4vR09TY2VuZS5qcyc7XHJcbmltcG9ydCBMZW5zIGZyb20gJy4uLy4uL2xlbnMvbW9kZWwvTGVucy5qcyc7XHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgeyBQaGV0aW9PYmplY3RPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1BoZXRpb09iamVjdC5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcbmltcG9ydCBQb3NpdGlvbk1hcmtlciBmcm9tICcuL3Rvb2xzL1Bvc2l0aW9uTWFya2VyLmpzJztcclxuaW1wb3J0IEdPQ29sb3JzIGZyb20gJy4uL0dPQ29sb3JzLmpzJztcclxuaW1wb3J0IFN0cmluZ1VuaW9uUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9TdHJpbmdVbmlvblByb3BlcnR5LmpzJztcclxuaW1wb3J0IFRNb2RlbCBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9UTW9kZWwuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuXHJcbiAgLy8gb3B0aWNhbCBvYmplY3QgY2hvaWNlcywgaW4gdGhlIG9yZGVyIHRoYXQgdGhleSB3aWxsIGFwcGVhciBpbiBPcHRpY2FsT2JqZWN0Q2hvaWNlQ29tYm9Cb3hcclxuICBvcHRpY2FsT2JqZWN0Q2hvaWNlczogT3B0aWNhbE9iamVjdENob2ljZVtdO1xyXG5cclxuICAvLyBpbml0aWFsIHBvc2l0aW9ucyBvZiBvcHRpY2FsIG9iamVjdHMgKGxpZ2h0cyBhcmUgb3B0aW9uYWwpXHJcbiAgYXJyb3dPYmplY3QxUG9zaXRpb246IFZlY3RvcjI7XHJcbiAgYXJyb3dPYmplY3QyUG9zaXRpb246IFZlY3RvcjI7XHJcbiAgZnJhbWVkT2JqZWN0UG9zaXRpb246IFZlY3RvcjI7XHJcbiAgbGlnaHRPYmplY3QxUG9zaXRpb24/OiBWZWN0b3IyO1xyXG4gIGxpZ2h0T2JqZWN0MlBvc2l0aW9uPzogVmVjdG9yMjtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEdPTW9kZWxPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaWNrUmVxdWlyZWQ8UGhldGlvT2JqZWN0T3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgR09Nb2RlbCBpbXBsZW1lbnRzIFRNb2RlbCB7XHJcblxyXG4gIC8vIGNob2ljZSBvZiBvcHRpY2FsIG9iamVjdFxyXG4gIHB1YmxpYyByZWFkb25seSBvcHRpY2FsT2JqZWN0Q2hvaWNlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8T3B0aWNhbE9iamVjdENob2ljZT47XHJcblxyXG4gIC8vIHJlcHJlc2VudGF0aW9uIHVzZWQgZm9yIHJheXNcclxuICBwdWJsaWMgcmVhZG9ubHkgcmF5c1R5cGVQcm9wZXJ0eTogUHJvcGVydHk8UmF5c1R5cGU+O1xyXG5cclxuICAvLyB3aGV0aGVyIGxpZ2h0IHByb3BhZ2F0aW9uIGlzIGVuYWJsZWRcclxuICBwdWJsaWMgcmVhZG9ubHkgbGlnaHRQcm9wYWdhdGlvbkVuYWJsZWRQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIG1vZGVsIG9mIHRoZSBvcHRpYywgc2hhcmVkIHdpdGggYWxsIHNjZW5lc1xyXG4gIHB1YmxpYyByZWFkb25seSBvcHRpYzogT3B0aWM7XHJcblxyXG4gIC8vIHNjZW5lc1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgc2NlbmVzOiBHT1NjZW5lW107XHJcbiAgcHVibGljIHJlYWRvbmx5IGFycm93U2NlbmU6IEFycm93U2NlbmU7XHJcbiAgcHVibGljIHJlYWRvbmx5IGZyYW1lZFNjZW5lOiBGcmFtZWRTY2VuZTtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGlnaHRTY2VuZT86IExpZ2h0U2NlbmU7IC8vIG9wdGlvbmFsLCBzdXBwb3J0ZWQgYnkgdGhlIExlbnMgc2NyZWVuXHJcblxyXG4gIC8vIHJ1bGVyc1xyXG4gIHB1YmxpYyByZWFkb25seSBob3Jpem9udGFsUnVsZXI6IEdPUnVsZXI7XHJcbiAgcHVibGljIHJlYWRvbmx5IHZlcnRpY2FsUnVsZXI6IEdPUnVsZXI7XHJcblxyXG4gIC8vIHBvc2l0aW9uIG1hcmtlcnNcclxuICBwdWJsaWMgcmVhZG9ubHkgcG9zaXRpb25NYXJrZXIxOiBQb3NpdGlvbk1hcmtlcjtcclxuICBwdWJsaWMgcmVhZG9ubHkgcG9zaXRpb25NYXJrZXIyOiBQb3NpdGlvbk1hcmtlcjtcclxuXHJcbiAgLy8gUmVzZXRzIHRoaW5ncyB0aGF0IGFyZSBzcGVjaWZpYyB0byB0aGlzIGNsYXNzLlxyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVzZXRHT01vZGVsOiAoKSA9PiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gb3B0aWMgLSB0aGUgb3B0aWMsIHNoYXJlZCBieSBhbGwgc2NlbmVzIGluIHRoZSBtb2RlbFxyXG4gICAqIEBwYXJhbSBwcm92aWRlZE9wdGlvbnNcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoIG9wdGljOiBPcHRpYywgcHJvdmlkZWRPcHRpb25zOiBHT01vZGVsT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEdPTW9kZWxPcHRpb25zLCBTZWxmT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgbGlnaHRPYmplY3QxUG9zaXRpb246IFZlY3RvcjIuWkVSTyxcclxuICAgICAgbGlnaHRPYmplY3QyUG9zaXRpb246IFZlY3RvcjIuWkVST1xyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5vcHRpY2FsT2JqZWN0Q2hvaWNlUHJvcGVydHkgPSBuZXcgRW51bWVyYXRpb25Qcm9wZXJ0eSggb3B0aW9ucy5vcHRpY2FsT2JqZWN0Q2hvaWNlc1sgMCBdLCB7XHJcbiAgICAgIHZhbGlkVmFsdWVzOiBvcHRpb25zLm9wdGljYWxPYmplY3RDaG9pY2VzLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ29wdGljYWxPYmplY3RDaG9pY2VQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWVcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm9wdGljID0gb3B0aWM7XHJcblxyXG4gICAgdGhpcy5yYXlzVHlwZVByb3BlcnR5ID0gbmV3IFN0cmluZ1VuaW9uUHJvcGVydHkoICdtYXJnaW5hbCcsIHtcclxuICAgICAgdmFsaWRWYWx1ZXM6IFJheXNUeXBlVmFsdWVzLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3JheXNUeXBlUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5saWdodFByb3BhZ2F0aW9uRW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSwge1xyXG4gICAgICB0YW5kZW06IHByb3ZpZGVkT3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnbGlnaHRQcm9wYWdhdGlvbkVuYWJsZWRQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWUsXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdUdXJucyBsaWdodCBwcm9wYWdhdGlvbiBvbiAodHJ1ZSkgYW5kIG9mZiAoZmFsc2UpIHRvIHN1cHBvcnQgcHJlZGljdGl2ZSBxdWVzdGlvbmluZy48YnI+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICdXaGVuIG9mZiwgdGhlIGZvbGxvd2luZyB0aGluZ3MgYXJlIG5vdCB2aXNpYmxlOicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnPGxpPnJheXMgKHJlYWwgYW5kIHZpcnR1YWwpJyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGk+aW1hZ2VzIChyZWFsIGFuZCB2aXJ0dWFsKScgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnPGxpPmxpZ2h0IHNwb3RzIG9uIHRoZSBwcm9qZWN0aW9uIHNjcmVlbicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnPC91bD4nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gU2NlbmVzIGFyZSBncm91cGVkIHVuZGVyIHRoaXMgdGFuZGVtLlxyXG4gICAgY29uc3Qgc2NlbmVzVGFuZGVtID0gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnc2NlbmVzJyApO1xyXG5cclxuICAgIHRoaXMuc2NlbmVzID0gW107XHJcblxyXG4gICAgdGhpcy5hcnJvd1NjZW5lID0gbmV3IEFycm93U2NlbmUoIHRoaXMub3B0aWMsIHRoaXMucmF5c1R5cGVQcm9wZXJ0eSwge1xyXG4gICAgICBhcnJvd09iamVjdDFQb3NpdGlvbjogb3B0aW9ucy5hcnJvd09iamVjdDFQb3NpdGlvbixcclxuICAgICAgYXJyb3dPYmplY3QyUG9zaXRpb246IG9wdGlvbnMuYXJyb3dPYmplY3QyUG9zaXRpb24sXHJcbiAgICAgIHRhbmRlbTogc2NlbmVzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2Fycm93U2NlbmUnIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMuc2NlbmVzLnB1c2goIHRoaXMuYXJyb3dTY2VuZSApO1xyXG5cclxuICAgIHRoaXMuZnJhbWVkU2NlbmUgPSBuZXcgRnJhbWVkU2NlbmUoIHRoaXMub3B0aWNhbE9iamVjdENob2ljZVByb3BlcnR5LCB0aGlzLm9wdGljLCB0aGlzLnJheXNUeXBlUHJvcGVydHksIHtcclxuICAgICAgZnJhbWVkT2JqZWN0UG9zaXRpb246IG9wdGlvbnMuZnJhbWVkT2JqZWN0UG9zaXRpb24sXHJcbiAgICAgIHRhbmRlbTogc2NlbmVzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2ZyYW1lZFNjZW5lJyApXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLnNjZW5lcy5wdXNoKCB0aGlzLmZyYW1lZFNjZW5lICk7XHJcblxyXG4gICAgLy8gTm90ZSB0aGF0IHdoaWxlIHRoZSBMaWdodCBzY2VuZSBpcyBzcGVjaWZpYyB0byB0aGUgTWlycm9yIHNjcmVlbiwgaXQgd2FzIG1vcmUgc3RyYWlnaHRmb3J3YXJkIHRvIGhhbmRsZSBpdFxyXG4gICAgLy8gYXMgYW4gb3B0aW9uYWwgcGFydCBvZiB0aGlzIGJhc2UgY2xhc3MuXHJcbiAgICBpZiAoIG9wdGlvbnMub3B0aWNhbE9iamVjdENob2ljZXMuaW5jbHVkZXMoIE9wdGljYWxPYmplY3RDaG9pY2UuTElHSFQgKSApIHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5vcHRpYyBpbnN0YW5jZW9mIExlbnMsICdMaWdodCBpcyBvbmx5IHN1cHBvcnRlZCBieSB0aGUgTGVucyBzY3JlZW4nICk7XHJcbiAgICAgIHRoaXMubGlnaHRTY2VuZSA9IG5ldyBMaWdodFNjZW5lKCB0aGlzLm9wdGljIGFzIExlbnMsIHRoaXMucmF5c1R5cGVQcm9wZXJ0eSwge1xyXG4gICAgICAgIGxpZ2h0T2JqZWN0MVBvc2l0aW9uOiBvcHRpb25zLmxpZ2h0T2JqZWN0MVBvc2l0aW9uLFxyXG4gICAgICAgIGxpZ2h0T2JqZWN0MlBvc2l0aW9uOiBvcHRpb25zLmxpZ2h0T2JqZWN0MlBvc2l0aW9uLFxyXG4gICAgICAgIHRhbmRlbTogc2NlbmVzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2xpZ2h0U2NlbmUnIClcclxuICAgICAgfSApO1xyXG4gICAgICB0aGlzLnNjZW5lcy5wdXNoKCB0aGlzLmxpZ2h0U2NlbmUgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUb29scyBhcmUgZ3JvdXBlZCB1bmRlciB0aGlzIHRhbmRlbS5cclxuICAgIGNvbnN0IHRvb2xzVGFuZGVtID0gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndG9vbHMnICk7XHJcblxyXG4gICAgdGhpcy5ob3Jpem9udGFsUnVsZXIgPSBuZXcgR09SdWxlcigge1xyXG4gICAgICBvcmllbnRhdGlvbjogJ2hvcml6b250YWwnLFxyXG4gICAgICBsZW5ndGg6IEdPQ29uc3RhbnRzLkhPUklaT05UQUxfUlVMRVJfTEVOR1RILFxyXG4gICAgICB0YW5kZW06IHRvb2xzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2hvcml6b250YWxSdWxlcicgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudmVydGljYWxSdWxlciA9IG5ldyBHT1J1bGVyKCB7XHJcbiAgICAgIG9yaWVudGF0aW9uOiAndmVydGljYWwnLFxyXG4gICAgICBsZW5ndGg6IEdPQ29uc3RhbnRzLlZFUlRJQ0FMX1JVTEVSX0xFTkdUSCxcclxuICAgICAgdGFuZGVtOiB0b29sc1RhbmRlbS5jcmVhdGVUYW5kZW0oICd2ZXJ0aWNhbFJ1bGVyJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5wb3NpdGlvbk1hcmtlcjEgPSBuZXcgUG9zaXRpb25NYXJrZXIoIHtcclxuICAgICAgZmlsbDogR09Db2xvcnMucG9zaXRpb25NYXJrZXIxRmlsbFByb3BlcnR5LFxyXG4gICAgICBzdHJva2U6IEdPQ29sb3JzLnBvc2l0aW9uTWFya2VyMVN0cm9rZVByb3BlcnR5LFxyXG4gICAgICB0YW5kZW06IHRvb2xzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Bvc2l0aW9uTWFya2VyMScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMucG9zaXRpb25NYXJrZXIyID0gbmV3IFBvc2l0aW9uTWFya2VyKCB7XHJcbiAgICAgIGZpbGw6IEdPQ29sb3JzLnBvc2l0aW9uTWFya2VyMkZpbGxQcm9wZXJ0eSxcclxuICAgICAgc3Ryb2tlOiBHT0NvbG9ycy5wb3NpdGlvbk1hcmtlcjJTdHJva2VQcm9wZXJ0eSxcclxuICAgICAgdGFuZGVtOiB0b29sc1RhbmRlbS5jcmVhdGVUYW5kZW0oICdwb3NpdGlvbk1hcmtlcjInIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnJlc2V0R09Nb2RlbCA9ICgpID0+IHtcclxuICAgICAgLy8gY2xpZW50IHByb3ZpZGVkIHRoZSBvcHRpYywgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciByZXNldHRpbmcgdGhlIG9wdGljIVxyXG4gICAgICB0aGlzLm9wdGljYWxPYmplY3RDaG9pY2VQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgICB0aGlzLnJheXNUeXBlUHJvcGVydHkucmVzZXQoKTtcclxuICAgICAgdGhpcy5saWdodFByb3BhZ2F0aW9uRW5hYmxlZFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICAgIHRoaXMuc2NlbmVzLmZvckVhY2goIHNjZW5lID0+IHNjZW5lLnJlc2V0KCkgKTtcclxuICAgICAgdGhpcy5ob3Jpem9udGFsUnVsZXIucmVzZXQoKTtcclxuICAgICAgdGhpcy52ZXJ0aWNhbFJ1bGVyLnJlc2V0KCk7XHJcbiAgICAgIHRoaXMucG9zaXRpb25NYXJrZXIxLnJlc2V0KCk7XHJcbiAgICAgIHRoaXMucG9zaXRpb25NYXJrZXIyLnJlc2V0KCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMucmVzZXRHT01vZGVsKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGVwcyB0aGUgbW9kZWwuXHJcbiAgICogQHBhcmFtIGR0IC0gdGltZSBzdGVwLCBpbiBzZWNvbmRzXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMubGlnaHRQcm9wYWdhdGlvbkVuYWJsZWRQcm9wZXJ0eS52YWx1ZSAmJiAoIHRoaXMucmF5c1R5cGVQcm9wZXJ0eS52YWx1ZSAhPT0gJ25vbmUnICkgKSB7XHJcbiAgICAgIHRoaXMuc2NlbmVzLmZvckVhY2goIHNjZW5lID0+IHNjZW5lLnN0ZXBMaWdodFJheXMoIGR0ICkgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhdXNlcyB0aGUgcmF5cyBhbmltYXRpb24gdG8gYmVnaW4uXHJcbiAgICovXHJcbiAgcHVibGljIGJlZ2luTGlnaHRSYXlzQW5pbWF0aW9uKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY2VuZXMuZm9yRWFjaCggc2NlbmUgPT4gc2NlbmUuYmVnaW5MaWdodFJheXNBbmltYXRpb24oKSApO1xyXG4gIH1cclxufVxyXG5cclxuZ2VvbWV0cmljT3B0aWNzLnJlZ2lzdGVyKCAnR09Nb2RlbCcsIEdPTW9kZWwgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsbUJBQW1CLE1BQU0sNENBQTRDO0FBRTVFLE9BQU9DLGVBQWUsTUFBTSwwQkFBMEI7QUFDdEQsT0FBT0MsV0FBVyxNQUFNLG1CQUFtQjtBQUUzQyxTQUFtQkMsY0FBYyxRQUFRLGVBQWU7QUFDeEQsT0FBT0MsT0FBTyxNQUFNLG9CQUFvQjtBQUN4QyxPQUFPQyxPQUFPLE1BQU0sK0JB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