// Copyright 2021-2023, University of Colorado Boulder

/**
 * LightSpot is the model of a light spot in the vertical plane of the projection screen.
 * Responsible for the position, diameter, and intensity of the spot.
 * The view decides how it should look, and clips it to the projection screen.
 *
 * @author Martin Veillette
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Utils from '../../../../dot/js/Utils.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import geometricOptics from '../../geometricOptics.js';
import NullableIO from '../../../../tandem/js/types/NullableIO.js';
import GOConstants from '../../common/GOConstants.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import optionize from '../../../../phet-core/js/optionize.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
export default class LightSpot extends PhetioObject {
  // Intensity of the light spot, in the range [0,1], 0 if there is no light spot hitting the projection screen

  // Position of the center of the light spot, which may not be on the screen

  // Diameter of the light spot in the y dimension

  // Whether the light spot intersects the projection screen

  constructor(optic, projectionScreen, lightObjectPositionProperty, opticalImagePositionProperty, providedOptions) {
    const options = optionize()({
      // PhetioObjectOptions
      phetioState: false
    }, providedOptions);
    super(options);
    const positionAndDiameterProperty = new DerivedProperty([optic.positionProperty, optic.diameterProperty, projectionScreen.positionProperty, lightObjectPositionProperty, opticalImagePositionProperty], (opticPosition, opticDiameter, projectionScreenPosition, lightObjectPosition, opticalImagePosition) => getPositionAndDiameter(optic, projectionScreenPosition, lightObjectPosition, opticalImagePosition));
    this.positionProperty = new DerivedProperty([positionAndDiameterProperty], positionAndDiameter => positionAndDiameter.position, {
      units: 'cm',
      tandem: options.tandem.createTandem('positionProperty'),
      phetioFeatured: true,
      phetioValueType: Vector2.Vector2IO,
      phetioDocumentation: 'position of the center of the light spot, in the vertical plane of the projection screen'
    });
    this.diameterProperty = new DerivedProperty([positionAndDiameterProperty], positionAndDiameter => positionAndDiameter.diameter, {
      isValidValue: diameter => diameter >= 0,
      units: 'cm',
      tandem: options.tandem.createTandem('diameterProperty'),
      phetioFeatured: true,
      phetioValueType: NumberIO,
      phetioDocumentation: 'diameter (in the y dimension) of the light spot, in the vertical plane of the projection screen'
    });

    // The normalized intensity of the light spot, in the range [0,1].
    // See https://github.com/phetsims/geometric-optics/issues/335
    this.intensityProperty = new DerivedProperty([this.diameterProperty, optic.diameterProperty], (lightSpotDiameter, opticDiameter) => {
      if (lightSpotDiameter === 0) {
        return 0; // avoid divide-by-zero
      } else {
        const opticDiameterRange = optic.diameterProperty.range;
        const opticDiameterFactor = Utils.linear(opticDiameterRange.min, opticDiameterRange.max, 0.5, 1, opticDiameter);

        // Any light spot less than this diameter will have full intensity when the optic diameter is at its maximum.
        const FULL_INTENSITY_DIAMETER = 14; // cm
        const lightSpotDiameterFactor = FULL_INTENSITY_DIAMETER / lightSpotDiameter;
        return GOConstants.INTENSITY_RANGE.constrainValue(opticDiameterFactor * lightSpotDiameterFactor);
      }
    }, {
      isValidValue: value => GOConstants.INTENSITY_RANGE.contains(value),
      tandem: options.tandem.createTandem('intensityProperty'),
      phetioFeatured: true,
      phetioValueType: NullableIO(NumberIO),
      phetioDocumentation: 'intensity of the light spot, in the range [0,1]'
    });
    this.intersectsProjectionScreenProperty = new DerivedProperty([this.positionProperty, this.diameterProperty, projectionScreen.positionProperty], (position, diameter, projectionScreenPosition) => position.y >= projectionScreenPosition.y - projectionScreen.height / 2 - diameter / 2 && position.y <= projectionScreenPosition.y + projectionScreen.height / 2 + diameter / 2, {
      tandem: options.tandem.createTandem('intersectsProjectionScreenProperty'),
      phetioValueType: BooleanIO
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
}

/**
 * Gets the center and diameter of the light spot, in the vertical plane of the projection screen.
 */
function getPositionAndDiameter(optic, projectionScreenPosition, lightObjectPosition, opticalImagePosition) {
  // Get the extrema points of the optic.
  const opticTopPoint = optic.getTopPoint(lightObjectPosition, opticalImagePosition);
  const opticBottomPoint = optic.getBottomPoint(lightObjectPosition, opticalImagePosition);

  // Determine the top and bottom positions of the light spot.
  const diskTopPosition = getIntersectionPosition(projectionScreenPosition, opticTopPoint, opticalImagePosition);
  const diskBottomPosition = getIntersectionPosition(projectionScreenPosition, opticBottomPoint, opticalImagePosition);
  return {
    position: diskTopPosition.average(diskBottomPosition),
    diameter: diskTopPosition.distance(diskBottomPosition)
  };
}

/**
 * Gets the projected position on the screen of a point.
 * This is determined by extrapolating the point from the optical image onto the projection screen.
 */
function getIntersectionPosition(projectionScreenPosition, opticPoint, opticalImagePosition) {
  const opticImageDistance = opticalImagePosition.x - opticPoint.x;
  const ratio = opticImageDistance === 0 ? 10e6 :
  // This should technically be Infinity, but practically must be a (very large) finite value.
  (projectionScreenPosition.x - opticPoint.x) / opticImageDistance;

  // linear interpolation between opticPoint.y (ratio=0) and another opticalImagePosition.y (ratio=1).
  const y = opticPoint.y + (opticalImagePosition.y - opticPoint.y) * ratio;
  return new Vector2(projectionScreenPosition.x, y);
}
geometricOptics.register('LightSpot', LightSpot);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJWZWN0b3IyIiwiVXRpbHMiLCJOdW1iZXJJTyIsImdlb21ldHJpY09wdGljcyIsIk51bGxhYmxlSU8iLCJHT0NvbnN0YW50cyIsIlBoZXRpb09iamVjdCIsIm9wdGlvbml6ZSIsIkJvb2xlYW5JTyIsIkxpZ2h0U3BvdCIsImNvbnN0cnVjdG9yIiwib3B0aWMiLCJwcm9qZWN0aW9uU2NyZWVuIiwibGlnaHRPYmplY3RQb3NpdGlvblByb3BlcnR5Iiwib3B0aWNhbEltYWdlUG9zaXRpb25Qcm9wZXJ0eSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJwaGV0aW9TdGF0ZSIsInBvc2l0aW9uQW5kRGlhbWV0ZXJQcm9wZXJ0eSIsInBvc2l0aW9uUHJvcGVydHkiLCJkaWFtZXRlclByb3BlcnR5Iiwib3B0aWNQb3NpdGlvbiIsIm9wdGljRGlhbWV0ZXIiLCJwcm9qZWN0aW9uU2NyZWVuUG9zaXRpb24iLCJsaWdodE9iamVjdFBvc2l0aW9uIiwib3B0aWNhbEltYWdlUG9zaXRpb24iLCJnZXRQb3NpdGlvbkFuZERpYW1ldGVyIiwicG9zaXRpb25BbmREaWFtZXRlciIsInBvc2l0aW9uIiwidW5pdHMiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9GZWF0dXJlZCIsInBoZXRpb1ZhbHVlVHlwZSIsIlZlY3RvcjJJTyIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJkaWFtZXRlciIsImlzVmFsaWRWYWx1ZSIsImludGVuc2l0eVByb3BlcnR5IiwibGlnaHRTcG90RGlhbWV0ZXIiLCJvcHRpY0RpYW1ldGVyUmFuZ2UiLCJyYW5nZSIsIm9wdGljRGlhbWV0ZXJGYWN0b3IiLCJsaW5lYXIiLCJtaW4iLCJtYXgiLCJGVUxMX0lOVEVOU0lUWV9ESUFNRVRFUiIsImxpZ2h0U3BvdERpYW1ldGVyRmFjdG9yIiwiSU5URU5TSVRZX1JBTkdFIiwiY29uc3RyYWluVmFsdWUiLCJ2YWx1ZSIsImNvbnRhaW5zIiwiaW50ZXJzZWN0c1Byb2plY3Rpb25TY3JlZW5Qcm9wZXJ0eSIsInkiLCJoZWlnaHQiLCJkaXNwb3NlIiwiYXNzZXJ0Iiwib3B0aWNUb3BQb2ludCIsImdldFRvcFBvaW50Iiwib3B0aWNCb3R0b21Qb2ludCIsImdldEJvdHRvbVBvaW50IiwiZGlza1RvcFBvc2l0aW9uIiwiZ2V0SW50ZXJzZWN0aW9uUG9zaXRpb24iLCJkaXNrQm90dG9tUG9zaXRpb24iLCJhdmVyYWdlIiwiZGlzdGFuY2UiLCJvcHRpY1BvaW50Iiwib3B0aWNJbWFnZURpc3RhbmNlIiwieCIsInJhdGlvIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJMaWdodFNwb3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTGlnaHRTcG90IGlzIHRoZSBtb2RlbCBvZiBhIGxpZ2h0IHNwb3QgaW4gdGhlIHZlcnRpY2FsIHBsYW5lIG9mIHRoZSBwcm9qZWN0aW9uIHNjcmVlbi5cclxuICogUmVzcG9uc2libGUgZm9yIHRoZSBwb3NpdGlvbiwgZGlhbWV0ZXIsIGFuZCBpbnRlbnNpdHkgb2YgdGhlIHNwb3QuXHJcbiAqIFRoZSB2aWV3IGRlY2lkZXMgaG93IGl0IHNob3VsZCBsb29rLCBhbmQgY2xpcHMgaXQgdG8gdGhlIHByb2plY3Rpb24gc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIE1hcnRpbiBWZWlsbGV0dGVcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IE51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdW1iZXJJTy5qcyc7XHJcbmltcG9ydCBPcHRpYyBmcm9tICcuL09wdGljLmpzJztcclxuaW1wb3J0IGdlb21ldHJpY09wdGljcyBmcm9tICcuLi8uLi9nZW9tZXRyaWNPcHRpY3MuanMnO1xyXG5pbXBvcnQgUHJvamVjdGlvblNjcmVlbiBmcm9tICcuL1Byb2plY3Rpb25TY3JlZW4uanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBHT0NvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vR09Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QsIHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IEVtcHR5U2VsZk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IFBpY2tPcHRpb25hbCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja09wdGlvbmFsLmpzJztcclxuaW1wb3J0IEJvb2xlYW5JTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvQm9vbGVhbklPLmpzJztcclxuXHJcbnR5cGUgUG9zaXRpb25BbmREaWFtZXRlciA9IHtcclxuICBwb3NpdGlvbjogVmVjdG9yMjsgLy8gcG9zaXRpb24gb2YgdGhlIGxpZ2h0IHNwb3QncyBjZW50ZXIsIGluIHRoZSB2ZXJ0aWNhbCBwbGFuZSBvZiB0aGUgcHJvamVjdGlvbiBzY3JlZW5cclxuICBkaWFtZXRlcjogbnVtYmVyOyAvLyBkaWFtZXRlciwgaW4gY21cclxufTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSBFbXB0eVNlbGZPcHRpb25zO1xyXG5cclxudHlwZSBMaWdodFNwb3RPcHRpb25zID0gU2VsZk9wdGlvbnMgJlxyXG4gIFBpY2tSZXF1aXJlZDxQaGV0aW9PYmplY3RPcHRpb25zLCAndGFuZGVtJz4gJlxyXG4gIFBpY2tPcHRpb25hbDxQaGV0aW9PYmplY3RPcHRpb25zLCAncGhldGlvRG9jdW1lbnRhdGlvbic+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTGlnaHRTcG90IGV4dGVuZHMgUGhldGlvT2JqZWN0IHtcclxuXHJcbiAgLy8gSW50ZW5zaXR5IG9mIHRoZSBsaWdodCBzcG90LCBpbiB0aGUgcmFuZ2UgWzAsMV0sIDAgaWYgdGhlcmUgaXMgbm8gbGlnaHQgc3BvdCBoaXR0aW5nIHRoZSBwcm9qZWN0aW9uIHNjcmVlblxyXG4gIHB1YmxpYyByZWFkb25seSBpbnRlbnNpdHlQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gUG9zaXRpb24gb2YgdGhlIGNlbnRlciBvZiB0aGUgbGlnaHQgc3BvdCwgd2hpY2ggbWF5IG5vdCBiZSBvbiB0aGUgc2NyZWVuXHJcbiAgcHVibGljIHJlYWRvbmx5IHBvc2l0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFZlY3RvcjI+O1xyXG5cclxuICAvLyBEaWFtZXRlciBvZiB0aGUgbGlnaHQgc3BvdCBpbiB0aGUgeSBkaW1lbnNpb25cclxuICBwdWJsaWMgcmVhZG9ubHkgZGlhbWV0ZXJQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gV2hldGhlciB0aGUgbGlnaHQgc3BvdCBpbnRlcnNlY3RzIHRoZSBwcm9qZWN0aW9uIHNjcmVlblxyXG4gIHB1YmxpYyByZWFkb25seSBpbnRlcnNlY3RzUHJvamVjdGlvblNjcmVlblByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBvcHRpYzogT3B0aWMsXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm9qZWN0aW9uU2NyZWVuOiBQcm9qZWN0aW9uU2NyZWVuLFxyXG4gICAgICAgICAgICAgICAgICAgICAgbGlnaHRPYmplY3RQb3NpdGlvblByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxWZWN0b3IyPixcclxuICAgICAgICAgICAgICAgICAgICAgIG9wdGljYWxJbWFnZVBvc2l0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFZlY3RvcjI+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRPcHRpb25zOiBMaWdodFNwb3RPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8TGlnaHRTcG90T3B0aW9ucywgU2VsZk9wdGlvbnMsIFBoZXRpb09iamVjdE9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFBoZXRpb09iamVjdE9wdGlvbnNcclxuICAgICAgcGhldGlvU3RhdGU6IGZhbHNlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHBvc2l0aW9uQW5kRGlhbWV0ZXJQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgb3B0aWMucG9zaXRpb25Qcm9wZXJ0eSwgb3B0aWMuZGlhbWV0ZXJQcm9wZXJ0eSwgcHJvamVjdGlvblNjcmVlbi5wb3NpdGlvblByb3BlcnR5LCBsaWdodE9iamVjdFBvc2l0aW9uUHJvcGVydHksIG9wdGljYWxJbWFnZVBvc2l0aW9uUHJvcGVydHkgXSxcclxuICAgICAgKCBvcHRpY1Bvc2l0aW9uLCBvcHRpY0RpYW1ldGVyLCBwcm9qZWN0aW9uU2NyZWVuUG9zaXRpb24sIGxpZ2h0T2JqZWN0UG9zaXRpb24sIG9wdGljYWxJbWFnZVBvc2l0aW9uICkgPT5cclxuICAgICAgICBnZXRQb3NpdGlvbkFuZERpYW1ldGVyKCBvcHRpYywgcHJvamVjdGlvblNjcmVlblBvc2l0aW9uLCBsaWdodE9iamVjdFBvc2l0aW9uLCBvcHRpY2FsSW1hZ2VQb3NpdGlvbiApXHJcbiAgICApO1xyXG5cclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgcG9zaXRpb25BbmREaWFtZXRlclByb3BlcnR5IF0sXHJcbiAgICAgIHBvc2l0aW9uQW5kRGlhbWV0ZXIgPT4gcG9zaXRpb25BbmREaWFtZXRlci5wb3NpdGlvbiwge1xyXG4gICAgICAgIHVuaXRzOiAnY20nLFxyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAncG9zaXRpb25Qcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9GZWF0dXJlZDogdHJ1ZSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IFZlY3RvcjIuVmVjdG9yMklPLFxyXG4gICAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdwb3NpdGlvbiBvZiB0aGUgY2VudGVyIG9mIHRoZSBsaWdodCBzcG90LCBpbiB0aGUgdmVydGljYWwgcGxhbmUgb2YgdGhlIHByb2plY3Rpb24gc2NyZWVuJ1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5kaWFtZXRlclByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyBwb3NpdGlvbkFuZERpYW1ldGVyUHJvcGVydHkgXSxcclxuICAgICAgcG9zaXRpb25BbmREaWFtZXRlciA9PiBwb3NpdGlvbkFuZERpYW1ldGVyLmRpYW1ldGVyLCB7XHJcbiAgICAgICAgaXNWYWxpZFZhbHVlOiAoIGRpYW1ldGVyOiBudW1iZXIgKSA9PiAoIGRpYW1ldGVyID49IDAgKSxcclxuICAgICAgICB1bml0czogJ2NtJyxcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RpYW1ldGVyUHJvcGVydHknICksXHJcbiAgICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWUsXHJcbiAgICAgICAgcGhldGlvVmFsdWVUeXBlOiBOdW1iZXJJTyxcclxuICAgICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnZGlhbWV0ZXIgKGluIHRoZSB5IGRpbWVuc2lvbikgb2YgdGhlIGxpZ2h0IHNwb3QsIGluIHRoZSB2ZXJ0aWNhbCBwbGFuZSBvZiB0aGUgcHJvamVjdGlvbiBzY3JlZW4nXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAvLyBUaGUgbm9ybWFsaXplZCBpbnRlbnNpdHkgb2YgdGhlIGxpZ2h0IHNwb3QsIGluIHRoZSByYW5nZSBbMCwxXS5cclxuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZ2VvbWV0cmljLW9wdGljcy9pc3N1ZXMvMzM1XHJcbiAgICB0aGlzLmludGVuc2l0eVByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyB0aGlzLmRpYW1ldGVyUHJvcGVydHksIG9wdGljLmRpYW1ldGVyUHJvcGVydHkgXSxcclxuICAgICAgKCBsaWdodFNwb3REaWFtZXRlciwgb3B0aWNEaWFtZXRlciApID0+IHtcclxuICAgICAgICBpZiAoIGxpZ2h0U3BvdERpYW1ldGVyID09PSAwICkge1xyXG4gICAgICAgICAgcmV0dXJuIDA7IC8vIGF2b2lkIGRpdmlkZS1ieS16ZXJvXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgY29uc3Qgb3B0aWNEaWFtZXRlclJhbmdlID0gb3B0aWMuZGlhbWV0ZXJQcm9wZXJ0eS5yYW5nZTtcclxuICAgICAgICAgIGNvbnN0IG9wdGljRGlhbWV0ZXJGYWN0b3IgPSBVdGlscy5saW5lYXIoIG9wdGljRGlhbWV0ZXJSYW5nZS5taW4sIG9wdGljRGlhbWV0ZXJSYW5nZS5tYXgsIDAuNSwgMSwgb3B0aWNEaWFtZXRlciApO1xyXG5cclxuICAgICAgICAgIC8vIEFueSBsaWdodCBzcG90IGxlc3MgdGhhbiB0aGlzIGRpYW1ldGVyIHdpbGwgaGF2ZSBmdWxsIGludGVuc2l0eSB3aGVuIHRoZSBvcHRpYyBkaWFtZXRlciBpcyBhdCBpdHMgbWF4aW11bS5cclxuICAgICAgICAgIGNvbnN0IEZVTExfSU5URU5TSVRZX0RJQU1FVEVSID0gMTQ7IC8vIGNtXHJcbiAgICAgICAgICBjb25zdCBsaWdodFNwb3REaWFtZXRlckZhY3RvciA9IEZVTExfSU5URU5TSVRZX0RJQU1FVEVSIC8gbGlnaHRTcG90RGlhbWV0ZXI7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIEdPQ29uc3RhbnRzLklOVEVOU0lUWV9SQU5HRS5jb25zdHJhaW5WYWx1ZSggb3B0aWNEaWFtZXRlckZhY3RvciAqIGxpZ2h0U3BvdERpYW1ldGVyRmFjdG9yICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCB7XHJcbiAgICAgICAgaXNWYWxpZFZhbHVlOiAoIHZhbHVlOiBudW1iZXIgKSA9PiBHT0NvbnN0YW50cy5JTlRFTlNJVFlfUkFOR0UuY29udGFpbnMoIHZhbHVlICksXHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdpbnRlbnNpdHlQcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9GZWF0dXJlZDogdHJ1ZSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IE51bGxhYmxlSU8oIE51bWJlcklPICksXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ2ludGVuc2l0eSBvZiB0aGUgbGlnaHQgc3BvdCwgaW4gdGhlIHJhbmdlIFswLDFdJ1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5pbnRlcnNlY3RzUHJvamVjdGlvblNjcmVlblByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgWyB0aGlzLnBvc2l0aW9uUHJvcGVydHksIHRoaXMuZGlhbWV0ZXJQcm9wZXJ0eSwgcHJvamVjdGlvblNjcmVlbi5wb3NpdGlvblByb3BlcnR5IF0sXHJcbiAgICAgICggcG9zaXRpb24sIGRpYW1ldGVyLCBwcm9qZWN0aW9uU2NyZWVuUG9zaXRpb24gKSA9PlxyXG4gICAgICAgIHBvc2l0aW9uLnkgPj0gcHJvamVjdGlvblNjcmVlblBvc2l0aW9uLnkgLSBwcm9qZWN0aW9uU2NyZWVuLmhlaWdodCAvIDIgLSBkaWFtZXRlciAvIDIgJiZcclxuICAgICAgICBwb3NpdGlvbi55IDw9IHByb2plY3Rpb25TY3JlZW5Qb3NpdGlvbi55ICsgcHJvamVjdGlvblNjcmVlbi5oZWlnaHQgLyAyICsgZGlhbWV0ZXIgLyAyLCB7XHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdpbnRlcnNlY3RzUHJvamVjdGlvblNjcmVlblByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgIH0gKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZmFsc2UsICdkaXNwb3NlIGlzIG5vdCBzdXBwb3J0ZWQsIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0nICk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2V0cyB0aGUgY2VudGVyIGFuZCBkaWFtZXRlciBvZiB0aGUgbGlnaHQgc3BvdCwgaW4gdGhlIHZlcnRpY2FsIHBsYW5lIG9mIHRoZSBwcm9qZWN0aW9uIHNjcmVlbi5cclxuICovXHJcbmZ1bmN0aW9uIGdldFBvc2l0aW9uQW5kRGlhbWV0ZXIoIG9wdGljOiBPcHRpYywgcHJvamVjdGlvblNjcmVlblBvc2l0aW9uOiBWZWN0b3IyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodE9iamVjdFBvc2l0aW9uOiBWZWN0b3IyLCBvcHRpY2FsSW1hZ2VQb3NpdGlvbjogVmVjdG9yMiApOiBQb3NpdGlvbkFuZERpYW1ldGVyIHtcclxuXHJcbiAgLy8gR2V0IHRoZSBleHRyZW1hIHBvaW50cyBvZiB0aGUgb3B0aWMuXHJcbiAgY29uc3Qgb3B0aWNUb3BQb2ludCA9IG9wdGljLmdldFRvcFBvaW50KCBsaWdodE9iamVjdFBvc2l0aW9uLCBvcHRpY2FsSW1hZ2VQb3NpdGlvbiApO1xyXG4gIGNvbnN0IG9wdGljQm90dG9tUG9pbnQgPSBvcHRpYy5nZXRCb3R0b21Qb2ludCggbGlnaHRPYmplY3RQb3NpdGlvbiwgb3B0aWNhbEltYWdlUG9zaXRpb24gKTtcclxuXHJcbiAgLy8gRGV0ZXJtaW5lIHRoZSB0b3AgYW5kIGJvdHRvbSBwb3NpdGlvbnMgb2YgdGhlIGxpZ2h0IHNwb3QuXHJcbiAgY29uc3QgZGlza1RvcFBvc2l0aW9uID0gZ2V0SW50ZXJzZWN0aW9uUG9zaXRpb24oIHByb2plY3Rpb25TY3JlZW5Qb3NpdGlvbiwgb3B0aWNUb3BQb2ludCwgb3B0aWNhbEltYWdlUG9zaXRpb24gKTtcclxuICBjb25zdCBkaXNrQm90dG9tUG9zaXRpb24gPSBnZXRJbnRlcnNlY3Rpb25Qb3NpdGlvbiggcHJvamVjdGlvblNjcmVlblBvc2l0aW9uLCBvcHRpY0JvdHRvbVBvaW50LCBvcHRpY2FsSW1hZ2VQb3NpdGlvbiApO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgcG9zaXRpb246IGRpc2tUb3BQb3NpdGlvbi5hdmVyYWdlKCBkaXNrQm90dG9tUG9zaXRpb24gKSxcclxuICAgIGRpYW1ldGVyOiBkaXNrVG9wUG9zaXRpb24uZGlzdGFuY2UoIGRpc2tCb3R0b21Qb3NpdGlvbiApXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldHMgdGhlIHByb2plY3RlZCBwb3NpdGlvbiBvbiB0aGUgc2NyZWVuIG9mIGEgcG9pbnQuXHJcbiAqIFRoaXMgaXMgZGV0ZXJtaW5lZCBieSBleHRyYXBvbGF0aW5nIHRoZSBwb2ludCBmcm9tIHRoZSBvcHRpY2FsIGltYWdlIG9udG8gdGhlIHByb2plY3Rpb24gc2NyZWVuLlxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0SW50ZXJzZWN0aW9uUG9zaXRpb24oIHByb2plY3Rpb25TY3JlZW5Qb3NpdGlvbjogVmVjdG9yMiwgb3B0aWNQb2ludDogVmVjdG9yMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGljYWxJbWFnZVBvc2l0aW9uOiBWZWN0b3IyICk6IFZlY3RvcjIge1xyXG4gIGNvbnN0IG9wdGljSW1hZ2VEaXN0YW5jZSA9ICggb3B0aWNhbEltYWdlUG9zaXRpb24ueCAtIG9wdGljUG9pbnQueCApO1xyXG4gIGNvbnN0IHJhdGlvID0gKCBvcHRpY0ltYWdlRGlzdGFuY2UgPT09IDAgKSA/XHJcbiAgICAgICAgICAgICAgICAxMGU2IDogLy8gVGhpcyBzaG91bGQgdGVjaG5pY2FsbHkgYmUgSW5maW5pdHksIGJ1dCBwcmFjdGljYWxseSBtdXN0IGJlIGEgKHZlcnkgbGFyZ2UpIGZpbml0ZSB2YWx1ZS5cclxuICAgICAgICAgICAgICAgICggcHJvamVjdGlvblNjcmVlblBvc2l0aW9uLnggLSBvcHRpY1BvaW50LnggKSAvIG9wdGljSW1hZ2VEaXN0YW5jZTtcclxuXHJcbiAgLy8gbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiBvcHRpY1BvaW50LnkgKHJhdGlvPTApIGFuZCBhbm90aGVyIG9wdGljYWxJbWFnZVBvc2l0aW9uLnkgKHJhdGlvPTEpLlxyXG4gIGNvbnN0IHkgPSBvcHRpY1BvaW50LnkgKyAoIG9wdGljYWxJbWFnZVBvc2l0aW9uLnkgLSBvcHRpY1BvaW50LnkgKSAqIHJhdGlvO1xyXG4gIHJldHVybiBuZXcgVmVjdG9yMiggcHJvamVjdGlvblNjcmVlblBvc2l0aW9uLngsIHkgKTtcclxufVxyXG5cclxuZ2VvbWV0cmljT3B0aWNzLnJlZ2lzdGVyKCAnTGlnaHRTcG90JywgTGlnaHRTcG90ICk7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FB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