// Copyright 2022-2023, University of Colorado Boulder

/**
 * OpticalImage is the base class for all optical images. It describes where the image would occur, the point where
 * light rays intersect. What the image looks like is the responsibility of subclasses.  It can be instantiated
 * directly in situations (like the 'Light' scene) where you want to know where an optical image would form, but
 * you don't want to form an image.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Martin Veillette
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import StringUnionIO from '../../../../tandem/js/types/StringUnionIO.js';
import geometricOptics from '../../geometricOptics.js';
import { OpticalImageTypeValues } from './OpticalImageType.js';
import optionize from '../../../../phet-core/js/optionize.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
export default class OpticalImage extends PhetioObject {
  // the optic associated with this image

  // the optical object that this optical image is associated with

  // position of the optical image (the focus, as predicted by lens and mirror equation)

  // horizontal distance from optic to image, see phetioDocumentation

  // whether the optical image is real or virtual

  // Whether the optical image is visible. The image is not visible until light rays have reached it.
  // Note that this Property has some odd quirks when used in the 'Light' scene. That scene does not have
  // optical images, so visibleProperty controls the visibility of the light spots on the projection screen.
  // For a more complete description, see https://github.com/phetsims/geometric-optics/issues/403
  // the magnification can be negative, indicating that the optical image is inverted.
  // Resets things that are specific to this class.
  constructor(opticalObject, optic, providedOptions) {
    const options = optionize()({
      // SelfOptions options
      opticalObjectPositionProperty: opticalObject.positionProperty,
      opticalImageTypePropertyFeatured: true,
      magnificationPropertyFeatured: true,
      // PhetioObject options
      phetioState: false
    }, providedOptions);
    const opticalObjectPositionProperty = options.opticalObjectPositionProperty;
    super(options);
    this.optic = optic;
    this.opticalObject = opticalObject;
    this.visibleProperty = new BooleanProperty(false, {
      tandem: options.tandem.createTandem('visibleProperty'),
      phetioReadOnly: true,
      phetioDocumentation: 'This Property is controlled by the simulation and is therefore read-only. ' + 'When light rays are animated, the optical image is visible only after rays ' + 'have reached the position where the image is formed.'
    });
    this.imageDistanceProperty = new DerivedProperty([opticalObject.objectDistanceProperty, optic.focalLengthProperty], (objectDistance, focalLength) => {
      // address the case where the optical object shares the same x position as the focal point
      if (objectDistance === focalLength) {
        // Set the distance to be very large (and arbitrarily positive).
        // This should technically be Infinity, but practically must be a (very large) finite value.
        return 10e6;
      } else {
        // Calculated based on the thin lens law/ mirror equation
        // For a lens, a positive distance indicates that the image is to the right of the lens.
        // For a mirror, a positive distance indicates that the image is to the left of the mirror.
        return focalLength * objectDistance / (objectDistance - focalLength);
      }
    }, {
      units: 'cm',
      tandem: options.tandem.createTandem('imageDistanceProperty'),
      phetioFeatured: true,
      phetioValueType: NumberIO,
      phetioDocumentation: 'Horizontal distance between optic and image, where the sign has the following significance.<br><br>' + 'For a lens:' + '<ul>' + '<li>positive is a real image to the right of the lens</li>' + '<li>negative is a virtual image to the left of the lens</li>' + '</ul>' + 'For a mirror:' + '<ul>' + '<li>positive is a real image to the left of the mirror</li>' + '<li>negative is a virtual image to the right of the mirror</li>' + '</li>'
    });
    this.magnificationProperty = new DerivedProperty([opticalObject.objectDistanceProperty, this.imageDistanceProperty], (objectDistance, imageDistance) => {
      // prevent division by zero
      if (objectDistance === 0) {
        return 1; // The magnification is 1 when the object and optic are coincident.
      } else {
        return -1 * imageDistance / objectDistance;
      }
    }, {
      tandem: options.tandem.createTandem('magnificationProperty'),
      phetioFeatured: options.magnificationPropertyFeatured,
      phetioValueType: NumberIO,
      phetioDocumentation: 'Magnification of the optical image. Negative indicates that the image is inverted.'
    });
    this.positionProperty = new DerivedProperty([opticalObjectPositionProperty, optic.positionProperty, this.imageDistanceProperty, this.magnificationProperty], (opticalObjectPosition, opticPosition, imageDistance, magnification) => {
      // The height is determined as the vertical offset from the optical axis of the focus point.
      // The height will be negative if the optical image is inverted.
      const height = magnification * (opticalObjectPosition.y - opticPosition.y);

      // Recall that the sign is different for lens vs mirror. See phetioDocumentation for imageDistanceProperty.
      return opticPosition.plusXY(optic.sign * imageDistance, height);
    }, {
      units: 'cm',
      tandem: options.tandem.createTandem('positionProperty'),
      phetioFeatured: true,
      phetioValueType: Vector2.Vector2IO
    });
    this.opticalImageTypeProperty = new DerivedProperty([this.imageDistanceProperty], imageDistance => imageDistance < 0 ? 'virtual' : 'real', {
      tandem: options.tandem.createTandem('opticalImageTypeProperty'),
      phetioFeatured: options.opticalImageTypePropertyFeatured,
      phetioValueType: StringUnionIO(OpticalImageTypeValues),
      validValues: OpticalImageTypeValues
    });
    this.resetOpticalImage = () => {
      this.visibleProperty.reset();
    };
  }
  reset() {
    this.resetOpticalImage();
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
}
geometricOptics.register('OpticalImage', OpticalImage);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJWZWN0b3IyIiwiUGhldGlvT2JqZWN0IiwiU3RyaW5nVW5pb25JTyIsImdlb21ldHJpY09wdGljcyIsIk9wdGljYWxJbWFnZVR5cGVWYWx1ZXMiLCJvcHRpb25pemUiLCJOdW1iZXJJTyIsIk9wdGljYWxJbWFnZSIsImNvbnN0cnVjdG9yIiwib3B0aWNhbE9iamVjdCIsIm9wdGljIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsIm9wdGljYWxPYmplY3RQb3NpdGlvblByb3BlcnR5IiwicG9zaXRpb25Qcm9wZXJ0eSIsIm9wdGljYWxJbWFnZVR5cGVQcm9wZXJ0eUZlYXR1cmVkIiwibWFnbmlmaWNhdGlvblByb3BlcnR5RmVhdHVyZWQiLCJwaGV0aW9TdGF0ZSIsInZpc2libGVQcm9wZXJ0eSIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsInBoZXRpb1JlYWRPbmx5IiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImltYWdlRGlzdGFuY2VQcm9wZXJ0eSIsIm9iamVjdERpc3RhbmNlUHJvcGVydHkiLCJmb2NhbExlbmd0aFByb3BlcnR5Iiwib2JqZWN0RGlzdGFuY2UiLCJmb2NhbExlbmd0aCIsInVuaXRzIiwicGhldGlvRmVhdHVyZWQiLCJwaGV0aW9WYWx1ZVR5cGUiLCJtYWduaWZpY2F0aW9uUHJvcGVydHkiLCJpbWFnZURpc3RhbmNlIiwib3B0aWNhbE9iamVjdFBvc2l0aW9uIiwib3B0aWNQb3NpdGlvbiIsIm1hZ25pZmljYXRpb24iLCJoZWlnaHQiLCJ5IiwicGx1c1hZIiwic2lnbiIsIlZlY3RvcjJJTyIsIm9wdGljYWxJbWFnZVR5cGVQcm9wZXJ0eSIsInZhbGlkVmFsdWVzIiwicmVzZXRPcHRpY2FsSW1hZ2UiLCJyZXNldCIsImRpc3Bvc2UiLCJhc3NlcnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk9wdGljYWxJbWFnZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBPcHRpY2FsSW1hZ2UgaXMgdGhlIGJhc2UgY2xhc3MgZm9yIGFsbCBvcHRpY2FsIGltYWdlcy4gSXQgZGVzY3JpYmVzIHdoZXJlIHRoZSBpbWFnZSB3b3VsZCBvY2N1ciwgdGhlIHBvaW50IHdoZXJlXHJcbiAqIGxpZ2h0IHJheXMgaW50ZXJzZWN0LiBXaGF0IHRoZSBpbWFnZSBsb29rcyBsaWtlIGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiBzdWJjbGFzc2VzLiAgSXQgY2FuIGJlIGluc3RhbnRpYXRlZFxyXG4gKiBkaXJlY3RseSBpbiBzaXR1YXRpb25zIChsaWtlIHRoZSAnTGlnaHQnIHNjZW5lKSB3aGVyZSB5b3Ugd2FudCB0byBrbm93IHdoZXJlIGFuIG9wdGljYWwgaW1hZ2Ugd291bGQgZm9ybSwgYnV0XHJcbiAqIHlvdSBkb24ndCB3YW50IHRvIGZvcm0gYW4gaW1hZ2UuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqIEBhdXRob3IgTWFydGluIFZlaWxsZXR0ZVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFBoZXRpb09iamVjdCwgeyBQaGV0aW9PYmplY3RPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1BoZXRpb09iamVjdC5qcyc7XHJcbmltcG9ydCBTdHJpbmdVbmlvbklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9TdHJpbmdVbmlvbklPLmpzJztcclxuaW1wb3J0IGdlb21ldHJpY09wdGljcyBmcm9tICcuLi8uLi9nZW9tZXRyaWNPcHRpY3MuanMnO1xyXG5pbXBvcnQgT3B0aWMgZnJvbSAnLi9PcHRpYy5qcyc7XHJcbmltcG9ydCB7IE9wdGljYWxJbWFnZVR5cGUsIE9wdGljYWxJbWFnZVR5cGVWYWx1ZXMgfSBmcm9tICcuL09wdGljYWxJbWFnZVR5cGUuanMnO1xyXG5pbXBvcnQgT3B0aWNhbE9iamVjdCBmcm9tICcuL09wdGljYWxPYmplY3QuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgUGlja1JlcXVpcmVkIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrUmVxdWlyZWQuanMnO1xyXG5pbXBvcnQgTnVtYmVySU8gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL051bWJlcklPLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIE9wdGlvbmFsIGFsdGVybmF0ZSBwb3NpdGlvbiBvZiB0aGUgb3B0aWNhbCBvYmplY3QsIGRlZmF1bHRzIHRvIG9wdGljYWxPYmplY3QucG9zaXRpb25Qcm9wZXJ0eS5cclxuICAvLyBUaGlzIGlzIHVzZWQgZm9yIHRoZSBzZWNvbmQgcG9pbnQtb2YtaW50ZXJlc3Qgb24gdGhlIGZyYW1lZCBvYmplY3RzLlxyXG4gIG9wdGljYWxPYmplY3RQb3NpdGlvblByb3BlcnR5PzogVFJlYWRPbmx5UHJvcGVydHk8VmVjdG9yMj47XHJcblxyXG4gIC8vIFRoZSBwaGV0aW9GZWF0dXJlZCB2YWx1ZSBmb3Igb3B0aWNhbEltYWdlVHlwZVByb3BlcnR5XHJcbiAgb3B0aWNhbEltYWdlVHlwZVByb3BlcnR5RmVhdHVyZWQ/OiBib29sZWFuO1xyXG5cclxuICAvLyBUaGUgcGhldGlvRmVhdHVyZWQgdmFsdWUgZm9yIG1hZ25pZmljYXRpb25Qcm9wZXJ0eVxyXG4gIG1hZ25pZmljYXRpb25Qcm9wZXJ0eUZlYXR1cmVkPzogYm9vbGVhbjtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIE9wdGljYWxJbWFnZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tSZXF1aXJlZDxQaGV0aW9PYmplY3RPcHRpb25zLCAndGFuZGVtJyB8ICdwaGV0aW9Eb2N1bWVudGF0aW9uJz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPcHRpY2FsSW1hZ2UgZXh0ZW5kcyBQaGV0aW9PYmplY3Qge1xyXG5cclxuICAvLyB0aGUgb3B0aWMgYXNzb2NpYXRlZCB3aXRoIHRoaXMgaW1hZ2VcclxuICBwdWJsaWMgcmVhZG9ubHkgb3B0aWM6IE9wdGljO1xyXG5cclxuICAvLyB0aGUgb3B0aWNhbCBvYmplY3QgdGhhdCB0aGlzIG9wdGljYWwgaW1hZ2UgaXMgYXNzb2NpYXRlZCB3aXRoXHJcbiAgcHVibGljIHJlYWRvbmx5IG9wdGljYWxPYmplY3Q6IE9wdGljYWxPYmplY3Q7XHJcblxyXG4gIC8vIHBvc2l0aW9uIG9mIHRoZSBvcHRpY2FsIGltYWdlICh0aGUgZm9jdXMsIGFzIHByZWRpY3RlZCBieSBsZW5zIGFuZCBtaXJyb3IgZXF1YXRpb24pXHJcbiAgcHVibGljIHJlYWRvbmx5IHBvc2l0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFZlY3RvcjI+O1xyXG5cclxuICAvLyBob3Jpem9udGFsIGRpc3RhbmNlIGZyb20gb3B0aWMgdG8gaW1hZ2UsIHNlZSBwaGV0aW9Eb2N1bWVudGF0aW9uXHJcbiAgcHVibGljIHJlYWRvbmx5IGltYWdlRGlzdGFuY2VQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gd2hldGhlciB0aGUgb3B0aWNhbCBpbWFnZSBpcyByZWFsIG9yIHZpcnR1YWxcclxuICBwdWJsaWMgcmVhZG9ubHkgb3B0aWNhbEltYWdlVHlwZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxPcHRpY2FsSW1hZ2VUeXBlPjtcclxuXHJcbiAgLy8gV2hldGhlciB0aGUgb3B0aWNhbCBpbWFnZSBpcyB2aXNpYmxlLiBUaGUgaW1hZ2UgaXMgbm90IHZpc2libGUgdW50aWwgbGlnaHQgcmF5cyBoYXZlIHJlYWNoZWQgaXQuXHJcbiAgLy8gTm90ZSB0aGF0IHRoaXMgUHJvcGVydHkgaGFzIHNvbWUgb2RkIHF1aXJrcyB3aGVuIHVzZWQgaW4gdGhlICdMaWdodCcgc2NlbmUuIFRoYXQgc2NlbmUgZG9lcyBub3QgaGF2ZVxyXG4gIC8vIG9wdGljYWwgaW1hZ2VzLCBzbyB2aXNpYmxlUHJvcGVydHkgY29udHJvbHMgdGhlIHZpc2liaWxpdHkgb2YgdGhlIGxpZ2h0IHNwb3RzIG9uIHRoZSBwcm9qZWN0aW9uIHNjcmVlbi5cclxuICAvLyBGb3IgYSBtb3JlIGNvbXBsZXRlIGRlc2NyaXB0aW9uLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2dlb21ldHJpYy1vcHRpY3MvaXNzdWVzLzQwM1xyXG4gIHB1YmxpYyByZWFkb25seSB2aXNpYmxlUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAvLyB0aGUgbWFnbmlmaWNhdGlvbiBjYW4gYmUgbmVnYXRpdmUsIGluZGljYXRpbmcgdGhhdCB0aGUgb3B0aWNhbCBpbWFnZSBpcyBpbnZlcnRlZC5cclxuICBwdWJsaWMgcmVhZG9ubHkgbWFnbmlmaWNhdGlvblByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxudW1iZXI+O1xyXG5cclxuICAvLyBSZXNldHMgdGhpbmdzIHRoYXQgYXJlIHNwZWNpZmljIHRvIHRoaXMgY2xhc3MuXHJcbiAgcHJpdmF0ZSByZWFkb25seSByZXNldE9wdGljYWxJbWFnZTogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBvcHRpY2FsT2JqZWN0OiBPcHRpY2FsT2JqZWN0LCBvcHRpYzogT3B0aWMsIHByb3ZpZGVkT3B0aW9uczogT3B0aWNhbEltYWdlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPE9wdGljYWxJbWFnZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBQaGV0aW9PYmplY3RPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9ucyBvcHRpb25zXHJcbiAgICAgIG9wdGljYWxPYmplY3RQb3NpdGlvblByb3BlcnR5OiBvcHRpY2FsT2JqZWN0LnBvc2l0aW9uUHJvcGVydHksXHJcbiAgICAgIG9wdGljYWxJbWFnZVR5cGVQcm9wZXJ0eUZlYXR1cmVkOiB0cnVlLFxyXG4gICAgICBtYWduaWZpY2F0aW9uUHJvcGVydHlGZWF0dXJlZDogdHJ1ZSxcclxuXHJcbiAgICAgIC8vIFBoZXRpb09iamVjdCBvcHRpb25zXHJcbiAgICAgIHBoZXRpb1N0YXRlOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3Qgb3B0aWNhbE9iamVjdFBvc2l0aW9uUHJvcGVydHkgPSBvcHRpb25zLm9wdGljYWxPYmplY3RQb3NpdGlvblByb3BlcnR5O1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5vcHRpYyA9IG9wdGljO1xyXG4gICAgdGhpcy5vcHRpY2FsT2JqZWN0ID0gb3B0aWNhbE9iamVjdDtcclxuXHJcbiAgICB0aGlzLnZpc2libGVQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9SZWFkT25seTogdHJ1ZSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1RoaXMgUHJvcGVydHkgaXMgY29udHJvbGxlZCBieSB0aGUgc2ltdWxhdGlvbiBhbmQgaXMgdGhlcmVmb3JlIHJlYWQtb25seS4gJyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICdXaGVuIGxpZ2h0IHJheXMgYXJlIGFuaW1hdGVkLCB0aGUgb3B0aWNhbCBpbWFnZSBpcyB2aXNpYmxlIG9ubHkgYWZ0ZXIgcmF5cyAnICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hhdmUgcmVhY2hlZCB0aGUgcG9zaXRpb24gd2hlcmUgdGhlIGltYWdlIGlzIGZvcm1lZC4nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5pbWFnZURpc3RhbmNlUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICBbIG9wdGljYWxPYmplY3Qub2JqZWN0RGlzdGFuY2VQcm9wZXJ0eSwgb3B0aWMuZm9jYWxMZW5ndGhQcm9wZXJ0eSBdLFxyXG4gICAgICAoIG9iamVjdERpc3RhbmNlLCBmb2NhbExlbmd0aCApID0+IHtcclxuXHJcbiAgICAgICAgLy8gYWRkcmVzcyB0aGUgY2FzZSB3aGVyZSB0aGUgb3B0aWNhbCBvYmplY3Qgc2hhcmVzIHRoZSBzYW1lIHggcG9zaXRpb24gYXMgdGhlIGZvY2FsIHBvaW50XHJcbiAgICAgICAgaWYgKCBvYmplY3REaXN0YW5jZSA9PT0gZm9jYWxMZW5ndGggKSB7XHJcblxyXG4gICAgICAgICAgLy8gU2V0IHRoZSBkaXN0YW5jZSB0byBiZSB2ZXJ5IGxhcmdlIChhbmQgYXJiaXRyYXJpbHkgcG9zaXRpdmUpLlxyXG4gICAgICAgICAgLy8gVGhpcyBzaG91bGQgdGVjaG5pY2FsbHkgYmUgSW5maW5pdHksIGJ1dCBwcmFjdGljYWxseSBtdXN0IGJlIGEgKHZlcnkgbGFyZ2UpIGZpbml0ZSB2YWx1ZS5cclxuICAgICAgICAgIHJldHVybiAxMGU2O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgICAvLyBDYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSB0aGluIGxlbnMgbGF3LyBtaXJyb3IgZXF1YXRpb25cclxuICAgICAgICAgIC8vIEZvciBhIGxlbnMsIGEgcG9zaXRpdmUgZGlzdGFuY2UgaW5kaWNhdGVzIHRoYXQgdGhlIGltYWdlIGlzIHRvIHRoZSByaWdodCBvZiB0aGUgbGVucy5cclxuICAgICAgICAgIC8vIEZvciBhIG1pcnJvciwgYSBwb3NpdGl2ZSBkaXN0YW5jZSBpbmRpY2F0ZXMgdGhhdCB0aGUgaW1hZ2UgaXMgdG8gdGhlIGxlZnQgb2YgdGhlIG1pcnJvci5cclxuICAgICAgICAgIHJldHVybiAoIGZvY2FsTGVuZ3RoICogb2JqZWN0RGlzdGFuY2UgKSAvICggb2JqZWN0RGlzdGFuY2UgLSBmb2NhbExlbmd0aCApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSwge1xyXG4gICAgICAgIHVuaXRzOiAnY20nLFxyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnaW1hZ2VEaXN0YW5jZVByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogTnVtYmVySU8sXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ0hvcml6b250YWwgZGlzdGFuY2UgYmV0d2VlbiBvcHRpYyBhbmQgaW1hZ2UsIHdoZXJlIHRoZSBzaWduIGhhcyB0aGUgZm9sbG93aW5nIHNpZ25pZmljYW5jZS48YnI+PGJyPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICdGb3IgYSBsZW5zOicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dWw+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxsaT5wb3NpdGl2ZSBpcyBhIHJlYWwgaW1hZ2UgdG8gdGhlIHJpZ2h0IG9mIHRoZSBsZW5zPC9saT4nICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGxpPm5lZ2F0aXZlIGlzIGEgdmlydHVhbCBpbWFnZSB0byB0aGUgbGVmdCBvZiB0aGUgbGVuczwvbGk+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdWw+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0ZvciBhIG1pcnJvcjonICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGk+cG9zaXRpdmUgaXMgYSByZWFsIGltYWdlIHRvIHRoZSBsZWZ0IG9mIHRoZSBtaXJyb3I8L2xpPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGk+bmVnYXRpdmUgaXMgYSB2aXJ0dWFsIGltYWdlIHRvIHRoZSByaWdodCBvZiB0aGUgbWlycm9yPC9saT4nICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9saT4nXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm1hZ25pZmljYXRpb25Qcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgb3B0aWNhbE9iamVjdC5vYmplY3REaXN0YW5jZVByb3BlcnR5LCB0aGlzLmltYWdlRGlzdGFuY2VQcm9wZXJ0eSBdLFxyXG4gICAgICAoIG9iamVjdERpc3RhbmNlLCBpbWFnZURpc3RhbmNlICkgPT4ge1xyXG5cclxuICAgICAgICAvLyBwcmV2ZW50IGRpdmlzaW9uIGJ5IHplcm9cclxuICAgICAgICBpZiAoIG9iamVjdERpc3RhbmNlID09PSAwICkge1xyXG4gICAgICAgICAgcmV0dXJuIDE7IC8vIFRoZSBtYWduaWZpY2F0aW9uIGlzIDEgd2hlbiB0aGUgb2JqZWN0IGFuZCBvcHRpYyBhcmUgY29pbmNpZGVudC5cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gLTEgKiBpbWFnZURpc3RhbmNlIC8gb2JqZWN0RGlzdGFuY2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCB7XHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdtYWduaWZpY2F0aW9uUHJvcGVydHknICksXHJcbiAgICAgICAgcGhldGlvRmVhdHVyZWQ6IG9wdGlvbnMubWFnbmlmaWNhdGlvblByb3BlcnR5RmVhdHVyZWQsXHJcbiAgICAgICAgcGhldGlvVmFsdWVUeXBlOiBOdW1iZXJJTyxcclxuICAgICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnTWFnbmlmaWNhdGlvbiBvZiB0aGUgb3B0aWNhbCBpbWFnZS4gTmVnYXRpdmUgaW5kaWNhdGVzIHRoYXQgdGhlIGltYWdlIGlzIGludmVydGVkLidcclxuICAgICAgfSApO1xyXG5cclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgb3B0aWNhbE9iamVjdFBvc2l0aW9uUHJvcGVydHksIG9wdGljLnBvc2l0aW9uUHJvcGVydHksIHRoaXMuaW1hZ2VEaXN0YW5jZVByb3BlcnR5LCB0aGlzLm1hZ25pZmljYXRpb25Qcm9wZXJ0eSBdLFxyXG4gICAgICAoIG9wdGljYWxPYmplY3RQb3NpdGlvbiwgb3B0aWNQb3NpdGlvbiwgaW1hZ2VEaXN0YW5jZSwgbWFnbmlmaWNhdGlvbiApID0+IHtcclxuXHJcbiAgICAgICAgLy8gVGhlIGhlaWdodCBpcyBkZXRlcm1pbmVkIGFzIHRoZSB2ZXJ0aWNhbCBvZmZzZXQgZnJvbSB0aGUgb3B0aWNhbCBheGlzIG9mIHRoZSBmb2N1cyBwb2ludC5cclxuICAgICAgICAvLyBUaGUgaGVpZ2h0IHdpbGwgYmUgbmVnYXRpdmUgaWYgdGhlIG9wdGljYWwgaW1hZ2UgaXMgaW52ZXJ0ZWQuXHJcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gbWFnbmlmaWNhdGlvbiAqICggb3B0aWNhbE9iamVjdFBvc2l0aW9uLnkgLSBvcHRpY1Bvc2l0aW9uLnkgKTtcclxuXHJcbiAgICAgICAgLy8gUmVjYWxsIHRoYXQgdGhlIHNpZ24gaXMgZGlmZmVyZW50IGZvciBsZW5zIHZzIG1pcnJvci4gU2VlIHBoZXRpb0RvY3VtZW50YXRpb24gZm9yIGltYWdlRGlzdGFuY2VQcm9wZXJ0eS5cclxuICAgICAgICByZXR1cm4gb3B0aWNQb3NpdGlvbi5wbHVzWFkoIG9wdGljLnNpZ24gKiBpbWFnZURpc3RhbmNlLCBoZWlnaHQgKTtcclxuICAgICAgfSwge1xyXG4gICAgICAgIHVuaXRzOiAnY20nLFxyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAncG9zaXRpb25Qcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9GZWF0dXJlZDogdHJ1ZSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IFZlY3RvcjIuVmVjdG9yMklPXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm9wdGljYWxJbWFnZVR5cGVQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgdGhpcy5pbWFnZURpc3RhbmNlUHJvcGVydHkgXSxcclxuICAgICAgaW1hZ2VEaXN0YW5jZSA9PiAoIGltYWdlRGlzdGFuY2UgPCAwICkgPyAndmlydHVhbCcgOiAncmVhbCcsIHtcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ29wdGljYWxJbWFnZVR5cGVQcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9GZWF0dXJlZDogb3B0aW9ucy5vcHRpY2FsSW1hZ2VUeXBlUHJvcGVydHlGZWF0dXJlZCxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IFN0cmluZ1VuaW9uSU8oIE9wdGljYWxJbWFnZVR5cGVWYWx1ZXMgKSxcclxuICAgICAgICB2YWxpZFZhbHVlczogT3B0aWNhbEltYWdlVHlwZVZhbHVlc1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5yZXNldE9wdGljYWxJbWFnZSA9ICgpID0+IHtcclxuICAgICAgdGhpcy52aXNpYmxlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlc2V0T3B0aWNhbEltYWdlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuZ2VvbWV0cmljT3B0aWNzLnJlZ2lzdGVyKCAnT3B0aWNhbEltYWdlJywgT3B0aWNhbEltYWdlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxlQUFlLE1BQU0sd0NBQXdDO0FBR3BFLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsWUFBWSxNQUErQix1Q0FBdUM7QUFDekYsT0FBT0MsYUFBYSxNQUFNLDhDQUE4QztBQUN4RSxPQUFPQyxlQUFlLE1BQU0sMEJBQTBCO0FBRXRELFNBQTJCQyxzQkFBc0IsUUFBUSx1QkFBdUI7QUFFaEYsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQUU3RCxPQUFPQyxRQUFRLE1BQU0seUNBQXlDO0FBaUI5RCxlQUFlLE1BQU1DLFlBQVksU0FBU04sWUFBWSxDQUFDO0VBRXJEOztFQUdBOztFQUdBOztFQUdBOztFQUdBOztFQUdBO0VBQ0E7RUFDQTtFQUNBO0VBR0E7RUFHQTtFQUdPTyxXQUFXQSxDQUFFQyxhQUE0QixFQUFFQyxLQUFZLEVBQUVDLGVBQW9DLEVBQUc7SUFFckcsTUFBTUMsT0FBTyxHQUFHUCxTQUFTLENBQXdELENBQUMsQ0FBRTtNQUVsRjtNQUNBUSw2QkFBNkIsRUFBRUosYUFBYSxDQUFDSyxnQkFBZ0I7TUFD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