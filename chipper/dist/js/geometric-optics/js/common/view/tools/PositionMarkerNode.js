// Copyright 2022, University of Colorado Boulder

/**
 * PositionMarkerNode is the view of a position marker. It can be dragged in/out of the toolbox, and
 * positioned anywhere within the drag bounds.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../../axon/js/DerivedProperty.js';
import Bounds2 from '../../../../../dot/js/Bounds2.js';
import optionize from '../../../../../phet-core/js/optionize.js';
import PositionMarkerIcon from './PositionMarkerIcon.js';
import GOToolNode from './GOToolNode.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import MapMarkerNode from '../MapMarkerNode.js';
import GOToolKeyboardDragListener from './GOToolKeyboardDragListener.js';
import GOToolDragListener from './GOToolDragListener.js';
import geometricOptics from '../../../geometricOptics.js';
export default class PositionMarkerNode extends GOToolNode {
  // See GOToolNode

  // the marker that is associated with this Node

  /**
   * @param positionMarker - model element
   * @param zoomTransformProperty - model-view transform that the user controls by zooming in/out
   * @param visibleBoundsProperty - visible bounds of the ScreenView
   * @param providedOptions
   */
  constructor(positionMarker, zoomTransformProperty, visibleBoundsProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      touchAreaDilationX: 5,
      touchAreaDilationY: 5,
      mouseAreaDilationX: 5,
      mouseAreaDilationY: 5
    }, providedOptions);
    super(positionMarker, options);
    this.icon = new PositionMarkerIcon(positionMarker, this, zoomTransformProperty);
    this.positionMarker = positionMarker;
    const mapMarkerNode = new MapMarkerNode({
      fill: positionMarker.fill,
      stroke: positionMarker.stroke
    });
    this.addChild(mapMarkerNode);

    // pointer areas
    this.touchArea = this.localBounds.dilatedXY(options.touchAreaDilationX, options.touchAreaDilationY);
    this.mouseArea = this.localBounds.dilatedXY(options.mouseAreaDilationX, options.mouseAreaDilationY);

    // Origin is at centerTop.
    positionMarker.positionProperty.link(position => {
      this.centerTop = zoomTransformProperty.value.modelToViewPosition(position);
    });

    // Update the marker's model position to match this Node's view position, so that the marker remains stationary
    // in the view, and the model position is correct.
    zoomTransformProperty.lazyLink(zoomTransform => {
      positionMarker.positionProperty.value = zoomTransform.viewToModelPosition(this.centerTop);
    });

    // Drag bounds for the marker, in model coordinates.
    // This keeps the entire marker inside the visible bounds of the ScreenView.
    this.dragBoundsProperty = new DerivedProperty([visibleBoundsProperty, zoomTransformProperty], (visibleBounds, zoomTransform) => {
      const viewBounds = new Bounds2(visibleBounds.minX + this.width / 2, visibleBounds.minY, visibleBounds.maxX - this.width / 2, visibleBounds.maxY - this.height);
      return zoomTransform.viewToModelBounds(viewBounds);
    });

    // Keep the marker inside the drag bounds.
    this.dragBoundsProperty.link(dragBounds => {
      positionMarker.positionProperty.value = dragBounds.closestPointTo(positionMarker.positionProperty.value);
    });

    // Return the tool to the toolbox if the marker's bounds intersect the toolbox.
    // toolboxNode should be set by the time this is called.
    const shouldReturnToToolbox = () => this.toolboxNode.intersectsGlobalBounds(this.parentToGlobalBounds(this.bounds));

    // Dragging with the pointer.
    this.dragListener = new GOToolDragListener(positionMarker, this, zoomTransformProperty, this.dragBoundsProperty, shouldReturnToToolbox, {
      offsetPosition: () => new Vector2(-this.width / 2, -this.height),
      tandem: options.tandem.createTandem('dragListener')
    });
    this.addInputListener(this.dragListener);

    // Dragging with the keyboard.
    const keyboardDragListener = new GOToolKeyboardDragListener(positionMarker, this, zoomTransformProperty, this.dragBoundsProperty, shouldReturnToToolbox, {
      tandem: options.tandem.createTandem('keyboardDragListener')
    });
    this.addInputListener(keyboardDragListener);
  }

  /**
   * Handles the 'J' (Jump) hotkey, which moves the ruler to the next 'interesting' point.
   * See https://github.com/phetsims/geometric-optics/issues/355
   */
  jumpToPoint() {
    const markerPosition = this.positionMarker.positionProperty.value;

    // Find the points that are relevant.
    const relevantJumpPoints = this.jumpPoints.filter(jumpPoint =>
    // not null
    jumpPoint.positionProperty.value !== null &&
    // visible
    jumpPoint.visibleProperty.value &&
    // inside the tool's drag bounds, so the tool doesn't move out of bounds
    this.dragBoundsProperty.value.containsPoint(jumpPoint.positionProperty.value));

    // Find the next jump point and move there.
    if (relevantJumpPoints.length > 0) {
      // Get the next point, based on the marker's position.
      const nextPoint = GOToolNode.getNextJumpPoint(relevantJumpPoints, markerPosition);

      // Move the marker
      if (nextPoint) {
        this.positionMarker.positionProperty.value = nextPoint;
      }
    }
  }
}
geometricOptics.register('PositionMarkerNode', PositionMarkerNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJCb3VuZHMyIiwib3B0aW9uaXplIiwiUG9zaXRpb25NYXJrZXJJY29uIiwiR09Ub29sTm9kZSIsIlZlY3RvcjIiLCJNYXBNYXJrZXJOb2RlIiwiR09Ub29sS2V5Ym9hcmREcmFnTGlzdGVuZXIiLCJHT1Rvb2xEcmFnTGlzdGVuZXIiLCJnZW9tZXRyaWNPcHRpY3MiLCJQb3NpdGlvbk1hcmtlck5vZGUiLCJjb25zdHJ1Y3RvciIsInBvc2l0aW9uTWFya2VyIiwiem9vbVRyYW5zZm9ybVByb3BlcnR5IiwidmlzaWJsZUJvdW5kc1Byb3BlcnR5IiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInRvdWNoQXJlYURpbGF0aW9uWCIsInRvdWNoQXJlYURpbGF0aW9uWSIsIm1vdXNlQXJlYURpbGF0aW9uWCIsIm1vdXNlQXJlYURpbGF0aW9uWSIsImljb24iLCJtYXBNYXJrZXJOb2RlIiwiZmlsbCIsInN0cm9rZSIsImFkZENoaWxkIiwidG91Y2hBcmVhIiwibG9jYWxCb3VuZHMiLCJkaWxhdGVkWFkiLCJtb3VzZUFyZWEiLCJwb3NpdGlvblByb3BlcnR5IiwibGluayIsInBvc2l0aW9uIiwiY2VudGVyVG9wIiwidmFsdWUiLCJtb2RlbFRvVmlld1Bvc2l0aW9uIiwibGF6eUxpbmsiLCJ6b29tVHJhbnNmb3JtIiwidmlld1RvTW9kZWxQb3NpdGlvbiIsImRyYWdCb3VuZHNQcm9wZXJ0eSIsInZpc2libGVCb3VuZHMiLCJ2aWV3Qm91bmRzIiwibWluWCIsIndpZHRoIiwibWluWSIsIm1heFgiLCJtYXhZIiwiaGVpZ2h0Iiwidmlld1RvTW9kZWxCb3VuZHMiLCJkcmFnQm91bmRzIiwiY2xvc2VzdFBvaW50VG8iLCJzaG91bGRSZXR1cm5Ub1Rvb2xib3giLCJ0b29sYm94Tm9kZSIsImludGVyc2VjdHNHbG9iYWxCb3VuZHMiLCJwYXJlbnRUb0dsb2JhbEJvdW5kcyIsImJvdW5kcyIsImRyYWdMaXN0ZW5lciIsIm9mZnNldFBvc2l0aW9uIiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwiYWRkSW5wdXRMaXN0ZW5lciIsImtleWJvYXJkRHJhZ0xpc3RlbmVyIiwianVtcFRvUG9pbnQiLCJtYXJrZXJQb3NpdGlvbiIsInJlbGV2YW50SnVtcFBvaW50cyIsImp1bXBQb2ludHMiLCJmaWx0ZXIiLCJqdW1wUG9pbnQiLCJ2aXNpYmxlUHJvcGVydHkiLCJjb250YWluc1BvaW50IiwibGVuZ3RoIiwibmV4dFBvaW50IiwiZ2V0TmV4dEp1bXBQb2ludCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUG9zaXRpb25NYXJrZXJOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBQb3NpdGlvbk1hcmtlck5vZGUgaXMgdGhlIHZpZXcgb2YgYSBwb3NpdGlvbiBtYXJrZXIuIEl0IGNhbiBiZSBkcmFnZ2VkIGluL291dCBvZiB0aGUgdG9vbGJveCwgYW5kXHJcbiAqIHBvc2l0aW9uZWQgYW55d2hlcmUgd2l0aGluIHRoZSBkcmFnIGJvdW5kcy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCB7IERyYWdMaXN0ZW5lciB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBvc2l0aW9uTWFya2VyIGZyb20gJy4uLy4uL21vZGVsL3Rvb2xzL1Bvc2l0aW9uTWFya2VyLmpzJztcclxuaW1wb3J0IFBvc2l0aW9uTWFya2VySWNvbiBmcm9tICcuL1Bvc2l0aW9uTWFya2VySWNvbi5qcyc7XHJcbmltcG9ydCBHT1Rvb2xOb2RlLCB7IEdPVG9vbE5vZGVPcHRpb25zIH0gZnJvbSAnLi9HT1Rvb2xOb2RlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgTWFwTWFya2VyTm9kZSBmcm9tICcuLi9NYXBNYXJrZXJOb2RlLmpzJztcclxuaW1wb3J0IEdPVG9vbEtleWJvYXJkRHJhZ0xpc3RlbmVyIGZyb20gJy4vR09Ub29sS2V5Ym9hcmREcmFnTGlzdGVuZXIuanMnO1xyXG5pbXBvcnQgR09Ub29sRHJhZ0xpc3RlbmVyIGZyb20gJy4vR09Ub29sRHJhZ0xpc3RlbmVyLmpzJztcclxuaW1wb3J0IGdlb21ldHJpY09wdGljcyBmcm9tICcuLi8uLi8uLi9nZW9tZXRyaWNPcHRpY3MuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuXHJcbiAgLy8gcG9pbnRlciBhcmVhc1xyXG4gIHRvdWNoQXJlYURpbGF0aW9uWD86IG51bWJlcjtcclxuICB0b3VjaEFyZWFEaWxhdGlvblk/OiBudW1iZXI7XHJcbiAgbW91c2VBcmVhRGlsYXRpb25YPzogbnVtYmVyO1xyXG4gIG1vdXNlQXJlYURpbGF0aW9uWT86IG51bWJlcjtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFBvc2l0aW9uTWFya2VyTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIEdPVG9vbE5vZGVPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9zaXRpb25NYXJrZXJOb2RlIGV4dGVuZHMgR09Ub29sTm9kZSB7XHJcblxyXG4gIC8vIFNlZSBHT1Rvb2xOb2RlXHJcbiAgcHVibGljIHJlYWRvbmx5IGljb246IFBvc2l0aW9uTWFya2VySWNvbjtcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZHJhZ0xpc3RlbmVyOiBEcmFnTGlzdGVuZXI7XHJcblxyXG4gIC8vIHRoZSBtYXJrZXIgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggdGhpcyBOb2RlXHJcbiAgcHVibGljIHJlYWRvbmx5IHBvc2l0aW9uTWFya2VyOiBQb3NpdGlvbk1hcmtlcjtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkcmFnQm91bmRzUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEJvdW5kczI+O1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gcG9zaXRpb25NYXJrZXIgLSBtb2RlbCBlbGVtZW50XHJcbiAgICogQHBhcmFtIHpvb21UcmFuc2Zvcm1Qcm9wZXJ0eSAtIG1vZGVsLXZpZXcgdHJhbnNmb3JtIHRoYXQgdGhlIHVzZXIgY29udHJvbHMgYnkgem9vbWluZyBpbi9vdXRcclxuICAgKiBAcGFyYW0gdmlzaWJsZUJvdW5kc1Byb3BlcnR5IC0gdmlzaWJsZSBib3VuZHMgb2YgdGhlIFNjcmVlblZpZXdcclxuICAgKiBAcGFyYW0gcHJvdmlkZWRPcHRpb25zXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwb3NpdGlvbk1hcmtlcjogUG9zaXRpb25NYXJrZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICB6b29tVHJhbnNmb3JtUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PE1vZGVsVmlld1RyYW5zZm9ybTI+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZUJvdW5kc1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxCb3VuZHMyPixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9uczogUG9zaXRpb25NYXJrZXJOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFBvc2l0aW9uTWFya2VyTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBHT1Rvb2xOb2RlT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgdG91Y2hBcmVhRGlsYXRpb25YOiA1LFxyXG4gICAgICB0b3VjaEFyZWFEaWxhdGlvblk6IDUsXHJcbiAgICAgIG1vdXNlQXJlYURpbGF0aW9uWDogNSxcclxuICAgICAgbW91c2VBcmVhRGlsYXRpb25ZOiA1XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggcG9zaXRpb25NYXJrZXIsIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLmljb24gPSBuZXcgUG9zaXRpb25NYXJrZXJJY29uKCBwb3NpdGlvbk1hcmtlciwgdGhpcywgem9vbVRyYW5zZm9ybVByb3BlcnR5ICk7XHJcbiAgICB0aGlzLnBvc2l0aW9uTWFya2VyID0gcG9zaXRpb25NYXJrZXI7XHJcblxyXG4gICAgY29uc3QgbWFwTWFya2VyTm9kZSA9IG5ldyBNYXBNYXJrZXJOb2RlKCB7XHJcbiAgICAgIGZpbGw6IHBvc2l0aW9uTWFya2VyLmZpbGwsXHJcbiAgICAgIHN0cm9rZTogcG9zaXRpb25NYXJrZXIuc3Ryb2tlXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBtYXBNYXJrZXJOb2RlICk7XHJcblxyXG4gICAgLy8gcG9pbnRlciBhcmVhc1xyXG4gICAgdGhpcy50b3VjaEFyZWEgPSB0aGlzLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggb3B0aW9ucy50b3VjaEFyZWFEaWxhdGlvblgsIG9wdGlvbnMudG91Y2hBcmVhRGlsYXRpb25ZICk7XHJcbiAgICB0aGlzLm1vdXNlQXJlYSA9IHRoaXMubG9jYWxCb3VuZHMuZGlsYXRlZFhZKCBvcHRpb25zLm1vdXNlQXJlYURpbGF0aW9uWCwgb3B0aW9ucy5tb3VzZUFyZWFEaWxhdGlvblkgKTtcclxuXHJcbiAgICAvLyBPcmlnaW4gaXMgYXQgY2VudGVyVG9wLlxyXG4gICAgcG9zaXRpb25NYXJrZXIucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBwb3NpdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMuY2VudGVyVG9wID0gem9vbVRyYW5zZm9ybVByb3BlcnR5LnZhbHVlLm1vZGVsVG9WaWV3UG9zaXRpb24oIHBvc2l0aW9uICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBtYXJrZXIncyBtb2RlbCBwb3NpdGlvbiB0byBtYXRjaCB0aGlzIE5vZGUncyB2aWV3IHBvc2l0aW9uLCBzbyB0aGF0IHRoZSBtYXJrZXIgcmVtYWlucyBzdGF0aW9uYXJ5XHJcbiAgICAvLyBpbiB0aGUgdmlldywgYW5kIHRoZSBtb2RlbCBwb3NpdGlvbiBpcyBjb3JyZWN0LlxyXG4gICAgem9vbVRyYW5zZm9ybVByb3BlcnR5LmxhenlMaW5rKCAoIHpvb21UcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIgKSA9PiB7XHJcbiAgICAgIHBvc2l0aW9uTWFya2VyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSB6b29tVHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHRoaXMuY2VudGVyVG9wICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gRHJhZyBib3VuZHMgZm9yIHRoZSBtYXJrZXIsIGluIG1vZGVsIGNvb3JkaW5hdGVzLlxyXG4gICAgLy8gVGhpcyBrZWVwcyB0aGUgZW50aXJlIG1hcmtlciBpbnNpZGUgdGhlIHZpc2libGUgYm91bmRzIG9mIHRoZSBTY3JlZW5WaWV3LlxyXG4gICAgdGhpcy5kcmFnQm91bmRzUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICBbIHZpc2libGVCb3VuZHNQcm9wZXJ0eSwgem9vbVRyYW5zZm9ybVByb3BlcnR5IF0sXHJcbiAgICAgICggdmlzaWJsZUJvdW5kcywgem9vbVRyYW5zZm9ybSApID0+IHtcclxuICAgICAgICBjb25zdCB2aWV3Qm91bmRzID0gbmV3IEJvdW5kczIoIHZpc2libGVCb3VuZHMubWluWCArIHRoaXMud2lkdGggLyAyLCB2aXNpYmxlQm91bmRzLm1pblksXHJcbiAgICAgICAgICB2aXNpYmxlQm91bmRzLm1heFggLSB0aGlzLndpZHRoIC8gMiwgdmlzaWJsZUJvdW5kcy5tYXhZIC0gdGhpcy5oZWlnaHQgKTtcclxuICAgICAgICByZXR1cm4gem9vbVRyYW5zZm9ybS52aWV3VG9Nb2RlbEJvdW5kcyggdmlld0JvdW5kcyApO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIC8vIEtlZXAgdGhlIG1hcmtlciBpbnNpZGUgdGhlIGRyYWcgYm91bmRzLlxyXG4gICAgdGhpcy5kcmFnQm91bmRzUHJvcGVydHkubGluayggZHJhZ0JvdW5kcyA9PiB7XHJcbiAgICAgIHBvc2l0aW9uTWFya2VyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBkcmFnQm91bmRzLmNsb3Nlc3RQb2ludFRvKCBwb3NpdGlvbk1hcmtlci5wb3NpdGlvblByb3BlcnR5LnZhbHVlICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gUmV0dXJuIHRoZSB0b29sIHRvIHRoZSB0b29sYm94IGlmIHRoZSBtYXJrZXIncyBib3VuZHMgaW50ZXJzZWN0IHRoZSB0b29sYm94LlxyXG4gICAgLy8gdG9vbGJveE5vZGUgc2hvdWxkIGJlIHNldCBieSB0aGUgdGltZSB0aGlzIGlzIGNhbGxlZC5cclxuICAgIGNvbnN0IHNob3VsZFJldHVyblRvVG9vbGJveCA9ICgpID0+IHRoaXMudG9vbGJveE5vZGUhLmludGVyc2VjdHNHbG9iYWxCb3VuZHMoIHRoaXMucGFyZW50VG9HbG9iYWxCb3VuZHMoIHRoaXMuYm91bmRzICkgKTtcclxuXHJcbiAgICAvLyBEcmFnZ2luZyB3aXRoIHRoZSBwb2ludGVyLlxyXG4gICAgdGhpcy5kcmFnTGlzdGVuZXIgPSBuZXcgR09Ub29sRHJhZ0xpc3RlbmVyKCBwb3NpdGlvbk1hcmtlciwgdGhpcywgem9vbVRyYW5zZm9ybVByb3BlcnR5LCB0aGlzLmRyYWdCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgc2hvdWxkUmV0dXJuVG9Ub29sYm94LCB7XHJcbiAgICAgICAgb2Zmc2V0UG9zaXRpb246ICgpID0+IG5ldyBWZWN0b3IyKCAtdGhpcy53aWR0aCAvIDIsIC10aGlzLmhlaWdodCApLFxyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZHJhZ0xpc3RlbmVyJyApXHJcbiAgICAgIH0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggdGhpcy5kcmFnTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBEcmFnZ2luZyB3aXRoIHRoZSBrZXlib2FyZC5cclxuICAgIGNvbnN0IGtleWJvYXJkRHJhZ0xpc3RlbmVyID0gbmV3IEdPVG9vbEtleWJvYXJkRHJhZ0xpc3RlbmVyKCBwb3NpdGlvbk1hcmtlciwgdGhpcywgem9vbVRyYW5zZm9ybVByb3BlcnR5LFxyXG4gICAgICB0aGlzLmRyYWdCb3VuZHNQcm9wZXJ0eSwgc2hvdWxkUmV0dXJuVG9Ub29sYm94LCB7XHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdrZXlib2FyZERyYWdMaXN0ZW5lcicgKVxyXG4gICAgICB9ICk7XHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIGtleWJvYXJkRHJhZ0xpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBIYW5kbGVzIHRoZSAnSicgKEp1bXApIGhvdGtleSwgd2hpY2ggbW92ZXMgdGhlIHJ1bGVyIHRvIHRoZSBuZXh0ICdpbnRlcmVzdGluZycgcG9pbnQuXHJcbiAgICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9nZW9tZXRyaWMtb3B0aWNzL2lzc3Vlcy8zNTVcclxuICAgKi9cclxuICBwdWJsaWMganVtcFRvUG9pbnQoKTogdm9pZCB7XHJcblxyXG4gICAgY29uc3QgbWFya2VyUG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uTWFya2VyLnBvc2l0aW9uUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgLy8gRmluZCB0aGUgcG9pbnRzIHRoYXQgYXJlIHJlbGV2YW50LlxyXG4gICAgY29uc3QgcmVsZXZhbnRKdW1wUG9pbnRzID0gdGhpcy5qdW1wUG9pbnRzLmZpbHRlcigganVtcFBvaW50ID0+XHJcblxyXG4gICAgICAvLyBub3QgbnVsbFxyXG4gICAgICAoIGp1bXBQb2ludC5wb3NpdGlvblByb3BlcnR5LnZhbHVlICE9PSBudWxsICkgJiZcclxuXHJcbiAgICAgIC8vIHZpc2libGVcclxuICAgICAganVtcFBvaW50LnZpc2libGVQcm9wZXJ0eS52YWx1ZSAmJlxyXG5cclxuICAgICAgLy8gaW5zaWRlIHRoZSB0b29sJ3MgZHJhZyBib3VuZHMsIHNvIHRoZSB0b29sIGRvZXNuJ3QgbW92ZSBvdXQgb2YgYm91bmRzXHJcbiAgICAgIHRoaXMuZHJhZ0JvdW5kc1Byb3BlcnR5LnZhbHVlLmNvbnRhaW5zUG9pbnQoIGp1bXBQb2ludC5wb3NpdGlvblByb3BlcnR5LnZhbHVlIClcclxuICAgICk7XHJcblxyXG4gICAgLy8gRmluZCB0aGUgbmV4dCBqdW1wIHBvaW50IGFuZCBtb3ZlIHRoZXJlLlxyXG4gICAgaWYgKCByZWxldmFudEp1bXBQb2ludHMubGVuZ3RoID4gMCApIHtcclxuXHJcbiAgICAgIC8vIEdldCB0aGUgbmV4dCBwb2ludCwgYmFzZWQgb24gdGhlIG1hcmtlcidzIHBvc2l0aW9uLlxyXG4gICAgICBjb25zdCBuZXh0UG9pbnQgPSBHT1Rvb2xOb2RlLmdldE5leHRKdW1wUG9pbnQoIHJlbGV2YW50SnVtcFBvaW50cywgbWFya2VyUG9zaXRpb24gKTtcclxuXHJcbiAgICAgIC8vIE1vdmUgdGhlIG1hcmtlclxyXG4gICAgICBpZiAoIG5leHRQb2ludCApIHtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uTWFya2VyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBuZXh0UG9pbnQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmdlb21ldHJpY09wdGljcy5yZWdpc3RlciggJ1Bvc2l0aW9uTWFya2VyTm9kZScsIFBvc2l0aW9uTWFya2VyTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSwyQ0FBMkM7QUFDdkUsT0FBT0MsT0FBTyxNQUFNLGtDQUFrQztBQUl0RCxPQUFPQyxTQUFTLE1BQU0sMENBQTBDO0FBRWhFLE9BQU9DLGtCQUFrQixNQUFNLHlCQUF5QjtBQUN4RCxPQUFPQyxVQUFVLE1BQTZCLGlCQUFpQjtBQUMvRCxPQUFPQyxPQUFPLE1BQU0sa0NBQWtDO0FBQ3RELE9BQU9DLGFBQWEsTUFBTSxxQkFBcUI7QUFDL0MsT0FBT0MsMEJBQTBCLE1BQU0saUNBQWlDO0FBQ3hFLE9BQU9DLGtCQUFrQixNQUFNLHlCQUF5QjtBQUN4RCxPQUFPQyxlQUFlLE1BQU0sNkJBQTZCO0FBYXpELGVBQWUsTUFBTUMsa0JBQWtCLFNBQVNOLFVBQVUsQ0FBQztFQUV6RDs7RUFJQTs7RUFLQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDU08sV0FBV0EsQ0FBRUMsY0FBOEIsRUFDOUJDLHFCQUE2RCxFQUM3REMscUJBQWlELEVBQ2pEQyxlQUEwQyxFQUFHO0lBRS9ELE1BQU1DLE9BQU8sR0FBR2QsU0FBUyxDQUE0RCxDQUFDLENBQUU7TUFFdEY7TUFDQWUsa0JBQWtCLEVBQUUsQ0FBQztNQUNyQkMsa0JBQWtCLEVBQUUsQ0FBQztNQUNyQkMsa0JBQWtCLEVBQUUsQ0FBQztNQUNyQkMsa0JBQWtCLEVBQUU7SUFDdEIsQ0FBQyxFQUFFTCxlQUFnQixDQUFDO0lBRXBCLEtBQUssQ0FBRUgsY0FBYyxFQUFFSSxPQUFRLENBQUM7SUFFaEMsSUFBSSxDQUFDSyxJQUFJLEdBQUcsSUFBSWxCLGtCQUFrQixDQUFFUyxjQUFjLEVB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