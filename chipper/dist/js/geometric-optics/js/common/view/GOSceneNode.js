// Copyright 2022-2023, University of Colorado Boulder

/**
 * GOSceneNode is the abstract base class for all scenes.  It handles things related to the optic and guides,
 * and creates "layers" for things that may be added by subclasses.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import { Node } from '../../../../scenery/js/imports.js';
import geometricOptics from '../../geometricOptics.js';
import OpticalAxisNode from './OpticalAxisNode.js';
import OpticVerticalAxisNode from './OpticVerticalAxisNode.js';
import FocalPointNode from './FocalPointNode.js';
import TwoFPointNode from './TwoFPointNode.js';
import GOColors from '../GOColors.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import GuidesNode from './GuidesNode.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import optionize from '../../../../phet-core/js/optionize.js';
import ToolJumpPoint from '../model/tools/ToolJumpPoint.js';
import Lens from '../../lens/model/Lens.js';
export default class GOSceneNode extends Node {
  // 'Jump points' for the tools. These are interesting points, where you might want to place a tool.
  // When a tool has focus, 'J' hotkey will cycle through these points, in order of ascending x coordinate.

  // Jump points related to the optic, common to all scenes

  // Various rendering layers where subclasses are expected to add Nodes.

  // Visibility of things that have labels, intended to be used to control the visibility of associated labels.

  /**
   * @param scene - model element
   * @param visibleProperties
   * @param modelViewTransform
   * @param modelVisibleBoundsProperty - ScreenView's visibleBounds in the model coordinate frame, with the zoom transform applied
   * @param sceneBoundsProperty - bounds for the scene, in model coordinates
   * @param raysTypeProperty - representation used for rays
   * @param providedOptions
   */
  constructor(scene, visibleProperties, modelViewTransform, modelVisibleBoundsProperty, sceneBoundsProperty, raysTypeProperty, providedOptions) {
    const options = optionize()({
      // NodeOptions
      visiblePropertyOptions: {
        phetioReadOnly: true
      }
    }, providedOptions);
    super(options);
    const opticNode = options.createOpticNode(modelViewTransform, options.tandem);
    const opticalAxisNode = new OpticalAxisNode(scene.optic.positionProperty, modelVisibleBoundsProperty, modelViewTransform, {
      visibleProperty: visibleProperties.opticalAxisVisibleProperty,
      tandem: options.tandem.createTandem('opticalAxisNode')
    });
    const opticVerticalAxisNode = new OpticVerticalAxisNode(scene.optic, raysTypeProperty, modelViewTransform);

    /**
     * A note about visibility of focal points (F and 2F), see https://github.com/phetsims/geometric-optics/issues/457.
     * A lens has 2 focal points. But since a mirror only has one surface, it only has one focal point. Unfortunately,
     * our Optic base class is very dependent on having two F and 2F points. So rather than modify the model, we decided
     * to control the visibility of F and 2F in the view - see 'visibleProperty: new DerivedProperty(...)' below.
     * For a lens, all F and 2F points are made visible.
     * For a concave mirror, F and 2F are on the left, so only leftFocalPointNode and left2FPointNode are made visible.
     * For a convex mirror, F and 2F are on the right, so only rightFocalPointNode and right2FPointNode are visible.
     * For a flat mirror, F and 2F are at infinity, so all F and 2F points are made invisible.
     */

    // Focal Points (F)
    const focalPointsTandem = options.tandem.createTandem('focalPoints');
    const leftFocalPointNodeTandem = focalPointsTandem.createTandem('leftFocalPointNode');
    const leftFocalPointNode = new FocalPointNode(scene.optic.leftFocalPointProperty, modelViewTransform, {
      visibleProperty: scene.optic instanceof Lens ? visibleProperties.focalPointsVisibleProperty : new DerivedProperty([visibleProperties.focalPointsVisibleProperty, scene.optic.opticSurfaceTypeProperty], (focalPointsVisible, surfaceType) => focalPointsVisible && surfaceType === 'concave', {
        tandem: leftFocalPointNodeTandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      }),
      tandem: leftFocalPointNodeTandem
    });
    const rightFocalPointNodeTandem = focalPointsTandem.createTandem('rightFocalPointNode');
    const rightFocalPointNode = new FocalPointNode(scene.optic.rightFocalPointProperty, modelViewTransform, {
      visibleProperty: scene.optic instanceof Lens ? visibleProperties.focalPointsVisibleProperty : new DerivedProperty([visibleProperties.focalPointsVisibleProperty, scene.optic.opticSurfaceTypeProperty], (focalPointsVisible, surfaceType) => focalPointsVisible && surfaceType === 'convex', {
        tandem: rightFocalPointNodeTandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      }),
      tandem: rightFocalPointNodeTandem
    });

    // 2F Points
    const twoFPointTandem = options.tandem.createTandem('twoFPoints');
    const left2FPointNodeTandem = twoFPointTandem.createTandem('left2FPointNode');
    const left2FPointNode = new TwoFPointNode(scene.optic.left2FProperty, modelViewTransform, {
      visibleProperty: scene.optic instanceof Lens ? visibleProperties.twoFPointsVisibleProperty : new DerivedProperty([visibleProperties.twoFPointsVisibleProperty, scene.optic.opticSurfaceTypeProperty], (twoFPointsVisible, surfaceType) => twoFPointsVisible && surfaceType === 'concave', {
        tandem: left2FPointNodeTandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      }),
      tandem: left2FPointNodeTandem
    });
    const right2FPointNodeTandem = twoFPointTandem.createTandem('right2FPointNode');
    const right2FPointNode = new TwoFPointNode(scene.optic.right2FProperty, modelViewTransform, {
      visibleProperty: scene.optic instanceof Lens ? visibleProperties.twoFPointsVisibleProperty : new DerivedProperty([visibleProperties.twoFPointsVisibleProperty, scene.optic.opticSurfaceTypeProperty], (twoFPointsVisible, surfaceType) => twoFPointsVisible && surfaceType === 'convex', {
        tandem: right2FPointNodeTandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      }),
      tandem: right2FPointNodeTandem
    });

    // Layers for things that may be added by subclasses
    this.opticalAxisForegroundLayer = new Node();
    this.opticalObjectsLayer = new Node();
    this.opticalImagesLayer = new Node();
    this.raysForegroundLayer = new Node();
    this.raysBackgroundLayer = new Node();
    const guidesLayer = new Node();
    if (scene.guides1) {
      const guides1Tandem = options.tandem.createTandem('guides1Node');
      const guides1Node = new GuidesNode(scene.guides1, GOColors.guideArm1FillProperty, modelViewTransform, {
        visibleProperty: visibleProperties.guidesVisibleProperty,
        tandem: guides1Tandem,
        phetioDocumentation: 'guides associated with the first object'
      });
      guidesLayer.addChild(guides1Node);
    }
    if (scene.guides2) {
      const guides2Tandem = options.tandem.createTandem('guides2Node');
      const guides2Node = new GuidesNode(scene.guides2, GOColors.guideArm2FillProperty, modelViewTransform, {
        visibleProperty: DerivedProperty.and([visibleProperties.guidesVisibleProperty, visibleProperties.secondPointVisibleProperty], {
          tandem: guides2Tandem.createTandem('visibleProperty'),
          phetioValueType: BooleanIO
        }),
        tandem: guides2Tandem,
        phetioDocumentation: 'guides associated with the second object'
      });
      guidesLayer.addChild(guides2Node);
    }

    // Rendering order is VERY important here.
    this.children = [opticalAxisNode, this.opticalObjectsLayer, this.raysBackgroundLayer, this.opticalImagesLayer, this.opticalAxisForegroundLayer, opticNode, opticVerticalAxisNode, leftFocalPointNode, rightFocalPointNode, left2FPointNode, right2FPointNode, this.raysForegroundLayer, guidesLayer];
    this.addLinkedElement(scene, {
      tandem: options.tandem.createTandem(scene.tandem.name)
    });
    this.opticJumpPoints = [new ToolJumpPoint(scene.optic.positionProperty, opticNode.visibleProperty), new ToolJumpPoint(scene.optic.leftFocalPointProperty, leftFocalPointNode.visibleProperty), new ToolJumpPoint(scene.optic.rightFocalPointProperty, rightFocalPointNode.visibleProperty), new ToolJumpPoint(scene.optic.left2FProperty, left2FPointNode.visibleProperty), new ToolJumpPoint(scene.optic.right2FProperty, right2FPointNode.visibleProperty)];

    // Visibility for associates labels
    this.opticNodeVisibleProperty = opticNode.visibleProperty;
    this.opticalAxisNodeVisibleProperty = opticalAxisNode.visibleProperty;
    this.leftFocalPointNodeVisibleProperty = leftFocalPointNode.visibleProperty;
    this.rightFocalPointNodeVisibleProperty = rightFocalPointNode.visibleProperty;
    this.left2FPointNodeVisibleProperty = left2FPointNode.visibleProperty;
    this.right2FPointNodeVisibleProperty = right2FPointNode.visibleProperty;
  }
}
geometricOptics.register('GOSceneNode', GOSceneNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOb2RlIiwiZ2VvbWV0cmljT3B0aWNzIiwiT3B0aWNhbEF4aXNOb2RlIiwiT3B0aWNWZXJ0aWNhbEF4aXNOb2RlIiwiRm9jYWxQb2ludE5vZGUiLCJUd29GUG9pbnROb2RlIiwiR09Db2xvcnMiLCJEZXJpdmVkUHJvcGVydHkiLCJHdWlkZXNOb2RlIiwiQm9vbGVhbklPIiwib3B0aW9uaXplIiwiVG9vbEp1bXBQb2ludCIsIkxlbnMiLCJHT1NjZW5lTm9kZSIsImNvbnN0cnVjdG9yIiwic2NlbmUiLCJ2aXNpYmxlUHJvcGVydGllcyIsIm1vZGVsVmlld1RyYW5zZm9ybSIsIm1vZGVsVmlzaWJsZUJvdW5kc1Byb3BlcnR5Iiwic2NlbmVCb3VuZHNQcm9wZXJ0eSIsInJheXNUeXBlUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwidmlzaWJsZVByb3BlcnR5T3B0aW9ucyIsInBoZXRpb1JlYWRPbmx5Iiwib3B0aWNOb2RlIiwiY3JlYXRlT3B0aWNOb2RlIiwidGFuZGVtIiwib3B0aWNhbEF4aXNOb2RlIiwib3B0aWMiLCJwb3NpdGlvblByb3BlcnR5IiwidmlzaWJsZVByb3BlcnR5Iiwib3B0aWNhbEF4aXNWaXNpYmxlUHJvcGVydHkiLCJjcmVhdGVUYW5kZW0iLCJvcHRpY1ZlcnRpY2FsQXhpc05vZGUiLCJmb2NhbFBvaW50c1RhbmRlbSIsImxlZnRGb2NhbFBvaW50Tm9kZVRhbmRlbSIsImxlZnRGb2NhbFBvaW50Tm9kZSIsImxlZnRGb2NhbFBvaW50UHJvcGVydHkiLCJmb2NhbFBvaW50c1Zpc2libGVQcm9wZXJ0eSIsIm9wdGljU3VyZmFjZVR5cGVQcm9wZXJ0eSIsImZvY2FsUG9pbnRzVmlzaWJsZSIsInN1cmZhY2VUeXBlIiwicGhldGlvVmFsdWVUeXBlIiwicmlnaHRGb2NhbFBvaW50Tm9kZVRhbmRlbSIsInJpZ2h0Rm9jYWxQb2ludE5vZGUiLCJyaWdodEZvY2FsUG9pbnRQcm9wZXJ0eSIsInR3b0ZQb2ludFRhbmRlbSIsImxlZnQyRlBvaW50Tm9kZVRhbmRlbSIsImxlZnQyRlBvaW50Tm9kZSIsImxlZnQyRlByb3BlcnR5IiwidHdvRlBvaW50c1Zpc2libGVQcm9wZXJ0eSIsInR3b0ZQb2ludHNWaXNpYmxlIiwicmlnaHQyRlBvaW50Tm9kZVRhbmRlbSIsInJpZ2h0MkZQb2ludE5vZGUiLCJyaWdodDJGUHJvcGVydHkiLCJvcHRpY2FsQXhpc0ZvcmVncm91bmRMYXllciIsIm9wdGljYWxPYmplY3RzTGF5ZXIiLCJvcHRpY2FsSW1hZ2VzTGF5ZXIiLCJyYXlzRm9yZWdyb3VuZExheWVyIiwicmF5c0JhY2tncm91bmRMYXllciIsImd1aWRlc0xheWVyIiwiZ3VpZGVzMSIsImd1aWRlczFUYW5kZW0iLCJndWlkZXMxTm9kZSIsImd1aWRlQXJtMUZpbGxQcm9wZXJ0eSIsImd1aWRlc1Zpc2libGVQcm9wZXJ0eSIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJhZGRDaGlsZCIsImd1aWRlczIiLCJndWlkZXMyVGFuZGVtIiwiZ3VpZGVzMk5vZGUiLCJndWlkZUFybTJGaWxsUHJvcGVydHkiLCJhbmQiLCJzZWNvbmRQb2ludFZpc2libGVQcm9wZXJ0eSIsImNoaWxkcmVuIiwiYWRkTGlua2VkRWxlbWVudCIsIm5hbWUiLCJvcHRpY0p1bXBQb2ludHMiLCJvcHRpY05vZGVWaXNpYmxlUHJvcGVydHkiLCJvcHRpY2FsQXhpc05vZGVWaXNpYmxlUHJvcGVydHkiLCJsZWZ0Rm9jYWxQb2ludE5vZGVWaXNpYmxlUHJvcGVydHkiLCJyaWdodEZvY2FsUG9pbnROb2RlVmlzaWJsZVByb3BlcnR5IiwibGVmdDJGUG9pbnROb2RlVmlzaWJsZVByb3BlcnR5IiwicmlnaHQyRlBvaW50Tm9kZVZpc2libGVQcm9wZXJ0eSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiR09TY2VuZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjItMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogR09TY2VuZU5vZGUgaXMgdGhlIGFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIGFsbCBzY2VuZXMuICBJdCBoYW5kbGVzIHRoaW5ncyByZWxhdGVkIHRvIHRoZSBvcHRpYyBhbmQgZ3VpZGVzLFxyXG4gKiBhbmQgY3JlYXRlcyBcImxheWVyc1wiIGZvciB0aGluZ3MgdGhhdCBtYXkgYmUgYWRkZWQgYnkgc3ViY2xhc3Nlcy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIE5vZGVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGdlb21ldHJpY09wdGljcyBmcm9tICcuLi8uLi9nZW9tZXRyaWNPcHRpY3MuanMnO1xyXG5pbXBvcnQgVmlzaWJsZVByb3BlcnRpZXMgZnJvbSAnLi9WaXNpYmxlUHJvcGVydGllcy5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgT3B0aWNhbEF4aXNOb2RlIGZyb20gJy4vT3B0aWNhbEF4aXNOb2RlLmpzJztcclxuaW1wb3J0IE9wdGljVmVydGljYWxBeGlzTm9kZSBmcm9tICcuL09wdGljVmVydGljYWxBeGlzTm9kZS5qcyc7XHJcbmltcG9ydCB7IFJheXNUeXBlIH0gZnJvbSAnLi4vbW9kZWwvUmF5c1R5cGUuanMnO1xyXG5pbXBvcnQgRm9jYWxQb2ludE5vZGUgZnJvbSAnLi9Gb2NhbFBvaW50Tm9kZS5qcyc7XHJcbmltcG9ydCBUd29GUG9pbnROb2RlIGZyb20gJy4vVHdvRlBvaW50Tm9kZS5qcyc7XHJcbmltcG9ydCBHT0NvbG9ycyBmcm9tICcuLi9HT0NvbG9ycy5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgR3VpZGVzTm9kZSBmcm9tICcuL0d1aWRlc05vZGUuanMnO1xyXG5pbXBvcnQgQm9vbGVhbklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9Cb29sZWFuSU8uanMnO1xyXG5pbXBvcnQgR09TY2VuZSBmcm9tICcuLi9tb2RlbC9HT1NjZW5lLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IFRvb2xKdW1wUG9pbnQgZnJvbSAnLi4vbW9kZWwvdG9vbHMvVG9vbEp1bXBQb2ludC5qcyc7XHJcbmltcG9ydCBMZW5zIGZyb20gJy4uLy4uL2xlbnMvbW9kZWwvTGVucy5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBDcmVhdGVzIHRoZSBOb2RlIGZvciB0aGUgb3B0aWNcclxuICBjcmVhdGVPcHRpY05vZGU6ICggbW9kZWxWaWV3VHJhbnNmb3JtOiBNb2RlbFZpZXdUcmFuc2Zvcm0yLCBwYXJlbnRUYW5kZW06IFRhbmRlbSApID0+IE5vZGU7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBHT1NjZW5lTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tSZXF1aXJlZDxOb2RlT3B0aW9ucywgJ3RhbmRlbScgfCAndmlzaWJsZVByb3BlcnR5Jz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBhYnN0cmFjdCBjbGFzcyBHT1NjZW5lTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICAvLyAnSnVtcCBwb2ludHMnIGZvciB0aGUgdG9vbHMuIFRoZXNlIGFyZSBpbnRlcmVzdGluZyBwb2ludHMsIHdoZXJlIHlvdSBtaWdodCB3YW50IHRvIHBsYWNlIGEgdG9vbC5cclxuICAvLyBXaGVuIGEgdG9vbCBoYXMgZm9jdXMsICdKJyBob3RrZXkgd2lsbCBjeWNsZSB0aHJvdWdoIHRoZXNlIHBvaW50cywgaW4gb3JkZXIgb2YgYXNjZW5kaW5nIHggY29vcmRpbmF0ZS5cclxuICBwdWJsaWMgYWJzdHJhY3QgcmVhZG9ubHkgdG9vbEp1bXBQb2ludHM6IFRvb2xKdW1wUG9pbnRbXTtcclxuXHJcbiAgcHVibGljIGFic3RyYWN0IHJlYWRvbmx5IHNjZW5lOiBHT1NjZW5lO1xyXG5cclxuICAvLyBKdW1wIHBvaW50cyByZWxhdGVkIHRvIHRoZSBvcHRpYywgY29tbW9uIHRvIGFsbCBzY2VuZXNcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgb3B0aWNKdW1wUG9pbnRzOiBUb29sSnVtcFBvaW50W107XHJcblxyXG4gIC8vIFZhcmlvdXMgcmVuZGVyaW5nIGxheWVycyB3aGVyZSBzdWJjbGFzc2VzIGFyZSBleHBlY3RlZCB0byBhZGQgTm9kZXMuXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IG9wdGljYWxBeGlzRm9yZWdyb3VuZExheWVyOiBOb2RlO1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBvcHRpY2FsT2JqZWN0c0xheWVyOiBOb2RlO1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBvcHRpY2FsSW1hZ2VzTGF5ZXI6IE5vZGU7XHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHJheXNGb3JlZ3JvdW5kTGF5ZXI6IE5vZGU7XHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHJheXNCYWNrZ3JvdW5kTGF5ZXI6IE5vZGU7XHJcblxyXG4gIC8vIFZpc2liaWxpdHkgb2YgdGhpbmdzIHRoYXQgaGF2ZSBsYWJlbHMsIGludGVuZGVkIHRvIGJlIHVzZWQgdG8gY29udHJvbCB0aGUgdmlzaWJpbGl0eSBvZiBhc3NvY2lhdGVkIGxhYmVscy5cclxuICBwdWJsaWMgcmVhZG9ubHkgb3B0aWNOb2RlVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgb3B0aWNhbEF4aXNOb2RlVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGVmdEZvY2FsUG9pbnROb2RlVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgcmlnaHRGb2NhbFBvaW50Tm9kZVZpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHVibGljIHJlYWRvbmx5IGxlZnQyRlBvaW50Tm9kZVZpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHVibGljIHJlYWRvbmx5IHJpZ2h0MkZQb2ludE5vZGVWaXNpYmxlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gc2NlbmUgLSBtb2RlbCBlbGVtZW50XHJcbiAgICogQHBhcmFtIHZpc2libGVQcm9wZXJ0aWVzXHJcbiAgICogQHBhcmFtIG1vZGVsVmlld1RyYW5zZm9ybVxyXG4gICAqIEBwYXJhbSBtb2RlbFZpc2libGVCb3VuZHNQcm9wZXJ0eSAtIFNjcmVlblZpZXcncyB2aXNpYmxlQm91bmRzIGluIHRoZSBtb2RlbCBjb29yZGluYXRlIGZyYW1lLCB3aXRoIHRoZSB6b29tIHRyYW5zZm9ybSBhcHBsaWVkXHJcbiAgICogQHBhcmFtIHNjZW5lQm91bmRzUHJvcGVydHkgLSBib3VuZHMgZm9yIHRoZSBzY2VuZSwgaW4gbW9kZWwgY29vcmRpbmF0ZXNcclxuICAgKiBAcGFyYW0gcmF5c1R5cGVQcm9wZXJ0eSAtIHJlcHJlc2VudGF0aW9uIHVzZWQgZm9yIHJheXNcclxuICAgKiBAcGFyYW0gcHJvdmlkZWRPcHRpb25zXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKCBzY2VuZTogR09TY2VuZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVQcm9wZXJ0aWVzOiBWaXNpYmxlUHJvcGVydGllcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlzaWJsZUJvdW5kc1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxCb3VuZHMyPixcclxuICAgICAgICAgICAgICAgICAgICAgICAgIHNjZW5lQm91bmRzUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEJvdW5kczI+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgcmF5c1R5cGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8UmF5c1R5cGU+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRPcHRpb25zOiBHT1NjZW5lTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxHT1NjZW5lTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBOb2RlT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gTm9kZU9wdGlvbnNcclxuICAgICAgdmlzaWJsZVByb3BlcnR5T3B0aW9uczogeyBwaGV0aW9SZWFkT25seTogdHJ1ZSB9XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IG9wdGljTm9kZSA9IG9wdGlvbnMuY3JlYXRlT3B0aWNOb2RlKCBtb2RlbFZpZXdUcmFuc2Zvcm0sIG9wdGlvbnMudGFuZGVtICk7XHJcblxyXG4gICAgY29uc3Qgb3B0aWNhbEF4aXNOb2RlID0gbmV3IE9wdGljYWxBeGlzTm9kZShcclxuICAgICAgc2NlbmUub3B0aWMucG9zaXRpb25Qcm9wZXJ0eSxcclxuICAgICAgbW9kZWxWaXNpYmxlQm91bmRzUHJvcGVydHksXHJcbiAgICAgIG1vZGVsVmlld1RyYW5zZm9ybSwge1xyXG4gICAgICAgIHZpc2libGVQcm9wZXJ0eTogdmlzaWJsZVByb3BlcnRpZXMub3B0aWNhbEF4aXNWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdvcHRpY2FsQXhpc05vZGUnIClcclxuICAgICAgfSApO1xyXG5cclxuICAgIGNvbnN0IG9wdGljVmVydGljYWxBeGlzTm9kZSA9IG5ldyBPcHRpY1ZlcnRpY2FsQXhpc05vZGUoIHNjZW5lLm9wdGljLCByYXlzVHlwZVByb3BlcnR5LCBtb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEEgbm90ZSBhYm91dCB2aXNpYmlsaXR5IG9mIGZvY2FsIHBvaW50cyAoRiBhbmQgMkYpLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2dlb21ldHJpYy1vcHRpY3MvaXNzdWVzLzQ1Ny5cclxuICAgICAqIEEgbGVucyBoYXMgMiBmb2NhbCBwb2ludHMuIEJ1dCBzaW5jZSBhIG1pcnJvciBvbmx5IGhhcyBvbmUgc3VyZmFjZSwgaXQgb25seSBoYXMgb25lIGZvY2FsIHBvaW50LiBVbmZvcnR1bmF0ZWx5LFxyXG4gICAgICogb3VyIE9wdGljIGJhc2UgY2xhc3MgaXMgdmVyeSBkZXBlbmRlbnQgb24gaGF2aW5nIHR3byBGIGFuZCAyRiBwb2ludHMuIFNvIHJhdGhlciB0aGFuIG1vZGlmeSB0aGUgbW9kZWwsIHdlIGRlY2lkZWRcclxuICAgICAqIHRvIGNvbnRyb2wgdGhlIHZpc2liaWxpdHkgb2YgRiBhbmQgMkYgaW4gdGhlIHZpZXcgLSBzZWUgJ3Zpc2libGVQcm9wZXJ0eTogbmV3IERlcml2ZWRQcm9wZXJ0eSguLi4pJyBiZWxvdy5cclxuICAgICAqIEZvciBhIGxlbnMsIGFsbCBGIGFuZCAyRiBwb2ludHMgYXJlIG1hZGUgdmlzaWJsZS5cclxuICAgICAqIEZvciBhIGNvbmNhdmUgbWlycm9yLCBGIGFuZCAyRiBhcmUgb24gdGhlIGxlZnQsIHNvIG9ubHkgbGVmdEZvY2FsUG9pbnROb2RlIGFuZCBsZWZ0MkZQb2ludE5vZGUgYXJlIG1hZGUgdmlzaWJsZS5cclxuICAgICAqIEZvciBhIGNvbnZleCBtaXJyb3IsIEYgYW5kIDJGIGFyZSBvbiB0aGUgcmlnaHQsIHNvIG9ubHkgcmlnaHRGb2NhbFBvaW50Tm9kZSBhbmQgcmlnaHQyRlBvaW50Tm9kZSBhcmUgdmlzaWJsZS5cclxuICAgICAqIEZvciBhIGZsYXQgbWlycm9yLCBGIGFuZCAyRiBhcmUgYXQgaW5maW5pdHksIHNvIGFsbCBGIGFuZCAyRiBwb2ludHMgYXJlIG1hZGUgaW52aXNpYmxlLlxyXG4gICAgICovXHJcblxyXG4gICAgICAvLyBGb2NhbCBQb2ludHMgKEYpXHJcbiAgICBjb25zdCBmb2NhbFBvaW50c1RhbmRlbSA9IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2ZvY2FsUG9pbnRzJyApO1xyXG4gICAgY29uc3QgbGVmdEZvY2FsUG9pbnROb2RlVGFuZGVtID0gZm9jYWxQb2ludHNUYW5kZW0uY3JlYXRlVGFuZGVtKCAnbGVmdEZvY2FsUG9pbnROb2RlJyApO1xyXG4gICAgY29uc3QgbGVmdEZvY2FsUG9pbnROb2RlID0gbmV3IEZvY2FsUG9pbnROb2RlKCBzY2VuZS5vcHRpYy5sZWZ0Rm9jYWxQb2ludFByb3BlcnR5LCBtb2RlbFZpZXdUcmFuc2Zvcm0sIHtcclxuICAgICAgdmlzaWJsZVByb3BlcnR5OiAoIHNjZW5lLm9wdGljIGluc3RhbmNlb2YgTGVucyApID9cclxuICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlUHJvcGVydGllcy5mb2NhbFBvaW50c1Zpc2libGVQcm9wZXJ0eSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgICAgICAgICAgICAgICAgICAgIFsgdmlzaWJsZVByb3BlcnRpZXMuZm9jYWxQb2ludHNWaXNpYmxlUHJvcGVydHksIHNjZW5lLm9wdGljLm9wdGljU3VyZmFjZVR5cGVQcm9wZXJ0eSBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgKCBmb2NhbFBvaW50c1Zpc2libGUsIHN1cmZhY2VUeXBlICkgPT4gZm9jYWxQb2ludHNWaXNpYmxlICYmIHN1cmZhY2VUeXBlID09PSAnY29uY2F2ZScsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFuZGVtOiBsZWZ0Rm9jYWxQb2ludE5vZGVUYW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IEJvb2xlYW5JT1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgfSApLFxyXG4gICAgICB0YW5kZW06IGxlZnRGb2NhbFBvaW50Tm9kZVRhbmRlbVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHJpZ2h0Rm9jYWxQb2ludE5vZGVUYW5kZW0gPSBmb2NhbFBvaW50c1RhbmRlbS5jcmVhdGVUYW5kZW0oICdyaWdodEZvY2FsUG9pbnROb2RlJyApO1xyXG4gICAgY29uc3QgcmlnaHRGb2NhbFBvaW50Tm9kZSA9IG5ldyBGb2NhbFBvaW50Tm9kZSggc2NlbmUub3B0aWMucmlnaHRGb2NhbFBvaW50UHJvcGVydHksIG1vZGVsVmlld1RyYW5zZm9ybSwge1xyXG4gICAgICB2aXNpYmxlUHJvcGVydHk6ICggc2NlbmUub3B0aWMgaW5zdGFuY2VvZiBMZW5zICkgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVQcm9wZXJ0aWVzLmZvY2FsUG9pbnRzVmlzaWJsZVByb3BlcnR5IDpcclxuICAgICAgICAgICAgICAgICAgICAgICBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgWyB2aXNpYmxlUHJvcGVydGllcy5mb2NhbFBvaW50c1Zpc2libGVQcm9wZXJ0eSwgc2NlbmUub3B0aWMub3B0aWNTdXJmYWNlVHlwZVByb3BlcnR5IF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAoIGZvY2FsUG9pbnRzVmlzaWJsZSwgc3VyZmFjZVR5cGUgKSA9PiBmb2NhbFBvaW50c1Zpc2libGUgJiYgc3VyZmFjZVR5cGUgPT09ICdjb252ZXgnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhbmRlbTogcmlnaHRGb2NhbFBvaW50Tm9kZVRhbmRlbS5jcmVhdGVUYW5kZW0oICd2aXNpYmxlUHJvcGVydHknICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICB9ICksXHJcbiAgICAgIHRhbmRlbTogcmlnaHRGb2NhbFBvaW50Tm9kZVRhbmRlbVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIDJGIFBvaW50c1xyXG4gICAgY29uc3QgdHdvRlBvaW50VGFuZGVtID0gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndHdvRlBvaW50cycgKTtcclxuICAgIGNvbnN0IGxlZnQyRlBvaW50Tm9kZVRhbmRlbSA9IHR3b0ZQb2ludFRhbmRlbS5jcmVhdGVUYW5kZW0oICdsZWZ0MkZQb2ludE5vZGUnICk7XHJcbiAgICBjb25zdCBsZWZ0MkZQb2ludE5vZGUgPSBuZXcgVHdvRlBvaW50Tm9kZSggc2NlbmUub3B0aWMubGVmdDJGUHJvcGVydHksIG1vZGVsVmlld1RyYW5zZm9ybSwge1xyXG4gICAgICB2aXNpYmxlUHJvcGVydHk6ICggc2NlbmUub3B0aWMgaW5zdGFuY2VvZiBMZW5zICkgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVQcm9wZXJ0aWVzLnR3b0ZQb2ludHNWaXNpYmxlUHJvcGVydHkgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgIG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBbIHZpc2libGVQcm9wZXJ0aWVzLnR3b0ZQb2ludHNWaXNpYmxlUHJvcGVydHksIHNjZW5lLm9wdGljLm9wdGljU3VyZmFjZVR5cGVQcm9wZXJ0eSBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgKCB0d29GUG9pbnRzVmlzaWJsZSwgc3VyZmFjZVR5cGUgKSA9PiB0d29GUG9pbnRzVmlzaWJsZSAmJiBzdXJmYWNlVHlwZSA9PT0gJ2NvbmNhdmUnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhbmRlbTogbGVmdDJGUG9pbnROb2RlVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Zpc2libGVQcm9wZXJ0eScgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcGhldGlvVmFsdWVUeXBlOiBCb29sZWFuSU9cclxuICAgICAgICAgICAgICAgICAgICAgICAgIH0gKSxcclxuICAgICAgdGFuZGVtOiBsZWZ0MkZQb2ludE5vZGVUYW5kZW1cclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCByaWdodDJGUG9pbnROb2RlVGFuZGVtID0gdHdvRlBvaW50VGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3JpZ2h0MkZQb2ludE5vZGUnICk7XHJcbiAgICBjb25zdCByaWdodDJGUG9pbnROb2RlID0gbmV3IFR3b0ZQb2ludE5vZGUoIHNjZW5lLm9wdGljLnJpZ2h0MkZQcm9wZXJ0eSwgbW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgIHZpc2libGVQcm9wZXJ0eTogKCBzY2VuZS5vcHRpYyBpbnN0YW5jZW9mIExlbnMgKSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZVByb3BlcnRpZXMudHdvRlBvaW50c1Zpc2libGVQcm9wZXJ0eSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgICAgICAgICAgICAgICAgICAgIFsgdmlzaWJsZVByb3BlcnRpZXMudHdvRlBvaW50c1Zpc2libGVQcm9wZXJ0eSwgc2NlbmUub3B0aWMub3B0aWNTdXJmYWNlVHlwZVByb3BlcnR5IF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAoIHR3b0ZQb2ludHNWaXNpYmxlLCBzdXJmYWNlVHlwZSApID0+IHR3b0ZQb2ludHNWaXNpYmxlICYmIHN1cmZhY2VUeXBlID09PSAnY29udmV4Jywge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0YW5kZW06IHJpZ2h0MkZQb2ludE5vZGVUYW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IEJvb2xlYW5JT1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgfSApLFxyXG4gICAgICB0YW5kZW06IHJpZ2h0MkZQb2ludE5vZGVUYW5kZW1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBMYXllcnMgZm9yIHRoaW5ncyB0aGF0IG1heSBiZSBhZGRlZCBieSBzdWJjbGFzc2VzXHJcbiAgICB0aGlzLm9wdGljYWxBeGlzRm9yZWdyb3VuZExheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMub3B0aWNhbE9iamVjdHNMYXllciA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLm9wdGljYWxJbWFnZXNMYXllciA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLnJheXNGb3JlZ3JvdW5kTGF5ZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5yYXlzQmFja2dyb3VuZExheWVyID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICBjb25zdCBndWlkZXNMYXllciA9IG5ldyBOb2RlKCk7XHJcblxyXG4gICAgaWYgKCBzY2VuZS5ndWlkZXMxICkge1xyXG4gICAgICBjb25zdCBndWlkZXMxVGFuZGVtID0gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZ3VpZGVzMU5vZGUnICk7XHJcbiAgICAgIGNvbnN0IGd1aWRlczFOb2RlID0gbmV3IEd1aWRlc05vZGUoIHNjZW5lLmd1aWRlczEsIEdPQ29sb3JzLmd1aWRlQXJtMUZpbGxQcm9wZXJ0eSwgbW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgICAgdmlzaWJsZVByb3BlcnR5OiB2aXNpYmxlUHJvcGVydGllcy5ndWlkZXNWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgICAgdGFuZGVtOiBndWlkZXMxVGFuZGVtLFxyXG4gICAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdndWlkZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBmaXJzdCBvYmplY3QnXHJcbiAgICAgIH0gKTtcclxuICAgICAgZ3VpZGVzTGF5ZXIuYWRkQ2hpbGQoIGd1aWRlczFOb2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCBzY2VuZS5ndWlkZXMyICkge1xyXG4gICAgICBjb25zdCBndWlkZXMyVGFuZGVtID0gb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZ3VpZGVzMk5vZGUnICk7XHJcbiAgICAgIGNvbnN0IGd1aWRlczJOb2RlID0gbmV3IEd1aWRlc05vZGUoIHNjZW5lLmd1aWRlczIsIEdPQ29sb3JzLmd1aWRlQXJtMkZpbGxQcm9wZXJ0eSwgbW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgICAgdmlzaWJsZVByb3BlcnR5OiBEZXJpdmVkUHJvcGVydHkuYW5kKCBbXHJcbiAgICAgICAgICB2aXNpYmxlUHJvcGVydGllcy5ndWlkZXNWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgICAgICB2aXNpYmxlUHJvcGVydGllcy5zZWNvbmRQb2ludFZpc2libGVQcm9wZXJ0eVxyXG4gICAgICAgIF0sIHtcclxuICAgICAgICAgIHRhbmRlbTogZ3VpZGVzMlRhbmRlbS5jcmVhdGVUYW5kZW0oICd2aXNpYmxlUHJvcGVydHknICksXHJcbiAgICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IEJvb2xlYW5JT1xyXG4gICAgICAgIH0gKSxcclxuICAgICAgICB0YW5kZW06IGd1aWRlczJUYW5kZW0sXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ2d1aWRlcyBhc3NvY2lhdGVkIHdpdGggdGhlIHNlY29uZCBvYmplY3QnXHJcbiAgICAgIH0gKTtcclxuICAgICAgZ3VpZGVzTGF5ZXIuYWRkQ2hpbGQoIGd1aWRlczJOb2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVuZGVyaW5nIG9yZGVyIGlzIFZFUlkgaW1wb3J0YW50IGhlcmUuXHJcbiAgICB0aGlzLmNoaWxkcmVuID0gW1xyXG4gICAgICBvcHRpY2FsQXhpc05vZGUsXHJcbiAgICAgIHRoaXMub3B0aWNhbE9iamVjdHNMYXllcixcclxuICAgICAgdGhpcy5yYXlzQmFja2dyb3VuZExheWVyLFxyXG4gICAgICB0aGlzLm9wdGljYWxJbWFnZXNMYXllcixcclxuICAgICAgdGhpcy5vcHRpY2FsQXhpc0ZvcmVncm91bmRMYXllcixcclxuICAgICAgb3B0aWNOb2RlLFxyXG4gICAgICBvcHRpY1ZlcnRpY2FsQXhpc05vZGUsXHJcbiAgICAgIGxlZnRGb2NhbFBvaW50Tm9kZSxcclxuICAgICAgcmlnaHRGb2NhbFBvaW50Tm9kZSxcclxuICAgICAgbGVmdDJGUG9pbnROb2RlLFxyXG4gICAgICByaWdodDJGUG9pbnROb2RlLFxyXG4gICAgICB0aGlzLnJheXNGb3JlZ3JvdW5kTGF5ZXIsXHJcbiAgICAgIGd1aWRlc0xheWVyXHJcbiAgICBdO1xyXG5cclxuICAgIHRoaXMuYWRkTGlua2VkRWxlbWVudCggc2NlbmUsIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oIHNjZW5lLnRhbmRlbS5uYW1lIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm9wdGljSnVtcFBvaW50cyA9IFtcclxuICAgICAgbmV3IFRvb2xKdW1wUG9pbnQoIHNjZW5lLm9wdGljLnBvc2l0aW9uUHJvcGVydHksIG9wdGljTm9kZS52aXNpYmxlUHJvcGVydHkgKSxcclxuICAgICAgbmV3IFRvb2xKdW1wUG9pbnQoIHNjZW5lLm9wdGljLmxlZnRGb2NhbFBvaW50UHJvcGVydHksIGxlZnRGb2NhbFBvaW50Tm9kZS52aXNpYmxlUHJvcGVydHkgKSxcclxuICAgICAgbmV3IFRvb2xKdW1wUG9pbnQoIHNjZW5lLm9wdGljLnJpZ2h0Rm9jYWxQb2ludFByb3BlcnR5LCByaWdodEZvY2FsUG9pbnROb2RlLnZpc2libGVQcm9wZXJ0eSApLFxyXG4gICAgICBuZXcgVG9vbEp1bXBQb2ludCggc2NlbmUub3B0aWMubGVmdDJGUHJvcGVydHksIGxlZnQyRlBvaW50Tm9kZS52aXNpYmxlUHJvcGVydHkgKSxcclxuICAgICAgbmV3IFRvb2xKdW1wUG9pbnQoIHNjZW5lLm9wdGljLnJpZ2h0MkZQcm9wZXJ0eSwgcmlnaHQyRlBvaW50Tm9kZS52aXNpYmxlUHJvcGVydHkgKVxyXG4gICAgXTtcclxuXHJcbiAgICAvLyBWaXNpYmlsaXR5IGZvciBhc3NvY2lhdGVzIGxhYmVsc1xyXG4gICAgdGhpcy5vcHRpY05vZGVWaXNpYmxlUHJvcGVydHkgPSBvcHRpY05vZGUudmlzaWJsZVByb3BlcnR5O1xyXG4gICAgdGhpcy5vcHRpY2FsQXhpc05vZGVWaXNpYmxlUHJvcGVydHkgPSBvcHRpY2FsQXhpc05vZGUudmlzaWJsZVByb3BlcnR5O1xyXG4gICAgdGhpcy5sZWZ0Rm9jYWxQb2ludE5vZGVWaXNpYmxlUHJvcGVydHkgPSBsZWZ0Rm9jYWxQb2ludE5vZGUudmlzaWJsZVByb3BlcnR5O1xyXG4gICAgdGhpcy5yaWdodEZvY2FsUG9pbnROb2RlVmlzaWJsZVByb3BlcnR5ID0gcmlnaHRGb2NhbFBvaW50Tm9kZS52aXNpYmxlUHJvcGVydHk7XHJcbiAgICB0aGlzLmxlZnQyRlBvaW50Tm9kZVZpc2libGVQcm9wZXJ0eSA9IGxlZnQyRlBvaW50Tm9kZS52aXNpYmxlUHJvcGVydHk7XHJcbiAgICB0aGlzLnJpZ2h0MkZQb2ludE5vZGVWaXNpYmxlUHJvcGVydHkgPSByaWdodDJGUG9pbnROb2RlLnZpc2libGVQcm9wZXJ0eTtcclxuICB9XHJcbn1cclxuXHJcbmdlb21ldHJpY09wdGljcy5yZWdpc3RlciggJ0dPU2NlbmVOb2RlJywgR09TY2VuZU5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFHQSxTQUFTQSxJQUFJLFFBQXFCLG1DQUFtQztBQUNyRSxPQUFPQyxlQUFlLE1BQU0sMEJBQTBCO0FBSXRELE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFDbEQsT0FBT0MscUJBQXFCLE1BQU0sNEJBQTRCO0FBRTlELE9BQU9DLGNBQWMsTUFBTSxxQkFBcUI7QUFDaEQsT0FBT0MsYUFBYSxNQUFNLG9CQUFvQjtBQUM5QyxPQUFPQyxRQUFRLE1BQU0sZ0JBQWdCO0FBRXJDLE9BQU9DLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsVUFBVSxNQUFNLGlCQUFpQjtBQUN4QyxPQUFPQyxTQUFTLE1BQU0sMENBQTBDO0FBRWhFLE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFFN0QsT0FBT0MsYUFBYSxNQUFNLGlDQUFpQztBQUMzRCxPQUFPQyxJQUFJLE1BQU0sMEJBQTBCO0FBVTNDLGVBQWUsTUFBZUMsV0FBVyxTQUFTYixJQUFJLENBQUM7RUFFckQ7RUFDQTs7RUFLQTs7RUFHQTs7RUFPQTs7RUFRQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDWWMsV0FBV0EsQ0FBRUMsS0FBYyxFQUNkQyxpQkFBb0MsRUFDcENDLGtCQUF1QyxFQUN2Q0MsMEJBQXNELEVBQ3REQyxtQkFBK0MsRUFDL0NDLGdCQUE2QyxFQUM3Q0MsZUFBbUMsRUFBRztJQUUzRCxNQUFNQyxPQUFPLEdBQUdaLFNBQVMsQ0FBK0MsQ0FBQyxDQUFFO01BRXpFO01BQ0FhLHNCQUFzQixFQUFFO1FBQUVDLGNBQWMsRUFBRTtNQUFLO0lBQ2pELENBQUMsRUFBRUgs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