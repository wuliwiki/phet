// Copyright 2021-2022, University of Colorado Boulder

/**
 * OpticalAxisForegroundNode is a subclass of OpticalAxisNode that (using clipArea) shows only the parts of
 * OpticalAxisNode that are in front of framed objects and their associated images. It is intended to be used in
 * FramedSceneNode, and layered in front of framed objects and images.
 *
 * Note that because the optical axis is dashed, we need to use clipArea instead of just drawing the relevant
 * line segments. If we were to draw line segments, the dash pattern would appear to move, and would not line
 * up with the (background) axis drawn by OpticalAxisNode.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import { Shape } from '../../../../kite/js/imports.js';
import geometricOptics from '../../geometricOptics.js';
import OpticalAxisNode from './OpticalAxisNode.js';
import GOQueryParameters from '../GOQueryParameters.js';
import { Path } from '../../../../scenery/js/imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import GOColors from '../GOColors.js';
export default class OpticalAxisForegroundNode extends OpticalAxisNode {
  /**
   * @param opticPositionProperty - position of the optic
   * @param modelVisibleBoundsProperty - ScreenView's visibleBounds in the model coordinate frame, with the zoom transform applied
   * @param modelViewTransform
   * @param framedObjectPositionProperty
   * @param framedObjectNode
   * @param framedImagePositionProperty
   * @param framedImageNode
   * @param lightRaysProcessedEmitter - fires when animation of rays has completed
   * @param providedOptions
   */
  constructor(opticPositionProperty, modelVisibleBoundsProperty, modelViewTransform, framedObjectPositionProperty, framedObjectNode, framedImagePositionProperty, framedImageNode, lightRaysProcessedEmitter, providedOptions) {
    const options = optionize()({
      // OpticalAxisNodeOptions
      stroke: GOQueryParameters.debugOpticalAxis ? 'red' : GOColors.opticalAxisStrokeProperty
    }, providedOptions);

    // create optical axis line, with arbitrary length values.
    super(opticPositionProperty, modelVisibleBoundsProperty, modelViewTransform, options);

    // Stroke the clipArea in red.
    let clipAreaNode;
    if (GOQueryParameters.debugOpticalAxis) {
      clipAreaNode = new Path(null, {
        stroke: 'red'
      });
      this.addChild(clipAreaNode);
    }

    // Update the clipArea, to make the axis look like it passes through things.
    // This shows only the parts of this Node that are in the foreground, i.e. not occluded by other things.
    // While it may seem a bit odd to be listening to the light rays, this is an optimization. When computation
    // of the light rays has completed, we know that other things are in their final positions, and therefore
    // don't end up computing intermediate states as things move around.
    // Run with ?debugOpticalAxis to see the clipArea rendered as a rectangle.
    const updateClipArea = () => {
      let clipArea; // in view coordinates

      const viewVisibleBounds = modelViewTransform.modelToViewBounds(modelVisibleBoundsProperty.value);
      const minY = viewVisibleBounds.minY;
      const maxY = viewVisibleBounds.maxY;
      const clipHeight = maxY - minY;
      const opticX = modelViewTransform.modelToViewX(opticPositionProperty.value.x);
      const framedObjectX = modelViewTransform.modelToViewX(framedObjectPositionProperty.value.x);
      const framedImageX = modelViewTransform.modelToViewX(framedImagePositionProperty.value.x);
      if (framedImageX > opticX) {
        // If the Image is to the right of the optic, clipArea is 1 rectangle, between the Object and Image.
        clipArea = Shape.rectangle(framedObjectX, minY, framedImageX - framedObjectX, clipHeight);
      } else {
        // If the Image is to the left of the optic, clipArea requires 2 rectangles.

        // Determine the relative position of the Object and Image.
        const imageOnRight = framedImageX > framedObjectX;

        // The first rectangle is between the thing on the right and the optic.
        const x1 = imageOnRight ? framedImageX : framedObjectX;
        const clipWidth1 = opticX - x1;

        // The second rectangle is between the thing on the left and the left edge of the picture frame on the right.
        const x2 = imageOnRight ? framedObjectX : framedImageX;
        const halfFrameWidth = (imageOnRight ? framedImageNode.bounds.width : framedObjectNode.visibleBounds.width) / 2;
        const clipWidth2 = x1 - x2 - halfFrameWidth;
        clipArea = new Shape().rect(x1, minY, clipWidth1, clipHeight).rect(x2, minY, clipWidth2, clipHeight);
      }
      this.clipArea = clipArea;
      if (clipAreaNode) {
        clipAreaNode.shape = clipArea;
      }
    };
    lightRaysProcessedEmitter.addListener(() => {
      if (this.visible) {
        updateClipArea();
      }
    });
    this.visibleProperty.link(visible => {
      if (visible) {
        updateClipArea();
      }
    });
  }
}
geometricOptics.register('OpticalAxisForegroundNode', OpticalAxisForegroundNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaGFwZSIsImdlb21ldHJpY09wdGljcyIsIk9wdGljYWxBeGlzTm9kZSIsIkdPUXVlcnlQYXJhbWV0ZXJzIiwiUGF0aCIsIm9wdGlvbml6ZSIsIkdPQ29sb3JzIiwiT3B0aWNhbEF4aXNGb3JlZ3JvdW5kTm9kZSIsImNvbnN0cnVjdG9yIiwib3B0aWNQb3NpdGlvblByb3BlcnR5IiwibW9kZWxWaXNpYmxlQm91bmRzUHJvcGVydHkiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJmcmFtZWRPYmplY3RQb3NpdGlvblByb3BlcnR5IiwiZnJhbWVkT2JqZWN0Tm9kZSIsImZyYW1lZEltYWdlUG9zaXRpb25Qcm9wZXJ0eSIsImZyYW1lZEltYWdlTm9kZSIsImxpZ2h0UmF5c1Byb2Nlc3NlZEVtaXR0ZXIiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwic3Ryb2tlIiwiZGVidWdPcHRpY2FsQXhpcyIsIm9wdGljYWxBeGlzU3Ryb2tlUHJvcGVydHkiLCJjbGlwQXJlYU5vZGUiLCJhZGRDaGlsZCIsInVwZGF0ZUNsaXBBcmVhIiwiY2xpcEFyZWEiLCJ2aWV3VmlzaWJsZUJvdW5kcyIsIm1vZGVsVG9WaWV3Qm91bmRzIiwidmFsdWUiLCJtaW5ZIiwibWF4WSIsImNsaXBIZWlnaHQiLCJvcHRpY1giLCJtb2RlbFRvVmlld1giLCJ4IiwiZnJhbWVkT2JqZWN0WCIsImZyYW1lZEltYWdlWCIsInJlY3RhbmdsZSIsImltYWdlT25SaWdodCIsIngxIiwiY2xpcFdpZHRoMSIsIngyIiwiaGFsZkZyYW1lV2lkdGgiLCJib3VuZHMiLCJ3aWR0aCIsInZpc2libGVCb3VuZHMiLCJjbGlwV2lkdGgyIiwicmVjdCIsInNoYXBlIiwiYWRkTGlzdGVuZXIiLCJ2aXNpYmxlIiwidmlzaWJsZVByb3BlcnR5IiwibGluayIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiT3B0aWNhbEF4aXNGb3JlZ3JvdW5kTm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBPcHRpY2FsQXhpc0ZvcmVncm91bmROb2RlIGlzIGEgc3ViY2xhc3Mgb2YgT3B0aWNhbEF4aXNOb2RlIHRoYXQgKHVzaW5nIGNsaXBBcmVhKSBzaG93cyBvbmx5IHRoZSBwYXJ0cyBvZlxyXG4gKiBPcHRpY2FsQXhpc05vZGUgdGhhdCBhcmUgaW4gZnJvbnQgb2YgZnJhbWVkIG9iamVjdHMgYW5kIHRoZWlyIGFzc29jaWF0ZWQgaW1hZ2VzLiBJdCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIGluXHJcbiAqIEZyYW1lZFNjZW5lTm9kZSwgYW5kIGxheWVyZWQgaW4gZnJvbnQgb2YgZnJhbWVkIG9iamVjdHMgYW5kIGltYWdlcy5cclxuICpcclxuICogTm90ZSB0aGF0IGJlY2F1c2UgdGhlIG9wdGljYWwgYXhpcyBpcyBkYXNoZWQsIHdlIG5lZWQgdG8gdXNlIGNsaXBBcmVhIGluc3RlYWQgb2YganVzdCBkcmF3aW5nIHRoZSByZWxldmFudFxyXG4gKiBsaW5lIHNlZ21lbnRzLiBJZiB3ZSB3ZXJlIHRvIGRyYXcgbGluZSBzZWdtZW50cywgdGhlIGRhc2ggcGF0dGVybiB3b3VsZCBhcHBlYXIgdG8gbW92ZSwgYW5kIHdvdWxkIG5vdCBsaW5lXHJcbiAqIHVwIHdpdGggdGhlIChiYWNrZ3JvdW5kKSBheGlzIGRyYXduIGJ5IE9wdGljYWxBeGlzTm9kZS5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBNb2RlbFZpZXdUcmFuc2Zvcm0yIGZyb20gJy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdmlldy9Nb2RlbFZpZXdUcmFuc2Zvcm0yLmpzJztcclxuaW1wb3J0IGdlb21ldHJpY09wdGljcyBmcm9tICcuLi8uLi9nZW9tZXRyaWNPcHRpY3MuanMnO1xyXG5pbXBvcnQgT3B0aWNhbEF4aXNOb2RlLCB7IE9wdGljYWxBeGlzTm9kZU9wdGlvbnMgfSBmcm9tICcuL09wdGljYWxBeGlzTm9kZS5qcyc7XHJcbmltcG9ydCBHT1F1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi9HT1F1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIFBhdGggfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IEVtcHR5U2VsZk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IEdPQ29sb3JzIGZyb20gJy4uL0dPQ29sb3JzLmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIE9wdGljYWxBeGlzRm9yZWdyb3VuZE5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBPcHRpY2FsQXhpc05vZGVPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3B0aWNhbEF4aXNGb3JlZ3JvdW5kTm9kZSBleHRlbmRzIE9wdGljYWxBeGlzTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBvcHRpY1Bvc2l0aW9uUHJvcGVydHkgLSBwb3NpdGlvbiBvZiB0aGUgb3B0aWNcclxuICAgKiBAcGFyYW0gbW9kZWxWaXNpYmxlQm91bmRzUHJvcGVydHkgLSBTY3JlZW5WaWV3J3MgdmlzaWJsZUJvdW5kcyBpbiB0aGUgbW9kZWwgY29vcmRpbmF0ZSBmcmFtZSwgd2l0aCB0aGUgem9vbSB0cmFuc2Zvcm0gYXBwbGllZFxyXG4gICAqIEBwYXJhbSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0gZnJhbWVkT2JqZWN0UG9zaXRpb25Qcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBmcmFtZWRPYmplY3ROb2RlXHJcbiAgICogQHBhcmFtIGZyYW1lZEltYWdlUG9zaXRpb25Qcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBmcmFtZWRJbWFnZU5vZGVcclxuICAgKiBAcGFyYW0gbGlnaHRSYXlzUHJvY2Vzc2VkRW1pdHRlciAtIGZpcmVzIHdoZW4gYW5pbWF0aW9uIG9mIHJheXMgaGFzIGNvbXBsZXRlZFxyXG4gICAqIEBwYXJhbSBwcm92aWRlZE9wdGlvbnNcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIG9wdGljUG9zaXRpb25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8VmVjdG9yMj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpc2libGVCb3VuZHNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Qm91bmRzMj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBmcmFtZWRPYmplY3RQb3NpdGlvblByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxWZWN0b3IyPixcclxuICAgICAgICAgICAgICAgICAgICAgIGZyYW1lZE9iamVjdE5vZGU6IE5vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICBmcmFtZWRJbWFnZVBvc2l0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFZlY3RvcjI+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgZnJhbWVkSW1hZ2VOb2RlOiBOb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgbGlnaHRSYXlzUHJvY2Vzc2VkRW1pdHRlcjogVEVtaXR0ZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IE9wdGljYWxBeGlzRm9yZWdyb3VuZE5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8T3B0aWNhbEF4aXNGb3JlZ3JvdW5kTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBPcHRpY2FsQXhpc05vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBPcHRpY2FsQXhpc05vZGVPcHRpb25zXHJcbiAgICAgIHN0cm9rZTogKCBHT1F1ZXJ5UGFyYW1ldGVycy5kZWJ1Z09wdGljYWxBeGlzICkgPyAncmVkJyA6IEdPQ29sb3JzLm9wdGljYWxBeGlzU3Ryb2tlUHJvcGVydHlcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIC8vIGNyZWF0ZSBvcHRpY2FsIGF4aXMgbGluZSwgd2l0aCBhcmJpdHJhcnkgbGVuZ3RoIHZhbHVlcy5cclxuICAgIHN1cGVyKCBvcHRpY1Bvc2l0aW9uUHJvcGVydHksIG1vZGVsVmlzaWJsZUJvdW5kc1Byb3BlcnR5LCBtb2RlbFZpZXdUcmFuc2Zvcm0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBTdHJva2UgdGhlIGNsaXBBcmVhIGluIHJlZC5cclxuICAgIGxldCBjbGlwQXJlYU5vZGU6IFBhdGg7XHJcbiAgICBpZiAoIEdPUXVlcnlQYXJhbWV0ZXJzLmRlYnVnT3B0aWNhbEF4aXMgKSB7XHJcbiAgICAgIGNsaXBBcmVhTm9kZSA9IG5ldyBQYXRoKCBudWxsLCB7XHJcbiAgICAgICAgc3Ryb2tlOiAncmVkJ1xyXG4gICAgICB9ICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIGNsaXBBcmVhTm9kZSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgY2xpcEFyZWEsIHRvIG1ha2UgdGhlIGF4aXMgbG9vayBsaWtlIGl0IHBhc3NlcyB0aHJvdWdoIHRoaW5ncy5cclxuICAgIC8vIFRoaXMgc2hvd3Mgb25seSB0aGUgcGFydHMgb2YgdGhpcyBOb2RlIHRoYXQgYXJlIGluIHRoZSBmb3JlZ3JvdW5kLCBpLmUuIG5vdCBvY2NsdWRlZCBieSBvdGhlciB0aGluZ3MuXHJcbiAgICAvLyBXaGlsZSBpdCBtYXkgc2VlbSBhIGJpdCBvZGQgdG8gYmUgbGlzdGVuaW5nIHRvIHRoZSBsaWdodCByYXlzLCB0aGlzIGlzIGFuIG9wdGltaXphdGlvbi4gV2hlbiBjb21wdXRhdGlvblxyXG4gICAgLy8gb2YgdGhlIGxpZ2h0IHJheXMgaGFzIGNvbXBsZXRlZCwgd2Uga25vdyB0aGF0IG90aGVyIHRoaW5ncyBhcmUgaW4gdGhlaXIgZmluYWwgcG9zaXRpb25zLCBhbmQgdGhlcmVmb3JlXHJcbiAgICAvLyBkb24ndCBlbmQgdXAgY29tcHV0aW5nIGludGVybWVkaWF0ZSBzdGF0ZXMgYXMgdGhpbmdzIG1vdmUgYXJvdW5kLlxyXG4gICAgLy8gUnVuIHdpdGggP2RlYnVnT3B0aWNhbEF4aXMgdG8gc2VlIHRoZSBjbGlwQXJlYSByZW5kZXJlZCBhcyBhIHJlY3RhbmdsZS5cclxuICAgIGNvbnN0IHVwZGF0ZUNsaXBBcmVhID0gKCkgPT4ge1xyXG5cclxuICAgICAgbGV0IGNsaXBBcmVhOiBTaGFwZTsgLy8gaW4gdmlldyBjb29yZGluYXRlc1xyXG5cclxuICAgICAgY29uc3Qgdmlld1Zpc2libGVCb3VuZHMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdCb3VuZHMoIG1vZGVsVmlzaWJsZUJvdW5kc1Byb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgIGNvbnN0IG1pblkgPSB2aWV3VmlzaWJsZUJvdW5kcy5taW5ZO1xyXG4gICAgICBjb25zdCBtYXhZID0gdmlld1Zpc2libGVCb3VuZHMubWF4WTtcclxuICAgICAgY29uc3QgY2xpcEhlaWdodCA9IG1heFkgLSBtaW5ZO1xyXG5cclxuICAgICAgY29uc3Qgb3B0aWNYID0gbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WCggb3B0aWNQb3NpdGlvblByb3BlcnR5LnZhbHVlLnggKTtcclxuICAgICAgY29uc3QgZnJhbWVkT2JqZWN0WCA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1goIGZyYW1lZE9iamVjdFBvc2l0aW9uUHJvcGVydHkudmFsdWUueCApO1xyXG4gICAgICBjb25zdCBmcmFtZWRJbWFnZVggPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYKCBmcmFtZWRJbWFnZVBvc2l0aW9uUHJvcGVydHkudmFsdWUueCApO1xyXG5cclxuICAgICAgaWYgKCBmcmFtZWRJbWFnZVggPiBvcHRpY1ggKSB7XHJcblxyXG4gICAgICAgIC8vIElmIHRoZSBJbWFnZSBpcyB0byB0aGUgcmlnaHQgb2YgdGhlIG9wdGljLCBjbGlwQXJlYSBpcyAxIHJlY3RhbmdsZSwgYmV0d2VlbiB0aGUgT2JqZWN0IGFuZCBJbWFnZS5cclxuICAgICAgICBjbGlwQXJlYSA9IFNoYXBlLnJlY3RhbmdsZSggZnJhbWVkT2JqZWN0WCwgbWluWSwgZnJhbWVkSW1hZ2VYIC0gZnJhbWVkT2JqZWN0WCwgY2xpcEhlaWdodCApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBJZiB0aGUgSW1hZ2UgaXMgdG8gdGhlIGxlZnQgb2YgdGhlIG9wdGljLCBjbGlwQXJlYSByZXF1aXJlcyAyIHJlY3RhbmdsZXMuXHJcblxyXG4gICAgICAgIC8vIERldGVybWluZSB0aGUgcmVsYXRpdmUgcG9zaXRpb24gb2YgdGhlIE9iamVjdCBhbmQgSW1hZ2UuXHJcbiAgICAgICAgY29uc3QgaW1hZ2VPblJpZ2h0ID0gKCBmcmFtZWRJbWFnZVggPiBmcmFtZWRPYmplY3RYICk7XHJcblxyXG4gICAgICAgIC8vIFRoZSBmaXJzdCByZWN0YW5nbGUgaXMgYmV0d2VlbiB0aGUgdGhpbmcgb24gdGhlIHJpZ2h0IGFuZCB0aGUgb3B0aWMuXHJcbiAgICAgICAgY29uc3QgeDEgPSBpbWFnZU9uUmlnaHQgPyBmcmFtZWRJbWFnZVggOiBmcmFtZWRPYmplY3RYO1xyXG4gICAgICAgIGNvbnN0IGNsaXBXaWR0aDEgPSBvcHRpY1ggLSB4MTtcclxuXHJcbiAgICAgICAgLy8gVGhlIHNlY29uZCByZWN0YW5nbGUgaXMgYmV0d2VlbiB0aGUgdGhpbmcgb24gdGhlIGxlZnQgYW5kIHRoZSBsZWZ0IGVkZ2Ugb2YgdGhlIHBpY3R1cmUgZnJhbWUgb24gdGhlIHJpZ2h0LlxyXG4gICAgICAgIGNvbnN0IHgyID0gaW1hZ2VPblJpZ2h0ID8gZnJhbWVkT2JqZWN0WCA6IGZyYW1lZEltYWdlWDtcclxuICAgICAgICBjb25zdCBoYWxmRnJhbWVXaWR0aCA9ICggaW1hZ2VPblJpZ2h0ID8gZnJhbWVkSW1hZ2VOb2RlLmJvdW5kcy53aWR0aCA6IGZyYW1lZE9iamVjdE5vZGUudmlzaWJsZUJvdW5kcy53aWR0aCApIC8gMjtcclxuICAgICAgICBjb25zdCBjbGlwV2lkdGgyID0geDEgLSB4MiAtIGhhbGZGcmFtZVdpZHRoO1xyXG5cclxuICAgICAgICBjbGlwQXJlYSA9IG5ldyBTaGFwZSgpXHJcbiAgICAgICAgICAucmVjdCggeDEsIG1pblksIGNsaXBXaWR0aDEsIGNsaXBIZWlnaHQgKVxyXG4gICAgICAgICAgLnJlY3QoIHgyLCBtaW5ZLCBjbGlwV2lkdGgyLCBjbGlwSGVpZ2h0ICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuY2xpcEFyZWEgPSBjbGlwQXJlYTtcclxuXHJcbiAgICAgIGlmICggY2xpcEFyZWFOb2RlICkge1xyXG4gICAgICAgIGNsaXBBcmVhTm9kZS5zaGFwZSA9IGNsaXBBcmVhO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGxpZ2h0UmF5c1Byb2Nlc3NlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuICAgICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcbiAgICAgICAgdXBkYXRlQ2xpcEFyZWEoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudmlzaWJsZVByb3BlcnR5LmxpbmsoIHZpc2libGUgPT4ge1xyXG4gICAgICBpZiAoIHZpc2libGUgKSB7XHJcbiAgICAgICAgdXBkYXRlQ2xpcEFyZWEoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxuZ2VvbWV0cmljT3B0aWNzLnJlZ2lzdGVyKCAnT3B0aWNhbEF4aXNGb3JlZ3JvdW5kTm9kZScsIE9wdGljYWxBeGlzRm9yZWdyb3VuZE5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBS0EsU0FBU0EsS0FBSyxRQUFRLGdDQUFnQztBQUV0RCxPQUFPQyxlQUFlLE1BQU0sMEJBQTBCO0FBQ3RELE9BQU9DLGVBQWUsTUFBa0Msc0JBQXNCO0FBQzlFLE9BQU9DLGlCQUFpQixNQUFNLHlCQUF5QjtBQUN2RCxTQUFlQyxJQUFJLFFBQVEsbUNBQW1DO0FBQzlELE9BQU9DLFNBQVMsTUFBNEIsdUNBQXVDO0FBQ25GLE9BQU9DLFFBQVEsTUFBTSxnQkFBZ0I7QUFPckMsZUFBZSxNQUFNQyx5QkFBeUIsU0FBU0wsZUFBZSxDQUFDO0VBRXJFO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDU00sV0FBV0EsQ0FBRUMscUJBQWlELEVBQ2pEQywwQkFBc0QsRUFDdERDLGtCQUF1QyxFQUN2Q0MsNEJBQXdELEVBQ3hEQyxnQkFBc0IsRUFDdEJDLDJCQUF1RCxFQUN2REMsZUFBcUIsRUFDckJDLHlCQUFtQyxFQUNuQ0MsZUFBaUQsRUFBRztJQUV0RSxNQUFNQyxPQUFPLEdBQUdiLFNBQVMsQ0FBd0UsQ0FBQyxDQUFFO01BRWxHO01BQ0FjLE1BQU0sRUFBSWhCLGlCQUFpQixDQUFDaUIsZ0JBQWdCLEdBQUssS0FBSyxHQUFHZCxRQUFRLENBQUNlO0lBQ3BFLENBQUMsRUFBRUos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