// Copyright 2022, University of Colorado Boulder

/**
 * ArrowObjectNode is the visual representation of an arrow object.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Bounds2 from '../../../../dot/js/Bounds2.js';
import { DragListener, FocusHighlightFromNode, KeyboardDragListener } from '../../../../scenery/js/imports.js';
import geometricOptics from '../../geometricOptics.js';
import ArrowObject from '../model/ArrowObject.js';
import GOConstants from '../GOConstants.js';
import ArrowNode from '../../../../scenery-phet/js/ArrowNode.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { combineOptions } from '../../../../phet-core/js/optionize.js';
import OpticalObjectNode from './OpticalObjectNode.js';
import Multilink from '../../../../axon/js/Multilink.js';
const SNAP_TO_MIN_MAGNITUDE = 20; // cm

export default class ArrowObjectNode extends OpticalObjectNode {
  /**
   * @param arrowObject - model element
   * @param optic - the associated optic
   * @param sceneBoundsProperty - bounds for the scene, in model coordinates
   * @param modelViewTransform
   * @param objectDragModeProperty - constrains how the object can be dragged
   * @param wasDraggedProperty - was any ArrowObjectNode dragged?
   * @param providedOptions
   */
  constructor(arrowObject, optic, sceneBoundsProperty, modelViewTransform, objectDragModeProperty, wasDraggedProperty, providedOptions) {
    super(arrowObject, objectDragModeProperty, wasDraggedProperty, providedOptions);
    const arrowNode = new ArrowNode(0, 0, 0, 1, combineOptions({}, GOConstants.ARROW_NODE_OPTIONS, {
      fill: arrowObject.fill,
      stroke: null
    }));
    this.addChild(arrowNode);
    this.setFocusHighlight(new FocusHighlightFromNode(arrowNode));
    Multilink.multilink([arrowObject.positionProperty, optic.positionProperty], (arrowObjectPosition, opticPosition) => {
      const tipPosition = modelViewTransform.modelToViewPosition(arrowObjectPosition);
      let tailY = modelViewTransform.modelToViewY(opticPosition.y);
      if (tailY === tipPosition.y) {
        tailY += GOConstants.MIN_MAGNITUDE; // see https://github.com/phetsims/geometric-optics/issues/306
      }

      arrowNode.setTailAndTip(tipPosition.x, tailY, tipPosition.x, tipPosition.y);
      arrowNode.mouseArea = arrowNode.localBounds.dilated(3);
      arrowNode.touchArea = arrowNode.localBounds.dilated(10);
    });
    const dragBoundsProperty = new DerivedProperty([sceneBoundsProperty, objectDragModeProperty], (sceneBounds, objectDragMode) => {
      const minX = sceneBounds.minX + modelViewTransform.viewToModelDeltaX(arrowNode.width) / 2;
      const maxX = optic.positionProperty.value.x - GOConstants.MIN_DISTANCE_FROM_OBJECT_TO_OPTIC;
      let minY;
      let maxY;
      if (objectDragMode === 'freeDragging') {
        // Constrain to the smaller of sceneBounds or MAX_MAGNITUDE. See https://github.com/phetsims/geometric-optics/issues/429
        minY = Math.max(sceneBounds.minY, optic.positionProperty.value.x - ArrowObject.MAX_MAGNITUDE);
        maxY = Math.min(sceneBounds.maxY, optic.positionProperty.value.x + ArrowObject.MAX_MAGNITUDE);
      } else {
        // horizontal dragging, locked to the object's current y position
        minY = arrowObject.positionProperty.value.y;
        maxY = arrowObject.positionProperty.value.y;
      }
      return new Bounds2(minX, minY, maxX, maxY);
    });

    // Keep the arrow inside the drag bounds.
    dragBoundsProperty.link(dragBounds => {
      arrowObject.positionProperty.value = dragBounds.closestPointTo(arrowObject.positionProperty.value);
    });

    // When mouse/touch dragging is completed, check the magnitude of the arrow. If it is less than the minimum
    // magnitude, snap it to the minimum length. Optionally invert the sign, to facilitate keyboard dragging.
    const end = sign => {
      const arrowLength = arrowObject.positionProperty.value.y - optic.positionProperty.value.y;
      if (Math.abs(arrowLength) < SNAP_TO_MIN_MAGNITUDE) {
        const arrowSign = arrowLength >= 0 ? 1 : -1; // do not use Math.sign, because Math.sign(0) = 0
        const x = arrowObject.positionProperty.value.x;
        const y = sign * arrowSign * SNAP_TO_MIN_MAGNITUDE;
        arrowObject.positionProperty.value = new Vector2(x, y);
      }
    };
    const dragListener = new DragListener({
      positionProperty: arrowObject.positionProperty,
      dragBoundsProperty: dragBoundsProperty,
      transform: modelViewTransform,
      useParentOffset: true,
      drag: () => this.drag(),
      end: () => end(1),
      tandem: providedOptions.tandem.createTandem('dragListener')
    });
    this.addInputListener(dragListener);
    const keyboardDragListener = new KeyboardDragListener(combineOptions({}, GOConstants.KEYBOARD_DRAG_LISTENER_OPTIONS, {
      positionProperty: arrowObject.positionProperty,
      dragBoundsProperty: dragBoundsProperty,
      transform: modelViewTransform,
      drag: () => this.drag(),
      end: () => end(-1),
      tandem: providedOptions.tandem.createTandem('keyboardDragListener')
    }));
    this.addInputListener(keyboardDragListener);

    // Keep cueing arrows next to the arrow.
    Multilink.multilink([arrowNode.boundsProperty, this.cueingArrowsNode.boundsProperty], (arrowNodeBounds, cueingArrowsNodeBounds) => {
      this.cueingArrowsNode.right = arrowNodeBounds.left - 5;
      this.cueingArrowsNode.centerY = arrowNodeBounds.centerY;
    });
  }
}
geometricOptics.register('ArrowObjectNode', ArrowObjectNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb3VuZHMyIiwiRHJhZ0xpc3RlbmVyIiwiRm9jdXNIaWdobGlnaHRGcm9tTm9kZSIsIktleWJvYXJkRHJhZ0xpc3RlbmVyIiwiZ2VvbWV0cmljT3B0aWNzIiwiQXJyb3dPYmplY3QiLCJHT0NvbnN0YW50cyIsIkFycm93Tm9kZSIsIkRlcml2ZWRQcm9wZXJ0eSIsIlZlY3RvcjIiLCJjb21iaW5lT3B0aW9ucyIsIk9wdGljYWxPYmplY3ROb2RlIiwiTXVsdGlsaW5rIiwiU05BUF9UT19NSU5fTUFHTklUVURFIiwiQXJyb3dPYmplY3ROb2RlIiwiY29uc3RydWN0b3IiLCJhcnJvd09iamVjdCIsIm9wdGljIiwic2NlbmVCb3VuZHNQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsIm9iamVjdERyYWdNb2RlUHJvcGVydHkiLCJ3YXNEcmFnZ2VkUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJhcnJvd05vZGUiLCJBUlJPV19OT0RFX09QVElPTlMiLCJmaWxsIiwic3Ryb2tlIiwiYWRkQ2hpbGQiLCJzZXRGb2N1c0hpZ2hsaWdodCIsIm11bHRpbGluayIsInBvc2l0aW9uUHJvcGVydHkiLCJhcnJvd09iamVjdFBvc2l0aW9uIiwib3B0aWNQb3NpdGlvbiIsInRpcFBvc2l0aW9uIiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsInRhaWxZIiwibW9kZWxUb1ZpZXdZIiwieSIsIk1JTl9NQUdOSVRVREUiLCJzZXRUYWlsQW5kVGlwIiwieCIsIm1vdXNlQXJlYSIsImxvY2FsQm91bmRzIiwiZGlsYXRlZCIsInRvdWNoQXJlYSIsImRyYWdCb3VuZHNQcm9wZXJ0eSIsInNjZW5lQm91bmRzIiwib2JqZWN0RHJhZ01vZGUiLCJtaW5YIiwidmlld1RvTW9kZWxEZWx0YVgiLCJ3aWR0aCIsIm1heFgiLCJ2YWx1ZSIsIk1JTl9ESVNUQU5DRV9GUk9NX09CSkVDVF9UT19PUFRJQyIsIm1pblkiLCJtYXhZIiwiTWF0aCIsIm1heCIsIk1BWF9NQUdOSVRVREUiLCJtaW4iLCJsaW5rIiwiZHJhZ0JvdW5kcyIsImNsb3Nlc3RQb2ludFRvIiwiZW5kIiwic2lnbiIsImFycm93TGVuZ3RoIiwiYWJzIiwiYXJyb3dTaWduIiwiZHJhZ0xpc3RlbmVyIiwidHJhbnNmb3JtIiwidXNlUGFyZW50T2Zmc2V0IiwiZHJhZyIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsImFkZElucHV0TGlzdGVuZXIiLCJrZXlib2FyZERyYWdMaXN0ZW5lciIsIktFWUJPQVJEX0RSQUdfTElTVEVORVJfT1BUSU9OUyIsImJvdW5kc1Byb3BlcnR5IiwiY3VlaW5nQXJyb3dzTm9kZSIsImFycm93Tm9kZUJvdW5kcyIsImN1ZWluZ0Fycm93c05vZGVCb3VuZHMiLCJyaWdodCIsImxlZnQiLCJjZW50ZXJZIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBcnJvd09iamVjdE5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEFycm93T2JqZWN0Tm9kZSBpcyB0aGUgdmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIGFuIGFycm93IG9iamVjdC5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgeyBEcmFnTGlzdGVuZXIsIEZvY3VzSGlnaGxpZ2h0RnJvbU5vZGUsIEtleWJvYXJkRHJhZ0xpc3RlbmVyLCBLZXlib2FyZERyYWdMaXN0ZW5lck9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgZ2VvbWV0cmljT3B0aWNzIGZyb20gJy4uLy4uL2dlb21ldHJpY09wdGljcy5qcyc7XHJcbmltcG9ydCBBcnJvd09iamVjdCBmcm9tICcuLi9tb2RlbC9BcnJvd09iamVjdC5qcyc7XHJcbmltcG9ydCBPcHRpYyBmcm9tICcuLi9tb2RlbC9PcHRpYy5qcyc7XHJcbmltcG9ydCBHT0NvbnN0YW50cyBmcm9tICcuLi9HT0NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBBcnJvd05vZGUsIHsgQXJyb3dOb2RlT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9BcnJvd05vZGUuanMnO1xyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBjb21iaW5lT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgeyBPYmplY3REcmFnTW9kZSB9IGZyb20gJy4vT2JqZWN0RHJhZ01vZGUuanMnO1xyXG5pbXBvcnQgT3B0aWNhbE9iamVjdE5vZGUsIHsgT3B0aWNhbE9iamVjdE5vZGVPcHRpb25zIH0gZnJvbSAnLi9PcHRpY2FsT2JqZWN0Tm9kZS5qcyc7XHJcbmltcG9ydCBUUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuXHJcbmNvbnN0IFNOQVBfVE9fTUlOX01BR05JVFVERSA9IDIwOyAvLyBjbVxyXG5cclxudHlwZSBBcnJvd09iamVjdE5vZGVPcHRpb25zID0gT3B0aWNhbE9iamVjdE5vZGVPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXJyb3dPYmplY3ROb2RlIGV4dGVuZHMgT3B0aWNhbE9iamVjdE5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gYXJyb3dPYmplY3QgLSBtb2RlbCBlbGVtZW50XHJcbiAgICogQHBhcmFtIG9wdGljIC0gdGhlIGFzc29jaWF0ZWQgb3B0aWNcclxuICAgKiBAcGFyYW0gc2NlbmVCb3VuZHNQcm9wZXJ0eSAtIGJvdW5kcyBmb3IgdGhlIHNjZW5lLCBpbiBtb2RlbCBjb29yZGluYXRlc1xyXG4gICAqIEBwYXJhbSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0gb2JqZWN0RHJhZ01vZGVQcm9wZXJ0eSAtIGNvbnN0cmFpbnMgaG93IHRoZSBvYmplY3QgY2FuIGJlIGRyYWdnZWRcclxuICAgKiBAcGFyYW0gd2FzRHJhZ2dlZFByb3BlcnR5IC0gd2FzIGFueSBBcnJvd09iamVjdE5vZGUgZHJhZ2dlZD9cclxuICAgKiBAcGFyYW0gcHJvdmlkZWRPcHRpb25zXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBhcnJvd09iamVjdDogQXJyb3dPYmplY3QsXHJcbiAgICAgICAgICAgICAgICAgICAgICBvcHRpYzogT3B0aWMsXHJcbiAgICAgICAgICAgICAgICAgICAgICBzY2VuZUJvdW5kc1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxCb3VuZHMyPixcclxuICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMixcclxuICAgICAgICAgICAgICAgICAgICAgIG9iamVjdERyYWdNb2RlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PE9iamVjdERyYWdNb2RlPixcclxuICAgICAgICAgICAgICAgICAgICAgIHdhc0RyYWdnZWRQcm9wZXJ0eTogVFByb3BlcnR5PGJvb2xlYW4+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRPcHRpb25zOiBBcnJvd09iamVjdE5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIHN1cGVyKCBhcnJvd09iamVjdCwgb2JqZWN0RHJhZ01vZGVQcm9wZXJ0eSwgd2FzRHJhZ2dlZFByb3BlcnR5LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBjb25zdCBhcnJvd05vZGUgPSBuZXcgQXJyb3dOb2RlKCAwLCAwLCAwLCAxLFxyXG4gICAgICBjb21iaW5lT3B0aW9uczxBcnJvd05vZGVPcHRpb25zPigge30sIEdPQ29uc3RhbnRzLkFSUk9XX05PREVfT1BUSU9OUywge1xyXG4gICAgICAgIGZpbGw6IGFycm93T2JqZWN0LmZpbGwsXHJcbiAgICAgICAgc3Ryb2tlOiBudWxsXHJcbiAgICAgIH0gKSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggYXJyb3dOb2RlICk7XHJcbiAgICB0aGlzLnNldEZvY3VzSGlnaGxpZ2h0KCBuZXcgRm9jdXNIaWdobGlnaHRGcm9tTm9kZSggYXJyb3dOb2RlICkgKTtcclxuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbIGFycm93T2JqZWN0LnBvc2l0aW9uUHJvcGVydHksIG9wdGljLnBvc2l0aW9uUHJvcGVydHkgXSxcclxuICAgICAgKCBhcnJvd09iamVjdFBvc2l0aW9uLCBvcHRpY1Bvc2l0aW9uICkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRpcFBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIGFycm93T2JqZWN0UG9zaXRpb24gKTtcclxuICAgICAgICBsZXQgdGFpbFkgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCBvcHRpY1Bvc2l0aW9uLnkgKTtcclxuICAgICAgICBpZiAoIHRhaWxZID09PSB0aXBQb3NpdGlvbi55ICkge1xyXG4gICAgICAgICAgdGFpbFkgKz0gR09Db25zdGFudHMuTUlOX01BR05JVFVERTsgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9nZW9tZXRyaWMtb3B0aWNzL2lzc3Vlcy8zMDZcclxuICAgICAgICB9XHJcbiAgICAgICAgYXJyb3dOb2RlLnNldFRhaWxBbmRUaXAoIHRpcFBvc2l0aW9uLngsIHRhaWxZLCB0aXBQb3NpdGlvbi54LCB0aXBQb3NpdGlvbi55ICk7XHJcbiAgICAgICAgYXJyb3dOb2RlLm1vdXNlQXJlYSA9IGFycm93Tm9kZS5sb2NhbEJvdW5kcy5kaWxhdGVkKCAzICk7XHJcbiAgICAgICAgYXJyb3dOb2RlLnRvdWNoQXJlYSA9IGFycm93Tm9kZS5sb2NhbEJvdW5kcy5kaWxhdGVkKCAxMCApO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ0JvdW5kc1Byb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgWyBzY2VuZUJvdW5kc1Byb3BlcnR5LCBvYmplY3REcmFnTW9kZVByb3BlcnR5IF0sXHJcbiAgICAgICggc2NlbmVCb3VuZHMsIG9iamVjdERyYWdNb2RlICkgPT4ge1xyXG5cclxuICAgICAgICBjb25zdCBtaW5YID0gc2NlbmVCb3VuZHMubWluWCArIG1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbERlbHRhWCggYXJyb3dOb2RlLndpZHRoICkgLyAyO1xyXG4gICAgICAgIGNvbnN0IG1heFggPSBvcHRpYy5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggLSBHT0NvbnN0YW50cy5NSU5fRElTVEFOQ0VfRlJPTV9PQkpFQ1RfVE9fT1BUSUM7XHJcbiAgICAgICAgbGV0IG1pblk6IG51bWJlcjtcclxuICAgICAgICBsZXQgbWF4WTogbnVtYmVyO1xyXG5cclxuICAgICAgICBpZiAoIG9iamVjdERyYWdNb2RlID09PSAnZnJlZURyYWdnaW5nJyApIHtcclxuXHJcbiAgICAgICAgICAvLyBDb25zdHJhaW4gdG8gdGhlIHNtYWxsZXIgb2Ygc2NlbmVCb3VuZHMgb3IgTUFYX01BR05JVFVERS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9nZW9tZXRyaWMtb3B0aWNzL2lzc3Vlcy80MjlcclxuICAgICAgICAgIG1pblkgPSBNYXRoLm1heCggc2NlbmVCb3VuZHMubWluWSwgb3B0aWMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54IC0gQXJyb3dPYmplY3QuTUFYX01BR05JVFVERSApO1xyXG4gICAgICAgICAgbWF4WSA9IE1hdGgubWluKCBzY2VuZUJvdW5kcy5tYXhZLCBvcHRpYy5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggKyBBcnJvd09iamVjdC5NQVhfTUFHTklUVURFICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIGhvcml6b250YWwgZHJhZ2dpbmcsIGxvY2tlZCB0byB0aGUgb2JqZWN0J3MgY3VycmVudCB5IHBvc2l0aW9uXHJcbiAgICAgICAgICBtaW5ZID0gYXJyb3dPYmplY3QucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55O1xyXG4gICAgICAgICAgbWF4WSA9IGFycm93T2JqZWN0LnBvc2l0aW9uUHJvcGVydHkudmFsdWUueTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5ldyBCb3VuZHMyKCBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZICk7XHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAvLyBLZWVwIHRoZSBhcnJvdyBpbnNpZGUgdGhlIGRyYWcgYm91bmRzLlxyXG4gICAgZHJhZ0JvdW5kc1Byb3BlcnR5LmxpbmsoIGRyYWdCb3VuZHMgPT4ge1xyXG4gICAgICBhcnJvd09iamVjdC5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gZHJhZ0JvdW5kcy5jbG9zZXN0UG9pbnRUbyggYXJyb3dPYmplY3QucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFdoZW4gbW91c2UvdG91Y2ggZHJhZ2dpbmcgaXMgY29tcGxldGVkLCBjaGVjayB0aGUgbWFnbml0dWRlIG9mIHRoZSBhcnJvdy4gSWYgaXQgaXMgbGVzcyB0aGFuIHRoZSBtaW5pbXVtXHJcbiAgICAvLyBtYWduaXR1ZGUsIHNuYXAgaXQgdG8gdGhlIG1pbmltdW0gbGVuZ3RoLiBPcHRpb25hbGx5IGludmVydCB0aGUgc2lnbiwgdG8gZmFjaWxpdGF0ZSBrZXlib2FyZCBkcmFnZ2luZy5cclxuICAgIGNvbnN0IGVuZCA9ICggc2lnbjogMSB8IC0xICkgPT4ge1xyXG4gICAgICBjb25zdCBhcnJvd0xlbmd0aCA9IGFycm93T2JqZWN0LnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSAtIG9wdGljLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueTtcclxuICAgICAgaWYgKCBNYXRoLmFicyggYXJyb3dMZW5ndGggKSA8IFNOQVBfVE9fTUlOX01BR05JVFVERSApIHtcclxuICAgICAgICBjb25zdCBhcnJvd1NpZ24gPSAoIGFycm93TGVuZ3RoID49IDAgKSA/IDEgOiAtMTsgLy8gZG8gbm90IHVzZSBNYXRoLnNpZ24sIGJlY2F1c2UgTWF0aC5zaWduKDApID0gMFxyXG4gICAgICAgIGNvbnN0IHggPSBhcnJvd09iamVjdC5wb3NpdGlvblByb3BlcnR5LnZhbHVlLng7XHJcbiAgICAgICAgY29uc3QgeSA9IHNpZ24gKiBhcnJvd1NpZ24gKiBTTkFQX1RPX01JTl9NQUdOSVRVREU7XHJcbiAgICAgICAgYXJyb3dPYmplY3QucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCB4LCB5ICk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICBwb3NpdGlvblByb3BlcnR5OiBhcnJvd09iamVjdC5wb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICBkcmFnQm91bmRzUHJvcGVydHk6IGRyYWdCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgdHJhbnNmb3JtOiBtb2RlbFZpZXdUcmFuc2Zvcm0sXHJcbiAgICAgIHVzZVBhcmVudE9mZnNldDogdHJ1ZSxcclxuICAgICAgZHJhZzogKCkgPT4gdGhpcy5kcmFnKCksXHJcbiAgICAgIGVuZDogKCkgPT4gZW5kKCAxICksXHJcbiAgICAgIHRhbmRlbTogcHJvdmlkZWRPcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkcmFnTGlzdGVuZXInIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggZHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgY29uc3Qga2V5Ym9hcmREcmFnTGlzdGVuZXIgPSBuZXcgS2V5Ym9hcmREcmFnTGlzdGVuZXIoXHJcbiAgICAgIGNvbWJpbmVPcHRpb25zPEtleWJvYXJkRHJhZ0xpc3RlbmVyT3B0aW9ucz4oIHt9LCBHT0NvbnN0YW50cy5LRVlCT0FSRF9EUkFHX0xJU1RFTkVSX09QVElPTlMsIHtcclxuICAgICAgICBwb3NpdGlvblByb3BlcnR5OiBhcnJvd09iamVjdC5wb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICAgIGRyYWdCb3VuZHNQcm9wZXJ0eTogZHJhZ0JvdW5kc1Byb3BlcnR5LFxyXG4gICAgICAgIHRyYW5zZm9ybTogbW9kZWxWaWV3VHJhbnNmb3JtLFxyXG4gICAgICAgIGRyYWc6ICgpID0+IHRoaXMuZHJhZygpLFxyXG4gICAgICAgIGVuZDogKCkgPT4gZW5kKCAtMSApLFxyXG4gICAgICAgIHRhbmRlbTogcHJvdmlkZWRPcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdrZXlib2FyZERyYWdMaXN0ZW5lcicgKVxyXG4gICAgICB9ICkgKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lcigga2V5Ym9hcmREcmFnTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBLZWVwIGN1ZWluZyBhcnJvd3MgbmV4dCB0byB0aGUgYXJyb3cuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbIGFycm93Tm9kZS5ib3VuZHNQcm9wZXJ0eSwgdGhpcy5jdWVpbmdBcnJvd3NOb2RlLmJvdW5kc1Byb3BlcnR5IF0sXHJcbiAgICAgICggYXJyb3dOb2RlQm91bmRzOiBCb3VuZHMyLCBjdWVpbmdBcnJvd3NOb2RlQm91bmRzOiBCb3VuZHMyICkgPT4ge1xyXG4gICAgICAgIHRoaXMuY3VlaW5nQXJyb3dzTm9kZS5yaWdodCA9IGFycm93Tm9kZUJvdW5kcy5sZWZ0IC0gNTtcclxuICAgICAgICB0aGlzLmN1ZWluZ0Fycm93c05vZGUuY2VudGVyWSA9IGFycm93Tm9kZUJvdW5kcy5jZW50ZXJZO1xyXG4gICAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5nZW9tZXRyaWNPcHRpY3MucmVnaXN0ZXIoICdBcnJvd09iamVjdE5vZGUnLCBBcnJvd09iamVjdE5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsT0FBT0EsT0FBTyxNQUFNLCtCQUErQjtBQUVuRCxTQUFTQyxZQUFZLEVBQUVDLHNCQUFzQixFQUFFQyxvQkFBb0IsUUFBcUMsbUNBQW1DO0FBQzNJLE9BQU9DLGVBQWUsTUFBTSwwQkFBMEI7QUFDdEQsT0FBT0MsV0FBVyxNQUFNLHlCQUF5QjtBQUVqRCxPQUFPQyxXQUFXLE1BQU0sbUJBQW1CO0FBQzNDLE9BQU9DLFNBQVMsTUFBNEIsMENBQTBDO0FBQ3RGLE9BQU9DLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxTQUFTQyxjQUFjLFFBQVEsdUNBQXVDO0FBRXRFLE9BQU9DLGlCQUFpQixNQUFvQyx3QkFBd0I7QUFFcEYsT0FBT0MsU0FBUyxNQUFNLGtDQUFrQztBQUV4RCxNQUFNQyxxQkFBcUIsR0FBRyxFQUFFLENBQUMsQ0FBQzs7QUFJbEMsZUFBZSxNQUFNQyxlQUFlLFNBQVNILGlCQUFpQixDQUFDO0VBRTdEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTSSxXQUFXQSxDQUFFQyxXQUF3QixFQUN4QkMsS0FBWSxFQUNaQyxtQkFBK0MsRUFDL0NDLGtCQUF1QyxFQUN2Q0Msc0JBQXlELEVBQ3pEQyxrQkFBc0MsRUFDdENDLGVBQXVDLEVBQUc7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