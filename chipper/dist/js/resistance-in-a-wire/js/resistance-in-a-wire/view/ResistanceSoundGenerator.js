// Copyright 2018-2022, University of Colorado Boulder

/**
 * A sound generator used to indicate the resistance level in the RIAW simulation.  This uses the values for the
 * resistivity, length, and area of the wire to decide WHEN to generate a sound, and the value of the resistance to
 * determine the nature of the sound to be generated.
 *
 * @author John Blanco
 */

import Range from '../../../../dot/js/Range.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import brightMarimbaShort_mp3 from '../../../../tambo/sounds/brightMarimbaShort_mp3.js';
import resistanceInAWire from '../../resistanceInAWire.js';
import ResistanceInAWireConstants from '../ResistanceInAWireConstants.js';

// constants
const BINS_PER_SLIDER = 9; // odd numbers generally work best because a bin then spans the middle initial value
const MIN_RESISTANCE = ResistanceInAWireConstants.RESISTANCE_RANGE.min;
const MAX_RESISTANCE = ResistanceInAWireConstants.RESISTANCE_RANGE.max;
const MIN_RESISTIVITY = ResistanceInAWireConstants.RESISTIVITY_RANGE.min;
const MAX_RESISTIVITY = ResistanceInAWireConstants.RESISTIVITY_RANGE.max;
const MIN_AREA = ResistanceInAWireConstants.AREA_RANGE.min;
const MAX_AREA = ResistanceInAWireConstants.AREA_RANGE.max;
const MIN_LENGTH = ResistanceInAWireConstants.LENGTH_RANGE.min;
const MAX_LENGTH = ResistanceInAWireConstants.LENGTH_RANGE.max;
class ResistanceSoundGenerator extends SoundClip {
  /**
   * @constructor
   * {Object} config - a configuration object that includes property values for the resistivity, area, and length of
   * the wire and the sliders that control each, as well as a property the indicates whether a reset is in progress.
   */
  constructor(config) {
    super(brightMarimbaShort_mp3, {
      initialOutputLevel: 0.5,
      rateChangesAffectPlayingSounds: false
    });

    // function to map the resistance to a playback speed and play the sound
    const playResistanceSound = () => {
      if (!config.resetInProgressProperty.value) {
        // normalize the resistance value between 0 and 1, taking into account several orders of magnitude
        const normalizedResistance = Math.log(config.resistanceProperty.value / MIN_RESISTANCE) / Math.log(MAX_RESISTANCE / MIN_RESISTANCE);

        // map the normalized resistance value to a playback rate for the sound clip
        const playbackRate = Math.pow(2, (1 - normalizedResistance) * 3) / 3;
        this.setPlaybackRate(playbackRate);
        this.play();
      }
    };

    // @private - objects that monitor the parameter and play the sound, references kept for debugging and clarity
    const resistivityMonitor = new ParameterMonitor(config.resistivityProperty, config.resistivitySlider, new Range(MIN_RESISTIVITY, MAX_RESISTIVITY), playResistanceSound);
    const lengthMonitor = new ParameterMonitor(config.lengthProperty, config.lengthSlider, new Range(MIN_LENGTH, MAX_LENGTH), playResistanceSound);
    const areaMonitor = new ParameterMonitor(config.areaProperty, config.areaSlider, new Range(MIN_AREA, MAX_AREA), playResistanceSound);
    this.disposeResistanceSoundGenerator = () => {
      resistivityMonitor.dispose();
      lengthMonitor.dispose();
      areaMonitor.dispose();
    };
  }

  /**
   * @public
   */
  dispose() {
    this.disposeResistanceSoundGenerator();
  }
}
class BinSelector {
  /**
   * inner type for placing values in a bin
   * @param {number} minValue
   * @param {number} maxValue
   * @param {number} numBins
   * @constructor
   */
  constructor(minValue, maxValue, numBins) {
    // parameter checking
    assert && assert(maxValue > minValue);
    assert && assert(numBins > 0);

    // @private
    this.minValue = minValue;
    this.maxValue = maxValue;
    this.span = this.maxValue - this.minValue;
    this.numBins = numBins;
  }

  /**
   * put the provided value in a bin
   * @param value
   * @returns {number}
   * @public
   */
  selectBin(value) {
    assert && assert(value <= this.maxValue);
    assert && assert(value >= this.minValue);

    // this calculation means that values on the boundaries will go into the higher bin except for the max value
    const proportion = (value - this.minValue) / this.span;
    return Math.min(Math.floor(proportion * this.numBins), this.numBins - 1);
  }
}
class ParameterMonitor {
  /**
   * inner type for monitoring a parameter a playing a sound when warranted
   * @param {NumberProperty} valueProperty - the value of the parameter, enclosed in an Axon Property
   * @param {SliderUnit} sliderUnit - the slider unit that controls the parameter's value
   * @param {Range} parameterRange - the range of values that the parameter can take on
   * @param {function} generateSound - function that will be called to generate the sound
   * @constructor
   */
  constructor(valueProperty, sliderUnit, parameterRange, generateSound) {
    const binSelector = new BinSelector(parameterRange.min, parameterRange.max, BINS_PER_SLIDER);
    let selectedBin = binSelector.selectBin(valueProperty.value);

    // @private - for dispose
    this.valueProperty = valueProperty;

    // @private - for dispose
    this.valuePropertyListener = parameterValue => {
      const bin = binSelector.selectBin(parameterValue);

      // Play the sound if a change has occurred due to keyboard interaction, if the area value has moved to a new bin,
      // or if a min or max has been reached.
      if (sliderUnit.keyboardDragging || bin !== selectedBin || parameterValue === parameterRange.min || parameterValue === parameterRange.max) {
        generateSound();
      }
      selectedBin = bin;
    };

    // hook up the listener
    valueProperty.lazyLink(this.valuePropertyListener);
  }

  /**
   * dispose
   * @public
   */
  dispose() {
    this.valueProperty.unlink(this.valuePropertyListener);
  }
}
resistanceInAWire.register('ResistanceSoundGenerator', ResistanceSoundGenerator);
export default ResistanceSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSYW5nZSIsIlNvdW5kQ2xpcCIsImJyaWdodE1hcmltYmFTaG9ydF9tcDMiLCJyZXNpc3RhbmNlSW5BV2lyZSIsIlJlc2lzdGFuY2VJbkFXaXJlQ29uc3RhbnRzIiwiQklOU19QRVJfU0xJREVSIiwiTUlOX1JFU0lTVEFOQ0UiLCJSRVNJU1RBTkNFX1JBTkdFIiwibWluIiwiTUFYX1JFU0lTVEFOQ0UiLCJtYXgiLCJNSU5fUkVTSVNUSVZJVFkiLCJSRVNJU1RJVklUWV9SQU5HRSIsIk1BWF9SRVNJU1RJVklUWSIsIk1JTl9BUkVBIiwiQVJFQV9SQU5HRSIsIk1BWF9BUkVBIiwiTUlOX0xFTkdUSCIsIkxFTkdUSF9SQU5HRSIsIk1BWF9MRU5HVEgiLCJSZXNpc3RhbmNlU291bmRHZW5lcmF0b3IiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImluaXRpYWxPdXRwdXRMZXZlbCIsInJhdGVDaGFuZ2VzQWZmZWN0UGxheWluZ1NvdW5kcyIsInBsYXlSZXNpc3RhbmNlU291bmQiLCJyZXNldEluUHJvZ3Jlc3NQcm9wZXJ0eSIsInZhbHVlIiwibm9ybWFsaXplZFJlc2lzdGFuY2UiLCJNYXRoIiwibG9nIiwicmVzaXN0YW5jZVByb3BlcnR5IiwicGxheWJhY2tSYXRlIiwicG93Iiwic2V0UGxheWJhY2tSYXRlIiwicGxheSIsInJlc2lzdGl2aXR5TW9uaXRvciIsIlBhcmFtZXRlck1vbml0b3IiLCJyZXNpc3Rpdml0eVByb3BlcnR5IiwicmVzaXN0aXZpdHlTbGlkZXIiLCJsZW5ndGhNb25pdG9yIiwibGVuZ3RoUHJvcGVydHkiLCJsZW5ndGhTbGlkZXIiLCJhcmVhTW9uaXRvciIsImFyZWFQcm9wZXJ0eSIsImFyZWFTbGlkZXIiLCJkaXNwb3NlUmVzaXN0YW5jZVNvdW5kR2VuZXJhdG9yIiwiZGlzcG9zZSIsIkJpblNlbGVjdG9yIiwibWluVmFsdWUiLCJtYXhWYWx1ZSIsIm51bUJpbnMiLCJhc3NlcnQiLCJzcGFuIiwic2VsZWN0QmluIiwicHJvcG9ydGlvbiIsImZsb29yIiwidmFsdWVQcm9wZXJ0eSIsInNsaWRlclVuaXQiLCJwYXJhbWV0ZXJSYW5nZSIsImdlbmVyYXRlU291bmQiLCJiaW5TZWxlY3RvciIsInNlbGVjdGVkQmluIiwidmFsdWVQcm9wZXJ0eUxpc3RlbmVyIiwicGFyYW1ldGVyVmFsdWUiLCJiaW4iLCJrZXlib2FyZERyYWdnaW5nIiwibGF6eUxpbmsiLCJ1bmxpbmsiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlJlc2lzdGFuY2VTb3VuZEdlbmVyYXRvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHNvdW5kIGdlbmVyYXRvciB1c2VkIHRvIGluZGljYXRlIHRoZSByZXNpc3RhbmNlIGxldmVsIGluIHRoZSBSSUFXIHNpbXVsYXRpb24uICBUaGlzIHVzZXMgdGhlIHZhbHVlcyBmb3IgdGhlXHJcbiAqIHJlc2lzdGl2aXR5LCBsZW5ndGgsIGFuZCBhcmVhIG9mIHRoZSB3aXJlIHRvIGRlY2lkZSBXSEVOIHRvIGdlbmVyYXRlIGEgc291bmQsIGFuZCB0aGUgdmFsdWUgb2YgdGhlIHJlc2lzdGFuY2UgdG9cclxuICogZGV0ZXJtaW5lIHRoZSBuYXR1cmUgb2YgdGhlIHNvdW5kIHRvIGJlIGdlbmVyYXRlZC5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKi9cclxuXHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgU291bmRDbGlwIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kLWdlbmVyYXRvcnMvU291bmRDbGlwLmpzJztcclxuaW1wb3J0IGJyaWdodE1hcmltYmFTaG9ydF9tcDMgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vc291bmRzL2JyaWdodE1hcmltYmFTaG9ydF9tcDMuanMnO1xyXG5pbXBvcnQgcmVzaXN0YW5jZUluQVdpcmUgZnJvbSAnLi4vLi4vcmVzaXN0YW5jZUluQVdpcmUuanMnO1xyXG5pbXBvcnQgUmVzaXN0YW5jZUluQVdpcmVDb25zdGFudHMgZnJvbSAnLi4vUmVzaXN0YW5jZUluQVdpcmVDb25zdGFudHMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEJJTlNfUEVSX1NMSURFUiA9IDk7IC8vIG9kZCBudW1iZXJzIGdlbmVyYWxseSB3b3JrIGJlc3QgYmVjYXVzZSBhIGJpbiB0aGVuIHNwYW5zIHRoZSBtaWRkbGUgaW5pdGlhbCB2YWx1ZVxyXG5jb25zdCBNSU5fUkVTSVNUQU5DRSA9IFJlc2lzdGFuY2VJbkFXaXJlQ29uc3RhbnRzLlJFU0lTVEFOQ0VfUkFOR0UubWluO1xyXG5jb25zdCBNQVhfUkVTSVNUQU5DRSA9IFJlc2lzdGFuY2VJbkFXaXJlQ29uc3RhbnRzLlJFU0lTVEFOQ0VfUkFOR0UubWF4O1xyXG5jb25zdCBNSU5fUkVTSVNUSVZJVFkgPSBSZXNpc3RhbmNlSW5BV2lyZUNvbnN0YW50cy5SRVNJU1RJVklUWV9SQU5HRS5taW47XHJcbmNvbnN0IE1BWF9SRVNJU1RJVklUWSA9IFJlc2lzdGFuY2VJbkFXaXJlQ29uc3RhbnRzLlJFU0lTVElWSVRZX1JBTkdFLm1heDtcclxuY29uc3QgTUlOX0FSRUEgPSBSZXNpc3RhbmNlSW5BV2lyZUNvbnN0YW50cy5BUkVBX1JBTkdFLm1pbjtcclxuY29uc3QgTUFYX0FSRUEgPSBSZXNpc3RhbmNlSW5BV2lyZUNvbnN0YW50cy5BUkVBX1JBTkdFLm1heDtcclxuY29uc3QgTUlOX0xFTkdUSCA9IFJlc2lzdGFuY2VJbkFXaXJlQ29uc3RhbnRzLkxFTkdUSF9SQU5HRS5taW47XHJcbmNvbnN0IE1BWF9MRU5HVEggPSBSZXNpc3RhbmNlSW5BV2lyZUNvbnN0YW50cy5MRU5HVEhfUkFOR0UubWF4O1xyXG5cclxuY2xhc3MgUmVzaXN0YW5jZVNvdW5kR2VuZXJhdG9yIGV4dGVuZHMgU291bmRDbGlwIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQGNvbnN0cnVjdG9yXHJcbiAgICoge09iamVjdH0gY29uZmlnIC0gYSBjb25maWd1cmF0aW9uIG9iamVjdCB0aGF0IGluY2x1ZGVzIHByb3BlcnR5IHZhbHVlcyBmb3IgdGhlIHJlc2lzdGl2aXR5LCBhcmVhLCBhbmQgbGVuZ3RoIG9mXHJcbiAgICogdGhlIHdpcmUgYW5kIHRoZSBzbGlkZXJzIHRoYXQgY29udHJvbCBlYWNoLCBhcyB3ZWxsIGFzIGEgcHJvcGVydHkgdGhlIGluZGljYXRlcyB3aGV0aGVyIGEgcmVzZXQgaXMgaW4gcHJvZ3Jlc3MuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGNvbmZpZyApIHtcclxuXHJcbiAgICBzdXBlciggYnJpZ2h0TWFyaW1iYVNob3J0X21wMywge1xyXG4gICAgICBpbml0aWFsT3V0cHV0TGV2ZWw6IDAuNSxcclxuICAgICAgcmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGZ1bmN0aW9uIHRvIG1hcCB0aGUgcmVzaXN0YW5jZSB0byBhIHBsYXliYWNrIHNwZWVkIGFuZCBwbGF5IHRoZSBzb3VuZFxyXG4gICAgY29uc3QgcGxheVJlc2lzdGFuY2VTb3VuZCA9ICgpID0+IHtcclxuXHJcbiAgICAgIGlmICggIWNvbmZpZy5yZXNldEluUHJvZ3Jlc3NQcm9wZXJ0eS52YWx1ZSApIHtcclxuXHJcbiAgICAgICAgLy8gbm9ybWFsaXplIHRoZSByZXNpc3RhbmNlIHZhbHVlIGJldHdlZW4gMCBhbmQgMSwgdGFraW5nIGludG8gYWNjb3VudCBzZXZlcmFsIG9yZGVycyBvZiBtYWduaXR1ZGVcclxuICAgICAgICBjb25zdCBub3JtYWxpemVkUmVzaXN0YW5jZSA9IE1hdGgubG9nKCBjb25maWcucmVzaXN0YW5jZVByb3BlcnR5LnZhbHVlIC8gTUlOX1JFU0lTVEFOQ0UgKSAvXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmxvZyggTUFYX1JFU0lTVEFOQ0UgLyBNSU5fUkVTSVNUQU5DRSApO1xyXG5cclxuICAgICAgICAvLyBtYXAgdGhlIG5vcm1hbGl6ZWQgcmVzaXN0YW5jZSB2YWx1ZSB0byBhIHBsYXliYWNrIHJhdGUgZm9yIHRoZSBzb3VuZCBjbGlwXHJcbiAgICAgICAgY29uc3QgcGxheWJhY2tSYXRlID0gTWF0aC5wb3coIDIsICggMSAtIG5vcm1hbGl6ZWRSZXNpc3RhbmNlICkgKiAzICkgLyAzO1xyXG5cclxuICAgICAgICB0aGlzLnNldFBsYXliYWNrUmF0ZSggcGxheWJhY2tSYXRlICk7XHJcbiAgICAgICAgdGhpcy5wbGF5KCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBvYmplY3RzIHRoYXQgbW9uaXRvciB0aGUgcGFyYW1ldGVyIGFuZCBwbGF5IHRoZSBzb3VuZCwgcmVmZXJlbmNlcyBrZXB0IGZvciBkZWJ1Z2dpbmcgYW5kIGNsYXJpdHlcclxuICAgIGNvbnN0IHJlc2lzdGl2aXR5TW9uaXRvciA9IG5ldyBQYXJhbWV0ZXJNb25pdG9yKFxyXG4gICAgICBjb25maWcucmVzaXN0aXZpdHlQcm9wZXJ0eSxcclxuICAgICAgY29uZmlnLnJlc2lzdGl2aXR5U2xpZGVyLFxyXG4gICAgICBuZXcgUmFuZ2UoIE1JTl9SRVNJU1RJVklUWSwgTUFYX1JFU0lTVElWSVRZICksXHJcbiAgICAgIHBsYXlSZXNpc3RhbmNlU291bmRcclxuICAgICk7XHJcbiAgICBjb25zdCBsZW5ndGhNb25pdG9yID0gbmV3IFBhcmFtZXRlck1vbml0b3IoXHJcbiAgICAgIGNvbmZpZy5sZW5ndGhQcm9wZXJ0eSxcclxuICAgICAgY29uZmlnLmxlbmd0aFNsaWRlcixcclxuICAgICAgbmV3IFJhbmdlKCBNSU5fTEVOR1RILCBNQVhfTEVOR1RIICksXHJcbiAgICAgIHBsYXlSZXNpc3RhbmNlU291bmRcclxuICAgICk7XHJcbiAgICBjb25zdCBhcmVhTW9uaXRvciA9IG5ldyBQYXJhbWV0ZXJNb25pdG9yKFxyXG4gICAgICBjb25maWcuYXJlYVByb3BlcnR5LFxyXG4gICAgICBjb25maWcuYXJlYVNsaWRlcixcclxuICAgICAgbmV3IFJhbmdlKCBNSU5fQVJFQSwgTUFYX0FSRUEgKSxcclxuICAgICAgcGxheVJlc2lzdGFuY2VTb3VuZFxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VSZXNpc3RhbmNlU291bmRHZW5lcmF0b3IgPSAoKSA9PiB7XHJcbiAgICAgIHJlc2lzdGl2aXR5TW9uaXRvci5kaXNwb3NlKCk7XHJcbiAgICAgIGxlbmd0aE1vbml0b3IuZGlzcG9zZSgpO1xyXG4gICAgICBhcmVhTW9uaXRvci5kaXNwb3NlKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2VSZXNpc3RhbmNlU291bmRHZW5lcmF0b3IoKTtcclxuICB9XHJcblxyXG59XHJcblxyXG5jbGFzcyBCaW5TZWxlY3RvciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIGlubmVyIHR5cGUgZm9yIHBsYWNpbmcgdmFsdWVzIGluIGEgYmluXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IG1pblZhbHVlXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IG1heFZhbHVlXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IG51bUJpbnNcclxuICAgKiBAY29uc3RydWN0b3JcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbWluVmFsdWUsIG1heFZhbHVlLCBudW1CaW5zICkge1xyXG5cclxuICAgIC8vIHBhcmFtZXRlciBjaGVja2luZ1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggbWF4VmFsdWUgPiBtaW5WYWx1ZSApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggbnVtQmlucyA+IDAgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5taW5WYWx1ZSA9IG1pblZhbHVlO1xyXG4gICAgdGhpcy5tYXhWYWx1ZSA9IG1heFZhbHVlO1xyXG4gICAgdGhpcy5zcGFuID0gdGhpcy5tYXhWYWx1ZSAtIHRoaXMubWluVmFsdWU7XHJcbiAgICB0aGlzLm51bUJpbnMgPSBudW1CaW5zO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHB1dCB0aGUgcHJvdmlkZWQgdmFsdWUgaW4gYSBiaW5cclxuICAgKiBAcGFyYW0gdmFsdWVcclxuICAgKiBAcmV0dXJucyB7bnVtYmVyfVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzZWxlY3RCaW4oIHZhbHVlICkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdmFsdWUgPD0gdGhpcy5tYXhWYWx1ZSApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdmFsdWUgPj0gdGhpcy5taW5WYWx1ZSApO1xyXG5cclxuICAgIC8vIHRoaXMgY2FsY3VsYXRpb24gbWVhbnMgdGhhdCB2YWx1ZXMgb24gdGhlIGJvdW5kYXJpZXMgd2lsbCBnbyBpbnRvIHRoZSBoaWdoZXIgYmluIGV4Y2VwdCBmb3IgdGhlIG1heCB2YWx1ZVxyXG4gICAgY29uc3QgcHJvcG9ydGlvbiA9ICggdmFsdWUgLSB0aGlzLm1pblZhbHVlICkgLyB0aGlzLnNwYW47XHJcbiAgICByZXR1cm4gTWF0aC5taW4oIE1hdGguZmxvb3IoIHByb3BvcnRpb24gKiB0aGlzLm51bUJpbnMgKSwgdGhpcy5udW1CaW5zIC0gMSApO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmNsYXNzIFBhcmFtZXRlck1vbml0b3Ige1xyXG5cclxuICAvKipcclxuICAgKiBpbm5lciB0eXBlIGZvciBtb25pdG9yaW5nIGEgcGFyYW1ldGVyIGEgcGxheWluZyBhIHNvdW5kIHdoZW4gd2FycmFudGVkXHJcbiAgICogQHBhcmFtIHtOdW1iZXJQcm9wZXJ0eX0gdmFsdWVQcm9wZXJ0eSAtIHRoZSB2YWx1ZSBvZiB0aGUgcGFyYW1ldGVyLCBlbmNsb3NlZCBpbiBhbiBBeG9uIFByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtTbGlkZXJVbml0fSBzbGlkZXJVbml0IC0gdGhlIHNsaWRlciB1bml0IHRoYXQgY29udHJvbHMgdGhlIHBhcmFtZXRlcidzIHZhbHVlXHJcbiAgICogQHBhcmFtIHtSYW5nZX0gcGFyYW1ldGVyUmFuZ2UgLSB0aGUgcmFuZ2Ugb2YgdmFsdWVzIHRoYXQgdGhlIHBhcmFtZXRlciBjYW4gdGFrZSBvblxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGdlbmVyYXRlU291bmQgLSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHRvIGdlbmVyYXRlIHRoZSBzb3VuZFxyXG4gICAqIEBjb25zdHJ1Y3RvclxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCB2YWx1ZVByb3BlcnR5LCBzbGlkZXJVbml0LCBwYXJhbWV0ZXJSYW5nZSwgZ2VuZXJhdGVTb3VuZCApIHtcclxuICAgIGNvbnN0IGJpblNlbGVjdG9yID0gbmV3IEJpblNlbGVjdG9yKCBwYXJhbWV0ZXJSYW5nZS5taW4sIHBhcmFtZXRlclJhbmdlLm1heCwgQklOU19QRVJfU0xJREVSICk7XHJcbiAgICBsZXQgc2VsZWN0ZWRCaW4gPSBiaW5TZWxlY3Rvci5zZWxlY3RCaW4oIHZhbHVlUHJvcGVydHkudmFsdWUgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIGZvciBkaXNwb3NlXHJcbiAgICB0aGlzLnZhbHVlUHJvcGVydHkgPSB2YWx1ZVByb3BlcnR5O1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gZm9yIGRpc3Bvc2VcclxuICAgIHRoaXMudmFsdWVQcm9wZXJ0eUxpc3RlbmVyID0gcGFyYW1ldGVyVmFsdWUgPT4ge1xyXG4gICAgICBjb25zdCBiaW4gPSBiaW5TZWxlY3Rvci5zZWxlY3RCaW4oIHBhcmFtZXRlclZhbHVlICk7XHJcblxyXG4gICAgICAvLyBQbGF5IHRoZSBzb3VuZCBpZiBhIGNoYW5nZSBoYXMgb2NjdXJyZWQgZHVlIHRvIGtleWJvYXJkIGludGVyYWN0aW9uLCBpZiB0aGUgYXJlYSB2YWx1ZSBoYXMgbW92ZWQgdG8gYSBuZXcgYmluLFxyXG4gICAgICAvLyBvciBpZiBhIG1pbiBvciBtYXggaGFzIGJlZW4gcmVhY2hlZC5cclxuICAgICAgaWYgKCBzbGlkZXJVbml0LmtleWJvYXJkRHJhZ2dpbmcgfHwgYmluICE9PSBzZWxlY3RlZEJpbiB8fFxyXG4gICAgICAgICAgIHBhcmFtZXRlclZhbHVlID09PSBwYXJhbWV0ZXJSYW5nZS5taW4gfHwgcGFyYW1ldGVyVmFsdWUgPT09IHBhcmFtZXRlclJhbmdlLm1heCApIHtcclxuICAgICAgICBnZW5lcmF0ZVNvdW5kKCk7XHJcbiAgICAgIH1cclxuICAgICAgc2VsZWN0ZWRCaW4gPSBiaW47XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGhvb2sgdXAgdGhlIGxpc3RlbmVyXHJcbiAgICB2YWx1ZVByb3BlcnR5LmxhenlMaW5rKCB0aGlzLnZhbHVlUHJvcGVydHlMaXN0ZW5lciApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogZGlzcG9zZVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy52YWx1ZVByb3BlcnR5LnVubGluayggdGhpcy52YWx1ZVByb3BlcnR5TGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG59XHJcblxyXG5yZXNpc3RhbmNlSW5BV2lyZS5yZWdpc3RlciggJ1Jlc2lzdGFuY2VTb3VuZEdlbmVyYXRvcicsIFJlc2lzdGFuY2VTb3VuZEdlbmVyYXRvciApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgUmVzaXN0YW5jZVNvdW5kR2VuZXJhdG9yOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxTQUFTLE1BQU0sb0RBQW9EO0FBQzFFLE9BQU9DLHNCQUFzQixNQUFNLG9EQUFvRDtBQUN2RixPQUFPQyxpQkFBaUIsTUFBTSw0QkFBNEI7QUFDMUQsT0FBT0MsMEJBQTBCLE1BQU0sa0NBQWtDOztBQUV6RTtBQUNBLE1BQU1DLGVBQWUsR0FBRyxDQUFDLENB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