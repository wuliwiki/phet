// Copyright 2020-2022, University of Colorado Boulder

/**
 * PhotonsModel is the main model for the "Photons" screen.
 *
 * @author John Blanco (PhET Interactive Simulations)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import ConcentrationModel, { ConcentrationControlMode, ConcentrationDate } from '../../common/model/ConcentrationModel.js';
import PhotonCollection from '../../common/model/PhotonCollection.js';
import greenhouseEffect from '../../greenhouseEffect.js';

// constants
const MAX_REFLECTION_ADJUSTMENT = Math.PI * 0.25; // empirically determined by what looked good
const MIN_REFLECTION_ADJUSTMENT = MAX_REFLECTION_ADJUSTMENT * 0.2; // empirically determined by what looked good

/**
 * @constructor
 */
class PhotonsModel extends ConcentrationModel {
  // the collection of visible and IR photons that move around and interact with the ground and atmosphere

  // set of photons that are passing through the cloud
  photonsPassingThroughCloud = [];

  // bounds of the cloud, calculated during construction to save time later

  constructor(tandem) {
    super(tandem, {
      fluxMeterPresent: true
    });

    // derived Property that is true when a glacier is present on the ground, false otherwise
    const glacierPresentProperty = new DerivedProperty([this.concentrationControlModeProperty, this.dateProperty], (concentrationControlMode, date) => concentrationControlMode === ConcentrationControlMode.BY_DATE && date === ConcentrationDate.ICE_AGE);
    this.photonCollection = new PhotonCollection(this.sunEnergySource, this.groundLayer, this.atmosphereLayers, {
      photonAbsorbingEmittingLayerOptions: {
        photonAbsorptionTime: 0,
        photonMaxLateralJumpProportion: 0,
        absorbanceMultiplier: 10 // empirically determined to give us the desired visual behavior, adjust as needed
      },

      glacierPresentProperty: glacierPresentProperty,
      tandem: tandem.createTandem('photonCollection')
    });
    assert && assert(this.cloud, 'The cloud should always be turned on in the PhotonsModel');
    this.cloudBounds = this.cloud.modelShape.bounds;

    // TODO: tandem is documented readonly (though not with TypeScript) - is this correct?
    this.tandem = tandem;
  }

  /**
   * Step forward in time.
   * @param dt - delta time, in seconds
   */
  stepModel(dt) {
    this.photonCollection.step(dt);

    // Check for interaction between the photons and the cloud.  This will cause some photons to reflect off the cloud.
    if (this.cloudEnabledProperty.value) {
      assert && assert(this.cloud, 'The model should never be in a state where the cloud is enabled but there is no cloud model');

      // Check if any photons are hitting the cloud and either reflect them or let them pass through.
      this.checkForCloudPhotonInteractions();
    }
    super.stepModel(dt);
  }

  /**
   * Restore initial state.
   */
  reset() {
    this.photonCollection.reset();
    super.reset();
  }

  /**
   * Check for photon-cloud interactions and reflect photons off the cloud when appropriate.
   */
  checkForCloudPhotonInteractions() {
    // Get a list of all photons that could potentially reflect off of the cloud.
    const photonsThatCouldReflect = this.photonCollection.photons.filter(photon => photon.isVisible && photon.velocity.y < 0 && !this.photonsPassingThroughCloud.includes(photon) && this.cloud.modelShape.containsPoint(photon.positionProperty.value));

    // For each of these photons, decide whether to reflect it or add it to the pass-through list.  This is done
    // randomly based on the albedo of the cloud.  The albedo value is taken from "The impact of clouds on the
    // brightness of the night sky" by Tomasz Ściężor, then tweaked a little based on designer input.
    photonsThatCouldReflect.forEach(photon => {
      if (dotRandom.nextDouble() < 0.65) {
        // Reflect the photon by reversing the vertical component of its velocity.
        photon.velocity.y = -photon.velocity.y;

        // Make the reflection look a little more natural by changing the angle.  This rotates the velocity vector of
        // the reflected photon a little to the right if it reflected off the right side of the cloud and a little to
        // the left if reflected off the left side.
        const normalizedSignedDistanceFromCenter = (photon.positionProperty.value.x - this.cloud.position.x) * 2 / this.cloud.modelShape.bounds.width;
        const reflectionAngleAdjustment = -Math.sign(normalizedSignedDistanceFromCenter) * MIN_REFLECTION_ADJUSTMENT + -normalizedSignedDistanceFromCenter * (MAX_REFLECTION_ADJUSTMENT - MIN_REFLECTION_ADJUSTMENT);
        photon.velocity.rotate(reflectionAngleAdjustment);
      } else {
        // Add this photon to the pass-through list so that it can go all the way through the cloud without reflecting.
        this.photonsPassingThroughCloud.push(photon);
      }
    });

    // Remove any photons from the pass-through list that have fully transited the cloud.
    this.filterOutTransitedPhotons();
  }

  /**
   * Go through the list of photons that are transiting the cloud and remove any that have gone all the way through.
   * This exists as a performance optimization so that the array of transiting photons doesn't have to be re-allocated
   * at every step, thus reducing memory allocations.
   */
  filterOutTransitedPhotons() {
    let i = 0;
    let j = 0;
    while (i < this.photonsPassingThroughCloud.length) {
      const photon = this.photonsPassingThroughCloud[i];
      if (photon.positionProperty.value.y >= this.cloudBounds.minY) {
        this.photonsPassingThroughCloud[j++] = photon;
      }
      i++;
    }
    this.photonsPassingThroughCloud.length = j;
  }
}
greenhouseEffect.register('PhotonsModel', PhotonsModel);
export default PhotonsModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJkb3RSYW5kb20iLCJDb25jZW50cmF0aW9uTW9kZWwiLCJDb25jZW50cmF0aW9uQ29udHJvbE1vZGUiLCJDb25jZW50cmF0aW9uRGF0ZSIsIlBob3RvbkNvbGxlY3Rpb24iLCJncmVlbmhvdXNlRWZmZWN0IiwiTUFYX1JFRkxFQ1RJT05fQURKVVNUTUVOVCIsIk1hdGgiLCJQSSIsIk1JTl9SRUZMRUNUSU9OX0FESlVTVE1FTlQiLCJQaG90b25zTW9kZWwiLCJwaG90b25zUGFzc2luZ1Rocm91Z2hDbG91ZCIsImNvbnN0cnVjdG9yIiwidGFuZGVtIiwiZmx1eE1ldGVyUHJlc2VudCIsImdsYWNpZXJQcmVzZW50UHJvcGVydHkiLCJjb25jZW50cmF0aW9uQ29udHJvbE1vZGVQcm9wZXJ0eSIsImRhdGVQcm9wZXJ0eSIsImNvbmNlbnRyYXRpb25Db250cm9sTW9kZSIsImRhdGUiLCJCWV9EQVRFIiwiSUNFX0FHRSIsInBob3RvbkNvbGxlY3Rpb24iLCJzdW5FbmVyZ3lTb3VyY2UiLCJncm91bmRMYXllciIsImF0bW9zcGhlcmVMYXllcnMiLCJwaG90b25BYnNvcmJpbmdFbWl0dGluZ0xheWVyT3B0aW9ucyIsInBob3RvbkFic29ycHRpb25UaW1lIiwicGhvdG9uTWF4TGF0ZXJhbEp1bXBQcm9wb3J0aW9uIiwiYWJzb3JiYW5jZU11bHRpcGxpZXIiLCJjcmVhdGVUYW5kZW0iLCJhc3NlcnQiLCJjbG91ZCIsImNsb3VkQm91bmRzIiwibW9kZWxTaGFwZSIsImJvdW5kcyIsInN0ZXBNb2RlbCIsImR0Iiwic3RlcCIsImNsb3VkRW5hYmxlZFByb3BlcnR5IiwidmFsdWUiLCJjaGVja0ZvckNsb3VkUGhvdG9uSW50ZXJhY3Rpb25zIiwicmVzZXQiLCJwaG90b25zVGhhdENvdWxkUmVmbGVjdCIsInBob3RvbnMiLCJmaWx0ZXIiLCJwaG90b24iLCJpc1Zpc2libGUiLCJ2ZWxvY2l0eSIsInkiLCJpbmNsdWRlcyIsImNvbnRhaW5zUG9pbnQiLCJwb3NpdGlvblByb3BlcnR5IiwiZm9yRWFjaCIsIm5leHREb3VibGUiLCJub3JtYWxpemVkU2lnbmVkRGlzdGFuY2VGcm9tQ2VudGVyIiwieCIsInBvc2l0aW9uIiwid2lkdGgiLCJyZWZsZWN0aW9uQW5nbGVBZGp1c3RtZW50Iiwic2lnbiIsInJvdGF0ZSIsInB1c2giLCJmaWx0ZXJPdXRUcmFuc2l0ZWRQaG90b25zIiwiaSIsImoiLCJsZW5ndGgiLCJtaW5ZIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQaG90b25zTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogUGhvdG9uc01vZGVsIGlzIHRoZSBtYWluIG1vZGVsIGZvciB0aGUgXCJQaG90b25zXCIgc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgZG90UmFuZG9tIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9kb3RSYW5kb20uanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgQ29uY2VudHJhdGlvbk1vZGVsLCB7IENvbmNlbnRyYXRpb25Db250cm9sTW9kZSwgQ29uY2VudHJhdGlvbkRhdGUgfSBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvQ29uY2VudHJhdGlvbk1vZGVsLmpzJztcclxuaW1wb3J0IFBob3RvbiBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvUGhvdG9uLmpzJztcclxuaW1wb3J0IFBob3RvbkNvbGxlY3Rpb24gZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL1Bob3RvbkNvbGxlY3Rpb24uanMnO1xyXG5pbXBvcnQgZ3JlZW5ob3VzZUVmZmVjdCBmcm9tICcuLi8uLi9ncmVlbmhvdXNlRWZmZWN0LmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBNQVhfUkVGTEVDVElPTl9BREpVU1RNRU5UID0gTWF0aC5QSSAqIDAuMjU7IC8vIGVtcGlyaWNhbGx5IGRldGVybWluZWQgYnkgd2hhdCBsb29rZWQgZ29vZFxyXG5jb25zdCBNSU5fUkVGTEVDVElPTl9BREpVU1RNRU5UID0gTUFYX1JFRkxFQ1RJT05fQURKVVNUTUVOVCAqIDAuMjsgLy8gZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCBieSB3aGF0IGxvb2tlZCBnb29kXHJcblxyXG4vKipcclxuICogQGNvbnN0cnVjdG9yXHJcbiAqL1xyXG5jbGFzcyBQaG90b25zTW9kZWwgZXh0ZW5kcyBDb25jZW50cmF0aW9uTW9kZWwge1xyXG5cclxuICAvLyB0aGUgY29sbGVjdGlvbiBvZiB2aXNpYmxlIGFuZCBJUiBwaG90b25zIHRoYXQgbW92ZSBhcm91bmQgYW5kIGludGVyYWN0IHdpdGggdGhlIGdyb3VuZCBhbmQgYXRtb3NwaGVyZVxyXG4gIHB1YmxpYyByZWFkb25seSBwaG90b25Db2xsZWN0aW9uOiBQaG90b25Db2xsZWN0aW9uO1xyXG5cclxuICAvLyBzZXQgb2YgcGhvdG9ucyB0aGF0IGFyZSBwYXNzaW5nIHRocm91Z2ggdGhlIGNsb3VkXHJcbiAgcHJpdmF0ZSBwaG90b25zUGFzc2luZ1Rocm91Z2hDbG91ZDogUGhvdG9uW10gPSBbXTtcclxuXHJcbiAgLy8gYm91bmRzIG9mIHRoZSBjbG91ZCwgY2FsY3VsYXRlZCBkdXJpbmcgY29uc3RydWN0aW9uIHRvIHNhdmUgdGltZSBsYXRlclxyXG4gIHByaXZhdGUgcmVhZG9ubHkgY2xvdWRCb3VuZHM6IEJvdW5kczI7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggdGFuZGVtOiBUYW5kZW0gKSB7XHJcbiAgICBzdXBlciggdGFuZGVtLCB7IGZsdXhNZXRlclByZXNlbnQ6IHRydWUgfSApO1xyXG5cclxuICAgIC8vIGRlcml2ZWQgUHJvcGVydHkgdGhhdCBpcyB0cnVlIHdoZW4gYSBnbGFjaWVyIGlzIHByZXNlbnQgb24gdGhlIGdyb3VuZCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICBjb25zdCBnbGFjaWVyUHJlc2VudFByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgWyB0aGlzLmNvbmNlbnRyYXRpb25Db250cm9sTW9kZVByb3BlcnR5LCB0aGlzLmRhdGVQcm9wZXJ0eSBdLFxyXG4gICAgICAoIGNvbmNlbnRyYXRpb25Db250cm9sTW9kZSwgZGF0ZSApID0+IGNvbmNlbnRyYXRpb25Db250cm9sTW9kZSA9PT0gQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlLkJZX0RBVEUgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlID09PSBDb25jZW50cmF0aW9uRGF0ZS5JQ0VfQUdFXHJcbiAgICApO1xyXG5cclxuICAgIHRoaXMucGhvdG9uQ29sbGVjdGlvbiA9IG5ldyBQaG90b25Db2xsZWN0aW9uKCB0aGlzLnN1bkVuZXJneVNvdXJjZSwgdGhpcy5ncm91bmRMYXllciwgdGhpcy5hdG1vc3BoZXJlTGF5ZXJzLCB7XHJcbiAgICAgIHBob3RvbkFic29yYmluZ0VtaXR0aW5nTGF5ZXJPcHRpb25zOiB7XHJcbiAgICAgICAgcGhvdG9uQWJzb3JwdGlvblRpbWU6IDAsXHJcbiAgICAgICAgcGhvdG9uTWF4TGF0ZXJhbEp1bXBQcm9wb3J0aW9uOiAwLFxyXG4gICAgICAgIGFic29yYmFuY2VNdWx0aXBsaWVyOiAxMCAvLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHRvIGdpdmUgdXMgdGhlIGRlc2lyZWQgdmlzdWFsIGJlaGF2aW9yLCBhZGp1c3QgYXMgbmVlZGVkXHJcbiAgICAgIH0sXHJcbiAgICAgIGdsYWNpZXJQcmVzZW50UHJvcGVydHk6IGdsYWNpZXJQcmVzZW50UHJvcGVydHksXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Bob3RvbkNvbGxlY3Rpb24nIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmNsb3VkLCAnVGhlIGNsb3VkIHNob3VsZCBhbHdheXMgYmUgdHVybmVkIG9uIGluIHRoZSBQaG90b25zTW9kZWwnICk7XHJcbiAgICB0aGlzLmNsb3VkQm91bmRzID0gdGhpcy5jbG91ZCEubW9kZWxTaGFwZS5ib3VuZHM7XHJcblxyXG4gICAgLy8gVE9ETzogdGFuZGVtIGlzIGRvY3VtZW50ZWQgcmVhZG9ubHkgKHRob3VnaCBub3Qgd2l0aCBUeXBlU2NyaXB0KSAtIGlzIHRoaXMgY29ycmVjdD9cclxuICAgIHRoaXMudGFuZGVtID0gdGFuZGVtO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RlcCBmb3J3YXJkIGluIHRpbWUuXHJcbiAgICogQHBhcmFtIGR0IC0gZGVsdGEgdGltZSwgaW4gc2Vjb25kc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSBzdGVwTW9kZWwoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICB0aGlzLnBob3RvbkNvbGxlY3Rpb24uc3RlcCggZHQgKTtcclxuXHJcbiAgICAvLyBDaGVjayBmb3IgaW50ZXJhY3Rpb24gYmV0d2VlbiB0aGUgcGhvdG9ucyBhbmQgdGhlIGNsb3VkLiAgVGhpcyB3aWxsIGNhdXNlIHNvbWUgcGhvdG9ucyB0byByZWZsZWN0IG9mZiB0aGUgY2xvdWQuXHJcbiAgICBpZiAoIHRoaXMuY2xvdWRFbmFibGVkUHJvcGVydHkudmFsdWUgKSB7XHJcblxyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KFxyXG4gICAgICAgIHRoaXMuY2xvdWQsXHJcbiAgICAgICAgJ1RoZSBtb2RlbCBzaG91bGQgbmV2ZXIgYmUgaW4gYSBzdGF0ZSB3aGVyZSB0aGUgY2xvdWQgaXMgZW5hYmxlZCBidXQgdGhlcmUgaXMgbm8gY2xvdWQgbW9kZWwnXHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBDaGVjayBpZiBhbnkgcGhvdG9ucyBhcmUgaGl0dGluZyB0aGUgY2xvdWQgYW5kIGVpdGhlciByZWZsZWN0IHRoZW0gb3IgbGV0IHRoZW0gcGFzcyB0aHJvdWdoLlxyXG4gICAgICB0aGlzLmNoZWNrRm9yQ2xvdWRQaG90b25JbnRlcmFjdGlvbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICBzdXBlci5zdGVwTW9kZWwoIGR0ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0b3JlIGluaXRpYWwgc3RhdGUuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5waG90b25Db2xsZWN0aW9uLnJlc2V0KCk7XHJcbiAgICBzdXBlci5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2hlY2sgZm9yIHBob3Rvbi1jbG91ZCBpbnRlcmFjdGlvbnMgYW5kIHJlZmxlY3QgcGhvdG9ucyBvZmYgdGhlIGNsb3VkIHdoZW4gYXBwcm9wcmlhdGUuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGVja0ZvckNsb3VkUGhvdG9uSW50ZXJhY3Rpb25zKCk6IHZvaWQge1xyXG5cclxuICAgIC8vIEdldCBhIGxpc3Qgb2YgYWxsIHBob3RvbnMgdGhhdCBjb3VsZCBwb3RlbnRpYWxseSByZWZsZWN0IG9mZiBvZiB0aGUgY2xvdWQuXHJcbiAgICBjb25zdCBwaG90b25zVGhhdENvdWxkUmVmbGVjdCA9IHRoaXMucGhvdG9uQ29sbGVjdGlvbi5waG90b25zLmZpbHRlcihcclxuICAgICAgcGhvdG9uID0+IHBob3Rvbi5pc1Zpc2libGUgJiZcclxuICAgICAgICAgICAgICAgIHBob3Rvbi52ZWxvY2l0eS55IDwgMCAmJlxyXG4gICAgICAgICAgICAgICAgIXRoaXMucGhvdG9uc1Bhc3NpbmdUaHJvdWdoQ2xvdWQuaW5jbHVkZXMoIHBob3RvbiApICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3VkIS5tb2RlbFNoYXBlLmNvbnRhaW5zUG9pbnQoIHBob3Rvbi5wb3NpdGlvblByb3BlcnR5LnZhbHVlIClcclxuICAgICk7XHJcblxyXG4gICAgLy8gRm9yIGVhY2ggb2YgdGhlc2UgcGhvdG9ucywgZGVjaWRlIHdoZXRoZXIgdG8gcmVmbGVjdCBpdCBvciBhZGQgaXQgdG8gdGhlIHBhc3MtdGhyb3VnaCBsaXN0LiAgVGhpcyBpcyBkb25lXHJcbiAgICAvLyByYW5kb21seSBiYXNlZCBvbiB0aGUgYWxiZWRvIG9mIHRoZSBjbG91ZC4gIFRoZSBhbGJlZG8gdmFsdWUgaXMgdGFrZW4gZnJvbSBcIlRoZSBpbXBhY3Qgb2YgY2xvdWRzIG9uIHRoZVxyXG4gICAgLy8gYnJpZ2h0bmVzcyBvZiB0aGUgbmlnaHQgc2t5XCIgYnkgVG9tYXN6IMWaY2nEmcW8b3IsIHRoZW4gdHdlYWtlZCBhIGxpdHRsZSBiYXNlZCBvbiBkZXNpZ25lciBpbnB1dC5cclxuICAgIHBob3RvbnNUaGF0Q291bGRSZWZsZWN0LmZvckVhY2goIHBob3RvbiA9PiB7XHJcbiAgICAgIGlmICggZG90UmFuZG9tLm5leHREb3VibGUoKSA8IDAuNjUgKSB7XHJcblxyXG4gICAgICAgIC8vIFJlZmxlY3QgdGhlIHBob3RvbiBieSByZXZlcnNpbmcgdGhlIHZlcnRpY2FsIGNvbXBvbmVudCBvZiBpdHMgdmVsb2NpdHkuXHJcbiAgICAgICAgcGhvdG9uLnZlbG9jaXR5LnkgPSAtcGhvdG9uLnZlbG9jaXR5Lnk7XHJcblxyXG4gICAgICAgIC8vIE1ha2UgdGhlIHJlZmxlY3Rpb24gbG9vayBhIGxpdHRsZSBtb3JlIG5hdHVyYWwgYnkgY2hhbmdpbmcgdGhlIGFuZ2xlLiAgVGhpcyByb3RhdGVzIHRoZSB2ZWxvY2l0eSB2ZWN0b3Igb2ZcclxuICAgICAgICAvLyB0aGUgcmVmbGVjdGVkIHBob3RvbiBhIGxpdHRsZSB0byB0aGUgcmlnaHQgaWYgaXQgcmVmbGVjdGVkIG9mZiB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgY2xvdWQgYW5kIGEgbGl0dGxlIHRvXHJcbiAgICAgICAgLy8gdGhlIGxlZnQgaWYgcmVmbGVjdGVkIG9mZiB0aGUgbGVmdCBzaWRlLlxyXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRTaWduZWREaXN0YW5jZUZyb21DZW50ZXIgPSAoIHBob3Rvbi5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggLSB0aGlzLmNsb3VkIS5wb3NpdGlvbi54ICkgKiAyIC9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG91ZCEubW9kZWxTaGFwZS5ib3VuZHMud2lkdGg7XHJcbiAgICAgICAgY29uc3QgcmVmbGVjdGlvbkFuZ2xlQWRqdXN0bWVudCA9IC1NYXRoLnNpZ24oIG5vcm1hbGl6ZWRTaWduZWREaXN0YW5jZUZyb21DZW50ZXIgKSAqIE1JTl9SRUZMRUNUSU9OX0FESlVTVE1FTlQgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtbm9ybWFsaXplZFNpZ25lZERpc3RhbmNlRnJvbUNlbnRlciAqXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICggTUFYX1JFRkxFQ1RJT05fQURKVVNUTUVOVCAtIE1JTl9SRUZMRUNUSU9OX0FESlVTVE1FTlQgKTtcclxuICAgICAgICBwaG90b24udmVsb2NpdHkucm90YXRlKCByZWZsZWN0aW9uQW5nbGVBZGp1c3RtZW50ICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgIC8vIEFkZCB0aGlzIHBob3RvbiB0byB0aGUgcGFzcy10aHJvdWdoIGxpc3Qgc28gdGhhdCBpdCBjYW4gZ28gYWxsIHRoZSB3YXkgdGhyb3VnaCB0aGUgY2xvdWQgd2l0aG91dCByZWZsZWN0aW5nLlxyXG4gICAgICAgIHRoaXMucGhvdG9uc1Bhc3NpbmdUaHJvdWdoQ2xvdWQucHVzaCggcGhvdG9uICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBSZW1vdmUgYW55IHBob3RvbnMgZnJvbSB0aGUgcGFzcy10aHJvdWdoIGxpc3QgdGhhdCBoYXZlIGZ1bGx5IHRyYW5zaXRlZCB0aGUgY2xvdWQuXHJcbiAgICB0aGlzLmZpbHRlck91dFRyYW5zaXRlZFBob3RvbnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdvIHRocm91Z2ggdGhlIGxpc3Qgb2YgcGhvdG9ucyB0aGF0IGFyZSB0cmFuc2l0aW5nIHRoZSBjbG91ZCBhbmQgcmVtb3ZlIGFueSB0aGF0IGhhdmUgZ29uZSBhbGwgdGhlIHdheSB0aHJvdWdoLlxyXG4gICAqIFRoaXMgZXhpc3RzIGFzIGEgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uIHNvIHRoYXQgdGhlIGFycmF5IG9mIHRyYW5zaXRpbmcgcGhvdG9ucyBkb2Vzbid0IGhhdmUgdG8gYmUgcmUtYWxsb2NhdGVkXHJcbiAgICogYXQgZXZlcnkgc3RlcCwgdGh1cyByZWR1Y2luZyBtZW1vcnkgYWxsb2NhdGlvbnMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaWx0ZXJPdXRUcmFuc2l0ZWRQaG90b25zKCk6IHZvaWQge1xyXG4gICAgbGV0IGkgPSAwO1xyXG4gICAgbGV0IGogPSAwO1xyXG4gICAgd2hpbGUgKCBpIDwgdGhpcy5waG90b25zUGFzc2luZ1Rocm91Z2hDbG91ZC5sZW5ndGggKSB7XHJcbiAgICAgIGNvbnN0IHBob3RvbiA9IHRoaXMucGhvdG9uc1Bhc3NpbmdUaHJvdWdoQ2xvdWRbIGkgXTtcclxuICAgICAgaWYgKCBwaG90b24ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55ID49IHRoaXMuY2xvdWRCb3VuZHMubWluWSApIHtcclxuICAgICAgICB0aGlzLnBob3RvbnNQYXNzaW5nVGhyb3VnaENsb3VkWyBqKysgXSA9IHBob3RvbjtcclxuICAgICAgfVxyXG4gICAgICBpKys7XHJcbiAgICB9XHJcbiAgICB0aGlzLnBob3RvbnNQYXNzaW5nVGhyb3VnaENsb3VkLmxlbmd0aCA9IGo7XHJcbiAgfVxyXG59XHJcblxyXG5ncmVlbmhvdXNlRWZmZWN0LnJlZ2lzdGVyKCAnUGhvdG9uc01vZGVsJywgUGhvdG9uc01vZGVsICk7XHJcbmV4cG9ydCBkZWZhdWx0IFBob3RvbnNNb2RlbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBRXBFLE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUFFdkQsT0FBT0Msa0JBQWtCLElBQUlDLHdCQUF3QixFQUFFQyxpQkFBaUIsUUFBUSwwQ0FBMEM7QUFFMUgsT0FBT0MsZ0JBQWdCLE1BQU0sd0NBQXdDO0FBQ3JFLE9BQU9DLGdCQUFnQixNQUFNLDJCQUEyQjs7QUFFeEQ7QUFDQSxNQUFNQyx5QkFBeUIsR0FBR0MsSUFBSSxDQUFDQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDbEQsTUFBTUMseUJBQXlCLEdBQUdILHlCQUF5QixHQUFHLEdBQUcsQ0FBQyxDQUFDOztBQUVuRTtBQUNBO0FBQ0E7QUFDQSxNQUFNSSxZQUFZLFNBQVNULGtCQUFrQixDQUFDO0VBRTVDOztFQUdBO0VBQ1FVLDBCQUEwQixHQUFhLEVBQUU7O0VBRWpEOztFQUdPQyxXQUFXQSxDQUFFQyxNQUFjLEVBQUc7SUFDbkMsS0FBSyxDQUFFQSxNQUFNLEVBQUU7TUFBRUMsZ0JBQWdCLEVBQUU7SUFBSyxDQUFFLENBQUM7O0lBRTNDO0lBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsSUFBSWhCLGVBQWUsQ0FDaEQsQ0FBRSxJQUFJLENBQUNpQixnQ0FBZ0MsRUFBRSxJQUFJLENBQUNDLFlBQVksQ0FBRSxFQUM1RCxDQUFFQyx3QkFBd0IsRUFBRUMsSUFBSSxLQUFNRCx3QkFBd0IsS0FBS2hCLHdCQUF3QixDQUFDa0IsT0FBTyxJQUM3REQsSUFBSSxLQUFLaEIsaUJB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