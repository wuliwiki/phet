// Copyright 2021-2022, University of Colorado Boulder

/**
 * ConcentrationModel is a GreenhouseEffectModel that adds in the ability to set the concentration of greenhouse gases
 * in the atmosphere and adjusts the attributes of the atmospheric layers accordingly.
 *
 * @author Jesse Greenberg (PhET Interactive Simulations)
 * @author John Blanco (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Range from '../../../../dot/js/Range.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Enumeration from '../../../../phet-core/js/Enumeration.js';
import EnumerationValue from '../../../../phet-core/js/EnumerationValue.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import greenhouseEffect from '../../greenhouseEffect.js';
import Cloud from './Cloud.js';
import GroundLayer from './GroundLayer.js';
import LayersModel from './LayersModel.js';

// constants
const SCALE_HEIGHT_OF_ATMOSPHERE = 8400; // in meters, taken from a Wikipedia article
const CLOUD_WIDTH = 18000; // in meters, empirically determined to look good

// In the 1/19/2022 design meeting, we decided that when the cloud is on, the total amount of reflected light should go
// up by 10%.  Note that this DOESN'T mean that we can just use 0.1 as the total target reflectance, because when it is
// on it reduces the amount of light reaching the ground, so the calculation is more complex than that.  The following
// calculation assumes that the ground with no clouds reflects 20% of incident light.
const CLOUD_VISIBLE_REFLECTIVITY = 0.125 * LayersModel.SUNLIGHT_SPAN.width / CLOUD_WIDTH;
assert && assert(CLOUD_VISIBLE_REFLECTIVITY <= 1, `invalid reflectivity value for cloud: ${CLOUD_VISIBLE_REFLECTIVITY}`);

// An enumeration for how concentration can be controlled, either by direct value or by selecting a value for Earth's
// concentration at a particular date.
class ConcentrationControlMode extends EnumerationValue {
  static BY_VALUE = new ConcentrationControlMode();
  static BY_DATE = new ConcentrationControlMode();

  // Gets a list of keys, values and mapping between them.  For use in EnumerationProperty and PhET-iO
  static enumeration = new Enumeration(ConcentrationControlMode, {
    phetioDocumentation: 'Describes the mode by which concentration is controlled, either by date or by value.'
  });
}

// dates with recorded values of greenhouse concentration
class ConcentrationDate extends EnumerationValue {
  static ICE_AGE = new ConcentrationDate();
  static SEVENTEEN_FIFTY = new ConcentrationDate();
  static NINETEEN_FIFTY = new ConcentrationDate();
  static TWENTY_TWENTY = new ConcentrationDate();

  // Gets a list of keys, values and mapping between them.  For use in EnumerationProperty and PhET-iO
  static enumeration = new Enumeration(ConcentrationDate, {
    phetioDocumentation: 'Various time periods or years that can be used to define what greenhouse concentration value is ued.'
  });
}

// Map of dates to concentration values.  These values were determined empirically to make the equilibrium temperature
// reached in the sim match the values specified in the design doc.
const DATE_TO_CONCENTRATION_MAP = new Map([[ConcentrationDate.ICE_AGE, 0.625], [ConcentrationDate.SEVENTEEN_FIFTY, 0.7147], [ConcentrationDate.NINETEEN_FIFTY, 0.7182], [ConcentrationDate.TWENTY_TWENTY, 0.7446]]);
const CONCENTRATION_RANGE = new Range(0, 1);
class ConcentrationModel extends LayersModel {
  // How the concentration can be changed, either by directly modifying the value or by selecting a value for Earth's
  // greenhouse gas concentration at a particular date.

  // selected date that, depending on the mode, may define the value used for greenhouse gas concentration

  // Property for the concentration when the concentration is controlled directly by value

  // The actual value of concentration for the model, depending on how the concentration is to be controlled.

  // A property that determines whether the reflective cloud is enabled.

  /**
   * @param tandem
   * @param [options]
   */
  constructor(tandem, options) {
    super(tandem, options);
    this.dateProperty = new EnumerationProperty(ConcentrationDate.SEVENTEEN_FIFTY, {
      tandem: tandem.createTandem('dateProperty')
    });
    this.manuallyControlledConcentrationProperty = new NumberProperty(0.5, {
      range: CONCENTRATION_RANGE,
      tandem: tandem.createTandem('manuallyControlledConcentrationProperty'),
      phetioDocumentation: 'The concentration value as set by the slider when in \'by value\' mode.'
    });
    this.concentrationControlModeProperty = new EnumerationProperty(ConcentrationControlMode.BY_VALUE, {
      tandem: tandem.createTandem('concentrationControlModeProperty')
    });
    this.concentrationProperty = new DerivedProperty([this.concentrationControlModeProperty, this.dateProperty, this.manuallyControlledConcentrationProperty], (concentrationControl, date, manuallyControlledConcentration) => {
      return concentrationControl === ConcentrationControlMode.BY_VALUE ? manuallyControlledConcentration : DATE_TO_CONCENTRATION_MAP.get(date);
    }, {
      tandem: tandem.createTandem('concentrationProperty'),
      phetioValueType: NumberIO,
      phetioDocumentation: 'The concentration value being used in the model, set via the slider or the date control.'
    });

    // Hook up the concentration to the layers created in the parent class.
    this.concentrationProperty.link(concentration => {
      // Map the normalized concentration to a value for the layer absorption proportion.  The higher layers absorb
      // less.  This numerical mapping is very important to the correct operation of the simulation with respect to
      // temperature, and was empirically adjusted to make the concentration slider correspond to the temperatures in a
      // linear fashion.
      this.atmosphereLayers.forEach(atmosphereLayer => {
        // The multiplier used in this calculation was empirically determined to make the model equilibrate at the max
        // temperature value defined in the spec (295 K as of this writing).  This may need to change if the number of
        // layers is adjusted or other changes are made to the model.
        const proportionToAbsorbAtSeaLevel = 0.85 * concentration;

        // Adjust the energy absorption amounts for each of the layers based on their altitude.  The calculation uses
        // the barometric formula, see https://en.wikipedia.org/wiki/Barometric_formula.
        const altitudeProportionFactor = Math.exp(-atmosphereLayer.altitude / SCALE_HEIGHT_OF_ATMOSPHERE);
        atmosphereLayer.energyAbsorptionProportionProperty.set(proportionToAbsorbAtSeaLevel * altitudeProportionFactor);
      });
    });
    Multilink.multilink([this.dateProperty, this.concentrationControlModeProperty], (date, concentrationControlMode) => {
      if (date === ConcentrationDate.ICE_AGE && concentrationControlMode === ConcentrationControlMode.BY_DATE) {
        // Set the albedo to correspond to the ice age.
        this.groundLayer.albedoProperty.set(GroundLayer.PARTIALLY_GLACIATED_LAND_ALBEDO);
      } else {
        // Set the albedo to a non-ice-age value.
        this.groundLayer.albedoProperty.set(GroundLayer.GREEN_MEADOW_ALBEDO);
      }
    });
    this.cloudEnabledProperty = new BooleanProperty(true, {
      tandem: tandem.createTandem('cloudEnabledProperty')
    });

    // When switching from manual concentration control mode to date-based concentration mode, the cloud must be turned
    // on if it isn't already.  Then, when switching back to manual concentration mode, the cloud must be restored to
    // whatever the state was when the user switched away.  That's what the following code does.
    let cloudEnabledInManualConcentrationMode = this.cloudEnabledProperty.value;
    this.concentrationControlModeProperty.lazyLink(concentrationControlMode => {
      if (concentrationControlMode === ConcentrationControlMode.BY_DATE) {
        cloudEnabledInManualConcentrationMode = this.cloudEnabledProperty.value;
        this.cloudEnabledProperty.set(true);
      } else if (concentrationControlMode === ConcentrationControlMode.BY_VALUE) {
        this.cloudEnabledProperty.set(cloudEnabledInManualConcentrationMode);
      }
    });

    // Create the one cloud that can be shown.  The position and size of the cloud were chosen to look good in the view
    // and can be adjusted as needed.
    this.cloud = new Cloud(new Vector2(-16000, 20000), CLOUD_WIDTH, 4000, {
      topVisibleLightReflectivity: CLOUD_VISIBLE_REFLECTIVITY,
      // phetio
      tandem: tandem.createTandem('cloud')
    });

    // Update the enabled state of the cloud.
    this.cloudEnabledProperty.link(cloudEnabled => {
      this.cloud && this.cloud.enabledProperty.set(cloudEnabled);
    });
  }

  /**
   * Resets all aspects of the model.
   */
  reset() {
    this.concentrationControlModeProperty.reset();
    this.dateProperty.reset();
    this.manuallyControlledConcentrationProperty.reset();
    this.cloudEnabledProperty.reset();
    super.reset();
  }

  // statics
  static CONCENTRATION_RANGE = CONCENTRATION_RANGE;
  static DATE_CONCENTRATION_RANGE = new Range(Array.from(DATE_TO_CONCENTRATION_MAP.values()).reduce((minSoFar, currentValue) => Math.min(minSoFar, currentValue), Number.POSITIVE_INFINITY), Array.from(DATE_TO_CONCENTRATION_MAP.values()).reduce((maxSoFar, currentValue) => Math.max(maxSoFar, currentValue), Number.NEGATIVE_INFINITY));
  static getConcentrationForDate(date) {
    assert && assert(DATE_TO_CONCENTRATION_MAP.has(date), 'no concentration for the provided date');
    const concentration = DATE_TO_CONCENTRATION_MAP.get(date);
    return concentration === undefined ? 0 : concentration;
  }
}
export { ConcentrationControlMode };
export { ConcentrationDate };
greenhouseEffect.register('ConcentrationModel', ConcentrationModel);
export default ConcentrationModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJFbnVtZXJhdGlvblByb3BlcnR5IiwiTXVsdGlsaW5rIiwiTnVtYmVyUHJvcGVydHkiLCJSYW5nZSIsIlZlY3RvcjIiLCJFbnVtZXJhdGlvbiIsIkVudW1lcmF0aW9uVmFsdWUiLCJOdW1iZXJJTyIsImdyZWVuaG91c2VFZmZlY3QiLCJDbG91ZCIsIkdyb3VuZExheWVyIiwiTGF5ZXJzTW9kZWwiLCJTQ0FMRV9IRUlHSFRfT0ZfQVRNT1NQSEVSRSIsIkNMT1VEX1dJRFRIIiwiQ0xPVURfVklTSUJMRV9SRUZMRUNUSVZJVFkiLCJTVU5MSUdIVF9TUEFOIiwid2lkdGgiLCJhc3NlcnQiLCJDb25jZW50cmF0aW9uQ29udHJvbE1vZGUiLCJCWV9WQUxVRSIsIkJZX0RBVEUiLCJlbnVtZXJhdGlvbiIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJDb25jZW50cmF0aW9uRGF0ZSIsIklDRV9BR0UiLCJTRVZFTlRFRU5fRklGVFkiLCJOSU5FVEVFTl9GSUZUWSIsIlRXRU5UWV9UV0VOVFkiLCJEQVRFX1RPX0NPTkNFTlRSQVRJT05fTUFQIiwiTWFwIiwiQ09OQ0VOVFJBVElPTl9SQU5HRSIsIkNvbmNlbnRyYXRpb25Nb2RlbCIsImNvbnN0cnVjdG9yIiwidGFuZGVtIiwib3B0aW9ucyIsImRhdGVQcm9wZXJ0eSIsImNyZWF0ZVRhbmRlbSIsIm1hbnVhbGx5Q29udHJvbGxlZENvbmNlbnRyYXRpb25Qcm9wZXJ0eSIsInJhbmdlIiwiY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlUHJvcGVydHkiLCJjb25jZW50cmF0aW9uUHJvcGVydHkiLCJjb25jZW50cmF0aW9uQ29udHJvbCIsImRhdGUiLCJtYW51YWxseUNvbnRyb2xsZWRDb25jZW50cmF0aW9uIiwiZ2V0IiwicGhldGlvVmFsdWVUeXBlIiwibGluayIsImNvbmNlbnRyYXRpb24iLCJhdG1vc3BoZXJlTGF5ZXJzIiwiZm9yRWFjaCIsImF0bW9zcGhlcmVMYXllciIsInByb3BvcnRpb25Ub0Fic29yYkF0U2VhTGV2ZWwiLCJhbHRpdHVkZVByb3BvcnRpb25GYWN0b3IiLCJNYXRoIiwiZXhwIiwiYWx0aXR1ZGUiLCJlbmVyZ3lBYnNvcnB0aW9uUHJvcG9ydGlvblByb3BlcnR5Iiwic2V0IiwibXVsdGlsaW5rIiwiY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlIiwiZ3JvdW5kTGF5ZXIiLCJhbGJlZG9Qcm9wZXJ0eSIsIlBBUlRJQUxMWV9HTEFDSUFURURfTEFORF9BTEJFRE8iLCJHUkVFTl9NRUFET1dfQUxCRURPIiwiY2xvdWRFbmFibGVkUHJvcGVydHkiLCJjbG91ZEVuYWJsZWRJbk1hbnVhbENvbmNlbnRyYXRpb25Nb2RlIiwidmFsdWUiLCJsYXp5TGluayIsImNsb3VkIiwidG9wVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5IiwiY2xvdWRFbmFibGVkIiwiZW5hYmxlZFByb3BlcnR5IiwicmVzZXQiLCJEQVRFX0NPTkNFTlRSQVRJT05fUkFOR0UiLCJBcnJheSIsImZyb20iLCJ2YWx1ZXMiLCJyZWR1Y2UiLCJtaW5Tb0ZhciIsImN1cnJlbnRWYWx1ZSIsIm1pbiIsIk51bWJlciIsIlBPU0lUSVZFX0lORklOSVRZIiwibWF4U29GYXIiLCJtYXgiLCJORUdBVElWRV9JTkZJTklUWSIsImdldENvbmNlbnRyYXRpb25Gb3JEYXRlIiwiaGFzIiwidW5kZWZpbmVkIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDb25jZW50cmF0aW9uTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQ29uY2VudHJhdGlvbk1vZGVsIGlzIGEgR3JlZW5ob3VzZUVmZmVjdE1vZGVsIHRoYXQgYWRkcyBpbiB0aGUgYWJpbGl0eSB0byBzZXQgdGhlIGNvbmNlbnRyYXRpb24gb2YgZ3JlZW5ob3VzZSBnYXNlc1xyXG4gKiBpbiB0aGUgYXRtb3NwaGVyZSBhbmQgYWRqdXN0cyB0aGUgYXR0cmlidXRlcyBvZiB0aGUgYXRtb3NwaGVyaWMgbGF5ZXJzIGFjY29yZGluZ2x5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBKb2huIEJsYW5jbyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW51bWVyYXRpb25Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBOdW1iZXJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL051bWJlclByb3BlcnR5LmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IEVudW1lcmF0aW9uIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9FbnVtZXJhdGlvbi5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvblZhbHVlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9FbnVtZXJhdGlvblZhbHVlLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IE51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdW1iZXJJTy5qcyc7XHJcbmltcG9ydCBncmVlbmhvdXNlRWZmZWN0IGZyb20gJy4uLy4uL2dyZWVuaG91c2VFZmZlY3QuanMnO1xyXG5pbXBvcnQgQ2xvdWQgZnJvbSAnLi9DbG91ZC5qcyc7XHJcbmltcG9ydCBHcm91bmRMYXllciBmcm9tICcuL0dyb3VuZExheWVyLmpzJztcclxuaW1wb3J0IExheWVyc01vZGVsLCB7IExheWVyc01vZGVsT3B0aW9ucyB9IGZyb20gJy4vTGF5ZXJzTW9kZWwuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFNDQUxFX0hFSUdIVF9PRl9BVE1PU1BIRVJFID0gODQwMDsgLy8gaW4gbWV0ZXJzLCB0YWtlbiBmcm9tIGEgV2lraXBlZGlhIGFydGljbGVcclxuY29uc3QgQ0xPVURfV0lEVEggPSAxODAwMDsgLy8gaW4gbWV0ZXJzLCBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHRvIGxvb2sgZ29vZFxyXG5cclxuLy8gSW4gdGhlIDEvMTkvMjAyMiBkZXNpZ24gbWVldGluZywgd2UgZGVjaWRlZCB0aGF0IHdoZW4gdGhlIGNsb3VkIGlzIG9uLCB0aGUgdG90YWwgYW1vdW50IG9mIHJlZmxlY3RlZCBsaWdodCBzaG91bGQgZ29cclxuLy8gdXAgYnkgMTAlLiAgTm90ZSB0aGF0IHRoaXMgRE9FU04nVCBtZWFuIHRoYXQgd2UgY2FuIGp1c3QgdXNlIDAuMSBhcyB0aGUgdG90YWwgdGFyZ2V0IHJlZmxlY3RhbmNlLCBiZWNhdXNlIHdoZW4gaXQgaXNcclxuLy8gb24gaXQgcmVkdWNlcyB0aGUgYW1vdW50IG9mIGxpZ2h0IHJlYWNoaW5nIHRoZSBncm91bmQsIHNvIHRoZSBjYWxjdWxhdGlvbiBpcyBtb3JlIGNvbXBsZXggdGhhbiB0aGF0LiAgVGhlIGZvbGxvd2luZ1xyXG4vLyBjYWxjdWxhdGlvbiBhc3N1bWVzIHRoYXQgdGhlIGdyb3VuZCB3aXRoIG5vIGNsb3VkcyByZWZsZWN0cyAyMCUgb2YgaW5jaWRlbnQgbGlnaHQuXHJcbmNvbnN0IENMT1VEX1ZJU0lCTEVfUkVGTEVDVElWSVRZID0gMC4xMjUgKiBMYXllcnNNb2RlbC5TVU5MSUdIVF9TUEFOLndpZHRoIC8gQ0xPVURfV0lEVEg7XHJcbmFzc2VydCAmJiBhc3NlcnQoIENMT1VEX1ZJU0lCTEVfUkVGTEVDVElWSVRZIDw9IDEsIGBpbnZhbGlkIHJlZmxlY3Rpdml0eSB2YWx1ZSBmb3IgY2xvdWQ6ICR7Q0xPVURfVklTSUJMRV9SRUZMRUNUSVZJVFl9YCApO1xyXG5cclxuLy8gQW4gZW51bWVyYXRpb24gZm9yIGhvdyBjb25jZW50cmF0aW9uIGNhbiBiZSBjb250cm9sbGVkLCBlaXRoZXIgYnkgZGlyZWN0IHZhbHVlIG9yIGJ5IHNlbGVjdGluZyBhIHZhbHVlIGZvciBFYXJ0aCdzXHJcbi8vIGNvbmNlbnRyYXRpb24gYXQgYSBwYXJ0aWN1bGFyIGRhdGUuXHJcbmNsYXNzIENvbmNlbnRyYXRpb25Db250cm9sTW9kZSBleHRlbmRzIEVudW1lcmF0aW9uVmFsdWUge1xyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgQllfVkFMVUUgPSBuZXcgQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlKCk7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBCWV9EQVRFID0gbmV3IENvbmNlbnRyYXRpb25Db250cm9sTW9kZSgpO1xyXG5cclxuICAvLyBHZXRzIGEgbGlzdCBvZiBrZXlzLCB2YWx1ZXMgYW5kIG1hcHBpbmcgYmV0d2VlbiB0aGVtLiAgRm9yIHVzZSBpbiBFbnVtZXJhdGlvblByb3BlcnR5IGFuZCBQaEVULWlPXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBlbnVtZXJhdGlvbiA9IG5ldyBFbnVtZXJhdGlvbiggQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlLCB7XHJcbiAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnRGVzY3JpYmVzIHRoZSBtb2RlIGJ5IHdoaWNoIGNvbmNlbnRyYXRpb24gaXMgY29udHJvbGxlZCwgZWl0aGVyIGJ5IGRhdGUgb3IgYnkgdmFsdWUuJ1xyXG4gIH0gKTtcclxufVxyXG5cclxuLy8gZGF0ZXMgd2l0aCByZWNvcmRlZCB2YWx1ZXMgb2YgZ3JlZW5ob3VzZSBjb25jZW50cmF0aW9uXHJcbmNsYXNzIENvbmNlbnRyYXRpb25EYXRlIGV4dGVuZHMgRW51bWVyYXRpb25WYWx1ZSB7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBJQ0VfQUdFID0gbmV3IENvbmNlbnRyYXRpb25EYXRlKCk7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBTRVZFTlRFRU5fRklGVFkgPSBuZXcgQ29uY2VudHJhdGlvbkRhdGUoKTtcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IE5JTkVURUVOX0ZJRlRZID0gbmV3IENvbmNlbnRyYXRpb25EYXRlKCk7XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBUV0VOVFlfVFdFTlRZID0gbmV3IENvbmNlbnRyYXRpb25EYXRlKCk7XHJcblxyXG4gIC8vIEdldHMgYSBsaXN0IG9mIGtleXMsIHZhbHVlcyBhbmQgbWFwcGluZyBiZXR3ZWVuIHRoZW0uICBGb3IgdXNlIGluIEVudW1lcmF0aW9uUHJvcGVydHkgYW5kIFBoRVQtaU9cclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IGVudW1lcmF0aW9uID0gbmV3IEVudW1lcmF0aW9uKCBDb25jZW50cmF0aW9uRGF0ZSwge1xyXG4gICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1ZhcmlvdXMgdGltZSBwZXJpb2RzIG9yIHllYXJzIHRoYXQgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIHdoYXQgZ3JlZW5ob3VzZSBjb25jZW50cmF0aW9uIHZhbHVlIGlzIHVlZC4nXHJcbiAgfSApO1xyXG59XHJcblxyXG4vLyBNYXAgb2YgZGF0ZXMgdG8gY29uY2VudHJhdGlvbiB2YWx1ZXMuICBUaGVzZSB2YWx1ZXMgd2VyZSBkZXRlcm1pbmVkIGVtcGlyaWNhbGx5IHRvIG1ha2UgdGhlIGVxdWlsaWJyaXVtIHRlbXBlcmF0dXJlXHJcbi8vIHJlYWNoZWQgaW4gdGhlIHNpbSBtYXRjaCB0aGUgdmFsdWVzIHNwZWNpZmllZCBpbiB0aGUgZGVzaWduIGRvYy5cclxuY29uc3QgREFURV9UT19DT05DRU5UUkFUSU9OX01BUCA9IG5ldyBNYXA8Q29uY2VudHJhdGlvbkRhdGUsIG51bWJlcj4oIFtcclxuICBbIENvbmNlbnRyYXRpb25EYXRlLklDRV9BR0UsIDAuNjI1IF0sXHJcbiAgWyBDb25jZW50cmF0aW9uRGF0ZS5TRVZFTlRFRU5fRklGVFksIDAuNzE0NyBdLFxyXG4gIFsgQ29uY2VudHJhdGlvbkRhdGUuTklORVRFRU5fRklGVFksIDAuNzE4MiBdLFxyXG4gIFsgQ29uY2VudHJhdGlvbkRhdGUuVFdFTlRZX1RXRU5UWSwgMC43NDQ2IF1cclxuXSApO1xyXG5jb25zdCBDT05DRU5UUkFUSU9OX1JBTkdFOiBSYW5nZSA9IG5ldyBSYW5nZSggMCwgMSApO1xyXG5cclxuY2xhc3MgQ29uY2VudHJhdGlvbk1vZGVsIGV4dGVuZHMgTGF5ZXJzTW9kZWwge1xyXG5cclxuICAvLyBIb3cgdGhlIGNvbmNlbnRyYXRpb24gY2FuIGJlIGNoYW5nZWQsIGVpdGhlciBieSBkaXJlY3RseSBtb2RpZnlpbmcgdGhlIHZhbHVlIG9yIGJ5IHNlbGVjdGluZyBhIHZhbHVlIGZvciBFYXJ0aCdzXHJcbiAgLy8gZ3JlZW5ob3VzZSBnYXMgY29uY2VudHJhdGlvbiBhdCBhIHBhcnRpY3VsYXIgZGF0ZS5cclxuICBwdWJsaWMgcmVhZG9ubHkgY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8Q29uY2VudHJhdGlvbkNvbnRyb2xNb2RlPjtcclxuXHJcbiAgLy8gc2VsZWN0ZWQgZGF0ZSB0aGF0LCBkZXBlbmRpbmcgb24gdGhlIG1vZGUsIG1heSBkZWZpbmUgdGhlIHZhbHVlIHVzZWQgZm9yIGdyZWVuaG91c2UgZ2FzIGNvbmNlbnRyYXRpb25cclxuICBwdWJsaWMgcmVhZG9ubHkgZGF0ZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PENvbmNlbnRyYXRpb25EYXRlPjtcclxuXHJcbiAgLy8gUHJvcGVydHkgZm9yIHRoZSBjb25jZW50cmF0aW9uIHdoZW4gdGhlIGNvbmNlbnRyYXRpb24gaXMgY29udHJvbGxlZCBkaXJlY3RseSBieSB2YWx1ZVxyXG4gIHB1YmxpYyByZWFkb25seSBtYW51YWxseUNvbnRyb2xsZWRDb25jZW50cmF0aW9uUHJvcGVydHk6IE51bWJlclByb3BlcnR5O1xyXG5cclxuICAvLyBUaGUgYWN0dWFsIHZhbHVlIG9mIGNvbmNlbnRyYXRpb24gZm9yIHRoZSBtb2RlbCwgZGVwZW5kaW5nIG9uIGhvdyB0aGUgY29uY2VudHJhdGlvbiBpcyB0byBiZSBjb250cm9sbGVkLlxyXG4gIHB1YmxpYyByZWFkb25seSBjb25jZW50cmF0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIEEgcHJvcGVydHkgdGhhdCBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHJlZmxlY3RpdmUgY2xvdWQgaXMgZW5hYmxlZC5cclxuICBwdWJsaWMgcmVhZG9ubHkgY2xvdWRFbmFibGVkUHJvcGVydHk6IEJvb2xlYW5Qcm9wZXJ0eTtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHRhbmRlbVxyXG4gICAqIEBwYXJhbSBbb3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHRhbmRlbTogVGFuZGVtLCBvcHRpb25zPzogTGF5ZXJzTW9kZWxPcHRpb25zICkge1xyXG4gICAgc3VwZXIoIHRhbmRlbSwgb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuZGF0ZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIENvbmNlbnRyYXRpb25EYXRlLlNFVkVOVEVFTl9GSUZUWSwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdkYXRlUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMubWFudWFsbHlDb250cm9sbGVkQ29uY2VudHJhdGlvblByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwLjUsIHtcclxuICAgICAgcmFuZ2U6IENPTkNFTlRSQVRJT05fUkFOR0UsXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ21hbnVhbGx5Q29udHJvbGxlZENvbmNlbnRyYXRpb25Qcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1RoZSBjb25jZW50cmF0aW9uIHZhbHVlIGFzIHNldCBieSB0aGUgc2xpZGVyIHdoZW4gaW4gXFwnYnkgdmFsdWVcXCcgbW9kZS4nXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmNvbmNlbnRyYXRpb25Db250cm9sTW9kZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoXHJcbiAgICAgIENvbmNlbnRyYXRpb25Db250cm9sTW9kZS5CWV9WQUxVRSxcclxuICAgICAgeyB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdjb25jZW50cmF0aW9uQ29udHJvbE1vZGVQcm9wZXJ0eScgKSB9XHJcbiAgICApO1xyXG4gICAgdGhpcy5jb25jZW50cmF0aW9uUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICBbIHRoaXMuY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlUHJvcGVydHksIHRoaXMuZGF0ZVByb3BlcnR5LCB0aGlzLm1hbnVhbGx5Q29udHJvbGxlZENvbmNlbnRyYXRpb25Qcm9wZXJ0eSBdLFxyXG4gICAgICAoIGNvbmNlbnRyYXRpb25Db250cm9sLCBkYXRlLCBtYW51YWxseUNvbnRyb2xsZWRDb25jZW50cmF0aW9uICkgPT4ge1xyXG4gICAgICAgIHJldHVybiBjb25jZW50cmF0aW9uQ29udHJvbCA9PT0gQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlLkJZX1ZBTFVFID9cclxuICAgICAgICAgICAgICAgbWFudWFsbHlDb250cm9sbGVkQ29uY2VudHJhdGlvbiA6XHJcbiAgICAgICAgICAgICAgIERBVEVfVE9fQ09OQ0VOVFJBVElPTl9NQVAuZ2V0KCBkYXRlICkhO1xyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnY29uY2VudHJhdGlvblByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogTnVtYmVySU8sXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1RoZSBjb25jZW50cmF0aW9uIHZhbHVlIGJlaW5nIHVzZWQgaW4gdGhlIG1vZGVsLCBzZXQgdmlhIHRoZSBzbGlkZXIgb3IgdGhlIGRhdGUgY29udHJvbC4nXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgLy8gSG9vayB1cCB0aGUgY29uY2VudHJhdGlvbiB0byB0aGUgbGF5ZXJzIGNyZWF0ZWQgaW4gdGhlIHBhcmVudCBjbGFzcy5cclxuICAgIHRoaXMuY29uY2VudHJhdGlvblByb3BlcnR5LmxpbmsoIGNvbmNlbnRyYXRpb24gPT4ge1xyXG5cclxuICAgICAgLy8gTWFwIHRoZSBub3JtYWxpemVkIGNvbmNlbnRyYXRpb24gdG8gYSB2YWx1ZSBmb3IgdGhlIGxheWVyIGFic29ycHRpb24gcHJvcG9ydGlvbi4gIFRoZSBoaWdoZXIgbGF5ZXJzIGFic29yYlxyXG4gICAgICAvLyBsZXNzLiAgVGhpcyBudW1lcmljYWwgbWFwcGluZyBpcyB2ZXJ5IGltcG9ydGFudCB0byB0aGUgY29ycmVjdCBvcGVyYXRpb24gb2YgdGhlIHNpbXVsYXRpb24gd2l0aCByZXNwZWN0IHRvXHJcbiAgICAgIC8vIHRlbXBlcmF0dXJlLCBhbmQgd2FzIGVtcGlyaWNhbGx5IGFkanVzdGVkIHRvIG1ha2UgdGhlIGNvbmNlbnRyYXRpb24gc2xpZGVyIGNvcnJlc3BvbmQgdG8gdGhlIHRlbXBlcmF0dXJlcyBpbiBhXHJcbiAgICAgIC8vIGxpbmVhciBmYXNoaW9uLlxyXG4gICAgICB0aGlzLmF0bW9zcGhlcmVMYXllcnMuZm9yRWFjaCggYXRtb3NwaGVyZUxheWVyID0+IHtcclxuXHJcbiAgICAgICAgLy8gVGhlIG11bHRpcGxpZXIgdXNlZCBpbiB0aGlzIGNhbGN1bGF0aW9uIHdhcyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHRvIG1ha2UgdGhlIG1vZGVsIGVxdWlsaWJyYXRlIGF0IHRoZSBtYXhcclxuICAgICAgICAvLyB0ZW1wZXJhdHVyZSB2YWx1ZSBkZWZpbmVkIGluIHRoZSBzcGVjICgyOTUgSyBhcyBvZiB0aGlzIHdyaXRpbmcpLiAgVGhpcyBtYXkgbmVlZCB0byBjaGFuZ2UgaWYgdGhlIG51bWJlciBvZlxyXG4gICAgICAgIC8vIGxheWVycyBpcyBhZGp1c3RlZCBvciBvdGhlciBjaGFuZ2VzIGFyZSBtYWRlIHRvIHRoZSBtb2RlbC5cclxuICAgICAgICBjb25zdCBwcm9wb3J0aW9uVG9BYnNvcmJBdFNlYUxldmVsID0gMC44NSAqIGNvbmNlbnRyYXRpb247XHJcblxyXG4gICAgICAgIC8vIEFkanVzdCB0aGUgZW5lcmd5IGFic29ycHRpb24gYW1vdW50cyBmb3IgZWFjaCBvZiB0aGUgbGF5ZXJzIGJhc2VkIG9uIHRoZWlyIGFsdGl0dWRlLiAgVGhlIGNhbGN1bGF0aW9uIHVzZXNcclxuICAgICAgICAvLyB0aGUgYmFyb21ldHJpYyBmb3JtdWxhLCBzZWUgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmFyb21ldHJpY19mb3JtdWxhLlxyXG4gICAgICAgIGNvbnN0IGFsdGl0dWRlUHJvcG9ydGlvbkZhY3RvciA9IE1hdGguZXhwKCAtYXRtb3NwaGVyZUxheWVyLmFsdGl0dWRlIC8gU0NBTEVfSEVJR0hUX09GX0FUTU9TUEhFUkUgKTtcclxuICAgICAgICBhdG1vc3BoZXJlTGF5ZXIuZW5lcmd5QWJzb3JwdGlvblByb3BvcnRpb25Qcm9wZXJ0eS5zZXQoIHByb3BvcnRpb25Ub0Fic29yYkF0U2VhTGV2ZWwgKiBhbHRpdHVkZVByb3BvcnRpb25GYWN0b3IgKTtcclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoXHJcbiAgICAgIFsgdGhpcy5kYXRlUHJvcGVydHksIHRoaXMuY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlUHJvcGVydHkgXSxcclxuICAgICAgKCBkYXRlLCBjb25jZW50cmF0aW9uQ29udHJvbE1vZGUgKSA9PiB7XHJcbiAgICAgICAgaWYgKCBkYXRlID09PSBDb25jZW50cmF0aW9uRGF0ZS5JQ0VfQUdFICYmIGNvbmNlbnRyYXRpb25Db250cm9sTW9kZSA9PT0gQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlLkJZX0RBVEUgKSB7XHJcblxyXG4gICAgICAgICAgLy8gU2V0IHRoZSBhbGJlZG8gdG8gY29ycmVzcG9uZCB0byB0aGUgaWNlIGFnZS5cclxuICAgICAgICAgIHRoaXMuZ3JvdW5kTGF5ZXIuYWxiZWRvUHJvcGVydHkuc2V0KCBHcm91bmRMYXllci5QQVJUSUFMTFlfR0xBQ0lBVEVEX0xBTkRfQUxCRURPICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIFNldCB0aGUgYWxiZWRvIHRvIGEgbm9uLWljZS1hZ2UgdmFsdWUuXHJcbiAgICAgICAgICB0aGlzLmdyb3VuZExheWVyLmFsYmVkb1Byb3BlcnR5LnNldCggR3JvdW5kTGF5ZXIuR1JFRU5fTUVBRE9XX0FMQkVETyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLmNsb3VkRW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdjbG91ZEVuYWJsZWRQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFdoZW4gc3dpdGNoaW5nIGZyb20gbWFudWFsIGNvbmNlbnRyYXRpb24gY29udHJvbCBtb2RlIHRvIGRhdGUtYmFzZWQgY29uY2VudHJhdGlvbiBtb2RlLCB0aGUgY2xvdWQgbXVzdCBiZSB0dXJuZWRcclxuICAgIC8vIG9uIGlmIGl0IGlzbid0IGFscmVhZHkuICBUaGVuLCB3aGVuIHN3aXRjaGluZyBiYWNrIHRvIG1hbnVhbCBjb25jZW50cmF0aW9uIG1vZGUsIHRoZSBjbG91ZCBtdXN0IGJlIHJlc3RvcmVkIHRvXHJcbiAgICAvLyB3aGF0ZXZlciB0aGUgc3RhdGUgd2FzIHdoZW4gdGhlIHVzZXIgc3dpdGNoZWQgYXdheS4gIFRoYXQncyB3aGF0IHRoZSBmb2xsb3dpbmcgY29kZSBkb2VzLlxyXG4gICAgbGV0IGNsb3VkRW5hYmxlZEluTWFudWFsQ29uY2VudHJhdGlvbk1vZGUgPSB0aGlzLmNsb3VkRW5hYmxlZFByb3BlcnR5LnZhbHVlO1xyXG4gICAgdGhpcy5jb25jZW50cmF0aW9uQ29udHJvbE1vZGVQcm9wZXJ0eS5sYXp5TGluayggY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlID0+IHtcclxuICAgICAgaWYgKCBjb25jZW50cmF0aW9uQ29udHJvbE1vZGUgPT09IENvbmNlbnRyYXRpb25Db250cm9sTW9kZS5CWV9EQVRFICkge1xyXG4gICAgICAgIGNsb3VkRW5hYmxlZEluTWFudWFsQ29uY2VudHJhdGlvbk1vZGUgPSB0aGlzLmNsb3VkRW5hYmxlZFByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgIHRoaXMuY2xvdWRFbmFibGVkUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIGNvbmNlbnRyYXRpb25Db250cm9sTW9kZSA9PT0gQ29uY2VudHJhdGlvbkNvbnRyb2xNb2RlLkJZX1ZBTFVFICkge1xyXG4gICAgICAgIHRoaXMuY2xvdWRFbmFibGVkUHJvcGVydHkuc2V0KCBjbG91ZEVuYWJsZWRJbk1hbnVhbENvbmNlbnRyYXRpb25Nb2RlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIG9uZSBjbG91ZCB0aGF0IGNhbiBiZSBzaG93bi4gIFRoZSBwb3NpdGlvbiBhbmQgc2l6ZSBvZiB0aGUgY2xvdWQgd2VyZSBjaG9zZW4gdG8gbG9vayBnb29kIGluIHRoZSB2aWV3XHJcbiAgICAvLyBhbmQgY2FuIGJlIGFkanVzdGVkIGFzIG5lZWRlZC5cclxuICAgIHRoaXMuY2xvdWQgPSBuZXcgQ2xvdWQoIG5ldyBWZWN0b3IyKCAtMTYwMDAsIDIwMDAwICksIENMT1VEX1dJRFRILCA0MDAwLCB7XHJcbiAgICAgIHRvcFZpc2libGVMaWdodFJlZmxlY3Rpdml0eTogQ0xPVURfVklTSUJMRV9SRUZMRUNUSVZJVFksXHJcblxyXG4gICAgICAvLyBwaGV0aW9cclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnY2xvdWQnIClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGVuYWJsZWQgc3RhdGUgb2YgdGhlIGNsb3VkLlxyXG4gICAgdGhpcy5jbG91ZEVuYWJsZWRQcm9wZXJ0eS5saW5rKCBjbG91ZEVuYWJsZWQgPT4ge1xyXG4gICAgICB0aGlzLmNsb3VkICYmIHRoaXMuY2xvdWQuZW5hYmxlZFByb3BlcnR5LnNldCggY2xvdWRFbmFibGVkICk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNldHMgYWxsIGFzcGVjdHMgb2YgdGhlIG1vZGVsLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMuY29uY2VudHJhdGlvbkNvbnRyb2xNb2RlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuZGF0ZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLm1hbnVhbGx5Q29udHJvbGxlZENvbmNlbnRyYXRpb25Qcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5jbG91ZEVuYWJsZWRQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgc3VwZXIucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIC8vIHN0YXRpY3NcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IENPTkNFTlRSQVRJT05fUkFOR0U6IFJhbmdlID0gQ09OQ0VOVFJBVElPTl9SQU5HRTtcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IERBVEVfQ09OQ0VOVFJBVElPTl9SQU5HRTogUmFuZ2UgPSBuZXcgUmFuZ2UoXHJcbiAgICBBcnJheS5mcm9tKCBEQVRFX1RPX0NPTkNFTlRSQVRJT05fTUFQLnZhbHVlcygpICkucmVkdWNlKFxyXG4gICAgICAoIG1pblNvRmFyLCBjdXJyZW50VmFsdWUgKSA9PiBNYXRoLm1pbiggbWluU29GYXIsIGN1cnJlbnRWYWx1ZSApLFxyXG4gICAgICBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlcclxuICAgICksXHJcbiAgICBBcnJheS5mcm9tKCBEQVRFX1RPX0NPTkNFTlRSQVRJT05fTUFQLnZhbHVlcygpICkucmVkdWNlKFxyXG4gICAgICAoIG1heFNvRmFyLCBjdXJyZW50VmFsdWUgKSA9PiBNYXRoLm1heCggbWF4U29GYXIsIGN1cnJlbnRWYWx1ZSApLFxyXG4gICAgICBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFlcclxuICAgIClcclxuICApO1xyXG5cclxuICBwdWJsaWMgc3RhdGljIGdldENvbmNlbnRyYXRpb25Gb3JEYXRlKCBkYXRlOiBDb25jZW50cmF0aW9uRGF0ZSApOiBudW1iZXIge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggREFURV9UT19DT05DRU5UUkFUSU9OX01BUC5oYXMoIGRhdGUgKSwgJ25vIGNvbmNlbnRyYXRpb24gZm9yIHRoZSBwcm92aWRlZCBkYXRlJyApO1xyXG4gICAgY29uc3QgY29uY2VudHJhdGlvbiA9IERBVEVfVE9fQ09OQ0VOVFJBVElPTl9NQVAuZ2V0KCBkYXRlICk7XHJcbiAgICByZXR1cm4gY29uY2VudHJhdGlvbiA9PT0gdW5kZWZpbmVkID8gMCA6IGNvbmNlbnRyYXRpb247XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBDb25jZW50cmF0aW9uQ29udHJvbE1vZGUgfTtcclxuZXhwb3J0IHsgQ29uY2VudHJhdGlvbkRhdGUgfTtcclxuXHJcbmdyZWVuaG91c2VFZmZlY3QucmVnaXN0ZXIoICdDb25jZW50cmF0aW9uTW9kZWwnLCBDb25jZW50cmF0aW9uTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgQ29uY2VudHJhdGlvbk1vZGVsO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxtQkFBbUIsTUFBTSw0Q0FBNEM7QUFFNUUsT0FBT0MsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBQ2xFLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxXQUFXLE1BQU0seUNBQXlDO0FBQ2pFLE9BQU9DLGdCQUFnQixNQUFNLDhDQUE4QztBQUUzRSxPQUFPQyxRQUFRLE1BQU0seUNBQXlDO0FBQzlELE9BQU9DLGdCQUFnQixNQUFNLDJCQUEyQjtBQUN4RCxPQUFPQyxLQUFLLE1BQU0sWUFBWTtBQUM5QixPQUFPQyxXQUFXLE1BQU0sa0JBQWtCO0FBQzFDLE9BQU9DLFdBQVcsTUFBOEIsa0JBQWtCOztBQUVsRTtBQUNBLE1BQU1DLDBCQUEwQixHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3pDLE1BQU1DLFdBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQzs7QUFFM0I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxLQUFLLEdBQUdILFdBQVcsQ0FBQ0ksYUFBYSxDQUFDQyxLQUFLLEdBQUdILFdBQVc7QUFDeEZJLE1BQU0sSUFBSUEsTUFBTSxDQUFFSCwwQkFBMEIsSUFBSSxDQUFDLEVBQUcseUNBQXdDQSwwQkFBMkIsRUFBRSxDQUFDOztBQUUxSDtBQUNBO0FBQ0EsTUFBTUksd0JBQXdCLFNBQVNaLGdC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