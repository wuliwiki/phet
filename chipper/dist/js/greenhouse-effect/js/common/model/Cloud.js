// Copyright 2021-2022, University of Colorado Boulder

/**
 * The Cloud class is a simple model of a cloud in the atmosphere.  Clouds can interact with light, generally reflecting
 * it in both the up and down directions.  For the purposes of reflecting light, the cloud is modeled as a horizontal
 * line that occupies some proportion of the modeled section of the Earth, and the amount of light that it reflects is
 * based on the proportion of the total horizontal space occupied by the cloud and its reflectivity in the up and down
 * directions for each frequency of light.
 *
 * For the purposes of the view, the shape of the cloud is modelled as an ellipse that is created from the provided
 * width, height and center position.  This shape is used when doing things like reflecting waves or bouncing photons,
 * but that sort of behavior is generally handled by the model that contains the cloud, and not the Cloud instances.
 *
 * @author John Blanco (PhET Interactive Simulations)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import { Shape } from '../../../../kite/js/imports.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import greenhouseEffect from '../../greenhouseEffect.js';
import EMEnergyPacket from './EMEnergyPacket.js';
import EnergyDirection from './EnergyDirection.js';
import optionize from '../../../../phet-core/js/optionize.js';
import LayersModel from './LayersModel.js';
class Cloud extends PhetioObject {
  constructor(position, width, height, providedOptions) {
    const options = optionize()({
      topVisibleLightReflectivity: 0.08,
      bottomVisibleLightReflectivity: 0,
      topInfraredLightReflectivity: 0,
      bottomInfraredLightReflectivity: 0,
      // phet-io
      phetioState: false,
      tandem: Tandem.REQUIRED // tandem is required because Cloud is used in a Map that is serialized
    }, providedOptions);
    super(options);

    // Make the reflectivity values available to the methods.
    this.reflectivityValues = {
      topVisibleLightReflectivity: options.topVisibleLightReflectivity,
      bottomVisibleLightReflectivity: options.bottomVisibleLightReflectivity,
      topInfraredLightReflectivity: options.topInfraredLightReflectivity,
      bottomInfraredLightReflectivity: options.bottomInfraredLightReflectivity
    };

    // parameter checking
    assert && assert(width <= LayersModel.SUNLIGHT_SPAN.width, 'cloud can\'t exceed the sunlight span');

    // position in model space of the center of this cloud
    this.position = position;

    // size of the cloud
    this.width = width;
    this.height = height;

    // controls whether the cloud is interacting with light
    this.enabledProperty = new BooleanProperty(false);

    // elliptical shape that defines the space which the cloud occupies
    this.modelShape = Shape.ellipse(position.x, position.y, width / 2, height / 2, 0);
  }

  /**
   * Interact with the provided energy.  Energy may be partially reflected.
   * @param emEnergyPackets - energy packets that are moving withing the system
   * @param dt - delta time, in seconds
   */
  interactWithEnergy(emEnergyPackets, dt) {
    if (this.enabledProperty.value) {
      const sunlightSpanWidthProportion = this.width / LayersModel.SUNLIGHT_SPAN.width;
      emEnergyPackets.forEach(emEnergyPacket => {
        // convenience variable
        const altitude = this.position.y;
        let reflectedEnergy = 0;

        // Check whether this energy packet has interacted with the cloud and, if so, calculate the reflection.
        if (emEnergyPacket.previousAltitude > altitude && emEnergyPacket.altitude <= altitude) {
          const reflectivity = emEnergyPacket.isVisible ? this.reflectivityValues.topVisibleLightReflectivity : this.reflectivityValues.topInfraredLightReflectivity;
          reflectedEnergy = emEnergyPacket.energy * reflectivity * sunlightSpanWidthProportion;
        } else if (emEnergyPacket.previousAltitude < altitude && emEnergyPacket.altitude >= altitude) {
          const reflectivity = emEnergyPacket.isVisible ? this.reflectivityValues.bottomVisibleLightReflectivity : this.reflectivityValues.bottomInfraredLightReflectivity;
          reflectedEnergy = emEnergyPacket.energy * reflectivity * sunlightSpanWidthProportion;
        }
        if (reflectedEnergy > 0) {
          // Attenuate the amount of energy in the non-reflected packet by the amount the was reflected.
          emEnergyPacket.energy = emEnergyPacket.energy - reflectedEnergy;

          // Create a new packet of the same type with the reflected energy, heading in the opposite direction.
          emEnergyPackets.push(new EMEnergyPacket(emEnergyPacket.wavelength, reflectedEnergy, altitude, EnergyDirection.getOpposite(emEnergyPacket.direction)));
        }
      });
    }
  }
}
greenhouseEffect.register('Cloud', Cloud);
export default Cloud;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJTaGFwZSIsIlBoZXRpb09iamVjdCIsIlRhbmRlbSIsImdyZWVuaG91c2VFZmZlY3QiLCJFTUVuZXJneVBhY2tldCIsIkVuZXJneURpcmVjdGlvbiIsIm9wdGlvbml6ZSIsIkxheWVyc01vZGVsIiwiQ2xvdWQiLCJjb25zdHJ1Y3RvciIsInBvc2l0aW9uIiwid2lkdGgiLCJoZWlnaHQiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwidG9wVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5IiwiYm90dG9tVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5IiwidG9wSW5mcmFyZWRMaWdodFJlZmxlY3Rpdml0eSIsImJvdHRvbUluZnJhcmVkTGlnaHRSZWZsZWN0aXZpdHkiLCJwaGV0aW9TdGF0ZSIsInRhbmRlbSIsIlJFUVVJUkVEIiwicmVmbGVjdGl2aXR5VmFsdWVzIiwiYXNzZXJ0IiwiU1VOTElHSFRfU1BBTiIsImVuYWJsZWRQcm9wZXJ0eSIsIm1vZGVsU2hhcGUiLCJlbGxpcHNlIiwieCIsInkiLCJpbnRlcmFjdFdpdGhFbmVyZ3kiLCJlbUVuZXJneVBhY2tldHMiLCJkdCIsInZhbHVlIiwic3VubGlnaHRTcGFuV2lkdGhQcm9wb3J0aW9uIiwiZm9yRWFjaCIsImVtRW5lcmd5UGFja2V0IiwiYWx0aXR1ZGUiLCJyZWZsZWN0ZWRFbmVyZ3kiLCJwcmV2aW91c0FsdGl0dWRlIiwicmVmbGVjdGl2aXR5IiwiaXNWaXNpYmxlIiwiZW5lcmd5IiwicHVzaCIsIndhdmVsZW5ndGgiLCJnZXRPcHBvc2l0ZSIsImRpcmVjdGlvbiIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQ2xvdWQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVGhlIENsb3VkIGNsYXNzIGlzIGEgc2ltcGxlIG1vZGVsIG9mIGEgY2xvdWQgaW4gdGhlIGF0bW9zcGhlcmUuICBDbG91ZHMgY2FuIGludGVyYWN0IHdpdGggbGlnaHQsIGdlbmVyYWxseSByZWZsZWN0aW5nXHJcbiAqIGl0IGluIGJvdGggdGhlIHVwIGFuZCBkb3duIGRpcmVjdGlvbnMuICBGb3IgdGhlIHB1cnBvc2VzIG9mIHJlZmxlY3RpbmcgbGlnaHQsIHRoZSBjbG91ZCBpcyBtb2RlbGVkIGFzIGEgaG9yaXpvbnRhbFxyXG4gKiBsaW5lIHRoYXQgb2NjdXBpZXMgc29tZSBwcm9wb3J0aW9uIG9mIHRoZSBtb2RlbGVkIHNlY3Rpb24gb2YgdGhlIEVhcnRoLCBhbmQgdGhlIGFtb3VudCBvZiBsaWdodCB0aGF0IGl0IHJlZmxlY3RzIGlzXHJcbiAqIGJhc2VkIG9uIHRoZSBwcm9wb3J0aW9uIG9mIHRoZSB0b3RhbCBob3Jpem9udGFsIHNwYWNlIG9jY3VwaWVkIGJ5IHRoZSBjbG91ZCBhbmQgaXRzIHJlZmxlY3Rpdml0eSBpbiB0aGUgdXAgYW5kIGRvd25cclxuICogZGlyZWN0aW9ucyBmb3IgZWFjaCBmcmVxdWVuY3kgb2YgbGlnaHQuXHJcbiAqXHJcbiAqIEZvciB0aGUgcHVycG9zZXMgb2YgdGhlIHZpZXcsIHRoZSBzaGFwZSBvZiB0aGUgY2xvdWQgaXMgbW9kZWxsZWQgYXMgYW4gZWxsaXBzZSB0aGF0IGlzIGNyZWF0ZWQgZnJvbSB0aGUgcHJvdmlkZWRcclxuICogd2lkdGgsIGhlaWdodCBhbmQgY2VudGVyIHBvc2l0aW9uLiAgVGhpcyBzaGFwZSBpcyB1c2VkIHdoZW4gZG9pbmcgdGhpbmdzIGxpa2UgcmVmbGVjdGluZyB3YXZlcyBvciBib3VuY2luZyBwaG90b25zLFxyXG4gKiBidXQgdGhhdCBzb3J0IG9mIGJlaGF2aW9yIGlzIGdlbmVyYWxseSBoYW5kbGVkIGJ5IHRoZSBtb2RlbCB0aGF0IGNvbnRhaW5zIHRoZSBjbG91ZCwgYW5kIG5vdCB0aGUgQ2xvdWQgaW5zdGFuY2VzLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgU2hhcGUgfSBmcm9tICcuLi8uLi8uLi8uLi9raXRlL2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgUGhldGlvT2JqZWN0LCB7IFBoZXRpb09iamVjdE9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvUGhldGlvT2JqZWN0LmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IGdyZWVuaG91c2VFZmZlY3QgZnJvbSAnLi4vLi4vZ3JlZW5ob3VzZUVmZmVjdC5qcyc7XHJcbmltcG9ydCBFTUVuZXJneVBhY2tldCBmcm9tICcuL0VNRW5lcmd5UGFja2V0LmpzJztcclxuaW1wb3J0IEVuZXJneURpcmVjdGlvbiBmcm9tICcuL0VuZXJneURpcmVjdGlvbi5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgTGF5ZXJzTW9kZWwgZnJvbSAnLi9MYXllcnNNb2RlbC5qcyc7XHJcblxyXG50eXBlIFJlZmxlY3Rpdml0eVZhbHVlcyA9IHtcclxuXHJcbiAgLy8gcHJvcG9ydGlvbiBvZiB0aGUgdmlzaWJsZSBsaWdodCB0aGF0IGhpdHMgdGhpcyBjbG91ZCBmcm9tIGFib3ZlIGFuZCBpcyBzdWJzZXF1ZW50bHkgcmVmbGVjdGVkIGJhY2sgdXBcclxuICB0b3BWaXNpYmxlTGlnaHRSZWZsZWN0aXZpdHk6IG51bWJlcjtcclxuXHJcbiAgLy8gcHJvcG9ydGlvbiBvZiB0aGUgdmlzaWJsZSBsaWdodCB0aGF0IGhpdHMgdGhpcyBjbG91ZCBmcm9tIGJlbG93IGFuZCBpcyBzdWJzZXF1ZW50bHkgcmVmbGVjdGVkIGJhY2sgZG93blxyXG4gIGJvdHRvbVZpc2libGVMaWdodFJlZmxlY3Rpdml0eTogbnVtYmVyO1xyXG5cclxuICAvLyBwcm9wb3J0aW9uIG9mIHRoZSBpbmZyYXJlZCBsaWdodCB0aGF0IGhpdHMgdGhpcyBjbG91ZCBmcm9tIGFib3ZlIGFuZCBpcyBzdWJzZXF1ZW50bHkgcmVmbGVjdGVkIGJhY2sgdXBcclxuICB0b3BJbmZyYXJlZExpZ2h0UmVmbGVjdGl2aXR5OiBudW1iZXI7XHJcblxyXG4gIC8vIHByb3BvcnRpb24gb2YgdGhlIGluZnJhcmVkIGxpZ2h0IHRoYXQgaGl0cyB0aGlzIGNsb3VkIGZyb20gYmVsb3cgYW5kIGlzIHN1YnNlcXVlbnRseSByZWZsZWN0ZWQgYmFjayBkb3duXHJcbiAgYm90dG9tSW5mcmFyZWRMaWdodFJlZmxlY3Rpdml0eTogbnVtYmVyO1xyXG59O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IFBhcnRpYWw8UmVmbGVjdGl2aXR5VmFsdWVzPjtcclxuZXhwb3J0IHR5cGUgQ2xvdWRPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaGV0aW9PYmplY3RPcHRpb25zO1xyXG5cclxuY2xhc3MgQ2xvdWQgZXh0ZW5kcyBQaGV0aW9PYmplY3Qge1xyXG4gIHB1YmxpYyByZWFkb25seSBwb3NpdGlvbjogVmVjdG9yMjtcclxuICBwdWJsaWMgcmVhZG9ubHkgd2lkdGg6IG51bWJlcjtcclxuICBwdWJsaWMgcmVhZG9ubHkgaGVpZ2h0OiBudW1iZXI7XHJcbiAgcHVibGljIHJlYWRvbmx5IGVuYWJsZWRQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHVibGljIHJlYWRvbmx5IG1vZGVsU2hhcGU6IFNoYXBlO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVmbGVjdGl2aXR5VmFsdWVzOiBSZWZsZWN0aXZpdHlWYWx1ZXM7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcG9zaXRpb246IFZlY3RvcjIsIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBwcm92aWRlZE9wdGlvbnM6IENsb3VkT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPENsb3VkT3B0aW9ucywgU2VsZk9wdGlvbnMsIFBoZXRpb09iamVjdE9wdGlvbnM+KCkoIHtcclxuICAgICAgdG9wVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5OiAwLjA4LFxyXG4gICAgICBib3R0b21WaXNpYmxlTGlnaHRSZWZsZWN0aXZpdHk6IDAsXHJcbiAgICAgIHRvcEluZnJhcmVkTGlnaHRSZWZsZWN0aXZpdHk6IDAsXHJcbiAgICAgIGJvdHRvbUluZnJhcmVkTGlnaHRSZWZsZWN0aXZpdHk6IDAsXHJcblxyXG4gICAgICAvLyBwaGV0LWlvXHJcbiAgICAgIHBoZXRpb1N0YXRlOiBmYWxzZSxcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRUQgLy8gdGFuZGVtIGlzIHJlcXVpcmVkIGJlY2F1c2UgQ2xvdWQgaXMgdXNlZCBpbiBhIE1hcCB0aGF0IGlzIHNlcmlhbGl6ZWRcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gTWFrZSB0aGUgcmVmbGVjdGl2aXR5IHZhbHVlcyBhdmFpbGFibGUgdG8gdGhlIG1ldGhvZHMuXHJcbiAgICB0aGlzLnJlZmxlY3Rpdml0eVZhbHVlcyA9IHtcclxuICAgICAgdG9wVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5OiBvcHRpb25zLnRvcFZpc2libGVMaWdodFJlZmxlY3Rpdml0eSxcclxuICAgICAgYm90dG9tVmlzaWJsZUxpZ2h0UmVmbGVjdGl2aXR5OiBvcHRpb25zLmJvdHRvbVZpc2libGVMaWdodFJlZmxlY3Rpdml0eSxcclxuICAgICAgdG9wSW5mcmFyZWRMaWdodFJlZmxlY3Rpdml0eTogb3B0aW9ucy50b3BJbmZyYXJlZExpZ2h0UmVmbGVjdGl2aXR5LFxyXG4gICAgICBib3R0b21JbmZyYXJlZExpZ2h0UmVmbGVjdGl2aXR5OiBvcHRpb25zLmJvdHRvbUluZnJhcmVkTGlnaHRSZWZsZWN0aXZpdHlcclxuICAgIH07XHJcblxyXG4gICAgLy8gcGFyYW1ldGVyIGNoZWNraW5nXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB3aWR0aCA8PSBMYXllcnNNb2RlbC5TVU5MSUdIVF9TUEFOLndpZHRoLCAnY2xvdWQgY2FuXFwndCBleGNlZWQgdGhlIHN1bmxpZ2h0IHNwYW4nICk7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gaW4gbW9kZWwgc3BhY2Ugb2YgdGhlIGNlbnRlciBvZiB0aGlzIGNsb3VkXHJcbiAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XHJcblxyXG4gICAgLy8gc2l6ZSBvZiB0aGUgY2xvdWRcclxuICAgIHRoaXMud2lkdGggPSB3aWR0aDtcclxuICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0O1xyXG5cclxuICAgIC8vIGNvbnRyb2xzIHdoZXRoZXIgdGhlIGNsb3VkIGlzIGludGVyYWN0aW5nIHdpdGggbGlnaHRcclxuICAgIHRoaXMuZW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuXHJcbiAgICAvLyBlbGxpcHRpY2FsIHNoYXBlIHRoYXQgZGVmaW5lcyB0aGUgc3BhY2Ugd2hpY2ggdGhlIGNsb3VkIG9jY3VwaWVzXHJcbiAgICB0aGlzLm1vZGVsU2hhcGUgPSBTaGFwZS5lbGxpcHNlKCBwb3NpdGlvbi54LCBwb3NpdGlvbi55LCB3aWR0aCAvIDIsIGhlaWdodCAvIDIsIDAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEludGVyYWN0IHdpdGggdGhlIHByb3ZpZGVkIGVuZXJneS4gIEVuZXJneSBtYXkgYmUgcGFydGlhbGx5IHJlZmxlY3RlZC5cclxuICAgKiBAcGFyYW0gZW1FbmVyZ3lQYWNrZXRzIC0gZW5lcmd5IHBhY2tldHMgdGhhdCBhcmUgbW92aW5nIHdpdGhpbmcgdGhlIHN5c3RlbVxyXG4gICAqIEBwYXJhbSBkdCAtIGRlbHRhIHRpbWUsIGluIHNlY29uZHNcclxuICAgKi9cclxuICBwdWJsaWMgaW50ZXJhY3RXaXRoRW5lcmd5KCBlbUVuZXJneVBhY2tldHM6IEVNRW5lcmd5UGFja2V0W10sIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcblxyXG4gICAgaWYgKCB0aGlzLmVuYWJsZWRQcm9wZXJ0eS52YWx1ZSApIHtcclxuXHJcbiAgICAgIGNvbnN0IHN1bmxpZ2h0U3BhbldpZHRoUHJvcG9ydGlvbiA9IHRoaXMud2lkdGggLyBMYXllcnNNb2RlbC5TVU5MSUdIVF9TUEFOLndpZHRoO1xyXG5cclxuICAgICAgZW1FbmVyZ3lQYWNrZXRzLmZvckVhY2goIGVtRW5lcmd5UGFja2V0ID0+IHtcclxuXHJcbiAgICAgICAgLy8gY29udmVuaWVuY2UgdmFyaWFibGVcclxuICAgICAgICBjb25zdCBhbHRpdHVkZSA9IHRoaXMucG9zaXRpb24ueTtcclxuXHJcbiAgICAgICAgbGV0IHJlZmxlY3RlZEVuZXJneSA9IDA7XHJcblxyXG4gICAgICAgIC8vIENoZWNrIHdoZXRoZXIgdGhpcyBlbmVyZ3kgcGFja2V0IGhhcyBpbnRlcmFjdGVkIHdpdGggdGhlIGNsb3VkIGFuZCwgaWYgc28sIGNhbGN1bGF0ZSB0aGUgcmVmbGVjdGlvbi5cclxuICAgICAgICBpZiAoIGVtRW5lcmd5UGFja2V0LnByZXZpb3VzQWx0aXR1ZGUgPiBhbHRpdHVkZSAmJiBlbUVuZXJneVBhY2tldC5hbHRpdHVkZSA8PSBhbHRpdHVkZSApIHtcclxuICAgICAgICAgIGNvbnN0IHJlZmxlY3Rpdml0eSA9IGVtRW5lcmd5UGFja2V0LmlzVmlzaWJsZSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZmxlY3Rpdml0eVZhbHVlcy50b3BWaXNpYmxlTGlnaHRSZWZsZWN0aXZpdHkgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZsZWN0aXZpdHlWYWx1ZXMudG9wSW5mcmFyZWRMaWdodFJlZmxlY3Rpdml0eTtcclxuICAgICAgICAgIHJlZmxlY3RlZEVuZXJneSA9IGVtRW5lcmd5UGFja2V0LmVuZXJneSAqIHJlZmxlY3Rpdml0eSAqIHN1bmxpZ2h0U3BhbldpZHRoUHJvcG9ydGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIGVtRW5lcmd5UGFja2V0LnByZXZpb3VzQWx0aXR1ZGUgPCBhbHRpdHVkZSAmJiBlbUVuZXJneVBhY2tldC5hbHRpdHVkZSA+PSBhbHRpdHVkZSApIHtcclxuICAgICAgICAgIGNvbnN0IHJlZmxlY3Rpdml0eSA9IGVtRW5lcmd5UGFja2V0LmlzVmlzaWJsZSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZmxlY3Rpdml0eVZhbHVlcy5ib3R0b21WaXNpYmxlTGlnaHRSZWZsZWN0aXZpdHkgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWZsZWN0aXZpdHlWYWx1ZXMuYm90dG9tSW5mcmFyZWRMaWdodFJlZmxlY3Rpdml0eTtcclxuICAgICAgICAgIHJlZmxlY3RlZEVuZXJneSA9IGVtRW5lcmd5UGFja2V0LmVuZXJneSAqIHJlZmxlY3Rpdml0eSAqIHN1bmxpZ2h0U3BhbldpZHRoUHJvcG9ydGlvbjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICggcmVmbGVjdGVkRW5lcmd5ID4gMCApIHtcclxuXHJcbiAgICAgICAgICAvLyBBdHRlbnVhdGUgdGhlIGFtb3VudCBvZiBlbmVyZ3kgaW4gdGhlIG5vbi1yZWZsZWN0ZWQgcGFja2V0IGJ5IHRoZSBhbW91bnQgdGhlIHdhcyByZWZsZWN0ZWQuXHJcbiAgICAgICAgICBlbUVuZXJneVBhY2tldC5lbmVyZ3kgPSBlbUVuZXJneVBhY2tldC5lbmVyZ3kgLSByZWZsZWN0ZWRFbmVyZ3k7XHJcblxyXG4gICAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IHBhY2tldCBvZiB0aGUgc2FtZSB0eXBlIHdpdGggdGhlIHJlZmxlY3RlZCBlbmVyZ3ksIGhlYWRpbmcgaW4gdGhlIG9wcG9zaXRlIGRpcmVjdGlvbi5cclxuICAgICAgICAgIGVtRW5lcmd5UGFja2V0cy5wdXNoKCBuZXcgRU1FbmVyZ3lQYWNrZXQoXHJcbiAgICAgICAgICAgIGVtRW5lcmd5UGFja2V0LndhdmVsZW5ndGgsXHJcbiAgICAgICAgICAgIHJlZmxlY3RlZEVuZXJneSxcclxuICAgICAgICAgICAgYWx0aXR1ZGUsXHJcbiAgICAgICAgICAgIEVuZXJneURpcmVjdGlvbi5nZXRPcHBvc2l0ZSggZW1FbmVyZ3lQYWNrZXQuZGlyZWN0aW9uIClcclxuICAgICAgICAgICkgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmdyZWVuaG91c2VFZmZlY3QucmVnaXN0ZXIoICdDbG91ZCcsIENsb3VkICk7XHJcbmV4cG9ydCBkZWZhdWx0IENsb3VkOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBQ3BFLFNBQVNDLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsT0FBT0MsWUFBWSxNQUErQix1Q0FBdUM7QUFDekYsT0FBT0MsTUFBTSxNQUFNLGlDQUFpQztBQUNwRCxPQUFPQyxnQkFBZ0IsTUFBTSwyQkFBMkI7QUFDeEQsT0FBT0MsY0FBYyxNQUFNLHFCQUFxQjtBQUNoRCxPQUFPQyxlQUFlLE1BQU0sc0JBQXNCO0FBR2xELE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFDN0QsT0FBT0MsV0FBVyxNQUFNLGtCQUFrQjtBQW9CMUMsTUFBTUMsS0FBSyxTQUFTUCxZQUFZLENBQUM7RUFReEJRLFdBQVdBLENBQUVDLFFBQWlCLEVBQUVDLEtBQWEsRUFBRUMsTUFBYyxFQUFFQyxlQUE2QixFQUFHO0lBRXBHLE1BQU1DLE9BQU8sR0FBR1IsU0FBUyxDQUFpRCxDQUFDLENBQUU7TUFDM0VTLDJCQUEyQixFQUFFLElBQUk7TUFDakNDLDhCQUE4QixFQUFFLENBQUM7TUFDakNDLDRCQUE0QixFQUFFLENBQUM7TUFDL0JDLCtCQUErQixFQUFFLENBQUM7TUFFbEM7TUFDQUMsV0FBVyxFQUFFLEtBQUs7TUFDbEJDLE1BQU0sRUFBRWxCLE1BQU0sQ0FBQ21CLFFBQVEsQ0FBQztJQUMxQixDQUFDLEVBQUVSLGVBQWdCLENBQUM7SUFFcEIsS0FBSyxDQUFFQyxPQUFRLENBQUM7O0lBRWhCO0lBQ0EsSUFBSSxDQUFDUSxrQkFBa0IsR0FBRztNQUN4QlAsMkJBQTJCLEVBQUVELE9BQU8sQ0FBQ0MsMkJBQTJCO01BQ2hFQyw4QkFBOEIsRUFBRUYsT0FBTyxDQUFDRSw4QkFBOEI7TUFDdEVDLDRCQUE0QixFQUFFSCxPQUFPLENBQUNHLDRCQUE0QjtNQUNsRUMsK0JBQStCLEVBQUVKLE9BQU8sQ0FBQ0k7SUFDM0MsQ0FBQzs7SUFFRDtJQUNBSyxNQUFNLElBQUlBLE1BQU0sQ0FBRVosS0FBSyxJQUFJSixXQUFXLENBQUNpQixhQUFhLENBQUNiLEtBQUssRUFBRSx1Q0FBd0MsQ0FBQzs7SUFFckc7SUFDQSxJQUFJLENBQUNELFFBQVEsR0FBR0EsUUFBUTs7SUFFeEI7SUFDQSxJQUFJLENBQUNDLEtBQUssR0FBR0EsS0FBSztJQUNsQixJQUFJLENBQUNDLE1BQU0sR0FBR0EsTUFBTTs7SUFFcEI7SUFDQSxJQUFJLENBQUNhLGVBQWUsR0FBRyxJQUFJMUIsZUFBZSxDQUFFLEtBQU0sQ0FBQzs7SUFFbkQ7SUFDQSxJQUFJLENBQUMyQixVQUFVLEdBQUcxQixLQUFLLENBQUMyQixPQUFPLENBQUVqQixRQUFRLENBQUNrQixDQUFDLEVBQUVsQixRQUFRLENBQUNtQixDQUFDLEVBQUVsQixLQUFLLEdBQUcsQ0FBQyxFQUFFQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQztFQUNyRjs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ1NrQixrQkFBa0JBLENBQUVDLGVBQWlDLEVBQUVDLEVBQVUsRUFBUztJQUUvRSxJQUFLLElBQUksQ0FBQ1AsZUFBZSxDQUFDUSxLQUFLLEVBQUc7TUFFaEMsTUFBTUMsMkJBQTJCLEdBQUcsSUFBSSxDQUFDdkIsS0FBSyxHQUFHSixXQUFXLENBQUNpQixhQUFhLENBQUNiLEtBQUs7TUFFaEZvQixlQUFlLENBQUNJLE9BQU8sQ0FBRUMsY0FBYyxJQUFJO1FBRXpDO1FBQ0EsTUFBTUMsUUFBUSxHQUFHLElBQUksQ0FBQzNCLFFBQVEsQ0FBQ21CLENBQUM7UUFFaEMsSUFBSVMsZUFBZSxHQUFHLENBQUM7O1FBRXZCO1FBQ0EsSUFBS0YsY0FBYyxDQUFDRyxnQkFBZ0IsR0FBR0YsUUFBUSxJQUFJRCxjQUFjLENBQUNDLFFBQVEsSUFBSUEsUUFBUSxFQUFHO1VBQ3ZGLE1BQU1HLFlBQVksR0FBR0osY0FBYyxDQUFDSyxTQUFTLEdBQ3hCLElBQUksQ0FBQ25CLGtCQUFrQixDQUFDUCwyQkFBMkIsR0FDbkQsSUFBSSxDQUFDTyxrQkFBa0IsQ0FBQ0wsNEJBQTRCO1VBQ3pFcUIsZUFBZSxHQUFHRixjQUFjLENBQUNNLE1BQU0sR0FBR0YsWUFBWSxHQUFHTiwyQkFBMkI7UUFDdEYsQ0FBQyxNQUNJLElBQUtFLGNBQWMsQ0FBQ0csZ0JBQWdCLEdBQUdGLFFBQVEsSUFBSUQsY0FBYyxDQUFDQyxRQUFRLElBQUlBLFFBQVEsRUFBRztVQUM1RixNQUFNRyxZQUFZLEdBQUdKLGNBQWMsQ0FBQ0ssU0FBUyxHQUN4QixJQUFJLENBQUNuQixrQkFBa0IsQ0FBQ04sOEJBQThCLEdBQ3RELElBQUksQ0FBQ00sa0JBQWtCLENBQUNKLCtCQUErQjtVQUM1RW9CLGVBQWUsR0FBR0YsY0FBYyxDQUFDTSxNQUFNLEdBQUdGLFlBQVksR0FBR04sMkJBQTJCO1FBQ3RGO1FBRUEsSUFBS0ksZUFBZSxHQUFHLENBQUMsRUFBRztVQUV6QjtVQUNBRixjQUFjLENBQUNNLE1BQU0sR0FBR04sY0FBYyxDQUFDTSxNQUFNLEdBQUdKLGVBQWU7O1VBRS9EO1VBQ0FQLGVBQWUsQ0FBQ1ksSUFBSSxDQUFFLElBQUl2QyxjQUFjLENBQ3RDZ0MsY0FBYyxDQUFDUSxVQUFVLEVBQ3pCTixlQUFlLEVBQ2ZELFFBQVEsRUFDUmhDLGVBQWUsQ0FBQ3dDLFdBQVcsQ0FBRVQsY0FBYyxDQUFDVSxTQUFVLENBQ3hELENBQUUsQ0FBQztRQUNMO01BQ0YsQ0FBRSxDQUFDO0lBQ0w7RUFDRjtBQUNGO0FBRUEzQyxnQkFBZ0IsQ0FBQzRDLFFBQVEsQ0FBRSxPQUFPLEVBQUV2QyxLQUFNLENBQUM7QUFDM0MsZUFBZUEsS0FBSyJ9