// Copyright 2022, University of Colorado Boulder

/**
 * FluxMeterSoundGenerator is used to produce sounds for the flux meter, which measures the amount of flux for visible
 * and IR radiation at various points in the atmosphere.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import Utils from '../../../../dot/js/Utils.js';
import optionize from '../../../../phet-core/js/optionize.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import SoundGenerator from '../../../../tambo/js/sound-generators/SoundGenerator.js';
import irFluxDownA_mp3 from '../../../sounds/irFluxDownA_mp3.js';
import irFluxDownB_mp3 from '../../../sounds/irFluxDownB_mp3.js';
import irFluxUp_mp3 from '../../../sounds/irFluxUp_mp3.js';
import greenhouseEffect from '../../greenhouseEffect.js';

// amount of time before starting to fade where flux change is below the threshold, in seconds
const PRE_FADE_TIME = 0.25;

// rate at which the sounds increase in volume, in proportion per second
const FADE_IN_RATE = 5;

// rate at which sounds decrease in volume, in proportion per second
const FADE_OUT_RATE = 4;
const FADE_OUT_TIME = 1 / FADE_OUT_RATE;

// the rate of flux change considered necessary to produce sound, empirically determined
const FLUX_CHANGE_RATE_THRESHOLD = 1000000;

// empirically determined values used to scale attributes of the sound generation
const MAX_EXPECTED_UPWARD_IR_FLUX = 178000000;
const MAX_EXPECTED_DOWNWARD_IR_FLUX = 134000000;

// number of samples to use when averaging out the rate of flux change
const NUMBER_OF_AVERAGING_SAMPLES = 10;

// types for options

class FluxMeterSoundGenerator extends SoundGenerator {
  irUpFluxChangedCountdownTimer = 0;
  irDownFluxChangedCountdownTimer = 0;
  downwardFluxGainLevel = 0;

  // arrays that track changes in the flux, used to calculate a moving average
  irFluxUpRateChangeSamples = [];
  irFluxDownRateChangeSamples = [];

  // internal dispose function

  constructor(visibleFluxUpProperty, visibleFluxDownProperty, irFluxUpProperty, irFluxDownProperty, providedOptions) {
    const options = optionize()({}, providedOptions);
    super(options);

    // Make the properties that track the flux rates available to the methods.
    this.irFluxUpProperty = irFluxUpProperty;
    this.irFluxDownProperty = irFluxDownProperty;

    // Set the initial values for the historic rate information that will be used to track changes.
    this.irPreviousFluxUp = irFluxUpProperty.value;
    this.irPreviousFluxDown = irFluxUpProperty.value;

    // Create the sound clip used for IR flux in the upward direction.
    this.irUpFluxSoundClip = new SoundClip(irFluxUp_mp3, {
      initialOutputLevel: 0,
      loop: true
    });
    this.irUpFluxSoundClip.connect(this.masterGainNode);

    // Create the gain node that will be used to fade in and out the combined clips that make up the IR flux down sound.
    this.downwardFluxGainNode = this.audioContext.createGain();
    this.downwardFluxGainNode.connect(this.masterGainNode);

    // Create the sound clips used for IR flux in the downward direction.  The overall sound is made by cross-fading
    // between these two sounds based on the flux level.
    this.irFluxDownASoundClip = new SoundClip(irFluxDownA_mp3, {
      initialOutputLevel: 0,
      loop: true
    });
    this.irFluxDownBSoundClip = new SoundClip(irFluxDownB_mp3, {
      initialOutputLevel: 0,
      loop: true
    });

    // Connect the sounds for the downward-direction IR to the overall gain node for this sound.
    this.irFluxDownASoundClip.connect(this.downwardFluxGainNode);
    this.irFluxDownBSoundClip.connect(this.downwardFluxGainNode);

    // Define the class-specific dispose function.
    this.disposeFluxMeterSoundGenerator = () => {
      // TODO: Remove this if it's not needed.  See https://github.com/phetsims/greenhouse-effect/issues/185.
    };
  }

  /**
   * Step forward in time by the specified amount.  This updates the output levels for the various sounds based on
   * time-related algorithms.
   * @param dt - delta time, in seconds
   */
  step(dt) {
    const irFluxUpChangeRateThisStep = Math.abs(this.irPreviousFluxUp - this.irFluxUpProperty.value) / dt;
    const irFluxDownChangeRateThisStep = Math.abs(this.irPreviousFluxDown - this.irFluxDownProperty.value) / dt;

    // Update the moving average samples and calculation for the IR flux change rate in both the upward and downward
    // directions.  This is a decidedly imperfect moving average calculation because it doesn't weight the samples based
    // on the dt values with which they are associated, but it has so far proven to be good enough for the needs of this
    // sound generator.
    this.irFluxUpRateChangeSamples.push(irFluxUpChangeRateThisStep);
    if (this.irFluxUpRateChangeSamples.length > NUMBER_OF_AVERAGING_SAMPLES) {
      this.irFluxUpRateChangeSamples.shift();
    }
    const averageIrFluxUpChangeRate = this.irFluxUpRateChangeSamples.length >= NUMBER_OF_AVERAGING_SAMPLES ? this.irFluxUpRateChangeSamples.reduce((total, val) => total + val, 0) / NUMBER_OF_AVERAGING_SAMPLES : 0;
    this.irFluxDownRateChangeSamples.push(irFluxDownChangeRateThisStep);
    if (this.irFluxDownRateChangeSamples.length > NUMBER_OF_AVERAGING_SAMPLES) {
      this.irFluxDownRateChangeSamples.shift();
    }
    const averageIrFluxDownChangeRate = this.irFluxDownRateChangeSamples.length >= NUMBER_OF_AVERAGING_SAMPLES ? this.irFluxDownRateChangeSamples.reduce((total, val) => total + val, 0) / NUMBER_OF_AVERAGING_SAMPLES : 0;

    // Adjust the countdown timers based on the rate of flux change.
    if (Math.abs(averageIrFluxUpChangeRate) > FLUX_CHANGE_RATE_THRESHOLD) {
      this.irUpFluxChangedCountdownTimer = PRE_FADE_TIME + FADE_OUT_TIME;
    } else {
      this.irUpFluxChangedCountdownTimer = Math.max(this.irUpFluxChangedCountdownTimer - dt, 0);
    }
    if (Math.abs(averageIrFluxDownChangeRate) > FLUX_CHANGE_RATE_THRESHOLD) {
      this.irDownFluxChangedCountdownTimer = PRE_FADE_TIME + FADE_OUT_TIME;
    } else {
      this.irDownFluxChangedCountdownTimer = Math.max(this.irDownFluxChangedCountdownTimer - dt, 0);
    }

    // Adjust the output level of the upward-direction IR sound.
    let irUpFluxSoundOutputLevel = this.irUpFluxSoundClip.outputLevel;
    if (this.irUpFluxChangedCountdownTimer > FADE_OUT_TIME) {
      // Move towards full volume if not already there.
      irUpFluxSoundOutputLevel = Math.min(irUpFluxSoundOutputLevel + FADE_IN_RATE * dt, 1);
    } else if (this.irUpFluxChangedCountdownTimer > 0) {
      // The countdown indicates that this sound should be fading out, so calculate what is probably a reduced volume.
      irUpFluxSoundOutputLevel = Math.max(irUpFluxSoundOutputLevel - FADE_OUT_RATE * dt, 0);
    } else {
      // The sound should be fully faded when the counter gets to zero.
      irUpFluxSoundOutputLevel = 0;
    }
    this.irUpFluxSoundClip.setOutputLevel(irUpFluxSoundOutputLevel);

    // Start or stop the upward-direction IR sound clip if appropriate.
    if (irUpFluxSoundOutputLevel > 0 && !this.irUpFluxSoundClip.isPlaying) {
      this.irUpFluxSoundClip.play();
    } else if (irUpFluxSoundOutputLevel === 0 && this.irUpFluxSoundClip.isPlaying) {
      this.irUpFluxSoundClip.stop(0.1);
    }

    // Set the playback rate for the upward-direction IR sound.  This happens regardless of whether it is playing.
    const playbackRate = 1 + Math.min(this.irFluxUpProperty.value / MAX_EXPECTED_UPWARD_IR_FLUX, 1) * 4;
    this.irUpFluxSoundClip.setPlaybackRate(playbackRate);

    // Update the overall output level for the downward-direction IR sound.
    if (this.irDownFluxChangedCountdownTimer > FADE_OUT_TIME) {
      // Move towards full volume if not already there.
      this.downwardFluxGainLevel = Math.min(this.downwardFluxGainLevel + FADE_IN_RATE * dt, 1);
    } else if (this.irDownFluxChangedCountdownTimer > 0) {
      // The countdown indicates that this sound should be fading out, so calculate what is probably a reduced volume.
      this.downwardFluxGainLevel = Math.max(this.downwardFluxGainLevel - FADE_OUT_RATE * dt, 0);
    } else {
      // The sound should be fully faded when the counter gets to zero.
      this.downwardFluxGainLevel = 0;
    }
    this.downwardFluxGainNode.gain.setValueAtTime(this.downwardFluxGainLevel, 0);

    // Set the cross-fade levels for the two sounds that comprise the downward IR composite sound.
    const soundAOutputLevel = Utils.clamp(1 - this.irFluxDownProperty.value / MAX_EXPECTED_DOWNWARD_IR_FLUX, 0, 1);
    this.irFluxDownASoundClip.setOutputLevel(soundAOutputLevel);
    this.irFluxDownBSoundClip.setOutputLevel(1 - soundAOutputLevel);

    // Start or stop the downward-direction IR sound clips if appropriate.
    if (this.downwardFluxGainLevel > 0) {
      !this.irFluxDownASoundClip.isPlaying && this.irFluxDownASoundClip.play();
      !this.irFluxDownBSoundClip.isPlaying && this.irFluxDownBSoundClip.play();
    } else if (this.downwardFluxGainLevel === 0) {
      this.irFluxDownASoundClip.isPlaying && this.irFluxDownASoundClip.stop(0.1);
      this.irFluxDownBSoundClip.isPlaying && this.irFluxDownBSoundClip.stop(0.1);
    }

    // Update the previous flux values for the next step.
    this.irPreviousFluxUp = this.irFluxUpProperty.value;
    this.irPreviousFluxDown = this.irFluxDownProperty.value;
  }
  reset() {
    this.irUpFluxChangedCountdownTimer = 0;
    this.irUpFluxSoundClip.outputLevel = 0;
    this.irUpFluxSoundClip.stop(0.1);
    this.irUpFluxSoundClip.setPlaybackRate(1);
    this.irPreviousFluxUp = 0;
  }
  dispose() {
    this.disposeFluxMeterSoundGenerator();
    super.dispose();
  }
}
greenhouseEffect.register('FluxMeterSoundGenerator', FluxMeterSoundGenerator);
export default FluxMeterSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIm9wdGlvbml6ZSIsIlNvdW5kQ2xpcCIsIlNvdW5kR2VuZXJhdG9yIiwiaXJGbHV4RG93bkFfbXAzIiwiaXJGbHV4RG93bkJfbXAzIiwiaXJGbHV4VXBfbXAzIiwiZ3JlZW5ob3VzZUVmZmVjdCIsIlBSRV9GQURFX1RJTUUiLCJGQURFX0lOX1JBVEUiLCJGQURFX09VVF9SQVRFIiwiRkFERV9PVVRfVElNRSIsIkZMVVhfQ0hBTkdFX1JBVEVfVEhSRVNIT0xEIiwiTUFYX0VYUEVDVEVEX1VQV0FSRF9JUl9GTFVYIiwiTUFYX0VYUEVDVEVEX0RPV05XQVJEX0lSX0ZMVVgiLCJOVU1CRVJfT0ZfQVZFUkFHSU5HX1NBTVBMRVMiLCJGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvciIsImlyVXBGbHV4Q2hhbmdlZENvdW50ZG93blRpbWVyIiwiaXJEb3duRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciIsImRvd253YXJkRmx1eEdhaW5MZXZlbCIsImlyRmx1eFVwUmF0ZUNoYW5nZVNhbXBsZXMiLCJpckZsdXhEb3duUmF0ZUNoYW5nZVNhbXBsZXMiLCJjb25zdHJ1Y3RvciIsInZpc2libGVGbHV4VXBQcm9wZXJ0eSIsInZpc2libGVGbHV4RG93blByb3BlcnR5IiwiaXJGbHV4VXBQcm9wZXJ0eSIsImlyRmx1eERvd25Qcm9wZXJ0eSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJpclByZXZpb3VzRmx1eFVwIiwidmFsdWUiLCJpclByZXZpb3VzRmx1eERvd24iLCJpclVwRmx1eFNvdW5kQ2xpcCIsImluaXRpYWxPdXRwdXRMZXZlbCIsImxvb3AiLCJjb25uZWN0IiwibWFzdGVyR2Fpbk5vZGUiLCJkb3dud2FyZEZsdXhHYWluTm9kZSIsImF1ZGlvQ29udGV4dCIsImNyZWF0ZUdhaW4iLCJpckZsdXhEb3duQVNvdW5kQ2xpcCIsImlyRmx1eERvd25CU291bmRDbGlwIiwiZGlzcG9zZUZsdXhNZXRlclNvdW5kR2VuZXJhdG9yIiwic3RlcCIsImR0IiwiaXJGbHV4VXBDaGFuZ2VSYXRlVGhpc1N0ZXAiLCJNYXRoIiwiYWJzIiwiaXJGbHV4RG93bkNoYW5nZVJhdGVUaGlzU3RlcCIsInB1c2giLCJsZW5ndGgiLCJzaGlmdCIsImF2ZXJhZ2VJckZsdXhVcENoYW5nZVJhdGUiLCJyZWR1Y2UiLCJ0b3RhbCIsInZhbCIsImF2ZXJhZ2VJckZsdXhEb3duQ2hhbmdlUmF0ZSIsIm1heCIsImlyVXBGbHV4U291bmRPdXRwdXRMZXZlbCIsIm91dHB1dExldmVsIiwibWluIiwic2V0T3V0cHV0TGV2ZWwiLCJpc1BsYXlpbmciLCJwbGF5Iiwic3RvcCIsInBsYXliYWNrUmF0ZSIsInNldFBsYXliYWNrUmF0ZSIsImdhaW4iLCJzZXRWYWx1ZUF0VGltZSIsInNvdW5kQU91dHB1dExldmVsIiwiY2xhbXAiLCJyZXNldCIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkZsdXhNZXRlclNvdW5kR2VuZXJhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvciBpcyB1c2VkIHRvIHByb2R1Y2Ugc291bmRzIGZvciB0aGUgZmx1eCBtZXRlciwgd2hpY2ggbWVhc3VyZXMgdGhlIGFtb3VudCBvZiBmbHV4IGZvciB2aXNpYmxlXHJcbiAqIGFuZCBJUiByYWRpYXRpb24gYXQgdmFyaW91cyBwb2ludHMgaW4gdGhlIGF0bW9zcGhlcmUuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY28gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBTb3VuZENsaXAsIHsgU291bmRDbGlwT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kLWdlbmVyYXRvcnMvU291bmRDbGlwLmpzJztcclxuaW1wb3J0IFNvdW5kR2VuZXJhdG9yLCB7IFNvdW5kR2VuZXJhdG9yT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kLWdlbmVyYXRvcnMvU291bmRHZW5lcmF0b3IuanMnO1xyXG5pbXBvcnQgaXJGbHV4RG93bkFfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9pckZsdXhEb3duQV9tcDMuanMnO1xyXG5pbXBvcnQgaXJGbHV4RG93bkJfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9pckZsdXhEb3duQl9tcDMuanMnO1xyXG5pbXBvcnQgaXJGbHV4VXBfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9pckZsdXhVcF9tcDMuanMnO1xyXG5pbXBvcnQgZ3JlZW5ob3VzZUVmZmVjdCBmcm9tICcuLi8uLi9ncmVlbmhvdXNlRWZmZWN0LmpzJztcclxuXHJcbi8vIGFtb3VudCBvZiB0aW1lIGJlZm9yZSBzdGFydGluZyB0byBmYWRlIHdoZXJlIGZsdXggY2hhbmdlIGlzIGJlbG93IHRoZSB0aHJlc2hvbGQsIGluIHNlY29uZHNcclxuY29uc3QgUFJFX0ZBREVfVElNRSA9IDAuMjU7XHJcblxyXG4vLyByYXRlIGF0IHdoaWNoIHRoZSBzb3VuZHMgaW5jcmVhc2UgaW4gdm9sdW1lLCBpbiBwcm9wb3J0aW9uIHBlciBzZWNvbmRcclxuY29uc3QgRkFERV9JTl9SQVRFID0gNTtcclxuXHJcbi8vIHJhdGUgYXQgd2hpY2ggc291bmRzIGRlY3JlYXNlIGluIHZvbHVtZSwgaW4gcHJvcG9ydGlvbiBwZXIgc2Vjb25kXHJcbmNvbnN0IEZBREVfT1VUX1JBVEUgPSA0O1xyXG5cclxuY29uc3QgRkFERV9PVVRfVElNRSA9IDEgLyBGQURFX09VVF9SQVRFO1xyXG5cclxuLy8gdGhlIHJhdGUgb2YgZmx1eCBjaGFuZ2UgY29uc2lkZXJlZCBuZWNlc3NhcnkgdG8gcHJvZHVjZSBzb3VuZCwgZW1waXJpY2FsbHkgZGV0ZXJtaW5lZFxyXG5jb25zdCBGTFVYX0NIQU5HRV9SQVRFX1RIUkVTSE9MRCA9IDEwMDAwMDA7XHJcblxyXG4vLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHZhbHVlcyB1c2VkIHRvIHNjYWxlIGF0dHJpYnV0ZXMgb2YgdGhlIHNvdW5kIGdlbmVyYXRpb25cclxuY29uc3QgTUFYX0VYUEVDVEVEX1VQV0FSRF9JUl9GTFVYID0gMTc4MDAwMDAwO1xyXG5jb25zdCBNQVhfRVhQRUNURURfRE9XTldBUkRfSVJfRkxVWCA9IDEzNDAwMDAwMDtcclxuXHJcbi8vIG51bWJlciBvZiBzYW1wbGVzIHRvIHVzZSB3aGVuIGF2ZXJhZ2luZyBvdXQgdGhlIHJhdGUgb2YgZmx1eCBjaGFuZ2VcclxuY29uc3QgTlVNQkVSX09GX0FWRVJBR0lOR19TQU1QTEVTID0gMTA7XHJcblxyXG4vLyB0eXBlcyBmb3Igb3B0aW9uc1xyXG50eXBlIFNlbGZPcHRpb25zID0gRW1wdHlTZWxmT3B0aW9ucztcclxudHlwZSBGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvck9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFNvdW5kR2VuZXJhdG9yT3B0aW9ucztcclxuXHJcbmNsYXNzIEZsdXhNZXRlclNvdW5kR2VuZXJhdG9yIGV4dGVuZHMgU291bmRHZW5lcmF0b3Ige1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGlyRmx1eFVwUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj47XHJcbiAgcHJpdmF0ZSBpclByZXZpb3VzRmx1eFVwOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBpclVwRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciA9IDA7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpclVwRmx1eFNvdW5kQ2xpcDogU291bmRDbGlwO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGlyRmx1eERvd25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuICBwcml2YXRlIGlyUHJldmlvdXNGbHV4RG93bjogbnVtYmVyO1xyXG4gIHByaXZhdGUgaXJEb3duRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciA9IDA7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpckZsdXhEb3duQVNvdW5kQ2xpcDogU291bmRDbGlwO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgaXJGbHV4RG93bkJTb3VuZENsaXA6IFNvdW5kQ2xpcDtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRvd253YXJkRmx1eEdhaW5Ob2RlOiBHYWluTm9kZTtcclxuICBwcml2YXRlIGRvd253YXJkRmx1eEdhaW5MZXZlbCA9IDA7XHJcblxyXG4gIC8vIGFycmF5cyB0aGF0IHRyYWNrIGNoYW5nZXMgaW4gdGhlIGZsdXgsIHVzZWQgdG8gY2FsY3VsYXRlIGEgbW92aW5nIGF2ZXJhZ2VcclxuICBwcml2YXRlIHJlYWRvbmx5IGlyRmx1eFVwUmF0ZUNoYW5nZVNhbXBsZXM6IG51bWJlcltdID0gW107XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpckZsdXhEb3duUmF0ZUNoYW5nZVNhbXBsZXM6IG51bWJlcltdID0gW107XHJcblxyXG4gIC8vIGludGVybmFsIGRpc3Bvc2UgZnVuY3Rpb25cclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB2aXNpYmxlRmx1eFVwUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlRmx1eERvd25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPixcclxuICAgICAgICAgICAgICAgICAgICAgIGlyRmx1eFVwUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBpckZsdXhEb3duUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM/OiBGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvck9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvck9wdGlvbnMsIFNlbGZPcHRpb25zLCBTb3VuZENsaXBPcHRpb25zPigpKCB7XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIE1ha2UgdGhlIHByb3BlcnRpZXMgdGhhdCB0cmFjayB0aGUgZmx1eCByYXRlcyBhdmFpbGFibGUgdG8gdGhlIG1ldGhvZHMuXHJcbiAgICB0aGlzLmlyRmx1eFVwUHJvcGVydHkgPSBpckZsdXhVcFByb3BlcnR5O1xyXG4gICAgdGhpcy5pckZsdXhEb3duUHJvcGVydHkgPSBpckZsdXhEb3duUHJvcGVydHk7XHJcblxyXG4gICAgLy8gU2V0IHRoZSBpbml0aWFsIHZhbHVlcyBmb3IgdGhlIGhpc3RvcmljIHJhdGUgaW5mb3JtYXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gdHJhY2sgY2hhbmdlcy5cclxuICAgIHRoaXMuaXJQcmV2aW91c0ZsdXhVcCA9IGlyRmx1eFVwUHJvcGVydHkudmFsdWU7XHJcbiAgICB0aGlzLmlyUHJldmlvdXNGbHV4RG93biA9IGlyRmx1eFVwUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBzb3VuZCBjbGlwIHVzZWQgZm9yIElSIGZsdXggaW4gdGhlIHVwd2FyZCBkaXJlY3Rpb24uXHJcbiAgICB0aGlzLmlyVXBGbHV4U291bmRDbGlwID0gbmV3IFNvdW5kQ2xpcCggaXJGbHV4VXBfbXAzLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogMCxcclxuICAgICAgbG9vcDogdHJ1ZVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5pclVwRmx1eFNvdW5kQ2xpcC5jb25uZWN0KCB0aGlzLm1hc3RlckdhaW5Ob2RlICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBnYWluIG5vZGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gZmFkZSBpbiBhbmQgb3V0IHRoZSBjb21iaW5lZCBjbGlwcyB0aGF0IG1ha2UgdXAgdGhlIElSIGZsdXggZG93biBzb3VuZC5cclxuICAgIHRoaXMuZG93bndhcmRGbHV4R2Fpbk5vZGUgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVHYWluKCk7XHJcbiAgICB0aGlzLmRvd253YXJkRmx1eEdhaW5Ob2RlLmNvbm5lY3QoIHRoaXMubWFzdGVyR2Fpbk5vZGUgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIHNvdW5kIGNsaXBzIHVzZWQgZm9yIElSIGZsdXggaW4gdGhlIGRvd253YXJkIGRpcmVjdGlvbi4gIFRoZSBvdmVyYWxsIHNvdW5kIGlzIG1hZGUgYnkgY3Jvc3MtZmFkaW5nXHJcbiAgICAvLyBiZXR3ZWVuIHRoZXNlIHR3byBzb3VuZHMgYmFzZWQgb24gdGhlIGZsdXggbGV2ZWwuXHJcbiAgICB0aGlzLmlyRmx1eERvd25BU291bmRDbGlwID0gbmV3IFNvdW5kQ2xpcCggaXJGbHV4RG93bkFfbXAzLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogMCxcclxuICAgICAgbG9vcDogdHJ1ZVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5pckZsdXhEb3duQlNvdW5kQ2xpcCA9IG5ldyBTb3VuZENsaXAoIGlyRmx1eERvd25CX21wMywge1xyXG4gICAgICBpbml0aWFsT3V0cHV0TGV2ZWw6IDAsXHJcbiAgICAgIGxvb3A6IHRydWVcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBDb25uZWN0IHRoZSBzb3VuZHMgZm9yIHRoZSBkb3dud2FyZC1kaXJlY3Rpb24gSVIgdG8gdGhlIG92ZXJhbGwgZ2FpbiBub2RlIGZvciB0aGlzIHNvdW5kLlxyXG4gICAgdGhpcy5pckZsdXhEb3duQVNvdW5kQ2xpcC5jb25uZWN0KCB0aGlzLmRvd253YXJkRmx1eEdhaW5Ob2RlICk7XHJcbiAgICB0aGlzLmlyRmx1eERvd25CU291bmRDbGlwLmNvbm5lY3QoIHRoaXMuZG93bndhcmRGbHV4R2Fpbk5vZGUgKTtcclxuXHJcbiAgICAvLyBEZWZpbmUgdGhlIGNsYXNzLXNwZWNpZmljIGRpc3Bvc2UgZnVuY3Rpb24uXHJcbiAgICB0aGlzLmRpc3Bvc2VGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvciA9ICgpID0+IHtcclxuICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgaWYgaXQncyBub3QgbmVlZGVkLiAgU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9ncmVlbmhvdXNlLWVmZmVjdC9pc3N1ZXMvMTg1LlxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0ZXAgZm9yd2FyZCBpbiB0aW1lIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LiAgVGhpcyB1cGRhdGVzIHRoZSBvdXRwdXQgbGV2ZWxzIGZvciB0aGUgdmFyaW91cyBzb3VuZHMgYmFzZWQgb25cclxuICAgKiB0aW1lLXJlbGF0ZWQgYWxnb3JpdGhtcy5cclxuICAgKiBAcGFyYW0gZHQgLSBkZWx0YSB0aW1lLCBpbiBzZWNvbmRzXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcblxyXG4gICAgY29uc3QgaXJGbHV4VXBDaGFuZ2VSYXRlVGhpc1N0ZXAgPSBNYXRoLmFicyggdGhpcy5pclByZXZpb3VzRmx1eFVwIC0gdGhpcy5pckZsdXhVcFByb3BlcnR5LnZhbHVlICkgLyBkdDtcclxuICAgIGNvbnN0IGlyRmx1eERvd25DaGFuZ2VSYXRlVGhpc1N0ZXAgPSBNYXRoLmFicyggdGhpcy5pclByZXZpb3VzRmx1eERvd24gLSB0aGlzLmlyRmx1eERvd25Qcm9wZXJ0eS52YWx1ZSApIC8gZHQ7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBtb3ZpbmcgYXZlcmFnZSBzYW1wbGVzIGFuZCBjYWxjdWxhdGlvbiBmb3IgdGhlIElSIGZsdXggY2hhbmdlIHJhdGUgaW4gYm90aCB0aGUgdXB3YXJkIGFuZCBkb3dud2FyZFxyXG4gICAgLy8gZGlyZWN0aW9ucy4gIFRoaXMgaXMgYSBkZWNpZGVkbHkgaW1wZXJmZWN0IG1vdmluZyBhdmVyYWdlIGNhbGN1bGF0aW9uIGJlY2F1c2UgaXQgZG9lc24ndCB3ZWlnaHQgdGhlIHNhbXBsZXMgYmFzZWRcclxuICAgIC8vIG9uIHRoZSBkdCB2YWx1ZXMgd2l0aCB3aGljaCB0aGV5IGFyZSBhc3NvY2lhdGVkLCBidXQgaXQgaGFzIHNvIGZhciBwcm92ZW4gdG8gYmUgZ29vZCBlbm91Z2ggZm9yIHRoZSBuZWVkcyBvZiB0aGlzXHJcbiAgICAvLyBzb3VuZCBnZW5lcmF0b3IuXHJcbiAgICB0aGlzLmlyRmx1eFVwUmF0ZUNoYW5nZVNhbXBsZXMucHVzaCggaXJGbHV4VXBDaGFuZ2VSYXRlVGhpc1N0ZXAgKTtcclxuICAgIGlmICggdGhpcy5pckZsdXhVcFJhdGVDaGFuZ2VTYW1wbGVzLmxlbmd0aCA+IE5VTUJFUl9PRl9BVkVSQUdJTkdfU0FNUExFUyApIHtcclxuICAgICAgdGhpcy5pckZsdXhVcFJhdGVDaGFuZ2VTYW1wbGVzLnNoaWZ0KCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBhdmVyYWdlSXJGbHV4VXBDaGFuZ2VSYXRlID0gdGhpcy5pckZsdXhVcFJhdGVDaGFuZ2VTYW1wbGVzLmxlbmd0aCA+PSBOVU1CRVJfT0ZfQVZFUkFHSU5HX1NBTVBMRVMgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXJGbHV4VXBSYXRlQ2hhbmdlU2FtcGxlcy5yZWR1Y2UoICggdG90YWwsIHZhbCApID0+IHRvdGFsICsgdmFsLCAwICkgLyBOVU1CRVJfT0ZfQVZFUkFHSU5HX1NBTVBMRVMgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDA7XHJcbiAgICB0aGlzLmlyRmx1eERvd25SYXRlQ2hhbmdlU2FtcGxlcy5wdXNoKCBpckZsdXhEb3duQ2hhbmdlUmF0ZVRoaXNTdGVwICk7XHJcbiAgICBpZiAoIHRoaXMuaXJGbHV4RG93blJhdGVDaGFuZ2VTYW1wbGVzLmxlbmd0aCA+IE5VTUJFUl9PRl9BVkVSQUdJTkdfU0FNUExFUyApIHtcclxuICAgICAgdGhpcy5pckZsdXhEb3duUmF0ZUNoYW5nZVNhbXBsZXMuc2hpZnQoKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGF2ZXJhZ2VJckZsdXhEb3duQ2hhbmdlUmF0ZSA9IHRoaXMuaXJGbHV4RG93blJhdGVDaGFuZ2VTYW1wbGVzLmxlbmd0aCA+PSBOVU1CRVJfT0ZfQVZFUkFHSU5HX1NBTVBMRVMgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pckZsdXhEb3duUmF0ZUNoYW5nZVNhbXBsZXMucmVkdWNlKCAoIHRvdGFsLCB2YWwgKSA9PiB0b3RhbCArIHZhbCwgMCApIC8gTlVNQkVSX09GX0FWRVJBR0lOR19TQU1QTEVTIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDA7XHJcblxyXG4gICAgLy8gQWRqdXN0IHRoZSBjb3VudGRvd24gdGltZXJzIGJhc2VkIG9uIHRoZSByYXRlIG9mIGZsdXggY2hhbmdlLlxyXG4gICAgaWYgKCBNYXRoLmFicyggYXZlcmFnZUlyRmx1eFVwQ2hhbmdlUmF0ZSApID4gRkxVWF9DSEFOR0VfUkFURV9USFJFU0hPTEQgKSB7XHJcbiAgICAgIHRoaXMuaXJVcEZsdXhDaGFuZ2VkQ291bnRkb3duVGltZXIgPSBQUkVfRkFERV9USU1FICsgRkFERV9PVVRfVElNRTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmlyVXBGbHV4Q2hhbmdlZENvdW50ZG93blRpbWVyID0gTWF0aC5tYXgoIHRoaXMuaXJVcEZsdXhDaGFuZ2VkQ291bnRkb3duVGltZXIgLSBkdCwgMCApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICggTWF0aC5hYnMoIGF2ZXJhZ2VJckZsdXhEb3duQ2hhbmdlUmF0ZSApID4gRkxVWF9DSEFOR0VfUkFURV9USFJFU0hPTEQgKSB7XHJcbiAgICAgIHRoaXMuaXJEb3duRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciA9IFBSRV9GQURFX1RJTUUgKyBGQURFX09VVF9USU1FO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMuaXJEb3duRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciA9IE1hdGgubWF4KCB0aGlzLmlyRG93bkZsdXhDaGFuZ2VkQ291bnRkb3duVGltZXIgLSBkdCwgMCApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFkanVzdCB0aGUgb3V0cHV0IGxldmVsIG9mIHRoZSB1cHdhcmQtZGlyZWN0aW9uIElSIHNvdW5kLlxyXG4gICAgbGV0IGlyVXBGbHV4U291bmRPdXRwdXRMZXZlbCA9IHRoaXMuaXJVcEZsdXhTb3VuZENsaXAub3V0cHV0TGV2ZWw7XHJcbiAgICBpZiAoIHRoaXMuaXJVcEZsdXhDaGFuZ2VkQ291bnRkb3duVGltZXIgPiBGQURFX09VVF9USU1FICkge1xyXG5cclxuICAgICAgLy8gTW92ZSB0b3dhcmRzIGZ1bGwgdm9sdW1lIGlmIG5vdCBhbHJlYWR5IHRoZXJlLlxyXG4gICAgICBpclVwRmx1eFNvdW5kT3V0cHV0TGV2ZWwgPSBNYXRoLm1pbiggaXJVcEZsdXhTb3VuZE91dHB1dExldmVsICsgRkFERV9JTl9SQVRFICogZHQsIDEgKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCB0aGlzLmlyVXBGbHV4Q2hhbmdlZENvdW50ZG93blRpbWVyID4gMCApIHtcclxuXHJcbiAgICAgIC8vIFRoZSBjb3VudGRvd24gaW5kaWNhdGVzIHRoYXQgdGhpcyBzb3VuZCBzaG91bGQgYmUgZmFkaW5nIG91dCwgc28gY2FsY3VsYXRlIHdoYXQgaXMgcHJvYmFibHkgYSByZWR1Y2VkIHZvbHVtZS5cclxuICAgICAgaXJVcEZsdXhTb3VuZE91dHB1dExldmVsID0gTWF0aC5tYXgoIGlyVXBGbHV4U291bmRPdXRwdXRMZXZlbCAtIEZBREVfT1VUX1JBVEUgKiBkdCwgMCApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICAvLyBUaGUgc291bmQgc2hvdWxkIGJlIGZ1bGx5IGZhZGVkIHdoZW4gdGhlIGNvdW50ZXIgZ2V0cyB0byB6ZXJvLlxyXG4gICAgICBpclVwRmx1eFNvdW5kT3V0cHV0TGV2ZWwgPSAwO1xyXG4gICAgfVxyXG4gICAgdGhpcy5pclVwRmx1eFNvdW5kQ2xpcC5zZXRPdXRwdXRMZXZlbCggaXJVcEZsdXhTb3VuZE91dHB1dExldmVsICk7XHJcblxyXG4gICAgLy8gU3RhcnQgb3Igc3RvcCB0aGUgdXB3YXJkLWRpcmVjdGlvbiBJUiBzb3VuZCBjbGlwIGlmIGFwcHJvcHJpYXRlLlxyXG4gICAgaWYgKCBpclVwRmx1eFNvdW5kT3V0cHV0TGV2ZWwgPiAwICYmICF0aGlzLmlyVXBGbHV4U291bmRDbGlwLmlzUGxheWluZyApIHtcclxuICAgICAgdGhpcy5pclVwRmx1eFNvdW5kQ2xpcC5wbGF5KCk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggaXJVcEZsdXhTb3VuZE91dHB1dExldmVsID09PSAwICYmIHRoaXMuaXJVcEZsdXhTb3VuZENsaXAuaXNQbGF5aW5nICkge1xyXG4gICAgICB0aGlzLmlyVXBGbHV4U291bmRDbGlwLnN0b3AoIDAuMSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFNldCB0aGUgcGxheWJhY2sgcmF0ZSBmb3IgdGhlIHVwd2FyZC1kaXJlY3Rpb24gSVIgc291bmQuICBUaGlzIGhhcHBlbnMgcmVnYXJkbGVzcyBvZiB3aGV0aGVyIGl0IGlzIHBsYXlpbmcuXHJcbiAgICBjb25zdCBwbGF5YmFja1JhdGUgPSAxICsgTWF0aC5taW4oIHRoaXMuaXJGbHV4VXBQcm9wZXJ0eS52YWx1ZSAvIE1BWF9FWFBFQ1RFRF9VUFdBUkRfSVJfRkxVWCwgMSApICogNDtcclxuICAgIHRoaXMuaXJVcEZsdXhTb3VuZENsaXAuc2V0UGxheWJhY2tSYXRlKCBwbGF5YmFja1JhdGUgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIG92ZXJhbGwgb3V0cHV0IGxldmVsIGZvciB0aGUgZG93bndhcmQtZGlyZWN0aW9uIElSIHNvdW5kLlxyXG4gICAgaWYgKCB0aGlzLmlyRG93bkZsdXhDaGFuZ2VkQ291bnRkb3duVGltZXIgPiBGQURFX09VVF9USU1FICkge1xyXG5cclxuICAgICAgLy8gTW92ZSB0b3dhcmRzIGZ1bGwgdm9sdW1lIGlmIG5vdCBhbHJlYWR5IHRoZXJlLlxyXG4gICAgICB0aGlzLmRvd253YXJkRmx1eEdhaW5MZXZlbCA9IE1hdGgubWluKCB0aGlzLmRvd253YXJkRmx1eEdhaW5MZXZlbCArIEZBREVfSU5fUkFURSAqIGR0LCAxICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGhpcy5pckRvd25GbHV4Q2hhbmdlZENvdW50ZG93blRpbWVyID4gMCApIHtcclxuXHJcbiAgICAgIC8vIFRoZSBjb3VudGRvd24gaW5kaWNhdGVzIHRoYXQgdGhpcyBzb3VuZCBzaG91bGQgYmUgZmFkaW5nIG91dCwgc28gY2FsY3VsYXRlIHdoYXQgaXMgcHJvYmFibHkgYSByZWR1Y2VkIHZvbHVtZS5cclxuICAgICAgdGhpcy5kb3dud2FyZEZsdXhHYWluTGV2ZWwgPSBNYXRoLm1heCggdGhpcy5kb3dud2FyZEZsdXhHYWluTGV2ZWwgLSBGQURFX09VVF9SQVRFICogZHQsIDAgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG5cclxuICAgICAgLy8gVGhlIHNvdW5kIHNob3VsZCBiZSBmdWxseSBmYWRlZCB3aGVuIHRoZSBjb3VudGVyIGdldHMgdG8gemVyby5cclxuICAgICAgdGhpcy5kb3dud2FyZEZsdXhHYWluTGV2ZWwgPSAwO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kb3dud2FyZEZsdXhHYWluTm9kZS5nYWluLnNldFZhbHVlQXRUaW1lKCB0aGlzLmRvd253YXJkRmx1eEdhaW5MZXZlbCwgMCApO1xyXG5cclxuICAgIC8vIFNldCB0aGUgY3Jvc3MtZmFkZSBsZXZlbHMgZm9yIHRoZSB0d28gc291bmRzIHRoYXQgY29tcHJpc2UgdGhlIGRvd253YXJkIElSIGNvbXBvc2l0ZSBzb3VuZC5cclxuICAgIGNvbnN0IHNvdW5kQU91dHB1dExldmVsID0gVXRpbHMuY2xhbXAoIDEgLSB0aGlzLmlyRmx1eERvd25Qcm9wZXJ0eS52YWx1ZSAvIE1BWF9FWFBFQ1RFRF9ET1dOV0FSRF9JUl9GTFVYLCAwLCAxICk7XHJcbiAgICB0aGlzLmlyRmx1eERvd25BU291bmRDbGlwLnNldE91dHB1dExldmVsKCBzb3VuZEFPdXRwdXRMZXZlbCApO1xyXG4gICAgdGhpcy5pckZsdXhEb3duQlNvdW5kQ2xpcC5zZXRPdXRwdXRMZXZlbCggMSAtIHNvdW5kQU91dHB1dExldmVsICk7XHJcblxyXG4gICAgLy8gU3RhcnQgb3Igc3RvcCB0aGUgZG93bndhcmQtZGlyZWN0aW9uIElSIHNvdW5kIGNsaXBzIGlmIGFwcHJvcHJpYXRlLlxyXG4gICAgaWYgKCB0aGlzLmRvd253YXJkRmx1eEdhaW5MZXZlbCA+IDAgKSB7XHJcbiAgICAgICF0aGlzLmlyRmx1eERvd25BU291bmRDbGlwLmlzUGxheWluZyAmJiB0aGlzLmlyRmx1eERvd25BU291bmRDbGlwLnBsYXkoKTtcclxuICAgICAgIXRoaXMuaXJGbHV4RG93bkJTb3VuZENsaXAuaXNQbGF5aW5nICYmIHRoaXMuaXJGbHV4RG93bkJTb3VuZENsaXAucGxheSgpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIHRoaXMuZG93bndhcmRGbHV4R2FpbkxldmVsID09PSAwICkge1xyXG4gICAgICB0aGlzLmlyRmx1eERvd25BU291bmRDbGlwLmlzUGxheWluZyAmJiB0aGlzLmlyRmx1eERvd25BU291bmRDbGlwLnN0b3AoIDAuMSApO1xyXG4gICAgICB0aGlzLmlyRmx1eERvd25CU291bmRDbGlwLmlzUGxheWluZyAmJiB0aGlzLmlyRmx1eERvd25CU291bmRDbGlwLnN0b3AoIDAuMSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgcHJldmlvdXMgZmx1eCB2YWx1ZXMgZm9yIHRoZSBuZXh0IHN0ZXAuXHJcbiAgICB0aGlzLmlyUHJldmlvdXNGbHV4VXAgPSB0aGlzLmlyRmx1eFVwUHJvcGVydHkudmFsdWU7XHJcbiAgICB0aGlzLmlyUHJldmlvdXNGbHV4RG93biA9IHRoaXMuaXJGbHV4RG93blByb3BlcnR5LnZhbHVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pclVwRmx1eENoYW5nZWRDb3VudGRvd25UaW1lciA9IDA7XHJcbiAgICB0aGlzLmlyVXBGbHV4U291bmRDbGlwLm91dHB1dExldmVsID0gMDtcclxuICAgIHRoaXMuaXJVcEZsdXhTb3VuZENsaXAuc3RvcCggMC4xICk7XHJcbiAgICB0aGlzLmlyVXBGbHV4U291bmRDbGlwLnNldFBsYXliYWNrUmF0ZSggMSApO1xyXG4gICAgdGhpcy5pclByZXZpb3VzRmx1eFVwID0gMDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlRmx1eE1ldGVyU291bmRHZW5lcmF0b3IoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmdyZWVuaG91c2VFZmZlY3QucmVnaXN0ZXIoICdGbHV4TWV0ZXJTb3VuZEdlbmVyYXRvcicsIEZsdXhNZXRlclNvdW5kR2VuZXJhdG9yICk7XHJcbmV4cG9ydCBkZWZhdWx0IEZsdXhNZXRlclNvdW5kR2VuZXJhdG9yOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsU0FBUyxNQUE0Qix1Q0FBdUM7QUFDbkYsT0FBT0MsU0FBUyxNQUE0QixvREFBb0Q7QUFDaEcsT0FBT0MsY0FBYyxNQUFpQyx5REFBeUQ7QUFDL0csT0FBT0MsZUFBZSxNQUFNLG9DQUFvQztBQUNoRSxPQUFPQyxlQUFlLE1BQU0sb0NBQW9DO0FBQ2hFLE9BQU9DLFlBQVksTUFBTSxpQ0FBaUM7QUFDMUQsT0FBT0MsZ0JBQWdCLE1BQU0sMkJBQTJCOztBQUV4RDtBQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUFJOztBQUUxQjtBQUNBLE1BQU1DLFlBQVksR0FBRyxDQUFDOztBQUV0QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxDQUFDO0FBRXZCLE1BQU1DLGFBQWEsR0FBRyxDQUFDLEdBQUdELGFBQWE7O0FBRXZDO0FBQ0EsTUFBTUUsMEJBQTBCLEdBQUcsT0FBTzs7QUFFMUM7QUFDQSxNQUFNQywyQkFBMkIsR0FBRyxTQUFTO0FBQzdDLE1BQU1DLDZCQUE2QixHQUFHLFNBQVM7O0FBRS9DO0FBQ0EsTUFBTUMsMkJBQTJCLEdBQUcsRUFBRTs7QUFFdEM7O0FBSUEsTUFBTUMsdUJBQXVCLFNBQVNiLGNBQWMsQ0FBQztFQUkzQ2MsNkJBQTZCLEdBQUcsQ0FBQztFQUtqQ0MsK0JBQStCLEdBQUcsQ0FBQztFQUluQ0MscUJBQXFCLEdBQUcsQ0FBQzs7RUFFakM7RUFDaUJDLHlCQUF5QixHQUFhLEVBQUU7RUFDeENDLDJCQUEyQixHQUFhLEVBQUU7O0VBRTNEOztFQUdPQyxXQUFXQSxDQUFFQyxxQkFBZ0QsRUFDaERDLHVCQUFrRCxFQUNsREMsZ0JBQTJDLEVBQzNDQyxrQkFBNkMsRUFDN0NDLGVBQWdELEVBQUc7SUFFckUsTUFBTUMsT0FBTyxHQUFHM0IsU0FBUyxDQUFnRSxDQUFDLENBQUUsQ0FDNUYsQ0FBQyxFQUFFMEIsZUFBZ0IsQ0FBQztJQUVwQixLQUFLLENBQUVDLE9BQVEsQ0FBQzs7SUFFaEI7SUFDQSxJQUFJLENBQUNILGdCQUFnQixHQUFHQSxnQkFBZ0I7SUFDeEMsSUFBSSxDQUFDQyxrQkFBa0IsR0FBR0Esa0JBQWtCOztJQUU1QztJQUNBLElBQUksQ0FBQ0csZ0JBQWdCLEdBQUdKLGdCQUFnQixDQUFDSyxLQUFLO0lBQzlDLElBQUksQ0FBQ0Msa0JBQWtCLEdBQUdOLGdCQUFnQixDQUFDSyxLQUFLOztJQUVoRDtJQUNBLElBQUksQ0FBQ0UsaUJBQWlCLEdBQUcsSUFBSTlCLFNBQVMsQ0FBRUksWUFBWSxFQUFFO01BQ3BEMkIsa0JBQWtCLEVBQUUsQ0FBQztNQUNyQkMsSUFBSSxFQUFFO0lBQ1IsQ0FBRSxDQUFDO0lBQ0gsSUFBSSxDQUFDRixpQkFBaUIsQ0FBQ0csT0FBTyxDQUFFLElBQUksQ0FBQ0MsY0FBZSxDQUFDOztJQUVyRDtJQUNBLElBQUksQ0FBQ0Msb0JBQW9CLEdBQUcsSUFBSSxDQUFDQyxZQUFZLENBQUNDLFVBQVUsQ0FBQyxDQUFDO0lBQzFELElBQUksQ0FBQ0Ysb0JBQW9CLENBQUNGLE9BQU8sQ0FBRSxJQUFJLENBQUNDLGNBQWUsQ0FBQzs7SUFFeEQ7SUFDQTtJQUNBLElBQUksQ0FBQ0ksb0JBQW9CLEdBQUcsSUFBSXRDLFNBQVMsQ0FBRUUsZUFBZSxFQUFFO01BQzFENkIsa0JBQWtCLEVBQUUsQ0FBQztNQUNyQkMsSUFBSSxFQUFFO0lBQ1IsQ0FBRSxDQUFDO0lBQ0gsSUFBSSxDQUFDTyxvQkFBb0IsR0FBRyxJQUFJdkMsU0FBUyxDQUFFRyxlQUFlLEVBQUU7TUFDMUQ0QixrQkFBa0IsRUFBRSxDQUFDO01BQ3JCQyxJQUFJLEVBQUU7SUFDUixDQUFFLENBQUM7O0lBRUg7SUFDQSxJQUFJLENBQUNNLG9CQUFvQixDQUFDTCxPQUFPLENBQUUsSUFBSSxDQUFDRSxvQkFBcUIsQ0FBQztJQUM5RCxJQUFJLENBQUNJLG9CQUFvQixDQUFDTixPQUFPLENBQUUsSUFBSSxDQUFDRSxvQkFBcUIsQ0FBQzs7SUFFOUQ7SUFDQSxJQUFJLENBQUNLLDhCQUE4QixHQUFHLE1BQU07TUFDMUM7SUFBQSxDQUNEO0VBQ0g7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7QUFDQTtFQUNTQyxJQUFJQSxDQUFFQyxFQUFVLEVBQVM7SUFFOUIsTUFBTUMsMEJBQTBCLEdBQUdDLElBQUksQ0FBQ0MsR0FBRyxDQUFFLElBQUksQ0FBQ2xCLGdCQUFnQixHQUFHLElBQUksQ0FBQ0osZ0JBQWdCLENBQUNLLEtBQU0sQ0FBQyxHQUFHYyxFQUFFO0lBQ3ZHLE1BQU1JLDRCQUE0QixHQUFHRixJQUFJLENBQUNDLEdBQUcsQ0FBRSxJQUFJLENBQUNoQixrQkFBa0IsR0FBRyxJQUFJLENBQUNMLGtCQUFrQixDQUFDSSxLQUFNLENBQUMsR0FBR2MsRUFBRTs7SUFFN0c7SUFDQTtJQUNBO0lBQ0E7SUFDQSxJQUFJLENBQUN4Qix5QkFBeUIsQ0FBQzZCLElBQUksQ0FBRUosMEJBQTJCLENBQUM7SUFDakUsSUFBSyxJQUFJLENBQUN6Qix5QkFBeUIsQ0FBQzhCLE1BQU0sR0FBR25DLDJCQUEyQixFQUFHO01BQ3pFLElBQUksQ0FBQ0sseUJBQXlCLENBQUMrQixLQUFLLENBQUMsQ0FBQztJQUN4QztJQUNBLE1BQU1DLHlCQUF5QixHQUFHLElBQUksQ0FBQ2hDLHlCQUF5QixDQUFDOEIsTUFBTSxJQUFJbkMsMkJBQTJCLEdBQ3BFLElBQUksQ0FBQ0sseUJBQXlCLENBQUNpQyxNQUFNLENBQUUsQ0FBRUMsS0FBSyxFQUFFQyxHQUFHLEtBQU1ELEtBQUssR0FBR0MsR0FBRyxFQUFFLENBQUUsQ0FBQyxHQUFHeEMsMkJBQTJCLEdBQ3ZHLENBQUM7SUFDbkMsSUFBSSxDQUFDTSwyQkFBMkIsQ0FBQzRCLElBQUksQ0FBRUQsNEJBQTZCLENBQUM7SUFDckUsSUFBSyxJQUFJLENBQUMzQiwyQkFBMkIsQ0FBQzZCLE1BQU0sR0FBR25DLDJCQUEyQixFQUFHO01BQzNFLElBQUksQ0FBQ00sMkJBQTJCLENBQUM4QixLQUFLLENBQUMsQ0FBQztJQUMxQztJQUNBLE1BQU1LLDJCQUEyQixHQUFHLElBQUksQ0FBQ25DLDJCQUEyQixDQUFDNkIsTUFBTSxJQUFJbkMsMkJBQTJCLEdBQ3RFLElBQUksQ0FBQ00sMkJBQTJCLENBQUNnQyxNQUFNLENBQUUsQ0FBRUMsS0FBSyxFQUFFQyxHQUFHLEtBQU1ELEtBQUssR0FBR0MsR0FBRyxFQUFFLENBQUUsQ0FBQyxHQUFHeEMsMkJBQTJCLEdBQ3pHLENBQUM7O0lBRXJDO0lBQ0EsSUFBSytCLElBQUksQ0FBQ0MsR0FBRyxDQUFFSyx5QkFBMEIsQ0FBQyxHQUFHeEMsMEJBQTBCLEVBQUc7TUFDeEUsSUFBSSxDQUFDSyw2QkFBNkIsR0FBR1QsYUFBYSxHQUFHRyxhQUFhO0lBQ3BFLENBQUMsTUFDSTtNQUNILElBQUksQ0FBQ00sNkJBQTZCLEdBQUc2QixJQUFJLENBQUNXLEdBQUcsQ0FBRSxJQUFJLENBQUN4Qyw2QkFBNkIsR0FBRzJCLEVBQUUsRUFBRSxDQUFFLENBQUM7SUFDN0Y7SUFFQSxJQUFLRSxJQUFJLENBQUNDLEdBQUcsQ0FBRVMsMkJBQTRCLENBQUMsR0FBRzVDLDBCQUEwQixFQUFHO01BQzFFLElBQUksQ0FBQ00sK0JBQStCLEdBQUdWLGFBQWEsR0FBR0csYUFBYTtJQUN0RSxDQUFDLE1BQ0k7TUFDSCxJQUFJLENBQUNPLCtCQUErQixHQUFHNEIsSUFBSSxDQUFDVyxHQUFHLENBQUUsSUFBSSxDQUFDdkMsK0JBQStCLEdBQUcwQixFQUFFLEVBQUUsQ0FBRSxDQUFDO0lBQ2pHOztJQUVBO0lBQ0EsSUFBSWMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDMUIsaUJBQWlCLENBQUMyQixXQUFXO0lBQ2pFLElBQUssSUFBSSxDQUFDMUMsNkJBQTZCLEdBQUdOLGFBQWEsRUFBRztNQUV4RDtNQUNBK0Msd0JBQXdCLEdBQUdaLElBQUksQ0FBQ2MsR0FBRyxDQUFFRix3QkFBd0IsR0FBR2pELFlBQVksR0FBR21DLEVBQUUsRUFBRSxDQUFFLENBQUM7SUFDeEYsQ0FBQyxNQUNJLElBQUssSUFBSSxDQUFDM0IsNkJBQTZCLEdBQUcsQ0FBQyxFQUFHO01BRWpEO01BQ0F5Qyx3QkFBd0IsR0FBR1osSUFBSSxDQUFDVyxHQUFHLENBQUVDLHdCQUF3QixHQUFHaEQsYUFBYSxHQUFHa0MsRUFBRSxFQUFFLENBQUUsQ0FBQztJQUN6RixDQUFDLE1BQ0k7TUFFSDtNQUNBYyx3QkFBd0IsR0FBRyxDQUFDO0lBQzlCO0lBQ0EsSUFBSSxDQUFDMUIsaUJBQWlCLENBQUM2QixjQUFjLENBQUVILHdCQUF5QixDQUFDOztJQUVqRTtJQUNBLElBQUtBLHdCQUF3QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzFCLGlCQUFpQixDQUFDOEIsU0FBUyxFQUFHO01BQ3ZFLElBQUksQ0FBQzlCLGlCQUFpQixDQUFDK0IsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQyxNQUNJLElBQUtMLHdCQUF3QixLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMxQixpQkFBaUIsQ0FBQzhCLFNBQVMsRUFBRztNQUM3RSxJQUFJLENBQUM5QixpQkFBaUIsQ0FBQ2dDLElBQUksQ0FBRSxHQUFJLENBQUM7SUFDcEM7O0lBRUE7SUFDQSxNQUFNQyxZQUFZLEdBQUcsQ0FBQyxHQUFHbkIsSUFBSSxDQUFDYyxHQUFHLENBQUUsSUFBSSxDQUFDbkMsZ0JBQWdCLENBQUNLLEtBQUssR0FBR2pCLDJCQUEyQixFQUFFLENBQUUsQ0FBQyxHQUFHLENBQUM7SUFDckcsSUFBSSxDQUFDbUIsaUJBQWlCLENBQUNrQyxlQUFlLENBQUVELFlBQWEsQ0FBQzs7SUFFdEQ7SUFDQSxJQUFLLElBQUksQ0FBQy9DLCtCQUErQixHQUFHUCxhQUFhLEVBQUc7TUFFMUQ7TUFDQSxJQUFJLENBQUNRLHFCQUFxQixHQUFHMkIsSUFBSSxDQUFDYyxHQUFHLENBQUUsSUFBSSxDQUFDekMscUJBQXFCLEdBQUdWLFlBQVksR0FBR21DLEVBQUUsRUFBRSxDQUFFLENBQUM7SUFDNUYsQ0FBQyxNQUNJLElBQUssSUFBSSxDQUFDMUIsK0JBQStCLEdBQUcsQ0FBQyxFQUFHO01BRW5EO01BQ0EsSUFBSSxDQUFDQyxxQkFBcUIsR0FBRzJCLElBQUksQ0FBQ1csR0FBRyxDQUFFLElBQUksQ0FBQ3RDLHFCQUFxQixHQUFHVCxhQUFhLEdBQUdrQyxFQUFFLEVBQUUsQ0FBRSxDQUFDO0lBQzdGLENBQUMsTUFDSTtNQUVIO01BQ0EsSUFBSSxDQUFDekIscUJBQXFCLEdBQUcsQ0FBQztJQUNoQztJQUNBLElBQUksQ0FBQ2tCLG9CQUFvQixDQUFDOEIsSUFBSSxDQUFDQyxjQUFjLENBQUUsSUFBSSxDQUFDakQscUJBQXFCLEVBQUUsQ0FBRSxDQUFDOztJQUU5RTtJQUNBLE1BQU1rRCxpQkFBaUIsR0FBR3JFLEtBQUssQ0FBQ3NFLEtBQUssQ0FBRSxDQUFDLEdBQUcsSUFBSSxDQUFDNUMsa0JBQWtCLENBQUNJLEtBQUssR0FBR2hCLDZCQUE2QixFQUFFLENBQUMsRUFBRSxDQUFFLENBQUM7SUFDaEgsSUFBSSxDQUFDMEIsb0JBQW9CLENBQUNxQixjQUFjLENBQUVRLGlCQUFrQixDQUFDO0lBQzdELElBQUksQ0FBQzVCLG9CQUFvQixDQUFDb0IsY0FBYyxDQUFFLENBQUMsR0FBR1EsaUJBQWtCLENBQUM7O0lBRWpFO0lBQ0EsSUFBSyxJQUFJLENBQUNsRCxxQkFBcUIsR0FBRyxDQUFDLEVBQUc7TUFDcEMsQ0FBQyxJQUFJLENBQUNxQixvQkFBb0IsQ0FBQ3NCLFNBQVMsSUFBSSxJQUFJLENBQUN0QixvQkFBb0IsQ0FBQ3VCLElBQUksQ0FBQyxDQUFDO01BQ3hFLENBQUMsSUFBSSxDQUFDdEIsb0JBQW9CLENBQUNxQixTQUFTLElBQUksSUFBSSxDQUFDckIsb0JBQW9CLENBQUNzQixJQUFJLENBQUMsQ0FBQztJQUMxRSxDQUFDLE1BQ0ksSUFBSyxJQUFJLENBQUM1QyxxQkFBcUIsS0FBSyxDQUFDLEVBQUc7TUFDM0MsSUFBSSxDQUFDcUIsb0JBQW9CLENBQUNzQixTQUFTLElBQUksSUFBSSxDQUFDdEIsb0JBQW9CLENBQUN3QixJQUFJLENBQUUsR0FBSSxDQUFDO01BQzVFLElBQUksQ0FBQ3ZCLG9CQUFvQixDQUFDcUIsU0FBUyxJQUFJLElBQUksQ0FBQ3JCLG9CQUFvQixDQUFDdUIsSUFBSSxDQUFFLEdBQUksQ0FBQztJQUM5RTs7SUFFQTtJQUNBLElBQUksQ0FBQ25DLGdCQUFnQixHQUFHLElBQUksQ0FBQ0osZ0JBQWdCLENBQUNLLEtBQUs7SUFDbkQsSUFBSSxDQUFDQyxrQkFBa0IsR0FBRyxJQUFJLENBQUNMLGtCQUFrQixDQUFDSSxLQUFLO0VBQ3pEO0VBRU95QyxLQUFLQSxDQUFBLEVBQVM7SUFDbkIsSUFBSSxDQUFDdEQsNkJBQTZCLEdBQUcsQ0FBQztJQUN0QyxJQUFJLENBQUNlLGlCQUFpQixDQUFDMkIsV0FBVyxHQUFHLENBQUM7SUFDdEMsSUFBSSxDQUFDM0IsaUJBQWlCLENBQUNnQyxJQUFJLENBQUUsR0FBSSxDQUFDO0lBQ2xDLElBQUksQ0FBQ2hDLGlCQUFpQixDQUFDa0MsZUFBZSxDQUFFLENBQUUsQ0FBQztJQUMzQyxJQUFJLENBQUNyQyxnQkFBZ0IsR0FBRyxDQUFDO0VBQzNCO0VBRWdCMkMsT0FBT0EsQ0FBQSxFQUFTO0lBQzlCLElBQUksQ0FBQzlCLDhCQUE4QixDQUFDLENBQUM7SUFDckMsS0FBSyxDQUFDOEIsT0FBTyxDQUFDLENBQUM7RUFDakI7QUFDRjtBQUVBakUsZ0JBQWdCLENBQUNrRSxRQUFRLENBQUUseUJBQXlCLEVBQUV6RCx1QkFBd0IsQ0FBQztBQUMvRSxlQUFlQSx1QkFBdUIifQ==