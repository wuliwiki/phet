// Copyright 2021-2023, University of Colorado Boulder

/**
 * EMWaveSource produces simulated waves of electromagnetic energy.
 */

import NumberProperty from '../../../../axon/js/NumberProperty.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import Range from '../../../../dot/js/Range.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import optionize from '../../../../phet-core/js/optionize.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import ArrayIO from '../../../../tandem/js/types/ArrayIO.js';
import InfiniteNumberIO from '../../../../tandem/js/types/InfiniteNumberIO.js';
import IOType from '../../../../tandem/js/types/IOType.js';
import MapIO from '../../../../tandem/js/types/MapIO.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import ReferenceIO from '../../../../tandem/js/types/ReferenceIO.js';
import GreenhouseEffectQueryParameters from '../../common/GreenhouseEffectQueryParameters.js';
import greenhouseEffect from '../../greenhouseEffect.js';
import Wave from './Wave.js';
// constants
const WAVE_GAPS_ENABLED = GreenhouseEffectQueryParameters.waveGapsEnabled;

/**
 * simple inner class for amalgamating the information needed to space out the waves
 */
class WaveCreationSpec {
  constructor(originX, propagationDirection, timeToCreation) {
    this.countdown = timeToCreation;
    this.propagationDirection = propagationDirection;
    this.originX = originX;
  }
  toStateObject() {
    return {
      countdown: this.countdown,
      propagationDirection: Vector2.Vector2IO.toStateObject(this.propagationDirection),
      originX: this.originX
    };
  }
  static WaveCreationSpecIO = new IOType('WaveCreationSpecIO', {
    valueType: WaveCreationSpec,
    stateSchema: {
      countdown: NumberIO,
      propagationDirection: Vector2.Vector2IO,
      originX: NumberIO
    },
    toStateObject: waveCreationSpec => waveCreationSpec.toStateObject(),
    fromStateObject: stateObject => new WaveCreationSpec(stateObject.originX, Vector2.Vector2IO.fromStateObject(stateObject.propagationDirection), stateObject.countdown)
  });
}
class EMWaveSource extends PhetioObject {
  // altitude from which waves originate

  // controls whether waves should be produced

  // map of waves produced by this wave source to their lifetimes

  // queue of waves that are queued for creation

  // other information necessary for the methods to do their thing

  /**
   * @param waveGroup
   * @param waveProductionEnabledProperty
   * @param wavelength - wavelength of waves to produce, in meters
   * @param waveStartAltitude - altitude from which waves will originate, it meters
   * @param waveEndAltitude - altitude at which the waves will terminate, it meters
   * @param waveSourceSpecs - specifications that define where the waves will be created
   * @param [providedOptions]
   */
  constructor(waveGroup, waveProductionEnabledProperty, wavelength, waveStartAltitude, waveEndAltitude, waveSourceSpecs, providedOptions) {
    const options = optionize()({
      waveIntensityProperty: null,
      interWaveTime: 0.75,
      waveLifetimeRange: new Range(10, 15),
      phetioType: EMWaveSource.EMWaveSourceIO
    }, providedOptions);
    super(options);

    // If no wave intensity Property was provided, create one, and assume max intensity.
    this.waveIntensityProperty = options.waveIntensityProperty || new NumberProperty(1);

    // Initialize other attributes of this wave source.
    this.waveStartAltitude = waveStartAltitude;
    this.waveProductionEnabledProperty = waveProductionEnabledProperty;
    this.waveGroup = waveGroup;
    this.wavelength = wavelength;
    this.waveEndAltitude = waveEndAltitude;
    this.waveSourceSpecs = waveSourceSpecs;
    this.interWaveTime = options.interWaveTime;
    this.waveLifetimeRange = options.waveLifetimeRange;
    this.wavesToLifetimesMap = new Map();
    this.waveCreationQueue = [];
  }

  /**
   * Step forward in time.
   */
  step(dt) {
    const waveIntensity = this.waveIntensityProperty.value;
    this.waveSourceSpecs.forEach(waveSourceSpec => {
      // Look for a wave that matches these parameters in the set of all waves in the model.
      const matchingWave = this.waveGroup.find(wave => wave.wavelength === this.wavelength && wave.isSourced && waveSourceSpec.xPosition === wave.origin.x && wave.origin.y === this.waveStartAltitude);

      // See whether there is a wave that is queued for creation that matches these parameters.
      const waveIsQueued = this.waveCreationQueue.reduce((previousValue, queuedWaveSpec) => previousValue || queuedWaveSpec.propagationDirection.equals(waveSourceSpec.propagationDirection) && queuedWaveSpec.originX === waveSourceSpec.xPosition, false);

      // If the wave doesn't exist yet and isn't queued for creation, but SHOULD exist, create it.
      if (!matchingWave && !waveIsQueued && this.waveProductionEnabledProperty.value) {
        this.addWaveToModel(waveSourceSpec.xPosition, waveSourceSpec.propagationDirection);
      }

      // If the wave already exists, update it.
      else if (matchingWave) {
        if (!this.waveProductionEnabledProperty.value || matchingWave.existenceTime > this.wavesToLifetimesMap.get(matchingWave)) {
          // This wave is done being produced.  Set it to propagate on its own.
          matchingWave.isSourced = false;
          this.wavesToLifetimesMap.delete(matchingWave);

          // If wave production is enabled, queue up a new wave to replace the one that just ended.
          if (this.waveProductionEnabledProperty.value) {
            // Queue up a wave for creation after the spacing time.
            this.waveCreationQueue.push(new WaveCreationSpec(waveSourceSpec.xPosition, waveSourceSpec.propagationDirection, this.interWaveTime));
          }
        }
        if (matchingWave.getIntensityAtDistance(0) !== waveIntensity) {
          // Update the intensity.
          matchingWave.setIntensityAtStart(waveIntensity);
        }
      }
    });

    // See if it's time to create any of the queued up waves.
    this.waveCreationQueue.forEach(waveCreationSpec => {
      waveCreationSpec.countdown -= dt;
      if (waveCreationSpec.countdown <= 0) {
        // Create the wave.
        this.addWaveToModel(waveCreationSpec.originX, waveCreationSpec.propagationDirection);
      }
    });

    // Remove any expired wave creation specs.
    this.waveCreationQueue = this.waveCreationQueue.filter(waveSpec => waveSpec.countdown > 0);
  }
  addWaveToModel(originX, propagationDirection) {
    const newIRWave = this.waveGroup.createNextElement(this.wavelength, new Vector2(originX, this.waveStartAltitude), propagationDirection, this.waveEndAltitude, {
      intensityAtStart: this.waveIntensityProperty.value
    });

    // If wave gaps are enabled, the newly created wave should have a limited lifetime, after which a new wave with the
    // same parameters will be created nearby.  If gaps aren't enabled, the lifetime is set to infinity, and the wave
    // will only go away when the source stops producing it.
    let waveLifetime;
    if (WAVE_GAPS_ENABLED) {
      waveLifetime = dotRandom.nextDoubleBetween(this.waveLifetimeRange.min, this.waveLifetimeRange.max);
    } else {
      waveLifetime = Number.POSITIVE_INFINITY;
    }
    this.wavesToLifetimesMap.set(newIRWave, waveLifetime);
  }

  /**
   * Reset the wave source.
   */
  reset() {
    this.wavesToLifetimesMap.clear();
    this.waveCreationQueue.length = 0;
  }
  toStateObject() {
    return {
      wavesToLifetimesMap: MapIO(ReferenceIO(Wave.WaveIO), InfiniteNumberIO).toStateObject(this.wavesToLifetimesMap),
      waveCreationQueue: ArrayIO(WaveCreationSpec.WaveCreationSpecIO).toStateObject(this.waveCreationQueue)
    };
  }
  applyState(stateObject) {
    this.wavesToLifetimesMap = MapIO(ReferenceIO(Wave.WaveIO), NumberIO).fromStateObject(stateObject.wavesToLifetimesMap);
    this.waveCreationQueue = ArrayIO(WaveCreationSpec.WaveCreationSpecIO).fromStateObject(stateObject.waveCreationQueue);
  }

  /**
   * EMWaveSourceIO handles PhET-iO serialization of the EMWaveSource. Because serialization involves accessing private
   * members, it delegates to EMWaveSource. The methods that EMWaveSourceIO overrides are typical of 'Dynamic element
   * serialization', as described in the Serialization section of
   * https://github.com/phetsims/phet-io/blob/master/doc/phet-io-instrumentation-technical-guide.md#serialization
   */
  static EMWaveSourceIO = new IOType('EMWaveSourceIO', {
    valueType: EMWaveSource,
    stateSchema: {
      wavesToLifetimesMap: MapIO(ReferenceIO(Wave.WaveIO), NumberIO),
      waveCreationQueue: ArrayIO(WaveCreationSpec.WaveCreationSpecIO)
    },
    applyState: (emWaveSource, stateObject) => emWaveSource.applyState(stateObject),
    toStateObject: emWaveSource => emWaveSource.toStateObject()
  });
}
greenhouseEffect.register('EMWaveSource', EMWaveSource);
export default EMWaveSource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOdW1iZXJQcm9wZXJ0eSIsImRvdFJhbmRvbSIsIlJhbmdlIiwiVmVjdG9yMiIsIm9wdGlvbml6ZSIsIlBoZXRpb09iamVjdCIsIkFycmF5SU8iLCJJbmZpbml0ZU51bWJlcklPIiwiSU9UeXBlIiwiTWFwSU8iLCJOdW1iZXJJTyIsIlJlZmVyZW5jZUlPIiwiR3JlZW5ob3VzZUVmZmVjdFF1ZXJ5UGFyYW1ldGVycyIsImdyZWVuaG91c2VFZmZlY3QiLCJXYXZlIiwiV0FWRV9HQVBTX0VOQUJMRUQiLCJ3YXZlR2Fwc0VuYWJsZWQiLCJXYXZlQ3JlYXRpb25TcGVjIiwiY29uc3RydWN0b3IiLCJvcmlnaW5YIiwicHJvcGFnYXRpb25EaXJlY3Rpb24iLCJ0aW1lVG9DcmVhdGlvbiIsImNvdW50ZG93biIsInRvU3RhdGVPYmplY3QiLCJWZWN0b3IySU8iLCJXYXZlQ3JlYXRpb25TcGVjSU8iLCJ2YWx1ZVR5cGUiLCJzdGF0ZVNjaGVtYSIsIndhdmVDcmVhdGlvblNwZWMiLCJmcm9tU3RhdGVPYmplY3QiLCJzdGF0ZU9iamVjdCIsIkVNV2F2ZVNvdXJjZSIsIndhdmVHcm91cCIsIndhdmVQcm9kdWN0aW9uRW5hYmxlZFByb3BlcnR5Iiwid2F2ZWxlbmd0aCIsIndhdmVTdGFydEFsdGl0dWRlIiwid2F2ZUVuZEFsdGl0dWRlIiwid2F2ZVNvdXJjZVNwZWNzIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsIndhdmVJbnRlbnNpdHlQcm9wZXJ0eSIsImludGVyV2F2ZVRpbWUiLCJ3YXZlTGlmZXRpbWVSYW5nZSIsInBoZXRpb1R5cGUiLCJFTVdhdmVTb3VyY2VJTyIsIndhdmVzVG9MaWZldGltZXNNYXAiLCJNYXAiLCJ3YXZlQ3JlYXRpb25RdWV1ZSIsInN0ZXAiLCJkdCIsIndhdmVJbnRlbnNpdHkiLCJ2YWx1ZSIsImZvckVhY2giLCJ3YXZlU291cmNlU3BlYyIsIm1hdGNoaW5nV2F2ZSIsImZpbmQiLCJ3YXZlIiwiaXNTb3VyY2VkIiwieFBvc2l0aW9uIiwib3JpZ2luIiwieCIsInkiLCJ3YXZlSXNRdWV1ZWQiLCJyZWR1Y2UiLCJwcmV2aW91c1ZhbHVlIiwicXVldWVkV2F2ZVNwZWMiLCJlcXVhbHMiLCJhZGRXYXZlVG9Nb2RlbCIsImV4aXN0ZW5jZVRpbWUiLCJnZXQiLCJkZWxldGUiLCJwdXNoIiwiZ2V0SW50ZW5zaXR5QXREaXN0YW5jZSIsInNldEludGVuc2l0eUF0U3RhcnQiLCJmaWx0ZXIiLCJ3YXZlU3BlYyIsIm5ld0lSV2F2ZSIsImNyZWF0ZU5leHRFbGVtZW50IiwiaW50ZW5zaXR5QXRTdGFydCIsIndhdmVMaWZldGltZSIsIm5leHREb3VibGVCZXR3ZWVuIiwibWluIiwibWF4IiwiTnVtYmVyIiwiUE9TSVRJVkVfSU5GSU5JVFkiLCJzZXQiLCJyZXNldCIsImNsZWFyIiwibGVuZ3RoIiwiV2F2ZUlPIiwiYXBwbHlTdGF0ZSIsImVtV2F2ZVNvdXJjZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRU1XYXZlU291cmNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEVNV2F2ZVNvdXJjZSBwcm9kdWNlcyBzaW11bGF0ZWQgd2F2ZXMgb2YgZWxlY3Ryb21hZ25ldGljIGVuZXJneS5cclxuICovXHJcblxyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyLCB7IFZlY3RvcjJTdGF0ZU9iamVjdCB9IGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IFBoZXRpb0dyb3VwIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9Hcm91cC5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QsIHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgQXJyYXlJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvQXJyYXlJTy5qcyc7XHJcbmltcG9ydCBJbmZpbml0ZU51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JbmZpbml0ZU51bWJlcklPLmpzJztcclxuaW1wb3J0IElPVHlwZSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvSU9UeXBlLmpzJztcclxuaW1wb3J0IE1hcElPLCB7IE1hcFN0YXRlT2JqZWN0IH0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL01hcElPLmpzJztcclxuaW1wb3J0IE51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdW1iZXJJTy5qcyc7XHJcbmltcG9ydCBSZWZlcmVuY2VJTywgeyBSZWZlcmVuY2VJT1N0YXRlIH0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL1JlZmVyZW5jZUlPLmpzJztcclxuaW1wb3J0IEdyZWVuaG91c2VFZmZlY3RRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vLi4vY29tbW9uL0dyZWVuaG91c2VFZmZlY3RRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgZ3JlZW5ob3VzZUVmZmVjdCBmcm9tICcuLi8uLi9ncmVlbmhvdXNlRWZmZWN0LmpzJztcclxuaW1wb3J0IFdhdmUsIHsgV2F2ZUNyZWF0b3JBcmd1bWVudHMgfSBmcm9tICcuL1dhdmUuanMnO1xyXG5pbXBvcnQgV2F2ZVNvdXJjZVNwZWMgZnJvbSAnLi9XYXZlU291cmNlU3BlYy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgV0FWRV9HQVBTX0VOQUJMRUQgPSBHcmVlbmhvdXNlRWZmZWN0UXVlcnlQYXJhbWV0ZXJzLndhdmVHYXBzRW5hYmxlZDtcclxuXHJcbi8qKlxyXG4gKiBzaW1wbGUgaW5uZXIgY2xhc3MgZm9yIGFtYWxnYW1hdGluZyB0aGUgaW5mb3JtYXRpb24gbmVlZGVkIHRvIHNwYWNlIG91dCB0aGUgd2F2ZXNcclxuICovXHJcbmNsYXNzIFdhdmVDcmVhdGlvblNwZWMge1xyXG4gIHB1YmxpYyBjb3VudGRvd246IG51bWJlcjtcclxuICBwdWJsaWMgcmVhZG9ubHkgcHJvcGFnYXRpb25EaXJlY3Rpb246IFZlY3RvcjI7XHJcbiAgcHVibGljIHJlYWRvbmx5IG9yaWdpblg6IG51bWJlcjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBvcmlnaW5YOiBudW1iZXIsIHByb3BhZ2F0aW9uRGlyZWN0aW9uOiBWZWN0b3IyLCB0aW1lVG9DcmVhdGlvbjogbnVtYmVyICkge1xyXG4gICAgdGhpcy5jb3VudGRvd24gPSB0aW1lVG9DcmVhdGlvbjtcclxuICAgIHRoaXMucHJvcGFnYXRpb25EaXJlY3Rpb24gPSBwcm9wYWdhdGlvbkRpcmVjdGlvbjtcclxuICAgIHRoaXMub3JpZ2luWCA9IG9yaWdpblg7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgdG9TdGF0ZU9iamVjdCgpOiBXYXZlQ3JlYXRpb25TcGVjU3RhdGVPYmplY3Qge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgY291bnRkb3duOiB0aGlzLmNvdW50ZG93bixcclxuICAgICAgcHJvcGFnYXRpb25EaXJlY3Rpb246IFZlY3RvcjIuVmVjdG9yMklPLnRvU3RhdGVPYmplY3QoIHRoaXMucHJvcGFnYXRpb25EaXJlY3Rpb24gKSxcclxuICAgICAgb3JpZ2luWDogdGhpcy5vcmlnaW5YXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBXYXZlQ3JlYXRpb25TcGVjSU8gPSBuZXcgSU9UeXBlPFdhdmVDcmVhdGlvblNwZWMsIFdhdmVDcmVhdGlvblNwZWNTdGF0ZU9iamVjdD4oICdXYXZlQ3JlYXRpb25TcGVjSU8nLCB7XHJcbiAgICB2YWx1ZVR5cGU6IFdhdmVDcmVhdGlvblNwZWMsXHJcbiAgICBzdGF0ZVNjaGVtYToge1xyXG4gICAgICBjb3VudGRvd246IE51bWJlcklPLFxyXG4gICAgICBwcm9wYWdhdGlvbkRpcmVjdGlvbjogVmVjdG9yMi5WZWN0b3IySU8sXHJcbiAgICAgIG9yaWdpblg6IE51bWJlcklPXHJcbiAgICB9LFxyXG4gICAgdG9TdGF0ZU9iamVjdDogKCB3YXZlQ3JlYXRpb25TcGVjOiBXYXZlQ3JlYXRpb25TcGVjICkgPT4gd2F2ZUNyZWF0aW9uU3BlYy50b1N0YXRlT2JqZWN0KCksXHJcbiAgICBmcm9tU3RhdGVPYmplY3Q6ICggc3RhdGVPYmplY3Q6IFdhdmVDcmVhdGlvblNwZWNTdGF0ZU9iamVjdCApID0+IG5ldyBXYXZlQ3JlYXRpb25TcGVjKFxyXG4gICAgICBzdGF0ZU9iamVjdC5vcmlnaW5YLFxyXG4gICAgICBWZWN0b3IyLlZlY3RvcjJJTy5mcm9tU3RhdGVPYmplY3QoIHN0YXRlT2JqZWN0LnByb3BhZ2F0aW9uRGlyZWN0aW9uICksXHJcbiAgICAgIHN0YXRlT2JqZWN0LmNvdW50ZG93blxyXG4gICAgKVxyXG4gIH0gKTtcclxufVxyXG5cclxudHlwZSBXYXZlQ3JlYXRpb25TcGVjU3RhdGVPYmplY3QgPSB7XHJcbiAgY291bnRkb3duOiBudW1iZXI7XHJcbiAgcHJvcGFnYXRpb25EaXJlY3Rpb246IFZlY3RvcjJTdGF0ZU9iamVjdDtcclxuICBvcmlnaW5YOiBudW1iZXI7XHJcbn07XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBBIHByb3BlcnR5IHRoYXQgaW5kaWNhdGVzIHdoYXQgdGhlIHByb2R1Y2VkIHdhdmUgaW50ZW5zaXR5IHNob3VsZCBiZS4gIEEgUHJvcGVydHkgZm9yIHRoaXMgd2lsbCBiZSBjcmVhdGVkIGlmIG5vbmVcclxuICAvLyBpcyBwcm92aWRlZC5cclxuICB3YXZlSW50ZW5zaXR5UHJvcGVydHk/OiBudWxsIHwgVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gdGltZSBiZXR3ZWVuIHdhdmVzLCBpbiBzZWNvbmRzXHJcbiAgaW50ZXJXYXZlVGltZT86IG51bWJlcjtcclxuXHJcbiAgLy8gcmFuZ2Ugb2YgbGlmZXRpbWVzIGZvciB0aGlzIHdhdmUsIGluIHNlY29uZHNcclxuICB3YXZlTGlmZXRpbWVSYW5nZT86IFJhbmdlO1xyXG59O1xyXG5leHBvcnQgdHlwZSBFTVdhdmVTb3VyY2VPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaGV0aW9PYmplY3RPcHRpb25zICYgUGlja1JlcXVpcmVkPFBoZXRpb09iamVjdE9wdGlvbnMsICd0YW5kZW0nPjtcclxuXHJcbmNsYXNzIEVNV2F2ZVNvdXJjZSBleHRlbmRzIFBoZXRpb09iamVjdCB7XHJcblxyXG4gIC8vIGFsdGl0dWRlIGZyb20gd2hpY2ggd2F2ZXMgb3JpZ2luYXRlXHJcbiAgcHVibGljIHJlYWRvbmx5IHdhdmVTdGFydEFsdGl0dWRlOiBudW1iZXI7XHJcblxyXG4gIC8vIGNvbnRyb2xzIHdoZXRoZXIgd2F2ZXMgc2hvdWxkIGJlIHByb2R1Y2VkXHJcbiAgcHJpdmF0ZSByZWFkb25seSB3YXZlSW50ZW5zaXR5UHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIG1hcCBvZiB3YXZlcyBwcm9kdWNlZCBieSB0aGlzIHdhdmUgc291cmNlIHRvIHRoZWlyIGxpZmV0aW1lc1xyXG4gIHByaXZhdGUgd2F2ZXNUb0xpZmV0aW1lc01hcDogTWFwPFdhdmUsIG51bWJlcj47XHJcblxyXG4gIC8vIHF1ZXVlIG9mIHdhdmVzIHRoYXQgYXJlIHF1ZXVlZCBmb3IgY3JlYXRpb25cclxuICBwcml2YXRlIHdhdmVDcmVhdGlvblF1ZXVlOiBXYXZlQ3JlYXRpb25TcGVjW107XHJcblxyXG4gIC8vIG90aGVyIGluZm9ybWF0aW9uIG5lY2Vzc2FyeSBmb3IgdGhlIG1ldGhvZHMgdG8gZG8gdGhlaXIgdGhpbmdcclxuICBwcml2YXRlIHJlYWRvbmx5IHdhdmVQcm9kdWN0aW9uRW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHdhdmVHcm91cDogUGhldGlvR3JvdXA8V2F2ZSwgV2F2ZUNyZWF0b3JBcmd1bWVudHM+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgd2F2ZWxlbmd0aDogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgd2F2ZUVuZEFsdGl0dWRlOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB3YXZlU291cmNlU3BlY3M6IFdhdmVTb3VyY2VTcGVjW107XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpbnRlcldhdmVUaW1lOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB3YXZlTGlmZXRpbWVSYW5nZTogUmFuZ2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB3YXZlR3JvdXBcclxuICAgKiBAcGFyYW0gd2F2ZVByb2R1Y3Rpb25FbmFibGVkUHJvcGVydHlcclxuICAgKiBAcGFyYW0gd2F2ZWxlbmd0aCAtIHdhdmVsZW5ndGggb2Ygd2F2ZXMgdG8gcHJvZHVjZSwgaW4gbWV0ZXJzXHJcbiAgICogQHBhcmFtIHdhdmVTdGFydEFsdGl0dWRlIC0gYWx0aXR1ZGUgZnJvbSB3aGljaCB3YXZlcyB3aWxsIG9yaWdpbmF0ZSwgaXQgbWV0ZXJzXHJcbiAgICogQHBhcmFtIHdhdmVFbmRBbHRpdHVkZSAtIGFsdGl0dWRlIGF0IHdoaWNoIHRoZSB3YXZlcyB3aWxsIHRlcm1pbmF0ZSwgaXQgbWV0ZXJzXHJcbiAgICogQHBhcmFtIHdhdmVTb3VyY2VTcGVjcyAtIHNwZWNpZmljYXRpb25zIHRoYXQgZGVmaW5lIHdoZXJlIHRoZSB3YXZlcyB3aWxsIGJlIGNyZWF0ZWRcclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHdhdmVHcm91cDogUGhldGlvR3JvdXA8V2F2ZSwgV2F2ZUNyZWF0b3JBcmd1bWVudHM+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgd2F2ZVByb2R1Y3Rpb25FbmFibGVkUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PGJvb2xlYW4+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgd2F2ZWxlbmd0aDogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgd2F2ZVN0YXJ0QWx0aXR1ZGU6IG51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgIHdhdmVFbmRBbHRpdHVkZTogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgd2F2ZVNvdXJjZVNwZWNzOiBXYXZlU291cmNlU3BlY1tdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRPcHRpb25zPzogRU1XYXZlU291cmNlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEVNV2F2ZVNvdXJjZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBQaGV0aW9PYmplY3RPcHRpb25zPigpKCB7XHJcbiAgICAgIHdhdmVJbnRlbnNpdHlQcm9wZXJ0eTogbnVsbCxcclxuICAgICAgaW50ZXJXYXZlVGltZTogMC43NSxcclxuICAgICAgd2F2ZUxpZmV0aW1lUmFuZ2U6IG5ldyBSYW5nZSggMTAsIDE1ICksXHJcbiAgICAgIHBoZXRpb1R5cGU6IEVNV2F2ZVNvdXJjZS5FTVdhdmVTb3VyY2VJT1xyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBJZiBubyB3YXZlIGludGVuc2l0eSBQcm9wZXJ0eSB3YXMgcHJvdmlkZWQsIGNyZWF0ZSBvbmUsIGFuZCBhc3N1bWUgbWF4IGludGVuc2l0eS5cclxuICAgIHRoaXMud2F2ZUludGVuc2l0eVByb3BlcnR5ID0gb3B0aW9ucy53YXZlSW50ZW5zaXR5UHJvcGVydHkgfHwgbmV3IE51bWJlclByb3BlcnR5KCAxICk7XHJcblxyXG4gICAgLy8gSW5pdGlhbGl6ZSBvdGhlciBhdHRyaWJ1dGVzIG9mIHRoaXMgd2F2ZSBzb3VyY2UuXHJcbiAgICB0aGlzLndhdmVTdGFydEFsdGl0dWRlID0gd2F2ZVN0YXJ0QWx0aXR1ZGU7XHJcbiAgICB0aGlzLndhdmVQcm9kdWN0aW9uRW5hYmxlZFByb3BlcnR5ID0gd2F2ZVByb2R1Y3Rpb25FbmFibGVkUHJvcGVydHk7XHJcbiAgICB0aGlzLndhdmVHcm91cCA9IHdhdmVHcm91cDtcclxuICAgIHRoaXMud2F2ZWxlbmd0aCA9IHdhdmVsZW5ndGg7XHJcbiAgICB0aGlzLndhdmVFbmRBbHRpdHVkZSA9IHdhdmVFbmRBbHRpdHVkZTtcclxuICAgIHRoaXMud2F2ZVNvdXJjZVNwZWNzID0gd2F2ZVNvdXJjZVNwZWNzO1xyXG4gICAgdGhpcy5pbnRlcldhdmVUaW1lID0gb3B0aW9ucy5pbnRlcldhdmVUaW1lITtcclxuICAgIHRoaXMud2F2ZUxpZmV0aW1lUmFuZ2UgPSBvcHRpb25zLndhdmVMaWZldGltZVJhbmdlITtcclxuICAgIHRoaXMud2F2ZXNUb0xpZmV0aW1lc01hcCA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMud2F2ZUNyZWF0aW9uUXVldWUgPSBbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0ZXAgZm9yd2FyZCBpbiB0aW1lLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGVwKCBkdDogbnVtYmVyICk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHdhdmVJbnRlbnNpdHkgPSB0aGlzLndhdmVJbnRlbnNpdHlQcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICB0aGlzLndhdmVTb3VyY2VTcGVjcy5mb3JFYWNoKCB3YXZlU291cmNlU3BlYyA9PiB7XHJcblxyXG4gICAgICAvLyBMb29rIGZvciBhIHdhdmUgdGhhdCBtYXRjaGVzIHRoZXNlIHBhcmFtZXRlcnMgaW4gdGhlIHNldCBvZiBhbGwgd2F2ZXMgaW4gdGhlIG1vZGVsLlxyXG4gICAgICBjb25zdCBtYXRjaGluZ1dhdmUgPSB0aGlzLndhdmVHcm91cC5maW5kKCAoIHdhdmU6IFdhdmUgKSA9PlxyXG4gICAgICAgIHdhdmUud2F2ZWxlbmd0aCA9PT0gdGhpcy53YXZlbGVuZ3RoICYmXHJcbiAgICAgICAgd2F2ZS5pc1NvdXJjZWQgJiYgd2F2ZVNvdXJjZVNwZWMueFBvc2l0aW9uID09PSB3YXZlLm9yaWdpbi54ICYmXHJcbiAgICAgICAgd2F2ZS5vcmlnaW4ueSA9PT0gdGhpcy53YXZlU3RhcnRBbHRpdHVkZVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gU2VlIHdoZXRoZXIgdGhlcmUgaXMgYSB3YXZlIHRoYXQgaXMgcXVldWVkIGZvciBjcmVhdGlvbiB0aGF0IG1hdGNoZXMgdGhlc2UgcGFyYW1ldGVycy5cclxuICAgICAgY29uc3Qgd2F2ZUlzUXVldWVkID0gdGhpcy53YXZlQ3JlYXRpb25RdWV1ZS5yZWR1Y2UoICggcHJldmlvdXNWYWx1ZSwgcXVldWVkV2F2ZVNwZWMgKSA9PlxyXG4gICAgICAgICAgcHJldmlvdXNWYWx1ZSB8fCBxdWV1ZWRXYXZlU3BlYy5wcm9wYWdhdGlvbkRpcmVjdGlvbi5lcXVhbHMoIHdhdmVTb3VyY2VTcGVjLnByb3BhZ2F0aW9uRGlyZWN0aW9uICkgJiZcclxuICAgICAgICAgIHF1ZXVlZFdhdmVTcGVjLm9yaWdpblggPT09IHdhdmVTb3VyY2VTcGVjLnhQb3NpdGlvbixcclxuICAgICAgICBmYWxzZVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gSWYgdGhlIHdhdmUgZG9lc24ndCBleGlzdCB5ZXQgYW5kIGlzbid0IHF1ZXVlZCBmb3IgY3JlYXRpb24sIGJ1dCBTSE9VTEQgZXhpc3QsIGNyZWF0ZSBpdC5cclxuICAgICAgaWYgKCAhbWF0Y2hpbmdXYXZlICYmICF3YXZlSXNRdWV1ZWQgJiYgdGhpcy53YXZlUHJvZHVjdGlvbkVuYWJsZWRQcm9wZXJ0eS52YWx1ZSApIHtcclxuICAgICAgICB0aGlzLmFkZFdhdmVUb01vZGVsKCB3YXZlU291cmNlU3BlYy54UG9zaXRpb24sIHdhdmVTb3VyY2VTcGVjLnByb3BhZ2F0aW9uRGlyZWN0aW9uICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIElmIHRoZSB3YXZlIGFscmVhZHkgZXhpc3RzLCB1cGRhdGUgaXQuXHJcbiAgICAgIGVsc2UgaWYgKCBtYXRjaGluZ1dhdmUgKSB7XHJcblxyXG4gICAgICAgIGlmICggIXRoaXMud2F2ZVByb2R1Y3Rpb25FbmFibGVkUHJvcGVydHkudmFsdWUgfHxcclxuICAgICAgICAgICAgIG1hdGNoaW5nV2F2ZS5leGlzdGVuY2VUaW1lID4gdGhpcy53YXZlc1RvTGlmZXRpbWVzTWFwLmdldCggbWF0Y2hpbmdXYXZlICkhICkge1xyXG5cclxuICAgICAgICAgIC8vIFRoaXMgd2F2ZSBpcyBkb25lIGJlaW5nIHByb2R1Y2VkLiAgU2V0IGl0IHRvIHByb3BhZ2F0ZSBvbiBpdHMgb3duLlxyXG4gICAgICAgICAgbWF0Y2hpbmdXYXZlLmlzU291cmNlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy53YXZlc1RvTGlmZXRpbWVzTWFwLmRlbGV0ZSggbWF0Y2hpbmdXYXZlICk7XHJcblxyXG4gICAgICAgICAgLy8gSWYgd2F2ZSBwcm9kdWN0aW9uIGlzIGVuYWJsZWQsIHF1ZXVlIHVwIGEgbmV3IHdhdmUgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQganVzdCBlbmRlZC5cclxuICAgICAgICAgIGlmICggdGhpcy53YXZlUHJvZHVjdGlvbkVuYWJsZWRQcm9wZXJ0eS52YWx1ZSApIHtcclxuXHJcbiAgICAgICAgICAgIC8vIFF1ZXVlIHVwIGEgd2F2ZSBmb3IgY3JlYXRpb24gYWZ0ZXIgdGhlIHNwYWNpbmcgdGltZS5cclxuICAgICAgICAgICAgdGhpcy53YXZlQ3JlYXRpb25RdWV1ZS5wdXNoKCBuZXcgV2F2ZUNyZWF0aW9uU3BlYyhcclxuICAgICAgICAgICAgICB3YXZlU291cmNlU3BlYy54UG9zaXRpb24sXHJcbiAgICAgICAgICAgICAgd2F2ZVNvdXJjZVNwZWMucHJvcGFnYXRpb25EaXJlY3Rpb24sXHJcbiAgICAgICAgICAgICAgdGhpcy5pbnRlcldhdmVUaW1lXHJcbiAgICAgICAgICAgICkgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICggbWF0Y2hpbmdXYXZlLmdldEludGVuc2l0eUF0RGlzdGFuY2UoIDAgKSAhPT0gd2F2ZUludGVuc2l0eSApIHtcclxuXHJcbiAgICAgICAgICAvLyBVcGRhdGUgdGhlIGludGVuc2l0eS5cclxuICAgICAgICAgIG1hdGNoaW5nV2F2ZS5zZXRJbnRlbnNpdHlBdFN0YXJ0KCB3YXZlSW50ZW5zaXR5ICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gU2VlIGlmIGl0J3MgdGltZSB0byBjcmVhdGUgYW55IG9mIHRoZSBxdWV1ZWQgdXAgd2F2ZXMuXHJcbiAgICB0aGlzLndhdmVDcmVhdGlvblF1ZXVlLmZvckVhY2goIHdhdmVDcmVhdGlvblNwZWMgPT4ge1xyXG4gICAgICB3YXZlQ3JlYXRpb25TcGVjLmNvdW50ZG93biAtPSBkdDtcclxuICAgICAgaWYgKCB3YXZlQ3JlYXRpb25TcGVjLmNvdW50ZG93biA8PSAwICkge1xyXG5cclxuICAgICAgICAvLyBDcmVhdGUgdGhlIHdhdmUuXHJcbiAgICAgICAgdGhpcy5hZGRXYXZlVG9Nb2RlbCggd2F2ZUNyZWF0aW9uU3BlYy5vcmlnaW5YLCB3YXZlQ3JlYXRpb25TcGVjLnByb3BhZ2F0aW9uRGlyZWN0aW9uICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBSZW1vdmUgYW55IGV4cGlyZWQgd2F2ZSBjcmVhdGlvbiBzcGVjcy5cclxuICAgIHRoaXMud2F2ZUNyZWF0aW9uUXVldWUgPSB0aGlzLndhdmVDcmVhdGlvblF1ZXVlLmZpbHRlciggd2F2ZVNwZWMgPT4gd2F2ZVNwZWMuY291bnRkb3duID4gMCApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhZGRXYXZlVG9Nb2RlbCggb3JpZ2luWDogbnVtYmVyLCBwcm9wYWdhdGlvbkRpcmVjdGlvbjogVmVjdG9yMiApOiB2b2lkIHtcclxuICAgIGNvbnN0IG5ld0lSV2F2ZSA9IHRoaXMud2F2ZUdyb3VwLmNyZWF0ZU5leHRFbGVtZW50KFxyXG4gICAgICB0aGlzLndhdmVsZW5ndGgsXHJcbiAgICAgIG5ldyBWZWN0b3IyKCBvcmlnaW5YLCB0aGlzLndhdmVTdGFydEFsdGl0dWRlICksXHJcbiAgICAgIHByb3BhZ2F0aW9uRGlyZWN0aW9uLFxyXG4gICAgICB0aGlzLndhdmVFbmRBbHRpdHVkZSwge1xyXG4gICAgICAgIGludGVuc2l0eUF0U3RhcnQ6IHRoaXMud2F2ZUludGVuc2l0eVByb3BlcnR5LnZhbHVlXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgLy8gSWYgd2F2ZSBnYXBzIGFyZSBlbmFibGVkLCB0aGUgbmV3bHkgY3JlYXRlZCB3YXZlIHNob3VsZCBoYXZlIGEgbGltaXRlZCBsaWZldGltZSwgYWZ0ZXIgd2hpY2ggYSBuZXcgd2F2ZSB3aXRoIHRoZVxyXG4gICAgLy8gc2FtZSBwYXJhbWV0ZXJzIHdpbGwgYmUgY3JlYXRlZCBuZWFyYnkuICBJZiBnYXBzIGFyZW4ndCBlbmFibGVkLCB0aGUgbGlmZXRpbWUgaXMgc2V0IHRvIGluZmluaXR5LCBhbmQgdGhlIHdhdmVcclxuICAgIC8vIHdpbGwgb25seSBnbyBhd2F5IHdoZW4gdGhlIHNvdXJjZSBzdG9wcyBwcm9kdWNpbmcgaXQuXHJcbiAgICBsZXQgd2F2ZUxpZmV0aW1lO1xyXG4gICAgaWYgKCBXQVZFX0dBUFNfRU5BQkxFRCApIHtcclxuICAgICAgd2F2ZUxpZmV0aW1lID0gZG90UmFuZG9tLm5leHREb3VibGVCZXR3ZWVuKCB0aGlzLndhdmVMaWZldGltZVJhbmdlLm1pbiwgdGhpcy53YXZlTGlmZXRpbWVSYW5nZS5tYXggKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB3YXZlTGlmZXRpbWUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7XHJcbiAgICB9XHJcbiAgICB0aGlzLndhdmVzVG9MaWZldGltZXNNYXAuc2V0KCBuZXdJUldhdmUsIHdhdmVMaWZldGltZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXQgdGhlIHdhdmUgc291cmNlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMud2F2ZXNUb0xpZmV0aW1lc01hcC5jbGVhcigpO1xyXG4gICAgdGhpcy53YXZlQ3JlYXRpb25RdWV1ZS5sZW5ndGggPSAwO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHRvU3RhdGVPYmplY3QoKTogRU1XYXZlU291cmNlU3RhdGVPYmplY3Qge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgd2F2ZXNUb0xpZmV0aW1lc01hcDogTWFwSU8oIFJlZmVyZW5jZUlPKCBXYXZlLldhdmVJTyApLCBJbmZpbml0ZU51bWJlcklPICkudG9TdGF0ZU9iamVjdCggdGhpcy53YXZlc1RvTGlmZXRpbWVzTWFwICksXHJcbiAgICAgIHdhdmVDcmVhdGlvblF1ZXVlOiBBcnJheUlPKCBXYXZlQ3JlYXRpb25TcGVjLldhdmVDcmVhdGlvblNwZWNJTyApLnRvU3RhdGVPYmplY3QoIHRoaXMud2F2ZUNyZWF0aW9uUXVldWUgKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhcHBseVN0YXRlKCBzdGF0ZU9iamVjdDogRU1XYXZlU291cmNlU3RhdGVPYmplY3QgKTogdm9pZCB7XHJcbiAgICB0aGlzLndhdmVzVG9MaWZldGltZXNNYXAgPSBNYXBJTyggUmVmZXJlbmNlSU8oIFdhdmUuV2F2ZUlPICksIE51bWJlcklPICkuZnJvbVN0YXRlT2JqZWN0KFxyXG4gICAgICBzdGF0ZU9iamVjdC53YXZlc1RvTGlmZXRpbWVzTWFwXHJcbiAgICApO1xyXG4gICAgdGhpcy53YXZlQ3JlYXRpb25RdWV1ZSA9IEFycmF5SU8oIFdhdmVDcmVhdGlvblNwZWMuV2F2ZUNyZWF0aW9uU3BlY0lPICkuZnJvbVN0YXRlT2JqZWN0KFxyXG4gICAgICBzdGF0ZU9iamVjdC53YXZlQ3JlYXRpb25RdWV1ZVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEVNV2F2ZVNvdXJjZUlPIGhhbmRsZXMgUGhFVC1pTyBzZXJpYWxpemF0aW9uIG9mIHRoZSBFTVdhdmVTb3VyY2UuIEJlY2F1c2Ugc2VyaWFsaXphdGlvbiBpbnZvbHZlcyBhY2Nlc3NpbmcgcHJpdmF0ZVxyXG4gICAqIG1lbWJlcnMsIGl0IGRlbGVnYXRlcyB0byBFTVdhdmVTb3VyY2UuIFRoZSBtZXRob2RzIHRoYXQgRU1XYXZlU291cmNlSU8gb3ZlcnJpZGVzIGFyZSB0eXBpY2FsIG9mICdEeW5hbWljIGVsZW1lbnRcclxuICAgKiBzZXJpYWxpemF0aW9uJywgYXMgZGVzY3JpYmVkIGluIHRoZSBTZXJpYWxpemF0aW9uIHNlY3Rpb24gb2ZcclxuICAgKiBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcGhldC1pby9ibG9iL21hc3Rlci9kb2MvcGhldC1pby1pbnN0cnVtZW50YXRpb24tdGVjaG5pY2FsLWd1aWRlLm1kI3NlcmlhbGl6YXRpb25cclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEVNV2F2ZVNvdXJjZUlPID0gbmV3IElPVHlwZTxFTVdhdmVTb3VyY2UsIEVNV2F2ZVNvdXJjZVN0YXRlT2JqZWN0PiggJ0VNV2F2ZVNvdXJjZUlPJywge1xyXG4gICAgdmFsdWVUeXBlOiBFTVdhdmVTb3VyY2UsXHJcbiAgICBzdGF0ZVNjaGVtYToge1xyXG4gICAgICB3YXZlc1RvTGlmZXRpbWVzTWFwOiBNYXBJTyggUmVmZXJlbmNlSU8oIFdhdmUuV2F2ZUlPICksIE51bWJlcklPICksXHJcbiAgICAgIHdhdmVDcmVhdGlvblF1ZXVlOiBBcnJheUlPKCBXYXZlQ3JlYXRpb25TcGVjLldhdmVDcmVhdGlvblNwZWNJTyApXHJcbiAgICB9LFxyXG4gICAgYXBwbHlTdGF0ZTogKCBlbVdhdmVTb3VyY2U6IEVNV2F2ZVNvdXJjZSwgc3RhdGVPYmplY3Q6IEVNV2F2ZVNvdXJjZVN0YXRlT2JqZWN0ICkgPT4gZW1XYXZlU291cmNlLmFwcGx5U3RhdGUoIHN0YXRlT2JqZWN0XHJcbiAgICApLFxyXG4gICAgdG9TdGF0ZU9iamVjdDogKCBlbVdhdmVTb3VyY2U6IEVNV2F2ZVNvdXJjZSApID0+IGVtV2F2ZVNvdXJjZS50b1N0YXRlT2JqZWN0KClcclxuICB9ICk7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEVNV2F2ZVNvdXJjZVN0YXRlT2JqZWN0ID0ge1xyXG4gIHdhdmVzVG9MaWZldGltZXNNYXA6IE1hcFN0YXRlT2JqZWN0PFJlZmVyZW5jZUlPU3RhdGUsIG51bWJlcj47XHJcbiAgd2F2ZUNyZWF0aW9uUXVldWU6IFdhdmVDcmVhdGlvblNwZWNTdGF0ZU9iamVjdFtdO1xyXG59O1xyXG5cclxuZ3JlZW5ob3VzZUVmZmVjdC5yZWdpc3RlciggJ0VNV2F2ZVNvdXJjZScsIEVNV2F2ZVNvdXJjZSApO1xyXG5leHBvcnQgZGVmYXVsdCBFTVdhdmVTb3VyY2U7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsY0FBYyxNQUFNLHVDQUF1QztBQUVsRSxPQUFPQyxTQUFTLE1BQU0saUNBQWlDO0FBQ3ZELE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsT0FBTyxNQUE4QiwrQkFBK0I7QUFDM0UsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQUc3RCxPQUFPQyxZQUFZLE1BQStCLHVDQUF1QztBQUN6RixP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