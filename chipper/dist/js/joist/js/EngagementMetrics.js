// Copyright 2019-2022, University of Colorado Boulder

/**
 * Monitors the engagement as it relates to time spent on each screen of a sim. Mainly this is to provide this information
 * to a PhET-iO wrapper frame.
 *
 * The main output of this file is powered by the data stream. As a result the finest granularity of this data is based on
 * the most frequent events that are emitting. As of this writing, when emitting high frequency events, that is every
 * frame on the "stepSimulation" event. Note that this Type requires high frequency events to be emitted.
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 * @author Chris Klusendorf (PhET Interactive Simulations)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Property from '../../axon/js/Property.js';
import joist from './joist.js';
import TemporalCounter from './TemporalCounter.js';

/////////////////////////////////
// TODO: Duplication alert! MK doesn't want to import from phet-io into joist, so we will just duplicate the type for now. https://github.com/phetsims/joist/issues/553
////////////////////////////////
class EngagementMetrics {
  screens = []; // {ScreenData[]}

  startTimestamp = null; // number, the timestamp of the start of the sim.

  constructor(sim) {
    const dataStream = phet && phet.phetio && phet.phetio.dataStream;
    assert && assert(dataStream, 'cannot add dataStream listener because dataStream is not defined');
    let currentScreenEntry = this.screens[sim.screens.indexOf(sim.selectedScreenProperty.value)];
    sim.screens.forEach(screen => {
      this.screens.push(new ScreenData(screen.tandem.name));
    });
    const updateCurrentScreenEntry = event => {
      currentScreenEntry = this.screens[sim.screens.indexOf(sim.selectedScreenProperty.value)];

      // initial condition if first time on this screen
      currentScreenEntry.firstTimestamp = currentScreenEntry.firstTimestamp || event.time;
    };

    // phet-io data stream listener for every sim event.
    dataStream.addAllEventListener(event => {
      // initial condition
      if (this.startTimestamp === null) {
        this.startTimestamp = event.time;
        updateCurrentScreenEntry(event);
      }

      // screenIndex changedr
      if (event.phetioID === sim.selectedScreenProperty.tandem.phetioID && event.name === Property.CHANGED_EVENT_NAME) {
        updateCurrentScreenEntry(event);
      }

      // Handle the case if the event signifies engagement with the simulation.
      this.isEngagedEvent(event) && currentScreenEntry.onEngagedEvent(event, this.startTimestamp);
      if (event.phetioID === sim.stepSimulationAction.tandem.phetioID) {
        // TODO: counted even when not in the active browser tab, perhaps we need to use browserTabVisibleProperty, https://github.com/phetsims/joist/issues/553
        // TODO: or just be adding up dt values instead of trying to use event.time, which is just from Date.now(), https://github.com/phetsims/joist/issues/553
        currentScreenEntry.lastTimestamp = event.time;
        currentScreenEntry.totalTime += Math.floor(event.data.dt * 1000);
      }
    });
  }

  /**
   * Returns true if the event signifies that the student is "engaged." The current definition is just pointer down
   * events.
   */
  isEngagedEvent(event) {
    let engaged = false;
    ['mouseDownAction', 'touchDownAction', 'keydownAction', 'penDownAction'].forEach(eventName => {
      if (window.phetio.PhetioIDUtils.getComponentName(event.phetioID) === eventName) {
        engaged = true;
      }
    });
    return engaged;
  }

  /**
   * get the current engagement data of the simulation.
   */
  getEngagementMetrics() {
    const screens = this.screens;
    return {
      sim: {
        // the timestamp of the first received model step
        startTimestamp: this.startTimestamp,
        // number of seconds since startTimestamp
        elapsedTime: _.sum(screens.map(screen => screen.totalTime)),
        // number of seconds in which "engagement" occurred
        engagedTime: _.sum(screens.map(screen => screen.engagedTime)),
        // the timestamp of the first time the sim is engaged with
        firstEngagementTimestamp: _.min(screens.map(screen => screen.firstTimestamp)),
        // current time of the sim
        currentTimestamp: _.max(screens.map(screen => screen.lastTimestamp))
      },
      screens: screens.map(screen => screen.getData())
    };
  }
}

// private class to keep track of data for each screen.
class ScreenData {
  firstTimestamp = null;
  lastTimestamp = null;
  totalTime = 0;
  firstEngagedTimestamp = null;
  temporalCounter = new TemporalCounter(1000);
  constructor(name) {
    this.name = name;
  }

  /**
   * Getter to keep things a bit more modular
   * @returns - the ms of engagement for the sim
   */
  get engagedTime() {
    return this.temporalCounter.counts * 1000;
  }
  onEngagedEvent(event, simStartTimestamp) {
    this.temporalCounter.onEvent(event.time - simStartTimestamp);

    // case for first engaged event
    this.firstTimestamp = this.firstTimestamp || event.time;
  }

  /**
   * Public facing info, mainer getter for this POJSO.
   */
  getData() {
    return {
      name: this.name,
      totalTime: this.totalTime,
      engagedTime: this.engagedTime,
      firstTimestamp: this.firstTimestamp,
      lastTimestamp: this.lastTimestamp
    };
  }
}
joist.register('EngagementMetrics', EngagementMetrics);
export default EngagementMetrics;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImpvaXN0IiwiVGVtcG9yYWxDb3VudGVyIiwiRW5nYWdlbWVudE1ldHJpY3MiLCJzY3JlZW5zIiwic3RhcnRUaW1lc3RhbXAiLCJjb25zdHJ1Y3RvciIsInNpbSIsImRhdGFTdHJlYW0iLCJwaGV0IiwicGhldGlvIiwiYXNzZXJ0IiwiY3VycmVudFNjcmVlbkVudHJ5IiwiaW5kZXhPZiIsInNlbGVjdGVkU2NyZWVuUHJvcGVydHkiLCJ2YWx1ZSIsImZvckVhY2giLCJzY3JlZW4iLCJwdXNoIiwiU2NyZWVuRGF0YSIsInRhbmRlbSIsIm5hbWUiLCJ1cGRhdGVDdXJyZW50U2NyZWVuRW50cnkiLCJldmVudCIsImZpcnN0VGltZXN0YW1wIiwidGltZSIsImFkZEFsbEV2ZW50TGlzdGVuZXIiLCJwaGV0aW9JRCIsIkNIQU5HRURfRVZFTlRfTkFNRSIsImlzRW5nYWdlZEV2ZW50Iiwib25FbmdhZ2VkRXZlbnQiLCJzdGVwU2ltdWxhdGlvbkFjdGlvbiIsImxhc3RUaW1lc3RhbXAiLCJ0b3RhbFRpbWUiLCJNYXRoIiwiZmxvb3IiLCJkYXRhIiwiZHQiLCJlbmdhZ2VkIiwiZXZlbnROYW1lIiwid2luZG93IiwiUGhldGlvSURVdGlscyIsImdldENvbXBvbmVudE5hbWUiLCJnZXRFbmdhZ2VtZW50TWV0cmljcyIsImVsYXBzZWRUaW1lIiwiXyIsInN1bSIsIm1hcCIsImVuZ2FnZWRUaW1lIiwiZmlyc3RFbmdhZ2VtZW50VGltZXN0YW1wIiwibWluIiwiY3VycmVudFRpbWVzdGFtcCIsIm1heCIsImdldERhdGEiLCJmaXJzdEVuZ2FnZWRUaW1lc3RhbXAiLCJ0ZW1wb3JhbENvdW50ZXIiLCJjb3VudHMiLCJzaW1TdGFydFRpbWVzdGFtcCIsIm9uRXZlbnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVuZ2FnZW1lbnRNZXRyaWNzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE5LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1vbml0b3JzIHRoZSBlbmdhZ2VtZW50IGFzIGl0IHJlbGF0ZXMgdG8gdGltZSBzcGVudCBvbiBlYWNoIHNjcmVlbiBvZiBhIHNpbS4gTWFpbmx5IHRoaXMgaXMgdG8gcHJvdmlkZSB0aGlzIGluZm9ybWF0aW9uXHJcbiAqIHRvIGEgUGhFVC1pTyB3cmFwcGVyIGZyYW1lLlxyXG4gKlxyXG4gKiBUaGUgbWFpbiBvdXRwdXQgb2YgdGhpcyBmaWxlIGlzIHBvd2VyZWQgYnkgdGhlIGRhdGEgc3RyZWFtLiBBcyBhIHJlc3VsdCB0aGUgZmluZXN0IGdyYW51bGFyaXR5IG9mIHRoaXMgZGF0YSBpcyBiYXNlZCBvblxyXG4gKiB0aGUgbW9zdCBmcmVxdWVudCBldmVudHMgdGhhdCBhcmUgZW1pdHRpbmcuIEFzIG9mIHRoaXMgd3JpdGluZywgd2hlbiBlbWl0dGluZyBoaWdoIGZyZXF1ZW5jeSBldmVudHMsIHRoYXQgaXMgZXZlcnlcclxuICogZnJhbWUgb24gdGhlIFwic3RlcFNpbXVsYXRpb25cIiBldmVudC4gTm90ZSB0aGF0IHRoaXMgVHlwZSByZXF1aXJlcyBoaWdoIGZyZXF1ZW5jeSBldmVudHMgdG8gYmUgZW1pdHRlZC5cclxuICpcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIENocmlzIEtsdXNlbmRvcmYgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgSW50ZW50aW9uYWxBbnkgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL0ludGVudGlvbmFsQW55LmpzJztcclxuaW1wb3J0IGpvaXN0IGZyb20gJy4vam9pc3QuanMnO1xyXG5pbXBvcnQgU2ltIGZyb20gJy4vU2ltLmpzJztcclxuaW1wb3J0IFRlbXBvcmFsQ291bnRlciBmcm9tICcuL1RlbXBvcmFsQ291bnRlci5qcyc7XHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuLy8gVE9ETzogRHVwbGljYXRpb24gYWxlcnQhIE1LIGRvZXNuJ3Qgd2FudCB0byBpbXBvcnQgZnJvbSBwaGV0LWlvIGludG8gam9pc3QsIHNvIHdlIHdpbGwganVzdCBkdXBsaWNhdGUgdGhlIHR5cGUgZm9yIG5vdy4gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy81NTNcclxudHlwZSBQaGV0aW9FdmVudERhdGEgPSBSZWNvcmQ8c3RyaW5nLCBJbnRlbnRpb25hbEFueT47XHJcbnR5cGUgUGhldGlvRXZlbnQgPSB7XHJcbiAgaW5kZXg6IG51bWJlcjtcclxuICB0aW1lOiBudW1iZXI7XHJcbiAgdHlwZTogc3RyaW5nO1xyXG4gIHBoZXRpb0lEOiBzdHJpbmc7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIGNvbXBvbmVudFR5cGU6IHN0cmluZztcclxuICBjaGlsZHJlbj86IFBoZXRpb0V2ZW50W107XHJcbiAgZGF0YT86IFBoZXRpb0V2ZW50RGF0YTtcclxuICBtZXRhZGF0YT86IFBoZXRpb0V2ZW50RGF0YTtcclxufTtcclxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuXHJcbnR5cGUgU2NyZWVuRGF0YVR5cGUgPSB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIHRvdGFsVGltZTogbnVtYmVyO1xyXG4gIGVuZ2FnZWRUaW1lOiBudW1iZXI7XHJcbiAgZmlyc3RUaW1lc3RhbXA6IG51bWJlcjtcclxuICBsYXN0VGltZXN0YW1wOiBudW1iZXI7XHJcbn07XHJcbnR5cGUgRW5nYWdlbWVudE1ldHJpY3NEYXRhID0ge1xyXG4gIHNpbToge1xyXG5cclxuICAgIC8vIHRoZSB0aW1lc3RhbXAgb2YgdGhlIGZpcnN0IHJlY2VpdmVkIG1vZGVsIHN0ZXBcclxuICAgIHN0YXJ0VGltZXN0YW1wOiBudW1iZXI7XHJcblxyXG4gICAgLy8gbnVtYmVyIG9mIHNlY29uZHMgc2luY2Ugc3RhcnRUaW1lc3RhbXBcclxuICAgIGVsYXBzZWRUaW1lOiBudW1iZXI7XHJcblxyXG4gICAgLy8gbnVtYmVyIG9mIHNlY29uZHMgaW4gd2hpY2ggXCJlbmdhZ2VtZW50XCIgb2NjdXJyZWRcclxuICAgIGVuZ2FnZWRUaW1lOiBudW1iZXI7XHJcblxyXG4gICAgLy8gdGhlIHRpbWVzdGFtcCBvZiB0aGUgZmlyc3QgdGltZSB0aGUgc2ltIGlzIGVuZ2FnZWQgd2l0aFxyXG4gICAgZmlyc3RFbmdhZ2VtZW50VGltZXN0YW1wOiBudW1iZXI7XHJcblxyXG4gICAgLy8gY3VycmVudCB0aW1lIG9mIHRoZSBzaW1cclxuICAgIGN1cnJlbnRUaW1lc3RhbXA6IG51bWJlcjtcclxuICB9O1xyXG4gIHNjcmVlbnM6IFNjcmVlbkRhdGFUeXBlW107XHJcbn07XHJcblxyXG5cclxuY2xhc3MgRW5nYWdlbWVudE1ldHJpY3Mge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHNjcmVlbnM6IFNjcmVlbkRhdGFbXSA9IFtdOyAvLyB7U2NyZWVuRGF0YVtdfVxyXG5cclxuICBwcml2YXRlIHN0YXJ0VGltZXN0YW1wOiBudW1iZXIgfCBudWxsID0gbnVsbDsgLy8gbnVtYmVyLCB0aGUgdGltZXN0YW1wIG9mIHRoZSBzdGFydCBvZiB0aGUgc2ltLlxyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHNpbTogU2ltICkge1xyXG4gICAgY29uc3QgZGF0YVN0cmVhbSA9IHBoZXQgJiYgcGhldC5waGV0aW8gJiYgcGhldC5waGV0aW8uZGF0YVN0cmVhbTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGRhdGFTdHJlYW0sICdjYW5ub3QgYWRkIGRhdGFTdHJlYW0gbGlzdGVuZXIgYmVjYXVzZSBkYXRhU3RyZWFtIGlzIG5vdCBkZWZpbmVkJyApO1xyXG5cclxuICAgIGxldCBjdXJyZW50U2NyZWVuRW50cnkgPSB0aGlzLnNjcmVlbnNbIHNpbS5zY3JlZW5zLmluZGV4T2YoIHNpbS5zZWxlY3RlZFNjcmVlblByb3BlcnR5LnZhbHVlICkgXTtcclxuXHJcbiAgICBzaW0uc2NyZWVucy5mb3JFYWNoKCBzY3JlZW4gPT4ge1xyXG4gICAgICB0aGlzLnNjcmVlbnMucHVzaCggbmV3IFNjcmVlbkRhdGEoIHNjcmVlbi50YW5kZW0ubmFtZSApICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgdXBkYXRlQ3VycmVudFNjcmVlbkVudHJ5ID0gKCBldmVudDogUGhldGlvRXZlbnQgKSA9PiB7XHJcbiAgICAgIGN1cnJlbnRTY3JlZW5FbnRyeSA9IHRoaXMuc2NyZWVuc1sgc2ltLnNjcmVlbnMuaW5kZXhPZiggc2ltLnNlbGVjdGVkU2NyZWVuUHJvcGVydHkudmFsdWUgKSBdO1xyXG5cclxuICAgICAgLy8gaW5pdGlhbCBjb25kaXRpb24gaWYgZmlyc3QgdGltZSBvbiB0aGlzIHNjcmVlblxyXG4gICAgICBjdXJyZW50U2NyZWVuRW50cnkuZmlyc3RUaW1lc3RhbXAgPSBjdXJyZW50U2NyZWVuRW50cnkuZmlyc3RUaW1lc3RhbXAhIHx8IGV2ZW50LnRpbWU7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHBoZXQtaW8gZGF0YSBzdHJlYW0gbGlzdGVuZXIgZm9yIGV2ZXJ5IHNpbSBldmVudC5cclxuICAgIGRhdGFTdHJlYW0uYWRkQWxsRXZlbnRMaXN0ZW5lciggKCBldmVudDogUGhldGlvRXZlbnQgKSA9PiB7XHJcblxyXG4gICAgICAvLyBpbml0aWFsIGNvbmRpdGlvblxyXG4gICAgICBpZiAoIHRoaXMuc3RhcnRUaW1lc3RhbXAgPT09IG51bGwgKSB7XHJcbiAgICAgICAgdGhpcy5zdGFydFRpbWVzdGFtcCA9IGV2ZW50LnRpbWU7XHJcbiAgICAgICAgdXBkYXRlQ3VycmVudFNjcmVlbkVudHJ5KCBldmVudCApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBzY3JlZW5JbmRleCBjaGFuZ2VkclxyXG4gICAgICBpZiAoIGV2ZW50LnBoZXRpb0lEID09PSBzaW0uc2VsZWN0ZWRTY3JlZW5Qcm9wZXJ0eS50YW5kZW0ucGhldGlvSUQgJiZcclxuICAgICAgICAgICBldmVudC5uYW1lID09PSBQcm9wZXJ0eS5DSEFOR0VEX0VWRU5UX05BTUUgKSB7XHJcbiAgICAgICAgdXBkYXRlQ3VycmVudFNjcmVlbkVudHJ5KCBldmVudCApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBIYW5kbGUgdGhlIGNhc2UgaWYgdGhlIGV2ZW50IHNpZ25pZmllcyBlbmdhZ2VtZW50IHdpdGggdGhlIHNpbXVsYXRpb24uXHJcbiAgICAgIHRoaXMuaXNFbmdhZ2VkRXZlbnQoIGV2ZW50ICkgJiYgY3VycmVudFNjcmVlbkVudHJ5Lm9uRW5nYWdlZEV2ZW50KCBldmVudCwgdGhpcy5zdGFydFRpbWVzdGFtcCApO1xyXG5cclxuICAgICAgaWYgKCBldmVudC5waGV0aW9JRCA9PT0gc2ltLnN0ZXBTaW11bGF0aW9uQWN0aW9uLnRhbmRlbS5waGV0aW9JRCApIHtcclxuXHJcbiAgICAgICAgLy8gVE9ETzogY291bnRlZCBldmVuIHdoZW4gbm90IGluIHRoZSBhY3RpdmUgYnJvd3NlciB0YWIsIHBlcmhhcHMgd2UgbmVlZCB0byB1c2UgYnJvd3NlclRhYlZpc2libGVQcm9wZXJ0eSwgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy81NTNcclxuICAgICAgICAvLyBUT0RPOiBvciBqdXN0IGJlIGFkZGluZyB1cCBkdCB2YWx1ZXMgaW5zdGVhZCBvZiB0cnlpbmcgdG8gdXNlIGV2ZW50LnRpbWUsIHdoaWNoIGlzIGp1c3QgZnJvbSBEYXRlLm5vdygpLCBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvam9pc3QvaXNzdWVzLzU1M1xyXG4gICAgICAgIGN1cnJlbnRTY3JlZW5FbnRyeS5sYXN0VGltZXN0YW1wID0gZXZlbnQudGltZTtcclxuICAgICAgICBjdXJyZW50U2NyZWVuRW50cnkudG90YWxUaW1lICs9IE1hdGguZmxvb3IoIGV2ZW50LmRhdGEhLmR0ICogMTAwMCApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGV2ZW50IHNpZ25pZmllcyB0aGF0IHRoZSBzdHVkZW50IGlzIFwiZW5nYWdlZC5cIiBUaGUgY3VycmVudCBkZWZpbml0aW9uIGlzIGp1c3QgcG9pbnRlciBkb3duXHJcbiAgICogZXZlbnRzLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNFbmdhZ2VkRXZlbnQoIGV2ZW50OiBQaGV0aW9FdmVudCApOiBib29sZWFuIHtcclxuICAgIGxldCBlbmdhZ2VkID0gZmFsc2U7XHJcbiAgICBbICdtb3VzZURvd25BY3Rpb24nLCAndG91Y2hEb3duQWN0aW9uJywgJ2tleWRvd25BY3Rpb24nLCAncGVuRG93bkFjdGlvbicgXS5mb3JFYWNoKCBldmVudE5hbWUgPT4ge1xyXG4gICAgICBpZiAoIHdpbmRvdy5waGV0aW8uUGhldGlvSURVdGlscy5nZXRDb21wb25lbnROYW1lKCBldmVudC5waGV0aW9JRCApID09PSBldmVudE5hbWUgKSB7XHJcbiAgICAgICAgZW5nYWdlZCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICAgIHJldHVybiBlbmdhZ2VkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogZ2V0IHRoZSBjdXJyZW50IGVuZ2FnZW1lbnQgZGF0YSBvZiB0aGUgc2ltdWxhdGlvbi5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW5nYWdlbWVudE1ldHJpY3MoKTogRW5nYWdlbWVudE1ldHJpY3NEYXRhIHtcclxuICAgIGNvbnN0IHNjcmVlbnMgPSB0aGlzLnNjcmVlbnM7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzaW06IHtcclxuXHJcbiAgICAgICAgLy8gdGhlIHRpbWVzdGFtcCBvZiB0aGUgZmlyc3QgcmVjZWl2ZWQgbW9kZWwgc3RlcFxyXG4gICAgICAgIHN0YXJ0VGltZXN0YW1wOiB0aGlzLnN0YXJ0VGltZXN0YW1wISxcclxuXHJcbiAgICAgICAgLy8gbnVtYmVyIG9mIHNlY29uZHMgc2luY2Ugc3RhcnRUaW1lc3RhbXBcclxuICAgICAgICBlbGFwc2VkVGltZTogXy5zdW0oIHNjcmVlbnMubWFwKCBzY3JlZW4gPT4gc2NyZWVuLnRvdGFsVGltZSApICksXHJcblxyXG4gICAgICAgIC8vIG51bWJlciBvZiBzZWNvbmRzIGluIHdoaWNoIFwiZW5nYWdlbWVudFwiIG9jY3VycmVkXHJcbiAgICAgICAgZW5nYWdlZFRpbWU6IF8uc3VtKCBzY3JlZW5zLm1hcCggc2NyZWVuID0+IHNjcmVlbi5lbmdhZ2VkVGltZSApICksXHJcblxyXG4gICAgICAgIC8vIHRoZSB0aW1lc3RhbXAgb2YgdGhlIGZpcnN0IHRpbWUgdGhlIHNpbSBpcyBlbmdhZ2VkIHdpdGhcclxuICAgICAgICBmaXJzdEVuZ2FnZW1lbnRUaW1lc3RhbXA6IF8ubWluKCBzY3JlZW5zLm1hcCggc2NyZWVuID0+IHNjcmVlbi5maXJzdFRpbWVzdGFtcCApICkhLFxyXG5cclxuICAgICAgICAvLyBjdXJyZW50IHRpbWUgb2YgdGhlIHNpbVxyXG4gICAgICAgIGN1cnJlbnRUaW1lc3RhbXA6IF8ubWF4KCBzY3JlZW5zLm1hcCggc2NyZWVuID0+IHNjcmVlbi5sYXN0VGltZXN0YW1wICkgKSFcclxuICAgICAgfSxcclxuICAgICAgc2NyZWVuczogc2NyZWVucy5tYXAoIHNjcmVlbiA9PiBzY3JlZW4uZ2V0RGF0YSgpIClcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG4vLyBwcml2YXRlIGNsYXNzIHRvIGtlZXAgdHJhY2sgb2YgZGF0YSBmb3IgZWFjaCBzY3JlZW4uXHJcbmNsYXNzIFNjcmVlbkRhdGEge1xyXG5cclxuICBwdWJsaWMgbmFtZTogc3RyaW5nO1xyXG4gIHB1YmxpYyBmaXJzdFRpbWVzdGFtcDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcbiAgcHVibGljIGxhc3RUaW1lc3RhbXA6IG51bWJlciB8IG51bGwgPSBudWxsO1xyXG4gIHB1YmxpYyB0b3RhbFRpbWUgPSAwO1xyXG4gIHB1YmxpYyBmaXJzdEVuZ2FnZWRUaW1lc3RhbXAgPSBudWxsO1xyXG4gIHB1YmxpYyByZWFkb25seSB0ZW1wb3JhbENvdW50ZXIgPSBuZXcgVGVtcG9yYWxDb3VudGVyKCAxMDAwICk7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggbmFtZTogc3RyaW5nICkge1xyXG4gICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHRlciB0byBrZWVwIHRoaW5ncyBhIGJpdCBtb3JlIG1vZHVsYXJcclxuICAgKiBAcmV0dXJucyAtIHRoZSBtcyBvZiBlbmdhZ2VtZW50IGZvciB0aGUgc2ltXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBlbmdhZ2VkVGltZSgpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMudGVtcG9yYWxDb3VudGVyLmNvdW50cyAqIDEwMDA7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25FbmdhZ2VkRXZlbnQoIGV2ZW50OiBQaGV0aW9FdmVudCwgc2ltU3RhcnRUaW1lc3RhbXA6IG51bWJlciApOiB2b2lkIHtcclxuXHJcbiAgICB0aGlzLnRlbXBvcmFsQ291bnRlci5vbkV2ZW50KCBldmVudC50aW1lIC0gc2ltU3RhcnRUaW1lc3RhbXAgKTtcclxuXHJcbiAgICAvLyBjYXNlIGZvciBmaXJzdCBlbmdhZ2VkIGV2ZW50XHJcbiAgICB0aGlzLmZpcnN0VGltZXN0YW1wID0gdGhpcy5maXJzdFRpbWVzdGFtcCEgfHwgZXZlbnQudGltZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFB1YmxpYyBmYWNpbmcgaW5mbywgbWFpbmVyIGdldHRlciBmb3IgdGhpcyBQT0pTTy5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RGF0YSgpOiBTY3JlZW5EYXRhVHlwZSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLm5hbWUsXHJcbiAgICAgIHRvdGFsVGltZTogdGhpcy50b3RhbFRpbWUsXHJcbiAgICAgIGVuZ2FnZWRUaW1lOiB0aGlzLmVuZ2FnZWRUaW1lLFxyXG4gICAgICBmaXJzdFRpbWVzdGFtcDogdGhpcy5maXJzdFRpbWVzdGFtcCEsXHJcbiAgICAgIGxhc3RUaW1lc3RhbXA6IHRoaXMubGFzdFRpbWVzdGFtcCFcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG5qb2lzdC5yZWdpc3RlciggJ0VuZ2FnZW1lbnRNZXRyaWNzJywgRW5nYWdlbWVudE1ldHJpY3MgKTtcclxuZXhwb3J0IGRlZmF1bHQgRW5nYWdlbWVudE1ldHJpY3M7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsUUFBUSxNQUFNLDJCQUEyQjtBQUVoRCxPQUFPQyxLQUFLLE1BQU0sWUFBWTtBQUU5QixPQUFPQyxlQUFlLE1BQU0sc0JBQXNCOztBQUVsRDtBQUNBO0FBYUE7QUErQkEsTUFBTUMsaUJBQWlCLENBQUM7RUFFTEMsT0FBTyxHQUFpQixFQUFFLENBQUMsQ0FBQzs7RUFFckNDLGNBQWMsR0FBa0IsSUFBSSxDQUFDLENBQUM7O0VBRXZDQyxXQUFXQSxDQUFFQyxHQUFRLEVBQUc7SUFDN0IsTUFBTUMsVUFBVSxHQUFHQyxJQUFJLElBQUlBLElBQUksQ0FBQ0MsTUFBTSxJQUFJRCxJQUFJLENBQUNDLE1BQU0sQ0FBQ0YsVUFBVTtJQUNoRUcsTUFBTSxJQUFJQSxNQUFNLENBQUVILFVBQVUsRUFBRSxrRUFBbUUsQ0FBQztJQUVsRyxJQUFJSSxrQkFBa0IsR0FBRyxJQUFJLENBQUNSLE9BQU8sQ0FBRUcsR0FBRyxDQUFDSCxPQUFPLENBQUNTLE9BQU8sQ0FBRU4sR0FBRyxDQUFDTyxzQkFBc0IsQ0FBQ0MsS0FBTSxDQUFDLENBQUU7SUFFaEdSLEdBQUcsQ0FBQ0gsT0FBTyxDQUFDWSxPQUFPLENBQUVDLE1BQU0sSUFBSTtNQUM3QixJQUFJLENBQUNiLE9BQU8sQ0FBQ2MsSUFBSSxDQUFFLElBQUlDLFVBQVUsQ0FBRUYsTUFBTSxDQUFDRyxNQUFNLENBQUNDLElBQUssQ0FBRSxDQUFDO0lBQzNELENBQUUsQ0FBQztJQUVILE1BQU1DLHdCQUF3QixHQUFLQyxLQUFrQixJQUFNO01BQ3pEWCxrQkFBa0IsR0FBRyxJQUFJLENBQUNSLE9BQU8sQ0FBRUcsR0FBRyxDQUFDSCxPQUFPLENBQUNTLE9BQU8sQ0FBRU4sR0FBRyxDQUFDTyxzQkFBc0IsQ0FBQ0MsS0FBTSxDQUFDLENBQUU7O01BRTVGO01BQ0FILGtCQUFrQixDQUFDWSxjQUFjLEdBQUdaLGtCQUFrQixDQUFDWSxjQUFjLElBQUtELEtBQUssQ0FBQ0UsSUFBSTtJQUN0RixDQUFDOztJQUVEO0lBQ0FqQixVQUFVLENBQUNrQixtQkFBbUIsQ0FBSUgsS0FBa0IsSUFBTTtNQUV4RDtNQUNBLElBQUssSUFBSSxDQUFDbEIsY0FBYyxLQUFLLElBQUksRUFBRztRQUNsQyxJQUFJLENBQUNBLGNBQWMsR0FBR2tCLEtBQUssQ0FBQ0UsSUFBSTtRQUNoQ0gsd0JBQXdCLENBQUVDLEtBQU0sQ0FBQztNQUNuQzs7TUFFQTtNQUNBLElBQUtBLEtBQUssQ0FBQ0ksUUFBUSxLQUFLcEIsR0FBRyxDQUFDTyxzQkFBc0IsQ0FBQ00sTUFBTSxDQUFDTyxRQUFRLElBQzdESixLQUFLLENBQUNGLElBQUksS0FBS3JCLFFBQVEsQ0FBQzRCLGtCQUFrQixFQUFHO1FBQ2hETix3QkFBd0IsQ0FBRUMsS0FBTSxDQUFDO01BQ25DOztNQUVBO01BQ0EsSUFBSSxDQUFDTSxjQUFjLENBQUVOLEtBQU0sQ0FBQyxJQUFJWCxrQkFBa0IsQ0FBQ2tCLGNBQWMsQ0FBRVAsS0FBSyxFQUFFLElBQUksQ0FBQ2xCLGNBQWUsQ0FBQztNQUUvRixJQUFLa0IsS0FBSyxDQUFDSSxRQUFRLEtBQUtwQixHQUFHLENBQUN3QixvQkFBb0IsQ0FBQ1gsTUFBTSxDQUFDTyxRQUFRLEVBQUc7UUFFakU7UUFDQTtRQUNBZixrQkFBa0IsQ0FBQ29CLGFBQWEsR0FBR1QsS0FBSyxDQUFDRSxJQUFJO1FBQzdDYixrQkFBa0IsQ0FBQ3FCLFNBQVMsSUFBSUMsSUFBSSxDQUFDQyxLQUFLLENBQUVaLEtBQUssQ0FBQ2EsSUFBSSxDQUFFQyxFQUFFLEdBQUcsSUFBSyxDQUFDO01BQ3JFO0lBQ0YsQ0FBRSxDQUFDO0VBQ0w7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7RUFDVVIsY0FBY0EsQ0FBRU4sS0FBa0IsRUFBWTtJQUNwRCxJQUFJZSxPQUFPLEdBQUcsS0FBSztJQUNuQixDQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBRSxlQUFlLENBQUUsQ0FBQ3RCLE9BQU8sQ0FBRXVCLFNBQVMsSUFBSTtNQUMvRixJQUFLQyxNQUFNLENBQUM5QixNQUFNLENBQUMrQixhQUFhLENBQUNDLGdCQUFnQixDQUFFbkIsS0FBSyxDQUFDSSxRQUFTLENBQUMsS0FBS1ksU0FBUyxFQUFHO1FBQ2xGRCxPQUFPLEdBQUcsSUFBSTtNQUNoQjtJQUNGLENBQUUsQ0FBQztJQUNILE9BQU9BLE9BQU87RUFDaEI7O0VBRUE7QUFDRjtBQUNBO0VBQ1NLLG9CQUFvQkEsQ0FBQSxFQUEwQjtJQUNuRCxNQUFNdkMsT0FBTyxHQUFHLElBQUksQ0FBQ0EsT0FBTztJQUM1QixPQUFPO01BQ0xHLEdBQUcsRUFBRTtRQUVIO1FBQ0FGLGNBQWMsRUFBRSxJQUFJLENBQUNBLGNBQWU7UUFFcEM7UUFDQXVDLFdBQVcsRUFBRUMsQ0FBQyxDQUFDQyxHQUFHLENBQUUxQyxPQUFPLENBQUMyQyxHQUFHLENBQUU5QixNQUFNLElBQUlBLE1BQU0sQ0FBQ2dCLFNBQVUsQ0FBRSxDQUFDO1FBRS9EO1FBQ0FlLFdBQVcsRUFBRUgsQ0FBQyxDQUFDQyxHQUFHLENBQUUxQyxPQUFPLENBQUMyQyxHQUFHLENBQUU5QixNQUFNLElBQUlBLE1BQU0sQ0FBQytCLFdBQVksQ0FBRSxDQUFDO1FBRWpFO1FBQ0FDLHdCQUF3QixFQUFFSixDQUFDLENBQUNLLEdBQUcsQ0FBRTlDLE9BQU8sQ0FBQzJDLEdBQUcsQ0FBRTlCLE1BQU0sSUFBSUEsTUFBTSxDQUFDTyxjQUFlLENBQUUsQ0FBRTtRQUVsRjtRQUNBMkIsZ0JBQWdCLEVBQUVOLENBQUMsQ0FBQ08sR0FBRyxDQUFFaEQsT0FBTyxDQUFDMkMsR0FBRyxDQUFFOUIsTUFBTSxJQUFJQSxNQUFNLENBQUNlLGFBQWMsQ0FBRTtNQUN6RSxDQUFDO01BQ0Q1QixPQUFPLEVBQUVBLE9BQU8sQ0FBQzJDLEdBQUcsQ0FBRTlCLE1BQU0sSUFBSUEsTUFBTSxDQUFDb0MsT0FBTyxDQUFDLENBQUU7SUFDbkQsQ0FBQztFQUNIO0FBQ0Y7O0FBRUE7QUFDQSxNQUFNbEMsVUFBVSxDQUFDO0VBR1JLLGNBQWMsR0FBa0IsSUFBSTtFQUNwQ1EsYUFBYSxHQUFrQixJQUFJO0VBQ25DQyxTQUFTLEdBQUcsQ0FBQztFQUNicUIscUJBQXFCLEdBQUcsSUFBSTtFQUNuQkMsZUFBZSxHQUFHLElBQUlyRCxlQUFlLENBQUUsSUFBSyxDQUFDO0VBRXRESSxXQUFXQSxDQUFFZSxJQUFZLEVBQUc7SUFDakMsSUFBSSxDQUFDQSxJQUFJLEdBQUdBLElBQUk7RUFDbEI7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7RUFDRSxJQUFXMkIsV0FBV0EsQ0FBQSxFQUFXO0lBQy9CLE9BQU8sSUFBSSxDQUFDTyxlQUFlLENBQUNDLE1BQU0sR0FBRyxJQUFJO0VBQzNDO0VBRU8xQixjQUFjQSxDQUFFUCxLQUFrQixFQUFFa0MsaUJBQXlCLEVBQVM7SUFFM0UsSUFBSSxDQUFDRixlQUFlLENBQUNHLE9BQU8sQ0FBRW5DLEtBQUssQ0FBQ0UsSUFBSSxHQUFHZ0MsaUJBQWtCLENBQUM7O0lBRTlEO0lBQ0EsSUFBSSxDQUFDakMsY0FBYyxHQUFHLElBQUksQ0FBQ0EsY0FBYyxJQUFLRCxLQUFLLENBQUNFLElBQUk7RUFDMUQ7O0VBRUE7QUFDRjtBQUNBO0VBQ1M0QixPQUFPQSxDQUFBLEVBQW1CO0lBQy9CLE9BQU87TUFDTGhDLElBQUksRUFBRSxJQUFJLENBQUNBLElBQUk7TUFDZlksU0FBUyxFQUFFLElBQUksQ0FBQ0EsU0FBUztNQUN6QmUsV0FBVyxFQUFFLElBQUksQ0FBQ0EsV0FBVztNQUM3QnhCLGNBQWMsRUFBRSxJQUFJLENBQUNBLGNBQWU7TUFDcENRLGFBQWEsRUFBRSxJQUFJLENBQUNBO0lBQ3RCLENBQUM7RUFDSDtBQUNGO0FBRUEvQixLQUFLLENBQUMwRCxRQUFRLENBQUUsbUJBQW1CLEVBQUV4RCxpQkFBa0IsQ0FBQztBQUN4RCxlQUFlQSxpQkFBaUIifQ==