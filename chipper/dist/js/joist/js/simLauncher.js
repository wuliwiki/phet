// Copyright 2013-2022, University of Colorado Boulder
/* eslint indent: 0 */ // Because ESLint doesn't support import() at the time of this writing
/**
 * Singleton which launches a PhET Simulation, after using PHET_CORE/asyncLoader to make sure resources such as images,
 * sounds, or dynamic modules have finished loading.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import asyncLoader from '../../phet-core/js/asyncLoader.js';
import Tandem from '../../tandem/js/Tandem.js';
import joist from './joist.js';

// See below for dynamic imports, which must be locked.
let phetioEngine = null;
const unlockBrand = asyncLoader.createLock({
  name: 'brand'
});
import( /* webpackMode: "eager" */`../../brand/${phet.chipper.brand}/js/Brand.js`).then(module => unlockBrand()).catch(err => console.log(err));
if (Tandem.PHET_IO_ENABLED) {
  const unlockPhetioEngine = asyncLoader.createLock({
    name: 'phetioEngine'
  });
  import( /* webpackMode: "eager" */'../../phet-io/js/phetioEngine.js').then(module => {
    phetioEngine = module.default;
    unlockPhetioEngine();
  }).catch(err => console.log(err));
}
const unlockLaunch = asyncLoader.createLock({
  name: 'launch'
});
class SimLauncher {
  // Marked as true when simLauncher has finished its work cycle and control is given over to the simulation to finish initialization.

  constructor() {
    this.launchComplete = false;
  }

  /**
   * Launch the Sim by preloading the images and calling the callback.
   * to be called by main()s everywhere
   *
   * callback - the callback function which should create and start the sim, given that all async
   *                              content is loaded
   */
  launch(callback) {
    assert && assert(!window.phet.joist.launchCalled, 'Tried to launch twice');

    // Add listener before unlocking the launch lock
    asyncLoader.addListener(() => {
      window.phet.joist.launchSimulation = () => {
        assert && assert(!this.launchComplete, 'should not have completed launching the sim yet');
        this.launchComplete = true;

        // once launchSimulation has been called, the wrapper is ready to receive messages because any listeners it
        // wants have been set up by now.
        if (Tandem.PHET_IO_ENABLED) {
          phetioEngine?.onCrossFrameListenersReady();
        }

        // Instantiate the sim and show it.
        callback();
      };

      // PhET-iO simulations support an initialization phase (before the sim launches)
      if (Tandem.PHET_IO_ENABLED) {
        phetioEngine?.initialize(); // calls back to window.phet.joist.launchSimulation
      }

      if (phet.chipper.queryParameters.postMessageOnReady) {
        window.parent && window.parent.postMessage(JSON.stringify({
          type: 'ready',
          url: window.location.href
        }), '*');
      }
      if (Tandem.PHET_IO_ENABLED && !phet.preloads.phetio.queryParameters.phetioStandalone || phet.chipper.queryParameters.playbackMode) {

        // Wait for phet-io to finish adding listeners. It will direct the launch from there.
      } else {
        window.phet.joist.launchSimulation();
      }
    });
    unlockLaunch();

    // Signify that the simLauncher was called, see https://github.com/phetsims/joist/issues/142
    window.phet.joist.launchCalled = true;
  }
}
const simLauncher = new SimLauncher();
joist.register('simLauncher', simLauncher);
export default simLauncher;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhc3luY0xvYWRlciIsIlRhbmRlbSIsImpvaXN0IiwicGhldGlvRW5naW5lIiwidW5sb2NrQnJhbmQiLCJjcmVhdGVMb2NrIiwibmFtZSIsInBoZXQiLCJjaGlwcGVyIiwiYnJhbmQiLCJ0aGVuIiwibW9kdWxlIiwiY2F0Y2giLCJlcnIiLCJjb25zb2xlIiwibG9nIiwiUEhFVF9JT19FTkFCTEVEIiwidW5sb2NrUGhldGlvRW5naW5lIiwiZGVmYXVsdCIsInVubG9ja0xhdW5jaCIsIlNpbUxhdW5jaGVyIiwiY29uc3RydWN0b3IiLCJsYXVuY2hDb21wbGV0ZSIsImxhdW5jaCIsImNhbGxiYWNrIiwiYXNzZXJ0Iiwid2luZG93IiwibGF1bmNoQ2FsbGVkIiwiYWRkTGlzdGVuZXIiLCJsYXVuY2hTaW11bGF0aW9uIiwib25Dcm9zc0ZyYW1lTGlzdGVuZXJzUmVhZHkiLCJpbml0aWFsaXplIiwicXVlcnlQYXJhbWV0ZXJzIiwicG9zdE1lc3NhZ2VPblJlYWR5IiwicGFyZW50IiwicG9zdE1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwidHlwZSIsInVybCIsImxvY2F0aW9uIiwiaHJlZiIsInByZWxvYWRzIiwicGhldGlvIiwicGhldGlvU3RhbmRhbG9uZSIsInBsYXliYWNrTW9kZSIsInNpbUxhdW5jaGVyIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJzaW1MYXVuY2hlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuLyogZXNsaW50IGluZGVudDogMCAqLyAvLyBCZWNhdXNlIEVTTGludCBkb2Vzbid0IHN1cHBvcnQgaW1wb3J0KCkgYXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nXHJcbi8qKlxyXG4gKiBTaW5nbGV0b24gd2hpY2ggbGF1bmNoZXMgYSBQaEVUIFNpbXVsYXRpb24sIGFmdGVyIHVzaW5nIFBIRVRfQ09SRS9hc3luY0xvYWRlciB0byBtYWtlIHN1cmUgcmVzb3VyY2VzIHN1Y2ggYXMgaW1hZ2VzLFxyXG4gKiBzb3VuZHMsIG9yIGR5bmFtaWMgbW9kdWxlcyBoYXZlIGZpbmlzaGVkIGxvYWRpbmcuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IGFzeW5jTG9hZGVyIGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy9hc3luY0xvYWRlci5qcyc7XHJcbmltcG9ydCB7IFBoZXRpb0VuZ2luZSB9IGZyb20gJy4uLy4uL3BoZXQtaW8vanMvcGhldGlvRW5naW5lLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IGpvaXN0IGZyb20gJy4vam9pc3QuanMnO1xyXG5cclxuLy8gU2VlIGJlbG93IGZvciBkeW5hbWljIGltcG9ydHMsIHdoaWNoIG11c3QgYmUgbG9ja2VkLlxyXG5sZXQgcGhldGlvRW5naW5lOiBQaGV0aW9FbmdpbmUgfCBudWxsID0gbnVsbDtcclxuXHJcbmNvbnN0IHVubG9ja0JyYW5kID0gYXN5bmNMb2FkZXIuY3JlYXRlTG9jayggeyBuYW1lOiAnYnJhbmQnIH0gKTtcclxuaW1wb3J0KCAvKiB3ZWJwYWNrTW9kZTogXCJlYWdlclwiICovIGAuLi8uLi9icmFuZC8ke3BoZXQuY2hpcHBlci5icmFuZH0vanMvQnJhbmQuanNgIClcclxuICAudGhlbiggbW9kdWxlID0+IHVubG9ja0JyYW5kKCkgKVxyXG4gIC5jYXRjaCggZXJyID0+IGNvbnNvbGUubG9nKCBlcnIgKSApO1xyXG5cclxuaWYgKCBUYW5kZW0uUEhFVF9JT19FTkFCTEVEICkge1xyXG4gIGNvbnN0IHVubG9ja1BoZXRpb0VuZ2luZSA9IGFzeW5jTG9hZGVyLmNyZWF0ZUxvY2soIHsgbmFtZTogJ3BoZXRpb0VuZ2luZScgfSApO1xyXG4gIGltcG9ydCggLyogd2VicGFja01vZGU6IFwiZWFnZXJcIiAqLyAnLi4vLi4vcGhldC1pby9qcy9waGV0aW9FbmdpbmUuanMnIClcclxuICAgIC50aGVuKCBtb2R1bGUgPT4ge1xyXG4gICAgICBwaGV0aW9FbmdpbmUgPSBtb2R1bGUuZGVmYXVsdDtcclxuICAgICAgdW5sb2NrUGhldGlvRW5naW5lKCk7XHJcbiAgICB9IClcclxuICAgIC5jYXRjaCggZXJyID0+IGNvbnNvbGUubG9nKCBlcnIgKSApO1xyXG59XHJcblxyXG5jb25zdCB1bmxvY2tMYXVuY2ggPSBhc3luY0xvYWRlci5jcmVhdGVMb2NrKCB7IG5hbWU6ICdsYXVuY2gnIH0gKTtcclxuXHJcbmNsYXNzIFNpbUxhdW5jaGVyIHtcclxuXHJcbiAgcHJpdmF0ZSBsYXVuY2hDb21wbGV0ZTogYm9vbGVhbjsgLy8gTWFya2VkIGFzIHRydWUgd2hlbiBzaW1MYXVuY2hlciBoYXMgZmluaXNoZWQgaXRzIHdvcmsgY3ljbGUgYW5kIGNvbnRyb2wgaXMgZ2l2ZW4gb3ZlciB0byB0aGUgc2ltdWxhdGlvbiB0byBmaW5pc2ggaW5pdGlhbGl6YXRpb24uXHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHRoaXMubGF1bmNoQ29tcGxldGUgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExhdW5jaCB0aGUgU2ltIGJ5IHByZWxvYWRpbmcgdGhlIGltYWdlcyBhbmQgY2FsbGluZyB0aGUgY2FsbGJhY2suXHJcbiAgICogdG8gYmUgY2FsbGVkIGJ5IG1haW4oKXMgZXZlcnl3aGVyZVxyXG4gICAqXHJcbiAgICogY2FsbGJhY2sgLSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2hpY2ggc2hvdWxkIGNyZWF0ZSBhbmQgc3RhcnQgdGhlIHNpbSwgZ2l2ZW4gdGhhdCBhbGwgYXN5bmNcclxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgaXMgbG9hZGVkXHJcbiAgICovXHJcbiAgcHVibGljIGxhdW5jaCggY2FsbGJhY2s6ICgpID0+IHZvaWQgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhd2luZG93LnBoZXQuam9pc3QubGF1bmNoQ2FsbGVkLCAnVHJpZWQgdG8gbGF1bmNoIHR3aWNlJyApO1xyXG5cclxuICAgIC8vIEFkZCBsaXN0ZW5lciBiZWZvcmUgdW5sb2NraW5nIHRoZSBsYXVuY2ggbG9ja1xyXG4gICAgYXN5bmNMb2FkZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuXHJcbiAgICAgIHdpbmRvdy5waGV0LmpvaXN0LmxhdW5jaFNpbXVsYXRpb24gPSAoKSA9PiB7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIXRoaXMubGF1bmNoQ29tcGxldGUsICdzaG91bGQgbm90IGhhdmUgY29tcGxldGVkIGxhdW5jaGluZyB0aGUgc2ltIHlldCcgKTtcclxuICAgICAgICB0aGlzLmxhdW5jaENvbXBsZXRlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgLy8gb25jZSBsYXVuY2hTaW11bGF0aW9uIGhhcyBiZWVuIGNhbGxlZCwgdGhlIHdyYXBwZXIgaXMgcmVhZHkgdG8gcmVjZWl2ZSBtZXNzYWdlcyBiZWNhdXNlIGFueSBsaXN0ZW5lcnMgaXRcclxuICAgICAgICAvLyB3YW50cyBoYXZlIGJlZW4gc2V0IHVwIGJ5IG5vdy5cclxuICAgICAgICBpZiAoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgKSB7XHJcbiAgICAgICAgICBwaGV0aW9FbmdpbmU/Lm9uQ3Jvc3NGcmFtZUxpc3RlbmVyc1JlYWR5KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBJbnN0YW50aWF0ZSB0aGUgc2ltIGFuZCBzaG93IGl0LlxyXG4gICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBQaEVULWlPIHNpbXVsYXRpb25zIHN1cHBvcnQgYW4gaW5pdGlhbGl6YXRpb24gcGhhc2UgKGJlZm9yZSB0aGUgc2ltIGxhdW5jaGVzKVxyXG4gICAgICBpZiAoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgKSB7XHJcbiAgICAgICAgcGhldGlvRW5naW5lPy5pbml0aWFsaXplKCk7IC8vIGNhbGxzIGJhY2sgdG8gd2luZG93LnBoZXQuam9pc3QubGF1bmNoU2ltdWxhdGlvblxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIHBoZXQuY2hpcHBlci5xdWVyeVBhcmFtZXRlcnMucG9zdE1lc3NhZ2VPblJlYWR5ICkge1xyXG4gICAgICAgIHdpbmRvdy5wYXJlbnQgJiYgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSggSlNPTi5zdHJpbmdpZnkoIHtcclxuICAgICAgICAgIHR5cGU6ICdyZWFkeScsXHJcbiAgICAgICAgICB1cmw6IHdpbmRvdy5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgfSApLCAnKicgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCAoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgIXBoZXQucHJlbG9hZHMucGhldGlvLnF1ZXJ5UGFyYW1ldGVycy5waGV0aW9TdGFuZGFsb25lICkgfHxcclxuICAgICAgICAgICBwaGV0LmNoaXBwZXIucXVlcnlQYXJhbWV0ZXJzLnBsYXliYWNrTW9kZSApIHtcclxuXHJcbiAgICAgICAgLy8gV2FpdCBmb3IgcGhldC1pbyB0byBmaW5pc2ggYWRkaW5nIGxpc3RlbmVycy4gSXQgd2lsbCBkaXJlY3QgdGhlIGxhdW5jaCBmcm9tIHRoZXJlLlxyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHdpbmRvdy5waGV0LmpvaXN0LmxhdW5jaFNpbXVsYXRpb24oKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gICAgdW5sb2NrTGF1bmNoKCk7XHJcblxyXG4gICAgLy8gU2lnbmlmeSB0aGF0IHRoZSBzaW1MYXVuY2hlciB3YXMgY2FsbGVkLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy8xNDJcclxuICAgIHdpbmRvdy5waGV0LmpvaXN0LmxhdW5jaENhbGxlZCA9IHRydWU7XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBzaW1MYXVuY2hlciA9IG5ldyBTaW1MYXVuY2hlcigpO1xyXG5cclxuam9pc3QucmVnaXN0ZXIoICdzaW1MYXVuY2hlcicsIHNpbUxhdW5jaGVyICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBzaW1MYXVuY2hlcjsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxXQUFXLE1BQU0sbUNBQW1DO0FBRTNELE9BQU9DLE1BQU0sTUFBTSwyQkFBMkI7QUFDOUMsT0FBT0MsS0FBSyxNQUFNLFlBQVk7O0FBRTlCO0FBQ0EsSUFBSUMsWUFBaUMsR0FBRyxJQUFJO0FBRTVDLE1BQU1DLFdBQVcsR0FBR0osV0FBVyxDQUFDSyxVQUFVLENBQUU7RUFBRUMsSUFBSSxFQUFFO0FBQVEsQ0FBRSxDQUFDO0FBQy9ELE1BQU0sRUFBRSwwQkFBNEIsZUFBY0MsSUFBSSxDQUFDQyxPQUFPLENBQUNDLEtBQU0sY0FBYyxDQUFDLENBQ2pGQyxJQUFJLENBQUVDLE1BQU0sSUFBSVAsV0FBVyxDQUFDLENBQUUsQ0FBQyxDQUMvQlEsS0FBSyxDQUFFQyxHQUFHLElBQUlDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFFRixHQUFJLENBQUUsQ0FBQztBQUVyQyxJQUFLWixNQUFNLENBQUNlLGVBQWUsRUFBRztFQUM1QixNQUFNQyxrQkFBa0IsR0FBR2pCLFdBQVcsQ0FBQ0ssVUFBVSxDQUFFO0lBQUVDLElBQUksRUFBRTtFQUFlLENBQUUsQ0FBQztFQUM3RSxNQUFNLEVBQUUsMEJBQTJCLGtDQUFtQyxDQUFDLENBQ3BFSSxJQUFJLENBQUVDLE1BQU0sSUFBSTtJQUNmUixZQUFZLEdBQUdRLE1BQU0sQ0FBQ08sT0FBTztJQUM3QkQsa0JBQWtCLENBQUMsQ0FBQztFQUN0QixDQUFFLENBQUMsQ0FDRkwsS0FBSyxDQUFFQyxHQUFHLElBQUlDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFFRixHQUFJLENBQUUsQ0FBQztBQUN2QztBQUVBLE1BQU1NLFlBQVksR0FBR25CLFdBQVcsQ0FBQ0ssVUFBVSxDQUFFO0VBQUVDLElBQUksRUFBRTtBQUFTLENBQUUsQ0FBQztBQUVqRSxNQUFNYyxXQUFXLENBQUM7RUFFaUI7O0VBRTFCQyxXQUFXQSxDQUFBLEVBQUc7SUFDbkIsSUFBSSxDQUFDQyxjQUFjLEdBQUcsS0FBSztFQUM3Qjs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTQyxNQUFNQSxDQUFFQyxRQUFvQixFQUFTO0lBQzFDQyxNQUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDQyxNQUFNLENBQUNuQixJQUFJLENBQUNMLEtBQUssQ0FBQ3lCLFlBQVksRUFBRSx1QkFBd0IsQ0FBQzs7SUFFNUU7SUFDQTNCLFdBQVcsQ0FBQzRCLFdBQVcsQ0FBRSxNQUFNO01BRTdCRixNQUFNLENBQUNuQixJQUFJLENBQUNMLEtBQUssQ0FBQzJCLGdCQUFnQixHQUFHLE1BQU07UUFDekNKLE1BQU0sSUFBSUEsTUFBTSxDQUFFLENBQUMsSUFBSSxDQUFDSCxjQUFjLEVBQUUsaURBQWtELENBQUM7UUFDM0YsSUFBSSxDQUFDQSxjQUFjLEdBQUcsSUFBSTs7UUFFMUI7UUFDQTtRQUNBLElBQUtyQixNQUFNLENBQUNlLGVBQWUsRUFBRztVQUM1QmIsWUFBWSxFQUFFMkIsMEJBQTBCLENBQUMsQ0FBQztRQUM1Qzs7UUFFQTtRQUNBTixRQUFRLENBQUMsQ0FBQztNQUNaLENBQUM7O01BRUQ7TUFDQSxJQUFLdkIsTUFBTSxDQUFDZSxlQUFlLEVBQUc7UUFDNUJiLFlBQVksRUFBRTRCLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztNQUM5Qjs7TUFFQSxJQUFLeEIsSUFBSSxDQUFDQyxPQUFPLENBQUN3QixlQUFlLENBQUNDLGtCQUFrQixFQUFHO1FBQ3JEUCxNQUFNLENBQUNRLE1BQU0sSUFBSVIsTUFBTSxDQUFDUSxNQUFNLENBQUNDLFdBQVcsQ0FBRUMsSUFBSSxDQUFDQyxTQUFTLENBQUU7VUFDMURDLElBQUksRUFBRSxPQUFPO1VBQ2JDLEdBQUcsRUFBRWIsTUFBTSxDQUFDYyxRQUFRLENBQUNDO1FBQ3ZCLENBQUUsQ0FBQyxFQUFFLEdBQUksQ0FBQztNQUNaO01BRUEsSUFBT3hDLE1BQU0sQ0FBQ2UsZUFBZSxJQUFJLENBQUNULElBQUksQ0FBQ21DLFFBQVEsQ0FBQ0MsTUFBTSxDQUFDWCxlQUFlLENBQUNZLGdCQUFnQixJQUNsRnJDLElBQUksQ0FBQ0MsT0FBTyxDQUFDd0IsZUFBZSxDQUFDYSxZQUFZLEVBQUc7O1FBRS9DO01BQUEsQ0FDRCxNQUNJO1FBQ0huQixNQUFNLENBQUNuQixJQUFJLENBQUNMLEtBQUssQ0FBQzJCLGdCQUFnQixDQUFDLENBQUM7TUFDdEM7SUFDRixDQUFFLENBQUM7SUFDSFYsWUFBWSxDQUFDLENBQUM7O0lBRWQ7SUFDQU8sTUFBTSxDQUFDbkIsSUFBSSxDQUFDTCxLQUFLLENBQUN5QixZQUFZLEdBQUcsSUFBSTtFQUN2QztBQUNGO0FBRUEsTUFBTW1CLFdBQVcsR0FBRyxJQUFJMUIsV0FBVyxDQUFDLENBQUM7QUFFckNsQixLQUFLLENBQUM2QyxRQUFRLENBQUUsYUFBYSxFQUFFRCxXQUFZLENBQUM7QUFFNUMsZUFBZUEsV0FBVyJ9