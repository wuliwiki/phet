// Copyright 2016-2023, University of Colorado Boulder

/**
 * Shows a Dialog with content describing keyboard interactions. Opened via a button in the navigation bar.
 *
 * @author Jesse Greenberg
 */

import Multilink from '../../axon/js/Multilink.js';
import optionize from '../../phet-core/js/optionize.js';
import KeyboardHelpSectionRow from '../../scenery-phet/js/keyboard/help/KeyboardHelpSectionRow.js';
import TextKeyNode from '../../scenery-phet/js/keyboard/TextKeyNode.js';
import PhetFont from '../../scenery-phet/js/PhetFont.js';
import { HBox, Node, PDOMPeer, ReadingBlock, VBox, VoicingText } from '../../scenery/js/imports.js';
import Dialog from '../../sun/js/Dialog.js';
import joist from './joist.js';
import JoistStrings from './JoistStrings.js';
// constants
const TITLE_MAX_WIDTH = 670;
const tabToGetStartedStringProperty = JoistStrings.a11y.keyboardHelp.tabToGetStartedStringProperty;
export default class KeyboardHelpDialog extends Dialog {
  constructor(screens, screenProperty, providedOptions) {
    const options = optionize()({
      titleAlign: 'center',
      fill: 'rgb( 214, 237, 249 )',
      ySpacing: 15,
      // phet-io
      phetioReadOnly: true,
      // the KeyboardHelpDialog should not be settable
      phetioDynamicElement: true,
      // Append the title to the close button
      closeButtonVoicingDialogTitle: JoistStrings.keyboardShortcuts.titleStringProperty,
      // Because of the special titleNode, we set the aria-labelledby attribute manually; see below.
      addAriaLabelledByFromTitle: false
    }, providedOptions);
    const content = new Node({
      tagName: 'div'
    });
    const contentTandem = options.tandem.createTandem('content');
    const screenContentNodes = [];
    screens.forEach(screen => {
      assert && assert(screen.createKeyboardHelpNode, 'if any screen has keyboard help content, then all screens need content');
      const screenTandem = contentTandem.createTandem(screen.tandem.name);
      const keyboardHelpNode = screen.createKeyboardHelpNode(screenTandem);
      screenContentNodes.push(keyboardHelpNode);
    });
    const shortcutsTitleText = new VoicingText(JoistStrings.keyboardShortcuts.titleStringProperty, {
      font: new PhetFont({
        weight: 'bold',
        size: 24
      }),
      maxWidth: TITLE_MAX_WIDTH,
      // pdom options
      tagName: 'h1',
      innerContent: JoistStrings.a11y.keyboardHelp.keyboardShortcutsStringProperty
    });

    // a 'tab to get started' hint
    const tabHintLine = new TabHintLine();

    // stack the two items with a bit of spacing
    assert && assert(!options.title, 'KeyboardHelpDialog sets title');
    const titleVBox = new VBox({
      children: [shortcutsTitleText, tabHintLine],
      spacing: 5,
      // pdom
      tagName: 'div'
    });
    options.title = titleVBox;

    // help content surrounded by a div unless already specified, so that all content is read when dialog opens

    super(content, options);

    // When the screen changes, swap out keyboard help content to the selected screen's content

    const childSwitcherMultilink = Multilink.multilink([screenProperty, this.isShowingProperty], (screen, isShowing) => {
      assert && assert(screens.includes(screen), 'double check that this is an expected screen');
      const currentContentNode = screenContentNodes[screens.indexOf(screen)];
      if (isShowing) {
        assert && assert(currentContentNode, 'a displayed KeyboardHelpButton for a screen should have content');
        content.children = [currentContentNode];
      }
    });

    // (a11y) Make sure that the title passed to the Dialog has an accessible name.
    this.addAriaLabelledbyAssociation({
      thisElementName: PDOMPeer.PRIMARY_SIBLING,
      otherNode: shortcutsTitleText,
      otherElementName: PDOMPeer.PRIMARY_SIBLING
    });
    this.disposeKeyboardHelpDialog = () => {
      childSwitcherMultilink.dispose();
      tabHintLine.dispose();
      shortcutsTitleText.dispose();

      // Graceful in case multiple screens reuse the same content.
      screenContentNodes.forEach(node => !node.isDisposed && node.dispose());
      screenContentNodes.length = 0;
      content.dispose();
    };
  }
  dispose() {
    this.disposeKeyboardHelpDialog();
    super.dispose();
  }
}

/**
 * An inner class that assembles the "Tab to get started" content of the Dialog title. This content
 * is interactive with Voicing in that it can be clicked to hear this content (when Voicing is enabled).
 */

class TabHintLine extends ReadingBlock(Node) {
  constructor(providedOptions) {
    const options = optionize()({
      readingBlockNameResponse: tabToGetStartedStringProperty
    }, providedOptions);
    super();
    const tabIcon = TextKeyNode.tab();

    // a line to say "tab to get started" below the "Keyboard Shortcuts" 'title'
    const labelWithIcon = KeyboardHelpSectionRow.labelWithIcon(JoistStrings.keyboardShortcuts.toGetStartedStringProperty, tabIcon, {
      labelInnerContent: tabToGetStartedStringProperty,
      iconOptions: {
        tagName: 'p' // because there is only one, and the default is an li tag
      }
    });

    // labelWithIcon is meant to be passed to KeyboardHelpSection, so we have to hack a bit here
    const hBox = new HBox({
      children: [labelWithIcon.icon, labelWithIcon.label],
      spacing: 4
    });
    this.disposeEmitter.addListener(() => {
      hBox.dispose();
      labelWithIcon.dispose();
      tabIcon.dispose();
    });
    this.addChild(hBox);
    this.mutate(options);
  }
}
joist.register('KeyboardHelpDialog', KeyboardHelpDialog);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJvcHRpb25pemUiLCJLZXlib2FyZEhlbHBTZWN0aW9uUm93IiwiVGV4dEtleU5vZGUiLCJQaGV0Rm9udCIsIkhCb3giLCJOb2RlIiwiUERPTVBlZXIiLCJSZWFkaW5nQmxvY2siLCJWQm94IiwiVm9pY2luZ1RleHQiLCJEaWFsb2ciLCJqb2lzdCIsIkpvaXN0U3RyaW5ncyIsIlRJVExFX01BWF9XSURUSCIsInRhYlRvR2V0U3RhcnRlZFN0cmluZ1Byb3BlcnR5IiwiYTExeSIsImtleWJvYXJkSGVscCIsIktleWJvYXJkSGVscERpYWxvZyIsImNvbnN0cnVjdG9yIiwic2NyZWVucyIsInNjcmVlblByb3BlcnR5IiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInRpdGxlQWxpZ24iLCJmaWxsIiwieVNwYWNpbmciLCJwaGV0aW9SZWFkT25seSIsInBoZXRpb0R5bmFtaWNFbGVtZW50IiwiY2xvc2VCdXR0b25Wb2ljaW5nRGlhbG9nVGl0bGUiLCJrZXlib2FyZFNob3J0Y3V0cyIsInRpdGxlU3RyaW5nUHJvcGVydHkiLCJhZGRBcmlhTGFiZWxsZWRCeUZyb21UaXRsZSIsImNvbnRlbnQiLCJ0YWdOYW1lIiwiY29udGVudFRhbmRlbSIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsInNjcmVlbkNvbnRlbnROb2RlcyIsImZvckVhY2giLCJzY3JlZW4iLCJhc3NlcnQiLCJjcmVhdGVLZXlib2FyZEhlbHBOb2RlIiwic2NyZWVuVGFuZGVtIiwibmFtZSIsImtleWJvYXJkSGVscE5vZGUiLCJwdXNoIiwic2hvcnRjdXRzVGl0bGVUZXh0IiwiZm9udCIsIndlaWdodCIsInNpemUiLCJtYXhXaWR0aCIsImlubmVyQ29udGVudCIsImtleWJvYXJkU2hvcnRjdXRzU3RyaW5nUHJvcGVydHkiLCJ0YWJIaW50TGluZSIsIlRhYkhpbnRMaW5lIiwidGl0bGUiLCJ0aXRsZVZCb3giLCJjaGlsZHJlbiIsInNwYWNpbmciLCJjaGlsZFN3aXRjaGVyTXVsdGlsaW5rIiwibXVsdGlsaW5rIiwiaXNTaG93aW5nUHJvcGVydHkiLCJpc1Nob3dpbmciLCJpbmNsdWRlcyIsImN1cnJlbnRDb250ZW50Tm9kZSIsImluZGV4T2YiLCJhZGRBcmlhTGFiZWxsZWRieUFzc29jaWF0aW9uIiwidGhpc0VsZW1lbnROYW1lIiwiUFJJTUFSWV9TSUJMSU5HIiwib3RoZXJOb2RlIiwib3RoZXJFbGVtZW50TmFtZSIsImRpc3Bvc2VLZXlib2FyZEhlbHBEaWFsb2ciLCJkaXNwb3NlIiwibm9kZSIsImlzRGlzcG9zZWQiLCJsZW5ndGgiLCJyZWFkaW5nQmxvY2tOYW1lUmVzcG9uc2UiLCJ0YWJJY29uIiwidGFiIiwibGFiZWxXaXRoSWNvbiIsInRvR2V0U3RhcnRlZFN0cmluZ1Byb3BlcnR5IiwibGFiZWxJbm5lckNvbnRlbnQiLCJpY29uT3B0aW9ucyIsImhCb3giLCJpY29uIiwibGFiZWwiLCJkaXNwb3NlRW1pdHRlciIsImFkZExpc3RlbmVyIiwiYWRkQ2hpbGQiLCJtdXRhdGUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIktleWJvYXJkSGVscERpYWxvZy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTaG93cyBhIERpYWxvZyB3aXRoIGNvbnRlbnQgZGVzY3JpYmluZyBrZXlib2FyZCBpbnRlcmFjdGlvbnMuIE9wZW5lZCB2aWEgYSBidXR0b24gaW4gdGhlIG5hdmlnYXRpb24gYmFyLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZ1xyXG4gKi9cclxuXHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUsIHsgRW1wdHlTZWxmT3B0aW9ucyB9IGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgUGlja1JlcXVpcmVkIGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrUmVxdWlyZWQuanMnO1xyXG5pbXBvcnQgU3RyaWN0T21pdCBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvU3RyaWN0T21pdC5qcyc7XHJcbmltcG9ydCBLZXlib2FyZEhlbHBTZWN0aW9uUm93IGZyb20gJy4uLy4uL3NjZW5lcnktcGhldC9qcy9rZXlib2FyZC9oZWxwL0tleWJvYXJkSGVscFNlY3Rpb25Sb3cuanMnO1xyXG5pbXBvcnQgVGV4dEtleU5vZGUgZnJvbSAnLi4vLi4vc2NlbmVyeS1waGV0L2pzL2tleWJvYXJkL1RleHRLZXlOb2RlLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IEhCb3gsIE5vZGUsIE5vZGVPcHRpb25zLCBQRE9NUGVlciwgUmVhZGluZ0Jsb2NrLCBSZWFkaW5nQmxvY2tPcHRpb25zLCBWQm94LCBWb2ljaW5nVGV4dCB9IGZyb20gJy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBEaWFsb2csIHsgRGlhbG9nT3B0aW9ucyB9IGZyb20gJy4uLy4uL3N1bi9qcy9EaWFsb2cuanMnO1xyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBKb2lzdFN0cmluZ3MgZnJvbSAnLi9Kb2lzdFN0cmluZ3MuanMnO1xyXG5pbXBvcnQgeyBBbnlTY3JlZW4gfSBmcm9tICcuL1NjcmVlbi5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgVElUTEVfTUFYX1dJRFRIID0gNjcwO1xyXG5cclxuY29uc3QgdGFiVG9HZXRTdGFydGVkU3RyaW5nUHJvcGVydHkgPSBKb2lzdFN0cmluZ3MuYTExeS5rZXlib2FyZEhlbHAudGFiVG9HZXRTdGFydGVkU3RyaW5nUHJvcGVydHk7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0gRW1wdHlTZWxmT3B0aW9ucztcclxuXHJcbmV4cG9ydCB0eXBlIEtleWJvYXJkSGVscERpYWxvZ09wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFN0cmljdE9taXQ8RGlhbG9nT3B0aW9ucywgJ3RpdGxlJz4gJiBQaWNrUmVxdWlyZWQ8RGlhbG9nT3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgS2V5Ym9hcmRIZWxwRGlhbG9nIGV4dGVuZHMgRGlhbG9nIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VLZXlib2FyZEhlbHBEaWFsb2c6ICgpID0+IHZvaWQ7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvciggc2NyZWVuczogQW55U2NyZWVuW10sIHNjcmVlblByb3BlcnR5OiBQcm9wZXJ0eTxBbnlTY3JlZW4+LCBwcm92aWRlZE9wdGlvbnM/OiBLZXlib2FyZEhlbHBEaWFsb2dPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8S2V5Ym9hcmRIZWxwRGlhbG9nT3B0aW9ucywgU2VsZk9wdGlvbnMsIERpYWxvZ09wdGlvbnM+KCkoIHtcclxuICAgICAgdGl0bGVBbGlnbjogJ2NlbnRlcicsXHJcbiAgICAgIGZpbGw6ICdyZ2IoIDIxNCwgMjM3LCAyNDkgKScsXHJcbiAgICAgIHlTcGFjaW5nOiAxNSxcclxuXHJcbiAgICAgIC8vIHBoZXQtaW9cclxuICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWUsIC8vIHRoZSBLZXlib2FyZEhlbHBEaWFsb2cgc2hvdWxkIG5vdCBiZSBzZXR0YWJsZVxyXG4gICAgICBwaGV0aW9EeW5hbWljRWxlbWVudDogdHJ1ZSxcclxuXHJcbiAgICAgIC8vIEFwcGVuZCB0aGUgdGl0bGUgdG8gdGhlIGNsb3NlIGJ1dHRvblxyXG4gICAgICBjbG9zZUJ1dHRvblZvaWNpbmdEaWFsb2dUaXRsZTogSm9pc3RTdHJpbmdzLmtleWJvYXJkU2hvcnRjdXRzLnRpdGxlU3RyaW5nUHJvcGVydHksXHJcblxyXG4gICAgICAvLyBCZWNhdXNlIG9mIHRoZSBzcGVjaWFsIHRpdGxlTm9kZSwgd2Ugc2V0IHRoZSBhcmlhLWxhYmVsbGVkYnkgYXR0cmlidXRlIG1hbnVhbGx5OyBzZWUgYmVsb3cuXHJcbiAgICAgIGFkZEFyaWFMYWJlbGxlZEJ5RnJvbVRpdGxlOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgY29udGVudCA9IG5ldyBOb2RlKCB7XHJcbiAgICAgIHRhZ05hbWU6ICdkaXYnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgY29udGVudFRhbmRlbSA9IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2NvbnRlbnQnICk7XHJcbiAgICBjb25zdCBzY3JlZW5Db250ZW50Tm9kZXM6IE5vZGVbXSA9IFtdO1xyXG4gICAgc2NyZWVucy5mb3JFYWNoKCBzY3JlZW4gPT4ge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBzY3JlZW4uY3JlYXRlS2V5Ym9hcmRIZWxwTm9kZSwgJ2lmIGFueSBzY3JlZW4gaGFzIGtleWJvYXJkIGhlbHAgY29udGVudCwgdGhlbiBhbGwgc2NyZWVucyBuZWVkIGNvbnRlbnQnICk7XHJcbiAgICAgIGNvbnN0IHNjcmVlblRhbmRlbSA9IGNvbnRlbnRUYW5kZW0uY3JlYXRlVGFuZGVtKCBzY3JlZW4udGFuZGVtLm5hbWUgKTtcclxuICAgICAgY29uc3Qga2V5Ym9hcmRIZWxwTm9kZSA9IHNjcmVlbi5jcmVhdGVLZXlib2FyZEhlbHBOb2RlISggc2NyZWVuVGFuZGVtICk7XHJcbiAgICAgIHNjcmVlbkNvbnRlbnROb2Rlcy5wdXNoKCBrZXlib2FyZEhlbHBOb2RlICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgc2hvcnRjdXRzVGl0bGVUZXh0ID0gbmV3IFZvaWNpbmdUZXh0KCBKb2lzdFN0cmluZ3Mua2V5Ym9hcmRTaG9ydGN1dHMudGl0bGVTdHJpbmdQcm9wZXJ0eSwge1xyXG4gICAgICBmb250OiBuZXcgUGhldEZvbnQoIHtcclxuICAgICAgICB3ZWlnaHQ6ICdib2xkJyxcclxuICAgICAgICBzaXplOiAyNFxyXG4gICAgICB9ICksXHJcbiAgICAgIG1heFdpZHRoOiBUSVRMRV9NQVhfV0lEVEgsXHJcblxyXG4gICAgICAvLyBwZG9tIG9wdGlvbnNcclxuICAgICAgdGFnTmFtZTogJ2gxJyxcclxuICAgICAgaW5uZXJDb250ZW50OiBKb2lzdFN0cmluZ3MuYTExeS5rZXlib2FyZEhlbHAua2V5Ym9hcmRTaG9ydGN1dHNTdHJpbmdQcm9wZXJ0eVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGEgJ3RhYiB0byBnZXQgc3RhcnRlZCcgaGludFxyXG4gICAgY29uc3QgdGFiSGludExpbmUgPSBuZXcgVGFiSGludExpbmUoKTtcclxuXHJcbiAgICAvLyBzdGFjayB0aGUgdHdvIGl0ZW1zIHdpdGggYSBiaXQgb2Ygc3BhY2luZ1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggIW9wdGlvbnMudGl0bGUsICdLZXlib2FyZEhlbHBEaWFsb2cgc2V0cyB0aXRsZScgKTtcclxuICAgIGNvbnN0IHRpdGxlVkJveCA9IG5ldyBWQm94KCB7XHJcbiAgICAgICAgY2hpbGRyZW46IFsgc2hvcnRjdXRzVGl0bGVUZXh0LCB0YWJIaW50TGluZSBdLFxyXG4gICAgICAgIHNwYWNpbmc6IDUsXHJcblxyXG4gICAgICAgIC8vIHBkb21cclxuICAgICAgICB0YWdOYW1lOiAnZGl2J1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gICAgb3B0aW9ucy50aXRsZSA9IHRpdGxlVkJveDtcclxuXHJcbiAgICAvLyBoZWxwIGNvbnRlbnQgc3Vycm91bmRlZCBieSBhIGRpdiB1bmxlc3MgYWxyZWFkeSBzcGVjaWZpZWQsIHNvIHRoYXQgYWxsIGNvbnRlbnQgaXMgcmVhZCB3aGVuIGRpYWxvZyBvcGVuc1xyXG5cclxuICAgIHN1cGVyKCBjb250ZW50LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gV2hlbiB0aGUgc2NyZWVuIGNoYW5nZXMsIHN3YXAgb3V0IGtleWJvYXJkIGhlbHAgY29udGVudCB0byB0aGUgc2VsZWN0ZWQgc2NyZWVuJ3MgY29udGVudFxyXG5cclxuICAgIGNvbnN0IGNoaWxkU3dpdGNoZXJNdWx0aWxpbmsgPSBNdWx0aWxpbmsubXVsdGlsaW5rKCBbIHNjcmVlblByb3BlcnR5LCB0aGlzLmlzU2hvd2luZ1Byb3BlcnR5IF0sICggc2NyZWVuLCBpc1Nob3dpbmcgKSA9PiB7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHNjcmVlbnMuaW5jbHVkZXMoIHNjcmVlbiApLCAnZG91YmxlIGNoZWNrIHRoYXQgdGhpcyBpcyBhbiBleHBlY3RlZCBzY3JlZW4nICk7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRDb250ZW50Tm9kZSA9IHNjcmVlbkNvbnRlbnROb2Rlc1sgc2NyZWVucy5pbmRleE9mKCBzY3JlZW4gKSBdITtcclxuICAgICAgaWYgKCBpc1Nob3dpbmcgKSB7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggY3VycmVudENvbnRlbnROb2RlLCAnYSBkaXNwbGF5ZWQgS2V5Ym9hcmRIZWxwQnV0dG9uIGZvciBhIHNjcmVlbiBzaG91bGQgaGF2ZSBjb250ZW50JyApO1xyXG4gICAgICAgIGNvbnRlbnQuY2hpbGRyZW4gPSBbIGN1cnJlbnRDb250ZW50Tm9kZSBdO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gKGExMXkpIE1ha2Ugc3VyZSB0aGF0IHRoZSB0aXRsZSBwYXNzZWQgdG8gdGhlIERpYWxvZyBoYXMgYW4gYWNjZXNzaWJsZSBuYW1lLlxyXG4gICAgdGhpcy5hZGRBcmlhTGFiZWxsZWRieUFzc29jaWF0aW9uKCB7XHJcbiAgICAgIHRoaXNFbGVtZW50TmFtZTogUERPTVBlZXIuUFJJTUFSWV9TSUJMSU5HLFxyXG4gICAgICBvdGhlck5vZGU6IHNob3J0Y3V0c1RpdGxlVGV4dCxcclxuICAgICAgb3RoZXJFbGVtZW50TmFtZTogUERPTVBlZXIuUFJJTUFSWV9TSUJMSU5HXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlS2V5Ym9hcmRIZWxwRGlhbG9nID0gKCkgPT4ge1xyXG4gICAgICBjaGlsZFN3aXRjaGVyTXVsdGlsaW5rLmRpc3Bvc2UoKTtcclxuICAgICAgdGFiSGludExpbmUuZGlzcG9zZSgpO1xyXG4gICAgICBzaG9ydGN1dHNUaXRsZVRleHQuZGlzcG9zZSgpO1xyXG5cclxuICAgICAgLy8gR3JhY2VmdWwgaW4gY2FzZSBtdWx0aXBsZSBzY3JlZW5zIHJldXNlIHRoZSBzYW1lIGNvbnRlbnQuXHJcbiAgICAgIHNjcmVlbkNvbnRlbnROb2Rlcy5mb3JFYWNoKCBub2RlID0+ICFub2RlLmlzRGlzcG9zZWQgJiYgbm9kZS5kaXNwb3NlKCkgKTtcclxuICAgICAgc2NyZWVuQ29udGVudE5vZGVzLmxlbmd0aCA9IDA7XHJcbiAgICAgIGNvbnRlbnQuZGlzcG9zZSgpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlS2V5Ym9hcmRIZWxwRGlhbG9nKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQW4gaW5uZXIgY2xhc3MgdGhhdCBhc3NlbWJsZXMgdGhlIFwiVGFiIHRvIGdldCBzdGFydGVkXCIgY29udGVudCBvZiB0aGUgRGlhbG9nIHRpdGxlLiBUaGlzIGNvbnRlbnRcclxuICogaXMgaW50ZXJhY3RpdmUgd2l0aCBWb2ljaW5nIGluIHRoYXQgaXQgY2FuIGJlIGNsaWNrZWQgdG8gaGVhciB0aGlzIGNvbnRlbnQgKHdoZW4gVm9pY2luZyBpcyBlbmFibGVkKS5cclxuICovXHJcblxyXG50eXBlIFRhYkhpbnRMaW5lU2VsZk9wdGlvbnMgPSBFbXB0eVNlbGZPcHRpb25zO1xyXG50eXBlIFRhYkhpbnRMaW5lT3B0aW9ucyA9IFRhYkhpbnRMaW5lU2VsZk9wdGlvbnMgJiBOb2RlT3B0aW9ucyAmIFJlYWRpbmdCbG9ja09wdGlvbnM7XHJcblxyXG5jbGFzcyBUYWJIaW50TGluZSBleHRlbmRzIFJlYWRpbmdCbG9jayggTm9kZSApIHtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcm92aWRlZE9wdGlvbnM/OiBUYWJIaW50TGluZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxUYWJIaW50TGluZU9wdGlvbnMsIFRhYkhpbnRMaW5lU2VsZk9wdGlvbnMsIFJlYWRpbmdCbG9ja09wdGlvbnM+KCkoIHtcclxuICAgICAgcmVhZGluZ0Jsb2NrTmFtZVJlc3BvbnNlOiB0YWJUb0dldFN0YXJ0ZWRTdHJpbmdQcm9wZXJ0eVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICBjb25zdCB0YWJJY29uID0gVGV4dEtleU5vZGUudGFiKCk7XHJcblxyXG4gICAgLy8gYSBsaW5lIHRvIHNheSBcInRhYiB0byBnZXQgc3RhcnRlZFwiIGJlbG93IHRoZSBcIktleWJvYXJkIFNob3J0Y3V0c1wiICd0aXRsZSdcclxuICAgIGNvbnN0IGxhYmVsV2l0aEljb24gPSBLZXlib2FyZEhlbHBTZWN0aW9uUm93LmxhYmVsV2l0aEljb24oIEpvaXN0U3RyaW5ncy5rZXlib2FyZFNob3J0Y3V0cy50b0dldFN0YXJ0ZWRTdHJpbmdQcm9wZXJ0eSxcclxuICAgICAgdGFiSWNvbiwge1xyXG4gICAgICAgIGxhYmVsSW5uZXJDb250ZW50OiB0YWJUb0dldFN0YXJ0ZWRTdHJpbmdQcm9wZXJ0eSxcclxuICAgICAgICBpY29uT3B0aW9uczoge1xyXG4gICAgICAgICAgdGFnTmFtZTogJ3AnIC8vIGJlY2F1c2UgdGhlcmUgaXMgb25seSBvbmUsIGFuZCB0aGUgZGVmYXVsdCBpcyBhbiBsaSB0YWdcclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAvLyBsYWJlbFdpdGhJY29uIGlzIG1lYW50IHRvIGJlIHBhc3NlZCB0byBLZXlib2FyZEhlbHBTZWN0aW9uLCBzbyB3ZSBoYXZlIHRvIGhhY2sgYSBiaXQgaGVyZVxyXG4gICAgY29uc3QgaEJveCA9IG5ldyBIQm94KCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIGxhYmVsV2l0aEljb24uaWNvbiwgbGFiZWxXaXRoSWNvbi5sYWJlbCBdLFxyXG4gICAgICBzcGFjaW5nOiA0XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmRpc3Bvc2VFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcbiAgICAgIGhCb3guZGlzcG9zZSgpO1xyXG4gICAgICBsYWJlbFdpdGhJY29uLmRpc3Bvc2UoKTtcclxuICAgICAgdGFiSWNvbi5kaXNwb3NlKCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggaEJveCApO1xyXG4gICAgdGhpcy5tdXRhdGUoIG9wdGlvbnMgKTtcclxuICB9XHJcbn1cclxuXHJcbmpvaXN0LnJlZ2lzdGVyKCAnS2V5Ym9hcmRIZWxwRGlhbG9nJywgS2V5Ym9hcmRIZWxwRGlhbG9nICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFNBQVMsTUFBTSw0QkFBNEI7QUFFbEQsT0FBT0MsU0FBUyxNQUE0QixpQ0FBaUM7QUFHN0UsT0FBT0Msc0JBQXNCLE1BQU0sK0RBQStEO0FBQ2xHLE9BQU9DLFdBQVcsTUFBTSwrQ0FBK0M7QUFDdkUsT0FBT0MsUUFBUSxNQUFNLG1DQUFtQztBQUN4RCxTQUFTQyxJQUFJLEVBQUVDLElBQUksRUFBZUMsUUFBUSxFQUFFQyxZQUFZLEVBQXVCQyxJQUFJLEVBQUVDLFdBQVcsUUFBUSw2QkFBNkI7QUFDckksT0FBT0MsTUFBTSxNQUF5Qix3QkFBd0I7QUFDOUQsT0FBT0MsS0FBSyxNQUFNLFlBQVk7QUFDOUIsT0FBT0MsWUFBWSxNQUFNLG1CQUFtQjtBQUc1QztBQUNBLE1BQU1DLGVBQWUsR0FBRyxHQUFHO0FBRTNCLE1BQU1DLDZCQUE2QixHQUFH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