// Copyright 2013-2023, University of Colorado Boulder

/**
 * The button that pops up the PhET menu, which appears in the bottom right of the home screen and on the right side
 * of the navbar.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import Multilink from '../../axon/js/Multilink.js';
import { AriaHasPopUpMutator, Color, Image, Line, Node } from '../../scenery/js/imports.js';
import pushButtonSoundPlayer from '../../tambo/js/shared-sound-players/pushButtonSoundPlayer.js';
import Tandem from '../../tandem/js/Tandem.js';
import IOType from '../../tandem/js/types/IOType.js';
import joist from './joist.js';
import JoistButton from './JoistButton.js';
import JoistStrings from './JoistStrings.js';
import KebabMenuIcon from './KebabMenuIcon.js';
import PhetMenu from './PhetMenu.js';
import updateCheck from './updateCheck.js';
import UpdateState from './UpdateState.js';

// Accommodate logos of any height by scaling them down proportionately.
// The primary logo is 108px high and we have been scaling it at 0.28 to make it look good even on higher resolution
// displays.  The logo will be scaled up to 108px high so the rest of the layout code will work smoothly
// Scale to the same height as the PhET logo, so that layout code works correctly.
// height of the PhET logo, brand/phet/images/logo.png or brand/adapted-from-phet/images/logo.png
const PHET_LOGO_HEIGHT = 108;
const PHET_LOGO_SCALE = 0.28; // scale applied to the PhET logo

class PhetButton extends JoistButton {
  /**
   * IO Type for PhetButton, to interface with PhET-iO API.  The PhetButtonIO acts as the main phet-io branding/logo in
   * the sim. It doesn't inherit from NodeIO because we neither need all of NodeIO's API methods, nor do we want to
   * support maintaining overriding no-ops in this file see https://github.com/phetsims/scenery/issues/711 for more info.
   */
  static PhetButtonIO = new IOType('PhetButtonIO', {
    valueType: PhetButton,
    documentation: 'The PhET Button in the bottom right of the screen'
  });
  constructor(sim, backgroundFillProperty, tandem) {
    // Dynamic modules are loaded in simLauncher and accessed through their namespace
    const Brand = phet.brand.Brand;
    assert && assert(Brand, 'Brand should exist by now');

    // The logo images are loaded from the brand which is selected via query parameter (during unbuilt mode)
    // or a grunt option (during the build), please see initialize-globals.js window.phet.chipper.brand for more
    // details
    const logoOnBlackBackground = Brand.logoOnBlackBackground;
    const logoOnWhiteBackground = Brand.logoOnWhiteBackground;

    // PhET logo
    const logoImage = new Image(logoOnBlackBackground, {
      scale: PHET_LOGO_SCALE / logoOnBlackBackground.height * PHET_LOGO_HEIGHT * 0.85,
      pickable: false
    });

    // The menu icon, to the right of the logo
    const menuIcon = new KebabMenuIcon({
      scale: 0.83,
      left: logoImage.width + 8,
      bottom: logoImage.bottom - 0.5,
      pickable: false
    });

    // Assert here means that ?ea was provided (potentially from the wrapper) AND that there are actually assertions
    // available for debugging.
    const children = assert && Tandem.PHET_IO_ENABLED ? [
    // The underline in phet-io debug mode. "7" is the right distance to avoid hiding the trademark.
    new Line(0, 0, logoImage.width - 7, 0, {
      stroke: 'red',
      lineWidth: 3,
      left: logoImage.left,
      bottom: logoImage.bottom
    }), logoImage, menuIcon] : [logoImage, menuIcon];

    // The icon combines the PhET logo and the menu icon
    const icon = new Node({
      children: children
    });
    super(icon, backgroundFillProperty, {
      highlightExtensionWidth: 6,
      highlightExtensionHeight: 5,
      highlightCenterOffsetY: 4,
      listener: () => {
        phetMenu.show();
        phetMenu.items[0].focus();
        pushButtonSoundPlayer.play();
      },
      tandem: tandem,
      phetioType: PhetButton.PhetButtonIO,
      phetioDocumentation: 'The button that appears at the right side of the navigation bar, which shows a menu when pressed',
      // This is the primary way to prevent learners from accessing the PhET menu in PhET-iO, so feature it.
      enabledPropertyOptions: {
        phetioFeatured: true,
        phetioDocumentation: 'When disabled, the (three dots) are hidden and the button cannot be pressed, hiding the PhET menu.'
      },
      phetioVisiblePropertyInstrumented: false,
      // This button is our branding, don't ever hide it.

      // pdom
      innerContent: JoistStrings.a11y.phetMenuStringProperty,
      // voicing
      voicingNameResponse: JoistStrings.a11y.phetMenuStringProperty
    });
    const phetMenu = new PhetMenu(sim, {
      tandem: tandem.createTandem('phetMenu'),
      focusOnHideNode: this
    });

    // Sim.js handles scaling the popup menu.  This code sets the position of the popup menu.
    // sim.bounds are null on init, but we will get the callback when it is sized for the first time
    // Does not need to be unlinked or disposed because PhetButton persists for the lifetime of the sim
    Multilink.multilink([sim.boundsProperty, sim.screenBoundsProperty, sim.scaleProperty, phetMenu.localBoundsProperty], (bounds, screenBounds, scale) => {
      if (bounds && screenBounds && scale) {
        phetMenu.setScaleMagnitude(scale);
        phetMenu.right = bounds.right - 2;
        const navBarHeight = bounds.height - screenBounds.height;
        phetMenu.bottom = screenBounds.bottom + navBarHeight / 2;
      }
    });

    // No need to unlink, as the PhetButton exists for the lifetime of the sim
    Multilink.multilink([backgroundFillProperty, sim.selectedScreenProperty, updateCheck.stateProperty], (backgroundFill, screen, updateState) => {
      const showHomeScreen = screen === sim.homeScreen;
      const backgroundIsWhite = !backgroundFill.equals(Color.BLACK) && !showHomeScreen;
      const outOfDate = updateState === UpdateState.OUT_OF_DATE;
      menuIcon.fill = backgroundIsWhite ? outOfDate ? '#0a0' : '#222' : outOfDate ? '#3F3' : 'white';
      logoImage.image = backgroundIsWhite ? logoOnWhiteBackground : logoOnBlackBackground;
    });

    // Added for phet-io, when toggling enabled, hide the option dots to prevent the cueing.
    // No need to be removed because the PhetButton exists for the lifetime of the sim.
    this.buttonModel.enabledProperty.link(enabled => {
      menuIcon.visible = enabled;
    });

    // pdom - add an attribute that lets the user know the button opens a menu
    AriaHasPopUpMutator.mutateNode(this, true);
  }
}
joist.register('PhetButton', PhetButton);
export default PhetButton;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJBcmlhSGFzUG9wVXBNdXRhdG9yIiwiQ29sb3IiLCJJbWFnZSIsIkxpbmUiLCJOb2RlIiwicHVzaEJ1dHRvblNvdW5kUGxheWVyIiwiVGFuZGVtIiwiSU9UeXBlIiwiam9pc3QiLCJKb2lzdEJ1dHRvbiIsIkpvaXN0U3RyaW5ncyIsIktlYmFiTWVudUljb24iLCJQaGV0TWVudSIsInVwZGF0ZUNoZWNrIiwiVXBkYXRlU3RhdGUiLCJQSEVUX0xPR09fSEVJR0hUIiwiUEhFVF9MT0dPX1NDQUxFIiwiUGhldEJ1dHRvbiIsIlBoZXRCdXR0b25JTyIsInZhbHVlVHlwZSIsImRvY3VtZW50YXRpb24iLCJjb25zdHJ1Y3RvciIsInNpbSIsImJhY2tncm91bmRGaWxsUHJvcGVydHkiLCJ0YW5kZW0iLCJCcmFuZCIsInBoZXQiLCJicmFuZCIsImFzc2VydCIsImxvZ29PbkJsYWNrQmFja2dyb3VuZCIsImxvZ29PbldoaXRlQmFja2dyb3VuZCIsImxvZ29JbWFnZSIsInNjYWxlIiwiaGVpZ2h0IiwicGlja2FibGUiLCJtZW51SWNvbiIsImxlZnQiLCJ3aWR0aCIsImJvdHRvbSIsImNoaWxkcmVuIiwiUEhFVF9JT19FTkFCTEVEIiwic3Ryb2tlIiwibGluZVdpZHRoIiwiaWNvbiIsImhpZ2hsaWdodEV4dGVuc2lvbldpZHRoIiwiaGlnaGxpZ2h0RXh0ZW5zaW9uSGVpZ2h0IiwiaGlnaGxpZ2h0Q2VudGVyT2Zmc2V0WSIsImxpc3RlbmVyIiwicGhldE1lbnUiLCJzaG93IiwiaXRlbXMiLCJmb2N1cyIsInBsYXkiLCJwaGV0aW9UeXBlIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImVuYWJsZWRQcm9wZXJ0eU9wdGlvbnMiLCJwaGV0aW9GZWF0dXJlZCIsInBoZXRpb1Zpc2libGVQcm9wZXJ0eUluc3RydW1lbnRlZCIsImlubmVyQ29udGVudCIsImExMXkiLCJwaGV0TWVudVN0cmluZ1Byb3BlcnR5Iiwidm9pY2luZ05hbWVSZXNwb25zZSIsImNyZWF0ZVRhbmRlbSIsImZvY3VzT25IaWRlTm9kZSIsIm11bHRpbGluayIsImJvdW5kc1Byb3BlcnR5Iiwic2NyZWVuQm91bmRzUHJvcGVydHkiLCJzY2FsZVByb3BlcnR5IiwibG9jYWxCb3VuZHNQcm9wZXJ0eSIsImJvdW5kcyIsInNjcmVlbkJvdW5kcyIsInNldFNjYWxlTWFnbml0dWRlIiwicmlnaHQiLCJuYXZCYXJIZWlnaHQiLCJzZWxlY3RlZFNjcmVlblByb3BlcnR5Iiwic3RhdGVQcm9wZXJ0eSIsImJhY2tncm91bmRGaWxsIiwic2NyZWVuIiwidXBkYXRlU3RhdGUiLCJzaG93SG9tZVNjcmVlbiIsImhvbWVTY3JlZW4iLCJiYWNrZ3JvdW5kSXNXaGl0ZSIsImVxdWFscyIsIkJMQUNLIiwib3V0T2ZEYXRlIiwiT1VUX09GX0RBVEUiLCJmaWxsIiwiaW1hZ2UiLCJidXR0b25Nb2RlbCIsImVuYWJsZWRQcm9wZXJ0eSIsImxpbmsiLCJlbmFibGVkIiwidmlzaWJsZSIsIm11dGF0ZU5vZGUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBoZXRCdXR0b24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVGhlIGJ1dHRvbiB0aGF0IHBvcHMgdXAgdGhlIFBoRVQgbWVudSwgd2hpY2ggYXBwZWFycyBpbiB0aGUgYm90dG9tIHJpZ2h0IG9mIHRoZSBob21lIHNjcmVlbiBhbmQgb24gdGhlIHJpZ2h0IHNpZGVcclxuICogb2YgdGhlIG5hdmJhci5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBUQnJhbmQgZnJvbSAnLi4vLi4vYnJhbmQvanMvVEJyYW5kLmpzJztcclxuaW1wb3J0IHsgQXJpYUhhc1BvcFVwTXV0YXRvciwgQ29sb3IsIEltYWdlLCBMaW5lLCBOb2RlIH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHB1c2hCdXR0b25Tb3VuZFBsYXllciBmcm9tICcuLi8uLi90YW1iby9qcy9zaGFyZWQtc291bmQtcGxheWVycy9wdXNoQnV0dG9uU291bmRQbGF5ZXIuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBKb2lzdEJ1dHRvbiBmcm9tICcuL0pvaXN0QnV0dG9uLmpzJztcclxuaW1wb3J0IEpvaXN0U3RyaW5ncyBmcm9tICcuL0pvaXN0U3RyaW5ncy5qcyc7XHJcbmltcG9ydCBLZWJhYk1lbnVJY29uIGZyb20gJy4vS2ViYWJNZW51SWNvbi5qcyc7XHJcbmltcG9ydCBQaGV0TWVudSBmcm9tICcuL1BoZXRNZW51LmpzJztcclxuaW1wb3J0IFNpbSBmcm9tICcuL1NpbS5qcyc7XHJcbmltcG9ydCB1cGRhdGVDaGVjayBmcm9tICcuL3VwZGF0ZUNoZWNrLmpzJztcclxuaW1wb3J0IFVwZGF0ZVN0YXRlIGZyb20gJy4vVXBkYXRlU3RhdGUuanMnO1xyXG5cclxuLy8gQWNjb21tb2RhdGUgbG9nb3Mgb2YgYW55IGhlaWdodCBieSBzY2FsaW5nIHRoZW0gZG93biBwcm9wb3J0aW9uYXRlbHkuXHJcbi8vIFRoZSBwcmltYXJ5IGxvZ28gaXMgMTA4cHggaGlnaCBhbmQgd2UgaGF2ZSBiZWVuIHNjYWxpbmcgaXQgYXQgMC4yOCB0byBtYWtlIGl0IGxvb2sgZ29vZCBldmVuIG9uIGhpZ2hlciByZXNvbHV0aW9uXHJcbi8vIGRpc3BsYXlzLiAgVGhlIGxvZ28gd2lsbCBiZSBzY2FsZWQgdXAgdG8gMTA4cHggaGlnaCBzbyB0aGUgcmVzdCBvZiB0aGUgbGF5b3V0IGNvZGUgd2lsbCB3b3JrIHNtb290aGx5XHJcbi8vIFNjYWxlIHRvIHRoZSBzYW1lIGhlaWdodCBhcyB0aGUgUGhFVCBsb2dvLCBzbyB0aGF0IGxheW91dCBjb2RlIHdvcmtzIGNvcnJlY3RseS5cclxuLy8gaGVpZ2h0IG9mIHRoZSBQaEVUIGxvZ28sIGJyYW5kL3BoZXQvaW1hZ2VzL2xvZ28ucG5nIG9yIGJyYW5kL2FkYXB0ZWQtZnJvbS1waGV0L2ltYWdlcy9sb2dvLnBuZ1xyXG5jb25zdCBQSEVUX0xPR09fSEVJR0hUID0gMTA4O1xyXG5jb25zdCBQSEVUX0xPR09fU0NBTEUgPSAwLjI4OyAvLyBzY2FsZSBhcHBsaWVkIHRvIHRoZSBQaEVUIGxvZ29cclxuXHJcbmNsYXNzIFBoZXRCdXR0b24gZXh0ZW5kcyBKb2lzdEJ1dHRvbiB7XHJcbiAgLyoqXHJcbiAgICogSU8gVHlwZSBmb3IgUGhldEJ1dHRvbiwgdG8gaW50ZXJmYWNlIHdpdGggUGhFVC1pTyBBUEkuICBUaGUgUGhldEJ1dHRvbklPIGFjdHMgYXMgdGhlIG1haW4gcGhldC1pbyBicmFuZGluZy9sb2dvIGluXHJcbiAgICogdGhlIHNpbS4gSXQgZG9lc24ndCBpbmhlcml0IGZyb20gTm9kZUlPIGJlY2F1c2Ugd2UgbmVpdGhlciBuZWVkIGFsbCBvZiBOb2RlSU8ncyBBUEkgbWV0aG9kcywgbm9yIGRvIHdlIHdhbnQgdG9cclxuICAgKiBzdXBwb3J0IG1haW50YWluaW5nIG92ZXJyaWRpbmcgbm8tb3BzIGluIHRoaXMgZmlsZSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3NjZW5lcnkvaXNzdWVzLzcxMSBmb3IgbW9yZSBpbmZvLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUGhldEJ1dHRvbklPID0gbmV3IElPVHlwZSggJ1BoZXRCdXR0b25JTycsIHtcclxuICAgIHZhbHVlVHlwZTogUGhldEJ1dHRvbixcclxuICAgIGRvY3VtZW50YXRpb246ICdUaGUgUGhFVCBCdXR0b24gaW4gdGhlIGJvdHRvbSByaWdodCBvZiB0aGUgc2NyZWVuJ1xyXG4gIH0gKTtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBzaW06IFNpbSwgYmFja2dyb3VuZEZpbGxQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Q29sb3I+LCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICAvLyBEeW5hbWljIG1vZHVsZXMgYXJlIGxvYWRlZCBpbiBzaW1MYXVuY2hlciBhbmQgYWNjZXNzZWQgdGhyb3VnaCB0aGVpciBuYW1lc3BhY2VcclxuICAgIGNvbnN0IEJyYW5kOiBUQnJhbmQgPSBwaGV0LmJyYW5kLkJyYW5kO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggQnJhbmQsICdCcmFuZCBzaG91bGQgZXhpc3QgYnkgbm93JyApO1xyXG5cclxuICAgIC8vIFRoZSBsb2dvIGltYWdlcyBhcmUgbG9hZGVkIGZyb20gdGhlIGJyYW5kIHdoaWNoIGlzIHNlbGVjdGVkIHZpYSBxdWVyeSBwYXJhbWV0ZXIgKGR1cmluZyB1bmJ1aWx0IG1vZGUpXHJcbiAgICAvLyBvciBhIGdydW50IG9wdGlvbiAoZHVyaW5nIHRoZSBidWlsZCksIHBsZWFzZSBzZWUgaW5pdGlhbGl6ZS1nbG9iYWxzLmpzIHdpbmRvdy5waGV0LmNoaXBwZXIuYnJhbmQgZm9yIG1vcmVcclxuICAgIC8vIGRldGFpbHNcclxuICAgIGNvbnN0IGxvZ29PbkJsYWNrQmFja2dyb3VuZCA9IEJyYW5kLmxvZ29PbkJsYWNrQmFja2dyb3VuZDtcclxuICAgIGNvbnN0IGxvZ29PbldoaXRlQmFja2dyb3VuZCA9IEJyYW5kLmxvZ29PbldoaXRlQmFja2dyb3VuZDtcclxuXHJcbiAgICAvLyBQaEVUIGxvZ29cclxuICAgIGNvbnN0IGxvZ29JbWFnZSA9IG5ldyBJbWFnZSggbG9nb09uQmxhY2tCYWNrZ3JvdW5kLCB7XHJcbiAgICAgIHNjYWxlOiBQSEVUX0xPR09fU0NBTEUgLyBsb2dvT25CbGFja0JhY2tncm91bmQuaGVpZ2h0ICogUEhFVF9MT0dPX0hFSUdIVCAqIDAuODUsXHJcbiAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFRoZSBtZW51IGljb24sIHRvIHRoZSByaWdodCBvZiB0aGUgbG9nb1xyXG4gICAgY29uc3QgbWVudUljb24gPSBuZXcgS2ViYWJNZW51SWNvbigge1xyXG4gICAgICBzY2FsZTogMC44MyxcclxuICAgICAgbGVmdDogbG9nb0ltYWdlLndpZHRoICsgOCxcclxuICAgICAgYm90dG9tOiBsb2dvSW1hZ2UuYm90dG9tIC0gMC41LFxyXG4gICAgICBwaWNrYWJsZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBBc3NlcnQgaGVyZSBtZWFucyB0aGF0ID9lYSB3YXMgcHJvdmlkZWQgKHBvdGVudGlhbGx5IGZyb20gdGhlIHdyYXBwZXIpIEFORCB0aGF0IHRoZXJlIGFyZSBhY3R1YWxseSBhc3NlcnRpb25zXHJcbiAgICAvLyBhdmFpbGFibGUgZm9yIGRlYnVnZ2luZy5cclxuICAgIGNvbnN0IGNoaWxkcmVuID0gYXNzZXJ0ICYmIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgP1xyXG4gICAgICBbXHJcblxyXG4gICAgICAgIC8vIFRoZSB1bmRlcmxpbmUgaW4gcGhldC1pbyBkZWJ1ZyBtb2RlLiBcIjdcIiBpcyB0aGUgcmlnaHQgZGlzdGFuY2UgdG8gYXZvaWQgaGlkaW5nIHRoZSB0cmFkZW1hcmsuXHJcbiAgICAgICAgbmV3IExpbmUoIDAsIDAsIGxvZ29JbWFnZS53aWR0aCAtIDcsIDAsIHtcclxuICAgICAgICAgIHN0cm9rZTogJ3JlZCcsIGxpbmVXaWR0aDogMyxcclxuICAgICAgICAgIGxlZnQ6IGxvZ29JbWFnZS5sZWZ0LFxyXG4gICAgICAgICAgYm90dG9tOiBsb2dvSW1hZ2UuYm90dG9tXHJcbiAgICAgICAgfSApLCBsb2dvSW1hZ2UsIG1lbnVJY29uIF0gOlxyXG4gICAgICBbIGxvZ29JbWFnZSwgbWVudUljb24gXTtcclxuXHJcbiAgICAvLyBUaGUgaWNvbiBjb21iaW5lcyB0aGUgUGhFVCBsb2dvIGFuZCB0aGUgbWVudSBpY29uXHJcbiAgICBjb25zdCBpY29uID0gbmV3IE5vZGUoIHsgY2hpbGRyZW46IGNoaWxkcmVuIH0gKTtcclxuXHJcbiAgICBzdXBlciggaWNvbiwgYmFja2dyb3VuZEZpbGxQcm9wZXJ0eSwge1xyXG4gICAgICBoaWdobGlnaHRFeHRlbnNpb25XaWR0aDogNixcclxuICAgICAgaGlnaGxpZ2h0RXh0ZW5zaW9uSGVpZ2h0OiA1LFxyXG4gICAgICBoaWdobGlnaHRDZW50ZXJPZmZzZXRZOiA0LFxyXG4gICAgICBsaXN0ZW5lcjogKCkgPT4ge1xyXG4gICAgICAgIHBoZXRNZW51LnNob3coKTtcclxuICAgICAgICBwaGV0TWVudS5pdGVtc1sgMCBdLmZvY3VzKCk7XHJcbiAgICAgICAgcHVzaEJ1dHRvblNvdW5kUGxheWVyLnBsYXkoKTtcclxuICAgICAgfSxcclxuXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLFxyXG4gICAgICBwaGV0aW9UeXBlOiBQaGV0QnV0dG9uLlBoZXRCdXR0b25JTyxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1RoZSBidXR0b24gdGhhdCBhcHBlYXJzIGF0IHRoZSByaWdodCBzaWRlIG9mIHRoZSBuYXZpZ2F0aW9uIGJhciwgd2hpY2ggc2hvd3MgYSBtZW51IHdoZW4gcHJlc3NlZCcsXHJcblxyXG4gICAgICAvLyBUaGlzIGlzIHRoZSBwcmltYXJ5IHdheSB0byBwcmV2ZW50IGxlYXJuZXJzIGZyb20gYWNjZXNzaW5nIHRoZSBQaEVUIG1lbnUgaW4gUGhFVC1pTywgc28gZmVhdHVyZSBpdC5cclxuICAgICAgZW5hYmxlZFByb3BlcnR5T3B0aW9uczoge1xyXG4gICAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlLFxyXG4gICAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdXaGVuIGRpc2FibGVkLCB0aGUgKHRocmVlIGRvdHMpIGFyZSBoaWRkZW4gYW5kIHRoZSBidXR0b24gY2Fubm90IGJlIHByZXNzZWQsIGhpZGluZyB0aGUgUGhFVCBtZW51LidcclxuICAgICAgfSxcclxuXHJcbiAgICAgIHBoZXRpb1Zpc2libGVQcm9wZXJ0eUluc3RydW1lbnRlZDogZmFsc2UsIC8vIFRoaXMgYnV0dG9uIGlzIG91ciBicmFuZGluZywgZG9uJ3QgZXZlciBoaWRlIGl0LlxyXG5cclxuICAgICAgLy8gcGRvbVxyXG4gICAgICBpbm5lckNvbnRlbnQ6IEpvaXN0U3RyaW5ncy5hMTF5LnBoZXRNZW51U3RyaW5nUHJvcGVydHksXHJcblxyXG4gICAgICAvLyB2b2ljaW5nXHJcbiAgICAgIHZvaWNpbmdOYW1lUmVzcG9uc2U6IEpvaXN0U3RyaW5ncy5hMTF5LnBoZXRNZW51U3RyaW5nUHJvcGVydHlcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBwaGV0TWVudSA9IG5ldyBQaGV0TWVudSggc2ltLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3BoZXRNZW51JyApLFxyXG4gICAgICBmb2N1c09uSGlkZU5vZGU6IHRoaXNcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBTaW0uanMgaGFuZGxlcyBzY2FsaW5nIHRoZSBwb3B1cCBtZW51LiAgVGhpcyBjb2RlIHNldHMgdGhlIHBvc2l0aW9uIG9mIHRoZSBwb3B1cCBtZW51LlxyXG4gICAgLy8gc2ltLmJvdW5kcyBhcmUgbnVsbCBvbiBpbml0LCBidXQgd2Ugd2lsbCBnZXQgdGhlIGNhbGxiYWNrIHdoZW4gaXQgaXMgc2l6ZWQgZm9yIHRoZSBmaXJzdCB0aW1lXHJcbiAgICAvLyBEb2VzIG5vdCBuZWVkIHRvIGJlIHVubGlua2VkIG9yIGRpc3Bvc2VkIGJlY2F1c2UgUGhldEJ1dHRvbiBwZXJzaXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW1cclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgc2ltLmJvdW5kc1Byb3BlcnR5LCBzaW0uc2NyZWVuQm91bmRzUHJvcGVydHksIHNpbS5zY2FsZVByb3BlcnR5LCBwaGV0TWVudS5sb2NhbEJvdW5kc1Byb3BlcnR5IF0sXHJcbiAgICAgICggYm91bmRzLCBzY3JlZW5Cb3VuZHMsIHNjYWxlICkgPT4ge1xyXG4gICAgICAgIGlmICggYm91bmRzICYmIHNjcmVlbkJvdW5kcyAmJiBzY2FsZSApIHtcclxuICAgICAgICAgIHBoZXRNZW51LnNldFNjYWxlTWFnbml0dWRlKCBzY2FsZSApO1xyXG4gICAgICAgICAgcGhldE1lbnUucmlnaHQgPSBib3VuZHMucmlnaHQgLSAyO1xyXG4gICAgICAgICAgY29uc3QgbmF2QmFySGVpZ2h0ID0gYm91bmRzLmhlaWdodCAtIHNjcmVlbkJvdW5kcy5oZWlnaHQ7XHJcbiAgICAgICAgICBwaGV0TWVudS5ib3R0b20gPSBzY3JlZW5Cb3VuZHMuYm90dG9tICsgbmF2QmFySGVpZ2h0IC8gMjtcclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuXHJcblxyXG4gICAgLy8gTm8gbmVlZCB0byB1bmxpbmssIGFzIHRoZSBQaGV0QnV0dG9uIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW1cclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgYmFja2dyb3VuZEZpbGxQcm9wZXJ0eSwgc2ltLnNlbGVjdGVkU2NyZWVuUHJvcGVydHksIHVwZGF0ZUNoZWNrLnN0YXRlUHJvcGVydHkgXSxcclxuICAgICAgKCBiYWNrZ3JvdW5kRmlsbCwgc2NyZWVuLCB1cGRhdGVTdGF0ZSApID0+IHtcclxuICAgICAgICBjb25zdCBzaG93SG9tZVNjcmVlbiA9IHNjcmVlbiA9PT0gc2ltLmhvbWVTY3JlZW47XHJcbiAgICAgICAgY29uc3QgYmFja2dyb3VuZElzV2hpdGUgPSAhYmFja2dyb3VuZEZpbGwuZXF1YWxzKCBDb2xvci5CTEFDSyApICYmICFzaG93SG9tZVNjcmVlbjtcclxuXHJcbiAgICAgICAgY29uc3Qgb3V0T2ZEYXRlID0gdXBkYXRlU3RhdGUgPT09IFVwZGF0ZVN0YXRlLk9VVF9PRl9EQVRFO1xyXG4gICAgICAgIG1lbnVJY29uLmZpbGwgPSBiYWNrZ3JvdW5kSXNXaGl0ZSA/ICggb3V0T2ZEYXRlID8gJyMwYTAnIDogJyMyMjInICkgOiAoIG91dE9mRGF0ZSA/ICcjM0YzJyA6ICd3aGl0ZScgKTtcclxuICAgICAgICBsb2dvSW1hZ2UuaW1hZ2UgPSBiYWNrZ3JvdW5kSXNXaGl0ZSA/IGxvZ29PbldoaXRlQmFja2dyb3VuZCA6IGxvZ29PbkJsYWNrQmFja2dyb3VuZDtcclxuICAgICAgfSApO1xyXG5cclxuICAgIC8vIEFkZGVkIGZvciBwaGV0LWlvLCB3aGVuIHRvZ2dsaW5nIGVuYWJsZWQsIGhpZGUgdGhlIG9wdGlvbiBkb3RzIHRvIHByZXZlbnQgdGhlIGN1ZWluZy5cclxuICAgIC8vIE5vIG5lZWQgdG8gYmUgcmVtb3ZlZCBiZWNhdXNlIHRoZSBQaGV0QnV0dG9uIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICB0aGlzLmJ1dHRvbk1vZGVsLmVuYWJsZWRQcm9wZXJ0eS5saW5rKCBlbmFibGVkID0+IHsgbWVudUljb24udmlzaWJsZSA9IGVuYWJsZWQ7IH0gKTtcclxuXHJcbiAgICAvLyBwZG9tIC0gYWRkIGFuIGF0dHJpYnV0ZSB0aGF0IGxldHMgdGhlIHVzZXIga25vdyB0aGUgYnV0dG9uIG9wZW5zIGEgbWVudVxyXG4gICAgQXJpYUhhc1BvcFVwTXV0YXRvci5tdXRhdGVOb2RlKCB0aGlzLCB0cnVlICk7XHJcbiAgfVxyXG59XHJcblxyXG5qb2lzdC5yZWdpc3RlciggJ1BoZXRCdXR0b24nLCBQaGV0QnV0dG9uICk7XHJcbmV4cG9ydCBkZWZhdWx0IFBoZXRCdXR0b247Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7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