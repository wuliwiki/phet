// Copyright 2021-2023, University of Colorado Boulder

/**
 * A manager that controls whether all audio is enabled and whether each auditory feature is enabled. Has flags that
 * indicate which auditory features are supported. Also responsible for initializing managers for sub-components
 * of the AudioManager.
 *
 * PhET uses the term "Audio" to describe the collection of all auditory features that are provided by the simulation.
 * Under "Audio" there are currently two sub-features that can be separately enabled and disabled that PhET calls
 * "Sound" and "Voicing". Illustrated below:
 *
 * "Audio" - All auditory output in the sim.
 *  - "Sound" - All sound effects and sonifications that represent the simulation.
 *    - "Extra Sound" - Additional Sounds that can be enabled separately, but may not be beneficial for all users.
 *  - "Voicing" - Spoken text that describes what is happening in the simulation.
 *
 *  Disabling Audio will mute all subcomponents. But each subcomponent can be muted separately.
 *
 * @author Jesse Greenberg
 */

import BooleanProperty from '../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../axon/js/DerivedProperty.js';
import { Display, voicingManager } from '../../scenery/js/imports.js';
import soundManager from '../../tambo/js/soundManager.js';
import PhetioObject from '../../tandem/js/PhetioObject.js';
import Tandem from '../../tandem/js/Tandem.js';
import joist from './joist.js';
const ANY_AUDIO_SUPPORTED = phet.chipper.queryParameters.supportsVoicing || phet.chipper.queryParameters.supportsSound;
class AudioManager extends PhetioObject {
  // Whether all features involving audio are enabled (including sound, extra sound, and voicing). When false,
  // everything should be totally silent.

  // Indicates when both Audio and Sound are enabled. When false, the soundManager will not produce any sound.

  // Indicates when both Audio and Voicing are enabled. When false, the voicingManager will not produce any speech.

  // Indicates when any subcomponent of audio is enabled. Note this will still be true when audio is disabled. It is
  // only for subcomponents.
  // Indicates when audio and at least one of its subcomponents are enabled. When false, there should be no auditory output.
  constructor(tandem) {
    super({
      tandem: tandem,
      phetioState: false,
      phetioDocumentation: 'Controls the simulation\'s audio features. This includes sound and voicing. For sims that ' + 'do not support these features, this element and its children can be ignored.'
    });
    this.audioEnabledProperty = new BooleanProperty(phet.chipper.queryParameters.audio === 'enabled', {
      tandem: tandem.createTandem('audioEnabledProperty'),
      phetioFeatured: true,
      phetioDocumentation: 'toggles all audio features on and off; supported only if this sim supports audio features.'
    });
    this.audioAndSoundEnabledProperty = DerivedProperty.and([this.audioEnabledProperty, soundManager.enabledProperty]);
    this.audioAndVoicingEnabledProperty = DerivedProperty.and([this.audioEnabledProperty, voicingManager.enabledProperty]);
    this.anySubcomponentEnabledProperty = new DerivedProperty([soundManager.enabledProperty, voicingManager.enabledProperty], (soundEnabled, voicingEnabled) => {
      return soundEnabled || voicingEnabled;
    });
    this.anyOutputEnabledProperty = new DerivedProperty([this.audioEnabledProperty, this.anySubcomponentEnabledProperty], (audioEnabled, anySubcomponentEnabled) => {
      return audioEnabled && anySubcomponentEnabled;
    });
  }

  /**
   * Initialize the AudioManager and subcomponents.
   */
  initialize(sim) {
    if (sim.preferencesModel.audioModel.supportsSound) {
      soundManager.initialize(sim.isConstructionCompleteProperty, this.audioEnabledProperty, sim.browserTabVisibleProperty, sim.activeProperty, sim.isSettingPhetioStateProperty);
    }
    if (sim.preferencesModel.audioModel.supportsVoicing) {
      voicingManager.initialize(Display.userGestureEmitter, {
        // specify the Properties that control whether or not output is allowed from voicingManager
        speechAllowedProperty: new DerivedProperty([sim.isConstructionCompleteProperty, sim.browserTabVisibleProperty, sim.activeProperty, sim.isSettingPhetioStateProperty, this.audioEnabledProperty], (simConstructionComplete, simVisible, simActive, simSettingPhetioState, audioEnabled) => {
          return simConstructionComplete && simVisible && simActive && !simSettingPhetioState && audioEnabled;
        })
      });
    }

    // If both sound and voicing are enabled, hook up a feature that will turn down the sound level when the speech
    // synthesizer is speaking.  This is called "ducking".
    if (sim.preferencesModel.audioModel.supportsSound && sim.preferencesModel.audioModel.supportsVoicing) {
      // state checking
      assert && assert(voicingManager.initialized, 'voicingManager must be initialized before ducking can be set up');
      assert && assert(soundManager.initialized, 'soundManager must be initialized before ducking can be set up');

      // Set up the ducking Property and hook it to the emitters that indicate when speaking is occurring in the voicing
      // manager.
      const duckSoundProperty = new BooleanProperty(false);
      voicingManager.startSpeakingEmitter.addListener(() => duckSoundProperty.set(true));
      voicingManager.endSpeakingEmitter.addListener(() => duckSoundProperty.set(false));

      // Add the ducking property to the sound manager.
      soundManager.addDuckingProperty(duckSoundProperty);
    }
  }
}
const audioManager = new AudioManager(ANY_AUDIO_SUPPORTED ? Tandem.GENERAL_VIEW.createTandem('audioManager') : Tandem.OPT_OUT);
joist.register('audioManager', audioManager);
export default audioManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJEaXNwbGF5Iiwidm9pY2luZ01hbmFnZXIiLCJzb3VuZE1hbmFnZXIiLCJQaGV0aW9PYmplY3QiLCJUYW5kZW0iLCJqb2lzdCIsIkFOWV9BVURJT19TVVBQT1JURUQiLCJwaGV0IiwiY2hpcHBlciIsInF1ZXJ5UGFyYW1ldGVycyIsInN1cHBvcnRzVm9pY2luZyIsInN1cHBvcnRzU291bmQiLCJBdWRpb01hbmFnZXIiLCJjb25zdHJ1Y3RvciIsInRhbmRlbSIsInBoZXRpb1N0YXRlIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImF1ZGlvRW5hYmxlZFByb3BlcnR5IiwiYXVkaW8iLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9GZWF0dXJlZCIsImF1ZGlvQW5kU291bmRFbmFibGVkUHJvcGVydHkiLCJhbmQiLCJlbmFibGVkUHJvcGVydHkiLCJhdWRpb0FuZFZvaWNpbmdFbmFibGVkUHJvcGVydHkiLCJhbnlTdWJjb21wb25lbnRFbmFibGVkUHJvcGVydHkiLCJzb3VuZEVuYWJsZWQiLCJ2b2ljaW5nRW5hYmxlZCIsImFueU91dHB1dEVuYWJsZWRQcm9wZXJ0eSIsImF1ZGlvRW5hYmxlZCIsImFueVN1YmNvbXBvbmVudEVuYWJsZWQiLCJpbml0aWFsaXplIiwic2ltIiwicHJlZmVyZW5jZXNNb2RlbCIsImF1ZGlvTW9kZWwiLCJpc0NvbnN0cnVjdGlvbkNvbXBsZXRlUHJvcGVydHkiLCJicm93c2VyVGFiVmlzaWJsZVByb3BlcnR5IiwiYWN0aXZlUHJvcGVydHkiLCJpc1NldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5IiwidXNlckdlc3R1cmVFbWl0dGVyIiwic3BlZWNoQWxsb3dlZFByb3BlcnR5Iiwic2ltQ29uc3RydWN0aW9uQ29tcGxldGUiLCJzaW1WaXNpYmxlIiwic2ltQWN0aXZlIiwic2ltU2V0dGluZ1BoZXRpb1N0YXRlIiwiYXNzZXJ0IiwiaW5pdGlhbGl6ZWQiLCJkdWNrU291bmRQcm9wZXJ0eSIsInN0YXJ0U3BlYWtpbmdFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJzZXQiLCJlbmRTcGVha2luZ0VtaXR0ZXIiLCJhZGREdWNraW5nUHJvcGVydHkiLCJhdWRpb01hbmFnZXIiLCJHRU5FUkFMX1ZJRVciLCJPUFRfT1VUIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJhdWRpb01hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBtYW5hZ2VyIHRoYXQgY29udHJvbHMgd2hldGhlciBhbGwgYXVkaW8gaXMgZW5hYmxlZCBhbmQgd2hldGhlciBlYWNoIGF1ZGl0b3J5IGZlYXR1cmUgaXMgZW5hYmxlZC4gSGFzIGZsYWdzIHRoYXRcclxuICogaW5kaWNhdGUgd2hpY2ggYXVkaXRvcnkgZmVhdHVyZXMgYXJlIHN1cHBvcnRlZC4gQWxzbyByZXNwb25zaWJsZSBmb3IgaW5pdGlhbGl6aW5nIG1hbmFnZXJzIGZvciBzdWItY29tcG9uZW50c1xyXG4gKiBvZiB0aGUgQXVkaW9NYW5hZ2VyLlxyXG4gKlxyXG4gKiBQaEVUIHVzZXMgdGhlIHRlcm0gXCJBdWRpb1wiIHRvIGRlc2NyaWJlIHRoZSBjb2xsZWN0aW9uIG9mIGFsbCBhdWRpdG9yeSBmZWF0dXJlcyB0aGF0IGFyZSBwcm92aWRlZCBieSB0aGUgc2ltdWxhdGlvbi5cclxuICogVW5kZXIgXCJBdWRpb1wiIHRoZXJlIGFyZSBjdXJyZW50bHkgdHdvIHN1Yi1mZWF0dXJlcyB0aGF0IGNhbiBiZSBzZXBhcmF0ZWx5IGVuYWJsZWQgYW5kIGRpc2FibGVkIHRoYXQgUGhFVCBjYWxsc1xyXG4gKiBcIlNvdW5kXCIgYW5kIFwiVm9pY2luZ1wiLiBJbGx1c3RyYXRlZCBiZWxvdzpcclxuICpcclxuICogXCJBdWRpb1wiIC0gQWxsIGF1ZGl0b3J5IG91dHB1dCBpbiB0aGUgc2ltLlxyXG4gKiAgLSBcIlNvdW5kXCIgLSBBbGwgc291bmQgZWZmZWN0cyBhbmQgc29uaWZpY2F0aW9ucyB0aGF0IHJlcHJlc2VudCB0aGUgc2ltdWxhdGlvbi5cclxuICogICAgLSBcIkV4dHJhIFNvdW5kXCIgLSBBZGRpdGlvbmFsIFNvdW5kcyB0aGF0IGNhbiBiZSBlbmFibGVkIHNlcGFyYXRlbHksIGJ1dCBtYXkgbm90IGJlIGJlbmVmaWNpYWwgZm9yIGFsbCB1c2Vycy5cclxuICogIC0gXCJWb2ljaW5nXCIgLSBTcG9rZW4gdGV4dCB0aGF0IGRlc2NyaWJlcyB3aGF0IGlzIGhhcHBlbmluZyBpbiB0aGUgc2ltdWxhdGlvbi5cclxuICpcclxuICogIERpc2FibGluZyBBdWRpbyB3aWxsIG11dGUgYWxsIHN1YmNvbXBvbmVudHMuIEJ1dCBlYWNoIHN1YmNvbXBvbmVudCBjYW4gYmUgbXV0ZWQgc2VwYXJhdGVseS5cclxuICpcclxuICogQGF1dGhvciBKZXNzZSBHcmVlbmJlcmdcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCB7IERpc3BsYXksIHZvaWNpbmdNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHNvdW5kTWFuYWdlciBmcm9tICcuLi8uLi90YW1iby9qcy9zb3VuZE1hbmFnZXIuanMnO1xyXG5pbXBvcnQgUGhldGlvT2JqZWN0IGZyb20gJy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgam9pc3QgZnJvbSAnLi9qb2lzdC5qcyc7XHJcbmltcG9ydCBTaW0gZnJvbSAnLi9TaW0uanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcblxyXG5jb25zdCBBTllfQVVESU9fU1VQUE9SVEVEID0gcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5zdXBwb3J0c1ZvaWNpbmcgfHwgcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5zdXBwb3J0c1NvdW5kO1xyXG5cclxuY2xhc3MgQXVkaW9NYW5hZ2VyIGV4dGVuZHMgUGhldGlvT2JqZWN0IHtcclxuXHJcbiAgLy8gV2hldGhlciBhbGwgZmVhdHVyZXMgaW52b2x2aW5nIGF1ZGlvIGFyZSBlbmFibGVkIChpbmNsdWRpbmcgc291bmQsIGV4dHJhIHNvdW5kLCBhbmQgdm9pY2luZykuIFdoZW4gZmFsc2UsXHJcbiAgLy8gZXZlcnl0aGluZyBzaG91bGQgYmUgdG90YWxseSBzaWxlbnQuXHJcbiAgcHVibGljIHJlYWRvbmx5IGF1ZGlvRW5hYmxlZFByb3BlcnR5OiBCb29sZWFuUHJvcGVydHk7XHJcblxyXG4gIC8vIEluZGljYXRlcyB3aGVuIGJvdGggQXVkaW8gYW5kIFNvdW5kIGFyZSBlbmFibGVkLiBXaGVuIGZhbHNlLCB0aGUgc291bmRNYW5hZ2VyIHdpbGwgbm90IHByb2R1Y2UgYW55IHNvdW5kLlxyXG4gIHB1YmxpYyByZWFkb25seSBhdWRpb0FuZFNvdW5kRW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gSW5kaWNhdGVzIHdoZW4gYm90aCBBdWRpbyBhbmQgVm9pY2luZyBhcmUgZW5hYmxlZC4gV2hlbiBmYWxzZSwgdGhlIHZvaWNpbmdNYW5hZ2VyIHdpbGwgbm90IHByb2R1Y2UgYW55IHNwZWVjaC5cclxuICBwdWJsaWMgcmVhZG9ubHkgYXVkaW9BbmRWb2ljaW5nRW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gSW5kaWNhdGVzIHdoZW4gYW55IHN1YmNvbXBvbmVudCBvZiBhdWRpbyBpcyBlbmFibGVkLiBOb3RlIHRoaXMgd2lsbCBzdGlsbCBiZSB0cnVlIHdoZW4gYXVkaW8gaXMgZGlzYWJsZWQuIEl0IGlzXHJcbiAgLy8gb25seSBmb3Igc3ViY29tcG9uZW50cy5cclxuICBwdWJsaWMgcmVhZG9ubHkgYW55U3ViY29tcG9uZW50RW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gSW5kaWNhdGVzIHdoZW4gYXVkaW8gYW5kIGF0IGxlYXN0IG9uZSBvZiBpdHMgc3ViY29tcG9uZW50cyBhcmUgZW5hYmxlZC4gV2hlbiBmYWxzZSwgdGhlcmUgc2hvdWxkIGJlIG5vIGF1ZGl0b3J5IG91dHB1dC5cclxuICBwdWJsaWMgcmVhZG9ubHkgYW55T3V0cHV0RW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbSxcclxuICAgICAgcGhldGlvU3RhdGU6IGZhbHNlLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnQ29udHJvbHMgdGhlIHNpbXVsYXRpb25cXCdzIGF1ZGlvIGZlYXR1cmVzLiBUaGlzIGluY2x1ZGVzIHNvdW5kIGFuZCB2b2ljaW5nLiBGb3Igc2ltcyB0aGF0ICcgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAnZG8gbm90IHN1cHBvcnQgdGhlc2UgZmVhdHVyZXMsIHRoaXMgZWxlbWVudCBhbmQgaXRzIGNoaWxkcmVuIGNhbiBiZSBpZ25vcmVkLidcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmF1ZGlvRW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5hdWRpbyA9PT0gJ2VuYWJsZWQnLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2F1ZGlvRW5hYmxlZFByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9GZWF0dXJlZDogdHJ1ZSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ3RvZ2dsZXMgYWxsIGF1ZGlvIGZlYXR1cmVzIG9uIGFuZCBvZmY7IHN1cHBvcnRlZCBvbmx5IGlmIHRoaXMgc2ltIHN1cHBvcnRzIGF1ZGlvIGZlYXR1cmVzLidcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmF1ZGlvQW5kU291bmRFbmFibGVkUHJvcGVydHkgPSBEZXJpdmVkUHJvcGVydHkuYW5kKCBbIHRoaXMuYXVkaW9FbmFibGVkUHJvcGVydHksIHNvdW5kTWFuYWdlci5lbmFibGVkUHJvcGVydHkgXSApO1xyXG4gICAgdGhpcy5hdWRpb0FuZFZvaWNpbmdFbmFibGVkUHJvcGVydHkgPSBEZXJpdmVkUHJvcGVydHkuYW5kKCBbIHRoaXMuYXVkaW9FbmFibGVkUHJvcGVydHksIHZvaWNpbmdNYW5hZ2VyLmVuYWJsZWRQcm9wZXJ0eSBdICk7XHJcblxyXG4gICAgdGhpcy5hbnlTdWJjb21wb25lbnRFbmFibGVkUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICBbIHNvdW5kTWFuYWdlci5lbmFibGVkUHJvcGVydHksIHZvaWNpbmdNYW5hZ2VyLmVuYWJsZWRQcm9wZXJ0eSBdLFxyXG4gICAgICAoIHNvdW5kRW5hYmxlZCwgdm9pY2luZ0VuYWJsZWQgKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNvdW5kRW5hYmxlZCB8fCB2b2ljaW5nRW5hYmxlZDtcclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLmFueU91dHB1dEVuYWJsZWRQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgdGhpcy5hdWRpb0VuYWJsZWRQcm9wZXJ0eSwgdGhpcy5hbnlTdWJjb21wb25lbnRFbmFibGVkUHJvcGVydHkgXSxcclxuICAgICAgKCBhdWRpb0VuYWJsZWQsIGFueVN1YmNvbXBvbmVudEVuYWJsZWQgKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGF1ZGlvRW5hYmxlZCAmJiBhbnlTdWJjb21wb25lbnRFbmFibGVkO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZSB0aGUgQXVkaW9NYW5hZ2VyIGFuZCBzdWJjb21wb25lbnRzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0aWFsaXplKCBzaW06IFNpbSApOiB2b2lkIHtcclxuXHJcbiAgICBpZiAoIHNpbS5wcmVmZXJlbmNlc01vZGVsLmF1ZGlvTW9kZWwuc3VwcG9ydHNTb3VuZCApIHtcclxuICAgICAgc291bmRNYW5hZ2VyLmluaXRpYWxpemUoXHJcbiAgICAgICAgc2ltLmlzQ29uc3RydWN0aW9uQ29tcGxldGVQcm9wZXJ0eSxcclxuICAgICAgICB0aGlzLmF1ZGlvRW5hYmxlZFByb3BlcnR5LFxyXG4gICAgICAgIHNpbS5icm93c2VyVGFiVmlzaWJsZVByb3BlcnR5LFxyXG4gICAgICAgIHNpbS5hY3RpdmVQcm9wZXJ0eSxcclxuICAgICAgICBzaW0uaXNTZXR0aW5nUGhldGlvU3RhdGVQcm9wZXJ0eVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICggc2ltLnByZWZlcmVuY2VzTW9kZWwuYXVkaW9Nb2RlbC5zdXBwb3J0c1ZvaWNpbmcgKSB7XHJcbiAgICAgIHZvaWNpbmdNYW5hZ2VyLmluaXRpYWxpemUoIERpc3BsYXkudXNlckdlc3R1cmVFbWl0dGVyLCB7XHJcblxyXG4gICAgICAgIC8vIHNwZWNpZnkgdGhlIFByb3BlcnRpZXMgdGhhdCBjb250cm9sIHdoZXRoZXIgb3Igbm90IG91dHB1dCBpcyBhbGxvd2VkIGZyb20gdm9pY2luZ01hbmFnZXJcclxuICAgICAgICBzcGVlY2hBbGxvd2VkUHJvcGVydHk6IG5ldyBEZXJpdmVkUHJvcGVydHkoIFtcclxuICAgICAgICAgIHNpbS5pc0NvbnN0cnVjdGlvbkNvbXBsZXRlUHJvcGVydHksXHJcbiAgICAgICAgICBzaW0uYnJvd3NlclRhYlZpc2libGVQcm9wZXJ0eSxcclxuICAgICAgICAgIHNpbS5hY3RpdmVQcm9wZXJ0eSxcclxuICAgICAgICAgIHNpbS5pc1NldHRpbmdQaGV0aW9TdGF0ZVByb3BlcnR5LFxyXG4gICAgICAgICAgdGhpcy5hdWRpb0VuYWJsZWRQcm9wZXJ0eVxyXG4gICAgICAgIF0sICggc2ltQ29uc3RydWN0aW9uQ29tcGxldGUsIHNpbVZpc2libGUsIHNpbUFjdGl2ZSwgc2ltU2V0dGluZ1BoZXRpb1N0YXRlLCBhdWRpb0VuYWJsZWQgKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gc2ltQ29uc3RydWN0aW9uQ29tcGxldGUgJiYgc2ltVmlzaWJsZSAmJiBzaW1BY3RpdmUgJiYgIXNpbVNldHRpbmdQaGV0aW9TdGF0ZSAmJiBhdWRpb0VuYWJsZWQ7XHJcbiAgICAgICAgfSApXHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBJZiBib3RoIHNvdW5kIGFuZCB2b2ljaW5nIGFyZSBlbmFibGVkLCBob29rIHVwIGEgZmVhdHVyZSB0aGF0IHdpbGwgdHVybiBkb3duIHRoZSBzb3VuZCBsZXZlbCB3aGVuIHRoZSBzcGVlY2hcclxuICAgIC8vIHN5bnRoZXNpemVyIGlzIHNwZWFraW5nLiAgVGhpcyBpcyBjYWxsZWQgXCJkdWNraW5nXCIuXHJcbiAgICBpZiAoIHNpbS5wcmVmZXJlbmNlc01vZGVsLmF1ZGlvTW9kZWwuc3VwcG9ydHNTb3VuZCAmJiBzaW0ucHJlZmVyZW5jZXNNb2RlbC5hdWRpb01vZGVsLnN1cHBvcnRzVm9pY2luZyApIHtcclxuXHJcbiAgICAgIC8vIHN0YXRlIGNoZWNraW5nXHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHZvaWNpbmdNYW5hZ2VyLmluaXRpYWxpemVkLCAndm9pY2luZ01hbmFnZXIgbXVzdCBiZSBpbml0aWFsaXplZCBiZWZvcmUgZHVja2luZyBjYW4gYmUgc2V0IHVwJyApO1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBzb3VuZE1hbmFnZXIuaW5pdGlhbGl6ZWQsICdzb3VuZE1hbmFnZXIgbXVzdCBiZSBpbml0aWFsaXplZCBiZWZvcmUgZHVja2luZyBjYW4gYmUgc2V0IHVwJyApO1xyXG5cclxuICAgICAgLy8gU2V0IHVwIHRoZSBkdWNraW5nIFByb3BlcnR5IGFuZCBob29rIGl0IHRvIHRoZSBlbWl0dGVycyB0aGF0IGluZGljYXRlIHdoZW4gc3BlYWtpbmcgaXMgb2NjdXJyaW5nIGluIHRoZSB2b2ljaW5nXHJcbiAgICAgIC8vIG1hbmFnZXIuXHJcbiAgICAgIGNvbnN0IGR1Y2tTb3VuZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuICAgICAgdm9pY2luZ01hbmFnZXIuc3RhcnRTcGVha2luZ0VtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IGR1Y2tTb3VuZFByb3BlcnR5LnNldCggdHJ1ZSApICk7XHJcbiAgICAgIHZvaWNpbmdNYW5hZ2VyLmVuZFNwZWFraW5nRW1pdHRlci5hZGRMaXN0ZW5lciggKCkgPT4gZHVja1NvdW5kUHJvcGVydHkuc2V0KCBmYWxzZSApICk7XHJcblxyXG4gICAgICAvLyBBZGQgdGhlIGR1Y2tpbmcgcHJvcGVydHkgdG8gdGhlIHNvdW5kIG1hbmFnZXIuXHJcbiAgICAgIHNvdW5kTWFuYWdlci5hZGREdWNraW5nUHJvcGVydHkoIGR1Y2tTb3VuZFByb3BlcnR5ICk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBhdWRpb01hbmFnZXIgPSBuZXcgQXVkaW9NYW5hZ2VyKCBBTllfQVVESU9fU1VQUE9SVEVEID8gVGFuZGVtLkdFTkVSQUxfVklFVy5jcmVhdGVUYW5kZW0oICdhdWRpb01hbmFnZXInICkgOiBUYW5kZW0uT1BUX09VVCApO1xyXG5cclxuam9pc3QucmVnaXN0ZXIoICdhdWRpb01hbmFnZXInLCBhdWRpb01hbmFnZXIgKTtcclxuZXhwb3J0IGRlZmF1bHQgYXVkaW9NYW5hZ2VyOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFD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