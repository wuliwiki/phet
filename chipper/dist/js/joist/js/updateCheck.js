// Copyright 2015-2022, University of Colorado Boulder

/**
 * A singleton type/object for handling checking whether our simulation is up-to-date, or whether there is an
 * updated version. See https://github.com/phetsims/joist/issues/189
 *
 * It exposes its current state (for UIs to hook into), and a check() function used to start checking the version.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import EnumerationProperty from '../../axon/js/EnumerationProperty.js';
import joist from './joist.js';
import packageJSON from './packageJSON.js'; // parse name/version out of the package.json
import UpdateState from './UpdateState.js';
const SimVersion = phet.preloads.chipper.SimVersion; // use preload from chipper (auto-copied from perennial)

// constants
const simName = packageJSON.name;
const simVersion = SimVersion.parse(packageJSON.version, phet.chipper.buildTimestamp);
const requestProtocolString = document.location.protocol === 'https:' ? 'https:' : 'http:';
const TIMEOUT_MILLISECONDS = 15000; // How many ms before we time out (set to 'offline')

class UpdateCheck {
  // {SimVersion|null} will be filled in by check() if applicable
  // (joist-internal) {SimVersion} version of the sim that is running

  // Whether we actually allow checking for updates, or showing any update-related UIs.
  // The URL to be used for "New version available" clicks
  // Valid only if `state === UpdateState.CHECKING`, the timeout ID of our timeout listener

  constructor() {
    this.stateProperty = new EnumerationProperty(UpdateState.UNCHECKED);
    this.latestVersion = null;
    this.ourVersion = simVersion;
    this.timeoutCallback = this.timeout.bind(this);

    // If it's not PhET-branded OR if it is phet-io or in the phet-app, do not check for updates
    this.areUpdatesChecked = phet.chipper.brand === 'phet' && !phet.chipper.isApp;
    this.updateURL = `${'http://phet.colorado.edu/html-sim-update' + '?simulation='}${encodeURIComponent(simName)}&version=${encodeURIComponent(simVersion.toString())}&buildTimestamp=${encodeURIComponent(`${phet.chipper.buildTimestamp}`)}`;
    this.timeoutId = -1;
  }

  // Clears our timeout listener.
  clearTimeout() {
    window.clearTimeout(this.timeoutId);
  }

  //Sets our timeout listener.
  setTimeout() {
    // eslint-disable-line bad-sim-text
    this.timeoutId = window.setTimeout(this.timeoutCallback, TIMEOUT_MILLISECONDS); // eslint-disable-line bad-sim-text
  }

  // If we are checking, it resets our timeout timer to TIMEOUT_MILLISECONDS
  resetTimeout() {
    if (this.stateProperty.value === UpdateState.CHECKING) {
      this.clearTimeout();
      this.setTimeout();
    }
  }

  // What happens when we actually time out.
  timeout() {
    this.stateProperty.value = UpdateState.OFFLINE;
  }

  /**
   * Kicks off the version checking request (if able), resulting in state changes.
   */
  check() {
    if (!this.areUpdatesChecked || this.stateProperty.value !== UpdateState.UNCHECKED && this.stateProperty.value !== UpdateState.OFFLINE) {
      return;
    }

    // If our sim's version indicates it hasn't been published, don't attempt to send a request for now
    if (this.ourVersion.isSimNotPublished) {
      this.stateProperty.value = UpdateState.UP_TO_DATE;
      return;
    }
    const req = new XMLHttpRequest();
    if ('withCredentials' in req) {
      // we'll be able to send the proper type of request, so we mark ourself as checking
      this.stateProperty.value = UpdateState.CHECKING;
      this.setTimeout();
      req.onload = () => {
        this.clearTimeout();
        try {
          const data = JSON.parse(req.responseText);
          if (data.error) {
            console.log(`Update check failure: ${data.error}`);
            this.stateProperty.value = UpdateState.OFFLINE;
          } else {
            if (this.updateURL) {
              this.updateURL = data.updateURL;
            }
            this.latestVersion = SimVersion.parse(data.latestVersion, data.buildTimestamp);

            // these `state` strings come from the website service, and should be kept in sync with
            // website\src\java\edu\colorado\phet\website\services\CheckHTMLUpdates.java
            if (data.state === 'out-of-date') {
              this.stateProperty.value = UpdateState.OUT_OF_DATE;
            } else if (data.state === 'up-to-date') {
              this.stateProperty.value = UpdateState.UP_TO_DATE;
            } else {
              console.log(`Failed to get proper state: ${data.state}`);
              this.stateProperty.value = UpdateState.OFFLINE;
            }
          }
        } catch (e) {
          this.stateProperty.value = UpdateState.OFFLINE;
        }
      };
      req.onerror = () => {
        this.clearTimeout();
        this.stateProperty.value = UpdateState.OFFLINE;
      };
      req.open('post', `${requestProtocolString}//phet.colorado.edu/services/check-html-updates`, true); // enable CORS
      req.send(JSON.stringify({
        api: '1.0',
        simulation: simName,
        locale: phet.joist.sim.locale,
        currentVersion: this.ourVersion.toString(),
        buildTimestamp: phet.chipper.buildTimestamp
      }));
    }
  }
}
const updateCheck = new UpdateCheck();
joist.register('updateCheck', updateCheck);
export default updateCheck;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbnVtZXJhdGlvblByb3BlcnR5Iiwiam9pc3QiLCJwYWNrYWdlSlNPTiIsIlVwZGF0ZVN0YXRlIiwiU2ltVmVyc2lvbiIsInBoZXQiLCJwcmVsb2FkcyIsImNoaXBwZXIiLCJzaW1OYW1lIiwibmFtZSIsInNpbVZlcnNpb24iLCJwYXJzZSIsInZlcnNpb24iLCJidWlsZFRpbWVzdGFtcCIsInJlcXVlc3RQcm90b2NvbFN0cmluZyIsImRvY3VtZW50IiwibG9jYXRpb24iLCJwcm90b2NvbCIsIlRJTUVPVVRfTUlMTElTRUNPTkRTIiwiVXBkYXRlQ2hlY2siLCJjb25zdHJ1Y3RvciIsInN0YXRlUHJvcGVydHkiLCJVTkNIRUNLRUQiLCJsYXRlc3RWZXJzaW9uIiwib3VyVmVyc2lvbiIsInRpbWVvdXRDYWxsYmFjayIsInRpbWVvdXQiLCJiaW5kIiwiYXJlVXBkYXRlc0NoZWNrZWQiLCJicmFuZCIsImlzQXBwIiwidXBkYXRlVVJMIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwidG9TdHJpbmciLCJ0aW1lb3V0SWQiLCJjbGVhclRpbWVvdXQiLCJ3aW5kb3ciLCJzZXRUaW1lb3V0IiwicmVzZXRUaW1lb3V0IiwidmFsdWUiLCJDSEVDS0lORyIsIk9GRkxJTkUiLCJjaGVjayIsImlzU2ltTm90UHVibGlzaGVkIiwiVVBfVE9fREFURSIsInJlcSIsIlhNTEh0dHBSZXF1ZXN0Iiwib25sb2FkIiwiZGF0YSIsIkpTT04iLCJyZXNwb25zZVRleHQiLCJlcnJvciIsImNvbnNvbGUiLCJsb2ciLCJzdGF0ZSIsIk9VVF9PRl9EQVRFIiwiZSIsIm9uZXJyb3IiLCJvcGVuIiwic2VuZCIsInN0cmluZ2lmeSIsImFwaSIsInNpbXVsYXRpb24iLCJsb2NhbGUiLCJzaW0iLCJjdXJyZW50VmVyc2lvbiIsInVwZGF0ZUNoZWNrIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJ1cGRhdGVDaGVjay50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHNpbmdsZXRvbiB0eXBlL29iamVjdCBmb3IgaGFuZGxpbmcgY2hlY2tpbmcgd2hldGhlciBvdXIgc2ltdWxhdGlvbiBpcyB1cC10by1kYXRlLCBvciB3aGV0aGVyIHRoZXJlIGlzIGFuXHJcbiAqIHVwZGF0ZWQgdmVyc2lvbi4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9qb2lzdC9pc3N1ZXMvMTg5XHJcbiAqXHJcbiAqIEl0IGV4cG9zZXMgaXRzIGN1cnJlbnQgc3RhdGUgKGZvciBVSXMgdG8gaG9vayBpbnRvKSwgYW5kIGEgY2hlY2soKSBmdW5jdGlvbiB1c2VkIHRvIHN0YXJ0IGNoZWNraW5nIHRoZSB2ZXJzaW9uLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IEVudW1lcmF0aW9uUHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9FbnVtZXJhdGlvblByb3BlcnR5LmpzJztcclxuaW1wb3J0IGpvaXN0IGZyb20gJy4vam9pc3QuanMnO1xyXG5pbXBvcnQgcGFja2FnZUpTT04gZnJvbSAnLi9wYWNrYWdlSlNPTi5qcyc7IC8vIHBhcnNlIG5hbWUvdmVyc2lvbiBvdXQgb2YgdGhlIHBhY2thZ2UuanNvblxyXG5pbXBvcnQgVXBkYXRlU3RhdGUgZnJvbSAnLi9VcGRhdGVTdGF0ZS5qcyc7XHJcblxyXG5jb25zdCBTaW1WZXJzaW9uID0gcGhldC5wcmVsb2Fkcy5jaGlwcGVyLlNpbVZlcnNpb247IC8vIHVzZSBwcmVsb2FkIGZyb20gY2hpcHBlciAoYXV0by1jb3BpZWQgZnJvbSBwZXJlbm5pYWwpXHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3Qgc2ltTmFtZSA9IHBhY2thZ2VKU09OLm5hbWU7XHJcbmNvbnN0IHNpbVZlcnNpb24gPSBTaW1WZXJzaW9uLnBhcnNlKCBwYWNrYWdlSlNPTi52ZXJzaW9uLCBwaGV0LmNoaXBwZXIuYnVpbGRUaW1lc3RhbXAgKTtcclxuY29uc3QgcmVxdWVzdFByb3RvY29sU3RyaW5nID0gKCBkb2N1bWVudC5sb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyAnaHR0cHM6JyA6ICdodHRwOicgKTtcclxuY29uc3QgVElNRU9VVF9NSUxMSVNFQ09ORFMgPSAxNTAwMDsgLy8gSG93IG1hbnkgbXMgYmVmb3JlIHdlIHRpbWUgb3V0IChzZXQgdG8gJ29mZmxpbmUnKVxyXG5cclxudHlwZSBUU2ltVmVyc2lvbiA9IHN0cmluZyAmIHtcclxuICBpc1NpbU5vdFB1Ymxpc2hlZDogYm9vbGVhbjtcclxufTtcclxuXHJcbmNsYXNzIFVwZGF0ZUNoZWNrIHtcclxuICBwdWJsaWMgcmVhZG9ubHkgc3RhdGVQcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxVcGRhdGVTdGF0ZT47XHJcbiAgcHVibGljIGxhdGVzdFZlcnNpb246IFRTaW1WZXJzaW9uIHwgbnVsbDsgLy8ge1NpbVZlcnNpb258bnVsbH0gd2lsbCBiZSBmaWxsZWQgaW4gYnkgY2hlY2soKSBpZiBhcHBsaWNhYmxlXHJcbiAgcHVibGljIHJlYWRvbmx5IG91clZlcnNpb246IFRTaW1WZXJzaW9uOyAvLyAoam9pc3QtaW50ZXJuYWwpIHtTaW1WZXJzaW9ufSB2ZXJzaW9uIG9mIHRoZSBzaW0gdGhhdCBpcyBydW5uaW5nXHJcbiAgcHJpdmF0ZSByZWFkb25seSB0aW1lb3V0Q2FsbGJhY2s6ICgpID0+IHZvaWQ7XHJcbiAgcHVibGljIHJlYWRvbmx5IGFyZVVwZGF0ZXNDaGVja2VkOiBib29sZWFuOyAvLyBXaGV0aGVyIHdlIGFjdHVhbGx5IGFsbG93IGNoZWNraW5nIGZvciB1cGRhdGVzLCBvciBzaG93aW5nIGFueSB1cGRhdGUtcmVsYXRlZCBVSXMuXHJcbiAgcHVibGljIHVwZGF0ZVVSTDogc3RyaW5nOyAvLyBUaGUgVVJMIHRvIGJlIHVzZWQgZm9yIFwiTmV3IHZlcnNpb24gYXZhaWxhYmxlXCIgY2xpY2tzXHJcbiAgcHJpdmF0ZSB0aW1lb3V0SWQ6IG51bWJlcjsgLy8gVmFsaWQgb25seSBpZiBgc3RhdGUgPT09IFVwZGF0ZVN0YXRlLkNIRUNLSU5HYCwgdGhlIHRpbWVvdXQgSUQgb2Ygb3VyIHRpbWVvdXQgbGlzdGVuZXJcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG5cclxuICAgIHRoaXMuc3RhdGVQcm9wZXJ0eSA9IG5ldyBFbnVtZXJhdGlvblByb3BlcnR5KCBVcGRhdGVTdGF0ZS5VTkNIRUNLRUQgKTtcclxuICAgIHRoaXMubGF0ZXN0VmVyc2lvbiA9IG51bGw7XHJcbiAgICB0aGlzLm91clZlcnNpb24gPSBzaW1WZXJzaW9uO1xyXG4gICAgdGhpcy50aW1lb3V0Q2FsbGJhY2sgPSB0aGlzLnRpbWVvdXQuYmluZCggdGhpcyApO1xyXG5cclxuICAgIC8vIElmIGl0J3Mgbm90IFBoRVQtYnJhbmRlZCBPUiBpZiBpdCBpcyBwaGV0LWlvIG9yIGluIHRoZSBwaGV0LWFwcCwgZG8gbm90IGNoZWNrIGZvciB1cGRhdGVzXHJcbiAgICB0aGlzLmFyZVVwZGF0ZXNDaGVja2VkID0gcGhldC5jaGlwcGVyLmJyYW5kID09PSAncGhldCcgJiYgIXBoZXQuY2hpcHBlci5pc0FwcDtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZVVSTCA9IGAkeydodHRwOi8vcGhldC5jb2xvcmFkby5lZHUvaHRtbC1zaW0tdXBkYXRlJyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICc/c2ltdWxhdGlvbj0nfSR7ZW5jb2RlVVJJQ29tcG9uZW50KCBzaW1OYW1lIClcclxuICAgIH0mdmVyc2lvbj0ke2VuY29kZVVSSUNvbXBvbmVudCggc2ltVmVyc2lvbi50b1N0cmluZygpIClcclxuICAgIH0mYnVpbGRUaW1lc3RhbXA9JHtlbmNvZGVVUklDb21wb25lbnQoIGAke3BoZXQuY2hpcHBlci5idWlsZFRpbWVzdGFtcH1gICl9YDtcclxuXHJcbiAgICB0aGlzLnRpbWVvdXRJZCA9IC0xO1xyXG4gIH1cclxuXHJcbiAgLy8gQ2xlYXJzIG91ciB0aW1lb3V0IGxpc3RlbmVyLlxyXG4gIHByaXZhdGUgY2xlYXJUaW1lb3V0KCk6IHZvaWQge1xyXG4gICAgd2luZG93LmNsZWFyVGltZW91dCggdGhpcy50aW1lb3V0SWQgKTtcclxuICB9XHJcblxyXG4gIC8vU2V0cyBvdXIgdGltZW91dCBsaXN0ZW5lci5cclxuICBwcml2YXRlIHNldFRpbWVvdXQoKTogdm9pZCB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgYmFkLXNpbS10ZXh0XHJcbiAgICB0aGlzLnRpbWVvdXRJZCA9IHdpbmRvdy5zZXRUaW1lb3V0KCB0aGlzLnRpbWVvdXRDYWxsYmFjaywgVElNRU9VVF9NSUxMSVNFQ09ORFMgKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBiYWQtc2ltLXRleHRcclxuICB9XHJcblxyXG4gIC8vIElmIHdlIGFyZSBjaGVja2luZywgaXQgcmVzZXRzIG91ciB0aW1lb3V0IHRpbWVyIHRvIFRJTUVPVVRfTUlMTElTRUNPTkRTXHJcbiAgcHVibGljIHJlc2V0VGltZW91dCgpOiB2b2lkIHtcclxuICAgIGlmICggdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID09PSBVcGRhdGVTdGF0ZS5DSEVDS0lORyApIHtcclxuICAgICAgdGhpcy5jbGVhclRpbWVvdXQoKTtcclxuICAgICAgdGhpcy5zZXRUaW1lb3V0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBXaGF0IGhhcHBlbnMgd2hlbiB3ZSBhY3R1YWxseSB0aW1lIG91dC5cclxuICBwcml2YXRlIHRpbWVvdXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5PRkZMSU5FO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogS2lja3Mgb2ZmIHRoZSB2ZXJzaW9uIGNoZWNraW5nIHJlcXVlc3QgKGlmIGFibGUpLCByZXN1bHRpbmcgaW4gc3RhdGUgY2hhbmdlcy5cclxuICAgKi9cclxuICBwdWJsaWMgY2hlY2soKTogdm9pZCB7XHJcbiAgICBpZiAoICF0aGlzLmFyZVVwZGF0ZXNDaGVja2VkIHx8ICggdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlICE9PSBVcGRhdGVTdGF0ZS5VTkNIRUNLRUQgJiYgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlICE9PSBVcGRhdGVTdGF0ZS5PRkZMSU5FICkgKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBJZiBvdXIgc2ltJ3MgdmVyc2lvbiBpbmRpY2F0ZXMgaXQgaGFzbid0IGJlZW4gcHVibGlzaGVkLCBkb24ndCBhdHRlbXB0IHRvIHNlbmQgYSByZXF1ZXN0IGZvciBub3dcclxuICAgIGlmICggdGhpcy5vdXJWZXJzaW9uLmlzU2ltTm90UHVibGlzaGVkICkge1xyXG4gICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5VUF9UT19EQVRFO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcblxyXG4gICAgaWYgKCAnd2l0aENyZWRlbnRpYWxzJyBpbiByZXEgKSB7XHJcblxyXG4gICAgICAvLyB3ZSdsbCBiZSBhYmxlIHRvIHNlbmQgdGhlIHByb3BlciB0eXBlIG9mIHJlcXVlc3QsIHNvIHdlIG1hcmsgb3Vyc2VsZiBhcyBjaGVja2luZ1xyXG4gICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5DSEVDS0lORztcclxuXHJcbiAgICAgIHRoaXMuc2V0VGltZW91dCgpO1xyXG5cclxuICAgICAgcmVxLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoIHJlcS5yZXNwb25zZVRleHQgKTtcclxuXHJcbiAgICAgICAgICBpZiAoIGRhdGEuZXJyb3IgKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCBgVXBkYXRlIGNoZWNrIGZhaWx1cmU6ICR7ZGF0YS5lcnJvcn1gICk7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFVwZGF0ZVN0YXRlLk9GRkxJTkU7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCB0aGlzLnVwZGF0ZVVSTCApIHtcclxuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVVSTCA9IGRhdGEudXBkYXRlVVJMO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMubGF0ZXN0VmVyc2lvbiA9IFNpbVZlcnNpb24ucGFyc2UoIGRhdGEubGF0ZXN0VmVyc2lvbiwgZGF0YS5idWlsZFRpbWVzdGFtcCApO1xyXG5cclxuICAgICAgICAgICAgLy8gdGhlc2UgYHN0YXRlYCBzdHJpbmdzIGNvbWUgZnJvbSB0aGUgd2Vic2l0ZSBzZXJ2aWNlLCBhbmQgc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoXHJcbiAgICAgICAgICAgIC8vIHdlYnNpdGVcXHNyY1xcamF2YVxcZWR1XFxjb2xvcmFkb1xccGhldFxcd2Vic2l0ZVxcc2VydmljZXNcXENoZWNrSFRNTFVwZGF0ZXMuamF2YVxyXG4gICAgICAgICAgICBpZiAoIGRhdGEuc3RhdGUgPT09ICdvdXQtb2YtZGF0ZScgKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuT1VUX09GX0RBVEU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoIGRhdGEuc3RhdGUgPT09ICd1cC10by1kYXRlJyApIHtcclxuICAgICAgICAgICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5VUF9UT19EQVRFO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCBgRmFpbGVkIHRvIGdldCBwcm9wZXIgc3RhdGU6ICR7ZGF0YS5zdGF0ZX1gICk7XHJcbiAgICAgICAgICAgICAgdGhpcy5zdGF0ZVByb3BlcnR5LnZhbHVlID0gVXBkYXRlU3RhdGUuT0ZGTElORTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCggZSApIHtcclxuICAgICAgICAgIHRoaXMuc3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFVwZGF0ZVN0YXRlLk9GRkxJTkU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICByZXEub25lcnJvciA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXRlUHJvcGVydHkudmFsdWUgPSBVcGRhdGVTdGF0ZS5PRkZMSU5FO1xyXG4gICAgICB9O1xyXG4gICAgICByZXEub3BlbiggJ3Bvc3QnLCBgJHtyZXF1ZXN0UHJvdG9jb2xTdHJpbmd9Ly9waGV0LmNvbG9yYWRvLmVkdS9zZXJ2aWNlcy9jaGVjay1odG1sLXVwZGF0ZXNgLCB0cnVlICk7IC8vIGVuYWJsZSBDT1JTXHJcbiAgICAgIHJlcS5zZW5kKCBKU09OLnN0cmluZ2lmeSgge1xyXG4gICAgICAgIGFwaTogJzEuMCcsXHJcbiAgICAgICAgc2ltdWxhdGlvbjogc2ltTmFtZSxcclxuICAgICAgICBsb2NhbGU6IHBoZXQuam9pc3Quc2ltLmxvY2FsZSxcclxuICAgICAgICBjdXJyZW50VmVyc2lvbjogdGhpcy5vdXJWZXJzaW9uLnRvU3RyaW5nKCksXHJcbiAgICAgICAgYnVpbGRUaW1lc3RhbXA6IHBoZXQuY2hpcHBlci5idWlsZFRpbWVzdGFtcFxyXG4gICAgICB9ICkgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IHVwZGF0ZUNoZWNrID0gbmV3IFVwZGF0ZUNoZWNrKCk7XHJcbmpvaXN0LnJlZ2lzdGVyKCAndXBkYXRlQ2hlY2snLCB1cGRhdGVDaGVjayAp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