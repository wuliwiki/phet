// Copyright 2019-2022, University of Colorado Boulder

/**
 * sound generator used to indicate the concentration level, but triggered by changes in solution volume or solute amount
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import BinMapper from '../../../../tambo/js/BinMapper.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import SoundGenerator from '../../../../tambo/js/sound-generators/SoundGenerator.js';
import brightMarimba_mp3 from '../../../../tambo/sounds/brightMarimba_mp3.js';
import softNoSolute_v2_mp3 from '../../../sounds/softNoSolute_v2_mp3.js';
import molarity from '../../molarity.js';
import MolarityConstants from '../MolarityConstants.js';

// constants
const NUM_SOLUTE_BINS = 13; // empirically determined to produce sounds as frequently as needed but not TOO frequently
const NUM_VOLUME_BINS = 10; // empirically determined to produce sounds as frequently as needed but not TOO frequently
const ZERO_CONCENTRATION_PLAYBACK_RATE = 2; // about 2 octaves above the nominal pitch, empirically determined

class ConcentrationSoundGenerator extends SoundGenerator {
  /**
   * @param {MacroSolution} solution - model of the solution
   * @param {VerticalSlider} soluteAmountSlider - slider that controls the amount of solute
   * @param {VerticalSlider} solutionVolumeSlider - slider that controls the volume of the solution
   * @param {Property.<boolean>} resetInProgressProperty - indicates when a reset is happening, used to mute sounds
   * @param {Object} [options]
   */
  constructor(solution, soluteAmountSlider, solutionVolumeSlider, resetInProgressProperty, options) {
    super(options);

    // sound clip that is played when the concentration is above zero (pitch is varied as a function of concentration)
    const nonZeroConcentrationSoundClip = new SoundClip(brightMarimba_mp3, {
      rateChangesAffectPlayingSounds: false
    });
    nonZeroConcentrationSoundClip.connect(this.soundSourceDestination);

    // sound clip that is played when the solute amount transitions to zero
    const transitionToZeroConcentrationSoundClip = new SoundClip(brightMarimba_mp3, {
      initialOutputLevel: 1.5,
      // higher than nominal, seems to work to make it more pronounced
      initialPlaybackRate: ZERO_CONCENTRATION_PLAYBACK_RATE
    });
    transitionToZeroConcentrationSoundClip.connect(this.soundSourceDestination);

    // sound clip that is played when the solution level is changed when the concentration is zero
    const atZeroConcentrationSoundClip = new SoundClip(softNoSolute_v2_mp3, {
      initialOutputLevel: 0.6
    });
    atZeroConcentrationSoundClip.connect(this.soundSourceDestination);

    // keep track of the concentration value each time sound is played
    let concentrationAtLastSoundProduction = solution.concentrationProperty.value;

    // closure for playing the appropriate concentration sound
    const playConcentrationSound = () => {
      const concentration = solution.concentrationProperty.value;
      const normalizedConcentration = concentration / MolarityConstants.CONCENTRATION_RANGE.max;
      if (normalizedConcentration > 0) {
        nonZeroConcentrationSoundClip.setPlaybackRate(1.5 - normalizedConcentration);
        nonZeroConcentrationSoundClip.play();
      } else if (concentrationAtLastSoundProduction > 0) {
        // the concentration value has transitioned to zero, so play the sound at a pitch meant to convey emptiness
        transitionToZeroConcentrationSoundClip.play();
      } else {
        // the user is changing the volume of the solution with no solute in it, play the sound for this specific case
        atZeroConcentrationSoundClip.play();
      }
      concentrationAtLastSoundProduction = concentration;
    };

    // trigger playing of the concentration sound as the solute amount changes
    const soluteAmountBinMapper = new BinMapper(MolarityConstants.SOLUTE_AMOUNT_RANGE, NUM_SOLUTE_BINS);
    solution.soluteAmountProperty.lazyLink((soluteAmount, previousSoluteAmount) => {
      // don't play if saturated - other sounds are used in that case
      if (!solution.precipitateAmountProperty.value > 0) {
        // determine if the sound was caused by an a11y-related action, such as keyboard manipulation
        const changeDueToA11yAction = soluteAmountSlider.draggingPointerType === 'pdom' || solutionVolumeSlider.draggingPointerType === 'pdom';

        // map the solute amount value to bins
        const previousBin = soluteAmountBinMapper.mapToBin(previousSoluteAmount);
        const currentBin = soluteAmountBinMapper.mapToBin(soluteAmount);

        // play the sound if appropriate
        if (!resetInProgressProperty.value && (changeDueToA11yAction || previousBin !== currentBin || soluteAmount === MolarityConstants.SOLUTE_AMOUNT_RANGE.max || soluteAmount === MolarityConstants.SOLUTE_AMOUNT_RANGE.min)) {
          playConcentrationSound();
        }
      }
    });

    // trigger playing of the concentration sound as the solution volume changes
    const volumeBinMapper = new BinMapper(MolarityConstants.SOLUTION_VOLUME_RANGE, NUM_VOLUME_BINS);
    solution.volumeProperty.lazyLink((volume, previousVolume) => {
      // don't play if saturated - other sounds are used in that case
      if (!solution.precipitateAmountProperty.value > 0) {
        // determine if the sound was caused by an a11y-related action, such as kayboard manipulation
        const changeDueToA11yAction = soluteAmountSlider.draggingPointerType === 'pdom' || solutionVolumeSlider.draggingPointerType === 'pdom';

        // map the solution volume value to bins
        const previousBin = volumeBinMapper.mapToBin(previousVolume);
        const currentBin = volumeBinMapper.mapToBin(volume);
        if (!resetInProgressProperty.value && (changeDueToA11yAction || previousBin !== currentBin || volume === MolarityConstants.SOLUTION_VOLUME_RANGE.max || volume === MolarityConstants.SOLUTION_VOLUME_RANGE.min)) {
          playConcentrationSound();
        }
      }
    });
  }
}
molarity.register('ConcentrationSoundGenerator', ConcentrationSoundGenerator);
export default ConcentrationSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCaW5NYXBwZXIiLCJTb3VuZENsaXAiLCJTb3VuZEdlbmVyYXRvciIsImJyaWdodE1hcmltYmFfbXAzIiwic29mdE5vU29sdXRlX3YyX21wMyIsIm1vbGFyaXR5IiwiTW9sYXJpdHlDb25zdGFudHMiLCJOVU1fU09MVVRFX0JJTlMiLCJOVU1fVk9MVU1FX0JJTlMiLCJaRVJPX0NPTkNFTlRSQVRJT05fUExBWUJBQ0tfUkFURSIsIkNvbmNlbnRyYXRpb25Tb3VuZEdlbmVyYXRvciIsImNvbnN0cnVjdG9yIiwic29sdXRpb24iLCJzb2x1dGVBbW91bnRTbGlkZXIiLCJzb2x1dGlvblZvbHVtZVNsaWRlciIsInJlc2V0SW5Qcm9ncmVzc1Byb3BlcnR5Iiwib3B0aW9ucyIsIm5vblplcm9Db25jZW50cmF0aW9uU291bmRDbGlwIiwicmF0ZUNoYW5nZXNBZmZlY3RQbGF5aW5nU291bmRzIiwiY29ubmVjdCIsInNvdW5kU291cmNlRGVzdGluYXRpb24iLCJ0cmFuc2l0aW9uVG9aZXJvQ29uY2VudHJhdGlvblNvdW5kQ2xpcCIsImluaXRpYWxPdXRwdXRMZXZlbCIsImluaXRpYWxQbGF5YmFja1JhdGUiLCJhdFplcm9Db25jZW50cmF0aW9uU291bmRDbGlwIiwiY29uY2VudHJhdGlvbkF0TGFzdFNvdW5kUHJvZHVjdGlvbiIsImNvbmNlbnRyYXRpb25Qcm9wZXJ0eSIsInZhbHVlIiwicGxheUNvbmNlbnRyYXRpb25Tb3VuZCIsImNvbmNlbnRyYXRpb24iLCJub3JtYWxpemVkQ29uY2VudHJhdGlvbiIsIkNPTkNFTlRSQVRJT05fUkFOR0UiLCJtYXgiLCJzZXRQbGF5YmFja1JhdGUiLCJwbGF5Iiwic29sdXRlQW1vdW50QmluTWFwcGVyIiwiU09MVVRFX0FNT1VOVF9SQU5HRSIsInNvbHV0ZUFtb3VudFByb3BlcnR5IiwibGF6eUxpbmsiLCJzb2x1dGVBbW91bnQiLCJwcmV2aW91c1NvbHV0ZUFtb3VudCIsInByZWNpcGl0YXRlQW1vdW50UHJvcGVydHkiLCJjaGFuZ2VEdWVUb0ExMXlBY3Rpb24iLCJkcmFnZ2luZ1BvaW50ZXJUeXBlIiwicHJldmlvdXNCaW4iLCJtYXBUb0JpbiIsImN1cnJlbnRCaW4iLCJtaW4iLCJ2b2x1bWVCaW5NYXBwZXIiLCJTT0xVVElPTl9WT0xVTUVfUkFOR0UiLCJ2b2x1bWVQcm9wZXJ0eSIsInZvbHVtZSIsInByZXZpb3VzVm9sdW1lIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDb25jZW50cmF0aW9uU291bmRHZW5lcmF0b3IuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogc291bmQgZ2VuZXJhdG9yIHVzZWQgdG8gaW5kaWNhdGUgdGhlIGNvbmNlbnRyYXRpb24gbGV2ZWwsIGJ1dCB0cmlnZ2VyZWQgYnkgY2hhbmdlcyBpbiBzb2x1dGlvbiB2b2x1bWUgb3Igc29sdXRlIGFtb3VudFxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCaW5NYXBwZXIgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvQmluTWFwcGVyLmpzJztcclxuaW1wb3J0IFNvdW5kQ2xpcCBmcm9tICcuLi8uLi8uLi8uLi90YW1iby9qcy9zb3VuZC1nZW5lcmF0b3JzL1NvdW5kQ2xpcC5qcyc7XHJcbmltcG9ydCBTb3VuZEdlbmVyYXRvciBmcm9tICcuLi8uLi8uLi8uLi90YW1iby9qcy9zb3VuZC1nZW5lcmF0b3JzL1NvdW5kR2VuZXJhdG9yLmpzJztcclxuaW1wb3J0IGJyaWdodE1hcmltYmFfbXAzIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL3NvdW5kcy9icmlnaHRNYXJpbWJhX21wMy5qcyc7XHJcbmltcG9ydCBzb2Z0Tm9Tb2x1dGVfdjJfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9zb2Z0Tm9Tb2x1dGVfdjJfbXAzLmpzJztcclxuaW1wb3J0IG1vbGFyaXR5IGZyb20gJy4uLy4uL21vbGFyaXR5LmpzJztcclxuaW1wb3J0IE1vbGFyaXR5Q29uc3RhbnRzIGZyb20gJy4uL01vbGFyaXR5Q29uc3RhbnRzLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBOVU1fU09MVVRFX0JJTlMgPSAxMzsgLy8gZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCB0byBwcm9kdWNlIHNvdW5kcyBhcyBmcmVxdWVudGx5IGFzIG5lZWRlZCBidXQgbm90IFRPTyBmcmVxdWVudGx5XHJcbmNvbnN0IE5VTV9WT0xVTUVfQklOUyA9IDEwOyAvLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHRvIHByb2R1Y2Ugc291bmRzIGFzIGZyZXF1ZW50bHkgYXMgbmVlZGVkIGJ1dCBub3QgVE9PIGZyZXF1ZW50bHlcclxuY29uc3QgWkVST19DT05DRU5UUkFUSU9OX1BMQVlCQUNLX1JBVEUgPSAyOyAvLyBhYm91dCAyIG9jdGF2ZXMgYWJvdmUgdGhlIG5vbWluYWwgcGl0Y2gsIGVtcGlyaWNhbGx5IGRldGVybWluZWRcclxuXHJcbmNsYXNzIENvbmNlbnRyYXRpb25Tb3VuZEdlbmVyYXRvciBleHRlbmRzIFNvdW5kR2VuZXJhdG9yIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtNYWNyb1NvbHV0aW9ufSBzb2x1dGlvbiAtIG1vZGVsIG9mIHRoZSBzb2x1dGlvblxyXG4gICAqIEBwYXJhbSB7VmVydGljYWxTbGlkZXJ9IHNvbHV0ZUFtb3VudFNsaWRlciAtIHNsaWRlciB0aGF0IGNvbnRyb2xzIHRoZSBhbW91bnQgb2Ygc29sdXRlXHJcbiAgICogQHBhcmFtIHtWZXJ0aWNhbFNsaWRlcn0gc29sdXRpb25Wb2x1bWVTbGlkZXIgLSBzbGlkZXIgdGhhdCBjb250cm9scyB0aGUgdm9sdW1lIG9mIHRoZSBzb2x1dGlvblxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPGJvb2xlYW4+fSByZXNldEluUHJvZ3Jlc3NQcm9wZXJ0eSAtIGluZGljYXRlcyB3aGVuIGEgcmVzZXQgaXMgaGFwcGVuaW5nLCB1c2VkIHRvIG11dGUgc291bmRzXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBzb2x1dGlvbiwgc29sdXRlQW1vdW50U2xpZGVyLCBzb2x1dGlvblZvbHVtZVNsaWRlciwgcmVzZXRJblByb2dyZXNzUHJvcGVydHksIG9wdGlvbnMgKSB7XHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIHNvdW5kIGNsaXAgdGhhdCBpcyBwbGF5ZWQgd2hlbiB0aGUgY29uY2VudHJhdGlvbiBpcyBhYm92ZSB6ZXJvIChwaXRjaCBpcyB2YXJpZWQgYXMgYSBmdW5jdGlvbiBvZiBjb25jZW50cmF0aW9uKVxyXG4gICAgY29uc3Qgbm9uWmVyb0NvbmNlbnRyYXRpb25Tb3VuZENsaXAgPSBuZXcgU291bmRDbGlwKCBicmlnaHRNYXJpbWJhX21wMywgeyByYXRlQ2hhbmdlc0FmZmVjdFBsYXlpbmdTb3VuZHM6IGZhbHNlIH0gKTtcclxuICAgIG5vblplcm9Db25jZW50cmF0aW9uU291bmRDbGlwLmNvbm5lY3QoIHRoaXMuc291bmRTb3VyY2VEZXN0aW5hdGlvbiApO1xyXG5cclxuICAgIC8vIHNvdW5kIGNsaXAgdGhhdCBpcyBwbGF5ZWQgd2hlbiB0aGUgc29sdXRlIGFtb3VudCB0cmFuc2l0aW9ucyB0byB6ZXJvXHJcbiAgICBjb25zdCB0cmFuc2l0aW9uVG9aZXJvQ29uY2VudHJhdGlvblNvdW5kQ2xpcCA9IG5ldyBTb3VuZENsaXAoIGJyaWdodE1hcmltYmFfbXAzLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogMS41LCAvLyBoaWdoZXIgdGhhbiBub21pbmFsLCBzZWVtcyB0byB3b3JrIHRvIG1ha2UgaXQgbW9yZSBwcm9ub3VuY2VkXHJcbiAgICAgIGluaXRpYWxQbGF5YmFja1JhdGU6IFpFUk9fQ09OQ0VOVFJBVElPTl9QTEFZQkFDS19SQVRFXHJcbiAgICB9ICk7XHJcbiAgICB0cmFuc2l0aW9uVG9aZXJvQ29uY2VudHJhdGlvblNvdW5kQ2xpcC5jb25uZWN0KCB0aGlzLnNvdW5kU291cmNlRGVzdGluYXRpb24gKTtcclxuXHJcbiAgICAvLyBzb3VuZCBjbGlwIHRoYXQgaXMgcGxheWVkIHdoZW4gdGhlIHNvbHV0aW9uIGxldmVsIGlzIGNoYW5nZWQgd2hlbiB0aGUgY29uY2VudHJhdGlvbiBpcyB6ZXJvXHJcbiAgICBjb25zdCBhdFplcm9Db25jZW50cmF0aW9uU291bmRDbGlwID0gbmV3IFNvdW5kQ2xpcCggc29mdE5vU29sdXRlX3YyX21wMywgeyBpbml0aWFsT3V0cHV0TGV2ZWw6IDAuNiB9ICk7XHJcbiAgICBhdFplcm9Db25jZW50cmF0aW9uU291bmRDbGlwLmNvbm5lY3QoIHRoaXMuc291bmRTb3VyY2VEZXN0aW5hdGlvbiApO1xyXG5cclxuICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIGNvbmNlbnRyYXRpb24gdmFsdWUgZWFjaCB0aW1lIHNvdW5kIGlzIHBsYXllZFxyXG4gICAgbGV0IGNvbmNlbnRyYXRpb25BdExhc3RTb3VuZFByb2R1Y3Rpb24gPSBzb2x1dGlvbi5jb25jZW50cmF0aW9uUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgLy8gY2xvc3VyZSBmb3IgcGxheWluZyB0aGUgYXBwcm9wcmlhdGUgY29uY2VudHJhdGlvbiBzb3VuZFxyXG4gICAgY29uc3QgcGxheUNvbmNlbnRyYXRpb25Tb3VuZCA9ICgpID0+IHtcclxuICAgICAgY29uc3QgY29uY2VudHJhdGlvbiA9IHNvbHV0aW9uLmNvbmNlbnRyYXRpb25Qcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgY29uc3Qgbm9ybWFsaXplZENvbmNlbnRyYXRpb24gPSBjb25jZW50cmF0aW9uIC8gTW9sYXJpdHlDb25zdGFudHMuQ09OQ0VOVFJBVElPTl9SQU5HRS5tYXg7XHJcbiAgICAgIGlmICggbm9ybWFsaXplZENvbmNlbnRyYXRpb24gPiAwICkge1xyXG4gICAgICAgIG5vblplcm9Db25jZW50cmF0aW9uU291bmRDbGlwLnNldFBsYXliYWNrUmF0ZSggMS41IC0gbm9ybWFsaXplZENvbmNlbnRyYXRpb24gKTtcclxuICAgICAgICBub25aZXJvQ29uY2VudHJhdGlvblNvdW5kQ2xpcC5wbGF5KCk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIGNvbmNlbnRyYXRpb25BdExhc3RTb3VuZFByb2R1Y3Rpb24gPiAwICkge1xyXG5cclxuICAgICAgICAvLyB0aGUgY29uY2VudHJhdGlvbiB2YWx1ZSBoYXMgdHJhbnNpdGlvbmVkIHRvIHplcm8sIHNvIHBsYXkgdGhlIHNvdW5kIGF0IGEgcGl0Y2ggbWVhbnQgdG8gY29udmV5IGVtcHRpbmVzc1xyXG4gICAgICAgIHRyYW5zaXRpb25Ub1plcm9Db25jZW50cmF0aW9uU291bmRDbGlwLnBsYXkoKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgLy8gdGhlIHVzZXIgaXMgY2hhbmdpbmcgdGhlIHZvbHVtZSBvZiB0aGUgc29sdXRpb24gd2l0aCBubyBzb2x1dGUgaW4gaXQsIHBsYXkgdGhlIHNvdW5kIGZvciB0aGlzIHNwZWNpZmljIGNhc2VcclxuICAgICAgICBhdFplcm9Db25jZW50cmF0aW9uU291bmRDbGlwLnBsYXkoKTtcclxuICAgICAgfVxyXG4gICAgICBjb25jZW50cmF0aW9uQXRMYXN0U291bmRQcm9kdWN0aW9uID0gY29uY2VudHJhdGlvbjtcclxuICAgIH07XHJcblxyXG4gICAgLy8gdHJpZ2dlciBwbGF5aW5nIG9mIHRoZSBjb25jZW50cmF0aW9uIHNvdW5kIGFzIHRoZSBzb2x1dGUgYW1vdW50IGNoYW5nZXNcclxuICAgIGNvbnN0IHNvbHV0ZUFtb3VudEJpbk1hcHBlciA9IG5ldyBCaW5NYXBwZXIoIE1vbGFyaXR5Q29uc3RhbnRzLlNPTFVURV9BTU9VTlRfUkFOR0UsIE5VTV9TT0xVVEVfQklOUyApO1xyXG4gICAgc29sdXRpb24uc29sdXRlQW1vdW50UHJvcGVydHkubGF6eUxpbmsoICggc29sdXRlQW1vdW50LCBwcmV2aW91c1NvbHV0ZUFtb3VudCApID0+IHtcclxuXHJcbiAgICAgIC8vIGRvbid0IHBsYXkgaWYgc2F0dXJhdGVkIC0gb3RoZXIgc291bmRzIGFyZSB1c2VkIGluIHRoYXQgY2FzZVxyXG4gICAgICBpZiAoICFzb2x1dGlvbi5wcmVjaXBpdGF0ZUFtb3VudFByb3BlcnR5LnZhbHVlID4gMCApIHtcclxuXHJcbiAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHRoZSBzb3VuZCB3YXMgY2F1c2VkIGJ5IGFuIGExMXktcmVsYXRlZCBhY3Rpb24sIHN1Y2ggYXMga2V5Ym9hcmQgbWFuaXB1bGF0aW9uXHJcbiAgICAgICAgY29uc3QgY2hhbmdlRHVlVG9BMTF5QWN0aW9uID0gc29sdXRlQW1vdW50U2xpZGVyLmRyYWdnaW5nUG9pbnRlclR5cGUgPT09ICdwZG9tJyB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvbHV0aW9uVm9sdW1lU2xpZGVyLmRyYWdnaW5nUG9pbnRlclR5cGUgPT09ICdwZG9tJztcclxuXHJcbiAgICAgICAgLy8gbWFwIHRoZSBzb2x1dGUgYW1vdW50IHZhbHVlIHRvIGJpbnNcclxuICAgICAgICBjb25zdCBwcmV2aW91c0JpbiA9IHNvbHV0ZUFtb3VudEJpbk1hcHBlci5tYXBUb0JpbiggcHJldmlvdXNTb2x1dGVBbW91bnQgKTtcclxuICAgICAgICBjb25zdCBjdXJyZW50QmluID0gc29sdXRlQW1vdW50QmluTWFwcGVyLm1hcFRvQmluKCBzb2x1dGVBbW91bnQgKTtcclxuXHJcbiAgICAgICAgLy8gcGxheSB0aGUgc291bmQgaWYgYXBwcm9wcmlhdGVcclxuICAgICAgICBpZiAoICFyZXNldEluUHJvZ3Jlc3NQcm9wZXJ0eS52YWx1ZSAmJlxyXG4gICAgICAgICAgICAgKCBjaGFuZ2VEdWVUb0ExMXlBY3Rpb24gfHxcclxuICAgICAgICAgICAgICAgcHJldmlvdXNCaW4gIT09IGN1cnJlbnRCaW4gfHxcclxuICAgICAgICAgICAgICAgc29sdXRlQW1vdW50ID09PSBNb2xhcml0eUNvbnN0YW50cy5TT0xVVEVfQU1PVU5UX1JBTkdFLm1heCB8fFxyXG4gICAgICAgICAgICAgICBzb2x1dGVBbW91bnQgPT09IE1vbGFyaXR5Q29uc3RhbnRzLlNPTFVURV9BTU9VTlRfUkFOR0UubWluICkgKSB7XHJcblxyXG4gICAgICAgICAgcGxheUNvbmNlbnRyYXRpb25Tb3VuZCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHRyaWdnZXIgcGxheWluZyBvZiB0aGUgY29uY2VudHJhdGlvbiBzb3VuZCBhcyB0aGUgc29sdXRpb24gdm9sdW1lIGNoYW5nZXNcclxuICAgIGNvbnN0IHZvbHVtZUJpbk1hcHBlciA9IG5ldyBCaW5NYXBwZXIoIE1vbGFyaXR5Q29uc3RhbnRzLlNPTFVUSU9OX1ZPTFVNRV9SQU5HRSwgTlVNX1ZPTFVNRV9CSU5TICk7XHJcbiAgICBzb2x1dGlvbi52b2x1bWVQcm9wZXJ0eS5sYXp5TGluayggKCB2b2x1bWUsIHByZXZpb3VzVm9sdW1lICkgPT4ge1xyXG5cclxuICAgICAgLy8gZG9uJ3QgcGxheSBpZiBzYXR1cmF0ZWQgLSBvdGhlciBzb3VuZHMgYXJlIHVzZWQgaW4gdGhhdCBjYXNlXHJcbiAgICAgIGlmICggIXNvbHV0aW9uLnByZWNpcGl0YXRlQW1vdW50UHJvcGVydHkudmFsdWUgPiAwICkge1xyXG5cclxuICAgICAgICAvLyBkZXRlcm1pbmUgaWYgdGhlIHNvdW5kIHdhcyBjYXVzZWQgYnkgYW4gYTExeS1yZWxhdGVkIGFjdGlvbiwgc3VjaCBhcyBrYXlib2FyZCBtYW5pcHVsYXRpb25cclxuICAgICAgICBjb25zdCBjaGFuZ2VEdWVUb0ExMXlBY3Rpb24gPSBzb2x1dGVBbW91bnRTbGlkZXIuZHJhZ2dpbmdQb2ludGVyVHlwZSA9PT0gJ3Bkb20nIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29sdXRpb25Wb2x1bWVTbGlkZXIuZHJhZ2dpbmdQb2ludGVyVHlwZSA9PT0gJ3Bkb20nO1xyXG5cclxuICAgICAgICAvLyBtYXAgdGhlIHNvbHV0aW9uIHZvbHVtZSB2YWx1ZSB0byBiaW5zXHJcbiAgICAgICAgY29uc3QgcHJldmlvdXNCaW4gPSB2b2x1bWVCaW5NYXBwZXIubWFwVG9CaW4oIHByZXZpb3VzVm9sdW1lICk7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEJpbiA9IHZvbHVtZUJpbk1hcHBlci5tYXBUb0Jpbiggdm9sdW1lICk7XHJcbiAgICAgICAgaWYgKCAhcmVzZXRJblByb2dyZXNzUHJvcGVydHkudmFsdWUgJiZcclxuICAgICAgICAgICAgICggY2hhbmdlRHVlVG9BMTF5QWN0aW9uIHx8XHJcbiAgICAgICAgICAgICAgIHByZXZpb3VzQmluICE9PSBjdXJyZW50QmluIHx8XHJcbiAgICAgICAgICAgICAgIHZvbHVtZSA9PT0gTW9sYXJpdHlDb25zdGFudHMuU09MVVRJT05fVk9MVU1FX1JBTkdFLm1heCB8fFxyXG4gICAgICAgICAgICAgICB2b2x1bWUgPT09IE1vbGFyaXR5Q29uc3RhbnRzLlNPTFVUSU9OX1ZPTFVNRV9SQU5HRS5taW4gKSApIHtcclxuXHJcbiAgICAgICAgICBwbGF5Q29uY2VudHJhdGlvblNvdW5kKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5tb2xhcml0eS5yZWdpc3RlciggJ0NvbmNlbnRyYXRpb25Tb3VuZEdlbmVyYXRvcicsIENvbmNlbnRyYXRpb25Tb3VuZEdlbmVyYXRvciApO1xyXG5leHBvcnQgZGVmYXVsdCBDb25jZW50cmF0aW9uU291bmRHZW5lcmF0b3I7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFNBQVMsTUFBTSxtQ0FBbUM7QUFDekQsT0FBT0MsU0FBUyxNQUFNLG9EQUFvRDtBQUMxRSxPQUFPQyxjQUFjLE1BQU0seURBQXlEO0FBQ3BGLE9BQU9DLGlCQUFpQixNQUFNLCtDQUEr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