// Copyright 2019-2022, University of Colorado Boulder

/**
 * Node for the PDOM content to describe the beaker.
 * @author Taylor Want (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import ChemUtils from '../../../../nitroglycerin/js/ChemUtils.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import { Node } from '../../../../scenery/js/imports.js';
import molarity from '../../molarity.js';
import MolarityStrings from '../../MolarityStrings.js';
const drinkMixString = MolarityStrings.drinkMix;
const beakerDescriptionPatternString = MolarityStrings.a11y.beaker.descriptionPattern;
const beakerHasZeroConcentrationString = MolarityStrings.a11y.beaker.hasZeroConcentration;
const beakerDescriptionPureWaterPatternString = MolarityStrings.a11y.beaker.descriptionPureWaterPattern;
const beakerPureWaterString = MolarityStrings.a11y.beaker.pureWater;
const beakerWaterFormulaDescriptionString = MolarityStrings.a11y.beaker.waterFormulaDescription;
class MolarityBeakerDescriptionNode extends Node {
  /**
   * @param {MacroSolution} solution - from MolarityModel
   * @param {Property.<boolean>} useQuantitativeDescriptionsProperty
   * @param {SoluteDescriber} soluteDescriber
   * @param {ConcentrationDescriber} concentrationDescriber
   * @param {PrecipitateAmountDescriber} precipitateAmountDescriber
   * @param {SoluteAmountDescriber} soluteAmountDescriber
   * @param {VolumeDescriber} volumeDescriber
   */
  constructor(solution, useQuantitativeDescriptionsProperty, soluteDescriber, concentrationDescriber, precipitateAmountDescriber, soluteAmountDescriber, volumeDescriber) {
    super({
      tagName: 'ul'
    });

    // @private
    this.solution = solution;
    this.useQuantitativeDescriptionsProperty = useQuantitativeDescriptionsProperty;
    this.concentrationDescriber = concentrationDescriber;
    this.precipitateAmountDescriber = precipitateAmountDescriber;
    this.soluteDescriber = soluteDescriber;
    this.soluteAmountDescriber = soluteAmountDescriber;
    this.volumeDescriber = volumeDescriber;

    // @private - Container Nodes for conditional content. This is to keep children order simple.
    this.saturationSummaryContainer = new Node();
    this.chemicalFormulaSummaryContainer = new Node();

    // @private - Create the Nodes to be used in the description list.
    this.soluteAmountSummaryItem = new Node({
      tagName: 'li'
    });
    this.saturationSummaryItem = new Node({
      tagName: 'li'
    });
    this.concentrationSummaryItem = new Node({
      tagName: 'li'
    });
    this.chemicalFormulaSummaryItem = new Node({
      tagName: 'li'
    });
    this.concentrationRangeSummaryItem = new Node({
      tagName: 'li'
    });
    Multilink.multilink([useQuantitativeDescriptionsProperty, solution.volumeProperty, solution.soluteAmountProperty, solution.concentrationProperty, solution.soluteProperty], () => this.updateBeakerDescription());
    this.setChildren([this.soluteAmountSummaryItem, this.saturationSummaryContainer, this.concentrationSummaryItem, this.chemicalFormulaSummaryContainer, this.concentrationRangeSummaryItem]);
    this.updateBeakerDescription();
  }

  /**
   * updates the entire beaker summary in the PDOM when a model property changes.
   * @private
   */
  updateBeakerDescription() {
    // summary string above the list items
    this.labelContent = this.updateBeakerSummaryString();

    // each method updates a single list item in the description
    this.updateSoluteAmountSummary();
    this.updateSaturationSummary();
    this.updateConcentrationSummary();
    this.updateChemicalFormulaSummary();
    this.updateConcentrationRangeSummary();
  }

  /**
   * updates the summary sentence before the bulleted list of descriptions
   * @private
   */
  updateBeakerSummaryString() {
    const summaryString = !this.solution.hasSolute() ? beakerDescriptionPureWaterPatternString : beakerDescriptionPatternString;
    return StringUtils.fillIn(summaryString, {
      solute: !this.solution.hasSolute() ? beakerPureWaterString : this.soluteDescriber.getCurrentSoluteName(),
      volume: this.volumeDescriber.getCurrentVolume(true),
      color: this.soluteDescriber.getCurrentColor()
    });
  }

  /**
   * updates the first bullet point - e.g. 'contains some drink mix'
   * @private
   */
  updateSoluteAmountSummary() {
    this.soluteAmountSummaryItem.innerContent = this.soluteAmountDescriber.getBeakerSoluteAmountString();
  }

  /**
   * if the solution is saturated, creates second bullet point - e.g. 'is saturated with a few solids'.
   * Otherwise, it removes that bullet point from the list
   * @private
   */
  updateSaturationSummary() {
    this.saturationSummaryContainer.children = this.solution.isSaturated() ? [this.saturationSummaryItem] : [];
    this.saturationSummaryItem.innerContent = this.precipitateAmountDescriber.getBeakerSaturationString();
  }

  /**
   * updates second/third (depending on saturation state) bullet - e.g. 'has low concentration'.
   * @private
   */
  updateConcentrationSummary() {
    if (!this.solution.hasSolute()) {
      this.concentrationSummaryItem.innerContent = beakerHasZeroConcentrationString;
    } else {
      this.concentrationSummaryItem.innerContent = this.concentrationDescriber.getBeakerConcentrationString(this.useQuantitativeDescriptionsProperty);
    }
  }

  /**
   * updates third/fourth (depending on saturation state) bullet - e.g. 'chemical formula of potassium permanganate
   * is KMnO4.' If the solute is drink mix, this bullet is not created.
   * @private
   */
  updateChemicalFormulaSummary() {
    const isDrinkMix = this.soluteDescriber.getCurrentSoluteName(true) === drinkMixString;
    if (!this.solution.hasSolute()) {
      // if there is no solute in the beaker, the chemical formula of water is displayed instead.
      this.chemicalFormulaSummaryItem.innerContent = ChemUtils.toSubscript(beakerWaterFormulaDescriptionString);
      this.chemicalFormulaSummaryContainer.children = [this.chemicalFormulaSummaryItem];
    } else if (!isDrinkMix) {
      // if there is solute in the beaker and the solute is not drink mix, displays the chemical formula of the solute.
      this.chemicalFormulaSummaryItem.innerContent = this.soluteDescriber.getBeakerChemicalFormulaString();
      this.chemicalFormulaSummaryContainer.children = [this.chemicalFormulaSummaryItem];
    } else {
      // if there is solute in the beaker and the solute is drink mix, no chemical formula is displayed
      this.chemicalFormulaSummaryContainer.children = [];
    }
  }

  /**
   * updates the concentration range bullet - e.g. 'concentration readout range 0 to 5.0 molar.'
   * @private
   */
  updateConcentrationRangeSummary() {
    this.concentrationRangeSummaryItem.innerContent = this.concentrationDescriber.getCurrentConcentrationRangeClause();
  }
}
molarity.register('MolarityBeakerDescriptionNode', MolarityBeakerDescriptionNode);
export default MolarityBeakerDescriptionNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJDaGVtVXRpbHMiLCJTdHJpbmdVdGlscyIsIk5vZGUiLCJtb2xhcml0eSIsIk1vbGFyaXR5U3RyaW5ncyIsImRyaW5rTWl4U3RyaW5nIiwiZHJpbmtNaXgiLCJiZWFrZXJEZXNjcmlwdGlvblBhdHRlcm5TdHJpbmciLCJhMTF5IiwiYmVha2VyIiwiZGVzY3JpcHRpb25QYXR0ZXJuIiwiYmVha2VySGFzWmVyb0NvbmNlbnRyYXRpb25TdHJpbmciLCJoYXNaZXJvQ29uY2VudHJhdGlvbiIsImJlYWtlckRlc2NyaXB0aW9uUHVyZVdhdGVyUGF0dGVyblN0cmluZyIsImRlc2NyaXB0aW9uUHVyZVdhdGVyUGF0dGVybiIsImJlYWtlclB1cmVXYXRlclN0cmluZyIsInB1cmVXYXRlciIsImJlYWtlcldhdGVyRm9ybXVsYURlc2NyaXB0aW9uU3RyaW5nIiwid2F0ZXJGb3JtdWxhRGVzY3JpcHRpb24iLCJNb2xhcml0eUJlYWtlckRlc2NyaXB0aW9uTm9kZSIsImNvbnN0cnVjdG9yIiwic29sdXRpb24iLCJ1c2VRdWFudGl0YXRpdmVEZXNjcmlwdGlvbnNQcm9wZXJ0eSIsInNvbHV0ZURlc2NyaWJlciIsImNvbmNlbnRyYXRpb25EZXNjcmliZXIiLCJwcmVjaXBpdGF0ZUFtb3VudERlc2NyaWJlciIsInNvbHV0ZUFtb3VudERlc2NyaWJlciIsInZvbHVtZURlc2NyaWJlciIsInRhZ05hbWUiLCJzYXR1cmF0aW9uU3VtbWFyeUNvbnRhaW5lciIsImNoZW1pY2FsRm9ybXVsYVN1bW1hcnlDb250YWluZXIiLCJzb2x1dGVBbW91bnRTdW1tYXJ5SXRlbSIsInNhdHVyYXRpb25TdW1tYXJ5SXRlbSIsImNvbmNlbnRyYXRpb25TdW1tYXJ5SXRlbSIsImNoZW1pY2FsRm9ybXVsYVN1bW1hcnlJdGVtIiwiY29uY2VudHJhdGlvblJhbmdlU3VtbWFyeUl0ZW0iLCJtdWx0aWxpbmsiLCJ2b2x1bWVQcm9wZXJ0eSIsInNvbHV0ZUFtb3VudFByb3BlcnR5IiwiY29uY2VudHJhdGlvblByb3BlcnR5Iiwic29sdXRlUHJvcGVydHkiLCJ1cGRhdGVCZWFrZXJEZXNjcmlwdGlvbiIsInNldENoaWxkcmVuIiwibGFiZWxDb250ZW50IiwidXBkYXRlQmVha2VyU3VtbWFyeVN0cmluZyIsInVwZGF0ZVNvbHV0ZUFtb3VudFN1bW1hcnkiLCJ1cGRhdGVTYXR1cmF0aW9uU3VtbWFyeSIsInVwZGF0ZUNvbmNlbnRyYXRpb25TdW1tYXJ5IiwidXBkYXRlQ2hlbWljYWxGb3JtdWxhU3VtbWFyeSIsInVwZGF0ZUNvbmNlbnRyYXRpb25SYW5nZVN1bW1hcnkiLCJzdW1tYXJ5U3RyaW5nIiwiaGFzU29sdXRlIiwiZmlsbEluIiwic29sdXRlIiwiZ2V0Q3VycmVudFNvbHV0ZU5hbWUiLCJ2b2x1bWUiLCJnZXRDdXJyZW50Vm9sdW1lIiwiY29sb3IiLCJnZXRDdXJyZW50Q29sb3IiLCJpbm5lckNvbnRlbnQiLCJnZXRCZWFrZXJTb2x1dGVBbW91bnRTdHJpbmciLCJjaGlsZHJlbiIsImlzU2F0dXJhdGVkIiwiZ2V0QmVha2VyU2F0dXJhdGlvblN0cmluZyIsImdldEJlYWtlckNvbmNlbnRyYXRpb25TdHJpbmciLCJpc0RyaW5rTWl4IiwidG9TdWJzY3JpcHQiLCJnZXRCZWFrZXJDaGVtaWNhbEZvcm11bGFTdHJpbmciLCJnZXRDdXJyZW50Q29uY2VudHJhdGlvblJhbmdlQ2xhdXNlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNb2xhcml0eUJlYWtlckRlc2NyaXB0aW9uTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBOb2RlIGZvciB0aGUgUERPTSBjb250ZW50IHRvIGRlc2NyaWJlIHRoZSBiZWFrZXIuXHJcbiAqIEBhdXRob3IgVGF5bG9yIFdhbnQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgTWljaGFlbCBLYXV6bWFubiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IENoZW1VdGlscyBmcm9tICcuLi8uLi8uLi8uLi9uaXRyb2dseWNlcmluL2pzL0NoZW1VdGlscy5qcyc7XHJcbmltcG9ydCBTdHJpbmdVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3V0aWwvU3RyaW5nVXRpbHMuanMnO1xyXG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG1vbGFyaXR5IGZyb20gJy4uLy4uL21vbGFyaXR5LmpzJztcclxuaW1wb3J0IE1vbGFyaXR5U3RyaW5ncyBmcm9tICcuLi8uLi9Nb2xhcml0eVN0cmluZ3MuanMnO1xyXG5cclxuY29uc3QgZHJpbmtNaXhTdHJpbmcgPSBNb2xhcml0eVN0cmluZ3MuZHJpbmtNaXg7XHJcblxyXG5jb25zdCBiZWFrZXJEZXNjcmlwdGlvblBhdHRlcm5TdHJpbmcgPSBNb2xhcml0eVN0cmluZ3MuYTExeS5iZWFrZXIuZGVzY3JpcHRpb25QYXR0ZXJuO1xyXG5jb25zdCBiZWFrZXJIYXNaZXJvQ29uY2VudHJhdGlvblN0cmluZyA9IE1vbGFyaXR5U3RyaW5ncy5hMTF5LmJlYWtlci5oYXNaZXJvQ29uY2VudHJhdGlvbjtcclxuY29uc3QgYmVha2VyRGVzY3JpcHRpb25QdXJlV2F0ZXJQYXR0ZXJuU3RyaW5nID0gTW9sYXJpdHlTdHJpbmdzLmExMXkuYmVha2VyLmRlc2NyaXB0aW9uUHVyZVdhdGVyUGF0dGVybjtcclxuY29uc3QgYmVha2VyUHVyZVdhdGVyU3RyaW5nID0gTW9sYXJpdHlTdHJpbmdzLmExMXkuYmVha2VyLnB1cmVXYXRlcjtcclxuY29uc3QgYmVha2VyV2F0ZXJGb3JtdWxhRGVzY3JpcHRpb25TdHJpbmcgPSBNb2xhcml0eVN0cmluZ3MuYTExeS5iZWFrZXIud2F0ZXJGb3JtdWxhRGVzY3JpcHRpb247XHJcblxyXG5jbGFzcyBNb2xhcml0eUJlYWtlckRlc2NyaXB0aW9uTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge01hY3JvU29sdXRpb259IHNvbHV0aW9uIC0gZnJvbSBNb2xhcml0eU1vZGVsXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Ym9vbGVhbj59IHVzZVF1YW50aXRhdGl2ZURlc2NyaXB0aW9uc1Byb3BlcnR5XHJcbiAgICogQHBhcmFtIHtTb2x1dGVEZXNjcmliZXJ9IHNvbHV0ZURlc2NyaWJlclxyXG4gICAqIEBwYXJhbSB7Q29uY2VudHJhdGlvbkRlc2NyaWJlcn0gY29uY2VudHJhdGlvbkRlc2NyaWJlclxyXG4gICAqIEBwYXJhbSB7UHJlY2lwaXRhdGVBbW91bnREZXNjcmliZXJ9IHByZWNpcGl0YXRlQW1vdW50RGVzY3JpYmVyXHJcbiAgICogQHBhcmFtIHtTb2x1dGVBbW91bnREZXNjcmliZXJ9IHNvbHV0ZUFtb3VudERlc2NyaWJlclxyXG4gICAqIEBwYXJhbSB7Vm9sdW1lRGVzY3JpYmVyfSB2b2x1bWVEZXNjcmliZXJcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvciggc29sdXRpb24sIHVzZVF1YW50aXRhdGl2ZURlc2NyaXB0aW9uc1Byb3BlcnR5LCBzb2x1dGVEZXNjcmliZXIsIGNvbmNlbnRyYXRpb25EZXNjcmliZXIsXHJcbiAgICAgICAgICAgICAgIHByZWNpcGl0YXRlQW1vdW50RGVzY3JpYmVyLCBzb2x1dGVBbW91bnREZXNjcmliZXIsIHZvbHVtZURlc2NyaWJlciApIHtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICB0YWdOYW1lOiAndWwnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuc29sdXRpb24gPSBzb2x1dGlvbjtcclxuICAgIHRoaXMudXNlUXVhbnRpdGF0aXZlRGVzY3JpcHRpb25zUHJvcGVydHkgPSB1c2VRdWFudGl0YXRpdmVEZXNjcmlwdGlvbnNQcm9wZXJ0eTtcclxuICAgIHRoaXMuY29uY2VudHJhdGlvbkRlc2NyaWJlciA9IGNvbmNlbnRyYXRpb25EZXNjcmliZXI7XHJcbiAgICB0aGlzLnByZWNpcGl0YXRlQW1vdW50RGVzY3JpYmVyID0gcHJlY2lwaXRhdGVBbW91bnREZXNjcmliZXI7XHJcbiAgICB0aGlzLnNvbHV0ZURlc2NyaWJlciA9IHNvbHV0ZURlc2NyaWJlcjtcclxuICAgIHRoaXMuc29sdXRlQW1vdW50RGVzY3JpYmVyID0gc29sdXRlQW1vdW50RGVzY3JpYmVyO1xyXG4gICAgdGhpcy52b2x1bWVEZXNjcmliZXIgPSB2b2x1bWVEZXNjcmliZXI7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBDb250YWluZXIgTm9kZXMgZm9yIGNvbmRpdGlvbmFsIGNvbnRlbnQuIFRoaXMgaXMgdG8ga2VlcCBjaGlsZHJlbiBvcmRlciBzaW1wbGUuXHJcbiAgICB0aGlzLnNhdHVyYXRpb25TdW1tYXJ5Q29udGFpbmVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMuY2hlbWljYWxGb3JtdWxhU3VtbWFyeUNvbnRhaW5lciA9IG5ldyBOb2RlKCk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBDcmVhdGUgdGhlIE5vZGVzIHRvIGJlIHVzZWQgaW4gdGhlIGRlc2NyaXB0aW9uIGxpc3QuXHJcbiAgICB0aGlzLnNvbHV0ZUFtb3VudFN1bW1hcnlJdGVtID0gbmV3IE5vZGUoIHsgdGFnTmFtZTogJ2xpJyB9ICk7XHJcbiAgICB0aGlzLnNhdHVyYXRpb25TdW1tYXJ5SXRlbSA9IG5ldyBOb2RlKCB7IHRhZ05hbWU6ICdsaScgfSApO1xyXG4gICAgdGhpcy5jb25jZW50cmF0aW9uU3VtbWFyeUl0ZW0gPSBuZXcgTm9kZSggeyB0YWdOYW1lOiAnbGknIH0gKTtcclxuICAgIHRoaXMuY2hlbWljYWxGb3JtdWxhU3VtbWFyeUl0ZW0gPSBuZXcgTm9kZSggeyB0YWdOYW1lOiAnbGknIH0gKTtcclxuICAgIHRoaXMuY29uY2VudHJhdGlvblJhbmdlU3VtbWFyeUl0ZW0gPSBuZXcgTm9kZSggeyB0YWdOYW1lOiAnbGknIH0gKTtcclxuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbXHJcbiAgICAgICAgdXNlUXVhbnRpdGF0aXZlRGVzY3JpcHRpb25zUHJvcGVydHksXHJcbiAgICAgICAgc29sdXRpb24udm9sdW1lUHJvcGVydHksXHJcbiAgICAgICAgc29sdXRpb24uc29sdXRlQW1vdW50UHJvcGVydHksXHJcbiAgICAgICAgc29sdXRpb24uY29uY2VudHJhdGlvblByb3BlcnR5LFxyXG4gICAgICAgIHNvbHV0aW9uLnNvbHV0ZVByb3BlcnR5IF0sXHJcbiAgICAgICgpID0+IHRoaXMudXBkYXRlQmVha2VyRGVzY3JpcHRpb24oKSApO1xyXG5cclxuICAgIHRoaXMuc2V0Q2hpbGRyZW4oIFtcclxuICAgICAgdGhpcy5zb2x1dGVBbW91bnRTdW1tYXJ5SXRlbSxcclxuICAgICAgdGhpcy5zYXR1cmF0aW9uU3VtbWFyeUNvbnRhaW5lcixcclxuICAgICAgdGhpcy5jb25jZW50cmF0aW9uU3VtbWFyeUl0ZW0sXHJcbiAgICAgIHRoaXMuY2hlbWljYWxGb3JtdWxhU3VtbWFyeUNvbnRhaW5lcixcclxuICAgICAgdGhpcy5jb25jZW50cmF0aW9uUmFuZ2VTdW1tYXJ5SXRlbVxyXG4gICAgXSApO1xyXG4gICAgdGhpcy51cGRhdGVCZWFrZXJEZXNjcmlwdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdXBkYXRlcyB0aGUgZW50aXJlIGJlYWtlciBzdW1tYXJ5IGluIHRoZSBQRE9NIHdoZW4gYSBtb2RlbCBwcm9wZXJ0eSBjaGFuZ2VzLlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgdXBkYXRlQmVha2VyRGVzY3JpcHRpb24oKSB7XHJcblxyXG4gICAgLy8gc3VtbWFyeSBzdHJpbmcgYWJvdmUgdGhlIGxpc3QgaXRlbXNcclxuICAgIHRoaXMubGFiZWxDb250ZW50ID0gdGhpcy51cGRhdGVCZWFrZXJTdW1tYXJ5U3RyaW5nKCk7XHJcblxyXG4gICAgLy8gZWFjaCBtZXRob2QgdXBkYXRlcyBhIHNpbmdsZSBsaXN0IGl0ZW0gaW4gdGhlIGRlc2NyaXB0aW9uXHJcbiAgICB0aGlzLnVwZGF0ZVNvbHV0ZUFtb3VudFN1bW1hcnkoKTtcclxuICAgIHRoaXMudXBkYXRlU2F0dXJhdGlvblN1bW1hcnkoKTtcclxuICAgIHRoaXMudXBkYXRlQ29uY2VudHJhdGlvblN1bW1hcnkoKTtcclxuICAgIHRoaXMudXBkYXRlQ2hlbWljYWxGb3JtdWxhU3VtbWFyeSgpO1xyXG4gICAgdGhpcy51cGRhdGVDb25jZW50cmF0aW9uUmFuZ2VTdW1tYXJ5KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiB1cGRhdGVzIHRoZSBzdW1tYXJ5IHNlbnRlbmNlIGJlZm9yZSB0aGUgYnVsbGV0ZWQgbGlzdCBvZiBkZXNjcmlwdGlvbnNcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHVwZGF0ZUJlYWtlclN1bW1hcnlTdHJpbmcoKSB7XHJcbiAgICBjb25zdCBzdW1tYXJ5U3RyaW5nID0gIXRoaXMuc29sdXRpb24uaGFzU29sdXRlKCkgPyBiZWFrZXJEZXNjcmlwdGlvblB1cmVXYXRlclBhdHRlcm5TdHJpbmcgOiBiZWFrZXJEZXNjcmlwdGlvblBhdHRlcm5TdHJpbmc7XHJcbiAgICByZXR1cm4gU3RyaW5nVXRpbHMuZmlsbEluKCBzdW1tYXJ5U3RyaW5nLCB7XHJcbiAgICAgIHNvbHV0ZTogIXRoaXMuc29sdXRpb24uaGFzU29sdXRlKCkgPyBiZWFrZXJQdXJlV2F0ZXJTdHJpbmcgOiB0aGlzLnNvbHV0ZURlc2NyaWJlci5nZXRDdXJyZW50U29sdXRlTmFtZSgpLFxyXG4gICAgICB2b2x1bWU6IHRoaXMudm9sdW1lRGVzY3JpYmVyLmdldEN1cnJlbnRWb2x1bWUoIHRydWUgKSxcclxuICAgICAgY29sb3I6IHRoaXMuc29sdXRlRGVzY3JpYmVyLmdldEN1cnJlbnRDb2xvcigpXHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiB1cGRhdGVzIHRoZSBmaXJzdCBidWxsZXQgcG9pbnQgLSBlLmcuICdjb250YWlucyBzb21lIGRyaW5rIG1peCdcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHVwZGF0ZVNvbHV0ZUFtb3VudFN1bW1hcnkoKSB7XHJcbiAgICB0aGlzLnNvbHV0ZUFtb3VudFN1bW1hcnlJdGVtLmlubmVyQ29udGVudCA9IHRoaXMuc29sdXRlQW1vdW50RGVzY3JpYmVyLmdldEJlYWtlclNvbHV0ZUFtb3VudFN0cmluZygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogaWYgdGhlIHNvbHV0aW9uIGlzIHNhdHVyYXRlZCwgY3JlYXRlcyBzZWNvbmQgYnVsbGV0IHBvaW50IC0gZS5nLiAnaXMgc2F0dXJhdGVkIHdpdGggYSBmZXcgc29saWRzJy5cclxuICAgKiBPdGhlcndpc2UsIGl0IHJlbW92ZXMgdGhhdCBidWxsZXQgcG9pbnQgZnJvbSB0aGUgbGlzdFxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgdXBkYXRlU2F0dXJhdGlvblN1bW1hcnkoKSB7XHJcbiAgICB0aGlzLnNhdHVyYXRpb25TdW1tYXJ5Q29udGFpbmVyLmNoaWxkcmVuID0gdGhpcy5zb2x1dGlvbi5pc1NhdHVyYXRlZCgpID8gWyB0aGlzLnNhdHVyYXRpb25TdW1tYXJ5SXRlbSBdIDogW107XHJcbiAgICB0aGlzLnNhdHVyYXRpb25TdW1tYXJ5SXRlbS5pbm5lckNvbnRlbnQgPSB0aGlzLnByZWNpcGl0YXRlQW1vdW50RGVzY3JpYmVyLmdldEJlYWtlclNhdHVyYXRpb25TdHJpbmcoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHVwZGF0ZXMgc2Vjb25kL3RoaXJkIChkZXBlbmRpbmcgb24gc2F0dXJhdGlvbiBzdGF0ZSkgYnVsbGV0IC0gZS5nLiAnaGFzIGxvdyBjb25jZW50cmF0aW9uJy5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHVwZGF0ZUNvbmNlbnRyYXRpb25TdW1tYXJ5KCkge1xyXG4gICAgaWYgKCAhdGhpcy5zb2x1dGlvbi5oYXNTb2x1dGUoKSApIHtcclxuICAgICAgdGhpcy5jb25jZW50cmF0aW9uU3VtbWFyeUl0ZW0uaW5uZXJDb250ZW50ID0gYmVha2VySGFzWmVyb0NvbmNlbnRyYXRpb25TdHJpbmc7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgdGhpcy5jb25jZW50cmF0aW9uU3VtbWFyeUl0ZW0uaW5uZXJDb250ZW50ID0gdGhpcy5jb25jZW50cmF0aW9uRGVzY3JpYmVyLmdldEJlYWtlckNvbmNlbnRyYXRpb25TdHJpbmcoXHJcbiAgICAgICAgdGhpcy51c2VRdWFudGl0YXRpdmVEZXNjcmlwdGlvbnNQcm9wZXJ0eSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdXBkYXRlcyB0aGlyZC9mb3VydGggKGRlcGVuZGluZyBvbiBzYXR1cmF0aW9uIHN0YXRlKSBidWxsZXQgLSBlLmcuICdjaGVtaWNhbCBmb3JtdWxhIG9mIHBvdGFzc2l1bSBwZXJtYW5nYW5hdGVcclxuICAgKiBpcyBLTW5PNC4nIElmIHRoZSBzb2x1dGUgaXMgZHJpbmsgbWl4LCB0aGlzIGJ1bGxldCBpcyBub3QgY3JlYXRlZC5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHVwZGF0ZUNoZW1pY2FsRm9ybXVsYVN1bW1hcnkoKSB7XHJcbiAgICBjb25zdCBpc0RyaW5rTWl4ID0gdGhpcy5zb2x1dGVEZXNjcmliZXIuZ2V0Q3VycmVudFNvbHV0ZU5hbWUoIHRydWUgKSA9PT0gZHJpbmtNaXhTdHJpbmc7XHJcbiAgICBpZiAoICF0aGlzLnNvbHV0aW9uLmhhc1NvbHV0ZSgpICkge1xyXG5cclxuICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gc29sdXRlIGluIHRoZSBiZWFrZXIsIHRoZSBjaGVtaWNhbCBmb3JtdWxhIG9mIHdhdGVyIGlzIGRpc3BsYXllZCBpbnN0ZWFkLlxyXG4gICAgICB0aGlzLmNoZW1pY2FsRm9ybXVsYVN1bW1hcnlJdGVtLmlubmVyQ29udGVudCA9IENoZW1VdGlscy50b1N1YnNjcmlwdCggYmVha2VyV2F0ZXJGb3JtdWxhRGVzY3JpcHRpb25TdHJpbmcgKTtcclxuICAgICAgdGhpcy5jaGVtaWNhbEZvcm11bGFTdW1tYXJ5Q29udGFpbmVyLmNoaWxkcmVuID0gWyB0aGlzLmNoZW1pY2FsRm9ybXVsYVN1bW1hcnlJdGVtIF07XHJcblxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoICFpc0RyaW5rTWl4ICkge1xyXG5cclxuICAgICAgLy8gaWYgdGhlcmUgaXMgc29sdXRlIGluIHRoZSBiZWFrZXIgYW5kIHRoZSBzb2x1dGUgaXMgbm90IGRyaW5rIG1peCwgZGlzcGxheXMgdGhlIGNoZW1pY2FsIGZvcm11bGEgb2YgdGhlIHNvbHV0ZS5cclxuICAgICAgdGhpcy5jaGVtaWNhbEZvcm11bGFTdW1tYXJ5SXRlbS5pbm5lckNvbnRlbnQgPSB0aGlzLnNvbHV0ZURlc2NyaWJlci5nZXRCZWFrZXJDaGVtaWNhbEZvcm11bGFTdHJpbmcoKTtcclxuICAgICAgdGhpcy5jaGVtaWNhbEZvcm11bGFTdW1tYXJ5Q29udGFpbmVyLmNoaWxkcmVuID0gWyB0aGlzLmNoZW1pY2FsRm9ybXVsYVN1bW1hcnlJdGVtIF07XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuXHJcbiAgICAgIC8vIGlmIHRoZXJlIGlzIHNvbHV0ZSBpbiB0aGUgYmVha2VyIGFuZCB0aGUgc29sdXRlIGlzIGRyaW5rIG1peCwgbm8gY2hlbWljYWwgZm9ybXVsYSBpcyBkaXNwbGF5ZWRcclxuICAgICAgdGhpcy5jaGVtaWNhbEZvcm11bGFTdW1tYXJ5Q29udGFpbmVyLmNoaWxkcmVuID0gW107XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiB1cGRhdGVzIHRoZSBjb25jZW50cmF0aW9uIHJhbmdlIGJ1bGxldCAtIGUuZy4gJ2NvbmNlbnRyYXRpb24gcmVhZG91dCByYW5nZSAwIHRvIDUuMCBtb2xhci4nXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICB1cGRhdGVDb25jZW50cmF0aW9uUmFuZ2VTdW1tYXJ5KCkge1xyXG4gICAgdGhpcy5jb25jZW50cmF0aW9uUmFuZ2VTdW1tYXJ5SXRlbS5pbm5lckNvbnRlbnQgPSB0aGlzLmNvbmNlbnRyYXRpb25EZXNjcmliZXIuZ2V0Q3VycmVudENvbmNlbnRyYXRpb25SYW5nZUNsYXVzZSgpO1xyXG4gIH1cclxufVxyXG5cclxubW9sYXJpdHkucmVnaXN0ZXIoICdNb2xhcml0eUJlYWtlckRlc2NyaXB0aW9uTm9kZScsIE1vbGFyaXR5QmVha2VyRGVzY3JpcHRpb25Ob2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IE1vbGFyaXR5QmVha2VyRGVzY3JpcHRpb25Ob2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLFNBQVMsTUFBTSwyQ0FBMkM7QUFDakUsT0FBT0MsV0FBVyxNQUFNLCtDQUErQztBQUN2RSxTQUFTQyxJQUFJLFFBQVEsbUNBQW1DO0FBQ3hELE9BQU9DLFFBQVEsTUFBTSxtQkFBbUI7QUFDeEMsT0FBT0MsZUFBZSxNQUFNLDBCQUEwQjtBQUV0RCxNQUFNQyxjQUFjLEdBQUdELGVBQWUsQ0FBQ0UsUUFBUTtBQUUvQyxNQUFNQyw4QkFBOEIsR0FBR0gsZUFBZSxDQUFDSSxJQUFJLENBQUNDLE1BQU0sQ0FBQ0Msa0JBQWtCO0FBQ3JGLE1BQU1DLGdDQUFnQyxHQUFHUCxlQUFlLENBQUNJLElBQUksQ0FBQ0MsTUFBTSxDQUFDRyxvQkFBb0I7QUFDekYsTUFBTUMsdUNBQXVDLEdBQUdULGVBQWUsQ0FBQ0ksSUFBSSxDQUFDQyxNQUFNLENBQUNLLDJCQUEyQjtBQUN2RyxNQUFNQyxxQkFBcUIsR0FBR1gsZUFBZSxDQUFDSSxJQUFJLENBQUNDLE1BQU0sQ0FBQ08sU0FBUztBQUNuRSxNQUFNQyxtQ0FBbUMsR0FBR2IsZUFBZSxDQUFDSSxJQUFJLENBQUNDLE1BQU0s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