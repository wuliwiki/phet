// Copyright 2021-2023, University of Colorado Boulder

/**
 * A view component for one of the vertices of the Quadrilateral.
 *
 * @author Jesse Greenberg
 */

import { Circle, DragListener, KeyboardDragListener, Path, Text } from '../../../../scenery/js/imports.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Shape } from '../../../../kite/js/imports.js';
import QuadrilateralConstants from '../../QuadrilateralConstants.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import grabHighPitch_mp3 from '../../../sounds/grabHighPitch_mp3.js';
import boundaryReached_mp3 from '../../../../tambo/sounds/boundaryReached_mp3.js';
import soundManager from '../../../../tambo/js/soundManager.js';
import quadrilateral from '../../quadrilateral.js';
import QuadrilateralMovableNode from './QuadrilateralMovableNode.js';
import optionize from '../../../../phet-core/js/optionize.js';
// constants
const LABEL_TEXT_FONT = new PhetFont({
  size: 16,
  weight: 'bold'
});
// Reusable map that saves proposed vertex positions, to avoid excessive garbage.
const scratchLabelToPositionMap = new Map();
export default class QuadrilateralVertexNode extends QuadrilateralMovableNode {
  constructor(vertex, vertexLabel, quadrilateralModel, vertexDescriber, modelViewTransform, providedOptions) {
    const options = optionize()({
      grabbedSound: grabHighPitch_mp3
    }, providedOptions);
    const viewRadius = modelViewTransform.modelToViewBounds(vertex.modelBoundsProperty.value).width / 2;
    const circle = new Circle(viewRadius);
    super(vertex, modelViewTransform, circle, options);
    this.vertex = vertex;
    this.quadrilateralModel = quadrilateralModel;
    const vertexLabelText = new Text(vertexLabel, {
      font: LABEL_TEXT_FONT,
      visibleProperty: quadrilateralModel.visibilityModel.vertexLabelsVisibleProperty,
      // i18n
      maxWidth: 12 // by inspection
    });

    this.addChild(vertexLabelText);

    // Add hatch marks to make it easier to align a vertex with the background grid
    const hatchMarkShape = new Shape();
    let angle = 0;
    while (angle <= 2 * Math.PI) {
      hatchMarkShape.moveTo(Math.cos(angle) * viewRadius * 3 / 4, Math.sin(angle) * viewRadius * 3 / 4);
      hatchMarkShape.lineTo(Math.cos(angle) * viewRadius, Math.sin(angle) * viewRadius);
      angle += Math.PI / 2;
    }
    const hatchMarkPath = new Path(hatchMarkShape, {
      stroke: 'black',
      // hatch marks are used to align with grid, so they are only visible when grid is visible
      visibleProperty: quadrilateralModel.visibilityModel.gridVisibleProperty
    });
    this.addChild(hatchMarkPath);
    quadrilateralModel.visibilityModel.gridVisibleProperty.link(visible => {
      hatchMarkPath.visible = visible;
    });

    // Expand the pointer areas a bit so that it is difficult to accidentally pick up a side when near the vertex edge
    this.touchArea = Shape.circle(viewRadius + QuadrilateralConstants.POINTER_AREA_DILATION);
    this.mouseArea = this.touchArea;
    vertex.positionProperty.link(position => {
      this.center = modelViewTransform.modelToViewPosition(position);
    });

    // dynamic string layout
    vertexLabelText.boundsProperty.link(() => {
      vertexLabelText.center = circle.center;
    });
    const keyboardDragListener = new KeyboardDragListener({
      dragDelta: this.largeViewDragDelta,
      shiftDragDelta: this.smallViewDragDelta,
      transform: modelViewTransform,
      drag: modelDelta => {
        const proposedPosition = quadrilateralModel.getClosestGridPositionInDirection(vertex.positionProperty.value, modelDelta);

        // constrain to model bounds
        const inBoundsPosition = quadrilateralModel.vertexDragBounds.closestPointTo(proposedPosition);
        const isAgainstBounds = !inBoundsPosition.equals(proposedPosition);
        scratchLabelToPositionMap.clear();
        scratchLabelToPositionMap.set(vertex.vertexLabel, inBoundsPosition);
        const isPositionAllowed = quadrilateralModel.areVertexPositionsAllowed(scratchLabelToPositionMap);
        if (isPositionAllowed) {
          // only update and trigger a new Voicing response if the position has changed.
          if (!vertex.positionProperty.value.equals(inBoundsPosition)) {
            vertex.voicingObjectResponseDirty = true;
            vertex.positionProperty.value = inBoundsPosition;
          }
        }
        this.updateBlockedState(!isPositionAllowed, isAgainstBounds);
      },
      moveOnHoldDelay: 750,
      moveOnHoldInterval: 50,
      tandem: providedOptions?.tandem.createTandem('keyboardDragListener')
    });
    this.addInputListener(keyboardDragListener);

    // Position on drag start, in model coordinate frame.
    let startPosition;
    const dragListener = new DragListener({
      transform: modelViewTransform,
      start: event => {
        const pointerPoint = event.pointer.point;
        const parentPoint = this.globalToParentPoint(pointerPoint);
        startPosition = modelViewTransform.viewToModelPosition(parentPoint);
      },
      drag: (event, listener) => {
        const pointerPoint = event.pointer.point;
        const parentPoint = this.globalToParentPoint(pointerPoint);
        const modelPoint = modelViewTransform.viewToModelPosition(parentPoint);

        // constrain to model bounds
        const inBoundsPosition = quadrilateralModel.vertexDragBounds.closestPointTo(modelPoint);
        const isAgainstBounds = !inBoundsPosition.equals(modelPoint);

        // constrain to the allowable positions in the model along the grid
        // const constrainedPosition = quadrilateralModel.getClosestGridPosition( inBoundsPosition );
        const constrainedPosition = quadrilateralModel.getClosestGridPositionAlongDiagonal(vertex.positionProperty.value, inBoundsPosition);
        scratchLabelToPositionMap.clear();
        scratchLabelToPositionMap.set(vertex.vertexLabel, constrainedPosition);
        const isPositionAllowed = quadrilateralModel.areVertexPositionsAllowed(scratchLabelToPositionMap);
        if (isPositionAllowed) {
          vertex.positionProperty.value = constrainedPosition;
        }
        this.updateBlockedState(!isPositionAllowed, isAgainstBounds);
      },
      end: event => {
        // event may be null if interupted or cancelled
        if (event) {
          const pointerPoint = event.pointer.point;
          const parentPoint = this.globalToParentPoint(pointerPoint);
          const endPosition = modelViewTransform.viewToModelPosition(parentPoint);
          if (startPosition.equals(endPosition)) {
            this.voicingSpeakFullResponse();
          }
        }
      },
      tandem: providedOptions?.tandem.createTandem('dragListener')
    });
    this.addInputListener(dragListener);

    // notify when this vertex is pressed
    dragListener.isPressedProperty.link(isPressed => vertex.isPressedProperty.set(isPressed));

    // I am not sure if the isPressedProperty should be set here, but it may not be necessary. It should probably be set by the
    // KeyboardDragListener on start/end drag, or the KeyboardDRagListener should
    // have its own isPressedProperty to match the API of the DragListener.
    this.addInputListener({
      focus: () => {
        vertex.isPressedProperty.value = true;
      },
      blur: () => {
        vertex.isPressedProperty.value = false;
      }
    });

    // sound - when the QuadrilateralVertex becomes blocked because of collision with model bounds, play a unique sound
    const blockedByBoundsSoundClip = new SoundClip(boundaryReached_mp3, {
      initialOutputLevel: 1.0
    });
    soundManager.addSoundGenerator(blockedByBoundsSoundClip);
    vertex.numberOfConstrainingEdgesProperty.link((constrainingEdges, oldConstrainingEdges) => {
      if (oldConstrainingEdges !== null && constrainingEdges > oldConstrainingEdges) {
        blockedByBoundsSoundClip.play();
        this.voicingSpeakResponse({
          contextResponse: vertexDescriber.getBlockedByEdgeResponse(),
          utterance: this.blockedUtterance
        });
      }
    });

    // voicing
    quadrilateralModel.quadrilateralShapeModel.shapeChangedEmitter.addListener(() => {
      this.voicingObjectResponse = vertexDescriber.getVertexObjectResponse();
    });

    // when corner guides are visible more information is also included in the object response
    quadrilateralModel.visibilityModel.markersVisibleProperty.link(visible => {
      this.voicingObjectResponse = vertexDescriber.getVertexObjectResponse();
    });
  }
}
quadrilateral.register('QuadrilateralVertexNode', QuadrilateralVertexNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDaXJjbGUiLCJEcmFnTGlzdGVuZXIiLCJLZXlib2FyZERyYWdMaXN0ZW5lciIsIlBhdGgiLCJUZXh0IiwiUGhldEZvbnQiLCJTaGFwZSIsIlF1YWRyaWxhdGVyYWxDb25zdGFudHMiLCJTb3VuZENsaXAiLCJncmFiSGlnaFBpdGNoX21wMyIsImJvdW5kYXJ5UmVhY2hlZF9tcDMiLCJzb3VuZE1hbmFnZXIiLCJxdWFkcmlsYXRlcmFsIiwiUXVhZHJpbGF0ZXJhbE1vdmFibGVOb2RlIiwib3B0aW9uaXplIiwiTEFCRUxfVEVYVF9GT05UIiwic2l6ZSIsIndlaWdodCIsInNjcmF0Y2hMYWJlbFRvUG9zaXRpb25NYXAiLCJNYXAiLCJRdWFkcmlsYXRlcmFsVmVydGV4Tm9kZSIsImNvbnN0cnVjdG9yIiwidmVydGV4IiwidmVydGV4TGFiZWwiLCJxdWFkcmlsYXRlcmFsTW9kZWwiLCJ2ZXJ0ZXhEZXNjcmliZXIiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZ3JhYmJlZFNvdW5kIiwidmlld1JhZGl1cyIsIm1vZGVsVG9WaWV3Qm91bmRzIiwibW9kZWxCb3VuZHNQcm9wZXJ0eSIsInZhbHVlIiwid2lkdGgiLCJjaXJjbGUiLCJ2ZXJ0ZXhMYWJlbFRleHQiLCJmb250IiwidmlzaWJsZVByb3BlcnR5IiwidmlzaWJpbGl0eU1vZGVsIiwidmVydGV4TGFiZWxzVmlzaWJsZVByb3BlcnR5IiwibWF4V2lkdGgiLCJhZGRDaGlsZCIsImhhdGNoTWFya1NoYXBlIiwiYW5nbGUiLCJNYXRoIiwiUEkiLCJtb3ZlVG8iLCJjb3MiLCJzaW4iLCJsaW5lVG8iLCJoYXRjaE1hcmtQYXRoIiwic3Ryb2tlIiwiZ3JpZFZpc2libGVQcm9wZXJ0eSIsImxpbmsiLCJ2aXNpYmxlIiwidG91Y2hBcmVhIiwiUE9JTlRFUl9BUkVBX0RJTEFUSU9OIiwibW91c2VBcmVhIiwicG9zaXRpb25Qcm9wZXJ0eSIsInBvc2l0aW9uIiwiY2VudGVyIiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsImJvdW5kc1Byb3BlcnR5Iiwia2V5Ym9hcmREcmFnTGlzdGVuZXIiLCJkcmFnRGVsdGEiLCJsYXJnZVZpZXdEcmFnRGVsdGEiLCJzaGlmdERyYWdEZWx0YSIsInNtYWxsVmlld0RyYWdEZWx0YSIsInRyYW5zZm9ybSIsImRyYWciLCJtb2RlbERlbHRhIiwicHJvcG9zZWRQb3NpdGlvbiIsImdldENsb3Nlc3RHcmlkUG9zaXRpb25JbkRpcmVjdGlvbiIsImluQm91bmRzUG9zaXRpb24iLCJ2ZXJ0ZXhEcmFnQm91bmRzIiwiY2xvc2VzdFBvaW50VG8iLCJpc0FnYWluc3RCb3VuZHMiLCJlcXVhbHMiLCJjbGVhciIsInNldCIsImlzUG9zaXRpb25BbGxvd2VkIiwiYXJlVmVydGV4UG9zaXRpb25zQWxsb3dlZCIsInZvaWNpbmdPYmplY3RSZXNwb25zZURpcnR5IiwidXBkYXRlQmxvY2tlZFN0YXRlIiwibW92ZU9uSG9sZERlbGF5IiwibW92ZU9uSG9sZEludGVydmFsIiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwiYWRkSW5wdXRMaXN0ZW5lciIsInN0YXJ0UG9zaXRpb24iLCJkcmFnTGlzdGVuZXIiLCJzdGFydCIsImV2ZW50IiwicG9pbnRlclBvaW50IiwicG9pbnRlciIsInBvaW50IiwicGFyZW50UG9pbnQiLCJnbG9iYWxUb1BhcmVudFBvaW50Iiwidmlld1RvTW9kZWxQb3NpdGlvbiIsImxpc3RlbmVyIiwibW9kZWxQb2ludCIsImNvbnN0cmFpbmVkUG9zaXRpb24iLCJnZXRDbG9zZXN0R3JpZFBvc2l0aW9uQWxvbmdEaWFnb25hbCIsImVuZCIsImVuZFBvc2l0aW9uIiwidm9pY2luZ1NwZWFrRnVsbFJlc3BvbnNlIiwiaXNQcmVzc2VkUHJvcGVydHkiLCJpc1ByZXNzZWQiLCJmb2N1cyIsImJsdXIiLCJibG9ja2VkQnlCb3VuZHNTb3VuZENsaXAiLCJpbml0aWFsT3V0cHV0TGV2ZWwiLCJhZGRTb3VuZEdlbmVyYXRvciIsIm51bWJlck9mQ29uc3RyYWluaW5nRWRnZXNQcm9wZXJ0eSIsImNvbnN0cmFpbmluZ0VkZ2VzIiwib2xkQ29uc3RyYWluaW5nRWRnZXMiLCJwbGF5Iiwidm9pY2luZ1NwZWFrUmVzcG9uc2UiLCJjb250ZXh0UmVzcG9uc2UiLCJnZXRCbG9ja2VkQnlFZGdlUmVzcG9uc2UiLCJ1dHRlcmFuY2UiLCJibG9ja2VkVXR0ZXJhbmNlIiwicXVhZHJpbGF0ZXJhbFNoYXBlTW9kZWwiLCJzaGFwZUNoYW5nZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJ2b2ljaW5nT2JqZWN0UmVzcG9uc2UiLCJnZXRWZXJ0ZXhPYmplY3RSZXNwb25zZSIsIm1hcmtlcnNWaXNpYmxlUHJvcGVydHkiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlF1YWRyaWxhdGVyYWxWZXJ0ZXhOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgdmlldyBjb21wb25lbnQgZm9yIG9uZSBvZiB0aGUgdmVydGljZXMgb2YgdGhlIFF1YWRyaWxhdGVyYWwuXHJcbiAqXHJcbiAqIEBhdXRob3IgSmVzc2UgR3JlZW5iZXJnXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgQ2lyY2xlLCBEcmFnTGlzdGVuZXIsIEtleWJvYXJkRHJhZ0xpc3RlbmVyLCBQYXRoLCBTY2VuZXJ5RXZlbnQsIFRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsVmVydGV4IGZyb20gJy4uL21vZGVsL1F1YWRyaWxhdGVyYWxWZXJ0ZXguanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsTW9kZWwgZnJvbSAnLi4vbW9kZWwvUXVhZHJpbGF0ZXJhbE1vZGVsLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsVmVydGV4RGVzY3JpYmVyIGZyb20gJy4vUXVhZHJpbGF0ZXJhbFZlcnRleERlc2NyaWJlci5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxDb25zdGFudHMgZnJvbSAnLi4vLi4vUXVhZHJpbGF0ZXJhbENvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBTb3VuZENsaXAgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvc291bmQtZ2VuZXJhdG9ycy9Tb3VuZENsaXAuanMnO1xyXG5pbXBvcnQgZ3JhYkhpZ2hQaXRjaF9tcDMgZnJvbSAnLi4vLi4vLi4vc291bmRzL2dyYWJIaWdoUGl0Y2hfbXAzLmpzJztcclxuaW1wb3J0IGJvdW5kYXJ5UmVhY2hlZF9tcDMgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vc291bmRzL2JvdW5kYXJ5UmVhY2hlZF9tcDMuanMnO1xyXG5pbXBvcnQgc291bmRNYW5hZ2VyIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kTWFuYWdlci5qcyc7XHJcbmltcG9ydCBxdWFkcmlsYXRlcmFsIGZyb20gJy4uLy4uL3F1YWRyaWxhdGVyYWwuanMnO1xyXG5pbXBvcnQgUXVhZHJpbGF0ZXJhbE1vdmFibGVOb2RlLCB7IFF1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZU9wdGlvbnMgfSBmcm9tICcuL1F1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZS5qcyc7XHJcbmltcG9ydCBTdHJpY3RPbWl0IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9TdHJpY3RPbWl0LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgVmVydGV4TGFiZWxUb1Byb3Bvc2VkUG9zaXRpb25NYXAgfSBmcm9tICcuLi9tb2RlbC9RdWFkcmlsYXRlcmFsU2hhcGVNb2RlbC5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgTEFCRUxfVEVYVF9GT05UID0gbmV3IFBoZXRGb250KCB7IHNpemU6IDE2LCB3ZWlnaHQ6ICdib2xkJyB9ICk7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0gRW1wdHlTZWxmT3B0aW9ucztcclxudHlwZSBWZXJ0ZXhOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgU3RyaWN0T21pdDxRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGVPcHRpb25zLCAnZ3JhYmJlZFNvdW5kJz47XHJcblxyXG4vLyBSZXVzYWJsZSBtYXAgdGhhdCBzYXZlcyBwcm9wb3NlZCB2ZXJ0ZXggcG9zaXRpb25zLCB0byBhdm9pZCBleGNlc3NpdmUgZ2FyYmFnZS5cclxuY29uc3Qgc2NyYXRjaExhYmVsVG9Qb3NpdGlvbk1hcDogVmVydGV4TGFiZWxUb1Byb3Bvc2VkUG9zaXRpb25NYXAgPSBuZXcgTWFwKCk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRdWFkcmlsYXRlcmFsVmVydGV4Tm9kZSBleHRlbmRzIFF1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBxdWFkcmlsYXRlcmFsTW9kZWw6IFF1YWRyaWxhdGVyYWxNb2RlbDtcclxuICBwcml2YXRlIHJlYWRvbmx5IHZlcnRleDogUXVhZHJpbGF0ZXJhbFZlcnRleDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB2ZXJ0ZXg6IFF1YWRyaWxhdGVyYWxWZXJ0ZXgsIHZlcnRleExhYmVsOiBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmc+LCBxdWFkcmlsYXRlcmFsTW9kZWw6IFF1YWRyaWxhdGVyYWxNb2RlbCwgdmVydGV4RGVzY3JpYmVyOiBRdWFkcmlsYXRlcmFsVmVydGV4RGVzY3JpYmVyLCBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsIHByb3ZpZGVkT3B0aW9ucz86IFZlcnRleE5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8VmVydGV4Tm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGVPcHRpb25zPigpKCB7XHJcbiAgICAgIGdyYWJiZWRTb3VuZDogZ3JhYkhpZ2hQaXRjaF9tcDNcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHZpZXdSYWRpdXMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdCb3VuZHMoIHZlcnRleC5tb2RlbEJvdW5kc1Byb3BlcnR5LnZhbHVlICkud2lkdGggLyAyO1xyXG4gICAgY29uc3QgY2lyY2xlID0gbmV3IENpcmNsZSggdmlld1JhZGl1cyApO1xyXG4gICAgc3VwZXIoIHZlcnRleCwgbW9kZWxWaWV3VHJhbnNmb3JtLCBjaXJjbGUsIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLnZlcnRleCA9IHZlcnRleDtcclxuICAgIHRoaXMucXVhZHJpbGF0ZXJhbE1vZGVsID0gcXVhZHJpbGF0ZXJhbE1vZGVsO1xyXG5cclxuICAgIGNvbnN0IHZlcnRleExhYmVsVGV4dCA9IG5ldyBUZXh0KCB2ZXJ0ZXhMYWJlbCwge1xyXG4gICAgICBmb250OiBMQUJFTF9URVhUX0ZPTlQsXHJcbiAgICAgIHZpc2libGVQcm9wZXJ0eTogcXVhZHJpbGF0ZXJhbE1vZGVsLnZpc2liaWxpdHlNb2RlbC52ZXJ0ZXhMYWJlbHNWaXNpYmxlUHJvcGVydHksXHJcblxyXG4gICAgICAvLyBpMThuXHJcbiAgICAgIG1heFdpZHRoOiAxMiAvLyBieSBpbnNwZWN0aW9uXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB2ZXJ0ZXhMYWJlbFRleHQgKTtcclxuXHJcbiAgICAvLyBBZGQgaGF0Y2ggbWFya3MgdG8gbWFrZSBpdCBlYXNpZXIgdG8gYWxpZ24gYSB2ZXJ0ZXggd2l0aCB0aGUgYmFja2dyb3VuZCBncmlkXHJcbiAgICBjb25zdCBoYXRjaE1hcmtTaGFwZSA9IG5ldyBTaGFwZSgpO1xyXG4gICAgbGV0IGFuZ2xlID0gMDtcclxuICAgIHdoaWxlICggYW5nbGUgPD0gMiAqIE1hdGguUEkgKSB7XHJcbiAgICAgIGhhdGNoTWFya1NoYXBlLm1vdmVUbyggTWF0aC5jb3MoIGFuZ2xlICkgKiB2aWV3UmFkaXVzICogMyAvIDQsIE1hdGguc2luKCBhbmdsZSApICogdmlld1JhZGl1cyAqIDMgLyA0ICk7XHJcbiAgICAgIGhhdGNoTWFya1NoYXBlLmxpbmVUbyggTWF0aC5jb3MoIGFuZ2xlICkgKiB2aWV3UmFkaXVzLCBNYXRoLnNpbiggYW5nbGUgKSAqIHZpZXdSYWRpdXMgKTtcclxuICAgICAgYW5nbGUgKz0gTWF0aC5QSSAvIDI7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaGF0Y2hNYXJrUGF0aCA9IG5ldyBQYXRoKCBoYXRjaE1hcmtTaGFwZSwge1xyXG4gICAgICBzdHJva2U6ICdibGFjaycsXHJcblxyXG4gICAgICAvLyBoYXRjaCBtYXJrcyBhcmUgdXNlZCB0byBhbGlnbiB3aXRoIGdyaWQsIHNvIHRoZXkgYXJlIG9ubHkgdmlzaWJsZSB3aGVuIGdyaWQgaXMgdmlzaWJsZVxyXG4gICAgICB2aXNpYmxlUHJvcGVydHk6IHF1YWRyaWxhdGVyYWxNb2RlbC52aXNpYmlsaXR5TW9kZWwuZ3JpZFZpc2libGVQcm9wZXJ0eVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggaGF0Y2hNYXJrUGF0aCApO1xyXG5cclxuICAgIHF1YWRyaWxhdGVyYWxNb2RlbC52aXNpYmlsaXR5TW9kZWwuZ3JpZFZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHtcclxuICAgICAgaGF0Y2hNYXJrUGF0aC52aXNpYmxlID0gdmlzaWJsZTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBFeHBhbmQgdGhlIHBvaW50ZXIgYXJlYXMgYSBiaXQgc28gdGhhdCBpdCBpcyBkaWZmaWN1bHQgdG8gYWNjaWRlbnRhbGx5IHBpY2sgdXAgYSBzaWRlIHdoZW4gbmVhciB0aGUgdmVydGV4IGVkZ2VcclxuICAgIHRoaXMudG91Y2hBcmVhID0gU2hhcGUuY2lyY2xlKCB2aWV3UmFkaXVzICsgUXVhZHJpbGF0ZXJhbENvbnN0YW50cy5QT0lOVEVSX0FSRUFfRElMQVRJT04gKTtcclxuICAgIHRoaXMubW91c2VBcmVhID0gdGhpcy50b3VjaEFyZWE7XHJcblxyXG4gICAgdmVydGV4LnBvc2l0aW9uUHJvcGVydHkubGluayggcG9zaXRpb24gPT4ge1xyXG4gICAgICB0aGlzLmNlbnRlciA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCBwb3NpdGlvbiApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGR5bmFtaWMgc3RyaW5nIGxheW91dFxyXG4gICAgdmVydGV4TGFiZWxUZXh0LmJvdW5kc1Byb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgdmVydGV4TGFiZWxUZXh0LmNlbnRlciA9IGNpcmNsZS5jZW50ZXI7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qga2V5Ym9hcmREcmFnTGlzdGVuZXIgPSBuZXcgS2V5Ym9hcmREcmFnTGlzdGVuZXIoIHtcclxuICAgICAgZHJhZ0RlbHRhOiB0aGlzLmxhcmdlVmlld0RyYWdEZWx0YSxcclxuICAgICAgc2hpZnREcmFnRGVsdGE6IHRoaXMuc21hbGxWaWV3RHJhZ0RlbHRhLFxyXG5cclxuICAgICAgdHJhbnNmb3JtOiBtb2RlbFZpZXdUcmFuc2Zvcm0sXHJcbiAgICAgIGRyYWc6ICggbW9kZWxEZWx0YTogVmVjdG9yMiApID0+IHtcclxuICAgICAgICBjb25zdCBwcm9wb3NlZFBvc2l0aW9uID0gcXVhZHJpbGF0ZXJhbE1vZGVsLmdldENsb3Nlc3RHcmlkUG9zaXRpb25JbkRpcmVjdGlvbiggdmVydGV4LnBvc2l0aW9uUHJvcGVydHkudmFsdWUsIG1vZGVsRGVsdGEgKTtcclxuXHJcbiAgICAgICAgLy8gY29uc3RyYWluIHRvIG1vZGVsIGJvdW5kc1xyXG4gICAgICAgIGNvbnN0IGluQm91bmRzUG9zaXRpb24gPSBxdWFkcmlsYXRlcmFsTW9kZWwudmVydGV4RHJhZ0JvdW5kcy5jbG9zZXN0UG9pbnRUbyggcHJvcG9zZWRQb3NpdGlvbiApO1xyXG4gICAgICAgIGNvbnN0IGlzQWdhaW5zdEJvdW5kcyA9ICFpbkJvdW5kc1Bvc2l0aW9uLmVxdWFscyggcHJvcG9zZWRQb3NpdGlvbiApO1xyXG5cclxuICAgICAgICBzY3JhdGNoTGFiZWxUb1Bvc2l0aW9uTWFwLmNsZWFyKCk7XHJcbiAgICAgICAgc2NyYXRjaExhYmVsVG9Qb3NpdGlvbk1hcC5zZXQoIHZlcnRleC52ZXJ0ZXhMYWJlbCwgaW5Cb3VuZHNQb3NpdGlvbiApO1xyXG4gICAgICAgIGNvbnN0IGlzUG9zaXRpb25BbGxvd2VkID0gcXVhZHJpbGF0ZXJhbE1vZGVsLmFyZVZlcnRleFBvc2l0aW9uc0FsbG93ZWQoIHNjcmF0Y2hMYWJlbFRvUG9zaXRpb25NYXAgKTtcclxuICAgICAgICBpZiAoIGlzUG9zaXRpb25BbGxvd2VkICkge1xyXG5cclxuICAgICAgICAgIC8vIG9ubHkgdXBkYXRlIGFuZCB0cmlnZ2VyIGEgbmV3IFZvaWNpbmcgcmVzcG9uc2UgaWYgdGhlIHBvc2l0aW9uIGhhcyBjaGFuZ2VkLlxyXG4gICAgICAgICAgaWYgKCAhdmVydGV4LnBvc2l0aW9uUHJvcGVydHkudmFsdWUuZXF1YWxzKCBpbkJvdW5kc1Bvc2l0aW9uICkgKSB7XHJcbiAgICAgICAgICAgIHZlcnRleC52b2ljaW5nT2JqZWN0UmVzcG9uc2VEaXJ0eSA9IHRydWU7XHJcbiAgICAgICAgICAgIHZlcnRleC5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gaW5Cb3VuZHNQb3NpdGlvbjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlQmxvY2tlZFN0YXRlKCAhaXNQb3NpdGlvbkFsbG93ZWQsIGlzQWdhaW5zdEJvdW5kcyApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgbW92ZU9uSG9sZERlbGF5OiA3NTAsXHJcbiAgICAgIG1vdmVPbkhvbGRJbnRlcnZhbDogNTAsXHJcblxyXG4gICAgICB0YW5kZW06IHByb3ZpZGVkT3B0aW9ucz8udGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2tleWJvYXJkRHJhZ0xpc3RlbmVyJyApXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIGtleWJvYXJkRHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgLy8gUG9zaXRpb24gb24gZHJhZyBzdGFydCwgaW4gbW9kZWwgY29vcmRpbmF0ZSBmcmFtZS5cclxuICAgIGxldCBzdGFydFBvc2l0aW9uOiBWZWN0b3IyO1xyXG4gICAgY29uc3QgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICB0cmFuc2Zvcm06IG1vZGVsVmlld1RyYW5zZm9ybSxcclxuICAgICAgc3RhcnQ6IGV2ZW50ID0+IHtcclxuICAgICAgICBjb25zdCBwb2ludGVyUG9pbnQgPSBldmVudC5wb2ludGVyLnBvaW50O1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFBvaW50ID0gdGhpcy5nbG9iYWxUb1BhcmVudFBvaW50KCBwb2ludGVyUG9pbnQgKTtcclxuICAgICAgICBzdGFydFBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGRyYWc6ICggZXZlbnQ6IFNjZW5lcnlFdmVudCwgbGlzdGVuZXI6IERyYWdMaXN0ZW5lciApID0+IHtcclxuICAgICAgICBjb25zdCBwb2ludGVyUG9pbnQgPSBldmVudC5wb2ludGVyLnBvaW50O1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFBvaW50ID0gdGhpcy5nbG9iYWxUb1BhcmVudFBvaW50KCBwb2ludGVyUG9pbnQgKTtcclxuICAgICAgICBjb25zdCBtb2RlbFBvaW50ID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcblxyXG4gICAgICAgIC8vIGNvbnN0cmFpbiB0byBtb2RlbCBib3VuZHNcclxuICAgICAgICBjb25zdCBpbkJvdW5kc1Bvc2l0aW9uID0gcXVhZHJpbGF0ZXJhbE1vZGVsLnZlcnRleERyYWdCb3VuZHMuY2xvc2VzdFBvaW50VG8oIG1vZGVsUG9pbnQgKTtcclxuICAgICAgICBjb25zdCBpc0FnYWluc3RCb3VuZHMgPSAhaW5Cb3VuZHNQb3NpdGlvbi5lcXVhbHMoIG1vZGVsUG9pbnQgKTtcclxuXHJcbiAgICAgICAgLy8gY29uc3RyYWluIHRvIHRoZSBhbGxvd2FibGUgcG9zaXRpb25zIGluIHRoZSBtb2RlbCBhbG9uZyB0aGUgZ3JpZFxyXG4gICAgICAgIC8vIGNvbnN0IGNvbnN0cmFpbmVkUG9zaXRpb24gPSBxdWFkcmlsYXRlcmFsTW9kZWwuZ2V0Q2xvc2VzdEdyaWRQb3NpdGlvbiggaW5Cb3VuZHNQb3NpdGlvbiApO1xyXG4gICAgICAgIGNvbnN0IGNvbnN0cmFpbmVkUG9zaXRpb24gPSBxdWFkcmlsYXRlcmFsTW9kZWwuZ2V0Q2xvc2VzdEdyaWRQb3NpdGlvbkFsb25nRGlhZ29uYWwoIHZlcnRleC5wb3NpdGlvblByb3BlcnR5LnZhbHVlLCBpbkJvdW5kc1Bvc2l0aW9uICk7XHJcblxyXG4gICAgICAgIHNjcmF0Y2hMYWJlbFRvUG9zaXRpb25NYXAuY2xlYXIoKTtcclxuICAgICAgICBzY3JhdGNoTGFiZWxUb1Bvc2l0aW9uTWFwLnNldCggdmVydGV4LnZlcnRleExhYmVsLCBjb25zdHJhaW5lZFBvc2l0aW9uICk7XHJcbiAgICAgICAgY29uc3QgaXNQb3NpdGlvbkFsbG93ZWQgPSBxdWFkcmlsYXRlcmFsTW9kZWwuYXJlVmVydGV4UG9zaXRpb25zQWxsb3dlZCggc2NyYXRjaExhYmVsVG9Qb3NpdGlvbk1hcCApO1xyXG5cclxuICAgICAgICBpZiAoIGlzUG9zaXRpb25BbGxvd2VkICkge1xyXG4gICAgICAgICAgdmVydGV4LnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBjb25zdHJhaW5lZFBvc2l0aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGVCbG9ja2VkU3RhdGUoICFpc1Bvc2l0aW9uQWxsb3dlZCwgaXNBZ2FpbnN0Qm91bmRzICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGVuZDogZXZlbnQgPT4ge1xyXG5cclxuICAgICAgICAvLyBldmVudCBtYXkgYmUgbnVsbCBpZiBpbnRlcnVwdGVkIG9yIGNhbmNlbGxlZFxyXG4gICAgICAgIGlmICggZXZlbnQgKSB7XHJcbiAgICAgICAgICBjb25zdCBwb2ludGVyUG9pbnQgPSBldmVudC5wb2ludGVyLnBvaW50O1xyXG4gICAgICAgICAgY29uc3QgcGFyZW50UG9pbnQgPSB0aGlzLmdsb2JhbFRvUGFyZW50UG9pbnQoIHBvaW50ZXJQb2ludCApO1xyXG4gICAgICAgICAgY29uc3QgZW5kUG9zaXRpb24gPSBtb2RlbFZpZXdUcmFuc2Zvcm0udmlld1RvTW9kZWxQb3NpdGlvbiggcGFyZW50UG9pbnQgKTtcclxuXHJcbiAgICAgICAgICBpZiAoIHN0YXJ0UG9zaXRpb24uZXF1YWxzKCBlbmRQb3NpdGlvbiApICkge1xyXG4gICAgICAgICAgICB0aGlzLnZvaWNpbmdTcGVha0Z1bGxSZXNwb25zZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuXHJcbiAgICAgIHRhbmRlbTogcHJvdmlkZWRPcHRpb25zPy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZHJhZ0xpc3RlbmVyJyApXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIGRyYWdMaXN0ZW5lciApO1xyXG5cclxuICAgIC8vIG5vdGlmeSB3aGVuIHRoaXMgdmVydGV4IGlzIHByZXNzZWRcclxuICAgIGRyYWdMaXN0ZW5lci5pc1ByZXNzZWRQcm9wZXJ0eS5saW5rKCBpc1ByZXNzZWQgPT4gdmVydGV4LmlzUHJlc3NlZFByb3BlcnR5LnNldCggaXNQcmVzc2VkICkgKTtcclxuXHJcbiAgICAvLyBJIGFtIG5vdCBzdXJlIGlmIHRoZSBpc1ByZXNzZWRQcm9wZXJ0eSBzaG91bGQgYmUgc2V0IGhlcmUsIGJ1dCBpdCBtYXkgbm90IGJlIG5lY2Vzc2FyeS4gSXQgc2hvdWxkIHByb2JhYmx5IGJlIHNldCBieSB0aGVcclxuICAgIC8vIEtleWJvYXJkRHJhZ0xpc3RlbmVyIG9uIHN0YXJ0L2VuZCBkcmFnLCBvciB0aGUgS2V5Ym9hcmREUmFnTGlzdGVuZXIgc2hvdWxkXHJcbiAgICAvLyBoYXZlIGl0cyBvd24gaXNQcmVzc2VkUHJvcGVydHkgdG8gbWF0Y2ggdGhlIEFQSSBvZiB0aGUgRHJhZ0xpc3RlbmVyLlxyXG4gICAgdGhpcy5hZGRJbnB1dExpc3RlbmVyKCB7XHJcbiAgICAgIGZvY3VzOiAoKSA9PiB7XHJcbiAgICAgICAgdmVydGV4LmlzUHJlc3NlZFByb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuICAgICAgfSxcclxuICAgICAgYmx1cjogKCkgPT4ge1xyXG4gICAgICAgIHZlcnRleC5pc1ByZXNzZWRQcm9wZXJ0eS52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gc291bmQgLSB3aGVuIHRoZSBRdWFkcmlsYXRlcmFsVmVydGV4IGJlY29tZXMgYmxvY2tlZCBiZWNhdXNlIG9mIGNvbGxpc2lvbiB3aXRoIG1vZGVsIGJvdW5kcywgcGxheSBhIHVuaXF1ZSBzb3VuZFxyXG4gICAgY29uc3QgYmxvY2tlZEJ5Qm91bmRzU291bmRDbGlwID0gbmV3IFNvdW5kQ2xpcCggYm91bmRhcnlSZWFjaGVkX21wMywge1xyXG4gICAgICBpbml0aWFsT3V0cHV0TGV2ZWw6IDEuMFxyXG4gICAgfSApO1xyXG4gICAgc291bmRNYW5hZ2VyLmFkZFNvdW5kR2VuZXJhdG9yKCBibG9ja2VkQnlCb3VuZHNTb3VuZENsaXAgKTtcclxuICAgIHZlcnRleC5udW1iZXJPZkNvbnN0cmFpbmluZ0VkZ2VzUHJvcGVydHkubGluayggKCBjb25zdHJhaW5pbmdFZGdlcywgb2xkQ29uc3RyYWluaW5nRWRnZXMgKSA9PiB7XHJcbiAgICAgIGlmICggb2xkQ29uc3RyYWluaW5nRWRnZXMgIT09IG51bGwgJiYgY29uc3RyYWluaW5nRWRnZXMgPiBvbGRDb25zdHJhaW5pbmdFZGdlcyApIHtcclxuICAgICAgICBibG9ja2VkQnlCb3VuZHNTb3VuZENsaXAucGxheSgpO1xyXG4gICAgICAgIHRoaXMudm9pY2luZ1NwZWFrUmVzcG9uc2UoIHtcclxuICAgICAgICAgIGNvbnRleHRSZXNwb25zZTogdmVydGV4RGVzY3JpYmVyLmdldEJsb2NrZWRCeUVkZ2VSZXNwb25zZSgpLFxyXG4gICAgICAgICAgdXR0ZXJhbmNlOiB0aGlzLmJsb2NrZWRVdHRlcmFuY2VcclxuICAgICAgICB9ICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyB2b2ljaW5nXHJcbiAgICBxdWFkcmlsYXRlcmFsTW9kZWwucXVhZHJpbGF0ZXJhbFNoYXBlTW9kZWwuc2hhcGVDaGFuZ2VkRW1pdHRlci5hZGRMaXN0ZW5lciggKCkgPT4ge1xyXG4gICAgICB0aGlzLnZvaWNpbmdPYmplY3RSZXNwb25zZSA9IHZlcnRleERlc2NyaWJlci5nZXRWZXJ0ZXhPYmplY3RSZXNwb25zZSgpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHdoZW4gY29ybmVyIGd1aWRlcyBhcmUgdmlzaWJsZSBtb3JlIGluZm9ybWF0aW9uIGlzIGFsc28gaW5jbHVkZWQgaW4gdGhlIG9iamVjdCByZXNwb25zZVxyXG4gICAgcXVhZHJpbGF0ZXJhbE1vZGVsLnZpc2liaWxpdHlNb2RlbC5tYXJrZXJzVmlzaWJsZVByb3BlcnR5LmxpbmsoIHZpc2libGUgPT4ge1xyXG4gICAgICB0aGlzLnZvaWNpbmdPYmplY3RSZXNwb25zZSA9IHZlcnRleERlc2NyaWJlci5nZXRWZXJ0ZXhPYmplY3RSZXNwb25zZSgpO1xyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxucXVhZHJpbGF0ZXJhbC5yZWdpc3RlciggJ1F1YWRyaWxhdGVyYWxWZXJ0ZXhOb2RlJywgUXVhZHJpbGF0ZXJhbFZlcnRleE5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsU0FBU0EsTUFBTSxFQUFFQyxZQUFZLEVBQUVDLG9CQUFvQixFQUFFQyxJQUFJLEVBQWdCQyxJQUFJLFFBQVEsbUNBQW1DO0FBS3hILE9BQU9DLFFBQVEsTUFBTSx5Q0FBeUM7QUFFOUQsU0FBU0MsS0FBSyxRQUFRLGdDQUFnQztBQUN0RCxPQUFPQyxzQkFBc0IsTUFBTSxpQ0FBaUM7QUFDcEUsT0FBT0MsU0FBUyxNQUFNLG9EQUFvRDtBQUMxRSxPQUFPQyxpQkFBaUIsTUFBTSxzQ0FBc0M7QUFDcEUsT0FBT0MsbUJBQW1CLE1BQU0saURBQWlEO0FBQ2pGLE9BQU9DLFlBQVksTUFBTSxzQ0FBc0M7QUFDL0QsT0FBT0MsYUFBYSxNQUFNLHdCQUF3QjtBQUNsRCxPQUFPQyx3QkFBd0IsTUFBMkMsK0JBQStCO0FBRXpHLE9BQU9DLFNBQVMsTUFBNEIsdUNBQXVDO0FBSW5GO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLElBQUlWLFFBQVEsQ0FBRTtFQUFFVyxJQUFJLEVBQUUsRUFBRTtFQUFFQyxNQUFNLEVBQUU7QUFBTyxDQUFFLENBQUM7QUFLcEU7QUFDQSxNQUFNQyx5QkFBMkQsR0FBRyxJQUFJQyxHQUFHLENBQUMsQ0FBQztBQUU3RSxlQUFlLE1BQU1DLHVCQUF1QixTQUFTUCx3QkFBd0IsQ0FBQztFQUlyRVEsV0FBV0EsQ0FBRUMsTUFBMkIsRUFBRUMsV0FBc0MsRUFBRUMs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