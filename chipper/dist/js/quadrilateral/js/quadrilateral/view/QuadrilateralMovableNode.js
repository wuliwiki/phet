// Copyright 2023, University of Colorado Boulder

/**
 * A superclass for movable components of the QuadrilateralNode. Namely, QuadrilateralVertexNode and QuadrilateralSideNode.
 *
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import quadrilateral from '../../quadrilateral.js';
import { KeyboardListener, Node, Voicing } from '../../../../scenery/js/imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import soundManager from '../../../../tambo/js/soundManager.js';
import quadShapeCollision_mp3 from '../../../sounds/quadShapeCollision_mp3.js';
import QuadrilateralStrings from '../../QuadrilateralStrings.js';
import QuadrilateralQueryParameters from '../QuadrilateralQueryParameters.js';
import QuadrilateralConstants from '../../QuadrilateralConstants.js';
import QuadrilateralColors from '../../QuadrilateralColors.js';
import Utterance from '../../../../utterance-queue/js/Utterance.js';

// constants
const blockedByInnerShapeStringProperty = QuadrilateralStrings.a11y.voicing.blockedByInnerShapeStringProperty;

// QuadrilateralVertexNode sets these properties explicitly from the nameResponse option

export default class QuadrilateralMovableNode extends Voicing(Node) {
  // Deltas used by movables for keyboard input - amount of motion per key press in view coordinates.

  // The actual visual PaintableNode for this view component, added as a child of this Node.

  // voicing - Responses related to this Node being blocked for movement have higher Priority so that it is not
  // interrupted by context responses during shape changes.
  blockedUtterance = new Utterance({
    priority: Utterance.MEDIUM_PRIORITY
  });
  constructor(model, modelViewTransform, paintableNode, providedOptions) {
    const options = optionize()({
      cursor: 'pointer',
      tagName: 'div',
      ariaRole: 'application',
      focusable: true,
      nameResponse: null,
      grabbedSoundOutputLevel: 0.6
    }, providedOptions);
    super(options);
    this.model = model;
    this.voicingNameResponse = options.nameResponse;
    this.innerContent = options.nameResponse;
    this.paintableNode = paintableNode;
    assert && assert(this.paintableNode.fill === null && this.paintableNode.stroke === null, 'QuadrilateralMovableNode sets default stroke and fill for the Paintable');
    paintableNode.fill = QuadrilateralColors.quadrilateralShapeColorProperty;
    paintableNode.stroke = QuadrilateralColors.quadrilateralShapeStrokeColorProperty;
    this.addChild(paintableNode);

    // calculate step sizes in view coordinates based on input modes from query parameters
    const reducedStepSize = QuadrilateralQueryParameters.reducedStepSize;
    const largeModelDelta = reducedStepSize ? QuadrilateralConstants.MAJOR_REDUCED_SIZE_VERTEX_INTERVAL : QuadrilateralQueryParameters.majorVertexInterval;
    const smallModelDelta = reducedStepSize ? QuadrilateralConstants.MINOR_REDUCED_SIZE_VERTEX_INTERVAL : QuadrilateralQueryParameters.minorVertexInterval;
    this.largeViewDragDelta = modelViewTransform.modelToViewDeltaX(largeModelDelta);
    this.smallViewDragDelta = modelViewTransform.modelToViewDeltaX(smallModelDelta);
    this.addInputListener({
      focus: () => {
        this.model.isPressedProperty.value = true;
      },
      blur: () => {
        this.model.isPressedProperty.value = false;
      }
    });

    // Voicing - speak all content about this component when you press enter or spacebar
    this.addInputListener(new KeyboardListener({
      keys: ['enter', 'space'],
      callback: (event, listener) => {
        this.voicingSpeakFullResponse();
      }
    }));

    // Sound - the grab sound is played on press but there is no release sound for this component since there is
    // no behavioral relevance to the release. The 'release' sound is used instead of 'grab' to distinguish sides
    // from vertices
    const pressedSoundPlayer = new SoundClip(providedOptions.grabbedSound, {
      initialOutputLevel: options.grabbedSoundOutputLevel
    });
    soundManager.addSoundGenerator(pressedSoundPlayer);
    model.isPressedProperty.lazyLink(isPressed => {
      if (isPressed) {
        pressedSoundPlayer.play();
      }
    });
    const blockedByShapeSoundClip = new SoundClip(quadShapeCollision_mp3, {
      initialOutputLevel: 0.5
    });
    soundManager.addSoundGenerator(blockedByShapeSoundClip);
    model.movementBlockedByShapeProperty.lazyLink(blocked => {
      if (blocked) {
        blockedByShapeSoundClip.play();
        this.voicingSpeakResponse({
          contextResponse: blockedByInnerShapeStringProperty,
          utterance: this.blockedUtterance
        });
      }
    });

    // Custom utterance for blocked state should only be spoken when Node is visible and voicingVisible.
    Voicing.registerUtteranceToVoicingNode(this.blockedUtterance, this);
  }

  /**
   * Update Properties in response to input indicating that the component was blocked from moving for some reason.
   */
  updateBlockedState(isBlockedByShape, isBlockedByBounds) {
    this.model.movementBlockedByShapeProperty.value = isBlockedByShape;
    this.model.movementBlockedByBoundsProperty.value = isBlockedByBounds;
  }
}
quadrilateral.register('QuadrilateralMovableNode', QuadrilateralMovableNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJxdWFkcmlsYXRlcmFsIiwiS2V5Ym9hcmRMaXN0ZW5lciIsIk5vZGUiLCJWb2ljaW5nIiwib3B0aW9uaXplIiwiU291bmRDbGlwIiwic291bmRNYW5hZ2VyIiwicXVhZFNoYXBlQ29sbGlzaW9uX21wMyIsIlF1YWRyaWxhdGVyYWxTdHJpbmdzIiwiUXVhZHJpbGF0ZXJhbFF1ZXJ5UGFyYW1ldGVycyIsIlF1YWRyaWxhdGVyYWxDb25zdGFudHMiLCJRdWFkcmlsYXRlcmFsQ29sb3JzIiwiVXR0ZXJhbmNlIiwiYmxvY2tlZEJ5SW5uZXJTaGFwZVN0cmluZ1Byb3BlcnR5IiwiYTExeSIsInZvaWNpbmciLCJRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGUiLCJibG9ja2VkVXR0ZXJhbmNlIiwicHJpb3JpdHkiLCJNRURJVU1fUFJJT1JJVFkiLCJjb25zdHJ1Y3RvciIsIm1vZGVsIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwicGFpbnRhYmxlTm9kZSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJjdXJzb3IiLCJ0YWdOYW1lIiwiYXJpYVJvbGUiLCJmb2N1c2FibGUiLCJuYW1lUmVzcG9uc2UiLCJncmFiYmVkU291bmRPdXRwdXRMZXZlbCIsInZvaWNpbmdOYW1lUmVzcG9uc2UiLCJpbm5lckNvbnRlbnQiLCJhc3NlcnQiLCJmaWxsIiwic3Ryb2tlIiwicXVhZHJpbGF0ZXJhbFNoYXBlQ29sb3JQcm9wZXJ0eSIsInF1YWRyaWxhdGVyYWxTaGFwZVN0cm9rZUNvbG9yUHJvcGVydHkiLCJhZGRDaGlsZCIsInJlZHVjZWRTdGVwU2l6ZSIsImxhcmdlTW9kZWxEZWx0YSIsIk1BSk9SX1JFRFVDRURfU0laRV9WRVJURVhfSU5URVJWQUwiLCJtYWpvclZlcnRleEludGVydmFsIiwic21hbGxNb2RlbERlbHRhIiwiTUlOT1JfUkVEVUNFRF9TSVpFX1ZFUlRFWF9JTlRFUlZBTCIsIm1pbm9yVmVydGV4SW50ZXJ2YWwiLCJsYXJnZVZpZXdEcmFnRGVsdGEiLCJtb2RlbFRvVmlld0RlbHRhWCIsInNtYWxsVmlld0RyYWdEZWx0YSIsImFkZElucHV0TGlzdGVuZXIiLCJmb2N1cyIsImlzUHJlc3NlZFByb3BlcnR5IiwidmFsdWUiLCJibHVyIiwia2V5cyIsImNhbGxiYWNrIiwiZXZlbnQiLCJsaXN0ZW5lciIsInZvaWNpbmdTcGVha0Z1bGxSZXNwb25zZSIsInByZXNzZWRTb3VuZFBsYXllciIsImdyYWJiZWRTb3VuZCIsImluaXRpYWxPdXRwdXRMZXZlbCIsImFkZFNvdW5kR2VuZXJhdG9yIiwibGF6eUxpbmsiLCJpc1ByZXNzZWQiLCJwbGF5IiwiYmxvY2tlZEJ5U2hhcGVTb3VuZENsaXAiLCJtb3ZlbWVudEJsb2NrZWRCeVNoYXBlUHJvcGVydHkiLCJibG9ja2VkIiwidm9pY2luZ1NwZWFrUmVzcG9uc2UiLCJjb250ZXh0UmVzcG9uc2UiLCJ1dHRlcmFuY2UiLCJyZWdpc3RlclV0dGVyYW5jZVRvVm9pY2luZ05vZGUiLCJ1cGRhdGVCbG9ja2VkU3RhdGUiLCJpc0Jsb2NrZWRCeVNoYXBlIiwiaXNCbG9ja2VkQnlCb3VuZHMiLCJtb3ZlbWVudEJsb2NrZWRCeUJvdW5kc1Byb3BlcnR5IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgc3VwZXJjbGFzcyBmb3IgbW92YWJsZSBjb21wb25lbnRzIG9mIHRoZSBRdWFkcmlsYXRlcmFsTm9kZS4gTmFtZWx5LCBRdWFkcmlsYXRlcmFsVmVydGV4Tm9kZSBhbmQgUXVhZHJpbGF0ZXJhbFNpZGVOb2RlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgcXVhZHJpbGF0ZXJhbCBmcm9tICcuLi8uLi9xdWFkcmlsYXRlcmFsLmpzJztcclxuaW1wb3J0IHsgS2V5Ym9hcmRMaXN0ZW5lciwgTm9kZSwgTm9kZU9wdGlvbnMsIFBhaW50YWJsZU5vZGUsIFZvaWNpbmcsIFZvaWNpbmdPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgUGlja1JlcXVpcmVkIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrUmVxdWlyZWQuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgUXVhZHJpbGF0ZXJhbE1vdmFibGUgZnJvbSAnLi4vbW9kZWwvUXVhZHJpbGF0ZXJhbE1vdmFibGUuanMnO1xyXG5pbXBvcnQgU291bmRDbGlwIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kLWdlbmVyYXRvcnMvU291bmRDbGlwLmpzJztcclxuaW1wb3J0IFdyYXBwZWRBdWRpb0J1ZmZlciBmcm9tICcuLi8uLi8uLi8uLi90YW1iby9qcy9XcmFwcGVkQXVkaW9CdWZmZXIuanMnO1xyXG5pbXBvcnQgc291bmRNYW5hZ2VyIGZyb20gJy4uLy4uLy4uLy4uL3RhbWJvL2pzL3NvdW5kTWFuYWdlci5qcyc7XHJcbmltcG9ydCBxdWFkU2hhcGVDb2xsaXNpb25fbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9xdWFkU2hhcGVDb2xsaXNpb25fbXAzLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxTdHJpbmdzIGZyb20gJy4uLy4uL1F1YWRyaWxhdGVyYWxTdHJpbmdzLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vUXVhZHJpbGF0ZXJhbFF1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsQ29uc3RhbnRzIGZyb20gJy4uLy4uL1F1YWRyaWxhdGVyYWxDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsQ29sb3JzIGZyb20gJy4uLy4uL1F1YWRyaWxhdGVyYWxDb2xvcnMuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBVdHRlcmFuY2UgZnJvbSAnLi4vLi4vLi4vLi4vdXR0ZXJhbmNlLXF1ZXVlL2pzL1V0dGVyYW5jZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgYmxvY2tlZEJ5SW5uZXJTaGFwZVN0cmluZ1Byb3BlcnR5ID0gUXVhZHJpbGF0ZXJhbFN0cmluZ3MuYTExeS52b2ljaW5nLmJsb2NrZWRCeUlubmVyU2hhcGVTdHJpbmdQcm9wZXJ0eTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIGExMXkgLSBuYW1lIG9mIHRoaXMgY29tcG9uZW50IGZvciBib3RoIFBET00gYW5kIFZvaWNpbmdcclxuICBuYW1lUmVzcG9uc2U/OiBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmc+IHwgbnVsbDtcclxuXHJcbiAgLy8gc291bmQgLSBzb3VuZCB0byBwbGF5IHdoZW4gdGhlIG1vdmFibGUgYmVjb21lcyBncmFiYmVkXHJcbiAgZ3JhYmJlZFNvdW5kOiBXcmFwcGVkQXVkaW9CdWZmZXI7XHJcbiAgZ3JhYmJlZFNvdW5kT3V0cHV0TGV2ZWw/OiBudW1iZXI7XHJcbn07XHJcblxyXG50eXBlIFBhcmVudE9wdGlvbnMgPSBWb2ljaW5nT3B0aW9ucyAmIE5vZGVPcHRpb25zO1xyXG5cclxuLy8gUXVhZHJpbGF0ZXJhbFZlcnRleE5vZGUgc2V0cyB0aGVzZSBwcm9wZXJ0aWVzIGV4cGxpY2l0bHkgZnJvbSB0aGUgbmFtZVJlc3BvbnNlIG9wdGlvblxyXG5leHBvcnQgdHlwZSBRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBTdHJpY3RPbWl0PFBhcmVudE9wdGlvbnMsICd2b2ljaW5nTmFtZVJlc3BvbnNlJyB8ICdpbm5lckNvbnRlbnQnPiAmIFBpY2tSZXF1aXJlZDxOb2RlT3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUXVhZHJpbGF0ZXJhbE1vdmFibGVOb2RlIGV4dGVuZHMgVm9pY2luZyggTm9kZSApIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBRdWFkcmlsYXRlcmFsTW92YWJsZTtcclxuXHJcbiAgLy8gRGVsdGFzIHVzZWQgYnkgbW92YWJsZXMgZm9yIGtleWJvYXJkIGlucHV0IC0gYW1vdW50IG9mIG1vdGlvbiBwZXIga2V5IHByZXNzIGluIHZpZXcgY29vcmRpbmF0ZXMuXHJcbiAgcHVibGljIHJlYWRvbmx5IGxhcmdlVmlld0RyYWdEZWx0YTogbnVtYmVyO1xyXG4gIHB1YmxpYyByZWFkb25seSBzbWFsbFZpZXdEcmFnRGVsdGE6IG51bWJlcjtcclxuXHJcbiAgLy8gVGhlIGFjdHVhbCB2aXN1YWwgUGFpbnRhYmxlTm9kZSBmb3IgdGhpcyB2aWV3IGNvbXBvbmVudCwgYWRkZWQgYXMgYSBjaGlsZCBvZiB0aGlzIE5vZGUuXHJcbiAgcHVibGljIHJlYWRvbmx5IHBhaW50YWJsZU5vZGU6IFBhaW50YWJsZU5vZGU7XHJcblxyXG4gIC8vIHZvaWNpbmcgLSBSZXNwb25zZXMgcmVsYXRlZCB0byB0aGlzIE5vZGUgYmVpbmcgYmxvY2tlZCBmb3IgbW92ZW1lbnQgaGF2ZSBoaWdoZXIgUHJpb3JpdHkgc28gdGhhdCBpdCBpcyBub3RcclxuICAvLyBpbnRlcnJ1cHRlZCBieSBjb250ZXh0IHJlc3BvbnNlcyBkdXJpbmcgc2hhcGUgY2hhbmdlcy5cclxuICBwdWJsaWMgcmVhZG9ubHkgYmxvY2tlZFV0dGVyYW5jZSA9IG5ldyBVdHRlcmFuY2UoIHtcclxuICAgIHByaW9yaXR5OiBVdHRlcmFuY2UuTUVESVVNX1BSSU9SSVRZXHJcbiAgfSApO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIG1vZGVsOiBRdWFkcmlsYXRlcmFsTW92YWJsZSwgbW9kZWxWaWV3VHJhbnNmb3JtOiBNb2RlbFZpZXdUcmFuc2Zvcm0yLCBwYWludGFibGVOb2RlOiBQYWludGFibGVOb2RlLCBwcm92aWRlZE9wdGlvbnM6IFF1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZU9wdGlvbnMgKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFF1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBQYXJlbnRPcHRpb25zPigpKCB7XHJcbiAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxyXG4gICAgICB0YWdOYW1lOiAnZGl2JyxcclxuICAgICAgYXJpYVJvbGU6ICdhcHBsaWNhdGlvbicsXHJcbiAgICAgIGZvY3VzYWJsZTogdHJ1ZSxcclxuICAgICAgbmFtZVJlc3BvbnNlOiBudWxsLFxyXG4gICAgICBncmFiYmVkU291bmRPdXRwdXRMZXZlbDogMC42XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xyXG5cclxuICAgIHRoaXMudm9pY2luZ05hbWVSZXNwb25zZSA9IG9wdGlvbnMubmFtZVJlc3BvbnNlO1xyXG4gICAgdGhpcy5pbm5lckNvbnRlbnQgPSBvcHRpb25zLm5hbWVSZXNwb25zZTtcclxuICAgIHRoaXMucGFpbnRhYmxlTm9kZSA9IHBhaW50YWJsZU5vZGU7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5wYWludGFibGVOb2RlLmZpbGwgPT09IG51bGwgJiYgdGhpcy5wYWludGFibGVOb2RlLnN0cm9rZSA9PT0gbnVsbCxcclxuICAgICAgJ1F1YWRyaWxhdGVyYWxNb3ZhYmxlTm9kZSBzZXRzIGRlZmF1bHQgc3Ryb2tlIGFuZCBmaWxsIGZvciB0aGUgUGFpbnRhYmxlJyApO1xyXG4gICAgcGFpbnRhYmxlTm9kZS5maWxsID0gUXVhZHJpbGF0ZXJhbENvbG9ycy5xdWFkcmlsYXRlcmFsU2hhcGVDb2xvclByb3BlcnR5O1xyXG4gICAgcGFpbnRhYmxlTm9kZS5zdHJva2UgPSBRdWFkcmlsYXRlcmFsQ29sb3JzLnF1YWRyaWxhdGVyYWxTaGFwZVN0cm9rZUNvbG9yUHJvcGVydHk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBwYWludGFibGVOb2RlICk7XHJcblxyXG4gICAgLy8gY2FsY3VsYXRlIHN0ZXAgc2l6ZXMgaW4gdmlldyBjb29yZGluYXRlcyBiYXNlZCBvbiBpbnB1dCBtb2RlcyBmcm9tIHF1ZXJ5IHBhcmFtZXRlcnNcclxuICAgIGNvbnN0IHJlZHVjZWRTdGVwU2l6ZSA9IFF1YWRyaWxhdGVyYWxRdWVyeVBhcmFtZXRlcnMucmVkdWNlZFN0ZXBTaXplO1xyXG4gICAgY29uc3QgbGFyZ2VNb2RlbERlbHRhID0gcmVkdWNlZFN0ZXBTaXplID8gUXVhZHJpbGF0ZXJhbENvbnN0YW50cy5NQUpPUl9SRURVQ0VEX1NJWkVfVkVSVEVYX0lOVEVSVkFMIDogUXVhZHJpbGF0ZXJhbFF1ZXJ5UGFyYW1ldGVycy5tYWpvclZlcnRleEludGVydmFsO1xyXG4gICAgY29uc3Qgc21hbGxNb2RlbERlbHRhID0gcmVkdWNlZFN0ZXBTaXplID8gUXVhZHJpbGF0ZXJhbENvbnN0YW50cy5NSU5PUl9SRURVQ0VEX1NJWkVfVkVSVEVYX0lOVEVSVkFMIDogUXVhZHJpbGF0ZXJhbFF1ZXJ5UGFyYW1ldGVycy5taW5vclZlcnRleEludGVydmFsO1xyXG4gICAgdGhpcy5sYXJnZVZpZXdEcmFnRGVsdGEgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGxhcmdlTW9kZWxEZWx0YSApO1xyXG4gICAgdGhpcy5zbWFsbFZpZXdEcmFnRGVsdGEgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIHNtYWxsTW9kZWxEZWx0YSApO1xyXG5cclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lcigge1xyXG4gICAgICBmb2N1czogKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubW9kZWwuaXNQcmVzc2VkUHJvcGVydHkudmFsdWUgPSB0cnVlO1xyXG4gICAgICB9LFxyXG4gICAgICBibHVyOiAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5tb2RlbC5pc1ByZXNzZWRQcm9wZXJ0eS52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVm9pY2luZyAtIHNwZWFrIGFsbCBjb250ZW50IGFib3V0IHRoaXMgY29tcG9uZW50IHdoZW4geW91IHByZXNzIGVudGVyIG9yIHNwYWNlYmFyXHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIG5ldyBLZXlib2FyZExpc3RlbmVyKCB7XHJcbiAgICAgIGtleXM6IFsgJ2VudGVyJywgJ3NwYWNlJyBdLFxyXG4gICAgICBjYWxsYmFjazogKCBldmVudCwgbGlzdGVuZXIgKSA9PiB7XHJcbiAgICAgICAgdGhpcy52b2ljaW5nU3BlYWtGdWxsUmVzcG9uc2UoKTtcclxuICAgICAgfVxyXG4gICAgfSApICk7XHJcblxyXG4gICAgLy8gU291bmQgLSB0aGUgZ3JhYiBzb3VuZCBpcyBwbGF5ZWQgb24gcHJlc3MgYnV0IHRoZXJlIGlzIG5vIHJlbGVhc2Ugc291bmQgZm9yIHRoaXMgY29tcG9uZW50IHNpbmNlIHRoZXJlIGlzXHJcbiAgICAvLyBubyBiZWhhdmlvcmFsIHJlbGV2YW5jZSB0byB0aGUgcmVsZWFzZS4gVGhlICdyZWxlYXNlJyBzb3VuZCBpcyB1c2VkIGluc3RlYWQgb2YgJ2dyYWInIHRvIGRpc3Rpbmd1aXNoIHNpZGVzXHJcbiAgICAvLyBmcm9tIHZlcnRpY2VzXHJcbiAgICBjb25zdCBwcmVzc2VkU291bmRQbGF5ZXIgPSBuZXcgU291bmRDbGlwKCBwcm92aWRlZE9wdGlvbnMuZ3JhYmJlZFNvdW5kLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogb3B0aW9ucy5ncmFiYmVkU291bmRPdXRwdXRMZXZlbFxyXG4gICAgfSApO1xyXG4gICAgc291bmRNYW5hZ2VyLmFkZFNvdW5kR2VuZXJhdG9yKCBwcmVzc2VkU291bmRQbGF5ZXIgKTtcclxuICAgIG1vZGVsLmlzUHJlc3NlZFByb3BlcnR5LmxhenlMaW5rKCBpc1ByZXNzZWQgPT4ge1xyXG4gICAgICBpZiAoIGlzUHJlc3NlZCApIHtcclxuICAgICAgICBwcmVzc2VkU291bmRQbGF5ZXIucGxheSgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgYmxvY2tlZEJ5U2hhcGVTb3VuZENsaXAgPSBuZXcgU291bmRDbGlwKCBxdWFkU2hhcGVDb2xsaXNpb25fbXAzLCB7XHJcbiAgICAgIGluaXRpYWxPdXRwdXRMZXZlbDogMC41XHJcbiAgICB9ICk7XHJcbiAgICBzb3VuZE1hbmFnZXIuYWRkU291bmRHZW5lcmF0b3IoIGJsb2NrZWRCeVNoYXBlU291bmRDbGlwICk7XHJcbiAgICBtb2RlbC5tb3ZlbWVudEJsb2NrZWRCeVNoYXBlUHJvcGVydHkubGF6eUxpbmsoIGJsb2NrZWQgPT4ge1xyXG4gICAgICBpZiAoIGJsb2NrZWQgKSB7XHJcbiAgICAgICAgYmxvY2tlZEJ5U2hhcGVTb3VuZENsaXAucGxheSgpO1xyXG4gICAgICAgIHRoaXMudm9pY2luZ1NwZWFrUmVzcG9uc2UoIHtcclxuICAgICAgICAgIGNvbnRleHRSZXNwb25zZTogYmxvY2tlZEJ5SW5uZXJTaGFwZVN0cmluZ1Byb3BlcnR5LFxyXG4gICAgICAgICAgdXR0ZXJhbmNlOiB0aGlzLmJsb2NrZWRVdHRlcmFuY2VcclxuICAgICAgICB9ICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBDdXN0b20gdXR0ZXJhbmNlIGZvciBibG9ja2VkIHN0YXRlIHNob3VsZCBvbmx5IGJlIHNwb2tlbiB3aGVuIE5vZGUgaXMgdmlzaWJsZSBhbmQgdm9pY2luZ1Zpc2libGUuXHJcbiAgICBWb2ljaW5nLnJlZ2lzdGVyVXR0ZXJhbmNlVG9Wb2ljaW5nTm9kZSggdGhpcy5ibG9ja2VkVXR0ZXJhbmNlLCB0aGlzICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGUgUHJvcGVydGllcyBpbiByZXNwb25zZSB0byBpbnB1dCBpbmRpY2F0aW5nIHRoYXQgdGhlIGNvbXBvbmVudCB3YXMgYmxvY2tlZCBmcm9tIG1vdmluZyBmb3Igc29tZSByZWFzb24uXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZUJsb2NrZWRTdGF0ZSggaXNCbG9ja2VkQnlTaGFwZTogYm9vbGVhbiwgaXNCbG9ja2VkQnlCb3VuZHM6IGJvb2xlYW4gKTogdm9pZCB7XHJcbiAgICB0aGlzLm1vZGVsLm1vdmVtZW50QmxvY2tlZEJ5U2hhcGVQcm9wZXJ0eS52YWx1ZSA9IGlzQmxvY2tlZEJ5U2hhcGU7XHJcbiAgICB0aGlzLm1vZGVsLm1vdmVtZW50QmxvY2tlZEJ5Qm91bmRzUHJvcGVydHkudmFsdWUgPSBpc0Jsb2NrZWRCeUJvdW5kcztcclxuICB9XHJcbn1cclxuXHJcbnF1YWRyaWxhdGVyYWwucmVnaXN0ZXIoICdRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGUnLCBRdWFkcmlsYXRlcmFsTW92YWJsZU5vZGUgKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGFBQWEsTUFBTSx3QkFBd0I7QUFDbEQsU0FBU0MsZ0JBQWdCLEVBQUVDLElBQUksRUFBOEJDLE9BQU8sUUFBd0IsbUNBQW1DO0FBRy9ILE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFFN0QsT0FBT0MsU0FBUyxNQUFNLG9EQUFvRDtBQUUxRSxPQUFPQyxZQUFZLE1BQU0sc0NBQXNDO0FBQy9ELE9BQU9DLHNCQUFzQixNQUFNLDJDQUEyQztBQUM5RSxPQUFPQyxvQkFBb0IsTUFB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