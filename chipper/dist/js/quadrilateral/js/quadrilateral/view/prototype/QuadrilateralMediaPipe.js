// Copyright 2022-2023, University of Colorado Boulder

/**
 * A prototype application of MediaPipe in quadrilateral. See https://github.com/phetsims/tangible.
 *
 * We might share this on the accessibility prototypes page, but this will not be a production feature.
 *
 * This feature uses camera input to control the quadrilateral shape by moving your fingers.
 * - QuadrilateralVertex A is controlled by left index finger.
 * - QuadrilateralVertex B is controlled by right index finger.
 * - QuadrilateralVertex C is controlled by right thumb.
 * - QuadrilateralVertex D is controlled by left thumb.
 *
 * Hold these fingers up in front of the camera to form a square like shape (pinching gesture), then move them around
 * to change the quadrilateral shape in the simulation.
 *
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import quadrilateral from '../../../quadrilateral.js';
import MediaPipe from '../../../../../tangible/js/mediaPipe/MediaPipe.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import MediaPipeQueryParameters from '../../../../../tangible/js/mediaPipe/MediaPipeQueryParameters.js';
import QuadrilateralVertexLabel from '../../model/QuadrilateralVertexLabel.js';

// aspect ratio of the video stream to map camera coordinates to sim model coordinates
const streamDimension2 = MediaPipe.videoStreamDimension2;
const MEDIA_PIPE_ASPECT_RATIO = streamDimension2.width / streamDimension2.height;

// Indices of the thumb and index finger from HandLandmarks of MediaPipe, according to that project
// https://google.github.io/mediapipe/solutions/hands.html#hand-landmark-model
const THUMB_TIP_INDEX = 4;
const INDEX_TIP_INDEX = 8;
if (MediaPipeQueryParameters.cameraInput === 'hands') {
  MediaPipe.initialize();
}

// A reusable map that has proposed vertex positions, to avoid lots of garbage.
const labelToProposedPositionMap = new Map();
export default class QuadrilateralMediaPipe extends MediaPipe {
  constructor(model, tangibleController) {
    assert && assert(MediaPipeQueryParameters.cameraInput === 'hands', 'MediaPipe can only be used when requested.');
    super();
    this.quadrilateralShapeModel = model.quadrilateralShapeModel;
    this.tangibleController = tangibleController;

    // So that there is a mapping from tangible space to simulation model space
    model.tangibleConnectionModel.setPhysicalToVirtualTransform(MEDIA_PIPE_ASPECT_RATIO, 1);

    // effectively connected to a device with this prototype
    model.tangibleConnectionModel.connectedToDeviceProperty.value = true;
  }

  /**
   * In the animation frame, get the most recent results from camera input. Use that data to update QuadrilateralVertex positions
   * in the simulation.
   */
  step(dt) {
    const results = MediaPipe.resultsProperty.value;

    // no work if no hands detected
    if (results) {
      const landmarks = results.multiHandLandmarks;

      // checking for two hands to form the quadrilateral with index/thumb fingers
      if (landmarks.length === 2) {
        // get the thumb and index positions from each hand
        const firstHandPositions = this.getThumbAndIndexPositions(landmarks[0]);
        const secondHandPositions = this.getThumbAndIndexPositions(landmarks[1]);

        // sort to determine which one is left/right
        const sortedPositions = this.sortHandedness([firstHandPositions, secondHandPositions]);
        const leftHandPositions = sortedPositions[0];
        const rightHandPositions = sortedPositions[1];

        // package and attempt to update shape
        labelToProposedPositionMap.set(QuadrilateralVertexLabel.VERTEX_A, leftHandPositions.indexPosition);
        labelToProposedPositionMap.set(QuadrilateralVertexLabel.VERTEX_B, rightHandPositions.indexPosition);
        labelToProposedPositionMap.set(QuadrilateralVertexLabel.VERTEX_C, rightHandPositions.thumbPosition);
        labelToProposedPositionMap.set(QuadrilateralVertexLabel.VERTEX_D, leftHandPositions.thumbPosition);
        this.tangibleController.setPositionsFromAbsolutePositionData(labelToProposedPositionMap);
      }
    }
  }

  /**
   * Returns the position of the thumb and index position in the camera view, provided the data of a HandLandmarks.
   */
  getThumbAndIndexPositions(handLandmarks) {
    const thumbHandPoint = handLandmarks[THUMB_TIP_INDEX];
    const indexHandPoint = handLandmarks[INDEX_TIP_INDEX];
    return {
      thumbPosition: new Vector2((1 - thumbHandPoint.x) * MEDIA_PIPE_ASPECT_RATIO, 1 - thumbHandPoint.y),
      indexPosition: new Vector2((1 - indexHandPoint.x) * MEDIA_PIPE_ASPECT_RATIO, 1 - indexHandPoint.y)
    };
  }

  /**
   * Sorts the ThumbAndIndexPositions to determine which set is the right hand vs left hand.
   */
  sortHandedness(handPositions) {
    assert && assert(handPositions.length === 2, 'must have 2 thumbs');
    return handPositions[0].thumbPosition.x <= handPositions[1].thumbPosition.x ? handPositions : handPositions.reverse();
  }
}
quadrilateral.register('QuadrilateralMediaPipe', QuadrilateralMediaPipe);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJxdWFkcmlsYXRlcmFsIiwiTWVkaWFQaXBlIiwiVmVjdG9yMiIsIk1lZGlhUGlwZVF1ZXJ5UGFyYW1ldGVycyIsIlF1YWRyaWxhdGVyYWxWZXJ0ZXhMYWJlbCIsInN0cmVhbURpbWVuc2lvbjIiLCJ2aWRlb1N0cmVhbURpbWVuc2lvbjIiLCJNRURJQV9QSVBFX0FTUEVDVF9SQVRJTyIsIndpZHRoIiwiaGVpZ2h0IiwiVEhVTUJfVElQX0lOREVYIiwiSU5ERVhfVElQX0lOREVYIiwiY2FtZXJhSW5wdXQiLCJpbml0aWFsaXplIiwibGFiZWxUb1Byb3Bvc2VkUG9zaXRpb25NYXAiLCJNYXAiLCJRdWFkcmlsYXRlcmFsTWVkaWFQaXBlIiwiY29uc3RydWN0b3IiLCJtb2RlbCIsInRhbmdpYmxlQ29udHJvbGxlciIsImFzc2VydCIsInF1YWRyaWxhdGVyYWxTaGFwZU1vZGVsIiwidGFuZ2libGVDb25uZWN0aW9uTW9kZWwiLCJzZXRQaHlzaWNhbFRvVmlydHVhbFRyYW5zZm9ybSIsImNvbm5lY3RlZFRvRGV2aWNlUHJvcGVydHkiLCJ2YWx1ZSIsInN0ZXAiLCJkdCIsInJlc3VsdHMiLCJyZXN1bHRzUHJvcGVydHkiLCJsYW5kbWFya3MiLCJtdWx0aUhhbmRMYW5kbWFya3MiLCJsZW5ndGgiLCJmaXJzdEhhbmRQb3NpdGlvbnMiLCJnZXRUaHVtYkFuZEluZGV4UG9zaXRpb25zIiwic2Vjb25kSGFuZFBvc2l0aW9ucyIsInNvcnRlZFBvc2l0aW9ucyIsInNvcnRIYW5kZWRuZXNzIiwibGVmdEhhbmRQb3NpdGlvbnMiLCJyaWdodEhhbmRQb3NpdGlvbnMiLCJzZXQiLCJWRVJURVhfQSIsImluZGV4UG9zaXRpb24iLCJWRVJURVhfQiIsIlZFUlRFWF9DIiwidGh1bWJQb3NpdGlvbiIsIlZFUlRFWF9EIiwic2V0UG9zaXRpb25zRnJvbUFic29sdXRlUG9zaXRpb25EYXRhIiwiaGFuZExhbmRtYXJrcyIsInRodW1iSGFuZFBvaW50IiwiaW5kZXhIYW5kUG9pbnQiLCJ4IiwieSIsImhhbmRQb3NpdGlvbnMiLCJyZXZlcnNlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJRdWFkcmlsYXRlcmFsTWVkaWFQaXBlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgcHJvdG90eXBlIGFwcGxpY2F0aW9uIG9mIE1lZGlhUGlwZSBpbiBxdWFkcmlsYXRlcmFsLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3RhbmdpYmxlLlxyXG4gKlxyXG4gKiBXZSBtaWdodCBzaGFyZSB0aGlzIG9uIHRoZSBhY2Nlc3NpYmlsaXR5IHByb3RvdHlwZXMgcGFnZSwgYnV0IHRoaXMgd2lsbCBub3QgYmUgYSBwcm9kdWN0aW9uIGZlYXR1cmUuXHJcbiAqXHJcbiAqIFRoaXMgZmVhdHVyZSB1c2VzIGNhbWVyYSBpbnB1dCB0byBjb250cm9sIHRoZSBxdWFkcmlsYXRlcmFsIHNoYXBlIGJ5IG1vdmluZyB5b3VyIGZpbmdlcnMuXHJcbiAqIC0gUXVhZHJpbGF0ZXJhbFZlcnRleCBBIGlzIGNvbnRyb2xsZWQgYnkgbGVmdCBpbmRleCBmaW5nZXIuXHJcbiAqIC0gUXVhZHJpbGF0ZXJhbFZlcnRleCBCIGlzIGNvbnRyb2xsZWQgYnkgcmlnaHQgaW5kZXggZmluZ2VyLlxyXG4gKiAtIFF1YWRyaWxhdGVyYWxWZXJ0ZXggQyBpcyBjb250cm9sbGVkIGJ5IHJpZ2h0IHRodW1iLlxyXG4gKiAtIFF1YWRyaWxhdGVyYWxWZXJ0ZXggRCBpcyBjb250cm9sbGVkIGJ5IGxlZnQgdGh1bWIuXHJcbiAqXHJcbiAqIEhvbGQgdGhlc2UgZmluZ2VycyB1cCBpbiBmcm9udCBvZiB0aGUgY2FtZXJhIHRvIGZvcm0gYSBzcXVhcmUgbGlrZSBzaGFwZSAocGluY2hpbmcgZ2VzdHVyZSksIHRoZW4gbW92ZSB0aGVtIGFyb3VuZFxyXG4gKiB0byBjaGFuZ2UgdGhlIHF1YWRyaWxhdGVyYWwgc2hhcGUgaW4gdGhlIHNpbXVsYXRpb24uXHJcbiAqXHJcbiAqIEBhdXRob3IgSmVzc2UgR3JlZW5iZXJnIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBxdWFkcmlsYXRlcmFsIGZyb20gJy4uLy4uLy4uL3F1YWRyaWxhdGVyYWwuanMnO1xyXG5pbXBvcnQgTWVkaWFQaXBlLCB7IEhhbmRMYW5kbWFya3MgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi90YW5naWJsZS9qcy9tZWRpYVBpcGUvTWVkaWFQaXBlLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxNb2RlbCBmcm9tICcuLi8uLi9tb2RlbC9RdWFkcmlsYXRlcmFsTW9kZWwuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBRdWFkcmlsYXRlcmFsU2hhcGVNb2RlbCwgeyBWZXJ0ZXhMYWJlbFRvUHJvcG9zZWRQb3NpdGlvbk1hcCB9IGZyb20gJy4uLy4uL21vZGVsL1F1YWRyaWxhdGVyYWxTaGFwZU1vZGVsLmpzJztcclxuaW1wb3J0IE1lZGlhUGlwZVF1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi8uLi8uLi8uLi90YW5naWJsZS9qcy9tZWRpYVBpcGUvTWVkaWFQaXBlUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxUYW5naWJsZUNvbnRyb2xsZXIgZnJvbSAnLi9RdWFkcmlsYXRlcmFsVGFuZ2libGVDb250cm9sbGVyLmpzJztcclxuaW1wb3J0IFF1YWRyaWxhdGVyYWxWZXJ0ZXhMYWJlbCBmcm9tICcuLi8uLi9tb2RlbC9RdWFkcmlsYXRlcmFsVmVydGV4TGFiZWwuanMnO1xyXG5cclxuLy8gYXNwZWN0IHJhdGlvIG9mIHRoZSB2aWRlbyBzdHJlYW0gdG8gbWFwIGNhbWVyYSBjb29yZGluYXRlcyB0byBzaW0gbW9kZWwgY29vcmRpbmF0ZXNcclxuY29uc3Qgc3RyZWFtRGltZW5zaW9uMiA9IE1lZGlhUGlwZS52aWRlb1N0cmVhbURpbWVuc2lvbjI7XHJcbmNvbnN0IE1FRElBX1BJUEVfQVNQRUNUX1JBVElPID0gc3RyZWFtRGltZW5zaW9uMi53aWR0aCAvIHN0cmVhbURpbWVuc2lvbjIuaGVpZ2h0O1xyXG5cclxuLy8gSW5kaWNlcyBvZiB0aGUgdGh1bWIgYW5kIGluZGV4IGZpbmdlciBmcm9tIEhhbmRMYW5kbWFya3Mgb2YgTWVkaWFQaXBlLCBhY2NvcmRpbmcgdG8gdGhhdCBwcm9qZWN0XHJcbi8vIGh0dHBzOi8vZ29vZ2xlLmdpdGh1Yi5pby9tZWRpYXBpcGUvc29sdXRpb25zL2hhbmRzLmh0bWwjaGFuZC1sYW5kbWFyay1tb2RlbFxyXG5jb25zdCBUSFVNQl9USVBfSU5ERVggPSA0O1xyXG5jb25zdCBJTkRFWF9USVBfSU5ERVggPSA4O1xyXG5cclxudHlwZSBUaHVtYkFuZEluZGV4UG9zaXRpb25zID0ge1xyXG4gIHRodW1iUG9zaXRpb246IFZlY3RvcjI7XHJcbiAgaW5kZXhQb3NpdGlvbjogVmVjdG9yMjtcclxufTtcclxuXHJcbmlmICggTWVkaWFQaXBlUXVlcnlQYXJhbWV0ZXJzLmNhbWVyYUlucHV0ID09PSAnaGFuZHMnICkge1xyXG4gIE1lZGlhUGlwZS5pbml0aWFsaXplKCk7XHJcbn1cclxuXHJcbi8vIEEgcmV1c2FibGUgbWFwIHRoYXQgaGFzIHByb3Bvc2VkIHZlcnRleCBwb3NpdGlvbnMsIHRvIGF2b2lkIGxvdHMgb2YgZ2FyYmFnZS5cclxuY29uc3QgbGFiZWxUb1Byb3Bvc2VkUG9zaXRpb25NYXA6IFZlcnRleExhYmVsVG9Qcm9wb3NlZFBvc2l0aW9uTWFwID0gbmV3IE1hcCgpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUXVhZHJpbGF0ZXJhbE1lZGlhUGlwZSBleHRlbmRzIE1lZGlhUGlwZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBxdWFkcmlsYXRlcmFsU2hhcGVNb2RlbDogUXVhZHJpbGF0ZXJhbFNoYXBlTW9kZWw7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB0YW5naWJsZUNvbnRyb2xsZXI6IFF1YWRyaWxhdGVyYWxUYW5naWJsZUNvbnRyb2xsZXI7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggbW9kZWw6IFF1YWRyaWxhdGVyYWxNb2RlbCwgdGFuZ2libGVDb250cm9sbGVyOiBRdWFkcmlsYXRlcmFsVGFuZ2libGVDb250cm9sbGVyICkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggTWVkaWFQaXBlUXVlcnlQYXJhbWV0ZXJzLmNhbWVyYUlucHV0ID09PSAnaGFuZHMnLCAnTWVkaWFQaXBlIGNhbiBvbmx5IGJlIHVzZWQgd2hlbiByZXF1ZXN0ZWQuJyApO1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMucXVhZHJpbGF0ZXJhbFNoYXBlTW9kZWwgPSBtb2RlbC5xdWFkcmlsYXRlcmFsU2hhcGVNb2RlbDtcclxuICAgIHRoaXMudGFuZ2libGVDb250cm9sbGVyID0gdGFuZ2libGVDb250cm9sbGVyO1xyXG5cclxuICAgIC8vIFNvIHRoYXQgdGhlcmUgaXMgYSBtYXBwaW5nIGZyb20gdGFuZ2libGUgc3BhY2UgdG8gc2ltdWxhdGlvbiBtb2RlbCBzcGFjZVxyXG4gICAgbW9kZWwudGFuZ2libGVDb25uZWN0aW9uTW9kZWwuc2V0UGh5c2ljYWxUb1ZpcnR1YWxUcmFuc2Zvcm0oIE1FRElBX1BJUEVfQVNQRUNUX1JBVElPLCAxICk7XHJcblxyXG4gICAgLy8gZWZmZWN0aXZlbHkgY29ubmVjdGVkIHRvIGEgZGV2aWNlIHdpdGggdGhpcyBwcm90b3R5cGVcclxuICAgIG1vZGVsLnRhbmdpYmxlQ29ubmVjdGlvbk1vZGVsLmNvbm5lY3RlZFRvRGV2aWNlUHJvcGVydHkudmFsdWUgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW4gdGhlIGFuaW1hdGlvbiBmcmFtZSwgZ2V0IHRoZSBtb3N0IHJlY2VudCByZXN1bHRzIGZyb20gY2FtZXJhIGlucHV0LiBVc2UgdGhhdCBkYXRhIHRvIHVwZGF0ZSBRdWFkcmlsYXRlcmFsVmVydGV4IHBvc2l0aW9uc1xyXG4gICAqIGluIHRoZSBzaW11bGF0aW9uLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGVwKCBkdDogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgY29uc3QgcmVzdWx0cyA9IE1lZGlhUGlwZS5yZXN1bHRzUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgLy8gbm8gd29yayBpZiBubyBoYW5kcyBkZXRlY3RlZFxyXG4gICAgaWYgKCByZXN1bHRzICkge1xyXG4gICAgICBjb25zdCBsYW5kbWFya3MgPSByZXN1bHRzLm11bHRpSGFuZExhbmRtYXJrcztcclxuXHJcbiAgICAgIC8vIGNoZWNraW5nIGZvciB0d28gaGFuZHMgdG8gZm9ybSB0aGUgcXVhZHJpbGF0ZXJhbCB3aXRoIGluZGV4L3RodW1iIGZpbmdlcnNcclxuICAgICAgaWYgKCBsYW5kbWFya3MubGVuZ3RoID09PSAyICkge1xyXG5cclxuICAgICAgICAvLyBnZXQgdGhlIHRodW1iIGFuZCBpbmRleCBwb3NpdGlvbnMgZnJvbSBlYWNoIGhhbmRcclxuICAgICAgICBjb25zdCBmaXJzdEhhbmRQb3NpdGlvbnMgPSB0aGlzLmdldFRodW1iQW5kSW5kZXhQb3NpdGlvbnMoIGxhbmRtYXJrc1sgMCBdICk7XHJcbiAgICAgICAgY29uc3Qgc2Vjb25kSGFuZFBvc2l0aW9ucyA9IHRoaXMuZ2V0VGh1bWJBbmRJbmRleFBvc2l0aW9ucyggbGFuZG1hcmtzWyAxIF0gKTtcclxuXHJcbiAgICAgICAgLy8gc29ydCB0byBkZXRlcm1pbmUgd2hpY2ggb25lIGlzIGxlZnQvcmlnaHRcclxuICAgICAgICBjb25zdCBzb3J0ZWRQb3NpdGlvbnMgPSB0aGlzLnNvcnRIYW5kZWRuZXNzKCBbIGZpcnN0SGFuZFBvc2l0aW9ucywgc2Vjb25kSGFuZFBvc2l0aW9ucyBdICk7XHJcbiAgICAgICAgY29uc3QgbGVmdEhhbmRQb3NpdGlvbnMgPSBzb3J0ZWRQb3NpdGlvbnNbIDAgXTtcclxuICAgICAgICBjb25zdCByaWdodEhhbmRQb3NpdGlvbnMgPSBzb3J0ZWRQb3NpdGlvbnNbIDEgXTtcclxuXHJcbiAgICAgICAgLy8gcGFja2FnZSBhbmQgYXR0ZW1wdCB0byB1cGRhdGUgc2hhcGVcclxuICAgICAgICBsYWJlbFRvUHJvcG9zZWRQb3NpdGlvbk1hcC5zZXQoIFF1YWRyaWxhdGVyYWxWZXJ0ZXhMYWJlbC5WRVJURVhfQSwgbGVmdEhhbmRQb3NpdGlvbnMuaW5kZXhQb3NpdGlvbiApO1xyXG4gICAgICAgIGxhYmVsVG9Qcm9wb3NlZFBvc2l0aW9uTWFwLnNldCggUXVhZHJpbGF0ZXJhbFZlcnRleExhYmVsLlZFUlRFWF9CLCByaWdodEhhbmRQb3NpdGlvbnMuaW5kZXhQb3NpdGlvbiApO1xyXG4gICAgICAgIGxhYmVsVG9Qcm9wb3NlZFBvc2l0aW9uTWFwLnNldCggUXVhZHJpbGF0ZXJhbFZlcnRleExhYmVsLlZFUlRFWF9DLCByaWdodEhhbmRQb3NpdGlvbnMudGh1bWJQb3NpdGlvbiApO1xyXG4gICAgICAgIGxhYmVsVG9Qcm9wb3NlZFBvc2l0aW9uTWFwLnNldCggUXVhZHJpbGF0ZXJhbFZlcnRleExhYmVsLlZFUlRFWF9ELCBsZWZ0SGFuZFBvc2l0aW9ucy50aHVtYlBvc2l0aW9uICk7XHJcblxyXG4gICAgICAgIHRoaXMudGFuZ2libGVDb250cm9sbGVyLnNldFBvc2l0aW9uc0Zyb21BYnNvbHV0ZVBvc2l0aW9uRGF0YSggbGFiZWxUb1Byb3Bvc2VkUG9zaXRpb25NYXAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0aGUgcG9zaXRpb24gb2YgdGhlIHRodW1iIGFuZCBpbmRleCBwb3NpdGlvbiBpbiB0aGUgY2FtZXJhIHZpZXcsIHByb3ZpZGVkIHRoZSBkYXRhIG9mIGEgSGFuZExhbmRtYXJrcy5cclxuICAgKi9cclxuICBwcml2YXRlIGdldFRodW1iQW5kSW5kZXhQb3NpdGlvbnMoIGhhbmRMYW5kbWFya3M6IEhhbmRMYW5kbWFya3MgKTogVGh1bWJBbmRJbmRleFBvc2l0aW9ucyB7XHJcbiAgICBjb25zdCB0aHVtYkhhbmRQb2ludCA9IGhhbmRMYW5kbWFya3NbIFRIVU1CX1RJUF9JTkRFWCBdO1xyXG4gICAgY29uc3QgaW5kZXhIYW5kUG9pbnQgPSBoYW5kTGFuZG1hcmtzWyBJTkRFWF9USVBfSU5ERVggXTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0aHVtYlBvc2l0aW9uOiBuZXcgVmVjdG9yMiggKCAxIC0gdGh1bWJIYW5kUG9pbnQueCApICogTUVESUFfUElQRV9BU1BFQ1RfUkFUSU8sICggMSAtIHRodW1iSGFuZFBvaW50LnkgKSApLFxyXG4gICAgICBpbmRleFBvc2l0aW9uOiBuZXcgVmVjdG9yMiggKCAxIC0gaW5kZXhIYW5kUG9pbnQueCApICogTUVESUFfUElQRV9BU1BFQ1RfUkFUSU8sICggMSAtIGluZGV4SGFuZFBvaW50LnkgKSApXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU29ydHMgdGhlIFRodW1iQW5kSW5kZXhQb3NpdGlvbnMgdG8gZGV0ZXJtaW5lIHdoaWNoIHNldCBpcyB0aGUgcmlnaHQgaGFuZCB2cyBsZWZ0IGhhbmQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzb3J0SGFuZGVkbmVzcyggaGFuZFBvc2l0aW9uczogVGh1bWJBbmRJbmRleFBvc2l0aW9uc1tdICk6IFRodW1iQW5kSW5kZXhQb3NpdGlvbnNbXSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBoYW5kUG9zaXRpb25zLmxlbmd0aCA9PT0gMiwgJ211c3QgaGF2ZSAyIHRodW1icycgKTtcclxuICAgIHJldHVybiBoYW5kUG9zaXRpb25zWyAwIF0udGh1bWJQb3NpdGlvbi54IDw9IGhhbmRQb3NpdGlvbnNbIDEgXS50aHVtYlBvc2l0aW9uLnggPyBoYW5kUG9zaXRpb25zIDogaGFuZFBvc2l0aW9ucy5yZXZlcnNlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5xdWFkcmlsYXRlcmFsLnJlZ2lzdGVyKCAnUXVhZHJpbGF0ZXJhbE1lZGlhUGlwZScsIFF1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