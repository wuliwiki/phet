// Copyright 2019-2023, University of Colorado Boulder

/**
 * VectorAngleNode is the angle indicator that appears on vectors on the graph when the angle checkbox is checked.
 * Only shows if the vector model is active.
 *
 * @author Brandon Li
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import ReadOnlyProperty from '../../../../axon/js/ReadOnlyProperty.js';
import Utils from '../../../../dot/js/Utils.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import MathSymbols from '../../../../scenery-phet/js/MathSymbols.js';
import { Color, Line, Node, Text } from '../../../../scenery/js/imports.js';
import vectorAddition from '../../vectorAddition.js';
import Vector from '../model/Vector.js';
import VectorAdditionConstants from '../VectorAdditionConstants.js';
import CurvedArrowNode from './CurvedArrowNode.js';

// constants

// maximum radius of the curved arrow - the radius is changed to keep the curved arrow smaller than the vector.
const MAX_CURVED_ARROW_RADIUS = 25;

// the percent symbol of curved arrow radius when compared to the magnitude of the vector - as long as it's less than
// the max curved arrow radius
const MAX_RADIUS_SCALE = 0.79;

// maximum length of the baseline that is parallel to the x axis
const MAX_BASELINE_WIDTH = 55;

// the maximum percentage of the baseline when compared to the radius of the curved arrow.
const MAX_BASELINE_SCALE = 0.60;

// the offset of the angle label from the curved arrow
const LABEL_OFFSET = 3.5;

// Angles greater than 35 deg position the label between the vector and the baseline, and angles under 35
// place the label on the other side of the baseline. See
// https://docs.google.com/document/d/1opnDgqIqIroo8VK0CbOyQ5608_g11MSGZXnFlI8k5Ds/edit#bookmark=id.on5p73bbry7g.
const ANGLE_UNDER_BASELINE_THRESHOLD = 35;
export default class VectorAngleNode extends Node {
  /**
   * @param {Vector} vector - the model for the vector that the angle represents
   * @param {BooleanProperty} anglesVisibleProperty
   * @param {ReadOnlyProperty.<ModelViewTransform2>} modelViewTransformProperty
   */
  constructor(vector, anglesVisibleProperty, modelViewTransformProperty) {
    assert && assert(vector instanceof Vector, `invalid vector: ${vector}`);
    assert && assert(anglesVisibleProperty instanceof BooleanProperty, `invalid anglesVisibleProperty: ${anglesVisibleProperty}`);
    assert && assert(modelViewTransformProperty instanceof ReadOnlyProperty, `invalid modelViewTransformProperty: ${modelViewTransformProperty}`);
    super();

    // @private {Line} baseline - line that is parallel to the x axis.
    this.baseLine = new Line(0, 0, MAX_BASELINE_WIDTH, 0, {
      stroke: Color.BLACK
    });

    // @private {CurvedArrowNode} curvedArrow - arrow in a circle shape from the baseline to the vector
    this.curvedArrow = new CurvedArrowNode(MAX_CURVED_ARROW_RADIUS, vector.angle ? vector.angle : 0);

    // @private {Text} labelText - set to an arbitrary string for now.
    this.labelText = new Text('', {
      font: VectorAdditionConstants.ANGLE_LABEL_FONT
    });
    this.setChildren([this.baseLine, this.curvedArrow, this.labelText]);

    // Update the angle and its visibility. Must be disposed on dispose.
    const angleVisibleMultilink = Multilink.multilink([anglesVisibleProperty, vector.isOnGraphProperty, vector.vectorComponentsProperty], (angleVisible, isOnGraph, vectorComponents) => {
      this.visible = angleVisible && isOnGraph && vector.magnitude !== 0;
      if (this.visible) {
        this.updateAngleNode(vector, modelViewTransformProperty.value);
      }
    });

    // @private {function} disposeVectorAngleNode - function to unlink listeners, called in dispose()
    this.disposeVectorAngleNode = () => {
      Multilink.unmultilink(angleVisibleMultilink);
    };
  }

  /**
   * @public
   * @override
   */
  dispose() {
    this.disposeVectorAngleNode();
    super.dispose();
  }

  /**
   * Updates the angle node: (called when the vector model's components change)
   *  - Curved arrow node angle
   *  - Curved arrow node radius
   *  - Label Text
   *  - baseline length
   *
   * @private
   * @param {Vector} vector - model vector to base the angle off of
   * @param {ModelViewTransform2} modelViewTransform
   */
  updateAngleNode(vector, modelViewTransform) {
    assert && assert(vector instanceof Vector, `invalid vector: ${vector}`);
    assert && assert(modelViewTransform instanceof ModelViewTransform2, `invalid modelViewTransform: ${modelViewTransform}`);

    // convenience reference.
    const angleDegrees = vector.angleDegrees;

    // Update the curved arrow node angle
    this.curvedArrow.setAngle(vector.angle ? vector.angle : 0);

    // Update the label text.
    this.labelText.setString(angleDegrees === null ? '' : `${Utils.toFixed(angleDegrees, VectorAdditionConstants.VECTOR_VALUE_DECIMAL_PLACES)}${MathSymbols.DEGREES}`);

    // Update the curved arrow radius
    const viewMagnitude = modelViewTransform.modelToViewDeltaX(vector.magnitude);
    if (viewMagnitude !== 0) {
      this.curvedArrow.setRadius(_.min([MAX_RADIUS_SCALE * viewMagnitude, MAX_CURVED_ARROW_RADIUS]));
    }

    // Update the baseline
    this.baseLine.setX2(_.min([this.curvedArrow.radius / MAX_BASELINE_SCALE, MAX_BASELINE_WIDTH]));

    // Position the label text
    if (angleDegrees !== null) {
      if (angleDegrees > ANGLE_UNDER_BASELINE_THRESHOLD) {
        // Position the label next to the arc, halfway across the arc
        this.labelText.setTranslation((this.curvedArrow.radius + LABEL_OFFSET) * Math.cos(vector.angle / 2), -(this.curvedArrow.radius + LABEL_OFFSET) * Math.sin(vector.angle / 2));
      } else if (angleDegrees >= 0) {
        // Position the label halfway across, but on the other side of the baseline
        this.labelText.setTranslation(this.curvedArrow.radius / 2, this.curvedArrow.radius / 2);
      } else if (angleDegrees > -ANGLE_UNDER_BASELINE_THRESHOLD) {
        // Position the label halfway across, but on the other side of the baseline
        this.labelText.setTranslation(this.curvedArrow.radius / 2, -this.curvedArrow.radius / 2 + this.labelText.height / 2);
      } else {
        // Position the label next to the arc, halfway across the arc
        this.labelText.setTranslation((this.curvedArrow.radius + LABEL_OFFSET) * Math.cos(vector.angle / 2), -(this.curvedArrow.radius + LABEL_OFFSET) * Math.sin(vector.angle / 2) + this.labelText.height / 2);
      }
    }
  }
}
vectorAddition.register('VectorAngleNode', VectorAngleNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJSZWFkT25seVByb3BlcnR5IiwiVXRpbHMiLCJNb2RlbFZpZXdUcmFuc2Zvcm0yIiwiTWF0aFN5bWJvbHMiLCJDb2xvciIsIkxpbmUiLCJOb2RlIiwiVGV4dCIsInZlY3RvckFkZGl0aW9uIiwiVmVjdG9yIiwiVmVjdG9yQWRkaXRpb25Db25zdGFudHMiLCJDdXJ2ZWRBcnJvd05vZGUiLCJNQVhfQ1VSVkVEX0FSUk9XX1JBRElVUyIsIk1BWF9SQURJVVNfU0NBTEUiLCJNQVhfQkFTRUxJTkVfV0lEVEgiLCJNQVhfQkFTRUxJTkVfU0NBTEUiLCJMQUJFTF9PRkZTRVQiLCJBTkdMRV9VTkRFUl9CQVNFTElORV9USFJFU0hPTEQiLCJWZWN0b3JBbmdsZU5vZGUiLCJjb25zdHJ1Y3RvciIsInZlY3RvciIsImFuZ2xlc1Zpc2libGVQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybVByb3BlcnR5IiwiYXNzZXJ0IiwiYmFzZUxpbmUiLCJzdHJva2UiLCJCTEFDSyIsImN1cnZlZEFycm93IiwiYW5nbGUiLCJsYWJlbFRleHQiLCJmb250IiwiQU5HTEVfTEFCRUxfRk9OVCIsInNldENoaWxkcmVuIiwiYW5nbGVWaXNpYmxlTXVsdGlsaW5rIiwibXVsdGlsaW5rIiwiaXNPbkdyYXBoUHJvcGVydHkiLCJ2ZWN0b3JDb21wb25lbnRzUHJvcGVydHkiLCJhbmdsZVZpc2libGUiLCJpc09uR3JhcGgiLCJ2ZWN0b3JDb21wb25lbnRzIiwidmlzaWJsZSIsIm1hZ25pdHVkZSIsInVwZGF0ZUFuZ2xlTm9kZSIsInZhbHVlIiwiZGlzcG9zZVZlY3RvckFuZ2xlTm9kZSIsInVubXVsdGlsaW5rIiwiZGlzcG9zZSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImFuZ2xlRGVncmVlcyIsInNldEFuZ2xlIiwic2V0U3RyaW5nIiwidG9GaXhlZCIsIlZFQ1RPUl9WQUxVRV9ERUNJTUFMX1BMQUNFUyIsIkRFR1JFRVMiLCJ2aWV3TWFnbml0dWRlIiwibW9kZWxUb1ZpZXdEZWx0YVgiLCJzZXRSYWRpdXMiLCJfIiwibWluIiwic2V0WDIiLCJyYWRpdXMiLCJzZXRUcmFuc2xhdGlvbiIsIk1hdGgiLCJjb3MiLCJzaW4iLCJoZWlnaHQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlZlY3RvckFuZ2xlTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBWZWN0b3JBbmdsZU5vZGUgaXMgdGhlIGFuZ2xlIGluZGljYXRvciB0aGF0IGFwcGVhcnMgb24gdmVjdG9ycyBvbiB0aGUgZ3JhcGggd2hlbiB0aGUgYW5nbGUgY2hlY2tib3ggaXMgY2hlY2tlZC5cclxuICogT25seSBzaG93cyBpZiB0aGUgdmVjdG9yIG1vZGVsIGlzIGFjdGl2ZS5cclxuICpcclxuICogQGF1dGhvciBCcmFuZG9uIExpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1JlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgTWF0aFN5bWJvbHMgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL01hdGhTeW1ib2xzLmpzJztcclxuaW1wb3J0IHsgQ29sb3IsIExpbmUsIE5vZGUsIFRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgdmVjdG9yQWRkaXRpb24gZnJvbSAnLi4vLi4vdmVjdG9yQWRkaXRpb24uanMnO1xyXG5pbXBvcnQgVmVjdG9yIGZyb20gJy4uL21vZGVsL1ZlY3Rvci5qcyc7XHJcbmltcG9ydCBWZWN0b3JBZGRpdGlvbkNvbnN0YW50cyBmcm9tICcuLi9WZWN0b3JBZGRpdGlvbkNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBDdXJ2ZWRBcnJvd05vZGUgZnJvbSAnLi9DdXJ2ZWRBcnJvd05vZGUuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcblxyXG4vLyBtYXhpbXVtIHJhZGl1cyBvZiB0aGUgY3VydmVkIGFycm93IC0gdGhlIHJhZGl1cyBpcyBjaGFuZ2VkIHRvIGtlZXAgdGhlIGN1cnZlZCBhcnJvdyBzbWFsbGVyIHRoYW4gdGhlIHZlY3Rvci5cclxuY29uc3QgTUFYX0NVUlZFRF9BUlJPV19SQURJVVMgPSAyNTtcclxuXHJcbi8vIHRoZSBwZXJjZW50IHN5bWJvbCBvZiBjdXJ2ZWQgYXJyb3cgcmFkaXVzIHdoZW4gY29tcGFyZWQgdG8gdGhlIG1hZ25pdHVkZSBvZiB0aGUgdmVjdG9yIC0gYXMgbG9uZyBhcyBpdCdzIGxlc3MgdGhhblxyXG4vLyB0aGUgbWF4IGN1cnZlZCBhcnJvdyByYWRpdXNcclxuY29uc3QgTUFYX1JBRElVU19TQ0FMRSA9IDAuNzk7XHJcblxyXG4vLyBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgYmFzZWxpbmUgdGhhdCBpcyBwYXJhbGxlbCB0byB0aGUgeCBheGlzXHJcbmNvbnN0IE1BWF9CQVNFTElORV9XSURUSCA9IDU1O1xyXG5cclxuLy8gdGhlIG1heGltdW0gcGVyY2VudGFnZSBvZiB0aGUgYmFzZWxpbmUgd2hlbiBjb21wYXJlZCB0byB0aGUgcmFkaXVzIG9mIHRoZSBjdXJ2ZWQgYXJyb3cuXHJcbmNvbnN0IE1BWF9CQVNFTElORV9TQ0FMRSA9IDAuNjA7XHJcblxyXG4vLyB0aGUgb2Zmc2V0IG9mIHRoZSBhbmdsZSBsYWJlbCBmcm9tIHRoZSBjdXJ2ZWQgYXJyb3dcclxuY29uc3QgTEFCRUxfT0ZGU0VUID0gMy41O1xyXG5cclxuLy8gQW5nbGVzIGdyZWF0ZXIgdGhhbiAzNSBkZWcgcG9zaXRpb24gdGhlIGxhYmVsIGJldHdlZW4gdGhlIHZlY3RvciBhbmQgdGhlIGJhc2VsaW5lLCBhbmQgYW5nbGVzIHVuZGVyIDM1XHJcbi8vIHBsYWNlIHRoZSBsYWJlbCBvbiB0aGUgb3RoZXIgc2lkZSBvZiB0aGUgYmFzZWxpbmUuIFNlZVxyXG4vLyBodHRwczovL2RvY3MuZ29vZ2xlLmNvbS9kb2N1bWVudC9kLzFvcG5EZ3FJcUlyb284VkswQ2JPeVE1NjA4X2cxMU1TR1pYbkZsSThrNURzL2VkaXQjYm9va21hcms9aWQub241cDczYmJyeTdnLlxyXG5jb25zdCBBTkdMRV9VTkRFUl9CQVNFTElORV9USFJFU0hPTEQgPSAzNTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZlY3RvckFuZ2xlTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1ZlY3Rvcn0gdmVjdG9yIC0gdGhlIG1vZGVsIGZvciB0aGUgdmVjdG9yIHRoYXQgdGhlIGFuZ2xlIHJlcHJlc2VudHNcclxuICAgKiBAcGFyYW0ge0Jvb2xlYW5Qcm9wZXJ0eX0gYW5nbGVzVmlzaWJsZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtSZWFkT25seVByb3BlcnR5LjxNb2RlbFZpZXdUcmFuc2Zvcm0yPn0gbW9kZWxWaWV3VHJhbnNmb3JtUHJvcGVydHlcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggdmVjdG9yLCBhbmdsZXNWaXNpYmxlUHJvcGVydHksIG1vZGVsVmlld1RyYW5zZm9ybVByb3BlcnR5ICkge1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHZlY3RvciBpbnN0YW5jZW9mIFZlY3RvciwgYGludmFsaWQgdmVjdG9yOiAke3ZlY3Rvcn1gICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBhbmdsZXNWaXNpYmxlUHJvcGVydHkgaW5zdGFuY2VvZiBCb29sZWFuUHJvcGVydHksIGBpbnZhbGlkIGFuZ2xlc1Zpc2libGVQcm9wZXJ0eTogJHthbmdsZXNWaXNpYmxlUHJvcGVydHl9YCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggbW9kZWxWaWV3VHJhbnNmb3JtUHJvcGVydHkgaW5zdGFuY2VvZiBSZWFkT25seVByb3BlcnR5LCBgaW52YWxpZCBtb2RlbFZpZXdUcmFuc2Zvcm1Qcm9wZXJ0eTogJHttb2RlbFZpZXdUcmFuc2Zvcm1Qcm9wZXJ0eX1gICk7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7TGluZX0gYmFzZWxpbmUgLSBsaW5lIHRoYXQgaXMgcGFyYWxsZWwgdG8gdGhlIHggYXhpcy5cclxuICAgIHRoaXMuYmFzZUxpbmUgPSBuZXcgTGluZSggMCwgMCwgTUFYX0JBU0VMSU5FX1dJRFRILCAwLCB7IHN0cm9rZTogQ29sb3IuQkxBQ0sgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtDdXJ2ZWRBcnJvd05vZGV9IGN1cnZlZEFycm93IC0gYXJyb3cgaW4gYSBjaXJjbGUgc2hhcGUgZnJvbSB0aGUgYmFzZWxpbmUgdG8gdGhlIHZlY3RvclxyXG4gICAgdGhpcy5jdXJ2ZWRBcnJvdyA9IG5ldyBDdXJ2ZWRBcnJvd05vZGUoIE1BWF9DVVJWRURfQVJST1dfUkFESVVTLCB2ZWN0b3IuYW5nbGUgPyB2ZWN0b3IuYW5nbGUgOiAwICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge1RleHR9IGxhYmVsVGV4dCAtIHNldCB0byBhbiBhcmJpdHJhcnkgc3RyaW5nIGZvciBub3cuXHJcbiAgICB0aGlzLmxhYmVsVGV4dCA9IG5ldyBUZXh0KCAnJywgeyBmb250OiBWZWN0b3JBZGRpdGlvbkNvbnN0YW50cy5BTkdMRV9MQUJFTF9GT05UIH0gKTtcclxuXHJcbiAgICB0aGlzLnNldENoaWxkcmVuKCBbIHRoaXMuYmFzZUxpbmUsIHRoaXMuY3VydmVkQXJyb3csIHRoaXMubGFiZWxUZXh0IF0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGFuZ2xlIGFuZCBpdHMgdmlzaWJpbGl0eS4gTXVzdCBiZSBkaXNwb3NlZCBvbiBkaXNwb3NlLlxyXG4gICAgY29uc3QgYW5nbGVWaXNpYmxlTXVsdGlsaW5rID0gTXVsdGlsaW5rLm11bHRpbGluayhcclxuICAgICAgWyBhbmdsZXNWaXNpYmxlUHJvcGVydHksIHZlY3Rvci5pc09uR3JhcGhQcm9wZXJ0eSwgdmVjdG9yLnZlY3RvckNvbXBvbmVudHNQcm9wZXJ0eSBdLFxyXG4gICAgICAoIGFuZ2xlVmlzaWJsZSwgaXNPbkdyYXBoLCB2ZWN0b3JDb21wb25lbnRzICkgPT4ge1xyXG4gICAgICAgIHRoaXMudmlzaWJsZSA9ICggYW5nbGVWaXNpYmxlICYmIGlzT25HcmFwaCAmJiB2ZWN0b3IubWFnbml0dWRlICE9PSAwICk7XHJcbiAgICAgICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZUFuZ2xlTm9kZSggdmVjdG9yLCBtb2RlbFZpZXdUcmFuc2Zvcm1Qcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtmdW5jdGlvbn0gZGlzcG9zZVZlY3RvckFuZ2xlTm9kZSAtIGZ1bmN0aW9uIHRvIHVubGluayBsaXN0ZW5lcnMsIGNhbGxlZCBpbiBkaXNwb3NlKClcclxuICAgIHRoaXMuZGlzcG9zZVZlY3RvckFuZ2xlTm9kZSA9ICgpID0+IHtcclxuICAgICAgTXVsdGlsaW5rLnVubXVsdGlsaW5rKCBhbmdsZVZpc2libGVNdWx0aWxpbmsgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIHRoaXMuZGlzcG9zZVZlY3RvckFuZ2xlTm9kZSgpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB0aGUgYW5nbGUgbm9kZTogKGNhbGxlZCB3aGVuIHRoZSB2ZWN0b3IgbW9kZWwncyBjb21wb25lbnRzIGNoYW5nZSlcclxuICAgKiAgLSBDdXJ2ZWQgYXJyb3cgbm9kZSBhbmdsZVxyXG4gICAqICAtIEN1cnZlZCBhcnJvdyBub2RlIHJhZGl1c1xyXG4gICAqICAtIExhYmVsIFRleHRcclxuICAgKiAgLSBiYXNlbGluZSBsZW5ndGhcclxuICAgKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICogQHBhcmFtIHtWZWN0b3J9IHZlY3RvciAtIG1vZGVsIHZlY3RvciB0byBiYXNlIHRoZSBhbmdsZSBvZmYgb2ZcclxuICAgKiBAcGFyYW0ge01vZGVsVmlld1RyYW5zZm9ybTJ9IG1vZGVsVmlld1RyYW5zZm9ybVxyXG4gICAqL1xyXG4gIHVwZGF0ZUFuZ2xlTm9kZSggdmVjdG9yLCBtb2RlbFZpZXdUcmFuc2Zvcm0gKSB7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdmVjdG9yIGluc3RhbmNlb2YgVmVjdG9yLCBgaW52YWxpZCB2ZWN0b3I6ICR7dmVjdG9yfWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIG1vZGVsVmlld1RyYW5zZm9ybSBpbnN0YW5jZW9mIE1vZGVsVmlld1RyYW5zZm9ybTIsIGBpbnZhbGlkIG1vZGVsVmlld1RyYW5zZm9ybTogJHttb2RlbFZpZXdUcmFuc2Zvcm19YCApO1xyXG5cclxuICAgIC8vIGNvbnZlbmllbmNlIHJlZmVyZW5jZS5cclxuICAgIGNvbnN0IGFuZ2xlRGVncmVlcyA9IHZlY3Rvci5hbmdsZURlZ3JlZXM7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBjdXJ2ZWQgYXJyb3cgbm9kZSBhbmdsZVxyXG4gICAgdGhpcy5jdXJ2ZWRBcnJvdy5zZXRBbmdsZSggdmVjdG9yLmFuZ2xlID8gdmVjdG9yLmFuZ2xlIDogMCApO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgbGFiZWwgdGV4dC5cclxuICAgIHRoaXMubGFiZWxUZXh0LnNldFN0cmluZyhcclxuICAgICAgKCBhbmdsZURlZ3JlZXMgPT09IG51bGwgKSA/ICcnIDpcclxuICAgICAgYCR7VXRpbHMudG9GaXhlZCggYW5nbGVEZWdyZWVzLCBWZWN0b3JBZGRpdGlvbkNvbnN0YW50cy5WRUNUT1JfVkFMVUVfREVDSU1BTF9QTEFDRVMgKX0ke01hdGhTeW1ib2xzLkRFR1JFRVN9YFxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGN1cnZlZCBhcnJvdyByYWRpdXNcclxuICAgIGNvbnN0IHZpZXdNYWduaXR1ZGUgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIHZlY3Rvci5tYWduaXR1ZGUgKTtcclxuICAgIGlmICggdmlld01hZ25pdHVkZSAhPT0gMCApIHtcclxuICAgICAgdGhpcy5jdXJ2ZWRBcnJvdy5zZXRSYWRpdXMoIF8ubWluKCBbIE1BWF9SQURJVVNfU0NBTEUgKiB2aWV3TWFnbml0dWRlLCBNQVhfQ1VSVkVEX0FSUk9XX1JBRElVUyBdICkgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGJhc2VsaW5lXHJcbiAgICB0aGlzLmJhc2VMaW5lLnNldFgyKCBfLm1pbiggWyB0aGlzLmN1cnZlZEFycm93LnJhZGl1cyAvIE1BWF9CQVNFTElORV9TQ0FMRSwgTUFYX0JBU0VMSU5FX1dJRFRIIF0gKSApO1xyXG5cclxuICAgIC8vIFBvc2l0aW9uIHRoZSBsYWJlbCB0ZXh0XHJcbiAgICBpZiAoIGFuZ2xlRGVncmVlcyAhPT0gbnVsbCApIHtcclxuXHJcbiAgICAgIGlmICggYW5nbGVEZWdyZWVzID4gQU5HTEVfVU5ERVJfQkFTRUxJTkVfVEhSRVNIT0xEICkge1xyXG5cclxuICAgICAgICAvLyBQb3NpdGlvbiB0aGUgbGFiZWwgbmV4dCB0byB0aGUgYXJjLCBoYWxmd2F5IGFjcm9zcyB0aGUgYXJjXHJcbiAgICAgICAgdGhpcy5sYWJlbFRleHQuc2V0VHJhbnNsYXRpb24oICggdGhpcy5jdXJ2ZWRBcnJvdy5yYWRpdXMgKyBMQUJFTF9PRkZTRVQgKSAqIE1hdGguY29zKCB2ZWN0b3IuYW5nbGUgLyAyICksXHJcbiAgICAgICAgICAtKCB0aGlzLmN1cnZlZEFycm93LnJhZGl1cyArIExBQkVMX09GRlNFVCApICogTWF0aC5zaW4oIHZlY3Rvci5hbmdsZSAvIDIgKSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCBhbmdsZURlZ3JlZXMgPj0gMCApIHtcclxuXHJcbiAgICAgICAgLy8gUG9zaXRpb24gdGhlIGxhYmVsIGhhbGZ3YXkgYWNyb3NzLCBidXQgb24gdGhlIG90aGVyIHNpZGUgb2YgdGhlIGJhc2VsaW5lXHJcbiAgICAgICAgdGhpcy5sYWJlbFRleHQuc2V0VHJhbnNsYXRpb24oIHRoaXMuY3VydmVkQXJyb3cucmFkaXVzIC8gMiwgdGhpcy5jdXJ2ZWRBcnJvdy5yYWRpdXMgLyAyICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIGFuZ2xlRGVncmVlcyA+IC1BTkdMRV9VTkRFUl9CQVNFTElORV9USFJFU0hPTEQgKSB7XHJcblxyXG4gICAgICAgIC8vIFBvc2l0aW9uIHRoZSBsYWJlbCBoYWxmd2F5IGFjcm9zcywgYnV0IG9uIHRoZSBvdGhlciBzaWRlIG9mIHRoZSBiYXNlbGluZVxyXG4gICAgICAgIHRoaXMubGFiZWxUZXh0LnNldFRyYW5zbGF0aW9uKCB0aGlzLmN1cnZlZEFycm93LnJhZGl1cyAvIDIsXHJcbiAgICAgICAgICAtdGhpcy5jdXJ2ZWRBcnJvdy5yYWRpdXMgLyAyICsgdGhpcy5sYWJlbFRleHQuaGVpZ2h0IC8gMiApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBQb3NpdGlvbiB0aGUgbGFiZWwgbmV4dCB0byB0aGUgYXJjLCBoYWxmd2F5IGFjcm9zcyB0aGUgYXJjXHJcbiAgICAgICAgdGhpcy5sYWJlbFRleHQuc2V0VHJhbnNsYXRpb24oICggdGhpcy5jdXJ2ZWRBcnJvdy5yYWRpdXMgKyBMQUJFTF9PRkZTRVQgKSAqIE1hdGguY29zKCB2ZWN0b3IuYW5nbGUgLyAyICksXHJcbiAgICAgICAgICAtKCB0aGlzLmN1cnZlZEFycm93LnJhZGl1cyArIExBQkVMX09GRlNFVCApICogTWF0aC5zaW4oIHZlY3Rvci5hbmdsZSAvIDIgKSArIHRoaXMubGFiZWxUZXh0LmhlaWdodCAvIDJcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG52ZWN0b3JBZGRpdGlvbi5yZWdpc3RlciggJ1ZlY3RvckFuZ2xlTm9kZScsIFZlY3RvckFuZ2xlTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxnQkFBZ0IsTUFBTSx5Q0FBeUM7QUFDdEUsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxtQkFBbUIsTUFBTSx1REFBdUQ7QUFDdkYsT0FBT0MsV0FBVyxNQUFNLDRDQUE0QztBQUNwRSxTQUFTQyxLQUFLLEVBQUVDLElBQUksRUFBRUMsSUFBSSxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQzNFLE9BQU9DLGNBQWMsTUFBTSx5QkFBeUI7QUFDcEQsT0FBT0MsTUFBTSxNQUFNLG9CQUFvQjtBQUN2QyxPQUFPQyx1QkFBdUIsTUFBTSwrQkFBK0I7QUFDbkUsT0FBT0MsZUFBZSxNQUFNLHNCQUFzQjs7QUFFbEQ7O0FBRUE7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxFQUFFOztBQUVsQztBQUNBO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsSUFBSTs7QUFFN0I7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxFQUFFOztBQUU3QjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLElBQUk7O0FBRS9CO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLEdBQUc7O0FBRXhCO0FBQ0E7QUFDQTtBQUNB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