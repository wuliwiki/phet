// Copyright 2019-2023, University of Colorado Boulder

/**
 * VectorLabelNode is the label that appears on a vector.  It may show only the vector's symbol, or the vector's value.
 *
 * @author Brandon Li
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import Property from '../../../../axon/js/Property.js';
import merge from '../../../../phet-core/js/merge.js';
import MathSymbols from '../../../../scenery-phet/js/MathSymbols.js';
import { HBox, Node, Rectangle, Text } from '../../../../scenery/js/imports.js';
import vectorAddition from '../../vectorAddition.js';
import RootVector from '../model/RootVector.js';
import VectorAdditionColors from '../VectorAdditionColors.js';
import VectorAdditionConstants from '../VectorAdditionConstants.js';
import VectorSymbolNode from './VectorSymbolNode.js';
export default class VectorLabelNode extends Node {
  /**
   * @param {RootVector} rootVector
   * @param {BooleanProperty} valuesVisibleProperty
   * @param {Property.<RootVector|null>} activeVectorProperty
   * @param {Object} [options]
   */
  constructor(rootVector, valuesVisibleProperty, activeVectorProperty, options) {
    assert && assert(rootVector instanceof RootVector, `invalid rootVector: ${rootVector}`);
    assert && assert(valuesVisibleProperty instanceof BooleanProperty, `invalid valuesVisibleProperty: ${valuesVisibleProperty}`);
    assert && assert(activeVectorProperty instanceof Property && activeVectorProperty.value instanceof RootVector || activeVectorProperty.value === null, `invalid activeVectorProperty: ${activeVectorProperty}`);
    assert && assert(!options || Object.getPrototypeOf(options) === Object.prototype, `Extra prototype on options: ${options}`);
    options = merge({
      xMargin: 5,
      // {number} horizontal margin
      yMargin: 1,
      // {number} vertical margin
      symbolValueSpacing: 7 // {number} spacing between the vector symbol node and the value
    }, options);

    // Create the background rectangle, set as an arbitrary rectangle for now
    const backgroundRectangle = new Rectangle(0, 0, 1, 1, {
      fill: VectorAdditionConstants.INACTIVE_VECTOR_LABEL_BACKGROUND_FILL,
      stroke: VectorAdditionConstants.INACTIVE_VECTOR_LABEL_BACKGROUND_STROKE,
      cornerRadius: 4
    });

    // Create the VectorSymbolNode, set to arbitrary value for now.
    const vectorSymbolNode = new VectorSymbolNode({
      symbolFont: VectorAdditionConstants.VECTOR_LABEL_SYMBOL_FONT,
      font: VectorAdditionConstants.VECTOR_LABEL_FONT,
      spacing: 1
    });

    // Create the text for the value
    const vectorValueText = new Text('', {
      font: VectorAdditionConstants.VECTOR_LABEL_FONT
    });

    // Create a horizontal layout box for the symbol and the value
    const vectorLabelContent = new HBox({
      spacing: options.symbolValueSpacing,
      align: 'origin' // so that text baselines will be aligned
    });

    assert && assert(!options.children, 'VectorLabelNode sets children');
    options.children = [backgroundRectangle, vectorLabelContent];
    super(options);

    // @private
    this.rootVector = rootVector;
    this.valuesVisibleProperty = valuesVisibleProperty;
    this.activeVectorProperty = activeVectorProperty;
    this.xMargin = options.xMargin;
    this.yMargin = options.yMargin;
    this.backgroundRectangle = backgroundRectangle;
    this.vectorSymbolNode = vectorSymbolNode;
    this.vectorValueText = vectorValueText;
    this.vectorLabelContent = vectorLabelContent;

    // Observe changes to the model vector, and update the label node. Dispose is required.
    const labelMultilink = new Multilink([valuesVisibleProperty, rootVector.tailPositionProperty, rootVector.tipPositionProperty, activeVectorProperty], () => this.update());

    // @private {function} function to dispose listeners
    this.disposeVectorLabelNode = () => {
      labelMultilink.dispose();
    };
  }

  /**
   * @public
   * @override
   */
  dispose() {
    this.disposeVectorLabelNode();
    super.dispose();
  }

  /**
   * Updates the label and background rectangle.
   * @public
   */
  update() {
    // Get the label display information
    const labelDisplayData = this.rootVector.getLabelContent(this.valuesVisibleProperty.value);

    // Update the VectorSymbolNode
    this.vectorSymbolNode.setVectorSymbolNode(labelDisplayData.symbol, labelDisplayData.coefficient, labelDisplayData.includeAbsoluteValueBars);

    // Update the displayed value
    if (labelDisplayData.value) {
      const valueText = this.vectorSymbolNode.visible ? `${MathSymbols.EQUAL_TO} ${labelDisplayData.value}` : labelDisplayData.value;
      this.vectorValueText.setString(valueText);
    }

    // Toggle the visibility
    this.vectorValueText.visible = !!labelDisplayData.value;
    this.backgroundRectangle.visible = this.vectorSymbolNode.visible || this.vectorValueText.visible;

    // Update the children of the label content container
    this.vectorLabelContent.setChildren([this.vectorSymbolNode, this.vectorValueText].filter(node => node.visible));

    // Update the background
    if (this.backgroundRectangle.visible) {
      // Set the background size
      this.backgroundRectangle.setRectWidth(this.vectorLabelContent.width + 2 * this.xMargin);
      this.backgroundRectangle.setRectHeight(this.vectorLabelContent.height + 2 * this.yMargin);

      // Update positioning
      this.vectorLabelContent.center = this.backgroundRectangle.center;
    }
  }

  /**
   * Determines whether the label is highlighted.
   * @param {boolean} highlighted
   * @public
   */
  setHighlighted(highlighted) {
    if (highlighted) {
      this.backgroundRectangle.fill = VectorAdditionColors.ACTIVE_VECTOR_LABEL_BACKGROUND_FILL;
      this.backgroundRectangle.stroke = VectorAdditionColors.ACTIVE_VECTOR_LABEL_BACKGROUND_STROKE;
    } else {
      this.backgroundRectangle.fill = VectorAdditionColors.INACTIVE_VECTOR_LABEL_BACKGROUND_FILL;
      this.backgroundRectangle.stroke = VectorAdditionColors.INACTIVE_VECTOR_LABEL_BACKGROUND_STROKE;
    }
  }
}
vectorAddition.register('VectorLabelNode', VectorLabelNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJQcm9wZXJ0eSIsIm1lcmdlIiwiTWF0aFN5bWJvbHMiLCJIQm94IiwiTm9kZSIsIlJlY3RhbmdsZSIsIlRleHQiLCJ2ZWN0b3JBZGRpdGlvbiIsIlJvb3RWZWN0b3IiLCJWZWN0b3JBZGRpdGlvbkNvbG9ycyIsIlZlY3RvckFkZGl0aW9uQ29uc3RhbnRzIiwiVmVjdG9yU3ltYm9sTm9kZSIsIlZlY3RvckxhYmVsTm9kZSIsImNvbnN0cnVjdG9yIiwicm9vdFZlY3RvciIsInZhbHVlc1Zpc2libGVQcm9wZXJ0eSIsImFjdGl2ZVZlY3RvclByb3BlcnR5Iiwib3B0aW9ucyIsImFzc2VydCIsInZhbHVlIiwiT2JqZWN0IiwiZ2V0UHJvdG90eXBlT2YiLCJwcm90b3R5cGUiLCJ4TWFyZ2luIiwieU1hcmdpbiIsInN5bWJvbFZhbHVlU3BhY2luZyIsImJhY2tncm91bmRSZWN0YW5nbGUiLCJmaWxsIiwiSU5BQ1RJVkVfVkVDVE9SX0xBQkVMX0JBQ0tHUk9VTkRfRklMTCIsInN0cm9rZSIsIklOQUNUSVZFX1ZFQ1RPUl9MQUJFTF9CQUNLR1JPVU5EX1NUUk9LRSIsImNvcm5lclJhZGl1cyIsInZlY3RvclN5bWJvbE5vZGUiLCJzeW1ib2xGb250IiwiVkVDVE9SX0xBQkVMX1NZTUJPTF9GT05UIiwiZm9udCIsIlZFQ1RPUl9MQUJFTF9GT05UIiwic3BhY2luZyIsInZlY3RvclZhbHVlVGV4dCIsInZlY3RvckxhYmVsQ29udGVudCIsImFsaWduIiwiY2hpbGRyZW4iLCJsYWJlbE11bHRpbGluayIsInRhaWxQb3NpdGlvblByb3BlcnR5IiwidGlwUG9zaXRpb25Qcm9wZXJ0eSIsInVwZGF0ZSIsImRpc3Bvc2VWZWN0b3JMYWJlbE5vZGUiLCJkaXNwb3NlIiwibGFiZWxEaXNwbGF5RGF0YSIsImdldExhYmVsQ29udGVudCIsInNldFZlY3RvclN5bWJvbE5vZGUiLCJzeW1ib2wiLCJjb2VmZmljaWVudCIsImluY2x1ZGVBYnNvbHV0ZVZhbHVlQmFycyIsInZhbHVlVGV4dCIsInZpc2libGUiLCJFUVVBTF9UTyIsInNldFN0cmluZyIsInNldENoaWxkcmVuIiwiZmlsdGVyIiwibm9kZSIsInNldFJlY3RXaWR0aCIsIndpZHRoIiwic2V0UmVjdEhlaWdodCIsImhlaWdodCIsImNlbnRlciIsInNldEhpZ2hsaWdodGVkIiwiaGlnaGxpZ2h0ZWQiLCJBQ1RJVkVfVkVDVE9SX0xBQkVMX0JBQ0tHUk9VTkRfRklMTCIsIkFDVElWRV9WRUNUT1JfTEFCRUxfQkFDS0dST1VORF9TVFJPS0UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlZlY3RvckxhYmVsTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBWZWN0b3JMYWJlbE5vZGUgaXMgdGhlIGxhYmVsIHRoYXQgYXBwZWFycyBvbiBhIHZlY3Rvci4gIEl0IG1heSBzaG93IG9ubHkgdGhlIHZlY3RvcidzIHN5bWJvbCwgb3IgdGhlIHZlY3RvcidzIHZhbHVlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBNYXRoU3ltYm9scyBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvTWF0aFN5bWJvbHMuanMnO1xyXG5pbXBvcnQgeyBIQm94LCBOb2RlLCBSZWN0YW5nbGUsIFRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgdmVjdG9yQWRkaXRpb24gZnJvbSAnLi4vLi4vdmVjdG9yQWRkaXRpb24uanMnO1xyXG5pbXBvcnQgUm9vdFZlY3RvciBmcm9tICcuLi9tb2RlbC9Sb290VmVjdG9yLmpzJztcclxuaW1wb3J0IFZlY3RvckFkZGl0aW9uQ29sb3JzIGZyb20gJy4uL1ZlY3RvckFkZGl0aW9uQ29sb3JzLmpzJztcclxuaW1wb3J0IFZlY3RvckFkZGl0aW9uQ29uc3RhbnRzIGZyb20gJy4uL1ZlY3RvckFkZGl0aW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFZlY3RvclN5bWJvbE5vZGUgZnJvbSAnLi9WZWN0b3JTeW1ib2xOb2RlLmpzJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZlY3RvckxhYmVsTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1Jvb3RWZWN0b3J9IHJvb3RWZWN0b3JcclxuICAgKiBAcGFyYW0ge0Jvb2xlYW5Qcm9wZXJ0eX0gdmFsdWVzVmlzaWJsZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Um9vdFZlY3RvcnxudWxsPn0gYWN0aXZlVmVjdG9yUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHJvb3RWZWN0b3IsIHZhbHVlc1Zpc2libGVQcm9wZXJ0eSwgYWN0aXZlVmVjdG9yUHJvcGVydHksIG9wdGlvbnMgKSB7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggcm9vdFZlY3RvciBpbnN0YW5jZW9mIFJvb3RWZWN0b3IsIGBpbnZhbGlkIHJvb3RWZWN0b3I6ICR7cm9vdFZlY3Rvcn1gICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB2YWx1ZXNWaXNpYmxlUHJvcGVydHkgaW5zdGFuY2VvZiBCb29sZWFuUHJvcGVydHksIGBpbnZhbGlkIHZhbHVlc1Zpc2libGVQcm9wZXJ0eTogJHt2YWx1ZXNWaXNpYmxlUHJvcGVydHl9YCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggYWN0aXZlVmVjdG9yUHJvcGVydHkgaW5zdGFuY2VvZiBQcm9wZXJ0eSAmJiBhY3RpdmVWZWN0b3JQcm9wZXJ0eS52YWx1ZSBpbnN0YW5jZW9mIFJvb3RWZWN0b3IgfHwgYWN0aXZlVmVjdG9yUHJvcGVydHkudmFsdWUgPT09IG51bGwsXHJcbiAgICAgIGBpbnZhbGlkIGFjdGl2ZVZlY3RvclByb3BlcnR5OiAke2FjdGl2ZVZlY3RvclByb3BlcnR5fWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICFvcHRpb25zIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZiggb3B0aW9ucyApID09PSBPYmplY3QucHJvdG90eXBlLCBgRXh0cmEgcHJvdG90eXBlIG9uIG9wdGlvbnM6ICR7b3B0aW9uc31gICk7XHJcblxyXG4gICAgb3B0aW9ucyA9IG1lcmdlKCB7XHJcbiAgICAgIHhNYXJnaW46IDUsIC8vIHtudW1iZXJ9IGhvcml6b250YWwgbWFyZ2luXHJcbiAgICAgIHlNYXJnaW46IDEsICAvLyB7bnVtYmVyfSB2ZXJ0aWNhbCBtYXJnaW5cclxuICAgICAgc3ltYm9sVmFsdWVTcGFjaW5nOiA3IC8vIHtudW1iZXJ9IHNwYWNpbmcgYmV0d2VlbiB0aGUgdmVjdG9yIHN5bWJvbCBub2RlIGFuZCB0aGUgdmFsdWVcclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIGJhY2tncm91bmQgcmVjdGFuZ2xlLCBzZXQgYXMgYW4gYXJiaXRyYXJ5IHJlY3RhbmdsZSBmb3Igbm93XHJcbiAgICBjb25zdCBiYWNrZ3JvdW5kUmVjdGFuZ2xlID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMSwgMSwge1xyXG4gICAgICBmaWxsOiBWZWN0b3JBZGRpdGlvbkNvbnN0YW50cy5JTkFDVElWRV9WRUNUT1JfTEFCRUxfQkFDS0dST1VORF9GSUxMLFxyXG4gICAgICBzdHJva2U6IFZlY3RvckFkZGl0aW9uQ29uc3RhbnRzLklOQUNUSVZFX1ZFQ1RPUl9MQUJFTF9CQUNLR1JPVU5EX1NUUk9LRSxcclxuICAgICAgY29ybmVyUmFkaXVzOiA0XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBWZWN0b3JTeW1ib2xOb2RlLCBzZXQgdG8gYXJiaXRyYXJ5IHZhbHVlIGZvciBub3cuXHJcbiAgICBjb25zdCB2ZWN0b3JTeW1ib2xOb2RlID0gbmV3IFZlY3RvclN5bWJvbE5vZGUoIHtcclxuICAgICAgc3ltYm9sRm9udDogVmVjdG9yQWRkaXRpb25Db25zdGFudHMuVkVDVE9SX0xBQkVMX1NZTUJPTF9GT05ULFxyXG4gICAgICBmb250OiBWZWN0b3JBZGRpdGlvbkNvbnN0YW50cy5WRUNUT1JfTEFCRUxfRk9OVCxcclxuICAgICAgc3BhY2luZzogMVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIENyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIHZhbHVlXHJcbiAgICBjb25zdCB2ZWN0b3JWYWx1ZVRleHQgPSBuZXcgVGV4dCggJycsIHsgZm9udDogVmVjdG9yQWRkaXRpb25Db25zdGFudHMuVkVDVE9SX0xBQkVMX0ZPTlQgfSApO1xyXG5cclxuICAgIC8vIENyZWF0ZSBhIGhvcml6b250YWwgbGF5b3V0IGJveCBmb3IgdGhlIHN5bWJvbCBhbmQgdGhlIHZhbHVlXHJcbiAgICBjb25zdCB2ZWN0b3JMYWJlbENvbnRlbnQgPSBuZXcgSEJveCgge1xyXG4gICAgICBzcGFjaW5nOiBvcHRpb25zLnN5bWJvbFZhbHVlU3BhY2luZyxcclxuICAgICAgYWxpZ246ICdvcmlnaW4nIC8vIHNvIHRoYXQgdGV4dCBiYXNlbGluZXMgd2lsbCBiZSBhbGlnbmVkXHJcbiAgICB9ICk7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggIW9wdGlvbnMuY2hpbGRyZW4sICdWZWN0b3JMYWJlbE5vZGUgc2V0cyBjaGlsZHJlbicgKTtcclxuICAgIG9wdGlvbnMuY2hpbGRyZW4gPSBbIGJhY2tncm91bmRSZWN0YW5nbGUsIHZlY3RvckxhYmVsQ29udGVudCBdO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMucm9vdFZlY3RvciA9IHJvb3RWZWN0b3I7XHJcbiAgICB0aGlzLnZhbHVlc1Zpc2libGVQcm9wZXJ0eSA9IHZhbHVlc1Zpc2libGVQcm9wZXJ0eTtcclxuICAgIHRoaXMuYWN0aXZlVmVjdG9yUHJvcGVydHkgPSBhY3RpdmVWZWN0b3JQcm9wZXJ0eTtcclxuICAgIHRoaXMueE1hcmdpbiA9IG9wdGlvbnMueE1hcmdpbjtcclxuICAgIHRoaXMueU1hcmdpbiA9IG9wdGlvbnMueU1hcmdpbjtcclxuICAgIHRoaXMuYmFja2dyb3VuZFJlY3RhbmdsZSA9IGJhY2tncm91bmRSZWN0YW5nbGU7XHJcbiAgICB0aGlzLnZlY3RvclN5bWJvbE5vZGUgPSB2ZWN0b3JTeW1ib2xOb2RlO1xyXG4gICAgdGhpcy52ZWN0b3JWYWx1ZVRleHQgPSB2ZWN0b3JWYWx1ZVRleHQ7XHJcbiAgICB0aGlzLnZlY3RvckxhYmVsQ29udGVudCA9IHZlY3RvckxhYmVsQ29udGVudDtcclxuXHJcbiAgICAvLyBPYnNlcnZlIGNoYW5nZXMgdG8gdGhlIG1vZGVsIHZlY3RvciwgYW5kIHVwZGF0ZSB0aGUgbGFiZWwgbm9kZS4gRGlzcG9zZSBpcyByZXF1aXJlZC5cclxuICAgIGNvbnN0IGxhYmVsTXVsdGlsaW5rID0gbmV3IE11bHRpbGluayhcclxuICAgICAgWyB2YWx1ZXNWaXNpYmxlUHJvcGVydHksIHJvb3RWZWN0b3IudGFpbFBvc2l0aW9uUHJvcGVydHksIHJvb3RWZWN0b3IudGlwUG9zaXRpb25Qcm9wZXJ0eSwgYWN0aXZlVmVjdG9yUHJvcGVydHkgXSxcclxuICAgICAgKCkgPT4gdGhpcy51cGRhdGUoKVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7ZnVuY3Rpb259IGZ1bmN0aW9uIHRvIGRpc3Bvc2UgbGlzdGVuZXJzXHJcbiAgICB0aGlzLmRpc3Bvc2VWZWN0b3JMYWJlbE5vZGUgPSAoKSA9PiB7XHJcbiAgICAgIGxhYmVsTXVsdGlsaW5rLmRpc3Bvc2UoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIHRoaXMuZGlzcG9zZVZlY3RvckxhYmVsTm9kZSgpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB0aGUgbGFiZWwgYW5kIGJhY2tncm91bmQgcmVjdGFuZ2xlLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICB1cGRhdGUoKSB7XHJcblxyXG4gICAgLy8gR2V0IHRoZSBsYWJlbCBkaXNwbGF5IGluZm9ybWF0aW9uXHJcbiAgICBjb25zdCBsYWJlbERpc3BsYXlEYXRhID0gdGhpcy5yb290VmVjdG9yLmdldExhYmVsQ29udGVudCggdGhpcy52YWx1ZXNWaXNpYmxlUHJvcGVydHkudmFsdWUgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIFZlY3RvclN5bWJvbE5vZGVcclxuICAgIHRoaXMudmVjdG9yU3ltYm9sTm9kZS5zZXRWZWN0b3JTeW1ib2xOb2RlKCBsYWJlbERpc3BsYXlEYXRhLnN5bWJvbCxcclxuICAgICAgbGFiZWxEaXNwbGF5RGF0YS5jb2VmZmljaWVudCxcclxuICAgICAgbGFiZWxEaXNwbGF5RGF0YS5pbmNsdWRlQWJzb2x1dGVWYWx1ZUJhcnMgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGRpc3BsYXllZCB2YWx1ZVxyXG4gICAgaWYgKCBsYWJlbERpc3BsYXlEYXRhLnZhbHVlICkge1xyXG4gICAgICBjb25zdCB2YWx1ZVRleHQgPSB0aGlzLnZlY3RvclN5bWJvbE5vZGUudmlzaWJsZSA/IGAke01hdGhTeW1ib2xzLkVRVUFMX1RPfSAke2xhYmVsRGlzcGxheURhdGEudmFsdWV9YCA6IGxhYmVsRGlzcGxheURhdGEudmFsdWU7XHJcbiAgICAgIHRoaXMudmVjdG9yVmFsdWVUZXh0LnNldFN0cmluZyggdmFsdWVUZXh0ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVG9nZ2xlIHRoZSB2aXNpYmlsaXR5XHJcbiAgICB0aGlzLnZlY3RvclZhbHVlVGV4dC52aXNpYmxlID0gISFsYWJlbERpc3BsYXlEYXRhLnZhbHVlO1xyXG4gICAgdGhpcy5iYWNrZ3JvdW5kUmVjdGFuZ2xlLnZpc2libGUgPSAoIHRoaXMudmVjdG9yU3ltYm9sTm9kZS52aXNpYmxlIHx8IHRoaXMudmVjdG9yVmFsdWVUZXh0LnZpc2libGUgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGNoaWxkcmVuIG9mIHRoZSBsYWJlbCBjb250ZW50IGNvbnRhaW5lclxyXG4gICAgdGhpcy52ZWN0b3JMYWJlbENvbnRlbnQuc2V0Q2hpbGRyZW4oXHJcbiAgICAgIFsgdGhpcy52ZWN0b3JTeW1ib2xOb2RlLCB0aGlzLnZlY3RvclZhbHVlVGV4dCBdLmZpbHRlciggbm9kZSA9PiAoIG5vZGUudmlzaWJsZSApIClcclxuICAgICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBiYWNrZ3JvdW5kXHJcbiAgICBpZiAoIHRoaXMuYmFja2dyb3VuZFJlY3RhbmdsZS52aXNpYmxlICkge1xyXG5cclxuICAgICAgLy8gU2V0IHRoZSBiYWNrZ3JvdW5kIHNpemVcclxuICAgICAgdGhpcy5iYWNrZ3JvdW5kUmVjdGFuZ2xlLnNldFJlY3RXaWR0aCggdGhpcy52ZWN0b3JMYWJlbENvbnRlbnQud2lkdGggKyAyICogdGhpcy54TWFyZ2luICk7XHJcbiAgICAgIHRoaXMuYmFja2dyb3VuZFJlY3RhbmdsZS5zZXRSZWN0SGVpZ2h0KCB0aGlzLnZlY3RvckxhYmVsQ29udGVudC5oZWlnaHQgKyAyICogdGhpcy55TWFyZ2luICk7XHJcblxyXG4gICAgICAvLyBVcGRhdGUgcG9zaXRpb25pbmdcclxuICAgICAgdGhpcy52ZWN0b3JMYWJlbENvbnRlbnQuY2VudGVyID0gdGhpcy5iYWNrZ3JvdW5kUmVjdGFuZ2xlLmNlbnRlcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERldGVybWluZXMgd2hldGhlciB0aGUgbGFiZWwgaXMgaGlnaGxpZ2h0ZWQuXHJcbiAgICogQHBhcmFtIHtib29sZWFufSBoaWdobGlnaHRlZFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzZXRIaWdobGlnaHRlZCggaGlnaGxpZ2h0ZWQgKSB7XHJcbiAgICBpZiAoIGhpZ2hsaWdodGVkICkge1xyXG4gICAgICB0aGlzLmJhY2tncm91bmRSZWN0YW5nbGUuZmlsbCA9IFZlY3RvckFkZGl0aW9uQ29sb3JzLkFDVElWRV9WRUNUT1JfTEFCRUxfQkFDS0dST1VORF9GSUxMO1xyXG4gICAgICB0aGlzLmJhY2tncm91bmRSZWN0YW5nbGUuc3Ryb2tlID0gVmVjdG9yQWRkaXRpb25Db2xvcnMuQUNUSVZFX1ZFQ1RPUl9MQUJFTF9CQUNLR1JPVU5EX1NUUk9LRTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmJhY2tncm91bmRSZWN0YW5nbGUuZmlsbCA9IFZlY3RvckFkZGl0aW9uQ29sb3JzLklOQUNUSVZFX1ZFQ1RPUl9MQUJFTF9CQUNLR1JPVU5EX0ZJTEw7XHJcbiAgICAgIHRoaXMuYmFja2dyb3VuZFJlY3RhbmdsZS5zdHJva2UgPSBWZWN0b3JBZGRpdGlvbkNvbG9ycy5JTkFDVElWRV9WRUNUT1JfTEFCRUxfQkFDS0dST1VORF9TVFJPS0U7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG52ZWN0b3JBZGRpdGlvbi5yZWdpc3RlciggJ1ZlY3RvckxhYmVsTm9kZScsIFZlY3RvckxhYmVsTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFB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