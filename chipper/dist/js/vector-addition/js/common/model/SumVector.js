// Copyright 2019-2023, University of Colorado Boulder

/**
 * SumVector is the model of a sum vector. A sum vector is the sum of all vectors for one VectorSet.
 * However, it's not as simple as just a quick add up, as vectors can change states and go from being on the graph to
 * off of the graph or vise versa.
 *
 * SumVectors can be directly manipulated. They can be translated, but not rotated or scale.
 *
 * SumVectors are created at the start of the sim, and exist for the lifetime of the sim.
 *
 * @author Martin Veillette
 * @author Brandon Li
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import merge from '../../../../phet-core/js/merge.js';
import vectorAddition from '../../vectorAddition.js';
import VectorAdditionConstants from '../VectorAdditionConstants.js';
import Vector from './Vector.js';

// constants
const SUM_VECTOR_OPTIONS = {
  isTipDraggable: false,
  // Sum vectors are not draggable by the tip.
  isRemovable: false,
  // Sum vectors are not removable which means they are also not disposable
  isOnGraphInitially: true // Sum vectors are always on the graph
};

export default class SumVector extends Vector {
  /**
   * @param {Vector2} initialTailPosition - starting tail position of the vector
   * @param {Graph} graph - graph the sum vector belongs to
   * @param {VectorSet} vectorSet - the VectorSet that the sum represents
   * @param {string|null} symbol - the symbol for the sum vector (e.g. 's', 'c', 'f')
   */
  constructor(initialTailPosition, graph, vectorSet, symbol) {
    // Initialize an arbitrary vector model. Its components and magnitude to be set later.
    super(initialTailPosition, Vector2.ZERO, graph, vectorSet, symbol, SUM_VECTOR_OPTIONS);

    // @public (read-only) whether the sum is defined.  The sum is defined if there is at least one vector on
    // the graph. It would be preferable to set its Vector2 value to null, but this was discovered very late
    // in development, when that was not practical. See https://github.com/phetsims/vector-addition/issues/187
    this.isDefinedProperty = new BooleanProperty(vectorSet.vectors.lengthProperty.value > 0);

    // Observe changes to the vector array. Never removed because SumVectors exists for the lifetime of the sim.
    vectorSet.vectors.addItemAddedListener(addedVector => {
      // When the vector changes, update the sum calculation. unmultilink is required when the vector is removed.
      const addedVectorMultilink = Multilink.multilink([addedVector.vectorComponentsProperty, addedVector.isOnGraphProperty], () => {
        this.updateSum(vectorSet.vectors);
      });

      // If the vector is removed, dispose of the multilink
      const vectorRemovedListener = removedVector => {
        if (removedVector === addedVector) {
          // Recalculate the sum
          this.updateSum(vectorSet.vectors);
          Multilink.unmultilink(addedVectorMultilink);
          vectorSet.vectors.removeItemRemovedListener(vectorRemovedListener);
        }
      };
      vectorSet.vectors.addItemRemovedListener(vectorRemovedListener);
    });
  }

  /**
   * @public
   * @override
   */
  dispose() {
    assert && assert(false, 'SumVector is not intended to be disposed');
  }

  /**
   * Update the sum vector components. Calculated from all the vectors that are on the graph.
   * @protected
   *
   * @param {ObservableArrayDef.<VectorsModel>} vectors
   */
  updateSum(vectors) {
    // Filter to get only the vectors that are on the graph
    const onGraphVectors = vectors.filter(vector => {
      return vector.isOnGraphProperty.value;
    });

    // Loop through and calculate the sum of all vectors that are on the graph
    const sumVectorComponents = new Vector2(0, 0);
    onGraphVectors.forEach(vector => {
      sumVectorComponents.add(vector.vectorComponents);
    });

    // Set the sum to the calculated sum
    this.vectorComponents = sumVectorComponents;

    // The sum is defined if there is at least one vector on the graph.
    this.isDefinedProperty.value = onGraphVectors.length > 0;
  }

  /**
   * Gets the label content information to be displayed on the vector.
   * See RootVector.getLabelContent for details.
   * @override
   * @public
   * @param {boolean} valuesVisible - whether the values are visible
   * @returns {Object} see RootVector.getLabelContent
   */
  getLabelContent(valuesVisible) {
    // The sum vector displays its symbol when:
    // - there is only one sum vector on the graph (see #241), or
    // - the sum vector is selected, or
    // - a vector in the sum's vector set is selected
    const activeVector = this.graph.activeVectorProperty.value;
    const isSymbolDisplayed = this.graph.vectorSets.length === 1 || activeVector === this || this.vectorSet.vectors.some(vector => vector === activeVector);
    if (isSymbolDisplayed) {
      // No change in behavior - do like we do for other vectors.
      return super.getLabelContent(valuesVisible);
    } else {
      // Omit the symbol, display only the value, if values are visible.
      const roundedMagnitude = Utils.toFixed(this.magnitude, VectorAdditionConstants.VECTOR_VALUE_DECIMAL_PLACES);
      return merge(super.getLabelContent(valuesVisible), {
        symbol: null,
        includeAbsoluteValueBars: false,
        value: valuesVisible ? roundedMagnitude : null
      });
    }
  }
}
vectorAddition.register('SumVector', SumVector);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJVdGlscyIsIlZlY3RvcjIiLCJtZXJnZSIsInZlY3RvckFkZGl0aW9uIiwiVmVjdG9yQWRkaXRpb25Db25zdGFudHMiLCJWZWN0b3IiLCJTVU1fVkVDVE9SX09QVElPTlMiLCJpc1RpcERyYWdnYWJsZSIsImlzUmVtb3ZhYmxlIiwiaXNPbkdyYXBoSW5pdGlhbGx5IiwiU3VtVmVjdG9yIiwiY29uc3RydWN0b3IiLCJpbml0aWFsVGFpbFBvc2l0aW9uIiwiZ3JhcGgiLCJ2ZWN0b3JTZXQiLCJzeW1ib2wiLCJaRVJPIiwiaXNEZWZpbmVkUHJvcGVydHkiLCJ2ZWN0b3JzIiwibGVuZ3RoUHJvcGVydHkiLCJ2YWx1ZSIsImFkZEl0ZW1BZGRlZExpc3RlbmVyIiwiYWRkZWRWZWN0b3IiLCJhZGRlZFZlY3Rvck11bHRpbGluayIsIm11bHRpbGluayIsInZlY3RvckNvbXBvbmVudHNQcm9wZXJ0eSIsImlzT25HcmFwaFByb3BlcnR5IiwidXBkYXRlU3VtIiwidmVjdG9yUmVtb3ZlZExpc3RlbmVyIiwicmVtb3ZlZFZlY3RvciIsInVubXVsdGlsaW5rIiwicmVtb3ZlSXRlbVJlbW92ZWRMaXN0ZW5lciIsImFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJkaXNwb3NlIiwiYXNzZXJ0Iiwib25HcmFwaFZlY3RvcnMiLCJmaWx0ZXIiLCJ2ZWN0b3IiLCJzdW1WZWN0b3JDb21wb25lbnRzIiwiZm9yRWFjaCIsImFkZCIsInZlY3RvckNvbXBvbmVudHMiLCJsZW5ndGgiLCJnZXRMYWJlbENvbnRlbnQiLCJ2YWx1ZXNWaXNpYmxlIiwiYWN0aXZlVmVjdG9yIiwiYWN0aXZlVmVjdG9yUHJvcGVydHkiLCJpc1N5bWJvbERpc3BsYXllZCIsInZlY3RvclNldHMiLCJzb21lIiwicm91bmRlZE1hZ25pdHVkZSIsInRvRml4ZWQiLCJtYWduaXR1ZGUiLCJWRUNUT1JfVkFMVUVfREVDSU1BTF9QTEFDRVMiLCJpbmNsdWRlQWJzb2x1dGVWYWx1ZUJhcnMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlN1bVZlY3Rvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTdW1WZWN0b3IgaXMgdGhlIG1vZGVsIG9mIGEgc3VtIHZlY3Rvci4gQSBzdW0gdmVjdG9yIGlzIHRoZSBzdW0gb2YgYWxsIHZlY3RvcnMgZm9yIG9uZSBWZWN0b3JTZXQuXHJcbiAqIEhvd2V2ZXIsIGl0J3Mgbm90IGFzIHNpbXBsZSBhcyBqdXN0IGEgcXVpY2sgYWRkIHVwLCBhcyB2ZWN0b3JzIGNhbiBjaGFuZ2Ugc3RhdGVzIGFuZCBnbyBmcm9tIGJlaW5nIG9uIHRoZSBncmFwaCB0b1xyXG4gKiBvZmYgb2YgdGhlIGdyYXBoIG9yIHZpc2UgdmVyc2EuXHJcbiAqXHJcbiAqIFN1bVZlY3RvcnMgY2FuIGJlIGRpcmVjdGx5IG1hbmlwdWxhdGVkLiBUaGV5IGNhbiBiZSB0cmFuc2xhdGVkLCBidXQgbm90IHJvdGF0ZWQgb3Igc2NhbGUuXHJcbiAqXHJcbiAqIFN1bVZlY3RvcnMgYXJlIGNyZWF0ZWQgYXQgdGhlIHN0YXJ0IG9mIHRoZSBzaW0sIGFuZCBleGlzdCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAqXHJcbiAqIEBhdXRob3IgTWFydGluIFZlaWxsZXR0ZVxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgdmVjdG9yQWRkaXRpb24gZnJvbSAnLi4vLi4vdmVjdG9yQWRkaXRpb24uanMnO1xyXG5pbXBvcnQgVmVjdG9yQWRkaXRpb25Db25zdGFudHMgZnJvbSAnLi4vVmVjdG9yQWRkaXRpb25Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yIGZyb20gJy4vVmVjdG9yLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBTVU1fVkVDVE9SX09QVElPTlMgPSB7XHJcbiAgaXNUaXBEcmFnZ2FibGU6IGZhbHNlLCAvLyBTdW0gdmVjdG9ycyBhcmUgbm90IGRyYWdnYWJsZSBieSB0aGUgdGlwLlxyXG4gIGlzUmVtb3ZhYmxlOiBmYWxzZSwgLy8gU3VtIHZlY3RvcnMgYXJlIG5vdCByZW1vdmFibGUgd2hpY2ggbWVhbnMgdGhleSBhcmUgYWxzbyBub3QgZGlzcG9zYWJsZVxyXG4gIGlzT25HcmFwaEluaXRpYWxseTogdHJ1ZSAvLyBTdW0gdmVjdG9ycyBhcmUgYWx3YXlzIG9uIHRoZSBncmFwaFxyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3VtVmVjdG9yIGV4dGVuZHMgVmVjdG9yIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtWZWN0b3IyfSBpbml0aWFsVGFpbFBvc2l0aW9uIC0gc3RhcnRpbmcgdGFpbCBwb3NpdGlvbiBvZiB0aGUgdmVjdG9yXHJcbiAgICogQHBhcmFtIHtHcmFwaH0gZ3JhcGggLSBncmFwaCB0aGUgc3VtIHZlY3RvciBiZWxvbmdzIHRvXHJcbiAgICogQHBhcmFtIHtWZWN0b3JTZXR9IHZlY3RvclNldCAtIHRoZSBWZWN0b3JTZXQgdGhhdCB0aGUgc3VtIHJlcHJlc2VudHNcclxuICAgKiBAcGFyYW0ge3N0cmluZ3xudWxsfSBzeW1ib2wgLSB0aGUgc3ltYm9sIGZvciB0aGUgc3VtIHZlY3RvciAoZS5nLiAncycsICdjJywgJ2YnKVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBpbml0aWFsVGFpbFBvc2l0aW9uLCBncmFwaCwgdmVjdG9yU2V0LCBzeW1ib2wgKSB7XHJcblxyXG4gICAgLy8gSW5pdGlhbGl6ZSBhbiBhcmJpdHJhcnkgdmVjdG9yIG1vZGVsLiBJdHMgY29tcG9uZW50cyBhbmQgbWFnbml0dWRlIHRvIGJlIHNldCBsYXRlci5cclxuICAgIHN1cGVyKCBpbml0aWFsVGFpbFBvc2l0aW9uLCBWZWN0b3IyLlpFUk8sIGdyYXBoLCB2ZWN0b3JTZXQsIHN5bWJvbCwgU1VNX1ZFQ1RPUl9PUFRJT05TICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSB3aGV0aGVyIHRoZSBzdW0gaXMgZGVmaW5lZC4gIFRoZSBzdW0gaXMgZGVmaW5lZCBpZiB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgdmVjdG9yIG9uXHJcbiAgICAvLyB0aGUgZ3JhcGguIEl0IHdvdWxkIGJlIHByZWZlcmFibGUgdG8gc2V0IGl0cyBWZWN0b3IyIHZhbHVlIHRvIG51bGwsIGJ1dCB0aGlzIHdhcyBkaXNjb3ZlcmVkIHZlcnkgbGF0ZVxyXG4gICAgLy8gaW4gZGV2ZWxvcG1lbnQsIHdoZW4gdGhhdCB3YXMgbm90IHByYWN0aWNhbC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy92ZWN0b3ItYWRkaXRpb24vaXNzdWVzLzE4N1xyXG4gICAgdGhpcy5pc0RlZmluZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIHZlY3RvclNldC52ZWN0b3JzLmxlbmd0aFByb3BlcnR5LnZhbHVlID4gMCApO1xyXG5cclxuICAgIC8vIE9ic2VydmUgY2hhbmdlcyB0byB0aGUgdmVjdG9yIGFycmF5LiBOZXZlciByZW1vdmVkIGJlY2F1c2UgU3VtVmVjdG9ycyBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltLlxyXG4gICAgdmVjdG9yU2V0LnZlY3RvcnMuYWRkSXRlbUFkZGVkTGlzdGVuZXIoIGFkZGVkVmVjdG9yID0+IHtcclxuXHJcbiAgICAgIC8vIFdoZW4gdGhlIHZlY3RvciBjaGFuZ2VzLCB1cGRhdGUgdGhlIHN1bSBjYWxjdWxhdGlvbi4gdW5tdWx0aWxpbmsgaXMgcmVxdWlyZWQgd2hlbiB0aGUgdmVjdG9yIGlzIHJlbW92ZWQuXHJcbiAgICAgIGNvbnN0IGFkZGVkVmVjdG9yTXVsdGlsaW5rID0gTXVsdGlsaW5rLm11bHRpbGluayhcclxuICAgICAgICBbIGFkZGVkVmVjdG9yLnZlY3RvckNvbXBvbmVudHNQcm9wZXJ0eSwgYWRkZWRWZWN0b3IuaXNPbkdyYXBoUHJvcGVydHkgXSwgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVTdW0oIHZlY3RvclNldC52ZWN0b3JzICk7XHJcbiAgICAgICAgfSApO1xyXG5cclxuICAgICAgLy8gSWYgdGhlIHZlY3RvciBpcyByZW1vdmVkLCBkaXNwb3NlIG9mIHRoZSBtdWx0aWxpbmtcclxuICAgICAgY29uc3QgdmVjdG9yUmVtb3ZlZExpc3RlbmVyID0gcmVtb3ZlZFZlY3RvciA9PiB7XHJcbiAgICAgICAgaWYgKCByZW1vdmVkVmVjdG9yID09PSBhZGRlZFZlY3RvciApIHtcclxuXHJcbiAgICAgICAgICAvLyBSZWNhbGN1bGF0ZSB0aGUgc3VtXHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZVN1bSggdmVjdG9yU2V0LnZlY3RvcnMgKTtcclxuXHJcbiAgICAgICAgICBNdWx0aWxpbmsudW5tdWx0aWxpbmsoIGFkZGVkVmVjdG9yTXVsdGlsaW5rICk7XHJcbiAgICAgICAgICB2ZWN0b3JTZXQudmVjdG9ycy5yZW1vdmVJdGVtUmVtb3ZlZExpc3RlbmVyKCB2ZWN0b3JSZW1vdmVkTGlzdGVuZXIgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICB2ZWN0b3JTZXQudmVjdG9ycy5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCB2ZWN0b3JSZW1vdmVkTGlzdGVuZXIgKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZmFsc2UsICdTdW1WZWN0b3IgaXMgbm90IGludGVuZGVkIHRvIGJlIGRpc3Bvc2VkJyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlIHRoZSBzdW0gdmVjdG9yIGNvbXBvbmVudHMuIENhbGN1bGF0ZWQgZnJvbSBhbGwgdGhlIHZlY3RvcnMgdGhhdCBhcmUgb24gdGhlIGdyYXBoLlxyXG4gICAqIEBwcm90ZWN0ZWRcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7T2JzZXJ2YWJsZUFycmF5RGVmLjxWZWN0b3JzTW9kZWw+fSB2ZWN0b3JzXHJcbiAgICovXHJcbiAgdXBkYXRlU3VtKCB2ZWN0b3JzICkge1xyXG5cclxuICAgIC8vIEZpbHRlciB0byBnZXQgb25seSB0aGUgdmVjdG9ycyB0aGF0IGFyZSBvbiB0aGUgZ3JhcGhcclxuICAgIGNvbnN0IG9uR3JhcGhWZWN0b3JzID0gdmVjdG9ycy5maWx0ZXIoIHZlY3RvciA9PiB7XHJcbiAgICAgIHJldHVybiB2ZWN0b3IuaXNPbkdyYXBoUHJvcGVydHkudmFsdWU7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gTG9vcCB0aHJvdWdoIGFuZCBjYWxjdWxhdGUgdGhlIHN1bSBvZiBhbGwgdmVjdG9ycyB0aGF0IGFyZSBvbiB0aGUgZ3JhcGhcclxuICAgIGNvbnN0IHN1bVZlY3RvckNvbXBvbmVudHMgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG5cclxuICAgIG9uR3JhcGhWZWN0b3JzLmZvckVhY2goIHZlY3RvciA9PiB7XHJcbiAgICAgIHN1bVZlY3RvckNvbXBvbmVudHMuYWRkKCB2ZWN0b3IudmVjdG9yQ29tcG9uZW50cyApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFNldCB0aGUgc3VtIHRvIHRoZSBjYWxjdWxhdGVkIHN1bVxyXG4gICAgdGhpcy52ZWN0b3JDb21wb25lbnRzID0gc3VtVmVjdG9yQ29tcG9uZW50cztcclxuXHJcbiAgICAvLyBUaGUgc3VtIGlzIGRlZmluZWQgaWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHZlY3RvciBvbiB0aGUgZ3JhcGguXHJcbiAgICB0aGlzLmlzRGVmaW5lZFByb3BlcnR5LnZhbHVlID0gKCBvbkdyYXBoVmVjdG9ycy5sZW5ndGggPiAwICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBsYWJlbCBjb250ZW50IGluZm9ybWF0aW9uIHRvIGJlIGRpc3BsYXllZCBvbiB0aGUgdmVjdG9yLlxyXG4gICAqIFNlZSBSb290VmVjdG9yLmdldExhYmVsQ29udGVudCBmb3IgZGV0YWlscy5cclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKiBAcHVibGljXHJcbiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZXNWaXNpYmxlIC0gd2hldGhlciB0aGUgdmFsdWVzIGFyZSB2aXNpYmxlXHJcbiAgICogQHJldHVybnMge09iamVjdH0gc2VlIFJvb3RWZWN0b3IuZ2V0TGFiZWxDb250ZW50XHJcbiAgICovXHJcbiAgZ2V0TGFiZWxDb250ZW50KCB2YWx1ZXNWaXNpYmxlICkge1xyXG5cclxuICAgIC8vIFRoZSBzdW0gdmVjdG9yIGRpc3BsYXlzIGl0cyBzeW1ib2wgd2hlbjpcclxuICAgIC8vIC0gdGhlcmUgaXMgb25seSBvbmUgc3VtIHZlY3RvciBvbiB0aGUgZ3JhcGggKHNlZSAjMjQxKSwgb3JcclxuICAgIC8vIC0gdGhlIHN1bSB2ZWN0b3IgaXMgc2VsZWN0ZWQsIG9yXHJcbiAgICAvLyAtIGEgdmVjdG9yIGluIHRoZSBzdW0ncyB2ZWN0b3Igc2V0IGlzIHNlbGVjdGVkXHJcbiAgICBjb25zdCBhY3RpdmVWZWN0b3IgPSB0aGlzLmdyYXBoLmFjdGl2ZVZlY3RvclByb3BlcnR5LnZhbHVlO1xyXG4gICAgY29uc3QgaXNTeW1ib2xEaXNwbGF5ZWQgPSB0aGlzLmdyYXBoLnZlY3RvclNldHMubGVuZ3RoID09PSAxIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVZlY3RvciA9PT0gdGhpcyB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlY3RvclNldC52ZWN0b3JzLnNvbWUoIHZlY3RvciA9PiB2ZWN0b3IgPT09IGFjdGl2ZVZlY3RvciApO1xyXG5cclxuICAgIGlmICggaXNTeW1ib2xEaXNwbGF5ZWQgKSB7XHJcblxyXG4gICAgICAvLyBObyBjaGFuZ2UgaW4gYmVoYXZpb3IgLSBkbyBsaWtlIHdlIGRvIGZvciBvdGhlciB2ZWN0b3JzLlxyXG4gICAgICByZXR1cm4gc3VwZXIuZ2V0TGFiZWxDb250ZW50KCB2YWx1ZXNWaXNpYmxlICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuXHJcbiAgICAgIC8vIE9taXQgdGhlIHN5bWJvbCwgZGlzcGxheSBvbmx5IHRoZSB2YWx1ZSwgaWYgdmFsdWVzIGFyZSB2aXNpYmxlLlxyXG4gICAgICBjb25zdCByb3VuZGVkTWFnbml0dWRlID0gVXRpbHMudG9GaXhlZCggdGhpcy5tYWduaXR1ZGUsIFZlY3RvckFkZGl0aW9uQ29uc3RhbnRzLlZFQ1RPUl9WQUxVRV9ERUNJTUFMX1BMQUNFUyApO1xyXG4gICAgICByZXR1cm4gbWVyZ2UoIHN1cGVyLmdldExhYmVsQ29udGVudCggdmFsdWVzVmlzaWJsZSApLCB7XHJcbiAgICAgICAgc3ltYm9sOiBudWxsLFxyXG4gICAgICAgIGluY2x1ZGVBYnNvbHV0ZVZhbHVlQmFyczogZmFsc2UsXHJcbiAgICAgICAgdmFsdWU6IHZhbHVlc1Zpc2libGUgPyByb3VuZGVkTWFnbml0dWRlIDogbnVsbFxyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG52ZWN0b3JBZGRpdGlvbi5yZWdpc3RlciggJ1N1bVZlY3RvcicsIFN1bVZlY3RvciApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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