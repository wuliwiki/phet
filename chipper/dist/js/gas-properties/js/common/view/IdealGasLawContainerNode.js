// Copyright 2018-2022, University of Colorado Boulder

/**
 * IdealGasLawContainerNode is the view of the container used in screens that are based on the Ideal Gas Law.
 * This container has mutable width, and a lid that can be moved/removed.
 * Do not transform this Node! It's origin must be at the origin of the view coordinate frame.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Utils from '../../../../dot/js/Utils.js';
import { Shape } from '../../../../kite/js/imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import HandleNode from '../../../../scenery-phet/js/HandleNode.js';
import { Node, Path, Rectangle } from '../../../../scenery/js/imports.js';
import gasProperties from '../../gasProperties.js';
import GasPropertiesColors from '../GasPropertiesColors.js';
import ContainerResizeDragListener from './ContainerResizeDragListener.js';
import LidDragListener from './LidDragListener.js';
import LidNode from './LidNode.js';

// constants
const LID_X_SPEED = -50; // pixels/second
const LID_Y_SPEED = -150; // pixels/second
const LID_ROTATION_SPEED = -50; // degrees/second

export default class IdealGasLawContainerNode extends Node {
  constructor(container, modelViewTransform, holdConstantProperty, visibleBoundsProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      resizeGripColor: GasPropertiesColors.resizeGripColorProperty,
      // {ColorDef} color of resize handle's grip
      lidGripColor: GasPropertiesColors.lidGripColorProperty,
      // {ColorDef} color of the lid handle's grip
      resizeHandleIsPressedListener: _.noop
    }, providedOptions);

    // Constant aspects of the container, in view coordinates
    const viewWallThickness = modelViewTransform.modelToViewDeltaX(container.wallThickness);
    const viewOpeningLeftInset = modelViewTransform.modelToViewDeltaX(container.openingLeftInset);
    const viewOpeningRightInset = modelViewTransform.modelToViewDeltaX(container.openingRightInset);

    // Walls of the container
    const wallsNode = new Path(null, {
      stroke: GasPropertiesColors.containerBoundsStrokeProperty,
      lineWidth: viewWallThickness
    });

    // Previous bounds of the container, visible while dragging.
    // This is a simple rectangle, and does not need to show the previous opening in the top.
    const previousBoundsNode = new Rectangle(0, 0, 1, 1, {
      stroke: GasPropertiesColors.containerPreviousBoundsStrokeProperty,
      lineWidth: viewWallThickness,
      visible: false
    });

    // Resize handle on the left wall
    const resizeHandleNode = new HandleNode({
      cursor: 'pointer',
      gripBaseColor: options.resizeGripColor,
      attachmentLineWidth: 1,
      rotation: -Math.PI / 2,
      scale: 0.4
    });

    // Lid on the top of the container
    const lidNode = new LidNode(holdConstantProperty, {
      baseWidth: modelViewTransform.modelToViewDeltaX(container.lidWidthProperty.value),
      baseHeight: modelViewTransform.modelToViewDeltaX(container.lidThickness),
      gripColor: options.lidGripColor,
      tandem: options.tandem.createTandem('lidNode')
    });
    options.children = [previousBoundsNode, resizeHandleNode, wallsNode, lidNode];
    super(options);

    // reposition the bottom-left corner of the lid's base, handle may extend past this to the left
    const updateLidPosition = () => {
      lidNode.x = wallsNode.left;
      lidNode.y = wallsNode.top + viewWallThickness;
    };

    // Half the wall thickness, in view coordinates.
    const viewHalfWallThickness = modelViewTransform.modelToViewDeltaX(container.wallThickness / 2);

    // Update the container when its bounds change.
    container.boundsProperty.link(bounds => {
      // Account for wall thickness, so that container walls are drawn around the container's model bounds.
      const viewBounds = modelViewTransform.modelToViewBounds(bounds).dilate(viewHalfWallThickness);

      // Update the walls, start at top-left, origin at bottom-right. Shape looks like:
      //  __               ___
      // |                    |
      // |                    |
      // |                    |
      // |____________________|
      //
      wallsNode.shape = new Shape().moveTo(viewBounds.minX + viewOpeningLeftInset, viewBounds.minY).lineTo(viewBounds.minX, viewBounds.minY).lineTo(viewBounds.minX, viewBounds.maxY).lineTo(viewBounds.maxX, viewBounds.maxY).lineTo(viewBounds.maxX, viewBounds.minY).lineTo(viewBounds.maxX - viewOpeningRightInset, viewBounds.minY);

      // reposition the resize handle
      resizeHandleNode.right = wallsNode.left + 1; // hide the overlap
      resizeHandleNode.centerY = wallsNode.centerY;

      // reposition the lid if it's on the container
      if (container.lidIsOnProperty.value) {
        updateLidPosition();
      }
    });

    // Update the lid width
    container.lidWidthProperty.link(lidWidth => {
      // resize the lid's base
      lidNode.setBaseWidth(modelViewTransform.modelToViewDeltaX(lidWidth) + 1); // +1 to cover seam

      // reposition the lid
      updateLidPosition();
    });

    // Hide the resize handle when volume is held constant
    holdConstantProperty.link(holdConstant => {
      resizeHandleNode.visible = holdConstant !== 'volume' && holdConstant !== 'pressureV';
    });

    // Cancel interaction when visibility of the resize handle changes.
    resizeHandleNode.visibleProperty.lazyLink(() => resizeHandleNode.interruptSubtreeInput());

    // Dragging the resize handle horizontally changes the container's width
    const resizeDragListener = new ContainerResizeDragListener(container, modelViewTransform, this, options.tandem.createTandem('resizeDragListener'));
    resizeHandleNode.addInputListener(resizeDragListener);

    // While interacting with the resize handle...
    resizeDragListener.isPressedProperty.lazyLink(isPressed => {
      // disable interaction with the lid, to simplify implementation
      lidNode.interruptSubtreeInput();
      lidNode.pickable = !isPressed && container.lidIsOnProperty.value;

      // display the previous bounds of the container if the wall doesn't do work
      previousBoundsNode.visible = isPressed && !container.leftWallDoesWork;
      previousBoundsNode.setRectBounds(wallsNode.bounds);

      // Notify the listener provided by the client.
      options.resizeHandleIsPressedListener(isPressed);

      // when the handle is released, log the opening
      if (!isPressed && container.isOpenProperty.value) {
        phet.log && phet.log(`Lid is open: ${container.getOpeningLeft()} to ${container.getOpeningRight()} pm`);
      }
    });

    // Dragging the lid's handle horizontally changes the size of the opening in the top of the container
    const lidDragListener = new LidDragListener(container, modelViewTransform, this, options.tandem.createTandem('lidDragListener'));
    lidNode.handleNode.addInputListener(lidDragListener);

    // This implementation assumes that the lid is not interactive while the container is being resized.
    // This is handled in resizeDragListener.isPressedProperty listener above.
    // The lid will behave badly if this is not the case, so verify.
    lidDragListener.isPressedProperty.lazyLink(isPressed => {
      assert && assert(!isPressed || !resizeDragListener.isPressedProperty.value, 'the lid should be not interactive while the container is being resized');
    });
    container.lidIsOnProperty.link(lidIsOn => {
      if (lidIsOn) {
        // restore the lid to the fully-closed position
        container.lidWidthProperty.value = container.getMaxLidWidth();
        lidNode.visible = true;
        lidNode.setRotation(0);
        updateLidPosition();
        lidNode.visible = true;
      } else {
        this.interruptSubtreeInput(); // cancel interactions with the container, because we're blowing the lid off
      }

      // Lid is only interactive when it's on the container.
      lidNode.pickable = lidIsOn;
    });
    this.container = container;
    this.modelViewTransform = modelViewTransform;
    this.visibleBoundsProperty = visibleBoundsProperty;
    this.lidNode = lidNode;
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }

  /**
   * @param dt - delta time, in seconds
   */
  step(dt) {
    assert && assert(dt >= 0, `invalid dt: ${dt}`);

    // Blow the lid off the container
    if (!this.container.lidIsOnProperty.value && this.lidNode.visible) {
      if (this.visibleBoundsProperty.value.intersectsBounds(this.lidNode.bounds)) {
        // Lid is inside the visible bounds, animate it.
        const dx = LID_X_SPEED * dt;
        const dy = LID_Y_SPEED * dt;
        this.lidNode.centerX += dx;
        this.lidNode.centerY += dy;
        const dr = Utils.toRadians(LID_ROTATION_SPEED) * dt;
        this.lidNode.rotateAround(this.lidNode.center, dr);
      } else {
        // Lid has left the visible bounds, hide it.
        this.lidNode.visible = false;
      }
    }
  }
}
gasProperties.register('IdealGasLawContainerNode', IdealGasLawContainerNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlNoYXBlIiwib3B0aW9uaXplIiwiSGFuZGxlTm9kZSIsIk5vZGUiLCJQYXRoIiwiUmVjdGFuZ2xlIiwiZ2FzUHJvcGVydGllcyIsIkdhc1Byb3BlcnRpZXNDb2xvcnMiLCJDb250YWluZXJSZXNpemVEcmFnTGlzdGVuZXIiLCJMaWREcmFnTGlzdGVuZXIiLCJMaWROb2RlIiwiTElEX1hfU1BFRUQiLCJMSURfWV9TUEVFRCIsIkxJRF9ST1RBVElPTl9TUEVFRCIsIklkZWFsR2FzTGF3Q29udGFpbmVyTm9kZSIsImNvbnN0cnVjdG9yIiwiY29udGFpbmVyIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwiaG9sZENvbnN0YW50UHJvcGVydHkiLCJ2aXNpYmxlQm91bmRzUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicmVzaXplR3JpcENvbG9yIiwicmVzaXplR3JpcENvbG9yUHJvcGVydHkiLCJsaWRHcmlwQ29sb3IiLCJsaWRHcmlwQ29sb3JQcm9wZXJ0eSIsInJlc2l6ZUhhbmRsZUlzUHJlc3NlZExpc3RlbmVyIiwiXyIsIm5vb3AiLCJ2aWV3V2FsbFRoaWNrbmVzcyIsIm1vZGVsVG9WaWV3RGVsdGFYIiwid2FsbFRoaWNrbmVzcyIsInZpZXdPcGVuaW5nTGVmdEluc2V0Iiwib3BlbmluZ0xlZnRJbnNldCIsInZpZXdPcGVuaW5nUmlnaHRJbnNldCIsIm9wZW5pbmdSaWdodEluc2V0Iiwid2FsbHNOb2RlIiwic3Ryb2tlIiwiY29udGFpbmVyQm91bmRzU3Ryb2tlUHJvcGVydHkiLCJsaW5lV2lkdGgiLCJwcmV2aW91c0JvdW5kc05vZGUiLCJjb250YWluZXJQcmV2aW91c0JvdW5kc1N0cm9rZVByb3BlcnR5IiwidmlzaWJsZSIsInJlc2l6ZUhhbmRsZU5vZGUiLCJjdXJzb3IiLCJncmlwQmFzZUNvbG9yIiwiYXR0YWNobWVudExpbmVXaWR0aCIsInJvdGF0aW9uIiwiTWF0aCIsIlBJIiwic2NhbGUiLCJsaWROb2RlIiwiYmFzZVdpZHRoIiwibGlkV2lkdGhQcm9wZXJ0eSIsInZhbHVlIiwiYmFzZUhlaWdodCIsImxpZFRoaWNrbmVzcyIsImdyaXBDb2xvciIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsImNoaWxkcmVuIiwidXBkYXRlTGlkUG9zaXRpb24iLCJ4IiwibGVmdCIsInkiLCJ0b3AiLCJ2aWV3SGFsZldhbGxUaGlja25lc3MiLCJib3VuZHNQcm9wZXJ0eSIsImxpbmsiLCJib3VuZHMiLCJ2aWV3Qm91bmRzIiwibW9kZWxUb1ZpZXdCb3VuZHMiLCJkaWxhdGUiLCJzaGFwZSIsIm1vdmVUbyIsIm1pblgiLCJtaW5ZIiwibGluZVRvIiwibWF4WSIsIm1heFgiLCJyaWdodCIsImNlbnRlclkiLCJsaWRJc09uUHJvcGVydHkiLCJsaWRXaWR0aCIsInNldEJhc2VXaWR0aCIsImhvbGRDb25zdGFudCIsInZpc2libGVQcm9wZXJ0eSIsImxhenlMaW5rIiwiaW50ZXJydXB0U3VidHJlZUlucHV0IiwicmVzaXplRHJhZ0xpc3RlbmVyIiwiYWRkSW5wdXRMaXN0ZW5lciIsImlzUHJlc3NlZFByb3BlcnR5IiwiaXNQcmVzc2VkIiwicGlja2FibGUiLCJsZWZ0V2FsbERvZXNXb3JrIiwic2V0UmVjdEJvdW5kcyIsImlzT3BlblByb3BlcnR5IiwicGhldCIsImxvZyIsImdldE9wZW5pbmdMZWZ0IiwiZ2V0T3BlbmluZ1JpZ2h0IiwibGlkRHJhZ0xpc3RlbmVyIiwiaGFuZGxlTm9kZSIsImFzc2VydCIsImxpZElzT24iLCJnZXRNYXhMaWRXaWR0aCIsInNldFJvdGF0aW9uIiwiZGlzcG9zZSIsInN0ZXAiLCJkdCIsImludGVyc2VjdHNCb3VuZHMiLCJkeCIsImR5IiwiY2VudGVyWCIsImRyIiwidG9SYWRpYW5zIiwicm90YXRlQXJvdW5kIiwiY2VudGVyIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJJZGVhbEdhc0xhd0NvbnRhaW5lck5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogSWRlYWxHYXNMYXdDb250YWluZXJOb2RlIGlzIHRoZSB2aWV3IG9mIHRoZSBjb250YWluZXIgdXNlZCBpbiBzY3JlZW5zIHRoYXQgYXJlIGJhc2VkIG9uIHRoZSBJZGVhbCBHYXMgTGF3LlxyXG4gKiBUaGlzIGNvbnRhaW5lciBoYXMgbXV0YWJsZSB3aWR0aCwgYW5kIGEgbGlkIHRoYXQgY2FuIGJlIG1vdmVkL3JlbW92ZWQuXHJcbiAqIERvIG5vdCB0cmFuc2Zvcm0gdGhpcyBOb2RlISBJdCdzIG9yaWdpbiBtdXN0IGJlIGF0IHRoZSBvcmlnaW4gb2YgdGhlIHZpZXcgY29vcmRpbmF0ZSBmcmFtZS5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgU3RyaW5nVW5pb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1N0cmluZ1VuaW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgSGFuZGxlTm9kZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvSGFuZGxlTm9kZS5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIE5vZGVPcHRpb25zLCBQYXRoLCBSZWN0YW5nbGUsIFRDb2xvciB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBnYXNQcm9wZXJ0aWVzIGZyb20gJy4uLy4uL2dhc1Byb3BlcnRpZXMuanMnO1xyXG5pbXBvcnQgR2FzUHJvcGVydGllc0NvbG9ycyBmcm9tICcuLi9HYXNQcm9wZXJ0aWVzQ29sb3JzLmpzJztcclxuaW1wb3J0IHsgSG9sZENvbnN0YW50IH0gZnJvbSAnLi4vbW9kZWwvSG9sZENvbnN0YW50LmpzJztcclxuaW1wb3J0IElkZWFsR2FzTGF3Q29udGFpbmVyIGZyb20gJy4uL21vZGVsL0lkZWFsR2FzTGF3Q29udGFpbmVyLmpzJztcclxuaW1wb3J0IENvbnRhaW5lclJlc2l6ZURyYWdMaXN0ZW5lciBmcm9tICcuL0NvbnRhaW5lclJlc2l6ZURyYWdMaXN0ZW5lci5qcyc7XHJcbmltcG9ydCBMaWREcmFnTGlzdGVuZXIgZnJvbSAnLi9MaWREcmFnTGlzdGVuZXIuanMnO1xyXG5pbXBvcnQgTGlkTm9kZSBmcm9tICcuL0xpZE5vZGUuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IExJRF9YX1NQRUVEID0gLTUwOyAvLyBwaXhlbHMvc2Vjb25kXHJcbmNvbnN0IExJRF9ZX1NQRUVEID0gLTE1MDsgLy8gcGl4ZWxzL3NlY29uZFxyXG5jb25zdCBMSURfUk9UQVRJT05fU1BFRUQgPSAtNTA7IC8vIGRlZ3JlZXMvc2Vjb25kXHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIHJlc2l6ZUdyaXBDb2xvcj86IFRDb2xvcjsgLy8gY29sb3Igb2YgcmVzaXplIGhhbmRsZSdzIGdyaXBcclxuICBsaWRHcmlwQ29sb3I/OiBUQ29sb3I7IC8vIGNvbG9yIG9mIHRoZSBsaWQgaGFuZGxlJ3MgZ3JpcFxyXG4gIHJlc2l6ZUhhbmRsZUlzUHJlc3NlZExpc3RlbmVyPzogKCBpc1ByZXNzZWQ6IGJvb2xlYW4gKSA9PiB2b2lkO1xyXG59O1xyXG5cclxudHlwZSBJZGVhbEdhc0xhd0NvbnRhaW5lck5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaWNrUmVxdWlyZWQ8Tm9kZU9wdGlvbnMsICd0YW5kZW0nPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIElkZWFsR2FzTGF3Q29udGFpbmVyTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGNvbnRhaW5lcjogSWRlYWxHYXNMYXdDb250YWluZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB2aXNpYmxlQm91bmRzUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEJvdW5kczI+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbGlkTm9kZTogTGlkTm9kZTtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBjb250YWluZXI6IElkZWFsR2FzTGF3Q29udGFpbmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgbW9kZWxWaWV3VHJhbnNmb3JtOiBNb2RlbFZpZXdUcmFuc2Zvcm0yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgaG9sZENvbnN0YW50UHJvcGVydHk6IFN0cmluZ1VuaW9uUHJvcGVydHk8SG9sZENvbnN0YW50PixcclxuICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVCb3VuZHNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Qm91bmRzMj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IElkZWFsR2FzTGF3Q29udGFpbmVyTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxJZGVhbEdhc0xhd0NvbnRhaW5lck5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIHJlc2l6ZUdyaXBDb2xvcjogR2FzUHJvcGVydGllc0NvbG9ycy5yZXNpemVHcmlwQ29sb3JQcm9wZXJ0eSwgLy8ge0NvbG9yRGVmfSBjb2xvciBvZiByZXNpemUgaGFuZGxlJ3MgZ3JpcFxyXG4gICAgICBsaWRHcmlwQ29sb3I6IEdhc1Byb3BlcnRpZXNDb2xvcnMubGlkR3JpcENvbG9yUHJvcGVydHksIC8vIHtDb2xvckRlZn0gY29sb3Igb2YgdGhlIGxpZCBoYW5kbGUncyBncmlwXHJcbiAgICAgIHJlc2l6ZUhhbmRsZUlzUHJlc3NlZExpc3RlbmVyOiBfLm5vb3BcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIC8vIENvbnN0YW50IGFzcGVjdHMgb2YgdGhlIGNvbnRhaW5lciwgaW4gdmlldyBjb29yZGluYXRlc1xyXG4gICAgY29uc3Qgdmlld1dhbGxUaGlja25lc3MgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGNvbnRhaW5lci53YWxsVGhpY2tuZXNzICk7XHJcbiAgICBjb25zdCB2aWV3T3BlbmluZ0xlZnRJbnNldCA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWCggY29udGFpbmVyLm9wZW5pbmdMZWZ0SW5zZXQgKTtcclxuICAgIGNvbnN0IHZpZXdPcGVuaW5nUmlnaHRJbnNldCA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWCggY29udGFpbmVyLm9wZW5pbmdSaWdodEluc2V0ICk7XHJcblxyXG4gICAgLy8gV2FsbHMgb2YgdGhlIGNvbnRhaW5lclxyXG4gICAgY29uc3Qgd2FsbHNOb2RlID0gbmV3IFBhdGgoIG51bGwsIHtcclxuICAgICAgc3Ryb2tlOiBHYXNQcm9wZXJ0aWVzQ29sb3JzLmNvbnRhaW5lckJvdW5kc1N0cm9rZVByb3BlcnR5LFxyXG4gICAgICBsaW5lV2lkdGg6IHZpZXdXYWxsVGhpY2tuZXNzXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gUHJldmlvdXMgYm91bmRzIG9mIHRoZSBjb250YWluZXIsIHZpc2libGUgd2hpbGUgZHJhZ2dpbmcuXHJcbiAgICAvLyBUaGlzIGlzIGEgc2ltcGxlIHJlY3RhbmdsZSwgYW5kIGRvZXMgbm90IG5lZWQgdG8gc2hvdyB0aGUgcHJldmlvdXMgb3BlbmluZyBpbiB0aGUgdG9wLlxyXG4gICAgY29uc3QgcHJldmlvdXNCb3VuZHNOb2RlID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMSwgMSwge1xyXG4gICAgICBzdHJva2U6IEdhc1Byb3BlcnRpZXNDb2xvcnMuY29udGFpbmVyUHJldmlvdXNCb3VuZHNTdHJva2VQcm9wZXJ0eSxcclxuICAgICAgbGluZVdpZHRoOiB2aWV3V2FsbFRoaWNrbmVzcyxcclxuICAgICAgdmlzaWJsZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBSZXNpemUgaGFuZGxlIG9uIHRoZSBsZWZ0IHdhbGxcclxuICAgIGNvbnN0IHJlc2l6ZUhhbmRsZU5vZGUgPSBuZXcgSGFuZGxlTm9kZSgge1xyXG4gICAgICBjdXJzb3I6ICdwb2ludGVyJyxcclxuICAgICAgZ3JpcEJhc2VDb2xvcjogb3B0aW9ucy5yZXNpemVHcmlwQ29sb3IsXHJcbiAgICAgIGF0dGFjaG1lbnRMaW5lV2lkdGg6IDEsXHJcbiAgICAgIHJvdGF0aW9uOiAtTWF0aC5QSSAvIDIsXHJcbiAgICAgIHNjYWxlOiAwLjRcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBMaWQgb24gdGhlIHRvcCBvZiB0aGUgY29udGFpbmVyXHJcbiAgICBjb25zdCBsaWROb2RlID0gbmV3IExpZE5vZGUoIGhvbGRDb25zdGFudFByb3BlcnR5LCB7XHJcbiAgICAgIGJhc2VXaWR0aDogbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFYKCBjb250YWluZXIubGlkV2lkdGhQcm9wZXJ0eS52YWx1ZSApLFxyXG4gICAgICBiYXNlSGVpZ2h0OiBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGNvbnRhaW5lci5saWRUaGlja25lc3MgKSxcclxuICAgICAgZ3JpcENvbG9yOiBvcHRpb25zLmxpZEdyaXBDb2xvcixcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdsaWROb2RlJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgb3B0aW9ucy5jaGlsZHJlbiA9IFsgcHJldmlvdXNCb3VuZHNOb2RlLCByZXNpemVIYW5kbGVOb2RlLCB3YWxsc05vZGUsIGxpZE5vZGUgXTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIHJlcG9zaXRpb24gdGhlIGJvdHRvbS1sZWZ0IGNvcm5lciBvZiB0aGUgbGlkJ3MgYmFzZSwgaGFuZGxlIG1heSBleHRlbmQgcGFzdCB0aGlzIHRvIHRoZSBsZWZ0XHJcbiAgICBjb25zdCB1cGRhdGVMaWRQb3NpdGlvbiA9ICgpID0+IHtcclxuICAgICAgbGlkTm9kZS54ID0gd2FsbHNOb2RlLmxlZnQ7XHJcbiAgICAgIGxpZE5vZGUueSA9IHdhbGxzTm9kZS50b3AgKyB2aWV3V2FsbFRoaWNrbmVzcztcclxuICAgIH07XHJcblxyXG4gICAgLy8gSGFsZiB0aGUgd2FsbCB0aGlja25lc3MsIGluIHZpZXcgY29vcmRpbmF0ZXMuXHJcbiAgICBjb25zdCB2aWV3SGFsZldhbGxUaGlja25lc3MgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGNvbnRhaW5lci53YWxsVGhpY2tuZXNzIC8gMiApO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgY29udGFpbmVyIHdoZW4gaXRzIGJvdW5kcyBjaGFuZ2UuXHJcbiAgICBjb250YWluZXIuYm91bmRzUHJvcGVydHkubGluayggYm91bmRzID0+IHtcclxuXHJcbiAgICAgIC8vIEFjY291bnQgZm9yIHdhbGwgdGhpY2tuZXNzLCBzbyB0aGF0IGNvbnRhaW5lciB3YWxscyBhcmUgZHJhd24gYXJvdW5kIHRoZSBjb250YWluZXIncyBtb2RlbCBib3VuZHMuXHJcbiAgICAgIGNvbnN0IHZpZXdCb3VuZHMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdCb3VuZHMoIGJvdW5kcyApLmRpbGF0ZSggdmlld0hhbGZXYWxsVGhpY2tuZXNzICk7XHJcblxyXG4gICAgICAvLyBVcGRhdGUgdGhlIHdhbGxzLCBzdGFydCBhdCB0b3AtbGVmdCwgb3JpZ2luIGF0IGJvdHRvbS1yaWdodC4gU2hhcGUgbG9va3MgbGlrZTpcclxuICAgICAgLy8gIF9fICAgICAgICAgICAgICAgX19fXHJcbiAgICAgIC8vIHwgICAgICAgICAgICAgICAgICAgIHxcclxuICAgICAgLy8gfCAgICAgICAgICAgICAgICAgICAgfFxyXG4gICAgICAvLyB8ICAgICAgICAgICAgICAgICAgICB8XHJcbiAgICAgIC8vIHxfX19fX19fX19fX19fX19fX19fX3xcclxuICAgICAgLy9cclxuICAgICAgd2FsbHNOb2RlLnNoYXBlID0gbmV3IFNoYXBlKClcclxuICAgICAgICAubW92ZVRvKCB2aWV3Qm91bmRzLm1pblggKyB2aWV3T3BlbmluZ0xlZnRJbnNldCwgdmlld0JvdW5kcy5taW5ZIClcclxuICAgICAgICAubGluZVRvKCB2aWV3Qm91bmRzLm1pblgsIHZpZXdCb3VuZHMubWluWSApXHJcbiAgICAgICAgLmxpbmVUbyggdmlld0JvdW5kcy5taW5YLCB2aWV3Qm91bmRzLm1heFkgKVxyXG4gICAgICAgIC5saW5lVG8oIHZpZXdCb3VuZHMubWF4WCwgdmlld0JvdW5kcy5tYXhZIClcclxuICAgICAgICAubGluZVRvKCB2aWV3Qm91bmRzLm1heFgsIHZpZXdCb3VuZHMubWluWSApXHJcbiAgICAgICAgLmxpbmVUbyggdmlld0JvdW5kcy5tYXhYIC0gdmlld09wZW5pbmdSaWdodEluc2V0LCB2aWV3Qm91bmRzLm1pblkgKTtcclxuXHJcbiAgICAgIC8vIHJlcG9zaXRpb24gdGhlIHJlc2l6ZSBoYW5kbGVcclxuICAgICAgcmVzaXplSGFuZGxlTm9kZS5yaWdodCA9IHdhbGxzTm9kZS5sZWZ0ICsgMTsgLy8gaGlkZSB0aGUgb3ZlcmxhcFxyXG4gICAgICByZXNpemVIYW5kbGVOb2RlLmNlbnRlclkgPSB3YWxsc05vZGUuY2VudGVyWTtcclxuXHJcbiAgICAgIC8vIHJlcG9zaXRpb24gdGhlIGxpZCBpZiBpdCdzIG9uIHRoZSBjb250YWluZXJcclxuICAgICAgaWYgKCBjb250YWluZXIubGlkSXNPblByb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICAgIHVwZGF0ZUxpZFBvc2l0aW9uKCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGxpZCB3aWR0aFxyXG4gICAgY29udGFpbmVyLmxpZFdpZHRoUHJvcGVydHkubGluayggbGlkV2lkdGggPT4ge1xyXG5cclxuICAgICAgLy8gcmVzaXplIHRoZSBsaWQncyBiYXNlXHJcbiAgICAgIGxpZE5vZGUuc2V0QmFzZVdpZHRoKCBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGxpZFdpZHRoICkgKyAxICk7ICAvLyArMSB0byBjb3ZlciBzZWFtXHJcblxyXG4gICAgICAvLyByZXBvc2l0aW9uIHRoZSBsaWRcclxuICAgICAgdXBkYXRlTGlkUG9zaXRpb24oKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBIaWRlIHRoZSByZXNpemUgaGFuZGxlIHdoZW4gdm9sdW1lIGlzIGhlbGQgY29uc3RhbnRcclxuICAgIGhvbGRDb25zdGFudFByb3BlcnR5LmxpbmsoIGhvbGRDb25zdGFudCA9PiB7XHJcbiAgICAgIHJlc2l6ZUhhbmRsZU5vZGUudmlzaWJsZSA9ICggaG9sZENvbnN0YW50ICE9PSAndm9sdW1lJyAmJiBob2xkQ29uc3RhbnQgIT09ICdwcmVzc3VyZVYnICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQ2FuY2VsIGludGVyYWN0aW9uIHdoZW4gdmlzaWJpbGl0eSBvZiB0aGUgcmVzaXplIGhhbmRsZSBjaGFuZ2VzLlxyXG4gICAgcmVzaXplSGFuZGxlTm9kZS52aXNpYmxlUHJvcGVydHkubGF6eUxpbmsoICgpID0+IHJlc2l6ZUhhbmRsZU5vZGUuaW50ZXJydXB0U3VidHJlZUlucHV0KCkgKTtcclxuXHJcbiAgICAvLyBEcmFnZ2luZyB0aGUgcmVzaXplIGhhbmRsZSBob3Jpem9udGFsbHkgY2hhbmdlcyB0aGUgY29udGFpbmVyJ3Mgd2lkdGhcclxuICAgIGNvbnN0IHJlc2l6ZURyYWdMaXN0ZW5lciA9IG5ldyBDb250YWluZXJSZXNpemVEcmFnTGlzdGVuZXIoIGNvbnRhaW5lciwgbW9kZWxWaWV3VHJhbnNmb3JtLCB0aGlzLFxyXG4gICAgICBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdyZXNpemVEcmFnTGlzdGVuZXInICkgKTtcclxuICAgIHJlc2l6ZUhhbmRsZU5vZGUuYWRkSW5wdXRMaXN0ZW5lciggcmVzaXplRHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgLy8gV2hpbGUgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgcmVzaXplIGhhbmRsZS4uLlxyXG4gICAgcmVzaXplRHJhZ0xpc3RlbmVyLmlzUHJlc3NlZFByb3BlcnR5LmxhenlMaW5rKCBpc1ByZXNzZWQgPT4ge1xyXG5cclxuICAgICAgLy8gZGlzYWJsZSBpbnRlcmFjdGlvbiB3aXRoIHRoZSBsaWQsIHRvIHNpbXBsaWZ5IGltcGxlbWVudGF0aW9uXHJcbiAgICAgIGxpZE5vZGUuaW50ZXJydXB0U3VidHJlZUlucHV0KCk7XHJcbiAgICAgIGxpZE5vZGUucGlja2FibGUgPSAhaXNQcmVzc2VkICYmIGNvbnRhaW5lci5saWRJc09uUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgICAvLyBkaXNwbGF5IHRoZSBwcmV2aW91cyBib3VuZHMgb2YgdGhlIGNvbnRhaW5lciBpZiB0aGUgd2FsbCBkb2Vzbid0IGRvIHdvcmtcclxuICAgICAgcHJldmlvdXNCb3VuZHNOb2RlLnZpc2libGUgPSBpc1ByZXNzZWQgJiYgIWNvbnRhaW5lci5sZWZ0V2FsbERvZXNXb3JrO1xyXG4gICAgICBwcmV2aW91c0JvdW5kc05vZGUuc2V0UmVjdEJvdW5kcyggd2FsbHNOb2RlLmJvdW5kcyApO1xyXG5cclxuICAgICAgLy8gTm90aWZ5IHRoZSBsaXN0ZW5lciBwcm92aWRlZCBieSB0aGUgY2xpZW50LlxyXG4gICAgICBvcHRpb25zLnJlc2l6ZUhhbmRsZUlzUHJlc3NlZExpc3RlbmVyKCBpc1ByZXNzZWQgKTtcclxuXHJcbiAgICAgIC8vIHdoZW4gdGhlIGhhbmRsZSBpcyByZWxlYXNlZCwgbG9nIHRoZSBvcGVuaW5nXHJcbiAgICAgIGlmICggIWlzUHJlc3NlZCAmJiBjb250YWluZXIuaXNPcGVuUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgICAgcGhldC5sb2cgJiYgcGhldC5sb2coIGBMaWQgaXMgb3BlbjogJHtjb250YWluZXIuZ2V0T3BlbmluZ0xlZnQoKX0gdG8gJHtjb250YWluZXIuZ2V0T3BlbmluZ1JpZ2h0KCl9IHBtYCApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gRHJhZ2dpbmcgdGhlIGxpZCdzIGhhbmRsZSBob3Jpem9udGFsbHkgY2hhbmdlcyB0aGUgc2l6ZSBvZiB0aGUgb3BlbmluZyBpbiB0aGUgdG9wIG9mIHRoZSBjb250YWluZXJcclxuICAgIGNvbnN0IGxpZERyYWdMaXN0ZW5lciA9IG5ldyBMaWREcmFnTGlzdGVuZXIoIGNvbnRhaW5lciwgbW9kZWxWaWV3VHJhbnNmb3JtLCB0aGlzLFxyXG4gICAgICBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdsaWREcmFnTGlzdGVuZXInICkgKTtcclxuICAgIGxpZE5vZGUuaGFuZGxlTm9kZS5hZGRJbnB1dExpc3RlbmVyKCBsaWREcmFnTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBUaGlzIGltcGxlbWVudGF0aW9uIGFzc3VtZXMgdGhhdCB0aGUgbGlkIGlzIG5vdCBpbnRlcmFjdGl2ZSB3aGlsZSB0aGUgY29udGFpbmVyIGlzIGJlaW5nIHJlc2l6ZWQuXHJcbiAgICAvLyBUaGlzIGlzIGhhbmRsZWQgaW4gcmVzaXplRHJhZ0xpc3RlbmVyLmlzUHJlc3NlZFByb3BlcnR5IGxpc3RlbmVyIGFib3ZlLlxyXG4gICAgLy8gVGhlIGxpZCB3aWxsIGJlaGF2ZSBiYWRseSBpZiB0aGlzIGlzIG5vdCB0aGUgY2FzZSwgc28gdmVyaWZ5LlxyXG4gICAgbGlkRHJhZ0xpc3RlbmVyLmlzUHJlc3NlZFByb3BlcnR5LmxhenlMaW5rKCBpc1ByZXNzZWQgPT4ge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhaXNQcmVzc2VkIHx8ICFyZXNpemVEcmFnTGlzdGVuZXIuaXNQcmVzc2VkUHJvcGVydHkudmFsdWUsXHJcbiAgICAgICAgJ3RoZSBsaWQgc2hvdWxkIGJlIG5vdCBpbnRlcmFjdGl2ZSB3aGlsZSB0aGUgY29udGFpbmVyIGlzIGJlaW5nIHJlc2l6ZWQnICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29udGFpbmVyLmxpZElzT25Qcm9wZXJ0eS5saW5rKCBsaWRJc09uID0+IHtcclxuICAgICAgaWYgKCBsaWRJc09uICkge1xyXG5cclxuICAgICAgICAvLyByZXN0b3JlIHRoZSBsaWQgdG8gdGhlIGZ1bGx5LWNsb3NlZCBwb3NpdGlvblxyXG4gICAgICAgIGNvbnRhaW5lci5saWRXaWR0aFByb3BlcnR5LnZhbHVlID0gY29udGFpbmVyLmdldE1heExpZFdpZHRoKCk7XHJcbiAgICAgICAgbGlkTm9kZS52aXNpYmxlID0gdHJ1ZTtcclxuICAgICAgICBsaWROb2RlLnNldFJvdGF0aW9uKCAwICk7XHJcbiAgICAgICAgdXBkYXRlTGlkUG9zaXRpb24oKTtcclxuICAgICAgICBsaWROb2RlLnZpc2libGUgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaW50ZXJydXB0U3VidHJlZUlucHV0KCk7IC8vIGNhbmNlbCBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgY29udGFpbmVyLCBiZWNhdXNlIHdlJ3JlIGJsb3dpbmcgdGhlIGxpZCBvZmZcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gTGlkIGlzIG9ubHkgaW50ZXJhY3RpdmUgd2hlbiBpdCdzIG9uIHRoZSBjb250YWluZXIuXHJcbiAgICAgIGxpZE5vZGUucGlja2FibGUgPSBsaWRJc09uO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyO1xyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBtb2RlbFZpZXdUcmFuc2Zvcm07XHJcbiAgICB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSA9IHZpc2libGVCb3VuZHNQcm9wZXJ0eTtcclxuICAgIHRoaXMubGlkTm9kZSA9IGxpZE5vZGU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGR0IC0gZGVsdGEgdGltZSwgaW4gc2Vjb25kc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGVwKCBkdDogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZHQgPj0gMCwgYGludmFsaWQgZHQ6ICR7ZHR9YCApO1xyXG5cclxuICAgIC8vIEJsb3cgdGhlIGxpZCBvZmYgdGhlIGNvbnRhaW5lclxyXG4gICAgaWYgKCAhdGhpcy5jb250YWluZXIubGlkSXNPblByb3BlcnR5LnZhbHVlICYmIHRoaXMubGlkTm9kZS52aXNpYmxlICkge1xyXG4gICAgICBpZiAoIHRoaXMudmlzaWJsZUJvdW5kc1Byb3BlcnR5LnZhbHVlLmludGVyc2VjdHNCb3VuZHMoIHRoaXMubGlkTm9kZS5ib3VuZHMgKSApIHtcclxuXHJcbiAgICAgICAgLy8gTGlkIGlzIGluc2lkZSB0aGUgdmlzaWJsZSBib3VuZHMsIGFuaW1hdGUgaXQuXHJcbiAgICAgICAgY29uc3QgZHggPSBMSURfWF9TUEVFRCAqIGR0O1xyXG4gICAgICAgIGNvbnN0IGR5ID0gTElEX1lfU1BFRUQgKiBkdDtcclxuICAgICAgICB0aGlzLmxpZE5vZGUuY2VudGVyWCArPSBkeDtcclxuICAgICAgICB0aGlzLmxpZE5vZGUuY2VudGVyWSArPSBkeTtcclxuICAgICAgICBjb25zdCBkciA9IFV0aWxzLnRvUmFkaWFucyggTElEX1JPVEFUSU9OX1NQRUVEICkgKiBkdDtcclxuICAgICAgICB0aGlzLmxpZE5vZGUucm90YXRlQXJvdW5kKCB0aGlzLmxpZE5vZGUuY2VudGVyLCBkciApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBMaWQgaGFzIGxlZnQgdGhlIHZpc2libGUgYm91bmRzLCBoaWRlIGl0LlxyXG4gICAgICAgIHRoaXMubGlkTm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmdhc1Byb3BlcnRpZXMucmVnaXN0ZXIoICdJZGVhbEdhc0xhd0NvbnRhaW5lck5vZGUnLCBJZGVhbEdhc0xhd0NvbnRhaW5lck5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUtBLE9BQU9BLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsU0FBU0MsS0FBSyxRQUFRLGdDQUFnQztBQUN0RCxPQUFPQyxTQUFTLE1BQU0sdUNBQXVDO0FBRzdELE9BQU9DLFVBQVUsTUFBTSwyQ0FBMkM7QUFDbEUsU0FBU0MsSUFBSSxFQUFlQyxJQUFJLEVBQUVDLFNBQVMsUUFBZ0IsbUNBQW1DO0FBQzlGLE9BQU9DLGFBQWEsTUFBTSx3QkFBd0I7QUFD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