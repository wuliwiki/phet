// Copyright 2019-2022, University of Colorado Boulder

/**
 * AverageSpeedModel is a sub-model in the Energy screen, responsible for data that is displayed in the
 * Average Speed accordion box.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Property from '../../../../axon/js/Property.js';
import { combineOptions } from '../../../../phet-core/js/optionize.js';
import NullableIO from '../../../../tandem/js/types/NullableIO.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import gasProperties from '../../gasProperties.js';

// constants
const AVERAGE_SPEED_PROPERTY_OPTIONS = {
  units: 'pm/ps',
  isValidValue: averageSpeed => averageSpeed === null || averageSpeed >= 0,
  phetioValueType: NullableIO(NumberIO),
  phetioReadOnly: true // derived from the state of the particle system
};

export default class AverageSpeedModel {
  // average speed of particle species in the container, in pm/ps, null when the container is empty

  // used internally to smooth the average speed computation
  // accumulated dts while samples were taken
  // number of samples we've taken
  // sum of samples for heavy particles
  // sum of samples for light particles
  /**
   * @param particleSystem
   * @param isPlayingProperty
   * @param samplePeriod - data is averaged over this period, in ps
   * @param providedOptions
   */
  constructor(particleSystem, isPlayingProperty, samplePeriod, providedOptions) {
    assert && assert(samplePeriod > 0, `invalid samplePeriod: ${samplePeriod}`);
    const options = providedOptions;
    this.particleSystem = particleSystem;
    this.isPlayingProperty = isPlayingProperty;
    this.samplePeriod = samplePeriod;
    this.heavyAverageSpeedProperty = new Property(null, combineOptions({}, AVERAGE_SPEED_PROPERTY_OPTIONS, {
      tandem: options.tandem.createTandem('heavyAverageSpeedProperty'),
      phetioDocumentation: 'average speed of heavy particles in the container'
    }));
    this.lightAverageSpeedProperty = new Property(null, combineOptions({}, AVERAGE_SPEED_PROPERTY_OPTIONS, {
      tandem: options.tandem.createTandem('lightAverageSpeedProperty'),
      phetioDocumentation: 'average speed of light particles in the container'
    }));
    this.dtAccumulator = 0;
    this.numberOfSamples = 0;
    this.heavyAverageSpeedSum = 0;
    this.lightAverageSpeedSum = 0;

    // Reset sample data when the play state changes, so that we can update immediately if manually stepping.
    isPlayingProperty.link(() => {
      this.clearSamples();
    });

    // If the number of particles changes while paused, sample the current state and update immediately.
    particleSystem.numberOfParticlesProperty.link(numberOfParticles => {
      if (numberOfParticles === 0 || !isPlayingProperty.value) {
        this.step(this.samplePeriod); // using the sample period causes an immediate update
      }
    });
  }

  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }
  reset() {
    this.heavyAverageSpeedProperty.reset();
    this.lightAverageSpeedProperty.reset();
    this.clearSamples();
  }

  /**
   * Clears the sample data.
   */
  clearSamples() {
    this.dtAccumulator = 0;
    this.numberOfSamples = 0;
    this.heavyAverageSpeedSum = 0;
    this.lightAverageSpeedSum = 0;
  }

  /**
   * Computes the average speed for each particle type, smoothed over an interval.
   * @param dt - time delta, in ps
   */
  step(dt) {
    // Accumulate dt
    this.dtAccumulator += dt;

    // Takes data samples
    this.sample();

    // Update now if we've reached the end of the sample period, or if we're manually stepping
    if (this.dtAccumulator >= this.samplePeriod || !this.isPlayingProperty.value) {
      this.update();
    }
  }

  /**
   * Takes a data sample.
   */
  sample() {
    assert && assert(!(this.numberOfSamples !== 0 && !this.isPlayingProperty.value), 'numberOfSamples should be 0 if called while the sim is paused');
    this.heavyAverageSpeedSum += getAverageSpeed(this.particleSystem.heavyParticles);
    this.lightAverageSpeedSum += getAverageSpeed(this.particleSystem.lightParticles);
    this.numberOfSamples++;
  }

  /**
   * Updates Properties using the current sample data.
   */
  update() {
    assert && assert(!(this.numberOfSamples !== 1 && !this.isPlayingProperty.value), 'numberOfSamples should be 1 if called while the sim is paused');

    // heavy particles
    if (this.particleSystem.heavyParticles.length === 0) {
      this.heavyAverageSpeedProperty.value = null;
    } else {
      this.heavyAverageSpeedProperty.value = this.heavyAverageSpeedSum / this.numberOfSamples;
    }

    // light particles
    if (this.particleSystem.lightParticles.length === 0) {
      this.lightAverageSpeedProperty.value = null;
    } else {
      this.lightAverageSpeedProperty.value = this.lightAverageSpeedSum / this.numberOfSamples;
    }

    // Clear sample data in preparation for the next sample period.
    this.clearSamples();
  }
}

/**
 * Gets the average speed for a set of particles, in pm/ps. Returns 0 if there are no particles
 */
function getAverageSpeed(particles) {
  let averageSpeed = 0;
  if (particles.length > 0) {
    let totalSpeed = 0;
    for (let i = particles.length - 1; i >= 0; i--) {
      totalSpeed += particles[i].velocity.magnitude;
    }
    averageSpeed = totalSpeed / particles.length;
  }
  return averageSpeed;
}
gasProperties.register('AverageSpeedModel', AverageSpeedModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImNvbWJpbmVPcHRpb25zIiwiTnVsbGFibGVJTyIsIk51bWJlcklPIiwiZ2FzUHJvcGVydGllcyIsIkFWRVJBR0VfU1BFRURfUFJPUEVSVFlfT1BUSU9OUyIsInVuaXRzIiwiaXNWYWxpZFZhbHVlIiwiYXZlcmFnZVNwZWVkIiwicGhldGlvVmFsdWVUeXBlIiwicGhldGlvUmVhZE9ubHkiLCJBdmVyYWdlU3BlZWRNb2RlbCIsImNvbnN0cnVjdG9yIiwicGFydGljbGVTeXN0ZW0iLCJpc1BsYXlpbmdQcm9wZXJ0eSIsInNhbXBsZVBlcmlvZCIsInByb3ZpZGVkT3B0aW9ucyIsImFzc2VydCIsIm9wdGlvbnMiLCJoZWF2eUF2ZXJhZ2VTcGVlZFByb3BlcnR5IiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImxpZ2h0QXZlcmFnZVNwZWVkUHJvcGVydHkiLCJkdEFjY3VtdWxhdG9yIiwibnVtYmVyT2ZTYW1wbGVzIiwiaGVhdnlBdmVyYWdlU3BlZWRTdW0iLCJsaWdodEF2ZXJhZ2VTcGVlZFN1bSIsImxpbmsiLCJjbGVhclNhbXBsZXMiLCJudW1iZXJPZlBhcnRpY2xlc1Byb3BlcnR5IiwibnVtYmVyT2ZQYXJ0aWNsZXMiLCJ2YWx1ZSIsInN0ZXAiLCJkaXNwb3NlIiwicmVzZXQiLCJkdCIsInNhbXBsZSIsInVwZGF0ZSIsImdldEF2ZXJhZ2VTcGVlZCIsImhlYXZ5UGFydGljbGVzIiwibGlnaHRQYXJ0aWNsZXMiLCJsZW5ndGgiLCJwYXJ0aWNsZXMiLCJ0b3RhbFNwZWVkIiwiaSIsInZlbG9jaXR5IiwibWFnbml0dWRlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBdmVyYWdlU3BlZWRNb2RlbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBdmVyYWdlU3BlZWRNb2RlbCBpcyBhIHN1Yi1tb2RlbCBpbiB0aGUgRW5lcmd5IHNjcmVlbiwgcmVzcG9uc2libGUgZm9yIGRhdGEgdGhhdCBpcyBkaXNwbGF5ZWQgaW4gdGhlXHJcbiAqIEF2ZXJhZ2UgU3BlZWQgYWNjb3JkaW9uIGJveC5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHksIHsgUHJvcGVydHlPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgY29tYmluZU9wdGlvbnMsIEVtcHR5U2VsZk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBOdW1iZXJJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVtYmVySU8uanMnO1xyXG5pbXBvcnQgUGFydGljbGUgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL1BhcnRpY2xlLmpzJztcclxuaW1wb3J0IFBhcnRpY2xlU3lzdGVtIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9QYXJ0aWNsZVN5c3RlbS5qcyc7XHJcbmltcG9ydCBnYXNQcm9wZXJ0aWVzIGZyb20gJy4uLy4uL2dhc1Byb3BlcnRpZXMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEFWRVJBR0VfU1BFRURfUFJPUEVSVFlfT1BUSU9OUzogUHJvcGVydHlPcHRpb25zPG51bWJlciB8IG51bGw+ID0ge1xyXG4gIHVuaXRzOiAncG0vcHMnLFxyXG4gIGlzVmFsaWRWYWx1ZTogYXZlcmFnZVNwZWVkID0+ICggYXZlcmFnZVNwZWVkID09PSBudWxsIHx8IGF2ZXJhZ2VTcGVlZCA+PSAwICksXHJcbiAgcGhldGlvVmFsdWVUeXBlOiBOdWxsYWJsZUlPKCBOdW1iZXJJTyApLFxyXG4gIHBoZXRpb1JlYWRPbmx5OiB0cnVlIC8vIGRlcml2ZWQgZnJvbSB0aGUgc3RhdGUgb2YgdGhlIHBhcnRpY2xlIHN5c3RlbVxyXG59O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIEF2ZXJhZ2VTcGVlZE1vZGVsT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgUGlja1JlcXVpcmVkPFBoZXRpb09iamVjdE9wdGlvbnMsICd0YW5kZW0nPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF2ZXJhZ2VTcGVlZE1vZGVsIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBwYXJ0aWNsZVN5c3RlbTogUGFydGljbGVTeXN0ZW07XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpc1BsYXlpbmdQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBzYW1wbGVQZXJpb2Q6IG51bWJlcjtcclxuXHJcbiAgLy8gYXZlcmFnZSBzcGVlZCBvZiBwYXJ0aWNsZSBzcGVjaWVzIGluIHRoZSBjb250YWluZXIsIGluIHBtL3BzLCBudWxsIHdoZW4gdGhlIGNvbnRhaW5lciBpcyBlbXB0eVxyXG4gIHB1YmxpYyByZWFkb25seSBoZWF2eUF2ZXJhZ2VTcGVlZFByb3BlcnR5OiBQcm9wZXJ0eTxudW1iZXIgfCBudWxsPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGlnaHRBdmVyYWdlU3BlZWRQcm9wZXJ0eTogUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcblxyXG4gIC8vIHVzZWQgaW50ZXJuYWxseSB0byBzbW9vdGggdGhlIGF2ZXJhZ2Ugc3BlZWQgY29tcHV0YXRpb25cclxuICBwcml2YXRlIGR0QWNjdW11bGF0b3I6IG51bWJlcjsgLy8gYWNjdW11bGF0ZWQgZHRzIHdoaWxlIHNhbXBsZXMgd2VyZSB0YWtlblxyXG4gIHByaXZhdGUgbnVtYmVyT2ZTYW1wbGVzOiBudW1iZXI7IC8vIG51bWJlciBvZiBzYW1wbGVzIHdlJ3ZlIHRha2VuXHJcbiAgcHJpdmF0ZSBoZWF2eUF2ZXJhZ2VTcGVlZFN1bTogbnVtYmVyOyAvLyBzdW0gb2Ygc2FtcGxlcyBmb3IgaGVhdnkgcGFydGljbGVzXHJcbiAgcHJpdmF0ZSBsaWdodEF2ZXJhZ2VTcGVlZFN1bTogbnVtYmVyOyAvLyBzdW0gb2Ygc2FtcGxlcyBmb3IgbGlnaHQgcGFydGljbGVzXHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBwYXJ0aWNsZVN5c3RlbVxyXG4gICAqIEBwYXJhbSBpc1BsYXlpbmdQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBzYW1wbGVQZXJpb2QgLSBkYXRhIGlzIGF2ZXJhZ2VkIG92ZXIgdGhpcyBwZXJpb2QsIGluIHBzXHJcbiAgICogQHBhcmFtIHByb3ZpZGVkT3B0aW9uc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcGFydGljbGVTeXN0ZW06IFBhcnRpY2xlU3lzdGVtLCBpc1BsYXlpbmdQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBzYW1wbGVQZXJpb2Q6IG51bWJlciwgcHJvdmlkZWRPcHRpb25zOiBBdmVyYWdlU3BlZWRNb2RlbE9wdGlvbnMgKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBzYW1wbGVQZXJpb2QgPiAwLCBgaW52YWxpZCBzYW1wbGVQZXJpb2Q6ICR7c2FtcGxlUGVyaW9kfWAgKTtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gcHJvdmlkZWRPcHRpb25zO1xyXG5cclxuICAgIHRoaXMucGFydGljbGVTeXN0ZW0gPSBwYXJ0aWNsZVN5c3RlbTtcclxuICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkgPSBpc1BsYXlpbmdQcm9wZXJ0eTtcclxuICAgIHRoaXMuc2FtcGxlUGVyaW9kID0gc2FtcGxlUGVyaW9kO1xyXG5cclxuICAgIHRoaXMuaGVhdnlBdmVyYWdlU3BlZWRQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCxcclxuICAgICAgY29tYmluZU9wdGlvbnM8UHJvcGVydHlPcHRpb25zPG51bWJlciB8IG51bGw+Pigge30sIEFWRVJBR0VfU1BFRURfUFJPUEVSVFlfT1BUSU9OUywge1xyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnaGVhdnlBdmVyYWdlU3BlZWRQcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnYXZlcmFnZSBzcGVlZCBvZiBoZWF2eSBwYXJ0aWNsZXMgaW4gdGhlIGNvbnRhaW5lcidcclxuICAgICAgfSApICk7XHJcblxyXG4gICAgdGhpcy5saWdodEF2ZXJhZ2VTcGVlZFByb3BlcnR5ID0gbmV3IFByb3BlcnR5PG51bWJlciB8IG51bGw+KCBudWxsLFxyXG4gICAgICBjb21iaW5lT3B0aW9uczxQcm9wZXJ0eU9wdGlvbnM8bnVtYmVyIHwgbnVsbD4+KCB7fSwgQVZFUkFHRV9TUEVFRF9QUk9QRVJUWV9PUFRJT05TLCB7XHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdsaWdodEF2ZXJhZ2VTcGVlZFByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdhdmVyYWdlIHNwZWVkIG9mIGxpZ2h0IHBhcnRpY2xlcyBpbiB0aGUgY29udGFpbmVyJ1xyXG4gICAgICB9ICkgKTtcclxuXHJcbiAgICB0aGlzLmR0QWNjdW11bGF0b3IgPSAwO1xyXG4gICAgdGhpcy5udW1iZXJPZlNhbXBsZXMgPSAwO1xyXG4gICAgdGhpcy5oZWF2eUF2ZXJhZ2VTcGVlZFN1bSA9IDA7XHJcbiAgICB0aGlzLmxpZ2h0QXZlcmFnZVNwZWVkU3VtID0gMDtcclxuXHJcbiAgICAvLyBSZXNldCBzYW1wbGUgZGF0YSB3aGVuIHRoZSBwbGF5IHN0YXRlIGNoYW5nZXMsIHNvIHRoYXQgd2UgY2FuIHVwZGF0ZSBpbW1lZGlhdGVseSBpZiBtYW51YWxseSBzdGVwcGluZy5cclxuICAgIGlzUGxheWluZ1Byb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgdGhpcy5jbGVhclNhbXBsZXMoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBJZiB0aGUgbnVtYmVyIG9mIHBhcnRpY2xlcyBjaGFuZ2VzIHdoaWxlIHBhdXNlZCwgc2FtcGxlIHRoZSBjdXJyZW50IHN0YXRlIGFuZCB1cGRhdGUgaW1tZWRpYXRlbHkuXHJcbiAgICBwYXJ0aWNsZVN5c3RlbS5udW1iZXJPZlBhcnRpY2xlc1Byb3BlcnR5LmxpbmsoIG51bWJlck9mUGFydGljbGVzID0+IHtcclxuICAgICAgaWYgKCBudW1iZXJPZlBhcnRpY2xlcyA9PT0gMCB8fCAhaXNQbGF5aW5nUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgICAgdGhpcy5zdGVwKCB0aGlzLnNhbXBsZVBlcmlvZCApOyAvLyB1c2luZyB0aGUgc2FtcGxlIHBlcmlvZCBjYXVzZXMgYW4gaW1tZWRpYXRlIHVwZGF0ZVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5oZWF2eUF2ZXJhZ2VTcGVlZFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmxpZ2h0QXZlcmFnZVNwZWVkUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuY2xlYXJTYW1wbGVzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhcnMgdGhlIHNhbXBsZSBkYXRhLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xlYXJTYW1wbGVzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kdEFjY3VtdWxhdG9yID0gMDtcclxuICAgIHRoaXMubnVtYmVyT2ZTYW1wbGVzID0gMDtcclxuICAgIHRoaXMuaGVhdnlBdmVyYWdlU3BlZWRTdW0gPSAwO1xyXG4gICAgdGhpcy5saWdodEF2ZXJhZ2VTcGVlZFN1bSA9IDA7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb21wdXRlcyB0aGUgYXZlcmFnZSBzcGVlZCBmb3IgZWFjaCBwYXJ0aWNsZSB0eXBlLCBzbW9vdGhlZCBvdmVyIGFuIGludGVydmFsLlxyXG4gICAqIEBwYXJhbSBkdCAtIHRpbWUgZGVsdGEsIGluIHBzXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcblxyXG4gICAgLy8gQWNjdW11bGF0ZSBkdFxyXG4gICAgdGhpcy5kdEFjY3VtdWxhdG9yICs9IGR0O1xyXG5cclxuICAgIC8vIFRha2VzIGRhdGEgc2FtcGxlc1xyXG4gICAgdGhpcy5zYW1wbGUoKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgbm93IGlmIHdlJ3ZlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgc2FtcGxlIHBlcmlvZCwgb3IgaWYgd2UncmUgbWFudWFsbHkgc3RlcHBpbmdcclxuICAgIGlmICggdGhpcy5kdEFjY3VtdWxhdG9yID49IHRoaXMuc2FtcGxlUGVyaW9kIHx8ICF0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGFrZXMgYSBkYXRhIHNhbXBsZS5cclxuICAgKi9cclxuICBwcml2YXRlIHNhbXBsZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICEoIHRoaXMubnVtYmVyT2ZTYW1wbGVzICE9PSAwICYmICF0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnZhbHVlICksXHJcbiAgICAgICdudW1iZXJPZlNhbXBsZXMgc2hvdWxkIGJlIDAgaWYgY2FsbGVkIHdoaWxlIHRoZSBzaW0gaXMgcGF1c2VkJyApO1xyXG5cclxuICAgIHRoaXMuaGVhdnlBdmVyYWdlU3BlZWRTdW0gKz0gZ2V0QXZlcmFnZVNwZWVkKCB0aGlzLnBhcnRpY2xlU3lzdGVtLmhlYXZ5UGFydGljbGVzICk7XHJcbiAgICB0aGlzLmxpZ2h0QXZlcmFnZVNwZWVkU3VtICs9IGdldEF2ZXJhZ2VTcGVlZCggdGhpcy5wYXJ0aWNsZVN5c3RlbS5saWdodFBhcnRpY2xlcyApO1xyXG4gICAgdGhpcy5udW1iZXJPZlNhbXBsZXMrKztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgUHJvcGVydGllcyB1c2luZyB0aGUgY3VycmVudCBzYW1wbGUgZGF0YS5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICEoIHRoaXMubnVtYmVyT2ZTYW1wbGVzICE9PSAxICYmICF0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnZhbHVlICksXHJcbiAgICAgICdudW1iZXJPZlNhbXBsZXMgc2hvdWxkIGJlIDEgaWYgY2FsbGVkIHdoaWxlIHRoZSBzaW0gaXMgcGF1c2VkJyApO1xyXG5cclxuICAgIC8vIGhlYXZ5IHBhcnRpY2xlc1xyXG4gICAgaWYgKCB0aGlzLnBhcnRpY2xlU3lzdGVtLmhlYXZ5UGFydGljbGVzLmxlbmd0aCA9PT0gMCApIHtcclxuICAgICAgdGhpcy5oZWF2eUF2ZXJhZ2VTcGVlZFByb3BlcnR5LnZhbHVlID0gbnVsbDtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmhlYXZ5QXZlcmFnZVNwZWVkUHJvcGVydHkudmFsdWUgPSB0aGlzLmhlYXZ5QXZlcmFnZVNwZWVkU3VtIC8gdGhpcy5udW1iZXJPZlNhbXBsZXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbGlnaHQgcGFydGljbGVzXHJcbiAgICBpZiAoIHRoaXMucGFydGljbGVTeXN0ZW0ubGlnaHRQYXJ0aWNsZXMubGVuZ3RoID09PSAwICkge1xyXG4gICAgICB0aGlzLmxpZ2h0QXZlcmFnZVNwZWVkUHJvcGVydHkudmFsdWUgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMubGlnaHRBdmVyYWdlU3BlZWRQcm9wZXJ0eS52YWx1ZSA9IHRoaXMubGlnaHRBdmVyYWdlU3BlZWRTdW0gLyB0aGlzLm51bWJlck9mU2FtcGxlcztcclxuICAgIH1cclxuXHJcbiAgICAvLyBDbGVhciBzYW1wbGUgZGF0YSBpbiBwcmVwYXJhdGlvbiBmb3IgdGhlIG5leHQgc2FtcGxlIHBlcmlvZC5cclxuICAgIHRoaXMuY2xlYXJTYW1wbGVzKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2V0cyB0aGUgYXZlcmFnZSBzcGVlZCBmb3IgYSBzZXQgb2YgcGFydGljbGVzLCBpbiBwbS9wcy4gUmV0dXJucyAwIGlmIHRoZXJlIGFyZSBubyBwYXJ0aWNsZXNcclxuICovXHJcbmZ1bmN0aW9uIGdldEF2ZXJhZ2VTcGVlZCggcGFydGljbGVzOiBQYXJ0aWNsZVtdICk6IG51bWJlciB7XHJcbiAgbGV0IGF2ZXJhZ2VTcGVlZCA9IDA7XHJcbiAgaWYgKCBwYXJ0aWNsZXMubGVuZ3RoID4gMCApIHtcclxuICAgIGxldCB0b3RhbFNwZWVkID0gMDtcclxuICAgIGZvciAoIGxldCBpID0gcGFydGljbGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkge1xyXG4gICAgICB0b3RhbFNwZWVkICs9IHBhcnRpY2xlc1sgaSBdLnZlbG9jaXR5Lm1hZ25pdHVkZTtcclxuICAgIH1cclxuICAgIGF2ZXJhZ2VTcGVlZCA9IHRvdGFsU3BlZWQgLyBwYXJ0aWNsZXMubGVuZ3RoO1xyXG4gIH1cclxuICByZXR1cm4gYXZlcmFnZVNwZWVkO1xyXG59XHJcblxyXG5nYXNQcm9wZXJ0aWVzLnJlZ2lzdGVyKCAnQXZlcmFnZVNwZWVkTW9kZWwnLCBBdmVyYWdlU3BlZWRNb2RlbCApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFFBQVEsTUFBMkIsaUNBQWlDO0FBRTNFLFNBQVNDLGNBQWMsUUFBMEIsdUNBQXVDO0FBR3hGLE9BQU9DLFVBQVUsTUFBTSwyQ0FBMkM7QUFDbEUsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUc5RCxPQUFPQyxhQUFhLE1BQU0sd0JBQXdCOztBQUVsRDtBQUNBLE1BQU1DLDhCQUE4RCxHQUFHO0VBQ3JFQyxLQUFLLEVBQUUsT0FBTztFQUNkQyxZQUFZLEVBQUVDLFlBQVksSUFBTUEsWUFBWSxLQUFLLElBQUksSUFBSUEsWUFBWSxJQUFJLENBQUc7RUFDNUVDLGVBQWUsRUFBRVAsVUFBVSxDQUFFQyxRQUFTLENBQUM7RUFDdkNPLGNBQWMsRUFBRSxJQUFJLENBQUM7QUFDdkIsQ0FBQzs7QUFNRCxlQUFlLE1BQU1DLGlCQUFpQixDQUFDO0VBTXJDOztFQUlBO0VBQytCO0VBQ0U7RUFDSztFQUNBO0VBRXRDO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTQyxXQUFXQSxDQUFFQyxjQUE4QixFQUFFQyxpQkFBNkMsRUFDN0VDLFlBQW9CLEVBQUVDLGVBQXlDLEVBQUc7SUFDcEZDLE1BQU0sSUFBSUEsTUFBTSxDQUFFRixZQUFZLEdBQUcsQ0FBQyxFQUFHLHlCQUF3QkEsWUFBYSxFQUFFLENBQUM7SUFFN0UsTUFBTUcsT0FBTyxHQUFHRixlQUFlO0lBRS9CLElBQUksQ0FBQ0gsY0FBYyxHQUFHQSxjQUFjO0lBQ3BDLElBQUksQ0FBQ0MsaUJBQWlCLEdBQUdBLGlCQUFpQjtJQUMxQyxJQUFJLENBQUND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