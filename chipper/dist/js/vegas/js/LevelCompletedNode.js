// Copyright 2013-2023, University of Colorado Boulder

/**
 * This node is used to display a user's results when they complete a level.
 *
 * @author John Blanco
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../axon/js/DerivedProperty.js';
import Property from '../../axon/js/Property.js';
import optionize from '../../phet-core/js/optionize.js';
import StringUtils from '../../phetcommon/js/util/StringUtils.js';
import PhetColorScheme from '../../scenery-phet/js/PhetColorScheme.js';
import PhetFont from '../../scenery-phet/js/PhetFont.js';
import { RichText, Text, VBox } from '../../scenery/js/imports.js';
import TextPushButton from '../../sun/js/buttons/TextPushButton.js';
import Panel from '../../sun/js/Panel.js';
import Tandem from '../../tandem/js/Tandem.js';
import GameTimer from './GameTimer.js';
import ScoreDisplayStars from './ScoreDisplayStars.js';
import vegas from './vegas.js';
import VegasStrings from './VegasStrings.js';
const DEFAULT_TITLE_FONT = new PhetFont({
  size: 28,
  weight: 'bold'
});
const DEFAULT_INFO_FONT = new PhetFont({
  size: 22,
  weight: 'bold'
});
const DEFAULT_BUTTON_FONT = new PhetFont(26);
export default class LevelCompletedNode extends Panel {
  /**
   * @param level - the game level that has been completed
   * @param score
   * @param perfectScore
   * @param numberOfStars
   * @param timerEnabled
   * @param elapsedTime (in seconds)
   * @param bestTimeAtThisLevel (in seconds), null indicates no best time
   * @param isNewBestTime
   * @param continueFunction - function to call when the user presses the 'Continue' button
   * @param providedOptions
   */
  constructor(level, score, perfectScore, numberOfStars, timerEnabled, elapsedTime, bestTimeAtThisLevel, isNewBestTime, continueFunction, providedOptions) {
    const options = optionize()({
      // SelfOptions
      levelVisible: true,
      ySpacing: 30,
      titleFont: DEFAULT_TITLE_FONT,
      infoFont: DEFAULT_INFO_FONT,
      buttonFont: DEFAULT_BUTTON_FONT,
      buttonFill: PhetColorScheme.BUTTON_YELLOW,
      starDiameter: 62,
      contentMaxWidth: null,
      // PanelOptions
      fill: 'rgb( 180, 205, 255 )',
      stroke: 'black',
      lineWidth: 2,
      cornerRadius: 35,
      xMargin: 20,
      yMargin: 20,
      tandem: Tandem.REQUIRED
    }, providedOptions);
    const vBoxChildren = [];

    // Title, which changes based on how the user did.
    const proportionCorrect = score / perfectScore;
    let titleTextStringProperty = VegasStrings.keepTryingStringProperty;
    if (proportionCorrect > 0.95) {
      titleTextStringProperty = VegasStrings.excellentStringProperty;
    } else if (proportionCorrect > 0.75) {
      titleTextStringProperty = VegasStrings.greatStringProperty;
    } else if (proportionCorrect >= 0.5) {
      titleTextStringProperty = VegasStrings.goodStringProperty;
    }
    const title = new Text(titleTextStringProperty, {
      font: options.titleFont,
      maxWidth: options.contentMaxWidth
    });
    vBoxChildren.push(title);

    // Progress indicator
    const scoreDisplayStars = new ScoreDisplayStars(new Property(score), {
      numberOfStars: numberOfStars,
      perfectScore: perfectScore,
      starNodeOptions: {
        starShapeOptions: {
          innerRadius: options.starDiameter / 4,
          outerRadius: options.starDiameter / 2
        }
      },
      maxWidth: options.contentMaxWidth
    });
    vBoxChildren.push(scoreDisplayStars);

    // Level (optional)
    if (options.levelVisible) {
      const levelStringProperty = new DerivedProperty([VegasStrings.label.levelStringProperty], pattern => StringUtils.format(pattern, level));
      vBoxChildren.push(new Text(levelStringProperty, {
        font: options.infoFont,
        maxWidth: options.contentMaxWidth
      }));
    }

    // Score
    const scoreStringProperty = new DerivedProperty([VegasStrings.label.score.maxStringProperty], pattern => StringUtils.format(pattern, score, perfectScore));
    vBoxChildren.push(new Text(scoreStringProperty, {
      font: options.infoFont,
      maxWidth: options.contentMaxWidth
    }));

    // Time (optional)
    if (timerEnabled) {
      // Time: MM:SS
      const elapsedTimeStringProperty = new DerivedProperty([VegasStrings.label.timeStringProperty], pattern => StringUtils.format(pattern, GameTimer.formatTime(elapsedTime)));
      let timeStringProperty;
      if (isNewBestTime) {
        // Time: MM:SS
        // (Your New Best!)
        timeStringProperty = new DerivedProperty([elapsedTimeStringProperty, VegasStrings.yourNewBestStringProperty], (elapsedTime, yourNewBest) => `${elapsedTime}<br>${yourNewBest}`);
      } else if (bestTimeAtThisLevel !== null) {
        // Time: MM:SS
        // (Your Best: MM:SS)
        timeStringProperty = new DerivedProperty([elapsedTimeStringProperty, VegasStrings.pattern['0yourBestStringProperty']], (elapsedTime, pattern) => `${elapsedTime}<br>${StringUtils.format(pattern, GameTimer.formatTime(bestTimeAtThisLevel))}`);
      } else {
        // Time: MM:SS
        timeStringProperty = elapsedTimeStringProperty;
      }
      vBoxChildren.push(new RichText(timeStringProperty, {
        font: options.infoFont,
        align: 'center',
        maxWidth: options.contentMaxWidth
      }));
    }

    // Continue button
    const continueButton = new TextPushButton(VegasStrings.continueStringProperty, {
      listener: continueFunction,
      font: options.buttonFont,
      baseColor: options.buttonFill,
      tandem: options.tandem.createTandem('continueButton'),
      maxWidth: options.contentMaxWidth
    });
    vBoxChildren.push(continueButton);
    const content = new VBox({
      children: vBoxChildren,
      spacing: options.ySpacing
    });
    super(content, options);
    this.disposeLevelCompletedNode = () => {
      // All VBox children are linked to dynamic string Properties, so must be disposed.
      vBoxChildren.forEach(child => child.dispose());
    };
  }
  dispose() {
    this.disposeLevelCompletedNode();
    super.dispose();
  }
}
vegas.register('LevelCompletedNode', LevelCompletedNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJQcm9wZXJ0eSIsIm9wdGlvbml6ZSIsIlN0cmluZ1V0aWxzIiwiUGhldENvbG9yU2NoZW1lIiwiUGhldEZvbnQiLCJSaWNoVGV4dCIsIlRleHQiLCJWQm94IiwiVGV4dFB1c2hCdXR0b24iLCJQYW5lbCIsIlRhbmRlbSIsIkdhbWVUaW1lciIsIlNjb3JlRGlzcGxheVN0YXJzIiwidmVnYXMiLCJWZWdhc1N0cmluZ3MiLCJERUZBVUxUX1RJVExFX0ZPTlQiLCJzaXplIiwid2VpZ2h0IiwiREVGQVVMVF9JTkZPX0ZPTlQiLCJERUZBVUxUX0JVVFRPTl9GT05UIiwiTGV2ZWxDb21wbGV0ZWROb2RlIiwiY29uc3RydWN0b3IiLCJsZXZlbCIsInNjb3JlIiwicGVyZmVjdFNjb3JlIiwibnVtYmVyT2ZTdGFycyIsInRpbWVyRW5hYmxlZCIsImVsYXBzZWRUaW1lIiwiYmVzdFRpbWVBdFRoaXNMZXZlbCIsImlzTmV3QmVzdFRpbWUiLCJjb250aW51ZUZ1bmN0aW9uIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImxldmVsVmlzaWJsZSIsInlTcGFjaW5nIiwidGl0bGVGb250IiwiaW5mb0ZvbnQiLCJidXR0b25Gb250IiwiYnV0dG9uRmlsbCIsIkJVVFRPTl9ZRUxMT1ciLCJzdGFyRGlhbWV0ZXIiLCJjb250ZW50TWF4V2lkdGgiLCJmaWxsIiwic3Ryb2tlIiwibGluZVdpZHRoIiwiY29ybmVyUmFkaXVzIiwieE1hcmdpbiIsInlNYXJnaW4iLCJ0YW5kZW0iLCJSRVFVSVJFRCIsInZCb3hDaGlsZHJlbiIsInByb3BvcnRpb25Db3JyZWN0IiwidGl0bGVUZXh0U3RyaW5nUHJvcGVydHkiLCJrZWVwVHJ5aW5nU3RyaW5nUHJvcGVydHkiLCJleGNlbGxlbnRTdHJpbmdQcm9wZXJ0eSIsImdyZWF0U3RyaW5nUHJvcGVydHkiLCJnb29kU3RyaW5nUHJvcGVydHkiLCJ0aXRsZSIsImZvbnQiLCJtYXhXaWR0aCIsInB1c2giLCJzY29yZURpc3BsYXlTdGFycyIsInN0YXJOb2RlT3B0aW9ucyIsInN0YXJTaGFwZU9wdGlvbnMiLCJpbm5lclJhZGl1cyIsIm91dGVyUmFkaXVzIiwibGV2ZWxTdHJpbmdQcm9wZXJ0eSIsImxhYmVsIiwicGF0dGVybiIsImZvcm1hdCIsInNjb3JlU3RyaW5nUHJvcGVydHkiLCJtYXhTdHJpbmdQcm9wZXJ0eSIsImVsYXBzZWRUaW1lU3RyaW5nUHJvcGVydHkiLCJ0aW1lU3RyaW5nUHJvcGVydHkiLCJmb3JtYXRUaW1lIiwieW91ck5ld0Jlc3RTdHJpbmdQcm9wZXJ0eSIsInlvdXJOZXdCZXN0IiwiYWxpZ24iLCJjb250aW51ZUJ1dHRvbiIsImNvbnRpbnVlU3RyaW5nUHJvcGVydHkiLCJsaXN0ZW5lciIsImJhc2VDb2xvciIsImNyZWF0ZVRhbmRlbSIsImNvbnRlbnQiLCJjaGlsZHJlbiIsInNwYWNpbmciLCJkaXNwb3NlTGV2ZWxDb21wbGV0ZWROb2RlIiwiZm9yRWFjaCIsImNoaWxkIiwiZGlzcG9zZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTGV2ZWxDb21wbGV0ZWROb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoaXMgbm9kZSBpcyB1c2VkIHRvIGRpc3BsYXkgYSB1c2VyJ3MgcmVzdWx0cyB3aGVuIHRoZXkgY29tcGxldGUgYSBsZXZlbC5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBTdHJpbmdVdGlscyBmcm9tICcuLi8uLi9waGV0Y29tbW9uL2pzL3V0aWwvU3RyaW5nVXRpbHMuanMnO1xyXG5pbXBvcnQgUGhldENvbG9yU2NoZW1lIGZyb20gJy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Q29sb3JTY2hlbWUuanMnO1xyXG5pbXBvcnQgUGhldEZvbnQgZnJvbSAnLi4vLi4vc2NlbmVyeS1waGV0L2pzL1BoZXRGb250LmpzJztcclxuaW1wb3J0IHsgRm9udCwgTm9kZSwgUmljaFRleHQsIFRDb2xvciwgVGV4dCwgVkJveCB9IGZyb20gJy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCB7IFB1c2hCdXR0b25MaXN0ZW5lciB9IGZyb20gJy4uLy4uL3N1bi9qcy9idXR0b25zL1B1c2hCdXR0b25Nb2RlbC5qcyc7XHJcbmltcG9ydCBUZXh0UHVzaEJ1dHRvbiBmcm9tICcuLi8uLi9zdW4vanMvYnV0dG9ucy9UZXh0UHVzaEJ1dHRvbi5qcyc7XHJcbmltcG9ydCBQYW5lbCwgeyBQYW5lbE9wdGlvbnMgfSBmcm9tICcuLi8uLi9zdW4vanMvUGFuZWwuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgR2FtZVRpbWVyIGZyb20gJy4vR2FtZVRpbWVyLmpzJztcclxuaW1wb3J0IFNjb3JlRGlzcGxheVN0YXJzIGZyb20gJy4vU2NvcmVEaXNwbGF5U3RhcnMuanMnO1xyXG5pbXBvcnQgdmVnYXMgZnJvbSAnLi92ZWdhcy5qcyc7XHJcbmltcG9ydCBWZWdhc1N0cmluZ3MgZnJvbSAnLi9WZWdhc1N0cmluZ3MuanMnO1xyXG5cclxuY29uc3QgREVGQVVMVF9USVRMRV9GT05UID0gbmV3IFBoZXRGb250KCB7IHNpemU6IDI4LCB3ZWlnaHQ6ICdib2xkJyB9ICk7XHJcbmNvbnN0IERFRkFVTFRfSU5GT19GT05UID0gbmV3IFBoZXRGb250KCB7IHNpemU6IDIyLCB3ZWlnaHQ6ICdib2xkJyB9ICk7XHJcbmNvbnN0IERFRkFVTFRfQlVUVE9OX0ZPTlQgPSBuZXcgUGhldEZvbnQoIDI2ICk7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIGxldmVsVmlzaWJsZT86IGJvb2xlYW47IC8vIHdoZXRoZXIgdG8gZGlzcGxheSB0aGUgbGV2ZWwgbnVtYmVyXHJcbiAgeVNwYWNpbmc/OiBudW1iZXI7XHJcbiAgdGl0bGVGb250PzogRm9udDtcclxuICBpbmZvRm9udD86IEZvbnQ7XHJcbiAgYnV0dG9uRm9udD86IEZvbnQ7XHJcbiAgYnV0dG9uRmlsbD86IFRDb2xvcjtcclxuICBzdGFyRGlhbWV0ZXI/OiBudW1iZXI7XHJcbiAgY29udGVudE1heFdpZHRoPzogbnVtYmVyIHwgbnVsbDsgLy8gYXBwbGllZCBhcyBtYXhXaWR0aCB0byBldmVyeSBzdWJjb21wb25lbnQgaW5kaXZpZHVhbGx5LCBub3QgUGFuZWwncyBjb250ZW50XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBMZXZlbENvbXBsZXRlZE5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQYW5lbE9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMZXZlbENvbXBsZXRlZE5vZGUgZXh0ZW5kcyBQYW5lbCB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zZUxldmVsQ29tcGxldGVkTm9kZTogKCkgPT4gdm9pZDtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGxldmVsIC0gdGhlIGdhbWUgbGV2ZWwgdGhhdCBoYXMgYmVlbiBjb21wbGV0ZWRcclxuICAgKiBAcGFyYW0gc2NvcmVcclxuICAgKiBAcGFyYW0gcGVyZmVjdFNjb3JlXHJcbiAgICogQHBhcmFtIG51bWJlck9mU3RhcnNcclxuICAgKiBAcGFyYW0gdGltZXJFbmFibGVkXHJcbiAgICogQHBhcmFtIGVsYXBzZWRUaW1lIChpbiBzZWNvbmRzKVxyXG4gICAqIEBwYXJhbSBiZXN0VGltZUF0VGhpc0xldmVsIChpbiBzZWNvbmRzKSwgbnVsbCBpbmRpY2F0ZXMgbm8gYmVzdCB0aW1lXHJcbiAgICogQHBhcmFtIGlzTmV3QmVzdFRpbWVcclxuICAgKiBAcGFyYW0gY29udGludWVGdW5jdGlvbiAtIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgdXNlciBwcmVzc2VzIHRoZSAnQ29udGludWUnIGJ1dHRvblxyXG4gICAqIEBwYXJhbSBwcm92aWRlZE9wdGlvbnNcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGxldmVsOiBudW1iZXIsIHNjb3JlOiBudW1iZXIsIHBlcmZlY3RTY29yZTogbnVtYmVyLCBudW1iZXJPZlN0YXJzOiBudW1iZXIsIHRpbWVyRW5hYmxlZDogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lOiBudW1iZXIsIGJlc3RUaW1lQXRUaGlzTGV2ZWw6IG51bWJlciB8IG51bGwsIGlzTmV3QmVzdFRpbWU6IGJvb2xlYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZUZ1bmN0aW9uOiBQdXNoQnV0dG9uTGlzdGVuZXIsIHByb3ZpZGVkT3B0aW9ucz86IExldmVsQ29tcGxldGVkTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxMZXZlbENvbXBsZXRlZE5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgUGFuZWxPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBsZXZlbFZpc2libGU6IHRydWUsXHJcbiAgICAgIHlTcGFjaW5nOiAzMCxcclxuICAgICAgdGl0bGVGb250OiBERUZBVUxUX1RJVExFX0ZPTlQsXHJcbiAgICAgIGluZm9Gb250OiBERUZBVUxUX0lORk9fRk9OVCxcclxuICAgICAgYnV0dG9uRm9udDogREVGQVVMVF9CVVRUT05fRk9OVCxcclxuICAgICAgYnV0dG9uRmlsbDogUGhldENvbG9yU2NoZW1lLkJVVFRPTl9ZRUxMT1csXHJcbiAgICAgIHN0YXJEaWFtZXRlcjogNjIsXHJcbiAgICAgIGNvbnRlbnRNYXhXaWR0aDogbnVsbCxcclxuXHJcbiAgICAgIC8vIFBhbmVsT3B0aW9uc1xyXG4gICAgICBmaWxsOiAncmdiKCAxODAsIDIwNSwgMjU1ICknLFxyXG4gICAgICBzdHJva2U6ICdibGFjaycsXHJcbiAgICAgIGxpbmVXaWR0aDogMixcclxuICAgICAgY29ybmVyUmFkaXVzOiAzNSxcclxuICAgICAgeE1hcmdpbjogMjAsXHJcbiAgICAgIHlNYXJnaW46IDIwLFxyXG4gICAgICB0YW5kZW06IFRhbmRlbS5SRVFVSVJFRFxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgdkJveENoaWxkcmVuOiBOb2RlW10gPSBbXTtcclxuXHJcbiAgICAvLyBUaXRsZSwgd2hpY2ggY2hhbmdlcyBiYXNlZCBvbiBob3cgdGhlIHVzZXIgZGlkLlxyXG4gICAgY29uc3QgcHJvcG9ydGlvbkNvcnJlY3QgPSBzY29yZSAvIHBlcmZlY3RTY29yZTtcclxuICAgIGxldCB0aXRsZVRleHRTdHJpbmdQcm9wZXJ0eSA9IFZlZ2FzU3RyaW5ncy5rZWVwVHJ5aW5nU3RyaW5nUHJvcGVydHk7XHJcbiAgICBpZiAoIHByb3BvcnRpb25Db3JyZWN0ID4gMC45NSApIHtcclxuICAgICAgdGl0bGVUZXh0U3RyaW5nUHJvcGVydHkgPSBWZWdhc1N0cmluZ3MuZXhjZWxsZW50U3RyaW5nUHJvcGVydHk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggcHJvcG9ydGlvbkNvcnJlY3QgPiAwLjc1ICkge1xyXG4gICAgICB0aXRsZVRleHRTdHJpbmdQcm9wZXJ0eSA9IFZlZ2FzU3RyaW5ncy5ncmVhdFN0cmluZ1Byb3BlcnR5O1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIHByb3BvcnRpb25Db3JyZWN0ID49IDAuNSApIHtcclxuICAgICAgdGl0bGVUZXh0U3RyaW5nUHJvcGVydHkgPSBWZWdhc1N0cmluZ3MuZ29vZFN0cmluZ1Byb3BlcnR5O1xyXG4gICAgfVxyXG4gICAgY29uc3QgdGl0bGUgPSBuZXcgVGV4dCggdGl0bGVUZXh0U3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgZm9udDogb3B0aW9ucy50aXRsZUZvbnQsXHJcbiAgICAgIG1heFdpZHRoOiBvcHRpb25zLmNvbnRlbnRNYXhXaWR0aFxyXG4gICAgfSApO1xyXG4gICAgdkJveENoaWxkcmVuLnB1c2goIHRpdGxlICk7XHJcblxyXG4gICAgLy8gUHJvZ3Jlc3MgaW5kaWNhdG9yXHJcbiAgICBjb25zdCBzY29yZURpc3BsYXlTdGFycyA9IG5ldyBTY29yZURpc3BsYXlTdGFycyggbmV3IFByb3BlcnR5KCBzY29yZSApLCB7XHJcbiAgICAgIG51bWJlck9mU3RhcnM6IG51bWJlck9mU3RhcnMsXHJcbiAgICAgIHBlcmZlY3RTY29yZTogcGVyZmVjdFNjb3JlLFxyXG4gICAgICBzdGFyTm9kZU9wdGlvbnM6IHtcclxuICAgICAgICBzdGFyU2hhcGVPcHRpb25zOiB7XHJcbiAgICAgICAgICBpbm5lclJhZGl1czogb3B0aW9ucy5zdGFyRGlhbWV0ZXIgLyA0LFxyXG4gICAgICAgICAgb3V0ZXJSYWRpdXM6IG9wdGlvbnMuc3RhckRpYW1ldGVyIC8gMlxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgbWF4V2lkdGg6IG9wdGlvbnMuY29udGVudE1heFdpZHRoXHJcbiAgICB9ICk7XHJcbiAgICB2Qm94Q2hpbGRyZW4ucHVzaCggc2NvcmVEaXNwbGF5U3RhcnMgKTtcclxuXHJcbiAgICAvLyBMZXZlbCAob3B0aW9uYWwpXHJcbiAgICBpZiAoIG9wdGlvbnMubGV2ZWxWaXNpYmxlICkge1xyXG5cclxuICAgICAgY29uc3QgbGV2ZWxTdHJpbmdQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgICAgWyBWZWdhc1N0cmluZ3MubGFiZWwubGV2ZWxTdHJpbmdQcm9wZXJ0eSBdLFxyXG4gICAgICAgIHBhdHRlcm4gPT4gU3RyaW5nVXRpbHMuZm9ybWF0KCBwYXR0ZXJuLCBsZXZlbCApXHJcbiAgICAgICk7XHJcblxyXG4gICAgICB2Qm94Q2hpbGRyZW4ucHVzaCggbmV3IFRleHQoIGxldmVsU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgICBmb250OiBvcHRpb25zLmluZm9Gb250LFxyXG4gICAgICAgIG1heFdpZHRoOiBvcHRpb25zLmNvbnRlbnRNYXhXaWR0aFxyXG4gICAgICB9ICkgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBTY29yZVxyXG4gICAgY29uc3Qgc2NvcmVTdHJpbmdQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgVmVnYXNTdHJpbmdzLmxhYmVsLnNjb3JlLm1heFN0cmluZ1Byb3BlcnR5IF0sXHJcbiAgICAgIHBhdHRlcm4gPT4gU3RyaW5nVXRpbHMuZm9ybWF0KCBwYXR0ZXJuLCBzY29yZSwgcGVyZmVjdFNjb3JlIClcclxuICAgICk7XHJcbiAgICB2Qm94Q2hpbGRyZW4ucHVzaCggbmV3IFRleHQoIHNjb3JlU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgZm9udDogb3B0aW9ucy5pbmZvRm9udCxcclxuICAgICAgbWF4V2lkdGg6IG9wdGlvbnMuY29udGVudE1heFdpZHRoXHJcbiAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBUaW1lIChvcHRpb25hbClcclxuICAgIGlmICggdGltZXJFbmFibGVkICkge1xyXG5cclxuICAgICAgLy8gVGltZTogTU06U1NcclxuICAgICAgY29uc3QgZWxhcHNlZFRpbWVTdHJpbmdQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgICAgWyBWZWdhc1N0cmluZ3MubGFiZWwudGltZVN0cmluZ1Byb3BlcnR5IF0sXHJcbiAgICAgICAgcGF0dGVybiA9PiBTdHJpbmdVdGlscy5mb3JtYXQoIHBhdHRlcm4sIEdhbWVUaW1lci5mb3JtYXRUaW1lKCBlbGFwc2VkVGltZSApIClcclxuICAgICAgKTtcclxuXHJcbiAgICAgIGxldCB0aW1lU3RyaW5nUHJvcGVydHk7XHJcbiAgICAgIGlmICggaXNOZXdCZXN0VGltZSApIHtcclxuXHJcbiAgICAgICAgLy8gVGltZTogTU06U1NcclxuICAgICAgICAvLyAoWW91ciBOZXcgQmVzdCEpXHJcbiAgICAgICAgdGltZVN0cmluZ1Byb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgICAgIFsgZWxhcHNlZFRpbWVTdHJpbmdQcm9wZXJ0eSwgVmVnYXNTdHJpbmdzLnlvdXJOZXdCZXN0U3RyaW5nUHJvcGVydHkgXSxcclxuICAgICAgICAgICggZWxhcHNlZFRpbWU6IHN0cmluZywgeW91ck5ld0Jlc3Q6IHN0cmluZyApID0+IGAke2VsYXBzZWRUaW1lfTxicj4ke3lvdXJOZXdCZXN0fWBcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCBiZXN0VGltZUF0VGhpc0xldmVsICE9PSBudWxsICkge1xyXG5cclxuICAgICAgICAvLyBUaW1lOiBNTTpTU1xyXG4gICAgICAgIC8vIChZb3VyIEJlc3Q6IE1NOlNTKVxyXG4gICAgICAgIHRpbWVTdHJpbmdQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgICAgICBbIGVsYXBzZWRUaW1lU3RyaW5nUHJvcGVydHksIFZlZ2FzU3RyaW5ncy5wYXR0ZXJuWyAnMHlvdXJCZXN0U3RyaW5nUHJvcGVydHknIF0gXSxcclxuICAgICAgICAgICggZWxhcHNlZFRpbWU6IHN0cmluZywgcGF0dGVybjogc3RyaW5nICkgPT5cclxuICAgICAgICAgICAgYCR7ZWxhcHNlZFRpbWV9PGJyPiR7U3RyaW5nVXRpbHMuZm9ybWF0KCBwYXR0ZXJuLCBHYW1lVGltZXIuZm9ybWF0VGltZSggYmVzdFRpbWVBdFRoaXNMZXZlbCApICl9YFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgIC8vIFRpbWU6IE1NOlNTXHJcbiAgICAgICAgdGltZVN0cmluZ1Byb3BlcnR5ID0gZWxhcHNlZFRpbWVTdHJpbmdQcm9wZXJ0eTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdkJveENoaWxkcmVuLnB1c2goIG5ldyBSaWNoVGV4dCggdGltZVN0cmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgICAgZm9udDogb3B0aW9ucy5pbmZvRm9udCxcclxuICAgICAgICBhbGlnbjogJ2NlbnRlcicsXHJcbiAgICAgICAgbWF4V2lkdGg6IG9wdGlvbnMuY29udGVudE1heFdpZHRoXHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENvbnRpbnVlIGJ1dHRvblxyXG4gICAgY29uc3QgY29udGludWVCdXR0b24gPSBuZXcgVGV4dFB1c2hCdXR0b24oIFZlZ2FzU3RyaW5ncy5jb250aW51ZVN0cmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgIGxpc3RlbmVyOiBjb250aW51ZUZ1bmN0aW9uLFxyXG4gICAgICBmb250OiBvcHRpb25zLmJ1dHRvbkZvbnQsXHJcbiAgICAgIGJhc2VDb2xvcjogb3B0aW9ucy5idXR0b25GaWxsLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2NvbnRpbnVlQnV0dG9uJyApLFxyXG4gICAgICBtYXhXaWR0aDogb3B0aW9ucy5jb250ZW50TWF4V2lkdGhcclxuICAgIH0gKTtcclxuICAgIHZCb3hDaGlsZHJlbi5wdXNoKCBjb250aW51ZUJ1dHRvbiApO1xyXG5cclxuICAgIGNvbnN0IGNvbnRlbnQgPSBuZXcgVkJveCgge1xyXG4gICAgICBjaGlsZHJlbjogdkJveENoaWxkcmVuLFxyXG4gICAgICBzcGFjaW5nOiBvcHRpb25zLnlTcGFjaW5nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgc3VwZXIoIGNvbnRlbnQsIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VMZXZlbENvbXBsZXRlZE5vZGUgPSAoKSA9PiB7XHJcblxyXG4gICAgICAvLyBBbGwgVkJveCBjaGlsZHJlbiBhcmUgbGlua2VkIHRvIGR5bmFtaWMgc3RyaW5nIFByb3BlcnRpZXMsIHNvIG11c3QgYmUgZGlzcG9zZWQuXHJcbiAgICAgIHZCb3hDaGlsZHJlbi5mb3JFYWNoKCBjaGlsZCA9PiBjaGlsZC5kaXNwb3NlKCkgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZUxldmVsQ29tcGxldGVkTm9kZSgpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxudmVnYXMucmVnaXN0ZXIoICdMZXZlbENvbXBsZXRlZE5vZGUnLCBMZXZlbENvbXBsZXRlZE5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sa0NBQWtDO0FBQzlELE9BQU9DLFFBQVEsTUFBTSwyQkFBMkI7QUFDaEQsT0FBT0MsU0FBUyxNQUFNLGlDQUFpQztBQUN2RCxPQUFPQyxXQUFXLE1BQU0seUNBQXlDO0FBQ2pFLE9BQU9DLGVBQWUsTUFBTSwwQ0FBMEM7QUFDdEUsT0FBT0MsUUFBUSxNQUFNLG1DQUFtQztBQUN4RCxTQUFxQkMsUUFBUSxFQUFVQyxJQUFJLEVBQUVDLElBQUksUUFBUSw2QkFBNkI7QUFFdEYsT0FBT0MsY0FBYyxNQUFNLHdDQUF3QztBQUNuRSxPQUFPQyxLQUFLLE1BQXdCLHVCQUF1QjtBQUMzRCxPQUFPQyxNQUFNLE1BQU0sMkJBQTJCO0FBQzlDLE9BQU9DLFNBQVMsTUFBTSxnQkFBZ0I7QUFDdEMsT0FBT0MsaUJBQWlCLE1BQU0sd0JBQXdCO0FBQ3RELE9BQU9DLEtBQUssTUFBTSxZQUFZO0FBQzlCLE9BQU9DLFlBQVksTUFBTSxtQkFBbUI7QUFFNUMsTUFBTUMsa0JBQWtCLEdBQUcsSUFBSVgsUUFBUSxDQUFFO0VBQUVZLElBQUksRUFBRSxFQUFFO0VBQUVDLE1BQU0sRUFBRTtBQUFPLENBQUUsQ0FBQztBQUN2RSxNQUFNQyxpQkFBaUIsR0FBRyxJ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