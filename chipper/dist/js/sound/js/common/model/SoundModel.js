// Copyright 2022-2023, University of Colorado Boulder
/**
 * Base model for a sound scene.
 *
 * @author Piet Goris (University of Leuven)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Range from '../../../../dot/js/Range.js';
import Rectangle from '../../../../dot/js/Rectangle.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import EventTimer from '../../../../phet-core/js/EventTimer.js';
import optionize from '../../../../phet-core/js/optionize.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import Lattice from '../../../../scenery-phet/js/Lattice.js';
import TemporalMask from '../../common/model/TemporalMask.js';
import SoundConstants from '../../common/SoundConstants.js';
import sound from '../../sound.js';

// This simulation uses EventTimer, which provides exactly the same model behavior on very slow and very fast
// platforms.  Here we define the frequency of events in Hz, which has been tuned so that our slowest platform has
// an acceptable frame rate
const eventTimerPeriod = 1 / SoundConstants.EVENT_RATE;
const frequencyRange = new Range(0, 1);
const INITIAL_FREQUENCY = 0.5;
export default class SoundModel {
  // whether audio is enabled

  // position of the non-moving first speaker.

  // the value of the wave at the oscillation point

  // propery that shows that a pulse is firing

  // the frequency in the appropriate units for the scene

  // controls the amplitude of the wave.

  // whether this model has a reflection wall.

  // propery that shows if the simulation in running.

  //  phase of the sound wave.
  phase = 0;

  // number of steps since launch of the simulation.
  stepIndex = 0;

  // In order to have exactly the same model behavior on very fast and very slow platforms, we use
  // EventTimer, which updates the model at regular intervals, and we can interpolate between states for additional
  // fidelity.
  // elapsed time in seconds
  // the grid that contains the wave values of the first speaker
  pulseStartTime = null;
  constructor(providedOptions) {
    const options = optionize()({
      initialAmplitude: 5,
      speaker1PositionY: SoundConstants.WAVE_AREA_WIDTH / 2,
      hasReflection: false,
      hasSecondSource: false
    }, providedOptions);
    this.hasSecondSource = options.hasSecondSource;
    this.hasReflection = options.hasReflection;
    this.isRunningProperty = new BooleanProperty(true);
    this.isPulseFiringProperty = new BooleanProperty(false);
    this.phase = 0;
    this.stepIndex = 0;
    this.temporalMask = new TemporalMask();
    this.oscillatorProperty = new NumberProperty(0);
    const eventTimerModel = {
      getPeriodBeforeNextEvent: () => eventTimerPeriod
    };
    this.eventTimer = new EventTimer(eventTimerModel, timeElapsed => this.advanceTime(eventTimerPeriod, false));

    // When frequency changes, choose a new phase such that the new sine curve has the same value and direction
    // for continuity
    const phaseUpdate = (newFrequency, oldFrequency) => {
      // For the main model, Math.sin is performed on angular frequency, so to match the phase, that computation
      // should also be based on angular frequencies
      const oldAngularFrequency = oldFrequency * Math.PI * 2;
      const newAngularFrequency = newFrequency * Math.PI * 2;
      const time = this.timeProperty.value;
      const oldValue = Math.sin(time * oldAngularFrequency + this.phase);
      let proposedPhase = Math.asin(oldValue) - time * newAngularFrequency;
      const oldDerivative = Math.cos(time * oldAngularFrequency + this.phase);
      const newDerivative = Math.cos(time * newAngularFrequency + proposedPhase);

      // If wrong phase, take the sin value from the opposite side and move forward by half a cycle
      if (oldDerivative * newDerivative < 0) {
        proposedPhase = Math.asin(-oldValue) - time * newAngularFrequency + Math.PI;
      }
      this.phase = proposedPhase;
    };
    this.frequencyProperty = new NumberProperty(INITIAL_FREQUENCY, {
      range: frequencyRange
    });
    this.frequencyProperty.lazyLink(phaseUpdate);
    this.amplitudeProperty = new NumberProperty(options.initialAmplitude, {
      range: SoundConstants.AMPLITUDE_RANGE
    });
    this.timeProperty = new NumberProperty(0);
    this.lattice = new Lattice(SoundConstants.LATTICE_DIMENSION, SoundConstants.LATTICE_DIMENSION, SoundConstants.LATTICE_PADDING, SoundConstants.LATTICE_PADDING);
    this.modelToLatticeTransform = ModelViewTransform2.createRectangleMapping(new Rectangle(0, 0, SoundConstants.WAVE_AREA_WIDTH, SoundConstants.WAVE_AREA_WIDTH), this.lattice.visibleBounds);
    this.modelViewTransform = null;
    this.latticeToViewTransform = null;
    this.speaker1Position = new Vector2(this.modelToLatticeTransform.viewToModelX(SoundConstants.SOURCE_POSITION_X), options.speaker1PositionY);
    this.isAudioEnabledProperty = new BooleanProperty(false);
  }

  /**
   * After the view is initialized, determine the coordinate transformations that map to view coordinates.
   */
  setViewBounds(viewBounds) {
    assert && assert(this.modelViewTransform === null, 'setViewBounds cannot be called twice');
    this.modelViewTransform = ModelViewTransform2.createRectangleMapping(this.getWaveAreaBounds(), viewBounds);
    const latticeBounds = new Bounds2(0, 0, 1, 1);
    const modelBounds = this.modelToLatticeTransform.viewToModelBounds(latticeBounds);
    const tempViewBounds = this.modelViewTransform.modelToViewBounds(modelBounds);
    this.latticeToViewTransform = ModelViewTransform2.createRectangleMapping(latticeBounds, tempViewBounds);
  }

  /**
   * Returns a Bounds2 for the visible part of the wave area, in the coordinates of the scene.
   * @returns - the lattice model bounds, in the coordinates of this scene.
   */
  getWaveAreaBounds() {
    return new Bounds2(0, 0, SoundConstants.WAVE_AREA_WIDTH, SoundConstants.WAVE_AREA_WIDTH);
  }

  /**
   * Generate a wave from the point sources
   */
  generateWaves() {
    const amplitude = this.amplitudeProperty.get();
    const time = this.timeProperty.get();
    const frequency = this.frequencyProperty.get();
    const period = 1 / frequency;
    const timeSincePulseStarted = time - this.pulseStartTime;

    // @ts-expect-error
    const isContinuous = !this.soundModeProperty || this.soundModeProperty.get() === 'CONTINUOUS';

    // Used to compute whether a delta appears in either mask
    let temporalMaskEmpty = true;

    // If the pulse is running, end the pulse after one period
    if (this.isPulseFiringProperty.get()) {
      const timeSincePulseStarted = this.timeProperty.value - this.pulseStartTime;
      if (timeSincePulseStarted > period) {
        this.isPulseFiringProperty.set(false);
        this.pulseStartTime = 0;
      }
    }
    if (isContinuous || this.isPulseFiringProperty.get()) {
      // The simulation is designed to start with a downward wave, corresponding to water splashing in
      const angularFrequency = Math.PI * 2 * frequency;

      // Value to be multiplied with the final wave value.
      // @ts-expect-error
      const dampingByPressure = this.pressureProperty ? this.pressureProperty.value : 1;

      // Compute the wave value as a function of time, or set to zero if no longer generating a wave.
      const waveValue = this.isPulseFiringProperty.get() && timeSincePulseStarted > period ? 0 : -Math.sin(time * angularFrequency + this.phase) * amplitude * 1.2 * dampingByPressure;

      // Point source
      if (isContinuous || this.isPulseFiringProperty.get()) {
        const j = Math.floor(this.modelToLatticeTransform.modelToViewY(this.speaker1Position.y));
        this.lattice.setCurrentValue(SoundConstants.SOURCE_POSITION_X, j, waveValue);
        this.oscillatorProperty.value = waveValue;
        if (amplitude > 0 && frequency > 0) {
          this.temporalMask.set(true, this.stepIndex, j);
          temporalMaskEmpty = false;
        }
      }
    }
    temporalMaskEmpty && this.temporalMask.set(false, this.stepIndex, 0);
  }

  /**
   * The user has initiated a single pulse.
   */
  startPulse() {
    assert && assert(!this.isPulseFiringProperty.value, 'Cannot fire a pulse while a pulse is already being fired');
    this.resetPhase();
    this.isPulseFiringProperty.value = true;
    this.pulseStartTime = this.timeProperty.value;
  }

  /**
   * Start the sine argument at 0 so it will smoothly form the first wave.
   */
  resetPhase() {
    const frequency = this.frequencyProperty.get();
    const angularFrequency = Math.PI * 2 * frequency;

    // Solve for the sin arg = 0 in Math.sin( this.time * angularFrequency + this.phase )
    this.phase = -this.timeProperty.value * angularFrequency;
  }

  /**
   * Resets the model.
   */
  reset() {
    this.isAudioEnabledProperty.reset();
    this.isRunningProperty.reset();
    this.timeProperty.reset();
    this.frequencyProperty.reset();
    this.amplitudeProperty.reset();
    this.timeProperty.reset();
    this.oscillatorProperty.reset();
    this.phase = 0;
    this.stepIndex = 0;
    this.lattice.clear();
  }

  /**
   * Clears the waves from the screen.
   */
  clearWaves() {
    this.lattice.clear();
  }

  /**
   * Steps the model.
   * @param dt - time step, in seconds
   */
  step(dt) {
    // Feed the real time to the eventTimer and it will trigger advanceTime at the appropriate rate
    this.eventTimer.step(dt);
  }

  /**
   * By recording the times and positions of the wave disturbances, and knowing the wave propagation speed,
   * we can apply a masking function across the wave area, zeroing out any cell that could note have been generated
   * from the source disturbance.  This filters out spurious noise and restores "black" for the light scene.
   */
  applyTemporalMask() {
    // zero out values that are outside of the mask
    for (let i = 0; i < this.lattice.width; i++) {
      for (let j = 0; j < this.lattice.height; j++) {
        const distanceWithinBounds = this.temporalMask.matches(SoundConstants.SOURCE_POSITION_X, i, j, this.stepIndex) >= 0;
        this.lattice.setAllowed(i, j, distanceWithinBounds);
      }
    }

    // Prune entries.  Elements that are too far out of range are eliminated.  Use the diagonal of the lattice for the
    // max distance
    this.temporalMask.prune(Math.sqrt(2) * this.lattice.width, this.stepIndex);
  }

  /**
   * Additionally called from the "step" button
   * @param dt - amount of time that passed
   * @param manualStep - true if the step button is being pressed
   */
  advanceTime(dt, manualStep) {
    if (this.isRunningProperty.get() || manualStep) {
      // Correction constant taken from wave-interference
      const correction = 2.4187847116091334 * SoundConstants.WAVE_AREA_WIDTH / 500;

      // @ts-expect-error
      if (this.stopwatch) {
        // @ts-expect-error
        this.stopwatch.step(dt * correction);
      }
      this.lattice.interpolationRatio = this.eventTimer.getRatio();
      this.timeProperty.value += dt * correction;

      // Update the lattice
      this.lattice.step();

      // Apply values on top of the computed lattice values so there is no noise at the point sources
      this.generateWaves();
      this.applyTemporalMask();

      // Notify listeners about changes
      this.lattice.changedEmitter.emit();
      this.stepIndex++;
    }
  }
}
sound.register('SoundModel', SoundModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsIkJvdW5kczIiLCJSYW5nZSIsIlJlY3RhbmdsZSIsIlZlY3RvcjIiLCJFdmVudFRpbWVyIiwib3B0aW9uaXplIiwiTW9kZWxWaWV3VHJhbnNmb3JtMiIsIkxhdHRpY2UiLCJUZW1wb3JhbE1hc2siLCJTb3VuZENvbnN0YW50cyIsInNvdW5kIiwiZXZlbnRUaW1lclBlcmlvZCIsIkVWRU5UX1JBVEUiLCJmcmVxdWVuY3lSYW5nZSIsIklOSVRJQUxfRlJFUVVFTkNZIiwiU291bmRNb2RlbCIsInBoYXNlIiwic3RlcEluZGV4IiwicHVsc2VTdGFydFRpbWUiLCJjb25zdHJ1Y3RvciIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJpbml0aWFsQW1wbGl0dWRlIiwic3BlYWtlcjFQb3NpdGlvblkiLCJXQVZFX0FSRUFfV0lEVEgiLCJoYXNSZWZsZWN0aW9uIiwiaGFzU2Vjb25kU291cmNlIiwiaXNSdW5uaW5nUHJvcGVydHkiLCJpc1B1bHNlRmlyaW5nUHJvcGVydHkiLCJ0ZW1wb3JhbE1hc2siLCJvc2NpbGxhdG9yUHJvcGVydHkiLCJldmVudFRpbWVyTW9kZWwiLCJnZXRQZXJpb2RCZWZvcmVOZXh0RXZlbnQiLCJldmVudFRpbWVyIiwidGltZUVsYXBzZWQiLCJhZHZhbmNlVGltZSIsInBoYXNlVXBkYXRlIiwibmV3RnJlcXVlbmN5Iiwib2xkRnJlcXVlbmN5Iiwib2xkQW5ndWxhckZyZXF1ZW5jeSIsIk1hdGgiLCJQSSIsIm5ld0FuZ3VsYXJGcmVxdWVuY3kiLCJ0aW1lIiwidGltZVByb3BlcnR5IiwidmFsdWUiLCJvbGRWYWx1ZSIsInNpbiIsInByb3Bvc2VkUGhhc2UiLCJhc2luIiwib2xkRGVyaXZhdGl2ZSIsImNvcyIsIm5ld0Rlcml2YXRpdmUiLCJmcmVxdWVuY3lQcm9wZXJ0eSIsInJhbmdlIiwibGF6eUxpbmsiLCJhbXBsaXR1ZGVQcm9wZXJ0eSIsIkFNUExJVFVERV9SQU5HRSIsImxhdHRpY2UiLCJMQVRUSUNFX0RJTUVOU0lPTiIsIkxBVFRJQ0VfUEFERElORyIsIm1vZGVsVG9MYXR0aWNlVHJhbnNmb3JtIiwiY3JlYXRlUmVjdGFuZ2xlTWFwcGluZyIsInZpc2libGVCb3VuZHMiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJsYXR0aWNlVG9WaWV3VHJhbnNmb3JtIiwic3BlYWtlcjFQb3NpdGlvbiIsInZpZXdUb01vZGVsWCIsIlNPVVJDRV9QT1NJVElPTl9YIiwiaXNBdWRpb0VuYWJsZWRQcm9wZXJ0eSIsInNldFZpZXdCb3VuZHMiLCJ2aWV3Qm91bmRzIiwiYXNzZXJ0IiwiZ2V0V2F2ZUFyZWFCb3VuZHMiLCJsYXR0aWNlQm91bmRzIiwibW9kZWxCb3VuZHMiLCJ2aWV3VG9Nb2RlbEJvdW5kcyIsInRlbXBWaWV3Qm91bmRzIiwibW9kZWxUb1ZpZXdCb3VuZHMiLCJnZW5lcmF0ZVdhdmVzIiwiYW1wbGl0dWRlIiwiZ2V0IiwiZnJlcXVlbmN5IiwicGVyaW9kIiwidGltZVNpbmNlUHVsc2VTdGFydGVkIiwiaXNDb250aW51b3VzIiwic291bmRNb2RlUHJvcGVydHkiLCJ0ZW1wb3JhbE1hc2tFbXB0eSIsInNldCIsImFuZ3VsYXJGcmVxdWVuY3kiLCJkYW1waW5nQnlQcmVzc3VyZSIsInByZXNzdXJlUHJvcGVydHkiLCJ3YXZlVmFsdWUiLCJqIiwiZmxvb3IiLCJtb2RlbFRvVmlld1kiLCJ5Iiwic2V0Q3VycmVudFZhbHVlIiwic3RhcnRQdWxzZSIsInJlc2V0UGhhc2UiLCJyZXNldCIsImNsZWFyIiwiY2xlYXJXYXZlcyIsInN0ZXAiLCJkdCIsImFwcGx5VGVtcG9yYWxNYXNrIiwiaSIsIndpZHRoIiwiaGVpZ2h0IiwiZGlzdGFuY2VXaXRoaW5Cb3VuZHMiLCJtYXRjaGVzIiwic2V0QWxsb3dlZCIsInBydW5lIiwic3FydCIsIm1hbnVhbFN0ZXAiLCJjb3JyZWN0aW9uIiwic3RvcHdhdGNoIiwiaW50ZXJwb2xhdGlvblJhdGlvIiwiZ2V0UmF0aW8iLCJjaGFuZ2VkRW1pdHRlciIsImVtaXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlNvdW5kTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjItMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcbi8qKlxyXG4gKiBCYXNlIG1vZGVsIGZvciBhIHNvdW5kIHNjZW5lLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFBpZXQgR29yaXMgKFVuaXZlcnNpdHkgb2YgTGV1dmVuKVxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFJlY3RhbmdsZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmVjdGFuZ2xlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVE1vZGVsIGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1RNb2RlbC5qcyc7XHJcbmltcG9ydCBFdmVudFRpbWVyIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9FdmVudFRpbWVyLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgTGF0dGljZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvTGF0dGljZS5qcyc7XHJcbmltcG9ydCBUZW1wb3JhbE1hc2sgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL1RlbXBvcmFsTWFzay5qcyc7XHJcbmltcG9ydCBTb3VuZENvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vU291bmRDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgc291bmQgZnJvbSAnLi4vLi4vc291bmQuanMnO1xyXG5cclxuLy8gVGhpcyBzaW11bGF0aW9uIHVzZXMgRXZlbnRUaW1lciwgd2hpY2ggcHJvdmlkZXMgZXhhY3RseSB0aGUgc2FtZSBtb2RlbCBiZWhhdmlvciBvbiB2ZXJ5IHNsb3cgYW5kIHZlcnkgZmFzdFxyXG4vLyBwbGF0Zm9ybXMuICBIZXJlIHdlIGRlZmluZSB0aGUgZnJlcXVlbmN5IG9mIGV2ZW50cyBpbiBIeiwgd2hpY2ggaGFzIGJlZW4gdHVuZWQgc28gdGhhdCBvdXIgc2xvd2VzdCBwbGF0Zm9ybSBoYXNcclxuLy8gYW4gYWNjZXB0YWJsZSBmcmFtZSByYXRlXHJcbmNvbnN0IGV2ZW50VGltZXJQZXJpb2QgPSAxIC8gU291bmRDb25zdGFudHMuRVZFTlRfUkFURTtcclxuY29uc3QgZnJlcXVlbmN5UmFuZ2UgPSBuZXcgUmFuZ2UoIDAsIDEgKTtcclxuY29uc3QgSU5JVElBTF9GUkVRVUVOQ1kgPSAwLjU7XHJcblxyXG50eXBlIFNvdW5kTW9kZWxPcHRpb25zID0ge1xyXG4gIGhhc1JlZmxlY3Rpb24/OiBib29sZWFuO1xyXG4gIGhhc1NlY29uZFNvdXJjZT86IGJvb2xlYW47XHJcbiAgaW5pdGlhbEFtcGxpdHVkZT86IG51bWJlcjtcclxuICBzcGVha2VyMVBvc2l0aW9uWT86IG51bWJlcjtcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNvdW5kTW9kZWwgaW1wbGVtZW50cyBUTW9kZWwge1xyXG5cclxuICAvLyB3aGV0aGVyIGF1ZGlvIGlzIGVuYWJsZWRcclxuICBwdWJsaWMgcmVhZG9ubHkgaXNBdWRpb0VuYWJsZWRQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHVibGljIHJlYWRvbmx5IG1vZGVsVG9MYXR0aWNlVHJhbnNmb3JtOiBNb2RlbFZpZXdUcmFuc2Zvcm0yO1xyXG4gIHB1YmxpYyBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIgfCBudWxsO1xyXG5cclxuICAvLyBwb3NpdGlvbiBvZiB0aGUgbm9uLW1vdmluZyBmaXJzdCBzcGVha2VyLlxyXG4gIHB1YmxpYyByZWFkb25seSBzcGVha2VyMVBvc2l0aW9uOiBWZWN0b3IyO1xyXG5cclxuICAvLyB0aGUgdmFsdWUgb2YgdGhlIHdhdmUgYXQgdGhlIG9zY2lsbGF0aW9uIHBvaW50XHJcbiAgcHVibGljIHJlYWRvbmx5IG9zY2lsbGF0b3JQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHk7XHJcblxyXG4gIC8vIHByb3BlcnkgdGhhdCBzaG93cyB0aGF0IGEgcHVsc2UgaXMgZmlyaW5nXHJcbiAgcHVibGljIHJlYWRvbmx5IGlzUHVsc2VGaXJpbmdQcm9wZXJ0eTogQm9vbGVhblByb3BlcnR5O1xyXG5cclxuICAvLyB0aGUgZnJlcXVlbmN5IGluIHRoZSBhcHByb3ByaWF0ZSB1bml0cyBmb3IgdGhlIHNjZW5lXHJcbiAgcHVibGljIHJlYWRvbmx5IGZyZXF1ZW5jeVByb3BlcnR5OiBOdW1iZXJQcm9wZXJ0eTtcclxuXHJcbiAgLy8gY29udHJvbHMgdGhlIGFtcGxpdHVkZSBvZiB0aGUgd2F2ZS5cclxuICBwdWJsaWMgcmVhZG9ubHkgYW1wbGl0dWRlUHJvcGVydHk6IE51bWJlclByb3BlcnR5O1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgaGFzU2Vjb25kU291cmNlOiBib29sZWFuO1xyXG5cclxuICAvLyB3aGV0aGVyIHRoaXMgbW9kZWwgaGFzIGEgcmVmbGVjdGlvbiB3YWxsLlxyXG4gIHB1YmxpYyByZWFkb25seSBoYXNSZWZsZWN0aW9uOiBib29sZWFuO1xyXG5cclxuICAvLyBwcm9wZXJ5IHRoYXQgc2hvd3MgaWYgdGhlIHNpbXVsYXRpb24gaW4gcnVubmluZy5cclxuICBwdWJsaWMgcmVhZG9ubHkgaXNSdW5uaW5nUHJvcGVydHk6IEJvb2xlYW5Qcm9wZXJ0eTtcclxuXHJcbiAgLy8gIHBoYXNlIG9mIHRoZSBzb3VuZCB3YXZlLlxyXG4gIHByaXZhdGUgcGhhc2UgPSAwO1xyXG5cclxuICAvLyBudW1iZXIgb2Ygc3RlcHMgc2luY2UgbGF1bmNoIG9mIHRoZSBzaW11bGF0aW9uLlxyXG4gIHByaXZhdGUgc3RlcEluZGV4ID0gMDtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSB0ZW1wb3JhbE1hc2s6IFRlbXBvcmFsTWFzaztcclxuXHJcbiAgLy8gSW4gb3JkZXIgdG8gaGF2ZSBleGFjdGx5IHRoZSBzYW1lIG1vZGVsIGJlaGF2aW9yIG9uIHZlcnkgZmFzdCBhbmQgdmVyeSBzbG93IHBsYXRmb3Jtcywgd2UgdXNlXHJcbiAgLy8gRXZlbnRUaW1lciwgd2hpY2ggdXBkYXRlcyB0aGUgbW9kZWwgYXQgcmVndWxhciBpbnRlcnZhbHMsIGFuZCB3ZSBjYW4gaW50ZXJwb2xhdGUgYmV0d2VlbiBzdGF0ZXMgZm9yIGFkZGl0aW9uYWxcclxuICAvLyBmaWRlbGl0eS5cclxuICBwcml2YXRlIHJlYWRvbmx5IGV2ZW50VGltZXI6IEV2ZW50VGltZXI7XHJcblxyXG4gIC8vIGVsYXBzZWQgdGltZSBpbiBzZWNvbmRzXHJcbiAgcHJpdmF0ZSByZWFkb25seSB0aW1lUHJvcGVydHk6IE51bWJlclByb3BlcnR5O1xyXG5cclxuICAvLyB0aGUgZ3JpZCB0aGF0IGNvbnRhaW5zIHRoZSB3YXZlIHZhbHVlcyBvZiB0aGUgZmlyc3Qgc3BlYWtlclxyXG4gIHB1YmxpYyByZWFkb25seSBsYXR0aWNlOiBMYXR0aWNlO1xyXG4gIHByaXZhdGUgbGF0dGljZVRvVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMiB8IG51bGw7XHJcbiAgcHJpdmF0ZSBwdWxzZVN0YXJ0VGltZTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zPzogU291bmRNb2RlbE9wdGlvbnMgKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFNvdW5kTW9kZWxPcHRpb25zPigpKCB7XHJcbiAgICAgIGluaXRpYWxBbXBsaXR1ZGU6IDUsXHJcbiAgICAgIHNwZWFrZXIxUG9zaXRpb25ZOiBTb3VuZENvbnN0YW50cy5XQVZFX0FSRUFfV0lEVEggLyAyLFxyXG4gICAgICBoYXNSZWZsZWN0aW9uOiBmYWxzZSxcclxuICAgICAgaGFzU2Vjb25kU291cmNlOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5oYXNTZWNvbmRTb3VyY2UgPSBvcHRpb25zLmhhc1NlY29uZFNvdXJjZTtcclxuICAgIHRoaXMuaGFzUmVmbGVjdGlvbiA9IG9wdGlvbnMuaGFzUmVmbGVjdGlvbjtcclxuICAgIHRoaXMuaXNSdW5uaW5nUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0cnVlICk7XHJcbiAgICB0aGlzLmlzUHVsc2VGaXJpbmdQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcbiAgICB0aGlzLnBoYXNlID0gMDtcclxuICAgIHRoaXMuc3RlcEluZGV4ID0gMDtcclxuXHJcbiAgICB0aGlzLnRlbXBvcmFsTWFzayA9IG5ldyBUZW1wb3JhbE1hc2soKTtcclxuICAgIHRoaXMub3NjaWxsYXRvclByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwICk7XHJcblxyXG4gICAgY29uc3QgZXZlbnRUaW1lck1vZGVsID0ge1xyXG4gICAgICBnZXRQZXJpb2RCZWZvcmVOZXh0RXZlbnQ6ICgpID0+IGV2ZW50VGltZXJQZXJpb2RcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5ldmVudFRpbWVyID0gbmV3IEV2ZW50VGltZXIoIGV2ZW50VGltZXJNb2RlbCwgdGltZUVsYXBzZWQgPT4gdGhpcy5hZHZhbmNlVGltZSggZXZlbnRUaW1lclBlcmlvZCwgZmFsc2UgKSApO1xyXG5cclxuICAgIC8vIFdoZW4gZnJlcXVlbmN5IGNoYW5nZXMsIGNob29zZSBhIG5ldyBwaGFzZSBzdWNoIHRoYXQgdGhlIG5ldyBzaW5lIGN1cnZlIGhhcyB0aGUgc2FtZSB2YWx1ZSBhbmQgZGlyZWN0aW9uXHJcbiAgICAvLyBmb3IgY29udGludWl0eVxyXG4gICAgY29uc3QgcGhhc2VVcGRhdGUgPSAoIG5ld0ZyZXF1ZW5jeTogbnVtYmVyLCBvbGRGcmVxdWVuY3k6IG51bWJlciApID0+IHtcclxuXHJcbiAgICAgIC8vIEZvciB0aGUgbWFpbiBtb2RlbCwgTWF0aC5zaW4gaXMgcGVyZm9ybWVkIG9uIGFuZ3VsYXIgZnJlcXVlbmN5LCBzbyB0byBtYXRjaCB0aGUgcGhhc2UsIHRoYXQgY29tcHV0YXRpb25cclxuICAgICAgLy8gc2hvdWxkIGFsc28gYmUgYmFzZWQgb24gYW5ndWxhciBmcmVxdWVuY2llc1xyXG4gICAgICBjb25zdCBvbGRBbmd1bGFyRnJlcXVlbmN5ID0gb2xkRnJlcXVlbmN5ICogTWF0aC5QSSAqIDI7XHJcbiAgICAgIGNvbnN0IG5ld0FuZ3VsYXJGcmVxdWVuY3kgPSBuZXdGcmVxdWVuY3kgKiBNYXRoLlBJICogMjtcclxuICAgICAgY29uc3QgdGltZSA9IHRoaXMudGltZVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgY29uc3Qgb2xkVmFsdWUgPSBNYXRoLnNpbiggdGltZSAqIG9sZEFuZ3VsYXJGcmVxdWVuY3kgKyB0aGlzLnBoYXNlICk7XHJcbiAgICAgIGxldCBwcm9wb3NlZFBoYXNlID0gTWF0aC5hc2luKCBvbGRWYWx1ZSApIC0gdGltZSAqIG5ld0FuZ3VsYXJGcmVxdWVuY3k7XHJcbiAgICAgIGNvbnN0IG9sZERlcml2YXRpdmUgPSBNYXRoLmNvcyggdGltZSAqIG9sZEFuZ3VsYXJGcmVxdWVuY3kgKyB0aGlzLnBoYXNlICk7XHJcbiAgICAgIGNvbnN0IG5ld0Rlcml2YXRpdmUgPSBNYXRoLmNvcyggdGltZSAqIG5ld0FuZ3VsYXJGcmVxdWVuY3kgKyBwcm9wb3NlZFBoYXNlICk7XHJcblxyXG4gICAgICAvLyBJZiB3cm9uZyBwaGFzZSwgdGFrZSB0aGUgc2luIHZhbHVlIGZyb20gdGhlIG9wcG9zaXRlIHNpZGUgYW5kIG1vdmUgZm9yd2FyZCBieSBoYWxmIGEgY3ljbGVcclxuICAgICAgaWYgKCBvbGREZXJpdmF0aXZlICogbmV3RGVyaXZhdGl2ZSA8IDAgKSB7XHJcbiAgICAgICAgcHJvcG9zZWRQaGFzZSA9IE1hdGguYXNpbiggLW9sZFZhbHVlICkgLSB0aW1lICogbmV3QW5ndWxhckZyZXF1ZW5jeSArIE1hdGguUEk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMucGhhc2UgPSBwcm9wb3NlZFBoYXNlO1xyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLmZyZXF1ZW5jeVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBJTklUSUFMX0ZSRVFVRU5DWSwgeyByYW5nZTogZnJlcXVlbmN5UmFuZ2UgfSApO1xyXG4gICAgdGhpcy5mcmVxdWVuY3lQcm9wZXJ0eS5sYXp5TGluayggcGhhc2VVcGRhdGUgKTtcclxuXHJcbiAgICB0aGlzLmFtcGxpdHVkZVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBvcHRpb25zLmluaXRpYWxBbXBsaXR1ZGUsIHtcclxuICAgICAgcmFuZ2U6IFNvdW5kQ29uc3RhbnRzLkFNUExJVFVERV9SQU5HRVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudGltZVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwICk7XHJcblxyXG4gICAgdGhpcy5sYXR0aWNlID0gbmV3IExhdHRpY2UoXHJcbiAgICAgIFNvdW5kQ29uc3RhbnRzLkxBVFRJQ0VfRElNRU5TSU9OLFxyXG4gICAgICBTb3VuZENvbnN0YW50cy5MQVRUSUNFX0RJTUVOU0lPTixcclxuICAgICAgU291bmRDb25zdGFudHMuTEFUVElDRV9QQURESU5HLFxyXG4gICAgICBTb3VuZENvbnN0YW50cy5MQVRUSUNFX1BBRERJTkdcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5tb2RlbFRvTGF0dGljZVRyYW5zZm9ybSA9IE1vZGVsVmlld1RyYW5zZm9ybTIuY3JlYXRlUmVjdGFuZ2xlTWFwcGluZyhcclxuICAgICAgbmV3IFJlY3RhbmdsZSggMCwgMCwgU291bmRDb25zdGFudHMuV0FWRV9BUkVBX1dJRFRILCBTb3VuZENvbnN0YW50cy5XQVZFX0FSRUFfV0lEVEggKSxcclxuICAgICAgdGhpcy5sYXR0aWNlLnZpc2libGVCb3VuZHNcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBudWxsO1xyXG4gICAgdGhpcy5sYXR0aWNlVG9WaWV3VHJhbnNmb3JtID0gbnVsbDtcclxuXHJcbiAgICB0aGlzLnNwZWFrZXIxUG9zaXRpb24gPSBuZXcgVmVjdG9yMiggdGhpcy5tb2RlbFRvTGF0dGljZVRyYW5zZm9ybS52aWV3VG9Nb2RlbFgoIFNvdW5kQ29uc3RhbnRzLlNPVVJDRV9QT1NJVElPTl9YICksIG9wdGlvbnMuc3BlYWtlcjFQb3NpdGlvblkgKTtcclxuXHJcbiAgICB0aGlzLmlzQXVkaW9FbmFibGVkUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBmYWxzZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWZ0ZXIgdGhlIHZpZXcgaXMgaW5pdGlhbGl6ZWQsIGRldGVybWluZSB0aGUgY29vcmRpbmF0ZSB0cmFuc2Zvcm1hdGlvbnMgdGhhdCBtYXAgdG8gdmlldyBjb29yZGluYXRlcy5cclxuICAgKi9cclxuICBwdWJsaWMgc2V0Vmlld0JvdW5kcyggdmlld0JvdW5kczogQm91bmRzMiApOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtID09PSBudWxsLCAnc2V0Vmlld0JvdW5kcyBjYW5ub3QgYmUgY2FsbGVkIHR3aWNlJyApO1xyXG5cclxuICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtID0gTW9kZWxWaWV3VHJhbnNmb3JtMi5jcmVhdGVSZWN0YW5nbGVNYXBwaW5nKFxyXG4gICAgICB0aGlzLmdldFdhdmVBcmVhQm91bmRzKCksXHJcbiAgICAgIHZpZXdCb3VuZHNcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgbGF0dGljZUJvdW5kcyA9IG5ldyBCb3VuZHMyKCAwLCAwLCAxLCAxICk7XHJcbiAgICBjb25zdCBtb2RlbEJvdW5kcyA9IHRoaXMubW9kZWxUb0xhdHRpY2VUcmFuc2Zvcm0udmlld1RvTW9kZWxCb3VuZHMoIGxhdHRpY2VCb3VuZHMgKTtcclxuICAgIGNvbnN0IHRlbXBWaWV3Qm91bmRzID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdCb3VuZHMoIG1vZGVsQm91bmRzICk7XHJcblxyXG4gICAgdGhpcy5sYXR0aWNlVG9WaWV3VHJhbnNmb3JtID0gTW9kZWxWaWV3VHJhbnNmb3JtMi5jcmVhdGVSZWN0YW5nbGVNYXBwaW5nKCBsYXR0aWNlQm91bmRzLCB0ZW1wVmlld0JvdW5kcyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIEJvdW5kczIgZm9yIHRoZSB2aXNpYmxlIHBhcnQgb2YgdGhlIHdhdmUgYXJlYSwgaW4gdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBzY2VuZS5cclxuICAgKiBAcmV0dXJucyAtIHRoZSBsYXR0aWNlIG1vZGVsIGJvdW5kcywgaW4gdGhlIGNvb3JkaW5hdGVzIG9mIHRoaXMgc2NlbmUuXHJcbiAgICovXHJcbiAgcHVibGljIGdldFdhdmVBcmVhQm91bmRzKCk6IEJvdW5kczIge1xyXG4gICAgcmV0dXJuIG5ldyBCb3VuZHMyKCAwLCAwLCBTb3VuZENvbnN0YW50cy5XQVZFX0FSRUFfV0lEVEgsIFNvdW5kQ29uc3RhbnRzLldBVkVfQVJFQV9XSURUSCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2VuZXJhdGUgYSB3YXZlIGZyb20gdGhlIHBvaW50IHNvdXJjZXNcclxuICAgKi9cclxuICBwcml2YXRlIGdlbmVyYXRlV2F2ZXMoKTogdm9pZCB7XHJcbiAgICBjb25zdCBhbXBsaXR1ZGUgPSB0aGlzLmFtcGxpdHVkZVByb3BlcnR5LmdldCgpO1xyXG4gICAgY29uc3QgdGltZSA9IHRoaXMudGltZVByb3BlcnR5LmdldCgpO1xyXG4gICAgY29uc3QgZnJlcXVlbmN5ID0gdGhpcy5mcmVxdWVuY3lQcm9wZXJ0eS5nZXQoKTtcclxuICAgIGNvbnN0IHBlcmlvZCA9IDEgLyBmcmVxdWVuY3k7XHJcbiAgICBjb25zdCB0aW1lU2luY2VQdWxzZVN0YXJ0ZWQgPSB0aW1lIC0gdGhpcy5wdWxzZVN0YXJ0VGltZSE7XHJcblxyXG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvclxyXG4gICAgY29uc3QgaXNDb250aW51b3VzID0gKCAhdGhpcy5zb3VuZE1vZGVQcm9wZXJ0eSB8fCB0aGlzLnNvdW5kTW9kZVByb3BlcnR5LmdldCgpID09PSAnQ09OVElOVU9VUycgKTtcclxuXHJcbiAgICAvLyBVc2VkIHRvIGNvbXB1dGUgd2hldGhlciBhIGRlbHRhIGFwcGVhcnMgaW4gZWl0aGVyIG1hc2tcclxuICAgIGxldCB0ZW1wb3JhbE1hc2tFbXB0eSA9IHRydWU7XHJcblxyXG4gICAgLy8gSWYgdGhlIHB1bHNlIGlzIHJ1bm5pbmcsIGVuZCB0aGUgcHVsc2UgYWZ0ZXIgb25lIHBlcmlvZFxyXG4gICAgaWYgKCB0aGlzLmlzUHVsc2VGaXJpbmdQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgY29uc3QgdGltZVNpbmNlUHVsc2VTdGFydGVkID0gdGhpcy50aW1lUHJvcGVydHkudmFsdWUgLSB0aGlzLnB1bHNlU3RhcnRUaW1lITtcclxuXHJcbiAgICAgIGlmICggdGltZVNpbmNlUHVsc2VTdGFydGVkID4gcGVyaW9kICkge1xyXG4gICAgICAgIHRoaXMuaXNQdWxzZUZpcmluZ1Byb3BlcnR5LnNldCggZmFsc2UgKTtcclxuICAgICAgICB0aGlzLnB1bHNlU3RhcnRUaW1lID0gMDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICggaXNDb250aW51b3VzIHx8IHRoaXMuaXNQdWxzZUZpcmluZ1Byb3BlcnR5LmdldCgpICkge1xyXG5cclxuICAgICAgLy8gVGhlIHNpbXVsYXRpb24gaXMgZGVzaWduZWQgdG8gc3RhcnQgd2l0aCBhIGRvd253YXJkIHdhdmUsIGNvcnJlc3BvbmRpbmcgdG8gd2F0ZXIgc3BsYXNoaW5nIGluXHJcbiAgICAgIGNvbnN0IGFuZ3VsYXJGcmVxdWVuY3kgPSBNYXRoLlBJICogMiAqIGZyZXF1ZW5jeTtcclxuXHJcbiAgICAgIC8vIFZhbHVlIHRvIGJlIG11bHRpcGxpZWQgd2l0aCB0aGUgZmluYWwgd2F2ZSB2YWx1ZS5cclxuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxyXG4gICAgICBjb25zdCBkYW1waW5nQnlQcmVzc3VyZSA9IHRoaXMucHJlc3N1cmVQcm9wZXJ0eSA/IHRoaXMucHJlc3N1cmVQcm9wZXJ0eS52YWx1ZSA6IDE7XHJcblxyXG4gICAgICAvLyBDb21wdXRlIHRoZSB3YXZlIHZhbHVlIGFzIGEgZnVuY3Rpb24gb2YgdGltZSwgb3Igc2V0IHRvIHplcm8gaWYgbm8gbG9uZ2VyIGdlbmVyYXRpbmcgYSB3YXZlLlxyXG4gICAgICBjb25zdCB3YXZlVmFsdWUgPSAoIHRoaXMuaXNQdWxzZUZpcmluZ1Byb3BlcnR5LmdldCgpICYmIHRpbWVTaW5jZVB1bHNlU3RhcnRlZCA+IHBlcmlvZCApID8gMCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC1NYXRoLnNpbiggdGltZSAqIGFuZ3VsYXJGcmVxdWVuY3kgKyB0aGlzLnBoYXNlICkgKiBhbXBsaXR1ZGUgKlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAxLjIgKiBkYW1waW5nQnlQcmVzc3VyZTtcclxuXHJcbiAgICAgIC8vIFBvaW50IHNvdXJjZVxyXG4gICAgICBpZiAoIGlzQ29udGludW91cyB8fCB0aGlzLmlzUHVsc2VGaXJpbmdQcm9wZXJ0eS5nZXQoKSApIHtcclxuXHJcbiAgICAgICAgY29uc3QgaiA9IE1hdGguZmxvb3IoIHRoaXMubW9kZWxUb0xhdHRpY2VUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCB0aGlzLnNwZWFrZXIxUG9zaXRpb24ueSApICk7XHJcbiAgICAgICAgdGhpcy5sYXR0aWNlLnNldEN1cnJlbnRWYWx1ZSggU291bmRDb25zdGFudHMuU09VUkNFX1BPU0lUSU9OX1gsIGosIHdhdmVWYWx1ZSApO1xyXG4gICAgICAgIHRoaXMub3NjaWxsYXRvclByb3BlcnR5LnZhbHVlID0gd2F2ZVZhbHVlO1xyXG4gICAgICAgIGlmICggYW1wbGl0dWRlID4gMCAmJiBmcmVxdWVuY3kgPiAwICkge1xyXG4gICAgICAgICAgdGhpcy50ZW1wb3JhbE1hc2suc2V0KCB0cnVlLCB0aGlzLnN0ZXBJbmRleCwgaiApO1xyXG4gICAgICAgICAgdGVtcG9yYWxNYXNrRW1wdHkgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0ZW1wb3JhbE1hc2tFbXB0eSAmJiB0aGlzLnRlbXBvcmFsTWFzay5zZXQoIGZhbHNlLCB0aGlzLnN0ZXBJbmRleCwgMCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIHVzZXIgaGFzIGluaXRpYXRlZCBhIHNpbmdsZSBwdWxzZS5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhcnRQdWxzZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLmlzUHVsc2VGaXJpbmdQcm9wZXJ0eS52YWx1ZSwgJ0Nhbm5vdCBmaXJlIGEgcHVsc2Ugd2hpbGUgYSBwdWxzZSBpcyBhbHJlYWR5IGJlaW5nIGZpcmVkJyApO1xyXG4gICAgdGhpcy5yZXNldFBoYXNlKCk7XHJcbiAgICB0aGlzLmlzUHVsc2VGaXJpbmdQcm9wZXJ0eS52YWx1ZSA9IHRydWU7XHJcbiAgICB0aGlzLnB1bHNlU3RhcnRUaW1lID0gdGhpcy50aW1lUHJvcGVydHkudmFsdWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGFydCB0aGUgc2luZSBhcmd1bWVudCBhdCAwIHNvIGl0IHdpbGwgc21vb3RobHkgZm9ybSB0aGUgZmlyc3Qgd2F2ZS5cclxuICAgKi9cclxuICBwcml2YXRlIHJlc2V0UGhhc2UoKTogdm9pZCB7XHJcbiAgICBjb25zdCBmcmVxdWVuY3kgPSB0aGlzLmZyZXF1ZW5jeVByb3BlcnR5LmdldCgpO1xyXG4gICAgY29uc3QgYW5ndWxhckZyZXF1ZW5jeSA9IE1hdGguUEkgKiAyICogZnJlcXVlbmN5O1xyXG5cclxuICAgIC8vIFNvbHZlIGZvciB0aGUgc2luIGFyZyA9IDAgaW4gTWF0aC5zaW4oIHRoaXMudGltZSAqIGFuZ3VsYXJGcmVxdWVuY3kgKyB0aGlzLnBoYXNlIClcclxuICAgIHRoaXMucGhhc2UgPSAtdGhpcy50aW1lUHJvcGVydHkudmFsdWUgKiBhbmd1bGFyRnJlcXVlbmN5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIHRoZSBtb2RlbC5cclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmlzQXVkaW9FbmFibGVkUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuaXNSdW5uaW5nUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMudGltZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmZyZXF1ZW5jeVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmFtcGxpdHVkZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLnRpbWVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5vc2NpbGxhdG9yUHJvcGVydHkucmVzZXQoKTtcclxuXHJcbiAgICB0aGlzLnBoYXNlID0gMDtcclxuICAgIHRoaXMuc3RlcEluZGV4ID0gMDtcclxuICAgIHRoaXMubGF0dGljZS5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXJzIHRoZSB3YXZlcyBmcm9tIHRoZSBzY3JlZW4uXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyV2F2ZXMoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxhdHRpY2UuY2xlYXIoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0ZXBzIHRoZSBtb2RlbC5cclxuICAgKiBAcGFyYW0gZHQgLSB0aW1lIHN0ZXAsIGluIHNlY29uZHNcclxuICAgKi9cclxuICBwdWJsaWMgc3RlcCggZHQ6IG51bWJlciApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBGZWVkIHRoZSByZWFsIHRpbWUgdG8gdGhlIGV2ZW50VGltZXIgYW5kIGl0IHdpbGwgdHJpZ2dlciBhZHZhbmNlVGltZSBhdCB0aGUgYXBwcm9wcmlhdGUgcmF0ZVxyXG4gICAgdGhpcy5ldmVudFRpbWVyLnN0ZXAoIGR0ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBCeSByZWNvcmRpbmcgdGhlIHRpbWVzIGFuZCBwb3NpdGlvbnMgb2YgdGhlIHdhdmUgZGlzdHVyYmFuY2VzLCBhbmQga25vd2luZyB0aGUgd2F2ZSBwcm9wYWdhdGlvbiBzcGVlZCxcclxuICAgKiB3ZSBjYW4gYXBwbHkgYSBtYXNraW5nIGZ1bmN0aW9uIGFjcm9zcyB0aGUgd2F2ZSBhcmVhLCB6ZXJvaW5nIG91dCBhbnkgY2VsbCB0aGF0IGNvdWxkIG5vdGUgaGF2ZSBiZWVuIGdlbmVyYXRlZFxyXG4gICAqIGZyb20gdGhlIHNvdXJjZSBkaXN0dXJiYW5jZS4gIFRoaXMgZmlsdGVycyBvdXQgc3B1cmlvdXMgbm9pc2UgYW5kIHJlc3RvcmVzIFwiYmxhY2tcIiBmb3IgdGhlIGxpZ2h0IHNjZW5lLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwbHlUZW1wb3JhbE1hc2soKTogdm9pZCB7XHJcblxyXG4gICAgLy8gemVybyBvdXQgdmFsdWVzIHRoYXQgYXJlIG91dHNpZGUgb2YgdGhlIG1hc2tcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMubGF0dGljZS53aWR0aDsgaSsrICkge1xyXG4gICAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLmxhdHRpY2UuaGVpZ2h0OyBqKysgKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IGRpc3RhbmNlV2l0aGluQm91bmRzID0gdGhpcy50ZW1wb3JhbE1hc2subWF0Y2hlcyggU291bmRDb25zdGFudHMuU09VUkNFX1BPU0lUSU9OX1gsIGksIGosIHRoaXMuc3RlcEluZGV4ICkgPj0gMDtcclxuXHJcbiAgICAgICAgdGhpcy5sYXR0aWNlLnNldEFsbG93ZWQoIGksIGosIGRpc3RhbmNlV2l0aGluQm91bmRzICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBQcnVuZSBlbnRyaWVzLiAgRWxlbWVudHMgdGhhdCBhcmUgdG9vIGZhciBvdXQgb2YgcmFuZ2UgYXJlIGVsaW1pbmF0ZWQuICBVc2UgdGhlIGRpYWdvbmFsIG9mIHRoZSBsYXR0aWNlIGZvciB0aGVcclxuICAgIC8vIG1heCBkaXN0YW5jZVxyXG4gICAgdGhpcy50ZW1wb3JhbE1hc2sucHJ1bmUoIE1hdGguc3FydCggMiApICogdGhpcy5sYXR0aWNlLndpZHRoLCB0aGlzLnN0ZXBJbmRleCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkaXRpb25hbGx5IGNhbGxlZCBmcm9tIHRoZSBcInN0ZXBcIiBidXR0b25cclxuICAgKiBAcGFyYW0gZHQgLSBhbW91bnQgb2YgdGltZSB0aGF0IHBhc3NlZFxyXG4gICAqIEBwYXJhbSBtYW51YWxTdGVwIC0gdHJ1ZSBpZiB0aGUgc3RlcCBidXR0b24gaXMgYmVpbmcgcHJlc3NlZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZHZhbmNlVGltZSggZHQ6IG51bWJlciwgbWFudWFsU3RlcDogYm9vbGVhbiApOiB2b2lkIHtcclxuICAgIGlmICggdGhpcy5pc1J1bm5pbmdQcm9wZXJ0eS5nZXQoKSB8fCBtYW51YWxTdGVwICkge1xyXG4gICAgICAvLyBDb3JyZWN0aW9uIGNvbnN0YW50IHRha2VuIGZyb20gd2F2ZS1pbnRlcmZlcmVuY2VcclxuICAgICAgY29uc3QgY29ycmVjdGlvbiA9IDIuNDE4Nzg0NzExNjA5MTMzNCAqIFNvdW5kQ29uc3RhbnRzLldBVkVfQVJFQV9XSURUSCAvIDUwMDtcclxuXHJcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3JcclxuICAgICAgaWYgKCB0aGlzLnN0b3B3YXRjaCApIHtcclxuXHJcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvclxyXG4gICAgICAgIHRoaXMuc3RvcHdhdGNoLnN0ZXAoIGR0ICogY29ycmVjdGlvbiApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmxhdHRpY2UuaW50ZXJwb2xhdGlvblJhdGlvID0gdGhpcy5ldmVudFRpbWVyLmdldFJhdGlvKCk7XHJcblxyXG4gICAgICB0aGlzLnRpbWVQcm9wZXJ0eS52YWx1ZSArPSBkdCAqIGNvcnJlY3Rpb247XHJcblxyXG4gICAgICAvLyBVcGRhdGUgdGhlIGxhdHRpY2VcclxuICAgICAgdGhpcy5sYXR0aWNlLnN0ZXAoKTtcclxuXHJcbiAgICAgIC8vIEFwcGx5IHZhbHVlcyBvbiB0b3Agb2YgdGhlIGNvbXB1dGVkIGxhdHRpY2UgdmFsdWVzIHNvIHRoZXJlIGlzIG5vIG5vaXNlIGF0IHRoZSBwb2ludCBzb3VyY2VzXHJcbiAgICAgIHRoaXMuZ2VuZXJhdGVXYXZlcygpO1xyXG5cclxuICAgICAgdGhpcy5hcHBseVRlbXBvcmFsTWFzaygpO1xyXG5cclxuICAgICAgLy8gTm90aWZ5IGxpc3RlbmVycyBhYm91dCBjaGFuZ2VzXHJcbiAgICAgIHRoaXMubGF0dGljZS5jaGFuZ2VkRW1pdHRlci5lbWl0KCk7XHJcblxyXG4gICAgICB0aGlzLnN0ZXBJbmRleCsrO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuc291bmQucmVnaXN0ZXIoICdTb3VuZE1vZGVsJywgU291bmRNb2RlbCApOyJdLCJtYXBw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