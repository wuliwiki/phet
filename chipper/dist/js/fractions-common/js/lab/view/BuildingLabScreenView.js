// Copyright 2018-2022, University of Colorado Boulder

/**
 * ScreenView for the "Lab" screen of Build a Fraction
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Matrix3 from '../../../../dot/js/Matrix3.js';
import ScreenView from '../../../../joist/js/ScreenView.js';
import Fraction from '../../../../phetcommon/js/model/Fraction.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import ResetAllButton from '../../../../scenery-phet/js/buttons/ResetAllButton.js';
import { AlignBox, HBox } from '../../../../scenery/js/imports.js';
import BuildingRepresentation from '../../building/model/BuildingRepresentation.js';
import NumberGroup from '../../building/model/NumberGroup.js';
import NumberGroupStack from '../../building/model/NumberGroupStack.js';
import NumberPiece from '../../building/model/NumberPiece.js';
import NumberStack from '../../building/model/NumberStack.js';
import ShapeGroup from '../../building/model/ShapeGroup.js';
import ShapeGroupStack from '../../building/model/ShapeGroupStack.js';
import ShapePiece from '../../building/model/ShapePiece.js';
import ShapeStack from '../../building/model/ShapeStack.js';
import NumberGroupNode from '../../building/view/NumberGroupNode.js';
import ShapeGroupNode from '../../building/view/ShapeGroupNode.js';
import FractionsCommonConstants from '../../common/FractionsCommonConstants.js';
import FractionsCommonGlobals from '../../common/FractionsCommonGlobals.js';
import FractionsCommonColors from '../../common/view/FractionsCommonColors.js';
import fractionsCommon from '../../fractionsCommon.js';
import BuildingLabLayerNode from './BuildingLabLayerNode.js';
import LabNumberPanel from './LabNumberPanel.js';
import LabShapePanel from './LabShapePanel.js';

// constants
const PANEL_MARGIN = FractionsCommonConstants.PANEL_MARGIN;
class BuildingLabScreenView extends ScreenView {
  /**
   * @param {BuildingLabModel} model
   */
  constructor(model) {
    super();

    // @private
    this.model = model;

    // @public {ModelViewTransform2}
    this.modelViewTransform = new ModelViewTransform2(Matrix3.translationFromVector(this.layoutBounds.center));

    // @private {Property.<Bounds2>}
    this.shapeDragBoundsProperty = new Property(this.visibleBounds);
    this.numberDragBoundsProperty = new Property(this.visibleBounds);

    // @private {Node}
    this.shapePanel = new LabShapePanel(model, (event, stack) => {
      const modelPoint = this.modelViewTransform.viewToModelPosition(this.globalToLocalPoint(event.pointer.point));
      if (stack instanceof ShapeStack) {
        const shapePiece = new ShapePiece(stack.fraction, stack.representation, stack.color);
        shapePiece.positionProperty.value = modelPoint;
        model.dragShapePieceFromStack(shapePiece);
        const shapePieceNode = this.layerNode.getShapePieceNode(shapePiece);
        shapePieceNode.dragListener.press(event, shapePieceNode);
      } else if (stack instanceof ShapeGroupStack) {
        const shapeGroup = model.addShapeGroup(stack.representation);
        shapeGroup.positionProperty.value = modelPoint;
        const shapeGroupNode = this.layerNode.getShapeGroupNode(shapeGroup);
        shapeGroupNode.dragListener.press(event, shapeGroupNode);
      } else {
        throw new Error('unknown stack type');
      }
    });

    // @private {Node}
    this.numberPanel = new LabNumberPanel(model, (event, stack) => {
      const modelPoint = this.modelViewTransform.viewToModelPosition(this.globalToLocalPoint(event.pointer.point));
      if (stack instanceof NumberStack) {
        const numberPiece = new NumberPiece(stack.number);
        numberPiece.positionProperty.value = modelPoint;
        model.dragNumberPieceFromStack(numberPiece);
        const numberPieceNode = this.layerNode.getNumberPieceNode(numberPiece);
        numberPieceNode.dragListener.press(event, numberPieceNode);
      } else if (stack instanceof NumberGroupStack) {
        const numberGroup = model.addNumberGroup(stack.isMixedNumber);
        numberGroup.positionProperty.value = modelPoint;
        const numberGroupNode = this.layerNode.getNumberGroupNode(numberGroup);
        numberGroupNode.dragListener.press(event, numberGroupNode);
      } else {
        throw new Error('unknown stack type');
      }
    });
    phet.joist.display.addInputListener({
      down: event => {
        const screen = phet.joist.sim.selectedScreenProperty.value;
        if (screen && screen.view === this) {
          const isActive = this.layerNode.activePointerProperty.value === event.pointer;

          // See if our press was a "miss" (trail length 1) or a hit on our screen (screen.view in the trail).
          // We really want to exclude home-screen clicks so that things start focused.
          const doesTrailMatch = _.includes(event.trail.nodes, screen.view) || event.trail.length <= 1;
          if (!isActive && doesTrailMatch) {
            // Any event on a shape group should handle it.
            model.selectedGroupProperty.value = null;
          }
        }
      }
    });

    // @private {Node}
    const resetAllButton = new ResetAllButton({
      listener: () => {
        this.interruptSubtreeInput();
        model.reset();
      }
    });
    const topAlignBox = new AlignBox(this.shapePanel, {
      xAlign: 'center',
      yAlign: 'top',
      margin: PANEL_MARGIN
    });
    const bottomAlignBox = new AlignBox(this.numberPanel, {
      xAlign: 'center',
      yAlign: 'bottom',
      margin: PANEL_MARGIN
    });
    const bottomRightAlignBox = new AlignBox(resetAllButton, {
      xAlign: 'right',
      yAlign: 'bottom',
      margin: PANEL_MARGIN
    });

    // dynamic layout
    this.visibleBoundsProperty.link(visibleBounds => {
      topAlignBox.alignBounds = visibleBounds;
      bottomAlignBox.alignBounds = visibleBounds;
      // Don't compensate for the right side expanding out, see https://github.com/phetsims/fractions-common/issues/51
      bottomRightAlignBox.alignBounds = visibleBounds.withMaxX(this.layoutBounds.right);
      this.shapePanel.updateModelPositions(this.modelViewTransform);
      this.numberPanel.updateModelPositions(this.modelViewTransform);
      this.shapeDragBoundsProperty.value = this.modelViewTransform.viewToModelBounds(new Bounds2(visibleBounds.left, visibleBounds.top, visibleBounds.right, this.numberPanel.top));
      this.numberDragBoundsProperty.value = this.modelViewTransform.viewToModelBounds(new Bounds2(visibleBounds.left, this.shapePanel.bottom, visibleBounds.right, visibleBounds.bottom));
    });

    // @private {BuildingLabLayerNode}
    this.layerNode = new BuildingLabLayerNode(model, this.modelViewTransform, this.shapeDragBoundsProperty, this.numberDragBoundsProperty, this.shapePanel, this.numberPanel);
    this.children = [bottomRightAlignBox, topAlignBox, bottomAlignBox, this.layerNode];
  }

  /**
   * Creates the icon for the unmixed lab screens.
   * @public
   *
   * @returns {Node}
   */
  static createUnmixedScreenIcon() {
    const numberGroup = new NumberGroup(false);
    numberGroup.numeratorSpot.pieceProperty.value = new NumberPiece(7);
    numberGroup.denominatorSpot.pieceProperty.value = new NumberPiece(8);
    const numberGroupNode = new NumberGroupNode(numberGroup, {
      isIcon: true,
      positioned: false,
      scale: 0.8
    });
    const shapeGroup = new ShapeGroup(BuildingRepresentation.PIE);
    [new Fraction(1, 2), new Fraction(1, 4), new Fraction(1, 8)].forEach(fraction => {
      shapeGroup.shapeContainers.get(0).shapePieces.push(new ShapePiece(fraction, BuildingRepresentation.PIE, FractionsCommonColors.shapeRedProperty));
    });
    const shapeGroupNode = new ShapeGroupNode(shapeGroup, {
      hasButtons: false,
      isIcon: true,
      positioned: false
    });
    return FractionsCommonGlobals.wrapIcon(new HBox({
      spacing: 20,
      children: [numberGroupNode, shapeGroupNode],
      scale: 2.3
    }), FractionsCommonColors.otherScreenBackgroundProperty);
  }

  /**
   * Creates the icon for the mixed lab screens.
   * @public
   *
   * @returns {Node}
   */
  static createMixedScreenIcon() {
    const shapeGroup = new ShapeGroup(BuildingRepresentation.PIE);
    shapeGroup.increaseContainerCount();
    shapeGroup.shapeContainers.get(0).shapePieces.push(new ShapePiece(Fraction.ONE, BuildingRepresentation.PIE, FractionsCommonColors.shapeRedProperty));
    [new Fraction(1, 2), new Fraction(1, 4), new Fraction(1, 8)].forEach(fraction => {
      shapeGroup.shapeContainers.get(1).shapePieces.push(new ShapePiece(fraction, BuildingRepresentation.PIE, FractionsCommonColors.shapeRedProperty));
    });
    const shapeGroupNode = new ShapeGroupNode(shapeGroup, {
      hasButtons: false,
      isIcon: true,
      positioned: false,
      scale: 2.1
    });
    return FractionsCommonGlobals.wrapIcon(shapeGroupNode, FractionsCommonColors.otherScreenBackgroundProperty);
  }
}
fractionsCommon.register('BuildingLabScreenView', BuildingLabScreenView);
export default BuildingLabScreenView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkJvdW5kczIiLCJNYXRyaXgzIiwiU2NyZWVuVmlldyIsIkZyYWN0aW9uIiwiTW9kZWxWaWV3VHJhbnNmb3JtMiIsIlJlc2V0QWxsQnV0dG9uIiwiQWxpZ25Cb3giLCJIQm94IiwiQnVpbGRpbmdSZXByZXNlbnRhdGlvbiIsIk51bWJlckdyb3VwIiwiTnVtYmVyR3JvdXBTdGFjayIsIk51bWJlclBpZWNlIiwiTnVtYmVyU3RhY2siLCJTaGFwZUdyb3VwIiwiU2hhcGVHcm91cFN0YWNrIiwiU2hhcGVQaWVjZSIsIlNoYXBlU3RhY2siLCJOdW1iZXJHcm91cE5vZGUiLCJTaGFwZUdyb3VwTm9kZSIsIkZyYWN0aW9uc0NvbW1vbkNvbnN0YW50cyIsIkZyYWN0aW9uc0NvbW1vbkdsb2JhbHMiLCJGcmFjdGlvbnNDb21tb25Db2xvcnMiLCJmcmFjdGlvbnNDb21tb24iLCJCdWlsZGluZ0xhYkxheWVyTm9kZSIsIkxhYk51bWJlclBhbmVsIiwiTGFiU2hhcGVQYW5lbCIsIlBBTkVMX01BUkdJTiIsIkJ1aWxkaW5nTGFiU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJ0cmFuc2xhdGlvbkZyb21WZWN0b3IiLCJsYXlvdXRCb3VuZHMiLCJjZW50ZXIiLCJzaGFwZURyYWdCb3VuZHNQcm9wZXJ0eSIsInZpc2libGVCb3VuZHMiLCJudW1iZXJEcmFnQm91bmRzUHJvcGVydHkiLCJzaGFwZVBhbmVsIiwiZXZlbnQiLCJzdGFjayIsIm1vZGVsUG9pbnQiLCJ2aWV3VG9Nb2RlbFBvc2l0aW9uIiwiZ2xvYmFsVG9Mb2NhbFBvaW50IiwicG9pbnRlciIsInBvaW50Iiwic2hhcGVQaWVjZSIsImZyYWN0aW9uIiwicmVwcmVzZW50YXRpb24iLCJjb2xvciIsInBvc2l0aW9uUHJvcGVydHkiLCJ2YWx1ZSIsImRyYWdTaGFwZVBpZWNlRnJvbVN0YWNrIiwic2hhcGVQaWVjZU5vZGUiLCJsYXllck5vZGUiLCJnZXRTaGFwZVBpZWNlTm9kZSIsImRyYWdMaXN0ZW5lciIsInByZXNzIiwic2hhcGVHcm91cCIsImFkZFNoYXBlR3JvdXAiLCJzaGFwZUdyb3VwTm9kZSIsImdldFNoYXBlR3JvdXBOb2RlIiwiRXJyb3IiLCJudW1iZXJQYW5lbCIsIm51bWJlclBpZWNlIiwibnVtYmVyIiwiZHJhZ051bWJlclBpZWNlRnJvbVN0YWNrIiwibnVtYmVyUGllY2VOb2RlIiwiZ2V0TnVtYmVyUGllY2VOb2RlIiwibnVtYmVyR3JvdXAiLCJhZGROdW1iZXJHcm91cCIsImlzTWl4ZWROdW1iZXIiLCJudW1iZXJHcm91cE5vZGUiLCJnZXROdW1iZXJHcm91cE5vZGUiLCJwaGV0Iiwiam9pc3QiLCJkaXNwbGF5IiwiYWRkSW5wdXRMaXN0ZW5lciIsImRvd24iLCJzY3JlZW4iLCJzaW0iLCJzZWxlY3RlZFNjcmVlblByb3BlcnR5IiwidmlldyIsImlzQWN0aXZlIiwiYWN0aXZlUG9pbnRlclByb3BlcnR5IiwiZG9lc1RyYWlsTWF0Y2giLCJfIiwiaW5jbHVkZXMiLCJ0cmFpbCIsIm5vZGVzIiwibGVuZ3RoIiwic2VsZWN0ZWRHcm91cFByb3BlcnR5IiwicmVzZXRBbGxCdXR0b24iLCJsaXN0ZW5lciIsImludGVycnVwdFN1YnRyZWVJbnB1dCIsInJlc2V0IiwidG9wQWxpZ25Cb3giLCJ4QWxpZ24iLCJ5QWxpZ24iLCJtYXJnaW4iLCJib3R0b21BbGlnbkJveCIsImJvdHRvbVJpZ2h0QWxpZ25Cb3giLCJ2aXNpYmxlQm91bmRzUHJvcGVydHkiLCJsaW5rIiwiYWxpZ25Cb3VuZHMiLCJ3aXRoTWF4WCIsInJpZ2h0IiwidXBkYXRlTW9kZWxQb3NpdGlvbnMiLCJ2aWV3VG9Nb2RlbEJvdW5kcyIsImxlZnQiLCJ0b3AiLCJib3R0b20iLCJjaGlsZHJlbiIsImNyZWF0ZVVubWl4ZWRTY3JlZW5JY29uIiwibnVtZXJhdG9yU3BvdCIsInBpZWNlUHJvcGVydHkiLCJkZW5vbWluYXRvclNwb3QiLCJpc0ljb24iLCJwb3NpdGlvbmVkIiwic2NhbGUiLCJQSUUiLCJmb3JFYWNoIiwic2hhcGVDb250YWluZXJzIiwiZ2V0Iiwic2hhcGVQaWVjZXMiLCJwdXNoIiwic2hhcGVSZWRQcm9wZXJ0eSIsImhhc0J1dHRvbnMiLCJ3cmFwSWNvbiIsInNwYWNpbmciLCJvdGhlclNjcmVlbkJhY2tncm91bmRQcm9wZXJ0eSIsImNyZWF0ZU1peGVkU2NyZWVuSWNvbiIsImluY3JlYXNlQ29udGFpbmVyQ291bnQiLCJPTkUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJ1aWxkaW5nTGFiU2NyZWVuVmlldy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTY3JlZW5WaWV3IGZvciB0aGUgXCJMYWJcIiBzY3JlZW4gb2YgQnVpbGQgYSBGcmFjdGlvblxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQm91bmRzMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvQm91bmRzMi5qcyc7XHJcbmltcG9ydCBNYXRyaXgzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9NYXRyaXgzLmpzJztcclxuaW1wb3J0IFNjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvU2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCBGcmFjdGlvbiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL21vZGVsL0ZyYWN0aW9uLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgUmVzZXRBbGxCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvUmVzZXRBbGxCdXR0b24uanMnO1xyXG5pbXBvcnQgeyBBbGlnbkJveCwgSEJveCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uIGZyb20gJy4uLy4uL2J1aWxkaW5nL21vZGVsL0J1aWxkaW5nUmVwcmVzZW50YXRpb24uanMnO1xyXG5pbXBvcnQgTnVtYmVyR3JvdXAgZnJvbSAnLi4vLi4vYnVpbGRpbmcvbW9kZWwvTnVtYmVyR3JvdXAuanMnO1xyXG5pbXBvcnQgTnVtYmVyR3JvdXBTdGFjayBmcm9tICcuLi8uLi9idWlsZGluZy9tb2RlbC9OdW1iZXJHcm91cFN0YWNrLmpzJztcclxuaW1wb3J0IE51bWJlclBpZWNlIGZyb20gJy4uLy4uL2J1aWxkaW5nL21vZGVsL051bWJlclBpZWNlLmpzJztcclxuaW1wb3J0IE51bWJlclN0YWNrIGZyb20gJy4uLy4uL2J1aWxkaW5nL21vZGVsL051bWJlclN0YWNrLmpzJztcclxuaW1wb3J0IFNoYXBlR3JvdXAgZnJvbSAnLi4vLi4vYnVpbGRpbmcvbW9kZWwvU2hhcGVHcm91cC5qcyc7XHJcbmltcG9ydCBTaGFwZUdyb3VwU3RhY2sgZnJvbSAnLi4vLi4vYnVpbGRpbmcvbW9kZWwvU2hhcGVHcm91cFN0YWNrLmpzJztcclxuaW1wb3J0IFNoYXBlUGllY2UgZnJvbSAnLi4vLi4vYnVpbGRpbmcvbW9kZWwvU2hhcGVQaWVjZS5qcyc7XHJcbmltcG9ydCBTaGFwZVN0YWNrIGZyb20gJy4uLy4uL2J1aWxkaW5nL21vZGVsL1NoYXBlU3RhY2suanMnO1xyXG5pbXBvcnQgTnVtYmVyR3JvdXBOb2RlIGZyb20gJy4uLy4uL2J1aWxkaW5nL3ZpZXcvTnVtYmVyR3JvdXBOb2RlLmpzJztcclxuaW1wb3J0IFNoYXBlR3JvdXBOb2RlIGZyb20gJy4uLy4uL2J1aWxkaW5nL3ZpZXcvU2hhcGVHcm91cE5vZGUuanMnO1xyXG5pbXBvcnQgRnJhY3Rpb25zQ29tbW9uQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9GcmFjdGlvbnNDb21tb25Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgRnJhY3Rpb25zQ29tbW9uR2xvYmFscyBmcm9tICcuLi8uLi9jb21tb24vRnJhY3Rpb25zQ29tbW9uR2xvYmFscy5qcyc7XHJcbmltcG9ydCBGcmFjdGlvbnNDb21tb25Db2xvcnMgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvRnJhY3Rpb25zQ29tbW9uQ29sb3JzLmpzJztcclxuaW1wb3J0IGZyYWN0aW9uc0NvbW1vbiBmcm9tICcuLi8uLi9mcmFjdGlvbnNDb21tb24uanMnO1xyXG5pbXBvcnQgQnVpbGRpbmdMYWJMYXllck5vZGUgZnJvbSAnLi9CdWlsZGluZ0xhYkxheWVyTm9kZS5qcyc7XHJcbmltcG9ydCBMYWJOdW1iZXJQYW5lbCBmcm9tICcuL0xhYk51bWJlclBhbmVsLmpzJztcclxuaW1wb3J0IExhYlNoYXBlUGFuZWwgZnJvbSAnLi9MYWJTaGFwZVBhbmVsLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBQQU5FTF9NQVJHSU4gPSBGcmFjdGlvbnNDb21tb25Db25zdGFudHMuUEFORUxfTUFSR0lOO1xyXG5cclxuY2xhc3MgQnVpbGRpbmdMYWJTY3JlZW5WaWV3IGV4dGVuZHMgU2NyZWVuVmlldyB7XHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtCdWlsZGluZ0xhYk1vZGVsfSBtb2RlbFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBtb2RlbCApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuXHJcbiAgICAvLyBAcHVibGljIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfVxyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBuZXcgTW9kZWxWaWV3VHJhbnNmb3JtMiggTWF0cml4My50cmFuc2xhdGlvbkZyb21WZWN0b3IoIHRoaXMubGF5b3V0Qm91bmRzLmNlbnRlciApICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge1Byb3BlcnR5LjxCb3VuZHMyPn1cclxuICAgIHRoaXMuc2hhcGVEcmFnQm91bmRzUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIHRoaXMudmlzaWJsZUJvdW5kcyApO1xyXG4gICAgdGhpcy5udW1iZXJEcmFnQm91bmRzUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIHRoaXMudmlzaWJsZUJvdW5kcyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtOb2RlfVxyXG4gICAgdGhpcy5zaGFwZVBhbmVsID0gbmV3IExhYlNoYXBlUGFuZWwoIG1vZGVsLCAoIGV2ZW50LCBzdGFjayApID0+IHtcclxuICAgICAgY29uc3QgbW9kZWxQb2ludCA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHRoaXMuZ2xvYmFsVG9Mb2NhbFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICkgKTtcclxuICAgICAgaWYgKCBzdGFjayBpbnN0YW5jZW9mIFNoYXBlU3RhY2sgKSB7XHJcbiAgICAgICAgY29uc3Qgc2hhcGVQaWVjZSA9IG5ldyBTaGFwZVBpZWNlKCBzdGFjay5mcmFjdGlvbiwgc3RhY2sucmVwcmVzZW50YXRpb24sIHN0YWNrLmNvbG9yICk7XHJcbiAgICAgICAgc2hhcGVQaWVjZS5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbW9kZWxQb2ludDtcclxuICAgICAgICBtb2RlbC5kcmFnU2hhcGVQaWVjZUZyb21TdGFjayggc2hhcGVQaWVjZSApO1xyXG4gICAgICAgIGNvbnN0IHNoYXBlUGllY2VOb2RlID0gdGhpcy5sYXllck5vZGUuZ2V0U2hhcGVQaWVjZU5vZGUoIHNoYXBlUGllY2UgKTtcclxuICAgICAgICBzaGFwZVBpZWNlTm9kZS5kcmFnTGlzdGVuZXIucHJlc3MoIGV2ZW50LCBzaGFwZVBpZWNlTm9kZSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCBzdGFjayBpbnN0YW5jZW9mIFNoYXBlR3JvdXBTdGFjayApIHtcclxuICAgICAgICBjb25zdCBzaGFwZUdyb3VwID0gbW9kZWwuYWRkU2hhcGVHcm91cCggc3RhY2sucmVwcmVzZW50YXRpb24gKTtcclxuICAgICAgICBzaGFwZUdyb3VwLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBtb2RlbFBvaW50O1xyXG4gICAgICAgIGNvbnN0IHNoYXBlR3JvdXBOb2RlID0gdGhpcy5sYXllck5vZGUuZ2V0U2hhcGVHcm91cE5vZGUoIHNoYXBlR3JvdXAgKTtcclxuICAgICAgICBzaGFwZUdyb3VwTm9kZS5kcmFnTGlzdGVuZXIucHJlc3MoIGV2ZW50LCBzaGFwZUdyb3VwTm9kZSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvciggJ3Vua25vd24gc3RhY2sgdHlwZScgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtOb2RlfVxyXG4gICAgdGhpcy5udW1iZXJQYW5lbCA9IG5ldyBMYWJOdW1iZXJQYW5lbCggbW9kZWwsICggZXZlbnQsIHN0YWNrICkgPT4ge1xyXG4gICAgICBjb25zdCBtb2RlbFBvaW50ID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0udmlld1RvTW9kZWxQb3NpdGlvbiggdGhpcy5nbG9iYWxUb0xvY2FsUG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKSApO1xyXG4gICAgICBpZiAoIHN0YWNrIGluc3RhbmNlb2YgTnVtYmVyU3RhY2sgKSB7XHJcbiAgICAgICAgY29uc3QgbnVtYmVyUGllY2UgPSBuZXcgTnVtYmVyUGllY2UoIHN0YWNrLm51bWJlciApO1xyXG4gICAgICAgIG51bWJlclBpZWNlLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBtb2RlbFBvaW50O1xyXG4gICAgICAgIG1vZGVsLmRyYWdOdW1iZXJQaWVjZUZyb21TdGFjayggbnVtYmVyUGllY2UgKTtcclxuICAgICAgICBjb25zdCBudW1iZXJQaWVjZU5vZGUgPSB0aGlzLmxheWVyTm9kZS5nZXROdW1iZXJQaWVjZU5vZGUoIG51bWJlclBpZWNlICk7XHJcbiAgICAgICAgbnVtYmVyUGllY2VOb2RlLmRyYWdMaXN0ZW5lci5wcmVzcyggZXZlbnQsIG51bWJlclBpZWNlTm9kZSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCBzdGFjayBpbnN0YW5jZW9mIE51bWJlckdyb3VwU3RhY2sgKSB7XHJcbiAgICAgICAgY29uc3QgbnVtYmVyR3JvdXAgPSBtb2RlbC5hZGROdW1iZXJHcm91cCggc3RhY2suaXNNaXhlZE51bWJlciApO1xyXG4gICAgICAgIG51bWJlckdyb3VwLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBtb2RlbFBvaW50O1xyXG4gICAgICAgIGNvbnN0IG51bWJlckdyb3VwTm9kZSA9IHRoaXMubGF5ZXJOb2RlLmdldE51bWJlckdyb3VwTm9kZSggbnVtYmVyR3JvdXAgKTtcclxuICAgICAgICBudW1iZXJHcm91cE5vZGUuZHJhZ0xpc3RlbmVyLnByZXNzKCBldmVudCwgbnVtYmVyR3JvdXBOb2RlICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCAndW5rbm93biBzdGFjayB0eXBlJyApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgcGhldC5qb2lzdC5kaXNwbGF5LmFkZElucHV0TGlzdGVuZXIoIHtcclxuICAgICAgZG93bjogZXZlbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNjcmVlbiA9IHBoZXQuam9pc3Quc2ltLnNlbGVjdGVkU2NyZWVuUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgaWYgKCBzY3JlZW4gJiYgc2NyZWVuLnZpZXcgPT09IHRoaXMgKSB7XHJcblxyXG4gICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSB0aGlzLmxheWVyTm9kZS5hY3RpdmVQb2ludGVyUHJvcGVydHkudmFsdWUgPT09IGV2ZW50LnBvaW50ZXI7XHJcblxyXG4gICAgICAgICAgLy8gU2VlIGlmIG91ciBwcmVzcyB3YXMgYSBcIm1pc3NcIiAodHJhaWwgbGVuZ3RoIDEpIG9yIGEgaGl0IG9uIG91ciBzY3JlZW4gKHNjcmVlbi52aWV3IGluIHRoZSB0cmFpbCkuXHJcbiAgICAgICAgICAvLyBXZSByZWFsbHkgd2FudCB0byBleGNsdWRlIGhvbWUtc2NyZWVuIGNsaWNrcyBzbyB0aGF0IHRoaW5ncyBzdGFydCBmb2N1c2VkLlxyXG4gICAgICAgICAgY29uc3QgZG9lc1RyYWlsTWF0Y2ggPSBfLmluY2x1ZGVzKCBldmVudC50cmFpbC5ub2Rlcywgc2NyZWVuLnZpZXcgKSB8fCBldmVudC50cmFpbC5sZW5ndGggPD0gMTtcclxuXHJcbiAgICAgICAgICBpZiAoICFpc0FjdGl2ZSAmJiBkb2VzVHJhaWxNYXRjaCApIHtcclxuICAgICAgICAgICAgLy8gQW55IGV2ZW50IG9uIGEgc2hhcGUgZ3JvdXAgc2hvdWxkIGhhbmRsZSBpdC5cclxuICAgICAgICAgICAgbW9kZWwuc2VsZWN0ZWRHcm91cFByb3BlcnR5LnZhbHVlID0gbnVsbDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Tm9kZX1cclxuICAgIGNvbnN0IHJlc2V0QWxsQnV0dG9uID0gbmV3IFJlc2V0QWxsQnV0dG9uKCB7XHJcbiAgICAgIGxpc3RlbmVyOiAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKTtcclxuICAgICAgICBtb2RlbC5yZXNldCgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgdG9wQWxpZ25Cb3ggPSBuZXcgQWxpZ25Cb3goIHRoaXMuc2hhcGVQYW5lbCwge1xyXG4gICAgICB4QWxpZ246ICdjZW50ZXInLFxyXG4gICAgICB5QWxpZ246ICd0b3AnLFxyXG4gICAgICBtYXJnaW46IFBBTkVMX01BUkdJTlxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGJvdHRvbUFsaWduQm94ID0gbmV3IEFsaWduQm94KCB0aGlzLm51bWJlclBhbmVsLCB7XHJcbiAgICAgIHhBbGlnbjogJ2NlbnRlcicsXHJcbiAgICAgIHlBbGlnbjogJ2JvdHRvbScsXHJcbiAgICAgIG1hcmdpbjogUEFORUxfTUFSR0lOXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgYm90dG9tUmlnaHRBbGlnbkJveCA9IG5ldyBBbGlnbkJveCggcmVzZXRBbGxCdXR0b24sIHtcclxuICAgICAgeEFsaWduOiAncmlnaHQnLFxyXG4gICAgICB5QWxpZ246ICdib3R0b20nLFxyXG4gICAgICBtYXJnaW46IFBBTkVMX01BUkdJTlxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGR5bmFtaWMgbGF5b3V0XHJcbiAgICB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eS5saW5rKCB2aXNpYmxlQm91bmRzID0+IHtcclxuICAgICAgdG9wQWxpZ25Cb3guYWxpZ25Cb3VuZHMgPSB2aXNpYmxlQm91bmRzO1xyXG4gICAgICBib3R0b21BbGlnbkJveC5hbGlnbkJvdW5kcyA9IHZpc2libGVCb3VuZHM7XHJcbiAgICAgIC8vIERvbid0IGNvbXBlbnNhdGUgZm9yIHRoZSByaWdodCBzaWRlIGV4cGFuZGluZyBvdXQsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZnJhY3Rpb25zLWNvbW1vbi9pc3N1ZXMvNTFcclxuICAgICAgYm90dG9tUmlnaHRBbGlnbkJveC5hbGlnbkJvdW5kcyA9IHZpc2libGVCb3VuZHMud2l0aE1heFgoIHRoaXMubGF5b3V0Qm91bmRzLnJpZ2h0ICk7XHJcbiAgICAgIHRoaXMuc2hhcGVQYW5lbC51cGRhdGVNb2RlbFBvc2l0aW9ucyggdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuICAgICAgdGhpcy5udW1iZXJQYW5lbC51cGRhdGVNb2RlbFBvc2l0aW9ucyggdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuXHJcbiAgICAgIHRoaXMuc2hhcGVEcmFnQm91bmRzUHJvcGVydHkudmFsdWUgPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbEJvdW5kcyggbmV3IEJvdW5kczIoXHJcbiAgICAgICAgdmlzaWJsZUJvdW5kcy5sZWZ0LFxyXG4gICAgICAgIHZpc2libGVCb3VuZHMudG9wLFxyXG4gICAgICAgIHZpc2libGVCb3VuZHMucmlnaHQsXHJcbiAgICAgICAgdGhpcy5udW1iZXJQYW5lbC50b3BcclxuICAgICAgKSApO1xyXG4gICAgICB0aGlzLm51bWJlckRyYWdCb3VuZHNQcm9wZXJ0eS52YWx1ZSA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsQm91bmRzKCBuZXcgQm91bmRzMihcclxuICAgICAgICB2aXNpYmxlQm91bmRzLmxlZnQsXHJcbiAgICAgICAgdGhpcy5zaGFwZVBhbmVsLmJvdHRvbSxcclxuICAgICAgICB2aXNpYmxlQm91bmRzLnJpZ2h0LFxyXG4gICAgICAgIHZpc2libGVCb3VuZHMuYm90dG9tXHJcbiAgICAgICkgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7QnVpbGRpbmdMYWJMYXllck5vZGV9XHJcbiAgICB0aGlzLmxheWVyTm9kZSA9IG5ldyBCdWlsZGluZ0xhYkxheWVyTm9kZSggbW9kZWwsIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLCB0aGlzLnNoYXBlRHJhZ0JvdW5kc1Byb3BlcnR5LCB0aGlzLm51bWJlckRyYWdCb3VuZHNQcm9wZXJ0eSwgdGhpcy5zaGFwZVBhbmVsLCB0aGlzLm51bWJlclBhbmVsICk7XHJcblxyXG4gICAgdGhpcy5jaGlsZHJlbiA9IFtcclxuICAgICAgYm90dG9tUmlnaHRBbGlnbkJveCxcclxuICAgICAgdG9wQWxpZ25Cb3gsXHJcbiAgICAgIGJvdHRvbUFsaWduQm94LFxyXG4gICAgICB0aGlzLmxheWVyTm9kZVxyXG4gICAgXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZXMgdGhlIGljb24gZm9yIHRoZSB1bm1peGVkIGxhYiBzY3JlZW5zLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHtOb2RlfVxyXG4gICAqL1xyXG4gIHN0YXRpYyBjcmVhdGVVbm1peGVkU2NyZWVuSWNvbigpIHtcclxuXHJcbiAgICBjb25zdCBudW1iZXJHcm91cCA9IG5ldyBOdW1iZXJHcm91cCggZmFsc2UgKTtcclxuICAgIG51bWJlckdyb3VwLm51bWVyYXRvclNwb3QucGllY2VQcm9wZXJ0eS52YWx1ZSA9IG5ldyBOdW1iZXJQaWVjZSggNyApO1xyXG4gICAgbnVtYmVyR3JvdXAuZGVub21pbmF0b3JTcG90LnBpZWNlUHJvcGVydHkudmFsdWUgPSBuZXcgTnVtYmVyUGllY2UoIDggKTtcclxuXHJcbiAgICBjb25zdCBudW1iZXJHcm91cE5vZGUgPSBuZXcgTnVtYmVyR3JvdXBOb2RlKCBudW1iZXJHcm91cCwge1xyXG4gICAgICBpc0ljb246IHRydWUsXHJcbiAgICAgIHBvc2l0aW9uZWQ6IGZhbHNlLFxyXG4gICAgICBzY2FsZTogMC44XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgc2hhcGVHcm91cCA9IG5ldyBTaGFwZUdyb3VwKCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uLlBJRSApO1xyXG4gICAgW1xyXG4gICAgICBuZXcgRnJhY3Rpb24oIDEsIDIgKSxcclxuICAgICAgbmV3IEZyYWN0aW9uKCAxLCA0ICksXHJcbiAgICAgIG5ldyBGcmFjdGlvbiggMSwgOCApXHJcbiAgICBdLmZvckVhY2goIGZyYWN0aW9uID0+IHtcclxuICAgICAgc2hhcGVHcm91cC5zaGFwZUNvbnRhaW5lcnMuZ2V0KCAwICkuc2hhcGVQaWVjZXMucHVzaCggbmV3IFNoYXBlUGllY2UoIGZyYWN0aW9uLCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uLlBJRSwgRnJhY3Rpb25zQ29tbW9uQ29sb3JzLnNoYXBlUmVkUHJvcGVydHkgKSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHNoYXBlR3JvdXBOb2RlID0gbmV3IFNoYXBlR3JvdXBOb2RlKCBzaGFwZUdyb3VwLCB7XHJcbiAgICAgIGhhc0J1dHRvbnM6IGZhbHNlLFxyXG4gICAgICBpc0ljb246IHRydWUsXHJcbiAgICAgIHBvc2l0aW9uZWQ6IGZhbHNlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgcmV0dXJuIEZyYWN0aW9uc0NvbW1vbkdsb2JhbHMud3JhcEljb24oIG5ldyBIQm94KCB7XHJcbiAgICAgIHNwYWNpbmc6IDIwLFxyXG4gICAgICBjaGlsZHJlbjogW1xyXG4gICAgICAgIG51bWJlckdyb3VwTm9kZSxcclxuICAgICAgICBzaGFwZUdyb3VwTm9kZVxyXG4gICAgICBdLFxyXG4gICAgICBzY2FsZTogMi4zXHJcbiAgICB9ICksIEZyYWN0aW9uc0NvbW1vbkNvbG9ycy5vdGhlclNjcmVlbkJhY2tncm91bmRQcm9wZXJ0eSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyB0aGUgaWNvbiBmb3IgdGhlIG1peGVkIGxhYiBzY3JlZW5zLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHtOb2RlfVxyXG4gICAqL1xyXG4gIHN0YXRpYyBjcmVhdGVNaXhlZFNjcmVlbkljb24oKSB7XHJcblxyXG4gICAgY29uc3Qgc2hhcGVHcm91cCA9IG5ldyBTaGFwZUdyb3VwKCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uLlBJRSApO1xyXG4gICAgc2hhcGVHcm91cC5pbmNyZWFzZUNvbnRhaW5lckNvdW50KCk7XHJcbiAgICBzaGFwZUdyb3VwLnNoYXBlQ29udGFpbmVycy5nZXQoIDAgKS5zaGFwZVBpZWNlcy5wdXNoKCBuZXcgU2hhcGVQaWVjZSggRnJhY3Rpb24uT05FLCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uLlBJRSwgRnJhY3Rpb25zQ29tbW9uQ29sb3JzLnNoYXBlUmVkUHJvcGVydHkgKSApO1xyXG4gICAgW1xyXG4gICAgICBuZXcgRnJhY3Rpb24oIDEsIDIgKSxcclxuICAgICAgbmV3IEZyYWN0aW9uKCAxLCA0ICksXHJcbiAgICAgIG5ldyBGcmFjdGlvbiggMSwgOCApXHJcbiAgICBdLmZvckVhY2goIGZyYWN0aW9uID0+IHtcclxuICAgICAgc2hhcGVHcm91cC5zaGFwZUNvbnRhaW5lcnMuZ2V0KCAxICkuc2hhcGVQaWVjZXMucHVzaCggbmV3IFNoYXBlUGllY2UoIGZyYWN0aW9uLCBCdWlsZGluZ1JlcHJlc2VudGF0aW9uLlBJRSwgRnJhY3Rpb25zQ29tbW9uQ29sb3JzLnNoYXBlUmVkUHJvcGVydHkgKSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHNoYXBlR3JvdXBOb2RlID0gbmV3IFNoYXBlR3JvdXBOb2RlKCBzaGFwZUdyb3VwLCB7XHJcbiAgICAgIGhhc0J1dHRvbnM6IGZhbHNlLFxyXG4gICAgICBpc0ljb246IHRydWUsXHJcbiAgICAgIHBvc2l0aW9uZWQ6IGZhbHNlLFxyXG4gICAgICBzY2FsZTogMi4xXHJcbiAgICB9ICk7XHJcblxyXG4gICAgcmV0dXJuIEZyYWN0aW9uc0NvbW1vbkdsb2JhbHMud3JhcEljb24oIHNoYXBlR3JvdXBOb2RlLCBGcmFjdGlvbnNDb21tb25Db2xvcnMub3RoZXJTY3JlZW5CYWNrZ3JvdW5kUHJvcGVydHkgKTtcclxuICB9XHJcbn1cclxuXHJcbmZyYWN0aW9uc0NvbW1vbi5yZWdpc3RlciggJ0J1aWxkaW5nTGFiU2NyZWVuVmlldycsIEJ1aWxkaW5nTGFiU2NyZWVuVmlldyApO1xyXG5leHBvcnQgZGVmYXVsdCBCdWlsZGluZ0xhYlNjcmVlblZpZXc7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxVQUFVLE1BQU0sb0NBQW9DO0FBQzNELE9BQU9DLFFBQVEsTUFBTSw2Q0FBNkM7QUFDbEUsT0FBT0MsbUJBQW1CLE1BQU0sdURB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