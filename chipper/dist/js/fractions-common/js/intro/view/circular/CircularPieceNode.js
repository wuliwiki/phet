// Copyright 2018-2020, University of Colorado Boulder

/**
 * The circular variant of a piece node.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import fractionsCommon from '../../../fractionsCommon.js';
import PieceNode from '../PieceNode.js';
import CircularNode from './CircularNode.js';
class CircularPieceNode extends PieceNode {
  /**
   * @param {Piece} piece
   * @param {function} finishedAnimatingCallback - Called as function( {Piece} ) with the piece to finish animating.
   * @param {function} droppedCallback - Called as function( {Piece} )
   */
  constructor(piece, finishedAnimatingCallback, droppedCallback) {
    super(piece, finishedAnimatingCallback, droppedCallback, {
      graphic: new CircularNode(piece.denominator, 0, {
        dropShadow: true
      })
    });

    // @private {number} (convenience variable)
    this.angleUnit = -2 * Math.PI / piece.denominator;

    // circle specific
    const originCell = piece.originCell;
    if (originCell) {
      this.graphic.setRotationAngle(originCell.index * this.angleUnit);
    } else {
      this.graphic.setRotationAngle(this.graphic.bucketRotation);
    }
  }

  /**
   * Handles operations in step() before midpoint is set.
   * @protected
   * @override
   */
  beforeMidpointSet() {
    // rotate before centering
    const destinationCell = this.piece.destinationCell;
    const originRotation = this.originRotation;
    let targetRotation = destinationCell ? destinationCell.index * this.angleUnit : this.graphic.bucketRotation;

    // Hack to get closest rotation AND deduplicate this code
    if (targetRotation - originRotation > Math.PI) {
      targetRotation -= 2 * Math.PI;
    }
    if (targetRotation - originRotation < -Math.PI) {
      targetRotation += 2 * Math.PI;
    }
    this.graphic.setRotationAngle((1 - this.ratio) * this.originRotation + this.ratio * targetRotation);
  }

  /**
   * Orients the piece to match the closest cell.
   * @public
   * @override
   *
   * @param {Cell} closestCell
   * @param {number} dt
   */
  orient(closestCell, dt) {
    super.orient(closestCell, dt);
    const originRotation = this.graphic.getCircleRotation();
    let targetRotation = closestCell.index * this.angleUnit;

    // Hack to get closest rotation AND deduplicate this code
    if (targetRotation - originRotation > Math.PI) {
      targetRotation -= 2 * Math.PI;
    }
    if (targetRotation - originRotation < -Math.PI) {
      targetRotation += 2 * Math.PI;
    }
    const midpoint = this.getMidpoint();
    const rotationAmount = 5 * dt;
    if (targetRotation > originRotation) {
      this.graphic.setRotationAngle(Math.min(targetRotation, originRotation + rotationAmount));
    } else if (targetRotation < originRotation) {
      this.graphic.setRotationAngle(Math.max(targetRotation, originRotation - rotationAmount));
    }
    this.setMidpoint(midpoint);
  }
}
fractionsCommon.register('CircularPieceNode', CircularPieceNode);
export default CircularPieceNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcmFjdGlvbnNDb21tb24iLCJQaWVjZU5vZGUiLCJDaXJjdWxhck5vZGUiLCJDaXJjdWxhclBpZWNlTm9kZSIsImNvbnN0cnVjdG9yIiwicGllY2UiLCJmaW5pc2hlZEFuaW1hdGluZ0NhbGxiYWNrIiwiZHJvcHBlZENhbGxiYWNrIiwiZ3JhcGhpYyIsImRlbm9taW5hdG9yIiwiZHJvcFNoYWRvdyIsImFuZ2xlVW5pdCIsIk1hdGgiLCJQSSIsIm9yaWdpbkNlbGwiLCJzZXRSb3RhdGlvbkFuZ2xlIiwiaW5kZXgiLCJidWNrZXRSb3RhdGlvbiIsImJlZm9yZU1pZHBvaW50U2V0IiwiZGVzdGluYXRpb25DZWxsIiwib3JpZ2luUm90YXRpb24iLCJ0YXJnZXRSb3RhdGlvbiIsInJhdGlvIiwib3JpZW50IiwiY2xvc2VzdENlbGwiLCJkdCIsImdldENpcmNsZVJvdGF0aW9uIiwibWlkcG9pbnQiLCJnZXRNaWRwb2ludCIsInJvdGF0aW9uQW1vdW50IiwibWluIiwibWF4Iiwic2V0TWlkcG9pbnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkNpcmN1bGFyUGllY2VOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjAsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoZSBjaXJjdWxhciB2YXJpYW50IG9mIGEgcGllY2Ugbm9kZS5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBmcmFjdGlvbnNDb21tb24gZnJvbSAnLi4vLi4vLi4vZnJhY3Rpb25zQ29tbW9uLmpzJztcclxuaW1wb3J0IFBpZWNlTm9kZSBmcm9tICcuLi9QaWVjZU5vZGUuanMnO1xyXG5pbXBvcnQgQ2lyY3VsYXJOb2RlIGZyb20gJy4vQ2lyY3VsYXJOb2RlLmpzJztcclxuXHJcbmNsYXNzIENpcmN1bGFyUGllY2VOb2RlIGV4dGVuZHMgUGllY2VOb2RlIHtcclxuICAvKipcclxuICAgKiBAcGFyYW0ge1BpZWNlfSBwaWVjZVxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGZpbmlzaGVkQW5pbWF0aW5nQ2FsbGJhY2sgLSBDYWxsZWQgYXMgZnVuY3Rpb24oIHtQaWVjZX0gKSB3aXRoIHRoZSBwaWVjZSB0byBmaW5pc2ggYW5pbWF0aW5nLlxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGRyb3BwZWRDYWxsYmFjayAtIENhbGxlZCBhcyBmdW5jdGlvbigge1BpZWNlfSApXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHBpZWNlLCBmaW5pc2hlZEFuaW1hdGluZ0NhbGxiYWNrLCBkcm9wcGVkQ2FsbGJhY2sgKSB7XHJcbiAgICBzdXBlciggcGllY2UsIGZpbmlzaGVkQW5pbWF0aW5nQ2FsbGJhY2ssIGRyb3BwZWRDYWxsYmFjaywge1xyXG4gICAgICBncmFwaGljOiBuZXcgQ2lyY3VsYXJOb2RlKCBwaWVjZS5kZW5vbWluYXRvciwgMCwgeyBkcm9wU2hhZG93OiB0cnVlIH0gKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtudW1iZXJ9IChjb252ZW5pZW5jZSB2YXJpYWJsZSlcclxuICAgIHRoaXMuYW5nbGVVbml0ID0gLTIgKiBNYXRoLlBJIC8gcGllY2UuZGVub21pbmF0b3I7XHJcblxyXG4gICAgLy8gY2lyY2xlIHNwZWNpZmljXHJcbiAgICBjb25zdCBvcmlnaW5DZWxsID0gcGllY2Uub3JpZ2luQ2VsbDtcclxuICAgIGlmICggb3JpZ2luQ2VsbCApIHtcclxuICAgICAgdGhpcy5ncmFwaGljLnNldFJvdGF0aW9uQW5nbGUoIG9yaWdpbkNlbGwuaW5kZXggKiB0aGlzLmFuZ2xlVW5pdCApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMuZ3JhcGhpYy5zZXRSb3RhdGlvbkFuZ2xlKCB0aGlzLmdyYXBoaWMuYnVja2V0Um90YXRpb24gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZXMgb3BlcmF0aW9ucyBpbiBzdGVwKCkgYmVmb3JlIG1pZHBvaW50IGlzIHNldC5cclxuICAgKiBAcHJvdGVjdGVkXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgYmVmb3JlTWlkcG9pbnRTZXQoKSB7XHJcbiAgICAvLyByb3RhdGUgYmVmb3JlIGNlbnRlcmluZ1xyXG4gICAgY29uc3QgZGVzdGluYXRpb25DZWxsID0gdGhpcy5waWVjZS5kZXN0aW5hdGlvbkNlbGw7XHJcblxyXG4gICAgY29uc3Qgb3JpZ2luUm90YXRpb24gPSB0aGlzLm9yaWdpblJvdGF0aW9uO1xyXG4gICAgbGV0IHRhcmdldFJvdGF0aW9uID0gZGVzdGluYXRpb25DZWxsID8gZGVzdGluYXRpb25DZWxsLmluZGV4ICogdGhpcy5hbmdsZVVuaXQgOiB0aGlzLmdyYXBoaWMuYnVja2V0Um90YXRpb247XHJcblxyXG4gICAgLy8gSGFjayB0byBnZXQgY2xvc2VzdCByb3RhdGlvbiBBTkQgZGVkdXBsaWNhdGUgdGhpcyBjb2RlXHJcbiAgICBpZiAoIHRhcmdldFJvdGF0aW9uIC0gb3JpZ2luUm90YXRpb24gPiBNYXRoLlBJICkge1xyXG4gICAgICB0YXJnZXRSb3RhdGlvbiAtPSAyICogTWF0aC5QSTtcclxuICAgIH1cclxuICAgIGlmICggdGFyZ2V0Um90YXRpb24gLSBvcmlnaW5Sb3RhdGlvbiA8IC1NYXRoLlBJICkge1xyXG4gICAgICB0YXJnZXRSb3RhdGlvbiArPSAyICogTWF0aC5QSTtcclxuICAgIH1cclxuICAgIHRoaXMuZ3JhcGhpYy5zZXRSb3RhdGlvbkFuZ2xlKCAoIDEgLSB0aGlzLnJhdGlvICkgKiB0aGlzLm9yaWdpblJvdGF0aW9uICsgdGhpcy5yYXRpbyAqIHRhcmdldFJvdGF0aW9uICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBPcmllbnRzIHRoZSBwaWVjZSB0byBtYXRjaCB0aGUgY2xvc2VzdCBjZWxsLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7Q2VsbH0gY2xvc2VzdENlbGxcclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHRcclxuICAgKi9cclxuICBvcmllbnQoIGNsb3Nlc3RDZWxsLCBkdCApIHtcclxuICAgIHN1cGVyLm9yaWVudCggY2xvc2VzdENlbGwsIGR0ICk7XHJcblxyXG4gICAgY29uc3Qgb3JpZ2luUm90YXRpb24gPSB0aGlzLmdyYXBoaWMuZ2V0Q2lyY2xlUm90YXRpb24oKTtcclxuICAgIGxldCB0YXJnZXRSb3RhdGlvbiA9IGNsb3Nlc3RDZWxsLmluZGV4ICogdGhpcy5hbmdsZVVuaXQ7XHJcblxyXG4gICAgLy8gSGFjayB0byBnZXQgY2xvc2VzdCByb3RhdGlvbiBBTkQgZGVkdXBsaWNhdGUgdGhpcyBjb2RlXHJcbiAgICBpZiAoIHRhcmdldFJvdGF0aW9uIC0gb3JpZ2luUm90YXRpb24gPiBNYXRoLlBJICkge1xyXG4gICAgICB0YXJnZXRSb3RhdGlvbiAtPSAyICogTWF0aC5QSTtcclxuICAgIH1cclxuICAgIGlmICggdGFyZ2V0Um90YXRpb24gLSBvcmlnaW5Sb3RhdGlvbiA8IC1NYXRoLlBJICkge1xyXG4gICAgICB0YXJnZXRSb3RhdGlvbiArPSAyICogTWF0aC5QSTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtaWRwb2ludCA9IHRoaXMuZ2V0TWlkcG9pbnQoKTtcclxuXHJcbiAgICBjb25zdCByb3RhdGlvbkFtb3VudCA9IDUgKiBkdDtcclxuICAgIGlmICggdGFyZ2V0Um90YXRpb24gPiBvcmlnaW5Sb3RhdGlvbiApIHtcclxuICAgICAgdGhpcy5ncmFwaGljLnNldFJvdGF0aW9uQW5nbGUoIE1hdGgubWluKCB0YXJnZXRSb3RhdGlvbiwgb3JpZ2luUm90YXRpb24gKyByb3RhdGlvbkFtb3VudCApICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGFyZ2V0Um90YXRpb24gPCBvcmlnaW5Sb3RhdGlvbiApIHtcclxuICAgICAgdGhpcy5ncmFwaGljLnNldFJvdGF0aW9uQW5nbGUoIE1hdGgubWF4KCB0YXJnZXRSb3RhdGlvbiwgb3JpZ2luUm90YXRpb24gLSByb3RhdGlvbkFtb3VudCApICk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zZXRNaWRwb2ludCggbWlkcG9pbnQgKTtcclxuICB9XHJcbn1cclxuXHJcbmZyYWN0aW9uc0NvbW1vbi5yZWdpc3RlciggJ0NpcmN1bGFyUGllY2VOb2RlJywgQ2lyY3VsYXJQaWVjZU5vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgQ2lyY3VsYXJQaWVjZU5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSw2QkFBNkI7QUFDekQsT0FBT0MsU0FBUyxNQUFNLGlCQUFpQjtBQUN2QyxPQUFPQyxZQUFZLE1BQU0sbUJBQW1CO0FBRTVDLE1BQU1DLGlCQUFpQixTQUFTRixTQUFTLENBQUM7RUFDeEM7QUFDRjtBQUNBO0FBQ0E7QUFDQTtFQUNFRyxXQUFXQSxDQUFFQyxLQUFLLEVBQUVDLHlCQUF5QixFQUFFQyxlQUFlLEVBQUc7SUFDL0QsS0FBSyxDQUFFRixLQUFLLEVBQUVDLHlCQUF5QixFQUFFQyxlQUFlLEVBQUU7TUFDeERDLE9BQU8sRUFBRSxJQUFJTixZQUFZLENBQUVHLEtBQUssQ0FBQ0ksV0FBVyxFQUFFLENBQUMsRUFBRTtRQUFFQyxVQUFVLEVBQUU7TUFBSyxDQUFFO0lBQ3hFLENBQUUsQ0FBQzs7SUFFSDtJQUNBLElBQUksQ0FBQ0MsU0FBUyxHQUFHLENBQUMsQ0FBQyxHQUFHQyxJQUFJLENBQUNDLEVBQUUsR0FBR1IsS0FBSyxDQUFDSSxXQUFXOztJQUVqRDtJQUNBLE1BQU1LLFVBQVUsR0FBR1QsS0FBSyxDQUFDUyxVQUFVO0lBQ25DLElBQUtBLFVBQVUsRUFBRztNQUNoQixJQUFJLENBQUNOLE9BQU8sQ0FBQ08sZ0JBQWdCLENBQUVELFVBQVUsQ0FBQ0UsS0FBSyxHQUFHLElBQUksQ0FBQ0wsU0FBVSxDQUFD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