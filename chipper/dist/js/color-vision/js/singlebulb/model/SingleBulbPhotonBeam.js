// Copyright 2014-2022, University of Colorado Boulder

/**
 * Model of the photon beam used on the single bulb screen, made of individual photon particles.
 *
 * @author Aaron Davis (PhET Interactive Simulations)
 */

import Emitter from '../../../../axon/js/Emitter.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import merge from '../../../../phet-core/js/merge.js';
import VisibleColor from '../../../../scenery-phet/js/VisibleColor.js';
import { Color } from '../../../../scenery/js/imports.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import IOType from '../../../../tandem/js/types/IOType.js';
import colorVision from '../../colorVision.js';
import ColorVisionConstants from '../../common/ColorVisionConstants.js';
import SingleBulbConstants from '../SingleBulbConstants.js';
import SingleBulbPhoton from './SingleBulbPhoton.js';

// constants
const BLACK_ALPHA_0 = Color.BLACK.withAlpha(0).setImmutable();
class SingleBulbPhotonBeam extends PhetioObject {
  /**
   * @param {SingleBulbModel} model
   * @param {number} beamLength the length of the beam. This is used to determine what position to restart the photons.
   * @param {Object} [options] - required
   */
  constructor(model, beamLength, options) {
    options = merge({
      phetioState: false
    }, options);
    super(options);

    // @public
    this.photons = [];
    this.beamLength = beamLength;

    // @private
    this.model = model;

    // @public
    this.repaintEmitter = new Emitter();
  }

  // @public
  updateAnimationFrame(dt) {
    let probability = 1; // probability for a given photon to pass the filter
    const filterWavelength = this.model.filterWavelengthProperty.value;

    // move all photons that are currently active
    for (let j = 0; j < this.photons.length; j++) {
      const photon = this.photons[j];

      // calculate the new position of the photon in order to check whether it will still be in bounds
      const newX = photon.position.x + dt * photon.velocity.x;
      const newY = photon.position.y + dt * photon.velocity.y;

      // check if the photon just passed through the filter position
      if (this.model.filterVisibleProperty.value && newX < this.filterOffset && !photon.passedFilter) {
        const halfWidth = SingleBulbConstants.GAUSSIAN_WIDTH / 2;

        // If the photon's wavelength is outside the transmission width, it doesn't pass.
        if (photon.wavelength < filterWavelength - halfWidth || photon.wavelength > filterWavelength + halfWidth) {
          probability = 0;
        }
        // flashlightWavelength is within the transmission width, pass a linear percentage.
        else {
          probability = 1 - Math.abs(filterWavelength - photon.wavelength) / halfWidth;
        }

        // set the probability to be 0.5 for white photons, this is just based on the observation of what looks good
        probability = !photon.wasWhite ? probability : 0.5;

        // remove a percentage of photons from the beam
        if (dotRandom.nextDouble() >= probability) {
          this.photons[j].dispose();
          this.photons.splice(j, 1); // remove jth photon from list
          continue;
        }
        // if the beam is white, make sure it is the color of the filter
        else if (photon.isWhite) {
          photon.color = VisibleColor.wavelengthToColor(filterWavelength);
          photon.isWhite = false;
        }
        // if the photon is not white
        else {
          // set the photonIntensity to be the same as the percentage passing through the filter,
          // for use when setting the perceived color when the photon hits the eye.
          // make sure the intensity is at least 0.2, otherwise it looks too black in the view
          photon.intensity = isFinite(probability) ? probability < 0.2 ? 0.2 : probability : 0;
        }
      }

      // keep track of photons which pass the filter
      if (photon.position.x < this.filterOffset) {
        photon.passedFilter = true;
      }

      // move the photon unless it goes out of bounds
      if (newX > 0 && newY > 0 && newY < ColorVisionConstants.BEAM_HEIGHT) {
        photon.updateAnimationFrame(newX, newY);
      }

      // if the photon goes out of bounds, update the lastPhotonColor Property, which is used in determining the perceived color
      else {
        // the perceived color, and in particular its intensity, is based in part on whether it is or was white
        let newPerceivedColor;
        if (photon.isWhite) {
          newPerceivedColor = Color.WHITE;
        } else {
          if (photon.wasWhite) {
            newPerceivedColor = photon.color;
          } else {
            newPerceivedColor = photon.color.withAlpha(photon.intensity);
          }
        }

        // don't update the lastPhotonColor unless it is different than before, for performance reasons
        // and don't bother to update the color if the view is on beam mode
        if (!this.model.lastPhotonColorProperty.value.equals(newPerceivedColor) && this.model.beamTypeProperty.value === 'photon') {
          // if the photon was white, the perceived color keeps full intensity even when it passes the filter,
          // otherwise it takes the intensity of the photon, which may have been partially filtered
          this.model.lastPhotonColorProperty.value = photon.wasWhite ? newPerceivedColor.withAlpha(1) : newPerceivedColor;
        }
        this.photons[j].dispose();
        this.photons.splice(j, 1); // remove jth photon from list
      }
    }

    // emit a black photon for resetting the perceived color to black if no more photons passing through the filter.
    // this takes care of the case when no photons pass through the filter
    if (probability === 0 && this.model.filterVisibleProperty.value) {
      const blackPhoton = new SingleBulbPhoton(new Vector2(this.filterOffset, ColorVisionConstants.BEAM_HEIGHT / 2), new Vector2(ColorVisionConstants.X_VELOCITY, 0), 1, BLACK_ALPHA_0, false, undefined);
      blackPhoton.passedFilter = true;
      this.photons.push(blackPhoton);
    }

    // emit a black photon for resetting the perceived color to black if the flashlight is off
    if (!this.model.flashlightOnProperty.value) {
      this.photons.push(new SingleBulbPhoton(new Vector2(this.beamLength, ColorVisionConstants.BEAM_HEIGHT / 2), new Vector2(ColorVisionConstants.X_VELOCITY, 0), 1, BLACK_ALPHA_0, false, undefined));
    }
  }

  // @public
  createPhoton(timeElapsed) {
    // if the flashlight is on, create a new photon this animation frame
    if (this.model.flashlightOnProperty.value) {
      const newColor = this.model.lightTypeProperty.value === 'white' ? randomVisibleColor() : VisibleColor.wavelengthToColor(this.model.flashlightWavelengthProperty.value);
      const x = this.beamLength + ColorVisionConstants.X_VELOCITY * timeElapsed;
      const yVelocity = (dotRandom.nextDouble() * ColorVisionConstants.FAN_FACTOR - ColorVisionConstants.FAN_FACTOR / 2) * 60;
      const initialY = yVelocity * (25 / 60) + ColorVisionConstants.BEAM_HEIGHT / 2;
      const deltaY = yVelocity * timeElapsed;
      const y = initialY + deltaY;
      this.photons.push(new SingleBulbPhoton(new Vector2(x, y), new Vector2(ColorVisionConstants.X_VELOCITY, yVelocity), 1, newColor, this.model.lightTypeProperty.value === 'white', this.model.flashlightWavelengthProperty.value));
    }
  }

  // @public
  reset() {
    // set all photons to be out of bounds to trigger empty redraw
    for (let i = 0; i < this.photons.length; i++) {
      this.photons[i].position.x = 0;
    }
  }
}

/**
 * Gets a random visible Color. This is used to generate random photon colors when the light source is white light.
 * @returns {Color}
 */
function randomVisibleColor() {
  const randomWavelength = dotRandom.nextIntBetween(VisibleColor.MIN_WAVELENGTH, VisibleColor.MAX_WAVELENGTH);
  return VisibleColor.wavelengthToColor(randomWavelength);
}
SingleBulbPhotonBeam.SingleBulbPhotonBeamIO = new IOType('SingleBulbPhotonBeamIO', {
  valueType: SingleBulbPhotonBeam,
  documentation: 'The Beam on the single bulb screen.'
});
colorVision.register('SingleBulbPhotonBeam', SingleBulbPhotonBeam);
export default SingleBulbPhotonBeam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbWl0dGVyIiwiZG90UmFuZG9tIiwiVmVjdG9yMiIsIm1lcmdlIiwiVmlzaWJsZUNvbG9yIiwiQ29sb3IiLCJQaGV0aW9PYmplY3QiLCJJT1R5cGUiLCJjb2xvclZpc2lvbiIsIkNvbG9yVmlzaW9uQ29uc3RhbnRzIiwiU2luZ2xlQnVsYkNvbnN0YW50cyIsIlNpbmdsZUJ1bGJQaG90b24iLCJCTEFDS19BTFBIQV8wIiwiQkxBQ0siLCJ3aXRoQWxwaGEiLCJzZXRJbW11dGFibGUiLCJTaW5nbGVCdWxiUGhvdG9uQmVhbSIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJiZWFtTGVuZ3RoIiwib3B0aW9ucyIsInBoZXRpb1N0YXRlIiwicGhvdG9ucyIsInJlcGFpbnRFbWl0dGVyIiwidXBkYXRlQW5pbWF0aW9uRnJhbWUiLCJkdCIsInByb2JhYmlsaXR5IiwiZmlsdGVyV2F2ZWxlbmd0aCIsImZpbHRlcldhdmVsZW5ndGhQcm9wZXJ0eSIsInZhbHVlIiwiaiIsImxlbmd0aCIsInBob3RvbiIsIm5ld1giLCJwb3NpdGlvbiIsIngiLCJ2ZWxvY2l0eSIsIm5ld1kiLCJ5IiwiZmlsdGVyVmlzaWJsZVByb3BlcnR5IiwiZmlsdGVyT2Zmc2V0IiwicGFzc2VkRmlsdGVyIiwiaGFsZldpZHRoIiwiR0FVU1NJQU5fV0lEVEgiLCJ3YXZlbGVuZ3RoIiwiTWF0aCIsImFicyIsIndhc1doaXRlIiwibmV4dERvdWJsZSIsImRpc3Bvc2UiLCJzcGxpY2UiLCJpc1doaXRlIiwiY29sb3IiLCJ3YXZlbGVuZ3RoVG9Db2xvciIsImludGVuc2l0eSIsImlzRmluaXRlIiwiQkVBTV9IRUlHSFQiLCJuZXdQZXJjZWl2ZWRDb2xvciIsIldISVRFIiwibGFzdFBob3RvbkNvbG9yUHJvcGVydHkiLCJlcXVhbHMiLCJiZWFtVHlwZVByb3BlcnR5IiwiYmxhY2tQaG90b24iLCJYX1ZFTE9DSVRZIiwidW5kZWZpbmVkIiwicHVzaCIsImZsYXNobGlnaHRPblByb3BlcnR5IiwiY3JlYXRlUGhvdG9uIiwidGltZUVsYXBzZWQiLCJuZXdDb2xvciIsImxpZ2h0VHlwZVByb3BlcnR5IiwicmFuZG9tVmlzaWJsZUNvbG9yIiwiZmxhc2hsaWdodFdhdmVsZW5ndGhQcm9wZXJ0eSIsInlWZWxvY2l0eSIsIkZBTl9GQUNUT1IiLCJpbml0aWFsWSIsImRlbHRhWSIsInJlc2V0IiwiaSIsInJhbmRvbVdhdmVsZW5ndGgiLCJuZXh0SW50QmV0d2VlbiIsIk1JTl9XQVZFTEVOR1RIIiwiTUFYX1dBVkVMRU5HVEgiLCJTaW5nbGVCdWxiUGhvdG9uQmVhbUlPIiwidmFsdWVUeXBlIiwiZG9jdW1lbnRhdGlvbiIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiU2luZ2xlQnVsYlBob3RvbkJlYW0uanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTW9kZWwgb2YgdGhlIHBob3RvbiBiZWFtIHVzZWQgb24gdGhlIHNpbmdsZSBidWxiIHNjcmVlbiwgbWFkZSBvZiBpbmRpdmlkdWFsIHBob3RvbiBwYXJ0aWNsZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQWFyb24gRGF2aXMgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEVtaXR0ZXIgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9FbWl0dGVyLmpzJztcclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFZpc2libGVDb2xvciBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvVmlzaWJsZUNvbG9yLmpzJztcclxuaW1wb3J0IHsgQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgUGhldGlvT2JqZWN0IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgY29sb3JWaXNpb24gZnJvbSAnLi4vLi4vY29sb3JWaXNpb24uanMnO1xyXG5pbXBvcnQgQ29sb3JWaXNpb25Db25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0NvbG9yVmlzaW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFNpbmdsZUJ1bGJDb25zdGFudHMgZnJvbSAnLi4vU2luZ2xlQnVsYkNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBTaW5nbGVCdWxiUGhvdG9uIGZyb20gJy4vU2luZ2xlQnVsYlBob3Rvbi5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgQkxBQ0tfQUxQSEFfMCA9IENvbG9yLkJMQUNLLndpdGhBbHBoYSggMCApLnNldEltbXV0YWJsZSgpO1xyXG5cclxuY2xhc3MgU2luZ2xlQnVsYlBob3RvbkJlYW0gZXh0ZW5kcyBQaGV0aW9PYmplY3Qge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1NpbmdsZUJ1bGJNb2RlbH0gbW9kZWxcclxuICAgKiBAcGFyYW0ge251bWJlcn0gYmVhbUxlbmd0aCB0aGUgbGVuZ3RoIG9mIHRoZSBiZWFtLiBUaGlzIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoYXQgcG9zaXRpb24gdG8gcmVzdGFydCB0aGUgcGhvdG9ucy5cclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gcmVxdWlyZWRcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbW9kZWwsIGJlYW1MZW5ndGgsIG9wdGlvbnMgKSB7XHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuICAgICAgcGhldGlvU3RhdGU6IGZhbHNlXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHVibGljXHJcbiAgICB0aGlzLnBob3RvbnMgPSBbXTtcclxuICAgIHRoaXMuYmVhbUxlbmd0aCA9IGJlYW1MZW5ndGg7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuXHJcbiAgICAvLyBAcHVibGljXHJcbiAgICB0aGlzLnJlcGFpbnRFbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICB1cGRhdGVBbmltYXRpb25GcmFtZSggZHQgKSB7XHJcblxyXG4gICAgbGV0IHByb2JhYmlsaXR5ID0gMTsgLy8gcHJvYmFiaWxpdHkgZm9yIGEgZ2l2ZW4gcGhvdG9uIHRvIHBhc3MgdGhlIGZpbHRlclxyXG4gICAgY29uc3QgZmlsdGVyV2F2ZWxlbmd0aCA9IHRoaXMubW9kZWwuZmlsdGVyV2F2ZWxlbmd0aFByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgIC8vIG1vdmUgYWxsIHBob3RvbnMgdGhhdCBhcmUgY3VycmVudGx5IGFjdGl2ZVxyXG4gICAgZm9yICggbGV0IGogPSAwOyBqIDwgdGhpcy5waG90b25zLmxlbmd0aDsgaisrICkge1xyXG4gICAgICBjb25zdCBwaG90b24gPSB0aGlzLnBob3RvbnNbIGogXTtcclxuXHJcbiAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgbmV3IHBvc2l0aW9uIG9mIHRoZSBwaG90b24gaW4gb3JkZXIgdG8gY2hlY2sgd2hldGhlciBpdCB3aWxsIHN0aWxsIGJlIGluIGJvdW5kc1xyXG4gICAgICBjb25zdCBuZXdYID0gcGhvdG9uLnBvc2l0aW9uLnggKyBkdCAqIHBob3Rvbi52ZWxvY2l0eS54O1xyXG4gICAgICBjb25zdCBuZXdZID0gcGhvdG9uLnBvc2l0aW9uLnkgKyBkdCAqIHBob3Rvbi52ZWxvY2l0eS55O1xyXG5cclxuICAgICAgLy8gY2hlY2sgaWYgdGhlIHBob3RvbiBqdXN0IHBhc3NlZCB0aHJvdWdoIHRoZSBmaWx0ZXIgcG9zaXRpb25cclxuICAgICAgaWYgKCB0aGlzLm1vZGVsLmZpbHRlclZpc2libGVQcm9wZXJ0eS52YWx1ZSAmJiBuZXdYIDwgdGhpcy5maWx0ZXJPZmZzZXQgJiYgIXBob3Rvbi5wYXNzZWRGaWx0ZXIgKSB7XHJcbiAgICAgICAgY29uc3QgaGFsZldpZHRoID0gU2luZ2xlQnVsYkNvbnN0YW50cy5HQVVTU0lBTl9XSURUSCAvIDI7XHJcblxyXG4gICAgICAgIC8vIElmIHRoZSBwaG90b24ncyB3YXZlbGVuZ3RoIGlzIG91dHNpZGUgdGhlIHRyYW5zbWlzc2lvbiB3aWR0aCwgaXQgZG9lc24ndCBwYXNzLlxyXG4gICAgICAgIGlmICggcGhvdG9uLndhdmVsZW5ndGggPCBmaWx0ZXJXYXZlbGVuZ3RoIC0gaGFsZldpZHRoIHx8XHJcbiAgICAgICAgICAgICBwaG90b24ud2F2ZWxlbmd0aCA+IGZpbHRlcldhdmVsZW5ndGggKyBoYWxmV2lkdGggKSB7XHJcbiAgICAgICAgICBwcm9iYWJpbGl0eSA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGZsYXNobGlnaHRXYXZlbGVuZ3RoIGlzIHdpdGhpbiB0aGUgdHJhbnNtaXNzaW9uIHdpZHRoLCBwYXNzIGEgbGluZWFyIHBlcmNlbnRhZ2UuXHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBwcm9iYWJpbGl0eSA9IDEgLSBNYXRoLmFicyggZmlsdGVyV2F2ZWxlbmd0aCAtIHBob3Rvbi53YXZlbGVuZ3RoICkgLyBoYWxmV2lkdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBzZXQgdGhlIHByb2JhYmlsaXR5IHRvIGJlIDAuNSBmb3Igd2hpdGUgcGhvdG9ucywgdGhpcyBpcyBqdXN0IGJhc2VkIG9uIHRoZSBvYnNlcnZhdGlvbiBvZiB3aGF0IGxvb2tzIGdvb2RcclxuICAgICAgICBwcm9iYWJpbGl0eSA9ICggIXBob3Rvbi53YXNXaGl0ZSApID8gcHJvYmFiaWxpdHkgOiAwLjU7XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZSBhIHBlcmNlbnRhZ2Ugb2YgcGhvdG9ucyBmcm9tIHRoZSBiZWFtXHJcbiAgICAgICAgaWYgKCBkb3RSYW5kb20ubmV4dERvdWJsZSgpID49IHByb2JhYmlsaXR5ICkge1xyXG4gICAgICAgICAgdGhpcy5waG90b25zWyBqIF0uZGlzcG9zZSgpO1xyXG4gICAgICAgICAgdGhpcy5waG90b25zLnNwbGljZSggaiwgMSApOyAvLyByZW1vdmUganRoIHBob3RvbiBmcm9tIGxpc3RcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBpZiB0aGUgYmVhbSBpcyB3aGl0ZSwgbWFrZSBzdXJlIGl0IGlzIHRoZSBjb2xvciBvZiB0aGUgZmlsdGVyXHJcbiAgICAgICAgZWxzZSBpZiAoIHBob3Rvbi5pc1doaXRlICkge1xyXG4gICAgICAgICAgcGhvdG9uLmNvbG9yID0gVmlzaWJsZUNvbG9yLndhdmVsZW5ndGhUb0NvbG9yKCBmaWx0ZXJXYXZlbGVuZ3RoICk7XHJcbiAgICAgICAgICBwaG90b24uaXNXaGl0ZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBpZiB0aGUgcGhvdG9uIGlzIG5vdCB3aGl0ZVxyXG4gICAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIHNldCB0aGUgcGhvdG9uSW50ZW5zaXR5IHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBwZXJjZW50YWdlIHBhc3NpbmcgdGhyb3VnaCB0aGUgZmlsdGVyLFxyXG4gICAgICAgICAgLy8gZm9yIHVzZSB3aGVuIHNldHRpbmcgdGhlIHBlcmNlaXZlZCBjb2xvciB3aGVuIHRoZSBwaG90b24gaGl0cyB0aGUgZXllLlxyXG4gICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSBpbnRlbnNpdHkgaXMgYXQgbGVhc3QgMC4yLCBvdGhlcndpc2UgaXQgbG9va3MgdG9vIGJsYWNrIGluIHRoZSB2aWV3XHJcbiAgICAgICAgICBwaG90b24uaW50ZW5zaXR5ID0gaXNGaW5pdGUoIHByb2JhYmlsaXR5ICkgPyAoICggcHJvYmFiaWxpdHkgPCAwLjIgKSA/IDAuMiA6IHByb2JhYmlsaXR5ICkgOiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8ga2VlcCB0cmFjayBvZiBwaG90b25zIHdoaWNoIHBhc3MgdGhlIGZpbHRlclxyXG4gICAgICBpZiAoIHBob3Rvbi5wb3NpdGlvbi54IDwgdGhpcy5maWx0ZXJPZmZzZXQgKSB7XHJcbiAgICAgICAgcGhvdG9uLnBhc3NlZEZpbHRlciA9IHRydWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIG1vdmUgdGhlIHBob3RvbiB1bmxlc3MgaXQgZ29lcyBvdXQgb2YgYm91bmRzXHJcbiAgICAgIGlmICggbmV3WCA+IDAgJiYgbmV3WSA+IDAgJiYgbmV3WSA8IENvbG9yVmlzaW9uQ29uc3RhbnRzLkJFQU1fSEVJR0hUICkge1xyXG4gICAgICAgIHBob3Rvbi51cGRhdGVBbmltYXRpb25GcmFtZSggbmV3WCwgbmV3WSApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBpZiB0aGUgcGhvdG9uIGdvZXMgb3V0IG9mIGJvdW5kcywgdXBkYXRlIHRoZSBsYXN0UGhvdG9uQ29sb3IgUHJvcGVydHksIHdoaWNoIGlzIHVzZWQgaW4gZGV0ZXJtaW5pbmcgdGhlIHBlcmNlaXZlZCBjb2xvclxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgLy8gdGhlIHBlcmNlaXZlZCBjb2xvciwgYW5kIGluIHBhcnRpY3VsYXIgaXRzIGludGVuc2l0eSwgaXMgYmFzZWQgaW4gcGFydCBvbiB3aGV0aGVyIGl0IGlzIG9yIHdhcyB3aGl0ZVxyXG4gICAgICAgIGxldCBuZXdQZXJjZWl2ZWRDb2xvcjtcclxuICAgICAgICBpZiAoIHBob3Rvbi5pc1doaXRlICkge1xyXG4gICAgICAgICAgbmV3UGVyY2VpdmVkQ29sb3IgPSBDb2xvci5XSElURTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBpZiAoIHBob3Rvbi53YXNXaGl0ZSApIHtcclxuICAgICAgICAgICAgbmV3UGVyY2VpdmVkQ29sb3IgPSBwaG90b24uY29sb3I7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgbmV3UGVyY2VpdmVkQ29sb3IgPSBwaG90b24uY29sb3Iud2l0aEFscGhhKCBwaG90b24uaW50ZW5zaXR5ICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBkb24ndCB1cGRhdGUgdGhlIGxhc3RQaG90b25Db2xvciB1bmxlc3MgaXQgaXMgZGlmZmVyZW50IHRoYW4gYmVmb3JlLCBmb3IgcGVyZm9ybWFuY2UgcmVhc29uc1xyXG4gICAgICAgIC8vIGFuZCBkb24ndCBib3RoZXIgdG8gdXBkYXRlIHRoZSBjb2xvciBpZiB0aGUgdmlldyBpcyBvbiBiZWFtIG1vZGVcclxuICAgICAgICBpZiAoICF0aGlzLm1vZGVsLmxhc3RQaG90b25Db2xvclByb3BlcnR5LnZhbHVlLmVxdWFscyggbmV3UGVyY2VpdmVkQ29sb3IgKSAmJiB0aGlzLm1vZGVsLmJlYW1UeXBlUHJvcGVydHkudmFsdWUgPT09ICdwaG90b24nICkge1xyXG5cclxuICAgICAgICAgIC8vIGlmIHRoZSBwaG90b24gd2FzIHdoaXRlLCB0aGUgcGVyY2VpdmVkIGNvbG9yIGtlZXBzIGZ1bGwgaW50ZW5zaXR5IGV2ZW4gd2hlbiBpdCBwYXNzZXMgdGhlIGZpbHRlcixcclxuICAgICAgICAgIC8vIG90aGVyd2lzZSBpdCB0YWtlcyB0aGUgaW50ZW5zaXR5IG9mIHRoZSBwaG90b24sIHdoaWNoIG1heSBoYXZlIGJlZW4gcGFydGlhbGx5IGZpbHRlcmVkXHJcbiAgICAgICAgICB0aGlzLm1vZGVsLmxhc3RQaG90b25Db2xvclByb3BlcnR5LnZhbHVlID0gKCBwaG90b24ud2FzV2hpdGUgKSA/IG5ld1BlcmNlaXZlZENvbG9yLndpdGhBbHBoYSggMSApIDogbmV3UGVyY2VpdmVkQ29sb3I7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnBob3RvbnNbIGogXS5kaXNwb3NlKCk7XHJcbiAgICAgICAgdGhpcy5waG90b25zLnNwbGljZSggaiwgMSApOyAvLyByZW1vdmUganRoIHBob3RvbiBmcm9tIGxpc3RcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGVtaXQgYSBibGFjayBwaG90b24gZm9yIHJlc2V0dGluZyB0aGUgcGVyY2VpdmVkIGNvbG9yIHRvIGJsYWNrIGlmIG5vIG1vcmUgcGhvdG9ucyBwYXNzaW5nIHRocm91Z2ggdGhlIGZpbHRlci5cclxuICAgIC8vIHRoaXMgdGFrZXMgY2FyZSBvZiB0aGUgY2FzZSB3aGVuIG5vIHBob3RvbnMgcGFzcyB0aHJvdWdoIHRoZSBmaWx0ZXJcclxuICAgIGlmICggcHJvYmFiaWxpdHkgPT09IDAgJiYgdGhpcy5tb2RlbC5maWx0ZXJWaXNpYmxlUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgIGNvbnN0IGJsYWNrUGhvdG9uID0gbmV3IFNpbmdsZUJ1bGJQaG90b24oXHJcbiAgICAgICAgbmV3IFZlY3RvcjIoIHRoaXMuZmlsdGVyT2Zmc2V0LCBDb2xvclZpc2lvbkNvbnN0YW50cy5CRUFNX0hFSUdIVCAvIDIgKSxcclxuICAgICAgICBuZXcgVmVjdG9yMiggQ29sb3JWaXNpb25Db25zdGFudHMuWF9WRUxPQ0lUWSwgMCApLFxyXG4gICAgICAgIDEsXHJcbiAgICAgICAgQkxBQ0tfQUxQSEFfMCxcclxuICAgICAgICBmYWxzZSxcclxuICAgICAgICB1bmRlZmluZWRcclxuICAgICAgKTtcclxuICAgICAgYmxhY2tQaG90b24ucGFzc2VkRmlsdGVyID0gdHJ1ZTtcclxuICAgICAgdGhpcy5waG90b25zLnB1c2goIGJsYWNrUGhvdG9uICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZW1pdCBhIGJsYWNrIHBob3RvbiBmb3IgcmVzZXR0aW5nIHRoZSBwZXJjZWl2ZWQgY29sb3IgdG8gYmxhY2sgaWYgdGhlIGZsYXNobGlnaHQgaXMgb2ZmXHJcbiAgICBpZiAoICF0aGlzLm1vZGVsLmZsYXNobGlnaHRPblByb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICB0aGlzLnBob3RvbnMucHVzaCggbmV3IFNpbmdsZUJ1bGJQaG90b24oXHJcbiAgICAgICAgbmV3IFZlY3RvcjIoIHRoaXMuYmVhbUxlbmd0aCwgQ29sb3JWaXNpb25Db25zdGFudHMuQkVBTV9IRUlHSFQgLyAyICksXHJcbiAgICAgICAgbmV3IFZlY3RvcjIoIENvbG9yVmlzaW9uQ29uc3RhbnRzLlhfVkVMT0NJVFksIDAgKSxcclxuICAgICAgICAxLFxyXG4gICAgICAgIEJMQUNLX0FMUEhBXzAsXHJcbiAgICAgICAgZmFsc2UsXHJcbiAgICAgICAgdW5kZWZpbmVkXHJcbiAgICAgICkgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICBjcmVhdGVQaG90b24oIHRpbWVFbGFwc2VkICkge1xyXG5cclxuICAgIC8vIGlmIHRoZSBmbGFzaGxpZ2h0IGlzIG9uLCBjcmVhdGUgYSBuZXcgcGhvdG9uIHRoaXMgYW5pbWF0aW9uIGZyYW1lXHJcbiAgICBpZiAoIHRoaXMubW9kZWwuZmxhc2hsaWdodE9uUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgIGNvbnN0IG5ld0NvbG9yID0gKCB0aGlzLm1vZGVsLmxpZ2h0VHlwZVByb3BlcnR5LnZhbHVlID09PSAnd2hpdGUnICkgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbVZpc2libGVDb2xvcigpIDpcclxuICAgICAgICAgICAgICAgICAgICAgICBWaXNpYmxlQ29sb3Iud2F2ZWxlbmd0aFRvQ29sb3IoIHRoaXMubW9kZWwuZmxhc2hsaWdodFdhdmVsZW5ndGhQcm9wZXJ0eS52YWx1ZSApO1xyXG5cclxuICAgICAgY29uc3QgeCA9IHRoaXMuYmVhbUxlbmd0aCArIENvbG9yVmlzaW9uQ29uc3RhbnRzLlhfVkVMT0NJVFkgKiB0aW1lRWxhcHNlZDtcclxuICAgICAgY29uc3QgeVZlbG9jaXR5ID0gKCBkb3RSYW5kb20ubmV4dERvdWJsZSgpICogQ29sb3JWaXNpb25Db25zdGFudHMuRkFOX0ZBQ1RPUiAtICggQ29sb3JWaXNpb25Db25zdGFudHMuRkFOX0ZBQ1RPUiAvIDIgKSApICogNjA7XHJcblxyXG4gICAgICBjb25zdCBpbml0aWFsWSA9IHlWZWxvY2l0eSAqICggMjUgLyA2MCApICsgKCBDb2xvclZpc2lvbkNvbnN0YW50cy5CRUFNX0hFSUdIVCAvIDIgKTtcclxuICAgICAgY29uc3QgZGVsdGFZID0geVZlbG9jaXR5ICogdGltZUVsYXBzZWQ7XHJcbiAgICAgIGNvbnN0IHkgPSBpbml0aWFsWSArIGRlbHRhWTtcclxuXHJcbiAgICAgIHRoaXMucGhvdG9ucy5wdXNoKCBuZXcgU2luZ2xlQnVsYlBob3RvbihcclxuICAgICAgICBuZXcgVmVjdG9yMiggeCwgeSApLFxyXG4gICAgICAgIG5ldyBWZWN0b3IyKCBDb2xvclZpc2lvbkNvbnN0YW50cy5YX1ZFTE9DSVRZLCB5VmVsb2NpdHkgKSxcclxuICAgICAgICAxLFxyXG4gICAgICAgIG5ld0NvbG9yLFxyXG4gICAgICAgIHRoaXMubW9kZWwubGlnaHRUeXBlUHJvcGVydHkudmFsdWUgPT09ICd3aGl0ZScsXHJcbiAgICAgICAgdGhpcy5tb2RlbC5mbGFzaGxpZ2h0V2F2ZWxlbmd0aFByb3BlcnR5LnZhbHVlXHJcbiAgICAgICkgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICByZXNldCgpIHtcclxuICAgIC8vIHNldCBhbGwgcGhvdG9ucyB0byBiZSBvdXQgb2YgYm91bmRzIHRvIHRyaWdnZXIgZW1wdHkgcmVkcmF3XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnBob3RvbnMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHRoaXMucGhvdG9uc1sgaSBdLnBvc2l0aW9uLnggPSAwO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIEdldHMgYSByYW5kb20gdmlzaWJsZSBDb2xvci4gVGhpcyBpcyB1c2VkIHRvIGdlbmVyYXRlIHJhbmRvbSBwaG90b24gY29sb3JzIHdoZW4gdGhlIGxpZ2h0IHNvdXJjZSBpcyB3aGl0ZSBsaWdodC5cclxuICogQHJldHVybnMge0NvbG9yfVxyXG4gKi9cclxuZnVuY3Rpb24gcmFuZG9tVmlzaWJsZUNvbG9yKCkge1xyXG4gIGNvbnN0IHJhbmRvbVdhdmVsZW5ndGggPSBkb3RSYW5kb20ubmV4dEludEJldHdlZW4oIFZpc2libGVDb2xvci5NSU5fV0FWRUxFTkdUSCwgVmlzaWJsZUNvbG9yLk1BWF9XQVZFTEVOR1RIICk7XHJcbiAgcmV0dXJuIFZpc2libGVDb2xvci53YXZlbGVuZ3RoVG9Db2xvciggcmFuZG9tV2F2ZWxlbmd0aCApO1xyXG59XHJcblxyXG5TaW5nbGVCdWxiUGhvdG9uQmVhbS5TaW5nbGVCdWxiUGhvdG9uQmVhbUlPID0gbmV3IElPVHlwZSggJ1NpbmdsZUJ1bGJQaG90b25CZWFtSU8nLCB7XHJcbiAgdmFsdWVUeXBlOiBTaW5nbGVCdWxiUGhvdG9uQmVhbSxcclxuICBkb2N1bWVudGF0aW9uOiAnVGhlIEJlYW0gb24gdGhlIHNpbmdsZSBidWxiIHNjcmVlbi4nXHJcbn0gKTtcclxuXHJcbmNvbG9yVmlzaW9uLnJlZ2lzdGVyKCAnU2luZ2xlQnVsYlBob3RvbkJlYW0nLCBTaW5nbGVCdWxiUGhvdG9uQmVhbSApO1xyXG5leHBvcnQgZGVmYXVsdCBTaW5nbGVCdWxiUGhvdG9uQmVhbTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLE9BQU8sTUFBTSxnQ0FBZ0M7QUFDcEQsT0FBT0MsU0FBUyxNQUFNLGlDQUFpQztBQUN2RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsT0FBT0MsWUFBWSxNQUFNLDZDQUE2QztBQUN0RSxTQUFTQyxLQUFLLFFBQVEs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