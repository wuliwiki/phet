// Copyright 2022, University of Colorado Boulder

/**
 * PerceivedColorSoundGenerator generates a sound that indicates the color that is being perceived by the person in the
 * model.  It mixes together sounds that correspond to the red, green, and blue levels that are being perceived.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

// TODO: There are a number of build- or run-time options in this file for different sounds.  They exists to support
//       comparisons between different options in the sound design, and should be removed once the design is finalized.
//       see https://github.com/phetsims/color-vision/issues/139.

import Range from '../../../../dot/js/Range.js';
import Utils from '../../../../dot/js/Utils.js';
import SoundClip from '../../../../tambo/js/sound-generators/SoundClip.js';
import SoundGenerator from '../../../../tambo/js/sound-generators/SoundGenerator.js';
import colorVisionHighAmbienceV2_mp3 from '../../../sounds/colorVisionHighAmbienceV2_mp3.js';
import colorVisionIndividualNotesChord01_mp3 from '../../../sounds/colorVisionIndividualNotesChord01_mp3.js';
import colorVisionIndividualNotesChord02_mp3 from '../../../sounds/colorVisionIndividualNotesChord02_mp3.js';
import colorVisionIndividualNotesChord03_mp3 from '../../../sounds/colorVisionIndividualNotesChord03_mp3.js';
import colorVisionIndividualNotesOctave01_mp3 from '../../../sounds/colorVisionIndividualNotesOctave01_mp3.js';
import colorVisionIndividualNotesOctave02_mp3 from '../../../sounds/colorVisionIndividualNotesOctave02_mp3.js';
import colorVisionIndividualNotesOctave03_mp3 from '../../../sounds/colorVisionIndividualNotesOctave03_mp3.js';
import colorVisionLowAmbienceV2_mp3 from '../../../sounds/colorVisionLowAmbienceV2_mp3.js';
import colorVisionMidAmbienceV2_mp3 from '../../../sounds/colorVisionMidAmbienceV2_mp3.js';
import colorVision from '../../colorVision.js';

// constants
const CONSTITUENT_SOUND_CLIP_OPTIONS = {
  loop: true
};
const SOUND_SETS = [[colorVisionIndividualNotesChord01_mp3, colorVisionIndividualNotesChord02_mp3, colorVisionIndividualNotesChord03_mp3], [colorVisionIndividualNotesOctave01_mp3, colorVisionIndividualNotesOctave02_mp3, colorVisionIndividualNotesOctave03_mp3], [colorVisionLowAmbienceV2_mp3, colorVisionMidAmbienceV2_mp3, colorVisionHighAmbienceV2_mp3]];
const SOUND_SET = SOUND_SETS[0];
const USE_FILTERS = true;
const LOW_FILTER_RANGE = new Range(200, 2000);
const MID_FILTER_RANGE = new Range(200, 4000);
const HIGH_FILTER_RANGE = new Range(300, 8000);
class PerceivedColorSoundGenerator extends SoundGenerator {
  /**
   * @param {Property.<Color>} perceivedColorProperty
   * @param {SoundGeneratorOptions} [options]
   */
  constructor(perceivedColorProperty, options) {
    super(options);

    // Create sound clips for the three light ranges, i.e. R, G, and B.
    const lowRangeSoundClip = new SoundClip(SOUND_SET[0], CONSTITUENT_SOUND_CLIP_OPTIONS);
    const midRangeSoundClip = new SoundClip(SOUND_SET[1], CONSTITUENT_SOUND_CLIP_OPTIONS);
    const highRangeSoundClip = new SoundClip(SOUND_SET[2], CONSTITUENT_SOUND_CLIP_OPTIONS);

    // Create the filters that will be used to alter the source sounds if they are turned on.
    let lowFilter = null;
    let midFilter = null;
    let highFilter = null;
    if (USE_FILTERS) {
      const now = this.audioContext.currentTime;
      lowFilter = this.audioContext.createBiquadFilter();
      lowFilter.type = 'lowpass';
      lowFilter.frequency.setValueAtTime(LOW_FILTER_RANGE.min, now);
      midFilter = this.audioContext.createBiquadFilter();
      midFilter.type = 'lowpass';
      midFilter.frequency.setValueAtTime(MID_FILTER_RANGE.min, now);
      highFilter = this.audioContext.createBiquadFilter();
      highFilter.type = 'lowpass';
      highFilter.frequency.setValueAtTime(HIGH_FILTER_RANGE.min, now);

      // Wire up the audio path.
      lowRangeSoundClip.connect(lowFilter);
      lowFilter.connect(this.masterGainNode);
      midRangeSoundClip.connect(midFilter);
      midFilter.connect(this.masterGainNode);
      highRangeSoundClip.connect(highFilter);
      highFilter.connect(this.masterGainNode);
    } else {
      lowRangeSoundClip.connect(this.masterGainNode);
      midRangeSoundClip.connect(this.masterGainNode);
      highRangeSoundClip.connect(this.masterGainNode);
    }

    // Adjust the audio based on the perceived color.  This may lead to changes in volume or filter frequencies.
    perceivedColorProperty.link(perceivedColor => {
      if (USE_FILTERS) {
        adjustAudio(perceivedColor.r, perceivedColor.a, lowRangeSoundClip, lowFilter, LOW_FILTER_RANGE);
        adjustAudio(perceivedColor.g, perceivedColor.a, midRangeSoundClip, midFilter, MID_FILTER_RANGE);
        adjustAudio(perceivedColor.b, perceivedColor.a, highRangeSoundClip, highFilter, HIGH_FILTER_RANGE);
      } else {
        adjustSoundLevel(perceivedColor.r, perceivedColor.a, lowRangeSoundClip);
        adjustSoundLevel(perceivedColor.g, perceivedColor.a, midRangeSoundClip);
        adjustSoundLevel(perceivedColor.b, perceivedColor.a, highRangeSoundClip);
      }
    });
  }
}

// helper function to adjust output level, created to avoid code duplication
const adjustSoundLevel = (colorLevel, alpha, soundClip) => {
  const normalizedColorLevel = Utils.clamp(colorLevel * alpha / 255, 0, 1);
  if (normalizedColorLevel === 0 && soundClip.isPlaying) {
    soundClip.stop();
  } else if (normalizedColorLevel > 0 && !soundClip.isPlaying) {
    soundClip.play();
  }
  soundClip.setOutputLevel(normalizedColorLevel);
};

// helper function to adjust filter cutoff frequency and sound clip output level, created to avoid code duplication
const adjustAudio = (colorLevel, alpha, soundClip, filter, filterRange) => {
  const normalizedColorLevel = Utils.clamp(colorLevel * alpha / 255, 0, 1);
  if (normalizedColorLevel === 0 && soundClip.isPlaying) {
    soundClip.stop();
  } else if (normalizedColorLevel > 0 && !soundClip.isPlaying) {
    soundClip.play();
  }
  filter.frequency.setValueAtTime(filterRange.expandNormalizedValue(Math.pow(normalizedColorLevel, 4)), 0);
};
colorVision.register('PerceivedColorSoundGenerator', PerceivedColorSoundGenerator);
export default PerceivedColorSoundGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSYW5nZSIsIlV0aWxzIiwiU291bmRDbGlwIiwiU291bmRHZW5lcmF0b3IiLCJjb2xvclZpc2lvbkhpZ2hBbWJpZW5jZVYyX21wMyIsImNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwMV9tcDMiLCJjb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc0Nob3JkMDJfbXAzIiwiY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNDaG9yZDAzX21wMyIsImNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzT2N0YXZlMDFfbXAzIiwiY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNPY3RhdmUwMl9tcDMiLCJjb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc09jdGF2ZTAzX21wMyIsImNvbG9yVmlzaW9uTG93QW1iaWVuY2VWMl9tcDMiLCJjb2xvclZpc2lvbk1pZEFtYmllbmNlVjJfbXAzIiwiY29sb3JWaXNpb24iLCJDT05TVElUVUVOVF9TT1VORF9DTElQX09QVElPTlMiLCJsb29wIiwiU09VTkRfU0VUUyIsIlNPVU5EX1NFVCIsIlVTRV9GSUxURVJTIiwiTE9XX0ZJTFRFUl9SQU5HRSIsIk1JRF9GSUxURVJfUkFOR0UiLCJISUdIX0ZJTFRFUl9SQU5HRSIsIlBlcmNlaXZlZENvbG9yU291bmRHZW5lcmF0b3IiLCJjb25zdHJ1Y3RvciIsInBlcmNlaXZlZENvbG9yUHJvcGVydHkiLCJvcHRpb25zIiwibG93UmFuZ2VTb3VuZENsaXAiLCJtaWRSYW5nZVNvdW5kQ2xpcCIsImhpZ2hSYW5nZVNvdW5kQ2xpcCIsImxvd0ZpbHRlciIsIm1pZEZpbHRlciIsImhpZ2hGaWx0ZXIiLCJub3ciLCJhdWRpb0NvbnRleHQiLCJjdXJyZW50VGltZSIsImNyZWF0ZUJpcXVhZEZpbHRlciIsInR5cGUiLCJmcmVxdWVuY3kiLCJzZXRWYWx1ZUF0VGltZSIsIm1pbiIsImNvbm5lY3QiLCJtYXN0ZXJHYWluTm9kZSIsImxpbmsiLCJwZXJjZWl2ZWRDb2xvciIsImFkanVzdEF1ZGlvIiwiciIsImEiLCJnIiwiYiIsImFkanVzdFNvdW5kTGV2ZWwiLCJjb2xvckxldmVsIiwiYWxwaGEiLCJzb3VuZENsaXAiLCJub3JtYWxpemVkQ29sb3JMZXZlbCIsImNsYW1wIiwiaXNQbGF5aW5nIiwic3RvcCIsInBsYXkiLCJzZXRPdXRwdXRMZXZlbCIsImZpbHRlciIsImZpbHRlclJhbmdlIiwiZXhwYW5kTm9ybWFsaXplZFZhbHVlIiwiTWF0aCIsInBvdyIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUGVyY2VpdmVkQ29sb3JTb3VuZEdlbmVyYXRvci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogUGVyY2VpdmVkQ29sb3JTb3VuZEdlbmVyYXRvciBnZW5lcmF0ZXMgYSBzb3VuZCB0aGF0IGluZGljYXRlcyB0aGUgY29sb3IgdGhhdCBpcyBiZWluZyBwZXJjZWl2ZWQgYnkgdGhlIHBlcnNvbiBpbiB0aGVcclxuICogbW9kZWwuICBJdCBtaXhlcyB0b2dldGhlciBzb3VuZHMgdGhhdCBjb3JyZXNwb25kIHRvIHRoZSByZWQsIGdyZWVuLCBhbmQgYmx1ZSBsZXZlbHMgdGhhdCBhcmUgYmVpbmcgcGVyY2VpdmVkLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbi8vIFRPRE86IFRoZXJlIGFyZSBhIG51bWJlciBvZiBidWlsZC0gb3IgcnVuLXRpbWUgb3B0aW9ucyBpbiB0aGlzIGZpbGUgZm9yIGRpZmZlcmVudCBzb3VuZHMuICBUaGV5IGV4aXN0cyB0byBzdXBwb3J0XHJcbi8vICAgICAgIGNvbXBhcmlzb25zIGJldHdlZW4gZGlmZmVyZW50IG9wdGlvbnMgaW4gdGhlIHNvdW5kIGRlc2lnbiwgYW5kIHNob3VsZCBiZSByZW1vdmVkIG9uY2UgdGhlIGRlc2lnbiBpcyBmaW5hbGl6ZWQuXHJcbi8vICAgICAgIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY29sb3ItdmlzaW9uL2lzc3Vlcy8xMzkuXHJcblxyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBTb3VuZENsaXAgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvc291bmQtZ2VuZXJhdG9ycy9Tb3VuZENsaXAuanMnO1xyXG5pbXBvcnQgU291bmRHZW5lcmF0b3IgZnJvbSAnLi4vLi4vLi4vLi4vdGFtYm8vanMvc291bmQtZ2VuZXJhdG9ycy9Tb3VuZEdlbmVyYXRvci5qcyc7XHJcbmltcG9ydCBjb2xvclZpc2lvbkhpZ2hBbWJpZW5jZVYyX21wMyBmcm9tICcuLi8uLi8uLi9zb3VuZHMvY29sb3JWaXNpb25IaWdoQW1iaWVuY2VWMl9tcDMuanMnO1xyXG5pbXBvcnQgY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNDaG9yZDAxX21wMyBmcm9tICcuLi8uLi8uLi9zb3VuZHMvY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNDaG9yZDAxX21wMy5qcyc7XHJcbmltcG9ydCBjb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc0Nob3JkMDJfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9jb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc0Nob3JkMDJfbXAzLmpzJztcclxuaW1wb3J0IGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwM19tcDMgZnJvbSAnLi4vLi4vLi4vc291bmRzL2NvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwM19tcDMuanMnO1xyXG5pbXBvcnQgY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNPY3RhdmUwMV9tcDMgZnJvbSAnLi4vLi4vLi4vc291bmRzL2NvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzT2N0YXZlMDFfbXAzLmpzJztcclxuaW1wb3J0IGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzT2N0YXZlMDJfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9jb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc09jdGF2ZTAyX21wMy5qcyc7XHJcbmltcG9ydCBjb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc09jdGF2ZTAzX21wMyBmcm9tICcuLi8uLi8uLi9zb3VuZHMvY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNPY3RhdmUwM19tcDMuanMnO1xyXG5pbXBvcnQgY29sb3JWaXNpb25Mb3dBbWJpZW5jZVYyX21wMyBmcm9tICcuLi8uLi8uLi9zb3VuZHMvY29sb3JWaXNpb25Mb3dBbWJpZW5jZVYyX21wMy5qcyc7XHJcbmltcG9ydCBjb2xvclZpc2lvbk1pZEFtYmllbmNlVjJfbXAzIGZyb20gJy4uLy4uLy4uL3NvdW5kcy9jb2xvclZpc2lvbk1pZEFtYmllbmNlVjJfbXAzLmpzJztcclxuaW1wb3J0IGNvbG9yVmlzaW9uIGZyb20gJy4uLy4uL2NvbG9yVmlzaW9uLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBDT05TVElUVUVOVF9TT1VORF9DTElQX09QVElPTlMgPSB7XHJcbiAgbG9vcDogdHJ1ZVxyXG59O1xyXG5cclxuY29uc3QgU09VTkRfU0VUUyA9IFtcclxuICBbIGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwMV9tcDMsIGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwMl9tcDMsIGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzQ2hvcmQwM19tcDMgXSxcclxuICBbIGNvbG9yVmlzaW9uSW5kaXZpZHVhbE5vdGVzT2N0YXZlMDFfbXAzLCBjb2xvclZpc2lvbkluZGl2aWR1YWxOb3Rlc09jdGF2ZTAyX21wMywgY29sb3JWaXNpb25JbmRpdmlkdWFsTm90ZXNPY3RhdmUwM19tcDMgXSxcclxuICBbIGNvbG9yVmlzaW9uTG93QW1iaWVuY2VWMl9tcDMsIGNvbG9yVmlzaW9uTWlkQW1iaWVuY2VWMl9tcDMsIGNvbG9yVmlzaW9uSGlnaEFtYmllbmNlVjJfbXAzIF1cclxuXTtcclxuXHJcbmNvbnN0IFNPVU5EX1NFVCA9IFNPVU5EX1NFVFNbIDAgXTtcclxuXHJcbmNvbnN0IFVTRV9GSUxURVJTID0gdHJ1ZTtcclxuXHJcbmNvbnN0IExPV19GSUxURVJfUkFOR0UgPSBuZXcgUmFuZ2UoIDIwMCwgMjAwMCApO1xyXG5jb25zdCBNSURfRklMVEVSX1JBTkdFID0gbmV3IFJhbmdlKCAyMDAsIDQwMDAgKTtcclxuY29uc3QgSElHSF9GSUxURVJfUkFOR0UgPSBuZXcgUmFuZ2UoIDMwMCwgODAwMCApO1xyXG5cclxuY2xhc3MgUGVyY2VpdmVkQ29sb3JTb3VuZEdlbmVyYXRvciBleHRlbmRzIFNvdW5kR2VuZXJhdG9yIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Q29sb3I+fSBwZXJjZWl2ZWRDb2xvclByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtTb3VuZEdlbmVyYXRvck9wdGlvbnN9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBwZXJjZWl2ZWRDb2xvclByb3BlcnR5LCBvcHRpb25zICkge1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHNvdW5kIGNsaXBzIGZvciB0aGUgdGhyZWUgbGlnaHQgcmFuZ2VzLCBpLmUuIFIsIEcsIGFuZCBCLlxyXG4gICAgY29uc3QgbG93UmFuZ2VTb3VuZENsaXAgPSBuZXcgU291bmRDbGlwKCBTT1VORF9TRVRbIDAgXSwgQ09OU1RJVFVFTlRfU09VTkRfQ0xJUF9PUFRJT05TICk7XHJcbiAgICBjb25zdCBtaWRSYW5nZVNvdW5kQ2xpcCA9IG5ldyBTb3VuZENsaXAoIFNPVU5EX1NFVFsgMSBdLCBDT05TVElUVUVOVF9TT1VORF9DTElQX09QVElPTlMgKTtcclxuICAgIGNvbnN0IGhpZ2hSYW5nZVNvdW5kQ2xpcCA9IG5ldyBTb3VuZENsaXAoIFNPVU5EX1NFVFsgMiBdLCBDT05TVElUVUVOVF9TT1VORF9DTElQX09QVElPTlMgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIGZpbHRlcnMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gYWx0ZXIgdGhlIHNvdXJjZSBzb3VuZHMgaWYgdGhleSBhcmUgdHVybmVkIG9uLlxyXG4gICAgbGV0IGxvd0ZpbHRlciA9IG51bGw7XHJcbiAgICBsZXQgbWlkRmlsdGVyID0gbnVsbDtcclxuICAgIGxldCBoaWdoRmlsdGVyID0gbnVsbDtcclxuICAgIGlmICggVVNFX0ZJTFRFUlMgKSB7XHJcbiAgICAgIGNvbnN0IG5vdyA9IHRoaXMuYXVkaW9Db250ZXh0LmN1cnJlbnRUaW1lO1xyXG4gICAgICBsb3dGaWx0ZXIgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVCaXF1YWRGaWx0ZXIoKTtcclxuICAgICAgbG93RmlsdGVyLnR5cGUgPSAnbG93cGFzcyc7XHJcbiAgICAgIGxvd0ZpbHRlci5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoIExPV19GSUxURVJfUkFOR0UubWluLCBub3cgKTtcclxuICAgICAgbWlkRmlsdGVyID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQmlxdWFkRmlsdGVyKCk7XHJcbiAgICAgIG1pZEZpbHRlci50eXBlID0gJ2xvd3Bhc3MnO1xyXG4gICAgICBtaWRGaWx0ZXIuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKCBNSURfRklMVEVSX1JBTkdFLm1pbiwgbm93ICk7XHJcbiAgICAgIGhpZ2hGaWx0ZXIgPSB0aGlzLmF1ZGlvQ29udGV4dC5jcmVhdGVCaXF1YWRGaWx0ZXIoKTtcclxuICAgICAgaGlnaEZpbHRlci50eXBlID0gJ2xvd3Bhc3MnO1xyXG4gICAgICBoaWdoRmlsdGVyLmZyZXF1ZW5jeS5zZXRWYWx1ZUF0VGltZSggSElHSF9GSUxURVJfUkFOR0UubWluLCBub3cgKTtcclxuXHJcbiAgICAgIC8vIFdpcmUgdXAgdGhlIGF1ZGlvIHBhdGguXHJcbiAgICAgIGxvd1JhbmdlU291bmRDbGlwLmNvbm5lY3QoIGxvd0ZpbHRlciApO1xyXG4gICAgICBsb3dGaWx0ZXIuY29ubmVjdCggdGhpcy5tYXN0ZXJHYWluTm9kZSApO1xyXG4gICAgICBtaWRSYW5nZVNvdW5kQ2xpcC5jb25uZWN0KCBtaWRGaWx0ZXIgKTtcclxuICAgICAgbWlkRmlsdGVyLmNvbm5lY3QoIHRoaXMubWFzdGVyR2Fpbk5vZGUgKTtcclxuICAgICAgaGlnaFJhbmdlU291bmRDbGlwLmNvbm5lY3QoIGhpZ2hGaWx0ZXIgKTtcclxuICAgICAgaGlnaEZpbHRlci5jb25uZWN0KCB0aGlzLm1hc3RlckdhaW5Ob2RlICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgbG93UmFuZ2VTb3VuZENsaXAuY29ubmVjdCggdGhpcy5tYXN0ZXJHYWluTm9kZSApO1xyXG4gICAgICBtaWRSYW5nZVNvdW5kQ2xpcC5jb25uZWN0KCB0aGlzLm1hc3RlckdhaW5Ob2RlICk7XHJcbiAgICAgIGhpZ2hSYW5nZVNvdW5kQ2xpcC5jb25uZWN0KCB0aGlzLm1hc3RlckdhaW5Ob2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRqdXN0IHRoZSBhdWRpbyBiYXNlZCBvbiB0aGUgcGVyY2VpdmVkIGNvbG9yLiAgVGhpcyBtYXkgbGVhZCB0byBjaGFuZ2VzIGluIHZvbHVtZSBvciBmaWx0ZXIgZnJlcXVlbmNpZXMuXHJcbiAgICBwZXJjZWl2ZWRDb2xvclByb3BlcnR5LmxpbmsoIHBlcmNlaXZlZENvbG9yID0+IHtcclxuICAgICAgaWYgKCBVU0VfRklMVEVSUyApIHtcclxuICAgICAgICBhZGp1c3RBdWRpbyggcGVyY2VpdmVkQ29sb3IuciwgcGVyY2VpdmVkQ29sb3IuYSwgbG93UmFuZ2VTb3VuZENsaXAsIGxvd0ZpbHRlciwgTE9XX0ZJTFRFUl9SQU5HRSApO1xyXG4gICAgICAgIGFkanVzdEF1ZGlvKCBwZXJjZWl2ZWRDb2xvci5nLCBwZXJjZWl2ZWRDb2xvci5hLCBtaWRSYW5nZVNvdW5kQ2xpcCwgbWlkRmlsdGVyLCBNSURfRklMVEVSX1JBTkdFICk7XHJcbiAgICAgICAgYWRqdXN0QXVkaW8oIHBlcmNlaXZlZENvbG9yLmIsIHBlcmNlaXZlZENvbG9yLmEsIGhpZ2hSYW5nZVNvdW5kQ2xpcCwgaGlnaEZpbHRlciwgSElHSF9GSUxURVJfUkFOR0UgKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBhZGp1c3RTb3VuZExldmVsKCBwZXJjZWl2ZWRDb2xvci5yLCBwZXJjZWl2ZWRDb2xvci5hLCBsb3dSYW5nZVNvdW5kQ2xpcCApO1xyXG4gICAgICAgIGFkanVzdFNvdW5kTGV2ZWwoIHBlcmNlaXZlZENvbG9yLmcsIHBlcmNlaXZlZENvbG9yLmEsIG1pZFJhbmdlU291bmRDbGlwICk7XHJcbiAgICAgICAgYWRqdXN0U291bmRMZXZlbCggcGVyY2VpdmVkQ29sb3IuYiwgcGVyY2VpdmVkQ29sb3IuYSwgaGlnaFJhbmdlU291bmRDbGlwICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIGhlbHBlciBmdW5jdGlvbiB0byBhZGp1c3Qgb3V0cHV0IGxldmVsLCBjcmVhdGVkIHRvIGF2b2lkIGNvZGUgZHVwbGljYXRpb25cclxuY29uc3QgYWRqdXN0U291bmRMZXZlbCA9ICggY29sb3JMZXZlbCwgYWxwaGEsIHNvdW5kQ2xpcCApID0+IHtcclxuICBjb25zdCBub3JtYWxpemVkQ29sb3JMZXZlbCA9IFV0aWxzLmNsYW1wKCAoIGNvbG9yTGV2ZWwgKiBhbHBoYSApIC8gMjU1LCAwLCAxICk7XHJcbiAgaWYgKCBub3JtYWxpemVkQ29sb3JMZXZlbCA9PT0gMCAmJiBzb3VuZENsaXAuaXNQbGF5aW5nICkge1xyXG4gICAgc291bmRDbGlwLnN0b3AoKTtcclxuICB9XHJcbiAgZWxzZSBpZiAoIG5vcm1hbGl6ZWRDb2xvckxldmVsID4gMCAmJiAhc291bmRDbGlwLmlzUGxheWluZyApIHtcclxuICAgIHNvdW5kQ2xpcC5wbGF5KCk7XHJcbiAgfVxyXG4gIHNvdW5kQ2xpcC5zZXRPdXRwdXRMZXZlbCggbm9ybWFsaXplZENvbG9yTGV2ZWwgKTtcclxufTtcclxuXHJcbi8vIGhlbHBlciBmdW5jdGlvbiB0byBhZGp1c3QgZmlsdGVyIGN1dG9mZiBmcmVxdWVuY3kgYW5kIHNvdW5kIGNsaXAgb3V0cHV0IGxldmVsLCBjcmVhdGVkIHRvIGF2b2lkIGNvZGUgZHVwbGljYXRpb25cclxuY29uc3QgYWRqdXN0QXVkaW8gPSAoIGNvbG9yTGV2ZWwsIGFscGhhLCBzb3VuZENsaXAsIGZpbHRlciwgZmlsdGVyUmFuZ2UgKSA9PiB7XHJcbiAgY29uc3Qgbm9ybWFsaXplZENvbG9yTGV2ZWwgPSBVdGlscy5jbGFtcCggKCBjb2xvckxldmVsICogYWxwaGEgKSAvIDI1NSwgMCwgMSApO1xyXG4gIGlmICggbm9ybWFsaXplZENvbG9yTGV2ZWwgPT09IDAgJiYgc291bmRDbGlwLmlzUGxheWluZyApIHtcclxuICAgIHNvdW5kQ2xpcC5zdG9wKCk7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCBub3JtYWxpemVkQ29sb3JMZXZlbCA+IDAgJiYgIXNvdW5kQ2xpcC5pc1BsYXlpbmcgKSB7XHJcbiAgICBzb3VuZENsaXAucGxheSgpO1xyXG4gIH1cclxuICBmaWx0ZXIuZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKCBmaWx0ZXJSYW5nZS5leHBhbmROb3JtYWxpemVkVmFsdWUoIE1hdGgucG93KCBub3JtYWxpemVkQ29sb3JMZXZlbCwgNCApICksIDAgKTtcclxufTtcclxuXHJcbmNvbG9yVmlzaW9uLnJlZ2lzdGVyKCAnUGVyY2VpdmVkQ29sb3JTb3VuZEdlbmVyYXRvcicsIFBlcmNlaXZlZENvbG9yU291bmRHZW5lcmF0b3IgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFBlcmNlaXZlZENvbG9yU291bmRHZW5lcmF0b3I7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxP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