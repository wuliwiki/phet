// Copyright 2014-2021, University of Colorado Boulder

/**
 * Model of the photon beams used on the RGB screen, made of individual photon particles.
 *
 * @author Aaron Davis (PhET Interactive Simulations)
 */

import dotRandom from '../../../../dot/js/dotRandom.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import colorVision from '../../colorVision.js';
import ColorVisionConstants from '../../common/ColorVisionConstants.js';
import RGBPhoton from './RGBPhoton.js';
class RGBPhotonBeam {
  /**
   * @param {string} color an rgb string
   * @param {Property.<number>} intensityProperty the intensity property for this color from the model
   * @param {Property.<number>} perceivedIntensityProperty the perceived intensity property for this color from the model
   * @param {number} beamLength the length of the beam, used to calculate the starting x coordinate
   * @param {Tandem} tandem
   */
  constructor(color, intensityProperty, perceivedIntensityProperty, beamLength, tandem) {
    // @public
    this.photons = [];
    this.color = color;
    this.beamLength = beamLength;

    // @private
    this.intensityProperty = intensityProperty;
    this.perceivedIntensityProperty = perceivedIntensityProperty;
  }

  // @public
  updateAnimationFrame(dt) {
    // move all photons that are currently active
    for (let i = 0; i < this.photons.length; i++) {
      // calculate the new position of the photon in order to check whether will still be in bounds
      const newX = this.photons[i].position.x + dt * this.photons[i].velocity.x;
      const newY = this.photons[i].position.y + dt * this.photons[i].velocity.y;
      if (newX > 0 && newY > 0 && newY < ColorVisionConstants.BEAM_HEIGHT) {
        this.photons[i].updateAnimationFrame(newX, newY);
      } else {
        this.perceivedIntensityProperty.set(this.photons[i].intensity);
        this.photons.splice(i, 1); // remove jth RGBPhoton from list
      }
    }

    // emit a black photon for resetting the perceived color to black if no more photons are emitted this frame
    if (this.intensityProperty.get() === 0) {
      const blackPhoton = new RGBPhoton(new Vector2(this.beamLength, ColorVisionConstants.BEAM_HEIGHT / 2), new Vector2(ColorVisionConstants.X_VELOCITY, 0), 0);
      this.photons.push(blackPhoton);
    }
  }

  // @public
  createPhoton(timeElapsed) {
    const intensity = this.intensityProperty.get();

    // only create a new photon if intensity is greater than 0
    if (intensity > 0) {
      const x = this.beamLength + ColorVisionConstants.X_VELOCITY * timeElapsed;
      const yVelocity = (dotRandom.nextDouble() * ColorVisionConstants.FAN_FACTOR - ColorVisionConstants.FAN_FACTOR / 2) * 60;
      const initialY = yVelocity * (25 / 60) + ColorVisionConstants.BEAM_HEIGHT / 2;
      const deltaY = yVelocity * timeElapsed;
      const y = initialY + deltaY;
      this.photons.push(new RGBPhoton(new Vector2(x, y), new Vector2(ColorVisionConstants.X_VELOCITY, yVelocity), intensity));
    }
  }

  // @public
  reset() {
    // empty photon array
    while (this.photons.length) {
      this.photons.pop();
    }
  }
}
colorVision.register('RGBPhotonBeam', RGBPhotonBeam);
export default RGBPhotonBeam;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3RSYW5kb20iLCJWZWN0b3IyIiwiY29sb3JWaXNpb24iLCJDb2xvclZpc2lvbkNvbnN0YW50cyIsIlJHQlBob3RvbiIsIlJHQlBob3RvbkJlYW0iLCJjb25zdHJ1Y3RvciIsImNvbG9yIiwiaW50ZW5zaXR5UHJvcGVydHkiLCJwZXJjZWl2ZWRJbnRlbnNpdHlQcm9wZXJ0eSIsImJlYW1MZW5ndGgiLCJ0YW5kZW0iLCJwaG90b25zIiwidXBkYXRlQW5pbWF0aW9uRnJhbWUiLCJkdCIsImkiLCJsZW5ndGgiLCJuZXdYIiwicG9zaXRpb24iLCJ4IiwidmVsb2NpdHkiLCJuZXdZIiwieSIsIkJFQU1fSEVJR0hUIiwic2V0IiwiaW50ZW5zaXR5Iiwic3BsaWNlIiwiZ2V0IiwiYmxhY2tQaG90b24iLCJYX1ZFTE9DSVRZIiwicHVzaCIsImNyZWF0ZVBob3RvbiIsInRpbWVFbGFwc2VkIiwieVZlbG9jaXR5IiwibmV4dERvdWJsZSIsIkZBTl9GQUNUT1IiLCJpbml0aWFsWSIsImRlbHRhWSIsInJlc2V0IiwicG9wIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJSR0JQaG90b25CZWFtLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1vZGVsIG9mIHRoZSBwaG90b24gYmVhbXMgdXNlZCBvbiB0aGUgUkdCIHNjcmVlbiwgbWFkZSBvZiBpbmRpdmlkdWFsIHBob3RvbiBwYXJ0aWNsZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQWFyb24gRGF2aXMgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgY29sb3JWaXNpb24gZnJvbSAnLi4vLi4vY29sb3JWaXNpb24uanMnO1xyXG5pbXBvcnQgQ29sb3JWaXNpb25Db25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0NvbG9yVmlzaW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFJHQlBob3RvbiBmcm9tICcuL1JHQlBob3Rvbi5qcyc7XHJcblxyXG5jbGFzcyBSR0JQaG90b25CZWFtIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIGFuIHJnYiBzdHJpbmdcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5LjxudW1iZXI+fSBpbnRlbnNpdHlQcm9wZXJ0eSB0aGUgaW50ZW5zaXR5IHByb3BlcnR5IGZvciB0aGlzIGNvbG9yIGZyb20gdGhlIG1vZGVsXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48bnVtYmVyPn0gcGVyY2VpdmVkSW50ZW5zaXR5UHJvcGVydHkgdGhlIHBlcmNlaXZlZCBpbnRlbnNpdHkgcHJvcGVydHkgZm9yIHRoaXMgY29sb3IgZnJvbSB0aGUgbW9kZWxcclxuICAgKiBAcGFyYW0ge251bWJlcn0gYmVhbUxlbmd0aCB0aGUgbGVuZ3RoIG9mIHRoZSBiZWFtLCB1c2VkIHRvIGNhbGN1bGF0ZSB0aGUgc3RhcnRpbmcgeCBjb29yZGluYXRlXHJcbiAgICogQHBhcmFtIHtUYW5kZW19IHRhbmRlbVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBjb2xvciwgaW50ZW5zaXR5UHJvcGVydHksIHBlcmNlaXZlZEludGVuc2l0eVByb3BlcnR5LCBiZWFtTGVuZ3RoLCB0YW5kZW0gKSB7XHJcblxyXG4gICAgLy8gQHB1YmxpY1xyXG4gICAgdGhpcy5waG90b25zID0gW107XHJcbiAgICB0aGlzLmNvbG9yID0gY29sb3I7XHJcbiAgICB0aGlzLmJlYW1MZW5ndGggPSBiZWFtTGVuZ3RoO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLmludGVuc2l0eVByb3BlcnR5ID0gaW50ZW5zaXR5UHJvcGVydHk7XHJcbiAgICB0aGlzLnBlcmNlaXZlZEludGVuc2l0eVByb3BlcnR5ID0gcGVyY2VpdmVkSW50ZW5zaXR5UHJvcGVydHk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIHVwZGF0ZUFuaW1hdGlvbkZyYW1lKCBkdCApIHtcclxuXHJcbiAgICAvLyBtb3ZlIGFsbCBwaG90b25zIHRoYXQgYXJlIGN1cnJlbnRseSBhY3RpdmVcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucGhvdG9ucy5sZW5ndGg7IGkrKyApIHtcclxuXHJcbiAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgbmV3IHBvc2l0aW9uIG9mIHRoZSBwaG90b24gaW4gb3JkZXIgdG8gY2hlY2sgd2hldGhlciB3aWxsIHN0aWxsIGJlIGluIGJvdW5kc1xyXG4gICAgICBjb25zdCBuZXdYID0gdGhpcy5waG90b25zWyBpIF0ucG9zaXRpb24ueCArIGR0ICogdGhpcy5waG90b25zWyBpIF0udmVsb2NpdHkueDtcclxuICAgICAgY29uc3QgbmV3WSA9IHRoaXMucGhvdG9uc1sgaSBdLnBvc2l0aW9uLnkgKyBkdCAqIHRoaXMucGhvdG9uc1sgaSBdLnZlbG9jaXR5Lnk7XHJcblxyXG4gICAgICBpZiAoIG5ld1ggPiAwICYmIG5ld1kgPiAwICYmIG5ld1kgPCBDb2xvclZpc2lvbkNvbnN0YW50cy5CRUFNX0hFSUdIVCApIHtcclxuICAgICAgICB0aGlzLnBob3RvbnNbIGkgXS51cGRhdGVBbmltYXRpb25GcmFtZSggbmV3WCwgbmV3WSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMucGVyY2VpdmVkSW50ZW5zaXR5UHJvcGVydHkuc2V0KCB0aGlzLnBob3RvbnNbIGkgXS5pbnRlbnNpdHkgKTtcclxuICAgICAgICB0aGlzLnBob3RvbnMuc3BsaWNlKCBpLCAxICk7IC8vIHJlbW92ZSBqdGggUkdCUGhvdG9uIGZyb20gbGlzdFxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZW1pdCBhIGJsYWNrIHBob3RvbiBmb3IgcmVzZXR0aW5nIHRoZSBwZXJjZWl2ZWQgY29sb3IgdG8gYmxhY2sgaWYgbm8gbW9yZSBwaG90b25zIGFyZSBlbWl0dGVkIHRoaXMgZnJhbWVcclxuICAgIGlmICggdGhpcy5pbnRlbnNpdHlQcm9wZXJ0eS5nZXQoKSA9PT0gMCApIHtcclxuICAgICAgY29uc3QgYmxhY2tQaG90b24gPSBuZXcgUkdCUGhvdG9uKFxyXG4gICAgICAgIG5ldyBWZWN0b3IyKCB0aGlzLmJlYW1MZW5ndGgsIENvbG9yVmlzaW9uQ29uc3RhbnRzLkJFQU1fSEVJR0hUIC8gMiApLFxyXG4gICAgICAgIG5ldyBWZWN0b3IyKCBDb2xvclZpc2lvbkNvbnN0YW50cy5YX1ZFTE9DSVRZLCAwICksXHJcbiAgICAgICAgMFxyXG4gICAgICApO1xyXG4gICAgICB0aGlzLnBob3RvbnMucHVzaCggYmxhY2tQaG90b24gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICBjcmVhdGVQaG90b24oIHRpbWVFbGFwc2VkICkge1xyXG4gICAgY29uc3QgaW50ZW5zaXR5ID0gdGhpcy5pbnRlbnNpdHlQcm9wZXJ0eS5nZXQoKTtcclxuXHJcbiAgICAvLyBvbmx5IGNyZWF0ZSBhIG5ldyBwaG90b24gaWYgaW50ZW5zaXR5IGlzIGdyZWF0ZXIgdGhhbiAwXHJcbiAgICBpZiAoIGludGVuc2l0eSA+IDAgKSB7XHJcbiAgICAgIGNvbnN0IHggPSB0aGlzLmJlYW1MZW5ndGggKyBDb2xvclZpc2lvbkNvbnN0YW50cy5YX1ZFTE9DSVRZICogdGltZUVsYXBzZWQ7XHJcbiAgICAgIGNvbnN0IHlWZWxvY2l0eSA9ICggZG90UmFuZG9tLm5leHREb3VibGUoKSAqIENvbG9yVmlzaW9uQ29uc3RhbnRzLkZBTl9GQUNUT1IgLSAoIENvbG9yVmlzaW9uQ29uc3RhbnRzLkZBTl9GQUNUT1IgLyAyICkgKSAqIDYwO1xyXG5cclxuICAgICAgY29uc3QgaW5pdGlhbFkgPSB5VmVsb2NpdHkgKiAoIDI1IC8gNjAgKSArICggQ29sb3JWaXNpb25Db25zdGFudHMuQkVBTV9IRUlHSFQgLyAyICk7XHJcbiAgICAgIGNvbnN0IGRlbHRhWSA9IHlWZWxvY2l0eSAqIHRpbWVFbGFwc2VkO1xyXG4gICAgICBjb25zdCB5ID0gaW5pdGlhbFkgKyBkZWx0YVk7XHJcblxyXG4gICAgICB0aGlzLnBob3RvbnMucHVzaCggbmV3IFJHQlBob3RvbihcclxuICAgICAgICBuZXcgVmVjdG9yMiggeCwgeSApLFxyXG4gICAgICAgIG5ldyBWZWN0b3IyKCBDb2xvclZpc2lvbkNvbnN0YW50cy5YX1ZFTE9DSVRZLCB5VmVsb2NpdHkgKSxcclxuICAgICAgICBpbnRlbnNpdHkgKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIHJlc2V0KCkge1xyXG4gICAgLy8gZW1wdHkgcGhvdG9uIGFycmF5XHJcbiAgICB3aGlsZSAoIHRoaXMucGhvdG9ucy5sZW5ndGggKSB7XHJcbiAgICAgIHRoaXMucGhvdG9ucy5wb3AoKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNvbG9yVmlzaW9uLnJlZ2lzdGVyKCAnUkdCUGhvdG9uQmVhbScsIFJHQlBob3RvbkJlYW0gKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFJHQlBob3RvbkJlYW07XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0saUNBQWlDO0FBQ3ZELE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsV0FBVyxNQUFNLHNCQUFzQjtBQUM5QyxPQUFPQyxvQkFBb0IsTUFBTSxzQ0FBc0M7QUFDdkUsT0FBT0MsU0FBUyxNQUFNLGdCQUFnQjtBQUV0QyxNQUFNQyxhQUFhLENBQUM7RUFFbEI7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRUMsV0FBV0EsQ0FBRUMsS0FBSyxFQUFFQyxpQkFBaUIsRUFBRUMsMEJBQTBCLEVBQUVD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