// Copyright 2015-2023, University of Colorado Boulder

/**
 * Object pooling mixin, for cases where creating new objects is expensive, and we'd rather mark some objects as able
 * to be reused (i.e. 'in the pool'). This provides a pool of objects for each type it is invoked on. It allows for
 * getting "new" objects that can either be constructed OR pulled in from a pool, and requires that the objects are
 * essentially able to "re-run" the constructor. Then when putting the object back in the pool, references should be
 * released, so memory isn't leaked.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import extend from './extend.js';
import phetCore from './phetCore.js';
import optionize from './optionize.js';
/**
 * @deprecated - Please use Pool.ts instead as the new pooling pattern.
 */
const Poolable = {
  /**
   * Changes the given type (and its prototype) to support object pooling.
   */
  mixInto(type, providedOptions) {
    const options = optionize()({
      defaultArguments: [],
      initialize: type.prototype.initialize,
      maxSize: 100,
      initialSize: 0,
      useDefaultConstruction: false
    }, providedOptions);
    assert && assert(options.maxSize >= 0);
    assert && assert(options.initialSize >= 0);

    // The actual array we store things in. Always push/pop.
    const pool = [];
    let maxPoolSize = options.maxSize;

    // There is a madness to this craziness. We'd want to use the method noted at
    // https://stackoverflow.com/questions/1606797/use-of-apply-with-new-operator-is-this-possible, but the type is
    // not provided in the arguments array below. By calling bind on itself, we're able to get a version of bind that
    // inserts the constructor as the first argument of the .apply called later so we don't create garbage by having
    // to pack `arguments` into an array AND THEN concatenate it with a new first element (the type itself).
    const partialConstructor = Function.prototype.bind.bind(type, type);

    // Basically our type constructor, but with the default arguments included already.
    const DefaultConstructor = partialConstructor(...options.defaultArguments);
    const initialize = options.initialize;
    const useDefaultConstruction = options.useDefaultConstruction;
    const proto = type.prototype;
    extend(type, {
      /**
       * This should not be modified externally. In the future if desired, functions could be added to help
       * adding/removing poolable instances manually.
       */
      pool: pool,
      /**
       * Returns an object with arbitrary state (possibly constructed with the default arguments).
       */
      dirtyFromPool() {
        return pool.length ? pool.pop() : new DefaultConstructor();
      },
      /**
       * Returns an object that behaves as if it was constructed with the given arguments. May result in a new object
       * being created (if the pool is empty), or it may use the constructor to mutate an object from the pool.
       */
      createFromPool(...args) {
        let result;
        if (pool.length) {
          result = pool.pop();
          initialize.apply(result, args);
        } else if (useDefaultConstruction) {
          result = new DefaultConstructor();
          initialize.apply(result, args);
        } else {
          result = new (partialConstructor(...args))();
        }
        return result;
      },
      /**
       * Returns the current size of the pool.
       */
      get poolSize() {
        return pool.length;
      },
      /**
       * Sets the maximum pool size.
       */
      set maxPoolSize(value) {
        assert && assert(value === Number.POSITIVE_INFINITY || Number.isInteger(value) && value >= 0, 'maxPoolSize should be a non-negative integer or infinity');
        maxPoolSize = value;
      },
      /**
       * Returns the maximum pool size.
       */
      get maxPoolSize() {
        return maxPoolSize;
      }
    });
    extend(proto, {
      /**
       * Adds this object into the pool, so that it can be reused elsewhere. Generally when this is done, no other
       * references to the object should be held (since they should not be used at all).
       */
      freeToPool() {
        if (pool.length < maxPoolSize) {
          pool.push(this);
        }
      }
    });

    // Initialize the pool (if it should have objects)
    while (pool.length < options.initialSize) {
      pool.push(new DefaultConstructor());
    }
    return type;
  }
};
phetCore.register('Poolable', Poolable);
export default Poolable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHRlbmQiLCJwaGV0Q29yZSIsIm9wdGlvbml6ZSIsIlBvb2xhYmxlIiwibWl4SW50byIsInR5cGUiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZGVmYXVsdEFyZ3VtZW50cyIsImluaXRpYWxpemUiLCJwcm90b3R5cGUiLCJtYXhTaXplIiwiaW5pdGlhbFNpemUiLCJ1c2VEZWZhdWx0Q29uc3RydWN0aW9uIiwiYXNzZXJ0IiwicG9vbCIsIm1heFBvb2xTaXplIiwicGFydGlhbENvbnN0cnVjdG9yIiwiRnVuY3Rpb24iLCJiaW5kIiwiRGVmYXVsdENvbnN0cnVjdG9yIiwicHJvdG8iLCJkaXJ0eUZyb21Qb29sIiwibGVuZ3RoIiwicG9wIiwiY3JlYXRlRnJvbVBvb2wiLCJhcmdzIiwicmVzdWx0IiwiYXBwbHkiLCJwb29sU2l6ZSIsInZhbHVlIiwiTnVtYmVyIiwiUE9TSVRJVkVfSU5GSU5JVFkiLCJpc0ludGVnZXIiLCJmcmVlVG9Qb29sIiwicHVzaCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUG9vbGFibGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTUtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogT2JqZWN0IHBvb2xpbmcgbWl4aW4sIGZvciBjYXNlcyB3aGVyZSBjcmVhdGluZyBuZXcgb2JqZWN0cyBpcyBleHBlbnNpdmUsIGFuZCB3ZSdkIHJhdGhlciBtYXJrIHNvbWUgb2JqZWN0cyBhcyBhYmxlXHJcbiAqIHRvIGJlIHJldXNlZCAoaS5lLiAnaW4gdGhlIHBvb2wnKS4gVGhpcyBwcm92aWRlcyBhIHBvb2wgb2Ygb2JqZWN0cyBmb3IgZWFjaCB0eXBlIGl0IGlzIGludm9rZWQgb24uIEl0IGFsbG93cyBmb3JcclxuICogZ2V0dGluZyBcIm5ld1wiIG9iamVjdHMgdGhhdCBjYW4gZWl0aGVyIGJlIGNvbnN0cnVjdGVkIE9SIHB1bGxlZCBpbiBmcm9tIGEgcG9vbCwgYW5kIHJlcXVpcmVzIHRoYXQgdGhlIG9iamVjdHMgYXJlXHJcbiAqIGVzc2VudGlhbGx5IGFibGUgdG8gXCJyZS1ydW5cIiB0aGUgY29uc3RydWN0b3IuIFRoZW4gd2hlbiBwdXR0aW5nIHRoZSBvYmplY3QgYmFjayBpbiB0aGUgcG9vbCwgcmVmZXJlbmNlcyBzaG91bGQgYmVcclxuICogcmVsZWFzZWQsIHNvIG1lbW9yeSBpc24ndCBsZWFrZWQuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgQ29uc3RydWN0b3IgZnJvbSAnLi90eXBlcy9Db25zdHJ1Y3Rvci5qcyc7XHJcbmltcG9ydCBleHRlbmQgZnJvbSAnLi9leHRlbmQuanMnO1xyXG5pbXBvcnQgcGhldENvcmUgZnJvbSAnLi9waGV0Q29yZS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgSW50ZW50aW9uYWxBbnkgZnJvbSAnLi90eXBlcy9JbnRlbnRpb25hbEFueS5qcyc7XHJcblxyXG50eXBlIFBvb2xhYmxlT3B0aW9uczxUeXBlIGV4dGVuZHMgQ29uc3RydWN0b3I+ID0ge1xyXG4gIC8vIElmIGFuIG9iamVjdCBuZWVkcyB0byBiZSBjcmVhdGVkIHdpdGhvdXQgYSBkaXJlY3QgY2FsbCAoc2F5LCB0byBmaWxsIHRoZSBwb29sIGluaXRpYWxseSksIHRoZXNlIGFyZSB0aGUgYXJndW1lbnRzXHJcbiAgLy8gdGhhdCB3aWxsIGJlIHBhc3NlZCBpbnRvIHRoZSBjb25zdHJ1Y3RvclxyXG4gIGRlZmF1bHRBcmd1bWVudHM/OiBDb25zdHJ1Y3RvclBhcmFtZXRlcnM8VHlwZT47XHJcblxyXG4gIC8vIFRoZSBmdW5jdGlvbiB0byBjYWxsIG9uIHRoZSBvYmplY3RzIHRvIHJlaW5pdGlhbGl6ZSB0aGVtICh0aGF0IGlzIGVpdGhlciB0aGUgY29uc3RydWN0b3IsIG9yIGFjdHMgbGlrZSB0aGVcclxuICAvLyBjb25zdHJ1Y3RvcikuXHJcbiAgaW5pdGlhbGl6ZT86IFBvb2xhYmxlSW5pdGlhbGl6ZXI8VHlwZT47XHJcblxyXG4gIC8vIEEgbGltaXQgZm9yIHRoZSBwb29sIHNpemUgKHNvIHdlIGRvbid0IGxlYWsgbWVtb3J5IGJ5IGdyb3dpbmcgdGhlIHBvb2wgZmFzdGVyIHRoYW4gd2UgdGFrZSB0aGluZ3MgZnJvbSBpdCkuIENhbiBiZVxyXG4gIC8vIGN1c3RvbWl6ZWQgYnkgc2V0dGluZyBUeXBlLm1heFBvb2xTaXplXHJcbiAgbWF4U2l6ZT86IG51bWJlcjtcclxuXHJcbiAgLy8gVGhlIGluaXRpYWwgc2l6ZSBvZiB0aGUgcG9vbC4gVG8gZmlsbCBpdCwgb2JqZWN0cyB3aWxsIGJlIGNyZWF0ZWQgd2l0aCB0aGUgZGVmYXVsdCBhcmd1bWVudHMuXHJcbiAgaW5pdGlhbFNpemU/OiBudW1iZXI7XHJcblxyXG4gIC8vIElmIHRydWUsIHdoZW4gY29uc3RydWN0aW5nIHRoZSBkZWZhdWx0IGFyZ3VtZW50cyB3aWxsIGFsd2F5cyBiZSB1c2VkIChhbmQgdGhlbiBpbml0aWFsaXplZCB3aXRoIHRoZSBpbml0aWFsaXplcilcclxuICAvLyBpbnN0ZWFkIG9mIGp1c3QgcHJvdmlkaW5nIHRoZSBhcmd1bWVudHMgc3RyYWlnaHQgdG8gdGhlIGNvbnN0cnVjdG9yLlxyXG4gIHVzZURlZmF1bHRDb25zdHJ1Y3Rpb24/OiBib29sZWFuO1xyXG59O1xyXG50eXBlIFBvb2xhYmxlSW5zdGFuY2UgPSB7XHJcbiAgZnJlZVRvUG9vbCgpOiB2b2lkO1xyXG59O1xyXG50eXBlIFBvb2xhYmxlVmVyc2lvbjxUeXBlIGV4dGVuZHMgQ29uc3RydWN0b3I+ID0gSW5zdGFuY2VUeXBlPFR5cGU+ICYgUG9vbGFibGVJbnN0YW5jZTtcclxudHlwZSBQb29sYWJsZUluaXRpYWxpemVyPFR5cGUgZXh0ZW5kcyBDb25zdHJ1Y3Rvcj4gPSAoIC4uLmFyZ3M6IENvbnN0cnVjdG9yUGFyYW1ldGVyczxUeXBlPiApID0+IEludGVudGlvbmFsQW55O1xyXG50eXBlIFBvb2xhYmxlQ2xhc3M8VHlwZSBleHRlbmRzIENvbnN0cnVjdG9yPiA9ICggbmV3ICggLi4uYXJnczogQ29uc3RydWN0b3JQYXJhbWV0ZXJzPFR5cGU+ICkgPT4gKCBQb29sYWJsZVZlcnNpb248VHlwZT4gKSApICYgUG9vbGFibGVUeXBlPFR5cGU+O1xyXG50eXBlIFBvb2xhYmxlRXhpc3RpbmdTdGF0aWNzPFR5cGUgZXh0ZW5kcyBDb25zdHJ1Y3Rvcj4gPSB7XHJcbiAgLy8gV2UgZ3JhYiB0aGUgc3RhdGljIHZhbHVlcyBvZiBhIHR5cGVcclxuICBbIFByb3BlcnR5IGluIGtleW9mIFR5cGUgXTogVHlwZVsgUHJvcGVydHkgXVxyXG59O1xyXG50eXBlIFBvb2xhYmxlVHlwZTxUeXBlIGV4dGVuZHMgQ29uc3RydWN0b3I+ID0ge1xyXG4gIHBvb2w6IFBvb2xhYmxlVmVyc2lvbjxUeXBlPltdO1xyXG4gIGRpcnR5RnJvbVBvb2woKTogUG9vbGFibGVWZXJzaW9uPFR5cGU+O1xyXG4gIGNyZWF0ZUZyb21Qb29sKCAuLi5hcmdzOiBDb25zdHJ1Y3RvclBhcmFtZXRlcnM8VHlwZT4gKTogUG9vbGFibGVWZXJzaW9uPFR5cGU+O1xyXG4gIGdldCBwb29sU2l6ZSgpOiBudW1iZXI7XHJcbiAgc2V0IG1heFBvb2xTaXplKCB2YWx1ZTogbnVtYmVyICk7XHJcbiAgZ2V0IG1heFBvb2xTaXplKCk6IG51bWJlcjtcclxufSAmIFBvb2xhYmxlRXhpc3RpbmdTdGF0aWNzPFR5cGU+O1xyXG5cclxuLyoqXHJcbiAqIEBkZXByZWNhdGVkIC0gUGxlYXNlIHVzZSBQb29sLnRzIGluc3RlYWQgYXMgdGhlIG5ldyBwb29saW5nIHBhdHRlcm4uXHJcbiAqL1xyXG5jb25zdCBQb29sYWJsZSA9IHtcclxuICAvKipcclxuICAgKiBDaGFuZ2VzIHRoZSBnaXZlbiB0eXBlIChhbmQgaXRzIHByb3RvdHlwZSkgdG8gc3VwcG9ydCBvYmplY3QgcG9vbGluZy5cclxuICAgKi9cclxuICBtaXhJbnRvPFR5cGUgZXh0ZW5kcyBDb25zdHJ1Y3Rvcj4oIHR5cGU6IFR5cGUsIHByb3ZpZGVkT3B0aW9ucz86IFBvb2xhYmxlT3B0aW9uczxUeXBlPiApIDogUG9vbGFibGVDbGFzczxUeXBlPiB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFBvb2xhYmxlT3B0aW9uczxUeXBlPiwgUG9vbGFibGVPcHRpb25zPFR5cGU+PigpKCB7XHJcblxyXG4gICAgICBkZWZhdWx0QXJndW1lbnRzOiBbXSBhcyB1bmtub3duIGFzIENvbnN0cnVjdG9yUGFyYW1ldGVyczxUeXBlPixcclxuICAgICAgaW5pdGlhbGl6ZTogdHlwZS5wcm90b3R5cGUuaW5pdGlhbGl6ZSxcclxuICAgICAgbWF4U2l6ZTogMTAwLFxyXG4gICAgICBpbml0aWFsU2l6ZTogMCxcclxuICAgICAgdXNlRGVmYXVsdENvbnN0cnVjdGlvbjogZmFsc2VcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApIGFzIFJlcXVpcmVkPFBvb2xhYmxlT3B0aW9uczxUeXBlPj47XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy5tYXhTaXplID49IDAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIG9wdGlvbnMuaW5pdGlhbFNpemUgPj0gMCApO1xyXG5cclxuICAgIC8vIFRoZSBhY3R1YWwgYXJyYXkgd2Ugc3RvcmUgdGhpbmdzIGluLiBBbHdheXMgcHVzaC9wb3AuXHJcbiAgICBjb25zdCBwb29sOiBJbnN0YW5jZVR5cGU8VHlwZT5bXSA9IFtdO1xyXG5cclxuICAgIGxldCBtYXhQb29sU2l6ZSA9IG9wdGlvbnMubWF4U2l6ZTtcclxuXHJcbiAgICAvLyBUaGVyZSBpcyBhIG1hZG5lc3MgdG8gdGhpcyBjcmF6aW5lc3MuIFdlJ2Qgd2FudCB0byB1c2UgdGhlIG1ldGhvZCBub3RlZCBhdFxyXG4gICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTYwNjc5Ny91c2Utb2YtYXBwbHktd2l0aC1uZXctb3BlcmF0b3ItaXMtdGhpcy1wb3NzaWJsZSwgYnV0IHRoZSB0eXBlIGlzXHJcbiAgICAvLyBub3QgcHJvdmlkZWQgaW4gdGhlIGFyZ3VtZW50cyBhcnJheSBiZWxvdy4gQnkgY2FsbGluZyBiaW5kIG9uIGl0c2VsZiwgd2UncmUgYWJsZSB0byBnZXQgYSB2ZXJzaW9uIG9mIGJpbmQgdGhhdFxyXG4gICAgLy8gaW5zZXJ0cyB0aGUgY29uc3RydWN0b3IgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSAuYXBwbHkgY2FsbGVkIGxhdGVyIHNvIHdlIGRvbid0IGNyZWF0ZSBnYXJiYWdlIGJ5IGhhdmluZ1xyXG4gICAgLy8gdG8gcGFjayBgYXJndW1lbnRzYCBpbnRvIGFuIGFycmF5IEFORCBUSEVOIGNvbmNhdGVuYXRlIGl0IHdpdGggYSBuZXcgZmlyc3QgZWxlbWVudCAodGhlIHR5cGUgaXRzZWxmKS5cclxuICAgIGNvbnN0IHBhcnRpYWxDb25zdHJ1Y3RvciA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmJpbmQoIHR5cGUsIHR5cGUgKTtcclxuXHJcbiAgICAvLyBCYXNpY2FsbHkgb3VyIHR5cGUgY29uc3RydWN0b3IsIGJ1dCB3aXRoIHRoZSBkZWZhdWx0IGFyZ3VtZW50cyBpbmNsdWRlZCBhbHJlYWR5LlxyXG4gICAgY29uc3QgRGVmYXVsdENvbnN0cnVjdG9yID0gcGFydGlhbENvbnN0cnVjdG9yKCAuLi5vcHRpb25zLmRlZmF1bHRBcmd1bWVudHMgKTtcclxuXHJcbiAgICBjb25zdCBpbml0aWFsaXplID0gb3B0aW9ucy5pbml0aWFsaXplO1xyXG4gICAgY29uc3QgdXNlRGVmYXVsdENvbnN0cnVjdGlvbiA9IG9wdGlvbnMudXNlRGVmYXVsdENvbnN0cnVjdGlvbjtcclxuXHJcbiAgICBjb25zdCBwcm90byA9IHR5cGUucHJvdG90eXBlO1xyXG5cclxuICAgIGV4dGVuZCggdHlwZSwge1xyXG4gICAgICAvKipcclxuICAgICAgICogVGhpcyBzaG91bGQgbm90IGJlIG1vZGlmaWVkIGV4dGVybmFsbHkuIEluIHRoZSBmdXR1cmUgaWYgZGVzaXJlZCwgZnVuY3Rpb25zIGNvdWxkIGJlIGFkZGVkIHRvIGhlbHBcclxuICAgICAgICogYWRkaW5nL3JlbW92aW5nIHBvb2xhYmxlIGluc3RhbmNlcyBtYW51YWxseS5cclxuICAgICAgICovXHJcbiAgICAgIHBvb2w6IHBvb2wsXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogUmV0dXJucyBhbiBvYmplY3Qgd2l0aCBhcmJpdHJhcnkgc3RhdGUgKHBvc3NpYmx5IGNvbnN0cnVjdGVkIHdpdGggdGhlIGRlZmF1bHQgYXJndW1lbnRzKS5cclxuICAgICAgICovXHJcbiAgICAgIGRpcnR5RnJvbVBvb2woKTogUG9vbGFibGVWZXJzaW9uPFR5cGU+IHtcclxuICAgICAgICByZXR1cm4gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IERlZmF1bHRDb25zdHJ1Y3RvcigpO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFJldHVybnMgYW4gb2JqZWN0IHRoYXQgYmVoYXZlcyBhcyBpZiBpdCB3YXMgY29uc3RydWN0ZWQgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLiBNYXkgcmVzdWx0IGluIGEgbmV3IG9iamVjdFxyXG4gICAgICAgKiBiZWluZyBjcmVhdGVkIChpZiB0aGUgcG9vbCBpcyBlbXB0eSksIG9yIGl0IG1heSB1c2UgdGhlIGNvbnN0cnVjdG9yIHRvIG11dGF0ZSBhbiBvYmplY3QgZnJvbSB0aGUgcG9vbC5cclxuICAgICAgICovXHJcbiAgICAgIGNyZWF0ZUZyb21Qb29sKCAuLi5hcmdzOiBDb25zdHJ1Y3RvclBhcmFtZXRlcnM8VHlwZT4gKTogUG9vbGFibGVWZXJzaW9uPFR5cGU+IHtcclxuICAgICAgICBsZXQgcmVzdWx0O1xyXG5cclxuICAgICAgICBpZiAoIHBvb2wubGVuZ3RoICkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gcG9vbC5wb3AoKTtcclxuICAgICAgICAgIGluaXRpYWxpemUuYXBwbHkoIHJlc3VsdCwgYXJncyApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICggdXNlRGVmYXVsdENvbnN0cnVjdGlvbiApIHtcclxuICAgICAgICAgIHJlc3VsdCA9IG5ldyBEZWZhdWx0Q29uc3RydWN0b3IoKTtcclxuICAgICAgICAgIGluaXRpYWxpemUuYXBwbHkoIHJlc3VsdCwgYXJncyApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIHJlc3VsdCA9IG5ldyAoIHBhcnRpYWxDb25zdHJ1Y3RvciggLi4uYXJncyApICkoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBzaXplIG9mIHRoZSBwb29sLlxyXG4gICAgICAgKi9cclxuICAgICAgZ2V0IHBvb2xTaXplKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHBvb2wubGVuZ3RoO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFNldHMgdGhlIG1heGltdW0gcG9vbCBzaXplLlxyXG4gICAgICAgKi9cclxuICAgICAgc2V0IG1heFBvb2xTaXplKCB2YWx1ZTogbnVtYmVyICkge1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHZhbHVlID09PSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkgfHwgKCBOdW1iZXIuaXNJbnRlZ2VyKCB2YWx1ZSApICYmIHZhbHVlID49IDAgKSwgJ21heFBvb2xTaXplIHNob3VsZCBiZSBhIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyIG9yIGluZmluaXR5JyApO1xyXG5cclxuICAgICAgICBtYXhQb29sU2l6ZSA9IHZhbHVlO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIFJldHVybnMgdGhlIG1heGltdW0gcG9vbCBzaXplLlxyXG4gICAgICAgKi9cclxuICAgICAgZ2V0IG1heFBvb2xTaXplKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIG1heFBvb2xTaXplO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgZXh0ZW5kKCBwcm90bywge1xyXG4gICAgICAvKipcclxuICAgICAgICogQWRkcyB0aGlzIG9iamVjdCBpbnRvIHRoZSBwb29sLCBzbyB0aGF0IGl0IGNhbiBiZSByZXVzZWQgZWxzZXdoZXJlLiBHZW5lcmFsbHkgd2hlbiB0aGlzIGlzIGRvbmUsIG5vIG90aGVyXHJcbiAgICAgICAqIHJlZmVyZW5jZXMgdG8gdGhlIG9iamVjdCBzaG91bGQgYmUgaGVsZCAoc2luY2UgdGhleSBzaG91bGQgbm90IGJlIHVzZWQgYXQgYWxsKS5cclxuICAgICAgICovXHJcbiAgICAgIGZyZWVUb1Bvb2woKSB7XHJcbiAgICAgICAgaWYgKCBwb29sLmxlbmd0aCA8IG1heFBvb2xTaXplICkge1xyXG4gICAgICAgICAgcG9vbC5wdXNoKCB0aGlzICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gSW5pdGlhbGl6ZSB0aGUgcG9vbCAoaWYgaXQgc2hvdWxkIGhhdmUgb2JqZWN0cylcclxuICAgIHdoaWxlICggcG9vbC5sZW5ndGggPCBvcHRpb25zLmluaXRpYWxTaXplICkge1xyXG4gICAgICBwb29sLnB1c2goIG5ldyBEZWZhdWx0Q29uc3RydWN0b3IoKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0eXBlIGFzIHVua25vd24gYXMgUG9vbGFibGVDbGFzczxUeXBlPjtcclxuICB9XHJcbn07XHJcblxyXG5waGV0Q29yZS5yZWdpc3RlciggJ1Bvb2xhYmxlJywgUG9vbGFibGUgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFBvb2xhYmxlO1xyXG5leHBvcnQgdHlwZSB7IFBvb2xhYmxlT3B0aW9ucywgUG9vbGFibGVJbnN0YW5jZSwgUG9vbGFibGVWZXJzaW9uLCBQb29sYWJsZUluaXRpYWxpemVy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