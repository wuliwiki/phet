// Copyright 2014-2023, University of Colorado Boulder

/**
 * Model for the 'Game' screen.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Range from '../../../../dot/js/Range.js';
import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Property from '../../../../axon/js/Property.js';
import optionize from '../../../../phet-core/js/optionize.js';
import GameTimer from '../../../../vegas/js/GameTimer.js';
import RPALConstants from '../../common/RPALConstants.js';
import reactantsProductsAndLeftovers from '../../reactantsProductsAndLeftovers.js';
import ChallengeFactory from './ChallengeFactory.js';
import GamePhase from './GamePhase.js';
import GameVisibility from './GameVisibility.js';
import PlayState from './PlayState.js';
import NullableIO from '../../../../tandem/js/types/NullableIO.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
const POINTS_FIRST_CHECK = 2;
const POINTS_SECOND_CHECK = 1;
export default class GameModel {
  // is the timer turned on?

  // the current level, starts at 0 in the model, presented as starting from 1 in the view

  // how many points the user has earned for the current game

  // the number of challenges in the current game being played

  // the current challenge being played, null if there's no challenge

  // the index of the current challenge, -1 indicates no challenge

  // the current 'phase' of the game

  // the current 'play state' of the game

  // These fields should be treated as read-only. They are changed by GameModel as game-play progresses.
  // the set of challenges for the current game being played
  // best scores for each level
  // best times for each level, null if a level has no best time yet
  // is the time for the most-recently-completed game a new best time?

  constructor(tandem, providedOptions) {
    const options = optionize()({
      // SelfOptions
      level: 0,
      numberOfLevels: 3,
      maxQuantity: RPALConstants.QUANTITY_RANGE.max
    }, providedOptions);
    this.numberOfLevels = options.numberOfLevels;
    this.maxQuantity = options.maxQuantity;
    this.timerEnabledProperty = new BooleanProperty(false, {
      tandem: tandem.createTandem('timerEnabledProperty')
    });
    this.gameVisibilityProperty = new EnumerationProperty(GameVisibility.SHOW_ALL, {
      tandem: tandem.createTandem('gameVisibilityProperty')
    });

    // read-only
    this.levelProperty = new NumberProperty(0, {
      numberType: 'Integer',
      hasListenerOrderDependencies: true,
      // TODO: https://github.com/phetsims/reactants-products-and-leftovers/issues/85
      range: new Range(0, this.numberOfLevels - 1),
      tandem: tandem.createTandem('levelProperty')
    });
    this.scoreProperty = new NumberProperty(0, {
      numberType: 'Integer',
      isValidValue: value => value >= 0,
      tandem: tandem.createTandem('scoreProperty')
    });
    this.numberOfChallengesProperty = new NumberProperty(0, {
      numberType: 'Integer',
      //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 range
      isValidValue: value => value >= 0,
      tandem: tandem.createTandem('numberOfChallengesProperty')
    });
    this.challengeProperty = new Property(null, {
      //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 NullableIO( ChallengeIO )
    });
    this.challengeIndexProperty = new NumberProperty(-1, {
      numberType: 'Integer',
      //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 range
      isValidValue: value => value >= -1,
      tandem: tandem.createTandem('challengeIndexProperty')
    });
    this.gamePhaseProperty = new EnumerationProperty(GamePhase.SETTINGS, {
      tandem: tandem.createTandem('gamePhaseProperty'),
      phetioReadOnly: true
      //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 phetioDocumentation
    });

    this.playStateProperty = new EnumerationProperty(PlayState.NONE, {
      tandem: tandem.createTandem('playStateProperty'),
      phetioReadOnly: true
      //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 phetioDocumentation
    });

    // read-only
    this.challenges = [];
    this.bestScoreProperties = [];
    this.bestTimeProperties = [];
    this.isNewBestTime = false;
    const bestScoresTandem = tandem.createTandem('bestScores');
    const bestTimesTandem = tandem.createTandem('bestTimes');
    for (let level = 0; level < this.numberOfLevels; level++) {
      this.bestScoreProperties.push(new NumberProperty(0, {
        numberType: 'Integer',
        tandem: bestScoresTandem.createTandem(`bestScore${level}Property`)
      }));
      this.bestTimeProperties.push(new Property(null, {
        tandem: bestTimesTandem.createTandem(`bestTime${level}Property`),
        phetioValueType: NullableIO(NumberIO)
        //TODO https://github.com/phetsims/reactants-products-and-leftovers/issues/78 phetioDocumentation
      }));
    }

    this.timer = new GameTimer();
  }
  reset() {
    // reset Properties
    this.timerEnabledProperty.reset();
    this.gameVisibilityProperty.reset();
    this.levelProperty.reset();
    this.scoreProperty.reset();
    this.numberOfChallengesProperty.reset();
    this.challengeProperty.reset();
    this.challengeIndexProperty.reset();
    this.gamePhaseProperty.reset();
    this.playStateProperty.reset();

    // reset scores and times for each level
    this.bestScoreProperties.forEach(property => {
      property.value = 0;
    });
    this.bestTimeProperties.forEach(property => {
      property.value = null;
    });
  }

  // Advances to GamePhase.SETTINGS, shows the user-interface for selecting game settings.
  settings() {
    this.timer.stop();
    this.playStateProperty.value = PlayState.NONE;
    this.gamePhaseProperty.value = GamePhase.SETTINGS; // do this last, so that other stuff is set up before observers are notified
  }

  // Advances to GamePhase.PLAY, to play a game for the specified level.
  play(level) {
    assert && assert(this.gamePhaseProperty.value === GamePhase.SETTINGS);
    this.levelProperty.value = level;
    this.scoreProperty.value = 0;
    this.initChallenges();
    this.timer.start();
    this.playStateProperty.value = PlayState.FIRST_CHECK;
    this.gamePhaseProperty.value = GamePhase.PLAY; // do this last, so that other stuff is set up before observers are notified
  }

  // Advances to GamePhase.RESULTS, ends the current game and displays results.
  results() {
    assert && assert(this.gamePhaseProperty.value === GamePhase.PLAY);
    this.timer.stop();
    this.updateBestScore();
    this.updateBestTime();
    this.playStateProperty.value = PlayState.NONE;
    this.gamePhaseProperty.value = GamePhase.RESULTS; // do this last, so that other stuff is set up before observers are notified
  }

  // Checks the current guess.
  check() {
    const playState = this.playStateProperty.value;
    assert && assert(playState === PlayState.FIRST_CHECK || playState === PlayState.SECOND_CHECK);
    const challenge = this.challengeProperty.value;
    assert && assert(challenge);
    if (challenge.isCorrect()) {
      // stop the timer as soon as we successfully complete the last challenge
      if (this.challengeIndexProperty.value === this.challenges.length - 1) {
        this.timer.stop();
      }
      const points = playState === PlayState.FIRST_CHECK ? POINTS_FIRST_CHECK : POINTS_SECOND_CHECK;
      challenge.points = points;
      this.scoreProperty.value = this.scoreProperty.value + points;
      this.playStateProperty.value = PlayState.NEXT;
    } else {
      this.playStateProperty.value = playState === PlayState.FIRST_CHECK ? PlayState.TRY_AGAIN : PlayState.SHOW_ANSWER;
    }
  }

  // Makes another attempt at solving the challenge.
  tryAgain() {
    assert && assert(this.playStateProperty.value === PlayState.TRY_AGAIN);
    this.playStateProperty.value = PlayState.SECOND_CHECK;
  }

  // Shows the correct answer.
  showAnswer() {
    assert && assert(this.playStateProperty.value === PlayState.SHOW_ANSWER);
    const challenge = this.challengeProperty.value;
    assert && assert(challenge);
    challenge.showAnswer();
    this.playStateProperty.value = PlayState.NEXT;
  }

  // Advances to the next challenge.
  next() {
    if (this.challengeIndexProperty.value === this.challenges.length - 1) {
      // game has been completed, advance to GamePhase.RESULTS
      this.results();
    } else {
      // advance to next challenge
      this.challengeIndexProperty.value = this.challengeIndexProperty.value + 1;
      this.challengeProperty.value = this.challenges[this.challengeIndexProperty.value];
      this.playStateProperty.value = PlayState.FIRST_CHECK;
    }
  }

  /**
   * Gets the number of challenges for the specified level.
   */
  getNumberOfChallenges(level) {
    return ChallengeFactory.getNumberOfChallenges(level);
  }

  /**
   * Gets the perfect score for the specified level.
   */
  getPerfectScore(level) {
    return ChallengeFactory.getNumberOfChallenges(level) * POINTS_FIRST_CHECK;
  }

  /**
   * Is the current score perfect?
   */
  isPerfectScore() {
    return this.scoreProperty.value === this.getPerfectScore(this.levelProperty.value);
  }

  // Updates the best score for the current level.
  updateBestScore() {
    const level = this.levelProperty.value;
    if (this.scoreProperty.value > this.bestScoreProperties[level].value) {
      this.bestScoreProperties[level].value = this.scoreProperty.value;
    }
  }

  // Updates the best time for the current level, at the end of a timed game with a perfect score.
  updateBestTime() {
    assert && assert(!this.timer.isRunningProperty.value);
    this.isNewBestTime = false;
    if (this.timerEnabledProperty.value && this.isPerfectScore()) {
      const level = this.levelProperty.value;
      const time = this.timer.elapsedTimeProperty.value;
      const bestTime = this.bestTimeProperties[level].value;
      if (bestTime === null) {
        // There was no previous best time for this level.
        this.bestTimeProperties[level].value = time;
      } else if (time < bestTime) {
        // We have a new best time for this level.
        this.bestTimeProperties[level].value = time;
        this.isNewBestTime = true;
      }
    }
  }

  // Initializes a new set of challenges for the current level.
  initChallenges() {
    this.challenges = ChallengeFactory.createChallenges(this.levelProperty.value, this.maxQuantity, {
      moleculesVisible: this.gameVisibilityProperty.value !== GameVisibility.HIDE_MOLECULES,
      numbersVisible: this.gameVisibilityProperty.value !== GameVisibility.HIDE_NUMBERS
    });
    this.numberOfChallengesProperty.value = this.challenges.length;
    this.challengeIndexProperty.value = 0;
    this.challengeProperty.value = this.challenges[this.challengeIndexProperty.value];
  }

  /**
   * DEBUG: Skips the current challenge. Score and best times are meaningless after using this. This is a developer feature.
   */
  skipCurrentChallenge() {
    this.next();
  }

  /**
   * DEBUG: Replays the current challenge. Score and best times are meaningless after using this. This is a developer feature.
   */
  replayCurrentChallenge() {
    this.challengeProperty.value && this.challengeProperty.value.reset();
    this.playStateProperty.value = PlayState.FIRST_CHECK;
  }
}
reactantsProductsAndLeftovers.register('GameModel', GameModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSYW5nZSIsIkJvb2xlYW5Qcm9wZXJ0eSIsIkVudW1lcmF0aW9uUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsIlByb3BlcnR5Iiwib3B0aW9uaXplIiwiR2FtZVRpbWVyIiwiUlBBTENvbnN0YW50cyIsInJlYWN0YW50c1Byb2R1Y3RzQW5kTGVmdG92ZXJzIiwiQ2hhbGxlbmdlRmFjdG9yeSIsIkdhbWVQaGFzZSIsIkdhbWVWaXNpYmlsaXR5IiwiUGxheVN0YXRlIiwiTnVsbGFibGVJTyIsIk51bWJlcklPIiwiUE9JTlRTX0ZJUlNUX0NIRUNLIiwiUE9JTlRTX1NFQ09ORF9DSEVDSyIsIkdhbWVNb2RlbCIsImNvbnN0cnVjdG9yIiwidGFuZGVtIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImxldmVsIiwibnVtYmVyT2ZMZXZlbHMiLCJtYXhRdWFudGl0eSIsIlFVQU5USVRZX1JBTkdFIiwibWF4IiwidGltZXJFbmFibGVkUHJvcGVydHkiLCJjcmVhdGVUYW5kZW0iLCJnYW1lVmlzaWJpbGl0eVByb3BlcnR5IiwiU0hPV19BTEwiLCJsZXZlbFByb3BlcnR5IiwibnVtYmVyVHlwZSIsImhhc0xpc3RlbmVyT3JkZXJEZXBlbmRlbmNpZXMiLCJyYW5nZSIsInNjb3JlUHJvcGVydHkiLCJpc1ZhbGlkVmFsdWUiLCJ2YWx1ZSIsIm51bWJlck9mQ2hhbGxlbmdlc1Byb3BlcnR5IiwiY2hhbGxlbmdlUHJvcGVydHkiLCJjaGFsbGVuZ2VJbmRleFByb3BlcnR5IiwiZ2FtZVBoYXNlUHJvcGVydHkiLCJTRVRUSU5HUyIsInBoZXRpb1JlYWRPbmx5IiwicGxheVN0YXRlUHJvcGVydHkiLCJOT05FIiwiY2hhbGxlbmdlcyIsImJlc3RTY29yZVByb3BlcnRpZXMiLCJiZXN0VGltZVByb3BlcnRpZXMiLCJpc05ld0Jlc3RUaW1lIiwiYmVzdFNjb3Jlc1RhbmRlbSIsImJlc3RUaW1lc1RhbmRlbSIsInB1c2giLCJwaGV0aW9WYWx1ZVR5cGUiLCJ0aW1lciIsInJlc2V0IiwiZm9yRWFjaCIsInByb3BlcnR5Iiwic2V0dGluZ3MiLCJzdG9wIiwicGxheSIsImFzc2VydCIsImluaXRDaGFsbGVuZ2VzIiwic3RhcnQiLCJGSVJTVF9DSEVDSyIsIlBMQVkiLCJyZXN1bHRzIiwidXBkYXRlQmVzdFNjb3JlIiwidXBkYXRlQmVzdFRpbWUiLCJSRVNVTFRTIiwiY2hlY2siLCJwbGF5U3RhdGUiLCJTRUNPTkRfQ0hFQ0siLCJjaGFsbGVuZ2UiLCJpc0NvcnJlY3QiLCJsZW5ndGgiLCJwb2ludHMiLCJORVhUIiwiVFJZX0FHQUlOIiwiU0hPV19BTlNXRVIiLCJ0cnlBZ2FpbiIsInNob3dBbnN3ZXIiLCJuZXh0IiwiZ2V0TnVtYmVyT2ZDaGFsbGVuZ2VzIiwiZ2V0UGVyZmVjdFNjb3JlIiwiaXNQZXJmZWN0U2NvcmUiLCJpc1J1bm5pbmdQcm9wZXJ0eSIsInRpbWUiLCJlbGFwc2VkVGltZVByb3BlcnR5IiwiYmVzdFRpbWUiLCJjcmVhdGVDaGFsbGVuZ2VzIiwibW9sZWN1bGVzVmlzaWJsZSIsIkhJREVfTU9MRUNVTEVTIiwibnVtYmVyc1Zpc2libGUiLCJISURFX05VTUJFUlMiLCJza2lwQ3VycmVudENoYWxsZW5nZSIsInJlcGxheUN1cnJlbnRDaGFsbGVuZ2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkdhbWVNb2RlbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNb2RlbCBmb3IgdGhlICdHYW1lJyBzY3JlZW4uXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFRNb2RlbCBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9UTW9kZWwuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgR2FtZVRpbWVyIGZyb20gJy4uLy4uLy4uLy4uL3ZlZ2FzL2pzL0dhbWVUaW1lci5qcyc7XHJcbmltcG9ydCBSUEFMQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9SUEFMQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IHJlYWN0YW50c1Byb2R1Y3RzQW5kTGVmdG92ZXJzIGZyb20gJy4uLy4uL3JlYWN0YW50c1Byb2R1Y3RzQW5kTGVmdG92ZXJzLmpzJztcclxuaW1wb3J0IENoYWxsZW5nZSBmcm9tICcuL0NoYWxsZW5nZS5qcyc7XHJcbmltcG9ydCBDaGFsbGVuZ2VGYWN0b3J5IGZyb20gJy4vQ2hhbGxlbmdlRmFjdG9yeS5qcyc7XHJcbmltcG9ydCBHYW1lUGhhc2UgZnJvbSAnLi9HYW1lUGhhc2UuanMnO1xyXG5pbXBvcnQgR2FtZVZpc2liaWxpdHkgZnJvbSAnLi9HYW1lVmlzaWJpbGl0eS5qcyc7XHJcbmltcG9ydCBQbGF5U3RhdGUgZnJvbSAnLi9QbGF5U3RhdGUuanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBOdW1iZXJJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVtYmVySU8uanMnO1xyXG5cclxuY29uc3QgUE9JTlRTX0ZJUlNUX0NIRUNLID0gMjtcclxuY29uc3QgUE9JTlRTX1NFQ09ORF9DSEVDSyA9IDE7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIGxldmVsPzogbnVtYmVyOyAvLyB0aGUgY3VycmVudCBsZXZlbCBpbiB0aGUgZ2FtZSwgbnVtYmVyZWQgc3RhcnRpbmcgd2l0aCB6ZXJvXHJcbiAgbnVtYmVyT2ZMZXZlbHM/OiBudW1iZXI7IC8vIG51bWJlciBvZiBsZXZlbHMgaW4gdGhlIGdhbWVcclxuICBtYXhRdWFudGl0eT86IG51bWJlcjsgLy8gbWF4aW11bSBxdWFudGl0eSBvZiBhbnkgc3Vic3RhbmNlIGluIGEgcmVhY3Rpb25cclxufTtcclxuXHJcbnR5cGUgR2FtZU1vZGVsT3B0aW9ucyA9IFNlbGZPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgR2FtZU1vZGVsIGltcGxlbWVudHMgVE1vZGVsIHtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IG51bWJlck9mTGV2ZWxzOiBudW1iZXI7XHJcbiAgcHVibGljIHJlYWRvbmx5IG1heFF1YW50aXR5OiBudW1iZXI7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSB0aW1lckVuYWJsZWRQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47IC8vIGlzIHRoZSB0aW1lciB0dXJuZWQgb24/XHJcbiAgcHVibGljIHJlYWRvbmx5IGdhbWVWaXNpYmlsaXR5UHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8R2FtZVZpc2liaWxpdHk+O1xyXG5cclxuICAvLyB0aGUgY3VycmVudCBsZXZlbCwgc3RhcnRzIGF0IDAgaW4gdGhlIG1vZGVsLCBwcmVzZW50ZWQgYXMgc3RhcnRpbmcgZnJvbSAxIGluIHRoZSB2aWV3XHJcbiAgcHVibGljIHJlYWRvbmx5IGxldmVsUHJvcGVydHk6IFByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIGhvdyBtYW55IHBvaW50cyB0aGUgdXNlciBoYXMgZWFybmVkIGZvciB0aGUgY3VycmVudCBnYW1lXHJcbiAgcHVibGljIHJlYWRvbmx5IHNjb3JlUHJvcGVydHk6IFByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIHRoZSBudW1iZXIgb2YgY2hhbGxlbmdlcyBpbiB0aGUgY3VycmVudCBnYW1lIGJlaW5nIHBsYXllZFxyXG4gIHB1YmxpYyByZWFkb25seSBudW1iZXJPZkNoYWxsZW5nZXNQcm9wZXJ0eTogUHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gdGhlIGN1cnJlbnQgY2hhbGxlbmdlIGJlaW5nIHBsYXllZCwgbnVsbCBpZiB0aGVyZSdzIG5vIGNoYWxsZW5nZVxyXG4gIHB1YmxpYyByZWFkb25seSBjaGFsbGVuZ2VQcm9wZXJ0eTogUHJvcGVydHk8Q2hhbGxlbmdlIHwgbnVsbD47XHJcblxyXG4gIC8vIHRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBjaGFsbGVuZ2UsIC0xIGluZGljYXRlcyBubyBjaGFsbGVuZ2VcclxuICBwdWJsaWMgcmVhZG9ubHkgY2hhbGxlbmdlSW5kZXhQcm9wZXJ0eTogUHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gdGhlIGN1cnJlbnQgJ3BoYXNlJyBvZiB0aGUgZ2FtZVxyXG4gIHB1YmxpYyByZWFkb25seSBnYW1lUGhhc2VQcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxHYW1lUGhhc2U+O1xyXG5cclxuICAvLyB0aGUgY3VycmVudCAncGxheSBzdGF0ZScgb2YgdGhlIGdhbWVcclxuICBwdWJsaWMgcmVhZG9ubHkgcGxheVN0YXRlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8UGxheVN0YXRlPjtcclxuXHJcbiAgLy8gVGhlc2UgZmllbGRzIHNob3VsZCBiZSB0cmVhdGVkIGFzIHJlYWQtb25seS4gVGhleSBhcmUgY2hhbmdlZCBieSBHYW1lTW9kZWwgYXMgZ2FtZS1wbGF5IHByb2dyZXNzZXMuXHJcbiAgcHVibGljIGNoYWxsZW5nZXM6IENoYWxsZW5nZVtdOyAvLyB0aGUgc2V0IG9mIGNoYWxsZW5nZXMgZm9yIHRoZSBjdXJyZW50IGdhbWUgYmVpbmcgcGxheWVkXHJcbiAgcHVibGljIHJlYWRvbmx5IGJlc3RTY29yZVByb3BlcnRpZXM6IFByb3BlcnR5PG51bWJlcj5bXTsgLy8gYmVzdCBzY29yZXMgZm9yIGVhY2ggbGV2ZWxcclxuICBwdWJsaWMgcmVhZG9ubHkgYmVzdFRpbWVQcm9wZXJ0aWVzOiBQcm9wZXJ0eTxudW1iZXIgfCBudWxsPltdOyAvLyBiZXN0IHRpbWVzIGZvciBlYWNoIGxldmVsLCBudWxsIGlmIGEgbGV2ZWwgaGFzIG5vIGJlc3QgdGltZSB5ZXRcclxuICBwdWJsaWMgaXNOZXdCZXN0VGltZTogYm9vbGVhbjsgLy8gaXMgdGhlIHRpbWUgZm9yIHRoZSBtb3N0LXJlY2VudGx5LWNvbXBsZXRlZCBnYW1lIGEgbmV3IGJlc3QgdGltZT9cclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IHRpbWVyOiBHYW1lVGltZXI7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggdGFuZGVtOiBUYW5kZW0sIHByb3ZpZGVkT3B0aW9ucz86IEdhbWVNb2RlbE9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxHYW1lTW9kZWxPcHRpb25zLCBTZWxmT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgbGV2ZWw6IDAsXHJcbiAgICAgIG51bWJlck9mTGV2ZWxzOiAzLFxyXG4gICAgICBtYXhRdWFudGl0eTogUlBBTENvbnN0YW50cy5RVUFOVElUWV9SQU5HRS5tYXhcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMubnVtYmVyT2ZMZXZlbHMgPSBvcHRpb25zLm51bWJlck9mTGV2ZWxzO1xyXG4gICAgdGhpcy5tYXhRdWFudGl0eSA9IG9wdGlvbnMubWF4UXVhbnRpdHk7XHJcblxyXG4gICAgdGhpcy50aW1lckVuYWJsZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3RpbWVyRW5hYmxlZFByb3BlcnR5JyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5nYW1lVmlzaWJpbGl0eVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIEdhbWVWaXNpYmlsaXR5LlNIT1dfQUxMLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2dhbWVWaXNpYmlsaXR5UHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyByZWFkLW9ubHlcclxuICAgIHRoaXMubGV2ZWxQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggMCwge1xyXG4gICAgICBudW1iZXJUeXBlOiAnSW50ZWdlcicsXHJcbiAgICAgIGhhc0xpc3RlbmVyT3JkZXJEZXBlbmRlbmNpZXM6IHRydWUsIC8vIFRPRE86IGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9yZWFjdGFudHMtcHJvZHVjdHMtYW5kLWxlZnRvdmVycy9pc3N1ZXMvODVcclxuICAgICAgcmFuZ2U6IG5ldyBSYW5nZSggMCwgdGhpcy5udW1iZXJPZkxldmVscyAtIDEgKSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnbGV2ZWxQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuc2NvcmVQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggMCwge1xyXG4gICAgICBudW1iZXJUeXBlOiAnSW50ZWdlcicsXHJcbiAgICAgIGlzVmFsaWRWYWx1ZTogdmFsdWUgPT4gKCB2YWx1ZSA+PSAwICksXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Njb3JlUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm51bWJlck9mQ2hhbGxlbmdlc1Byb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwLCB7XHJcbiAgICAgIG51bWJlclR5cGU6ICdJbnRlZ2VyJyxcclxuICAgICAgLy9UT0RPIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9yZWFjdGFudHMtcHJvZHVjdHMtYW5kLWxlZnRvdmVycy9pc3N1ZXMvNzggcmFuZ2VcclxuICAgICAgaXNWYWxpZFZhbHVlOiB2YWx1ZSA9PiAoIHZhbHVlID49IDAgKSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnbnVtYmVyT2ZDaGFsbGVuZ2VzUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmNoYWxsZW5nZVByb3BlcnR5ID0gbmV3IFByb3BlcnR5PENoYWxsZW5nZSB8IG51bGw+KCBudWxsLCB7XHJcbiAgICAgIC8vVE9ETyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcmVhY3RhbnRzLXByb2R1Y3RzLWFuZC1sZWZ0b3ZlcnMvaXNzdWVzLzc4IE51bGxhYmxlSU8oIENoYWxsZW5nZUlPIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmNoYWxsZW5nZUluZGV4UHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIC0xLCB7XHJcbiAgICAgIG51bWJlclR5cGU6ICdJbnRlZ2VyJyxcclxuICAgICAgLy9UT0RPIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9yZWFjdGFudHMtcHJvZHVjdHMtYW5kLWxlZnRvdmVycy9pc3N1ZXMvNzggcmFuZ2VcclxuICAgICAgaXNWYWxpZFZhbHVlOiB2YWx1ZSA9PiAoIHZhbHVlID49IC0xICksXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2NoYWxsZW5nZUluZGV4UHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmdhbWVQaGFzZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIEdhbWVQaGFzZS5TRVRUSU5HUywge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdnYW1lUGhhc2VQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWVcclxuICAgICAgLy9UT0RPIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9yZWFjdGFudHMtcHJvZHVjdHMtYW5kLWxlZnRvdmVycy9pc3N1ZXMvNzggcGhldGlvRG9jdW1lbnRhdGlvblxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMucGxheVN0YXRlUHJvcGVydHkgPSBuZXcgRW51bWVyYXRpb25Qcm9wZXJ0eSggUGxheVN0YXRlLk5PTkUsIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAncGxheVN0YXRlUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiB0cnVlXHJcbiAgICAgIC8vVE9ETyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcmVhY3RhbnRzLXByb2R1Y3RzLWFuZC1sZWZ0b3ZlcnMvaXNzdWVzLzc4IHBoZXRpb0RvY3VtZW50YXRpb25cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyByZWFkLW9ubHlcclxuICAgIHRoaXMuY2hhbGxlbmdlcyA9IFtdO1xyXG4gICAgdGhpcy5iZXN0U2NvcmVQcm9wZXJ0aWVzID0gW107XHJcbiAgICB0aGlzLmJlc3RUaW1lUHJvcGVydGllcyA9IFtdO1xyXG4gICAgdGhpcy5pc05ld0Jlc3RUaW1lID0gZmFsc2U7XHJcbiAgICBjb25zdCBiZXN0U2NvcmVzVGFuZGVtID0gdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2Jlc3RTY29yZXMnICk7XHJcbiAgICBjb25zdCBiZXN0VGltZXNUYW5kZW0gPSB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnYmVzdFRpbWVzJyApO1xyXG4gICAgZm9yICggbGV0IGxldmVsID0gMDsgbGV2ZWwgPCB0aGlzLm51bWJlck9mTGV2ZWxzOyBsZXZlbCsrICkge1xyXG5cclxuICAgICAgdGhpcy5iZXN0U2NvcmVQcm9wZXJ0aWVzLnB1c2goIG5ldyBOdW1iZXJQcm9wZXJ0eSggMCwge1xyXG4gICAgICAgIG51bWJlclR5cGU6ICdJbnRlZ2VyJyxcclxuICAgICAgICB0YW5kZW06IGJlc3RTY29yZXNUYW5kZW0uY3JlYXRlVGFuZGVtKCBgYmVzdFNjb3JlJHtsZXZlbH1Qcm9wZXJ0eWAgKVxyXG4gICAgICB9ICkgKTtcclxuXHJcbiAgICAgIHRoaXMuYmVzdFRpbWVQcm9wZXJ0aWVzLnB1c2goIG5ldyBQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCwge1xyXG4gICAgICAgIHRhbmRlbTogYmVzdFRpbWVzVGFuZGVtLmNyZWF0ZVRhbmRlbSggYGJlc3RUaW1lJHtsZXZlbH1Qcm9wZXJ0eWAgKSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IE51bGxhYmxlSU8oIE51bWJlcklPIClcclxuICAgICAgICAvL1RPRE8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3JlYWN0YW50cy1wcm9kdWN0cy1hbmQtbGVmdG92ZXJzL2lzc3Vlcy83OCBwaGV0aW9Eb2N1bWVudGF0aW9uXHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMudGltZXIgPSBuZXcgR2FtZVRpbWVyKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcblxyXG4gICAgLy8gcmVzZXQgUHJvcGVydGllc1xyXG4gICAgdGhpcy50aW1lckVuYWJsZWRQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5nYW1lVmlzaWJpbGl0eVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmxldmVsUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuc2NvcmVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5udW1iZXJPZkNoYWxsZW5nZXNQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5jaGFsbGVuZ2VQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5jaGFsbGVuZ2VJbmRleFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmdhbWVQaGFzZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLnBsYXlTdGF0ZVByb3BlcnR5LnJlc2V0KCk7XHJcblxyXG4gICAgLy8gcmVzZXQgc2NvcmVzIGFuZCB0aW1lcyBmb3IgZWFjaCBsZXZlbFxyXG4gICAgdGhpcy5iZXN0U2NvcmVQcm9wZXJ0aWVzLmZvckVhY2goIHByb3BlcnR5ID0+IHtcclxuICAgICAgcHJvcGVydHkudmFsdWUgPSAwO1xyXG4gICAgfSApO1xyXG4gICAgdGhpcy5iZXN0VGltZVByb3BlcnRpZXMuZm9yRWFjaCggcHJvcGVydHkgPT4ge1xyXG4gICAgICBwcm9wZXJ0eS52YWx1ZSA9IG51bGw7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvLyBBZHZhbmNlcyB0byBHYW1lUGhhc2UuU0VUVElOR1MsIHNob3dzIHRoZSB1c2VyLWludGVyZmFjZSBmb3Igc2VsZWN0aW5nIGdhbWUgc2V0dGluZ3MuXHJcbiAgcHVibGljIHNldHRpbmdzKCk6IHZvaWQge1xyXG4gICAgdGhpcy50aW1lci5zdG9wKCk7XHJcbiAgICB0aGlzLnBsYXlTdGF0ZVByb3BlcnR5LnZhbHVlID0gUGxheVN0YXRlLk5PTkU7XHJcbiAgICB0aGlzLmdhbWVQaGFzZVByb3BlcnR5LnZhbHVlID0gR2FtZVBoYXNlLlNFVFRJTkdTOyAvLyBkbyB0aGlzIGxhc3QsIHNvIHRoYXQgb3RoZXIgc3R1ZmYgaXMgc2V0IHVwIGJlZm9yZSBvYnNlcnZlcnMgYXJlIG5vdGlmaWVkXHJcbiAgfVxyXG5cclxuICAvLyBBZHZhbmNlcyB0byBHYW1lUGhhc2UuUExBWSwgdG8gcGxheSBhIGdhbWUgZm9yIHRoZSBzcGVjaWZpZWQgbGV2ZWwuXHJcbiAgcHVibGljIHBsYXkoIGxldmVsOiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmdhbWVQaGFzZVByb3BlcnR5LnZhbHVlID09PSBHYW1lUGhhc2UuU0VUVElOR1MgKTtcclxuICAgIHRoaXMubGV2ZWxQcm9wZXJ0eS52YWx1ZSA9IGxldmVsO1xyXG4gICAgdGhpcy5zY29yZVByb3BlcnR5LnZhbHVlID0gMDtcclxuICAgIHRoaXMuaW5pdENoYWxsZW5nZXMoKTtcclxuICAgIHRoaXMudGltZXIuc3RhcnQoKTtcclxuICAgIHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWUgPSBQbGF5U3RhdGUuRklSU1RfQ0hFQ0s7XHJcbiAgICB0aGlzLmdhbWVQaGFzZVByb3BlcnR5LnZhbHVlID0gR2FtZVBoYXNlLlBMQVk7IC8vIGRvIHRoaXMgbGFzdCwgc28gdGhhdCBvdGhlciBzdHVmZiBpcyBzZXQgdXAgYmVmb3JlIG9ic2VydmVycyBhcmUgbm90aWZpZWRcclxuICB9XHJcblxyXG4gIC8vIEFkdmFuY2VzIHRvIEdhbWVQaGFzZS5SRVNVTFRTLCBlbmRzIHRoZSBjdXJyZW50IGdhbWUgYW5kIGRpc3BsYXlzIHJlc3VsdHMuXHJcbiAgcHJpdmF0ZSByZXN1bHRzKCk6IHZvaWQge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5nYW1lUGhhc2VQcm9wZXJ0eS52YWx1ZSA9PT0gR2FtZVBoYXNlLlBMQVkgKTtcclxuICAgIHRoaXMudGltZXIuc3RvcCgpO1xyXG4gICAgdGhpcy51cGRhdGVCZXN0U2NvcmUoKTtcclxuICAgIHRoaXMudXBkYXRlQmVzdFRpbWUoKTtcclxuICAgIHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWUgPSBQbGF5U3RhdGUuTk9ORTtcclxuICAgIHRoaXMuZ2FtZVBoYXNlUHJvcGVydHkudmFsdWUgPSBHYW1lUGhhc2UuUkVTVUxUUzsgLy8gZG8gdGhpcyBsYXN0LCBzbyB0aGF0IG90aGVyIHN0dWZmIGlzIHNldCB1cCBiZWZvcmUgb2JzZXJ2ZXJzIGFyZSBub3RpZmllZFxyXG4gIH1cclxuXHJcbiAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IGd1ZXNzLlxyXG4gIHB1YmxpYyBjaGVjaygpOiB2b2lkIHtcclxuICAgIGNvbnN0IHBsYXlTdGF0ZSA9IHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWU7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBwbGF5U3RhdGUgPT09IFBsYXlTdGF0ZS5GSVJTVF9DSEVDSyB8fCBwbGF5U3RhdGUgPT09IFBsYXlTdGF0ZS5TRUNPTkRfQ0hFQ0sgKTtcclxuXHJcbiAgICBjb25zdCBjaGFsbGVuZ2UgPSB0aGlzLmNoYWxsZW5nZVByb3BlcnR5LnZhbHVlITtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGNoYWxsZW5nZSApO1xyXG5cclxuICAgIGlmICggY2hhbGxlbmdlLmlzQ29ycmVjdCgpICkge1xyXG4gICAgICAvLyBzdG9wIHRoZSB0aW1lciBhcyBzb29uIGFzIHdlIHN1Y2Nlc3NmdWxseSBjb21wbGV0ZSB0aGUgbGFzdCBjaGFsbGVuZ2VcclxuICAgICAgaWYgKCB0aGlzLmNoYWxsZW5nZUluZGV4UHJvcGVydHkudmFsdWUgPT09IHRoaXMuY2hhbGxlbmdlcy5sZW5ndGggLSAxICkge1xyXG4gICAgICAgIHRoaXMudGltZXIuc3RvcCgpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHBvaW50cyA9ICggcGxheVN0YXRlID09PSBQbGF5U3RhdGUuRklSU1RfQ0hFQ0sgKSA/IFBPSU5UU19GSVJTVF9DSEVDSyA6IFBPSU5UU19TRUNPTkRfQ0hFQ0s7XHJcbiAgICAgIGNoYWxsZW5nZS5wb2ludHMgPSBwb2ludHM7XHJcbiAgICAgIHRoaXMuc2NvcmVQcm9wZXJ0eS52YWx1ZSA9IHRoaXMuc2NvcmVQcm9wZXJ0eS52YWx1ZSArIHBvaW50cztcclxuICAgICAgdGhpcy5wbGF5U3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFBsYXlTdGF0ZS5ORVhUO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWUgPSAoIHBsYXlTdGF0ZSA9PT0gUGxheVN0YXRlLkZJUlNUX0NIRUNLICkgPyBQbGF5U3RhdGUuVFJZX0FHQUlOIDogUGxheVN0YXRlLlNIT1dfQU5TV0VSO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gTWFrZXMgYW5vdGhlciBhdHRlbXB0IGF0IHNvbHZpbmcgdGhlIGNoYWxsZW5nZS5cclxuICBwdWJsaWMgdHJ5QWdhaW4oKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLnBsYXlTdGF0ZVByb3BlcnR5LnZhbHVlID09PSBQbGF5U3RhdGUuVFJZX0FHQUlOICk7XHJcbiAgICB0aGlzLnBsYXlTdGF0ZVByb3BlcnR5LnZhbHVlID0gUGxheVN0YXRlLlNFQ09ORF9DSEVDSztcclxuICB9XHJcblxyXG4gIC8vIFNob3dzIHRoZSBjb3JyZWN0IGFuc3dlci5cclxuICBwdWJsaWMgc2hvd0Fuc3dlcigpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWUgPT09IFBsYXlTdGF0ZS5TSE9XX0FOU1dFUiApO1xyXG4gICAgY29uc3QgY2hhbGxlbmdlID0gdGhpcy5jaGFsbGVuZ2VQcm9wZXJ0eS52YWx1ZSE7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBjaGFsbGVuZ2UgKTtcclxuICAgIGNoYWxsZW5nZS5zaG93QW5zd2VyKCk7XHJcbiAgICB0aGlzLnBsYXlTdGF0ZVByb3BlcnR5LnZhbHVlID0gUGxheVN0YXRlLk5FWFQ7XHJcbiAgfVxyXG5cclxuICAvLyBBZHZhbmNlcyB0byB0aGUgbmV4dCBjaGFsbGVuZ2UuXHJcbiAgcHVibGljIG5leHQoKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMuY2hhbGxlbmdlSW5kZXhQcm9wZXJ0eS52YWx1ZSA9PT0gdGhpcy5jaGFsbGVuZ2VzLmxlbmd0aCAtIDEgKSB7XHJcbiAgICAgIC8vIGdhbWUgaGFzIGJlZW4gY29tcGxldGVkLCBhZHZhbmNlIHRvIEdhbWVQaGFzZS5SRVNVTFRTXHJcbiAgICAgIHRoaXMucmVzdWx0cygpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIC8vIGFkdmFuY2UgdG8gbmV4dCBjaGFsbGVuZ2VcclxuICAgICAgdGhpcy5jaGFsbGVuZ2VJbmRleFByb3BlcnR5LnZhbHVlID0gdGhpcy5jaGFsbGVuZ2VJbmRleFByb3BlcnR5LnZhbHVlICsgMTtcclxuICAgICAgdGhpcy5jaGFsbGVuZ2VQcm9wZXJ0eS52YWx1ZSA9IHRoaXMuY2hhbGxlbmdlc1sgdGhpcy5jaGFsbGVuZ2VJbmRleFByb3BlcnR5LnZhbHVlIF07XHJcbiAgICAgIHRoaXMucGxheVN0YXRlUHJvcGVydHkudmFsdWUgPSBQbGF5U3RhdGUuRklSU1RfQ0hFQ0s7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgY2hhbGxlbmdlcyBmb3IgdGhlIHNwZWNpZmllZCBsZXZlbC5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0TnVtYmVyT2ZDaGFsbGVuZ2VzKCBsZXZlbDogbnVtYmVyICk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gQ2hhbGxlbmdlRmFjdG9yeS5nZXROdW1iZXJPZkNoYWxsZW5nZXMoIGxldmVsICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBwZXJmZWN0IHNjb3JlIGZvciB0aGUgc3BlY2lmaWVkIGxldmVsLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQZXJmZWN0U2NvcmUoIGxldmVsOiBudW1iZXIgKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBDaGFsbGVuZ2VGYWN0b3J5LmdldE51bWJlck9mQ2hhbGxlbmdlcyggbGV2ZWwgKSAqIFBPSU5UU19GSVJTVF9DSEVDSztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIElzIHRoZSBjdXJyZW50IHNjb3JlIHBlcmZlY3Q/XHJcbiAgICovXHJcbiAgcHVibGljIGlzUGVyZmVjdFNjb3JlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICggdGhpcy5zY29yZVByb3BlcnR5LnZhbHVlID09PSB0aGlzLmdldFBlcmZlY3RTY29yZSggdGhpcy5sZXZlbFByb3BlcnR5LnZhbHVlICkgKTtcclxuICB9XHJcblxyXG4gIC8vIFVwZGF0ZXMgdGhlIGJlc3Qgc2NvcmUgZm9yIHRoZSBjdXJyZW50IGxldmVsLlxyXG4gIHByaXZhdGUgdXBkYXRlQmVzdFNjb3JlKCk6IHZvaWQge1xyXG4gICAgY29uc3QgbGV2ZWwgPSB0aGlzLmxldmVsUHJvcGVydHkudmFsdWU7XHJcbiAgICBpZiAoIHRoaXMuc2NvcmVQcm9wZXJ0eS52YWx1ZSA+IHRoaXMuYmVzdFNjb3JlUHJvcGVydGllc1sgbGV2ZWwgXS52YWx1ZSApIHtcclxuICAgICAgdGhpcy5iZXN0U2NvcmVQcm9wZXJ0aWVzWyBsZXZlbCBdLnZhbHVlID0gdGhpcy5zY29yZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gVXBkYXRlcyB0aGUgYmVzdCB0aW1lIGZvciB0aGUgY3VycmVudCBsZXZlbCwgYXQgdGhlIGVuZCBvZiBhIHRpbWVkIGdhbWUgd2l0aCBhIHBlcmZlY3Qgc2NvcmUuXHJcbiAgcHJpdmF0ZSB1cGRhdGVCZXN0VGltZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLnRpbWVyLmlzUnVubmluZ1Byb3BlcnR5LnZhbHVlICk7XHJcbiAgICB0aGlzLmlzTmV3QmVzdFRpbWUgPSBmYWxzZTtcclxuICAgIGlmICggdGhpcy50aW1lckVuYWJsZWRQcm9wZXJ0eS52YWx1ZSAmJiB0aGlzLmlzUGVyZmVjdFNjb3JlKCkgKSB7XHJcbiAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5sZXZlbFByb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCB0aW1lID0gdGhpcy50aW1lci5lbGFwc2VkVGltZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBiZXN0VGltZSA9IHRoaXMuYmVzdFRpbWVQcm9wZXJ0aWVzWyBsZXZlbCBdLnZhbHVlO1xyXG4gICAgICBpZiAoIGJlc3RUaW1lID09PSBudWxsICkge1xyXG4gICAgICAgIC8vIFRoZXJlIHdhcyBubyBwcmV2aW91cyBiZXN0IHRpbWUgZm9yIHRoaXMgbGV2ZWwuXHJcbiAgICAgICAgdGhpcy5iZXN0VGltZVByb3BlcnRpZXNbIGxldmVsIF0udmFsdWUgPSB0aW1lO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCB0aW1lIDwgYmVzdFRpbWUgKSB7XHJcbiAgICAgICAgLy8gV2UgaGF2ZSBhIG5ldyBiZXN0IHRpbWUgZm9yIHRoaXMgbGV2ZWwuXHJcbiAgICAgICAgdGhpcy5iZXN0VGltZVByb3BlcnRpZXNbIGxldmVsIF0udmFsdWUgPSB0aW1lO1xyXG4gICAgICAgIHRoaXMuaXNOZXdCZXN0VGltZSA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEluaXRpYWxpemVzIGEgbmV3IHNldCBvZiBjaGFsbGVuZ2VzIGZvciB0aGUgY3VycmVudCBsZXZlbC5cclxuICBwcml2YXRlIGluaXRDaGFsbGVuZ2VzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jaGFsbGVuZ2VzID0gQ2hhbGxlbmdlRmFjdG9yeS5jcmVhdGVDaGFsbGVuZ2VzKCB0aGlzLmxldmVsUHJvcGVydHkudmFsdWUsIHRoaXMubWF4UXVhbnRpdHksIHtcclxuICAgICAgbW9sZWN1bGVzVmlzaWJsZTogKCB0aGlzLmdhbWVWaXNpYmlsaXR5UHJvcGVydHkudmFsdWUgIT09IEdhbWVWaXNpYmlsaXR5LkhJREVfTU9MRUNVTEVTICksXHJcbiAgICAgIG51bWJlcnNWaXNpYmxlOiAoIHRoaXMuZ2FtZVZpc2liaWxpdHlQcm9wZXJ0eS52YWx1ZSAhPT0gR2FtZVZpc2liaWxpdHkuSElERV9OVU1CRVJTIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMubnVtYmVyT2ZDaGFsbGVuZ2VzUHJvcGVydHkudmFsdWUgPSB0aGlzLmNoYWxsZW5nZXMubGVuZ3RoO1xyXG4gICAgdGhpcy5jaGFsbGVuZ2VJbmRleFByb3BlcnR5LnZhbHVlID0gMDtcclxuICAgIHRoaXMuY2hhbGxlbmdlUHJvcGVydHkudmFsdWUgPSB0aGlzLmNoYWxsZW5nZXNbIHRoaXMuY2hhbGxlbmdlSW5kZXhQcm9wZXJ0eS52YWx1ZSBdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogREVCVUc6IFNraXBzIHRoZSBjdXJyZW50IGNoYWxsZW5nZS4gU2NvcmUgYW5kIGJlc3QgdGltZXMgYXJlIG1lYW5pbmdsZXNzIGFmdGVyIHVzaW5nIHRoaXMuIFRoaXMgaXMgYSBkZXZlbG9wZXIgZmVhdHVyZS5cclxuICAgKi9cclxuICBwdWJsaWMgc2tpcEN1cnJlbnRDaGFsbGVuZ2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLm5leHQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERFQlVHOiBSZXBsYXlzIHRoZSBjdXJyZW50IGNoYWxsZW5nZS4gU2NvcmUgYW5kIGJlc3QgdGltZXMgYXJlIG1lYW5pbmdsZXNzIGFmdGVyIHVzaW5nIHRoaXMuIFRoaXMgaXMgYSBkZXZlbG9wZXIgZmVhdHVyZS5cclxuICAgKi9cclxuICBwdWJsaWMgcmVwbGF5Q3VycmVudENoYWxsZW5nZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hhbGxlbmdlUHJvcGVydHkudmFsdWUgJiYgdGhpcy5jaGFsbGVuZ2VQcm9wZXJ0eS52YWx1ZS5yZXNldCgpO1xyXG4gICAgdGhpcy5wbGF5U3RhdGVQcm9wZXJ0eS52YWx1ZSA9IFBsYXlTdGF0ZS5GSVJTVF9DSEVDSztcclxuICB9XHJcbn1cclxuXHJcbnJlYWN0YW50c1Byb2R1Y3RzQW5kTGVmdG92ZXJzLnJlZ2lzdGVyKCAnR2FtZU1vZGVsJywgR2FtZU1vZGVsICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxtQkFBbUIsTUFBTSw0Q0FBNEM7QUFDNUUsT0FBT0MsY0FBYyxNQUFNLHVDQUF1QztBQUNsRSxPQUFPQyxRQUFRLE1BQU0saUNBQWlDO0FBRXRELE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7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