// Copyright 2013-2022, University of Colorado Boulder

/**
 * View for the string
 *
 * Author: Anton Ulyanov (Mlearner)
 */

import { Shape } from '../../../../kite/js/imports.js';
import { Circle, Image, Node, Path } from '../../../../scenery/js/imports.js';
import waveOnAString from '../../waveOnAString.js';
class StringNode extends Node {
  /**
   * @param {WOASModel} model
   * @param {Emitter} frameEmitter - Emits an event when the animation frame changes
   * @param {Object} [options]
   */
  constructor(model, frameEmitter, options) {
    super({
      layerSplit: true
    });
    let stringShape = new Shape();
    const stringPath = new Path(stringShape, {
      stroke: '#F00'
    });
    const beads = [];
    this.addChild(stringPath);
    stringPath.computeShapeBounds = function () {
      return this.getShape().bounds.dilated(20); // miterLimit should cut off with the normal stroke before this
    };

    const highlightCircle = new Circle(options.radius * 0.3, {
      fill: '#fff',
      x: -0.45 * options.radius,
      y: -0.45 * options.radius
    });
    const scale = 3;
    const redBead = new Circle(options.radius, {
      fill: 'red',
      stroke: 'black',
      lineWidth: 0.5,
      children: [highlightCircle],
      scale: scale
    });
    const limeBead = new Circle(options.radius, {
      fill: 'lime',
      stroke: 'black',
      lineWidth: 0.5,
      children: [highlightCircle],
      scale: scale
    });
    let redNode;
    redBead.toDataURL((url, x, y) => {
      redNode = new Image(url, {
        x: -x / scale,
        y: -y / scale,
        scale: 1 / scale
      });
    });
    let limeNode;
    limeBead.toDataURL((url, x, y) => {
      limeNode = new Image(url, {
        x: -x / scale,
        y: -y / scale,
        scale: 1 / scale
      });
    });
    for (let i = 0; i < model.yDraw.length; i++) {
      const bead = i % 10 === 0 ? limeNode : redNode;
      beads.push(new Node({
        x: i * options.radius * 2,
        children: [bead]
      }));
    }
    beads[0].scale(1.2);
    this.addChild(new Node({
      children: beads
    }));
    this.mutate(options);
    let dirty = true;
    model.yNowChangedEmitter.addListener(() => {
      dirty = true;
    });
    frameEmitter.addListener(() => {
      if (dirty) {
        stringShape = new Shape();
        beads[0].y = model.nextLeftYProperty.value;
        stringShape.lineTo(0, model.nextLeftYProperty.value || 0);
        for (let i = 1; i < model.yDraw.length; i++) {
          beads[i].y = model.yDraw[i];
          /*REVIEW:
           * A lot of the performance issues relate to this shape drawing. There's nothing you can do here,
           * I'll hopefully have speed improvements to Kite's Shape soon to make this much faster. Sorry!
           */
          stringShape.lineTo(i * options.radius * 2, model.yDraw[i] || 0);
        }
        stringPath.shape = stringShape;
        dirty = false;
      }
    });
  }
}
waveOnAString.register('StringNode', StringNode);
export default StringNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaGFwZSIsIkNpcmNsZSIsIkltYWdlIiwiTm9kZSIsIlBhdGgiLCJ3YXZlT25BU3RyaW5nIiwiU3RyaW5nTm9kZSIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJmcmFtZUVtaXR0ZXIiLCJvcHRpb25zIiwibGF5ZXJTcGxpdCIsInN0cmluZ1NoYXBlIiwic3RyaW5nUGF0aCIsInN0cm9rZSIsImJlYWRzIiwiYWRkQ2hpbGQiLCJjb21wdXRlU2hhcGVCb3VuZHMiLCJnZXRTaGFwZSIsImJvdW5kcyIsImRpbGF0ZWQiLCJoaWdobGlnaHRDaXJjbGUiLCJyYWRpdXMiLCJmaWxsIiwieCIsInkiLCJzY2FsZSIsInJlZEJlYWQiLCJsaW5lV2lkdGgiLCJjaGlsZHJlbiIsImxpbWVCZWFkIiwicmVkTm9kZSIsInRvRGF0YVVSTCIsInVybCIsImxpbWVOb2RlIiwiaSIsInlEcmF3IiwibGVuZ3RoIiwiYmVhZCIsInB1c2giLCJtdXRhdGUiLCJkaXJ0eSIsInlOb3dDaGFuZ2VkRW1pdHRlciIsImFkZExpc3RlbmVyIiwibmV4dExlZnRZUHJvcGVydHkiLCJ2YWx1ZSIsImxpbmVUbyIsInNoYXBlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTdHJpbmdOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZpZXcgZm9yIHRoZSBzdHJpbmdcclxuICpcclxuICogQXV0aG9yOiBBbnRvbiBVbHlhbm92IChNbGVhcm5lcilcclxuICovXHJcblxyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCB7IENpcmNsZSwgSW1hZ2UsIE5vZGUsIFBhdGggfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgd2F2ZU9uQVN0cmluZyBmcm9tICcuLi8uLi93YXZlT25BU3RyaW5nLmpzJztcclxuXHJcbmNsYXNzIFN0cmluZ05vZGUgZXh0ZW5kcyBOb2RlIHtcclxuICAvKipcclxuICAgKiBAcGFyYW0ge1dPQVNNb2RlbH0gbW9kZWxcclxuICAgKiBAcGFyYW0ge0VtaXR0ZXJ9IGZyYW1lRW1pdHRlciAtIEVtaXRzIGFuIGV2ZW50IHdoZW4gdGhlIGFuaW1hdGlvbiBmcmFtZSBjaGFuZ2VzXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBtb2RlbCwgZnJhbWVFbWl0dGVyLCBvcHRpb25zICkge1xyXG4gICAgc3VwZXIoIHsgbGF5ZXJTcGxpdDogdHJ1ZSB9ICk7XHJcblxyXG4gICAgbGV0IHN0cmluZ1NoYXBlID0gbmV3IFNoYXBlKCk7XHJcbiAgICBjb25zdCBzdHJpbmdQYXRoID0gbmV3IFBhdGgoIHN0cmluZ1NoYXBlLCB7XHJcbiAgICAgIHN0cm9rZTogJyNGMDAnXHJcbiAgICB9ICk7XHJcbiAgICBjb25zdCBiZWFkcyA9IFtdO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggc3RyaW5nUGF0aCApO1xyXG5cclxuICAgIHN0cmluZ1BhdGguY29tcHV0ZVNoYXBlQm91bmRzID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldFNoYXBlKCkuYm91bmRzLmRpbGF0ZWQoIDIwICk7IC8vIG1pdGVyTGltaXQgc2hvdWxkIGN1dCBvZmYgd2l0aCB0aGUgbm9ybWFsIHN0cm9rZSBiZWZvcmUgdGhpc1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBoaWdobGlnaHRDaXJjbGUgPSBuZXcgQ2lyY2xlKCBvcHRpb25zLnJhZGl1cyAqIDAuMywge1xyXG4gICAgICBmaWxsOiAnI2ZmZicsXHJcbiAgICAgIHg6IC0wLjQ1ICogb3B0aW9ucy5yYWRpdXMsXHJcbiAgICAgIHk6IC0wLjQ1ICogb3B0aW9ucy5yYWRpdXNcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IHNjYWxlID0gMztcclxuICAgIGNvbnN0IHJlZEJlYWQgPSBuZXcgQ2lyY2xlKCBvcHRpb25zLnJhZGl1cywge1xyXG4gICAgICBmaWxsOiAncmVkJyxcclxuICAgICAgc3Ryb2tlOiAnYmxhY2snLFxyXG4gICAgICBsaW5lV2lkdGg6IDAuNSxcclxuICAgICAgY2hpbGRyZW46IFsgaGlnaGxpZ2h0Q2lyY2xlIF0sXHJcbiAgICAgIHNjYWxlOiBzY2FsZVxyXG4gICAgfSApO1xyXG4gICAgY29uc3QgbGltZUJlYWQgPSBuZXcgQ2lyY2xlKCBvcHRpb25zLnJhZGl1cywge1xyXG4gICAgICBmaWxsOiAnbGltZScsXHJcbiAgICAgIHN0cm9rZTogJ2JsYWNrJyxcclxuICAgICAgbGluZVdpZHRoOiAwLjUsXHJcbiAgICAgIGNoaWxkcmVuOiBbIGhpZ2hsaWdodENpcmNsZSBdLFxyXG4gICAgICBzY2FsZTogc2NhbGVcclxuICAgIH0gKTtcclxuXHJcbiAgICBsZXQgcmVkTm9kZTtcclxuICAgIHJlZEJlYWQudG9EYXRhVVJMKCAoIHVybCwgeCwgeSApID0+IHtcclxuICAgICAgcmVkTm9kZSA9IG5ldyBJbWFnZSggdXJsLCB7IHg6IC14IC8gc2NhbGUsIHk6IC15IC8gc2NhbGUsIHNjYWxlOiAxIC8gc2NhbGUgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGxldCBsaW1lTm9kZTtcclxuICAgIGxpbWVCZWFkLnRvRGF0YVVSTCggKCB1cmwsIHgsIHkgKSA9PiB7XHJcbiAgICAgIGxpbWVOb2RlID0gbmV3IEltYWdlKCB1cmwsIHsgeDogLXggLyBzY2FsZSwgeTogLXkgLyBzY2FsZSwgc2NhbGU6IDEgLyBzY2FsZSB9ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgbW9kZWwueURyYXcubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IGJlYWQgPSAoIGkgJSAxMCA9PT0gMCApID8gbGltZU5vZGUgOiByZWROb2RlO1xyXG4gICAgICBiZWFkcy5wdXNoKCBuZXcgTm9kZSggeyB4OiBpICogb3B0aW9ucy5yYWRpdXMgKiAyLCBjaGlsZHJlbjogWyBiZWFkIF0gfSApICk7XHJcbiAgICB9XHJcbiAgICBiZWFkc1sgMCBdLnNjYWxlKCAxLjIgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIG5ldyBOb2RlKCB7IGNoaWxkcmVuOiBiZWFkcyB9ICkgKTtcclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG5cclxuICAgIGxldCBkaXJ0eSA9IHRydWU7XHJcbiAgICBtb2RlbC55Tm93Q2hhbmdlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuICAgICAgZGlydHkgPSB0cnVlO1xyXG4gICAgfSApO1xyXG4gICAgZnJhbWVFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcbiAgICAgIGlmICggZGlydHkgKSB7XHJcbiAgICAgICAgc3RyaW5nU2hhcGUgPSBuZXcgU2hhcGUoKTtcclxuICAgICAgICBiZWFkc1sgMCBdLnkgPSBtb2RlbC5uZXh0TGVmdFlQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgICBzdHJpbmdTaGFwZS5saW5lVG8oIDAsIG1vZGVsLm5leHRMZWZ0WVByb3BlcnR5LnZhbHVlIHx8IDAgKTtcclxuICAgICAgICBmb3IgKCBsZXQgaSA9IDE7IGkgPCBtb2RlbC55RHJhdy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICAgIGJlYWRzWyBpIF0ueSA9IG1vZGVsLnlEcmF3WyBpIF07XHJcbiAgICAgICAgICAvKlJFVklFVzpcclxuICAgICAgICAgICAqIEEgbG90IG9mIHRoZSBwZXJmb3JtYW5jZSBpc3N1ZXMgcmVsYXRlIHRvIHRoaXMgc2hhcGUgZHJhd2luZy4gVGhlcmUncyBub3RoaW5nIHlvdSBjYW4gZG8gaGVyZSxcclxuICAgICAgICAgICAqIEknbGwgaG9wZWZ1bGx5IGhhdmUgc3BlZWQgaW1wcm92ZW1lbnRzIHRvIEtpdGUncyBTaGFwZSBzb29uIHRvIG1ha2UgdGhpcyBtdWNoIGZhc3Rlci4gU29ycnkhXHJcbiAgICAgICAgICAgKi9cclxuICAgICAgICAgIHN0cmluZ1NoYXBlLmxpbmVUbyggaSAqIG9wdGlvbnMucmFkaXVzICogMiwgbW9kZWwueURyYXdbIGkgXSB8fCAwICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0cmluZ1BhdGguc2hhcGUgPSBzdHJpbmdTaGFwZTtcclxuXHJcbiAgICAgICAgZGlydHkgPSBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxud2F2ZU9uQVN0cmluZy5yZWdpc3RlciggJ1N0cmluZ05vZGUnLCBTdHJpbmdOb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IFN0cmluZ05vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQVNBLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsU0FBU0MsTUFBTSxFQUFFQyxLQUFLLEVBQUVDLElBQUksRUFBRUMsSUFBSSxRQUFRLG1DQUFtQztBQUM3RSxPQUFPQyxhQUFhLE1BQU0sd0JBQXdCO0FBRWxELE1BQU1DLFVBQVUsU0FBU0gsSUFBSSxDQUFDO0VBQzVCO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7RUFDRUksV0FBV0EsQ0FBRUMsS0FBSyxFQUFFQyxZQUFZLEVBQUVDLE9BQU8sRUFBRztJQUMxQyxLQUFLLENBQUU7TUFBRUMsVUFBVSxFQUFFO0lBQUssQ0FBRSxDQUFDO0lBRTdCLElBQUlDLFdBQVcsR0FBRyxJQUFJWixLQUFLLENBQUMsQ0FBQztJQUM3QixNQUFNYSxVQUFVLEdBQUcsSUFBSVQsSUFBSSxDQUFFUSxXQUFXLEVBQUU7TUFDeENFLE1BQU0sRUFBRTtJQUNWLENBQUUsQ0FBQztJQUNILE1BQU1DLEtBQUssR0FBRyxFQUFFO0lBQ2hCLElBQUksQ0FBQ0MsUUFBUSxDQUFFSCxVQUFXLENBQUM7SUFFM0JBLFVBQVUsQ0FBQ0ksa0JBQWtCLEdBQUcsWUFBVztNQUN6QyxPQUFPLElBQUksQ0FBQ0MsUUFBUSxDQUFDLENBQUMsQ0FBQ0MsTUFBTSxDQUFDQyxPQUFPLENBQUUs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