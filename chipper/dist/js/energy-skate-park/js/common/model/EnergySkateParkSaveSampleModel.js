// Copyright 2019-2022, University of Colorado Boulder

/**
 * An EnergySkateParkTrackSetModel that can save EnergySkateParkDataSamples. EnergySkateParkDataSamples contain information about the physical
 * state of the skater at a point in time.
 *
 * Generally, it is up to the subtype of EnergySkateParkSaveSampleModel to clear data at the correct time, as different
 * presentations of this data need to persist in different cases. But maxNumberOfSamples can be specified to keep
 * at most that number of samples at a time.
 *
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import createObservableArray from '../../../../axon/js/createObservableArray.js';
import Emitter from '../../../../axon/js/Emitter.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import merge from '../../../../phet-core/js/merge.js';
import energySkatePark from '../../energySkatePark.js';
import EnergySkateParkDataSample from './EnergySkateParkDataSample.js';
import EnergySkateParkModel from './EnergySkateParkModel.js';
class EnergySkateParkSaveSampleModel extends EnergySkateParkModel {
  /**
   * @param {EnergySkateParkPreferencesModel} preferencesModel
   * @param {Tandem} tandem
   * @param {Object} [options]
   */
  constructor(preferencesModel, tandem, options) {
    options = merge({
      // {boolean} - the default value for whether or not the model is saving
      // samples of data for display
      defaultSaveSamples: true,
      // {number} - the interval at which we save EnergySkateParkDataSamples, in seconds
      saveSampleInterval: 0.1,
      // {number} skater samples which are being removed will fade away at this rate every animation frame
      // like opacity = opacity * sampleFadeDecay
      sampleFadeDecay: 0.95,
      // {number} - the maximum number of EnergySkateParkDataSamples saved by this model, to prevent from saving too many if we
      // run without encountering a case that clears old samples
      maxNumberOfSamples: 50
    }, options);
    super(preferencesModel, tandem, options);

    // @private {number}
    this.saveSampleInterval = options.saveSampleInterval;
    this.maxNumberOfSamples = options.maxNumberOfSamples;
    this.sampleFadeDecay = options.sampleFadeDecay;

    // @private {number} - amount of time that has elapsed since a skater sample has been saved
    this.timeSinceSampleSave = 0;

    // @public {boolean} - whether or not to limit the number of samples to be saved - if false, which
    // can be done if you are ok with saving limitless samples, options.maxNumberOfSamples has no impact
    this.limitNumberOfSamples = true;

    // @public {BooleanProperty} - controls whether or not samples are saved as the model steps through time
    this.saveSamplesProperty = new BooleanProperty(options.defaultSaveSamples, {
      tandem: tandem.createTandem('saveSamplesProperty')
    });

    // @public {boolean} - set to true to prevent the model from saving any more samples, even if
    // saveSamplesProperty is true - this can be used instead of (or in combination with) maxNumberOfSamples\
    // to prevent the model from saving too many samples for reasons other than array length
    this.preventSampleSave = false;

    // @public - in seconds, how much time has passed since beginning to record skater states
    this.sampleTimeProperty = new NumberProperty(0);

    // @protected {ObservableArrayDef.<EnergySkateParkDataSample>} - observable list of all saved EnergySkateParkDataSamples
    this.dataSamples = createObservableArray();

    // @public (read-only) - an array of EnergySkateParkDataSamples that have just been removed from the model. Necessary
    // for performance so that we can update once after removing many samples rather than every time
    // a single sample is removed
    this.batchRemoveSamplesEmitter = new Emitter({
      parameters: [{
        isValidValue: value => Array.isArray(value) && value.every(element => element instanceof EnergySkateParkDataSample)
      }]
    });
  }

  /**
   * Set model state from a saved sample, potentially modifying Skater, Track, and other things.
   * @public
   *
   * @param {EnergySkateParkDataSample} dataSample
   */
  setFromSample(dataSample) {
    dataSample.skaterState.setToSkater(this.skater);

    // restore friction and stickingToTrackProperty (all other Properties are set on Skater)
    this.frictionProperty.set(dataSample.friction);
    this.stickingToTrackProperty.set(dataSample.stickingToTrack);
    if (dataSample.track) {
      assert && assert(dataSample.track === this.skater.trackProperty.get(), 'only the active track can be set from sample');
      dataSample.trackControlPointPositions.forEach((position, i) => {
        this.skater.trackProperty.get().controlPoints[i].sourcePositionProperty.set(position);
      });

      // make sure control points are constrained, and update splines and shape
      this.skater.trackProperty.get().containControlPointsInLimitBounds(true);
    }
  }

  /**
   * Clear all saved data immediately and prepare to save data again.
   * @public
   */
  clearEnergyData() {
    this.batchRemoveSamples(this.dataSamples.slice());
    this.sampleTimeProperty.reset();
    this.timeSinceSampleSave = 0;
  }

  /**
   * EnergySkateParkDataSamples are removed from the model in batches for performance. This way we can remove many
   * EnergySkateParkDataSamples and then update the view once after several are removed. The behavior of this sim
   * is such that hundreds of EnergySkateParkDataSamples are frequently removed at a time.
   *
   * Assumes that samplesToRemove is a sub-array of this.dataSamples, in the right order.
   * @public
   *
   * @param {EnergySkateParkDataSample[]} samplesToRemove
   */
  batchRemoveSamples(samplesToRemove) {
    const indexOfFirstSample = this.dataSamples.indexOf(samplesToRemove[0]);
    this.dataSamples.splice(indexOfFirstSample, samplesToRemove.length);

    // broadcast that this batch of samples has been removed
    this.batchRemoveSamplesEmitter.emit(samplesToRemove);
  }

  /**
   * Begin to remove all samples, indicating that all existing samples should fade away.
   * @protected
   */
  initiateSampleRemoval() {
    for (let i = 0; i < this.dataSamples.length; i++) {
      this.dataSamples.get(i).initiateRemove();
    }
  }

  /**
   * Custom stepModel for the SaveSampleModel. Saves and clears EnergySkateParkDataSamples.
   * @override
   * @public
   *
   * @param {number} dt - in seconds
   * @param {SkaterState} skaterState
   * @returns {SkaterState}
   */
  stepModel(dt, skaterState) {
    const updatedState = super.stepModel(dt, skaterState);
    if (this.saveSamplesProperty.get()) {
      this.timeSinceSampleSave = this.timeSinceSampleSave + dt;
      if (!this.preventSampleSave && this.timeSinceSampleSave > this.saveSampleInterval) {
        const newSample = new EnergySkateParkDataSample(updatedState, this.frictionProperty.get(), this.sampleTimeProperty.get(), this.stickingToTrackProperty.get(), this.sampleFadeDecay);
        this.dataSamples.add(newSample);
        this.timeSinceSampleSave = 0;
        this.sampleTimeProperty.set(this.sampleTimeProperty.get() + dt);
      }
    }

    // old samples fade out if we have collected too many
    if (this.limitNumberOfSamples && this.dataSamples.length > this.maxNumberOfSamples) {
      const numberToRemove = this.dataSamples.length - this.maxNumberOfSamples;
      for (let i = 0; i < numberToRemove; i++) {
        this.dataSamples.get(i).initiateRemove();
      }
    }

    // update opacity of EnergySkateParkDataSamples and determine if it is time for them to be removed from model
    const samplesToRemove = [];
    this.dataSamples.forEach(sample => {
      sample.step(dt);
      if (sample.opacityProperty.get() < EnergySkateParkDataSample.MIN_OPACITY) {
        samplesToRemove.push(sample);
      }
    });

    // for performance, we batch removal of EnergySkateParkDataSamples so that we can update once after many have been removed
    // rather than on each data point, see https://github.com/phetsims/energy-skate-park/issues/198
    if (samplesToRemove.length > 0) {
      // BatchRemoveSamples requires that samplesToRemove is a sub array of this.dataSamples, in the same order.
      // We can guarantee this is the case because we built samplesToRemove as we iterated through this.dataSamples
      // so it must be in the right order. And as soon as we find one sample to remove, the rest in this.dataSamples
      // will be ready for removal since they are even older and therefore less opaque.
      this.batchRemoveSamples(samplesToRemove);
    }
    return updatedState;
  }

  /**
   * Attach listeners that will remove and clear samples in response to Skater and model Properties. These are attached
   * for some EnergySkateParkSaveSampleModels but not all of them. They are generally useful when EnergySkateParkDataSamples are
   * used to draw the skater path.
   * @public
   */
  attachPathRemovalListeners() {
    // existing data fades away before removal when the skater direction changes
    this.skater.directionProperty.link(direction => {
      this.initiateSampleRemoval();
    });

    // existing data is removed immediately when any of these Properties change
    const boundClearSamples = this.clearEnergyData.bind(this);
    Multilink.multilink([this.saveSamplesProperty, this.skater.draggingProperty, this.sceneProperty], boundClearSamples);
    this.skater.returnedEmitter.addListener(boundClearSamples);
    this.trackChangedEmitter.addListener(boundClearSamples);
  }

  /**
   * @public
   * @override
   */
  reset() {
    super.reset();
    this.clearEnergyData();
    this.sampleTimeProperty.reset();
    this.saveSamplesProperty.reset();
  }
}
energySkatePark.register('EnergySkateParkSaveSampleModel', EnergySkateParkSaveSampleModel);
export default EnergySkateParkSaveSampleModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJjcmVhdGVPYnNlcnZhYmxlQXJyYXkiLCJFbWl0dGVyIiwiTXVsdGlsaW5rIiwiTnVtYmVyUHJvcGVydHkiLCJtZXJnZSIsImVuZXJneVNrYXRlUGFyayIsIkVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGUiLCJFbmVyZ3lTa2F0ZVBhcmtNb2RlbCIsIkVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbCIsImNvbnN0cnVjdG9yIiwicHJlZmVyZW5jZXNNb2RlbCIsInRhbmRlbSIsIm9wdGlvbnMiLCJkZWZhdWx0U2F2ZVNhbXBsZXMiLCJzYXZlU2FtcGxlSW50ZXJ2YWwiLCJzYW1wbGVGYWRlRGVjYXkiLCJtYXhOdW1iZXJPZlNhbXBsZXMiLCJ0aW1lU2luY2VTYW1wbGVTYXZlIiwibGltaXROdW1iZXJPZlNhbXBsZXMiLCJzYXZlU2FtcGxlc1Byb3BlcnR5IiwiY3JlYXRlVGFuZGVtIiwicHJldmVudFNhbXBsZVNhdmUiLCJzYW1wbGVUaW1lUHJvcGVydHkiLCJkYXRhU2FtcGxlcyIsImJhdGNoUmVtb3ZlU2FtcGxlc0VtaXR0ZXIiLCJwYXJhbWV0ZXJzIiwiaXNWYWxpZFZhbHVlIiwidmFsdWUiLCJBcnJheSIsImlzQXJyYXkiLCJldmVyeSIsImVsZW1lbnQiLCJzZXRGcm9tU2FtcGxlIiwiZGF0YVNhbXBsZSIsInNrYXRlclN0YXRlIiwic2V0VG9Ta2F0ZXIiLCJza2F0ZXIiLCJmcmljdGlvblByb3BlcnR5Iiwic2V0IiwiZnJpY3Rpb24iLCJzdGlja2luZ1RvVHJhY2tQcm9wZXJ0eSIsInN0aWNraW5nVG9UcmFjayIsInRyYWNrIiwiYXNzZXJ0IiwidHJhY2tQcm9wZXJ0eSIsImdldCIsInRyYWNrQ29udHJvbFBvaW50UG9zaXRpb25zIiwiZm9yRWFjaCIsInBvc2l0aW9uIiwiaSIsImNvbnRyb2xQb2ludHMiLCJzb3VyY2VQb3NpdGlvblByb3BlcnR5IiwiY29udGFpbkNvbnRyb2xQb2ludHNJbkxpbWl0Qm91bmRzIiwiY2xlYXJFbmVyZ3lEYXRhIiwiYmF0Y2hSZW1vdmVTYW1wbGVzIiwic2xpY2UiLCJyZXNldCIsInNhbXBsZXNUb1JlbW92ZSIsImluZGV4T2ZGaXJzdFNhbXBsZSIsImluZGV4T2YiLCJzcGxpY2UiLCJsZW5ndGgiLCJlbWl0IiwiaW5pdGlhdGVTYW1wbGVSZW1vdmFsIiwiaW5pdGlhdGVSZW1vdmUiLCJzdGVwTW9kZWwiLCJkdCIsInVwZGF0ZWRTdGF0ZSIsIm5ld1NhbXBsZSIsImFkZCIsIm51bWJlclRvUmVtb3ZlIiwic2FtcGxlIiwic3RlcCIsIm9wYWNpdHlQcm9wZXJ0eSIsIk1JTl9PUEFDSVRZIiwicHVzaCIsImF0dGFjaFBhdGhSZW1vdmFsTGlzdGVuZXJzIiwiZGlyZWN0aW9uUHJvcGVydHkiLCJsaW5rIiwiZGlyZWN0aW9uIiwiYm91bmRDbGVhclNhbXBsZXMiLCJiaW5kIiwibXVsdGlsaW5rIiwiZHJhZ2dpbmdQcm9wZXJ0eSIsInNjZW5lUHJvcGVydHkiLCJyZXR1cm5lZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsInRyYWNrQ2hhbmdlZEVtaXR0ZXIiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBbiBFbmVyZ3lTa2F0ZVBhcmtUcmFja1NldE1vZGVsIHRoYXQgY2FuIHNhdmUgRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZXMuIEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGVzIGNvbnRhaW4gaW5mb3JtYXRpb24gYWJvdXQgdGhlIHBoeXNpY2FsXHJcbiAqIHN0YXRlIG9mIHRoZSBza2F0ZXIgYXQgYSBwb2ludCBpbiB0aW1lLlxyXG4gKlxyXG4gKiBHZW5lcmFsbHksIGl0IGlzIHVwIHRvIHRoZSBzdWJ0eXBlIG9mIEVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbCB0byBjbGVhciBkYXRhIGF0IHRoZSBjb3JyZWN0IHRpbWUsIGFzIGRpZmZlcmVudFxyXG4gKiBwcmVzZW50YXRpb25zIG9mIHRoaXMgZGF0YSBuZWVkIHRvIHBlcnNpc3QgaW4gZGlmZmVyZW50IGNhc2VzLiBCdXQgbWF4TnVtYmVyT2ZTYW1wbGVzIGNhbiBiZSBzcGVjaWZpZWQgdG8ga2VlcFxyXG4gKiBhdCBtb3N0IHRoYXQgbnVtYmVyIG9mIHNhbXBsZXMgYXQgYSB0aW1lLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IGNyZWF0ZU9ic2VydmFibGVBcnJheSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL2NyZWF0ZU9ic2VydmFibGVBcnJheS5qcyc7XHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgZW5lcmd5U2thdGVQYXJrIGZyb20gJy4uLy4uL2VuZXJneVNrYXRlUGFyay5qcyc7XHJcbmltcG9ydCBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlIGZyb20gJy4vRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZS5qcyc7XHJcbmltcG9ydCBFbmVyZ3lTa2F0ZVBhcmtNb2RlbCBmcm9tICcuL0VuZXJneVNrYXRlUGFya01vZGVsLmpzJztcclxuXHJcbmNsYXNzIEVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbCBleHRlbmRzIEVuZXJneVNrYXRlUGFya01vZGVsIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtFbmVyZ3lTa2F0ZVBhcmtQcmVmZXJlbmNlc01vZGVsfSBwcmVmZXJlbmNlc01vZGVsXHJcbiAgICogQHBhcmFtIHtUYW5kZW19IHRhbmRlbVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggcHJlZmVyZW5jZXNNb2RlbCwgdGFuZGVtLCBvcHRpb25zICkge1xyXG4gICAgb3B0aW9ucyA9IG1lcmdlKCB7XHJcblxyXG4gICAgICAvLyB7Ym9vbGVhbn0gLSB0aGUgZGVmYXVsdCB2YWx1ZSBmb3Igd2hldGhlciBvciBub3QgdGhlIG1vZGVsIGlzIHNhdmluZ1xyXG4gICAgICAvLyBzYW1wbGVzIG9mIGRhdGEgZm9yIGRpc3BsYXlcclxuICAgICAgZGVmYXVsdFNhdmVTYW1wbGVzOiB0cnVlLFxyXG5cclxuICAgICAgLy8ge251bWJlcn0gLSB0aGUgaW50ZXJ2YWwgYXQgd2hpY2ggd2Ugc2F2ZSBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlcywgaW4gc2Vjb25kc1xyXG4gICAgICBzYXZlU2FtcGxlSW50ZXJ2YWw6IDAuMSxcclxuXHJcbiAgICAgIC8vIHtudW1iZXJ9IHNrYXRlciBzYW1wbGVzIHdoaWNoIGFyZSBiZWluZyByZW1vdmVkIHdpbGwgZmFkZSBhd2F5IGF0IHRoaXMgcmF0ZSBldmVyeSBhbmltYXRpb24gZnJhbWVcclxuICAgICAgLy8gbGlrZSBvcGFjaXR5ID0gb3BhY2l0eSAqIHNhbXBsZUZhZGVEZWNheVxyXG4gICAgICBzYW1wbGVGYWRlRGVjYXk6IDAuOTUsXHJcblxyXG4gICAgICAvLyB7bnVtYmVyfSAtIHRoZSBtYXhpbXVtIG51bWJlciBvZiBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlcyBzYXZlZCBieSB0aGlzIG1vZGVsLCB0byBwcmV2ZW50IGZyb20gc2F2aW5nIHRvbyBtYW55IGlmIHdlXHJcbiAgICAgIC8vIHJ1biB3aXRob3V0IGVuY291bnRlcmluZyBhIGNhc2UgdGhhdCBjbGVhcnMgb2xkIHNhbXBsZXNcclxuICAgICAgbWF4TnVtYmVyT2ZTYW1wbGVzOiA1MFxyXG4gICAgfSwgb3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCBwcmVmZXJlbmNlc01vZGVsLCB0YW5kZW0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7bnVtYmVyfVxyXG4gICAgdGhpcy5zYXZlU2FtcGxlSW50ZXJ2YWwgPSBvcHRpb25zLnNhdmVTYW1wbGVJbnRlcnZhbDtcclxuICAgIHRoaXMubWF4TnVtYmVyT2ZTYW1wbGVzID0gb3B0aW9ucy5tYXhOdW1iZXJPZlNhbXBsZXM7XHJcbiAgICB0aGlzLnNhbXBsZUZhZGVEZWNheSA9IG9wdGlvbnMuc2FtcGxlRmFkZURlY2F5O1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtudW1iZXJ9IC0gYW1vdW50IG9mIHRpbWUgdGhhdCBoYXMgZWxhcHNlZCBzaW5jZSBhIHNrYXRlciBzYW1wbGUgaGFzIGJlZW4gc2F2ZWRcclxuICAgIHRoaXMudGltZVNpbmNlU2FtcGxlU2F2ZSA9IDA7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7Ym9vbGVhbn0gLSB3aGV0aGVyIG9yIG5vdCB0byBsaW1pdCB0aGUgbnVtYmVyIG9mIHNhbXBsZXMgdG8gYmUgc2F2ZWQgLSBpZiBmYWxzZSwgd2hpY2hcclxuICAgIC8vIGNhbiBiZSBkb25lIGlmIHlvdSBhcmUgb2sgd2l0aCBzYXZpbmcgbGltaXRsZXNzIHNhbXBsZXMsIG9wdGlvbnMubWF4TnVtYmVyT2ZTYW1wbGVzIGhhcyBubyBpbXBhY3RcclxuICAgIHRoaXMubGltaXROdW1iZXJPZlNhbXBsZXMgPSB0cnVlO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge0Jvb2xlYW5Qcm9wZXJ0eX0gLSBjb250cm9scyB3aGV0aGVyIG9yIG5vdCBzYW1wbGVzIGFyZSBzYXZlZCBhcyB0aGUgbW9kZWwgc3RlcHMgdGhyb3VnaCB0aW1lXHJcbiAgICB0aGlzLnNhdmVTYW1wbGVzUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBvcHRpb25zLmRlZmF1bHRTYXZlU2FtcGxlcywgeyB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdzYXZlU2FtcGxlc1Byb3BlcnR5JyApIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtib29sZWFufSAtIHNldCB0byB0cnVlIHRvIHByZXZlbnQgdGhlIG1vZGVsIGZyb20gc2F2aW5nIGFueSBtb3JlIHNhbXBsZXMsIGV2ZW4gaWZcclxuICAgIC8vIHNhdmVTYW1wbGVzUHJvcGVydHkgaXMgdHJ1ZSAtIHRoaXMgY2FuIGJlIHVzZWQgaW5zdGVhZCBvZiAob3IgaW4gY29tYmluYXRpb24gd2l0aCkgbWF4TnVtYmVyT2ZTYW1wbGVzXFxcclxuICAgIC8vIHRvIHByZXZlbnQgdGhlIG1vZGVsIGZyb20gc2F2aW5nIHRvbyBtYW55IHNhbXBsZXMgZm9yIHJlYXNvbnMgb3RoZXIgdGhhbiBhcnJheSBsZW5ndGhcclxuICAgIHRoaXMucHJldmVudFNhbXBsZVNhdmUgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBAcHVibGljIC0gaW4gc2Vjb25kcywgaG93IG11Y2ggdGltZSBoYXMgcGFzc2VkIHNpbmNlIGJlZ2lubmluZyB0byByZWNvcmQgc2thdGVyIHN0YXRlc1xyXG4gICAgdGhpcy5zYW1wbGVUaW1lUHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIDAgKTtcclxuXHJcbiAgICAvLyBAcHJvdGVjdGVkIHtPYnNlcnZhYmxlQXJyYXlEZWYuPEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGU+fSAtIG9ic2VydmFibGUgbGlzdCBvZiBhbGwgc2F2ZWQgRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZXNcclxuICAgIHRoaXMuZGF0YVNhbXBsZXMgPSBjcmVhdGVPYnNlcnZhYmxlQXJyYXkoKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIC0gYW4gYXJyYXkgb2YgRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZXMgdGhhdCBoYXZlIGp1c3QgYmVlbiByZW1vdmVkIGZyb20gdGhlIG1vZGVsLiBOZWNlc3NhcnlcclxuICAgIC8vIGZvciBwZXJmb3JtYW5jZSBzbyB0aGF0IHdlIGNhbiB1cGRhdGUgb25jZSBhZnRlciByZW1vdmluZyBtYW55IHNhbXBsZXMgcmF0aGVyIHRoYW4gZXZlcnkgdGltZVxyXG4gICAgLy8gYSBzaW5nbGUgc2FtcGxlIGlzIHJlbW92ZWRcclxuICAgIHRoaXMuYmF0Y2hSZW1vdmVTYW1wbGVzRW1pdHRlciA9IG5ldyBFbWl0dGVyKCB7XHJcbiAgICAgIHBhcmFtZXRlcnM6IFsge1xyXG4gICAgICAgIGlzVmFsaWRWYWx1ZTogdmFsdWUgPT4gQXJyYXkuaXNBcnJheSggdmFsdWUgKSAmJiB2YWx1ZS5ldmVyeSggZWxlbWVudCA9PiBlbGVtZW50IGluc3RhbmNlb2YgRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZSApXHJcbiAgICAgIH0gXVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IG1vZGVsIHN0YXRlIGZyb20gYSBzYXZlZCBzYW1wbGUsIHBvdGVudGlhbGx5IG1vZGlmeWluZyBTa2F0ZXIsIFRyYWNrLCBhbmQgb3RoZXIgdGhpbmdzLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7RW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZX0gZGF0YVNhbXBsZVxyXG4gICAqL1xyXG4gIHNldEZyb21TYW1wbGUoIGRhdGFTYW1wbGUgKSB7XHJcbiAgICBkYXRhU2FtcGxlLnNrYXRlclN0YXRlLnNldFRvU2thdGVyKCB0aGlzLnNrYXRlciApO1xyXG5cclxuICAgIC8vIHJlc3RvcmUgZnJpY3Rpb24gYW5kIHN0aWNraW5nVG9UcmFja1Byb3BlcnR5IChhbGwgb3RoZXIgUHJvcGVydGllcyBhcmUgc2V0IG9uIFNrYXRlcilcclxuICAgIHRoaXMuZnJpY3Rpb25Qcm9wZXJ0eS5zZXQoIGRhdGFTYW1wbGUuZnJpY3Rpb24gKTtcclxuICAgIHRoaXMuc3RpY2tpbmdUb1RyYWNrUHJvcGVydHkuc2V0KCBkYXRhU2FtcGxlLnN0aWNraW5nVG9UcmFjayApO1xyXG5cclxuICAgIGlmICggZGF0YVNhbXBsZS50cmFjayApIHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggZGF0YVNhbXBsZS50cmFjayA9PT0gdGhpcy5za2F0ZXIudHJhY2tQcm9wZXJ0eS5nZXQoKSwgJ29ubHkgdGhlIGFjdGl2ZSB0cmFjayBjYW4gYmUgc2V0IGZyb20gc2FtcGxlJyApO1xyXG5cclxuICAgICAgZGF0YVNhbXBsZS50cmFja0NvbnRyb2xQb2ludFBvc2l0aW9ucy5mb3JFYWNoKCAoIHBvc2l0aW9uLCBpICkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2thdGVyLnRyYWNrUHJvcGVydHkuZ2V0KCkuY29udHJvbFBvaW50c1sgaSBdLnNvdXJjZVBvc2l0aW9uUHJvcGVydHkuc2V0KCBwb3NpdGlvbiApO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyBtYWtlIHN1cmUgY29udHJvbCBwb2ludHMgYXJlIGNvbnN0cmFpbmVkLCBhbmQgdXBkYXRlIHNwbGluZXMgYW5kIHNoYXBlXHJcbiAgICAgIHRoaXMuc2thdGVyLnRyYWNrUHJvcGVydHkuZ2V0KCkuY29udGFpbkNvbnRyb2xQb2ludHNJbkxpbWl0Qm91bmRzKCB0cnVlICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBhbGwgc2F2ZWQgZGF0YSBpbW1lZGlhdGVseSBhbmQgcHJlcGFyZSB0byBzYXZlIGRhdGEgYWdhaW4uXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGNsZWFyRW5lcmd5RGF0YSgpIHtcclxuICAgIHRoaXMuYmF0Y2hSZW1vdmVTYW1wbGVzKCB0aGlzLmRhdGFTYW1wbGVzLnNsaWNlKCkgKTtcclxuICAgIHRoaXMuc2FtcGxlVGltZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLnRpbWVTaW5jZVNhbXBsZVNhdmUgPSAwO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgbW9kZWwgaW4gYmF0Y2hlcyBmb3IgcGVyZm9ybWFuY2UuIFRoaXMgd2F5IHdlIGNhbiByZW1vdmUgbWFueVxyXG4gICAqIEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGVzIGFuZCB0aGVuIHVwZGF0ZSB0aGUgdmlldyBvbmNlIGFmdGVyIHNldmVyYWwgYXJlIHJlbW92ZWQuIFRoZSBiZWhhdmlvciBvZiB0aGlzIHNpbVxyXG4gICAqIGlzIHN1Y2ggdGhhdCBodW5kcmVkcyBvZiBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlcyBhcmUgZnJlcXVlbnRseSByZW1vdmVkIGF0IGEgdGltZS5cclxuICAgKlxyXG4gICAqIEFzc3VtZXMgdGhhdCBzYW1wbGVzVG9SZW1vdmUgaXMgYSBzdWItYXJyYXkgb2YgdGhpcy5kYXRhU2FtcGxlcywgaW4gdGhlIHJpZ2h0IG9yZGVyLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7RW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZVtdfSBzYW1wbGVzVG9SZW1vdmVcclxuICAgKi9cclxuICBiYXRjaFJlbW92ZVNhbXBsZXMoIHNhbXBsZXNUb1JlbW92ZSApIHtcclxuXHJcbiAgICBjb25zdCBpbmRleE9mRmlyc3RTYW1wbGUgPSB0aGlzLmRhdGFTYW1wbGVzLmluZGV4T2YoIHNhbXBsZXNUb1JlbW92ZVsgMCBdICk7XHJcbiAgICB0aGlzLmRhdGFTYW1wbGVzLnNwbGljZSggaW5kZXhPZkZpcnN0U2FtcGxlLCBzYW1wbGVzVG9SZW1vdmUubGVuZ3RoICk7XHJcblxyXG4gICAgLy8gYnJvYWRjYXN0IHRoYXQgdGhpcyBiYXRjaCBvZiBzYW1wbGVzIGhhcyBiZWVuIHJlbW92ZWRcclxuICAgIHRoaXMuYmF0Y2hSZW1vdmVTYW1wbGVzRW1pdHRlci5lbWl0KCBzYW1wbGVzVG9SZW1vdmUgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJlZ2luIHRvIHJlbW92ZSBhbGwgc2FtcGxlcywgaW5kaWNhdGluZyB0aGF0IGFsbCBleGlzdGluZyBzYW1wbGVzIHNob3VsZCBmYWRlIGF3YXkuXHJcbiAgICogQHByb3RlY3RlZFxyXG4gICAqL1xyXG4gIGluaXRpYXRlU2FtcGxlUmVtb3ZhbCgpIHtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuZGF0YVNhbXBsZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHRoaXMuZGF0YVNhbXBsZXMuZ2V0KCBpICkuaW5pdGlhdGVSZW1vdmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEN1c3RvbSBzdGVwTW9kZWwgZm9yIHRoZSBTYXZlU2FtcGxlTW9kZWwuIFNhdmVzIGFuZCBjbGVhcnMgRW5lcmd5U2thdGVQYXJrRGF0YVNhbXBsZXMuXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0IC0gaW4gc2Vjb25kc1xyXG4gICAqIEBwYXJhbSB7U2thdGVyU3RhdGV9IHNrYXRlclN0YXRlXHJcbiAgICogQHJldHVybnMge1NrYXRlclN0YXRlfVxyXG4gICAqL1xyXG4gIHN0ZXBNb2RlbCggZHQsIHNrYXRlclN0YXRlICkge1xyXG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0gc3VwZXIuc3RlcE1vZGVsKCBkdCwgc2thdGVyU3RhdGUgKTtcclxuXHJcbiAgICBpZiAoIHRoaXMuc2F2ZVNhbXBsZXNQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgdGhpcy50aW1lU2luY2VTYW1wbGVTYXZlID0gdGhpcy50aW1lU2luY2VTYW1wbGVTYXZlICsgZHQ7XHJcblxyXG4gICAgICBpZiAoICF0aGlzLnByZXZlbnRTYW1wbGVTYXZlICYmIHRoaXMudGltZVNpbmNlU2FtcGxlU2F2ZSA+IHRoaXMuc2F2ZVNhbXBsZUludGVydmFsICkge1xyXG4gICAgICAgIGNvbnN0IG5ld1NhbXBsZSA9IG5ldyBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlKCB1cGRhdGVkU3RhdGUsIHRoaXMuZnJpY3Rpb25Qcm9wZXJ0eS5nZXQoKSwgdGhpcy5zYW1wbGVUaW1lUHJvcGVydHkuZ2V0KCksIHRoaXMuc3RpY2tpbmdUb1RyYWNrUHJvcGVydHkuZ2V0KCksIHRoaXMuc2FtcGxlRmFkZURlY2F5ICk7XHJcbiAgICAgICAgdGhpcy5kYXRhU2FtcGxlcy5hZGQoIG5ld1NhbXBsZSApO1xyXG4gICAgICAgIHRoaXMudGltZVNpbmNlU2FtcGxlU2F2ZSA9IDA7XHJcbiAgICAgICAgdGhpcy5zYW1wbGVUaW1lUHJvcGVydHkuc2V0KCB0aGlzLnNhbXBsZVRpbWVQcm9wZXJ0eS5nZXQoKSArIGR0ICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBvbGQgc2FtcGxlcyBmYWRlIG91dCBpZiB3ZSBoYXZlIGNvbGxlY3RlZCB0b28gbWFueVxyXG4gICAgaWYgKCB0aGlzLmxpbWl0TnVtYmVyT2ZTYW1wbGVzICYmIHRoaXMuZGF0YVNhbXBsZXMubGVuZ3RoID4gdGhpcy5tYXhOdW1iZXJPZlNhbXBsZXMgKSB7XHJcbiAgICAgIGNvbnN0IG51bWJlclRvUmVtb3ZlID0gdGhpcy5kYXRhU2FtcGxlcy5sZW5ndGggLSB0aGlzLm1heE51bWJlck9mU2FtcGxlcztcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgbnVtYmVyVG9SZW1vdmU7IGkrKyApIHtcclxuICAgICAgICB0aGlzLmRhdGFTYW1wbGVzLmdldCggaSApLmluaXRpYXRlUmVtb3ZlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyB1cGRhdGUgb3BhY2l0eSBvZiBFbmVyZ3lTa2F0ZVBhcmtEYXRhU2FtcGxlcyBhbmQgZGV0ZXJtaW5lIGlmIGl0IGlzIHRpbWUgZm9yIHRoZW0gdG8gYmUgcmVtb3ZlZCBmcm9tIG1vZGVsXHJcbiAgICBjb25zdCBzYW1wbGVzVG9SZW1vdmUgPSBbXTtcclxuICAgIHRoaXMuZGF0YVNhbXBsZXMuZm9yRWFjaCggc2FtcGxlID0+IHtcclxuICAgICAgc2FtcGxlLnN0ZXAoIGR0ICk7XHJcbiAgICAgIGlmICggc2FtcGxlLm9wYWNpdHlQcm9wZXJ0eS5nZXQoKSA8IEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGUuTUlOX09QQUNJVFkgKSB7XHJcbiAgICAgICAgc2FtcGxlc1RvUmVtb3ZlLnB1c2goIHNhbXBsZSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gZm9yIHBlcmZvcm1hbmNlLCB3ZSBiYXRjaCByZW1vdmFsIG9mIEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGVzIHNvIHRoYXQgd2UgY2FuIHVwZGF0ZSBvbmNlIGFmdGVyIG1hbnkgaGF2ZSBiZWVuIHJlbW92ZWRcclxuICAgIC8vIHJhdGhlciB0aGFuIG9uIGVhY2ggZGF0YSBwb2ludCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9lbmVyZ3ktc2thdGUtcGFyay9pc3N1ZXMvMTk4XHJcbiAgICBpZiAoIHNhbXBsZXNUb1JlbW92ZS5sZW5ndGggPiAwICkge1xyXG5cclxuICAgICAgLy8gQmF0Y2hSZW1vdmVTYW1wbGVzIHJlcXVpcmVzIHRoYXQgc2FtcGxlc1RvUmVtb3ZlIGlzIGEgc3ViIGFycmF5IG9mIHRoaXMuZGF0YVNhbXBsZXMsIGluIHRoZSBzYW1lIG9yZGVyLlxyXG4gICAgICAvLyBXZSBjYW4gZ3VhcmFudGVlIHRoaXMgaXMgdGhlIGNhc2UgYmVjYXVzZSB3ZSBidWlsdCBzYW1wbGVzVG9SZW1vdmUgYXMgd2UgaXRlcmF0ZWQgdGhyb3VnaCB0aGlzLmRhdGFTYW1wbGVzXHJcbiAgICAgIC8vIHNvIGl0IG11c3QgYmUgaW4gdGhlIHJpZ2h0IG9yZGVyLiBBbmQgYXMgc29vbiBhcyB3ZSBmaW5kIG9uZSBzYW1wbGUgdG8gcmVtb3ZlLCB0aGUgcmVzdCBpbiB0aGlzLmRhdGFTYW1wbGVzXHJcbiAgICAgIC8vIHdpbGwgYmUgcmVhZHkgZm9yIHJlbW92YWwgc2luY2UgdGhleSBhcmUgZXZlbiBvbGRlciBhbmQgdGhlcmVmb3JlIGxlc3Mgb3BhcXVlLlxyXG4gICAgICB0aGlzLmJhdGNoUmVtb3ZlU2FtcGxlcyggc2FtcGxlc1RvUmVtb3ZlICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEF0dGFjaCBsaXN0ZW5lcnMgdGhhdCB3aWxsIHJlbW92ZSBhbmQgY2xlYXIgc2FtcGxlcyBpbiByZXNwb25zZSB0byBTa2F0ZXIgYW5kIG1vZGVsIFByb3BlcnRpZXMuIFRoZXNlIGFyZSBhdHRhY2hlZFxyXG4gICAqIGZvciBzb21lIEVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbHMgYnV0IG5vdCBhbGwgb2YgdGhlbS4gVGhleSBhcmUgZ2VuZXJhbGx5IHVzZWZ1bCB3aGVuIEVuZXJneVNrYXRlUGFya0RhdGFTYW1wbGVzIGFyZVxyXG4gICAqIHVzZWQgdG8gZHJhdyB0aGUgc2thdGVyIHBhdGguXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGF0dGFjaFBhdGhSZW1vdmFsTGlzdGVuZXJzKCkge1xyXG5cclxuICAgIC8vIGV4aXN0aW5nIGRhdGEgZmFkZXMgYXdheSBiZWZvcmUgcmVtb3ZhbCB3aGVuIHRoZSBza2F0ZXIgZGlyZWN0aW9uIGNoYW5nZXNcclxuICAgIHRoaXMuc2thdGVyLmRpcmVjdGlvblByb3BlcnR5LmxpbmsoIGRpcmVjdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMuaW5pdGlhdGVTYW1wbGVSZW1vdmFsKCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gZXhpc3RpbmcgZGF0YSBpcyByZW1vdmVkIGltbWVkaWF0ZWx5IHdoZW4gYW55IG9mIHRoZXNlIFByb3BlcnRpZXMgY2hhbmdlXHJcbiAgICBjb25zdCBib3VuZENsZWFyU2FtcGxlcyA9IHRoaXMuY2xlYXJFbmVyZ3lEYXRhLmJpbmQoIHRoaXMgKTtcclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgdGhpcy5zYXZlU2FtcGxlc1Byb3BlcnR5LCB0aGlzLnNrYXRlci5kcmFnZ2luZ1Byb3BlcnR5LCB0aGlzLnNjZW5lUHJvcGVydHkgXSwgYm91bmRDbGVhclNhbXBsZXMgKTtcclxuICAgIHRoaXMuc2thdGVyLnJldHVybmVkRW1pdHRlci5hZGRMaXN0ZW5lciggYm91bmRDbGVhclNhbXBsZXMgKTtcclxuICAgIHRoaXMudHJhY2tDaGFuZ2VkRW1pdHRlci5hZGRMaXN0ZW5lciggYm91bmRDbGVhclNhbXBsZXMgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICByZXNldCgpIHtcclxuICAgIHN1cGVyLnJlc2V0KCk7XHJcbiAgICB0aGlzLmNsZWFyRW5lcmd5RGF0YSgpO1xyXG5cclxuICAgIHRoaXMuc2FtcGxlVGltZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLnNhdmVTYW1wbGVzUHJvcGVydHkucmVzZXQoKTtcclxuICB9XHJcbn1cclxuXHJcbmVuZXJneVNrYXRlUGFyay5yZWdpc3RlciggJ0VuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbCcsIEVuZXJneVNrYXRlUGFya1NhdmVTYW1wbGVNb2RlbCApO1xyXG5leHBvcnQgZGVmYXVsdCBFbmVyZ3lTa2F0ZVBhcmtTYXZlU2FtcGxlTW9kZWw7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBQ3BFLE9BQU9DLHFCQUFxQixNQUFNLDhDQUE4QztBQUNoRixPQUFPQyxPQUFPLE1BQU0sZ0NBQWdDO0FBQ3BELE9BQU9DLFNBQVMsTUFBTSxrQ0FBa0M7QUFDeEQsT0FBT0MsY0FBYyxNQUFNLHVDQUF1QztBQUNsRSxPQUFPQyxLQUFLLE1BQU0sbUNBQW1DO0FBQ3JELE9BQU9DLGVBQWUsTUFB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