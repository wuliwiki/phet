// Copyright 2013-2022, University of Colorado Boulder

/**
 * Scenery node for the track, which can be translated by dragging the track, or manipulated by dragging its control points.
 * If the track's length is changed (by deleting a control point or linking two tracks together) a new TrackNode is created.
 * Keep track of whether the track is dragging, so performance can be optimized while dragging
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import dot from '../../../../dot/js/dot.js';
import { LineStyles, Shape } from '../../../../kite/js/imports.js';
import merge from '../../../../phet-core/js/merge.js';
import { Node, Path } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import energySkatePark from '../../energySkatePark.js';
import SplineEvaluation from '../SplineEvaluation.js';
import ControlPointNode from './ControlPointNode.js';
import TrackDragHandler from './TrackDragHandler.js';

// constants
const FastArray = dot.FastArray;
class TrackNode extends Node {
  /**
   * @param {Track} track the track for this track node
   * @param {ModelViewTransform2} modelViewTransform the model view transform for the view
   * @param {Property.<Bounds2>} availableBoundsProperty
   * @param {Tandem} tandem
   * @param {Object} [options]
   */
  constructor(track, modelViewTransform, availableBoundsProperty, tandem, options) {
    const model = track.model;
    options = merge({
      // {null|string} - cursor for the Track road - by default it is a 'pointer' if only draggable, but for some icons
      //  we want a pointer even when not draggable (like in the toolbox).
      roadCursorOverride: null,
      // {boolean} - whether or not this TrackNode is being used as an icon - if so, its
      // representation is a little different, mostly it has no visible control points
      // and its road path is a bit thicker to be more visible since the track will likley
      // be smaller
      isIcon: false,
      tandem: tandem,
      visiblePropertyOptions: {
        phetioState: false
      }
    }, options);
    super(options);

    // @private
    this.track = track;
    this.model = model;
    this.modelViewTransform = modelViewTransform;
    this.availableBoundsProperty = availableBoundsProperty;
    this.isIcon = options.isIcon;
    this.road = new Path(null, {
      fill: 'gray',
      cursor: options.roadCursorOverride || track.draggable ? 'pointer' : 'default'
    });
    this.centerLine = new Path(null, {
      stroke: 'black',
      lineWidth: 1.2,
      lineDash: [11, 8]
    });
    this.children = [this.road, this.centerLine];

    // must be unlinked in dispose
    const stickingToTrackListener = sticking => {
      this.centerLine.lineDash = sticking ? [11, 8] : [];
    };
    model.stickingToTrackProperty.link(stickingToTrackListener);

    // Reuse arrays to save allocations and prevent garbage collections, see #38
    this.xArray = new FastArray(track.controlPoints.length);
    this.yArray = new FastArray(track.controlPoints.length);

    // Store for performance
    this.lastPoint = (track.controlPoints.length - 1) / track.controlPoints.length;

    // Sample space, which is recomputed if the track gets longer, to keep it looking smooth no matter how many control points
    this.linSpace = numeric.linspace(0, this.lastPoint, 20 * (track.controlPoints.length - 1));
    this.lengthForLinSpace = track.controlPoints.length;

    // @public {TrackDraghandler} - public so that ControlPointNodes so that dragging a control point can initiate
    // dragging a track and dragging from toolbox can forward input to this listener
    this.trackDragHandler = null;
    if (track.draggable) {
      this.trackDragHandler = new TrackDragHandler(this, tandem.createTandem('trackDragHandler'));
      this.road.addInputListener(this.trackDragHandler);
    }

    // only "configurable" tracks have draggable control points, and individual control points may have dragging
    // disabled - also, "icon" TrackNodes do not display ControlPoints
    if (track.configurable && !options.isIcon) {
      for (let i = 0; i < track.controlPoints.length; i++) {
        const controlPoint = track.controlPoints[i];
        if (controlPoint.visible) {
          const isEndPoint = i === 0 || i === track.controlPoints.length - 1;
          const controlPointNode = new ControlPointNode(this, this.trackDragHandler, i, isEndPoint, tandem.createTandem(`controlPointNode${i}`));
          this.addChild(controlPointNode);
          if (controlPoint.limitBounds) {
            assert && assert(controlPointNode.boundsRectangle, 'bounds are limited but there is no bounding Rectangle');
            this.addChild(controlPointNode.boundsRectangle);
          }
        }
      }
    }

    // Init the track shape
    this.updateTrackShape();

    // Update the track shape when the whole track is translated
    // Just observing the control points individually would lead to N expensive callbacks (instead of 1) for each of the N points
    // So we use this broadcast mechanism instead
    track.translatedEmitter.addListener(this.updateTrackShape.bind(this));
    track.draggingProperty.link(dragging => {
      if (!dragging) {
        this.updateTrackShape();
      }
    });
    track.resetEmitter.addListener(this.updateTrackShape.bind(this));
    track.smoothedEmitter.addListener(this.updateTrackShape.bind(this));
    track.updateEmitter.addListener(this.updateTrackShape.bind(this));

    // track was pulled from the tool box, start drag event to the drag listener
    track.forwardingDragStartEmitter.addListener(event => {
      this.trackDragHandler.press(event);
    });

    // In the state wrapper, when the state changes, we must update the skater node
    const stateListener = () => {
      this.updateTrackShape();
    };
    Tandem.PHET_IO_ENABLED && phet.phetio.phetioEngine.phetioStateEngine.stateSetEmitter.addListener(stateListener);

    // @private - only called by dispose
    this.disposeTrackNode = () => {
      model.stickingToTrackProperty.unlink(stickingToTrackListener);
      Tandem.PHET_IO_ENABLED && phet.phetio.phetioEngine.phetioStateEngine.stateSetEmitter.removeListener(stateListener);
      for (let i = 0; i < this.children.length; i++) {
        const child = this.children[i];
        if (child instanceof ControlPointNode) {
          child.dispose();
          i--; // Child is removed, we must decrement index so wo don't miss the next child
        }
      }

      if (track.draggable) {
        this.trackDragHandler.dispose();
      }
    };
  }

  /**
   * Make eligible for garbage collection.
   * @public
   */
  dispose() {
    this.disposeTrackNode();
    super.dispose();
  }

  /**
   * When a control point has moved, or the track has moved, or the track has been reset, or on initialization
   * update the shape of the track.
   * @public
   */
  updateTrackShape() {
    const track = this.track;
    const model = this.model;
    let i;
    // Update the sample range when the number of control points has changed
    if (this.lengthForLinSpace !== track.controlPoints.length) {
      this.lastPoint = (track.controlPoints.length - 1) / track.controlPoints.length;
      this.linSpace = numeric.linspace(0, this.lastPoint, 20 * (track.controlPoints.length - 1));
      this.lengthForLinSpace = track.controlPoints.length;
    }

    // Arrays are fixed length, so just overwrite values
    for (i = 0; i < track.controlPoints.length; i++) {
      this.xArray[i] = track.controlPoints[i].positionProperty.value.x;
      this.yArray[i] = track.controlPoints[i].positionProperty.value.y;
    }

    // Compute points for lineTo
    const xPoints = SplineEvaluation.atArray(track.xSpline, this.linSpace);
    const yPoints = SplineEvaluation.atArray(track.ySpline, this.linSpace);
    const tx = this.getTranslation();
    const shape = new Shape().moveTo(this.modelViewTransform.modelToViewX(xPoints[0]) - tx.x, this.modelViewTransform.modelToViewY(yPoints[0]) - tx.y);

    // Show the track at reduced resolution while dragging so it will be smooth and responsive while dragging
    // (whether updating the entire track, some of the control points or both)
    const delta = track.draggingProperty.value ? 3 : 1;
    for (i = 1; i < xPoints.length; i = i + delta) {
      shape.lineTo(this.modelViewTransform.modelToViewX(xPoints[i]) - tx.x, this.modelViewTransform.modelToViewY(yPoints[i]) - tx.y);
    }

    // If at reduced resolution, still make sure we draw to the end point
    if (i !== xPoints.length - 1) {
      i = xPoints.length - 1;
      shape.lineTo(this.modelViewTransform.modelToViewX(xPoints[i]) - tx.x, this.modelViewTransform.modelToViewY(yPoints[i]) - tx.y);
    }
    const strokeStyles = new LineStyles({
      lineWidth: this.isIcon ? 30 : 12,
      lineCap: 'butt',
      lineJoin: 'miter',
      miterLimit: 10
    });
    this.road.shape = shape.getStrokedShape(strokeStyles);
    this.centerLine.shape = shape;

    // Update the skater if the track is moved while the sim is paused, see #84
    if (model.skater.trackProperty.value === track && model.pausedProperty.value) {
      model.skater.positionProperty.value = track.getPoint(model.skater.parametricPositionProperty.value);
      model.skater.angleProperty.value = model.skater.trackProperty.value.getViewAngleAt(model.skater.parametricPositionProperty.value) + (model.skater.onTopSideOfTrackProperty.value ? 0 : Math.PI);
      model.skater.updatedEmitter.emit();
    }
  }
}
energySkatePark.register('TrackNode', TrackNode);
export default TrackNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3QiLCJMaW5lU3R5bGVzIiwiU2hhcGUiLCJtZXJnZSIsIk5vZGUiLCJQYXRoIiwiVGFuZGVtIiwiZW5lcmd5U2thdGVQYXJrIiwiU3BsaW5lRXZhbHVhdGlvbiIsIkNvbnRyb2xQb2ludE5vZGUiLCJUcmFja0RyYWdIYW5kbGVyIiwiRmFzdEFycmF5IiwiVHJhY2tOb2RlIiwiY29uc3RydWN0b3IiLCJ0cmFjayIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5IiwidGFuZGVtIiwib3B0aW9ucyIsIm1vZGVsIiwicm9hZEN1cnNvck92ZXJyaWRlIiwiaXNJY29uIiwidmlzaWJsZVByb3BlcnR5T3B0aW9ucyIsInBoZXRpb1N0YXRlIiwicm9hZCIsImZpbGwiLCJjdXJzb3IiLCJkcmFnZ2FibGUiLCJjZW50ZXJMaW5lIiwic3Ryb2tlIiwibGluZVdpZHRoIiwibGluZURhc2giLCJjaGlsZHJlbiIsInN0aWNraW5nVG9UcmFja0xpc3RlbmVyIiwic3RpY2tpbmciLCJzdGlja2luZ1RvVHJhY2tQcm9wZXJ0eSIsImxpbmsiLCJ4QXJyYXkiLCJjb250cm9sUG9pbnRzIiwibGVuZ3RoIiwieUFycmF5IiwibGFzdFBvaW50IiwibGluU3BhY2UiLCJudW1lcmljIiwibGluc3BhY2UiLCJsZW5ndGhGb3JMaW5TcGFjZSIsInRyYWNrRHJhZ0hhbmRsZXIiLCJjcmVhdGVUYW5kZW0iLCJhZGRJbnB1dExpc3RlbmVyIiwiY29uZmlndXJhYmxlIiwiaSIsImNvbnRyb2xQb2ludCIsInZpc2libGUiLCJpc0VuZFBvaW50IiwiY29udHJvbFBvaW50Tm9kZSIsImFkZENoaWxkIiwibGltaXRCb3VuZHMiLCJhc3NlcnQiLCJib3VuZHNSZWN0YW5nbGUiLCJ1cGRhdGVUcmFja1NoYXBlIiwidHJhbnNsYXRlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsImJpbmQiLCJkcmFnZ2luZ1Byb3BlcnR5IiwiZHJhZ2dpbmciLCJyZXNldEVtaXR0ZXIiLCJzbW9vdGhlZEVtaXR0ZXIiLCJ1cGRhdGVFbWl0dGVyIiwiZm9yd2FyZGluZ0RyYWdTdGFydEVtaXR0ZXIiLCJldmVudCIsInByZXNzIiwic3RhdGVMaXN0ZW5lciIsIlBIRVRfSU9fRU5BQkxFRCIsInBoZXQiLCJwaGV0aW8iLCJwaGV0aW9FbmdpbmUiLCJwaGV0aW9TdGF0ZUVuZ2luZSIsInN0YXRlU2V0RW1pdHRlciIsImRpc3Bvc2VUcmFja05vZGUiLCJ1bmxpbmsiLCJyZW1vdmVMaXN0ZW5lciIsImNoaWxkIiwiZGlzcG9zZSIsInBvc2l0aW9uUHJvcGVydHkiLCJ2YWx1ZSIsIngiLCJ5IiwieFBvaW50cyIsImF0QXJyYXkiLCJ4U3BsaW5lIiwieVBvaW50cyIsInlTcGxpbmUiLCJ0eCIsImdldFRyYW5zbGF0aW9uIiwic2hhcGUiLCJtb3ZlVG8iLCJtb2RlbFRvVmlld1giLCJtb2RlbFRvVmlld1kiLCJkZWx0YSIsImxpbmVUbyIsInN0cm9rZVN0eWxlcyIsImxpbmVDYXAiLCJsaW5lSm9pbiIsIm1pdGVyTGltaXQiLCJnZXRTdHJva2VkU2hhcGUiLCJza2F0ZXIiLCJ0cmFja1Byb3BlcnR5IiwicGF1c2VkUHJvcGVydHkiLCJnZXRQb2ludCIsInBhcmFtZXRyaWNQb3NpdGlvblByb3BlcnR5IiwiYW5nbGVQcm9wZXJ0eSIsImdldFZpZXdBbmdsZUF0Iiwib25Ub3BTaWRlT2ZUcmFja1Byb3BlcnR5IiwiTWF0aCIsIlBJIiwidXBkYXRlZEVtaXR0ZXIiLCJlbWl0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJUcmFja05vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogU2NlbmVyeSBub2RlIGZvciB0aGUgdHJhY2ssIHdoaWNoIGNhbiBiZSB0cmFuc2xhdGVkIGJ5IGRyYWdnaW5nIHRoZSB0cmFjaywgb3IgbWFuaXB1bGF0ZWQgYnkgZHJhZ2dpbmcgaXRzIGNvbnRyb2wgcG9pbnRzLlxyXG4gKiBJZiB0aGUgdHJhY2sncyBsZW5ndGggaXMgY2hhbmdlZCAoYnkgZGVsZXRpbmcgYSBjb250cm9sIHBvaW50IG9yIGxpbmtpbmcgdHdvIHRyYWNrcyB0b2dldGhlcikgYSBuZXcgVHJhY2tOb2RlIGlzIGNyZWF0ZWQuXHJcbiAqIEtlZXAgdHJhY2sgb2Ygd2hldGhlciB0aGUgdHJhY2sgaXMgZHJhZ2dpbmcsIHNvIHBlcmZvcm1hbmNlIGNhbiBiZSBvcHRpbWl6ZWQgd2hpbGUgZHJhZ2dpbmdcclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgZG90IGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9kb3QuanMnO1xyXG5pbXBvcnQgeyBMaW5lU3R5bGVzLCBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBQYXRoIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IGVuZXJneVNrYXRlUGFyayBmcm9tICcuLi8uLi9lbmVyZ3lTa2F0ZVBhcmsuanMnO1xyXG5pbXBvcnQgU3BsaW5lRXZhbHVhdGlvbiBmcm9tICcuLi9TcGxpbmVFdmFsdWF0aW9uLmpzJztcclxuaW1wb3J0IENvbnRyb2xQb2ludE5vZGUgZnJvbSAnLi9Db250cm9sUG9pbnROb2RlLmpzJztcclxuaW1wb3J0IFRyYWNrRHJhZ0hhbmRsZXIgZnJvbSAnLi9UcmFja0RyYWdIYW5kbGVyLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBGYXN0QXJyYXkgPSBkb3QuRmFzdEFycmF5O1xyXG5cclxuY2xhc3MgVHJhY2tOb2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7VHJhY2t9IHRyYWNrIHRoZSB0cmFjayBmb3IgdGhpcyB0cmFjayBub2RlXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm0gdGhlIG1vZGVsIHZpZXcgdHJhbnNmb3JtIGZvciB0aGUgdmlld1xyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPEJvdW5kczI+fSBhdmFpbGFibGVCb3VuZHNQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHRyYWNrLCBtb2RlbFZpZXdUcmFuc2Zvcm0sIGF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5LCB0YW5kZW0sIG9wdGlvbnMgKSB7XHJcbiAgICBjb25zdCBtb2RlbCA9IHRyYWNrLm1vZGVsO1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG5cclxuICAgICAgLy8ge251bGx8c3RyaW5nfSAtIGN1cnNvciBmb3IgdGhlIFRyYWNrIHJvYWQgLSBieSBkZWZhdWx0IGl0IGlzIGEgJ3BvaW50ZXInIGlmIG9ubHkgZHJhZ2dhYmxlLCBidXQgZm9yIHNvbWUgaWNvbnNcclxuICAgICAgLy8gIHdlIHdhbnQgYSBwb2ludGVyIGV2ZW4gd2hlbiBub3QgZHJhZ2dhYmxlIChsaWtlIGluIHRoZSB0b29sYm94KS5cclxuICAgICAgcm9hZEN1cnNvck92ZXJyaWRlOiBudWxsLFxyXG5cclxuICAgICAgLy8ge2Jvb2xlYW59IC0gd2hldGhlciBvciBub3QgdGhpcyBUcmFja05vZGUgaXMgYmVpbmcgdXNlZCBhcyBhbiBpY29uIC0gaWYgc28sIGl0c1xyXG4gICAgICAvLyByZXByZXNlbnRhdGlvbiBpcyBhIGxpdHRsZSBkaWZmZXJlbnQsIG1vc3RseSBpdCBoYXMgbm8gdmlzaWJsZSBjb250cm9sIHBvaW50c1xyXG4gICAgICAvLyBhbmQgaXRzIHJvYWQgcGF0aCBpcyBhIGJpdCB0aGlja2VyIHRvIGJlIG1vcmUgdmlzaWJsZSBzaW5jZSB0aGUgdHJhY2sgd2lsbCBsaWtsZXlcclxuICAgICAgLy8gYmUgc21hbGxlclxyXG4gICAgICBpc0ljb246IGZhbHNlLFxyXG5cclxuICAgICAgdGFuZGVtOiB0YW5kZW0sXHJcbiAgICAgIHZpc2libGVQcm9wZXJ0eU9wdGlvbnM6IHsgcGhldGlvU3RhdGU6IGZhbHNlIH1cclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLnRyYWNrID0gdHJhY2s7XHJcbiAgICB0aGlzLm1vZGVsID0gbW9kZWw7XHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IG1vZGVsVmlld1RyYW5zZm9ybTtcclxuICAgIHRoaXMuYXZhaWxhYmxlQm91bmRzUHJvcGVydHkgPSBhdmFpbGFibGVCb3VuZHNQcm9wZXJ0eTtcclxuICAgIHRoaXMuaXNJY29uID0gb3B0aW9ucy5pc0ljb247XHJcblxyXG4gICAgdGhpcy5yb2FkID0gbmV3IFBhdGgoIG51bGwsIHtcclxuICAgICAgZmlsbDogJ2dyYXknLFxyXG4gICAgICBjdXJzb3I6IG9wdGlvbnMucm9hZEN1cnNvck92ZXJyaWRlIHx8IHRyYWNrLmRyYWdnYWJsZSA/ICdwb2ludGVyJyA6ICdkZWZhdWx0J1xyXG4gICAgfSApO1xyXG4gICAgdGhpcy5jZW50ZXJMaW5lID0gbmV3IFBhdGgoIG51bGwsIHtcclxuICAgICAgc3Ryb2tlOiAnYmxhY2snLFxyXG4gICAgICBsaW5lV2lkdGg6IDEuMixcclxuICAgICAgbGluZURhc2g6IFsgMTEsIDggXVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuY2hpbGRyZW4gPSBbIHRoaXMucm9hZCwgdGhpcy5jZW50ZXJMaW5lIF07XHJcblxyXG4gICAgLy8gbXVzdCBiZSB1bmxpbmtlZCBpbiBkaXNwb3NlXHJcbiAgICBjb25zdCBzdGlja2luZ1RvVHJhY2tMaXN0ZW5lciA9IHN0aWNraW5nID0+IHtcclxuICAgICAgdGhpcy5jZW50ZXJMaW5lLmxpbmVEYXNoID0gc3RpY2tpbmcgPyBbIDExLCA4IF0gOiBbXTtcclxuICAgIH07XHJcbiAgICBtb2RlbC5zdGlja2luZ1RvVHJhY2tQcm9wZXJ0eS5saW5rKCBzdGlja2luZ1RvVHJhY2tMaXN0ZW5lciApO1xyXG5cclxuICAgIC8vIFJldXNlIGFycmF5cyB0byBzYXZlIGFsbG9jYXRpb25zIGFuZCBwcmV2ZW50IGdhcmJhZ2UgY29sbGVjdGlvbnMsIHNlZSAjMzhcclxuICAgIHRoaXMueEFycmF5ID0gbmV3IEZhc3RBcnJheSggdHJhY2suY29udHJvbFBvaW50cy5sZW5ndGggKTtcclxuICAgIHRoaXMueUFycmF5ID0gbmV3IEZhc3RBcnJheSggdHJhY2suY29udHJvbFBvaW50cy5sZW5ndGggKTtcclxuXHJcbiAgICAvLyBTdG9yZSBmb3IgcGVyZm9ybWFuY2VcclxuICAgIHRoaXMubGFzdFBvaW50ID0gKCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aCAtIDEgKSAvIHRyYWNrLmNvbnRyb2xQb2ludHMubGVuZ3RoO1xyXG5cclxuICAgIC8vIFNhbXBsZSBzcGFjZSwgd2hpY2ggaXMgcmVjb21wdXRlZCBpZiB0aGUgdHJhY2sgZ2V0cyBsb25nZXIsIHRvIGtlZXAgaXQgbG9va2luZyBzbW9vdGggbm8gbWF0dGVyIGhvdyBtYW55IGNvbnRyb2wgcG9pbnRzXHJcbiAgICB0aGlzLmxpblNwYWNlID0gbnVtZXJpYy5saW5zcGFjZSggMCwgdGhpcy5sYXN0UG9pbnQsIDIwICogKCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aCAtIDEgKSApO1xyXG4gICAgdGhpcy5sZW5ndGhGb3JMaW5TcGFjZSA9IHRyYWNrLmNvbnRyb2xQb2ludHMubGVuZ3RoO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge1RyYWNrRHJhZ2hhbmRsZXJ9IC0gcHVibGljIHNvIHRoYXQgQ29udHJvbFBvaW50Tm9kZXMgc28gdGhhdCBkcmFnZ2luZyBhIGNvbnRyb2wgcG9pbnQgY2FuIGluaXRpYXRlXHJcbiAgICAvLyBkcmFnZ2luZyBhIHRyYWNrIGFuZCBkcmFnZ2luZyBmcm9tIHRvb2xib3ggY2FuIGZvcndhcmQgaW5wdXQgdG8gdGhpcyBsaXN0ZW5lclxyXG4gICAgdGhpcy50cmFja0RyYWdIYW5kbGVyID0gbnVsbDtcclxuICAgIGlmICggdHJhY2suZHJhZ2dhYmxlICkge1xyXG4gICAgICB0aGlzLnRyYWNrRHJhZ0hhbmRsZXIgPSBuZXcgVHJhY2tEcmFnSGFuZGxlciggdGhpcywgdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3RyYWNrRHJhZ0hhbmRsZXInICkgKTtcclxuICAgICAgdGhpcy5yb2FkLmFkZElucHV0TGlzdGVuZXIoIHRoaXMudHJhY2tEcmFnSGFuZGxlciApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIG9ubHkgXCJjb25maWd1cmFibGVcIiB0cmFja3MgaGF2ZSBkcmFnZ2FibGUgY29udHJvbCBwb2ludHMsIGFuZCBpbmRpdmlkdWFsIGNvbnRyb2wgcG9pbnRzIG1heSBoYXZlIGRyYWdnaW5nXHJcbiAgICAvLyBkaXNhYmxlZCAtIGFsc28sIFwiaWNvblwiIFRyYWNrTm9kZXMgZG8gbm90IGRpc3BsYXkgQ29udHJvbFBvaW50c1xyXG4gICAgaWYgKCB0cmFjay5jb25maWd1cmFibGUgJiYgIW9wdGlvbnMuaXNJY29uICkge1xyXG4gICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRyb2xQb2ludCA9IHRyYWNrLmNvbnRyb2xQb2ludHNbIGkgXTtcclxuXHJcbiAgICAgICAgaWYgKCBjb250cm9sUG9pbnQudmlzaWJsZSApIHtcclxuICAgICAgICAgIGNvbnN0IGlzRW5kUG9pbnQgPSBpID09PSAwIHx8IGkgPT09IHRyYWNrLmNvbnRyb2xQb2ludHMubGVuZ3RoIC0gMTtcclxuICAgICAgICAgIGNvbnN0IGNvbnRyb2xQb2ludE5vZGUgPSBuZXcgQ29udHJvbFBvaW50Tm9kZSggdGhpcywgdGhpcy50cmFja0RyYWdIYW5kbGVyLCBpLCBpc0VuZFBvaW50LCB0YW5kZW0uY3JlYXRlVGFuZGVtKCBgY29udHJvbFBvaW50Tm9kZSR7aX1gICkgKTtcclxuICAgICAgICAgIHRoaXMuYWRkQ2hpbGQoIGNvbnRyb2xQb2ludE5vZGUgKTtcclxuXHJcbiAgICAgICAgICBpZiAoIGNvbnRyb2xQb2ludC5saW1pdEJvdW5kcyApIHtcclxuICAgICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggY29udHJvbFBvaW50Tm9kZS5ib3VuZHNSZWN0YW5nbGUsICdib3VuZHMgYXJlIGxpbWl0ZWQgYnV0IHRoZXJlIGlzIG5vIGJvdW5kaW5nIFJlY3RhbmdsZScgKTtcclxuICAgICAgICAgICAgdGhpcy5hZGRDaGlsZCggY29udHJvbFBvaW50Tm9kZS5ib3VuZHNSZWN0YW5nbGUgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBJbml0IHRoZSB0cmFjayBzaGFwZVxyXG4gICAgdGhpcy51cGRhdGVUcmFja1NoYXBlKCk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSB0cmFjayBzaGFwZSB3aGVuIHRoZSB3aG9sZSB0cmFjayBpcyB0cmFuc2xhdGVkXHJcbiAgICAvLyBKdXN0IG9ic2VydmluZyB0aGUgY29udHJvbCBwb2ludHMgaW5kaXZpZHVhbGx5IHdvdWxkIGxlYWQgdG8gTiBleHBlbnNpdmUgY2FsbGJhY2tzIChpbnN0ZWFkIG9mIDEpIGZvciBlYWNoIG9mIHRoZSBOIHBvaW50c1xyXG4gICAgLy8gU28gd2UgdXNlIHRoaXMgYnJvYWRjYXN0IG1lY2hhbmlzbSBpbnN0ZWFkXHJcbiAgICB0cmFjay50cmFuc2xhdGVkRW1pdHRlci5hZGRMaXN0ZW5lciggdGhpcy51cGRhdGVUcmFja1NoYXBlLmJpbmQoIHRoaXMgKSApO1xyXG5cclxuICAgIHRyYWNrLmRyYWdnaW5nUHJvcGVydHkubGluayggZHJhZ2dpbmcgPT4ge1xyXG4gICAgICBpZiAoICFkcmFnZ2luZyApIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVRyYWNrU2hhcGUoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRyYWNrLnJlc2V0RW1pdHRlci5hZGRMaXN0ZW5lciggdGhpcy51cGRhdGVUcmFja1NoYXBlLmJpbmQoIHRoaXMgKSApO1xyXG4gICAgdHJhY2suc21vb3RoZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLnVwZGF0ZVRyYWNrU2hhcGUuYmluZCggdGhpcyApICk7XHJcbiAgICB0cmFjay51cGRhdGVFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLnVwZGF0ZVRyYWNrU2hhcGUuYmluZCggdGhpcyApICk7XHJcblxyXG4gICAgLy8gdHJhY2sgd2FzIHB1bGxlZCBmcm9tIHRoZSB0b29sIGJveCwgc3RhcnQgZHJhZyBldmVudCB0byB0aGUgZHJhZyBsaXN0ZW5lclxyXG4gICAgdHJhY2suZm9yd2FyZGluZ0RyYWdTdGFydEVtaXR0ZXIuYWRkTGlzdGVuZXIoIGV2ZW50ID0+IHtcclxuICAgICAgdGhpcy50cmFja0RyYWdIYW5kbGVyLnByZXNzKCBldmVudCApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEluIHRoZSBzdGF0ZSB3cmFwcGVyLCB3aGVuIHRoZSBzdGF0ZSBjaGFuZ2VzLCB3ZSBtdXN0IHVwZGF0ZSB0aGUgc2thdGVyIG5vZGVcclxuICAgIGNvbnN0IHN0YXRlTGlzdGVuZXIgPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlVHJhY2tTaGFwZSgpO1xyXG4gICAgfTtcclxuICAgIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgcGhldC5waGV0aW8ucGhldGlvRW5naW5lLnBoZXRpb1N0YXRlRW5naW5lLnN0YXRlU2V0RW1pdHRlci5hZGRMaXN0ZW5lciggc3RhdGVMaXN0ZW5lciApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gb25seSBjYWxsZWQgYnkgZGlzcG9zZVxyXG4gICAgdGhpcy5kaXNwb3NlVHJhY2tOb2RlID0gKCkgPT4ge1xyXG4gICAgICBtb2RlbC5zdGlja2luZ1RvVHJhY2tQcm9wZXJ0eS51bmxpbmsoIHN0aWNraW5nVG9UcmFja0xpc3RlbmVyICk7XHJcbiAgICAgIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgcGhldC5waGV0aW8ucGhldGlvRW5naW5lLnBoZXRpb1N0YXRlRW5naW5lLnN0YXRlU2V0RW1pdHRlci5yZW1vdmVMaXN0ZW5lciggc3RhdGVMaXN0ZW5lciApO1xyXG4gICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5jaGlsZHJlblsgaSBdO1xyXG4gICAgICAgIGlmICggY2hpbGQgaW5zdGFuY2VvZiBDb250cm9sUG9pbnROb2RlICkge1xyXG4gICAgICAgICAgY2hpbGQuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgaS0tOyAvLyBDaGlsZCBpcyByZW1vdmVkLCB3ZSBtdXN0IGRlY3JlbWVudCBpbmRleCBzbyB3byBkb24ndCBtaXNzIHRoZSBuZXh0IGNoaWxkXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIHRyYWNrLmRyYWdnYWJsZSApIHtcclxuICAgICAgICB0aGlzLnRyYWNrRHJhZ0hhbmRsZXIuZGlzcG9zZSgpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFrZSBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy5kaXNwb3NlVHJhY2tOb2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBXaGVuIGEgY29udHJvbCBwb2ludCBoYXMgbW92ZWQsIG9yIHRoZSB0cmFjayBoYXMgbW92ZWQsIG9yIHRoZSB0cmFjayBoYXMgYmVlbiByZXNldCwgb3Igb24gaW5pdGlhbGl6YXRpb25cclxuICAgKiB1cGRhdGUgdGhlIHNoYXBlIG9mIHRoZSB0cmFjay5cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgdXBkYXRlVHJhY2tTaGFwZSgpIHtcclxuXHJcbiAgICBjb25zdCB0cmFjayA9IHRoaXMudHJhY2s7XHJcbiAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWw7XHJcblxyXG4gICAgbGV0IGk7XHJcbiAgICAvLyBVcGRhdGUgdGhlIHNhbXBsZSByYW5nZSB3aGVuIHRoZSBudW1iZXIgb2YgY29udHJvbCBwb2ludHMgaGFzIGNoYW5nZWRcclxuICAgIGlmICggdGhpcy5sZW5ndGhGb3JMaW5TcGFjZSAhPT0gdHJhY2suY29udHJvbFBvaW50cy5sZW5ndGggKSB7XHJcbiAgICAgIHRoaXMubGFzdFBvaW50ID0gKCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aCAtIDEgKSAvIHRyYWNrLmNvbnRyb2xQb2ludHMubGVuZ3RoO1xyXG4gICAgICB0aGlzLmxpblNwYWNlID0gbnVtZXJpYy5saW5zcGFjZSggMCwgdGhpcy5sYXN0UG9pbnQsIDIwICogKCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aCAtIDEgKSApO1xyXG4gICAgICB0aGlzLmxlbmd0aEZvckxpblNwYWNlID0gdHJhY2suY29udHJvbFBvaW50cy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQXJyYXlzIGFyZSBmaXhlZCBsZW5ndGgsIHNvIGp1c3Qgb3ZlcndyaXRlIHZhbHVlc1xyXG4gICAgZm9yICggaSA9IDA7IGkgPCB0cmFjay5jb250cm9sUG9pbnRzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICB0aGlzLnhBcnJheVsgaSBdID0gdHJhY2suY29udHJvbFBvaW50c1sgaSBdLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueDtcclxuICAgICAgdGhpcy55QXJyYXlbIGkgXSA9IHRyYWNrLmNvbnRyb2xQb2ludHNbIGkgXS5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ29tcHV0ZSBwb2ludHMgZm9yIGxpbmVUb1xyXG4gICAgY29uc3QgeFBvaW50cyA9IFNwbGluZUV2YWx1YXRpb24uYXRBcnJheSggdHJhY2sueFNwbGluZSwgdGhpcy5saW5TcGFjZSApO1xyXG4gICAgY29uc3QgeVBvaW50cyA9IFNwbGluZUV2YWx1YXRpb24uYXRBcnJheSggdHJhY2sueVNwbGluZSwgdGhpcy5saW5TcGFjZSApO1xyXG5cclxuICAgIGNvbnN0IHR4ID0gdGhpcy5nZXRUcmFuc2xhdGlvbigpO1xyXG4gICAgY29uc3Qgc2hhcGUgPSBuZXcgU2hhcGUoKS5tb3ZlVG8oXHJcbiAgICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WCggeFBvaW50c1sgMCBdICkgLSB0eC54LFxyXG4gICAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1koIHlQb2ludHNbIDAgXSApIC0gdHgueVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBTaG93IHRoZSB0cmFjayBhdCByZWR1Y2VkIHJlc29sdXRpb24gd2hpbGUgZHJhZ2dpbmcgc28gaXQgd2lsbCBiZSBzbW9vdGggYW5kIHJlc3BvbnNpdmUgd2hpbGUgZHJhZ2dpbmdcclxuICAgIC8vICh3aGV0aGVyIHVwZGF0aW5nIHRoZSBlbnRpcmUgdHJhY2ssIHNvbWUgb2YgdGhlIGNvbnRyb2wgcG9pbnRzIG9yIGJvdGgpXHJcbiAgICBjb25zdCBkZWx0YSA9IHRyYWNrLmRyYWdnaW5nUHJvcGVydHkudmFsdWUgPyAzIDogMTtcclxuICAgIGZvciAoIGkgPSAxOyBpIDwgeFBvaW50cy5sZW5ndGg7IGkgPSBpICsgZGVsdGEgKSB7XHJcbiAgICAgIHNoYXBlLmxpbmVUbyggdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYKCB4UG9pbnRzWyBpIF0gKSAtIHR4LngsIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WSggeVBvaW50c1sgaSBdICkgLSB0eC55ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSWYgYXQgcmVkdWNlZCByZXNvbHV0aW9uLCBzdGlsbCBtYWtlIHN1cmUgd2UgZHJhdyB0byB0aGUgZW5kIHBvaW50XHJcbiAgICBpZiAoIGkgIT09IHhQb2ludHMubGVuZ3RoIC0gMSApIHtcclxuICAgICAgaSA9IHhQb2ludHMubGVuZ3RoIC0gMTtcclxuICAgICAgc2hhcGUubGluZVRvKCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1goIHhQb2ludHNbIGkgXSApIC0gdHgueCwgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCB5UG9pbnRzWyBpIF0gKSAtIHR4LnkgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdHJva2VTdHlsZXMgPSBuZXcgTGluZVN0eWxlcygge1xyXG4gICAgICBsaW5lV2lkdGg6IHRoaXMuaXNJY29uID8gMzAgOiAxMixcclxuICAgICAgbGluZUNhcDogJ2J1dHQnLFxyXG4gICAgICBsaW5lSm9pbjogJ21pdGVyJyxcclxuICAgICAgbWl0ZXJMaW1pdDogMTBcclxuICAgIH0gKTtcclxuICAgIHRoaXMucm9hZC5zaGFwZSA9IHNoYXBlLmdldFN0cm9rZWRTaGFwZSggc3Ryb2tlU3R5bGVzICk7XHJcbiAgICB0aGlzLmNlbnRlckxpbmUuc2hhcGUgPSBzaGFwZTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHNrYXRlciBpZiB0aGUgdHJhY2sgaXMgbW92ZWQgd2hpbGUgdGhlIHNpbSBpcyBwYXVzZWQsIHNlZSAjODRcclxuICAgIGlmICggbW9kZWwuc2thdGVyLnRyYWNrUHJvcGVydHkudmFsdWUgPT09IHRyYWNrICYmIG1vZGVsLnBhdXNlZFByb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICBtb2RlbC5za2F0ZXIucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IHRyYWNrLmdldFBvaW50KCBtb2RlbC5za2F0ZXIucGFyYW1ldHJpY1Bvc2l0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuICAgICAgbW9kZWwuc2thdGVyLmFuZ2xlUHJvcGVydHkudmFsdWUgPSBtb2RlbC5za2F0ZXIudHJhY2tQcm9wZXJ0eS52YWx1ZS5nZXRWaWV3QW5nbGVBdCggbW9kZWwuc2thdGVyLnBhcmFtZXRyaWNQb3NpdGlvblByb3BlcnR5LnZhbHVlICkgKyAoIG1vZGVsLnNrYXRlci5vblRvcFNpZGVPZlRyYWNrUHJvcGVydHkudmFsdWUgPyAwIDogTWF0aC5QSSApO1xyXG4gICAgICBtb2RlbC5za2F0ZXIudXBkYXRlZEVtaXR0ZXIuZW1pdCgpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZW5lcmd5U2thdGVQYXJrLnJlZ2lzdGVyKCAnVHJhY2tOb2RlJywgVHJhY2tOb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IFRyYWNrTm9kZTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEdBQUcsTUFBTSwyQkFBMkI7QUFDM0MsU0FBU0MsVUFBVSxFQUFFQyxLQUFLLFFBQVEsZ0NBQWdDO0FBQ2xFLE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsU0FBU0MsSUFBSSxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQzlELE9BQU9DLE1BQU0sTUFBTSxpQ0FBaUM7QUFDcEQsT0FBT0MsZUFBZSxNQUFNLDBCQUEwQjtBQUN0RCxPQUFPQyxnQkFBZ0IsTUFBTSx3QkFBd0I7QUFDckQsT0FBT0MsZ0JBQWdCLE1BQU0sdUJBQXVCO0FBQ3BELE9BQU9DLGdCQUFnQixNQUFNLHVCQUF1Qjs7QUFFcEQ7QUFDQSxNQUFNQyxTQUFTLEdBQUdYLEdBQUcsQ0FBQ1csU0FBUztBQUUvQixNQUFNQyxTQUFTLFNBQVNSLElBQUksQ0FBQztFQUUzQjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFUyxX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