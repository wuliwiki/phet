// Copyright 2013-2023, University of Colorado Boulder

/**
 * Scenery node for the skater, which is draggable.
 *
 * Converted to composition instead of inheritance for SkaterNode to work around updateSVGFragment problem, see #123
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Property from '../../../../axon/js/Property.js';
import LinearFunction from '../../../../dot/js/LinearFunction.js';
import Matrix3 from '../../../../dot/js/Matrix3.js';
import { Circle, DragListener, Image, Node } from '../../../../scenery/js/imports.js';
import skater1_set1_left_png from '../../../images/skater1_set1_left_png.js';
import skater1_set1_right_png from '../../../images/skater1_set1_right_png.js';
import energySkatePark from '../../energySkatePark.js';
import Skater from '../model/Skater.js';
import SkaterImages from './SkaterImages.js';
class SkaterNode extends Node {
  /**
   * SkaterNode constructor.
   *
   * @param {Skater} skater
   * @param {EnergySkateParkScreenView} view
   * @param {BooleanProperty} userControlledProperty
   * @param {ModelViewTransform2} modelViewTransform
   * @param {function(Vector2, Track[]):Object} getClosestTrackAndPositionAndParameter - gets the closest track
   *                                            properties, used when the skater is being dragged close to the track.
   *                                            See EnergySkateParkModel.getClosestTrackAndPositionAndParameter
   * @param {function} getPhysicalTracks - function that returns the physical tracks in the model, so the skater can try
   *                                       to attach to them while dragging
   * @param {Tandem} tandem
   */
  constructor(skater, view, userControlledProperty, modelViewTransform, getClosestTrackAndPositionAndParameter, getPhysicalTracks, tandem) {
    super({
      // rendering the skater with canvas makes it move smoothly around the screen edges in iOS Safari, see
      // https://github.com/phetsims/energy-skate-park/issues/42
      renderer: 'canvas',
      // prevent fitted blocks for the Skater to improve performance, see #213
      preventFit: true,
      tandem: tandem
    });

    // @private {Image} - left and right Images for the skater
    const leftSkaterImageNode = new Image(skater1_set1_left_png, {
      cursor: 'pointer',
      tandem: tandem.createTandem('leftSkaterImageNode')
    });
    const rightSkaterImageNode = new Image(skater1_set1_right_png, {
      cursor: 'pointer',
      tandem: tandem.createTandem('rightSkaterImageNode')
    });
    this.children = [leftSkaterImageNode, rightSkaterImageNode];

    // Show a red dot in the bottom center as the important particle model coordinate
    const circle = new Circle(8, {
      fill: 'red'
    });
    this.addChild(circle);

    // @public - One of SkaterImages.SkaterImageSet, with images for left and right motion. Controls the skater
    // character.
    this.skaterImageSetProperty = new Property(SkaterImages.SKATER_CHARACTER_SETS[0].imageSet1);
    let imageWidth;
    let imageHeight;

    // @private {Skater}
    this.skater = skater;
    this.skaterImageSetProperty.link(skaterImage => {
      leftSkaterImageNode.image = skaterImage.leftImage;
      rightSkaterImageNode.image = skaterImage.rightImage;
      imageWidth = leftSkaterImageNode.width;
      imageHeight = leftSkaterImageNode.height;
      circle.x = imageWidth / 2;
      circle.y = imageHeight;

      // image dimensions might have changed, update matrix (which horizontally centers the image around the position)
      this.skater.updatedEmitter.emit();
    });
    skater.directionProperty.link(direction => {
      leftSkaterImageNode.visible = direction === Skater.Direction.LEFT;
      rightSkaterImageNode.visible = direction === Skater.Direction.RIGHT;
    });

    // @private - Map from mass(kg) to the amount to scale the image
    const centerMassValue = skater.massRange.getCenter();
    const massToScale = new LinearFunction(centerMassValue, skater.massRange.max, 0.46, 0.614);

    // make the SkaterNode invisible  until the first update so it isn't displayed in the wrong location before
    // the matrix is set on the first update
    this.visible = false;

    // Update the position and angle.  Normally the angle would only change if the position has also changed, so no need
    // for a duplicate callback there.
    this.skater.updatedEmitter.addListener(() => {
      // update visibility on first model update
      if (!this.visible) {
        this.visible = true;
      }
      const mass = skater.massProperty.value;
      const position = skater.positionProperty.value;
      const angle = skater.angleProperty.value;
      const view = modelViewTransform.modelToViewPosition(position);

      // Translate to the desired position
      const matrix = Matrix3.translation(view.x, view.y);

      // Rotate about the pivot (bottom center of the skater)
      const rotationMatrix = Matrix3.rotation2(angle);
      matrix.multiplyMatrix(rotationMatrix);
      rotationMatrix.freeToPool();
      const scale = massToScale.evaluate(mass);
      const scalingMatrix = Matrix3.scaling(scale);
      matrix.multiplyMatrix(scalingMatrix);
      scalingMatrix.freeToPool();

      // Inverting the scale of the red circle so it always stays the same size
      circle.setRadius(3.5 / scale);

      // Think of it as a multiplying the Vector2 to the right, so this step happens first actually.  Use it to center
      // the registration point
      const translation = Matrix3.translation(-imageWidth / 2, -imageHeight);
      matrix.multiplyMatrix(translation);
      translation.freeToPool();
      this.setMatrix(matrix);
    });
    let targetTrack = null;
    let targetU = null;
    const dragSkater = event => {
      const globalPoint = this.globalToParentPoint(event.pointer.point);
      let position = modelViewTransform.viewToModelPosition(globalPoint);

      // make sure it is within the visible bounds
      position = view.availableModelBounds.getClosestPoint(position.x, position.y, position);

      // PERFORMANCE/ALLOCATION: lots of unnecessary allocations and computation here, biggest improvement could be
      // to use binary search for position on the track
      const closestTrackAndPositionAndParameter = getClosestTrackAndPositionAndParameter(position, getPhysicalTracks());
      let closeEnough = false;
      if (closestTrackAndPositionAndParameter && closestTrackAndPositionAndParameter.track && closestTrackAndPositionAndParameter.track.isParameterInBounds(closestTrackAndPositionAndParameter.parametricPosition)) {
        const closestPoint = closestTrackAndPositionAndParameter.point;
        const distance = closestPoint.distance(position);
        if (distance < 0.5) {
          position = closestPoint;
          targetTrack = closestTrackAndPositionAndParameter.track;
          targetU = closestTrackAndPositionAndParameter.parametricPosition;

          // Choose the right side of the track, i.e. the side of the track that would have the skater upside up
          const normal = targetTrack.getUnitNormalVector(targetU);
          skater.onTopSideOfTrackProperty.value = normal.y > 0;
          skater.angleProperty.value = targetTrack.getViewAngleAt(targetU) + (skater.onTopSideOfTrackProperty.value ? 0 : Math.PI);
          closeEnough = true;
        }
      }
      if (!closeEnough) {
        targetTrack = null;
        targetU = null;

        // make skater upright if not near the track
        skater.angleProperty.value = 0;
        skater.onTopSideOfTrackProperty.value = true;
        skater.positionProperty.value = position;
      } else {
        skater.positionProperty.value = targetTrack.getPoint(targetU);
      }
      skater.updateEnergy();
      skater.updatedEmitter.emit();
    };

    // @private - for interruption, see interruptDrag
    this.dragHandler = new DragListener({
      tandem: tandem.createTandem('dragListener'),
      start: event => {
        userControlledProperty.set(true);
        skater.draggingProperty.value = true;

        // Clear thermal energy whenever skater is grabbed, see #32
        skater.thermalEnergyProperty.value = 0;

        // Jump to the input position when dragged
        dragSkater(event);
      },
      drag: dragSkater,
      end: () => {
        // Record the state of the skater for "return skater"
        skater.released(targetTrack, targetU);
        userControlledProperty.set(false);
      }
    });
    this.addInputListener(this.dragHandler);
  }

  /**
   * If dragging, interrupt and release the Skater.
   * @public
   */
  interruptDrag() {
    if (this.dragHandler.isPressed) {
      this.dragHandler.interrupt();
    }
  }
}
energySkatePark.register('SkaterNode', SkaterNode);
export default SkaterNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkxpbmVhckZ1bmN0aW9uIiwiTWF0cml4MyIsIkNpcmNsZSIsIkRyYWdMaXN0ZW5lciIsIkltYWdlIiwiTm9kZSIsInNrYXRlcjFfc2V0MV9sZWZ0X3BuZyIsInNrYXRlcjFfc2V0MV9yaWdodF9wbmciLCJlbmVyZ3lTa2F0ZVBhcmsiLCJTa2F0ZXIiLCJTa2F0ZXJJbWFnZXMiLCJTa2F0ZXJOb2RlIiwiY29uc3RydWN0b3IiLCJza2F0ZXIiLCJ2aWV3IiwidXNlckNvbnRyb2xsZWRQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImdldENsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyIiwiZ2V0UGh5c2ljYWxUcmFja3MiLCJ0YW5kZW0iLCJyZW5kZXJlciIsInByZXZlbnRGaXQiLCJsZWZ0U2thdGVySW1hZ2VOb2RlIiwiY3Vyc29yIiwiY3JlYXRlVGFuZGVtIiwicmlnaHRTa2F0ZXJJbWFnZU5vZGUiLCJjaGlsZHJlbiIsImNpcmNsZSIsImZpbGwiLCJhZGRDaGlsZCIsInNrYXRlckltYWdlU2V0UHJvcGVydHkiLCJTS0FURVJfQ0hBUkFDVEVSX1NFVFMiLCJpbWFnZVNldDEiLCJpbWFnZVdpZHRoIiwiaW1hZ2VIZWlnaHQiLCJsaW5rIiwic2thdGVySW1hZ2UiLCJpbWFnZSIsImxlZnRJbWFnZSIsInJpZ2h0SW1hZ2UiLCJ3aWR0aCIsImhlaWdodCIsIngiLCJ5IiwidXBkYXRlZEVtaXR0ZXIiLCJlbWl0IiwiZGlyZWN0aW9uUHJvcGVydHkiLCJkaXJlY3Rpb24iLCJ2aXNpYmxlIiwiRGlyZWN0aW9uIiwiTEVGVCIsIlJJR0hUIiwiY2VudGVyTWFzc1ZhbHVlIiwibWFzc1JhbmdlIiwiZ2V0Q2VudGVyIiwibWFzc1RvU2NhbGUiLCJtYXgiLCJhZGRMaXN0ZW5lciIsIm1hc3MiLCJtYXNzUHJvcGVydHkiLCJ2YWx1ZSIsInBvc2l0aW9uIiwicG9zaXRpb25Qcm9wZXJ0eSIsImFuZ2xlIiwiYW5nbGVQcm9wZXJ0eSIsIm1vZGVsVG9WaWV3UG9zaXRpb24iLCJtYXRyaXgiLCJ0cmFuc2xhdGlvbiIsInJvdGF0aW9uTWF0cml4Iiwicm90YXRpb24yIiwibXVsdGlwbHlNYXRyaXgiLCJmcmVlVG9Qb29sIiwic2NhbGUiLCJldmFsdWF0ZSIsInNjYWxpbmdNYXRyaXgiLCJzY2FsaW5nIiwic2V0UmFkaXVzIiwic2V0TWF0cml4IiwidGFyZ2V0VHJhY2siLCJ0YXJnZXRVIiwiZHJhZ1NrYXRlciIsImV2ZW50IiwiZ2xvYmFsUG9pbnQiLCJnbG9iYWxUb1BhcmVudFBvaW50IiwicG9pbnRlciIsInBvaW50Iiwidmlld1RvTW9kZWxQb3NpdGlvbiIsImF2YWlsYWJsZU1vZGVsQm91bmRzIiwiZ2V0Q2xvc2VzdFBvaW50IiwiY2xvc2VzdFRyYWNrQW5kUG9zaXRpb25BbmRQYXJhbWV0ZXIiLCJjbG9zZUVub3VnaCIsInRyYWNrIiwiaXNQYXJhbWV0ZXJJbkJvdW5kcyIsInBhcmFtZXRyaWNQb3NpdGlvbiIsImNsb3Nlc3RQb2ludCIsImRpc3RhbmNlIiwibm9ybWFsIiwiZ2V0VW5pdE5vcm1hbFZlY3RvciIsIm9uVG9wU2lkZU9mVHJhY2tQcm9wZXJ0eSIsImdldFZpZXdBbmdsZUF0IiwiTWF0aCIsIlBJIiwiZ2V0UG9pbnQiLCJ1cGRhdGVFbmVyZ3kiLCJkcmFnSGFuZGxlciIsInN0YXJ0Iiwic2V0IiwiZHJhZ2dpbmdQcm9wZXJ0eSIsInRoZXJtYWxFbmVyZ3lQcm9wZXJ0eSIsImRyYWciLCJlbmQiLCJyZWxlYXNlZCIsImFkZElucHV0TGlzdGVuZXIiLCJpbnRlcnJ1cHREcmFnIiwiaXNQcmVzc2VkIiwiaW50ZXJydXB0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTa2F0ZXJOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNjZW5lcnkgbm9kZSBmb3IgdGhlIHNrYXRlciwgd2hpY2ggaXMgZHJhZ2dhYmxlLlxyXG4gKlxyXG4gKiBDb252ZXJ0ZWQgdG8gY29tcG9zaXRpb24gaW5zdGVhZCBvZiBpbmhlcml0YW5jZSBmb3IgU2thdGVyTm9kZSB0byB3b3JrIGFyb3VuZCB1cGRhdGVTVkdGcmFnbWVudCBwcm9ibGVtLCBzZWUgIzEyM1xyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IExpbmVhckZ1bmN0aW9uIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9MaW5lYXJGdW5jdGlvbi5qcyc7XHJcbmltcG9ydCBNYXRyaXgzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9NYXRyaXgzLmpzJztcclxuaW1wb3J0IHsgQ2lyY2xlLCBEcmFnTGlzdGVuZXIsIEltYWdlLCBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHNrYXRlcjFfc2V0MV9sZWZ0X3BuZyBmcm9tICcuLi8uLi8uLi9pbWFnZXMvc2thdGVyMV9zZXQxX2xlZnRfcG5nLmpzJztcclxuaW1wb3J0IHNrYXRlcjFfc2V0MV9yaWdodF9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL3NrYXRlcjFfc2V0MV9yaWdodF9wbmcuanMnO1xyXG5pbXBvcnQgZW5lcmd5U2thdGVQYXJrIGZyb20gJy4uLy4uL2VuZXJneVNrYXRlUGFyay5qcyc7XHJcbmltcG9ydCBTa2F0ZXIgZnJvbSAnLi4vbW9kZWwvU2thdGVyLmpzJztcclxuaW1wb3J0IFNrYXRlckltYWdlcyBmcm9tICcuL1NrYXRlckltYWdlcy5qcyc7XHJcblxyXG5jbGFzcyBTa2F0ZXJOb2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIFNrYXRlck5vZGUgY29uc3RydWN0b3IuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1NrYXRlcn0gc2thdGVyXHJcbiAgICogQHBhcmFtIHtFbmVyZ3lTa2F0ZVBhcmtTY3JlZW5WaWV3fSB2aWV3XHJcbiAgICogQHBhcmFtIHtCb29sZWFuUHJvcGVydHl9IHVzZXJDb250cm9sbGVkUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge01vZGVsVmlld1RyYW5zZm9ybTJ9IG1vZGVsVmlld1RyYW5zZm9ybVxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24oVmVjdG9yMiwgVHJhY2tbXSk6T2JqZWN0fSBnZXRDbG9zZXN0VHJhY2tBbmRQb3NpdGlvbkFuZFBhcmFtZXRlciAtIGdldHMgdGhlIGNsb3Nlc3QgdHJhY2tcclxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllcywgdXNlZCB3aGVuIHRoZSBza2F0ZXIgaXMgYmVpbmcgZHJhZ2dlZCBjbG9zZSB0byB0aGUgdHJhY2suXHJcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlZSBFbmVyZ3lTa2F0ZVBhcmtNb2RlbC5nZXRDbG9zZXN0VHJhY2tBbmRQb3NpdGlvbkFuZFBhcmFtZXRlclxyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGdldFBoeXNpY2FsVHJhY2tzIC0gZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBwaHlzaWNhbCB0cmFja3MgaW4gdGhlIG1vZGVsLCBzbyB0aGUgc2thdGVyIGNhbiB0cnlcclxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGF0dGFjaCB0byB0aGVtIHdoaWxlIGRyYWdnaW5nXHJcbiAgICogQHBhcmFtIHtUYW5kZW19IHRhbmRlbVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBza2F0ZXIsIHZpZXcsIHVzZXJDb250cm9sbGVkUHJvcGVydHksIG1vZGVsVmlld1RyYW5zZm9ybSwgZ2V0Q2xvc2VzdFRyYWNrQW5kUG9zaXRpb25BbmRQYXJhbWV0ZXIsIGdldFBoeXNpY2FsVHJhY2tzLCB0YW5kZW0gKSB7XHJcbiAgICBzdXBlcigge1xyXG5cclxuICAgICAgLy8gcmVuZGVyaW5nIHRoZSBza2F0ZXIgd2l0aCBjYW52YXMgbWFrZXMgaXQgbW92ZSBzbW9vdGhseSBhcm91bmQgdGhlIHNjcmVlbiBlZGdlcyBpbiBpT1MgU2FmYXJpLCBzZWVcclxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2VuZXJneS1za2F0ZS1wYXJrL2lzc3Vlcy80MlxyXG4gICAgICByZW5kZXJlcjogJ2NhbnZhcycsXHJcblxyXG4gICAgICAvLyBwcmV2ZW50IGZpdHRlZCBibG9ja3MgZm9yIHRoZSBTa2F0ZXIgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZSwgc2VlICMyMTNcclxuICAgICAgcHJldmVudEZpdDogdHJ1ZSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7SW1hZ2V9IC0gbGVmdCBhbmQgcmlnaHQgSW1hZ2VzIGZvciB0aGUgc2thdGVyXHJcbiAgICBjb25zdCBsZWZ0U2thdGVySW1hZ2VOb2RlID0gbmV3IEltYWdlKCBza2F0ZXIxX3NldDFfbGVmdF9wbmcsIHtcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2xlZnRTa2F0ZXJJbWFnZU5vZGUnIClcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IHJpZ2h0U2thdGVySW1hZ2VOb2RlID0gbmV3IEltYWdlKCBza2F0ZXIxX3NldDFfcmlnaHRfcG5nLCB7XHJcbiAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdyaWdodFNrYXRlckltYWdlTm9kZScgKVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5jaGlsZHJlbiA9IFsgbGVmdFNrYXRlckltYWdlTm9kZSwgcmlnaHRTa2F0ZXJJbWFnZU5vZGUgXTtcclxuXHJcbiAgICAvLyBTaG93IGEgcmVkIGRvdCBpbiB0aGUgYm90dG9tIGNlbnRlciBhcyB0aGUgaW1wb3J0YW50IHBhcnRpY2xlIG1vZGVsIGNvb3JkaW5hdGVcclxuICAgIGNvbnN0IGNpcmNsZSA9IG5ldyBDaXJjbGUoIDgsIHsgZmlsbDogJ3JlZCcgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggY2lyY2xlICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAtIE9uZSBvZiBTa2F0ZXJJbWFnZXMuU2thdGVySW1hZ2VTZXQsIHdpdGggaW1hZ2VzIGZvciBsZWZ0IGFuZCByaWdodCBtb3Rpb24uIENvbnRyb2xzIHRoZSBza2F0ZXJcclxuICAgIC8vIGNoYXJhY3Rlci5cclxuICAgIHRoaXMuc2thdGVySW1hZ2VTZXRQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggU2thdGVySW1hZ2VzLlNLQVRFUl9DSEFSQUNURVJfU0VUU1sgMCBdLmltYWdlU2V0MSApO1xyXG5cclxuICAgIGxldCBpbWFnZVdpZHRoO1xyXG4gICAgbGV0IGltYWdlSGVpZ2h0O1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtTa2F0ZXJ9XHJcbiAgICB0aGlzLnNrYXRlciA9IHNrYXRlcjtcclxuXHJcbiAgICB0aGlzLnNrYXRlckltYWdlU2V0UHJvcGVydHkubGluayggc2thdGVySW1hZ2UgPT4ge1xyXG4gICAgICBsZWZ0U2thdGVySW1hZ2VOb2RlLmltYWdlID0gc2thdGVySW1hZ2UubGVmdEltYWdlO1xyXG4gICAgICByaWdodFNrYXRlckltYWdlTm9kZS5pbWFnZSA9IHNrYXRlckltYWdlLnJpZ2h0SW1hZ2U7XHJcblxyXG4gICAgICBpbWFnZVdpZHRoID0gbGVmdFNrYXRlckltYWdlTm9kZS53aWR0aDtcclxuICAgICAgaW1hZ2VIZWlnaHQgPSBsZWZ0U2thdGVySW1hZ2VOb2RlLmhlaWdodDtcclxuXHJcbiAgICAgIGNpcmNsZS54ID0gaW1hZ2VXaWR0aCAvIDI7XHJcbiAgICAgIGNpcmNsZS55ID0gaW1hZ2VIZWlnaHQ7XHJcblxyXG4gICAgICAvLyBpbWFnZSBkaW1lbnNpb25zIG1pZ2h0IGhhdmUgY2hhbmdlZCwgdXBkYXRlIG1hdHJpeCAod2hpY2ggaG9yaXpvbnRhbGx5IGNlbnRlcnMgdGhlIGltYWdlIGFyb3VuZCB0aGUgcG9zaXRpb24pXHJcbiAgICAgIHRoaXMuc2thdGVyLnVwZGF0ZWRFbWl0dGVyLmVtaXQoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBza2F0ZXIuZGlyZWN0aW9uUHJvcGVydHkubGluayggZGlyZWN0aW9uID0+IHtcclxuICAgICAgbGVmdFNrYXRlckltYWdlTm9kZS52aXNpYmxlID0gZGlyZWN0aW9uID09PSBTa2F0ZXIuRGlyZWN0aW9uLkxFRlQ7XHJcbiAgICAgIHJpZ2h0U2thdGVySW1hZ2VOb2RlLnZpc2libGUgPSBkaXJlY3Rpb24gPT09IFNrYXRlci5EaXJlY3Rpb24uUklHSFQ7XHJcbiAgICB9ICk7XHJcblxyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gTWFwIGZyb20gbWFzcyhrZykgdG8gdGhlIGFtb3VudCB0byBzY2FsZSB0aGUgaW1hZ2VcclxuICAgIGNvbnN0IGNlbnRlck1hc3NWYWx1ZSA9IHNrYXRlci5tYXNzUmFuZ2UuZ2V0Q2VudGVyKCk7XHJcbiAgICBjb25zdCBtYXNzVG9TY2FsZSA9IG5ldyBMaW5lYXJGdW5jdGlvbiggY2VudGVyTWFzc1ZhbHVlLCBza2F0ZXIubWFzc1JhbmdlLm1heCwgMC40NiwgMC42MTQgKTtcclxuXHJcbiAgICAvLyBtYWtlIHRoZSBTa2F0ZXJOb2RlIGludmlzaWJsZSAgdW50aWwgdGhlIGZpcnN0IHVwZGF0ZSBzbyBpdCBpc24ndCBkaXNwbGF5ZWQgaW4gdGhlIHdyb25nIGxvY2F0aW9uIGJlZm9yZVxyXG4gICAgLy8gdGhlIG1hdHJpeCBpcyBzZXQgb24gdGhlIGZpcnN0IHVwZGF0ZVxyXG4gICAgdGhpcy52aXNpYmxlID0gZmFsc2U7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBwb3NpdGlvbiBhbmQgYW5nbGUuICBOb3JtYWxseSB0aGUgYW5nbGUgd291bGQgb25seSBjaGFuZ2UgaWYgdGhlIHBvc2l0aW9uIGhhcyBhbHNvIGNoYW5nZWQsIHNvIG5vIG5lZWRcclxuICAgIC8vIGZvciBhIGR1cGxpY2F0ZSBjYWxsYmFjayB0aGVyZS5cclxuICAgIHRoaXMuc2thdGVyLnVwZGF0ZWRFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcblxyXG4gICAgICAvLyB1cGRhdGUgdmlzaWJpbGl0eSBvbiBmaXJzdCBtb2RlbCB1cGRhdGVcclxuICAgICAgaWYgKCAhdGhpcy52aXNpYmxlICkge1xyXG4gICAgICAgIHRoaXMudmlzaWJsZSA9IHRydWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IG1hc3MgPSBza2F0ZXIubWFzc1Byb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHNrYXRlci5wb3NpdGlvblByb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBhbmdsZSA9IHNrYXRlci5hbmdsZVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgY29uc3QgdmlldyA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCBwb3NpdGlvbiApO1xyXG5cclxuICAgICAgLy8gVHJhbnNsYXRlIHRvIHRoZSBkZXNpcmVkIHBvc2l0aW9uXHJcbiAgICAgIGNvbnN0IG1hdHJpeCA9IE1hdHJpeDMudHJhbnNsYXRpb24oIHZpZXcueCwgdmlldy55ICk7XHJcblxyXG4gICAgICAvLyBSb3RhdGUgYWJvdXQgdGhlIHBpdm90IChib3R0b20gY2VudGVyIG9mIHRoZSBza2F0ZXIpXHJcbiAgICAgIGNvbnN0IHJvdGF0aW9uTWF0cml4ID0gTWF0cml4My5yb3RhdGlvbjIoIGFuZ2xlICk7XHJcbiAgICAgIG1hdHJpeC5tdWx0aXBseU1hdHJpeCggcm90YXRpb25NYXRyaXggKTtcclxuICAgICAgcm90YXRpb25NYXRyaXguZnJlZVRvUG9vbCgpO1xyXG5cclxuICAgICAgY29uc3Qgc2NhbGUgPSBtYXNzVG9TY2FsZS5ldmFsdWF0ZSggbWFzcyApO1xyXG4gICAgICBjb25zdCBzY2FsaW5nTWF0cml4ID0gTWF0cml4My5zY2FsaW5nKCBzY2FsZSApO1xyXG4gICAgICBtYXRyaXgubXVsdGlwbHlNYXRyaXgoIHNjYWxpbmdNYXRyaXggKTtcclxuICAgICAgc2NhbGluZ01hdHJpeC5mcmVlVG9Qb29sKCk7XHJcblxyXG4gICAgICAvLyBJbnZlcnRpbmcgdGhlIHNjYWxlIG9mIHRoZSByZWQgY2lyY2xlIHNvIGl0IGFsd2F5cyBzdGF5cyB0aGUgc2FtZSBzaXplXHJcbiAgICAgIGNpcmNsZS5zZXRSYWRpdXMoIDMuNSAvIHNjYWxlICk7XHJcblxyXG4gICAgICAvLyBUaGluayBvZiBpdCBhcyBhIG11bHRpcGx5aW5nIHRoZSBWZWN0b3IyIHRvIHRoZSByaWdodCwgc28gdGhpcyBzdGVwIGhhcHBlbnMgZmlyc3QgYWN0dWFsbHkuICBVc2UgaXQgdG8gY2VudGVyXHJcbiAgICAgIC8vIHRoZSByZWdpc3RyYXRpb24gcG9pbnRcclxuICAgICAgY29uc3QgdHJhbnNsYXRpb24gPSBNYXRyaXgzLnRyYW5zbGF0aW9uKCAtaW1hZ2VXaWR0aCAvIDIsIC1pbWFnZUhlaWdodCApO1xyXG4gICAgICBtYXRyaXgubXVsdGlwbHlNYXRyaXgoIHRyYW5zbGF0aW9uICk7XHJcbiAgICAgIHRyYW5zbGF0aW9uLmZyZWVUb1Bvb2woKTtcclxuXHJcbiAgICAgIHRoaXMuc2V0TWF0cml4KCBtYXRyaXggKTtcclxuXHJcbiAgICB9ICk7XHJcblxyXG4gICAgbGV0IHRhcmdldFRyYWNrID0gbnVsbDtcclxuXHJcbiAgICBsZXQgdGFyZ2V0VSA9IG51bGw7XHJcblxyXG4gICAgY29uc3QgZHJhZ1NrYXRlciA9IGV2ZW50ID0+IHtcclxuICAgICAgY29uc3QgZ2xvYmFsUG9pbnQgPSB0aGlzLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKTtcclxuICAgICAgbGV0IHBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIGdsb2JhbFBvaW50ICk7XHJcblxyXG4gICAgICAvLyBtYWtlIHN1cmUgaXQgaXMgd2l0aGluIHRoZSB2aXNpYmxlIGJvdW5kc1xyXG4gICAgICBwb3NpdGlvbiA9IHZpZXcuYXZhaWxhYmxlTW9kZWxCb3VuZHMuZ2V0Q2xvc2VzdFBvaW50KCBwb3NpdGlvbi54LCBwb3NpdGlvbi55LCBwb3NpdGlvbiApO1xyXG5cclxuICAgICAgLy8gUEVSRk9STUFOQ0UvQUxMT0NBVElPTjogbG90cyBvZiB1bm5lY2Vzc2FyeSBhbGxvY2F0aW9ucyBhbmQgY29tcHV0YXRpb24gaGVyZSwgYmlnZ2VzdCBpbXByb3ZlbWVudCBjb3VsZCBiZVxyXG4gICAgICAvLyB0byB1c2UgYmluYXJ5IHNlYXJjaCBmb3IgcG9zaXRpb24gb24gdGhlIHRyYWNrXHJcbiAgICAgIGNvbnN0IGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyID0gZ2V0Q2xvc2VzdFRyYWNrQW5kUG9zaXRpb25BbmRQYXJhbWV0ZXIoIHBvc2l0aW9uLCBnZXRQaHlzaWNhbFRyYWNrcygpICk7XHJcbiAgICAgIGxldCBjbG9zZUVub3VnaCA9IGZhbHNlO1xyXG4gICAgICBpZiAoIGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyICYmIGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyLnRyYWNrICYmIGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyLnRyYWNrLmlzUGFyYW1ldGVySW5Cb3VuZHMoIGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyLnBhcmFtZXRyaWNQb3NpdGlvbiApICkge1xyXG4gICAgICAgIGNvbnN0IGNsb3Nlc3RQb2ludCA9IGNsb3Nlc3RUcmFja0FuZFBvc2l0aW9uQW5kUGFyYW1ldGVyLnBvaW50O1xyXG4gICAgICAgIGNvbnN0IGRpc3RhbmNlID0gY2xvc2VzdFBvaW50LmRpc3RhbmNlKCBwb3NpdGlvbiApO1xyXG4gICAgICAgIGlmICggZGlzdGFuY2UgPCAwLjUgKSB7XHJcbiAgICAgICAgICBwb3NpdGlvbiA9IGNsb3Nlc3RQb2ludDtcclxuICAgICAgICAgIHRhcmdldFRyYWNrID0gY2xvc2VzdFRyYWNrQW5kUG9zaXRpb25BbmRQYXJhbWV0ZXIudHJhY2s7XHJcbiAgICAgICAgICB0YXJnZXRVID0gY2xvc2VzdFRyYWNrQW5kUG9zaXRpb25BbmRQYXJhbWV0ZXIucGFyYW1ldHJpY1Bvc2l0aW9uO1xyXG5cclxuICAgICAgICAgIC8vIENob29zZSB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgdHJhY2ssIGkuZS4gdGhlIHNpZGUgb2YgdGhlIHRyYWNrIHRoYXQgd291bGQgaGF2ZSB0aGUgc2thdGVyIHVwc2lkZSB1cFxyXG4gICAgICAgICAgY29uc3Qgbm9ybWFsID0gdGFyZ2V0VHJhY2suZ2V0VW5pdE5vcm1hbFZlY3RvciggdGFyZ2V0VSApO1xyXG4gICAgICAgICAgc2thdGVyLm9uVG9wU2lkZU9mVHJhY2tQcm9wZXJ0eS52YWx1ZSA9IG5vcm1hbC55ID4gMDtcclxuXHJcbiAgICAgICAgICBza2F0ZXIuYW5nbGVQcm9wZXJ0eS52YWx1ZSA9IHRhcmdldFRyYWNrLmdldFZpZXdBbmdsZUF0KCB0YXJnZXRVICkgKyAoIHNrYXRlci5vblRvcFNpZGVPZlRyYWNrUHJvcGVydHkudmFsdWUgPyAwIDogTWF0aC5QSSApO1xyXG5cclxuICAgICAgICAgIGNsb3NlRW5vdWdoID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCAhY2xvc2VFbm91Z2ggKSB7XHJcbiAgICAgICAgdGFyZ2V0VHJhY2sgPSBudWxsO1xyXG4gICAgICAgIHRhcmdldFUgPSBudWxsO1xyXG5cclxuICAgICAgICAvLyBtYWtlIHNrYXRlciB1cHJpZ2h0IGlmIG5vdCBuZWFyIHRoZSB0cmFja1xyXG4gICAgICAgIHNrYXRlci5hbmdsZVByb3BlcnR5LnZhbHVlID0gMDtcclxuICAgICAgICBza2F0ZXIub25Ub3BTaWRlT2ZUcmFja1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgc2thdGVyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBwb3NpdGlvbjtcclxuICAgICAgfVxyXG5cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgc2thdGVyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSB0YXJnZXRUcmFjay5nZXRQb2ludCggdGFyZ2V0VSApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBza2F0ZXIudXBkYXRlRW5lcmd5KCk7XHJcbiAgICAgIHNrYXRlci51cGRhdGVkRW1pdHRlci5lbWl0KCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gZm9yIGludGVycnVwdGlvbiwgc2VlIGludGVycnVwdERyYWdcclxuICAgIHRoaXMuZHJhZ0hhbmRsZXIgPSBuZXcgRHJhZ0xpc3RlbmVyKCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RyYWdMaXN0ZW5lcicgKSxcclxuICAgICAgc3RhcnQ6IGV2ZW50ID0+IHtcclxuICAgICAgICB1c2VyQ29udHJvbGxlZFByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG4gICAgICAgIHNrYXRlci5kcmFnZ2luZ1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgLy8gQ2xlYXIgdGhlcm1hbCBlbmVyZ3kgd2hlbmV2ZXIgc2thdGVyIGlzIGdyYWJiZWQsIHNlZSAjMzJcclxuICAgICAgICBza2F0ZXIudGhlcm1hbEVuZXJneVByb3BlcnR5LnZhbHVlID0gMDtcclxuXHJcbiAgICAgICAgLy8gSnVtcCB0byB0aGUgaW5wdXQgcG9zaXRpb24gd2hlbiBkcmFnZ2VkXHJcbiAgICAgICAgZHJhZ1NrYXRlciggZXZlbnQgKTtcclxuICAgICAgfSxcclxuXHJcbiAgICAgIGRyYWc6IGRyYWdTa2F0ZXIsXHJcblxyXG4gICAgICBlbmQ6ICgpID0+IHtcclxuXHJcbiAgICAgICAgLy8gUmVjb3JkIHRoZSBzdGF0ZSBvZiB0aGUgc2thdGVyIGZvciBcInJldHVybiBza2F0ZXJcIlxyXG4gICAgICAgIHNrYXRlci5yZWxlYXNlZCggdGFyZ2V0VHJhY2ssIHRhcmdldFUgKTtcclxuXHJcbiAgICAgICAgdXNlckNvbnRyb2xsZWRQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggdGhpcy5kcmFnSGFuZGxlciApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSWYgZHJhZ2dpbmcsIGludGVycnVwdCBhbmQgcmVsZWFzZSB0aGUgU2thdGVyLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBpbnRlcnJ1cHREcmFnKCkge1xyXG4gICAgaWYgKCB0aGlzLmRyYWdIYW5kbGVyLmlzUHJlc3NlZCApIHtcclxuICAgICAgdGhpcy5kcmFnSGFuZGxlci5pbnRlcnJ1cHQoKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmVuZXJneVNrYXRlUGFyay5yZWdpc3RlciggJ1NrYXRlck5vZGUnLCBTa2F0ZXJOb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IFNrYXRlck5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLGNBQWMsTUFBTSxzQ0FBc0M7QUFDakUsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxTQUFTQyxNQUFNLEVBQUVDLFlBQVksRUFBRUMsS0FBSyxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQ3JGLE9BQU9DLHFCQUFxQixNQUFNLDBDQUEwQztBQUM1RSxPQUFPQyxzQkFBc0IsTUFBTSwyQ0FBMkM7QUFDOUUsT0FBT0MsZUFBZSxNQUFNLDBCQUEwQjtBQUN0RCxPQUFPQyxNQUFNLE1BQU0sb0JBQW9CO0FBQ3ZDLE9BQU9DLFlBQVksTUFBTSxtQkFBbUI7QUFFNUMsTUFBTUMsVUFBVSxTQUFTTixJQUFJLENB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