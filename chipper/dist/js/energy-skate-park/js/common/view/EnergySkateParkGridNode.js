// Copyright 2013-2022, University of Colorado Boulder

/**
 * Scenery node that shows the grid lines and labels, when enabled in the control panel.
 * Every other horizontal line is labeled and highlighted to make it easy to count.
 *
 * The grid will translate with the potential energy reference line, so that "0" line always aligns with
 * 0 potential energy.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import GridNode from '../../../../griddle/js/GridNode.js';
import { Node } from '../../../../scenery/js/imports.js';
import energySkatePark from '../../energySkatePark.js';
import EnergySkateParkStrings from '../../EnergySkateParkStrings.js';
import TextPanel from './TextPanel.js';
class EnergySkateParkGridNode extends Node {
  /**
   * @param {Property.<boolean>} gridVisibleProperty the axon property indicating whether the grid should be visible
   * @param {NumberProperty} referenceHeightProperty - Property in meters for height of zero potential energy
   * @param {Property.<Bounds2>} visibleBoundsProperty - visible bounds, in view coordinates
   * @param {ModelViewTransform2} modelViewTransform the main model-view transform
   * @param {Tandem} tandem
   */
  constructor(gridVisibleProperty, referenceHeightProperty, visibleBoundsProperty, modelViewTransform, tandem) {
    super({
      pickable: false,
      tandem: tandem
    });
    const visibleBounds = visibleBoundsProperty.get();
    const gridNode = new GridNode(visibleBounds.width, visibleBounds.height, {
      minorVerticalLineSpacing: modelViewTransform.modelToViewDeltaX(1),
      minorHorizontalLineSpacing: Math.abs(modelViewTransform.modelToViewDeltaY(1)),
      majorHorizontalLineSpacing: Math.abs(modelViewTransform.modelToViewDeltaY(2)),
      majorLineOptions: {
        stroke: '#686868',
        lineWidth: 1.8
      },
      minorLineOptions: {
        stroke: '#686868',
        lineWidth: 0.8
      }
    });
    this.addChild(gridNode);

    // @private
    this.referenceHeightProperty = referenceHeightProperty;
    this.modelViewTransform = modelViewTransform;
    this.gridNode = gridNode;

    // @private {number} - persistent positions for labels that don't depend on reference height or layout
    this.labelXPosition = this.modelViewTransform.modelToViewX(-5);

    // @private {TextPanel} - a unique label for the zero meter reference height position
    this.zeroMeterLabel = new TextPanel(EnergySkateParkStrings.heightLabels.zeroMStringProperty, {
      bottom: this.modelViewTransform.modelToViewY(0) - 2,
      right: this.labelXPosition - 2
    });
    this.addChild(this.zeroMeterLabel);

    // @private - keep references to all text created so that they can be disposed and removed from scene graph
    // when layout changes
    this.createdTextPanels = [];

    // redraw grid and reposition labels with reference height
    referenceHeightProperty.lazyLink((height, oldHeight) => {
      const viewDelta = modelViewTransform.modelToViewDeltaY(height - oldHeight);
      this.zeroMeterLabel.translate(0, viewDelta);
      this.layout(visibleBoundsProperty.get());
    });
    visibleBoundsProperty.link(bounds => this.layout(bounds));
    gridVisibleProperty.linkAttribute(this, 'visible');
  }

  /**
   * Redraw the grid so that grid lines fall exactly on the meter relative to the model origin (center of ground),
   * and grid lines fill the entire screen above ground. Labels are also added relative to model coordinates.
   *
   * Perhaps it will improve performance too? Could performance optimize by using visible instead of add/remove child
   * if necessary (would only change performance on screen size change). For more performance improvements on screen size change,
   * only update when the graph is visible, then again when it becomes visible.
   * @private
   *
   * @param {Bounds2} bounds - visible bounds, in view coordinates
   */
  layout(bounds) {
    const referenceHeight = this.referenceHeightProperty.get();
    const viewReferenceHeight = this.modelViewTransform.modelToViewDeltaX(referenceHeight);

    // find the left position and width such that the meter lines will fall exactly on the meter
    const modelLeft = this.modelViewTransform.viewToModelX(bounds.left);
    const roundedModelLeft = Math.floor(modelLeft);
    const modelWidthDifference = modelLeft - roundedModelLeft;
    const viewWidthDifference = this.modelViewTransform.modelToViewDeltaX(modelWidthDifference);
    this.gridNode.setGridWidth(bounds.width + viewWidthDifference);

    // find the top position and height so that lines will fall exactly on the meter AND major grid lines
    // will fall on even meters
    const modelTop = this.modelViewTransform.viewToModelY(bounds.top);
    let roundedModelTop = Math.ceil(modelTop);
    if (roundedModelTop % 2 !== 0) {
      roundedModelTop++;
    }
    const modelHeightDifference = modelTop - roundedModelTop;
    const viewHeightDifference = this.modelViewTransform.modelToViewDeltaY(modelHeightDifference);
    this.gridNode.setGridHeight(bounds.height + viewHeightDifference + viewReferenceHeight);
    this.gridNode.left = this.modelViewTransform.modelToViewX(roundedModelLeft);
    this.gridNode.top = this.modelViewTransform.modelToViewY(roundedModelTop) - viewReferenceHeight;

    // detach and destroy old labels
    for (let k = 0; k < this.createdTextPanels.length; k++) {
      this.createdTextPanels[k].dispose();
    }
    this.createdTextPanels.length = 0;

    // create and add new labels along the grid
    const roundedModelHeight = -Math.floor(this.modelViewTransform.viewToModelDeltaY(bounds.height));
    const roundedReferenceHeight = Math.floor(referenceHeight);
    for (let y = -roundedReferenceHeight; y < roundedModelHeight - referenceHeight; y++) {
      const viewY = this.modelViewTransform.modelToViewY(y) - viewReferenceHeight;

      // only major grid lines are labeled, and 0 meters has a unique label
      if (y % 2 === 0 && y !== 0) {
        const gridLineLabel = new TextPanel(`${y}`, {
          bottom: viewY - 2,
          right: this.labelXPosition - 2
        });
        gridLineLabel.touchArea = gridLineLabel.localBounds;
        this.addChild(gridLineLabel);

        // so that we can dispose them before next layout
        this.createdTextPanels.push(gridLineLabel);
      }
    }
  }
}
energySkatePark.register('EnergySkateParkGridNode', EnergySkateParkGridNode);
export default EnergySkateParkGridNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJHcmlkTm9kZSIsIk5vZGUiLCJlbmVyZ3lTa2F0ZVBhcmsiLCJFbmVyZ3lTa2F0ZVBhcmtTdHJpbmdzIiwiVGV4dFBhbmVsIiwiRW5lcmd5U2thdGVQYXJrR3JpZE5vZGUiLCJjb25zdHJ1Y3RvciIsImdyaWRWaXNpYmxlUHJvcGVydHkiLCJyZWZlcmVuY2VIZWlnaHRQcm9wZXJ0eSIsInZpc2libGVCb3VuZHNQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsInRhbmRlbSIsInBpY2thYmxlIiwidmlzaWJsZUJvdW5kcyIsImdldCIsImdyaWROb2RlIiwid2lkdGgiLCJoZWlnaHQiLCJtaW5vclZlcnRpY2FsTGluZVNwYWNpbmciLCJtb2RlbFRvVmlld0RlbHRhWCIsIm1pbm9ySG9yaXpvbnRhbExpbmVTcGFjaW5nIiwiTWF0aCIsImFicyIsIm1vZGVsVG9WaWV3RGVsdGFZIiwibWFqb3JIb3Jpem9udGFsTGluZVNwYWNpbmciLCJtYWpvckxpbmVPcHRpb25zIiwic3Ryb2tlIiwibGluZVdpZHRoIiwibWlub3JMaW5lT3B0aW9ucyIsImFkZENoaWxkIiwibGFiZWxYUG9zaXRpb24iLCJtb2RlbFRvVmlld1giLCJ6ZXJvTWV0ZXJMYWJlbCIsImhlaWdodExhYmVscyIsInplcm9NU3RyaW5nUHJvcGVydHkiLCJib3R0b20iLCJtb2RlbFRvVmlld1kiLCJyaWdodCIsImNyZWF0ZWRUZXh0UGFuZWxzIiwibGF6eUxpbmsiLCJvbGRIZWlnaHQiLCJ2aWV3RGVsdGEiLCJ0cmFuc2xhdGUiLCJsYXlvdXQiLCJsaW5rIiwiYm91bmRzIiwibGlua0F0dHJpYnV0ZSIsInJlZmVyZW5jZUhlaWdodCIsInZpZXdSZWZlcmVuY2VIZWlnaHQiLCJtb2RlbExlZnQiLCJ2aWV3VG9Nb2RlbFgiLCJsZWZ0Iiwicm91bmRlZE1vZGVsTGVmdCIsImZsb29yIiwibW9kZWxXaWR0aERpZmZlcmVuY2UiLCJ2aWV3V2lkdGhEaWZmZXJlbmNlIiwic2V0R3JpZFdpZHRoIiwibW9kZWxUb3AiLCJ2aWV3VG9Nb2RlbFkiLCJ0b3AiLCJyb3VuZGVkTW9kZWxUb3AiLCJjZWlsIiwibW9kZWxIZWlnaHREaWZmZXJlbmNlIiwidmlld0hlaWdodERpZmZlcmVuY2UiLCJzZXRHcmlkSGVpZ2h0IiwiayIsImxlbmd0aCIsImRpc3Bvc2UiLCJyb3VuZGVkTW9kZWxIZWlnaHQiLCJ2aWV3VG9Nb2RlbERlbHRhWSIsInJvdW5kZWRSZWZlcmVuY2VIZWlnaHQiLCJ5Iiwidmlld1kiLCJncmlkTGluZUxhYmVsIiwidG91Y2hBcmVhIiwibG9jYWxCb3VuZHMiLCJwdXNoIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFbmVyZ3lTa2F0ZVBhcmtHcmlkTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTY2VuZXJ5IG5vZGUgdGhhdCBzaG93cyB0aGUgZ3JpZCBsaW5lcyBhbmQgbGFiZWxzLCB3aGVuIGVuYWJsZWQgaW4gdGhlIGNvbnRyb2wgcGFuZWwuXHJcbiAqIEV2ZXJ5IG90aGVyIGhvcml6b250YWwgbGluZSBpcyBsYWJlbGVkIGFuZCBoaWdobGlnaHRlZCB0byBtYWtlIGl0IGVhc3kgdG8gY291bnQuXHJcbiAqXHJcbiAqIFRoZSBncmlkIHdpbGwgdHJhbnNsYXRlIHdpdGggdGhlIHBvdGVudGlhbCBlbmVyZ3kgcmVmZXJlbmNlIGxpbmUsIHNvIHRoYXQgXCIwXCIgbGluZSBhbHdheXMgYWxpZ25zIHdpdGhcclxuICogMCBwb3RlbnRpYWwgZW5lcmd5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgR3JpZE5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vZ3JpZGRsZS9qcy9HcmlkTm9kZS5qcyc7XHJcbmltcG9ydCB7IE5vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgZW5lcmd5U2thdGVQYXJrIGZyb20gJy4uLy4uL2VuZXJneVNrYXRlUGFyay5qcyc7XHJcbmltcG9ydCBFbmVyZ3lTa2F0ZVBhcmtTdHJpbmdzIGZyb20gJy4uLy4uL0VuZXJneVNrYXRlUGFya1N0cmluZ3MuanMnO1xyXG5pbXBvcnQgVGV4dFBhbmVsIGZyb20gJy4vVGV4dFBhbmVsLmpzJztcclxuXHJcbmNsYXNzIEVuZXJneVNrYXRlUGFya0dyaWROb2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPGJvb2xlYW4+fSBncmlkVmlzaWJsZVByb3BlcnR5IHRoZSBheG9uIHByb3BlcnR5IGluZGljYXRpbmcgd2hldGhlciB0aGUgZ3JpZCBzaG91bGQgYmUgdmlzaWJsZVxyXG4gICAqIEBwYXJhbSB7TnVtYmVyUHJvcGVydHl9IHJlZmVyZW5jZUhlaWdodFByb3BlcnR5IC0gUHJvcGVydHkgaW4gbWV0ZXJzIGZvciBoZWlnaHQgb2YgemVybyBwb3RlbnRpYWwgZW5lcmd5XHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48Qm91bmRzMj59IHZpc2libGVCb3VuZHNQcm9wZXJ0eSAtIHZpc2libGUgYm91bmRzLCBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm0gdGhlIG1haW4gbW9kZWwtdmlldyB0cmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGdyaWRWaXNpYmxlUHJvcGVydHksIHJlZmVyZW5jZUhlaWdodFByb3BlcnR5LCB2aXNpYmxlQm91bmRzUHJvcGVydHksIG1vZGVsVmlld1RyYW5zZm9ybSwgdGFuZGVtICkge1xyXG4gICAgc3VwZXIoIHtcclxuICAgICAgcGlja2FibGU6IGZhbHNlLFxyXG4gICAgICB0YW5kZW06IHRhbmRlbVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHZpc2libGVCb3VuZHMgPSB2aXNpYmxlQm91bmRzUHJvcGVydHkuZ2V0KCk7XHJcbiAgICBjb25zdCBncmlkTm9kZSA9IG5ldyBHcmlkTm9kZSggdmlzaWJsZUJvdW5kcy53aWR0aCwgdmlzaWJsZUJvdW5kcy5oZWlnaHQsIHtcclxuICAgICAgbWlub3JWZXJ0aWNhbExpbmVTcGFjaW5nOiBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIDEgKSxcclxuICAgICAgbWlub3JIb3Jpem9udGFsTGluZVNwYWNpbmc6IE1hdGguYWJzKCBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIDEgKSApLFxyXG4gICAgICBtYWpvckhvcml6b250YWxMaW5lU3BhY2luZzogTWF0aC5hYnMoIG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWSggMiApICksXHJcbiAgICAgIG1ham9yTGluZU9wdGlvbnM6IHtcclxuICAgICAgICBzdHJva2U6ICcjNjg2ODY4JyxcclxuICAgICAgICBsaW5lV2lkdGg6IDEuOFxyXG4gICAgICB9LFxyXG4gICAgICBtaW5vckxpbmVPcHRpb25zOiB7XHJcbiAgICAgICAgc3Ryb2tlOiAnIzY4Njg2OCcsXHJcbiAgICAgICAgbGluZVdpZHRoOiAwLjhcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggZ3JpZE5vZGUgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5yZWZlcmVuY2VIZWlnaHRQcm9wZXJ0eSA9IHJlZmVyZW5jZUhlaWdodFByb3BlcnR5O1xyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBtb2RlbFZpZXdUcmFuc2Zvcm07XHJcbiAgICB0aGlzLmdyaWROb2RlID0gZ3JpZE5vZGU7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge251bWJlcn0gLSBwZXJzaXN0ZW50IHBvc2l0aW9ucyBmb3IgbGFiZWxzIHRoYXQgZG9uJ3QgZGVwZW5kIG9uIHJlZmVyZW5jZSBoZWlnaHQgb3IgbGF5b3V0XHJcbiAgICB0aGlzLmxhYmVsWFBvc2l0aW9uID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYKCAtNSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtUZXh0UGFuZWx9IC0gYSB1bmlxdWUgbGFiZWwgZm9yIHRoZSB6ZXJvIG1ldGVyIHJlZmVyZW5jZSBoZWlnaHQgcG9zaXRpb25cclxuICAgIHRoaXMuemVyb01ldGVyTGFiZWwgPSBuZXcgVGV4dFBhbmVsKCBFbmVyZ3lTa2F0ZVBhcmtTdHJpbmdzLmhlaWdodExhYmVscy56ZXJvTVN0cmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgIGJvdHRvbTogdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCAwICkgLSAyLFxyXG4gICAgICByaWdodDogdGhpcy5sYWJlbFhQb3NpdGlvbiAtIDJcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHRoaXMuemVyb01ldGVyTGFiZWwgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIGtlZXAgcmVmZXJlbmNlcyB0byBhbGwgdGV4dCBjcmVhdGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgZGlzcG9zZWQgYW5kIHJlbW92ZWQgZnJvbSBzY2VuZSBncmFwaFxyXG4gICAgLy8gd2hlbiBsYXlvdXQgY2hhbmdlc1xyXG4gICAgdGhpcy5jcmVhdGVkVGV4dFBhbmVscyA9IFtdO1xyXG5cclxuICAgIC8vIHJlZHJhdyBncmlkIGFuZCByZXBvc2l0aW9uIGxhYmVscyB3aXRoIHJlZmVyZW5jZSBoZWlnaHRcclxuICAgIHJlZmVyZW5jZUhlaWdodFByb3BlcnR5LmxhenlMaW5rKCAoIGhlaWdodCwgb2xkSGVpZ2h0ICkgPT4ge1xyXG4gICAgICBjb25zdCB2aWV3RGVsdGEgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIGhlaWdodCAtIG9sZEhlaWdodCApO1xyXG5cclxuICAgICAgdGhpcy56ZXJvTWV0ZXJMYWJlbC50cmFuc2xhdGUoIDAsIHZpZXdEZWx0YSApO1xyXG4gICAgICB0aGlzLmxheW91dCggdmlzaWJsZUJvdW5kc1Byb3BlcnR5LmdldCgpICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdmlzaWJsZUJvdW5kc1Byb3BlcnR5LmxpbmsoIGJvdW5kcyA9PiB0aGlzLmxheW91dCggYm91bmRzICkgKTtcclxuICAgIGdyaWRWaXNpYmxlUHJvcGVydHkubGlua0F0dHJpYnV0ZSggdGhpcywgJ3Zpc2libGUnICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZWRyYXcgdGhlIGdyaWQgc28gdGhhdCBncmlkIGxpbmVzIGZhbGwgZXhhY3RseSBvbiB0aGUgbWV0ZXIgcmVsYXRpdmUgdG8gdGhlIG1vZGVsIG9yaWdpbiAoY2VudGVyIG9mIGdyb3VuZCksXHJcbiAgICogYW5kIGdyaWQgbGluZXMgZmlsbCB0aGUgZW50aXJlIHNjcmVlbiBhYm92ZSBncm91bmQuIExhYmVscyBhcmUgYWxzbyBhZGRlZCByZWxhdGl2ZSB0byBtb2RlbCBjb29yZGluYXRlcy5cclxuICAgKlxyXG4gICAqIFBlcmhhcHMgaXQgd2lsbCBpbXByb3ZlIHBlcmZvcm1hbmNlIHRvbz8gQ291bGQgcGVyZm9ybWFuY2Ugb3B0aW1pemUgYnkgdXNpbmcgdmlzaWJsZSBpbnN0ZWFkIG9mIGFkZC9yZW1vdmUgY2hpbGRcclxuICAgKiBpZiBuZWNlc3NhcnkgKHdvdWxkIG9ubHkgY2hhbmdlIHBlcmZvcm1hbmNlIG9uIHNjcmVlbiBzaXplIGNoYW5nZSkuIEZvciBtb3JlIHBlcmZvcm1hbmNlIGltcHJvdmVtZW50cyBvbiBzY3JlZW4gc2l6ZSBjaGFuZ2UsXHJcbiAgICogb25seSB1cGRhdGUgd2hlbiB0aGUgZ3JhcGggaXMgdmlzaWJsZSwgdGhlbiBhZ2FpbiB3aGVuIGl0IGJlY29tZXMgdmlzaWJsZS5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtCb3VuZHMyfSBib3VuZHMgLSB2aXNpYmxlIGJvdW5kcywgaW4gdmlldyBjb29yZGluYXRlc1xyXG4gICAqL1xyXG4gIGxheW91dCggYm91bmRzICkge1xyXG4gICAgY29uc3QgcmVmZXJlbmNlSGVpZ2h0ID0gdGhpcy5yZWZlcmVuY2VIZWlnaHRQcm9wZXJ0eS5nZXQoKTtcclxuICAgIGNvbnN0IHZpZXdSZWZlcmVuY2VIZWlnaHQgPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWCggcmVmZXJlbmNlSGVpZ2h0ICk7XHJcblxyXG4gICAgLy8gZmluZCB0aGUgbGVmdCBwb3NpdGlvbiBhbmQgd2lkdGggc3VjaCB0aGF0IHRoZSBtZXRlciBsaW5lcyB3aWxsIGZhbGwgZXhhY3RseSBvbiB0aGUgbWV0ZXJcclxuICAgIGNvbnN0IG1vZGVsTGVmdCA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsWCggYm91bmRzLmxlZnQgKTtcclxuICAgIGNvbnN0IHJvdW5kZWRNb2RlbExlZnQgPSBNYXRoLmZsb29yKCBtb2RlbExlZnQgKTtcclxuICAgIGNvbnN0IG1vZGVsV2lkdGhEaWZmZXJlbmNlID0gbW9kZWxMZWZ0IC0gcm91bmRlZE1vZGVsTGVmdDtcclxuICAgIGNvbnN0IHZpZXdXaWR0aERpZmZlcmVuY2UgPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWCggbW9kZWxXaWR0aERpZmZlcmVuY2UgKTtcclxuICAgIHRoaXMuZ3JpZE5vZGUuc2V0R3JpZFdpZHRoKCBib3VuZHMud2lkdGggKyB2aWV3V2lkdGhEaWZmZXJlbmNlICk7XHJcblxyXG4gICAgLy8gZmluZCB0aGUgdG9wIHBvc2l0aW9uIGFuZCBoZWlnaHQgc28gdGhhdCBsaW5lcyB3aWxsIGZhbGwgZXhhY3RseSBvbiB0aGUgbWV0ZXIgQU5EIG1ham9yIGdyaWQgbGluZXNcclxuICAgIC8vIHdpbGwgZmFsbCBvbiBldmVuIG1ldGVyc1xyXG4gICAgY29uc3QgbW9kZWxUb3AgPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbFkoIGJvdW5kcy50b3AgKTtcclxuICAgIGxldCByb3VuZGVkTW9kZWxUb3AgPSBNYXRoLmNlaWwoIG1vZGVsVG9wICk7XHJcblxyXG4gICAgaWYgKCByb3VuZGVkTW9kZWxUb3AgJSAyICE9PSAwICkge1xyXG4gICAgICByb3VuZGVkTW9kZWxUb3ArKztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtb2RlbEhlaWdodERpZmZlcmVuY2UgPSBtb2RlbFRvcCAtIHJvdW5kZWRNb2RlbFRvcDtcclxuICAgIGNvbnN0IHZpZXdIZWlnaHREaWZmZXJlbmNlID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIG1vZGVsSGVpZ2h0RGlmZmVyZW5jZSApO1xyXG4gICAgdGhpcy5ncmlkTm9kZS5zZXRHcmlkSGVpZ2h0KCBib3VuZHMuaGVpZ2h0ICsgdmlld0hlaWdodERpZmZlcmVuY2UgKyB2aWV3UmVmZXJlbmNlSGVpZ2h0ICk7XHJcblxyXG4gICAgdGhpcy5ncmlkTm9kZS5sZWZ0ID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYKCByb3VuZGVkTW9kZWxMZWZ0ICk7XHJcbiAgICB0aGlzLmdyaWROb2RlLnRvcCA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WSggcm91bmRlZE1vZGVsVG9wICkgLSB2aWV3UmVmZXJlbmNlSGVpZ2h0O1xyXG5cclxuICAgIC8vIGRldGFjaCBhbmQgZGVzdHJveSBvbGQgbGFiZWxzXHJcbiAgICBmb3IgKCBsZXQgayA9IDA7IGsgPCB0aGlzLmNyZWF0ZWRUZXh0UGFuZWxzLmxlbmd0aDsgaysrICkge1xyXG4gICAgICB0aGlzLmNyZWF0ZWRUZXh0UGFuZWxzWyBrIF0uZGlzcG9zZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jcmVhdGVkVGV4dFBhbmVscy5sZW5ndGggPSAwO1xyXG5cclxuICAgIC8vIGNyZWF0ZSBhbmQgYWRkIG5ldyBsYWJlbHMgYWxvbmcgdGhlIGdyaWRcclxuICAgIGNvbnN0IHJvdW5kZWRNb2RlbEhlaWdodCA9IC1NYXRoLmZsb29yKCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbERlbHRhWSggYm91bmRzLmhlaWdodCApICk7XHJcbiAgICBjb25zdCByb3VuZGVkUmVmZXJlbmNlSGVpZ2h0ID0gTWF0aC5mbG9vciggcmVmZXJlbmNlSGVpZ2h0ICk7XHJcbiAgICBmb3IgKCBsZXQgeSA9IC1yb3VuZGVkUmVmZXJlbmNlSGVpZ2h0OyB5IDwgcm91bmRlZE1vZGVsSGVpZ2h0IC0gcmVmZXJlbmNlSGVpZ2h0OyB5KysgKSB7XHJcbiAgICAgIGNvbnN0IHZpZXdZID0gdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCB5ICkgLSB2aWV3UmVmZXJlbmNlSGVpZ2h0O1xyXG5cclxuICAgICAgLy8gb25seSBtYWpvciBncmlkIGxpbmVzIGFyZSBsYWJlbGVkLCBhbmQgMCBtZXRlcnMgaGFzIGEgdW5pcXVlIGxhYmVsXHJcbiAgICAgIGlmICggeSAlIDIgPT09IDAgJiYgeSAhPT0gMCApIHtcclxuICAgICAgICBjb25zdCBncmlkTGluZUxhYmVsID0gbmV3IFRleHRQYW5lbCggYCR7eX1gLCB7XHJcbiAgICAgICAgICBib3R0b206IHZpZXdZIC0gMixcclxuICAgICAgICAgIHJpZ2h0OiB0aGlzLmxhYmVsWFBvc2l0aW9uIC0gMlxyXG4gICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgZ3JpZExpbmVMYWJlbC50b3VjaEFyZWEgPSBncmlkTGluZUxhYmVsLmxvY2FsQm91bmRzO1xyXG4gICAgICAgIHRoaXMuYWRkQ2hpbGQoIGdyaWRMaW5lTGFiZWwgKTtcclxuXHJcbiAgICAgICAgLy8gc28gdGhhdCB3ZSBjYW4gZGlzcG9zZSB0aGVtIGJlZm9yZSBuZXh0IGxheW91dFxyXG4gICAgICAgIHRoaXMuY3JlYXRlZFRleHRQYW5lbHMucHVzaCggZ3JpZExpbmVMYWJlbCApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5lbmVyZ3lTa2F0ZVBhcmsucmVnaXN0ZXIoICdFbmVyZ3lTa2F0ZVBhcmtHcmlkTm9kZScsIEVuZXJneVNrYXRlUGFya0dyaWROb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IEVuZXJneVNrYXRlUGFya0dyaWROb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsUUFBUSxNQUFNLG9DQUFvQztBQUN6RCxTQUFTQyxJQUFJLFFBQVEsbUNBQW1DO0FBQ3hELE9BQU9DLGVBQWUsTUFBTSwwQkFBMEI7QUFDdEQsT0FBT0Msc0JBQXNCLE1BQU0saUNBQWlDO0FBQ3BFLE9BQU9DLFNBQVMsTUFBTSxnQkFBZ0I7QUFFdEMsTUFBTUMsdUJBQXVCLFNBQVNKLElBQUksQ0FBQztFQUV6QztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFSyxXQUFXQSxDQUFFQyxtQkFBbUIsRUFBRUMsdUJBQXVCLEVBQUVDLHFCQUFxQixFQUFFQyxrQkFBa0IsRUFBRUMsTUFBTSxFQUFHO0lBQzdHLEtBQUssQ0FBRTtNQUNMQyxRQUFRLEVBQUUsS0FBSztNQUNmRCxNQUFNLEVBQUVBO0lBQ1YsQ0FBRSxDQUFDO0lBRUgsTUFBTUUsYUFBYSxHQUFHSixxQkFBcUIsQ0FBQ0ssR0FBRyxDQUFDLENBQUM7SUFDakQsTUFBTUMsUUFBUSxHQUFHLElBQUlmLFFBQVEsQ0FBRWEsYUFBYSxDQUFDRyxLQUFLLEVBQUVILGFBQWEsQ0FBQ0ksTUFBTSxFQUFFO01BQ3hFQyx3QkFBd0IsRUFBRVIsa0JBQWtCLENBQUNTLGlCQUFpQixDQUFFLENBQUUsQ0FBQztNQUNuRUMsMEJBQTBCLEVBQUVDLElBQUksQ0FBQ0MsR0FBRyxDQUFFWixrQkFBa0IsQ0FBQ2EsaUJBQWlCLENBQUUsQ0FBRSxDQUFFLENBQUM7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