// Copyright 2014-2023, University of Colorado Boulder

/**
 * The drag handler for moving the body of a track (not a control point).
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import { DragListener } from '../../../../scenery/js/imports.js';
import energySkatePark from '../../energySkatePark.js';
import EnergySkateParkQueryParameters from '../EnergySkateParkQueryParameters.js';
class TrackDragHandler extends DragListener {
  /**
   * @param {TrackNode} trackNode the track node that this listener will drag
   * @param {Tandem} tandem
   */
  constructor(trackNode, tandem) {
    // Drag handler for dragging the track segment itself (not one of the control points)
    // Its bounds are determined by the shape of the track, so it cannot go below ground.
    // And so it can be dragged out of the toolbox but not back into it (so it won't be dragged below ground)
    super({
      tandem: tandem.createTandem('dragListener'),
      allowTouchSnag: true,
      start: event => this.handleDragStart(event),
      drag: event => this.handleDrag(event),
      end: event => this.handleDragEnd(event)
    });
    this.trackNode = trackNode;
    this.track = trackNode.track;
    this.model = trackNode.model;
    this.modelViewTransform = trackNode.modelViewTransform;
    this.availableBoundsProperty = trackNode.availableBoundsProperty;
    this.startOffset = null;
  }

  /**
   * Start of a drag interaction from an event.
   * @public
   *
   * @param {SceneryEvent} event
   */
  handleDragStart(event) {
    // Move the track to the front when it starts dragging, see #296
    // The track is in a layer of tracks (without other nodes) so moving it to the front will work perfectly
    this.trackNode.moveToFront();
    this.calculateStartOffset(event);
  }

  /**
   * Continuation of drag.
   * @private
   *
   * @param {SceneryEvent} event
   */
  handleDrag(event) {
    this.trackDragged(event);
  }

  /**
   * End of a drag interaction.
   * @private
   *
   * @param {SceneryEvent} event
   */
  handleDragEnd(event) {
    this.trackDragEnded(event);
  }

  /**
   * @private
   * @param {Event} event
   */
  trackDragged(event) {
    let snapTargetChanged = false;
    const model = this.model;
    const track = this.track;

    // Check whether the model contains a track so that input listeners for detached elements can't create bugs, see #230
    if (!model.containsTrack(track)) {
      return;
    }
    track.draggingProperty.value = true;
    const parentPoint = this.globalToParentPoint(event.pointer.point).minus(this.startOffset);
    const position = this.modelViewTransform.viewToModelPosition(parentPoint);

    // If the user moved it out of the toolbox above y=0, then make it physically interactive
    const bottomControlPointY = track.getBottomControlPointY();
    if (!track.physicalProperty.value && bottomControlPointY > 0) {
      track.physicalProperty.value = true;
    }

    // When dragging track, make sure the control points don't go below ground, see #71
    const modelDelta = position.minus(track.position);
    const translatedBottomControlPointY = bottomControlPointY + modelDelta.y;
    if (track.physicalProperty.value && translatedBottomControlPointY < 0) {
      position.y += Math.abs(translatedBottomControlPointY);
    }
    if (this.availableBoundsProperty.value) {
      // constrain each point to lie within the available bounds
      const availableBounds = this.availableBoundsProperty.value;

      // Constrain the top
      const topControlPointY = track.getTopControlPointY();
      if (topControlPointY + modelDelta.y > availableBounds.maxY) {
        position.y = availableBounds.maxY - (topControlPointY - track.position.y);
      }

      // Constrain the left side
      const leftControlPointX = track.getLeftControlPointX();
      if (leftControlPointX + modelDelta.x < availableBounds.minX) {
        position.x = availableBounds.minX - (leftControlPointX - track.position.x);
      }

      // Constrain the right side
      const rightControlPointX = track.getRightControlPointX();
      if (rightControlPointX + modelDelta.x > availableBounds.maxX) {
        position.x = availableBounds.maxX - (rightControlPointX - track.position.x);
      }
    }
    track.position = position;

    // If one of the control points is close enough to link to another track, do so
    const tracks = model.getPhysicalTracks();
    let bestDistance = null;
    let myBestPoint = null;
    let otherBestPoint = null;
    const points = [track.controlPoints[0], track.controlPoints[track.controlPoints.length - 1]];
    for (let i = 0; i < tracks.length; i++) {
      const t = tracks[i];
      if (t !== track) {
        // 4 cases 00, 01, 10, 11
        const otherPoints = [t.controlPoints[0], t.controlPoints[t.controlPoints.length - 1]];

        // don't match inner points
        for (let j = 0; j < points.length; j++) {
          const point = points[j];
          for (let k = 0; k < otherPoints.length; k++) {
            const otherPoint = otherPoints[k];
            const distance = point.sourcePositionProperty.value.distance(otherPoint.positionProperty.value);
            if (bestDistance === null && distance > 1E-6 || distance < bestDistance) {
              bestDistance = distance;
              myBestPoint = point;
              otherBestPoint = otherPoint;
            }
          }
        }
      }
    }
    if (bestDistance !== null && bestDistance < 1) {
      if (myBestPoint.snapTargetProperty.value !== otherBestPoint) {
        snapTargetChanged = true;
      }
      myBestPoint.snapTargetProperty.value = otherBestPoint;

      // Set the opposite point to be unsnapped, you can only snap one at a time
      const source = myBestPoint === points[0] ? points[1] : points[0];
      if (source.snapTargetProperty.value !== null) {
        snapTargetChanged = true;
      }
      source.snapTargetProperty.value = null;
    } else {
      if (points[0].snapTargetProperty.value !== null || points[1].snapTargetProperty.value !== null) {
        snapTargetChanged = true;
      }
      points[0].snapTargetProperty.value = null;
      points[1].snapTargetProperty.value = null;
    }

    // It costs about 5fps to do this every frame (on iPad3), so only check if the snapTargets have changed.  See #235
    if (snapTargetChanged) {
      track.updateSplines();
      this.trackNode.updateTrackShape();
    }

    // Make it so the track can't be dragged underground when dragged by the track itself (not control point), see #166
    // But if the user is dragging the track out of the toolbox, then leave the motion continuous, see #178
    if (track.physicalProperty.value) {
      track.bumpAboveGround();
    }
    model.trackModified(track);
  }

  /**
   * @public
   * @param {Event} event
   */
  trackDragEnded(event) {
    const track = this.track;
    const model = this.model;

    // If dropped in the play area, signify that it has been dropped--this will make it so that dragging the control points
    // reshapes the track instead of translating it
    track.droppedProperty.value = true;

    // Check whether the model contains a track so that input listeners for detached elements can't create bugs, see #230
    if (!model.containsTrack(track)) {
      return;
    }

    // track was released underground and was never added to the play area, so remove it
    if (!this.isPressed && !track.physicalProperty.get()) {
      model.removeAndDisposeTrack(track);
    }

    // If the user never dragged the object, then there is no track to drop in this case, see #205
    const myPoints = [track.controlPoints[0], track.controlPoints[track.controlPoints.length - 1]];
    if (myPoints[0].snapTargetProperty.value || myPoints[1].snapTargetProperty.value) {
      model.joinTracks(track); // Track will be joined to compatible track, then both will be disposed, and new track created.
    }

    // If the track hasn't been disposed (see #393), bump it above ground and make it physical if user has started
    // dragging, see #384 and #205
    if (!track.isDisposed && track.controlPoints.filter(point => {
      return !point.isDisposed;
    }).length !== 0) {
      track.bumpAboveGround();
      track.physicalProperty.value = true; // for interactivity, but also for #414
      track.draggingProperty.value = false; // signify that the track shape can be smoothed again
    }

    if (EnergySkateParkQueryParameters.testTrackIndex > 0) {
      console.log(track.getDebugString());
    }
  }

  /**
   * Determine the offset point at the start of a drag so that the track translates with the mouse without jumping.
   * @private
   *
   * @param {SceneryEvent} event
   */
  calculateStartOffset(event) {
    const startingPosition = this.modelViewTransform.modelToViewPosition(this.track.position);
    this.startOffset = event.currentTarget.globalToParentPoint(event.pointer.point).minus(startingPosition);
  }
}
energySkatePark.register('TrackDragHandler', TrackDragHandler);
export default TrackDragHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEcmFnTGlzdGVuZXIiLCJlbmVyZ3lTa2F0ZVBhcmsiLCJFbmVyZ3lTa2F0ZVBhcmtRdWVyeVBhcmFtZXRlcnMiLCJUcmFja0RyYWdIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJ0cmFja05vZGUiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJhbGxvd1RvdWNoU25hZyIsInN0YXJ0IiwiZXZlbnQiLCJoYW5kbGVEcmFnU3RhcnQiLCJkcmFnIiwiaGFuZGxlRHJhZyIsImVuZCIsImhhbmRsZURyYWdFbmQiLCJ0cmFjayIsIm1vZGVsIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwiYXZhaWxhYmxlQm91bmRzUHJvcGVydHkiLCJzdGFydE9mZnNldCIsIm1vdmVUb0Zyb250IiwiY2FsY3VsYXRlU3RhcnRPZmZzZXQiLCJ0cmFja0RyYWdnZWQiLCJ0cmFja0RyYWdFbmRlZCIsInNuYXBUYXJnZXRDaGFuZ2VkIiwiY29udGFpbnNUcmFjayIsImRyYWdnaW5nUHJvcGVydHkiLCJ2YWx1ZSIsInBhcmVudFBvaW50IiwiZ2xvYmFsVG9QYXJlbnRQb2ludCIsInBvaW50ZXIiLCJwb2ludCIsIm1pbnVzIiwicG9zaXRpb24iLCJ2aWV3VG9Nb2RlbFBvc2l0aW9uIiwiYm90dG9tQ29udHJvbFBvaW50WSIsImdldEJvdHRvbUNvbnRyb2xQb2ludFkiLCJwaHlzaWNhbFByb3BlcnR5IiwibW9kZWxEZWx0YSIsInRyYW5zbGF0ZWRCb3R0b21Db250cm9sUG9pbnRZIiwieSIsIk1hdGgiLCJhYnMiLCJhdmFpbGFibGVCb3VuZHMiLCJ0b3BDb250cm9sUG9pbnRZIiwiZ2V0VG9wQ29udHJvbFBvaW50WSIsIm1heFkiLCJsZWZ0Q29udHJvbFBvaW50WCIsImdldExlZnRDb250cm9sUG9pbnRYIiwieCIsIm1pblgiLCJyaWdodENvbnRyb2xQb2ludFgiLCJnZXRSaWdodENvbnRyb2xQb2ludFgiLCJtYXhYIiwidHJhY2tzIiwiZ2V0UGh5c2ljYWxUcmFja3MiLCJiZXN0RGlzdGFuY2UiLCJteUJlc3RQb2ludCIsIm90aGVyQmVzdFBvaW50IiwicG9pbnRzIiwiY29udHJvbFBvaW50cyIsImxlbmd0aCIsImkiLCJ0Iiwib3RoZXJQb2ludHMiLCJqIiwiayIsIm90aGVyUG9pbnQiLCJkaXN0YW5jZSIsInNvdXJjZVBvc2l0aW9uUHJvcGVydHkiLCJwb3NpdGlvblByb3BlcnR5Iiwic25hcFRhcmdldFByb3BlcnR5Iiwic291cmNlIiwidXBkYXRlU3BsaW5lcyIsInVwZGF0ZVRyYWNrU2hhcGUiLCJidW1wQWJvdmVHcm91bmQiLCJ0cmFja01vZGlmaWVkIiwiZHJvcHBlZFByb3BlcnR5IiwiaXNQcmVzc2VkIiwiZ2V0IiwicmVtb3ZlQW5kRGlzcG9zZVRyYWNrIiwibXlQb2ludHMiLCJqb2luVHJhY2tzIiwiaXNEaXNwb3NlZCIsImZpbHRlciIsInRlc3RUcmFja0luZGV4IiwiY29uc29sZSIsImxvZyIsImdldERlYnVnU3RyaW5nIiwic3RhcnRpbmdQb3NpdGlvbiIsIm1vZGVsVG9WaWV3UG9zaXRpb24iLCJjdXJyZW50VGFyZ2V0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJUcmFja0RyYWdIYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoZSBkcmFnIGhhbmRsZXIgZm9yIG1vdmluZyB0aGUgYm9keSBvZiBhIHRyYWNrIChub3QgYSBjb250cm9sIHBvaW50KS5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgeyBEcmFnTGlzdGVuZXIgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgZW5lcmd5U2thdGVQYXJrIGZyb20gJy4uLy4uL2VuZXJneVNrYXRlUGFyay5qcyc7XHJcbmltcG9ydCBFbmVyZ3lTa2F0ZVBhcmtRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vRW5lcmd5U2thdGVQYXJrUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuXHJcbmNsYXNzIFRyYWNrRHJhZ0hhbmRsZXIgZXh0ZW5kcyBEcmFnTGlzdGVuZXIge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1RyYWNrTm9kZX0gdHJhY2tOb2RlIHRoZSB0cmFjayBub2RlIHRoYXQgdGhpcyBsaXN0ZW5lciB3aWxsIGRyYWdcclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHRyYWNrTm9kZSwgdGFuZGVtICkge1xyXG5cclxuICAgIC8vIERyYWcgaGFuZGxlciBmb3IgZHJhZ2dpbmcgdGhlIHRyYWNrIHNlZ21lbnQgaXRzZWxmIChub3Qgb25lIG9mIHRoZSBjb250cm9sIHBvaW50cylcclxuICAgIC8vIEl0cyBib3VuZHMgYXJlIGRldGVybWluZWQgYnkgdGhlIHNoYXBlIG9mIHRoZSB0cmFjaywgc28gaXQgY2Fubm90IGdvIGJlbG93IGdyb3VuZC5cclxuICAgIC8vIEFuZCBzbyBpdCBjYW4gYmUgZHJhZ2dlZCBvdXQgb2YgdGhlIHRvb2xib3ggYnV0IG5vdCBiYWNrIGludG8gaXQgKHNvIGl0IHdvbid0IGJlIGRyYWdnZWQgYmVsb3cgZ3JvdW5kKVxyXG4gICAgc3VwZXIoIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnZHJhZ0xpc3RlbmVyJyApLFxyXG4gICAgICBhbGxvd1RvdWNoU25hZzogdHJ1ZSxcclxuXHJcbiAgICAgIHN0YXJ0OiBldmVudCA9PiB0aGlzLmhhbmRsZURyYWdTdGFydCggZXZlbnQgKSxcclxuICAgICAgZHJhZzogZXZlbnQgPT4gdGhpcy5oYW5kbGVEcmFnKCBldmVudCApLFxyXG4gICAgICBlbmQ6IGV2ZW50ID0+IHRoaXMuaGFuZGxlRHJhZ0VuZCggZXZlbnQgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudHJhY2tOb2RlID0gdHJhY2tOb2RlO1xyXG4gICAgdGhpcy50cmFjayA9IHRyYWNrTm9kZS50cmFjaztcclxuICAgIHRoaXMubW9kZWwgPSB0cmFja05vZGUubW9kZWw7XHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IHRyYWNrTm9kZS5tb2RlbFZpZXdUcmFuc2Zvcm07XHJcbiAgICB0aGlzLmF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5ID0gdHJhY2tOb2RlLmF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5O1xyXG4gICAgdGhpcy5zdGFydE9mZnNldCA9IG51bGw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGFydCBvZiBhIGRyYWcgaW50ZXJhY3Rpb24gZnJvbSBhbiBldmVudC5cclxuICAgKiBAcHVibGljXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1NjZW5lcnlFdmVudH0gZXZlbnRcclxuICAgKi9cclxuICBoYW5kbGVEcmFnU3RhcnQoIGV2ZW50ICkge1xyXG5cclxuICAgIC8vIE1vdmUgdGhlIHRyYWNrIHRvIHRoZSBmcm9udCB3aGVuIGl0IHN0YXJ0cyBkcmFnZ2luZywgc2VlICMyOTZcclxuICAgIC8vIFRoZSB0cmFjayBpcyBpbiBhIGxheWVyIG9mIHRyYWNrcyAod2l0aG91dCBvdGhlciBub2Rlcykgc28gbW92aW5nIGl0IHRvIHRoZSBmcm9udCB3aWxsIHdvcmsgcGVyZmVjdGx5XHJcbiAgICB0aGlzLnRyYWNrTm9kZS5tb3ZlVG9Gcm9udCgpO1xyXG5cclxuICAgIHRoaXMuY2FsY3VsYXRlU3RhcnRPZmZzZXQoIGV2ZW50ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb250aW51YXRpb24gb2YgZHJhZy5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtTY2VuZXJ5RXZlbnR9IGV2ZW50XHJcbiAgICovXHJcbiAgaGFuZGxlRHJhZyggZXZlbnQgKSB7XHJcbiAgICB0aGlzLnRyYWNrRHJhZ2dlZCggZXZlbnQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEVuZCBvZiBhIGRyYWcgaW50ZXJhY3Rpb24uXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U2NlbmVyeUV2ZW50fSBldmVudFxyXG4gICAqL1xyXG4gIGhhbmRsZURyYWdFbmQoIGV2ZW50ICkge1xyXG4gICAgdGhpcy50cmFja0RyYWdFbmRlZCggZXZlbnQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICogQHBhcmFtIHtFdmVudH0gZXZlbnRcclxuICAgKi9cclxuICB0cmFja0RyYWdnZWQoIGV2ZW50ICkge1xyXG4gICAgbGV0IHNuYXBUYXJnZXRDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWw7XHJcbiAgICBjb25zdCB0cmFjayA9IHRoaXMudHJhY2s7XHJcblxyXG4gICAgLy8gQ2hlY2sgd2hldGhlciB0aGUgbW9kZWwgY29udGFpbnMgYSB0cmFjayBzbyB0aGF0IGlucHV0IGxpc3RlbmVycyBmb3IgZGV0YWNoZWQgZWxlbWVudHMgY2FuJ3QgY3JlYXRlIGJ1Z3MsIHNlZSAjMjMwXHJcbiAgICBpZiAoICFtb2RlbC5jb250YWluc1RyYWNrKCB0cmFjayApICkgeyByZXR1cm47IH1cclxuXHJcbiAgICB0cmFjay5kcmFnZ2luZ1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRQb2ludCA9IHRoaXMuZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApLm1pbnVzKCB0aGlzLnN0YXJ0T2Zmc2V0ICk7XHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcblxyXG4gICAgLy8gSWYgdGhlIHVzZXIgbW92ZWQgaXQgb3V0IG9mIHRoZSB0b29sYm94IGFib3ZlIHk9MCwgdGhlbiBtYWtlIGl0IHBoeXNpY2FsbHkgaW50ZXJhY3RpdmVcclxuICAgIGNvbnN0IGJvdHRvbUNvbnRyb2xQb2ludFkgPSB0cmFjay5nZXRCb3R0b21Db250cm9sUG9pbnRZKCk7XHJcbiAgICBpZiAoICF0cmFjay5waHlzaWNhbFByb3BlcnR5LnZhbHVlICYmIGJvdHRvbUNvbnRyb2xQb2ludFkgPiAwICkge1xyXG4gICAgICB0cmFjay5waHlzaWNhbFByb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBXaGVuIGRyYWdnaW5nIHRyYWNrLCBtYWtlIHN1cmUgdGhlIGNvbnRyb2wgcG9pbnRzIGRvbid0IGdvIGJlbG93IGdyb3VuZCwgc2VlICM3MVxyXG4gICAgY29uc3QgbW9kZWxEZWx0YSA9IHBvc2l0aW9uLm1pbnVzKCB0cmFjay5wb3NpdGlvbiApO1xyXG4gICAgY29uc3QgdHJhbnNsYXRlZEJvdHRvbUNvbnRyb2xQb2ludFkgPSBib3R0b21Db250cm9sUG9pbnRZICsgbW9kZWxEZWx0YS55O1xyXG5cclxuICAgIGlmICggdHJhY2sucGh5c2ljYWxQcm9wZXJ0eS52YWx1ZSAmJiB0cmFuc2xhdGVkQm90dG9tQ29udHJvbFBvaW50WSA8IDAgKSB7XHJcbiAgICAgIHBvc2l0aW9uLnkgKz0gTWF0aC5hYnMoIHRyYW5zbGF0ZWRCb3R0b21Db250cm9sUG9pbnRZICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCB0aGlzLmF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5LnZhbHVlICkge1xyXG5cclxuICAgICAgLy8gY29uc3RyYWluIGVhY2ggcG9pbnQgdG8gbGllIHdpdGhpbiB0aGUgYXZhaWxhYmxlIGJvdW5kc1xyXG4gICAgICBjb25zdCBhdmFpbGFibGVCb3VuZHMgPSB0aGlzLmF2YWlsYWJsZUJvdW5kc1Byb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgLy8gQ29uc3RyYWluIHRoZSB0b3BcclxuICAgICAgY29uc3QgdG9wQ29udHJvbFBvaW50WSA9IHRyYWNrLmdldFRvcENvbnRyb2xQb2ludFkoKTtcclxuICAgICAgaWYgKCB0b3BDb250cm9sUG9pbnRZICsgbW9kZWxEZWx0YS55ID4gYXZhaWxhYmxlQm91bmRzLm1heFkgKSB7XHJcbiAgICAgICAgcG9zaXRpb24ueSA9IGF2YWlsYWJsZUJvdW5kcy5tYXhZIC0gKCB0b3BDb250cm9sUG9pbnRZIC0gdHJhY2sucG9zaXRpb24ueSApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBDb25zdHJhaW4gdGhlIGxlZnQgc2lkZVxyXG4gICAgICBjb25zdCBsZWZ0Q29udHJvbFBvaW50WCA9IHRyYWNrLmdldExlZnRDb250cm9sUG9pbnRYKCk7XHJcbiAgICAgIGlmICggbGVmdENvbnRyb2xQb2ludFggKyBtb2RlbERlbHRhLnggPCBhdmFpbGFibGVCb3VuZHMubWluWCApIHtcclxuICAgICAgICBwb3NpdGlvbi54ID0gYXZhaWxhYmxlQm91bmRzLm1pblggLSAoIGxlZnRDb250cm9sUG9pbnRYIC0gdHJhY2sucG9zaXRpb24ueCApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBDb25zdHJhaW4gdGhlIHJpZ2h0IHNpZGVcclxuICAgICAgY29uc3QgcmlnaHRDb250cm9sUG9pbnRYID0gdHJhY2suZ2V0UmlnaHRDb250cm9sUG9pbnRYKCk7XHJcbiAgICAgIGlmICggcmlnaHRDb250cm9sUG9pbnRYICsgbW9kZWxEZWx0YS54ID4gYXZhaWxhYmxlQm91bmRzLm1heFggKSB7XHJcbiAgICAgICAgcG9zaXRpb24ueCA9IGF2YWlsYWJsZUJvdW5kcy5tYXhYIC0gKCByaWdodENvbnRyb2xQb2ludFggLSB0cmFjay5wb3NpdGlvbi54ICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0cmFjay5wb3NpdGlvbiA9IHBvc2l0aW9uO1xyXG5cclxuICAgIC8vIElmIG9uZSBvZiB0aGUgY29udHJvbCBwb2ludHMgaXMgY2xvc2UgZW5vdWdoIHRvIGxpbmsgdG8gYW5vdGhlciB0cmFjaywgZG8gc29cclxuICAgIGNvbnN0IHRyYWNrcyA9IG1vZGVsLmdldFBoeXNpY2FsVHJhY2tzKCk7XHJcblxyXG4gICAgbGV0IGJlc3REaXN0YW5jZSA9IG51bGw7XHJcbiAgICBsZXQgbXlCZXN0UG9pbnQgPSBudWxsO1xyXG4gICAgbGV0IG90aGVyQmVzdFBvaW50ID0gbnVsbDtcclxuXHJcbiAgICBjb25zdCBwb2ludHMgPSBbIHRyYWNrLmNvbnRyb2xQb2ludHNbIDAgXSwgdHJhY2suY29udHJvbFBvaW50c1sgdHJhY2suY29udHJvbFBvaW50cy5sZW5ndGggLSAxIF0gXTtcclxuXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0cmFja3MubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IHQgPSB0cmFja3NbIGkgXTtcclxuICAgICAgaWYgKCB0ICE9PSB0cmFjayApIHtcclxuXHJcbiAgICAgICAgLy8gNCBjYXNlcyAwMCwgMDEsIDEwLCAxMVxyXG4gICAgICAgIGNvbnN0IG90aGVyUG9pbnRzID0gWyB0LmNvbnRyb2xQb2ludHNbIDAgXSwgdC5jb250cm9sUG9pbnRzWyB0LmNvbnRyb2xQb2ludHMubGVuZ3RoIC0gMSBdIF07XHJcblxyXG4gICAgICAgIC8vIGRvbid0IG1hdGNoIGlubmVyIHBvaW50c1xyXG4gICAgICAgIGZvciAoIGxldCBqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGorKyApIHtcclxuICAgICAgICAgIGNvbnN0IHBvaW50ID0gcG9pbnRzWyBqIF07XHJcbiAgICAgICAgICBmb3IgKCBsZXQgayA9IDA7IGsgPCBvdGhlclBvaW50cy5sZW5ndGg7IGsrKyApIHtcclxuICAgICAgICAgICAgY29uc3Qgb3RoZXJQb2ludCA9IG90aGVyUG9pbnRzWyBrIF07XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlID0gcG9pbnQuc291cmNlUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS5kaXN0YW5jZSggb3RoZXJQb2ludC5wb3NpdGlvblByb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgICAgICAgIGlmICggKCBiZXN0RGlzdGFuY2UgPT09IG51bGwgJiYgZGlzdGFuY2UgPiAxRS02ICkgfHwgKCBkaXN0YW5jZSA8IGJlc3REaXN0YW5jZSApICkge1xyXG4gICAgICAgICAgICAgIGJlc3REaXN0YW5jZSA9IGRpc3RhbmNlO1xyXG4gICAgICAgICAgICAgIG15QmVzdFBvaW50ID0gcG9pbnQ7XHJcbiAgICAgICAgICAgICAgb3RoZXJCZXN0UG9pbnQgPSBvdGhlclBvaW50O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCBiZXN0RGlzdGFuY2UgIT09IG51bGwgJiYgYmVzdERpc3RhbmNlIDwgMSApIHtcclxuICAgICAgaWYgKCBteUJlc3RQb2ludC5zbmFwVGFyZ2V0UHJvcGVydHkudmFsdWUgIT09IG90aGVyQmVzdFBvaW50ICkge1xyXG4gICAgICAgIHNuYXBUYXJnZXRDaGFuZ2VkID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBteUJlc3RQb2ludC5zbmFwVGFyZ2V0UHJvcGVydHkudmFsdWUgPSBvdGhlckJlc3RQb2ludDtcclxuXHJcbiAgICAgIC8vIFNldCB0aGUgb3Bwb3NpdGUgcG9pbnQgdG8gYmUgdW5zbmFwcGVkLCB5b3UgY2FuIG9ubHkgc25hcCBvbmUgYXQgYSB0aW1lXHJcbiAgICAgIGNvbnN0IHNvdXJjZSA9ICggbXlCZXN0UG9pbnQgPT09IHBvaW50c1sgMCBdID8gcG9pbnRzWyAxIF0gOiBwb2ludHNbIDAgXSApO1xyXG4gICAgICBpZiAoIHNvdXJjZS5zbmFwVGFyZ2V0UHJvcGVydHkudmFsdWUgIT09IG51bGwgKSB7XHJcbiAgICAgICAgc25hcFRhcmdldENoYW5nZWQgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHNvdXJjZS5zbmFwVGFyZ2V0UHJvcGVydHkudmFsdWUgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICBpZiAoIHBvaW50c1sgMCBdLnNuYXBUYXJnZXRQcm9wZXJ0eS52YWx1ZSAhPT0gbnVsbCB8fCBwb2ludHNbIDEgXS5zbmFwVGFyZ2V0UHJvcGVydHkudmFsdWUgIT09IG51bGwgKSB7XHJcbiAgICAgICAgc25hcFRhcmdldENoYW5nZWQgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHBvaW50c1sgMCBdLnNuYXBUYXJnZXRQcm9wZXJ0eS52YWx1ZSA9IG51bGw7XHJcbiAgICAgIHBvaW50c1sgMSBdLnNuYXBUYXJnZXRQcm9wZXJ0eS52YWx1ZSA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSXQgY29zdHMgYWJvdXQgNWZwcyB0byBkbyB0aGlzIGV2ZXJ5IGZyYW1lIChvbiBpUGFkMyksIHNvIG9ubHkgY2hlY2sgaWYgdGhlIHNuYXBUYXJnZXRzIGhhdmUgY2hhbmdlZC4gIFNlZSAjMjM1XHJcbiAgICBpZiAoIHNuYXBUYXJnZXRDaGFuZ2VkICkge1xyXG4gICAgICB0cmFjay51cGRhdGVTcGxpbmVzKCk7XHJcbiAgICAgIHRoaXMudHJhY2tOb2RlLnVwZGF0ZVRyYWNrU2hhcGUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNYWtlIGl0IHNvIHRoZSB0cmFjayBjYW4ndCBiZSBkcmFnZ2VkIHVuZGVyZ3JvdW5kIHdoZW4gZHJhZ2dlZCBieSB0aGUgdHJhY2sgaXRzZWxmIChub3QgY29udHJvbCBwb2ludCksIHNlZSAjMTY2XHJcbiAgICAvLyBCdXQgaWYgdGhlIHVzZXIgaXMgZHJhZ2dpbmcgdGhlIHRyYWNrIG91dCBvZiB0aGUgdG9vbGJveCwgdGhlbiBsZWF2ZSB0aGUgbW90aW9uIGNvbnRpbnVvdXMsIHNlZSAjMTc4XHJcbiAgICBpZiAoIHRyYWNrLnBoeXNpY2FsUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgIHRyYWNrLmJ1bXBBYm92ZUdyb3VuZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG1vZGVsLnRyYWNrTW9kaWZpZWQoIHRyYWNrICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQHBhcmFtIHtFdmVudH0gZXZlbnRcclxuICAgKi9cclxuICB0cmFja0RyYWdFbmRlZCggZXZlbnQgKSB7XHJcbiAgICBjb25zdCB0cmFjayA9IHRoaXMudHJhY2s7XHJcbiAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWw7XHJcblxyXG4gICAgLy8gSWYgZHJvcHBlZCBpbiB0aGUgcGxheSBhcmVhLCBzaWduaWZ5IHRoYXQgaXQgaGFzIGJlZW4gZHJvcHBlZC0tdGhpcyB3aWxsIG1ha2UgaXQgc28gdGhhdCBkcmFnZ2luZyB0aGUgY29udHJvbCBwb2ludHNcclxuICAgIC8vIHJlc2hhcGVzIHRoZSB0cmFjayBpbnN0ZWFkIG9mIHRyYW5zbGF0aW5nIGl0XHJcbiAgICB0cmFjay5kcm9wcGVkUHJvcGVydHkudmFsdWUgPSB0cnVlO1xyXG5cclxuICAgIC8vIENoZWNrIHdoZXRoZXIgdGhlIG1vZGVsIGNvbnRhaW5zIGEgdHJhY2sgc28gdGhhdCBpbnB1dCBsaXN0ZW5lcnMgZm9yIGRldGFjaGVkIGVsZW1lbnRzIGNhbid0IGNyZWF0ZSBidWdzLCBzZWUgIzIzMFxyXG4gICAgaWYgKCAhbW9kZWwuY29udGFpbnNUcmFjayggdHJhY2sgKSApIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgLy8gdHJhY2sgd2FzIHJlbGVhc2VkIHVuZGVyZ3JvdW5kIGFuZCB3YXMgbmV2ZXIgYWRkZWQgdG8gdGhlIHBsYXkgYXJlYSwgc28gcmVtb3ZlIGl0XHJcbiAgICBpZiAoICF0aGlzLmlzUHJlc3NlZCAmJiAhdHJhY2sucGh5c2ljYWxQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgbW9kZWwucmVtb3ZlQW5kRGlzcG9zZVRyYWNrKCB0cmFjayApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIHRoZSB1c2VyIG5ldmVyIGRyYWdnZWQgdGhlIG9iamVjdCwgdGhlbiB0aGVyZSBpcyBubyB0cmFjayB0byBkcm9wIGluIHRoaXMgY2FzZSwgc2VlICMyMDVcclxuICAgIGNvbnN0IG15UG9pbnRzID0gWyB0cmFjay5jb250cm9sUG9pbnRzWyAwIF0sIHRyYWNrLmNvbnRyb2xQb2ludHNbIHRyYWNrLmNvbnRyb2xQb2ludHMubGVuZ3RoIC0gMSBdIF07XHJcbiAgICBpZiAoIG15UG9pbnRzWyAwIF0uc25hcFRhcmdldFByb3BlcnR5LnZhbHVlIHx8IG15UG9pbnRzWyAxIF0uc25hcFRhcmdldFByb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICBtb2RlbC5qb2luVHJhY2tzKCB0cmFjayApOyAvLyBUcmFjayB3aWxsIGJlIGpvaW5lZCB0byBjb21wYXRpYmxlIHRyYWNrLCB0aGVuIGJvdGggd2lsbCBiZSBkaXNwb3NlZCwgYW5kIG5ldyB0cmFjayBjcmVhdGVkLlxyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIHRoZSB0cmFjayBoYXNuJ3QgYmVlbiBkaXNwb3NlZCAoc2VlICMzOTMpLCBidW1wIGl0IGFib3ZlIGdyb3VuZCBhbmQgbWFrZSBpdCBwaHlzaWNhbCBpZiB1c2VyIGhhcyBzdGFydGVkXHJcbiAgICAvLyBkcmFnZ2luZywgc2VlICMzODQgYW5kICMyMDVcclxuICAgIGlmICggIXRyYWNrLmlzRGlzcG9zZWQgJiYgdHJhY2suY29udHJvbFBvaW50cy5maWx0ZXIoIHBvaW50ID0+IHtyZXR1cm4gIXBvaW50LmlzRGlzcG9zZWQ7fSApLmxlbmd0aCAhPT0gMCApIHtcclxuICAgICAgdHJhY2suYnVtcEFib3ZlR3JvdW5kKCk7XHJcbiAgICAgIHRyYWNrLnBoeXNpY2FsUHJvcGVydHkudmFsdWUgPSB0cnVlOyAvLyBmb3IgaW50ZXJhY3Rpdml0eSwgYnV0IGFsc28gZm9yICM0MTRcclxuICAgICAgdHJhY2suZHJhZ2dpbmdQcm9wZXJ0eS52YWx1ZSA9IGZhbHNlOyAvLyBzaWduaWZ5IHRoYXQgdGhlIHRyYWNrIHNoYXBlIGNhbiBiZSBzbW9vdGhlZCBhZ2FpblxyXG4gICAgfVxyXG5cclxuICAgIGlmICggRW5lcmd5U2thdGVQYXJrUXVlcnlQYXJhbWV0ZXJzLnRlc3RUcmFja0luZGV4ID4gMCApIHtcclxuICAgICAgY29uc29sZS5sb2coIHRyYWNrLmdldERlYnVnU3RyaW5nKCkgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERldGVybWluZSB0aGUgb2Zmc2V0IHBvaW50IGF0IHRoZSBzdGFydCBvZiBhIGRyYWcgc28gdGhhdCB0aGUgdHJhY2sgdHJhbnNsYXRlcyB3aXRoIHRoZSBtb3VzZSB3aXRob3V0IGp1bXBpbmcuXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U2NlbmVyeUV2ZW50fSBldmVudFxyXG4gICAqL1xyXG4gIGNhbGN1bGF0ZVN0YXJ0T2Zmc2V0KCBldmVudCApIHtcclxuICAgIGNvbnN0IHN0YXJ0aW5nUG9zaXRpb24gPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCB0aGlzLnRyYWNrLnBvc2l0aW9uICk7XHJcbiAgICB0aGlzLnN0YXJ0T2Zmc2V0ID0gZXZlbnQuY3VycmVudFRhcmdldC5nbG9iYWxUb1BhcmVudFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICkubWludXMoIHN0YXJ0aW5nUG9zaXRpb24gKTtcclxuICB9XHJcbn1cclxuXHJcbmVuZXJneVNrYXRlUGFyay5yZWdpc3RlciggJ1RyYWNrRHJhZ0hhbmRsZXInLCBUcmFja0RyYWdIYW5kbGVyICk7XHJcbmV4cG9ydCBkZWZhdWx0IFRyYWNrRHJhZ0hhbmRsZXI7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQVNBLFlBQVksUUFBUSxtQ0FBbUM7QUFDaEUsT0FBT0MsZUFBZSxNQUFNLDBCQUEwQjtBQUN0RCxPQUFPQyw4QkFBOEIsTUFBTSxzQ0FBc0M7QUFFakYsTUFBTUMsZ0JBQWdCLFNBQVNILFlBQVksQ0FBQztFQUUxQztBQUNGO0FBQ0E7QUFDQTtFQUNFSSxXQUFXQSxDQUFFQyxTQUFTLEVBQUVDLE1BQU0sRUFBRztJQUUvQjtJQUNBO0lBQ0E7SUFDQSxLQUFLLENBQUU7TUFDTEEsTUFBTSxFQUFFQSxNQUFNLENBQUNDLFlBQVks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