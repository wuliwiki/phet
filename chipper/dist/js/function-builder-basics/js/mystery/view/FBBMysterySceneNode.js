// Copyright 2017-2023, University of Colorado Boulder

/**
 * Scene for the 'Mystery' screen in 'Function Builder: Basics'.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import FBColors from '../../../../function-builder/js/common/FBColors.js';
import FBQueryParameters from '../../../../function-builder/js/common/FBQueryParameters.js';
import ImageCard from '../../../../function-builder/js/common/model/cards/ImageCard.js';
import ImageCardNode from '../../../../function-builder/js/common/view/cards/ImageCardNode.js';
import CardContainer from '../../../../function-builder/js/common/view/containers/CardContainer.js';
import SceneNode from '../../../../function-builder/js/common/view/SceneNode.js';
import merge from '../../../../phet-core/js/merge.js';
import EyeToggleButton from '../../../../scenery-phet/js/buttons/EyeToggleButton.js';
import RefreshButton from '../../../../scenery-phet/js/buttons/RefreshButton.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Text } from '../../../../scenery/js/imports.js';
import functionBuilderBasics from '../../functionBuilderBasics.js';
import FBBMysteryFunctionNode from './FBBMysteryFunctionNode.js';

// constants
const QUESTION_MARK_COLORS = ['red', 'rgb( 0, 170, 255 )', 'green', 'orange', 'magenta'];
class FBBMysterySceneNode extends SceneNode {
  /**
   * @param {MysteryScene} scene - model for this scene
   * @param {Bounds2} layoutBounds - layoutBounds of the parent ScreenView
   * @param {Object} [options]
   */
  constructor(scene, layoutBounds, options) {
    options = merge({
      /*
       * Mystery scenes have a hidden function carousel, which is where we get functions for composing challenges.
       * This approach was necessary because the Mystery screen was added late in the development process, and
       * the existence of the function carousel was (by that point) required by too many things.
       */
      functionCarouselVisible: false,
      // Hide the checkbox that lets us show/hide the identify of functions in the builder.
      hideFunctionsCheckboxVisible: false,
      // Show an image on the 'See Inside' checkbox icon
      seeInsideIconType: 'image'
    }, options);
    super(scene, layoutBounds, FBBMysteryFunctionNode, options);
    const self = this;

    // Toggle buttons below each builder slot, for revealing identity of functions
    this.revealProperties = []; // {Property.<boolean>[]}
    this.revealButtons = []; // {EyeToggleButton[]}
    for (let i = 0; i < scene.builder.numberOfSlots; i++) {
      // create a closure for slotNumber using an IIFE
      (() => {
        const slotNumber = i;

        // Property associated with the slot
        const revealProperty = new BooleanProperty(false);
        self.revealProperties.push(revealProperty);

        // wire up Property to control the function that's in the slot
        // unlink unnecessary, instances exist for lifetime of the sim
        revealProperty.link(reveal => {
          const functionNode = self.builderNode.getFunctionNode(slotNumber);
          if (functionNode) {
            functionNode.identityVisibleProperty.set(reveal);
          }
        });

        // button below the slot
        const slotPosition = scene.builder.slots[slotNumber].position;
        const revealButton = new EyeToggleButton(revealProperty, {
          baseColor: FBColors.HIDDEN_FUNCTION,
          scale: 0.75,
          centerX: slotPosition.x,
          top: slotPosition.y + 65
        });
        self.revealButtons.push(revealButton);
        self.controlsLayer.addChild(revealButton);

        // touchArea
        revealButton.touchArea = revealButton.localBounds.dilatedXY(25, 15);
      })();
    }

    // button for generating a new challenge
    const generateButton = new RefreshButton({
      listener: () => scene.nextChallenge(),
      iconHeight: 38,
      xMargin: 18,
      yMargin: 10,
      centerX: this.builderNode.centerX,
      top: this.builderNode.bottom + 65
    });
    this.addChild(generateButton);

    // @private shows the answer below the generate button, for debugging, i18n not required
    this.answerNode = new Text('answer', {
      font: new PhetFont(18),
      centerX: generateButton.centerX,
      top: generateButton.bottom + 10
    });
    if (phet.chipper.queryParameters.showAnswers) {
      this.addChild(this.answerNode);
    }

    // Update when the challenge changes.
    // unlink unnecessary, instances exist for lifetime of the sim
    scene.challengeProperty.lazyLink(challenge => this.updateChallenge());

    // Enable features based on number of cards that have been moved to the output carousel.
    // unlink unnecessary, instances exist for lifetime of the sim.
    this.outputCarousel.numberOfCardsProperty.link(numberOfCards => {
      // enabled function reveal buttons
      this.revealButtons.forEach(revealButton => {
        revealButton.enabled = revealButton.enabled || numberOfCards === 3;
      });

      // enable 'See Inside' checkbox
      this.seeInsideCheckbox.enabled = this.seeInsideCheckbox.enabled || numberOfCards === 1;
    });

    // @private colors for the '?' on function nodes
    this.questionMarkColors = dotRandom.shuffle(QUESTION_MARK_COLORS);

    // @private
    this.scene = scene;
  }

  /**
   * @public
   * @override
   */
  reset() {
    super.reset();
    this.resetChallengeControls();
  }

  /**
   * Creates the card containers that go in the input and output carousels.
   *
   * @param {Scene} scene
   * @param {Object} [containerOptions] - see CardContainer options
   * @returns {CarouselItem[]}
   * @protected
   * @override
   */
  createCardCarouselItems(scene, containerOptions) {
    const containers = [];
    scene.cardContent.forEach(cardImage => {
      containers.push({
        createNode: tandem => new CardContainer(ImageCard, ImageCardNode, cardImage, containerOptions)
      });
    });
    return containers;
  }

  /**
   * Resets controls that need to be reset each time the challenge changes.
   *
   * @private
   */
  resetChallengeControls() {
    // reset Properties for revealing function identity
    this.revealProperties.forEach(revealProperty => revealProperty.reset());

    // disable buttons for revealing function identity
    this.revealButtons.forEach(revealButton => {
      revealButton.enabled = false;
    });

    // reset 'See Inside' property
    this.seeInsideProperty.reset();

    // disable 'See Inside' checkbox
    this.seeInsideCheckbox.enabled = false;
  }

  /**
   * Completes initialization by displaying the first challenge.
   *
   * @public
   * @override
   */
  completeInitialization() {
    super.completeInitialization();
    this.updateChallenge();
  }

  /**
   * Synchronizes the displayed challenge with the model.
   *
   * @private
   */
  updateChallenge() {
    this.resetCarousels();
    this.builderNode.reset();
    this.resetFunctions();
    this.resetCards();
    const functionConstructors = this.scene.challengeProperty.get(); // {constructor[]}

    const questionMarkColors = this.getQuestionMarkColors(this.scene.builder.numberOfSlots);

    // transfer functions from carousel to builder, configured to match the challenge
    let slotNumber = 0;
    let answerText = '';
    for (let i = 0; i < functionConstructors.length; i++) {
      // get a function node from the carousel
      const functionNode = this.getFunctionNode(functionConstructors[i]);

      // change the color of its question mark
      functionNode.setQuestionMarkColor(questionMarkColors[i]);

      // move the function to the builder
      functionNode.moveToBuilder(slotNumber);

      // hide the function's identity
      functionNode.identityVisibleProperty.set(false);

      // add to answer text
      answerText += functionNode.functionInstance.name;
      if (i < functionConstructors.length - 1) {
        answerText += ' > ';
      }
      slotNumber++;
    }

    // Resets controls that need to be reset each time the challenge changes.
    this.resetChallengeControls();

    // show the answer for debugging
    this.answerNode.string = answerText;
    this.answerNode.centerX = this.builderNode.centerX;
    if (FBQueryParameters.populateOutput) {
      this.populateOutputCarousel();
    }
  }

  /**
   * Given a function constructor, get a corresponding FunctionNode from the carousel.
   * @param {constructor} functionConstructor - constructor for an ImageFunction
   * @returns {ImageFunctionNode}
   * @public
   */
  getFunctionNode(functionConstructor) {
    // get the container that has functions of the specified type
    let functionContainer = null;
    for (let i = 0; i < this.functionContainers.length && !functionContainer; i++) {
      if (this.functionContainers[i].getFunctionConstructor() === functionConstructor) {
        functionContainer = this.functionContainers[i];
      }
    }
    assert && assert(functionContainer, 'functionContainer not found');
    assert && assert(!functionContainer.isEmpty(), 'functionContainer is empty');

    // get the first item in the container
    return functionContainer.getContents()[0];
  }

  /**
   * Gets a set of question mark colors, containing no duplicates.
   * @param {number} numberOfColors
   * @returns {Color[]|string[]}
   * @public
   */
  getQuestionMarkColors(numberOfColors) {
    assert && assert(numberOfColors <= QUESTION_MARK_COLORS.length);
    const colors = [];
    while (colors.length < numberOfColors) {
      // remove first color from the pool
      const color = this.questionMarkColors[0];
      this.questionMarkColors.splice(0, 1);

      // prevent duplicate colors
      if (colors.indexOf(color) === -1) {
        colors.push(color);
      }

      // replenish the colors
      if (this.questionMarkColors.length === 0) {
        this.questionMarkColors = dotRandom.shuffle(QUESTION_MARK_COLORS);

        // prevent choosing the same color consecutively
        if (this.questionMarkColors[0] === color) {
          this.questionMarkColors.splice(0, 1);
        }
      }
    }
    assert && assert(colors.length === numberOfColors);
    return colors;
  }
}
functionBuilderBasics.register('FBBMysterySceneNode', FBBMysterySceneNode);
export default FBBMysterySceneNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJkb3RSYW5kb20iLCJGQkNvbG9ycyIsIkZCUXVlcnlQYXJhbWV0ZXJzIiwiSW1hZ2VDYXJkIiwiSW1hZ2VDYXJkTm9kZSIsIkNhcmRDb250YWluZXIiLCJTY2VuZU5vZGUiLCJtZXJnZSIsIkV5ZVRvZ2dsZUJ1dHRvbiIsIlJlZnJlc2hCdXR0b24iLCJQaGV0Rm9udCIsIlRleHQiLCJmdW5jdGlvbkJ1aWxkZXJCYXNpY3MiLCJGQkJNeXN0ZXJ5RnVuY3Rpb25Ob2RlIiwiUVVFU1RJT05fTUFSS19DT0xPUlMiLCJGQkJNeXN0ZXJ5U2NlbmVOb2RlIiwiY29uc3RydWN0b3IiLCJzY2VuZSIsImxheW91dEJvdW5kcyIsIm9wdGlvbnMiLCJmdW5jdGlvbkNhcm91c2VsVmlzaWJsZSIsImhpZGVGdW5jdGlvbnNDaGVja2JveFZpc2libGUiLCJzZWVJbnNpZGVJY29uVHlwZSIsInNlbGYiLCJyZXZlYWxQcm9wZXJ0aWVzIiwicmV2ZWFsQnV0dG9ucyIsImkiLCJidWlsZGVyIiwibnVtYmVyT2ZTbG90cyIsInNsb3ROdW1iZXIiLCJyZXZlYWxQcm9wZXJ0eSIsInB1c2giLCJsaW5rIiwicmV2ZWFsIiwiZnVuY3Rpb25Ob2RlIiwiYnVpbGRlck5vZGUiLCJnZXRGdW5jdGlvbk5vZGUiLCJpZGVudGl0eVZpc2libGVQcm9wZXJ0eSIsInNldCIsInNsb3RQb3NpdGlvbiIsInNsb3RzIiwicG9zaXRpb24iLCJyZXZlYWxCdXR0b24iLCJiYXNlQ29sb3IiLCJISURERU5fRlVOQ1RJT04iLCJzY2FsZSIsImNlbnRlclgiLCJ4IiwidG9wIiwieSIsImNvbnRyb2xzTGF5ZXIiLCJhZGRDaGlsZCIsInRvdWNoQXJlYSIsImxvY2FsQm91bmRzIiwiZGlsYXRlZFhZIiwiZ2VuZXJhdGVCdXR0b24iLCJsaXN0ZW5lciIsIm5leHRDaGFsbGVuZ2UiLCJpY29uSGVpZ2h0IiwieE1hcmdpbiIsInlNYXJnaW4iLCJib3R0b20iLCJhbnN3ZXJOb2RlIiwiZm9udCIsInBoZXQiLCJjaGlwcGVyIiwicXVlcnlQYXJhbWV0ZXJzIiwic2hvd0Fuc3dlcnMiLCJjaGFsbGVuZ2VQcm9wZXJ0eSIsImxhenlMaW5rIiwiY2hhbGxlbmdlIiwidXBkYXRlQ2hhbGxlbmdlIiwib3V0cHV0Q2Fyb3VzZWwiLCJudW1iZXJPZkNhcmRzUHJvcGVydHkiLCJudW1iZXJPZkNhcmRzIiwiZm9yRWFjaCIsImVuYWJsZWQiLCJzZWVJbnNpZGVDaGVja2JveCIsInF1ZXN0aW9uTWFya0NvbG9ycyIsInNodWZmbGUiLCJyZXNldCIsInJlc2V0Q2hhbGxlbmdlQ29udHJvbHMiLCJjcmVhdGVDYXJkQ2Fyb3VzZWxJdGVtcyIsImNvbnRhaW5lck9wdGlvbnMiLCJjb250YWluZXJzIiwiY2FyZENvbnRlbnQiLCJjYXJkSW1hZ2UiLCJjcmVhdGVOb2RlIiwidGFuZGVtIiwic2VlSW5zaWRlUHJvcGVydHkiLCJjb21wbGV0ZUluaXRpYWxpemF0aW9uIiwicmVzZXRDYXJvdXNlbHMiLCJyZXNldEZ1bmN0aW9ucyIsInJlc2V0Q2FyZHMiLCJmdW5jdGlvbkNvbnN0cnVjdG9ycyIsImdldCIsImdldFF1ZXN0aW9uTWFya0NvbG9ycyIsImFuc3dlclRleHQiLCJsZW5ndGgiLCJzZXRRdWVzdGlvbk1hcmtDb2xvciIsIm1vdmVUb0J1aWxkZXIiLCJmdW5jdGlvbkluc3RhbmNlIiwibmFtZSIsInN0cmluZyIsInBvcHVsYXRlT3V0cHV0IiwicG9wdWxhdGVPdXRwdXRDYXJvdXNlbCIsImZ1bmN0aW9uQ29uc3RydWN0b3IiLCJmdW5jdGlvbkNvbnRhaW5lciIsImZ1bmN0aW9uQ29udGFpbmVycyIsImdldEZ1bmN0aW9uQ29uc3RydWN0b3IiLCJhc3NlcnQiLCJpc0VtcHR5IiwiZ2V0Q29udGVudHMiLCJudW1iZXJPZkNvbG9ycyIsImNvbG9ycyIsImNvbG9yIiwic3BsaWNlIiwiaW5kZXhPZiIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRkJCTXlzdGVyeVNjZW5lTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTY2VuZSBmb3IgdGhlICdNeXN0ZXJ5JyBzY3JlZW4gaW4gJ0Z1bmN0aW9uIEJ1aWxkZXI6IEJhc2ljcycuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBkb3RSYW5kb20gZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL2RvdFJhbmRvbS5qcyc7XHJcbmltcG9ydCBGQkNvbG9ycyBmcm9tICcuLi8uLi8uLi8uLi9mdW5jdGlvbi1idWlsZGVyL2pzL2NvbW1vbi9GQkNvbG9ycy5qcyc7XHJcbmltcG9ydCBGQlF1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi8uLi8uLi9mdW5jdGlvbi1idWlsZGVyL2pzL2NvbW1vbi9GQlF1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCBJbWFnZUNhcmQgZnJvbSAnLi4vLi4vLi4vLi4vZnVuY3Rpb24tYnVpbGRlci9qcy9jb21tb24vbW9kZWwvY2FyZHMvSW1hZ2VDYXJkLmpzJztcclxuaW1wb3J0IEltYWdlQ2FyZE5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vZnVuY3Rpb24tYnVpbGRlci9qcy9jb21tb24vdmlldy9jYXJkcy9JbWFnZUNhcmROb2RlLmpzJztcclxuaW1wb3J0IENhcmRDb250YWluZXIgZnJvbSAnLi4vLi4vLi4vLi4vZnVuY3Rpb24tYnVpbGRlci9qcy9jb21tb24vdmlldy9jb250YWluZXJzL0NhcmRDb250YWluZXIuanMnO1xyXG5pbXBvcnQgU2NlbmVOb2RlIGZyb20gJy4uLy4uLy4uLy4uL2Z1bmN0aW9uLWJ1aWxkZXIvanMvY29tbW9uL3ZpZXcvU2NlbmVOb2RlLmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBFeWVUb2dnbGVCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvRXllVG9nZ2xlQnV0dG9uLmpzJztcclxuaW1wb3J0IFJlZnJlc2hCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvUmVmcmVzaEJ1dHRvbi5qcyc7XHJcbmltcG9ydCBQaGV0Rm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldEZvbnQuanMnO1xyXG5pbXBvcnQgeyBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGZ1bmN0aW9uQnVpbGRlckJhc2ljcyBmcm9tICcuLi8uLi9mdW5jdGlvbkJ1aWxkZXJCYXNpY3MuanMnO1xyXG5pbXBvcnQgRkJCTXlzdGVyeUZ1bmN0aW9uTm9kZSBmcm9tICcuL0ZCQk15c3RlcnlGdW5jdGlvbk5vZGUuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFFVRVNUSU9OX01BUktfQ09MT1JTID0gWyAncmVkJywgJ3JnYiggMCwgMTcwLCAyNTUgKScsICdncmVlbicsICdvcmFuZ2UnLCAnbWFnZW50YScgXTtcclxuXHJcbmNsYXNzIEZCQk15c3RlcnlTY2VuZU5vZGUgZXh0ZW5kcyBTY2VuZU5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge015c3RlcnlTY2VuZX0gc2NlbmUgLSBtb2RlbCBmb3IgdGhpcyBzY2VuZVxyXG4gICAqIEBwYXJhbSB7Qm91bmRzMn0gbGF5b3V0Qm91bmRzIC0gbGF5b3V0Qm91bmRzIG9mIHRoZSBwYXJlbnQgU2NyZWVuVmlld1xyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvciggc2NlbmUsIGxheW91dEJvdW5kcywgb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuXHJcbiAgICAgIC8qXHJcbiAgICAgICAqIE15c3Rlcnkgc2NlbmVzIGhhdmUgYSBoaWRkZW4gZnVuY3Rpb24gY2Fyb3VzZWwsIHdoaWNoIGlzIHdoZXJlIHdlIGdldCBmdW5jdGlvbnMgZm9yIGNvbXBvc2luZyBjaGFsbGVuZ2VzLlxyXG4gICAgICAgKiBUaGlzIGFwcHJvYWNoIHdhcyBuZWNlc3NhcnkgYmVjYXVzZSB0aGUgTXlzdGVyeSBzY3JlZW4gd2FzIGFkZGVkIGxhdGUgaW4gdGhlIGRldmVsb3BtZW50IHByb2Nlc3MsIGFuZFxyXG4gICAgICAgKiB0aGUgZXhpc3RlbmNlIG9mIHRoZSBmdW5jdGlvbiBjYXJvdXNlbCB3YXMgKGJ5IHRoYXQgcG9pbnQpIHJlcXVpcmVkIGJ5IHRvbyBtYW55IHRoaW5ncy5cclxuICAgICAgICovXHJcbiAgICAgIGZ1bmN0aW9uQ2Fyb3VzZWxWaXNpYmxlOiBmYWxzZSxcclxuXHJcbiAgICAgIC8vIEhpZGUgdGhlIGNoZWNrYm94IHRoYXQgbGV0cyB1cyBzaG93L2hpZGUgdGhlIGlkZW50aWZ5IG9mIGZ1bmN0aW9ucyBpbiB0aGUgYnVpbGRlci5cclxuICAgICAgaGlkZUZ1bmN0aW9uc0NoZWNrYm94VmlzaWJsZTogZmFsc2UsXHJcblxyXG4gICAgICAvLyBTaG93IGFuIGltYWdlIG9uIHRoZSAnU2VlIEluc2lkZScgY2hlY2tib3ggaWNvblxyXG4gICAgICBzZWVJbnNpZGVJY29uVHlwZTogJ2ltYWdlJ1xyXG5cclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggc2NlbmUsIGxheW91dEJvdW5kcywgRkJCTXlzdGVyeUZ1bmN0aW9uTm9kZSwgb3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIC8vIFRvZ2dsZSBidXR0b25zIGJlbG93IGVhY2ggYnVpbGRlciBzbG90LCBmb3IgcmV2ZWFsaW5nIGlkZW50aXR5IG9mIGZ1bmN0aW9uc1xyXG4gICAgdGhpcy5yZXZlYWxQcm9wZXJ0aWVzID0gW107ICAvLyB7UHJvcGVydHkuPGJvb2xlYW4+W119XHJcbiAgICB0aGlzLnJldmVhbEJ1dHRvbnMgPSBbXTsgLy8ge0V5ZVRvZ2dsZUJ1dHRvbltdfVxyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgc2NlbmUuYnVpbGRlci5udW1iZXJPZlNsb3RzOyBpKysgKSB7XHJcblxyXG4gICAgICAvLyBjcmVhdGUgYSBjbG9zdXJlIGZvciBzbG90TnVtYmVyIHVzaW5nIGFuIElJRkVcclxuICAgICAgKCAoKSA9PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IHNsb3ROdW1iZXIgPSBpO1xyXG5cclxuICAgICAgICAvLyBQcm9wZXJ0eSBhc3NvY2lhdGVkIHdpdGggdGhlIHNsb3RcclxuICAgICAgICBjb25zdCByZXZlYWxQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcbiAgICAgICAgc2VsZi5yZXZlYWxQcm9wZXJ0aWVzLnB1c2goIHJldmVhbFByb3BlcnR5ICk7XHJcblxyXG4gICAgICAgIC8vIHdpcmUgdXAgUHJvcGVydHkgdG8gY29udHJvbCB0aGUgZnVuY3Rpb24gdGhhdCdzIGluIHRoZSBzbG90XHJcbiAgICAgICAgLy8gdW5saW5rIHVubmVjZXNzYXJ5LCBpbnN0YW5jZXMgZXhpc3QgZm9yIGxpZmV0aW1lIG9mIHRoZSBzaW1cclxuICAgICAgICByZXZlYWxQcm9wZXJ0eS5saW5rKCByZXZlYWwgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnVuY3Rpb25Ob2RlID0gc2VsZi5idWlsZGVyTm9kZS5nZXRGdW5jdGlvbk5vZGUoIHNsb3ROdW1iZXIgKTtcclxuICAgICAgICAgIGlmICggZnVuY3Rpb25Ob2RlICkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbk5vZGUuaWRlbnRpdHlWaXNpYmxlUHJvcGVydHkuc2V0KCByZXZlYWwgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgIC8vIGJ1dHRvbiBiZWxvdyB0aGUgc2xvdFxyXG4gICAgICAgIGNvbnN0IHNsb3RQb3NpdGlvbiA9IHNjZW5lLmJ1aWxkZXIuc2xvdHNbIHNsb3ROdW1iZXIgXS5wb3NpdGlvbjtcclxuICAgICAgICBjb25zdCByZXZlYWxCdXR0b24gPSBuZXcgRXllVG9nZ2xlQnV0dG9uKCByZXZlYWxQcm9wZXJ0eSwge1xyXG4gICAgICAgICAgYmFzZUNvbG9yOiBGQkNvbG9ycy5ISURERU5fRlVOQ1RJT04sXHJcbiAgICAgICAgICBzY2FsZTogMC43NSxcclxuICAgICAgICAgIGNlbnRlclg6IHNsb3RQb3NpdGlvbi54LFxyXG4gICAgICAgICAgdG9wOiBzbG90UG9zaXRpb24ueSArIDY1XHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIHNlbGYucmV2ZWFsQnV0dG9ucy5wdXNoKCByZXZlYWxCdXR0b24gKTtcclxuICAgICAgICBzZWxmLmNvbnRyb2xzTGF5ZXIuYWRkQ2hpbGQoIHJldmVhbEJ1dHRvbiApO1xyXG5cclxuICAgICAgICAvLyB0b3VjaEFyZWFcclxuICAgICAgICByZXZlYWxCdXR0b24udG91Y2hBcmVhID0gcmV2ZWFsQnV0dG9uLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggMjUsIDE1ICk7XHJcblxyXG4gICAgICB9ICkoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidXR0b24gZm9yIGdlbmVyYXRpbmcgYSBuZXcgY2hhbGxlbmdlXHJcbiAgICBjb25zdCBnZW5lcmF0ZUJ1dHRvbiA9IG5ldyBSZWZyZXNoQnV0dG9uKCB7XHJcbiAgICAgIGxpc3RlbmVyOiAoKSA9PiBzY2VuZS5uZXh0Q2hhbGxlbmdlKCksXHJcbiAgICAgIGljb25IZWlnaHQ6IDM4LFxyXG4gICAgICB4TWFyZ2luOiAxOCxcclxuICAgICAgeU1hcmdpbjogMTAsXHJcbiAgICAgIGNlbnRlclg6IHRoaXMuYnVpbGRlck5vZGUuY2VudGVyWCxcclxuICAgICAgdG9wOiB0aGlzLmJ1aWxkZXJOb2RlLmJvdHRvbSArIDY1XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBnZW5lcmF0ZUJ1dHRvbiApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHNob3dzIHRoZSBhbnN3ZXIgYmVsb3cgdGhlIGdlbmVyYXRlIGJ1dHRvbiwgZm9yIGRlYnVnZ2luZywgaTE4biBub3QgcmVxdWlyZWRcclxuICAgIHRoaXMuYW5zd2VyTm9kZSA9IG5ldyBUZXh0KCAnYW5zd2VyJywge1xyXG4gICAgICBmb250OiBuZXcgUGhldEZvbnQoIDE4ICksXHJcbiAgICAgIGNlbnRlclg6IGdlbmVyYXRlQnV0dG9uLmNlbnRlclgsXHJcbiAgICAgIHRvcDogZ2VuZXJhdGVCdXR0b24uYm90dG9tICsgMTBcclxuICAgIH0gKTtcclxuICAgIGlmICggcGhldC5jaGlwcGVyLnF1ZXJ5UGFyYW1ldGVycy5zaG93QW5zd2VycyApIHtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggdGhpcy5hbnN3ZXJOb2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXBkYXRlIHdoZW4gdGhlIGNoYWxsZW5nZSBjaGFuZ2VzLlxyXG4gICAgLy8gdW5saW5rIHVubmVjZXNzYXJ5LCBpbnN0YW5jZXMgZXhpc3QgZm9yIGxpZmV0aW1lIG9mIHRoZSBzaW1cclxuICAgIHNjZW5lLmNoYWxsZW5nZVByb3BlcnR5LmxhenlMaW5rKCBjaGFsbGVuZ2UgPT4gdGhpcy51cGRhdGVDaGFsbGVuZ2UoKSApO1xyXG5cclxuICAgIC8vIEVuYWJsZSBmZWF0dXJlcyBiYXNlZCBvbiBudW1iZXIgb2YgY2FyZHMgdGhhdCBoYXZlIGJlZW4gbW92ZWQgdG8gdGhlIG91dHB1dCBjYXJvdXNlbC5cclxuICAgIC8vIHVubGluayB1bm5lY2Vzc2FyeSwgaW5zdGFuY2VzIGV4aXN0IGZvciBsaWZldGltZSBvZiB0aGUgc2ltLlxyXG4gICAgdGhpcy5vdXRwdXRDYXJvdXNlbC5udW1iZXJPZkNhcmRzUHJvcGVydHkubGluayggbnVtYmVyT2ZDYXJkcyA9PiB7XHJcblxyXG4gICAgICAvLyBlbmFibGVkIGZ1bmN0aW9uIHJldmVhbCBidXR0b25zXHJcbiAgICAgIHRoaXMucmV2ZWFsQnV0dG9ucy5mb3JFYWNoKCByZXZlYWxCdXR0b24gPT4ge1xyXG4gICAgICAgIHJldmVhbEJ1dHRvbi5lbmFibGVkID0gcmV2ZWFsQnV0dG9uLmVuYWJsZWQgfHwgKCBudW1iZXJPZkNhcmRzID09PSAzICk7XHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAgIC8vIGVuYWJsZSAnU2VlIEluc2lkZScgY2hlY2tib3hcclxuICAgICAgdGhpcy5zZWVJbnNpZGVDaGVja2JveC5lbmFibGVkID0gdGhpcy5zZWVJbnNpZGVDaGVja2JveC5lbmFibGVkIHx8ICggbnVtYmVyT2ZDYXJkcyA9PT0gMSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIGNvbG9ycyBmb3IgdGhlICc/JyBvbiBmdW5jdGlvbiBub2Rlc1xyXG4gICAgdGhpcy5xdWVzdGlvbk1hcmtDb2xvcnMgPSBkb3RSYW5kb20uc2h1ZmZsZSggUVVFU1RJT05fTUFSS19DT0xPUlMgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5zY2VuZSA9IHNjZW5lO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG4gICAgc3VwZXIucmVzZXQoKTtcclxuICAgIHRoaXMucmVzZXRDaGFsbGVuZ2VDb250cm9scygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyB0aGUgY2FyZCBjb250YWluZXJzIHRoYXQgZ28gaW4gdGhlIGlucHV0IGFuZCBvdXRwdXQgY2Fyb3VzZWxzLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtTY2VuZX0gc2NlbmVcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbnRhaW5lck9wdGlvbnNdIC0gc2VlIENhcmRDb250YWluZXIgb3B0aW9uc1xyXG4gICAqIEByZXR1cm5zIHtDYXJvdXNlbEl0ZW1bXX1cclxuICAgKiBAcHJvdGVjdGVkXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgY3JlYXRlQ2FyZENhcm91c2VsSXRlbXMoIHNjZW5lLCBjb250YWluZXJPcHRpb25zICkge1xyXG4gICAgY29uc3QgY29udGFpbmVycyA9IFtdO1xyXG4gICAgc2NlbmUuY2FyZENvbnRlbnQuZm9yRWFjaCggY2FyZEltYWdlID0+IHtcclxuICAgICAgY29udGFpbmVycy5wdXNoKCB7XHJcbiAgICAgICAgY3JlYXRlTm9kZTogdGFuZGVtID0+IG5ldyBDYXJkQ29udGFpbmVyKCBJbWFnZUNhcmQsIEltYWdlQ2FyZE5vZGUsIGNhcmRJbWFnZSwgY29udGFpbmVyT3B0aW9ucyApXHJcbiAgICAgIH0gKTtcclxuICAgIH0gKTtcclxuICAgIHJldHVybiBjb250YWluZXJzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIGNvbnRyb2xzIHRoYXQgbmVlZCB0byBiZSByZXNldCBlYWNoIHRpbWUgdGhlIGNoYWxsZW5nZSBjaGFuZ2VzLlxyXG4gICAqXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICByZXNldENoYWxsZW5nZUNvbnRyb2xzKCkge1xyXG5cclxuICAgIC8vIHJlc2V0IFByb3BlcnRpZXMgZm9yIHJldmVhbGluZyBmdW5jdGlvbiBpZGVudGl0eVxyXG4gICAgdGhpcy5yZXZlYWxQcm9wZXJ0aWVzLmZvckVhY2goIHJldmVhbFByb3BlcnR5ID0+IHJldmVhbFByb3BlcnR5LnJlc2V0KCkgKTtcclxuXHJcbiAgICAvLyBkaXNhYmxlIGJ1dHRvbnMgZm9yIHJldmVhbGluZyBmdW5jdGlvbiBpZGVudGl0eVxyXG4gICAgdGhpcy5yZXZlYWxCdXR0b25zLmZvckVhY2goIHJldmVhbEJ1dHRvbiA9PiB7XHJcbiAgICAgIHJldmVhbEJ1dHRvbi5lbmFibGVkID0gZmFsc2U7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gcmVzZXQgJ1NlZSBJbnNpZGUnIHByb3BlcnR5XHJcbiAgICB0aGlzLnNlZUluc2lkZVByb3BlcnR5LnJlc2V0KCk7XHJcblxyXG4gICAgLy8gZGlzYWJsZSAnU2VlIEluc2lkZScgY2hlY2tib3hcclxuICAgIHRoaXMuc2VlSW5zaWRlQ2hlY2tib3guZW5hYmxlZCA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29tcGxldGVzIGluaXRpYWxpemF0aW9uIGJ5IGRpc3BsYXlpbmcgdGhlIGZpcnN0IGNoYWxsZW5nZS5cclxuICAgKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICBjb21wbGV0ZUluaXRpYWxpemF0aW9uKCkge1xyXG4gICAgc3VwZXIuY29tcGxldGVJbml0aWFsaXphdGlvbigpO1xyXG4gICAgdGhpcy51cGRhdGVDaGFsbGVuZ2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN5bmNocm9uaXplcyB0aGUgZGlzcGxheWVkIGNoYWxsZW5nZSB3aXRoIHRoZSBtb2RlbC5cclxuICAgKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgdXBkYXRlQ2hhbGxlbmdlKCkge1xyXG5cclxuICAgIHRoaXMucmVzZXRDYXJvdXNlbHMoKTtcclxuICAgIHRoaXMuYnVpbGRlck5vZGUucmVzZXQoKTtcclxuICAgIHRoaXMucmVzZXRGdW5jdGlvbnMoKTtcclxuICAgIHRoaXMucmVzZXRDYXJkcygpO1xyXG5cclxuICAgIGNvbnN0IGZ1bmN0aW9uQ29uc3RydWN0b3JzID0gdGhpcy5zY2VuZS5jaGFsbGVuZ2VQcm9wZXJ0eS5nZXQoKTsgLy8ge2NvbnN0cnVjdG9yW119XHJcblxyXG4gICAgY29uc3QgcXVlc3Rpb25NYXJrQ29sb3JzID0gdGhpcy5nZXRRdWVzdGlvbk1hcmtDb2xvcnMoIHRoaXMuc2NlbmUuYnVpbGRlci5udW1iZXJPZlNsb3RzICk7XHJcblxyXG4gICAgLy8gdHJhbnNmZXIgZnVuY3Rpb25zIGZyb20gY2Fyb3VzZWwgdG8gYnVpbGRlciwgY29uZmlndXJlZCB0byBtYXRjaCB0aGUgY2hhbGxlbmdlXHJcbiAgICBsZXQgc2xvdE51bWJlciA9IDA7XHJcbiAgICBsZXQgYW5zd2VyVGV4dCA9ICcnO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgZnVuY3Rpb25Db25zdHJ1Y3RvcnMubGVuZ3RoOyBpKysgKSB7XHJcblxyXG4gICAgICAvLyBnZXQgYSBmdW5jdGlvbiBub2RlIGZyb20gdGhlIGNhcm91c2VsXHJcbiAgICAgIGNvbnN0IGZ1bmN0aW9uTm9kZSA9IHRoaXMuZ2V0RnVuY3Rpb25Ob2RlKCBmdW5jdGlvbkNvbnN0cnVjdG9yc1sgaSBdICk7XHJcblxyXG4gICAgICAvLyBjaGFuZ2UgdGhlIGNvbG9yIG9mIGl0cyBxdWVzdGlvbiBtYXJrXHJcbiAgICAgIGZ1bmN0aW9uTm9kZS5zZXRRdWVzdGlvbk1hcmtDb2xvciggcXVlc3Rpb25NYXJrQ29sb3JzWyBpIF0gKTtcclxuXHJcbiAgICAgIC8vIG1vdmUgdGhlIGZ1bmN0aW9uIHRvIHRoZSBidWlsZGVyXHJcbiAgICAgIGZ1bmN0aW9uTm9kZS5tb3ZlVG9CdWlsZGVyKCBzbG90TnVtYmVyICk7XHJcblxyXG4gICAgICAvLyBoaWRlIHRoZSBmdW5jdGlvbidzIGlkZW50aXR5XHJcbiAgICAgIGZ1bmN0aW9uTm9kZS5pZGVudGl0eVZpc2libGVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcblxyXG4gICAgICAvLyBhZGQgdG8gYW5zd2VyIHRleHRcclxuICAgICAgYW5zd2VyVGV4dCArPSBmdW5jdGlvbk5vZGUuZnVuY3Rpb25JbnN0YW5jZS5uYW1lO1xyXG4gICAgICBpZiAoIGkgPCBmdW5jdGlvbkNvbnN0cnVjdG9ycy5sZW5ndGggLSAxICkge1xyXG4gICAgICAgIGFuc3dlclRleHQgKz0gJyA+ICc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHNsb3ROdW1iZXIrKztcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZXNldHMgY29udHJvbHMgdGhhdCBuZWVkIHRvIGJlIHJlc2V0IGVhY2ggdGltZSB0aGUgY2hhbGxlbmdlIGNoYW5nZXMuXHJcbiAgICB0aGlzLnJlc2V0Q2hhbGxlbmdlQ29udHJvbHMoKTtcclxuXHJcbiAgICAvLyBzaG93IHRoZSBhbnN3ZXIgZm9yIGRlYnVnZ2luZ1xyXG4gICAgdGhpcy5hbnN3ZXJOb2RlLnN0cmluZyA9IGFuc3dlclRleHQ7XHJcbiAgICB0aGlzLmFuc3dlck5vZGUuY2VudGVyWCA9IHRoaXMuYnVpbGRlck5vZGUuY2VudGVyWDtcclxuXHJcbiAgICBpZiAoIEZCUXVlcnlQYXJhbWV0ZXJzLnBvcHVsYXRlT3V0cHV0ICkge1xyXG4gICAgICB0aGlzLnBvcHVsYXRlT3V0cHV0Q2Fyb3VzZWwoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdpdmVuIGEgZnVuY3Rpb24gY29uc3RydWN0b3IsIGdldCBhIGNvcnJlc3BvbmRpbmcgRnVuY3Rpb25Ob2RlIGZyb20gdGhlIGNhcm91c2VsLlxyXG4gICAqIEBwYXJhbSB7Y29uc3RydWN0b3J9IGZ1bmN0aW9uQ29uc3RydWN0b3IgLSBjb25zdHJ1Y3RvciBmb3IgYW4gSW1hZ2VGdW5jdGlvblxyXG4gICAqIEByZXR1cm5zIHtJbWFnZUZ1bmN0aW9uTm9kZX1cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZ2V0RnVuY3Rpb25Ob2RlKCBmdW5jdGlvbkNvbnN0cnVjdG9yICkge1xyXG5cclxuICAgIC8vIGdldCB0aGUgY29udGFpbmVyIHRoYXQgaGFzIGZ1bmN0aW9ucyBvZiB0aGUgc3BlY2lmaWVkIHR5cGVcclxuICAgIGxldCBmdW5jdGlvbkNvbnRhaW5lciA9IG51bGw7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmZ1bmN0aW9uQ29udGFpbmVycy5sZW5ndGggJiYgIWZ1bmN0aW9uQ29udGFpbmVyOyBpKysgKSB7XHJcbiAgICAgIGlmICggdGhpcy5mdW5jdGlvbkNvbnRhaW5lcnNbIGkgXS5nZXRGdW5jdGlvbkNvbnN0cnVjdG9yKCkgPT09IGZ1bmN0aW9uQ29uc3RydWN0b3IgKSB7XHJcbiAgICAgICAgZnVuY3Rpb25Db250YWluZXIgPSB0aGlzLmZ1bmN0aW9uQ29udGFpbmVyc1sgaSBdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmdW5jdGlvbkNvbnRhaW5lciwgJ2Z1bmN0aW9uQ29udGFpbmVyIG5vdCBmb3VuZCcgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICFmdW5jdGlvbkNvbnRhaW5lci5pc0VtcHR5KCksICdmdW5jdGlvbkNvbnRhaW5lciBpcyBlbXB0eScgKTtcclxuXHJcbiAgICAvLyBnZXQgdGhlIGZpcnN0IGl0ZW0gaW4gdGhlIGNvbnRhaW5lclxyXG4gICAgcmV0dXJuIGZ1bmN0aW9uQ29udGFpbmVyLmdldENvbnRlbnRzKClbIDAgXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHMgYSBzZXQgb2YgcXVlc3Rpb24gbWFyayBjb2xvcnMsIGNvbnRhaW5pbmcgbm8gZHVwbGljYXRlcy5cclxuICAgKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyT2ZDb2xvcnNcclxuICAgKiBAcmV0dXJucyB7Q29sb3JbXXxzdHJpbmdbXX1cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZ2V0UXVlc3Rpb25NYXJrQ29sb3JzKCBudW1iZXJPZkNvbG9ycyApIHtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBudW1iZXJPZkNvbG9ycyA8PSBRVUVTVElPTl9NQVJLX0NPTE9SUy5sZW5ndGggKTtcclxuXHJcbiAgICBjb25zdCBjb2xvcnMgPSBbXTtcclxuICAgIHdoaWxlICggY29sb3JzLmxlbmd0aCA8IG51bWJlck9mQ29sb3JzICkge1xyXG5cclxuICAgICAgLy8gcmVtb3ZlIGZpcnN0IGNvbG9yIGZyb20gdGhlIHBvb2xcclxuICAgICAgY29uc3QgY29sb3IgPSB0aGlzLnF1ZXN0aW9uTWFya0NvbG9yc1sgMCBdO1xyXG4gICAgICB0aGlzLnF1ZXN0aW9uTWFya0NvbG9ycy5zcGxpY2UoIDAsIDEgKTtcclxuXHJcbiAgICAgIC8vIHByZXZlbnQgZHVwbGljYXRlIGNvbG9yc1xyXG4gICAgICBpZiAoIGNvbG9ycy5pbmRleE9mKCBjb2xvciApID09PSAtMSApIHtcclxuICAgICAgICBjb2xvcnMucHVzaCggY29sb3IgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gcmVwbGVuaXNoIHRoZSBjb2xvcnNcclxuICAgICAgaWYgKCB0aGlzLnF1ZXN0aW9uTWFya0NvbG9ycy5sZW5ndGggPT09IDAgKSB7XHJcbiAgICAgICAgdGhpcy5xdWVzdGlvbk1hcmtDb2xvcnMgPSBkb3RSYW5kb20uc2h1ZmZsZSggUVVFU1RJT05fTUFSS19DT0xPUlMgKTtcclxuXHJcbiAgICAgICAgLy8gcHJldmVudCBjaG9vc2luZyB0aGUgc2FtZSBjb2xvciBjb25zZWN1dGl2ZWx5XHJcbiAgICAgICAgaWYgKCB0aGlzLnF1ZXN0aW9uTWFya0NvbG9yc1sgMCBdID09PSBjb2xvciApIHtcclxuICAgICAgICAgIHRoaXMucXVlc3Rpb25NYXJrQ29sb3JzLnNwbGljZSggMCwgMSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggY29sb3JzLmxlbmd0aCA9PT0gbnVtYmVyT2ZDb2xvcnMgKTtcclxuICAgIHJldHVybiBjb2xvcnM7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbkJ1aWxkZXJCYXNpY3MucmVnaXN0ZXIoICdGQkJNeXN0ZXJ5U2NlbmVOb2RlJywgRkJCTXlzdGVyeVNjZW5lTm9kZSApO1xyXG5leHBvcnQgZGVmYXVsdCBGQkJNeXN0ZXJ5U2NlbmVOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBQ3BFLE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUFDdkQsT0FBT0MsUUFBUSxNQUFNLG9EQUFvRDtBQUN6RSxPQUFPQyxpQkFBaUIsTUFBTSw2REFBNkQ7QUFDM0YsT0FBT0MsU0FBUyxNQUFN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