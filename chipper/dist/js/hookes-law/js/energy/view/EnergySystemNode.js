// Copyright 2015-2022, University of Colorado Boulder

/**
 * EnergySystemNode is a single-spring system for the "Energy" screen.
 * It includes one spring, a robotic arm, and all representations & controls that go with them.
 * The origin is at the point where the spring attaches to the wall.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Utils from '../../../../dot/js/Utils.js';
import optionize from '../../../../phet-core/js/optionize.js';
import { Node } from '../../../../scenery/js/imports.js';
import HookesLawColors from '../../common/HookesLawColors.js';
import HookesLawConstants from '../../common/HookesLawConstants.js';
import AppliedForceVectorNode from '../../common/view/AppliedForceVectorNode.js';
import DisplacementVectorNode from '../../common/view/DisplacementVectorNode.js';
import EquilibriumPositionNode from '../../common/view/EquilibriumPositionNode.js';
import HookesLawSpringNode from '../../common/view/HookesLawSpringNode.js';
import NibNode from '../../common/view/NibNode.js';
import RoboticArmNode from '../../common/view/RoboticArmNode.js';
import WallNode from '../../common/view/WallNode.js';
import hookesLaw from '../../hookesLaw.js';
import EnergySpringControls from './EnergySpringControls.js';
export default class EnergySystemNode extends Node {
  constructor(system, viewProperties, providedOptions) {
    const options = optionize()({
      // SelfOptions
      unitDisplacementLength: 1
    }, providedOptions);
    assert && assert(options.unitDisplacementLength > 0);

    // to improve readability
    const spring = system.spring;
    const roboticArm = system.roboticArm;

    // This sim operates in 1 dimension (x), so center everything on y = 0.
    const yOrigin = 0;

    // number of interactions in progress that affect displacement
    const numberOfInteractionsInProgressProperty = new NumberProperty(0, {
      numberType: 'Integer',
      isValidValue: value => value >= 0
    });

    //------------------------------------------------
    // Scene graph

    // origin is at right-center of wall
    const wallNode = new WallNode(HookesLawConstants.WALL_SIZE, {
      right: options.unitDisplacementLength * spring.leftProperty.value,
      centerY: yOrigin
    });
    const springNode = new HookesLawSpringNode(spring, {
      frontColor: HookesLawColors.SINGLE_SPRING_FRONT,
      middleColor: HookesLawColors.SINGLE_SPRING_MIDDLE,
      backColor: HookesLawColors.SINGLE_SPRING_BACK,
      loops: HookesLawConstants.SINGLE_SPRING_LOOPS,
      unitDisplacementLength: options.unitDisplacementLength,
      // use x,y exclusively for layout, other translation options are inaccurate because we're using boundsMethod:'none'
      x: options.unitDisplacementLength * spring.leftProperty.value,
      y: yOrigin
    });

    // pincers grab this
    const nibNode = new NibNode({
      fill: HookesLawColors.SINGLE_SPRING_MIDDLE,
      // x is determined by rightSpring.leftProperty
      centerY: yOrigin
    });
    const roboticArmNode = new RoboticArmNode(roboticArm, spring.rightRangeProperty, numberOfInteractionsInProgressProperty, {
      unitDisplacementLength: options.unitDisplacementLength,
      // constrain dragging to multiples of this interval, see https://github.com/phetsims/hookes-law/issues/54
      displacementInterval: HookesLawConstants.ROBOTIC_ARM_DISPLACEMENT_INTERVAL,
      x: options.unitDisplacementLength * roboticArm.right,
      y: yOrigin,
      tandem: options.tandem.createTandem('roboticArmNode')
    });
    const equilibriumPositionNode = new EquilibriumPositionNode(wallNode.height, {
      centerX: options.unitDisplacementLength * spring.equilibriumXProperty.value,
      centerY: yOrigin,
      visibleProperty: viewProperties.equilibriumPositionVisibleProperty,
      tandem: options.tandem.createTandem('equilibriumPositionNode')
    });
    const appliedForceVectorNode = new AppliedForceVectorNode(spring.appliedForceProperty, viewProperties.valuesVisibleProperty, {
      unitLength: HookesLawConstants.ENERGY_UNIT_FORCE_X,
      // view length of a 1N force vector
      // x is determined by spring.rightProperty
      // bottom determined empirically, springNode.top is not accurate because we're using boundMethod:'none'
      bottom: springNode.y - 50,
      visibleProperty: viewProperties.appliedForceVectorVisibleProperty,
      tandem: options.tandem.createTandem('appliedForceVectorNode')
    });
    const displacementVectorNode = new DisplacementVectorNode(spring.displacementProperty, viewProperties.valuesVisibleProperty, {
      unitDisplacementLength: options.unitDisplacementLength,
      x: equilibriumPositionNode.centerX,
      // top determined empirically, springNode.bottom is not accurate because we're using boundMethod:'none'
      top: springNode.y + 50,
      visibleProperty: viewProperties.displacementVectorVisibleProperty,
      tandem: options.tandem.createTandem('displacementVectorNode')
    });
    const springControls = new EnergySpringControls(spring, numberOfInteractionsInProgressProperty, {
      centerX: wallNode.left + (roboticArmNode.right - wallNode.left) / 2,
      top: wallNode.bottom + 10,
      maxWidth: roboticArmNode.right - wallNode.left,
      // constrain width for i18n
      tandem: options.tandem.createTandem('springControls')
    });
    options.children = [equilibriumPositionNode, roboticArmNode, springNode, wallNode, nibNode, appliedForceVectorNode, displacementVectorNode, springControls];

    //------------------------------------------------
    // Property observers

    // Position the force vectors at the right end of the spring.
    spring.rightProperty.link(right => {
      appliedForceVectorNode.x = nibNode.x = options.unitDisplacementLength * right;
    });

    // Open pincers when displacement is zero and no user interactions affecting displacement are talking place.
    Multilink.multilink([numberOfInteractionsInProgressProperty, spring.displacementProperty], (numberOfInteractions, displacement) => {
      assert && assert(numberOfInteractions >= 0);
      const fixedDisplacement = Utils.toFixedNumber(displacement, HookesLawConstants.DISPLACEMENT_DECIMAL_PLACES);
      roboticArmNode.setPincersOpen(numberOfInteractions === 0 && fixedDisplacement === 0);
    });
    super(options);
  }
}
hookesLaw.register('EnergySystemNode', EnergySystemNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJOdW1iZXJQcm9wZXJ0eSIsIlV0aWxzIiwib3B0aW9uaXplIiwiTm9kZSIsIkhvb2tlc0xhd0NvbG9ycyIsIkhvb2tlc0xhd0NvbnN0YW50cyIsIkFwcGxpZWRGb3JjZVZlY3Rvck5vZGUiLCJEaXNwbGFjZW1lbnRWZWN0b3JOb2RlIiwiRXF1aWxpYnJpdW1Qb3NpdGlvbk5vZGUiLCJIb29rZXNMYXdTcHJpbmdOb2RlIiwiTmliTm9kZSIsIlJvYm90aWNBcm1Ob2RlIiwiV2FsbE5vZGUiLCJob29rZXNMYXciLCJFbmVyZ3lTcHJpbmdDb250cm9scyIsIkVuZXJneVN5c3RlbU5vZGUiLCJjb25zdHJ1Y3RvciIsInN5c3RlbSIsInZpZXdQcm9wZXJ0aWVzIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInVuaXREaXNwbGFjZW1lbnRMZW5ndGgiLCJhc3NlcnQiLCJzcHJpbmciLCJyb2JvdGljQXJtIiwieU9yaWdpbiIsIm51bWJlck9mSW50ZXJhY3Rpb25zSW5Qcm9ncmVzc1Byb3BlcnR5IiwibnVtYmVyVHlwZSIsImlzVmFsaWRWYWx1ZSIsInZhbHVlIiwid2FsbE5vZGUiLCJXQUxMX1NJWkUiLCJyaWdodCIsImxlZnRQcm9wZXJ0eSIsImNlbnRlclkiLCJzcHJpbmdOb2RlIiwiZnJvbnRDb2xvciIsIlNJTkdMRV9TUFJJTkdfRlJPTlQiLCJtaWRkbGVDb2xvciIsIlNJTkdMRV9TUFJJTkdfTUlERExFIiwiYmFja0NvbG9yIiwiU0lOR0xFX1NQUklOR19CQUNLIiwibG9vcHMiLCJTSU5HTEVfU1BSSU5HX0xPT1BTIiwieCIsInkiLCJuaWJOb2RlIiwiZmlsbCIsInJvYm90aWNBcm1Ob2RlIiwicmlnaHRSYW5nZVByb3BlcnR5IiwiZGlzcGxhY2VtZW50SW50ZXJ2YWwiLCJST0JPVElDX0FSTV9ESVNQTEFDRU1FTlRfSU5URVJWQUwiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJlcXVpbGlicml1bVBvc2l0aW9uTm9kZSIsImhlaWdodCIsImNlbnRlclgiLCJlcXVpbGlicml1bVhQcm9wZXJ0eSIsInZpc2libGVQcm9wZXJ0eSIsImVxdWlsaWJyaXVtUG9zaXRpb25WaXNpYmxlUHJvcGVydHkiLCJhcHBsaWVkRm9yY2VWZWN0b3JOb2RlIiwiYXBwbGllZEZvcmNlUHJvcGVydHkiLCJ2YWx1ZXNWaXNpYmxlUHJvcGVydHkiLCJ1bml0TGVuZ3RoIiwiRU5FUkdZX1VOSVRfRk9SQ0VfWCIsImJvdHRvbSIsImFwcGxpZWRGb3JjZVZlY3RvclZpc2libGVQcm9wZXJ0eSIsImRpc3BsYWNlbWVudFZlY3Rvck5vZGUiLCJkaXNwbGFjZW1lbnRQcm9wZXJ0eSIsInRvcCIsImRpc3BsYWNlbWVudFZlY3RvclZpc2libGVQcm9wZXJ0eSIsInNwcmluZ0NvbnRyb2xzIiwibGVmdCIsIm1heFdpZHRoIiwiY2hpbGRyZW4iLCJyaWdodFByb3BlcnR5IiwibGluayIsIm11bHRpbGluayIsIm51bWJlck9mSW50ZXJhY3Rpb25zIiwiZGlzcGxhY2VtZW50IiwiZml4ZWREaXNwbGFjZW1lbnQiLCJ0b0ZpeGVkTnVtYmVyIiwiRElTUExBQ0VNRU5UX0RFQ0lNQUxfUExBQ0VTIiwic2V0UGluY2Vyc09wZW4iLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVuZXJneVN5c3RlbU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTUtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRW5lcmd5U3lzdGVtTm9kZSBpcyBhIHNpbmdsZS1zcHJpbmcgc3lzdGVtIGZvciB0aGUgXCJFbmVyZ3lcIiBzY3JlZW4uXHJcbiAqIEl0IGluY2x1ZGVzIG9uZSBzcHJpbmcsIGEgcm9ib3RpYyBhcm0sIGFuZCBhbGwgcmVwcmVzZW50YXRpb25zICYgY29udHJvbHMgdGhhdCBnbyB3aXRoIHRoZW0uXHJcbiAqIFRoZSBvcmlnaW4gaXMgYXQgdGhlIHBvaW50IHdoZXJlIHRoZSBzcHJpbmcgYXR0YWNoZXMgdG8gdGhlIHdhbGwuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBOdW1iZXJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL051bWJlclByb3BlcnR5LmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIE5vZGVPcHRpb25zLCBOb2RlVHJhbnNsYXRpb25PcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IEhvb2tlc0xhd0NvbG9ycyBmcm9tICcuLi8uLi9jb21tb24vSG9va2VzTGF3Q29sb3JzLmpzJztcclxuaW1wb3J0IEhvb2tlc0xhd0NvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vSG9va2VzTGF3Q29uc3RhbnRzLmpzJztcclxuaW1wb3J0IFNpbmdsZVNwcmluZ1N5c3RlbSBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvU2luZ2xlU3ByaW5nU3lzdGVtLmpzJztcclxuaW1wb3J0IEFwcGxpZWRGb3JjZVZlY3Rvck5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvQXBwbGllZEZvcmNlVmVjdG9yTm9kZS5qcyc7XHJcbmltcG9ydCBEaXNwbGFjZW1lbnRWZWN0b3JOb2RlIGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L0Rpc3BsYWNlbWVudFZlY3Rvck5vZGUuanMnO1xyXG5pbXBvcnQgRXF1aWxpYnJpdW1Qb3NpdGlvbk5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvRXF1aWxpYnJpdW1Qb3NpdGlvbk5vZGUuanMnO1xyXG5pbXBvcnQgSG9va2VzTGF3U3ByaW5nTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9Ib29rZXNMYXdTcHJpbmdOb2RlLmpzJztcclxuaW1wb3J0IE5pYk5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvTmliTm9kZS5qcyc7XHJcbmltcG9ydCBSb2JvdGljQXJtTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9Sb2JvdGljQXJtTm9kZS5qcyc7XHJcbmltcG9ydCBXYWxsTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9XYWxsTm9kZS5qcyc7XHJcbmltcG9ydCBob29rZXNMYXcgZnJvbSAnLi4vLi4vaG9va2VzTGF3LmpzJztcclxuaW1wb3J0IEVuZXJneVNwcmluZ0NvbnRyb2xzIGZyb20gJy4vRW5lcmd5U3ByaW5nQ29udHJvbHMuanMnO1xyXG5pbXBvcnQgRW5lcmd5Vmlld1Byb3BlcnRpZXMgZnJvbSAnLi9FbmVyZ3lWaWV3UHJvcGVydGllcy5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIHVuaXREaXNwbGFjZW1lbnRMZW5ndGg/OiBudW1iZXI7IC8vIHZpZXcgbGVuZ3RoIG9mIDEgbWV0ZXIgb2YgZGlzcGxhY2VtZW50XHJcbn07XHJcblxyXG50eXBlIEVuZXJneVN5c3RlbU5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBOb2RlVHJhbnNsYXRpb25PcHRpb25zICYgUGlja1JlcXVpcmVkPE5vZGVPcHRpb25zLCAndGFuZGVtJz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFbmVyZ3lTeXN0ZW1Ob2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvciggc3lzdGVtOiBTaW5nbGVTcHJpbmdTeXN0ZW0sIHZpZXdQcm9wZXJ0aWVzOiBFbmVyZ3lWaWV3UHJvcGVydGllcywgcHJvdmlkZWRPcHRpb25zOiBFbmVyZ3lTeXN0ZW1Ob2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEVuZXJneVN5c3RlbU5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIHVuaXREaXNwbGFjZW1lbnRMZW5ndGg6IDFcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIG9wdGlvbnMudW5pdERpc3BsYWNlbWVudExlbmd0aCA+IDAgKTtcclxuXHJcbiAgICAvLyB0byBpbXByb3ZlIHJlYWRhYmlsaXR5XHJcbiAgICBjb25zdCBzcHJpbmcgPSBzeXN0ZW0uc3ByaW5nO1xyXG4gICAgY29uc3Qgcm9ib3RpY0FybSA9IHN5c3RlbS5yb2JvdGljQXJtO1xyXG5cclxuICAgIC8vIFRoaXMgc2ltIG9wZXJhdGVzIGluIDEgZGltZW5zaW9uICh4KSwgc28gY2VudGVyIGV2ZXJ5dGhpbmcgb24geSA9IDAuXHJcbiAgICBjb25zdCB5T3JpZ2luID0gMDtcclxuXHJcbiAgICAvLyBudW1iZXIgb2YgaW50ZXJhY3Rpb25zIGluIHByb2dyZXNzIHRoYXQgYWZmZWN0IGRpc3BsYWNlbWVudFxyXG4gICAgY29uc3QgbnVtYmVyT2ZJbnRlcmFjdGlvbnNJblByb2dyZXNzUHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIDAsIHtcclxuICAgICAgbnVtYmVyVHlwZTogJ0ludGVnZXInLFxyXG4gICAgICBpc1ZhbGlkVmFsdWU6IHZhbHVlID0+ICggdmFsdWUgPj0gMCApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIC8vIFNjZW5lIGdyYXBoXHJcblxyXG4gICAgLy8gb3JpZ2luIGlzIGF0IHJpZ2h0LWNlbnRlciBvZiB3YWxsXHJcbiAgICBjb25zdCB3YWxsTm9kZSA9IG5ldyBXYWxsTm9kZSggSG9va2VzTGF3Q29uc3RhbnRzLldBTExfU0laRSwge1xyXG4gICAgICByaWdodDogb3B0aW9ucy51bml0RGlzcGxhY2VtZW50TGVuZ3RoICogc3ByaW5nLmxlZnRQcm9wZXJ0eS52YWx1ZSxcclxuICAgICAgY2VudGVyWTogeU9yaWdpblxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHNwcmluZ05vZGUgPSBuZXcgSG9va2VzTGF3U3ByaW5nTm9kZSggc3ByaW5nLCB7XHJcbiAgICAgIGZyb250Q29sb3I6IEhvb2tlc0xhd0NvbG9ycy5TSU5HTEVfU1BSSU5HX0ZST05ULFxyXG4gICAgICBtaWRkbGVDb2xvcjogSG9va2VzTGF3Q29sb3JzLlNJTkdMRV9TUFJJTkdfTUlERExFLFxyXG4gICAgICBiYWNrQ29sb3I6IEhvb2tlc0xhd0NvbG9ycy5TSU5HTEVfU1BSSU5HX0JBQ0ssXHJcbiAgICAgIGxvb3BzOiBIb29rZXNMYXdDb25zdGFudHMuU0lOR0xFX1NQUklOR19MT09QUyxcclxuICAgICAgdW5pdERpc3BsYWNlbWVudExlbmd0aDogb3B0aW9ucy51bml0RGlzcGxhY2VtZW50TGVuZ3RoLFxyXG4gICAgICAvLyB1c2UgeCx5IGV4Y2x1c2l2ZWx5IGZvciBsYXlvdXQsIG90aGVyIHRyYW5zbGF0aW9uIG9wdGlvbnMgYXJlIGluYWNjdXJhdGUgYmVjYXVzZSB3ZSdyZSB1c2luZyBib3VuZHNNZXRob2Q6J25vbmUnXHJcbiAgICAgIHg6IG9wdGlvbnMudW5pdERpc3BsYWNlbWVudExlbmd0aCAqIHNwcmluZy5sZWZ0UHJvcGVydHkudmFsdWUsXHJcbiAgICAgIHk6IHlPcmlnaW5cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBwaW5jZXJzIGdyYWIgdGhpc1xyXG4gICAgY29uc3QgbmliTm9kZSA9IG5ldyBOaWJOb2RlKCB7XHJcbiAgICAgIGZpbGw6IEhvb2tlc0xhd0NvbG9ycy5TSU5HTEVfU1BSSU5HX01JRERMRSxcclxuICAgICAgLy8geCBpcyBkZXRlcm1pbmVkIGJ5IHJpZ2h0U3ByaW5nLmxlZnRQcm9wZXJ0eVxyXG4gICAgICBjZW50ZXJZOiB5T3JpZ2luXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgcm9ib3RpY0FybU5vZGUgPSBuZXcgUm9ib3RpY0FybU5vZGUoIHJvYm90aWNBcm0sIHNwcmluZy5yaWdodFJhbmdlUHJvcGVydHksIG51bWJlck9mSW50ZXJhY3Rpb25zSW5Qcm9ncmVzc1Byb3BlcnR5LCB7XHJcbiAgICAgIHVuaXREaXNwbGFjZW1lbnRMZW5ndGg6IG9wdGlvbnMudW5pdERpc3BsYWNlbWVudExlbmd0aCxcclxuXHJcbiAgICAgIC8vIGNvbnN0cmFpbiBkcmFnZ2luZyB0byBtdWx0aXBsZXMgb2YgdGhpcyBpbnRlcnZhbCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9ob29rZXMtbGF3L2lzc3Vlcy81NFxyXG4gICAgICBkaXNwbGFjZW1lbnRJbnRlcnZhbDogSG9va2VzTGF3Q29uc3RhbnRzLlJPQk9USUNfQVJNX0RJU1BMQUNFTUVOVF9JTlRFUlZBTCxcclxuICAgICAgeDogb3B0aW9ucy51bml0RGlzcGxhY2VtZW50TGVuZ3RoICogcm9ib3RpY0FybS5yaWdodCxcclxuICAgICAgeTogeU9yaWdpbixcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdyb2JvdGljQXJtTm9kZScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGVxdWlsaWJyaXVtUG9zaXRpb25Ob2RlID0gbmV3IEVxdWlsaWJyaXVtUG9zaXRpb25Ob2RlKCB3YWxsTm9kZS5oZWlnaHQsIHtcclxuICAgICAgY2VudGVyWDogb3B0aW9ucy51bml0RGlzcGxhY2VtZW50TGVuZ3RoICogc3ByaW5nLmVxdWlsaWJyaXVtWFByb3BlcnR5LnZhbHVlLFxyXG4gICAgICBjZW50ZXJZOiB5T3JpZ2luLFxyXG4gICAgICB2aXNpYmxlUHJvcGVydHk6IHZpZXdQcm9wZXJ0aWVzLmVxdWlsaWJyaXVtUG9zaXRpb25WaXNpYmxlUHJvcGVydHksXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZXF1aWxpYnJpdW1Qb3NpdGlvbk5vZGUnIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBhcHBsaWVkRm9yY2VWZWN0b3JOb2RlID0gbmV3IEFwcGxpZWRGb3JjZVZlY3Rvck5vZGUoXHJcbiAgICAgIHNwcmluZy5hcHBsaWVkRm9yY2VQcm9wZXJ0eSwgdmlld1Byb3BlcnRpZXMudmFsdWVzVmlzaWJsZVByb3BlcnR5LCB7XHJcbiAgICAgICAgdW5pdExlbmd0aDogSG9va2VzTGF3Q29uc3RhbnRzLkVORVJHWV9VTklUX0ZPUkNFX1gsIC8vIHZpZXcgbGVuZ3RoIG9mIGEgMU4gZm9yY2UgdmVjdG9yXHJcbiAgICAgICAgLy8geCBpcyBkZXRlcm1pbmVkIGJ5IHNwcmluZy5yaWdodFByb3BlcnR5XHJcbiAgICAgICAgLy8gYm90dG9tIGRldGVybWluZWQgZW1waXJpY2FsbHksIHNwcmluZ05vZGUudG9wIGlzIG5vdCBhY2N1cmF0ZSBiZWNhdXNlIHdlJ3JlIHVzaW5nIGJvdW5kTWV0aG9kOidub25lJ1xyXG4gICAgICAgIGJvdHRvbTogc3ByaW5nTm9kZS55IC0gNTAsXHJcbiAgICAgICAgdmlzaWJsZVByb3BlcnR5OiB2aWV3UHJvcGVydGllcy5hcHBsaWVkRm9yY2VWZWN0b3JWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdhcHBsaWVkRm9yY2VWZWN0b3JOb2RlJyApXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBkaXNwbGFjZW1lbnRWZWN0b3JOb2RlID0gbmV3IERpc3BsYWNlbWVudFZlY3Rvck5vZGUoXHJcbiAgICAgIHNwcmluZy5kaXNwbGFjZW1lbnRQcm9wZXJ0eSwgdmlld1Byb3BlcnRpZXMudmFsdWVzVmlzaWJsZVByb3BlcnR5LCB7XHJcbiAgICAgICAgdW5pdERpc3BsYWNlbWVudExlbmd0aDogb3B0aW9ucy51bml0RGlzcGxhY2VtZW50TGVuZ3RoLFxyXG4gICAgICAgIHg6IGVxdWlsaWJyaXVtUG9zaXRpb25Ob2RlLmNlbnRlclgsXHJcbiAgICAgICAgLy8gdG9wIGRldGVybWluZWQgZW1waXJpY2FsbHksIHNwcmluZ05vZGUuYm90dG9tIGlzIG5vdCBhY2N1cmF0ZSBiZWNhdXNlIHdlJ3JlIHVzaW5nIGJvdW5kTWV0aG9kOidub25lJ1xyXG4gICAgICAgIHRvcDogc3ByaW5nTm9kZS55ICsgNTAsXHJcbiAgICAgICAgdmlzaWJsZVByb3BlcnR5OiB2aWV3UHJvcGVydGllcy5kaXNwbGFjZW1lbnRWZWN0b3JWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkaXNwbGFjZW1lbnRWZWN0b3JOb2RlJyApXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBzcHJpbmdDb250cm9scyA9IG5ldyBFbmVyZ3lTcHJpbmdDb250cm9scyggc3ByaW5nLCBudW1iZXJPZkludGVyYWN0aW9uc0luUHJvZ3Jlc3NQcm9wZXJ0eSwge1xyXG4gICAgICBjZW50ZXJYOiB3YWxsTm9kZS5sZWZ0ICsgKCByb2JvdGljQXJtTm9kZS5yaWdodCAtIHdhbGxOb2RlLmxlZnQgKSAvIDIsXHJcbiAgICAgIHRvcDogd2FsbE5vZGUuYm90dG9tICsgMTAsXHJcbiAgICAgIG1heFdpZHRoOiByb2JvdGljQXJtTm9kZS5yaWdodCAtIHdhbGxOb2RlLmxlZnQsIC8vIGNvbnN0cmFpbiB3aWR0aCBmb3IgaTE4blxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3NwcmluZ0NvbnRyb2xzJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgb3B0aW9ucy5jaGlsZHJlbiA9IFtcclxuICAgICAgZXF1aWxpYnJpdW1Qb3NpdGlvbk5vZGUsIHJvYm90aWNBcm1Ob2RlLCBzcHJpbmdOb2RlLCB3YWxsTm9kZSwgbmliTm9kZSxcclxuICAgICAgYXBwbGllZEZvcmNlVmVjdG9yTm9kZSwgZGlzcGxhY2VtZW50VmVjdG9yTm9kZSxcclxuICAgICAgc3ByaW5nQ29udHJvbHNcclxuICAgIF07XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIC8vIFByb3BlcnR5IG9ic2VydmVyc1xyXG5cclxuICAgIC8vIFBvc2l0aW9uIHRoZSBmb3JjZSB2ZWN0b3JzIGF0IHRoZSByaWdodCBlbmQgb2YgdGhlIHNwcmluZy5cclxuICAgIHNwcmluZy5yaWdodFByb3BlcnR5LmxpbmsoIHJpZ2h0ID0+IHtcclxuICAgICAgYXBwbGllZEZvcmNlVmVjdG9yTm9kZS54ID0gbmliTm9kZS54ID0gKCBvcHRpb25zLnVuaXREaXNwbGFjZW1lbnRMZW5ndGggKiByaWdodCApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE9wZW4gcGluY2VycyB3aGVuIGRpc3BsYWNlbWVudCBpcyB6ZXJvIGFuZCBubyB1c2VyIGludGVyYWN0aW9ucyBhZmZlY3RpbmcgZGlzcGxhY2VtZW50IGFyZSB0YWxraW5nIHBsYWNlLlxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBudW1iZXJPZkludGVyYWN0aW9uc0luUHJvZ3Jlc3NQcm9wZXJ0eSwgc3ByaW5nLmRpc3BsYWNlbWVudFByb3BlcnR5IF0sXHJcbiAgICAgICggbnVtYmVyT2ZJbnRlcmFjdGlvbnMsIGRpc3BsYWNlbWVudCApID0+IHtcclxuICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBudW1iZXJPZkludGVyYWN0aW9ucyA+PSAwICk7XHJcbiAgICAgICAgY29uc3QgZml4ZWREaXNwbGFjZW1lbnQgPSBVdGlscy50b0ZpeGVkTnVtYmVyKCBkaXNwbGFjZW1lbnQsIEhvb2tlc0xhd0NvbnN0YW50cy5ESVNQTEFDRU1FTlRfREVDSU1BTF9QTEFDRVMgKTtcclxuICAgICAgICByb2JvdGljQXJtTm9kZS5zZXRQaW5jZXJzT3BlbiggbnVtYmVyT2ZJbnRlcmFjdGlvbnMgPT09IDAgJiYgZml4ZWREaXNwbGFjZW1lbnQgPT09IDAgKTtcclxuICAgICAgfSApO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcbiAgfVxyXG59XHJcblxyXG5ob29rZXNMYXcucmVnaXN0ZXIoICdFbmVyZ3lTeXN0ZW1Ob2RlJywgRW5lcmd5U3lzdGVtTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBQ2xFLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQUU3RCxTQUFTQyxJQUFJLFFBQTZDLG1DQUFtQztBQUM3RixPQUFPQyxlQUFlLE1BQU0saUNBQWlDO0FBQzdELE9BQU9DLGtCQUFrQixNQUFNLG9DQUFvQztBQUVuRSxPQUFPQyxzQkFBc0IsTUFBTSw2Q0FBNkM7QUFDaEYsT0FBT0Msc0JBQXNCLE1BQU0sNkNBQTZDO0FBQ2hGLE9BQU9DLHVCQUF1QixNQUFNLDhDQUE4QztBQUNsRixPQUFPQyxtQkFBbUIsTUFBTSwwQ0FBMEM7QUFDMUUsT0FBT0MsT0FBTyxNQUFNLDhCQUE4QjtBQUNsRCxPQUFPQyxjQUFjLE1BQU0scUNBQXFDO0FBQ2hFLE9BQU9DLFFBQVEsTUFBTSwrQkFBK0I7QUFDcEQsT0FBT0MsU0FBUyxNQUFNLG9CQUFvQjtBQUMxQyxPQUFPQyxvQkFBb0IsTUFBTSwyQkFBMkI7QUFTNUQsZUFBZSxNQUFNQyxnQkFBZ0IsU0FBU1osSUFBSSxDQUFDO0VBRTFDYSxXQUFXQSxDQUFFQyxNQUEwQixFQUFFQyxjQUFvQyxFQUFFQyxlQUF3QyxFQUFHO0lBRS9ILE1BQU1DLE9BQU8sR0FBR2xCLFNBQVMsQ0FBb0QsQ0FBQyxDQUFFO01BRTlFO01BQ0FtQixzQkFBc0IsRUFBRTtJQUMxQixD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