// Copyright 2014-2023, University of Colorado Boulder

/**
 * Model representation of a particle.
 *
 * @author John Blanco
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import Emitter from '../../../axon/js/Emitter.js';
import NumberProperty from '../../../axon/js/NumberProperty.js';
import StringProperty from '../../../axon/js/StringProperty.js';
import Range from '../../../dot/js/Range.js';
import Vector2 from '../../../dot/js/Vector2.js';
import Vector2Property from '../../../dot/js/Vector2Property.js';
import merge from '../../../phet-core/js/merge.js';
import PhetioObject from '../../../tandem/js/PhetioObject.js';
import Tandem from '../../../tandem/js/Tandem.js';
import IOType from '../../../tandem/js/types/IOType.js';
import ReferenceIO from '../../../tandem/js/types/ReferenceIO.js';
import shred from '../shred.js';
import ShredConstants from '../ShredConstants.js';

// Incremented for Particle IDs
let nextParticleId = 1;

// constants
const DEFAULT_PARTICLE_VELOCITY = 200; // Basically in pixels/sec.

class Particle extends PhetioObject {
  /**
   * @param {string} type
   * @param {Object} [options]
   */
  constructor(type, options) {
    options = merge({
      inputEnabled: true,
      nucleonRadius: ShredConstants.NUCLEON_RADIUS,
      maxZLayer: Number.POSITIVE_INFINITY,
      // for phet-io, can take on values 0-maxZLayer (inclusive)
      phetioType: Particle.ParticleIO,
      phetioState: false,
      tandem: Tandem.REQUIRED
    }, options);
    super(options);

    // @public (read-only) - IDs needed for map-like lookup
    this.id = nextParticleId++;

    // TODO: investigate getting rid of this and using userControlledProperty
    // @public - Fires when the user stops dragging a particle.
    this.dragEndedEmitter = new Emitter({
      parameters: [{
        valueType: Particle
      }]
    });

    // @public - Fires when the particle reaches its destination via animation in step
    this.animationEndedEmitter = new Emitter();

    // @public (read-only)
    this.typeProperty = new StringProperty(type);

    // @public (read-only)
    this.inputEnabledProperty = new BooleanProperty(options.inputEnabled);

    // @public - keep track of the index in the nucleonColorChange gradient
    // the default is 4 since there are 5 colors in the color gradient array. See the NUCLEON_COLOR_GRADIENT array in ParticleNode.js.
    this.colorGradientIndexNumberProperty = new NumberProperty(4);

    // @public
    this.positionProperty = new Vector2Property(Vector2.ZERO, {
      valueComparisonStrategy: 'equalsFunction',
      tandem: options.tandem && options.tandem.createTandem('positionProperty')
    });

    // @public
    this.destinationProperty = new Vector2Property(Vector2.ZERO, {
      valueComparisonStrategy: 'equalsFunction',
      tandem: options.tandem && options.tandem.createTandem('destinationProperty')
    });

    // @public
    this.radiusProperty = new NumberProperty(type === 'electron' || type === 'positron' ? ShredConstants.ELECTRON_RADIUS : options.nucleonRadius, {
      tandem: options.tandem && options.tandem.createTandem('radiusProperty'),
      phetioDocumentation: 'The radius of the particle.  Changes to radius may not be reflected in view.'
    });

    // @public
    this.animationVelocityProperty = new NumberProperty(DEFAULT_PARTICLE_VELOCITY, {
      tandem: options.tandem && options.tandem.createTandem('animationVelocityProperty'),
      range: new Range(0, 10 * DEFAULT_PARTICLE_VELOCITY),
      // limited for the PhET-iO Studio wrapper, code can handle any value
      units: 'view-coordinates/s'
    });

    // @public
    this.userControlledProperty = new BooleanProperty(false, {
      tandem: options.tandem && options.tandem.createTandem('userControlledProperty')
    });

    // @public Used in view, integer value, higher means further back.
    this.zLayerProperty = new NumberProperty(0, {
      isValidValue: function (value) {
        return value >= 0 && value <= options.maxZLayer;
      },
      tandem: options.tandem && options.tandem.createTandem('zLayerProperty'),
      numberType: 'Integer',
      range: new Range(0, options.maxZLayer)
    });

    // @private
    this.disposeParticle = () => {
      this.typeProperty.dispose();
      this.colorGradientIndexNumberProperty.dispose();
      this.positionProperty.dispose();
      this.destinationProperty.dispose();
      this.radiusProperty.dispose();
      this.animationVelocityProperty.dispose();
      this.userControlledProperty.dispose();
      this.zLayerProperty.dispose();
    };
  }

  /**
   * @public
   * @override
   */
  dispose() {
    this.disposeParticle();
    super.dispose();
  }

  /**
   * @param {number} dt
   * @public
   */
  step(dt) {
    if (!this.userControlledProperty.get()) {
      const position = this.positionProperty.get();
      const destination = this.destinationProperty.get();
      const velocity = this.animationVelocityProperty.get();
      const distanceToDestination = position.distance(destination);
      if (distanceToDestination > dt * velocity) {
        // This was broken up into individual steps in an attempt to solve an issue where complex vector operations
        // sometimes didn't work.
        const stepMagnitude = velocity * dt;
        const stepAngle = Math.atan2(destination.y - position.y, destination.x - position.x);
        const stepVector = Vector2.createPolar(stepMagnitude, stepAngle);

        // Move a step toward the destination.
        this.positionProperty.set(position.plus(stepVector));
      } else if (distanceToDestination > 0) {
        // Less than one time step away, so just go to the destination.
        this.moveImmediatelyToDestination();
        this.animationEndedEmitter.emit();
      }
    }
  }
  get type() {
    return this.typeProperty.value;
  }

  // @public
  moveImmediatelyToDestination() {
    this.positionProperty.set(this.destinationProperty.get());
  }

  /**
   * @param {Vector2} newPosition
   * @public
   */
  setPositionAndDestination(newPosition) {
    assert && assert(newPosition instanceof Vector2, 'Attempt to set non-vector position.');
    if (newPosition instanceof Vector2) {
      this.destinationProperty.set(newPosition);
      this.moveImmediatelyToDestination();
    }
  }
}

// @public
Particle.MAX_LAYERS = 5;
Particle.ParticleIO = new IOType('ParticleIO', {
  valueType: Particle,
  documentation: 'The model for a single particle such as an electron, proton, or neutron.',
  supertype: ReferenceIO(IOType.ObjectIO)
});
shred.register('Particle', Particle);
export default Particle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJFbWl0dGVyIiwiTnVtYmVyUHJvcGVydHkiLCJTdHJpbmdQcm9wZXJ0eSIsIlJhbmdlIiwiVmVjdG9yMiIsIlZlY3RvcjJQcm9wZXJ0eSIsIm1lcmdlIiwiUGhldGlvT2JqZWN0IiwiVGFuZGVtIiwiSU9UeXBlIiwiUmVmZXJlbmNlSU8iLCJzaHJlZCIsIlNocmVkQ29uc3RhbnRzIiwibmV4dFBhcnRpY2xlSWQiLCJERUZBVUxUX1BBUlRJQ0xFX1ZFTE9DSVRZIiwiUGFydGljbGUiLCJjb25zdHJ1Y3RvciIsInR5cGUiLCJvcHRpb25zIiwiaW5wdXRFbmFibGVkIiwibnVjbGVvblJhZGl1cyIsIk5VQ0xFT05fUkFESVVTIiwibWF4WkxheWVyIiwiTnVtYmVyIiwiUE9TSVRJVkVfSU5GSU5JVFkiLCJwaGV0aW9UeXBlIiwiUGFydGljbGVJTyIsInBoZXRpb1N0YXRlIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJpZCIsImRyYWdFbmRlZEVtaXR0ZXIiLCJwYXJhbWV0ZXJzIiwidmFsdWVUeXBlIiwiYW5pbWF0aW9uRW5kZWRFbWl0dGVyIiwidHlwZVByb3BlcnR5IiwiaW5wdXRFbmFibGVkUHJvcGVydHkiLCJjb2xvckdyYWRpZW50SW5kZXhOdW1iZXJQcm9wZXJ0eSIsInBvc2l0aW9uUHJvcGVydHkiLCJaRVJPIiwidmFsdWVDb21wYXJpc29uU3RyYXRlZ3kiLCJjcmVhdGVUYW5kZW0iLCJkZXN0aW5hdGlvblByb3BlcnR5IiwicmFkaXVzUHJvcGVydHkiLCJFTEVDVFJPTl9SQURJVVMiLCJwaGV0aW9Eb2N1bWVudGF0aW9uIiwiYW5pbWF0aW9uVmVsb2NpdHlQcm9wZXJ0eSIsInJhbmdlIiwidW5pdHMiLCJ1c2VyQ29udHJvbGxlZFByb3BlcnR5IiwiekxheWVyUHJvcGVydHkiLCJpc1ZhbGlkVmFsdWUiLCJ2YWx1ZSIsIm51bWJlclR5cGUiLCJkaXNwb3NlUGFydGljbGUiLCJkaXNwb3NlIiwic3RlcCIsImR0IiwiZ2V0IiwicG9zaXRpb24iLCJkZXN0aW5hdGlvbiIsInZlbG9jaXR5IiwiZGlzdGFuY2VUb0Rlc3RpbmF0aW9uIiwiZGlzdGFuY2UiLCJzdGVwTWFnbml0dWRlIiwic3RlcEFuZ2xlIiwiTWF0aCIsImF0YW4yIiwieSIsIngiLCJzdGVwVmVjdG9yIiwiY3JlYXRlUG9sYXIiLCJzZXQiLCJwbHVzIiwibW92ZUltbWVkaWF0ZWx5VG9EZXN0aW5hdGlvbiIsImVtaXQiLCJzZXRQb3NpdGlvbkFuZERlc3RpbmF0aW9uIiwibmV3UG9zaXRpb24iLCJhc3NlcnQiLCJNQVhfTEFZRVJTIiwiZG9jdW1lbnRhdGlvbiIsInN1cGVydHlwZSIsIk9iamVjdElPIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQYXJ0aWNsZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNb2RlbCByZXByZXNlbnRhdGlvbiBvZiBhIHBhcnRpY2xlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBOdW1iZXJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL051bWJlclByb3BlcnR5LmpzJztcclxuaW1wb3J0IFN0cmluZ1Byb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvU3RyaW5nUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMlByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFBoZXRpb09iamVjdCBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvUGhldGlvT2JqZWN0LmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IElPVHlwZSBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvSU9UeXBlLmpzJztcclxuaW1wb3J0IFJlZmVyZW5jZUlPIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9SZWZlcmVuY2VJTy5qcyc7XHJcbmltcG9ydCBzaHJlZCBmcm9tICcuLi9zaHJlZC5qcyc7XHJcbmltcG9ydCBTaHJlZENvbnN0YW50cyBmcm9tICcuLi9TaHJlZENvbnN0YW50cy5qcyc7XHJcblxyXG4vLyBJbmNyZW1lbnRlZCBmb3IgUGFydGljbGUgSURzXHJcbmxldCBuZXh0UGFydGljbGVJZCA9IDE7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgREVGQVVMVF9QQVJUSUNMRV9WRUxPQ0lUWSA9IDIwMDsgLy8gQmFzaWNhbGx5IGluIHBpeGVscy9zZWMuXHJcblxyXG5jbGFzcyBQYXJ0aWNsZSBleHRlbmRzIFBoZXRpb09iamVjdCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCB0eXBlLCBvcHRpb25zICkge1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBpbnB1dEVuYWJsZWQ6IHRydWUsXHJcbiAgICAgIG51Y2xlb25SYWRpdXM6IFNocmVkQ29uc3RhbnRzLk5VQ0xFT05fUkFESVVTLFxyXG4gICAgICBtYXhaTGF5ZXI6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwgLy8gZm9yIHBoZXQtaW8sIGNhbiB0YWtlIG9uIHZhbHVlcyAwLW1heFpMYXllciAoaW5jbHVzaXZlKVxyXG4gICAgICBwaGV0aW9UeXBlOiBQYXJ0aWNsZS5QYXJ0aWNsZUlPLFxyXG4gICAgICBwaGV0aW9TdGF0ZTogZmFsc2UsXHJcbiAgICAgIHRhbmRlbTogVGFuZGVtLlJFUVVJUkVEXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIC0gSURzIG5lZWRlZCBmb3IgbWFwLWxpa2UgbG9va3VwXHJcbiAgICB0aGlzLmlkID0gbmV4dFBhcnRpY2xlSWQrKztcclxuXHJcbiAgICAvLyBUT0RPOiBpbnZlc3RpZ2F0ZSBnZXR0aW5nIHJpZCBvZiB0aGlzIGFuZCB1c2luZyB1c2VyQ29udHJvbGxlZFByb3BlcnR5XHJcbiAgICAvLyBAcHVibGljIC0gRmlyZXMgd2hlbiB0aGUgdXNlciBzdG9wcyBkcmFnZ2luZyBhIHBhcnRpY2xlLlxyXG4gICAgdGhpcy5kcmFnRW5kZWRFbWl0dGVyID0gbmV3IEVtaXR0ZXIoIHsgcGFyYW1ldGVyczogWyB7IHZhbHVlVHlwZTogUGFydGljbGUgfSBdIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIC0gRmlyZXMgd2hlbiB0aGUgcGFydGljbGUgcmVhY2hlcyBpdHMgZGVzdGluYXRpb24gdmlhIGFuaW1hdGlvbiBpbiBzdGVwXHJcbiAgICB0aGlzLmFuaW1hdGlvbkVuZGVkRW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KVxyXG4gICAgdGhpcy50eXBlUHJvcGVydHkgPSBuZXcgU3RyaW5nUHJvcGVydHkoIHR5cGUgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpXHJcbiAgICB0aGlzLmlucHV0RW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggb3B0aW9ucy5pbnB1dEVuYWJsZWQgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIC0ga2VlcCB0cmFjayBvZiB0aGUgaW5kZXggaW4gdGhlIG51Y2xlb25Db2xvckNoYW5nZSBncmFkaWVudFxyXG4gICAgLy8gdGhlIGRlZmF1bHQgaXMgNCBzaW5jZSB0aGVyZSBhcmUgNSBjb2xvcnMgaW4gdGhlIGNvbG9yIGdyYWRpZW50IGFycmF5LiBTZWUgdGhlIE5VQ0xFT05fQ09MT1JfR1JBRElFTlQgYXJyYXkgaW4gUGFydGljbGVOb2RlLmpzLlxyXG4gICAgdGhpcy5jb2xvckdyYWRpZW50SW5kZXhOdW1iZXJQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggNCApO1xyXG5cclxuICAgIC8vIEBwdWJsaWNcclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBWZWN0b3IyUHJvcGVydHkoIFZlY3RvcjIuWkVSTywge1xyXG4gICAgICB2YWx1ZUNvbXBhcmlzb25TdHJhdGVneTogJ2VxdWFsc0Z1bmN0aW9uJyxcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbSAmJiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdwb3NpdGlvblByb3BlcnR5JyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHB1YmxpY1xyXG4gICAgdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5ID0gbmV3IFZlY3RvcjJQcm9wZXJ0eSggVmVjdG9yMi5aRVJPLCB7XHJcbiAgICAgIHZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5OiAnZXF1YWxzRnVuY3Rpb24nLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtICYmIG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2Rlc3RpbmF0aW9uUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljXHJcbiAgICB0aGlzLnJhZGl1c1Byb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCB0eXBlID09PSAnZWxlY3Ryb24nIHx8IHR5cGUgPT09ICdwb3NpdHJvbicgPyBTaHJlZENvbnN0YW50cy5FTEVDVFJPTl9SQURJVVMgOiBvcHRpb25zLm51Y2xlb25SYWRpdXMsIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbSAmJiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdyYWRpdXNQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ1RoZSByYWRpdXMgb2YgdGhlIHBhcnRpY2xlLiAgQ2hhbmdlcyB0byByYWRpdXMgbWF5IG5vdCBiZSByZWZsZWN0ZWQgaW4gdmlldy4nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHB1YmxpY1xyXG4gICAgdGhpcy5hbmltYXRpb25WZWxvY2l0eVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBERUZBVUxUX1BBUlRJQ0xFX1ZFTE9DSVRZLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0gJiYgb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnYW5pbWF0aW9uVmVsb2NpdHlQcm9wZXJ0eScgKSxcclxuICAgICAgcmFuZ2U6IG5ldyBSYW5nZSggMCwgMTAgKiBERUZBVUxUX1BBUlRJQ0xFX1ZFTE9DSVRZICksIC8vIGxpbWl0ZWQgZm9yIHRoZSBQaEVULWlPIFN0dWRpbyB3cmFwcGVyLCBjb2RlIGNhbiBoYW5kbGUgYW55IHZhbHVlXHJcbiAgICAgIHVuaXRzOiAndmlldy1jb29yZGluYXRlcy9zJ1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWNcclxuICAgIHRoaXMudXNlckNvbnRyb2xsZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0gJiYgb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndXNlckNvbnRyb2xsZWRQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgVXNlZCBpbiB2aWV3LCBpbnRlZ2VyIHZhbHVlLCBoaWdoZXIgbWVhbnMgZnVydGhlciBiYWNrLlxyXG4gICAgdGhpcy56TGF5ZXJQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggMCwge1xyXG4gICAgICBpc1ZhbGlkVmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSBvcHRpb25zLm1heFpMYXllcjtcclxuICAgICAgfSxcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbSAmJiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICd6TGF5ZXJQcm9wZXJ0eScgKSxcclxuICAgICAgbnVtYmVyVHlwZTogJ0ludGVnZXInLFxyXG4gICAgICByYW5nZTogbmV3IFJhbmdlKCAwLCBvcHRpb25zLm1heFpMYXllciApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuZGlzcG9zZVBhcnRpY2xlID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLnR5cGVQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICAgIHRoaXMuY29sb3JHcmFkaWVudEluZGV4TnVtYmVyUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICB0aGlzLmRlc3RpbmF0aW9uUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICB0aGlzLnJhZGl1c1Byb3BlcnR5LmRpc3Bvc2UoKTtcclxuICAgICAgdGhpcy5hbmltYXRpb25WZWxvY2l0eVByb3BlcnR5LmRpc3Bvc2UoKTtcclxuICAgICAgdGhpcy51c2VyQ29udHJvbGxlZFByb3BlcnR5LmRpc3Bvc2UoKTtcclxuICAgICAgdGhpcy56TGF5ZXJQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2VQYXJ0aWNsZSgpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGR0ICkge1xyXG4gICAgaWYgKCAhdGhpcy51c2VyQ29udHJvbGxlZFByb3BlcnR5LmdldCgpICkge1xyXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKTtcclxuICAgICAgY29uc3QgZGVzdGluYXRpb24gPSB0aGlzLmRlc3RpbmF0aW9uUHJvcGVydHkuZ2V0KCk7XHJcbiAgICAgIGNvbnN0IHZlbG9jaXR5ID0gdGhpcy5hbmltYXRpb25WZWxvY2l0eVByb3BlcnR5LmdldCgpO1xyXG4gICAgICBjb25zdCBkaXN0YW5jZVRvRGVzdGluYXRpb24gPSBwb3NpdGlvbi5kaXN0YW5jZSggZGVzdGluYXRpb24gKTtcclxuICAgICAgaWYgKCBkaXN0YW5jZVRvRGVzdGluYXRpb24gPiBkdCAqIHZlbG9jaXR5ICkge1xyXG5cclxuICAgICAgICAvLyBUaGlzIHdhcyBicm9rZW4gdXAgaW50byBpbmRpdmlkdWFsIHN0ZXBzIGluIGFuIGF0dGVtcHQgdG8gc29sdmUgYW4gaXNzdWUgd2hlcmUgY29tcGxleCB2ZWN0b3Igb3BlcmF0aW9uc1xyXG4gICAgICAgIC8vIHNvbWV0aW1lcyBkaWRuJ3Qgd29yay5cclxuICAgICAgICBjb25zdCBzdGVwTWFnbml0dWRlID0gdmVsb2NpdHkgKiBkdDtcclxuICAgICAgICBjb25zdCBzdGVwQW5nbGUgPSBNYXRoLmF0YW4yKCBkZXN0aW5hdGlvbi55IC0gcG9zaXRpb24ueSwgZGVzdGluYXRpb24ueCAtIHBvc2l0aW9uLnggKTtcclxuICAgICAgICBjb25zdCBzdGVwVmVjdG9yID0gVmVjdG9yMi5jcmVhdGVQb2xhciggc3RlcE1hZ25pdHVkZSwgc3RlcEFuZ2xlICk7XHJcblxyXG4gICAgICAgIC8vIE1vdmUgYSBzdGVwIHRvd2FyZCB0aGUgZGVzdGluYXRpb24uXHJcbiAgICAgICAgdGhpcy5wb3NpdGlvblByb3BlcnR5LnNldCggcG9zaXRpb24ucGx1cyggc3RlcFZlY3RvciApICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIGRpc3RhbmNlVG9EZXN0aW5hdGlvbiA+IDAgKSB7XHJcbiAgICAgICAgLy8gTGVzcyB0aGFuIG9uZSB0aW1lIHN0ZXAgYXdheSwgc28ganVzdCBnbyB0byB0aGUgZGVzdGluYXRpb24uXHJcbiAgICAgICAgdGhpcy5tb3ZlSW1tZWRpYXRlbHlUb0Rlc3RpbmF0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5hbmltYXRpb25FbmRlZEVtaXR0ZXIuZW1pdCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXQgdHlwZSgpIHsgcmV0dXJuIHRoaXMudHlwZVByb3BlcnR5LnZhbHVlOyB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICBtb3ZlSW1tZWRpYXRlbHlUb0Rlc3RpbmF0aW9uKCkge1xyXG4gICAgdGhpcy5wb3NpdGlvblByb3BlcnR5LnNldCggdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5LmdldCgpICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG5ld1Bvc2l0aW9uXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHNldFBvc2l0aW9uQW5kRGVzdGluYXRpb24oIG5ld1Bvc2l0aW9uICkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggbmV3UG9zaXRpb24gaW5zdGFuY2VvZiBWZWN0b3IyLCAnQXR0ZW1wdCB0byBzZXQgbm9uLXZlY3RvciBwb3NpdGlvbi4nICk7XHJcbiAgICBpZiAoIG5ld1Bvc2l0aW9uIGluc3RhbmNlb2YgVmVjdG9yMiApIHtcclxuICAgICAgdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5LnNldCggbmV3UG9zaXRpb24gKTtcclxuICAgICAgdGhpcy5tb3ZlSW1tZWRpYXRlbHlUb0Rlc3RpbmF0aW9uKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyBAcHVibGljXHJcblBhcnRpY2xlLk1BWF9MQVlFUlMgPSA1O1xyXG5cclxuUGFydGljbGUuUGFydGljbGVJTyA9IG5ldyBJT1R5cGUoICdQYXJ0aWNsZUlPJywge1xyXG4gIHZhbHVlVHlwZTogUGFydGljbGUsXHJcbiAgZG9jdW1lbnRhdGlvbjogJ1RoZSBtb2RlbCBmb3IgYSBzaW5nbGUgcGFydGljbGUgc3VjaCBhcyBhbiBlbGVjdHJvbiwgcHJvdG9uLCBvciBuZXV0cm9uLicsXHJcbiAgc3VwZXJ0eXBlOiBSZWZlcmVuY2VJTyggSU9UeXBlLk9iamVjdElPIClcclxufSApO1xyXG5cclxuc2hyZWQucmVnaXN0ZXIoICdQYXJ0aWNsZScsIFBhcnRpY2xlICk7XHJcbmV4cG9ydCBkZWZhdWx0IFBhcnRpY2xlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0scUNBQXFDO0FBQ2pFLE9BQU9DLE9BQU8sTUFBTSw2QkFBNkI7QUFDakQsT0FBT0MsY0FBYyxNQUFNLG9DQUFvQztBQUMvRCxPQUFPQyxjQUFjLE1BQU0sb0NBQW9DO0FBQy9ELE9BQU9DLEtBQUssTUFBTSwwQkFBMEI7QUFDNUMsT0FBT0MsT0FBTyxNQUFNLDRCQUE0QjtBQUNoRCxPQUFPQyxlQUFlLE1BQU0sb0NBQW9DO0FBQ2hFLE9BQU9DLEtBQUssTUFBTSxnQ0FBZ0M7QUFDbEQsT0FBT0MsWUFBWSxNQUFNLG9DQUFvQztBQUM3RCxPQUFPQyxNQUFNLE1BQU0sOEJBQThCO0FBQ2pELE9BQU9DLE1BQU0sTUFBTSxvQ0FBb0M7QUFDdkQsT0FBT0MsV0FBVyxNQUFNLHlDQUF5QztBQUNqRSxPQUFPQyxLQUFLLE1BQU0sYUFBYTtBQUMvQixPQUFPQyxjQUFjLE1BQU0sc0JBQXNCOztBQUVqRDtBQUNBLElBQUlDLGNBQWMsR0FBRyxDQUFDOztBQUV0QjtBQUNBLE1BQU1DLHlC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