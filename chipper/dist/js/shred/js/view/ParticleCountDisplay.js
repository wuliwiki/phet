// Copyright 2014-2022, University of Colorado Boulder

/**
 * A node that presents a graphical representation of an atom's configuration. It looks somewhat like a bar graph that
 * grows to the right except that the "bars" are actually lines of particles.
 *
 * @author John Blanco
 * @author Aadish Gupta
 */

import merge from '../../../phet-core/js/merge.js';
import PhetFont from '../../../scenery-phet/js/PhetFont.js';
import { Node, Rectangle, Text } from '../../../scenery/js/imports.js';
import Panel from '../../../sun/js/Panel.js';
import Tandem from '../../../tandem/js/Tandem.js';
import shred from '../shred.js';
import ShredConstants from '../ShredConstants.js';
import ShredStrings from '../ShredStrings.js';
import ParticleNode from './ParticleNode.js';
const electronsColonString = ShredStrings.electronsColon;
const neutronsColonString = ShredStrings.neutronsColon;
const protonsColonString = ShredStrings.protonsColon;

// constants
const TITLE_MAX_WIDTH_PROPORTION = 1 / 3;
const MIN_VERTICAL_SPACING = 16; // Empirically Determined
const LABEL_FONT = new PhetFont(12);
class ParticleCountDisplay extends Panel {
  /**
   * @param {NumberAtom} numberAtom Model representation of the atom
   * @param {number} maxParticles The maximum number of particles to display
   * @param {number} maxWidth The maximum width that this display should reach
   * @param {Object} [options]
   */
  constructor(numberAtom, maxParticles, maxWidth, options) {
    options = merge({
      fill: ShredConstants.DISPLAY_PANEL_BACKGROUND_COLOR,
      cornerRadius: 5,
      pickable: false,
      tandem: Tandem.REQUIRED
    }, options);
    const panelContents = new Node();
    const protonTitle = new Text(protonsColonString, {
      font: LABEL_FONT,
      tandem: options.tandem.createTandem('protonTitleText')
    });
    panelContents.addChild(protonTitle);
    const neutronTitle = new Text(neutronsColonString, {
      font: LABEL_FONT,
      tandem: options.tandem.createTandem('neutronTitleText')
    });
    panelContents.addChild(neutronTitle);
    const electronTitle = new Text(electronsColonString, {
      font: LABEL_FONT,
      tandem: options.tandem.createTandem('electronTitleText')
    });
    panelContents.addChild(electronTitle);

    // Scale the title if more than allowed proportion width
    const maxAllowableLabelWidth = maxWidth * TITLE_MAX_WIDTH_PROPORTION;
    protonTitle.maxWidth = maxAllowableLabelWidth;
    electronTitle.maxWidth = maxAllowableLabelWidth;
    neutronTitle.maxWidth = maxAllowableLabelWidth;

    // Lay out the labels.
    const maxLabelWidth = Math.max(Math.max(protonTitle.width, neutronTitle.width), electronTitle.width);
    protonTitle.right = maxLabelWidth;
    protonTitle.top = 0;
    neutronTitle.right = maxLabelWidth;
    neutronTitle.bottom = protonTitle.bottom + Math.max(neutronTitle.height, MIN_VERTICAL_SPACING);
    electronTitle.right = maxLabelWidth;
    electronTitle.bottom = neutronTitle.bottom + Math.max(electronTitle.height, MIN_VERTICAL_SPACING);

    // Figure out the sizes of the particles and the inter-particle spacing based on the max width.
    const totalParticleSpace = maxWidth - protonTitle.right - 10;
    const nucleonRadius = totalParticleSpace / (maxParticles * 2 + (maxParticles - 1) + 2);
    const electronRadius = nucleonRadius * 0.6; // Arbitrarily chosen.
    const interParticleSpacing = nucleonRadius * 3;

    // Add an invisible spacer that will keep the control panel at a min width.
    const spacer = new Rectangle(maxLabelWidth, 0, interParticleSpacing * 3, 1);

    // Add the layer where the particles will live.
    const particleLayer = new Node({
      children: [spacer]
    });
    panelContents.addChild(particleLayer);

    // stored ParticleNode instances that are positioned correctly, so we just have to add/remove the
    // changed ones (faster than full rebuild)
    const protons = [];
    const neutrons = [];
    const electrons = [];

    // counts of the displayed number of particles
    let protonDisplayCount = 0;
    let neutronDisplayCount = 0;
    let electronDisplayCount = 0;

    // increase the particle count by 1, and return the currently displayed quantity array
    function incrementParticleCount(array, currentQuantity, particleType, radius, startX, startY) {
      const newIndex = currentQuantity;
      if (newIndex === array.length) {
        // we need to create a new particle
        array.push(new ParticleNode(particleType, radius, {
          x: startX + newIndex * interParticleSpacing,
          y: startY
        }));
      }
      particleLayer.addChild(array[newIndex]);
      currentQuantity += 1;
      return currentQuantity;
    }

    // decrease the particle count by 1, and return the currently displayed quantity array
    function decrementParticleCount(array, currentQuantity) {
      currentQuantity -= 1;
      particleLayer.removeChild(array[currentQuantity]);
      array.splice(currentQuantity, 1);
      return currentQuantity;
    }

    // Function that updates that displayed particles.
    const updateParticles = function (atom) {
      // feel free to refactor this, although we'd need to get a passable reference to the counts
      // (that's why there is duplication now)
      while (atom.protonCountProperty.get() > protonDisplayCount) {
        protonDisplayCount = incrementParticleCount(protons, protonDisplayCount, 'proton', nucleonRadius, protonTitle.right + interParticleSpacing, protonTitle.center.y);
      }
      while (atom.protonCountProperty.get() < protonDisplayCount) {
        protonDisplayCount = decrementParticleCount(protons, protonDisplayCount);
      }
      while (atom.neutronCountProperty.get() > neutronDisplayCount) {
        neutronDisplayCount = incrementParticleCount(neutrons, neutronDisplayCount, 'neutron', nucleonRadius, neutronTitle.right + interParticleSpacing, neutronTitle.center.y);
      }
      while (atom.neutronCountProperty.get() < neutronDisplayCount) {
        neutronDisplayCount = decrementParticleCount(neutrons, neutronDisplayCount);
      }
      while (atom.electronCountProperty.get() > electronDisplayCount) {
        electronDisplayCount = incrementParticleCount(electrons, electronDisplayCount, 'electron', electronRadius, electronTitle.right + interParticleSpacing, electronTitle.center.y);
      }
      while (atom.electronCountProperty.get() < electronDisplayCount) {
        electronDisplayCount = decrementParticleCount(electrons, electronDisplayCount);
      }
    };

    // Hook up the update function.
    numberAtom.particleCountProperty.link(() => {
      updateParticles(numberAtom);
    });

    // Initial update.
    updateParticles(numberAtom);
    super(panelContents, options);
  }
}
shred.register('ParticleCountDisplay', ParticleCountDisplay);
export default ParticleCountDisplay;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtZXJnZSIsIlBoZXRGb250IiwiTm9kZSIsIlJlY3RhbmdsZSIsIlRleHQiLCJQYW5lbCIsIlRhbmRlbSIsInNocmVkIiwiU2hyZWRDb25zdGFudHMiLCJTaHJlZFN0cmluZ3MiLCJQYXJ0aWNsZU5vZGUiLCJlbGVjdHJvbnNDb2xvblN0cmluZyIsImVsZWN0cm9uc0NvbG9uIiwibmV1dHJvbnNDb2xvblN0cmluZyIsIm5ldXRyb25zQ29sb24iLCJwcm90b25zQ29sb25TdHJpbmciLCJwcm90b25zQ29sb24iLCJUSVRMRV9NQVhfV0lEVEhfUFJPUE9SVElPTiIsIk1JTl9WRVJUSUNBTF9TUEFDSU5HIiwiTEFCRUxfRk9OVCIsIlBhcnRpY2xlQ291bnREaXNwbGF5IiwiY29uc3RydWN0b3IiLCJudW1iZXJBdG9tIiwibWF4UGFydGljbGVzIiwibWF4V2lkdGgiLCJvcHRpb25zIiwiZmlsbCIsIkRJU1BMQVlfUEFORUxfQkFDS0dST1VORF9DT0xPUiIsImNvcm5lclJhZGl1cyIsInBpY2thYmxlIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJwYW5lbENvbnRlbnRzIiwicHJvdG9uVGl0bGUiLCJmb250IiwiY3JlYXRlVGFuZGVtIiwiYWRkQ2hpbGQiLCJuZXV0cm9uVGl0bGUiLCJlbGVjdHJvblRpdGxlIiwibWF4QWxsb3dhYmxlTGFiZWxXaWR0aCIsIm1heExhYmVsV2lkdGgiLCJNYXRoIiwibWF4Iiwid2lkdGgiLCJyaWdodCIsInRvcCIsImJvdHRvbSIsImhlaWdodCIsInRvdGFsUGFydGljbGVTcGFjZSIsIm51Y2xlb25SYWRpdXMiLCJlbGVjdHJvblJhZGl1cyIsImludGVyUGFydGljbGVTcGFjaW5nIiwic3BhY2VyIiwicGFydGljbGVMYXllciIsImNoaWxkcmVuIiwicHJvdG9ucyIsIm5ldXRyb25zIiwiZWxlY3Ryb25zIiwicHJvdG9uRGlzcGxheUNvdW50IiwibmV1dHJvbkRpc3BsYXlDb3VudCIsImVsZWN0cm9uRGlzcGxheUNvdW50IiwiaW5jcmVtZW50UGFydGljbGVDb3VudCIsImFycmF5IiwiY3VycmVudFF1YW50aXR5IiwicGFydGljbGVUeXBlIiwicmFkaXVzIiwic3RhcnRYIiwic3RhcnRZIiwibmV3SW5kZXgiLCJsZW5ndGgiLCJwdXNoIiwieCIsInkiLCJkZWNyZW1lbnRQYXJ0aWNsZUNvdW50IiwicmVtb3ZlQ2hpbGQiLCJzcGxpY2UiLCJ1cGRhdGVQYXJ0aWNsZXMiLCJhdG9tIiwicHJvdG9uQ291bnRQcm9wZXJ0eSIsImdldCIsImNlbnRlciIsIm5ldXRyb25Db3VudFByb3BlcnR5IiwiZWxlY3Ryb25Db3VudFByb3BlcnR5IiwicGFydGljbGVDb3VudFByb3BlcnR5IiwibGluayIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUGFydGljbGVDb3VudERpc3BsYXkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBub2RlIHRoYXQgcHJlc2VudHMgYSBncmFwaGljYWwgcmVwcmVzZW50YXRpb24gb2YgYW4gYXRvbSdzIGNvbmZpZ3VyYXRpb24uIEl0IGxvb2tzIHNvbWV3aGF0IGxpa2UgYSBiYXIgZ3JhcGggdGhhdFxyXG4gKiBncm93cyB0byB0aGUgcmlnaHQgZXhjZXB0IHRoYXQgdGhlIFwiYmFyc1wiIGFyZSBhY3R1YWxseSBsaW5lcyBvZiBwYXJ0aWNsZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY29cclxuICogQGF1dGhvciBBYWRpc2ggR3VwdGFcclxuICovXHJcblxyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIFJlY3RhbmdsZSwgVGV4dCB9IGZyb20gJy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBQYW5lbCBmcm9tICcuLi8uLi8uLi9zdW4vanMvUGFuZWwuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgc2hyZWQgZnJvbSAnLi4vc2hyZWQuanMnO1xyXG5pbXBvcnQgU2hyZWRDb25zdGFudHMgZnJvbSAnLi4vU2hyZWRDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgU2hyZWRTdHJpbmdzIGZyb20gJy4uL1NocmVkU3RyaW5ncy5qcyc7XHJcbmltcG9ydCBQYXJ0aWNsZU5vZGUgZnJvbSAnLi9QYXJ0aWNsZU5vZGUuanMnO1xyXG5cclxuY29uc3QgZWxlY3Ryb25zQ29sb25TdHJpbmcgPSBTaHJlZFN0cmluZ3MuZWxlY3Ryb25zQ29sb247XHJcbmNvbnN0IG5ldXRyb25zQ29sb25TdHJpbmcgPSBTaHJlZFN0cmluZ3MubmV1dHJvbnNDb2xvbjtcclxuY29uc3QgcHJvdG9uc0NvbG9uU3RyaW5nID0gU2hyZWRTdHJpbmdzLnByb3RvbnNDb2xvbjtcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBUSVRMRV9NQVhfV0lEVEhfUFJPUE9SVElPTiA9IDEgLyAzO1xyXG5jb25zdCBNSU5fVkVSVElDQUxfU1BBQ0lORyA9IDE2OyAvLyBFbXBpcmljYWxseSBEZXRlcm1pbmVkXHJcbmNvbnN0IExBQkVMX0ZPTlQgPSBuZXcgUGhldEZvbnQoIDEyICk7XHJcblxyXG5jbGFzcyBQYXJ0aWNsZUNvdW50RGlzcGxheSBleHRlbmRzIFBhbmVsIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtOdW1iZXJBdG9tfSBudW1iZXJBdG9tIE1vZGVsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBhdG9tXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IG1heFBhcnRpY2xlcyBUaGUgbWF4aW11bSBudW1iZXIgb2YgcGFydGljbGVzIHRvIGRpc3BsYXlcclxuICAgKiBAcGFyYW0ge251bWJlcn0gbWF4V2lkdGggVGhlIG1heGltdW0gd2lkdGggdGhhdCB0aGlzIGRpc3BsYXkgc2hvdWxkIHJlYWNoXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBudW1iZXJBdG9tLCBtYXhQYXJ0aWNsZXMsIG1heFdpZHRoLCBvcHRpb25zICkge1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBmaWxsOiBTaHJlZENvbnN0YW50cy5ESVNQTEFZX1BBTkVMX0JBQ0tHUk9VTkRfQ09MT1IsXHJcbiAgICAgIGNvcm5lclJhZGl1czogNSxcclxuICAgICAgcGlja2FibGU6IGZhbHNlLFxyXG4gICAgICB0YW5kZW06IFRhbmRlbS5SRVFVSVJFRFxyXG4gICAgfSwgb3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHBhbmVsQ29udGVudHMgPSBuZXcgTm9kZSgpO1xyXG5cclxuICAgIGNvbnN0IHByb3RvblRpdGxlID0gbmV3IFRleHQoIHByb3RvbnNDb2xvblN0cmluZywge1xyXG4gICAgICBmb250OiBMQUJFTF9GT05ULFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Byb3RvblRpdGxlVGV4dCcgKVxyXG4gICAgfSApO1xyXG4gICAgcGFuZWxDb250ZW50cy5hZGRDaGlsZCggcHJvdG9uVGl0bGUgKTtcclxuICAgIGNvbnN0IG5ldXRyb25UaXRsZSA9IG5ldyBUZXh0KCBuZXV0cm9uc0NvbG9uU3RyaW5nLCB7XHJcbiAgICAgIGZvbnQ6IExBQkVMX0ZPTlQsXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnbmV1dHJvblRpdGxlVGV4dCcgKVxyXG4gICAgfSApO1xyXG4gICAgcGFuZWxDb250ZW50cy5hZGRDaGlsZCggbmV1dHJvblRpdGxlICk7XHJcbiAgICBjb25zdCBlbGVjdHJvblRpdGxlID0gbmV3IFRleHQoIGVsZWN0cm9uc0NvbG9uU3RyaW5nLCB7XHJcbiAgICAgIGZvbnQ6IExBQkVMX0ZPTlQsXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZWxlY3Ryb25UaXRsZVRleHQnIClcclxuICAgIH0gKTtcclxuICAgIHBhbmVsQ29udGVudHMuYWRkQ2hpbGQoIGVsZWN0cm9uVGl0bGUgKTtcclxuXHJcbiAgICAvLyBTY2FsZSB0aGUgdGl0bGUgaWYgbW9yZSB0aGFuIGFsbG93ZWQgcHJvcG9ydGlvbiB3aWR0aFxyXG4gICAgY29uc3QgbWF4QWxsb3dhYmxlTGFiZWxXaWR0aCA9IG1heFdpZHRoICogVElUTEVfTUFYX1dJRFRIX1BST1BPUlRJT047XHJcbiAgICBwcm90b25UaXRsZS5tYXhXaWR0aCA9IG1heEFsbG93YWJsZUxhYmVsV2lkdGg7XHJcbiAgICBlbGVjdHJvblRpdGxlLm1heFdpZHRoID0gbWF4QWxsb3dhYmxlTGFiZWxXaWR0aDtcclxuICAgIG5ldXRyb25UaXRsZS5tYXhXaWR0aCA9IG1heEFsbG93YWJsZUxhYmVsV2lkdGg7XHJcblxyXG4gICAgLy8gTGF5IG91dCB0aGUgbGFiZWxzLlxyXG4gICAgY29uc3QgbWF4TGFiZWxXaWR0aCA9IE1hdGgubWF4KCBNYXRoLm1heCggcHJvdG9uVGl0bGUud2lkdGgsIG5ldXRyb25UaXRsZS53aWR0aCApLCBlbGVjdHJvblRpdGxlLndpZHRoICk7XHJcbiAgICBwcm90b25UaXRsZS5yaWdodCA9IG1heExhYmVsV2lkdGg7XHJcbiAgICBwcm90b25UaXRsZS50b3AgPSAwO1xyXG4gICAgbmV1dHJvblRpdGxlLnJpZ2h0ID0gbWF4TGFiZWxXaWR0aDtcclxuICAgIG5ldXRyb25UaXRsZS5ib3R0b20gPSBwcm90b25UaXRsZS5ib3R0b20gKyBNYXRoLm1heCggbmV1dHJvblRpdGxlLmhlaWdodCwgTUlOX1ZFUlRJQ0FMX1NQQUNJTkcgKTtcclxuICAgIGVsZWN0cm9uVGl0bGUucmlnaHQgPSBtYXhMYWJlbFdpZHRoO1xyXG4gICAgZWxlY3Ryb25UaXRsZS5ib3R0b20gPSBuZXV0cm9uVGl0bGUuYm90dG9tICsgTWF0aC5tYXgoIGVsZWN0cm9uVGl0bGUuaGVpZ2h0LCBNSU5fVkVSVElDQUxfU1BBQ0lORyApO1xyXG5cclxuICAgIC8vIEZpZ3VyZSBvdXQgdGhlIHNpemVzIG9mIHRoZSBwYXJ0aWNsZXMgYW5kIHRoZSBpbnRlci1wYXJ0aWNsZSBzcGFjaW5nIGJhc2VkIG9uIHRoZSBtYXggd2lkdGguXHJcbiAgICBjb25zdCB0b3RhbFBhcnRpY2xlU3BhY2UgPSBtYXhXaWR0aCAtIHByb3RvblRpdGxlLnJpZ2h0IC0gMTA7XHJcbiAgICBjb25zdCBudWNsZW9uUmFkaXVzID0gdG90YWxQYXJ0aWNsZVNwYWNlIC8gKCAoIG1heFBhcnRpY2xlcyAqIDIgKSArICggbWF4UGFydGljbGVzIC0gMSApICsgMiApO1xyXG4gICAgY29uc3QgZWxlY3Ryb25SYWRpdXMgPSBudWNsZW9uUmFkaXVzICogMC42OyAvLyBBcmJpdHJhcmlseSBjaG9zZW4uXHJcbiAgICBjb25zdCBpbnRlclBhcnRpY2xlU3BhY2luZyA9IG51Y2xlb25SYWRpdXMgKiAzO1xyXG5cclxuICAgIC8vIEFkZCBhbiBpbnZpc2libGUgc3BhY2VyIHRoYXQgd2lsbCBrZWVwIHRoZSBjb250cm9sIHBhbmVsIGF0IGEgbWluIHdpZHRoLlxyXG4gICAgY29uc3Qgc3BhY2VyID0gbmV3IFJlY3RhbmdsZSggbWF4TGFiZWxXaWR0aCwgMCwgaW50ZXJQYXJ0aWNsZVNwYWNpbmcgKiAzLCAxICk7XHJcblxyXG4gICAgLy8gQWRkIHRoZSBsYXllciB3aGVyZSB0aGUgcGFydGljbGVzIHdpbGwgbGl2ZS5cclxuICAgIGNvbnN0IHBhcnRpY2xlTGF5ZXIgPSBuZXcgTm9kZSggeyBjaGlsZHJlbjogWyBzcGFjZXIgXSB9ICk7XHJcbiAgICBwYW5lbENvbnRlbnRzLmFkZENoaWxkKCBwYXJ0aWNsZUxheWVyICk7XHJcblxyXG4gICAgLy8gc3RvcmVkIFBhcnRpY2xlTm9kZSBpbnN0YW5jZXMgdGhhdCBhcmUgcG9zaXRpb25lZCBjb3JyZWN0bHksIHNvIHdlIGp1c3QgaGF2ZSB0byBhZGQvcmVtb3ZlIHRoZVxyXG4gICAgLy8gY2hhbmdlZCBvbmVzIChmYXN0ZXIgdGhhbiBmdWxsIHJlYnVpbGQpXHJcbiAgICBjb25zdCBwcm90b25zID0gW107XHJcbiAgICBjb25zdCBuZXV0cm9ucyA9IFtdO1xyXG4gICAgY29uc3QgZWxlY3Ryb25zID0gW107XHJcblxyXG4gICAgLy8gY291bnRzIG9mIHRoZSBkaXNwbGF5ZWQgbnVtYmVyIG9mIHBhcnRpY2xlc1xyXG4gICAgbGV0IHByb3RvbkRpc3BsYXlDb3VudCA9IDA7XHJcbiAgICBsZXQgbmV1dHJvbkRpc3BsYXlDb3VudCA9IDA7XHJcbiAgICBsZXQgZWxlY3Ryb25EaXNwbGF5Q291bnQgPSAwO1xyXG5cclxuICAgIC8vIGluY3JlYXNlIHRoZSBwYXJ0aWNsZSBjb3VudCBieSAxLCBhbmQgcmV0dXJuIHRoZSBjdXJyZW50bHkgZGlzcGxheWVkIHF1YW50aXR5IGFycmF5XHJcbiAgICBmdW5jdGlvbiBpbmNyZW1lbnRQYXJ0aWNsZUNvdW50KCBhcnJheSwgY3VycmVudFF1YW50aXR5LCBwYXJ0aWNsZVR5cGUsIHJhZGl1cywgc3RhcnRYLCBzdGFydFkgKSB7XHJcbiAgICAgIGNvbnN0IG5ld0luZGV4ID0gY3VycmVudFF1YW50aXR5O1xyXG4gICAgICBpZiAoIG5ld0luZGV4ID09PSBhcnJheS5sZW5ndGggKSB7XHJcblxyXG4gICAgICAgIC8vIHdlIG5lZWQgdG8gY3JlYXRlIGEgbmV3IHBhcnRpY2xlXHJcbiAgICAgICAgYXJyYXkucHVzaCggbmV3IFBhcnRpY2xlTm9kZSggcGFydGljbGVUeXBlLCByYWRpdXMsIHtcclxuICAgICAgICAgIHg6IHN0YXJ0WCArIG5ld0luZGV4ICogaW50ZXJQYXJ0aWNsZVNwYWNpbmcsXHJcbiAgICAgICAgICB5OiBzdGFydFlcclxuICAgICAgICB9ICkgKTtcclxuICAgICAgfVxyXG4gICAgICBwYXJ0aWNsZUxheWVyLmFkZENoaWxkKCBhcnJheVsgbmV3SW5kZXggXSApO1xyXG4gICAgICBjdXJyZW50UXVhbnRpdHkgKz0gMTtcclxuICAgICAgcmV0dXJuIGN1cnJlbnRRdWFudGl0eTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBkZWNyZWFzZSB0aGUgcGFydGljbGUgY291bnQgYnkgMSwgYW5kIHJldHVybiB0aGUgY3VycmVudGx5IGRpc3BsYXllZCBxdWFudGl0eSBhcnJheVxyXG4gICAgZnVuY3Rpb24gZGVjcmVtZW50UGFydGljbGVDb3VudCggYXJyYXksIGN1cnJlbnRRdWFudGl0eSApIHtcclxuICAgICAgY3VycmVudFF1YW50aXR5IC09IDE7XHJcbiAgICAgIHBhcnRpY2xlTGF5ZXIucmVtb3ZlQ2hpbGQoIGFycmF5WyBjdXJyZW50UXVhbnRpdHkgXSApO1xyXG4gICAgICBhcnJheS5zcGxpY2UoIGN1cnJlbnRRdWFudGl0eSwgMSApO1xyXG4gICAgICByZXR1cm4gY3VycmVudFF1YW50aXR5O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZ1bmN0aW9uIHRoYXQgdXBkYXRlcyB0aGF0IGRpc3BsYXllZCBwYXJ0aWNsZXMuXHJcbiAgICBjb25zdCB1cGRhdGVQYXJ0aWNsZXMgPSBmdW5jdGlvbiggYXRvbSApIHtcclxuICAgICAgLy8gZmVlbCBmcmVlIHRvIHJlZmFjdG9yIHRoaXMsIGFsdGhvdWdoIHdlJ2QgbmVlZCB0byBnZXQgYSBwYXNzYWJsZSByZWZlcmVuY2UgdG8gdGhlIGNvdW50c1xyXG4gICAgICAvLyAodGhhdCdzIHdoeSB0aGVyZSBpcyBkdXBsaWNhdGlvbiBub3cpXHJcbiAgICAgIHdoaWxlICggYXRvbS5wcm90b25Db3VudFByb3BlcnR5LmdldCgpID4gcHJvdG9uRGlzcGxheUNvdW50ICkge1xyXG4gICAgICAgIHByb3RvbkRpc3BsYXlDb3VudCA9IGluY3JlbWVudFBhcnRpY2xlQ291bnQoXHJcbiAgICAgICAgICBwcm90b25zLFxyXG4gICAgICAgICAgcHJvdG9uRGlzcGxheUNvdW50LFxyXG4gICAgICAgICAgJ3Byb3RvbicsXHJcbiAgICAgICAgICBudWNsZW9uUmFkaXVzLFxyXG4gICAgICAgICAgcHJvdG9uVGl0bGUucmlnaHQgKyBpbnRlclBhcnRpY2xlU3BhY2luZyxcclxuICAgICAgICAgIHByb3RvblRpdGxlLmNlbnRlci55XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICB3aGlsZSAoIGF0b20ucHJvdG9uQ291bnRQcm9wZXJ0eS5nZXQoKSA8IHByb3RvbkRpc3BsYXlDb3VudCApIHtcclxuICAgICAgICBwcm90b25EaXNwbGF5Q291bnQgPSBkZWNyZW1lbnRQYXJ0aWNsZUNvdW50KCBwcm90b25zLCBwcm90b25EaXNwbGF5Q291bnQgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgd2hpbGUgKCBhdG9tLm5ldXRyb25Db3VudFByb3BlcnR5LmdldCgpID4gbmV1dHJvbkRpc3BsYXlDb3VudCApIHtcclxuICAgICAgICBuZXV0cm9uRGlzcGxheUNvdW50ID0gaW5jcmVtZW50UGFydGljbGVDb3VudChcclxuICAgICAgICAgIG5ldXRyb25zLFxyXG4gICAgICAgICAgbmV1dHJvbkRpc3BsYXlDb3VudCxcclxuICAgICAgICAgICduZXV0cm9uJyxcclxuICAgICAgICAgIG51Y2xlb25SYWRpdXMsXHJcbiAgICAgICAgICBuZXV0cm9uVGl0bGUucmlnaHQgKyBpbnRlclBhcnRpY2xlU3BhY2luZywgbmV1dHJvblRpdGxlLmNlbnRlci55XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgICB3aGlsZSAoIGF0b20ubmV1dHJvbkNvdW50UHJvcGVydHkuZ2V0KCkgPCBuZXV0cm9uRGlzcGxheUNvdW50ICkge1xyXG4gICAgICAgIG5ldXRyb25EaXNwbGF5Q291bnQgPSBkZWNyZW1lbnRQYXJ0aWNsZUNvdW50KCBuZXV0cm9ucywgbmV1dHJvbkRpc3BsYXlDb3VudCApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB3aGlsZSAoIGF0b20uZWxlY3Ryb25Db3VudFByb3BlcnR5LmdldCgpID4gZWxlY3Ryb25EaXNwbGF5Q291bnQgKSB7XHJcbiAgICAgICAgZWxlY3Ryb25EaXNwbGF5Q291bnQgPSBpbmNyZW1lbnRQYXJ0aWNsZUNvdW50KFxyXG4gICAgICAgICAgZWxlY3Ryb25zLFxyXG4gICAgICAgICAgZWxlY3Ryb25EaXNwbGF5Q291bnQsXHJcbiAgICAgICAgICAnZWxlY3Ryb24nLFxyXG4gICAgICAgICAgZWxlY3Ryb25SYWRpdXMsXHJcbiAgICAgICAgICBlbGVjdHJvblRpdGxlLnJpZ2h0ICsgaW50ZXJQYXJ0aWNsZVNwYWNpbmcsIGVsZWN0cm9uVGl0bGUuY2VudGVyLnlcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICAgIHdoaWxlICggYXRvbS5lbGVjdHJvbkNvdW50UHJvcGVydHkuZ2V0KCkgPCBlbGVjdHJvbkRpc3BsYXlDb3VudCApIHtcclxuICAgICAgICBlbGVjdHJvbkRpc3BsYXlDb3VudCA9IGRlY3JlbWVudFBhcnRpY2xlQ291bnQoIGVsZWN0cm9ucywgZWxlY3Ryb25EaXNwbGF5Q291bnQgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBIb29rIHVwIHRoZSB1cGRhdGUgZnVuY3Rpb24uXHJcbiAgICBudW1iZXJBdG9tLnBhcnRpY2xlQ291bnRQcm9wZXJ0eS5saW5rKCAoKSA9PiB7XHJcbiAgICAgIHVwZGF0ZVBhcnRpY2xlcyggbnVtYmVyQXRvbSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEluaXRpYWwgdXBkYXRlLlxyXG4gICAgdXBkYXRlUGFydGljbGVzKCBudW1iZXJBdG9tICk7XHJcblxyXG4gICAgc3VwZXIoIHBhbmVsQ29udGVudHMsIG9wdGlvbnMgKTtcclxuICB9XHJcbn1cclxuXHJcbnNocmVkLnJlZ2lzdGVyKCAnUGFydGljbGVDb3VudERpc3BsYXknLCBQYXJ0aWNsZUNvdW50RGlzcGxheSApO1xyXG5leHBvcnQgZGVmYXVsdCBQYXJ0aWNsZUNvdW50RGlzcGxheTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFD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