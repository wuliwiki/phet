// Copyright 2019-2023, University of Colorado Boulder

/**
 * Model class for the 'Compare' screen.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import CompareCountingType from './CompareCountingType.js';
import CountingArea from '../../../../number-suite-common/js/common/model/CountingArea.js';
import Range from '../../../../dot/js/Range.js';
import numberCompare from '../../numberCompare.js';
import CountingObjectType from '../../../../counting-common/js/common/model/CountingObjectType.js';
import numberComparePreferences from '../../common/model/numberComparePreferences.js';
import NumberCompareStrings from '../../NumberCompareStrings.js';
import NumberSuiteCommonConstants, { NUMBER_STRING_PROPERTIES } from '../../../../number-suite-common/js/common/NumberSuiteCommonConstants.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import NumberCompareConstants from '../../common/NumberCompareConstants.js';
import localeProperty from '../../../../joist/js/i18n/localeProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';

// constants
const IS_LESS_THAN_STRING_KEY = `${NumberCompareConstants.NUMBER_COMPARE_REQUIREJS_NAMESPACE}/isLessThan`;
const IS_GREATER_THAN_STRING_KEY = `${NumberCompareConstants.NUMBER_COMPARE_REQUIREJS_NAMESPACE}/isGreaterThan`;
const IS_EQUAL_TO_STRING_KEY = `${NumberCompareConstants.NUMBER_COMPARE_REQUIREJS_NAMESPACE}/isEqualTo`;
class CompareModel {
  constructor(highestCount, speechDataProperty, tandem) {
    this.sumRange = new Range(0, highestCount);
    this.leftCountingObjectTypeProperty = new EnumerationProperty(CountingObjectType.DOG);
    this.rightCountingObjectTypeProperty = new EnumerationProperty(CountingObjectType.DOG);
    this.countingTypeProperty = new EnumerationProperty(CompareCountingType.BLOCKS);
    this.comparisonSignsAndTextVisibleProperty = new BooleanProperty(true);

    // create the left and right countingAreas
    this.leftCountingArea = new CountingArea(highestCount, new BooleanProperty(true));
    this.rightCountingArea = new CountingArea(highestCount, new BooleanProperty(true));
    const comparisonStringProperty = new DerivedProperty([this.leftCountingArea.sumProperty, this.rightCountingArea.sumProperty, numberComparePreferences.isPrimaryLocaleProperty, localeProperty, numberComparePreferences.secondLocaleStringsProperty,
    // Strings that could change the comparisonStringProperty value
    NumberCompareStrings.isLessThanStringProperty, NumberCompareStrings.isGreaterThanStringProperty, NumberCompareStrings.isEqualToStringProperty], (leftCurrentNumber, rightCurrentNumber, isPrimaryLocale, primaryLocale, secondLocaleStrings) => {
      return CompareModel.getComparisonString(leftCurrentNumber, rightCurrentNumber, isPrimaryLocale, secondLocaleStrings);
    });

    // Strings that could change the comparisonStringProperty value
    // Instead of needing to use DerivedProperty.deriveAny which doesn't allow callback parameters above, just recompute with
    // these Property changes.
    Multilink.multilinkAny(NUMBER_STRING_PROPERTIES, () => {
      comparisonStringProperty.recomputeDerivation();
    });
    this.comparisonStringProperty = comparisonStringProperty;

    // Update the speechDataProperty when the comparisonString or comparisonSignsAndTextVisible changes. If the
    // comparison sign and text is not visible, set the speech to null.
    Multilink.multilink([this.comparisonStringProperty, this.comparisonSignsAndTextVisibleProperty], (comparisonString, comparisonSignsAndTextVisible) => {
      speechDataProperty.value = comparisonSignsAndTextVisible ? comparisonString : null;
    });
  }

  /**
   * Resets the model.
   */
  reset() {
    numberComparePreferences.isPrimaryLocaleProperty.reset();
    this.leftCountingArea.reset();
    this.rightCountingArea.reset();
    this.rightCountingObjectTypeProperty.reset();
    this.leftCountingObjectTypeProperty.reset();
    this.comparisonSignsAndTextVisibleProperty.reset();
    this.countingTypeProperty.reset();
  }

  /**
   * Builds the string based on the current numbers. Example format: "Three is less than seven"
   */
  static getComparisonString(leftCurrentNumber, rightCurrentNumber, isPrimaryLocale, secondLocaleStrings) {
    const isLessThanString = NumberSuiteCommonConstants.getString(NumberCompareStrings.isLessThanStringProperty.value, secondLocaleStrings[IS_LESS_THAN_STRING_KEY], IS_LESS_THAN_STRING_KEY, isPrimaryLocale);
    const isGreaterThanString = NumberSuiteCommonConstants.getString(NumberCompareStrings.isGreaterThanStringProperty.value, secondLocaleStrings[IS_GREATER_THAN_STRING_KEY], IS_GREATER_THAN_STRING_KEY, isPrimaryLocale);
    const isEqualToString = NumberSuiteCommonConstants.getString(NumberCompareStrings.isEqualToStringProperty.value, secondLocaleStrings[IS_EQUAL_TO_STRING_KEY], IS_EQUAL_TO_STRING_KEY, isPrimaryLocale);
    const leftNumberWord = NumberSuiteCommonConstants.numberToWord(secondLocaleStrings, leftCurrentNumber, isPrimaryLocale);
    const rightNumberWord = NumberSuiteCommonConstants.numberToWord(secondLocaleStrings, rightCurrentNumber, isPrimaryLocale);
    let comparisonString;
    if (leftCurrentNumber < rightCurrentNumber) {
      comparisonString = StringUtils.fillIn(isLessThanString, {
        smallerNumber: leftNumberWord,
        greaterNumber: rightNumberWord
      });
    } else if (leftCurrentNumber > rightCurrentNumber) {
      comparisonString = StringUtils.fillIn(isGreaterThanString, {
        greaterNumber: leftNumberWord,
        smallerNumber: rightNumberWord
      });
    } else {
      comparisonString = StringUtils.fillIn(isEqualToString, {
        equalNumberLeft: leftNumberWord,
        equalNumberRight: rightNumberWord
      });
    }
    return comparisonString;
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }
}
numberCompare.register('CompareModel', CompareModel);
export default CompareModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJFbnVtZXJhdGlvblByb3BlcnR5IiwiQ29tcGFyZUNvdW50aW5nVHlwZSIsIkNvdW50aW5nQXJlYSIsIlJhbmdlIiwibnVtYmVyQ29tcGFyZSIsIkNvdW50aW5nT2JqZWN0VHlwZSIsIm51bWJlckNvbXBhcmVQcmVmZXJlbmNlcyIsIk51bWJlckNvbXBhcmVTdHJpbmdzIiwiTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMiLCJOVU1CRVJfU1RSSU5HX1BST1BFUlRJRVMiLCJTdHJpbmdVdGlscyIsIk51bWJlckNvbXBhcmVDb25zdGFudHMiLCJsb2NhbGVQcm9wZXJ0eSIsIkRlcml2ZWRQcm9wZXJ0eSIsIk11bHRpbGluayIsIklTX0xFU1NfVEhBTl9TVFJJTkdfS0VZIiwiTlVNQkVSX0NPTVBBUkVfUkVRVUlSRUpTX05BTUVTUEFDRSIsIklTX0dSRUFURVJfVEhBTl9TVFJJTkdfS0VZIiwiSVNfRVFVQUxfVE9fU1RSSU5HX0tFWSIsIkNvbXBhcmVNb2RlbCIsImNvbnN0cnVjdG9yIiwiaGlnaGVzdENvdW50Iiwic3BlZWNoRGF0YVByb3BlcnR5IiwidGFuZGVtIiwic3VtUmFuZ2UiLCJsZWZ0Q291bnRpbmdPYmplY3RUeXBlUHJvcGVydHkiLCJET0ciLCJyaWdodENvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5IiwiY291bnRpbmdUeXBlUHJvcGVydHkiLCJCTE9DS1MiLCJjb21wYXJpc29uU2lnbnNBbmRUZXh0VmlzaWJsZVByb3BlcnR5IiwibGVmdENvdW50aW5nQXJlYSIsInJpZ2h0Q291bnRpbmdBcmVhIiwiY29tcGFyaXNvblN0cmluZ1Byb3BlcnR5Iiwic3VtUHJvcGVydHkiLCJpc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eSIsInNlY29uZExvY2FsZVN0cmluZ3NQcm9wZXJ0eSIsImlzTGVzc1RoYW5TdHJpbmdQcm9wZXJ0eSIsImlzR3JlYXRlclRoYW5TdHJpbmdQcm9wZXJ0eSIsImlzRXF1YWxUb1N0cmluZ1Byb3BlcnR5IiwibGVmdEN1cnJlbnROdW1iZXIiLCJyaWdodEN1cnJlbnROdW1iZXIiLCJpc1ByaW1hcnlMb2NhbGUiLCJwcmltYXJ5TG9jYWxlIiwic2Vjb25kTG9jYWxlU3RyaW5ncyIsImdldENvbXBhcmlzb25TdHJpbmciLCJtdWx0aWxpbmtBbnkiLCJyZWNvbXB1dGVEZXJpdmF0aW9uIiwibXVsdGlsaW5rIiwiY29tcGFyaXNvblN0cmluZyIsImNvbXBhcmlzb25TaWduc0FuZFRleHRWaXNpYmxlIiwidmFsdWUiLCJyZXNldCIsImlzTGVzc1RoYW5TdHJpbmciLCJnZXRTdHJpbmciLCJpc0dyZWF0ZXJUaGFuU3RyaW5nIiwiaXNFcXVhbFRvU3RyaW5nIiwibGVmdE51bWJlcldvcmQiLCJudW1iZXJUb1dvcmQiLCJyaWdodE51bWJlcldvcmQiLCJmaWxsSW4iLCJzbWFsbGVyTnVtYmVyIiwiZ3JlYXRlck51bWJlciIsImVxdWFsTnVtYmVyTGVmdCIsImVxdWFsTnVtYmVyUmlnaHQiLCJkaXNwb3NlIiwiYXNzZXJ0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDb21wYXJlTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTW9kZWwgY2xhc3MgZm9yIHRoZSAnQ29tcGFyZScgc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIEtsdXNlbmRvcmYgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW51bWVyYXRpb25Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBDb21wYXJlQ291bnRpbmdUeXBlIGZyb20gJy4vQ29tcGFyZUNvdW50aW5nVHlwZS5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBDb3VudGluZ0FyZWEgZnJvbSAnLi4vLi4vLi4vLi4vbnVtYmVyLXN1aXRlLWNvbW1vbi9qcy9jb21tb24vbW9kZWwvQ291bnRpbmdBcmVhLmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBudW1iZXJDb21wYXJlIGZyb20gJy4uLy4uL251bWJlckNvbXBhcmUuanMnO1xyXG5pbXBvcnQgQ291bnRpbmdPYmplY3RUeXBlIGZyb20gJy4uLy4uLy4uLy4uL2NvdW50aW5nLWNvbW1vbi9qcy9jb21tb24vbW9kZWwvQ291bnRpbmdPYmplY3RUeXBlLmpzJztcclxuaW1wb3J0IFRNb2RlbCBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9UTW9kZWwuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBudW1iZXJDb21wYXJlUHJlZmVyZW5jZXMgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL251bWJlckNvbXBhcmVQcmVmZXJlbmNlcy5qcyc7XHJcbmltcG9ydCBOdW1iZXJDb21wYXJlU3RyaW5ncyBmcm9tICcuLi8uLi9OdW1iZXJDb21wYXJlU3RyaW5ncy5qcyc7XHJcbmltcG9ydCBOdW1iZXJTdWl0ZUNvbW1vbkNvbnN0YW50cywgeyBOVU1CRVJfU1RSSU5HX1BST1BFUlRJRVMgfSBmcm9tICcuLi8uLi8uLi8uLi9udW1iZXItc3VpdGUtY29tbW9uL2pzL2NvbW1vbi9OdW1iZXJTdWl0ZUNvbW1vbkNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBTdHJpbmdVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3V0aWwvU3RyaW5nVXRpbHMuanMnO1xyXG5pbXBvcnQgTnVtYmVyQ29tcGFyZUNvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vTnVtYmVyQ29tcGFyZUNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCB7IFNlY29uZExvY2FsZVN0cmluZ3MgfSBmcm9tICcuLi8uLi8uLi8uLi9udW1iZXItc3VpdGUtY29tbW9uL2pzL2NvbW1vbi9tb2RlbC9OdW1iZXJTdWl0ZUNvbW1vblByZWZlcmVuY2VzLmpzJztcclxuaW1wb3J0IGxvY2FsZVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL2kxOG4vbG9jYWxlUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFByb3BlcnR5LmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgSVNfTEVTU19USEFOX1NUUklOR19LRVkgPSBgJHtOdW1iZXJDb21wYXJlQ29uc3RhbnRzLk5VTUJFUl9DT01QQVJFX1JFUVVJUkVKU19OQU1FU1BBQ0V9L2lzTGVzc1RoYW5gO1xyXG5jb25zdCBJU19HUkVBVEVSX1RIQU5fU1RSSU5HX0tFWSA9IGAke051bWJlckNvbXBhcmVDb25zdGFudHMuTlVNQkVSX0NPTVBBUkVfUkVRVUlSRUpTX05BTUVTUEFDRX0vaXNHcmVhdGVyVGhhbmA7XHJcbmNvbnN0IElTX0VRVUFMX1RPX1NUUklOR19LRVkgPSBgJHtOdW1iZXJDb21wYXJlQ29uc3RhbnRzLk5VTUJFUl9DT01QQVJFX1JFUVVJUkVKU19OQU1FU1BBQ0V9L2lzRXF1YWxUb2A7XHJcblxyXG5jbGFzcyBDb21wYXJlTW9kZWwgaW1wbGVtZW50cyBUTW9kZWwge1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgc3VtUmFuZ2U6IFJhbmdlO1xyXG4gIHB1YmxpYyByZWFkb25seSBjb3VudGluZ1R5cGVQcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxDb21wYXJlQ291bnRpbmdUeXBlPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgY29tcGFyaXNvblNpZ25zQW5kVGV4dFZpc2libGVQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHVibGljIHJlYWRvbmx5IGxlZnRDb3VudGluZ0FyZWE6IENvdW50aW5nQXJlYTtcclxuICBwdWJsaWMgcmVhZG9ubHkgcmlnaHRDb3VudGluZ0FyZWE6IENvdW50aW5nQXJlYTtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGVmdENvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PENvdW50aW5nT2JqZWN0VHlwZT47XHJcbiAgcHVibGljIHJlYWRvbmx5IHJpZ2h0Q291bnRpbmdPYmplY3RUeXBlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8Q291bnRpbmdPYmplY3RUeXBlPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgY29tcGFyaXNvblN0cmluZ1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmc+O1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGhpZ2hlc3RDb3VudDogbnVtYmVyLCBzcGVlY2hEYXRhUHJvcGVydHk6IFRQcm9wZXJ0eTxzdHJpbmcgfCBudWxsPiwgdGFuZGVtOiBUYW5kZW0gKSB7XHJcblxyXG4gICAgdGhpcy5zdW1SYW5nZSA9IG5ldyBSYW5nZSggMCwgaGlnaGVzdENvdW50ICk7XHJcblxyXG4gICAgdGhpcy5sZWZ0Q291bnRpbmdPYmplY3RUeXBlUHJvcGVydHkgPSBuZXcgRW51bWVyYXRpb25Qcm9wZXJ0eSggQ291bnRpbmdPYmplY3RUeXBlLkRPRyApO1xyXG4gICAgdGhpcy5yaWdodENvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIENvdW50aW5nT2JqZWN0VHlwZS5ET0cgKTtcclxuXHJcbiAgICB0aGlzLmNvdW50aW5nVHlwZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIENvbXBhcmVDb3VudGluZ1R5cGUuQkxPQ0tTICk7XHJcbiAgICB0aGlzLmNvbXBhcmlzb25TaWduc0FuZFRleHRWaXNpYmxlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0cnVlICk7XHJcblxyXG4gICAgLy8gY3JlYXRlIHRoZSBsZWZ0IGFuZCByaWdodCBjb3VudGluZ0FyZWFzXHJcbiAgICB0aGlzLmxlZnRDb3VudGluZ0FyZWEgPSBuZXcgQ291bnRpbmdBcmVhKCBoaWdoZXN0Q291bnQsIG5ldyBCb29sZWFuUHJvcGVydHkoIHRydWUgKSApO1xyXG4gICAgdGhpcy5yaWdodENvdW50aW5nQXJlYSA9IG5ldyBDb3VudGluZ0FyZWEoIGhpZ2hlc3RDb3VudCwgbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSApICk7XHJcblxyXG4gICAgY29uc3QgY29tcGFyaXNvblN0cmluZ1Byb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggW1xyXG4gICAgICB0aGlzLmxlZnRDb3VudGluZ0FyZWEuc3VtUHJvcGVydHksXHJcbiAgICAgIHRoaXMucmlnaHRDb3VudGluZ0FyZWEuc3VtUHJvcGVydHksXHJcbiAgICAgIG51bWJlckNvbXBhcmVQcmVmZXJlbmNlcy5pc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eSxcclxuICAgICAgbG9jYWxlUHJvcGVydHksXHJcbiAgICAgIG51bWJlckNvbXBhcmVQcmVmZXJlbmNlcy5zZWNvbmRMb2NhbGVTdHJpbmdzUHJvcGVydHksXHJcblxyXG4gICAgICAvLyBTdHJpbmdzIHRoYXQgY291bGQgY2hhbmdlIHRoZSBjb21wYXJpc29uU3RyaW5nUHJvcGVydHkgdmFsdWVcclxuICAgICAgTnVtYmVyQ29tcGFyZVN0cmluZ3MuaXNMZXNzVGhhblN0cmluZ1Byb3BlcnR5LFxyXG4gICAgICBOdW1iZXJDb21wYXJlU3RyaW5ncy5pc0dyZWF0ZXJUaGFuU3RyaW5nUHJvcGVydHksXHJcbiAgICAgIE51bWJlckNvbXBhcmVTdHJpbmdzLmlzRXF1YWxUb1N0cmluZ1Byb3BlcnR5XHJcbiAgICBdLCAoIGxlZnRDdXJyZW50TnVtYmVyLCByaWdodEN1cnJlbnROdW1iZXIsIGlzUHJpbWFyeUxvY2FsZSwgcHJpbWFyeUxvY2FsZSwgc2Vjb25kTG9jYWxlU3RyaW5ncyApID0+IHtcclxuICAgICAgcmV0dXJuIENvbXBhcmVNb2RlbC5nZXRDb21wYXJpc29uU3RyaW5nKCBsZWZ0Q3VycmVudE51bWJlciwgcmlnaHRDdXJyZW50TnVtYmVyLCBpc1ByaW1hcnlMb2NhbGUsIHNlY29uZExvY2FsZVN0cmluZ3MgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBTdHJpbmdzIHRoYXQgY291bGQgY2hhbmdlIHRoZSBjb21wYXJpc29uU3RyaW5nUHJvcGVydHkgdmFsdWVcclxuICAgIC8vIEluc3RlYWQgb2YgbmVlZGluZyB0byB1c2UgRGVyaXZlZFByb3BlcnR5LmRlcml2ZUFueSB3aGljaCBkb2Vzbid0IGFsbG93IGNhbGxiYWNrIHBhcmFtZXRlcnMgYWJvdmUsIGp1c3QgcmVjb21wdXRlIHdpdGhcclxuICAgIC8vIHRoZXNlIFByb3BlcnR5IGNoYW5nZXMuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rQW55KCBOVU1CRVJfU1RSSU5HX1BST1BFUlRJRVMsICgpID0+IHtcclxuICAgICAgY29tcGFyaXNvblN0cmluZ1Byb3BlcnR5LnJlY29tcHV0ZURlcml2YXRpb24oKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmNvbXBhcmlzb25TdHJpbmdQcm9wZXJ0eSA9IGNvbXBhcmlzb25TdHJpbmdQcm9wZXJ0eTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHNwZWVjaERhdGFQcm9wZXJ0eSB3aGVuIHRoZSBjb21wYXJpc29uU3RyaW5nIG9yIGNvbXBhcmlzb25TaWduc0FuZFRleHRWaXNpYmxlIGNoYW5nZXMuIElmIHRoZVxyXG4gICAgLy8gY29tcGFyaXNvbiBzaWduIGFuZCB0ZXh0IGlzIG5vdCB2aXNpYmxlLCBzZXQgdGhlIHNwZWVjaCB0byBudWxsLlxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyB0aGlzLmNvbXBhcmlzb25TdHJpbmdQcm9wZXJ0eSwgdGhpcy5jb21wYXJpc29uU2lnbnNBbmRUZXh0VmlzaWJsZVByb3BlcnR5IF0sXHJcbiAgICAgICggY29tcGFyaXNvblN0cmluZywgY29tcGFyaXNvblNpZ25zQW5kVGV4dFZpc2libGUgKSA9PiB7XHJcbiAgICAgICAgc3BlZWNoRGF0YVByb3BlcnR5LnZhbHVlID0gY29tcGFyaXNvblNpZ25zQW5kVGV4dFZpc2libGUgPyBjb21wYXJpc29uU3RyaW5nIDogbnVsbDtcclxuICAgICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIHRoZSBtb2RlbC5cclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcbiAgICBudW1iZXJDb21wYXJlUHJlZmVyZW5jZXMuaXNQcmltYXJ5TG9jYWxlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMubGVmdENvdW50aW5nQXJlYS5yZXNldCgpO1xyXG4gICAgdGhpcy5yaWdodENvdW50aW5nQXJlYS5yZXNldCgpO1xyXG4gICAgdGhpcy5yaWdodENvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmxlZnRDb3VudGluZ09iamVjdFR5cGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5jb21wYXJpc29uU2lnbnNBbmRUZXh0VmlzaWJsZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmNvdW50aW5nVHlwZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBCdWlsZHMgdGhlIHN0cmluZyBiYXNlZCBvbiB0aGUgY3VycmVudCBudW1iZXJzLiBFeGFtcGxlIGZvcm1hdDogXCJUaHJlZSBpcyBsZXNzIHRoYW4gc2V2ZW5cIlxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGdldENvbXBhcmlzb25TdHJpbmcoIGxlZnRDdXJyZW50TnVtYmVyOiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRDdXJyZW50TnVtYmVyOiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNQcmltYXJ5TG9jYWxlOiBib29sZWFuLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY29uZExvY2FsZVN0cmluZ3M6IFNlY29uZExvY2FsZVN0cmluZ3MgKTogc3RyaW5nIHtcclxuXHJcbiAgICBjb25zdCBpc0xlc3NUaGFuU3RyaW5nID0gTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMuZ2V0U3RyaW5nKCBOdW1iZXJDb21wYXJlU3RyaW5ncy5pc0xlc3NUaGFuU3RyaW5nUHJvcGVydHkudmFsdWUsXHJcbiAgICAgIHNlY29uZExvY2FsZVN0cmluZ3NbIElTX0xFU1NfVEhBTl9TVFJJTkdfS0VZIF0sIElTX0xFU1NfVEhBTl9TVFJJTkdfS0VZLCBpc1ByaW1hcnlMb2NhbGUgKTtcclxuICAgIGNvbnN0IGlzR3JlYXRlclRoYW5TdHJpbmcgPSBOdW1iZXJTdWl0ZUNvbW1vbkNvbnN0YW50cy5nZXRTdHJpbmcoIE51bWJlckNvbXBhcmVTdHJpbmdzLmlzR3JlYXRlclRoYW5TdHJpbmdQcm9wZXJ0eS52YWx1ZSxcclxuICAgICAgc2Vjb25kTG9jYWxlU3RyaW5nc1sgSVNfR1JFQVRFUl9USEFOX1NUUklOR19LRVkgXSwgSVNfR1JFQVRFUl9USEFOX1NUUklOR19LRVksIGlzUHJpbWFyeUxvY2FsZSApO1xyXG4gICAgY29uc3QgaXNFcXVhbFRvU3RyaW5nID0gTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMuZ2V0U3RyaW5nKCBOdW1iZXJDb21wYXJlU3RyaW5ncy5pc0VxdWFsVG9TdHJpbmdQcm9wZXJ0eS52YWx1ZSxcclxuICAgICAgc2Vjb25kTG9jYWxlU3RyaW5nc1sgSVNfRVFVQUxfVE9fU1RSSU5HX0tFWSBdLCBJU19FUVVBTF9UT19TVFJJTkdfS0VZLCBpc1ByaW1hcnlMb2NhbGUgKTtcclxuXHJcbiAgICBjb25zdCBsZWZ0TnVtYmVyV29yZCA9IE51bWJlclN1aXRlQ29tbW9uQ29uc3RhbnRzLm51bWJlclRvV29yZCggc2Vjb25kTG9jYWxlU3RyaW5ncyxcclxuICAgICAgbGVmdEN1cnJlbnROdW1iZXIsIGlzUHJpbWFyeUxvY2FsZSApO1xyXG4gICAgY29uc3QgcmlnaHROdW1iZXJXb3JkID0gTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMubnVtYmVyVG9Xb3JkKCBzZWNvbmRMb2NhbGVTdHJpbmdzLFxyXG4gICAgICByaWdodEN1cnJlbnROdW1iZXIsIGlzUHJpbWFyeUxvY2FsZSApO1xyXG4gICAgbGV0IGNvbXBhcmlzb25TdHJpbmc7XHJcblxyXG4gICAgaWYgKCBsZWZ0Q3VycmVudE51bWJlciA8IHJpZ2h0Q3VycmVudE51bWJlciApIHtcclxuICAgICAgY29tcGFyaXNvblN0cmluZyA9IFN0cmluZ1V0aWxzLmZpbGxJbiggaXNMZXNzVGhhblN0cmluZywge1xyXG4gICAgICAgIHNtYWxsZXJOdW1iZXI6IGxlZnROdW1iZXJXb3JkLFxyXG4gICAgICAgIGdyZWF0ZXJOdW1iZXI6IHJpZ2h0TnVtYmVyV29yZFxyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggbGVmdEN1cnJlbnROdW1iZXIgPiByaWdodEN1cnJlbnROdW1iZXIgKSB7XHJcbiAgICAgIGNvbXBhcmlzb25TdHJpbmcgPSBTdHJpbmdVdGlscy5maWxsSW4oIGlzR3JlYXRlclRoYW5TdHJpbmcsIHtcclxuICAgICAgICBncmVhdGVyTnVtYmVyOiBsZWZ0TnVtYmVyV29yZCxcclxuICAgICAgICBzbWFsbGVyTnVtYmVyOiByaWdodE51bWJlcldvcmRcclxuICAgICAgfSApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbXBhcmlzb25TdHJpbmcgPSBTdHJpbmdVdGlscy5maWxsSW4oIGlzRXF1YWxUb1N0cmluZywge1xyXG4gICAgICAgIGVxdWFsTnVtYmVyTGVmdDogbGVmdE51bWJlcldvcmQsXHJcbiAgICAgICAgZXF1YWxOdW1iZXJSaWdodDogcmlnaHROdW1iZXJXb3JkXHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY29tcGFyaXNvblN0cmluZztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZmFsc2UsICdkaXNwb3NlIGlzIG5vdCBzdXBwb3J0ZWQsIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0nICk7XHJcbiAgfVxyXG59XHJcblxyXG5udW1iZXJDb21wYXJlLnJlZ2lzdGVyKCAnQ29tcGFyZU1vZGVsJywgQ29tcGFyZU1vZGVsICk7XHJcbmV4cG9ydCBkZWZhdWx0IENvbXBhcmVNb2RlbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxtQkFBbUIsTUFBTSw0Q0FBNEM7QUFDNUUsT0FBT0MsbUJBQW1CLE1BQU0sMEJBQTBCO0FBRTFELE9BQU9DLFlBQVksTUFBTSxpRUFBaUU7QUFDMUYsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxhQUFhLE1BQU0sd0JBQXdCO0FBQ2xELE9BQU9DLGtCQUFrQixNQUFNLG1FQUFtRTtBQUdsRyxPQUFPQyx3QkFBd0IsTUFBTSxnREFBZ0Q7QUFDckYsT0FBT0Msb0JBQW9CLE1BQU0sK0JBQStCO0FBQ2hFLE9BQU9DLDBCQUEwQixJQUFJQyx3QkFBd0IsUUFBUSx5RUFBeUU7QUFDOUksT0FBT0MsV0FBVyxNQUFNLCtD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