// Copyright 2015-2022, University of Colorado Boulder

/**
 * Model for the "Light Bulb" circuit, which extends ParallelCircuit.  This circuit is composed of a battery, capacitor
 * and a light bulb.  The capacitor is connected to a switch so that it can be connected to either the light bulb OR
 * the battery, but not both at the same time.  The capacitor can also be entirely disconnected from the circuit. This
 * is illustrated in the following diagram:
 *
 * +---+ + +----+
 * |      /     |
 * |     |      |
 * B     C      Z
 * |     |      |
 * |      \     |
 * +---+ + +----+
 *
 * B = Battery
 * C = Capacitor, connected in parallel through switches
 * Z = Light Bulb
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 * @author Andrew Adare (PhET Interactive Simulations)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import Vector3 from '../../../../dot/js/Vector3.js';
import capacitorLabBasics from '../../capacitorLabBasics.js';
import CLBConstants from '../../common/CLBConstants.js';
import CircuitPosition from '../../common/model/CircuitPosition.js';
import CircuitState from '../../common/model/CircuitState.js';
import LightBulb from '../../common/model/LightBulb.js';
import ParallelCircuit from '../../common/model/ParallelCircuit.js';

// During exponential voltage drop, circuit voltage crosses this threshold,
// below which we no longer call discharge() so I and V don't tail off forever.
const MIN_VOLTAGE = 1e-3; // Volts. Minimum readable value on voltmeter.

class LightBulbCircuit extends ParallelCircuit {
  /**
   * @param {CircuitConfig} config
   * @param {Tandem} tandem
   */
  constructor(config, tandem) {
    // Initialize a lightBulb
    const bulbPosition = new Vector3(CLBConstants.BATTERY_POSITION.x + config.capacitorXSpacing + CLBConstants.LIGHT_BULB_X_SPACING, CLBConstants.BATTERY_POSITION.y + config.capacitorYSpacing, CLBConstants.BATTERY_POSITION.z);
    const lightBulb = new LightBulb(bulbPosition, config.modelViewTransform);
    config.lightBulb = lightBulb;
    super(config, tandem);

    // @public {LightBulb}
    this.lightBulb = lightBulb;

    // Make sure that the charges are correct when the battery is reconnected to the circuit.
    this.circuitConnectionProperty.link(circuitConnection => {
      /*
       * When disconnecting the battery, set the disconnected plate charge to whatever the total plate charge was with
       * the battery connected.  Need to do this before changing the plate voltages property.
       */
      if (circuitConnection !== CircuitState.BATTERY_CONNECTED) {
        this.disconnectedPlateChargeProperty.set(this.getTotalCharge());
      }
      this.updatePlateVoltages();
    });

    // Allow the capacitor to discharge when adjusting the plate geometry.
    Multilink.multilink([this.capacitor.plateSizeProperty, this.capacitor.plateSeparationProperty], () => {
      // Don't discharge the capacitor when we're connected to the battery (since the amount of charge changes to
      // compensate). See https://github.com/phetsims/capacitor-lab-basics/issues/282
      if (this.circuitConnectionProperty.value === CircuitState.LIGHT_BULB_CONNECTED && Math.abs(this.capacitor.plateVoltageProperty.value) > MIN_VOLTAGE) {
        this.capacitor.discharge(this.lightBulb.resistance, 0);
      }
    });
  }

  /**
   * LightBulbCircuit model update function
   * @public
   * @override
   *
   * @param {number} dt time step in seconds
   */
  step(dt) {
    // Step through common circuit components
    super.step(dt);

    // Discharge the capacitor when it is in parallel with the light bulb,
    // but don't allow the voltage to taper to zero forever.
    // This is both for performance, and for better timing control.
    // The current arrows should start fading when the voltmeter reading drops
    // below MIN_VOLTAGE.
    if (this.circuitConnectionProperty.value === CircuitState.LIGHT_BULB_CONNECTED) {
      if (Math.abs(this.capacitor.plateVoltageProperty.value) > MIN_VOLTAGE) {
        this.capacitor.discharge(this.lightBulb.resistance, dt);
      } else {
        this.capacitor.plateVoltageProperty.set(0);
        this.currentAmplitudeProperty.set(0);
        this.previousTotalCharge = 0; // This fixes #130
      }
    }
  }

  /**
   * Updates the plate voltage, depending on whether the battery is connected.
   * Null check required because superclass calls this method from its constructor.
   * Remember to call this method at the end of this class' constructor.
   * @public
   */
  updatePlateVoltages() {
    // If the battery is connected, the voltage is equal to the battery voltage
    if (this.circuitConnectionProperty !== undefined) {
      if (this.circuitConnectionProperty.value === CircuitState.BATTERY_CONNECTED) {
        this.capacitor.plateVoltageProperty.value = this.battery.voltageProperty.value;
      }
      // If circuit is open, use V = Q/C
      else if (this.circuitConnectionProperty.value === CircuitState.OPEN_CIRCUIT) {
        this.capacitor.plateVoltageProperty.value = this.disconnectedPlateChargeProperty.value / this.capacitor.capacitanceProperty.value;
      }
    }
  }

  /**
   * Assert that position is either CircuitPosition.LIGHT_BULB_TOP or BOTTOM.
   * @private
   *
   * @param {CircuitPosition} position
   */
  validatePosition(position) {
    assert && assert(position === CircuitPosition.LIGHT_BULB_TOP || position === CircuitPosition.LIGHT_BULB_BOTTOM, `position should be LIGHT_BULB_TOP or LIGHT_BULB_BOTTOM, received ${position}`);
  }

  /**
   * Update the current amplitude depending on the circuit connection.  If the capacitor is connected to the light
   * bulb, find the current by I = V / R.  Otherwise, current is found by dQ/dT.
   * @public
   *
   * @param {number} dt
   */
  updateCurrentAmplitude(dt) {
    // if the circuit is connected to the light bulb, I = V / R
    if (this.circuitConnectionProperty.value === CircuitState.LIGHT_BULB_CONNECTED) {
      let current = this.capacitor.plateVoltageProperty.value / this.lightBulb.resistance;

      // The cutoff is doubled here for #58
      if (Math.abs(current) < 2 * MIN_VOLTAGE / this.lightBulb.resistance) {
        current = 0;
      }
      this.currentAmplitudeProperty.set(current);
    }

    // otherise, I = dQ/dT
    else {
      super.updateCurrentAmplitude(dt);
    }
  }
}
capacitorLabBasics.register('LightBulbCircuit', LightBulbCircuit);
export default LightBulbCircuit;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJWZWN0b3IzIiwiY2FwYWNpdG9yTGFiQmFzaWNzIiwiQ0xCQ29uc3RhbnRzIiwiQ2lyY3VpdFBvc2l0aW9uIiwiQ2lyY3VpdFN0YXRlIiwiTGlnaHRCdWxiIiwiUGFyYWxsZWxDaXJjdWl0IiwiTUlOX1ZPTFRBR0UiLCJMaWdodEJ1bGJDaXJjdWl0IiwiY29uc3RydWN0b3IiLCJjb25maWciLCJ0YW5kZW0iLCJidWxiUG9zaXRpb24iLCJCQVRURVJZX1BPU0lUSU9OIiwieCIsImNhcGFjaXRvclhTcGFjaW5nIiwiTElHSFRfQlVMQl9YX1NQQUNJTkciLCJ5IiwiY2FwYWNpdG9yWVNwYWNpbmciLCJ6IiwibGlnaHRCdWxiIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwiY2lyY3VpdENvbm5lY3Rpb25Qcm9wZXJ0eSIsImxpbmsiLCJjaXJjdWl0Q29ubmVjdGlvbiIsIkJBVFRFUllfQ09OTkVDVEVEIiwiZGlzY29ubmVjdGVkUGxhdGVDaGFyZ2VQcm9wZXJ0eSIsInNldCIsImdldFRvdGFsQ2hhcmdlIiwidXBkYXRlUGxhdGVWb2x0YWdlcyIsIm11bHRpbGluayIsImNhcGFjaXRvciIsInBsYXRlU2l6ZVByb3BlcnR5IiwicGxhdGVTZXBhcmF0aW9uUHJvcGVydHkiLCJ2YWx1ZSIsIkxJR0hUX0JVTEJfQ09OTkVDVEVEIiwiTWF0aCIsImFicyIsInBsYXRlVm9sdGFnZVByb3BlcnR5IiwiZGlzY2hhcmdlIiwicmVzaXN0YW5jZSIsInN0ZXAiLCJkdCIsImN1cnJlbnRBbXBsaXR1ZGVQcm9wZXJ0eSIsInByZXZpb3VzVG90YWxDaGFyZ2UiLCJ1bmRlZmluZWQiLCJiYXR0ZXJ5Iiwidm9sdGFnZVByb3BlcnR5IiwiT1BFTl9DSVJDVUlUIiwiY2FwYWNpdGFuY2VQcm9wZXJ0eSIsInZhbGlkYXRlUG9zaXRpb24iLCJwb3NpdGlvbiIsImFzc2VydCIsIkxJR0hUX0JVTEJfVE9QIiwiTElHSFRfQlVMQl9CT1RUT00iLCJ1cGRhdGVDdXJyZW50QW1wbGl0dWRlIiwiY3VycmVudCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTGlnaHRCdWxiQ2lyY3VpdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNb2RlbCBmb3IgdGhlIFwiTGlnaHQgQnVsYlwiIGNpcmN1aXQsIHdoaWNoIGV4dGVuZHMgUGFyYWxsZWxDaXJjdWl0LiAgVGhpcyBjaXJjdWl0IGlzIGNvbXBvc2VkIG9mIGEgYmF0dGVyeSwgY2FwYWNpdG9yXHJcbiAqIGFuZCBhIGxpZ2h0IGJ1bGIuICBUaGUgY2FwYWNpdG9yIGlzIGNvbm5lY3RlZCB0byBhIHN3aXRjaCBzbyB0aGF0IGl0IGNhbiBiZSBjb25uZWN0ZWQgdG8gZWl0aGVyIHRoZSBsaWdodCBidWxiIE9SXHJcbiAqIHRoZSBiYXR0ZXJ5LCBidXQgbm90IGJvdGggYXQgdGhlIHNhbWUgdGltZS4gIFRoZSBjYXBhY2l0b3IgY2FuIGFsc28gYmUgZW50aXJlbHkgZGlzY29ubmVjdGVkIGZyb20gdGhlIGNpcmN1aXQuIFRoaXNcclxuICogaXMgaWxsdXN0cmF0ZWQgaW4gdGhlIGZvbGxvd2luZyBkaWFncmFtOlxyXG4gKlxyXG4gKiArLS0tKyArICstLS0tK1xyXG4gKiB8ICAgICAgLyAgICAgfFxyXG4gKiB8ICAgICB8ICAgICAgfFxyXG4gKiBCICAgICBDICAgICAgWlxyXG4gKiB8ICAgICB8ICAgICAgfFxyXG4gKiB8ICAgICAgXFwgICAgIHxcclxuICogKy0tLSsgKyArLS0tLStcclxuICpcclxuICogQiA9IEJhdHRlcnlcclxuICogQyA9IENhcGFjaXRvciwgY29ubmVjdGVkIGluIHBhcmFsbGVsIHRocm91Z2ggc3dpdGNoZXNcclxuICogWiA9IExpZ2h0IEJ1bGJcclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICogQGF1dGhvciBKZXNzZSBHcmVlbmJlcmcgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgQW5kcmV3IEFkYXJlIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgVmVjdG9yMyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMy5qcyc7XHJcbmltcG9ydCBjYXBhY2l0b3JMYWJCYXNpY3MgZnJvbSAnLi4vLi4vY2FwYWNpdG9yTGFiQmFzaWNzLmpzJztcclxuaW1wb3J0IENMQkNvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vQ0xCQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IENpcmN1aXRQb3NpdGlvbiBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvQ2lyY3VpdFBvc2l0aW9uLmpzJztcclxuaW1wb3J0IENpcmN1aXRTdGF0ZSBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvQ2lyY3VpdFN0YXRlLmpzJztcclxuaW1wb3J0IExpZ2h0QnVsYiBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvTGlnaHRCdWxiLmpzJztcclxuaW1wb3J0IFBhcmFsbGVsQ2lyY3VpdCBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvUGFyYWxsZWxDaXJjdWl0LmpzJztcclxuXHJcbi8vIER1cmluZyBleHBvbmVudGlhbCB2b2x0YWdlIGRyb3AsIGNpcmN1aXQgdm9sdGFnZSBjcm9zc2VzIHRoaXMgdGhyZXNob2xkLFxyXG4vLyBiZWxvdyB3aGljaCB3ZSBubyBsb25nZXIgY2FsbCBkaXNjaGFyZ2UoKSBzbyBJIGFuZCBWIGRvbid0IHRhaWwgb2ZmIGZvcmV2ZXIuXHJcbmNvbnN0IE1JTl9WT0xUQUdFID0gMWUtMzsgLy8gVm9sdHMuIE1pbmltdW0gcmVhZGFibGUgdmFsdWUgb24gdm9sdG1ldGVyLlxyXG5cclxuY2xhc3MgTGlnaHRCdWxiQ2lyY3VpdCBleHRlbmRzIFBhcmFsbGVsQ2lyY3VpdCB7XHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtDaXJjdWl0Q29uZmlnfSBjb25maWdcclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGNvbmZpZywgdGFuZGVtICkge1xyXG5cclxuICAgIC8vIEluaXRpYWxpemUgYSBsaWdodEJ1bGJcclxuICAgIGNvbnN0IGJ1bGJQb3NpdGlvbiA9IG5ldyBWZWN0b3IzKFxyXG4gICAgICBDTEJDb25zdGFudHMuQkFUVEVSWV9QT1NJVElPTi54ICsgY29uZmlnLmNhcGFjaXRvclhTcGFjaW5nICsgQ0xCQ29uc3RhbnRzLkxJR0hUX0JVTEJfWF9TUEFDSU5HLFxyXG4gICAgICBDTEJDb25zdGFudHMuQkFUVEVSWV9QT1NJVElPTi55ICsgY29uZmlnLmNhcGFjaXRvcllTcGFjaW5nLFxyXG4gICAgICBDTEJDb25zdGFudHMuQkFUVEVSWV9QT1NJVElPTi56XHJcbiAgICApO1xyXG4gICAgY29uc3QgbGlnaHRCdWxiID0gbmV3IExpZ2h0QnVsYiggYnVsYlBvc2l0aW9uLCBjb25maWcubW9kZWxWaWV3VHJhbnNmb3JtICk7XHJcbiAgICBjb25maWcubGlnaHRCdWxiID0gbGlnaHRCdWxiO1xyXG5cclxuICAgIHN1cGVyKCBjb25maWcsIHRhbmRlbSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge0xpZ2h0QnVsYn1cclxuICAgIHRoaXMubGlnaHRCdWxiID0gbGlnaHRCdWxiO1xyXG5cclxuICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBjaGFyZ2VzIGFyZSBjb3JyZWN0IHdoZW4gdGhlIGJhdHRlcnkgaXMgcmVjb25uZWN0ZWQgdG8gdGhlIGNpcmN1aXQuXHJcbiAgICB0aGlzLmNpcmN1aXRDb25uZWN0aW9uUHJvcGVydHkubGluayggY2lyY3VpdENvbm5lY3Rpb24gPT4ge1xyXG4gICAgICAvKlxyXG4gICAgICAgKiBXaGVuIGRpc2Nvbm5lY3RpbmcgdGhlIGJhdHRlcnksIHNldCB0aGUgZGlzY29ubmVjdGVkIHBsYXRlIGNoYXJnZSB0byB3aGF0ZXZlciB0aGUgdG90YWwgcGxhdGUgY2hhcmdlIHdhcyB3aXRoXHJcbiAgICAgICAqIHRoZSBiYXR0ZXJ5IGNvbm5lY3RlZC4gIE5lZWQgdG8gZG8gdGhpcyBiZWZvcmUgY2hhbmdpbmcgdGhlIHBsYXRlIHZvbHRhZ2VzIHByb3BlcnR5LlxyXG4gICAgICAgKi9cclxuICAgICAgaWYgKCBjaXJjdWl0Q29ubmVjdGlvbiAhPT0gQ2lyY3VpdFN0YXRlLkJBVFRFUllfQ09OTkVDVEVEICkge1xyXG4gICAgICAgIHRoaXMuZGlzY29ubmVjdGVkUGxhdGVDaGFyZ2VQcm9wZXJ0eS5zZXQoIHRoaXMuZ2V0VG90YWxDaGFyZ2UoKSApO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudXBkYXRlUGxhdGVWb2x0YWdlcygpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEFsbG93IHRoZSBjYXBhY2l0b3IgdG8gZGlzY2hhcmdlIHdoZW4gYWRqdXN0aW5nIHRoZSBwbGF0ZSBnZW9tZXRyeS5cclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgdGhpcy5jYXBhY2l0b3IucGxhdGVTaXplUHJvcGVydHksIHRoaXMuY2FwYWNpdG9yLnBsYXRlU2VwYXJhdGlvblByb3BlcnR5IF0sXHJcbiAgICAgICgpID0+IHtcclxuICAgICAgICAvLyBEb24ndCBkaXNjaGFyZ2UgdGhlIGNhcGFjaXRvciB3aGVuIHdlJ3JlIGNvbm5lY3RlZCB0byB0aGUgYmF0dGVyeSAoc2luY2UgdGhlIGFtb3VudCBvZiBjaGFyZ2UgY2hhbmdlcyB0b1xyXG4gICAgICAgIC8vIGNvbXBlbnNhdGUpLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NhcGFjaXRvci1sYWItYmFzaWNzL2lzc3Vlcy8yODJcclxuICAgICAgICBpZiAoIHRoaXMuY2lyY3VpdENvbm5lY3Rpb25Qcm9wZXJ0eS52YWx1ZSA9PT0gQ2lyY3VpdFN0YXRlLkxJR0hUX0JVTEJfQ09OTkVDVEVEICYmXHJcbiAgICAgICAgICAgICBNYXRoLmFicyggdGhpcy5jYXBhY2l0b3IucGxhdGVWb2x0YWdlUHJvcGVydHkudmFsdWUgKSA+IE1JTl9WT0xUQUdFICkge1xyXG4gICAgICAgICAgdGhpcy5jYXBhY2l0b3IuZGlzY2hhcmdlKCB0aGlzLmxpZ2h0QnVsYi5yZXNpc3RhbmNlLCAwICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9ICk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogTGlnaHRCdWxiQ2lyY3VpdCBtb2RlbCB1cGRhdGUgZnVuY3Rpb25cclxuICAgKiBAcHVibGljXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHQgdGltZSBzdGVwIGluIHNlY29uZHNcclxuICAgKi9cclxuICBzdGVwKCBkdCApIHtcclxuXHJcbiAgICAvLyBTdGVwIHRocm91Z2ggY29tbW9uIGNpcmN1aXQgY29tcG9uZW50c1xyXG4gICAgc3VwZXIuc3RlcCggZHQgKTtcclxuXHJcbiAgICAvLyBEaXNjaGFyZ2UgdGhlIGNhcGFjaXRvciB3aGVuIGl0IGlzIGluIHBhcmFsbGVsIHdpdGggdGhlIGxpZ2h0IGJ1bGIsXHJcbiAgICAvLyBidXQgZG9uJ3QgYWxsb3cgdGhlIHZvbHRhZ2UgdG8gdGFwZXIgdG8gemVybyBmb3JldmVyLlxyXG4gICAgLy8gVGhpcyBpcyBib3RoIGZvciBwZXJmb3JtYW5jZSwgYW5kIGZvciBiZXR0ZXIgdGltaW5nIGNvbnRyb2wuXHJcbiAgICAvLyBUaGUgY3VycmVudCBhcnJvd3Mgc2hvdWxkIHN0YXJ0IGZhZGluZyB3aGVuIHRoZSB2b2x0bWV0ZXIgcmVhZGluZyBkcm9wc1xyXG4gICAgLy8gYmVsb3cgTUlOX1ZPTFRBR0UuXHJcbiAgICBpZiAoIHRoaXMuY2lyY3VpdENvbm5lY3Rpb25Qcm9wZXJ0eS52YWx1ZSA9PT0gQ2lyY3VpdFN0YXRlLkxJR0hUX0JVTEJfQ09OTkVDVEVEICkge1xyXG4gICAgICBpZiAoIE1hdGguYWJzKCB0aGlzLmNhcGFjaXRvci5wbGF0ZVZvbHRhZ2VQcm9wZXJ0eS52YWx1ZSApID4gTUlOX1ZPTFRBR0UgKSB7XHJcbiAgICAgICAgdGhpcy5jYXBhY2l0b3IuZGlzY2hhcmdlKCB0aGlzLmxpZ2h0QnVsYi5yZXNpc3RhbmNlLCBkdCApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICB0aGlzLmNhcGFjaXRvci5wbGF0ZVZvbHRhZ2VQcm9wZXJ0eS5zZXQoIDAgKTtcclxuICAgICAgICB0aGlzLmN1cnJlbnRBbXBsaXR1ZGVQcm9wZXJ0eS5zZXQoIDAgKTtcclxuICAgICAgICB0aGlzLnByZXZpb3VzVG90YWxDaGFyZ2UgPSAwOyAvLyBUaGlzIGZpeGVzICMxMzBcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhlIHBsYXRlIHZvbHRhZ2UsIGRlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSBiYXR0ZXJ5IGlzIGNvbm5lY3RlZC5cclxuICAgKiBOdWxsIGNoZWNrIHJlcXVpcmVkIGJlY2F1c2Ugc3VwZXJjbGFzcyBjYWxscyB0aGlzIG1ldGhvZCBmcm9tIGl0cyBjb25zdHJ1Y3Rvci5cclxuICAgKiBSZW1lbWJlciB0byBjYWxsIHRoaXMgbWV0aG9kIGF0IHRoZSBlbmQgb2YgdGhpcyBjbGFzcycgY29uc3RydWN0b3IuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHVwZGF0ZVBsYXRlVm9sdGFnZXMoKSB7XHJcbiAgICAvLyBJZiB0aGUgYmF0dGVyeSBpcyBjb25uZWN0ZWQsIHRoZSB2b2x0YWdlIGlzIGVxdWFsIHRvIHRoZSBiYXR0ZXJ5IHZvbHRhZ2VcclxuICAgIGlmICggdGhpcy5jaXJjdWl0Q29ubmVjdGlvblByb3BlcnR5ICE9PSB1bmRlZmluZWQgKSB7XHJcbiAgICAgIGlmICggdGhpcy5jaXJjdWl0Q29ubmVjdGlvblByb3BlcnR5LnZhbHVlID09PSBDaXJjdWl0U3RhdGUuQkFUVEVSWV9DT05ORUNURUQgKSB7XHJcbiAgICAgICAgdGhpcy5jYXBhY2l0b3IucGxhdGVWb2x0YWdlUHJvcGVydHkudmFsdWUgPSB0aGlzLmJhdHRlcnkudm9sdGFnZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIElmIGNpcmN1aXQgaXMgb3BlbiwgdXNlIFYgPSBRL0NcclxuICAgICAgZWxzZSBpZiAoIHRoaXMuY2lyY3VpdENvbm5lY3Rpb25Qcm9wZXJ0eS52YWx1ZSA9PT0gQ2lyY3VpdFN0YXRlLk9QRU5fQ0lSQ1VJVCApIHtcclxuICAgICAgICB0aGlzLmNhcGFjaXRvci5wbGF0ZVZvbHRhZ2VQcm9wZXJ0eS52YWx1ZSA9XHJcbiAgICAgICAgICB0aGlzLmRpc2Nvbm5lY3RlZFBsYXRlQ2hhcmdlUHJvcGVydHkudmFsdWUgLyB0aGlzLmNhcGFjaXRvci5jYXBhY2l0YW5jZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBc3NlcnQgdGhhdCBwb3NpdGlvbiBpcyBlaXRoZXIgQ2lyY3VpdFBvc2l0aW9uLkxJR0hUX0JVTEJfVE9QIG9yIEJPVFRPTS5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtDaXJjdWl0UG9zaXRpb259IHBvc2l0aW9uXHJcbiAgICovXHJcbiAgdmFsaWRhdGVQb3NpdGlvbiggcG9zaXRpb24gKSB7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggcG9zaXRpb24gPT09IENpcmN1aXRQb3NpdGlvbi5MSUdIVF9CVUxCX1RPUCB8fCBwb3NpdGlvbiA9PT0gQ2lyY3VpdFBvc2l0aW9uLkxJR0hUX0JVTEJfQk9UVE9NLFxyXG4gICAgICBgcG9zaXRpb24gc2hvdWxkIGJlIExJR0hUX0JVTEJfVE9QIG9yIExJR0hUX0JVTEJfQk9UVE9NLCByZWNlaXZlZCAke3Bvc2l0aW9ufWAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSB0aGUgY3VycmVudCBhbXBsaXR1ZGUgZGVwZW5kaW5nIG9uIHRoZSBjaXJjdWl0IGNvbm5lY3Rpb24uICBJZiB0aGUgY2FwYWNpdG9yIGlzIGNvbm5lY3RlZCB0byB0aGUgbGlnaHRcclxuICAgKiBidWxiLCBmaW5kIHRoZSBjdXJyZW50IGJ5IEkgPSBWIC8gUi4gIE90aGVyd2lzZSwgY3VycmVudCBpcyBmb3VuZCBieSBkUS9kVC5cclxuICAgKiBAcHVibGljXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHRcclxuICAgKi9cclxuICB1cGRhdGVDdXJyZW50QW1wbGl0dWRlKCBkdCApIHtcclxuXHJcbiAgICAvLyBpZiB0aGUgY2lyY3VpdCBpcyBjb25uZWN0ZWQgdG8gdGhlIGxpZ2h0IGJ1bGIsIEkgPSBWIC8gUlxyXG4gICAgaWYgKCB0aGlzLmNpcmN1aXRDb25uZWN0aW9uUHJvcGVydHkudmFsdWUgPT09IENpcmN1aXRTdGF0ZS5MSUdIVF9CVUxCX0NPTk5FQ1RFRCApIHtcclxuICAgICAgbGV0IGN1cnJlbnQgPSB0aGlzLmNhcGFjaXRvci5wbGF0ZVZvbHRhZ2VQcm9wZXJ0eS52YWx1ZSAvIHRoaXMubGlnaHRCdWxiLnJlc2lzdGFuY2U7XHJcblxyXG4gICAgICAvLyBUaGUgY3V0b2ZmIGlzIGRvdWJsZWQgaGVyZSBmb3IgIzU4XHJcbiAgICAgIGlmICggTWF0aC5hYnMoIGN1cnJlbnQgKSA8IDIgKiBNSU5fVk9MVEFHRSAvIHRoaXMubGlnaHRCdWxiLnJlc2lzdGFuY2UgKSB7XHJcbiAgICAgICAgY3VycmVudCA9IDA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuY3VycmVudEFtcGxpdHVkZVByb3BlcnR5LnNldCggY3VycmVudCApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIG90aGVyaXNlLCBJID0gZFEvZFRcclxuICAgIGVsc2Uge1xyXG4gICAgICBzdXBlci51cGRhdGVDdXJyZW50QW1wbGl0dWRlKCBkdCApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuY2FwYWNpdG9yTGFiQmFzaWNzLnJlZ2lzdGVyKCAnTGlnaHRCdWxiQ2lyY3VpdCcsIExpZ2h0QnVsYkNpcmN1aXQgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IExpZ2h0QnVsYkNpcmN1aXQ7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLGtCQUFrQixNQUFNLDZCQUE2QjtBQUM1RCxPQUFPQyxZQUFZLE1BQU0sOEJBQThCO0FBQ3ZELE9BQU9DLGVBQWUsTUFBTSx1Q0FBdUM7QUFDbkUsT0FBT0MsWUFBWSxNQUFNLG9DQUFvQztBQUM3RCxPQUFPQyxTQUFTLE1BQU0saUNBQWlDO0FBQ3ZELE9BQU9DLGVBQWUsTUFBTSx1Q0FBdUM7O0FBRW5FO0FBQ0E7QUFDQSxNQUFNQyxXQUFXLEdBQUcsSUFBSSxDQUFDLENBQUM7O0FBRTFCLE1BQU1DLGdCQUFnQixTQUFTRixlQUFlLENBQUM7RUFDN0M7QUFDRjtBQUNBO0FBQ0E7RUFDRUcsV0FBV0EsQ0FBRUMsTUFBTSxFQUFFQyxNQUFNLEVBQUc7SUFFNUI7SUFDQSxNQUFNQyxZQUFZLEdBQUcsSUFBSVosT0FBTyxDQUM5QkUsWUFBWSxDQUFDVyxnQkFBZ0IsQ0FBQ0MsQ0FBQyxHQUFHSixNQUFNLENBQUNLLGlCQUFpQixHQUFHYixZQUFZLENBQUNjLG9CQUFvQixFQUM5RmQsWUFBWSxDQUFDVyxnQkFBZ0IsQ0FBQ0ksQ0FBQyxHQUFHUCxNQUFNLENBQUNRLGlCQUFpQixFQUMxRGhCLFlBQVksQ0FBQ1csZ0JBQWdCLENBQUNNLENBQ2hDLENBQUM7SUFDRCxNQUFNQyxTQUFTLEdBQUcsSUFBSWYsU0FBUyxDQUFFTyxZQUFZLEVBQUVGLE1BQU0sQ0FBQ1csa0JBQW1CLENBQUM7SUFDMUVYLE1BQU0sQ0FB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