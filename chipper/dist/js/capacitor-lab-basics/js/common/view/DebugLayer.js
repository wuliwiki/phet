// Copyright 2017-2022, University of Colorado Boulder

/**
 * Handles displaying debugging information for showDebugAreas (where the voltmeter tips will intersect things)
 *
 * @author Jonathan Olson (PhET Interactive Simulations)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import { Shape } from '../../../../kite/js/imports.js';
import CapacitorConstants from '../../../../scenery-phet/js/capacitor/CapacitorConstants.js';
import { Node, Path } from '../../../../scenery/js/imports.js';
import capacitorLabBasics from '../../capacitorLabBasics.js';
import CLBConstants from '../CLBConstants.js';
import CLBQueryParameters from '../CLBQueryParameters.js';
import CircuitPosition from '../model/CircuitPosition.js';
import CircuitState from '../model/CircuitState.js';
class DebugLayer extends Node {
  /**
   * @param {CLBModel} model
   */
  constructor(model) {
    super();

    /*
     * TODO: shapeTouchesWireGroup uses intersectsBounds?
     * TODO: Capacitor contains point is only using 1 point (the probe bounds-center)
     * TODO: Battery contains only checks bounds intersection
     * TODO: Light bulb base intersection uses intersectsBounds
     */

    // Don't do anything else unless debugging is enabled
    if (!CLBQueryParameters.showDebugAreas) {
      return;
    }
    const circuitPositions = [CircuitPosition.BATTERY_TOP, CircuitPosition.BATTERY_BOTTOM, CircuitPosition.CAPACITOR_TOP, CircuitPosition.CAPACITOR_BOTTOM];
    if (model.circuit.lightBulb) {
      circuitPositions.push(CircuitPosition.LIGHT_BULB_TOP);
      circuitPositions.push(CircuitPosition.LIGHT_BULB_BOTTOM);
    }
    circuitPositions.forEach(circuitPosition => {
      const wires = model.circuit.wireGroup[circuitPosition];
      wires.forEach(wire => {
        const wirePath = new Path(null, {
          stroke: 'blue'
        });
        this.addChild(wirePath);
        wire.shapeProperty.link(shape => {
          wirePath.shape = shape;
        });
      });
    });

    // capacitor top
    const capacitorContainer = new Node();
    this.addChild(capacitorContainer);
    const capacitor = model.circuit.capacitor;
    Multilink.multilink([capacitor.plateSizeProperty, capacitor.plateSeparationProperty], (size, separation) => {
      capacitorContainer.children = [new Path(capacitor.shapeCreator.createBoxShape(capacitor.position.x, capacitor.getTopConnectionPoint().y, capacitor.position.z, size.width, size.height, size.depth), {
        stroke: 'blue'
      }), new Path(capacitor.shapeCreator.createBoxShape(capacitor.position.x, capacitor.position.y + separation / 2, capacitor.position.z, size.width, size.height, size.depth), {
        stroke: 'blue'
      })];
    });
    const topSwitchContainer = new Node();
    this.addChild(topSwitchContainer);
    capacitor.topCircuitSwitch.circuitConnectionProperty.link(circuitConnection => {
      topSwitchContainer.removeAllChildren();
      if (circuitConnection !== CircuitState.SWITCH_IN_TRANSIT && circuitConnection !== CircuitState.OPEN_CIRCUIT) {
        const endPoint = capacitor.topCircuitSwitch.switchSegment.endPointProperty.value;
        const hingePoint = capacitor.topCircuitSwitch.switchSegment.hingePoint;
        const delta = endPoint.minus(hingePoint).setMagnitude(CLBConstants.SWITCH_WIRE_LENGTH);
        const point = model.modelViewTransform.modelToViewPosition(hingePoint.plus(delta));
        topSwitchContainer.addChild(new Path(Shape.circle(point.x, point.y, CLBConstants.CONNECTION_POINT_RADIUS), {
          stroke: 'blue'
        }));
      }
    });
    const bottomSwitchContainer = new Node();
    this.addChild(bottomSwitchContainer);
    capacitor.bottomCircuitSwitch.circuitConnectionProperty.link(circuitConnection => {
      bottomSwitchContainer.removeAllChildren();
      if (circuitConnection !== CircuitState.SWITCH_IN_TRANSIT && circuitConnection !== CircuitState.OPEN_CIRCUIT) {
        const endPoint = capacitor.bottomCircuitSwitch.switchSegment.endPointProperty.value;
        const hingePoint = capacitor.bottomCircuitSwitch.switchSegment.hingePoint;
        const delta = endPoint.minus(hingePoint).setMagnitude(CLBConstants.SWITCH_WIRE_LENGTH);
        const point = model.modelViewTransform.modelToViewPosition(hingePoint.plus(delta));
        bottomSwitchContainer.addChild(new Path(Shape.circle(point.x, point.y, CLBConstants.CONNECTION_POINT_RADIUS), {
          stroke: 'blue'
        }));
      }
    });
    const terminalContainer = new Node();
    this.addChild(terminalContainer);
    const battery = model.circuit.battery;
    battery.polarityProperty.link(polarity => {
      terminalContainer.children = [new Path(polarity === CapacitorConstants.POLARITY.POSITIVE ? battery.shapeCreator.createPositiveTerminalShape() : battery.shapeCreator.createNegativeTerminalShape(), {
        stroke: 'blue'
      })];
    });
    if (model.circuit.lightBulb) {
      this.addChild(new Path(model.circuit.lightBulb.shapeCreator.createTopBaseShape(), {
        stroke: 'blue'
      }));
      this.addChild(new Path(model.circuit.lightBulb.shapeCreator.createBottomBaseShape(), {
        stroke: 'blue'
      }));
    }
    const positiveVoltmeterNode = new Node();
    this.addChild(positiveVoltmeterNode);
    const negativeVoltmeterNode = new Node();
    this.addChild(negativeVoltmeterNode);
    model.voltmeter.positiveProbePositionProperty.link(() => {
      positiveVoltmeterNode.children = [new Path(model.voltmeter.shapeCreator.getPositiveProbeTipShape(), {
        stroke: 'blue'
      })];
    });
    model.voltmeter.negativeProbePositionProperty.link(() => {
      negativeVoltmeterNode.children = [new Path(model.voltmeter.shapeCreator.getNegativeProbeTipShape(), {
        stroke: 'blue'
      })];
    });
  }
}
capacitorLabBasics.register('DebugLayer', DebugLayer);
export default DebugLayer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJTaGFwZSIsIkNhcGFjaXRvckNvbnN0YW50cyIsIk5vZGUiLCJQYXRoIiwiY2FwYWNpdG9yTGFiQmFzaWNzIiwiQ0xCQ29uc3RhbnRzIiwiQ0xCUXVlcnlQYXJhbWV0ZXJzIiwiQ2lyY3VpdFBvc2l0aW9uIiwiQ2lyY3VpdFN0YXRlIiwiRGVidWdMYXllciIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJzaG93RGVidWdBcmVhcyIsImNpcmN1aXRQb3NpdGlvbnMiLCJCQVRURVJZX1RPUCIsIkJBVFRFUllfQk9UVE9NIiwiQ0FQQUNJVE9SX1RPUCIsIkNBUEFDSVRPUl9CT1RUT00iLCJjaXJjdWl0IiwibGlnaHRCdWxiIiwicHVzaCIsIkxJR0hUX0JVTEJfVE9QIiwiTElHSFRfQlVMQl9CT1RUT00iLCJmb3JFYWNoIiwiY2lyY3VpdFBvc2l0aW9uIiwid2lyZXMiLCJ3aXJlR3JvdXAiLCJ3aXJlIiwid2lyZVBhdGgiLCJzdHJva2UiLCJhZGRDaGlsZCIsInNoYXBlUHJvcGVydHkiLCJsaW5rIiwic2hhcGUiLCJjYXBhY2l0b3JDb250YWluZXIiLCJjYXBhY2l0b3IiLCJtdWx0aWxpbmsiLCJwbGF0ZVNpemVQcm9wZXJ0eSIsInBsYXRlU2VwYXJhdGlvblByb3BlcnR5Iiwic2l6ZSIsInNlcGFyYXRpb24iLCJjaGlsZHJlbiIsInNoYXBlQ3JlYXRvciIsImNyZWF0ZUJveFNoYXBlIiwicG9zaXRpb24iLCJ4IiwiZ2V0VG9wQ29ubmVjdGlvblBvaW50IiwieSIsInoiLCJ3aWR0aCIsImhlaWdodCIsImRlcHRoIiwidG9wU3dpdGNoQ29udGFpbmVyIiwidG9wQ2lyY3VpdFN3aXRjaCIsImNpcmN1aXRDb25uZWN0aW9uUHJvcGVydHkiLCJjaXJjdWl0Q29ubmVjdGlvbiIsInJlbW92ZUFsbENoaWxkcmVuIiwiU1dJVENIX0lOX1RSQU5TSVQiLCJPUEVOX0NJUkNVSVQiLCJlbmRQb2ludCIsInN3aXRjaFNlZ21lbnQiLCJlbmRQb2ludFByb3BlcnR5IiwidmFsdWUiLCJoaW5nZVBvaW50IiwiZGVsdGEiLCJtaW51cyIsInNldE1hZ25pdHVkZSIsIlNXSVRDSF9XSVJFX0xFTkdUSCIsInBvaW50IiwibW9kZWxWaWV3VHJhbnNmb3JtIiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsInBsdXMiLCJjaXJjbGUiLCJDT05ORUNUSU9OX1BPSU5UX1JBRElVUyIsImJvdHRvbVN3aXRjaENvbnRhaW5lciIsImJvdHRvbUNpcmN1aXRTd2l0Y2giLCJ0ZXJtaW5hbENvbnRhaW5lciIsImJhdHRlcnkiLCJwb2xhcml0eVByb3BlcnR5IiwicG9sYXJpdHkiLCJQT0xBUklUWSIsIlBPU0lUSVZFIiwiY3JlYXRlUG9zaXRpdmVUZXJtaW5hbFNoYXBlIiwiY3JlYXRlTmVnYXRpdmVUZXJtaW5hbFNoYXBlIiwiY3JlYXRlVG9wQmFzZVNoYXBlIiwiY3JlYXRlQm90dG9tQmFzZVNoYXBlIiwicG9zaXRpdmVWb2x0bWV0ZXJOb2RlIiwibmVnYXRpdmVWb2x0bWV0ZXJOb2RlIiwidm9sdG1ldGVyIiwicG9zaXRpdmVQcm9iZVBvc2l0aW9uUHJvcGVydHkiLCJnZXRQb3NpdGl2ZVByb2JlVGlwU2hhcGUiLCJuZWdhdGl2ZVByb2JlUG9zaXRpb25Qcm9wZXJ0eSIsImdldE5lZ2F0aXZlUHJvYmVUaXBTaGFwZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRGVidWdMYXllci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBIYW5kbGVzIGRpc3BsYXlpbmcgZGVidWdnaW5nIGluZm9ybWF0aW9uIGZvciBzaG93RGVidWdBcmVhcyAod2hlcmUgdGhlIHZvbHRtZXRlciB0aXBzIHdpbGwgaW50ZXJzZWN0IHRoaW5ncylcclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IHsgU2hhcGUgfSBmcm9tICcuLi8uLi8uLi8uLi9raXRlL2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgQ2FwYWNpdG9yQ29uc3RhbnRzIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9jYXBhY2l0b3IvQ2FwYWNpdG9yQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgUGF0aCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBjYXBhY2l0b3JMYWJCYXNpY3MgZnJvbSAnLi4vLi4vY2FwYWNpdG9yTGFiQmFzaWNzLmpzJztcclxuaW1wb3J0IENMQkNvbnN0YW50cyBmcm9tICcuLi9DTEJDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgQ0xCUXVlcnlQYXJhbWV0ZXJzIGZyb20gJy4uL0NMQlF1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCBDaXJjdWl0UG9zaXRpb24gZnJvbSAnLi4vbW9kZWwvQ2lyY3VpdFBvc2l0aW9uLmpzJztcclxuaW1wb3J0IENpcmN1aXRTdGF0ZSBmcm9tICcuLi9tb2RlbC9DaXJjdWl0U3RhdGUuanMnO1xyXG5cclxuY2xhc3MgRGVidWdMYXllciBleHRlbmRzIE5vZGUge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7Q0xCTW9kZWx9IG1vZGVsXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsICkge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICAvKlxyXG4gICAgICogVE9ETzogc2hhcGVUb3VjaGVzV2lyZUdyb3VwIHVzZXMgaW50ZXJzZWN0c0JvdW5kcz9cclxuICAgICAqIFRPRE86IENhcGFjaXRvciBjb250YWlucyBwb2ludCBpcyBvbmx5IHVzaW5nIDEgcG9pbnQgKHRoZSBwcm9iZSBib3VuZHMtY2VudGVyKVxyXG4gICAgICogVE9ETzogQmF0dGVyeSBjb250YWlucyBvbmx5IGNoZWNrcyBib3VuZHMgaW50ZXJzZWN0aW9uXHJcbiAgICAgKiBUT0RPOiBMaWdodCBidWxiIGJhc2UgaW50ZXJzZWN0aW9uIHVzZXMgaW50ZXJzZWN0c0JvdW5kc1xyXG4gICAgICovXHJcblxyXG4gICAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgZWxzZSB1bmxlc3MgZGVidWdnaW5nIGlzIGVuYWJsZWRcclxuICAgIGlmICggIUNMQlF1ZXJ5UGFyYW1ldGVycy5zaG93RGVidWdBcmVhcyApIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgY29uc3QgY2lyY3VpdFBvc2l0aW9ucyA9IFtcclxuICAgICAgQ2lyY3VpdFBvc2l0aW9uLkJBVFRFUllfVE9QLFxyXG4gICAgICBDaXJjdWl0UG9zaXRpb24uQkFUVEVSWV9CT1RUT00sXHJcbiAgICAgIENpcmN1aXRQb3NpdGlvbi5DQVBBQ0lUT1JfVE9QLFxyXG4gICAgICBDaXJjdWl0UG9zaXRpb24uQ0FQQUNJVE9SX0JPVFRPTVxyXG4gICAgXTtcclxuICAgIGlmICggbW9kZWwuY2lyY3VpdC5saWdodEJ1bGIgKSB7XHJcbiAgICAgIGNpcmN1aXRQb3NpdGlvbnMucHVzaCggQ2lyY3VpdFBvc2l0aW9uLkxJR0hUX0JVTEJfVE9QICk7XHJcbiAgICAgIGNpcmN1aXRQb3NpdGlvbnMucHVzaCggQ2lyY3VpdFBvc2l0aW9uLkxJR0hUX0JVTEJfQk9UVE9NICk7XHJcbiAgICB9XHJcblxyXG4gICAgY2lyY3VpdFBvc2l0aW9ucy5mb3JFYWNoKCBjaXJjdWl0UG9zaXRpb24gPT4ge1xyXG4gICAgICBjb25zdCB3aXJlcyA9IG1vZGVsLmNpcmN1aXQud2lyZUdyb3VwWyBjaXJjdWl0UG9zaXRpb24gXTtcclxuXHJcbiAgICAgIHdpcmVzLmZvckVhY2goIHdpcmUgPT4ge1xyXG4gICAgICAgIGNvbnN0IHdpcmVQYXRoID0gbmV3IFBhdGgoIG51bGwsIHtcclxuICAgICAgICAgIHN0cm9rZTogJ2JsdWUnXHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIHRoaXMuYWRkQ2hpbGQoIHdpcmVQYXRoICk7XHJcblxyXG4gICAgICAgIHdpcmUuc2hhcGVQcm9wZXJ0eS5saW5rKCBzaGFwZSA9PiB7XHJcbiAgICAgICAgICB3aXJlUGF0aC5zaGFwZSA9IHNoYXBlO1xyXG4gICAgICAgIH0gKTtcclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGNhcGFjaXRvciB0b3BcclxuICAgIGNvbnN0IGNhcGFjaXRvckNvbnRhaW5lciA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBjYXBhY2l0b3JDb250YWluZXIgKTtcclxuICAgIGNvbnN0IGNhcGFjaXRvciA9IG1vZGVsLmNpcmN1aXQuY2FwYWNpdG9yO1xyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBjYXBhY2l0b3IucGxhdGVTaXplUHJvcGVydHksIGNhcGFjaXRvci5wbGF0ZVNlcGFyYXRpb25Qcm9wZXJ0eSBdLCAoIHNpemUsIHNlcGFyYXRpb24gKSA9PiB7XHJcbiAgICAgIGNhcGFjaXRvckNvbnRhaW5lci5jaGlsZHJlbiA9IFtcclxuICAgICAgICBuZXcgUGF0aCggY2FwYWNpdG9yLnNoYXBlQ3JlYXRvci5jcmVhdGVCb3hTaGFwZSggY2FwYWNpdG9yLnBvc2l0aW9uLngsIGNhcGFjaXRvci5nZXRUb3BDb25uZWN0aW9uUG9pbnQoKS55LCBjYXBhY2l0b3IucG9zaXRpb24ueiwgc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQsIHNpemUuZGVwdGggKSwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgICB9ICksXHJcbiAgICAgICAgbmV3IFBhdGgoIGNhcGFjaXRvci5zaGFwZUNyZWF0b3IuY3JlYXRlQm94U2hhcGUoIGNhcGFjaXRvci5wb3NpdGlvbi54LCBjYXBhY2l0b3IucG9zaXRpb24ueSArIHNlcGFyYXRpb24gLyAyLCBjYXBhY2l0b3IucG9zaXRpb24ueiwgc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQsIHNpemUuZGVwdGggKSwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgICB9IClcclxuICAgICAgXTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCB0b3BTd2l0Y2hDb250YWluZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdG9wU3dpdGNoQ29udGFpbmVyICk7XHJcbiAgICBjYXBhY2l0b3IudG9wQ2lyY3VpdFN3aXRjaC5jaXJjdWl0Q29ubmVjdGlvblByb3BlcnR5LmxpbmsoIGNpcmN1aXRDb25uZWN0aW9uID0+IHtcclxuICAgICAgdG9wU3dpdGNoQ29udGFpbmVyLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgICBpZiAoIGNpcmN1aXRDb25uZWN0aW9uICE9PSBDaXJjdWl0U3RhdGUuU1dJVENIX0lOX1RSQU5TSVQgJiYgY2lyY3VpdENvbm5lY3Rpb24gIT09IENpcmN1aXRTdGF0ZS5PUEVOX0NJUkNVSVQgKSB7XHJcbiAgICAgICAgY29uc3QgZW5kUG9pbnQgPSBjYXBhY2l0b3IudG9wQ2lyY3VpdFN3aXRjaC5zd2l0Y2hTZWdtZW50LmVuZFBvaW50UHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgY29uc3QgaGluZ2VQb2ludCA9IGNhcGFjaXRvci50b3BDaXJjdWl0U3dpdGNoLnN3aXRjaFNlZ21lbnQuaGluZ2VQb2ludDtcclxuICAgICAgICBjb25zdCBkZWx0YSA9IGVuZFBvaW50Lm1pbnVzKCBoaW5nZVBvaW50ICkuc2V0TWFnbml0dWRlKCBDTEJDb25zdGFudHMuU1dJVENIX1dJUkVfTEVOR1RIICk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBvaW50ID0gbW9kZWwubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIGhpbmdlUG9pbnQucGx1cyggZGVsdGEgKSApO1xyXG4gICAgICAgIHRvcFN3aXRjaENvbnRhaW5lci5hZGRDaGlsZCggbmV3IFBhdGgoIFNoYXBlLmNpcmNsZSggcG9pbnQueCwgcG9pbnQueSwgQ0xCQ29uc3RhbnRzLkNPTk5FQ1RJT05fUE9JTlRfUkFESVVTICksIHtcclxuICAgICAgICAgIHN0cm9rZTogJ2JsdWUnXHJcbiAgICAgICAgfSApICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBib3R0b21Td2l0Y2hDb250YWluZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggYm90dG9tU3dpdGNoQ29udGFpbmVyICk7XHJcbiAgICBjYXBhY2l0b3IuYm90dG9tQ2lyY3VpdFN3aXRjaC5jaXJjdWl0Q29ubmVjdGlvblByb3BlcnR5LmxpbmsoIGNpcmN1aXRDb25uZWN0aW9uID0+IHtcclxuICAgICAgYm90dG9tU3dpdGNoQ29udGFpbmVyLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgICBpZiAoIGNpcmN1aXRDb25uZWN0aW9uICE9PSBDaXJjdWl0U3RhdGUuU1dJVENIX0lOX1RSQU5TSVQgJiYgY2lyY3VpdENvbm5lY3Rpb24gIT09IENpcmN1aXRTdGF0ZS5PUEVOX0NJUkNVSVQgKSB7XHJcbiAgICAgICAgY29uc3QgZW5kUG9pbnQgPSBjYXBhY2l0b3IuYm90dG9tQ2lyY3VpdFN3aXRjaC5zd2l0Y2hTZWdtZW50LmVuZFBvaW50UHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgY29uc3QgaGluZ2VQb2ludCA9IGNhcGFjaXRvci5ib3R0b21DaXJjdWl0U3dpdGNoLnN3aXRjaFNlZ21lbnQuaGluZ2VQb2ludDtcclxuICAgICAgICBjb25zdCBkZWx0YSA9IGVuZFBvaW50Lm1pbnVzKCBoaW5nZVBvaW50ICkuc2V0TWFnbml0dWRlKCBDTEJDb25zdGFudHMuU1dJVENIX1dJUkVfTEVOR1RIICk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBvaW50ID0gbW9kZWwubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIGhpbmdlUG9pbnQucGx1cyggZGVsdGEgKSApO1xyXG4gICAgICAgIGJvdHRvbVN3aXRjaENvbnRhaW5lci5hZGRDaGlsZCggbmV3IFBhdGgoIFNoYXBlLmNpcmNsZSggcG9pbnQueCwgcG9pbnQueSwgQ0xCQ29uc3RhbnRzLkNPTk5FQ1RJT05fUE9JTlRfUkFESVVTICksIHtcclxuICAgICAgICAgIHN0cm9rZTogJ2JsdWUnXHJcbiAgICAgICAgfSApICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCB0ZXJtaW5hbENvbnRhaW5lciA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0ZXJtaW5hbENvbnRhaW5lciApO1xyXG4gICAgY29uc3QgYmF0dGVyeSA9IG1vZGVsLmNpcmN1aXQuYmF0dGVyeTtcclxuICAgIGJhdHRlcnkucG9sYXJpdHlQcm9wZXJ0eS5saW5rKCBwb2xhcml0eSA9PiB7XHJcbiAgICAgIHRlcm1pbmFsQ29udGFpbmVyLmNoaWxkcmVuID0gW1xyXG4gICAgICAgIG5ldyBQYXRoKCBwb2xhcml0eSA9PT0gQ2FwYWNpdG9yQ29uc3RhbnRzLlBPTEFSSVRZLlBPU0lUSVZFID8gYmF0dGVyeS5zaGFwZUNyZWF0b3IuY3JlYXRlUG9zaXRpdmVUZXJtaW5hbFNoYXBlKCkgOiBiYXR0ZXJ5LnNoYXBlQ3JlYXRvci5jcmVhdGVOZWdhdGl2ZVRlcm1pbmFsU2hhcGUoKSwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgICB9IClcclxuICAgICAgXTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBpZiAoIG1vZGVsLmNpcmN1aXQubGlnaHRCdWxiICkge1xyXG4gICAgICB0aGlzLmFkZENoaWxkKCBuZXcgUGF0aCggbW9kZWwuY2lyY3VpdC5saWdodEJ1bGIuc2hhcGVDcmVhdG9yLmNyZWF0ZVRvcEJhc2VTaGFwZSgpLCB7XHJcbiAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgfSApICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIG5ldyBQYXRoKCBtb2RlbC5jaXJjdWl0LmxpZ2h0QnVsYi5zaGFwZUNyZWF0b3IuY3JlYXRlQm90dG9tQmFzZVNoYXBlKCksIHtcclxuICAgICAgICBzdHJva2U6ICdibHVlJ1xyXG4gICAgICB9ICkgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwb3NpdGl2ZVZvbHRtZXRlck5vZGUgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggcG9zaXRpdmVWb2x0bWV0ZXJOb2RlICk7XHJcblxyXG4gICAgY29uc3QgbmVnYXRpdmVWb2x0bWV0ZXJOb2RlID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIG5lZ2F0aXZlVm9sdG1ldGVyTm9kZSApO1xyXG5cclxuICAgIG1vZGVsLnZvbHRtZXRlci5wb3NpdGl2ZVByb2JlUG9zaXRpb25Qcm9wZXJ0eS5saW5rKCAoKSA9PiB7XHJcbiAgICAgIHBvc2l0aXZlVm9sdG1ldGVyTm9kZS5jaGlsZHJlbiA9IFtcclxuICAgICAgICBuZXcgUGF0aCggbW9kZWwudm9sdG1ldGVyLnNoYXBlQ3JlYXRvci5nZXRQb3NpdGl2ZVByb2JlVGlwU2hhcGUoKSwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgICB9IClcclxuICAgICAgXTtcclxuICAgIH0gKTtcclxuICAgIG1vZGVsLnZvbHRtZXRlci5uZWdhdGl2ZVByb2JlUG9zaXRpb25Qcm9wZXJ0eS5saW5rKCAoKSA9PiB7XHJcbiAgICAgIG5lZ2F0aXZlVm9sdG1ldGVyTm9kZS5jaGlsZHJlbiA9IFtcclxuICAgICAgICBuZXcgUGF0aCggbW9kZWwudm9sdG1ldGVyLnNoYXBlQ3JlYXRvci5nZXROZWdhdGl2ZVByb2JlVGlwU2hhcGUoKSwge1xyXG4gICAgICAgICAgc3Ryb2tlOiAnYmx1ZSdcclxuICAgICAgICB9IClcclxuICAgICAgXTtcclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbmNhcGFjaXRvckxhYkJhc2ljcy5yZWdpc3RlciggJ0RlYnVnTGF5ZXInLCBEZWJ1Z0xheWVyICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBEZWJ1Z0xheWVyO1xyXG4iXSwibWFwcGlu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