// Copyright 2014-2022, University of Colorado Boulder

/**
 * Type that represents a movable shape in the view.
 *
 * @author John Blanco
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { Color, DragListener, Node, Path } from '../../../../scenery/js/imports.js';
import areaBuilder from '../../areaBuilder.js';
import AreaBuilderSharedConstants from '../AreaBuilderSharedConstants.js';
import Grid from './Grid.js';

// constants
const SHADOW_COLOR = 'rgba( 50, 50, 50, 0.5 )';
const SHADOW_OFFSET = new Vector2(5, 5);
const OPACITY_OF_TRANSLUCENT_SHAPES = 0.65; // Value empirically determined.
const UNIT_LENGTH = AreaBuilderSharedConstants.UNIT_SQUARE_LENGTH;
const BORDER_LINE_WIDTH = 1;
class ShapeNode extends Node {
  /**
   * @param {MovableShape} movableShape
   * @param {Bounds2} dragBounds
   */
  constructor(movableShape, dragBounds) {
    super({
      cursor: 'pointer'
    });
    const self = this;
    this.color = movableShape.color; // @public

    // Set up the mouse and touch areas for this node so that this can still be grabbed when invisible.
    this.touchArea = movableShape.shape;
    this.mouseArea = movableShape.shape;

    // Set up a root node whose visibility and opacity will be manipulated below.
    const rootNode = new Node();
    this.addChild(rootNode);

    // Create the shadow
    const shadow = new Path(movableShape.shape, {
      fill: SHADOW_COLOR,
      leftTop: SHADOW_OFFSET
    });
    rootNode.addChild(shadow);

    // Create the primary representation
    const representation = new Path(movableShape.shape, {
      fill: movableShape.color,
      stroke: Color.toColor(movableShape.color).colorUtilsDarker(AreaBuilderSharedConstants.PERIMETER_DARKEN_FACTOR),
      lineWidth: 1,
      lineJoin: 'round'
    });
    rootNode.addChild(representation);

    // Add the grid.
    const grid = new Grid(representation.bounds.dilated(-BORDER_LINE_WIDTH), UNIT_LENGTH, {
      lineDash: [0, 3, 1, 0],
      stroke: 'black'
    });
    representation.addChild(grid);

    // Move this node as the model representation moves
    const updatePosition = position => {
      this.leftTop = position;
    };
    movableShape.positionProperty.link(updatePosition);

    // Because a composite shape is often used to depict the overall shape when a shape is on the placement board, this
    // element may become invisible unless it is user controlled, animating, or fading.
    const visibleProperty = new DerivedProperty([movableShape.userControlledProperty, movableShape.animatingProperty, movableShape.fadeProportionProperty, movableShape.invisibleWhenStillProperty], (userControlled, animating, fadeProportion, invisibleWhenStill) => userControlled || animating || fadeProportion > 0 || !invisibleWhenStill);

    // Opacity is also a derived property, range is 0 to 1.
    const opacityProperty = new DerivedProperty([movableShape.userControlledProperty, movableShape.animatingProperty, movableShape.fadeProportionProperty], (userControlled, animating, fadeProportion) => {
      if (userControlled || animating) {
        // The shape is either being dragged by the user or is moving to a position, so should be fully opaque.
        return 1;
      } else if (fadeProportion > 0) {
        // The shape is fading away.
        return 1 - fadeProportion;
      } else {
        // The shape is not controlled by the user, animated, or fading, so it is most likely placed on the board.
        // If it is visible, it will be translucent, since some of the games use shapes in this state to place over
        // other shapes for comparative purposes.
        return OPACITY_OF_TRANSLUCENT_SHAPES;
      }
    });
    opacityProperty.link(opacity => {
      rootNode.opacity = opacity;
    });
    visibleProperty.link(visible => {
      rootNode.visible = visible;
    });
    const shadowVisibilityProperty = new DerivedProperty([movableShape.userControlledProperty, movableShape.animatingProperty], (userControlled, animating) => userControlled || animating);
    shadowVisibilityProperty.linkAttribute(shadow, 'visible');

    // To avoid certain complications, this node should not be pickable if it is animating or fading.
    const updatePickability = () => {
      self.pickable = !movableShape.animatingProperty.get() && movableShape.fadeProportionProperty.get() === 0;
    };
    movableShape.animatingProperty.link(updatePickability);
    movableShape.fadeProportionProperty.link(updatePickability);

    // Adjust the drag bounds to compensate for the shape that that the entire shape will stay in bounds.
    const shapeDragBounds = new Bounds2(dragBounds.minX, dragBounds.minY, dragBounds.maxX - movableShape.shape.bounds.width, dragBounds.maxY - movableShape.shape.bounds.height);

    // Enclose the drag bounds in a Property so that it can be used in the drag handler.
    const dragBoundsProperty = new Property(shapeDragBounds);

    // Add the listener that will allow the user to drag the shape around.
    const dragListener = new DragListener({
      positionProperty: movableShape.positionProperty,
      dragBoundsProperty: dragBoundsProperty,
      allowTouchSnag: true,
      start: () => {
        movableShape.userControlledProperty.set(true);
      },
      end: () => {
        movableShape.userControlledProperty.set(false);
      }
    });
    this.addInputListener(dragListener);

    // @private
    this.disposeShapeNode = () => {
      movableShape.positionProperty.unlink(updatePosition);
      visibleProperty.dispose();
      opacityProperty.dispose();
      shadowVisibilityProperty.dispose();
      movableShape.animatingProperty.unlink(updatePickability);
      movableShape.fadeProportionProperty.unlink(updatePickability);
      representation.dispose();
      shadow.dispose();
      grid.dispose();
      dragListener.dispose();
    };
  }

  /**
   * release memory references
   * @public
   */
  dispose() {
    this.disposeShapeNode();
    super.dispose();
  }
}
areaBuilder.register('ShapeNode', ShapeNode);
export default ShapeNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJQcm9wZXJ0eSIsIkJvdW5kczIiLCJWZWN0b3IyIiwiQ29sb3IiLCJEcmFnTGlzdGVuZXIiLCJOb2RlIiwiUGF0aCIsImFyZWFCdWlsZGVyIiwiQXJlYUJ1aWxkZXJTaGFyZWRDb25zdGFudHMiLCJHcmlkIiwiU0hBRE9XX0NPTE9SIiwiU0hBRE9XX09GRlNFVCIsIk9QQUNJVFlfT0ZfVFJBTlNMVUNFTlRfU0hBUEVTIiwiVU5JVF9MRU5HVEgiLCJVTklUX1NRVUFSRV9MRU5HVEgiLCJCT1JERVJfTElORV9XSURUSCIsIlNoYXBlTm9kZSIsImNvbnN0cnVjdG9yIiwibW92YWJsZVNoYXBlIiwiZHJhZ0JvdW5kcyIsImN1cnNvciIsInNlbGYiLCJjb2xvciIsInRvdWNoQXJlYSIsInNoYXBlIiwibW91c2VBcmVhIiwicm9vdE5vZGUiLCJhZGRDaGlsZCIsInNoYWRvdyIsImZpbGwiLCJsZWZ0VG9wIiwicmVwcmVzZW50YXRpb24iLCJzdHJva2UiLCJ0b0NvbG9yIiwiY29sb3JVdGlsc0RhcmtlciIsIlBFUklNRVRFUl9EQVJLRU5fRkFDVE9SIiwibGluZVdpZHRoIiwibGluZUpvaW4iLCJncmlkIiwiYm91bmRzIiwiZGlsYXRlZCIsImxpbmVEYXNoIiwidXBkYXRlUG9zaXRpb24iLCJwb3NpdGlvbiIsInBvc2l0aW9uUHJvcGVydHkiLCJsaW5rIiwidmlzaWJsZVByb3BlcnR5IiwidXNlckNvbnRyb2xsZWRQcm9wZXJ0eSIsImFuaW1hdGluZ1Byb3BlcnR5IiwiZmFkZVByb3BvcnRpb25Qcm9wZXJ0eSIsImludmlzaWJsZVdoZW5TdGlsbFByb3BlcnR5IiwidXNlckNvbnRyb2xsZWQiLCJhbmltYXRpbmciLCJmYWRlUHJvcG9ydGlvbiIsImludmlzaWJsZVdoZW5TdGlsbCIsIm9wYWNpdHlQcm9wZXJ0eSIsIm9wYWNpdHkiLCJ2aXNpYmxlIiwic2hhZG93VmlzaWJpbGl0eVByb3BlcnR5IiwibGlua0F0dHJpYnV0ZSIsInVwZGF0ZVBpY2thYmlsaXR5IiwicGlja2FibGUiLCJnZXQiLCJzaGFwZURyYWdCb3VuZHMiLCJtaW5YIiwibWluWSIsIm1heFgiLCJ3aWR0aCIsIm1heFkiLCJoZWlnaHQiLCJkcmFnQm91bmRzUHJvcGVydHkiLCJkcmFnTGlzdGVuZXIiLCJhbGxvd1RvdWNoU25hZyIsInN0YXJ0Iiwic2V0IiwiZW5kIiwiYWRkSW5wdXRMaXN0ZW5lciIsImRpc3Bvc2VTaGFwZU5vZGUiLCJ1bmxpbmsiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTaGFwZU5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVHlwZSB0aGF0IHJlcHJlc2VudHMgYSBtb3ZhYmxlIHNoYXBlIGluIHRoZSB2aWV3LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCB7IENvbG9yLCBEcmFnTGlzdGVuZXIsIE5vZGUsIFBhdGggfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYXJlYUJ1aWxkZXIgZnJvbSAnLi4vLi4vYXJlYUJ1aWxkZXIuanMnO1xyXG5pbXBvcnQgQXJlYUJ1aWxkZXJTaGFyZWRDb25zdGFudHMgZnJvbSAnLi4vQXJlYUJ1aWxkZXJTaGFyZWRDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgR3JpZCBmcm9tICcuL0dyaWQuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFNIQURPV19DT0xPUiA9ICdyZ2JhKCA1MCwgNTAsIDUwLCAwLjUgKSc7XHJcbmNvbnN0IFNIQURPV19PRkZTRVQgPSBuZXcgVmVjdG9yMiggNSwgNSApO1xyXG5jb25zdCBPUEFDSVRZX09GX1RSQU5TTFVDRU5UX1NIQVBFUyA9IDAuNjU7IC8vIFZhbHVlIGVtcGlyaWNhbGx5IGRldGVybWluZWQuXHJcbmNvbnN0IFVOSVRfTEVOR1RIID0gQXJlYUJ1aWxkZXJTaGFyZWRDb25zdGFudHMuVU5JVF9TUVVBUkVfTEVOR1RIO1xyXG5jb25zdCBCT1JERVJfTElORV9XSURUSCA9IDE7XHJcblxyXG5jbGFzcyBTaGFwZU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtNb3ZhYmxlU2hhcGV9IG1vdmFibGVTaGFwZVxyXG4gICAqIEBwYXJhbSB7Qm91bmRzMn0gZHJhZ0JvdW5kc1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBtb3ZhYmxlU2hhcGUsIGRyYWdCb3VuZHMgKSB7XHJcbiAgICBzdXBlciggeyBjdXJzb3I6ICdwb2ludGVyJyB9ICk7XHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuICAgIHRoaXMuY29sb3IgPSBtb3ZhYmxlU2hhcGUuY29sb3I7IC8vIEBwdWJsaWNcclxuXHJcbiAgICAvLyBTZXQgdXAgdGhlIG1vdXNlIGFuZCB0b3VjaCBhcmVhcyBmb3IgdGhpcyBub2RlIHNvIHRoYXQgdGhpcyBjYW4gc3RpbGwgYmUgZ3JhYmJlZCB3aGVuIGludmlzaWJsZS5cclxuICAgIHRoaXMudG91Y2hBcmVhID0gbW92YWJsZVNoYXBlLnNoYXBlO1xyXG4gICAgdGhpcy5tb3VzZUFyZWEgPSBtb3ZhYmxlU2hhcGUuc2hhcGU7XHJcblxyXG4gICAgLy8gU2V0IHVwIGEgcm9vdCBub2RlIHdob3NlIHZpc2liaWxpdHkgYW5kIG9wYWNpdHkgd2lsbCBiZSBtYW5pcHVsYXRlZCBiZWxvdy5cclxuICAgIGNvbnN0IHJvb3ROb2RlID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHJvb3ROb2RlICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBzaGFkb3dcclxuICAgIGNvbnN0IHNoYWRvdyA9IG5ldyBQYXRoKCBtb3ZhYmxlU2hhcGUuc2hhcGUsIHtcclxuICAgICAgZmlsbDogU0hBRE9XX0NPTE9SLFxyXG4gICAgICBsZWZ0VG9wOiBTSEFET1dfT0ZGU0VUXHJcbiAgICB9ICk7XHJcbiAgICByb290Tm9kZS5hZGRDaGlsZCggc2hhZG93ICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBwcmltYXJ5IHJlcHJlc2VudGF0aW9uXHJcbiAgICBjb25zdCByZXByZXNlbnRhdGlvbiA9IG5ldyBQYXRoKCBtb3ZhYmxlU2hhcGUuc2hhcGUsIHtcclxuICAgICAgZmlsbDogbW92YWJsZVNoYXBlLmNvbG9yLFxyXG4gICAgICBzdHJva2U6IENvbG9yLnRvQ29sb3IoIG1vdmFibGVTaGFwZS5jb2xvciApLmNvbG9yVXRpbHNEYXJrZXIoIEFyZWFCdWlsZGVyU2hhcmVkQ29uc3RhbnRzLlBFUklNRVRFUl9EQVJLRU5fRkFDVE9SICksXHJcbiAgICAgIGxpbmVXaWR0aDogMSxcclxuICAgICAgbGluZUpvaW46ICdyb3VuZCdcclxuICAgIH0gKTtcclxuICAgIHJvb3ROb2RlLmFkZENoaWxkKCByZXByZXNlbnRhdGlvbiApO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgZ3JpZC5cclxuICAgIGNvbnN0IGdyaWQgPSBuZXcgR3JpZCggcmVwcmVzZW50YXRpb24uYm91bmRzLmRpbGF0ZWQoIC1CT1JERVJfTElORV9XSURUSCApLCBVTklUX0xFTkdUSCwge1xyXG4gICAgICBsaW5lRGFzaDogWyAwLCAzLCAxLCAwIF0sXHJcbiAgICAgIHN0cm9rZTogJ2JsYWNrJ1xyXG4gICAgfSApO1xyXG4gICAgcmVwcmVzZW50YXRpb24uYWRkQ2hpbGQoIGdyaWQgKTtcclxuXHJcbiAgICAvLyBNb3ZlIHRoaXMgbm9kZSBhcyB0aGUgbW9kZWwgcmVwcmVzZW50YXRpb24gbW92ZXNcclxuICAgIGNvbnN0IHVwZGF0ZVBvc2l0aW9uID0gcG9zaXRpb24gPT4geyB0aGlzLmxlZnRUb3AgPSBwb3NpdGlvbjsgfTtcclxuICAgIG1vdmFibGVTaGFwZS5wb3NpdGlvblByb3BlcnR5LmxpbmsoIHVwZGF0ZVBvc2l0aW9uICk7XHJcblxyXG4gICAgLy8gQmVjYXVzZSBhIGNvbXBvc2l0ZSBzaGFwZSBpcyBvZnRlbiB1c2VkIHRvIGRlcGljdCB0aGUgb3ZlcmFsbCBzaGFwZSB3aGVuIGEgc2hhcGUgaXMgb24gdGhlIHBsYWNlbWVudCBib2FyZCwgdGhpc1xyXG4gICAgLy8gZWxlbWVudCBtYXkgYmVjb21lIGludmlzaWJsZSB1bmxlc3MgaXQgaXMgdXNlciBjb250cm9sbGVkLCBhbmltYXRpbmcsIG9yIGZhZGluZy5cclxuICAgIGNvbnN0IHZpc2libGVQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFtcclxuICAgICAgICBtb3ZhYmxlU2hhcGUudXNlckNvbnRyb2xsZWRQcm9wZXJ0eSxcclxuICAgICAgICBtb3ZhYmxlU2hhcGUuYW5pbWF0aW5nUHJvcGVydHksXHJcbiAgICAgICAgbW92YWJsZVNoYXBlLmZhZGVQcm9wb3J0aW9uUHJvcGVydHksXHJcbiAgICAgICAgbW92YWJsZVNoYXBlLmludmlzaWJsZVdoZW5TdGlsbFByb3BlcnR5IF0sXHJcbiAgICAgICggdXNlckNvbnRyb2xsZWQsIGFuaW1hdGluZywgZmFkZVByb3BvcnRpb24sIGludmlzaWJsZVdoZW5TdGlsbCApID0+IHVzZXJDb250cm9sbGVkIHx8IGFuaW1hdGluZyB8fCBmYWRlUHJvcG9ydGlvbiA+IDAgfHwgIWludmlzaWJsZVdoZW5TdGlsbCApO1xyXG5cclxuICAgIC8vIE9wYWNpdHkgaXMgYWxzbyBhIGRlcml2ZWQgcHJvcGVydHksIHJhbmdlIGlzIDAgdG8gMS5cclxuICAgIGNvbnN0IG9wYWNpdHlQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFtcclxuICAgICAgICBtb3ZhYmxlU2hhcGUudXNlckNvbnRyb2xsZWRQcm9wZXJ0eSxcclxuICAgICAgICBtb3ZhYmxlU2hhcGUuYW5pbWF0aW5nUHJvcGVydHksXHJcbiAgICAgICAgbW92YWJsZVNoYXBlLmZhZGVQcm9wb3J0aW9uUHJvcGVydHkgXSxcclxuICAgICAgKCB1c2VyQ29udHJvbGxlZCwgYW5pbWF0aW5nLCBmYWRlUHJvcG9ydGlvbiApID0+IHtcclxuICAgICAgICBpZiAoIHVzZXJDb250cm9sbGVkIHx8IGFuaW1hdGluZyApIHtcclxuXHJcbiAgICAgICAgICAvLyBUaGUgc2hhcGUgaXMgZWl0aGVyIGJlaW5nIGRyYWdnZWQgYnkgdGhlIHVzZXIgb3IgaXMgbW92aW5nIHRvIGEgcG9zaXRpb24sIHNvIHNob3VsZCBiZSBmdWxseSBvcGFxdWUuXHJcbiAgICAgICAgICByZXR1cm4gMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIGZhZGVQcm9wb3J0aW9uID4gMCApIHtcclxuICAgICAgICAgIC8vIFRoZSBzaGFwZSBpcyBmYWRpbmcgYXdheS5cclxuICAgICAgICAgIHJldHVybiAxIC0gZmFkZVByb3BvcnRpb247XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgLy8gVGhlIHNoYXBlIGlzIG5vdCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyLCBhbmltYXRlZCwgb3IgZmFkaW5nLCBzbyBpdCBpcyBtb3N0IGxpa2VseSBwbGFjZWQgb24gdGhlIGJvYXJkLlxyXG4gICAgICAgICAgLy8gSWYgaXQgaXMgdmlzaWJsZSwgaXQgd2lsbCBiZSB0cmFuc2x1Y2VudCwgc2luY2Ugc29tZSBvZiB0aGUgZ2FtZXMgdXNlIHNoYXBlcyBpbiB0aGlzIHN0YXRlIHRvIHBsYWNlIG92ZXJcclxuICAgICAgICAgIC8vIG90aGVyIHNoYXBlcyBmb3IgY29tcGFyYXRpdmUgcHVycG9zZXMuXHJcbiAgICAgICAgICByZXR1cm4gT1BBQ0lUWV9PRl9UUkFOU0xVQ0VOVF9TSEFQRVM7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIG9wYWNpdHlQcm9wZXJ0eS5saW5rKCBvcGFjaXR5ID0+IHtcclxuICAgICAgcm9vdE5vZGUub3BhY2l0eSA9IG9wYWNpdHk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdmlzaWJsZVByb3BlcnR5LmxpbmsoIHZpc2libGUgPT4ge1xyXG4gICAgICByb290Tm9kZS52aXNpYmxlID0gdmlzaWJsZTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBzaGFkb3dWaXNpYmlsaXR5UHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KFxyXG4gICAgICBbIG1vdmFibGVTaGFwZS51c2VyQ29udHJvbGxlZFByb3BlcnR5LCBtb3ZhYmxlU2hhcGUuYW5pbWF0aW5nUHJvcGVydHkgXSxcclxuICAgICAgKCB1c2VyQ29udHJvbGxlZCwgYW5pbWF0aW5nICkgPT4gdXNlckNvbnRyb2xsZWQgfHwgYW5pbWF0aW5nICk7XHJcblxyXG4gICAgc2hhZG93VmlzaWJpbGl0eVByb3BlcnR5LmxpbmtBdHRyaWJ1dGUoIHNoYWRvdywgJ3Zpc2libGUnICk7XHJcblxyXG4gICAgLy8gVG8gYXZvaWQgY2VydGFpbiBjb21wbGljYXRpb25zLCB0aGlzIG5vZGUgc2hvdWxkIG5vdCBiZSBwaWNrYWJsZSBpZiBpdCBpcyBhbmltYXRpbmcgb3IgZmFkaW5nLlxyXG4gICAgY29uc3QgdXBkYXRlUGlja2FiaWxpdHkgPSAoKSA9PiB7XHJcbiAgICAgIHNlbGYucGlja2FibGUgPSAhbW92YWJsZVNoYXBlLmFuaW1hdGluZ1Byb3BlcnR5LmdldCgpICYmIG1vdmFibGVTaGFwZS5mYWRlUHJvcG9ydGlvblByb3BlcnR5LmdldCgpID09PSAwO1xyXG4gICAgfTtcclxuICAgIG1vdmFibGVTaGFwZS5hbmltYXRpbmdQcm9wZXJ0eS5saW5rKCB1cGRhdGVQaWNrYWJpbGl0eSApO1xyXG4gICAgbW92YWJsZVNoYXBlLmZhZGVQcm9wb3J0aW9uUHJvcGVydHkubGluayggdXBkYXRlUGlja2FiaWxpdHkgKTtcclxuXHJcbiAgICAvLyBBZGp1c3QgdGhlIGRyYWcgYm91bmRzIHRvIGNvbXBlbnNhdGUgZm9yIHRoZSBzaGFwZSB0aGF0IHRoYXQgdGhlIGVudGlyZSBzaGFwZSB3aWxsIHN0YXkgaW4gYm91bmRzLlxyXG4gICAgY29uc3Qgc2hhcGVEcmFnQm91bmRzID0gbmV3IEJvdW5kczIoXHJcbiAgICAgIGRyYWdCb3VuZHMubWluWCxcclxuICAgICAgZHJhZ0JvdW5kcy5taW5ZLFxyXG4gICAgICBkcmFnQm91bmRzLm1heFggLSBtb3ZhYmxlU2hhcGUuc2hhcGUuYm91bmRzLndpZHRoLFxyXG4gICAgICBkcmFnQm91bmRzLm1heFkgLSBtb3ZhYmxlU2hhcGUuc2hhcGUuYm91bmRzLmhlaWdodFxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBFbmNsb3NlIHRoZSBkcmFnIGJvdW5kcyBpbiBhIFByb3BlcnR5IHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgaW4gdGhlIGRyYWcgaGFuZGxlci5cclxuICAgIGNvbnN0IGRyYWdCb3VuZHNQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggc2hhcGVEcmFnQm91bmRzICk7XHJcblxyXG4gICAgLy8gQWRkIHRoZSBsaXN0ZW5lciB0aGF0IHdpbGwgYWxsb3cgdGhlIHVzZXIgdG8gZHJhZyB0aGUgc2hhcGUgYXJvdW5kLlxyXG4gICAgY29uc3QgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG5cclxuICAgICAgcG9zaXRpb25Qcm9wZXJ0eTogbW92YWJsZVNoYXBlLnBvc2l0aW9uUHJvcGVydHksXHJcbiAgICAgIGRyYWdCb3VuZHNQcm9wZXJ0eTogZHJhZ0JvdW5kc1Byb3BlcnR5LFxyXG4gICAgICBhbGxvd1RvdWNoU25hZzogdHJ1ZSxcclxuXHJcbiAgICAgIHN0YXJ0OiAoKSA9PiB7XHJcbiAgICAgICAgbW92YWJsZVNoYXBlLnVzZXJDb250cm9sbGVkUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICBlbmQ6ICgpID0+IHtcclxuICAgICAgICBtb3ZhYmxlU2hhcGUudXNlckNvbnRyb2xsZWRQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggZHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuZGlzcG9zZVNoYXBlTm9kZSA9ICgpID0+IHtcclxuICAgICAgbW92YWJsZVNoYXBlLnBvc2l0aW9uUHJvcGVydHkudW5saW5rKCB1cGRhdGVQb3NpdGlvbiApO1xyXG4gICAgICB2aXNpYmxlUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICBvcGFjaXR5UHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICBzaGFkb3dWaXNpYmlsaXR5UHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgICBtb3ZhYmxlU2hhcGUuYW5pbWF0aW5nUHJvcGVydHkudW5saW5rKCB1cGRhdGVQaWNrYWJpbGl0eSApO1xyXG4gICAgICBtb3ZhYmxlU2hhcGUuZmFkZVByb3BvcnRpb25Qcm9wZXJ0eS51bmxpbmsoIHVwZGF0ZVBpY2thYmlsaXR5ICk7XHJcbiAgICAgIHJlcHJlc2VudGF0aW9uLmRpc3Bvc2UoKTtcclxuICAgICAgc2hhZG93LmRpc3Bvc2UoKTtcclxuICAgICAgZ3JpZC5kaXNwb3NlKCk7XHJcbiAgICAgIGRyYWdMaXN0ZW5lci5kaXNwb3NlKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogcmVsZWFzZSBtZW1vcnkgcmVmZXJlbmNlc1xyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy5kaXNwb3NlU2hhcGVOb2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5hcmVhQnVpbGRlci5yZWdpc3RlciggJ1NoYXBlTm9kZScsIFNoYXBlTm9kZSApO1xyXG5leHBvcnQgZGVmYXVsdCBTaGFwZU5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsUUFBUSxNQUFNLGlDQUFpQztBQUN0RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsU0FBU0MsS0FBSyxFQUFFQyxZQUFZLEVBQUVDLElBQUksRUFBRUMsSUFBSSxRQUFRLG1DQUFtQztBQUNuRixPQUFPQyxXQUFXLE1BQU0sc0JBQXNCO0FBQzlDLE9BQU9DLDBCQUEwQixNQUFNLGtDQUFrQztBQUN6RSxPQUFPQyxJQUFJLE1BQU0sV0FBVzs7QUFFNUI7QUFDQSxNQUFNQyxZQUFZLEdBQUcseUJBQXlCO0FBQzlDLE1BQU1DLGFBQWEsR0FBRyxJQUFJVCxPQUFPLENBQUUsQ0FBQyxFQUFFLENBQUUsQ0FBQztBQUN6QyxNQUFNVSw2QkFBNkIsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUM1QyxNQUFNQyxXQUFXLEdBQUdMLDBCQUEwQixDQUFDTSxrQkFBa0I7QUFDakUsTUFBTUMsaUJBQWlCLEdBQUcsQ0FBQztBQUUzQixNQUFNQyxTQUFTLFNBQVNYLElBQUksQ0FBQztFQUUzQjtBQUNGO0FBQ0E7QUFDQTtFQUNFWSxXQUFXQSxDQUFFQyxZQUFZLEVBQUVDLFVBQVUsRUFBRztJQUN0QyxLQUFLLENBQUU7TUFBRUMsTUFBTSxFQUFFO0lBQVUsQ0FBRSxDQUFDO0lBQzlCLE1BQU1DLElBQUksR0FBRyxJQUFJO0lBQ2pCLElBQUksQ0FBQ0MsS0FBSyxHQUFHSixZQUFZLENBQUNJLEtBQUssQ0FBQyxDQUFDOztJQUVqQztJQUNBLElBQUksQ0FBQ0MsU0FBUyxHQUFHTCxZQUFZLENBQUNNLEtBQUs7SUFDbkMsSUFBSSxDQUFDQyxTQUFTLEdBQUdQLFlBQVksQ0FBQ00s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