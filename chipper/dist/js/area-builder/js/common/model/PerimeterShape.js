// Copyright 2014-2022, University of Colorado Boulder

/**
 * Model element that describes a shape in terms of 'perimeter points', both exterior and interior.  The interior
 * perimeters allow holes to be defined.  The shape is defined by straight lines drawn from each point to the next.
 *
 * @author John Blanco
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import { Shape } from '../../../../kite/js/imports.js';
import merge from '../../../../phet-core/js/merge.js';
import areaBuilder from '../../areaBuilder.js';

// constants
const FLOATING_POINT_ERR_TOLERANCE = 1e-6;
class PerimeterShape {
  /**
   * @param {Array.<Array.<Vector2>>} exteriorPerimeters An array of perimeters, each of which is a sequential array of
   * points.
   * @param {Array.<Array.<Vector2>>} interiorPerimeters An array of perimeters, each of which is a sequential array of
   * points. Each interior perimeter must be fully contained within an exterior perimeter.
   * @param {number} unitLength The unit length (i.e. the width or height of a unit square) of the unit sizes that
   * this shape should be constructed from.
   * @param {Object} [options]
   */
  constructor(exteriorPerimeters, interiorPerimeters, unitLength, options) {
    let i;
    options = merge({
      fillColor: null,
      edgeColor: null
    }, options); // Make sure options is defined.

    // @public, read only
    this.fillColor = options.fillColor;

    // @public, read only
    this.edgeColor = options.edgeColor;

    // @public, read only
    this.exteriorPerimeters = exteriorPerimeters;

    // @public, read only
    this.interiorPerimeters = interiorPerimeters;

    // @private
    this.unitLength = unitLength;

    // @private - a shape created from the points, useful in various situations.
    this.kiteShape = new Shape();
    exteriorPerimeters.forEach(exteriorPerimeter => {
      this.kiteShape.moveToPoint(exteriorPerimeter[0]);
      for (i = 1; i < exteriorPerimeter.length; i++) {
        this.kiteShape.lineToPoint(exteriorPerimeter[i]);
      }
      this.kiteShape.lineToPoint(exteriorPerimeter[0]);
      this.kiteShape.close();
    });

    // Only add interior spaces if there is a legitimate external perimeter.
    if (!this.kiteShape.bounds.isEmpty()) {
      interiorPerimeters.forEach(interiorPerimeter => {
        this.kiteShape.moveToPoint(interiorPerimeter[0]);
        for (i = 1; i < interiorPerimeter.length; i++) {
          this.kiteShape.lineToPoint(interiorPerimeter[i]);
        }
        this.kiteShape.lineToPoint(interiorPerimeter[0]);
        this.kiteShape.close();
      });
    }

    // @public, read only
    this.unitArea = calculateUnitArea(this.kiteShape, unitLength);
  }

  /**
   * Returns a linearly translated version of this perimeter shape.
   * @param {number} x
   * @param {number} y
   * @returns {PerimeterShape}
   * @public
   */
  translated(x, y) {
    const exteriorPerimeters = [];
    const interiorPerimeters = [];
    this.exteriorPerimeters.forEach((exteriorPerimeter, index) => {
      exteriorPerimeters.push([]);
      exteriorPerimeter.forEach(point => {
        exteriorPerimeters[index].push(point.plusXY(x, y));
      });
    });
    this.interiorPerimeters.forEach((interiorPerimeter, index) => {
      interiorPerimeters.push([]);
      interiorPerimeter.forEach(point => {
        interiorPerimeters[index].push(point.plusXY(x, y));
      });
    });
    return new PerimeterShape(exteriorPerimeters, interiorPerimeters, this.unitLength, {
      fillColor: this.fillColor,
      edgeColor: this.edgeColor
    });
  }

  /**
   * @returns {number}
   * @public
   */
  getWidth() {
    return this.kiteShape.bounds.width;
  }

  /**
   * @returns {number}
   * @public
   */
  getHeight() {
    return this.kiteShape.bounds.height;
  }
}

// Utility function to compute the unit area of a perimeter shape.
function calculateUnitArea(shape, unitLength) {
  if (!shape.bounds.isFinite()) {
    return 0;
  }
  assert && assert(shape.bounds.width % unitLength < FLOATING_POINT_ERR_TOLERANCE && shape.bounds.height % unitLength < FLOATING_POINT_ERR_TOLERANCE, 'Error: This method will only work with shapes that have bounds of unit width and height.');

  // Compute the unit area by testing whether or not points on a sub-grid are contained in the shape.
  let unitArea = 0;
  const testPoint = new Vector2(0, 0);
  for (let row = 0; row * unitLength < shape.bounds.height; row++) {
    for (let column = 0; column * unitLength < shape.bounds.width; column++) {
      // Scan four points in the unit square.  This allows support for triangular 1/2 unit square shapes.  This is
      // in-lined rather than looped for the sake of efficiency, since this approach avoids vector allocations.
      testPoint.setXY(shape.bounds.minX + (column + 0.25) * unitLength, shape.bounds.minY + (row + 0.5) * unitLength);
      if (shape.containsPoint(testPoint)) {
        unitArea += 0.25;
      }
      testPoint.setXY(shape.bounds.minX + (column + 0.5) * unitLength, shape.bounds.minY + (row + 0.25) * unitLength);
      if (shape.containsPoint(testPoint)) {
        unitArea += 0.25;
      }
      testPoint.setXY(shape.bounds.minX + (column + 0.5) * unitLength, shape.bounds.minY + (row + 0.75) * unitLength);
      if (shape.containsPoint(testPoint)) {
        unitArea += 0.25;
      }
      testPoint.setXY(shape.bounds.minX + (column + 0.75) * unitLength, shape.bounds.minY + (row + 0.5) * unitLength);
      if (shape.containsPoint(testPoint)) {
        unitArea += 0.25;
      }
    }
  }
  return unitArea;
}
areaBuilder.register('PerimeterShape', PerimeterShape);
export default PerimeterShape;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwiU2hhcGUiLCJtZXJnZSIsImFyZWFCdWlsZGVyIiwiRkxPQVRJTkdfUE9JTlRfRVJSX1RPTEVSQU5DRSIsIlBlcmltZXRlclNoYXBlIiwiY29uc3RydWN0b3IiLCJleHRlcmlvclBlcmltZXRlcnMiLCJpbnRlcmlvclBlcmltZXRlcnMiLCJ1bml0TGVuZ3RoIiwib3B0aW9ucyIsImkiLCJmaWxsQ29sb3IiLCJlZGdlQ29sb3IiLCJraXRlU2hhcGUiLCJmb3JFYWNoIiwiZXh0ZXJpb3JQZXJpbWV0ZXIiLCJtb3ZlVG9Qb2ludCIsImxlbmd0aCIsImxpbmVUb1BvaW50IiwiY2xvc2UiLCJib3VuZHMiLCJpc0VtcHR5IiwiaW50ZXJpb3JQZXJpbWV0ZXIiLCJ1bml0QXJlYSIsImNhbGN1bGF0ZVVuaXRBcmVhIiwidHJhbnNsYXRlZCIsIngiLCJ5IiwiaW5kZXgiLCJwdXNoIiwicG9pbnQiLCJwbHVzWFkiLCJnZXRXaWR0aCIsIndpZHRoIiwiZ2V0SGVpZ2h0IiwiaGVpZ2h0Iiwic2hhcGUiLCJpc0Zpbml0ZSIsImFzc2VydCIsInRlc3RQb2ludCIsInJvdyIsImNvbHVtbiIsInNldFhZIiwibWluWCIsIm1pblkiLCJjb250YWluc1BvaW50IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQZXJpbWV0ZXJTaGFwZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBNb2RlbCBlbGVtZW50IHRoYXQgZGVzY3JpYmVzIGEgc2hhcGUgaW4gdGVybXMgb2YgJ3BlcmltZXRlciBwb2ludHMnLCBib3RoIGV4dGVyaW9yIGFuZCBpbnRlcmlvci4gIFRoZSBpbnRlcmlvclxyXG4gKiBwZXJpbWV0ZXJzIGFsbG93IGhvbGVzIHRvIGJlIGRlZmluZWQuICBUaGUgc2hhcGUgaXMgZGVmaW5lZCBieSBzdHJhaWdodCBsaW5lcyBkcmF3biBmcm9tIGVhY2ggcG9pbnQgdG8gdGhlIG5leHQuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY29cclxuICovXHJcblxyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBhcmVhQnVpbGRlciBmcm9tICcuLi8uLi9hcmVhQnVpbGRlci5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgRkxPQVRJTkdfUE9JTlRfRVJSX1RPTEVSQU5DRSA9IDFlLTY7XHJcblxyXG5jbGFzcyBQZXJpbWV0ZXJTaGFwZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7QXJyYXkuPEFycmF5LjxWZWN0b3IyPj59IGV4dGVyaW9yUGVyaW1ldGVycyBBbiBhcnJheSBvZiBwZXJpbWV0ZXJzLCBlYWNoIG9mIHdoaWNoIGlzIGEgc2VxdWVudGlhbCBhcnJheSBvZlxyXG4gICAqIHBvaW50cy5cclxuICAgKiBAcGFyYW0ge0FycmF5LjxBcnJheS48VmVjdG9yMj4+fSBpbnRlcmlvclBlcmltZXRlcnMgQW4gYXJyYXkgb2YgcGVyaW1ldGVycywgZWFjaCBvZiB3aGljaCBpcyBhIHNlcXVlbnRpYWwgYXJyYXkgb2ZcclxuICAgKiBwb2ludHMuIEVhY2ggaW50ZXJpb3IgcGVyaW1ldGVyIG11c3QgYmUgZnVsbHkgY29udGFpbmVkIHdpdGhpbiBhbiBleHRlcmlvciBwZXJpbWV0ZXIuXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHVuaXRMZW5ndGggVGhlIHVuaXQgbGVuZ3RoIChpLmUuIHRoZSB3aWR0aCBvciBoZWlnaHQgb2YgYSB1bml0IHNxdWFyZSkgb2YgdGhlIHVuaXQgc2l6ZXMgdGhhdFxyXG4gICAqIHRoaXMgc2hhcGUgc2hvdWxkIGJlIGNvbnN0cnVjdGVkIGZyb20uXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBleHRlcmlvclBlcmltZXRlcnMsIGludGVyaW9yUGVyaW1ldGVycywgdW5pdExlbmd0aCwgb3B0aW9ucyApIHtcclxuICAgIGxldCBpO1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBmaWxsQ29sb3I6IG51bGwsXHJcbiAgICAgIGVkZ2VDb2xvcjogbnVsbFxyXG4gICAgfSwgb3B0aW9ucyApOyAvLyBNYWtlIHN1cmUgb3B0aW9ucyBpcyBkZWZpbmVkLlxyXG5cclxuICAgIC8vIEBwdWJsaWMsIHJlYWQgb25seVxyXG4gICAgdGhpcy5maWxsQ29sb3IgPSBvcHRpb25zLmZpbGxDb2xvcjtcclxuXHJcbiAgICAvLyBAcHVibGljLCByZWFkIG9ubHlcclxuICAgIHRoaXMuZWRnZUNvbG9yID0gb3B0aW9ucy5lZGdlQ29sb3I7XHJcblxyXG4gICAgLy8gQHB1YmxpYywgcmVhZCBvbmx5XHJcbiAgICB0aGlzLmV4dGVyaW9yUGVyaW1ldGVycyA9IGV4dGVyaW9yUGVyaW1ldGVycztcclxuXHJcbiAgICAvLyBAcHVibGljLCByZWFkIG9ubHlcclxuICAgIHRoaXMuaW50ZXJpb3JQZXJpbWV0ZXJzID0gaW50ZXJpb3JQZXJpbWV0ZXJzO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLnVuaXRMZW5ndGggPSB1bml0TGVuZ3RoO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gYSBzaGFwZSBjcmVhdGVkIGZyb20gdGhlIHBvaW50cywgdXNlZnVsIGluIHZhcmlvdXMgc2l0dWF0aW9ucy5cclxuICAgIHRoaXMua2l0ZVNoYXBlID0gbmV3IFNoYXBlKCk7XHJcbiAgICBleHRlcmlvclBlcmltZXRlcnMuZm9yRWFjaCggZXh0ZXJpb3JQZXJpbWV0ZXIgPT4ge1xyXG4gICAgICB0aGlzLmtpdGVTaGFwZS5tb3ZlVG9Qb2ludCggZXh0ZXJpb3JQZXJpbWV0ZXJbIDAgXSApO1xyXG4gICAgICBmb3IgKCBpID0gMTsgaSA8IGV4dGVyaW9yUGVyaW1ldGVyLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIHRoaXMua2l0ZVNoYXBlLmxpbmVUb1BvaW50KCBleHRlcmlvclBlcmltZXRlclsgaSBdICk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5raXRlU2hhcGUubGluZVRvUG9pbnQoIGV4dGVyaW9yUGVyaW1ldGVyWyAwIF0gKTtcclxuICAgICAgdGhpcy5raXRlU2hhcGUuY2xvc2UoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBPbmx5IGFkZCBpbnRlcmlvciBzcGFjZXMgaWYgdGhlcmUgaXMgYSBsZWdpdGltYXRlIGV4dGVybmFsIHBlcmltZXRlci5cclxuICAgIGlmICggIXRoaXMua2l0ZVNoYXBlLmJvdW5kcy5pc0VtcHR5KCkgKSB7XHJcbiAgICAgIGludGVyaW9yUGVyaW1ldGVycy5mb3JFYWNoKCBpbnRlcmlvclBlcmltZXRlciA9PiB7XHJcbiAgICAgICAgdGhpcy5raXRlU2hhcGUubW92ZVRvUG9pbnQoIGludGVyaW9yUGVyaW1ldGVyWyAwIF0gKTtcclxuICAgICAgICBmb3IgKCBpID0gMTsgaSA8IGludGVyaW9yUGVyaW1ldGVyLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgICAgdGhpcy5raXRlU2hhcGUubGluZVRvUG9pbnQoIGludGVyaW9yUGVyaW1ldGVyWyBpIF0gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5raXRlU2hhcGUubGluZVRvUG9pbnQoIGludGVyaW9yUGVyaW1ldGVyWyAwIF0gKTtcclxuICAgICAgICB0aGlzLmtpdGVTaGFwZS5jbG9zZSgpO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQHB1YmxpYywgcmVhZCBvbmx5XHJcbiAgICB0aGlzLnVuaXRBcmVhID0gY2FsY3VsYXRlVW5pdEFyZWEoIHRoaXMua2l0ZVNoYXBlLCB1bml0TGVuZ3RoICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGEgbGluZWFybHkgdHJhbnNsYXRlZCB2ZXJzaW9uIG9mIHRoaXMgcGVyaW1ldGVyIHNoYXBlLlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB4XHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHlcclxuICAgKiBAcmV0dXJucyB7UGVyaW1ldGVyU2hhcGV9XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHRyYW5zbGF0ZWQoIHgsIHkgKSB7XHJcbiAgICBjb25zdCBleHRlcmlvclBlcmltZXRlcnMgPSBbXTtcclxuICAgIGNvbnN0IGludGVyaW9yUGVyaW1ldGVycyA9IFtdO1xyXG4gICAgdGhpcy5leHRlcmlvclBlcmltZXRlcnMuZm9yRWFjaCggKCBleHRlcmlvclBlcmltZXRlciwgaW5kZXggKSA9PiB7XHJcbiAgICAgIGV4dGVyaW9yUGVyaW1ldGVycy5wdXNoKCBbXSApO1xyXG4gICAgICBleHRlcmlvclBlcmltZXRlci5mb3JFYWNoKCBwb2ludCA9PiB7XHJcbiAgICAgICAgZXh0ZXJpb3JQZXJpbWV0ZXJzWyBpbmRleCBdLnB1c2goIHBvaW50LnBsdXNYWSggeCwgeSApICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH0gKTtcclxuICAgIHRoaXMuaW50ZXJpb3JQZXJpbWV0ZXJzLmZvckVhY2goICggaW50ZXJpb3JQZXJpbWV0ZXIsIGluZGV4ICkgPT4ge1xyXG4gICAgICBpbnRlcmlvclBlcmltZXRlcnMucHVzaCggW10gKTtcclxuICAgICAgaW50ZXJpb3JQZXJpbWV0ZXIuZm9yRWFjaCggcG9pbnQgPT4ge1xyXG4gICAgICAgIGludGVyaW9yUGVyaW1ldGVyc1sgaW5kZXggXS5wdXNoKCBwb2ludC5wbHVzWFkoIHgsIHkgKSApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9ICk7XHJcbiAgICByZXR1cm4gbmV3IFBlcmltZXRlclNoYXBlKCBleHRlcmlvclBlcmltZXRlcnMsIGludGVyaW9yUGVyaW1ldGVycywgdGhpcy51bml0TGVuZ3RoLCB7XHJcbiAgICAgIGZpbGxDb2xvcjogdGhpcy5maWxsQ29sb3IsXHJcbiAgICAgIGVkZ2VDb2xvcjogdGhpcy5lZGdlQ29sb3JcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGdldFdpZHRoKCkge1xyXG4gICAgcmV0dXJuIHRoaXMua2l0ZVNoYXBlLmJvdW5kcy53aWR0aDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGdldEhlaWdodCgpIHtcclxuICAgIHJldHVybiB0aGlzLmtpdGVTaGFwZS5ib3VuZHMuaGVpZ2h0O1xyXG4gIH1cclxufVxyXG5cclxuLy8gVXRpbGl0eSBmdW5jdGlvbiB0byBjb21wdXRlIHRoZSB1bml0IGFyZWEgb2YgYSBwZXJpbWV0ZXIgc2hhcGUuXHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZVVuaXRBcmVhKCBzaGFwZSwgdW5pdExlbmd0aCApIHtcclxuXHJcbiAgaWYgKCAhc2hhcGUuYm91bmRzLmlzRmluaXRlKCkgKSB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcblxyXG4gIGFzc2VydCAmJiBhc3NlcnQoIHNoYXBlLmJvdW5kcy53aWR0aCAlIHVuaXRMZW5ndGggPCBGTE9BVElOR19QT0lOVF9FUlJfVE9MRVJBTkNFICYmXHJcbiAgc2hhcGUuYm91bmRzLmhlaWdodCAlIHVuaXRMZW5ndGggPCBGTE9BVElOR19QT0lOVF9FUlJfVE9MRVJBTkNFLFxyXG4gICAgJ0Vycm9yOiBUaGlzIG1ldGhvZCB3aWxsIG9ubHkgd29yayB3aXRoIHNoYXBlcyB0aGF0IGhhdmUgYm91bmRzIG9mIHVuaXQgd2lkdGggYW5kIGhlaWdodC4nXHJcbiAgKTtcclxuXHJcbiAgLy8gQ29tcHV0ZSB0aGUgdW5pdCBhcmVhIGJ5IHRlc3Rpbmcgd2hldGhlciBvciBub3QgcG9pbnRzIG9uIGEgc3ViLWdyaWQgYXJlIGNvbnRhaW5lZCBpbiB0aGUgc2hhcGUuXHJcbiAgbGV0IHVuaXRBcmVhID0gMDtcclxuICBjb25zdCB0ZXN0UG9pbnQgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG4gIGZvciAoIGxldCByb3cgPSAwOyByb3cgKiB1bml0TGVuZ3RoIDwgc2hhcGUuYm91bmRzLmhlaWdodDsgcm93KysgKSB7XHJcbiAgICBmb3IgKCBsZXQgY29sdW1uID0gMDsgY29sdW1uICogdW5pdExlbmd0aCA8IHNoYXBlLmJvdW5kcy53aWR0aDsgY29sdW1uKysgKSB7XHJcbiAgICAgIC8vIFNjYW4gZm91ciBwb2ludHMgaW4gdGhlIHVuaXQgc3F1YXJlLiAgVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgdHJpYW5ndWxhciAxLzIgdW5pdCBzcXVhcmUgc2hhcGVzLiAgVGhpcyBpc1xyXG4gICAgICAvLyBpbi1saW5lZCByYXRoZXIgdGhhbiBsb29wZWQgZm9yIHRoZSBzYWtlIG9mIGVmZmljaWVuY3ksIHNpbmNlIHRoaXMgYXBwcm9hY2ggYXZvaWRzIHZlY3RvciBhbGxvY2F0aW9ucy5cclxuICAgICAgdGVzdFBvaW50LnNldFhZKCBzaGFwZS5ib3VuZHMubWluWCArICggY29sdW1uICsgMC4yNSApICogdW5pdExlbmd0aCwgc2hhcGUuYm91bmRzLm1pblkgKyAoIHJvdyArIDAuNSApICogdW5pdExlbmd0aCApO1xyXG4gICAgICBpZiAoIHNoYXBlLmNvbnRhaW5zUG9pbnQoIHRlc3RQb2ludCApICkge1xyXG4gICAgICAgIHVuaXRBcmVhICs9IDAuMjU7XHJcbiAgICAgIH1cclxuICAgICAgdGVzdFBvaW50LnNldFhZKCBzaGFwZS5ib3VuZHMubWluWCArICggY29sdW1uICsgMC41ICkgKiB1bml0TGVuZ3RoLCBzaGFwZS5ib3VuZHMubWluWSArICggcm93ICsgMC4yNSApICogdW5pdExlbmd0aCApO1xyXG4gICAgICBpZiAoIHNoYXBlLmNvbnRhaW5zUG9pbnQoIHRlc3RQb2ludCApICkge1xyXG4gICAgICAgIHVuaXRBcmVhICs9IDAuMjU7XHJcbiAgICAgIH1cclxuICAgICAgdGVzdFBvaW50LnNldFhZKCBzaGFwZS5ib3VuZHMubWluWCArICggY29sdW1uICsgMC41ICkgKiB1bml0TGVuZ3RoLCBzaGFwZS5ib3VuZHMubWluWSArICggcm93ICsgMC43NSApICogdW5pdExlbmd0aCApO1xyXG4gICAgICBpZiAoIHNoYXBlLmNvbnRhaW5zUG9pbnQoIHRlc3RQb2ludCApICkge1xyXG4gICAgICAgIHVuaXRBcmVhICs9IDAuMjU7XHJcbiAgICAgIH1cclxuICAgICAgdGVzdFBvaW50LnNldFhZKCBzaGFwZS5ib3VuZHMubWluWCArICggY29sdW1uICsgMC43NSApICogdW5pdExlbmd0aCwgc2hhcGUuYm91bmRzLm1pblkgKyAoIHJvdyArIDAuNSApICogdW5pdExlbmd0aCApO1xyXG4gICAgICBpZiAoIHNoYXBlLmNvbnRhaW5zUG9pbnQoIHRlc3RQb2ludCApICkge1xyXG4gICAgICAgIHVuaXRBcmVhICs9IDAuMjU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHVuaXRBcmVhO1xyXG59XHJcblxyXG5hcmVhQnVpbGRlci5yZWdpc3RlciggJ1BlcmltZXRlclNoYXBlJywgUGVyaW1ldGVyU2hhcGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgUGVyaW1ldGVyU2hhcGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxTQUFTQyxLQUFLLFFBQVEsZ0NBQWdDO0FBQ3RELE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsT0FBT0MsV0FBVyxNQUFNLHNCQUFzQjs7QUFFOUM7QUFDQSxNQUFNQyw0QkFBNEIsR0FBRyxJQUFJO0FBRXpDLE1BQU1DLGNBQWMsQ0FBQztFQUVuQjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRUMsV0FBV0EsQ0FB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