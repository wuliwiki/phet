// Copyright 2014-2023, University of Colorado Boulder

/**
 * Type that defines a shape that can be moved by the user and placed on the shape placement boards.
 *
 * @author John Blanco
 */

import Emitter from '../../../../axon/js/Emitter.js';
import Property from '../../../../axon/js/Property.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { Shape } from '../../../../kite/js/imports.js';
import { Color } from '../../../../scenery/js/imports.js';
import areaBuilder from '../../areaBuilder.js';
import AreaBuilderSharedConstants from '../AreaBuilderSharedConstants.js';

// constants
const FADE_RATE = 2; // proportion per second

class MovableShape {
  /**
   * @param {Shape} shape
   * @param {Color || string} color
   * @param {Vector2} initialPosition
   */
  constructor(shape, color, initialPosition) {
    // Property that indicates where in model space the upper left corner of this shape is.  In general, this should
    // not be set directly outside of this type, and should only be manipulated through the methods defined below.
    this.positionProperty = new Property(initialPosition);

    // Flag that tracks whether the user is dragging this shape around.  Should be set externally ; generally by the a
    // view node.
    this.userControlledProperty = new Property(false);

    // Flag that indicates whether this element is animating from one position to another ; should not be set externally.
    this.animatingProperty = new Property(false, {
      reentrant: true,
      hasListenerOrderDependencies: true // TODO: https://github.com/phetsims/area-builder/issues/124
    });

    // Value that indicates how faded out this shape is.  This is used as part of a feature where shapes can fade
    // out.  Once fade has started ; it doesn't stop until it is fully faded ; i.e. the value is 1.  This should not be
    // set externally.
    this.fadeProportionProperty = new Property(0, {
      hasListenerOrderDependencies: true
    }); // TODO: https://github.com/phetsims/area-builder/issues/124

    // A flag that indicates whether this individual shape should become invisible when it is done animating.  This
    // is generally used in cases where it becomes part of a larger composite shape that is depicted instead.
    this.invisibleWhenStillProperty = new Property(true);

    // Destination is used for animation, and should be set through accessor methods only.
    this.destination = initialPosition.copy(); // @private

    // Emit an event whenever this shape returns to its original position.
    this.returnedToOriginEmitter = new Emitter();
    this.positionProperty.lazyLink(position => {
      if (position.equals(initialPosition)) {
        this.returnedToOriginEmitter.emit();
      }
    });

    // Non-dynamic attributes
    this.shape = shape; // @public, read only
    this.color = Color.toColor(color); // @public

    // Internal vars
    this.fading = false; // @private
  }

  /**
   * @param {number} dt
   * @public
   */
  step(dt) {
    if (!this.userControlledProperty.get()) {
      // Perform any animation.
      const currentPosition = this.positionProperty.get();
      const distanceToDestination = currentPosition.distance(this.destination);
      if (distanceToDestination > dt * AreaBuilderSharedConstants.ANIMATION_SPEED) {
        // Move a step toward the destination.
        const stepAngle = Math.atan2(this.destination.y - currentPosition.y, this.destination.x - currentPosition.x);
        const stepVector = Vector2.createPolar(AreaBuilderSharedConstants.ANIMATION_SPEED * dt, stepAngle);
        this.positionProperty.set(currentPosition.plus(stepVector));
      } else if (this.animatingProperty.get()) {
        // Less than one time step away, so just go to the destination.
        this.positionProperty.set(this.destination);
        this.animatingProperty.set(false);
      }

      // Perform any fading.
      if (this.fading) {
        this.fadeProportionProperty.set(Math.min(1, this.fadeProportionProperty.get() + dt * FADE_RATE));
        if (this.fadeProportionProperty.get() >= 1) {
          this.fading = false;
        }
      }
    }
  }

  /**
   * Set the destination for this shape.
   * @param {Vector2} destination
   * @param {boolean} animate
   * @public
   */
  setDestination(destination, animate) {
    this.destination = destination;
    if (animate) {
      this.animatingProperty.set(true);
    } else {
      this.animatingProperty.set(false);
      this.positionProperty.set(this.destination);
    }
  }

  /**
   * Return the shape to the place where it was originally created.
   * @param {boolean} animate
   * @public
   */
  returnToOrigin(animate) {
    this.setDestination(this.positionProperty.initialValue, animate);
  }

  /**
   * @public
   */
  fadeAway() {
    this.fading = true;
    this.fadeProportionProperty.set(0.0001); // this is done to make sure the shape is made unpickable as soon as fading starts
  }

  /**
   * Returns a set of squares that are of the specified size and are positioned correctly such that they collectively
   * make up the same shape as this rectangle.  The specified length must be an integer value of the length and
   * width or things will get weird.
   *
   * NOTE: This only works properly for rectangular shapes!
   *
   * @param squareLength
   * @public
   */
  decomposeIntoSquares(squareLength) {
    assert && assert(this.shape.bounds.width % squareLength === 0 && this.shape.bounds.height % squareLength === 0, 'Error: A dimension of this movable shape is not an integer multiple of the provided dimension');
    const shapes = [];
    const unitSquareShape = Shape.rect(0, 0, squareLength, squareLength);
    for (let column = 0; column < this.shape.bounds.width; column += squareLength) {
      for (let row = 0; row < this.shape.bounds.height; row += squareLength) {
        const constituentShape = new MovableShape(unitSquareShape, this.color, this.positionProperty.initialValue);
        constituentShape.setDestination(this.positionProperty.get().plusXY(column, row), false);
        constituentShape.invisibleWhenStillProperty.set(this.invisibleWhenStillProperty.get());
        shapes.push(constituentShape);
      }
    }
    return shapes;
  }
}
areaBuilder.register('MovableShape', MovableShape);
export default MovableShape;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbWl0dGVyIiwiUHJvcGVydHkiLCJWZWN0b3IyIiwiU2hhcGUiLCJDb2xvciIsImFyZWFCdWlsZGVyIiwiQXJlYUJ1aWxkZXJTaGFyZWRDb25zdGFudHMiLCJGQURFX1JBVEUiLCJNb3ZhYmxlU2hhcGUiLCJjb25zdHJ1Y3RvciIsInNoYXBlIiwiY29sb3IiLCJpbml0aWFsUG9zaXRpb24iLCJwb3NpdGlvblByb3BlcnR5IiwidXNlckNvbnRyb2xsZWRQcm9wZXJ0eSIsImFuaW1hdGluZ1Byb3BlcnR5IiwicmVlbnRyYW50IiwiaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llcyIsImZhZGVQcm9wb3J0aW9uUHJvcGVydHkiLCJpbnZpc2libGVXaGVuU3RpbGxQcm9wZXJ0eSIsImRlc3RpbmF0aW9uIiwiY29weSIsInJldHVybmVkVG9PcmlnaW5FbWl0dGVyIiwibGF6eUxpbmsiLCJwb3NpdGlvbiIsImVxdWFscyIsImVtaXQiLCJ0b0NvbG9yIiwiZmFkaW5nIiwic3RlcCIsImR0IiwiZ2V0IiwiY3VycmVudFBvc2l0aW9uIiwiZGlzdGFuY2VUb0Rlc3RpbmF0aW9uIiwiZGlzdGFuY2UiLCJBTklNQVRJT05fU1BFRUQiLCJzdGVwQW5nbGUiLCJNYXRoIiwiYXRhbjIiLCJ5IiwieCIsInN0ZXBWZWN0b3IiLCJjcmVhdGVQb2xhciIsInNldCIsInBsdXMiLCJtaW4iLCJzZXREZXN0aW5hdGlvbiIsImFuaW1hdGUiLCJyZXR1cm5Ub09yaWdpbiIsImluaXRpYWxWYWx1ZSIsImZhZGVBd2F5IiwiZGVjb21wb3NlSW50b1NxdWFyZXMiLCJzcXVhcmVMZW5ndGgiLCJhc3NlcnQiLCJib3VuZHMiLCJ3aWR0aCIsImhlaWdodCIsInNoYXBlcyIsInVuaXRTcXVhcmVTaGFwZSIsInJlY3QiLCJjb2x1bW4iLCJyb3ciLCJjb25zdGl0dWVudFNoYXBlIiwicGx1c1hZIiwicHVzaCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTW92YWJsZVNoYXBlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFR5cGUgdGhhdCBkZWZpbmVzIGEgc2hhcGUgdGhhdCBjYW4gYmUgbW92ZWQgYnkgdGhlIHVzZXIgYW5kIHBsYWNlZCBvbiB0aGUgc2hhcGUgcGxhY2VtZW50IGJvYXJkcy5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKi9cclxuXHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCB7IENvbG9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGFyZWFCdWlsZGVyIGZyb20gJy4uLy4uL2FyZWFCdWlsZGVyLmpzJztcclxuaW1wb3J0IEFyZWFCdWlsZGVyU2hhcmVkQ29uc3RhbnRzIGZyb20gJy4uL0FyZWFCdWlsZGVyU2hhcmVkQ29uc3RhbnRzLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBGQURFX1JBVEUgPSAyOyAvLyBwcm9wb3J0aW9uIHBlciBzZWNvbmRcclxuXHJcbmNsYXNzIE1vdmFibGVTaGFwZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7U2hhcGV9IHNoYXBlXHJcbiAgICogQHBhcmFtIHtDb2xvciB8fCBzdHJpbmd9IGNvbG9yXHJcbiAgICogQHBhcmFtIHtWZWN0b3IyfSBpbml0aWFsUG9zaXRpb25cclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvciggc2hhcGUsIGNvbG9yLCBpbml0aWFsUG9zaXRpb24gKSB7XHJcblxyXG4gICAgLy8gUHJvcGVydHkgdGhhdCBpbmRpY2F0ZXMgd2hlcmUgaW4gbW9kZWwgc3BhY2UgdGhlIHVwcGVyIGxlZnQgY29ybmVyIG9mIHRoaXMgc2hhcGUgaXMuICBJbiBnZW5lcmFsLCB0aGlzIHNob3VsZFxyXG4gICAgLy8gbm90IGJlIHNldCBkaXJlY3RseSBvdXRzaWRlIG9mIHRoaXMgdHlwZSwgYW5kIHNob3VsZCBvbmx5IGJlIG1hbmlwdWxhdGVkIHRocm91Z2ggdGhlIG1ldGhvZHMgZGVmaW5lZCBiZWxvdy5cclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggaW5pdGlhbFBvc2l0aW9uICk7XHJcblxyXG4gICAgLy8gRmxhZyB0aGF0IHRyYWNrcyB3aGV0aGVyIHRoZSB1c2VyIGlzIGRyYWdnaW5nIHRoaXMgc2hhcGUgYXJvdW5kLiAgU2hvdWxkIGJlIHNldCBleHRlcm5hbGx5IDsgZ2VuZXJhbGx5IGJ5IHRoZSBhXHJcbiAgICAvLyB2aWV3IG5vZGUuXHJcbiAgICB0aGlzLnVzZXJDb250cm9sbGVkUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIGZhbHNlICk7XHJcblxyXG4gICAgLy8gRmxhZyB0aGF0IGluZGljYXRlcyB3aGV0aGVyIHRoaXMgZWxlbWVudCBpcyBhbmltYXRpbmcgZnJvbSBvbmUgcG9zaXRpb24gdG8gYW5vdGhlciA7IHNob3VsZCBub3QgYmUgc2V0IGV4dGVybmFsbHkuXHJcbiAgICB0aGlzLmFuaW1hdGluZ1Byb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBmYWxzZSwge1xyXG4gICAgICByZWVudHJhbnQ6IHRydWUsXHJcbiAgICAgIGhhc0xpc3RlbmVyT3JkZXJEZXBlbmRlbmNpZXM6IHRydWUgLy8gVE9ETzogaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2FyZWEtYnVpbGRlci9pc3N1ZXMvMTI0XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVmFsdWUgdGhhdCBpbmRpY2F0ZXMgaG93IGZhZGVkIG91dCB0aGlzIHNoYXBlIGlzLiAgVGhpcyBpcyB1c2VkIGFzIHBhcnQgb2YgYSBmZWF0dXJlIHdoZXJlIHNoYXBlcyBjYW4gZmFkZVxyXG4gICAgLy8gb3V0LiAgT25jZSBmYWRlIGhhcyBzdGFydGVkIDsgaXQgZG9lc24ndCBzdG9wIHVudGlsIGl0IGlzIGZ1bGx5IGZhZGVkIDsgaS5lLiB0aGUgdmFsdWUgaXMgMS4gIFRoaXMgc2hvdWxkIG5vdCBiZVxyXG4gICAgLy8gc2V0IGV4dGVybmFsbHkuXHJcbiAgICB0aGlzLmZhZGVQcm9wb3J0aW9uUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIDAsIHsgaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llczogdHJ1ZSB9ICk7IC8vIFRPRE86IGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9hcmVhLWJ1aWxkZXIvaXNzdWVzLzEyNFxyXG5cclxuICAgIC8vIEEgZmxhZyB0aGF0IGluZGljYXRlcyB3aGV0aGVyIHRoaXMgaW5kaXZpZHVhbCBzaGFwZSBzaG91bGQgYmVjb21lIGludmlzaWJsZSB3aGVuIGl0IGlzIGRvbmUgYW5pbWF0aW5nLiAgVGhpc1xyXG4gICAgLy8gaXMgZ2VuZXJhbGx5IHVzZWQgaW4gY2FzZXMgd2hlcmUgaXQgYmVjb21lcyBwYXJ0IG9mIGEgbGFyZ2VyIGNvbXBvc2l0ZSBzaGFwZSB0aGF0IGlzIGRlcGljdGVkIGluc3RlYWQuXHJcbiAgICB0aGlzLmludmlzaWJsZVdoZW5TdGlsbFByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCB0cnVlICk7XHJcblxyXG4gICAgLy8gRGVzdGluYXRpb24gaXMgdXNlZCBmb3IgYW5pbWF0aW9uLCBhbmQgc2hvdWxkIGJlIHNldCB0aHJvdWdoIGFjY2Vzc29yIG1ldGhvZHMgb25seS5cclxuICAgIHRoaXMuZGVzdGluYXRpb24gPSBpbml0aWFsUG9zaXRpb24uY29weSgpOyAvLyBAcHJpdmF0ZVxyXG5cclxuICAgIC8vIEVtaXQgYW4gZXZlbnQgd2hlbmV2ZXIgdGhpcyBzaGFwZSByZXR1cm5zIHRvIGl0cyBvcmlnaW5hbCBwb3NpdGlvbi5cclxuICAgIHRoaXMucmV0dXJuZWRUb09yaWdpbkVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xyXG4gICAgdGhpcy5wb3NpdGlvblByb3BlcnR5LmxhenlMaW5rKCBwb3NpdGlvbiA9PiB7XHJcbiAgICAgIGlmICggcG9zaXRpb24uZXF1YWxzKCBpbml0aWFsUG9zaXRpb24gKSApIHtcclxuICAgICAgICB0aGlzLnJldHVybmVkVG9PcmlnaW5FbWl0dGVyLmVtaXQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE5vbi1keW5hbWljIGF0dHJpYnV0ZXNcclxuICAgIHRoaXMuc2hhcGUgPSBzaGFwZTsgLy8gQHB1YmxpYywgcmVhZCBvbmx5XHJcbiAgICB0aGlzLmNvbG9yID0gQ29sb3IudG9Db2xvciggY29sb3IgKTsgLy8gQHB1YmxpY1xyXG5cclxuICAgIC8vIEludGVybmFsIHZhcnNcclxuICAgIHRoaXMuZmFkaW5nID0gZmFsc2U7IC8vIEBwcml2YXRlXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHRcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgc3RlcCggZHQgKSB7XHJcbiAgICBpZiAoICF0aGlzLnVzZXJDb250cm9sbGVkUHJvcGVydHkuZ2V0KCkgKSB7XHJcblxyXG4gICAgICAvLyBQZXJmb3JtIGFueSBhbmltYXRpb24uXHJcbiAgICAgIGNvbnN0IGN1cnJlbnRQb3NpdGlvbiA9IHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKTtcclxuICAgICAgY29uc3QgZGlzdGFuY2VUb0Rlc3RpbmF0aW9uID0gY3VycmVudFBvc2l0aW9uLmRpc3RhbmNlKCB0aGlzLmRlc3RpbmF0aW9uICk7XHJcbiAgICAgIGlmICggZGlzdGFuY2VUb0Rlc3RpbmF0aW9uID4gZHQgKiBBcmVhQnVpbGRlclNoYXJlZENvbnN0YW50cy5BTklNQVRJT05fU1BFRUQgKSB7XHJcblxyXG4gICAgICAgIC8vIE1vdmUgYSBzdGVwIHRvd2FyZCB0aGUgZGVzdGluYXRpb24uXHJcbiAgICAgICAgY29uc3Qgc3RlcEFuZ2xlID0gTWF0aC5hdGFuMiggdGhpcy5kZXN0aW5hdGlvbi55IC0gY3VycmVudFBvc2l0aW9uLnksIHRoaXMuZGVzdGluYXRpb24ueCAtIGN1cnJlbnRQb3NpdGlvbi54ICk7XHJcbiAgICAgICAgY29uc3Qgc3RlcFZlY3RvciA9IFZlY3RvcjIuY3JlYXRlUG9sYXIoIEFyZWFCdWlsZGVyU2hhcmVkQ29uc3RhbnRzLkFOSU1BVElPTl9TUEVFRCAqIGR0LCBzdGVwQW5nbGUgKTtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkuc2V0KCBjdXJyZW50UG9zaXRpb24ucGx1cyggc3RlcFZlY3RvciApICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIHRoaXMuYW5pbWF0aW5nUHJvcGVydHkuZ2V0KCkgKSB7XHJcblxyXG4gICAgICAgIC8vIExlc3MgdGhhbiBvbmUgdGltZSBzdGVwIGF3YXksIHNvIGp1c3QgZ28gdG8gdGhlIGRlc3RpbmF0aW9uLlxyXG4gICAgICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5zZXQoIHRoaXMuZGVzdGluYXRpb24gKTtcclxuICAgICAgICB0aGlzLmFuaW1hdGluZ1Byb3BlcnR5LnNldCggZmFsc2UgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUGVyZm9ybSBhbnkgZmFkaW5nLlxyXG4gICAgICBpZiAoIHRoaXMuZmFkaW5nICkge1xyXG4gICAgICAgIHRoaXMuZmFkZVByb3BvcnRpb25Qcm9wZXJ0eS5zZXQoIE1hdGgubWluKCAxLCB0aGlzLmZhZGVQcm9wb3J0aW9uUHJvcGVydHkuZ2V0KCkgKyAoIGR0ICogRkFERV9SQVRFICkgKSApO1xyXG4gICAgICAgIGlmICggdGhpcy5mYWRlUHJvcG9ydGlvblByb3BlcnR5LmdldCgpID49IDEgKSB7XHJcbiAgICAgICAgICB0aGlzLmZhZGluZyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IHRoZSBkZXN0aW5hdGlvbiBmb3IgdGhpcyBzaGFwZS5cclxuICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IGRlc3RpbmF0aW9uXHJcbiAgICogQHBhcmFtIHtib29sZWFufSBhbmltYXRlXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHNldERlc3RpbmF0aW9uKCBkZXN0aW5hdGlvbiwgYW5pbWF0ZSApIHtcclxuICAgIHRoaXMuZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbjtcclxuICAgIGlmICggYW5pbWF0ZSApIHtcclxuICAgICAgdGhpcy5hbmltYXRpbmdQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmFuaW1hdGluZ1Byb3BlcnR5LnNldCggZmFsc2UgKTtcclxuICAgICAgdGhpcy5wb3NpdGlvblByb3BlcnR5LnNldCggdGhpcy5kZXN0aW5hdGlvbiApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJuIHRoZSBzaGFwZSB0byB0aGUgcGxhY2Ugd2hlcmUgaXQgd2FzIG9yaWdpbmFsbHkgY3JlYXRlZC5cclxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFuaW1hdGVcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmV0dXJuVG9PcmlnaW4oIGFuaW1hdGUgKSB7XHJcbiAgICB0aGlzLnNldERlc3RpbmF0aW9uKCB0aGlzLnBvc2l0aW9uUHJvcGVydHkuaW5pdGlhbFZhbHVlLCBhbmltYXRlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZmFkZUF3YXkoKSB7XHJcbiAgICB0aGlzLmZhZGluZyA9IHRydWU7XHJcbiAgICB0aGlzLmZhZGVQcm9wb3J0aW9uUHJvcGVydHkuc2V0KCAwLjAwMDEgKTsgLy8gdGhpcyBpcyBkb25lIHRvIG1ha2Ugc3VyZSB0aGUgc2hhcGUgaXMgbWFkZSB1bnBpY2thYmxlIGFzIHNvb24gYXMgZmFkaW5nIHN0YXJ0c1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIHNldCBvZiBzcXVhcmVzIHRoYXQgYXJlIG9mIHRoZSBzcGVjaWZpZWQgc2l6ZSBhbmQgYXJlIHBvc2l0aW9uZWQgY29ycmVjdGx5IHN1Y2ggdGhhdCB0aGV5IGNvbGxlY3RpdmVseVxyXG4gICAqIG1ha2UgdXAgdGhlIHNhbWUgc2hhcGUgYXMgdGhpcyByZWN0YW5nbGUuICBUaGUgc3BlY2lmaWVkIGxlbmd0aCBtdXN0IGJlIGFuIGludGVnZXIgdmFsdWUgb2YgdGhlIGxlbmd0aCBhbmRcclxuICAgKiB3aWR0aCBvciB0aGluZ3Mgd2lsbCBnZXQgd2VpcmQuXHJcbiAgICpcclxuICAgKiBOT1RFOiBUaGlzIG9ubHkgd29ya3MgcHJvcGVybHkgZm9yIHJlY3Rhbmd1bGFyIHNoYXBlcyFcclxuICAgKlxyXG4gICAqIEBwYXJhbSBzcXVhcmVMZW5ndGhcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZGVjb21wb3NlSW50b1NxdWFyZXMoIHNxdWFyZUxlbmd0aCApIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMuc2hhcGUuYm91bmRzLndpZHRoICUgc3F1YXJlTGVuZ3RoID09PSAwICYmIHRoaXMuc2hhcGUuYm91bmRzLmhlaWdodCAlIHNxdWFyZUxlbmd0aCA9PT0gMCxcclxuICAgICAgJ0Vycm9yOiBBIGRpbWVuc2lvbiBvZiB0aGlzIG1vdmFibGUgc2hhcGUgaXMgbm90IGFuIGludGVnZXIgbXVsdGlwbGUgb2YgdGhlIHByb3ZpZGVkIGRpbWVuc2lvbicgKTtcclxuICAgIGNvbnN0IHNoYXBlcyA9IFtdO1xyXG4gICAgY29uc3QgdW5pdFNxdWFyZVNoYXBlID0gU2hhcGUucmVjdCggMCwgMCwgc3F1YXJlTGVuZ3RoLCBzcXVhcmVMZW5ndGggKTtcclxuICAgIGZvciAoIGxldCBjb2x1bW4gPSAwOyBjb2x1bW4gPCB0aGlzLnNoYXBlLmJvdW5kcy53aWR0aDsgY29sdW1uICs9IHNxdWFyZUxlbmd0aCApIHtcclxuICAgICAgZm9yICggbGV0IHJvdyA9IDA7IHJvdyA8IHRoaXMuc2hhcGUuYm91bmRzLmhlaWdodDsgcm93ICs9IHNxdWFyZUxlbmd0aCApIHtcclxuICAgICAgICBjb25zdCBjb25zdGl0dWVudFNoYXBlID0gbmV3IE1vdmFibGVTaGFwZSggdW5pdFNxdWFyZVNoYXBlLCB0aGlzLmNvbG9yLCB0aGlzLnBvc2l0aW9uUHJvcGVydHkuaW5pdGlhbFZhbHVlICk7XHJcbiAgICAgICAgY29uc3RpdHVlbnRTaGFwZS5zZXREZXN0aW5hdGlvbiggdGhpcy5wb3NpdGlvblByb3BlcnR5LmdldCgpLnBsdXNYWSggY29sdW1uLCByb3cgKSwgZmFsc2UgKTtcclxuICAgICAgICBjb25zdGl0dWVudFNoYXBlLmludmlzaWJsZVdoZW5TdGlsbFByb3BlcnR5LnNldCggdGhpcy5pbnZpc2libGVXaGVuU3RpbGxQcm9wZXJ0eS5nZXQoKSApO1xyXG4gICAgICAgIHNoYXBlcy5wdXNoKCBjb25zdGl0dWVudFNoYXBlICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBzaGFwZXM7XHJcbiAgfVxyXG59XHJcblxyXG5hcmVhQnVpbGRlci5yZWdpc3RlciggJ01vdmFibGVTaGFwZScsIE1vdmFibGVTaGFwZSApO1xyXG5leHBvcnQgZGVmYXVsdCBNb3ZhYmxlU2hhcGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLE9BQU8sTUFBTSxnQ0FBZ0M7QUFDcEQsT0FBT0MsUUFBUSxNQUFNLGlDQUFpQztBQUN0RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELFNBQVNDLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsU0FBU0MsS0FBSyxRQUFRLG1DQUFtQztBQUN6RCxPQUFPQyxXQUFXLE1BQU0sc0JBQXNCO0FBQzlDLE9BQU9DLDBCQUEwQixNQUFNLGtDQUFrQzs7QUFF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