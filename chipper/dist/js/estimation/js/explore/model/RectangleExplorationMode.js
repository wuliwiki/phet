// Copyright 2014-2021, University of Colorado Boulder

/**
 * Definition of the 'line exploration mode' for the exploration model.
 */

import Dimension2 from '../../../../dot/js/Dimension2.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import EstimationConstants from '../../common/EstimationConstants.js';
import RectangleModel from '../../common/model/RectangleModel.js';
import estimation from '../../estimation.js';
import AbstractExplorationMode from './AbstractExplorationMode.js';

// constants
const MAX_DISCRETE_RECTANGLES = 200;
const MODE_NAME = 'rectangles';
const COMPARE_RECTANGLE_SIZE = new Dimension2(2, 2);
const VALID_REF_OBJECT_SIZES = [new Dimension2(COMPARE_RECTANGLE_SIZE.width / 20, COMPARE_RECTANGLE_SIZE.height / 20), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 12, COMPARE_RECTANGLE_SIZE.height / 12), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 8, COMPARE_RECTANGLE_SIZE.height / 8), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 5, COMPARE_RECTANGLE_SIZE.height / 5), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 3, COMPARE_RECTANGLE_SIZE.height / 3), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 2, COMPARE_RECTANGLE_SIZE.height / 2), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 2, COMPARE_RECTANGLE_SIZE.height / 4), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 4, COMPARE_RECTANGLE_SIZE.height / 2), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 4, COMPARE_RECTANGLE_SIZE.height / 8), new Dimension2(COMPARE_RECTANGLE_SIZE.width / 8, COMPARE_RECTANGLE_SIZE.height / 4)];
const INITIAL_REFERENCE_OBJECT_SIZE = VALID_REF_OBJECT_SIZES[3];
class RectangleExplorationMode extends AbstractExplorationMode {
  constructor(selectedModeProperty) {
    super(selectedModeProperty, MODE_NAME);

    // Create the reference, compare, continuous, and discrete objects.
    const compareRectPosition = new Vector2(0, 0);
    this.compareObject = new RectangleModel(new Dimension2(2.0, 2.0), compareRectPosition, EstimationConstants.COMPARISON_OBJECT_COLOR, false, false);
    this.continuousSizableObject = new RectangleModel(new Dimension2(2, 1), compareRectPosition, EstimationConstants.REFERENCE_OBJECT_COLOR, false, false);
    this.referenceObject = new RectangleModel(new Dimension2(0.5, 0.5), new Vector2(-2.0, 0.5), EstimationConstants.REFERENCE_OBJECT_COLOR, false, false);
    _.times(MAX_DISCRETE_RECTANGLES, () => {
      // Initial size is arbitrary, will be sized as needed.
      this.discreteObjectList.push(new RectangleModel(new Dimension2(1.0, 1.0), Vector2.ZERO, EstimationConstants.REFERENCE_OBJECT_COLOR, true, false));
    });
    this.setReferenceObjectSize(INITIAL_REFERENCE_OBJECT_SIZE);
    this.numVisibleDiscreteRects = 0;

    // Complete initialization by hooking up visibility updates in the parent class.
    this.hookUpVisibilityUpdates();

    // Maintain a short history of reference object sizes so unique ones can be chosen.
    this.previousReferenceObjectSize = INITIAL_REFERENCE_OBJECT_SIZE;
  }

  // TODO: Visibility annotations should be checked and updated, see https://github.com/phetsims/estimation/issues/9

  // @public
  setReferenceObjectSize(size) {
    this.referenceObject.sizeProperty.value = size;

    // Size and position the discrete rectangles based on the sizes of the
    // reference rectangle and the compare rectangle.
    const rectanglesPerRow = this.compareObject.sizeProperty.value.width / this.referenceObject.sizeProperty.value.width;
    const numRows = this.discreteObjectList.length / rectanglesPerRow;
    const origin = this.compareObject.positionProperty.value;
    for (let i = 0; i < numRows; i++) {
      for (let j = 0; j < rectanglesPerRow; j++) {
        const index = i * rectanglesPerRow + j;
        if (index < MAX_DISCRETE_RECTANGLES) {
          this.discreteObjectList[index].sizeProperty.value = this.referenceObject.sizeProperty.value;
          this.discreteObjectList[index].positionProperty.value = new Vector2(origin.x + j * this.referenceObject.sizeProperty.value.width, origin.y + i * this.referenceObject.sizeProperty.value.height);
        }
      }
    }

    // Set the initial size of the continuous object.
    this.updateContinuousObjectSize(this.estimateProperty.value);
  }

  // @public
  newReferenceObject() {
    // Choose a random size that hasn't been chosen for a while.
    let unique = false;
    let referenceObjectSize = null;
    while (!unique) {
      referenceObjectSize = VALID_REF_OBJECT_SIZES[Math.floor(dotRandom.nextDouble() * VALID_REF_OBJECT_SIZES.length)];
      unique = referenceObjectSize !== this.previousReferenceObjectSize && referenceObjectSize !== this.referenceObject.size;
    }
    this.previousReferenceObjectSize = referenceObjectSize;
    this.setReferenceObjectSize(referenceObjectSize);
  }

  // @public
  setInitialReferenceObject() {
    this.setReferenceObjectSize(INITIAL_REFERENCE_OBJECT_SIZE);
  }

  // @public
  updateDiscreteObjectVisibility(selectedMode, estimateValue) {
    const targetNumVisibleDiscreteRects = selectedMode === 'rectangles' && this.continuousOrDiscreteProperty.value === 'discrete' ? estimateValue : 0;
    const startIndex = Math.min(this.numVisibleDiscreteRects, targetNumVisibleDiscreteRects);
    const endIndex = Math.max(this.numVisibleDiscreteRects, targetNumVisibleDiscreteRects);
    const visibility = targetNumVisibleDiscreteRects > this.numVisibleDiscreteRects;
    for (let i = startIndex; i < endIndex && i < MAX_DISCRETE_RECTANGLES; i++) {
      this.discreteObjectList[i].visibleProperty.value = visibility;
    }
    this.numVisibleDiscreteRects = targetNumVisibleDiscreteRects;
  }

  // @public
  updateContinuousObjectSize(estimateValue) {
    const hr = this.referenceObject.sizeProperty.value.height;
    const wr = this.referenceObject.sizeProperty.value.width;
    const hc = this.compareObject.sizeProperty.value.height;
    const wc = this.compareObject.sizeProperty.value.width;
    const answer = hc * wc / (hr * wr);
    const a = (1 - wc / wr) / (1 - answer) * (estimateValue - 1) + 1;
    const b = (1 - hc / hr) / (1 - answer) * (estimateValue - 1) + 1;
    // Set the size of the continuous rectangle
    this.continuousSizableObject.sizeProperty.value = new Dimension2(a * wr, b * hr);
  }
}
estimation.register('RectangleExplorationMode', RectangleExplorationMode);
export default RectangleExplorationMode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEaW1lbnNpb24yIiwiZG90UmFuZG9tIiwiVmVjdG9yMiIsIkVzdGltYXRpb25Db25zdGFudHMiLCJSZWN0YW5nbGVNb2RlbCIsImVzdGltYXRpb24iLCJBYnN0cmFjdEV4cGxvcmF0aW9uTW9kZSIsIk1BWF9ESVNDUkVURV9SRUNUQU5HTEVTIiwiTU9ERV9OQU1FIiwiQ09NUEFSRV9SRUNUQU5HTEVfU0laRSIsIlZBTElEX1JFRl9PQkpFQ1RfU0laRVMiLCJ3aWR0aCIsImhlaWdodCIsIklOSVRJQUxfUkVGRVJFTkNFX09CSkVDVF9TSVpFIiwiUmVjdGFuZ2xlRXhwbG9yYXRpb25Nb2RlIiwiY29uc3RydWN0b3IiLCJzZWxlY3RlZE1vZGVQcm9wZXJ0eSIsImNvbXBhcmVSZWN0UG9zaXRpb24iLCJjb21wYXJlT2JqZWN0IiwiQ09NUEFSSVNPTl9PQkpFQ1RfQ09MT1IiLCJjb250aW51b3VzU2l6YWJsZU9iamVjdCIsIlJFRkVSRU5DRV9PQkpFQ1RfQ09MT1IiLCJyZWZlcmVuY2VPYmplY3QiLCJfIiwidGltZXMiLCJkaXNjcmV0ZU9iamVjdExpc3QiLCJwdXNoIiwiWkVSTyIsInNldFJlZmVyZW5jZU9iamVjdFNpemUiLCJudW1WaXNpYmxlRGlzY3JldGVSZWN0cyIsImhvb2tVcFZpc2liaWxpdHlVcGRhdGVzIiwicHJldmlvdXNSZWZlcmVuY2VPYmplY3RTaXplIiwic2l6ZSIsInNpemVQcm9wZXJ0eSIsInZhbHVlIiwicmVjdGFuZ2xlc1BlclJvdyIsIm51bVJvd3MiLCJsZW5ndGgiLCJvcmlnaW4iLCJwb3NpdGlvblByb3BlcnR5IiwiaSIsImoiLCJpbmRleCIsIngiLCJ5IiwidXBkYXRlQ29udGludW91c09iamVjdFNpemUiLCJlc3RpbWF0ZVByb3BlcnR5IiwibmV3UmVmZXJlbmNlT2JqZWN0IiwidW5pcXVlIiwicmVmZXJlbmNlT2JqZWN0U2l6ZSIsIk1hdGgiLCJmbG9vciIsIm5leHREb3VibGUiLCJzZXRJbml0aWFsUmVmZXJlbmNlT2JqZWN0IiwidXBkYXRlRGlzY3JldGVPYmplY3RWaXNpYmlsaXR5Iiwic2VsZWN0ZWRNb2RlIiwiZXN0aW1hdGVWYWx1ZSIsInRhcmdldE51bVZpc2libGVEaXNjcmV0ZVJlY3RzIiwiY29udGludW91c09yRGlzY3JldGVQcm9wZXJ0eSIsInN0YXJ0SW5kZXgiLCJtaW4iLCJlbmRJbmRleCIsIm1heCIsInZpc2liaWxpdHkiLCJ2aXNpYmxlUHJvcGVydHkiLCJociIsIndyIiwiaGMiLCJ3YyIsImFuc3dlciIsImEiLCJiIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJSZWN0YW5nbGVFeHBsb3JhdGlvbk1vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMSwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGVmaW5pdGlvbiBvZiB0aGUgJ2xpbmUgZXhwbG9yYXRpb24gbW9kZScgZm9yIHRoZSBleHBsb3JhdGlvbiBtb2RlbC5cclxuICovXHJcblxyXG5pbXBvcnQgRGltZW5zaW9uMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvRGltZW5zaW9uMi5qcyc7XHJcbmltcG9ydCBkb3RSYW5kb20gZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL2RvdFJhbmRvbS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IEVzdGltYXRpb25Db25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0VzdGltYXRpb25Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgUmVjdGFuZ2xlTW9kZWwgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL1JlY3RhbmdsZU1vZGVsLmpzJztcclxuaW1wb3J0IGVzdGltYXRpb24gZnJvbSAnLi4vLi4vZXN0aW1hdGlvbi5qcyc7XHJcbmltcG9ydCBBYnN0cmFjdEV4cGxvcmF0aW9uTW9kZSBmcm9tICcuL0Fic3RyYWN0RXhwbG9yYXRpb25Nb2RlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBNQVhfRElTQ1JFVEVfUkVDVEFOR0xFUyA9IDIwMDtcclxuY29uc3QgTU9ERV9OQU1FID0gJ3JlY3RhbmdsZXMnO1xyXG5jb25zdCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFID0gbmV3IERpbWVuc2lvbjIoIDIsIDIgKTtcclxuY29uc3QgVkFMSURfUkVGX09CSkVDVF9TSVpFUyA9IFtcclxuICBuZXcgRGltZW5zaW9uMiggQ09NUEFSRV9SRUNUQU5HTEVfU0laRS53aWR0aCAvIDIwLCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLmhlaWdodCAvIDIwICksXHJcbiAgbmV3IERpbWVuc2lvbjIoIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUud2lkdGggLyAxMiwgQ09NUEFSRV9SRUNUQU5HTEVfU0laRS5oZWlnaHQgLyAxMiApLFxyXG4gIG5ldyBEaW1lbnNpb24yKCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLndpZHRoIC8gOCwgQ09NUEFSRV9SRUNUQU5HTEVfU0laRS5oZWlnaHQgLyA4ICksXHJcbiAgbmV3IERpbWVuc2lvbjIoIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUud2lkdGggLyA1LCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLmhlaWdodCAvIDUgKSxcclxuICBuZXcgRGltZW5zaW9uMiggQ09NUEFSRV9SRUNUQU5HTEVfU0laRS53aWR0aCAvIDMsIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUuaGVpZ2h0IC8gMyApLFxyXG4gIG5ldyBEaW1lbnNpb24yKCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLndpZHRoIC8gMiwgQ09NUEFSRV9SRUNUQU5HTEVfU0laRS5oZWlnaHQgLyAyICksXHJcbiAgbmV3IERpbWVuc2lvbjIoIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUud2lkdGggLyAyLCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLmhlaWdodCAvIDQgKSxcclxuICBuZXcgRGltZW5zaW9uMiggQ09NUEFSRV9SRUNUQU5HTEVfU0laRS53aWR0aCAvIDQsIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUuaGVpZ2h0IC8gMiApLFxyXG4gIG5ldyBEaW1lbnNpb24yKCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLndpZHRoIC8gNCwgQ09NUEFSRV9SRUNUQU5HTEVfU0laRS5oZWlnaHQgLyA4ICksXHJcbiAgbmV3IERpbWVuc2lvbjIoIENPTVBBUkVfUkVDVEFOR0xFX1NJWkUud2lkdGggLyA4LCBDT01QQVJFX1JFQ1RBTkdMRV9TSVpFLmhlaWdodCAvIDQgKVxyXG5dO1xyXG5jb25zdCBJTklUSUFMX1JFRkVSRU5DRV9PQkpFQ1RfU0laRSA9IFZBTElEX1JFRl9PQkpFQ1RfU0laRVNbIDMgXTtcclxuXHJcbmNsYXNzIFJlY3RhbmdsZUV4cGxvcmF0aW9uTW9kZSBleHRlbmRzIEFic3RyYWN0RXhwbG9yYXRpb25Nb2RlIHtcclxuXHJcbiAgY29uc3RydWN0b3IoIHNlbGVjdGVkTW9kZVByb3BlcnR5ICkge1xyXG4gICAgc3VwZXIoIHNlbGVjdGVkTW9kZVByb3BlcnR5LCBNT0RFX05BTUUgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIHJlZmVyZW5jZSwgY29tcGFyZSwgY29udGludW91cywgYW5kIGRpc2NyZXRlIG9iamVjdHMuXHJcbiAgICBjb25zdCBjb21wYXJlUmVjdFBvc2l0aW9uID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuICAgIHRoaXMuY29tcGFyZU9iamVjdCA9IG5ldyBSZWN0YW5nbGVNb2RlbCggbmV3IERpbWVuc2lvbjIoIDIuMCwgMi4wICksIGNvbXBhcmVSZWN0UG9zaXRpb24sIEVzdGltYXRpb25Db25zdGFudHMuQ09NUEFSSVNPTl9PQkpFQ1RfQ09MT1IsIGZhbHNlLCBmYWxzZSApO1xyXG4gICAgdGhpcy5jb250aW51b3VzU2l6YWJsZU9iamVjdCA9IG5ldyBSZWN0YW5nbGVNb2RlbCggbmV3IERpbWVuc2lvbjIoIDIsIDEgKSwgY29tcGFyZVJlY3RQb3NpdGlvbiwgRXN0aW1hdGlvbkNvbnN0YW50cy5SRUZFUkVOQ0VfT0JKRUNUX0NPTE9SLCBmYWxzZSwgZmFsc2UgKTtcclxuICAgIHRoaXMucmVmZXJlbmNlT2JqZWN0ID0gbmV3IFJlY3RhbmdsZU1vZGVsKCBuZXcgRGltZW5zaW9uMiggMC41LCAwLjUgKSwgbmV3IFZlY3RvcjIoIC0yLjAsIDAuNSApLCBFc3RpbWF0aW9uQ29uc3RhbnRzLlJFRkVSRU5DRV9PQkpFQ1RfQ09MT1IsIGZhbHNlLCBmYWxzZSApO1xyXG4gICAgXy50aW1lcyggTUFYX0RJU0NSRVRFX1JFQ1RBTkdMRVMsICgpID0+IHtcclxuICAgICAgLy8gSW5pdGlhbCBzaXplIGlzIGFyYml0cmFyeSwgd2lsbCBiZSBzaXplZCBhcyBuZWVkZWQuXHJcbiAgICAgIHRoaXMuZGlzY3JldGVPYmplY3RMaXN0LnB1c2goIG5ldyBSZWN0YW5nbGVNb2RlbCggbmV3IERpbWVuc2lvbjIoIDEuMCwgMS4wICksIFZlY3RvcjIuWkVSTywgRXN0aW1hdGlvbkNvbnN0YW50cy5SRUZFUkVOQ0VfT0JKRUNUX0NPTE9SLCB0cnVlLCBmYWxzZSApICk7XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLnNldFJlZmVyZW5jZU9iamVjdFNpemUoIElOSVRJQUxfUkVGRVJFTkNFX09CSkVDVF9TSVpFICk7XHJcbiAgICB0aGlzLm51bVZpc2libGVEaXNjcmV0ZVJlY3RzID0gMDtcclxuXHJcbiAgICAvLyBDb21wbGV0ZSBpbml0aWFsaXphdGlvbiBieSBob29raW5nIHVwIHZpc2liaWxpdHkgdXBkYXRlcyBpbiB0aGUgcGFyZW50IGNsYXNzLlxyXG4gICAgdGhpcy5ob29rVXBWaXNpYmlsaXR5VXBkYXRlcygpO1xyXG5cclxuICAgIC8vIE1haW50YWluIGEgc2hvcnQgaGlzdG9yeSBvZiByZWZlcmVuY2Ugb2JqZWN0IHNpemVzIHNvIHVuaXF1ZSBvbmVzIGNhbiBiZSBjaG9zZW4uXHJcbiAgICB0aGlzLnByZXZpb3VzUmVmZXJlbmNlT2JqZWN0U2l6ZSA9IElOSVRJQUxfUkVGRVJFTkNFX09CSkVDVF9TSVpFO1xyXG4gIH1cclxuXHJcbiAgLy8gVE9ETzogVmlzaWJpbGl0eSBhbm5vdGF0aW9ucyBzaG91bGQgYmUgY2hlY2tlZCBhbmQgdXBkYXRlZCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9lc3RpbWF0aW9uL2lzc3Vlcy85XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICBzZXRSZWZlcmVuY2VPYmplY3RTaXplKCBzaXplICkge1xyXG4gICAgdGhpcy5yZWZlcmVuY2VPYmplY3Quc2l6ZVByb3BlcnR5LnZhbHVlID0gc2l6ZTtcclxuXHJcbiAgICAvLyBTaXplIGFuZCBwb3NpdGlvbiB0aGUgZGlzY3JldGUgcmVjdGFuZ2xlcyBiYXNlZCBvbiB0aGUgc2l6ZXMgb2YgdGhlXHJcbiAgICAvLyByZWZlcmVuY2UgcmVjdGFuZ2xlIGFuZCB0aGUgY29tcGFyZSByZWN0YW5nbGUuXHJcbiAgICBjb25zdCByZWN0YW5nbGVzUGVyUm93ID0gdGhpcy5jb21wYXJlT2JqZWN0LnNpemVQcm9wZXJ0eS52YWx1ZS53aWR0aCAvIHRoaXMucmVmZXJlbmNlT2JqZWN0LnNpemVQcm9wZXJ0eS52YWx1ZS53aWR0aDtcclxuICAgIGNvbnN0IG51bVJvd3MgPSB0aGlzLmRpc2NyZXRlT2JqZWN0TGlzdC5sZW5ndGggLyByZWN0YW5nbGVzUGVyUm93O1xyXG4gICAgY29uc3Qgb3JpZ2luID0gdGhpcy5jb21wYXJlT2JqZWN0LnBvc2l0aW9uUHJvcGVydHkudmFsdWU7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBudW1Sb3dzOyBpKysgKSB7XHJcbiAgICAgIGZvciAoIGxldCBqID0gMDsgaiA8IHJlY3RhbmdsZXNQZXJSb3c7IGorKyApIHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IGkgKiByZWN0YW5nbGVzUGVyUm93ICsgajtcclxuICAgICAgICBpZiAoIGluZGV4IDwgTUFYX0RJU0NSRVRFX1JFQ1RBTkdMRVMgKSB7XHJcbiAgICAgICAgICB0aGlzLmRpc2NyZXRlT2JqZWN0TGlzdFsgaW5kZXggXS5zaXplUHJvcGVydHkudmFsdWUgPSB0aGlzLnJlZmVyZW5jZU9iamVjdC5zaXplUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgICB0aGlzLmRpc2NyZXRlT2JqZWN0TGlzdFsgaW5kZXggXS5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIG9yaWdpbi54ICsgaiAqIHRoaXMucmVmZXJlbmNlT2JqZWN0LnNpemVQcm9wZXJ0eS52YWx1ZS53aWR0aCxcclxuICAgICAgICAgICAgb3JpZ2luLnkgKyBpICogdGhpcy5yZWZlcmVuY2VPYmplY3Quc2l6ZVByb3BlcnR5LnZhbHVlLmhlaWdodCApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFNldCB0aGUgaW5pdGlhbCBzaXplIG9mIHRoZSBjb250aW51b3VzIG9iamVjdC5cclxuICAgIHRoaXMudXBkYXRlQ29udGludW91c09iamVjdFNpemUoIHRoaXMuZXN0aW1hdGVQcm9wZXJ0eS52YWx1ZSApO1xyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIG5ld1JlZmVyZW5jZU9iamVjdCgpIHtcclxuICAgIC8vIENob29zZSBhIHJhbmRvbSBzaXplIHRoYXQgaGFzbid0IGJlZW4gY2hvc2VuIGZvciBhIHdoaWxlLlxyXG4gICAgbGV0IHVuaXF1ZSA9IGZhbHNlO1xyXG4gICAgbGV0IHJlZmVyZW5jZU9iamVjdFNpemUgPSBudWxsO1xyXG4gICAgd2hpbGUgKCAhdW5pcXVlICkge1xyXG4gICAgICByZWZlcmVuY2VPYmplY3RTaXplID0gVkFMSURfUkVGX09CSkVDVF9TSVpFU1sgTWF0aC5mbG9vciggZG90UmFuZG9tLm5leHREb3VibGUoKSAqIFZBTElEX1JFRl9PQkpFQ1RfU0laRVMubGVuZ3RoICkgXTtcclxuICAgICAgdW5pcXVlID0gKCByZWZlcmVuY2VPYmplY3RTaXplICE9PSB0aGlzLnByZXZpb3VzUmVmZXJlbmNlT2JqZWN0U2l6ZSAmJiByZWZlcmVuY2VPYmplY3RTaXplICE9PSB0aGlzLnJlZmVyZW5jZU9iamVjdC5zaXplICk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnByZXZpb3VzUmVmZXJlbmNlT2JqZWN0U2l6ZSA9IHJlZmVyZW5jZU9iamVjdFNpemU7XHJcbiAgICB0aGlzLnNldFJlZmVyZW5jZU9iamVjdFNpemUoIHJlZmVyZW5jZU9iamVjdFNpemUgKTtcclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICBzZXRJbml0aWFsUmVmZXJlbmNlT2JqZWN0KCkge1xyXG4gICAgdGhpcy5zZXRSZWZlcmVuY2VPYmplY3RTaXplKCBJTklUSUFMX1JFRkVSRU5DRV9PQkpFQ1RfU0laRSApO1xyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIHVwZGF0ZURpc2NyZXRlT2JqZWN0VmlzaWJpbGl0eSggc2VsZWN0ZWRNb2RlLCBlc3RpbWF0ZVZhbHVlICkge1xyXG4gICAgY29uc3QgdGFyZ2V0TnVtVmlzaWJsZURpc2NyZXRlUmVjdHMgPSBzZWxlY3RlZE1vZGUgPT09ICdyZWN0YW5nbGVzJyAmJiB0aGlzLmNvbnRpbnVvdXNPckRpc2NyZXRlUHJvcGVydHkudmFsdWUgPT09ICdkaXNjcmV0ZScgPyBlc3RpbWF0ZVZhbHVlIDogMDtcclxuICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBNYXRoLm1pbiggdGhpcy5udW1WaXNpYmxlRGlzY3JldGVSZWN0cywgdGFyZ2V0TnVtVmlzaWJsZURpc2NyZXRlUmVjdHMgKTtcclxuICAgIGNvbnN0IGVuZEluZGV4ID0gTWF0aC5tYXgoIHRoaXMubnVtVmlzaWJsZURpc2NyZXRlUmVjdHMsIHRhcmdldE51bVZpc2libGVEaXNjcmV0ZVJlY3RzICk7XHJcbiAgICBjb25zdCB2aXNpYmlsaXR5ID0gdGFyZ2V0TnVtVmlzaWJsZURpc2NyZXRlUmVjdHMgPiB0aGlzLm51bVZpc2libGVEaXNjcmV0ZVJlY3RzO1xyXG4gICAgZm9yICggbGV0IGkgPSBzdGFydEluZGV4OyBpIDwgZW5kSW5kZXggJiYgaSA8IE1BWF9ESVNDUkVURV9SRUNUQU5HTEVTOyBpKysgKSB7XHJcbiAgICAgIHRoaXMuZGlzY3JldGVPYmplY3RMaXN0WyBpIF0udmlzaWJsZVByb3BlcnR5LnZhbHVlID0gdmlzaWJpbGl0eTtcclxuICAgIH1cclxuICAgIHRoaXMubnVtVmlzaWJsZURpc2NyZXRlUmVjdHMgPSB0YXJnZXROdW1WaXNpYmxlRGlzY3JldGVSZWN0cztcclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWNcclxuICB1cGRhdGVDb250aW51b3VzT2JqZWN0U2l6ZSggZXN0aW1hdGVWYWx1ZSApIHtcclxuICAgIGNvbnN0IGhyID0gdGhpcy5yZWZlcmVuY2VPYmplY3Quc2l6ZVByb3BlcnR5LnZhbHVlLmhlaWdodDtcclxuICAgIGNvbnN0IHdyID0gdGhpcy5yZWZlcmVuY2VPYmplY3Quc2l6ZVByb3BlcnR5LnZhbHVlLndpZHRoO1xyXG4gICAgY29uc3QgaGMgPSB0aGlzLmNvbXBhcmVPYmplY3Quc2l6ZVByb3BlcnR5LnZhbHVlLmhlaWdodDtcclxuICAgIGNvbnN0IHdjID0gdGhpcy5jb21wYXJlT2JqZWN0LnNpemVQcm9wZXJ0eS52YWx1ZS53aWR0aDtcclxuICAgIGNvbnN0IGFuc3dlciA9IGhjICogd2MgLyAoIGhyICogd3IgKTtcclxuICAgIGNvbnN0IGEgPSAoICggMSAtIHdjIC8gd3IgKSAvICggMSAtIGFuc3dlciApICkgKiAoIGVzdGltYXRlVmFsdWUgLSAxICkgKyAxO1xyXG4gICAgY29uc3QgYiA9ICggKCAxIC0gaGMgLyBociApIC8gKCAxIC0gYW5zd2VyICkgKSAqICggZXN0aW1hdGVWYWx1ZSAtIDEgKSArIDE7XHJcbiAgICAvLyBTZXQgdGhlIHNpemUgb2YgdGhlIGNvbnRpbnVvdXMgcmVjdGFuZ2xlXHJcbiAgICB0aGlzLmNvbnRpbnVvdXNTaXphYmxlT2JqZWN0LnNpemVQcm9wZXJ0eS52YWx1ZSA9IG5ldyBEaW1lbnNpb24yKCBhICogd3IsIGIgKiBociApO1xyXG4gIH1cclxufVxyXG5cclxuZXN0aW1hdGlvbi5yZWdpc3RlciggJ1JlY3RhbmdsZUV4cGxvcmF0aW9uTW9kZScsIFJlY3RhbmdsZUV4cGxvcmF0aW9uTW9kZSApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgUmVjdGFuZ2xlRXhwbG9yYXRpb25Nb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFVBQVUsTUFBTSxrQ0FBa0M7QUFDekQsT0FBT0MsU0FBUyxNQUFNLGlDQUFpQztBQUN2RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLG1CQUFtQixNQUFNLHFDQUFxQztBQUNyRSxPQUFPQyxjQUFjLE1BQU0sc0NBQXNDO0FBQ2pFLE9BQU9DLFVBQVUsTUFBTSxxQkFBcUI7QUFDNUMsT0FBT0MsdUJBQXVCLE1BQU0sOEJBQThCOztBQUVsRTtBQUNBLE1BQU1DLHVCQUF1QixHQUFHLEdBQUc7QUFDbkMsTUFBTUMsU0FBUyxHQUFHLFlBQVk7QUFDOUIsTUFBTUMsc0JBQXNCLEdBQUcsSUFBSVQsVUFBVSxDQUFFLENBQUMsRUFBRSxDQUFFLENBQUM7QUFDckQsTUFBTVUsc0JBQXNCLEdBQUcsQ0FDN0IsSUFBSVYsVUFBVSxDQUFFUyxzQkFBc0IsQ0FBQ0UsS0FBSyxHQUFHLEVBQUUsRUFBRUYsc0JBQXNCLENBQUNHLE1BQU0sR0FBRyxFQUFHLENBQUMsRUFDdkYsSUFBSVosVUFBVSxDQUFFUyxzQkFBc0IsQ0FBQ0UsS0FBSyxHQUFHLEVBQUUsRUFBRUYsc0JBQXNCLENBQUNHLE1BQU0sR0FBRyxFQUFHLENBQUMsRUFDdkYsSUFBSVosVUFBVSxDQUFFUyxzQkFBc0IsQ0FBQ0UsS0FBSyxHQUFHLENBQUMsRUFBRUYsc0JBQXNCLENBQUNHLE1BQU0sR0FBRyxDQUFFLENBQUMsRUFDckYsSUFBSVosVUFBVSxDQUFFUyxzQkFBc0IsQ0FBQ0UsS0FBSyxHQUFHLENBQUMsRUFBRUYsc0JBQXNCLENBQUNHLE1BQU0sR0FBRyxDQUFFLENBQUMsRUFDckYsSUFBSVosVUFBVSxDQUFFUyxzQkFBc0IsQ0FBQ0UsS0FBSyxHQUFHLENBQUMsRUFBRUYsc0JBQXNCLENBQUNHLE1BQU0sR0FBRyxDQUFFLENBQUMs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