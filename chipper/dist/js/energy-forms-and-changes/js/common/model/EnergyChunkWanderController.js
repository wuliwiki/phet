// Copyright 2014-2023, University of Colorado Boulder

/**
 * This type is used to make an energy chunk wander, i.e. to perform somewhat of a random walk while moving towards a
 * destination.
 *
 * @author John Blanco
 */

import Property from '../../../../axon/js/Property.js';
import dotRandom from '../../../../dot/js/dotRandom.js';
import Range from '../../../../dot/js/Range.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Vector2Property from '../../../../dot/js/Vector2Property.js';
import merge from '../../../../phet-core/js/merge.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import IOType from '../../../../tandem/js/types/IOType.js';
import NullableIO from '../../../../tandem/js/types/NullableIO.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import ReferenceIO from '../../../../tandem/js/types/ReferenceIO.js';
import energyFormsAndChanges from '../../energyFormsAndChanges.js';
import EnergyChunk from './EnergyChunk.js';

// constants
const DEFAULT_MIN_SPEED = 0.06; // In m/s.
const DEFAULT_MAX_SPEED = 0.10; // In m/s.
const MIN_TIME_IN_ONE_DIRECTION = 0.4;
const MAX_TIME_IN_ONE_DIRECTION = 0.8;
const DISTANCE_AT_WHICH_TO_STOP_WANDERING = 0.05; // in meters, empirically chosen
const DEFAULT_ANGLE_VARIATION = Math.PI * 0.2; // deviation from angle to destination, in radians, empirically chosen.
const GO_STRAIGHT_HOME_DISTANCE = 0.2; // in meters, distance at which, if destination changes, speed increases

class EnergyChunkWanderController extends PhetioObject {
  /**
   * @param {EnergyChunk} energyChunk
   * @param {Property.<Vector2>} destinationProperty
   * @param {Object} [options]
   */
  constructor(energyChunk, destinationProperty, options) {
    options = merge({
      // {Range|null} - bounding range in the X direction within which the energy chunk's motion should be constrained.
      // Not all energy chunks need this constraint, so null is an acceptable value
      horizontalWanderConstraint: null,
      // {number} - range of angle variations, higher means more wandering, in radians from Math.PI to zero
      wanderAngleVariation: DEFAULT_ANGLE_VARIATION,
      // {boolean} - Translate the EC position and wander constraints horizontally if the destination changes.  This
      // was found to be useful to help prevent "chase scenes" when an energy was heading towards an object and the
      // user started dragging that object.
      translateXWithDestination: true,
      // phet-io
      tandem: Tandem.REQUIRED,
      phetioType: EnergyChunkWanderController.EnergyChunkWanderControllerIO,
      phetioDynamicElement: true
    }, options);

    // parameter checking
    assert && options.horizontalWanderConstraint && assert(options.horizontalWanderConstraint.contains(energyChunk.positionProperty.value.x), 'energy chunk starting position is not within the wander constraint');
    assert && options.horizontalWanderConstraint && assert(options.horizontalWanderConstraint.contains(destinationProperty.value.x), 'energy chunk destination is not within the wander constraint');
    assert && assert(options.wanderAngleVariation <= Math.PI && options.wanderAngleVariation >= 0, 'wander angle must be from zero to PI (inclusive)');
    super(options);
    assert && Tandem.VALIDATION && this.isPhetioInstrumented() && assert(energyChunk.isPhetioInstrumented());

    // Instead of asserting that the destinationProperty is instrumented, assert that it must be instrumented if it
    // changes. This was the simplest solution zepumph and samreid came up with for dealing with supporting PhET-iO
    // state when there are usages that just wrap a single value in a Property and never change it.
    assert && Tandem.VALIDATION && destinationProperty.lazyLink(() => {
      assert(this.destinationProperty.isPhetioInstrumented(), 'If the destinationProperty ever changes, then it must be instrumented to support PhET-iO state.');
    });

    // @public (read-only) {EnergyChunk)
    this.energyChunk = energyChunk;

    // @private
    this.minSpeed = DEFAULT_MIN_SPEED;
    this.maxSpeed = DEFAULT_MAX_SPEED;
    this.horizontalWanderConstraint = options.horizontalWanderConstraint;
    this.wanderAngleVariation = options.wanderAngleVariation;
    this.destinationProperty = destinationProperty;
    this.velocity = new Vector2(0, DEFAULT_MAX_SPEED);
    this.wandering = true;

    // @private - Store this on the instance so that it can be set by PhET-iO state
    this.translateXWithDestination = options.translateXWithDestination;

    // @private - countdown to when the EnergyChunk will change direction
    this.countdownTimer = 0;
    this.resetCountdownTimer();
    this.changeVelocityVector();

    // if an energy chunk's destination moves, quickly send the chunk to its destination - this is used as a flag to
    // make sure only one speed increase happens
    let speedIncreased = false;
    const handleDestinationChanged = (newDestination, oldDestination) => {
      // Short circuit this if state is being set - otherwise approaching energy chunks that are part of the state can
      // get moved around, messing up their state.
      if (phet.joist.sim.isSettingPhetioStateProperty.value) {
        return;
      }
      const distanceToDestination = newDestination.distance(this.energyChunk.positionProperty.value);

      // if the destination changes, speed up and go directly to the destination
      if (distanceToDestination <= GO_STRAIGHT_HOME_DISTANCE && !speedIncreased) {
        const increaseFactor = 8; // empirically determined to be fast but still visible
        this.minSpeed = DEFAULT_MIN_SPEED * increaseFactor;
        this.maxSpeed = DEFAULT_MAX_SPEED * increaseFactor;
        speedIncreased = true;
        this.wandering = false;
      }
      this.changeVelocityVector();
      if (this.translateXWithDestination) {
        const translation = newDestination.minus(oldDestination);

        // adjust the current EC position
        this.energyChunk.positionProperty.set(this.energyChunk.positionProperty.value.plusXY(translation.x, 0));

        // adjust the wander constraints if present
        if (this.horizontalWanderConstraint) {
          this.setHorizontalWanderConstraint(new Range(this.horizontalWanderConstraint.min + translation.x, this.horizontalWanderConstraint.max + translation.x));
        }
      }
    };
    this.destinationProperty.lazyLink(handleDestinationChanged);
    this.disposeEnergyChunkWanderController = () => {
      this.destinationProperty.unlink(handleDestinationChanged);
    };
  }

  // @public (EnergyChunkWanderControllerIO)
  toStateObject() {
    const stateObject = {
      minSpeed: this.minSpeed,
      maxSpeed: this.maxSpeed,
      wanderAngleVariation: this.wanderAngleVariation,
      translateXWithDestination: this.translateXWithDestination,
      countdownTimer: this.countdownTimer,
      wandering: this.wandering,
      horizontalWanderConstraint: NullableIO(Range.RangeIO).toStateObject(this.horizontalWanderConstraint),
      energyChunkReference: ReferenceIO(EnergyChunk.EnergyChunkIO).toStateObject(this.energyChunk)
    };

    // NOTE: destinationProperty does not need to be instrumented to support this, as some Properties just wrap single
    // values that don't change.
    if (this.destinationProperty.isPhetioInstrumented()) {
      stateObject.destinationPropertyReference = ReferenceIO(Property.PropertyIO(Vector2.Vector2IO)).toStateObject(this.destinationProperty);
      stateObject.destinationVector2 = null;
    } else {
      stateObject.destinationPropertyReference = null;
      stateObject.destinationVector2 = Vector2.Vector2IO.toStateObject(this.destinationProperty.value);
    }
    return stateObject;
  }

  // @public (EnergyChunkWanderControllerIO)
  static stateObjectToCreateElementArguments(stateObject) {
    const energyChunk = ReferenceIO(EnergyChunk.EnergyChunkIO).fromStateObject(stateObject.energyChunkReference);
    let destinationProperty = null;
    if (stateObject.destinationPropertyReference) {
      destinationProperty = ReferenceIO(Property.PropertyIO(Vector2.Vector2IO)).fromStateObject(stateObject.destinationPropertyReference);
    } else if (stateObject.destinationVector2) {
      destinationProperty = new Vector2Property(Vector2.Vector2IO.fromStateObject(stateObject.destinationVector2));
    }
    return [energyChunk, destinationProperty, {}];
  }

  // @public (EnergyChunkWanderControllerIO)
  applyState(stateObject) {
    this.minSpeed = stateObject.minSpeed;
    this.maxSpeed = stateObject.maxSpeed;
    this.wanderAngleVariation = stateObject.wanderAngleVariation;
    this.translateXWithDestination = stateObject.translateXWithDestination;
    this.countdownTimer = stateObject.countdownTimer;
    this.wandering = stateObject.wandering;
    this.horizontalWanderConstraint = NullableIO(Range.RangeIO).fromStateObject(stateObject.horizontalWanderConstraint);
  }

  /**
   * dispose function
   * @public
   */
  dispose() {
    this.disposeEnergyChunkWanderController();
    super.dispose();
  }

  /**
   * Update the position of this energy chunk for a given change in time.
   * @param {number} dt
   * @public
   */
  updatePosition(dt) {
    const currentPosition = this.energyChunk.positionProperty.get();
    const destination = this.destinationProperty.get();
    const distanceToDestination = currentPosition.distance(destination);
    const speed = this.velocity.magnitude;

    // only do something if the energy chunk has not yet reached its destination
    if (speed > 0 || !currentPosition.equals(destination)) {
      // check if destination reached
      if (distanceToDestination <= this.velocity.magnitude * dt) {
        this.energyChunk.positionProperty.set(destination);
        this.velocity.setMagnitude(0);
      } else {
        if (this.horizontalWanderConstraint) {
          // stay within the confines of the horizontal wander constraint
          const proposedX = this.energyChunk.positionProperty.value.x + dt * this.velocity.x;
          if (proposedX < this.horizontalWanderConstraint.min && this.velocity.x < 0 || proposedX > this.horizontalWanderConstraint.max && this.velocity.x > 0) {
            // bounce in the x direction
            this.velocity.setX(-this.velocity.x);
          }
        }

        // update the position of the energy chunk based on its velocity
        this.energyChunk.positionProperty.set(new Vector2(currentPosition.x + dt * this.velocity.x, currentPosition.y + dt * this.velocity.y));

        // determine whether any updates to the motion are needed and make them if so
        this.countdownTimer -= dt;
        if (this.countdownTimer <= 0 || distanceToDestination < DISTANCE_AT_WHICH_TO_STOP_WANDERING) {
          this.changeVelocityVector();
          this.resetCountdownTimer();
        }
      }
    }
  }

  /**
   * randomly change the velocity vector of the energy chunk
   * @private
   */
  changeVelocityVector() {
    const vectorToDestination = this.destinationProperty.value.minus(this.energyChunk.positionProperty.value);
    let angle = vectorToDestination.angle;
    if (vectorToDestination.magnitude > DISTANCE_AT_WHICH_TO_STOP_WANDERING && this.wandering) {
      // add some randomness to the direction of travel
      angle = angle + (dotRandom.nextDouble() - 0.5) * 2 * this.wanderAngleVariation;
    }
    const speed = this.minSpeed + (this.maxSpeed - this.minSpeed) * dotRandom.nextDouble();
    this.velocity.setXY(speed * Math.cos(angle), speed * Math.sin(angle));
  }

  /**
   * reset the countdown timer that is used to decide when to change direction
   * @private
   */
  resetCountdownTimer() {
    this.countdownTimer = MIN_TIME_IN_ONE_DIRECTION + (MAX_TIME_IN_ONE_DIRECTION - MIN_TIME_IN_ONE_DIRECTION) * dotRandom.nextDouble();
  }

  /**
   * returns true if the energy chunk has reached its destination, false if not
   * @returns {boolean}
   * @public
   */
  isDestinationReached() {
    return this.energyChunk.positionProperty.value.equals(this.destinationProperty.value);
  }

  /**
   * set a new constraint on the wandering
   * @param {Range|null} horizontalWanderConstraint
   * @public
   */
  setHorizontalWanderConstraint(horizontalWanderConstraint) {
    this.horizontalWanderConstraint = horizontalWanderConstraint;
  }
}
EnergyChunkWanderController.EnergyChunkWanderControllerIO = new IOType('EnergyChunkWanderControllerIO', {
  valueType: EnergyChunkWanderController,
  toStateObject: energyChunkWanderController => energyChunkWanderController.toStateObject(),
  stateObjectToCreateElementArguments: EnergyChunkWanderController.stateObjectToCreateElementArguments,
  applyState: (energyChunkWanderController, stateObject) => energyChunkWanderController.applyState(stateObject),
  stateSchema: {
    minSpeed: NumberIO,
    maxSpeed: NumberIO,
    wanderAngleVariation: NumberIO,
    translateXWithDestination: BooleanIO,
    countdownTimer: NumberIO,
    wandering: BooleanIO,
    horizontalWanderConstraint: NullableIO(Range.RangeIO),
    energyChunkReference: ReferenceIO(EnergyChunk.EnergyChunkIO),
    destinationPropertyReference: NullableIO(ReferenceIO(Property.PropertyIO(Vector2.Vector2IO))),
    destinationVector2: NullableIO(Vector2.Vector2IO)
  }
});
energyFormsAndChanges.register('EnergyChunkWanderController', EnergyChunkWanderController);
export default EnergyChunkWanderController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImRvdFJhbmRvbSIsIlJhbmdlIiwiVmVjdG9yMiIsIlZlY3RvcjJQcm9wZXJ0eSIsIm1lcmdlIiwiUGhldGlvT2JqZWN0IiwiVGFuZGVtIiwiQm9vbGVhbklPIiwiSU9UeXBlIiwiTnVsbGFibGVJTyIsIk51bWJlcklPIiwiUmVmZXJlbmNlSU8iLCJlbmVyZ3lGb3Jtc0FuZENoYW5nZXMiLCJFbmVyZ3lDaHVuayIsIkRFRkFVTFRfTUlOX1NQRUVEIiwiREVGQVVMVF9NQVhfU1BFRUQiLCJNSU5fVElNRV9JTl9PTkVfRElSRUNUSU9OIiwiTUFYX1RJTUVfSU5fT05FX0RJUkVDVElPTiIsIkRJU1RBTkNFX0FUX1dISUNIX1RPX1NUT1BfV0FOREVSSU5HIiwiREVGQVVMVF9BTkdMRV9WQVJJQVRJT04iLCJNYXRoIiwiUEkiLCJHT19TVFJBSUdIVF9IT01FX0RJU1RBTkNFIiwiRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyIiwiY29uc3RydWN0b3IiLCJlbmVyZ3lDaHVuayIsImRlc3RpbmF0aW9uUHJvcGVydHkiLCJvcHRpb25zIiwiaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQiLCJ3YW5kZXJBbmdsZVZhcmlhdGlvbiIsInRyYW5zbGF0ZVhXaXRoRGVzdGluYXRpb24iLCJ0YW5kZW0iLCJSRVFVSVJFRCIsInBoZXRpb1R5cGUiLCJFbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXJJTyIsInBoZXRpb0R5bmFtaWNFbGVtZW50IiwiYXNzZXJ0IiwiY29udGFpbnMiLCJwb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJ4IiwiVkFMSURBVElPTiIsImlzUGhldGlvSW5zdHJ1bWVudGVkIiwibGF6eUxpbmsiLCJtaW5TcGVlZCIsIm1heFNwZWVkIiwidmVsb2NpdHkiLCJ3YW5kZXJpbmciLCJjb3VudGRvd25UaW1lciIsInJlc2V0Q291bnRkb3duVGltZXIiLCJjaGFuZ2VWZWxvY2l0eVZlY3RvciIsInNwZWVkSW5jcmVhc2VkIiwiaGFuZGxlRGVzdGluYXRpb25DaGFuZ2VkIiwibmV3RGVzdGluYXRpb24iLCJvbGREZXN0aW5hdGlvbiIsInBoZXQiLCJqb2lzdCIsInNpbSIsImlzU2V0dGluZ1BoZXRpb1N0YXRlUHJvcGVydHkiLCJkaXN0YW5jZVRvRGVzdGluYXRpb24iLCJkaXN0YW5jZSIsImluY3JlYXNlRmFjdG9yIiwidHJhbnNsYXRpb24iLCJtaW51cyIsInNldCIsInBsdXNYWSIsInNldEhvcml6b250YWxXYW5kZXJDb25zdHJhaW50IiwibWluIiwibWF4IiwiZGlzcG9zZUVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlciIsInVubGluayIsInRvU3RhdGVPYmplY3QiLCJzdGF0ZU9iamVjdCIsIlJhbmdlSU8iLCJlbmVyZ3lDaHVua1JlZmVyZW5jZSIsIkVuZXJneUNodW5rSU8iLCJkZXN0aW5hdGlvblByb3BlcnR5UmVmZXJlbmNlIiwiUHJvcGVydHlJTyIsIlZlY3RvcjJJTyIsImRlc3RpbmF0aW9uVmVjdG9yMiIsInN0YXRlT2JqZWN0VG9DcmVhdGVFbGVtZW50QXJndW1lbnRzIiwiZnJvbVN0YXRlT2JqZWN0IiwiYXBwbHlTdGF0ZSIsImRpc3Bvc2UiLCJ1cGRhdGVQb3NpdGlvbiIsImR0IiwiY3VycmVudFBvc2l0aW9uIiwiZ2V0IiwiZGVzdGluYXRpb24iLCJzcGVlZCIsIm1hZ25pdHVkZSIsImVxdWFscyIsInNldE1hZ25pdHVkZSIsInByb3Bvc2VkWCIsInNldFgiLCJ5IiwidmVjdG9yVG9EZXN0aW5hdGlvbiIsImFuZ2xlIiwibmV4dERvdWJsZSIsInNldFhZIiwiY29zIiwic2luIiwiaXNEZXN0aW5hdGlvblJlYWNoZWQiLCJ2YWx1ZVR5cGUiLCJlbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXIiLCJzdGF0ZVNjaGVtYSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoaXMgdHlwZSBpcyB1c2VkIHRvIG1ha2UgYW4gZW5lcmd5IGNodW5rIHdhbmRlciwgaS5lLiB0byBwZXJmb3JtIHNvbWV3aGF0IG9mIGEgcmFuZG9tIHdhbGsgd2hpbGUgbW92aW5nIHRvd2FyZHMgYVxyXG4gKiBkZXN0aW5hdGlvbi5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IGRvdFJhbmRvbSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvZG90UmFuZG9tLmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFZlY3RvcjJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMlByb3BlcnR5LmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QgZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1BoZXRpb09iamVjdC5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBCb29sZWFuSU8gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0Jvb2xlYW5JTy5qcyc7XHJcbmltcG9ydCBJT1R5cGUgZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0lPVHlwZS5qcyc7XHJcbmltcG9ydCBOdWxsYWJsZUlPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdWxsYWJsZUlPLmpzJztcclxuaW1wb3J0IE51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdW1iZXJJTy5qcyc7XHJcbmltcG9ydCBSZWZlcmVuY2VJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvUmVmZXJlbmNlSU8uanMnO1xyXG5pbXBvcnQgZW5lcmd5Rm9ybXNBbmRDaGFuZ2VzIGZyb20gJy4uLy4uL2VuZXJneUZvcm1zQW5kQ2hhbmdlcy5qcyc7XHJcbmltcG9ydCBFbmVyZ3lDaHVuayBmcm9tICcuL0VuZXJneUNodW5rLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBERUZBVUxUX01JTl9TUEVFRCA9IDAuMDY7IC8vIEluIG0vcy5cclxuY29uc3QgREVGQVVMVF9NQVhfU1BFRUQgPSAwLjEwOyAvLyBJbiBtL3MuXHJcbmNvbnN0IE1JTl9USU1FX0lOX09ORV9ESVJFQ1RJT04gPSAwLjQ7XHJcbmNvbnN0IE1BWF9USU1FX0lOX09ORV9ESVJFQ1RJT04gPSAwLjg7XHJcbmNvbnN0IERJU1RBTkNFX0FUX1dISUNIX1RPX1NUT1BfV0FOREVSSU5HID0gMC4wNTsgLy8gaW4gbWV0ZXJzLCBlbXBpcmljYWxseSBjaG9zZW5cclxuY29uc3QgREVGQVVMVF9BTkdMRV9WQVJJQVRJT04gPSBNYXRoLlBJICogMC4yOyAvLyBkZXZpYXRpb24gZnJvbSBhbmdsZSB0byBkZXN0aW5hdGlvbiwgaW4gcmFkaWFucywgZW1waXJpY2FsbHkgY2hvc2VuLlxyXG5jb25zdCBHT19TVFJBSUdIVF9IT01FX0RJU1RBTkNFID0gMC4yOyAvLyBpbiBtZXRlcnMsIGRpc3RhbmNlIGF0IHdoaWNoLCBpZiBkZXN0aW5hdGlvbiBjaGFuZ2VzLCBzcGVlZCBpbmNyZWFzZXNcclxuXHJcbmNsYXNzIEVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlciBleHRlbmRzIFBoZXRpb09iamVjdCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7RW5lcmd5Q2h1bmt9IGVuZXJneUNodW5rXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48VmVjdG9yMj59IGRlc3RpbmF0aW9uUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGVuZXJneUNodW5rLCBkZXN0aW5hdGlvblByb3BlcnR5LCBvcHRpb25zICkge1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG5cclxuICAgICAgLy8ge1JhbmdlfG51bGx9IC0gYm91bmRpbmcgcmFuZ2UgaW4gdGhlIFggZGlyZWN0aW9uIHdpdGhpbiB3aGljaCB0aGUgZW5lcmd5IGNodW5rJ3MgbW90aW9uIHNob3VsZCBiZSBjb25zdHJhaW5lZC5cclxuICAgICAgLy8gTm90IGFsbCBlbmVyZ3kgY2h1bmtzIG5lZWQgdGhpcyBjb25zdHJhaW50LCBzbyBudWxsIGlzIGFuIGFjY2VwdGFibGUgdmFsdWVcclxuICAgICAgaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQ6IG51bGwsXHJcblxyXG4gICAgICAvLyB7bnVtYmVyfSAtIHJhbmdlIG9mIGFuZ2xlIHZhcmlhdGlvbnMsIGhpZ2hlciBtZWFucyBtb3JlIHdhbmRlcmluZywgaW4gcmFkaWFucyBmcm9tIE1hdGguUEkgdG8gemVyb1xyXG4gICAgICB3YW5kZXJBbmdsZVZhcmlhdGlvbjogREVGQVVMVF9BTkdMRV9WQVJJQVRJT04sXHJcblxyXG4gICAgICAvLyB7Ym9vbGVhbn0gLSBUcmFuc2xhdGUgdGhlIEVDIHBvc2l0aW9uIGFuZCB3YW5kZXIgY29uc3RyYWludHMgaG9yaXpvbnRhbGx5IGlmIHRoZSBkZXN0aW5hdGlvbiBjaGFuZ2VzLiAgVGhpc1xyXG4gICAgICAvLyB3YXMgZm91bmQgdG8gYmUgdXNlZnVsIHRvIGhlbHAgcHJldmVudCBcImNoYXNlIHNjZW5lc1wiIHdoZW4gYW4gZW5lcmd5IHdhcyBoZWFkaW5nIHRvd2FyZHMgYW4gb2JqZWN0IGFuZCB0aGVcclxuICAgICAgLy8gdXNlciBzdGFydGVkIGRyYWdnaW5nIHRoYXQgb2JqZWN0LlxyXG4gICAgICB0cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uOiB0cnVlLFxyXG5cclxuICAgICAgLy8gcGhldC1pb1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5SRVFVSVJFRCxcclxuICAgICAgcGhldGlvVHlwZTogRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyLkVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlcklPLFxyXG4gICAgICBwaGV0aW9EeW5hbWljRWxlbWVudDogdHJ1ZVxyXG4gICAgfSwgb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIHBhcmFtZXRlciBjaGVja2luZ1xyXG4gICAgYXNzZXJ0ICYmIG9wdGlvbnMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQgJiYgYXNzZXJ0KFxyXG4gICAgICBvcHRpb25zLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50LmNvbnRhaW5zKCBlbmVyZ3lDaHVuay5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggKSxcclxuICAgICAgJ2VuZXJneSBjaHVuayBzdGFydGluZyBwb3NpdGlvbiBpcyBub3Qgd2l0aGluIHRoZSB3YW5kZXIgY29uc3RyYWludCdcclxuICAgICk7XHJcbiAgICBhc3NlcnQgJiYgb3B0aW9ucy5ob3Jpem9udGFsV2FuZGVyQ29uc3RyYWludCAmJiBhc3NlcnQoXHJcbiAgICAgIG9wdGlvbnMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQuY29udGFpbnMoIGRlc3RpbmF0aW9uUHJvcGVydHkudmFsdWUueCApLFxyXG4gICAgICAnZW5lcmd5IGNodW5rIGRlc3RpbmF0aW9uIGlzIG5vdCB3aXRoaW4gdGhlIHdhbmRlciBjb25zdHJhaW50J1xyXG4gICAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoXHJcbiAgICBvcHRpb25zLndhbmRlckFuZ2xlVmFyaWF0aW9uIDw9IE1hdGguUEkgJiYgb3B0aW9ucy53YW5kZXJBbmdsZVZhcmlhdGlvbiA+PSAwLFxyXG4gICAgICAnd2FuZGVyIGFuZ2xlIG11c3QgYmUgZnJvbSB6ZXJvIHRvIFBJIChpbmNsdXNpdmUpJ1xyXG4gICAgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIGFzc2VydCAmJiBUYW5kZW0uVkFMSURBVElPTiAmJiB0aGlzLmlzUGhldGlvSW5zdHJ1bWVudGVkKCkgJiYgYXNzZXJ0KCBlbmVyZ3lDaHVuay5pc1BoZXRpb0luc3RydW1lbnRlZCgpICk7XHJcblxyXG4gICAgLy8gSW5zdGVhZCBvZiBhc3NlcnRpbmcgdGhhdCB0aGUgZGVzdGluYXRpb25Qcm9wZXJ0eSBpcyBpbnN0cnVtZW50ZWQsIGFzc2VydCB0aGF0IGl0IG11c3QgYmUgaW5zdHJ1bWVudGVkIGlmIGl0XHJcbiAgICAvLyBjaGFuZ2VzLiBUaGlzIHdhcyB0aGUgc2ltcGxlc3Qgc29sdXRpb24gemVwdW1waCBhbmQgc2FtcmVpZCBjYW1lIHVwIHdpdGggZm9yIGRlYWxpbmcgd2l0aCBzdXBwb3J0aW5nIFBoRVQtaU9cclxuICAgIC8vIHN0YXRlIHdoZW4gdGhlcmUgYXJlIHVzYWdlcyB0aGF0IGp1c3Qgd3JhcCBhIHNpbmdsZSB2YWx1ZSBpbiBhIFByb3BlcnR5IGFuZCBuZXZlciBjaGFuZ2UgaXQuXHJcbiAgICBhc3NlcnQgJiYgVGFuZGVtLlZBTElEQVRJT04gJiYgZGVzdGluYXRpb25Qcm9wZXJ0eS5sYXp5TGluayggKCkgPT4ge1xyXG4gICAgICBhc3NlcnQoIHRoaXMuZGVzdGluYXRpb25Qcm9wZXJ0eS5pc1BoZXRpb0luc3RydW1lbnRlZCgpLFxyXG4gICAgICAgICdJZiB0aGUgZGVzdGluYXRpb25Qcm9wZXJ0eSBldmVyIGNoYW5nZXMsIHRoZW4gaXQgbXVzdCBiZSBpbnN0cnVtZW50ZWQgdG8gc3VwcG9ydCBQaEVULWlPIHN0YXRlLicgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtFbmVyZ3lDaHVuaylcclxuICAgIHRoaXMuZW5lcmd5Q2h1bmsgPSBlbmVyZ3lDaHVuaztcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5taW5TcGVlZCA9IERFRkFVTFRfTUlOX1NQRUVEO1xyXG4gICAgdGhpcy5tYXhTcGVlZCA9IERFRkFVTFRfTUFYX1NQRUVEO1xyXG4gICAgdGhpcy5ob3Jpem9udGFsV2FuZGVyQ29uc3RyYWludCA9IG9wdGlvbnMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQ7XHJcbiAgICB0aGlzLndhbmRlckFuZ2xlVmFyaWF0aW9uID0gb3B0aW9ucy53YW5kZXJBbmdsZVZhcmlhdGlvbjtcclxuICAgIHRoaXMuZGVzdGluYXRpb25Qcm9wZXJ0eSA9IGRlc3RpbmF0aW9uUHJvcGVydHk7XHJcbiAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFZlY3RvcjIoIDAsIERFRkFVTFRfTUFYX1NQRUVEICk7XHJcbiAgICB0aGlzLndhbmRlcmluZyA9IHRydWU7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBTdG9yZSB0aGlzIG9uIHRoZSBpbnN0YW5jZSBzbyB0aGF0IGl0IGNhbiBiZSBzZXQgYnkgUGhFVC1pTyBzdGF0ZVxyXG4gICAgdGhpcy50cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uID0gb3B0aW9ucy50cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gY291bnRkb3duIHRvIHdoZW4gdGhlIEVuZXJneUNodW5rIHdpbGwgY2hhbmdlIGRpcmVjdGlvblxyXG4gICAgdGhpcy5jb3VudGRvd25UaW1lciA9IDA7XHJcbiAgICB0aGlzLnJlc2V0Q291bnRkb3duVGltZXIoKTtcclxuICAgIHRoaXMuY2hhbmdlVmVsb2NpdHlWZWN0b3IoKTtcclxuXHJcbiAgICAvLyBpZiBhbiBlbmVyZ3kgY2h1bmsncyBkZXN0aW5hdGlvbiBtb3ZlcywgcXVpY2tseSBzZW5kIHRoZSBjaHVuayB0byBpdHMgZGVzdGluYXRpb24gLSB0aGlzIGlzIHVzZWQgYXMgYSBmbGFnIHRvXHJcbiAgICAvLyBtYWtlIHN1cmUgb25seSBvbmUgc3BlZWQgaW5jcmVhc2UgaGFwcGVuc1xyXG4gICAgbGV0IHNwZWVkSW5jcmVhc2VkID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3QgaGFuZGxlRGVzdGluYXRpb25DaGFuZ2VkID0gKCBuZXdEZXN0aW5hdGlvbiwgb2xkRGVzdGluYXRpb24gKSA9PiB7XHJcblxyXG4gICAgICAvLyBTaG9ydCBjaXJjdWl0IHRoaXMgaWYgc3RhdGUgaXMgYmVpbmcgc2V0IC0gb3RoZXJ3aXNlIGFwcHJvYWNoaW5nIGVuZXJneSBjaHVua3MgdGhhdCBhcmUgcGFydCBvZiB0aGUgc3RhdGUgY2FuXHJcbiAgICAgIC8vIGdldCBtb3ZlZCBhcm91bmQsIG1lc3NpbmcgdXAgdGhlaXIgc3RhdGUuXHJcbiAgICAgIGlmICggcGhldC5qb2lzdC5zaW0uaXNTZXR0aW5nUGhldGlvU3RhdGVQcm9wZXJ0eS52YWx1ZSApIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGRpc3RhbmNlVG9EZXN0aW5hdGlvbiA9IG5ld0Rlc3RpbmF0aW9uLmRpc3RhbmNlKCB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuXHJcbiAgICAgIC8vIGlmIHRoZSBkZXN0aW5hdGlvbiBjaGFuZ2VzLCBzcGVlZCB1cCBhbmQgZ28gZGlyZWN0bHkgdG8gdGhlIGRlc3RpbmF0aW9uXHJcbiAgICAgIGlmICggZGlzdGFuY2VUb0Rlc3RpbmF0aW9uIDw9IEdPX1NUUkFJR0hUX0hPTUVfRElTVEFOQ0UgJiYgIXNwZWVkSW5jcmVhc2VkICkge1xyXG4gICAgICAgIGNvbnN0IGluY3JlYXNlRmFjdG9yID0gODsgLy8gZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCB0byBiZSBmYXN0IGJ1dCBzdGlsbCB2aXNpYmxlXHJcbiAgICAgICAgdGhpcy5taW5TcGVlZCA9IERFRkFVTFRfTUlOX1NQRUVEICogaW5jcmVhc2VGYWN0b3I7XHJcbiAgICAgICAgdGhpcy5tYXhTcGVlZCA9IERFRkFVTFRfTUFYX1NQRUVEICogaW5jcmVhc2VGYWN0b3I7XHJcbiAgICAgICAgc3BlZWRJbmNyZWFzZWQgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMud2FuZGVyaW5nID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5jaGFuZ2VWZWxvY2l0eVZlY3RvcigpO1xyXG5cclxuICAgICAgaWYgKCB0aGlzLnRyYW5zbGF0ZVhXaXRoRGVzdGluYXRpb24gKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uID0gbmV3RGVzdGluYXRpb24ubWludXMoIG9sZERlc3RpbmF0aW9uICk7XHJcblxyXG4gICAgICAgIC8vIGFkanVzdCB0aGUgY3VycmVudCBFQyBwb3NpdGlvblxyXG4gICAgICAgIHRoaXMuZW5lcmd5Q2h1bmsucG9zaXRpb25Qcm9wZXJ0eS5zZXQoXHJcbiAgICAgICAgICB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkudmFsdWUucGx1c1hZKCB0cmFuc2xhdGlvbi54LCAwIClcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBhZGp1c3QgdGhlIHdhbmRlciBjb25zdHJhaW50cyBpZiBwcmVzZW50XHJcbiAgICAgICAgaWYgKCB0aGlzLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50ICkge1xyXG4gICAgICAgICAgdGhpcy5zZXRIb3Jpem9udGFsV2FuZGVyQ29uc3RyYWludCggbmV3IFJhbmdlKFxyXG4gICAgICAgICAgICB0aGlzLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50Lm1pbiArIHRyYW5zbGF0aW9uLngsXHJcbiAgICAgICAgICAgIHRoaXMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQubWF4ICsgdHJhbnNsYXRpb24ueFxyXG4gICAgICAgICAgKSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLmRlc3RpbmF0aW9uUHJvcGVydHkubGF6eUxpbmsoIGhhbmRsZURlc3RpbmF0aW9uQ2hhbmdlZCApO1xyXG5cclxuICAgIHRoaXMuZGlzcG9zZUVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlciA9ICgpID0+IHtcclxuICAgICAgdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5LnVubGluayggaGFuZGxlRGVzdGluYXRpb25DaGFuZ2VkICk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpYyAoRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVySU8pXHJcbiAgdG9TdGF0ZU9iamVjdCgpIHtcclxuXHJcbiAgICBjb25zdCBzdGF0ZU9iamVjdCA9IHtcclxuICAgICAgbWluU3BlZWQ6IHRoaXMubWluU3BlZWQsXHJcbiAgICAgIG1heFNwZWVkOiB0aGlzLm1heFNwZWVkLFxyXG4gICAgICB3YW5kZXJBbmdsZVZhcmlhdGlvbjogdGhpcy53YW5kZXJBbmdsZVZhcmlhdGlvbixcclxuICAgICAgdHJhbnNsYXRlWFdpdGhEZXN0aW5hdGlvbjogdGhpcy50cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uLFxyXG4gICAgICBjb3VudGRvd25UaW1lcjogdGhpcy5jb3VudGRvd25UaW1lcixcclxuICAgICAgd2FuZGVyaW5nOiB0aGlzLndhbmRlcmluZyxcclxuICAgICAgaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQ6IE51bGxhYmxlSU8oIFJhbmdlLlJhbmdlSU8gKS50b1N0YXRlT2JqZWN0KCB0aGlzLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50ICksXHJcbiAgICAgIGVuZXJneUNodW5rUmVmZXJlbmNlOiBSZWZlcmVuY2VJTyggRW5lcmd5Q2h1bmsuRW5lcmd5Q2h1bmtJTyApLnRvU3RhdGVPYmplY3QoIHRoaXMuZW5lcmd5Q2h1bmsgKVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBOT1RFOiBkZXN0aW5hdGlvblByb3BlcnR5IGRvZXMgbm90IG5lZWQgdG8gYmUgaW5zdHJ1bWVudGVkIHRvIHN1cHBvcnQgdGhpcywgYXMgc29tZSBQcm9wZXJ0aWVzIGp1c3Qgd3JhcCBzaW5nbGVcclxuICAgIC8vIHZhbHVlcyB0aGF0IGRvbid0IGNoYW5nZS5cclxuICAgIGlmICggdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5LmlzUGhldGlvSW5zdHJ1bWVudGVkKCkgKSB7XHJcbiAgICAgIHN0YXRlT2JqZWN0LmRlc3RpbmF0aW9uUHJvcGVydHlSZWZlcmVuY2UgPSBSZWZlcmVuY2VJTyggUHJvcGVydHkuUHJvcGVydHlJTyggVmVjdG9yMi5WZWN0b3IySU8gKSApLnRvU3RhdGVPYmplY3QoIHRoaXMuZGVzdGluYXRpb25Qcm9wZXJ0eSApO1xyXG4gICAgICBzdGF0ZU9iamVjdC5kZXN0aW5hdGlvblZlY3RvcjIgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHN0YXRlT2JqZWN0LmRlc3RpbmF0aW9uUHJvcGVydHlSZWZlcmVuY2UgPSBudWxsO1xyXG4gICAgICBzdGF0ZU9iamVjdC5kZXN0aW5hdGlvblZlY3RvcjIgPSBWZWN0b3IyLlZlY3RvcjJJTy50b1N0YXRlT2JqZWN0KCB0aGlzLmRlc3RpbmF0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBzdGF0ZU9iamVjdDtcclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWMgKEVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlcklPKVxyXG4gIHN0YXRpYyBzdGF0ZU9iamVjdFRvQ3JlYXRlRWxlbWVudEFyZ3VtZW50cyggc3RhdGVPYmplY3QgKSB7XHJcbiAgICBjb25zdCBlbmVyZ3lDaHVuayA9IFJlZmVyZW5jZUlPKCBFbmVyZ3lDaHVuay5FbmVyZ3lDaHVua0lPICkuZnJvbVN0YXRlT2JqZWN0KCBzdGF0ZU9iamVjdC5lbmVyZ3lDaHVua1JlZmVyZW5jZSApO1xyXG5cclxuICAgIGxldCBkZXN0aW5hdGlvblByb3BlcnR5ID0gbnVsbDtcclxuICAgIGlmICggc3RhdGVPYmplY3QuZGVzdGluYXRpb25Qcm9wZXJ0eVJlZmVyZW5jZSApIHtcclxuXHJcbiAgICAgIGRlc3RpbmF0aW9uUHJvcGVydHkgPSBSZWZlcmVuY2VJTyggUHJvcGVydHkuUHJvcGVydHlJTyggVmVjdG9yMi5WZWN0b3IySU8gKSApLmZyb21TdGF0ZU9iamVjdCggc3RhdGVPYmplY3QuZGVzdGluYXRpb25Qcm9wZXJ0eVJlZmVyZW5jZSApO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIHN0YXRlT2JqZWN0LmRlc3RpbmF0aW9uVmVjdG9yMiApIHtcclxuICAgICAgZGVzdGluYXRpb25Qcm9wZXJ0eSA9IG5ldyBWZWN0b3IyUHJvcGVydHkoIFZlY3RvcjIuVmVjdG9yMklPLmZyb21TdGF0ZU9iamVjdCggc3RhdGVPYmplY3QuZGVzdGluYXRpb25WZWN0b3IyICkgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBbIGVuZXJneUNodW5rLCBkZXN0aW5hdGlvblByb3BlcnR5LCB7fSBdO1xyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpYyAoRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVySU8pXHJcbiAgYXBwbHlTdGF0ZSggc3RhdGVPYmplY3QgKSB7XHJcbiAgICB0aGlzLm1pblNwZWVkID0gc3RhdGVPYmplY3QubWluU3BlZWQ7XHJcbiAgICB0aGlzLm1heFNwZWVkID0gc3RhdGVPYmplY3QubWF4U3BlZWQ7XHJcbiAgICB0aGlzLndhbmRlckFuZ2xlVmFyaWF0aW9uID0gc3RhdGVPYmplY3Qud2FuZGVyQW5nbGVWYXJpYXRpb247XHJcbiAgICB0aGlzLnRyYW5zbGF0ZVhXaXRoRGVzdGluYXRpb24gPSBzdGF0ZU9iamVjdC50cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uO1xyXG4gICAgdGhpcy5jb3VudGRvd25UaW1lciA9IHN0YXRlT2JqZWN0LmNvdW50ZG93blRpbWVyO1xyXG4gICAgdGhpcy53YW5kZXJpbmcgPSBzdGF0ZU9iamVjdC53YW5kZXJpbmc7XHJcbiAgICB0aGlzLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50ID0gTnVsbGFibGVJTyggUmFuZ2UuUmFuZ2VJTyApLmZyb21TdGF0ZU9iamVjdCggc3RhdGVPYmplY3QuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQgKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBkaXNwb3NlIGZ1bmN0aW9uXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2VFbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXIoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgdGhpcyBlbmVyZ3kgY2h1bmsgZm9yIGEgZ2l2ZW4gY2hhbmdlIGluIHRpbWUuXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHVwZGF0ZVBvc2l0aW9uKCBkdCApIHtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50UG9zaXRpb24gPSB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkuZ2V0KCk7XHJcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IHRoaXMuZGVzdGluYXRpb25Qcm9wZXJ0eS5nZXQoKTtcclxuICAgIGNvbnN0IGRpc3RhbmNlVG9EZXN0aW5hdGlvbiA9IGN1cnJlbnRQb3NpdGlvbi5kaXN0YW5jZSggZGVzdGluYXRpb24gKTtcclxuICAgIGNvbnN0IHNwZWVkID0gdGhpcy52ZWxvY2l0eS5tYWduaXR1ZGU7XHJcblxyXG4gICAgLy8gb25seSBkbyBzb21ldGhpbmcgaWYgdGhlIGVuZXJneSBjaHVuayBoYXMgbm90IHlldCByZWFjaGVkIGl0cyBkZXN0aW5hdGlvblxyXG4gICAgaWYgKCBzcGVlZCA+IDAgfHwgIWN1cnJlbnRQb3NpdGlvbi5lcXVhbHMoIGRlc3RpbmF0aW9uICkgKSB7XHJcblxyXG4gICAgICAvLyBjaGVjayBpZiBkZXN0aW5hdGlvbiByZWFjaGVkXHJcbiAgICAgIGlmICggZGlzdGFuY2VUb0Rlc3RpbmF0aW9uIDw9IHRoaXMudmVsb2NpdHkubWFnbml0dWRlICogZHQgKSB7XHJcbiAgICAgICAgdGhpcy5lbmVyZ3lDaHVuay5wb3NpdGlvblByb3BlcnR5LnNldCggZGVzdGluYXRpb24gKTtcclxuICAgICAgICB0aGlzLnZlbG9jaXR5LnNldE1hZ25pdHVkZSggMCApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICBpZiAoIHRoaXMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQgKSB7XHJcblxyXG4gICAgICAgICAgLy8gc3RheSB3aXRoaW4gdGhlIGNvbmZpbmVzIG9mIHRoZSBob3Jpem9udGFsIHdhbmRlciBjb25zdHJhaW50XHJcbiAgICAgICAgICBjb25zdCBwcm9wb3NlZFggPSB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueCArIGR0ICogdGhpcy52ZWxvY2l0eS54O1xyXG4gICAgICAgICAgaWYgKCBwcm9wb3NlZFggPCB0aGlzLmhvcml6b250YWxXYW5kZXJDb25zdHJhaW50Lm1pbiAmJiB0aGlzLnZlbG9jaXR5LnggPCAwIHx8XHJcbiAgICAgICAgICAgICAgIHByb3Bvc2VkWCA+IHRoaXMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQubWF4ICYmIHRoaXMudmVsb2NpdHkueCA+IDAgKSB7XHJcblxyXG4gICAgICAgICAgICAvLyBib3VuY2UgaW4gdGhlIHggZGlyZWN0aW9uXHJcbiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkuc2V0WCggLXRoaXMudmVsb2NpdHkueCApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdXBkYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgZW5lcmd5IGNodW5rIGJhc2VkIG9uIGl0cyB2ZWxvY2l0eVxyXG4gICAgICAgIHRoaXMuZW5lcmd5Q2h1bmsucG9zaXRpb25Qcm9wZXJ0eS5zZXQoIG5ldyBWZWN0b3IyKFxyXG4gICAgICAgICAgY3VycmVudFBvc2l0aW9uLnggKyBkdCAqIHRoaXMudmVsb2NpdHkueCxcclxuICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbi55ICsgZHQgKiB0aGlzLnZlbG9jaXR5LnlcclxuICAgICAgICApICk7XHJcblxyXG4gICAgICAgIC8vIGRldGVybWluZSB3aGV0aGVyIGFueSB1cGRhdGVzIHRvIHRoZSBtb3Rpb24gYXJlIG5lZWRlZCBhbmQgbWFrZSB0aGVtIGlmIHNvXHJcbiAgICAgICAgdGhpcy5jb3VudGRvd25UaW1lciAtPSBkdDtcclxuICAgICAgICBpZiAoIHRoaXMuY291bnRkb3duVGltZXIgPD0gMCB8fCBkaXN0YW5jZVRvRGVzdGluYXRpb24gPCBESVNUQU5DRV9BVF9XSElDSF9UT19TVE9QX1dBTkRFUklORyApIHtcclxuICAgICAgICAgIHRoaXMuY2hhbmdlVmVsb2NpdHlWZWN0b3IoKTtcclxuICAgICAgICAgIHRoaXMucmVzZXRDb3VudGRvd25UaW1lcigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogcmFuZG9tbHkgY2hhbmdlIHRoZSB2ZWxvY2l0eSB2ZWN0b3Igb2YgdGhlIGVuZXJneSBjaHVua1xyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgY2hhbmdlVmVsb2NpdHlWZWN0b3IoKSB7XHJcbiAgICBjb25zdCB2ZWN0b3JUb0Rlc3RpbmF0aW9uID0gdGhpcy5kZXN0aW5hdGlvblByb3BlcnR5LnZhbHVlLm1pbnVzKCB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuICAgIGxldCBhbmdsZSA9IHZlY3RvclRvRGVzdGluYXRpb24uYW5nbGU7XHJcbiAgICBpZiAoIHZlY3RvclRvRGVzdGluYXRpb24ubWFnbml0dWRlID4gRElTVEFOQ0VfQVRfV0hJQ0hfVE9fU1RPUF9XQU5ERVJJTkcgJiYgdGhpcy53YW5kZXJpbmcgKSB7XHJcblxyXG4gICAgICAvLyBhZGQgc29tZSByYW5kb21uZXNzIHRvIHRoZSBkaXJlY3Rpb24gb2YgdHJhdmVsXHJcbiAgICAgIGFuZ2xlID0gYW5nbGUgKyAoICggZG90UmFuZG9tLm5leHREb3VibGUoKSAtIDAuNSApICogMiApICogdGhpcy53YW5kZXJBbmdsZVZhcmlhdGlvbjtcclxuICAgIH1cclxuICAgIGNvbnN0IHNwZWVkID0gdGhpcy5taW5TcGVlZCArICggdGhpcy5tYXhTcGVlZCAtIHRoaXMubWluU3BlZWQgKSAqIGRvdFJhbmRvbS5uZXh0RG91YmxlKCk7XHJcbiAgICB0aGlzLnZlbG9jaXR5LnNldFhZKCBzcGVlZCAqIE1hdGguY29zKCBhbmdsZSApLCBzcGVlZCAqIE1hdGguc2luKCBhbmdsZSApICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiByZXNldCB0aGUgY291bnRkb3duIHRpbWVyIHRoYXQgaXMgdXNlZCB0byBkZWNpZGUgd2hlbiB0byBjaGFuZ2UgZGlyZWN0aW9uXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICByZXNldENvdW50ZG93blRpbWVyKCkge1xyXG4gICAgdGhpcy5jb3VudGRvd25UaW1lciA9IE1JTl9USU1FX0lOX09ORV9ESVJFQ1RJT04gKyAoIE1BWF9USU1FX0lOX09ORV9ESVJFQ1RJT04gLSBNSU5fVElNRV9JTl9PTkVfRElSRUNUSU9OICkgKlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGRvdFJhbmRvbS5uZXh0RG91YmxlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiByZXR1cm5zIHRydWUgaWYgdGhlIGVuZXJneSBjaHVuayBoYXMgcmVhY2hlZCBpdHMgZGVzdGluYXRpb24sIGZhbHNlIGlmIG5vdFxyXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBpc0Rlc3RpbmF0aW9uUmVhY2hlZCgpIHtcclxuICAgIHJldHVybiB0aGlzLmVuZXJneUNodW5rLnBvc2l0aW9uUHJvcGVydHkudmFsdWUuZXF1YWxzKCB0aGlzLmRlc3RpbmF0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHNldCBhIG5ldyBjb25zdHJhaW50IG9uIHRoZSB3YW5kZXJpbmdcclxuICAgKiBAcGFyYW0ge1JhbmdlfG51bGx9IGhvcml6b250YWxXYW5kZXJDb25zdHJhaW50XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHNldEhvcml6b250YWxXYW5kZXJDb25zdHJhaW50KCBob3Jpem9udGFsV2FuZGVyQ29uc3RyYWludCApIHtcclxuICAgIHRoaXMuaG9yaXpvbnRhbFdhbmRlckNvbnN0cmFpbnQgPSBob3Jpem9udGFsV2FuZGVyQ29uc3RyYWludDtcclxuICB9XHJcbn1cclxuXHJcbkVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlci5FbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXJJTyA9IG5ldyBJT1R5cGUoICdFbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXJJTycsIHtcclxuICB2YWx1ZVR5cGU6IEVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlcixcclxuICB0b1N0YXRlT2JqZWN0OiBlbmVyZ3lDaHVua1dhbmRlckNvbnRyb2xsZXIgPT4gZW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyLnRvU3RhdGVPYmplY3QoKSxcclxuICBzdGF0ZU9iamVjdFRvQ3JlYXRlRWxlbWVudEFyZ3VtZW50czogRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyLnN0YXRlT2JqZWN0VG9DcmVhdGVFbGVtZW50QXJndW1lbnRzLFxyXG4gIGFwcGx5U3RhdGU6ICggZW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyLCBzdGF0ZU9iamVjdCApID0+IGVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlci5hcHBseVN0YXRlKCBzdGF0ZU9iamVjdCApLFxyXG4gIHN0YXRlU2NoZW1hOiB7XHJcbiAgICBtaW5TcGVlZDogTnVtYmVySU8sXHJcbiAgICBtYXhTcGVlZDogTnVtYmVySU8sXHJcbiAgICB3YW5kZXJBbmdsZVZhcmlhdGlvbjogTnVtYmVySU8sXHJcbiAgICB0cmFuc2xhdGVYV2l0aERlc3RpbmF0aW9uOiBCb29sZWFuSU8sXHJcbiAgICBjb3VudGRvd25UaW1lcjogTnVtYmVySU8sXHJcbiAgICB3YW5kZXJpbmc6IEJvb2xlYW5JTyxcclxuICAgIGhvcml6b250YWxXYW5kZXJDb25zdHJhaW50OiBOdWxsYWJsZUlPKCBSYW5nZS5SYW5nZUlPICksXHJcbiAgICBlbmVyZ3lDaHVua1JlZmVyZW5jZTogUmVmZXJlbmNlSU8oIEVuZXJneUNodW5rLkVuZXJneUNodW5rSU8gKSxcclxuICAgIGRlc3RpbmF0aW9uUHJvcGVydHlSZWZlcmVuY2U6IE51bGxhYmxlSU8oIFJlZmVyZW5jZUlPKCBQcm9wZXJ0eS5Qcm9wZXJ0eUlPKCBWZWN0b3IyLlZlY3RvcjJJTyApICkgKSxcclxuICAgIGRlc3RpbmF0aW9uVmVjdG9yMjogTnVsbGFibGVJTyggVmVjdG9yMi5WZWN0b3IySU8gKVxyXG4gIH1cclxufSApO1xyXG5cclxuZW5lcmd5Rm9ybXNBbmRDaGFuZ2VzLnJlZ2lzdGVyKCAnRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyJywgRW5lcmd5Q2h1bmtXYW5kZXJDb250cm9sbGVyICk7XHJcbmV4cG9ydCBkZWZhdWx0IEVuZXJneUNodW5rV2FuZGVyQ29udHJvbGxlcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUFDdkQsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLGVBQWUsTUFBTSx1Q0FBdUM7QUFDbkUsT0FBT0MsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxZQUFZLE1BQU0sdUNBQXVDO0FBQ2hFLE9BQU9DLE1BQU0sTUFBTSxpQ0FBaUM7QUFDcEQsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQztBQUNoRSxPQUFPQyxNQUFNLE1BQU0sdUNBQXVDO0FBQzFELE9BQU9DLFVBQVUsTUFBTSwyQ0FBMkM7QUFDbEUsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUM5RCxP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