// Copyright 2018-2021, University of Colorado Boulder

/**
 * A node for the column of steam that rises out of a beaker when the temperature of the contained liquid is high enough.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 * @author John Blanco (PhET Interactive Simulations)
 */

import dotRandom from '../../../../dot/js/dotRandom.js';
import Range from '../../../../dot/js/Range.js';
import Utils from '../../../../dot/js/Utils.js';
import { CanvasNode } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import energyFormsAndChanges from '../../energyFormsAndChanges.js';
import EFACConstants from '../EFACConstants.js';

// constants
const STEAMING_RANGE = 10; // number of degrees Kelvin over which steam is visible
const STEAM_BUBBLE_SPEED_RANGE = new Range(100, 125); // in screen coords (~ pixels) / second
const STEAM_BUBBLE_DIAMETER_RANGE = new Range(20, 50); // in screen coords (~ pixels)
const MAX_STEAM_BUBBLE_HEIGHT = 300;
const STEAM_BUBBLE_RATE_RANGE = new Range(20, 40); // bubbles per second
const STEAM_BUBBLE_GROWTH_RATE = 0.2; // proportion per second
const MAX_STEAM_BUBBLE_OPACITY = 0.7; // proportion, 0 to 1

class BeakerSteamCanvasNode extends CanvasNode {
  /**
   * @param {Rectangle} containerOutlineRect - the outline of the container
   * @param {Property.<number>} fluidProportionProperty - the proportion of fluid in its container
   * @param {Property.<number>} temperatureProperty - the temperature of the liquid
   * @param {number} fluidBoilingPoint
   * @param {Color} steamColor
   * @param {Object} [options]
   */
  constructor(containerOutlineRect, fluidProportionProperty, temperatureProperty, fluidBoilingPoint, steamColor, options) {
    super(options);

    // @private
    this.containerOutlineRect = containerOutlineRect;
    this.fluidProportionProperty = fluidProportionProperty;
    this.temperatureProperty = temperatureProperty;
    this.fluidBoilingPoint = fluidBoilingPoint;
    this.steamColor = steamColor;
    this.preloadComplete = true;

    // @private
    this.bubbleProductionRemainder = 0;
    this.steamOrigin = 0;
    this.steamBubbles = [];

    // @private
    // canvas where the steam bubble image resides
    this.steamBubbleImageCanvas = document.createElement('canvas');
    this.steamBubbleImageCanvas.width = STEAM_BUBBLE_DIAMETER_RANGE.max;
    this.steamBubbleImageCanvas.height = STEAM_BUBBLE_DIAMETER_RANGE.max;
    const context = this.steamBubbleImageCanvas.getContext('2d');

    // draw a steam bubble centered in the steam bubble image canvas
    context.fillStyle = this.steamColor.toCSS();
    context.beginPath();
    context.arc(STEAM_BUBBLE_DIAMETER_RANGE.max / 2, STEAM_BUBBLE_DIAMETER_RANGE.max / 2, STEAM_BUBBLE_DIAMETER_RANGE.max / 2, 0, Math.PI * 2, true);
    context.fill();

    // update the appearance of the water as the level changes
    this.fluidProportionProperty.link(fluidProportion => {
      this.steamOrigin = this.containerOutlineRect.minY * fluidProportion;
    });
    this.mutate(options);

    // Preload steam animation after state has been set
    Tandem.PHET_IO_ENABLED && phet.phetio.phetioEngine.phetioStateEngine.stateSetEmitter.addListener(() => {
      this.preloadSteam();
    });
  }

  /**
   * Updates the number of steam bubbles and the position, size, and opacity of each one.
   * @param {number} dt
   * @public
   */
  step(dt) {
    let steamingProportion = 0;

    // add any new steam bubbles
    if (this.fluidBoilingPoint - this.temperatureProperty.value < STEAMING_RANGE) {
      // the water is emitting some amount of steam - set the proportionate amount
      steamingProportion = 1 - (this.fluidBoilingPoint - this.temperatureProperty.value) / STEAMING_RANGE;
      steamingProportion = Utils.clamp(steamingProportion, 0, 1);
      const bubblesToProduceCalc = (STEAM_BUBBLE_RATE_RANGE.min + STEAM_BUBBLE_RATE_RANGE.getLength() * steamingProportion) * dt;
      let bubblesToProduce = Math.floor(bubblesToProduceCalc);
      this.bubbleProductionRemainder += bubblesToProduceCalc - bubblesToProduce;
      if (this.bubbleProductionRemainder >= 1) {
        bubblesToProduce += Math.floor(this.bubbleProductionRemainder);
        this.bubbleProductionRemainder -= Math.floor(this.bubbleProductionRemainder);
      }
      for (let i = 0; i < bubblesToProduce; i++) {
        const steamBubbleDiameter = STEAM_BUBBLE_DIAMETER_RANGE.min + dotRandom.nextDouble() * STEAM_BUBBLE_DIAMETER_RANGE.getLength();
        const steamBubbleCenterXPos = this.containerOutlineRect.centerX + (dotRandom.nextDouble() - 0.5) * (this.containerOutlineRect.width - steamBubbleDiameter);

        // bubbles are invisible to start; they will fade in
        const steamBubble = {
          x: steamBubbleCenterXPos,
          y: this.steamOrigin,
          radius: steamBubbleDiameter / 2,
          opacity: 0
        };
        this.steamBubbles.push(steamBubble);
      }
    } else {
      this.preloadComplete = true;
    }

    // update the position and appearance of the existing steam bubbles
    const steamBubbleSpeed = STEAM_BUBBLE_SPEED_RANGE.min + steamingProportion * STEAM_BUBBLE_SPEED_RANGE.getLength();
    const unfilledBeakerHeight = this.containerOutlineRect.height + this.steamOrigin;

    // create a clone to iterate over so we can splice the original when removing bubbles
    const steamBubblesCopy = [...this.steamBubbles];
    for (let i = 0; i < steamBubblesCopy.length; i++) {
      // float the bubbles upward from the beaker
      steamBubblesCopy[i].y += -dt * steamBubbleSpeed;
      if (steamBubblesCopy[i].y < this.containerOutlineRect.minY) {
        // increase radius
        steamBubblesCopy[i].radius = steamBubblesCopy[i].radius * 2 * (1 + STEAM_BUBBLE_GROWTH_RATE * dt) / 2;

        // give bubble some lateral drift motion
        const distanceFromCenterX = steamBubblesCopy[i].x;
        steamBubblesCopy[i].x += distanceFromCenterX * 0.2 * dt;

        // fade the bubble as it reaches the end of its range
        const heightFraction = Utils.clamp((this.containerOutlineRect.minY - steamBubblesCopy[i].y) / MAX_STEAM_BUBBLE_HEIGHT, 0, 1);
        steamBubblesCopy[i].opacity = (1 - heightFraction) * MAX_STEAM_BUBBLE_OPACITY;
      }

      // fade new bubble in
      else {
        const distanceFromWater = this.steamOrigin - steamBubblesCopy[i].y;
        const opacityFraction = Utils.clamp(distanceFromWater / (unfilledBeakerHeight / 4), 0, 1);
        steamBubblesCopy[i].opacity = opacityFraction * MAX_STEAM_BUBBLE_OPACITY;
      }

      // remove bubble that has floated out of view
      if (this.containerOutlineRect.minY - steamBubblesCopy[i].y > MAX_STEAM_BUBBLE_HEIGHT) {
        this.steamBubbles.splice(i, 1);
        this.preloadComplete = true;
      }
    }
    this.preloadComplete && this.steamBubbles.length && this.invalidatePaint();
  }

  /**
   * Draws a steam bubble.
   * @param {CanvasRenderingContext2D} context
   * @param {Object} steamBubble
   * @private
   */
  drawSteamBubble(context, steamBubble) {
    context.globalAlpha = steamBubble.opacity;
    context.drawImage(this.steamBubbleImageCanvas, steamBubble.x - steamBubble.radius, steamBubble.y - steamBubble.radius, steamBubble.radius * 2, steamBubble.radius * 2);
  }

  /**
   * Paints the steam on the canvas node.
   * @param {CanvasRenderingContext2D} context
   * @public
   */
  paintCanvas(context) {
    for (let i = 0; i < this.steamBubbles.length; i++) {
      this.drawSteamBubble(context, this.steamBubbles[i]);
    }
  }

  /**
   * @public
   */
  reset() {
    this.steamBubbles.length = 0;
    this.invalidatePaint();
  }

  /**
   * Preloads the steam animation.
   * @private
   */
  preloadSteam() {
    this.preloadComplete = false;
    const dt = 1 / EFACConstants.FRAMES_PER_SECOND;
    while (!this.preloadComplete) {
      this.step(dt);
    }
  }
}
energyFormsAndChanges.register('BeakerSteamCanvasNode', BeakerSteamCanvasNode);
export default BeakerSteamCanvasNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3RSYW5kb20iLCJSYW5nZSIsIlV0aWxzIiwiQ2FudmFzTm9kZSIsIlRhbmRlbSIsImVuZXJneUZvcm1zQW5kQ2hhbmdlcyIsIkVGQUNDb25zdGFudHMiLCJTVEVBTUlOR19SQU5HRSIsIlNURUFNX0JVQkJMRV9TUEVFRF9SQU5HRSIsIlNURUFNX0JVQkJMRV9ESUFNRVRFUl9SQU5HRSIsIk1BWF9TVEVBTV9CVUJCTEVfSEVJR0hUIiwiU1RFQU1fQlVCQkxFX1JBVEVfUkFOR0UiLCJTVEVBTV9CVUJCTEVfR1JPV1RIX1JBVEUiLCJNQVhfU1RFQU1fQlVCQkxFX09QQUNJVFkiLCJCZWFrZXJTdGVhbUNhbnZhc05vZGUiLCJjb25zdHJ1Y3RvciIsImNvbnRhaW5lck91dGxpbmVSZWN0IiwiZmx1aWRQcm9wb3J0aW9uUHJvcGVydHkiLCJ0ZW1wZXJhdHVyZVByb3BlcnR5IiwiZmx1aWRCb2lsaW5nUG9pbnQiLCJzdGVhbUNvbG9yIiwib3B0aW9ucyIsInByZWxvYWRDb21wbGV0ZSIsImJ1YmJsZVByb2R1Y3Rpb25SZW1haW5kZXIiLCJzdGVhbU9yaWdpbiIsInN0ZWFtQnViYmxlcyIsInN0ZWFtQnViYmxlSW1hZ2VDYW52YXMiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsIm1heCIsImhlaWdodCIsImNvbnRleHQiLCJnZXRDb250ZXh0IiwiZmlsbFN0eWxlIiwidG9DU1MiLCJiZWdpblBhdGgiLCJhcmMiLCJNYXRoIiwiUEkiLCJmaWxsIiwibGluayIsImZsdWlkUHJvcG9ydGlvbiIsIm1pblkiLCJtdXRhdGUiLCJQSEVUX0lPX0VOQUJMRUQiLCJwaGV0IiwicGhldGlvIiwicGhldGlvRW5naW5lIiwicGhldGlvU3RhdGVFbmdpbmUiLCJzdGF0ZVNldEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsInByZWxvYWRTdGVhbSIsInN0ZXAiLCJkdCIsInN0ZWFtaW5nUHJvcG9ydGlvbiIsInZhbHVlIiwiY2xhbXAiLCJidWJibGVzVG9Qcm9kdWNlQ2FsYyIsIm1pbiIsImdldExlbmd0aCIsImJ1YmJsZXNUb1Byb2R1Y2UiLCJmbG9vciIsImkiLCJzdGVhbUJ1YmJsZURpYW1ldGVyIiwibmV4dERvdWJsZSIsInN0ZWFtQnViYmxlQ2VudGVyWFBvcyIsImNlbnRlclgiLCJzdGVhbUJ1YmJsZSIsIngiLCJ5IiwicmFkaXVzIiwib3BhY2l0eSIsInB1c2giLCJzdGVhbUJ1YmJsZVNwZWVkIiwidW5maWxsZWRCZWFrZXJIZWlnaHQiLCJzdGVhbUJ1YmJsZXNDb3B5IiwibGVuZ3RoIiwiZGlzdGFuY2VGcm9tQ2VudGVyWCIsImhlaWdodEZyYWN0aW9uIiwiZGlzdGFuY2VGcm9tV2F0ZXIiLCJvcGFjaXR5RnJhY3Rpb24iLCJzcGxpY2UiLCJpbnZhbGlkYXRlUGFpbnQiLCJkcmF3U3RlYW1CdWJibGUiLCJnbG9iYWxBbHBoYSIsImRyYXdJbWFnZSIsInBhaW50Q2FudmFzIiwicmVzZXQiLCJGUkFNRVNfUEVSX1NFQ09ORCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQmVha2VyU3RlYW1DYW52YXNOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgbm9kZSBmb3IgdGhlIGNvbHVtbiBvZiBzdGVhbSB0aGF0IHJpc2VzIG91dCBvZiBhIGJlYWtlciB3aGVuIHRoZSB0ZW1wZXJhdHVyZSBvZiB0aGUgY29udGFpbmVkIGxpcXVpZCBpcyBoaWdoIGVub3VnaC5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBLbHVzZW5kb3JmIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBkb3RSYW5kb20gZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL2RvdFJhbmRvbS5qcyc7XHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IHsgQ2FudmFzTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBlbmVyZ3lGb3Jtc0FuZENoYW5nZXMgZnJvbSAnLi4vLi4vZW5lcmd5Rm9ybXNBbmRDaGFuZ2VzLmpzJztcclxuaW1wb3J0IEVGQUNDb25zdGFudHMgZnJvbSAnLi4vRUZBQ0NvbnN0YW50cy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgU1RFQU1JTkdfUkFOR0UgPSAxMDsgLy8gbnVtYmVyIG9mIGRlZ3JlZXMgS2VsdmluIG92ZXIgd2hpY2ggc3RlYW0gaXMgdmlzaWJsZVxyXG5jb25zdCBTVEVBTV9CVUJCTEVfU1BFRURfUkFOR0UgPSBuZXcgUmFuZ2UoIDEwMCwgMTI1ICk7IC8vIGluIHNjcmVlbiBjb29yZHMgKH4gcGl4ZWxzKSAvIHNlY29uZFxyXG5jb25zdCBTVEVBTV9CVUJCTEVfRElBTUVURVJfUkFOR0UgPSBuZXcgUmFuZ2UoIDIwLCA1MCApOyAvLyBpbiBzY3JlZW4gY29vcmRzICh+IHBpeGVscylcclxuY29uc3QgTUFYX1NURUFNX0JVQkJMRV9IRUlHSFQgPSAzMDA7XHJcbmNvbnN0IFNURUFNX0JVQkJMRV9SQVRFX1JBTkdFID0gbmV3IFJhbmdlKCAyMCwgNDAgKTsgLy8gYnViYmxlcyBwZXIgc2Vjb25kXHJcbmNvbnN0IFNURUFNX0JVQkJMRV9HUk9XVEhfUkFURSA9IDAuMjsgLy8gcHJvcG9ydGlvbiBwZXIgc2Vjb25kXHJcbmNvbnN0IE1BWF9TVEVBTV9CVUJCTEVfT1BBQ0lUWSA9IDAuNzsgLy8gcHJvcG9ydGlvbiwgMCB0byAxXHJcblxyXG5jbGFzcyBCZWFrZXJTdGVhbUNhbnZhc05vZGUgZXh0ZW5kcyBDYW52YXNOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtSZWN0YW5nbGV9IGNvbnRhaW5lck91dGxpbmVSZWN0IC0gdGhlIG91dGxpbmUgb2YgdGhlIGNvbnRhaW5lclxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPG51bWJlcj59IGZsdWlkUHJvcG9ydGlvblByb3BlcnR5IC0gdGhlIHByb3BvcnRpb24gb2YgZmx1aWQgaW4gaXRzIGNvbnRhaW5lclxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPG51bWJlcj59IHRlbXBlcmF0dXJlUHJvcGVydHkgLSB0aGUgdGVtcGVyYXR1cmUgb2YgdGhlIGxpcXVpZFxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBmbHVpZEJvaWxpbmdQb2ludFxyXG4gICAqIEBwYXJhbSB7Q29sb3J9IHN0ZWFtQ29sb3JcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGNvbnRhaW5lck91dGxpbmVSZWN0LCBmbHVpZFByb3BvcnRpb25Qcm9wZXJ0eSwgdGVtcGVyYXR1cmVQcm9wZXJ0eSwgZmx1aWRCb2lsaW5nUG9pbnQsIHN0ZWFtQ29sb3IsIG9wdGlvbnMgKSB7XHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLmNvbnRhaW5lck91dGxpbmVSZWN0ID0gY29udGFpbmVyT3V0bGluZVJlY3Q7XHJcbiAgICB0aGlzLmZsdWlkUHJvcG9ydGlvblByb3BlcnR5ID0gZmx1aWRQcm9wb3J0aW9uUHJvcGVydHk7XHJcbiAgICB0aGlzLnRlbXBlcmF0dXJlUHJvcGVydHkgPSB0ZW1wZXJhdHVyZVByb3BlcnR5O1xyXG4gICAgdGhpcy5mbHVpZEJvaWxpbmdQb2ludCA9IGZsdWlkQm9pbGluZ1BvaW50O1xyXG4gICAgdGhpcy5zdGVhbUNvbG9yID0gc3RlYW1Db2xvcjtcclxuICAgIHRoaXMucHJlbG9hZENvbXBsZXRlID0gdHJ1ZTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5idWJibGVQcm9kdWN0aW9uUmVtYWluZGVyID0gMDtcclxuICAgIHRoaXMuc3RlYW1PcmlnaW4gPSAwO1xyXG4gICAgdGhpcy5zdGVhbUJ1YmJsZXMgPSBbXTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgLy8gY2FudmFzIHdoZXJlIHRoZSBzdGVhbSBidWJibGUgaW1hZ2UgcmVzaWRlc1xyXG4gICAgdGhpcy5zdGVhbUJ1YmJsZUltYWdlQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTtcclxuICAgIHRoaXMuc3RlYW1CdWJibGVJbWFnZUNhbnZhcy53aWR0aCA9IFNURUFNX0JVQkJMRV9ESUFNRVRFUl9SQU5HRS5tYXg7XHJcbiAgICB0aGlzLnN0ZWFtQnViYmxlSW1hZ2VDYW52YXMuaGVpZ2h0ID0gU1RFQU1fQlVCQkxFX0RJQU1FVEVSX1JBTkdFLm1heDtcclxuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLnN0ZWFtQnViYmxlSW1hZ2VDYW52YXMuZ2V0Q29udGV4dCggJzJkJyApO1xyXG5cclxuICAgIC8vIGRyYXcgYSBzdGVhbSBidWJibGUgY2VudGVyZWQgaW4gdGhlIHN0ZWFtIGJ1YmJsZSBpbWFnZSBjYW52YXNcclxuICAgIGNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5zdGVhbUNvbG9yLnRvQ1NTKCk7XHJcbiAgICBjb250ZXh0LmJlZ2luUGF0aCgpO1xyXG4gICAgY29udGV4dC5hcmMoXHJcbiAgICAgIFNURUFNX0JVQkJMRV9ESUFNRVRFUl9SQU5HRS5tYXggLyAyLFxyXG4gICAgICBTVEVBTV9CVUJCTEVfRElBTUVURVJfUkFOR0UubWF4IC8gMixcclxuICAgICAgU1RFQU1fQlVCQkxFX0RJQU1FVEVSX1JBTkdFLm1heCAvIDIsXHJcbiAgICAgIDAsXHJcbiAgICAgIE1hdGguUEkgKiAyLFxyXG4gICAgICB0cnVlXHJcbiAgICApO1xyXG4gICAgY29udGV4dC5maWxsKCk7XHJcblxyXG4gICAgLy8gdXBkYXRlIHRoZSBhcHBlYXJhbmNlIG9mIHRoZSB3YXRlciBhcyB0aGUgbGV2ZWwgY2hhbmdlc1xyXG4gICAgdGhpcy5mbHVpZFByb3BvcnRpb25Qcm9wZXJ0eS5saW5rKCBmbHVpZFByb3BvcnRpb24gPT4ge1xyXG4gICAgICB0aGlzLnN0ZWFtT3JpZ2luID0gdGhpcy5jb250YWluZXJPdXRsaW5lUmVjdC5taW5ZICogZmx1aWRQcm9wb3J0aW9uO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubXV0YXRlKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gUHJlbG9hZCBzdGVhbSBhbmltYXRpb24gYWZ0ZXIgc3RhdGUgaGFzIGJlZW4gc2V0XHJcbiAgICBUYW5kZW0uUEhFVF9JT19FTkFCTEVEICYmIHBoZXQucGhldGlvLnBoZXRpb0VuZ2luZS5waGV0aW9TdGF0ZUVuZ2luZS5zdGF0ZVNldEVtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuICAgICAgdGhpcy5wcmVsb2FkU3RlYW0oKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhlIG51bWJlciBvZiBzdGVhbSBidWJibGVzIGFuZCB0aGUgcG9zaXRpb24sIHNpemUsIGFuZCBvcGFjaXR5IG9mIGVhY2ggb25lLlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBkdFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzdGVwKCBkdCApIHtcclxuICAgIGxldCBzdGVhbWluZ1Byb3BvcnRpb24gPSAwO1xyXG5cclxuICAgIC8vIGFkZCBhbnkgbmV3IHN0ZWFtIGJ1YmJsZXNcclxuICAgIGlmICggdGhpcy5mbHVpZEJvaWxpbmdQb2ludCAtIHRoaXMudGVtcGVyYXR1cmVQcm9wZXJ0eS52YWx1ZSA8IFNURUFNSU5HX1JBTkdFICkge1xyXG5cclxuICAgICAgLy8gdGhlIHdhdGVyIGlzIGVtaXR0aW5nIHNvbWUgYW1vdW50IG9mIHN0ZWFtIC0gc2V0IHRoZSBwcm9wb3J0aW9uYXRlIGFtb3VudFxyXG4gICAgICBzdGVhbWluZ1Byb3BvcnRpb24gPSAxIC0gKCAoIHRoaXMuZmx1aWRCb2lsaW5nUG9pbnQgLSB0aGlzLnRlbXBlcmF0dXJlUHJvcGVydHkudmFsdWUgKSAvIFNURUFNSU5HX1JBTkdFICk7XHJcbiAgICAgIHN0ZWFtaW5nUHJvcG9ydGlvbiA9IFV0aWxzLmNsYW1wKCBzdGVhbWluZ1Byb3BvcnRpb24sIDAsIDEgKTtcclxuXHJcbiAgICAgIGNvbnN0IGJ1YmJsZXNUb1Byb2R1Y2VDYWxjID1cclxuICAgICAgICAoIFNURUFNX0JVQkJMRV9SQVRFX1JBTkdFLm1pbiArIFNURUFNX0JVQkJMRV9SQVRFX1JBTkdFLmdldExlbmd0aCgpICogc3RlYW1pbmdQcm9wb3J0aW9uICkgKiBkdDtcclxuICAgICAgbGV0IGJ1YmJsZXNUb1Byb2R1Y2UgPSBNYXRoLmZsb29yKCBidWJibGVzVG9Qcm9kdWNlQ2FsYyApO1xyXG5cclxuICAgICAgdGhpcy5idWJibGVQcm9kdWN0aW9uUmVtYWluZGVyICs9IGJ1YmJsZXNUb1Byb2R1Y2VDYWxjIC0gYnViYmxlc1RvUHJvZHVjZTtcclxuXHJcbiAgICAgIGlmICggdGhpcy5idWJibGVQcm9kdWN0aW9uUmVtYWluZGVyID49IDEgKSB7XHJcbiAgICAgICAgYnViYmxlc1RvUHJvZHVjZSArPSBNYXRoLmZsb29yKCB0aGlzLmJ1YmJsZVByb2R1Y3Rpb25SZW1haW5kZXIgKTtcclxuICAgICAgICB0aGlzLmJ1YmJsZVByb2R1Y3Rpb25SZW1haW5kZXIgLT0gTWF0aC5mbG9vciggdGhpcy5idWJibGVQcm9kdWN0aW9uUmVtYWluZGVyICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGJ1YmJsZXNUb1Byb2R1Y2U7IGkrKyApIHtcclxuICAgICAgICBjb25zdCBzdGVhbUJ1YmJsZURpYW1ldGVyID0gU1RFQU1fQlVCQkxFX0RJQU1FVEVSX1JBTkdFLm1pbiArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvdFJhbmRvbS5uZXh0RG91YmxlKCkgKiBTVEVBTV9CVUJCTEVfRElBTUVURVJfUkFOR0UuZ2V0TGVuZ3RoKCk7XHJcbiAgICAgICAgY29uc3Qgc3RlYW1CdWJibGVDZW50ZXJYUG9zID0gdGhpcy5jb250YWluZXJPdXRsaW5lUmVjdC5jZW50ZXJYICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIGRvdFJhbmRvbS5uZXh0RG91YmxlKCkgLSAwLjUgKSAqXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCB0aGlzLmNvbnRhaW5lck91dGxpbmVSZWN0LndpZHRoIC0gc3RlYW1CdWJibGVEaWFtZXRlciApO1xyXG5cclxuICAgICAgICAvLyBidWJibGVzIGFyZSBpbnZpc2libGUgdG8gc3RhcnQ7IHRoZXkgd2lsbCBmYWRlIGluXHJcbiAgICAgICAgY29uc3Qgc3RlYW1CdWJibGUgPSB7XHJcbiAgICAgICAgICB4OiBzdGVhbUJ1YmJsZUNlbnRlclhQb3MsXHJcbiAgICAgICAgICB5OiB0aGlzLnN0ZWFtT3JpZ2luLFxyXG4gICAgICAgICAgcmFkaXVzOiBzdGVhbUJ1YmJsZURpYW1ldGVyIC8gMixcclxuICAgICAgICAgIG9wYWNpdHk6IDBcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuc3RlYW1CdWJibGVzLnB1c2goIHN0ZWFtQnViYmxlICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLnByZWxvYWRDb21wbGV0ZSA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gdXBkYXRlIHRoZSBwb3NpdGlvbiBhbmQgYXBwZWFyYW5jZSBvZiB0aGUgZXhpc3Rpbmcgc3RlYW0gYnViYmxlc1xyXG4gICAgY29uc3Qgc3RlYW1CdWJibGVTcGVlZCA9IFNURUFNX0JVQkJMRV9TUEVFRF9SQU5HRS5taW4gKyBzdGVhbWluZ1Byb3BvcnRpb24gKiBTVEVBTV9CVUJCTEVfU1BFRURfUkFOR0UuZ2V0TGVuZ3RoKCk7XHJcbiAgICBjb25zdCB1bmZpbGxlZEJlYWtlckhlaWdodCA9IHRoaXMuY29udGFpbmVyT3V0bGluZVJlY3QuaGVpZ2h0ICsgdGhpcy5zdGVhbU9yaWdpbjtcclxuXHJcbiAgICAvLyBjcmVhdGUgYSBjbG9uZSB0byBpdGVyYXRlIG92ZXIgc28gd2UgY2FuIHNwbGljZSB0aGUgb3JpZ2luYWwgd2hlbiByZW1vdmluZyBidWJibGVzXHJcbiAgICBjb25zdCBzdGVhbUJ1YmJsZXNDb3B5ID0gWyAuLi50aGlzLnN0ZWFtQnViYmxlcyBdO1xyXG5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHN0ZWFtQnViYmxlc0NvcHkubGVuZ3RoOyBpKysgKSB7XHJcblxyXG4gICAgICAvLyBmbG9hdCB0aGUgYnViYmxlcyB1cHdhcmQgZnJvbSB0aGUgYmVha2VyXHJcbiAgICAgIHN0ZWFtQnViYmxlc0NvcHlbIGkgXS55ICs9IC1kdCAqIHN0ZWFtQnViYmxlU3BlZWQ7XHJcblxyXG4gICAgICBpZiAoIHN0ZWFtQnViYmxlc0NvcHlbIGkgXS55IDwgdGhpcy5jb250YWluZXJPdXRsaW5lUmVjdC5taW5ZICkge1xyXG5cclxuICAgICAgICAvLyBpbmNyZWFzZSByYWRpdXNcclxuICAgICAgICBzdGVhbUJ1YmJsZXNDb3B5WyBpIF0ucmFkaXVzID0gc3RlYW1CdWJibGVzQ29weVsgaSBdLnJhZGl1cyAqIDIgKiAoIDEgKyAoIFNURUFNX0JVQkJMRV9HUk9XVEhfUkFURSAqIGR0ICkgKSAvIDI7XHJcblxyXG4gICAgICAgIC8vIGdpdmUgYnViYmxlIHNvbWUgbGF0ZXJhbCBkcmlmdCBtb3Rpb25cclxuICAgICAgICBjb25zdCBkaXN0YW5jZUZyb21DZW50ZXJYID0gc3RlYW1CdWJibGVzQ29weVsgaSBdLng7XHJcbiAgICAgICAgc3RlYW1CdWJibGVzQ29weVsgaSBdLnggKz0gZGlzdGFuY2VGcm9tQ2VudGVyWCAqIDAuMiAqIGR0O1xyXG5cclxuICAgICAgICAvLyBmYWRlIHRoZSBidWJibGUgYXMgaXQgcmVhY2hlcyB0aGUgZW5kIG9mIGl0cyByYW5nZVxyXG4gICAgICAgIGNvbnN0IGhlaWdodEZyYWN0aW9uID0gVXRpbHMuY2xhbXAoICggdGhpcy5jb250YWluZXJPdXRsaW5lUmVjdC5taW5ZIC0gc3RlYW1CdWJibGVzQ29weVsgaSBdLnkgKSAvIE1BWF9TVEVBTV9CVUJCTEVfSEVJR0hULCAwLCAxICk7XHJcbiAgICAgICAgc3RlYW1CdWJibGVzQ29weVsgaSBdLm9wYWNpdHkgPSAoIDEgLSBoZWlnaHRGcmFjdGlvbiApICogTUFYX1NURUFNX0JVQkJMRV9PUEFDSVRZO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBmYWRlIG5ldyBidWJibGUgaW5cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgY29uc3QgZGlzdGFuY2VGcm9tV2F0ZXIgPSB0aGlzLnN0ZWFtT3JpZ2luIC0gc3RlYW1CdWJibGVzQ29weVsgaSBdLnk7XHJcbiAgICAgICAgY29uc3Qgb3BhY2l0eUZyYWN0aW9uID0gVXRpbHMuY2xhbXAoIGRpc3RhbmNlRnJvbVdhdGVyIC8gKCB1bmZpbGxlZEJlYWtlckhlaWdodCAvIDQgKSwgMCwgMSApO1xyXG4gICAgICAgIHN0ZWFtQnViYmxlc0NvcHlbIGkgXS5vcGFjaXR5ID0gb3BhY2l0eUZyYWN0aW9uICogTUFYX1NURUFNX0JVQkJMRV9PUEFDSVRZO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyByZW1vdmUgYnViYmxlIHRoYXQgaGFzIGZsb2F0ZWQgb3V0IG9mIHZpZXdcclxuICAgICAgaWYgKCB0aGlzLmNvbnRhaW5lck91dGxpbmVSZWN0Lm1pblkgLSBzdGVhbUJ1YmJsZXNDb3B5WyBpIF0ueSA+IE1BWF9TVEVBTV9CVUJCTEVfSEVJR0hUICkge1xyXG4gICAgICAgIHRoaXMuc3RlYW1CdWJibGVzLnNwbGljZSggaSwgMSApO1xyXG4gICAgICAgIHRoaXMucHJlbG9hZENvbXBsZXRlID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucHJlbG9hZENvbXBsZXRlICYmIHRoaXMuc3RlYW1CdWJibGVzLmxlbmd0aCAmJiB0aGlzLmludmFsaWRhdGVQYWludCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRHJhd3MgYSBzdGVhbSBidWJibGUuXHJcbiAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHRcclxuICAgKiBAcGFyYW0ge09iamVjdH0gc3RlYW1CdWJibGVcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGRyYXdTdGVhbUJ1YmJsZSggY29udGV4dCwgc3RlYW1CdWJibGUgKSB7XHJcbiAgICBjb250ZXh0Lmdsb2JhbEFscGhhID0gc3RlYW1CdWJibGUub3BhY2l0eTtcclxuICAgIGNvbnRleHQuZHJhd0ltYWdlKFxyXG4gICAgICB0aGlzLnN0ZWFtQnViYmxlSW1hZ2VDYW52YXMsXHJcbiAgICAgIHN0ZWFtQnViYmxlLnggLSBzdGVhbUJ1YmJsZS5yYWRpdXMsXHJcbiAgICAgIHN0ZWFtQnViYmxlLnkgLSBzdGVhbUJ1YmJsZS5yYWRpdXMsXHJcbiAgICAgIHN0ZWFtQnViYmxlLnJhZGl1cyAqIDIsXHJcbiAgICAgIHN0ZWFtQnViYmxlLnJhZGl1cyAqIDJcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQYWludHMgdGhlIHN0ZWFtIG9uIHRoZSBjYW52YXMgbm9kZS5cclxuICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBwYWludENhbnZhcyggY29udGV4dCApIHtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuc3RlYW1CdWJibGVzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICB0aGlzLmRyYXdTdGVhbUJ1YmJsZSggY29udGV4dCwgdGhpcy5zdGVhbUJ1YmJsZXNbIGkgXSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5zdGVhbUJ1YmJsZXMubGVuZ3RoID0gMDtcclxuICAgIHRoaXMuaW52YWxpZGF0ZVBhaW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQcmVsb2FkcyB0aGUgc3RlYW0gYW5pbWF0aW9uLlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgcHJlbG9hZFN0ZWFtKCkge1xyXG4gICAgdGhpcy5wcmVsb2FkQ29tcGxldGUgPSBmYWxzZTtcclxuICAgIGNvbnN0IGR0ID0gMSAvIEVGQUNDb25zdGFudHMuRlJBTUVTX1BFUl9TRUNPTkQ7XHJcblxyXG4gICAgd2hpbGUgKCAhdGhpcy5wcmVsb2FkQ29tcGxldGUgKSB7XHJcbiAgICAgIHRoaXMuc3RlcCggZHQgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmVuZXJneUZvcm1zQW5kQ2hhbmdlcy5yZWdpc3RlciggJ0JlYWtlclN0ZWFtQ2FudmFzTm9kZScsIEJlYWtlclN0ZWFtQ2FudmFzTm9kZSApO1xyXG5leHBvcnQgZGVmYXVsdCBCZWFrZXJTdGVhbUNhbnZhc05vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGlDQUFpQztBQUN2RCxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsU0FBU0MsVUFBVSxRQUFRLG1DQUFtQztBQUM5RCxPQUFPQyxNQUFNLE1BQU0saUNBQWlDO0FBQ3BELE9BQU9DLHFCQUFxQixNQUFNLGdDQUFnQztBQUNsRSxPQUFPQyxhQUFhLE1BQU0scUJBQXFCOztBQUUvQztBQUNBLE1BQU1DLGNBQWMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUMzQixNQUFNQyx3QkFBd0IsR0FBRyxJQUFJUCxLQUFLLENBQUUsR0FBRyxFQUFFLEdBQUksQ0FBQyxDQUFDLENBQUM7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