// Copyright 2018-2021, University of Colorado Boulder

/**
 * A node for water droplets falling out of the faucet. This canvas node exists because the water drops can be rendered
 * faster as canvas images than as individual nodes.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 * @author John Blanco (PhET Interactive Simulations)
 */

import { CanvasNode } from '../../../../scenery/js/imports.js';
import EFACConstants from '../../common/EFACConstants.js';
import energyFormsAndChanges from '../../energyFormsAndChanges.js';
import FaucetAndWater from '../model/FaucetAndWater.js';
class FallingWaterCanvasNode extends CanvasNode {
  /**
   * @param {WaterDrop[]} waterDrops - the falling water drops to be rendered
   * @param {ModelViewTransform2} modelViewTransform
   * @param {Object} [options] that can be passed on to the underlying node
   */
  constructor(waterDrops, modelViewTransform, options) {
    super(options);

    // @private
    this.waterDrops = waterDrops;
    this.modelViewTransform = modelViewTransform;

    // @private
    // canvas where the water drop image is drawn
    this.waterDropImageCanvas = document.createElement('canvas');

    // initial drop image is a circle of size MAX_WATER_WIDTH for width and height
    const waterDropImageCanvasWidthHeight = modelViewTransform.modelToViewDeltaX(FaucetAndWater.MAX_WATER_WIDTH);
    const waterDropImageCanvasRadius = modelViewTransform.modelToViewDeltaX(FaucetAndWater.MAX_WATER_WIDTH / 2);
    this.waterDropImageCanvas.width = waterDropImageCanvasWidthHeight;
    this.waterDropImageCanvas.height = waterDropImageCanvasWidthHeight;
    const context = this.waterDropImageCanvas.getContext('2d');

    // draw a water drop centered in the water drop image canvas
    context.fillStyle = EFACConstants.WATER_COLOR_OPAQUE.toCSS();
    context.globalAlpha = 0.25;
    context.beginPath();
    context.arc(waterDropImageCanvasRadius, waterDropImageCanvasRadius, waterDropImageCanvasRadius, 0, Math.PI * 2, true);
    context.fill();
    this.mutate(options);
  }

  /**
   * Renders water drops on the canvas node.
   * @param {CanvasRenderingContext2D} context
   * @private
   */
  renderFallingWater(context) {
    const numberOfWaterDrops = this.waterDrops.length;
    for (let i = 0; i < numberOfWaterDrops; i++) {
      this.drawWaterDrop(context, this.waterDrops[i]);
    }
  }

  /*
   * Draws a water drop.
   * @param {CanvasRenderingContext2D} context
   * @param {WaterDrop} drop
   * @private
   */
  drawWaterDrop(context, drop) {
    context.drawImage(this.waterDropImageCanvas, this.modelViewTransform.modelToViewDeltaX(drop.position.x - drop.size.width / 2), this.modelViewTransform.modelToViewDeltaY(drop.position.y + drop.size.height / 2), this.modelViewTransform.modelToViewDeltaX(drop.size.width), -this.modelViewTransform.modelToViewDeltaY(drop.size.height));
  }

  /**
   * Paints the water drops on the canvas node.
   * @param {CanvasRenderingContext2D} context
   * @override
   * @public
   */
  paintCanvas(context) {
    this.renderFallingWater(context);
  }

  /**
   * @public
   * @param {number} dt - the change in time
   */
  step(dt) {
    this.invalidatePaint();
  }
}
energyFormsAndChanges.register('FallingWaterCanvasNode', FallingWaterCanvasNode);
export default FallingWaterCanvasNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDYW52YXNOb2RlIiwiRUZBQ0NvbnN0YW50cyIsImVuZXJneUZvcm1zQW5kQ2hhbmdlcyIsIkZhdWNldEFuZFdhdGVyIiwiRmFsbGluZ1dhdGVyQ2FudmFzTm9kZSIsImNvbnN0cnVjdG9yIiwid2F0ZXJEcm9wcyIsIm1vZGVsVmlld1RyYW5zZm9ybSIsIm9wdGlvbnMiLCJ3YXRlckRyb3BJbWFnZUNhbnZhcyIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsIndhdGVyRHJvcEltYWdlQ2FudmFzV2lkdGhIZWlnaHQiLCJtb2RlbFRvVmlld0RlbHRhWCIsIk1BWF9XQVRFUl9XSURUSCIsIndhdGVyRHJvcEltYWdlQ2FudmFzUmFkaXVzIiwid2lkdGgiLCJoZWlnaHQiLCJjb250ZXh0IiwiZ2V0Q29udGV4dCIsImZpbGxTdHlsZSIsIldBVEVSX0NPTE9SX09QQVFVRSIsInRvQ1NTIiwiZ2xvYmFsQWxwaGEiLCJiZWdpblBhdGgiLCJhcmMiLCJNYXRoIiwiUEkiLCJmaWxsIiwibXV0YXRlIiwicmVuZGVyRmFsbGluZ1dhdGVyIiwibnVtYmVyT2ZXYXRlckRyb3BzIiwibGVuZ3RoIiwiaSIsImRyYXdXYXRlckRyb3AiLCJkcm9wIiwiZHJhd0ltYWdlIiwicG9zaXRpb24iLCJ4Iiwic2l6ZSIsIm1vZGVsVG9WaWV3RGVsdGFZIiwieSIsInBhaW50Q2FudmFzIiwic3RlcCIsImR0IiwiaW52YWxpZGF0ZVBhaW50IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJGYWxsaW5nV2F0ZXJDYW52YXNOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgbm9kZSBmb3Igd2F0ZXIgZHJvcGxldHMgZmFsbGluZyBvdXQgb2YgdGhlIGZhdWNldC4gVGhpcyBjYW52YXMgbm9kZSBleGlzdHMgYmVjYXVzZSB0aGUgd2F0ZXIgZHJvcHMgY2FuIGJlIHJlbmRlcmVkXHJcbiAqIGZhc3RlciBhcyBjYW52YXMgaW1hZ2VzIHRoYW4gYXMgaW5kaXZpZHVhbCBub2Rlcy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBLbHVzZW5kb3JmIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IENhbnZhc05vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgRUZBQ0NvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vRUZBQ0NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBlbmVyZ3lGb3Jtc0FuZENoYW5nZXMgZnJvbSAnLi4vLi4vZW5lcmd5Rm9ybXNBbmRDaGFuZ2VzLmpzJztcclxuaW1wb3J0IEZhdWNldEFuZFdhdGVyIGZyb20gJy4uL21vZGVsL0ZhdWNldEFuZFdhdGVyLmpzJztcclxuXHJcbmNsYXNzIEZhbGxpbmdXYXRlckNhbnZhc05vZGUgZXh0ZW5kcyBDYW52YXNOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtXYXRlckRyb3BbXX0gd2F0ZXJEcm9wcyAtIHRoZSBmYWxsaW5nIHdhdGVyIGRyb3BzIHRvIGJlIHJlbmRlcmVkXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIHRoYXQgY2FuIGJlIHBhc3NlZCBvbiB0byB0aGUgdW5kZXJseWluZyBub2RlXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHdhdGVyRHJvcHMsIG1vZGVsVmlld1RyYW5zZm9ybSwgb3B0aW9ucyApIHtcclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMud2F0ZXJEcm9wcyA9IHdhdGVyRHJvcHM7XHJcbiAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSA9IG1vZGVsVmlld1RyYW5zZm9ybTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgLy8gY2FudmFzIHdoZXJlIHRoZSB3YXRlciBkcm9wIGltYWdlIGlzIGRyYXduXHJcbiAgICB0aGlzLndhdGVyRHJvcEltYWdlQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTtcclxuXHJcbiAgICAvLyBpbml0aWFsIGRyb3AgaW1hZ2UgaXMgYSBjaXJjbGUgb2Ygc2l6ZSBNQVhfV0FURVJfV0lEVEggZm9yIHdpZHRoIGFuZCBoZWlnaHRcclxuICAgIGNvbnN0IHdhdGVyRHJvcEltYWdlQ2FudmFzV2lkdGhIZWlnaHQgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIEZhdWNldEFuZFdhdGVyLk1BWF9XQVRFUl9XSURUSCApO1xyXG4gICAgY29uc3Qgd2F0ZXJEcm9wSW1hZ2VDYW52YXNSYWRpdXMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIEZhdWNldEFuZFdhdGVyLk1BWF9XQVRFUl9XSURUSCAvIDIgKTtcclxuICAgIHRoaXMud2F0ZXJEcm9wSW1hZ2VDYW52YXMud2lkdGggPSB3YXRlckRyb3BJbWFnZUNhbnZhc1dpZHRoSGVpZ2h0O1xyXG4gICAgdGhpcy53YXRlckRyb3BJbWFnZUNhbnZhcy5oZWlnaHQgPSB3YXRlckRyb3BJbWFnZUNhbnZhc1dpZHRoSGVpZ2h0O1xyXG4gICAgY29uc3QgY29udGV4dCA9IHRoaXMud2F0ZXJEcm9wSW1hZ2VDYW52YXMuZ2V0Q29udGV4dCggJzJkJyApO1xyXG5cclxuICAgIC8vIGRyYXcgYSB3YXRlciBkcm9wIGNlbnRlcmVkIGluIHRoZSB3YXRlciBkcm9wIGltYWdlIGNhbnZhc1xyXG4gICAgY29udGV4dC5maWxsU3R5bGUgPSBFRkFDQ29uc3RhbnRzLldBVEVSX0NPTE9SX09QQVFVRS50b0NTUygpO1xyXG4gICAgY29udGV4dC5nbG9iYWxBbHBoYSA9IDAuMjU7XHJcbiAgICBjb250ZXh0LmJlZ2luUGF0aCgpO1xyXG4gICAgY29udGV4dC5hcmMoXHJcbiAgICAgIHdhdGVyRHJvcEltYWdlQ2FudmFzUmFkaXVzLFxyXG4gICAgICB3YXRlckRyb3BJbWFnZUNhbnZhc1JhZGl1cyxcclxuICAgICAgd2F0ZXJEcm9wSW1hZ2VDYW52YXNSYWRpdXMsXHJcbiAgICAgIDAsXHJcbiAgICAgIE1hdGguUEkgKiAyLFxyXG4gICAgICB0cnVlXHJcbiAgICApO1xyXG4gICAgY29udGV4dC5maWxsKCk7XHJcblxyXG4gICAgdGhpcy5tdXRhdGUoIG9wdGlvbnMgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbmRlcnMgd2F0ZXIgZHJvcHMgb24gdGhlIGNhbnZhcyBub2RlLlxyXG4gICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0XHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICByZW5kZXJGYWxsaW5nV2F0ZXIoIGNvbnRleHQgKSB7XHJcbiAgICBjb25zdCBudW1iZXJPZldhdGVyRHJvcHMgPSB0aGlzLndhdGVyRHJvcHMubGVuZ3RoO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZXYXRlckRyb3BzOyBpKysgKSB7XHJcbiAgICAgIHRoaXMuZHJhd1dhdGVyRHJvcCggY29udGV4dCwgdGhpcy53YXRlckRyb3BzWyBpIF0gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogRHJhd3MgYSB3YXRlciBkcm9wLlxyXG4gICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0XHJcbiAgICogQHBhcmFtIHtXYXRlckRyb3B9IGRyb3BcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGRyYXdXYXRlckRyb3AoIGNvbnRleHQsIGRyb3AgKSB7XHJcbiAgICBjb250ZXh0LmRyYXdJbWFnZShcclxuICAgICAgdGhpcy53YXRlckRyb3BJbWFnZUNhbnZhcyxcclxuICAgICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGRyb3AucG9zaXRpb24ueCAtIGRyb3Auc2l6ZS53aWR0aCAvIDIgKSxcclxuICAgICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIGRyb3AucG9zaXRpb24ueSArIGRyb3Auc2l6ZS5oZWlnaHQgLyAyICksXHJcbiAgICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFYKCBkcm9wLnNpemUud2lkdGggKSxcclxuICAgICAgLXRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFZKCBkcm9wLnNpemUuaGVpZ2h0IClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQYWludHMgdGhlIHdhdGVyIGRyb3BzIG9uIHRoZSBjYW52YXMgbm9kZS5cclxuICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dFxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBwYWludENhbnZhcyggY29udGV4dCApIHtcclxuICAgIHRoaXMucmVuZGVyRmFsbGluZ1dhdGVyKCBjb250ZXh0ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0IC0gdGhlIGNoYW5nZSBpbiB0aW1lXHJcbiAgICovXHJcbiAgc3RlcCggZHQgKSB7XHJcbiAgICB0aGlzLmludmFsaWRhdGVQYWludCgpO1xyXG4gIH1cclxufVxyXG5cclxuZW5lcmd5Rm9ybXNBbmRDaGFuZ2VzLnJlZ2lzdGVyKCAnRmFsbGluZ1dhdGVyQ2FudmFzTm9kZScsIEZhbGxpbmdXYXRlckNhbnZhc05vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgRmFsbGluZ1dhdGVyQ2FudmFzTm9kZTsiXSwibWFwcGluZ3MiOiJBQUFB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