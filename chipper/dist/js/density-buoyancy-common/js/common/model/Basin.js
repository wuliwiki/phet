// Copyright 2020-2022, University of Colorado Boulder

/**
 * Represents a basin that a liquid can reside in at a specific level. This is used for the pool and liquid in the boat.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Range from '../../../../dot/js/Range.js';
import optionize from '../../../../phet-core/js/optionize.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import NumberIO from '../../../../tandem/js/types/NumberIO.js';
import densityBuoyancyCommon from '../../densityBuoyancyCommon.js';
import InterpolatedProperty from './InterpolatedProperty.js';
export default class Basin {
  // In m^3, the volume of liquid contained in this basin

  // The y coordinate of the liquid level (absolute in the model, NOT relative to anything)

  // The bottom and top of the basin's area of containment (absolute model coordinates), set during physics engine steps.

  // The masses contained in this basin, set during the physics engine steps.

  // A basin that may be contained in this one (boat basin in the pool) NOTE: only one guaranteed

  constructor(providedOptions) {
    const options = optionize()({
      initialVolume: 0,
      initialY: 0,
      tandem: Tandem.REQUIRED
    }, providedOptions);
    const tandem = options.tandem;
    this.liquidVolumeProperty = new NumberProperty(options.initialVolume, {
      tandem: tandem.createTandem('liquidVolumeProperty'),
      phetioReadOnly: true,
      range: new Range(0, Number.POSITIVE_INFINITY),
      phetioDocumentation: 'The volume of liquid contained in the basin',
      units: 'm^3'
    });
    this.liquidYInterpolatedProperty = new InterpolatedProperty(options.initialY, {
      interpolate: InterpolatedProperty.interpolateNumber,
      phetioOuterType: InterpolatedProperty.InterpolatedPropertyIO,
      phetioValueType: NumberIO,
      tandem: tandem.createTandem('liquidYInterpolatedProperty'),
      phetioHighFrequency: true,
      phetioReadOnly: true,
      phetioDocumentation: 'The y-value of the liquid in model coordinates (where 0 is the top of the pool)'
    });
    this.stepBottom = 0;
    this.stepTop = 0;
    this.stepMasses = [];
    this.childBasin = null;
  }

  /**
   * Returns whether a given mass is inside this basin (e.g. if filled with liquid, would it be displacing any
   * liquid).
   */

  /**
   * Returns the maximum area that could be contained with liquid at a given y value.
   */

  /**
   * Returns the maximum volume that could be contained with liquid up to a given y value.
   */

  /**
   * Returns the filled area in the basin (i.e. things that aren't air or water) at the given y value
   */
  getDisplacedArea(y) {
    let area = 0;
    this.stepMasses.forEach(mass => {
      area += mass.getDisplacedArea(y);
      assert && assert(!isNaN(area));
    });

    // Don't double-count things, since we're counting the full displacement of the child basin's container
    if (this.childBasin) {
      area -= this.childBasin.getDisplacedArea(y);
    }
    return area;
  }

  /**
   * Returns the filled volume in the basin (i.e. things that aren't air or water) that is below the given y value.
   */
  getDisplacedVolume(y) {
    let volume = 0;
    this.stepMasses.forEach(mass => {
      volume += mass.getDisplacedVolume(y);
      assert && assert(!isNaN(volume));
    });
    assert && assert(this !== this.childBasin);

    // Don't double-count things, since we're counting the full displacement of the child basin's container
    if (this.childBasin) {
      volume -= this.childBasin.getDisplacedVolume(Math.min(y, this.childBasin.stepTop));
    }
    return volume;
  }

  /**
   * Returns the empty area in the basin (i.e. air, that isn't a solid object) at the given y value.
   */
  getEmptyArea(y) {
    return this.getMaximumArea(y) - this.getDisplacedArea(y);
  }

  /**
   * Returns the empty volume in the basin (i.e. air, that isn't a solid object) that is below the given y value.
   */
  getEmptyVolume(y) {
    const emptyVolume = this.getMaximumVolume(y) - this.getDisplacedVolume(y);
    assert && assert(emptyVolume >= -1e-11, 'empty volume should be non-negative');
    return emptyVolume;
  }

  /**
   * Computes the liquid's y coordinate, given the current volume
   */
  computeY() {
    const liquidVolume = this.liquidVolumeProperty.value;
    if (liquidVolume === 0) {
      this.liquidYInterpolatedProperty.setNextValue(this.stepBottom);
      return;
    }
    const emptyVolume = this.getEmptyVolume(this.stepTop);
    if (emptyVolume === liquidVolume) {
      this.liquidYInterpolatedProperty.setNextValue(this.stepTop);
      return;
    }

    // Due to shapes used, there is no analytical solution.
    this.liquidYInterpolatedProperty.setNextValue(Basin.findRoot(this.stepBottom, this.stepTop, 1e-7,
    // We're finding the root (zero), so that's where the empty volume equals the liquid volume
    yTest => this.getEmptyVolume(yTest) - liquidVolume,
    // The derivative (change of volume) happens to be the area at that section
    yTest => this.getEmptyArea(yTest)));
  }

  /**
   * Resets to an initial state.
   */
  reset() {
    this.liquidVolumeProperty.reset();
    this.liquidYInterpolatedProperty.reset();
  }

  /**
   * Hybrid root-finding given our constraints (guaranteed interval, value/derivative). Combines Newton's and bisection.
   */
  static findRoot(minX, maxX, tolerance, valueFunction, derivativeFunction) {
    let x = (minX + maxX) / 2;
    let y;
    let dy;
    while (Math.abs(y = valueFunction(x)) > tolerance) {
      dy = derivativeFunction(x);
      if (y < 0) {
        minX = x;
      } else {
        maxX = x;
      }

      // Newton's method first
      x -= y / dy;

      // Bounded to be bisection at the very least
      if (x <= minX || x >= maxX) {
        x = (minX + maxX) / 2;

        // Check to see if it's impossible to pass our tolerance
        if (x === minX || x === maxX) {
          break;
        }
      }
    }
    return x;
  }
}
densityBuoyancyCommon.register('Basin', Basin);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOdW1iZXJQcm9wZXJ0eSIsIlJhbmdlIiwib3B0aW9uaXplIiwiVGFuZGVtIiwiTnVtYmVySU8iLCJkZW5zaXR5QnVveWFuY3lDb21tb24iLCJJbnRlcnBvbGF0ZWRQcm9wZXJ0eSIsIkJhc2luIiwiY29uc3RydWN0b3IiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiaW5pdGlhbFZvbHVtZSIsImluaXRpYWxZIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJsaXF1aWRWb2x1bWVQcm9wZXJ0eSIsImNyZWF0ZVRhbmRlbSIsInBoZXRpb1JlYWRPbmx5IiwicmFuZ2UiLCJOdW1iZXIiLCJQT1NJVElWRV9JTkZJTklUWSIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJ1bml0cyIsImxpcXVpZFlJbnRlcnBvbGF0ZWRQcm9wZXJ0eSIsImludGVycG9sYXRlIiwiaW50ZXJwb2xhdGVOdW1iZXIiLCJwaGV0aW9PdXRlclR5cGUiLCJJbnRlcnBvbGF0ZWRQcm9wZXJ0eUlPIiwicGhldGlvVmFsdWVUeXBlIiwicGhldGlvSGlnaEZyZXF1ZW5jeSIsInN0ZXBCb3R0b20iLCJzdGVwVG9wIiwic3RlcE1hc3NlcyIsImNoaWxkQmFzaW4iLCJnZXREaXNwbGFjZWRBcmVhIiwieSIsImFyZWEiLCJmb3JFYWNoIiwibWFzcyIsImFzc2VydCIsImlzTmFOIiwiZ2V0RGlzcGxhY2VkVm9sdW1lIiwidm9sdW1lIiwiTWF0aCIsIm1pbiIsImdldEVtcHR5QXJlYSIsImdldE1heGltdW1BcmVhIiwiZ2V0RW1wdHlWb2x1bWUiLCJlbXB0eVZvbHVtZSIsImdldE1heGltdW1Wb2x1bWUiLCJjb21wdXRlWSIsImxpcXVpZFZvbHVtZSIsInZhbHVlIiwic2V0TmV4dFZhbHVlIiwiZmluZFJvb3QiLCJ5VGVzdCIsInJlc2V0IiwibWluWCIsIm1heFgiLCJ0b2xlcmFuY2UiLCJ2YWx1ZUZ1bmN0aW9uIiwiZGVyaXZhdGl2ZUZ1bmN0aW9uIiwieCIsImR5IiwiYWJzIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJCYXNpbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBSZXByZXNlbnRzIGEgYmFzaW4gdGhhdCBhIGxpcXVpZCBjYW4gcmVzaWRlIGluIGF0IGEgc3BlY2lmaWMgbGV2ZWwuIFRoaXMgaXMgdXNlZCBmb3IgdGhlIHBvb2wgYW5kIGxpcXVpZCBpbiB0aGUgYm9hdC5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBOdW1iZXJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL051bWJlclByb3BlcnR5LmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IE51bWJlcklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9OdW1iZXJJTy5qcyc7XHJcbmltcG9ydCBkZW5zaXR5QnVveWFuY3lDb21tb24gZnJvbSAnLi4vLi4vZGVuc2l0eUJ1b3lhbmN5Q29tbW9uLmpzJztcclxuaW1wb3J0IEludGVycG9sYXRlZFByb3BlcnR5IGZyb20gJy4vSW50ZXJwb2xhdGVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTWFzcyBmcm9tICcuL01hc3MuanMnO1xyXG5cclxuZXhwb3J0IHR5cGUgQmFzaW5PcHRpb25zID0ge1xyXG4gIGluaXRpYWxWb2x1bWU/OiBudW1iZXI7XHJcbiAgaW5pdGlhbFk/OiBudW1iZXI7XHJcbiAgdGFuZGVtPzogVGFuZGVtO1xyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgYWJzdHJhY3QgY2xhc3MgQmFzaW4ge1xyXG5cclxuICAvLyBJbiBtXjMsIHRoZSB2b2x1bWUgb2YgbGlxdWlkIGNvbnRhaW5lZCBpbiB0aGlzIGJhc2luXHJcbiAgcHVibGljIHJlYWRvbmx5IGxpcXVpZFZvbHVtZVByb3BlcnR5OiBQcm9wZXJ0eTxudW1iZXI+O1xyXG5cclxuICAvLyBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBsaXF1aWQgbGV2ZWwgKGFic29sdXRlIGluIHRoZSBtb2RlbCwgTk9UIHJlbGF0aXZlIHRvIGFueXRoaW5nKVxyXG4gIHB1YmxpYyByZWFkb25seSBsaXF1aWRZSW50ZXJwb2xhdGVkUHJvcGVydHk6IEludGVycG9sYXRlZFByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIFRoZSBib3R0b20gYW5kIHRvcCBvZiB0aGUgYmFzaW4ncyBhcmVhIG9mIGNvbnRhaW5tZW50IChhYnNvbHV0ZSBtb2RlbCBjb29yZGluYXRlcyksIHNldCBkdXJpbmcgcGh5c2ljcyBlbmdpbmUgc3RlcHMuXHJcbiAgcHVibGljIHN0ZXBCb3R0b206IG51bWJlcjtcclxuICBwdWJsaWMgc3RlcFRvcDogbnVtYmVyO1xyXG5cclxuICAvLyBUaGUgbWFzc2VzIGNvbnRhaW5lZCBpbiB0aGlzIGJhc2luLCBzZXQgZHVyaW5nIHRoZSBwaHlzaWNzIGVuZ2luZSBzdGVwcy5cclxuICBwdWJsaWMgc3RlcE1hc3NlczogTWFzc1tdO1xyXG5cclxuICAvLyBBIGJhc2luIHRoYXQgbWF5IGJlIGNvbnRhaW5lZCBpbiB0aGlzIG9uZSAoYm9hdCBiYXNpbiBpbiB0aGUgcG9vbCkgTk9URTogb25seSBvbmUgZ3VhcmFudGVlZFxyXG4gIHB1YmxpYyBjaGlsZEJhc2luOiBCYXNpbiB8IG51bGw7XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zPzogQmFzaW5PcHRpb25zICkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxCYXNpbk9wdGlvbnMsIEJhc2luT3B0aW9ucz4oKSgge1xyXG4gICAgICBpbml0aWFsVm9sdW1lOiAwLFxyXG4gICAgICBpbml0aWFsWTogMCxcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRURcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHRhbmRlbSA9IG9wdGlvbnMudGFuZGVtO1xyXG5cclxuICAgIHRoaXMubGlxdWlkVm9sdW1lUHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIG9wdGlvbnMuaW5pdGlhbFZvbHVtZSwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdsaXF1aWRWb2x1bWVQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWUsXHJcbiAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoIDAsIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSApLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnVGhlIHZvbHVtZSBvZiBsaXF1aWQgY29udGFpbmVkIGluIHRoZSBiYXNpbicsXHJcbiAgICAgIHVuaXRzOiAnbV4zJ1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubGlxdWlkWUludGVycG9sYXRlZFByb3BlcnR5ID0gbmV3IEludGVycG9sYXRlZFByb3BlcnR5KCBvcHRpb25zLmluaXRpYWxZLCB7XHJcbiAgICAgIGludGVycG9sYXRlOiBJbnRlcnBvbGF0ZWRQcm9wZXJ0eS5pbnRlcnBvbGF0ZU51bWJlcixcclxuICAgICAgcGhldGlvT3V0ZXJUeXBlOiBJbnRlcnBvbGF0ZWRQcm9wZXJ0eS5JbnRlcnBvbGF0ZWRQcm9wZXJ0eUlPLFxyXG4gICAgICBwaGV0aW9WYWx1ZVR5cGU6IE51bWJlcklPLFxyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdsaXF1aWRZSW50ZXJwb2xhdGVkUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0hpZ2hGcmVxdWVuY3k6IHRydWUsXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiB0cnVlLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnVGhlIHktdmFsdWUgb2YgdGhlIGxpcXVpZCBpbiBtb2RlbCBjb29yZGluYXRlcyAod2hlcmUgMCBpcyB0aGUgdG9wIG9mIHRoZSBwb29sKSdcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnN0ZXBCb3R0b20gPSAwO1xyXG4gICAgdGhpcy5zdGVwVG9wID0gMDtcclxuICAgIHRoaXMuc3RlcE1hc3NlcyA9IFtdO1xyXG4gICAgdGhpcy5jaGlsZEJhc2luID0gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgd2hldGhlciBhIGdpdmVuIG1hc3MgaXMgaW5zaWRlIHRoaXMgYmFzaW4gKGUuZy4gaWYgZmlsbGVkIHdpdGggbGlxdWlkLCB3b3VsZCBpdCBiZSBkaXNwbGFjaW5nIGFueVxyXG4gICAqIGxpcXVpZCkuXHJcbiAgICovXHJcbiAgcHVibGljIGFic3RyYWN0IGlzTWFzc0luc2lkZSggbWFzczogTWFzcyApOiBib29sZWFuO1xyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBtYXhpbXVtIGFyZWEgdGhhdCBjb3VsZCBiZSBjb250YWluZWQgd2l0aCBsaXF1aWQgYXQgYSBnaXZlbiB5IHZhbHVlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRNYXhpbXVtQXJlYSggeTogbnVtYmVyICk6IG51bWJlcjtcclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0aGUgbWF4aW11bSB2b2x1bWUgdGhhdCBjb3VsZCBiZSBjb250YWluZWQgd2l0aCBsaXF1aWQgdXAgdG8gYSBnaXZlbiB5IHZhbHVlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRNYXhpbXVtVm9sdW1lKCB5OiBudW1iZXIgKTogbnVtYmVyO1xyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBmaWxsZWQgYXJlYSBpbiB0aGUgYmFzaW4gKGkuZS4gdGhpbmdzIHRoYXQgYXJlbid0IGFpciBvciB3YXRlcikgYXQgdGhlIGdpdmVuIHkgdmFsdWVcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RGlzcGxhY2VkQXJlYSggeTogbnVtYmVyICk6IG51bWJlciB7XHJcbiAgICBsZXQgYXJlYSA9IDA7XHJcbiAgICB0aGlzLnN0ZXBNYXNzZXMuZm9yRWFjaCggbWFzcyA9PiB7XHJcbiAgICAgIGFyZWEgKz0gbWFzcy5nZXREaXNwbGFjZWRBcmVhKCB5ICk7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoICFpc05hTiggYXJlYSApICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gRG9uJ3QgZG91YmxlLWNvdW50IHRoaW5ncywgc2luY2Ugd2UncmUgY291bnRpbmcgdGhlIGZ1bGwgZGlzcGxhY2VtZW50IG9mIHRoZSBjaGlsZCBiYXNpbidzIGNvbnRhaW5lclxyXG4gICAgaWYgKCB0aGlzLmNoaWxkQmFzaW4gKSB7XHJcbiAgICAgIGFyZWEgLT0gdGhpcy5jaGlsZEJhc2luLmdldERpc3BsYWNlZEFyZWEoIHkgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYXJlYTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGZpbGxlZCB2b2x1bWUgaW4gdGhlIGJhc2luIChpLmUuIHRoaW5ncyB0aGF0IGFyZW4ndCBhaXIgb3Igd2F0ZXIpIHRoYXQgaXMgYmVsb3cgdGhlIGdpdmVuIHkgdmFsdWUuXHJcbiAgICovXHJcbiAgcHVibGljIGdldERpc3BsYWNlZFZvbHVtZSggeTogbnVtYmVyICk6IG51bWJlciB7XHJcbiAgICBsZXQgdm9sdW1lID0gMDtcclxuICAgIHRoaXMuc3RlcE1hc3Nlcy5mb3JFYWNoKCBtYXNzID0+IHtcclxuICAgICAgdm9sdW1lICs9IG1hc3MuZ2V0RGlzcGxhY2VkVm9sdW1lKCB5ICk7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoICFpc05hTiggdm9sdW1lICkgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzICE9PSB0aGlzLmNoaWxkQmFzaW4gKTtcclxuXHJcbiAgICAvLyBEb24ndCBkb3VibGUtY291bnQgdGhpbmdzLCBzaW5jZSB3ZSdyZSBjb3VudGluZyB0aGUgZnVsbCBkaXNwbGFjZW1lbnQgb2YgdGhlIGNoaWxkIGJhc2luJ3MgY29udGFpbmVyXHJcbiAgICBpZiAoIHRoaXMuY2hpbGRCYXNpbiApIHtcclxuICAgICAgdm9sdW1lIC09IHRoaXMuY2hpbGRCYXNpbi5nZXREaXNwbGFjZWRWb2x1bWUoIE1hdGgubWluKCB5LCB0aGlzLmNoaWxkQmFzaW4uc3RlcFRvcCApICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZvbHVtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGVtcHR5IGFyZWEgaW4gdGhlIGJhc2luIChpLmUuIGFpciwgdGhhdCBpc24ndCBhIHNvbGlkIG9iamVjdCkgYXQgdGhlIGdpdmVuIHkgdmFsdWUuXHJcbiAgICovXHJcbiAgcHVibGljIGdldEVtcHR5QXJlYSggeTogbnVtYmVyICk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRNYXhpbXVtQXJlYSggeSApIC0gdGhpcy5nZXREaXNwbGFjZWRBcmVhKCB5ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBlbXB0eSB2b2x1bWUgaW4gdGhlIGJhc2luIChpLmUuIGFpciwgdGhhdCBpc24ndCBhIHNvbGlkIG9iamVjdCkgdGhhdCBpcyBiZWxvdyB0aGUgZ2l2ZW4geSB2YWx1ZS5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW1wdHlWb2x1bWUoIHk6IG51bWJlciApOiBudW1iZXIge1xyXG4gICAgY29uc3QgZW1wdHlWb2x1bWUgPSB0aGlzLmdldE1heGltdW1Wb2x1bWUoIHkgKSAtIHRoaXMuZ2V0RGlzcGxhY2VkVm9sdW1lKCB5ICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBlbXB0eVZvbHVtZSA+PSAtMWUtMTEsICdlbXB0eSB2b2x1bWUgc2hvdWxkIGJlIG5vbi1uZWdhdGl2ZScgKTtcclxuICAgIHJldHVybiBlbXB0eVZvbHVtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXB1dGVzIHRoZSBsaXF1aWQncyB5IGNvb3JkaW5hdGUsIGdpdmVuIHRoZSBjdXJyZW50IHZvbHVtZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb21wdXRlWSgpOiB2b2lkIHtcclxuICAgIGNvbnN0IGxpcXVpZFZvbHVtZSA9IHRoaXMubGlxdWlkVm9sdW1lUHJvcGVydHkudmFsdWU7XHJcbiAgICBpZiAoIGxpcXVpZFZvbHVtZSA9PT0gMCApIHtcclxuICAgICAgdGhpcy5saXF1aWRZSW50ZXJwb2xhdGVkUHJvcGVydHkuc2V0TmV4dFZhbHVlKCB0aGlzLnN0ZXBCb3R0b20gKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGVtcHR5Vm9sdW1lID0gdGhpcy5nZXRFbXB0eVZvbHVtZSggdGhpcy5zdGVwVG9wICk7XHJcbiAgICBpZiAoIGVtcHR5Vm9sdW1lID09PSBsaXF1aWRWb2x1bWUgKSB7XHJcbiAgICAgIHRoaXMubGlxdWlkWUludGVycG9sYXRlZFByb3BlcnR5LnNldE5leHRWYWx1ZSggdGhpcy5zdGVwVG9wICk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBEdWUgdG8gc2hhcGVzIHVzZWQsIHRoZXJlIGlzIG5vIGFuYWx5dGljYWwgc29sdXRpb24uXHJcbiAgICB0aGlzLmxpcXVpZFlJbnRlcnBvbGF0ZWRQcm9wZXJ0eS5zZXROZXh0VmFsdWUoIEJhc2luLmZpbmRSb290KFxyXG4gICAgICB0aGlzLnN0ZXBCb3R0b20sXHJcbiAgICAgIHRoaXMuc3RlcFRvcCxcclxuICAgICAgMWUtNyxcclxuXHJcbiAgICAgIC8vIFdlJ3JlIGZpbmRpbmcgdGhlIHJvb3QgKHplcm8pLCBzbyB0aGF0J3Mgd2hlcmUgdGhlIGVtcHR5IHZvbHVtZSBlcXVhbHMgdGhlIGxpcXVpZCB2b2x1bWVcclxuICAgICAgeVRlc3QgPT4gdGhpcy5nZXRFbXB0eVZvbHVtZSggeVRlc3QgKSAtIGxpcXVpZFZvbHVtZSxcclxuXHJcbiAgICAgIC8vIFRoZSBkZXJpdmF0aXZlIChjaGFuZ2Ugb2Ygdm9sdW1lKSBoYXBwZW5zIHRvIGJlIHRoZSBhcmVhIGF0IHRoYXQgc2VjdGlvblxyXG4gICAgICB5VGVzdCA9PiB0aGlzLmdldEVtcHR5QXJlYSggeVRlc3QgKVxyXG4gICAgKSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIHRvIGFuIGluaXRpYWwgc3RhdGUuXHJcbiAgICovXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5saXF1aWRWb2x1bWVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5saXF1aWRZSW50ZXJwb2xhdGVkUHJvcGVydHkucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEh5YnJpZCByb290LWZpbmRpbmcgZ2l2ZW4gb3VyIGNvbnN0cmFpbnRzIChndWFyYW50ZWVkIGludGVydmFsLCB2YWx1ZS9kZXJpdmF0aXZlKS4gQ29tYmluZXMgTmV3dG9uJ3MgYW5kIGJpc2VjdGlvbi5cclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBmaW5kUm9vdCggbWluWDogbnVtYmVyLCBtYXhYOiBudW1iZXIsIHRvbGVyYW5jZTogbnVtYmVyLCB2YWx1ZUZ1bmN0aW9uOiAoIG46IG51bWJlciApID0+IG51bWJlciwgZGVyaXZhdGl2ZUZ1bmN0aW9uOiAoIG46IG51bWJlciApID0+IG51bWJlciApOiBudW1iZXIge1xyXG4gICAgbGV0IHggPSAoIG1pblggKyBtYXhYICkgLyAyO1xyXG5cclxuICAgIGxldCB5O1xyXG4gICAgbGV0IGR5O1xyXG5cclxuICAgIHdoaWxlICggTWF0aC5hYnMoIHkgPSB2YWx1ZUZ1bmN0aW9uKCB4ICkgKSA+IHRvbGVyYW5jZSApIHtcclxuICAgICAgZHkgPSBkZXJpdmF0aXZlRnVuY3Rpb24oIHggKTtcclxuXHJcbiAgICAgIGlmICggeSA8IDAgKSB7XHJcbiAgICAgICAgbWluWCA9IHg7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgbWF4WCA9IHg7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE5ld3RvbidzIG1ldGhvZCBmaXJzdFxyXG4gICAgICB4IC09IHkgLyBkeTtcclxuXHJcbiAgICAgIC8vIEJvdW5kZWQgdG8gYmUgYmlzZWN0aW9uIGF0IHRoZSB2ZXJ5IGxlYXN0XHJcbiAgICAgIGlmICggeCA8PSBtaW5YIHx8IHggPj0gbWF4WCApIHtcclxuICAgICAgICB4ID0gKCBtaW5YICsgbWF4WCApIC8gMjtcclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIGl0J3MgaW1wb3NzaWJsZSB0byBwYXNzIG91ciB0b2xlcmFuY2VcclxuICAgICAgICBpZiAoIHggPT09IG1pblggfHwgeCA9PT0gbWF4WCApIHtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB4O1xyXG4gIH1cclxufVxyXG5cclxuZGVuc2l0eUJ1b3lhbmN5Q29tbW9uLnJlZ2lzdGVyKCAnQmFzaW4nLCBCYXNpbiApO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsY0FBYyxNQUFNLHVDQUF1QztBQUVsRSxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFDN0QsT0FBT0MsTUFBTSxNQUFNLGlDQUFpQztBQUNwRCxPQUFPQyxRQUFRLE1BQU0seUNBQXlDO0FBQzlELE9BQU9DLHFCQUFxQixNQUFNLGdDQUFnQztBQUNsRSxPQUFPQyxvQkFBb0IsTUFBTSwyQkFBMkI7QUFT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