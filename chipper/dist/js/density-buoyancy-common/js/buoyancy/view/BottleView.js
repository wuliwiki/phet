// Copyright 2019-2022, University of Colorado Boulder

/**
 * The 3D view for a Bottle.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import MassView from '../../common/view/MassView.js';
import densityBuoyancyCommon from '../../densityBuoyancyCommon.js';
import Bottle from '../model/Bottle.js';
import Material from '../../common/model/Material.js';
export default class BottleView extends MassView {
  constructor(bottle) {
    const primaryGeometry = Bottle.getPrimaryGeometry();

    // @ts-expect-error
    super(bottle, new THREE.Geometry());
    const bottomClipPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 0);
    const topClipPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
    const backTopMaterial = new THREE.MeshPhongMaterial({
      color: 0xffffff,
      opacity: 0.4,
      transparent: true,
      side: THREE.BackSide,
      depthWrite: false,
      clippingPlanes: [topClipPlane]
    });
    const backTop = new THREE.Mesh(primaryGeometry, backTopMaterial);
    this.add(backTop);
    const backBottomMaterial = new THREE.MeshPhongMaterial({
      color: 0x33FF33,
      opacity: 0.8,
      transparent: true,
      side: THREE.BackSide,
      depthWrite: false,
      clippingPlanes: [bottomClipPlane]
    });
    const backBottom = new THREE.Mesh(primaryGeometry, backBottomMaterial);
    this.add(backBottom);
    const frontTopMaterial = new THREE.MeshPhongMaterial({
      color: 0xffffff,
      opacity: 0.4,
      transparent: true,
      side: THREE.FrontSide,
      depthWrite: false,
      clippingPlanes: [topClipPlane]
    });
    const frontTop = new THREE.Mesh(primaryGeometry, frontTopMaterial);
    this.add(frontTop);
    const frontBottomMaterial = new THREE.MeshPhongMaterial({
      color: 0x33FF33,
      opacity: 0.8,
      transparent: true,
      side: THREE.FrontSide,
      // depthWrite: false, // TODO: hmmm?
      clippingPlanes: [bottomClipPlane]
    });
    const frontBottom = new THREE.Mesh(primaryGeometry, frontBottomMaterial);
    this.add(frontBottom);

    // TODO: optimize
    const frontBottomForDepth = new THREE.Mesh(primaryGeometry, new THREE.MeshPhongMaterial({
      color: 0xFF0000,
      opacity: 0,
      transparent: true,
      side: THREE.FrontSide,
      clippingPlanes: [bottomClipPlane]
    }));
    this.add(frontBottomForDepth);
    const frontTopForDepth = new THREE.Mesh(primaryGeometry, new THREE.MeshPhongMaterial({
      color: 0xFF0000,
      opacity: 0,
      transparent: true,
      side: THREE.FrontSide,
      clippingPlanes: [topClipPlane]
    }));
    this.add(frontTopForDepth);
    const cap = new THREE.Mesh(Bottle.getCapGeometry(), new THREE.MeshPhongMaterial({
      color: 0xFF3333,
      side: THREE.DoubleSide
    }));
    this.add(cap);
    const crossSectionPositionArray = Bottle.createCrossSectionVertexArray();
    const crossSectionNormalArray = new Float32Array(crossSectionPositionArray.length);
    for (let i = 1; i < crossSectionNormalArray.length; i += 3) {
      crossSectionNormalArray[i] = 1; // normals should all be 0,1,0
    }

    const interiorSurfaceGeometry = new THREE.BufferGeometry();
    interiorSurfaceGeometry.addAttribute('position', new THREE.BufferAttribute(crossSectionPositionArray, 3));
    interiorSurfaceGeometry.addAttribute('normal', new THREE.BufferAttribute(crossSectionNormalArray, 3));
    const setCrossSectionRelativeY = y => {
      Bottle.fillCrossSectionVertexArray(y, crossSectionPositionArray);
      interiorSurfaceGeometry.attributes.position.needsUpdate = true;
      interiorSurfaceGeometry.computeBoundingSphere();
    };
    // TODO: unlink
    bottle.interiorVolumeProperty.link(volume => {
      setCrossSectionRelativeY(Bottle.getYFromVolume(volume));
    });

    // TODO: unlink
    const adjustClipPlanes = () => {
      const modelY = bottle.matrix.translation.y + Bottle.getYFromVolume(bottle.interiorVolumeProperty.value);
      bottomClipPlane.constant = modelY;
      topClipPlane.constant = -modelY;
    };
    bottle.transformedEmitter.addListener(adjustClipPlanes);
    bottle.interiorVolumeProperty.lazyLink(adjustClipPlanes);
    adjustClipPlanes();
    const interiorSurfaceMaterial = new THREE.MeshPhongMaterial({
      color: 0x33FF33,
      opacity: 0.8,
      transparent: true,
      depthWrite: false,
      side: THREE.DoubleSide
    });
    const interiorSurface = new THREE.Mesh(interiorSurfaceGeometry, interiorSurfaceMaterial);
    this.add(interiorSurface);

    // Set render order for all elements
    [frontTopForDepth, frontTop, interiorSurface, frontBottomForDepth, frontBottom, backBottom, backTop].forEach((view, index) => {
      view.renderOrder = -(index + 1);
    });
    Material.linkLiquidColor(bottle.interiorMaterialProperty, interiorSurfaceMaterial);
    Material.linkLiquidColor(bottle.interiorMaterialProperty, backBottomMaterial);
    Material.linkLiquidColor(bottle.interiorMaterialProperty, frontBottomMaterial);
    this.bottle = bottle;
  }

  /**
   * Releases references.
   */
  dispose() {
    // TODO: dispose everything from above

    super.dispose();
  }
}
densityBuoyancyCommon.register('BottleView', BottleView);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNYXNzVmlldyIsImRlbnNpdHlCdW95YW5jeUNvbW1vbiIsIkJvdHRsZSIsIk1hdGVyaWFsIiwiQm90dGxlVmlldyIsImNvbnN0cnVjdG9yIiwiYm90dGxlIiwicHJpbWFyeUdlb21ldHJ5IiwiZ2V0UHJpbWFyeUdlb21ldHJ5IiwiVEhSRUUiLCJHZW9tZXRyeSIsImJvdHRvbUNsaXBQbGFuZSIsIlBsYW5lIiwiVmVjdG9yMyIsInRvcENsaXBQbGFuZSIsImJhY2tUb3BNYXRlcmlhbCIsIk1lc2hQaG9uZ01hdGVyaWFsIiwiY29sb3IiLCJvcGFjaXR5IiwidHJhbnNwYXJlbnQiLCJzaWRlIiwiQmFja1NpZGUiLCJkZXB0aFdyaXRlIiwiY2xpcHBpbmdQbGFuZXMiLCJiYWNrVG9wIiwiTWVzaCIsImFkZCIsImJhY2tCb3R0b21NYXRlcmlhbCIsImJhY2tCb3R0b20iLCJmcm9udFRvcE1hdGVyaWFsIiwiRnJvbnRTaWRlIiwiZnJvbnRUb3AiLCJmcm9udEJvdHRvbU1hdGVyaWFsIiwiZnJvbnRCb3R0b20iLCJmcm9udEJvdHRvbUZvckRlcHRoIiwiZnJvbnRUb3BGb3JEZXB0aCIsImNhcCIsImdldENhcEdlb21ldHJ5IiwiRG91YmxlU2lkZSIsImNyb3NzU2VjdGlvblBvc2l0aW9uQXJyYXkiLCJjcmVhdGVDcm9zc1NlY3Rpb25WZXJ0ZXhBcnJheSIsImNyb3NzU2VjdGlvbk5vcm1hbEFycmF5IiwiRmxvYXQzMkFycmF5IiwibGVuZ3RoIiwiaSIsImludGVyaW9yU3VyZmFjZUdlb21ldHJ5IiwiQnVmZmVyR2VvbWV0cnkiLCJhZGRBdHRyaWJ1dGUiLCJCdWZmZXJBdHRyaWJ1dGUiLCJzZXRDcm9zc1NlY3Rpb25SZWxhdGl2ZVkiLCJ5IiwiZmlsbENyb3NzU2VjdGlvblZlcnRleEFycmF5IiwiYXR0cmlidXRlcyIsInBvc2l0aW9uIiwibmVlZHNVcGRhdGUiLCJjb21wdXRlQm91bmRpbmdTcGhlcmUiLCJpbnRlcmlvclZvbHVtZVByb3BlcnR5IiwibGluayIsInZvbHVtZSIsImdldFlGcm9tVm9sdW1lIiwiYWRqdXN0Q2xpcFBsYW5lcyIsIm1vZGVsWSIsIm1hdHJpeCIsInRyYW5zbGF0aW9uIiwidmFsdWUiLCJjb25zdGFudCIsInRyYW5zZm9ybWVkRW1pdHRlciIsImFkZExpc3RlbmVyIiwibGF6eUxpbmsiLCJpbnRlcmlvclN1cmZhY2VNYXRlcmlhbCIsImludGVyaW9yU3VyZmFjZSIsImZvckVhY2giLCJ2aWV3IiwiaW5kZXgiLCJyZW5kZXJPcmRlciIsImxpbmtMaXF1aWRDb2xvciIsImludGVyaW9yTWF0ZXJpYWxQcm9wZXJ0eSIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJvdHRsZVZpZXcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVGhlIDNEIHZpZXcgZm9yIGEgQm90dGxlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IE1hc3NWaWV3IGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L01hc3NWaWV3LmpzJztcclxuaW1wb3J0IGRlbnNpdHlCdW95YW5jeUNvbW1vbiBmcm9tICcuLi8uLi9kZW5zaXR5QnVveWFuY3lDb21tb24uanMnO1xyXG5pbXBvcnQgQm90dGxlIGZyb20gJy4uL21vZGVsL0JvdHRsZS5qcyc7XHJcbmltcG9ydCBNYXRlcmlhbCBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvTWF0ZXJpYWwuanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQm90dGxlVmlldyBleHRlbmRzIE1hc3NWaWV3IHtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGJvdHRsZTogQm90dGxlO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGJvdHRsZTogQm90dGxlICkge1xyXG5cclxuICAgIGNvbnN0IHByaW1hcnlHZW9tZXRyeSA9IEJvdHRsZS5nZXRQcmltYXJ5R2VvbWV0cnkoKTtcclxuXHJcbiAgICAvLyBAdHMtZXhwZWN0LWVycm9yXHJcbiAgICBzdXBlciggYm90dGxlLCBuZXcgVEhSRUUuR2VvbWV0cnkoKSApO1xyXG5cclxuICAgIGNvbnN0IGJvdHRvbUNsaXBQbGFuZSA9IG5ldyBUSFJFRS5QbGFuZSggbmV3IFRIUkVFLlZlY3RvcjMoIDAsIC0xLCAwICksIDAgKTtcclxuICAgIGNvbnN0IHRvcENsaXBQbGFuZSA9IG5ldyBUSFJFRS5QbGFuZSggbmV3IFRIUkVFLlZlY3RvcjMoIDAsIDEsIDAgKSwgMCApO1xyXG5cclxuICAgIGNvbnN0IGJhY2tUb3BNYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCgge1xyXG4gICAgICBjb2xvcjogMHhmZmZmZmYsXHJcbiAgICAgIG9wYWNpdHk6IDAuNCxcclxuICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsXHJcbiAgICAgIHNpZGU6IFRIUkVFLkJhY2tTaWRlLFxyXG4gICAgICBkZXB0aFdyaXRlOiBmYWxzZSxcclxuICAgICAgY2xpcHBpbmdQbGFuZXM6IFsgdG9wQ2xpcFBsYW5lIF1cclxuICAgIH0gKTtcclxuICAgIGNvbnN0IGJhY2tUb3AgPSBuZXcgVEhSRUUuTWVzaCggcHJpbWFyeUdlb21ldHJ5LCBiYWNrVG9wTWF0ZXJpYWwgKTtcclxuICAgIHRoaXMuYWRkKCBiYWNrVG9wICk7XHJcblxyXG4gICAgY29uc3QgYmFja0JvdHRvbU1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKCB7XHJcbiAgICAgIGNvbG9yOiAweDMzRkYzMyxcclxuICAgICAgb3BhY2l0eTogMC44LFxyXG4gICAgICB0cmFuc3BhcmVudDogdHJ1ZSxcclxuICAgICAgc2lkZTogVEhSRUUuQmFja1NpZGUsXHJcbiAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLFxyXG4gICAgICBjbGlwcGluZ1BsYW5lczogWyBib3R0b21DbGlwUGxhbmUgXVxyXG4gICAgfSApO1xyXG4gICAgY29uc3QgYmFja0JvdHRvbSA9IG5ldyBUSFJFRS5NZXNoKCBwcmltYXJ5R2VvbWV0cnksIGJhY2tCb3R0b21NYXRlcmlhbCApO1xyXG4gICAgdGhpcy5hZGQoIGJhY2tCb3R0b20gKTtcclxuXHJcbiAgICBjb25zdCBmcm9udFRvcE1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKCB7XHJcbiAgICAgIGNvbG9yOiAweGZmZmZmZixcclxuICAgICAgb3BhY2l0eTogMC40LFxyXG4gICAgICB0cmFuc3BhcmVudDogdHJ1ZSxcclxuICAgICAgc2lkZTogVEhSRUUuRnJvbnRTaWRlLFxyXG4gICAgICBkZXB0aFdyaXRlOiBmYWxzZSxcclxuICAgICAgY2xpcHBpbmdQbGFuZXM6IFsgdG9wQ2xpcFBsYW5lIF1cclxuICAgIH0gKTtcclxuICAgIGNvbnN0IGZyb250VG9wID0gbmV3IFRIUkVFLk1lc2goIHByaW1hcnlHZW9tZXRyeSwgZnJvbnRUb3BNYXRlcmlhbCApO1xyXG4gICAgdGhpcy5hZGQoIGZyb250VG9wICk7XHJcblxyXG4gICAgY29uc3QgZnJvbnRCb3R0b21NYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCgge1xyXG4gICAgICBjb2xvcjogMHgzM0ZGMzMsXHJcbiAgICAgIG9wYWNpdHk6IDAuOCxcclxuICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsXHJcbiAgICAgIHNpZGU6IFRIUkVFLkZyb250U2lkZSxcclxuICAgICAgLy8gZGVwdGhXcml0ZTogZmFsc2UsIC8vIFRPRE86IGhtbW0/XHJcbiAgICAgIGNsaXBwaW5nUGxhbmVzOiBbIGJvdHRvbUNsaXBQbGFuZSBdXHJcbiAgICB9ICk7XHJcbiAgICBjb25zdCBmcm9udEJvdHRvbSA9IG5ldyBUSFJFRS5NZXNoKCBwcmltYXJ5R2VvbWV0cnksIGZyb250Qm90dG9tTWF0ZXJpYWwgKTtcclxuICAgIHRoaXMuYWRkKCBmcm9udEJvdHRvbSApO1xyXG5cclxuICAgIC8vIFRPRE86IG9wdGltaXplXHJcbiAgICBjb25zdCBmcm9udEJvdHRvbUZvckRlcHRoID0gbmV3IFRIUkVFLk1lc2goIHByaW1hcnlHZW9tZXRyeSwgbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKCB7XHJcbiAgICAgIGNvbG9yOiAweEZGMDAwMCxcclxuICAgICAgb3BhY2l0eTogMCxcclxuICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsXHJcbiAgICAgIHNpZGU6IFRIUkVFLkZyb250U2lkZSxcclxuICAgICAgY2xpcHBpbmdQbGFuZXM6IFsgYm90dG9tQ2xpcFBsYW5lIF1cclxuICAgIH0gKSApO1xyXG4gICAgdGhpcy5hZGQoIGZyb250Qm90dG9tRm9yRGVwdGggKTtcclxuXHJcbiAgICBjb25zdCBmcm9udFRvcEZvckRlcHRoID0gbmV3IFRIUkVFLk1lc2goIHByaW1hcnlHZW9tZXRyeSwgbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKCB7XHJcbiAgICAgIGNvbG9yOiAweEZGMDAwMCxcclxuICAgICAgb3BhY2l0eTogMCxcclxuICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsXHJcbiAgICAgIHNpZGU6IFRIUkVFLkZyb250U2lkZSxcclxuICAgICAgY2xpcHBpbmdQbGFuZXM6IFsgdG9wQ2xpcFBsYW5lIF1cclxuICAgIH0gKSApO1xyXG4gICAgdGhpcy5hZGQoIGZyb250VG9wRm9yRGVwdGggKTtcclxuXHJcbiAgICBjb25zdCBjYXAgPSBuZXcgVEhSRUUuTWVzaCggQm90dGxlLmdldENhcEdlb21ldHJ5KCksIG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCgge1xyXG4gICAgICBjb2xvcjogMHhGRjMzMzMsXHJcbiAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGVcclxuICAgIH0gKSApO1xyXG4gICAgdGhpcy5hZGQoIGNhcCApO1xyXG5cclxuICAgIGNvbnN0IGNyb3NzU2VjdGlvblBvc2l0aW9uQXJyYXkgPSBCb3R0bGUuY3JlYXRlQ3Jvc3NTZWN0aW9uVmVydGV4QXJyYXkoKTtcclxuICAgIGNvbnN0IGNyb3NzU2VjdGlvbk5vcm1hbEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSggY3Jvc3NTZWN0aW9uUG9zaXRpb25BcnJheS5sZW5ndGggKTtcclxuICAgIGZvciAoIGxldCBpID0gMTsgaSA8IGNyb3NzU2VjdGlvbk5vcm1hbEFycmF5Lmxlbmd0aDsgaSArPSAzICkge1xyXG4gICAgICBjcm9zc1NlY3Rpb25Ob3JtYWxBcnJheVsgaSBdID0gMTsgLy8gbm9ybWFscyBzaG91bGQgYWxsIGJlIDAsMSwwXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaW50ZXJpb3JTdXJmYWNlR2VvbWV0cnkgPSBuZXcgVEhSRUUuQnVmZmVyR2VvbWV0cnkoKTtcclxuICAgIGludGVyaW9yU3VyZmFjZUdlb21ldHJ5LmFkZEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZSggY3Jvc3NTZWN0aW9uUG9zaXRpb25BcnJheSwgMyApICk7XHJcbiAgICBpbnRlcmlvclN1cmZhY2VHZW9tZXRyeS5hZGRBdHRyaWJ1dGUoICdub3JtYWwnLCBuZXcgVEhSRUUuQnVmZmVyQXR0cmlidXRlKCBjcm9zc1NlY3Rpb25Ob3JtYWxBcnJheSwgMyApICk7XHJcblxyXG4gICAgY29uc3Qgc2V0Q3Jvc3NTZWN0aW9uUmVsYXRpdmVZID0gKCB5OiBudW1iZXIgKSA9PiB7XHJcbiAgICAgIEJvdHRsZS5maWxsQ3Jvc3NTZWN0aW9uVmVydGV4QXJyYXkoIHksIGNyb3NzU2VjdGlvblBvc2l0aW9uQXJyYXkgKTtcclxuICAgICAgaW50ZXJpb3JTdXJmYWNlR2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5uZWVkc1VwZGF0ZSA9IHRydWU7XHJcbiAgICAgIGludGVyaW9yU3VyZmFjZUdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpO1xyXG4gICAgfTtcclxuICAgIC8vIFRPRE86IHVubGlua1xyXG4gICAgYm90dGxlLmludGVyaW9yVm9sdW1lUHJvcGVydHkubGluayggdm9sdW1lID0+IHtcclxuICAgICAgc2V0Q3Jvc3NTZWN0aW9uUmVsYXRpdmVZKCBCb3R0bGUuZ2V0WUZyb21Wb2x1bWUoIHZvbHVtZSApICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVE9ETzogdW5saW5rXHJcbiAgICBjb25zdCBhZGp1c3RDbGlwUGxhbmVzID0gKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2RlbFkgPSBib3R0bGUubWF0cml4LnRyYW5zbGF0aW9uLnkgKyBCb3R0bGUuZ2V0WUZyb21Wb2x1bWUoIGJvdHRsZS5pbnRlcmlvclZvbHVtZVByb3BlcnR5LnZhbHVlICk7XHJcblxyXG4gICAgICBib3R0b21DbGlwUGxhbmUuY29uc3RhbnQgPSBtb2RlbFk7XHJcbiAgICAgIHRvcENsaXBQbGFuZS5jb25zdGFudCA9IC1tb2RlbFk7XHJcbiAgICB9O1xyXG4gICAgYm90dGxlLnRyYW5zZm9ybWVkRW1pdHRlci5hZGRMaXN0ZW5lciggYWRqdXN0Q2xpcFBsYW5lcyApO1xyXG4gICAgYm90dGxlLmludGVyaW9yVm9sdW1lUHJvcGVydHkubGF6eUxpbmsoIGFkanVzdENsaXBQbGFuZXMgKTtcclxuICAgIGFkanVzdENsaXBQbGFuZXMoKTtcclxuXHJcbiAgICBjb25zdCBpbnRlcmlvclN1cmZhY2VNYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCgge1xyXG4gICAgICBjb2xvcjogMHgzM0ZGMzMsXHJcbiAgICAgIG9wYWNpdHk6IDAuOCxcclxuICAgICAgdHJhbnNwYXJlbnQ6IHRydWUsXHJcbiAgICAgIGRlcHRoV3JpdGU6IGZhbHNlLFxyXG4gICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlXHJcbiAgICB9ICk7XHJcbiAgICBjb25zdCBpbnRlcmlvclN1cmZhY2UgPSBuZXcgVEhSRUUuTWVzaCggaW50ZXJpb3JTdXJmYWNlR2VvbWV0cnksIGludGVyaW9yU3VyZmFjZU1hdGVyaWFsICk7XHJcblxyXG4gICAgdGhpcy5hZGQoIGludGVyaW9yU3VyZmFjZSApO1xyXG5cclxuICAgIC8vIFNldCByZW5kZXIgb3JkZXIgZm9yIGFsbCBlbGVtZW50c1xyXG4gICAgW1xyXG4gICAgICBmcm9udFRvcEZvckRlcHRoLFxyXG4gICAgICBmcm9udFRvcCxcclxuICAgICAgaW50ZXJpb3JTdXJmYWNlLFxyXG4gICAgICBmcm9udEJvdHRvbUZvckRlcHRoLFxyXG4gICAgICBmcm9udEJvdHRvbSxcclxuICAgICAgYmFja0JvdHRvbSxcclxuICAgICAgYmFja1RvcFxyXG4gICAgXS5mb3JFYWNoKCAoIHZpZXcsIGluZGV4ICkgPT4ge1xyXG4gICAgICB2aWV3LnJlbmRlck9yZGVyID0gLSggaW5kZXggKyAxICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgTWF0ZXJpYWwubGlua0xpcXVpZENvbG9yKCBib3R0bGUuaW50ZXJpb3JNYXRlcmlhbFByb3BlcnR5LCBpbnRlcmlvclN1cmZhY2VNYXRlcmlhbCApO1xyXG4gICAgTWF0ZXJpYWwubGlua0xpcXVpZENvbG9yKCBib3R0bGUuaW50ZXJpb3JNYXRlcmlhbFByb3BlcnR5LCBiYWNrQm90dG9tTWF0ZXJpYWwgKTtcclxuICAgIE1hdGVyaWFsLmxpbmtMaXF1aWRDb2xvciggYm90dGxlLmludGVyaW9yTWF0ZXJpYWxQcm9wZXJ0eSwgZnJvbnRCb3R0b21NYXRlcmlhbCApO1xyXG5cclxuICAgIHRoaXMuYm90dGxlID0gYm90dGxlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVsZWFzZXMgcmVmZXJlbmNlcy5cclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIC8vIFRPRE86IGRpc3Bvc2UgZXZlcnl0aGluZyBmcm9tIGFib3ZlXHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuZGVuc2l0eUJ1b3lhbmN5Q29tbW9uLnJlZ2lzdGVyKCAnQm90dGxlVmlldycsIEJvdHRsZVZpZXcgKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNB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