// Copyright 2018-2023, University of Colorado Boulder

/**
 * FocusManipulator is the manipulator for editing a quadratic (parabola) by changing its focus.
 * It displays the coordinates of the focus.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { DragListener } from '../../../../scenery/js/imports.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import GQColors from '../../common/GQColors.js';
import GQConstants from '../../common/GQConstants.js';
import GQManipulator from '../../common/view/GQManipulator.js';
import graphingQuadratics from '../../graphingQuadratics.js';
import optionize, { combineOptions } from '../../../../phet-core/js/optionize.js';
// constants
const COORDINATES_Y_SPACING = 1;
export default class FocusManipulator extends GQManipulator {
  /**
   * @param pProperty - p coefficient of alternate vertex form
   * @param quadraticProperty - the interactive quadratic
   * @param graph
   * @param modelViewTransform
   * @param focusVisibleProperty
   * @param coordinatesVisibleProperty
   * @param [providedOptions]
   */
  constructor(pProperty, quadraticProperty, graph, modelViewTransform, focusVisibleProperty, coordinatesVisibleProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      interval: GQConstants.FOCUS_AND_DIRECTRIX_INTERVAL_P,
      // GQManipulatorOptions
      radius: modelViewTransform.modelToViewDeltaX(GQConstants.MANIPULATOR_RADIUS),
      color: GQColors.FOCUS,
      coordinatesForegroundColor: 'white',
      coordinatesBackgroundColor: GQColors.FOCUS,
      coordinatesDecimals: GQConstants.FOCUS_DECIMALS,
      phetioDocumentation: 'manipulator for the focus'
    }, providedOptions);

    // position coordinates based on which way the parabola opens
    assert && assert(!options.layoutCoordinates, 'FocusManipulator sets layoutCoordinates');
    options.layoutCoordinates = (coordinates, coordinatesNode, radius) => {
      assert && assert(coordinates, 'expected coordinates');
      coordinatesNode.centerX = 0;
      const yOffset = radius + COORDINATES_Y_SPACING;
      if (quadraticProperty.value.a > 0) {
        coordinatesNode.bottom = -yOffset;
      } else {
        coordinatesNode.top = yOffset;
      }
    };

    // coordinates correspond to the quadratic's focus
    const coordinatesProperty = new DerivedProperty([quadraticProperty], quadratic => quadratic.focus || null, {
      valueType: Vector2,
      tandem: options.tandem.createTandem('coordinatesProperty'),
      phetioValueType: Vector2.Vector2IO,
      phetioDocumentation: 'coordinates displayed on the focus manipulator'
    });

    // visibility of this Node
    assert && assert(!options.visibleProperty, 'FocusManipulator sets visibleProperty');
    options.visibleProperty = new DerivedProperty([focusVisibleProperty, quadraticProperty], (focusVisible, quadratic) => focusVisible &&
    // the Focus checkbox is checked
    quadratic.focus !== undefined &&
    // the quadratic has a focus
    graph.contains(quadratic.focus),
    // the focus is on the graph
    {
      tandem: options.tandem.createTandem('visibleProperty'),
      phetioValueType: BooleanIO
    });
    super(coordinatesProperty, coordinatesVisibleProperty, options);

    // add the drag listener
    this.addInputListener(new FocusDragListener(this, pProperty, quadraticProperty, graph.yRange, modelViewTransform, options.interval, {
      tandem: options.tandem.createTandem('dragListener')
    }));

    // move the manipulator
    quadraticProperty.link(quadratic => {
      const focus = quadratic.focus;
      assert && assert(focus, `expected focus: ${quadratic.focus}`);
      this.translation = modelViewTransform.modelToViewPosition(focus);
    });
    options.visibleProperty.link(visible => {
      this.interruptSubtreeInput(); // cancel any drag that is in progress
    });
  }
}

class FocusDragListener extends DragListener {
  /**
   * @param targetNode - the Node that we attached this listener to
   * @param pProperty - p coefficient of alternate vertex form
   * @param quadraticProperty - the interactive quadratic
   * @param yRange - range of the graph's y-axis
   * @param modelViewTransform
   * @param interval - dragging this manipulator changes p to be a multiple of this value, in model coordinate frame
   * @param [providedOptions]
   */
  constructor(targetNode, pProperty, quadraticProperty, yRange, modelViewTransform, interval, providedOptions) {
    assert && assert(pProperty.range, 'pProperty is missing range');
    let startOffset; // where the drag started, relative to the manipulator

    const options = combineOptions({
      allowTouchSnag: true,
      // note where the drag started
      start: (event, listener) => {
        const focus = quadraticProperty.value.focus;
        assert && assert(focus, `expected focus: ${focus}`);
        const position = modelViewTransform.modelToViewPosition(focus);
        startOffset = targetNode.globalToParentPoint(event.pointer.point).minus(position);
      },
      drag: (event, listener) => {
        const vertex = quadraticProperty.value.vertex;
        assert && assert(vertex, `expected vertex: ${vertex}`);

        // transform the drag point from view to model coordinate frame
        const parentPoint = targetNode.globalToParentPoint(event.pointer.point).minus(startOffset);
        const position = modelViewTransform.viewToModelPosition(parentPoint);

        // constrain to the graph
        const y = yRange.constrainValue(position.y);

        // constrain and round
        let p = pProperty.range.constrainValue(y - vertex.y);
        p = Utils.roundToInterval(p, interval);

        // skip over p === 0
        if (p === 0) {
          p = pProperty.value > 0 ? interval : -interval;
        }
        assert && assert(p !== 0, 'p=0 is not supported');
        pProperty.value = p;
      }
    }, providedOptions);
    super(options);
  }
}
graphingQuadratics.register('FocusManipulator', FocusManipulator);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJVdGlscyIsIlZlY3RvcjIiLCJEcmFnTGlzdGVuZXIiLCJCb29sZWFuSU8iLCJHUUNvbG9ycyIsIkdRQ29uc3RhbnRzIiwiR1FNYW5pcHVsYXRvciIsImdyYXBoaW5nUXVhZHJhdGljcyIsIm9wdGlvbml6ZSIsImNvbWJpbmVPcHRpb25zIiwiQ09PUkRJTkFURVNfWV9TUEFDSU5HIiwiRm9jdXNNYW5pcHVsYXRvciIsImNvbnN0cnVjdG9yIiwicFByb3BlcnR5IiwicXVhZHJhdGljUHJvcGVydHkiLCJncmFwaCIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImZvY3VzVmlzaWJsZVByb3BlcnR5IiwiY29vcmRpbmF0ZXNWaXNpYmxlUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiaW50ZXJ2YWwiLCJGT0NVU19BTkRfRElSRUNUUklYX0lOVEVSVkFMX1AiLCJyYWRpdXMiLCJtb2RlbFRvVmlld0RlbHRhWCIsIk1BTklQVUxBVE9SX1JBRElVUyIsImNvbG9yIiwiRk9DVVMiLCJjb29yZGluYXRlc0ZvcmVncm91bmRDb2xvciIsImNvb3JkaW5hdGVzQmFja2dyb3VuZENvbG9yIiwiY29vcmRpbmF0ZXNEZWNpbWFscyIsIkZPQ1VTX0RFQ0lNQUxTIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImFzc2VydCIsImxheW91dENvb3JkaW5hdGVzIiwiY29vcmRpbmF0ZXMiLCJjb29yZGluYXRlc05vZGUiLCJjZW50ZXJYIiwieU9mZnNldCIsInZhbHVlIiwiYSIsImJvdHRvbSIsInRvcCIsImNvb3JkaW5hdGVzUHJvcGVydHkiLCJxdWFkcmF0aWMiLCJmb2N1cyIsInZhbHVlVHlwZSIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsInBoZXRpb1ZhbHVlVHlwZSIsIlZlY3RvcjJJTyIsInZpc2libGVQcm9wZXJ0eSIsImZvY3VzVmlzaWJsZSIsInVuZGVmaW5lZCIsImNvbnRhaW5zIiwiYWRkSW5wdXRMaXN0ZW5lciIsIkZvY3VzRHJhZ0xpc3RlbmVyIiwieVJhbmdlIiwibGluayIsInRyYW5zbGF0aW9uIiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsInZpc2libGUiLCJpbnRlcnJ1cHRTdWJ0cmVlSW5wdXQiLCJ0YXJnZXROb2RlIiwicmFuZ2UiLCJzdGFydE9mZnNldCIsImFsbG93VG91Y2hTbmFnIiwic3RhcnQiLCJldmVudCIsImxpc3RlbmVyIiwicG9zaXRpb24iLCJnbG9iYWxUb1BhcmVudFBvaW50IiwicG9pbnRlciIsInBvaW50IiwibWludXMiLCJkcmFnIiwidmVydGV4IiwicGFyZW50UG9pbnQiLCJ2aWV3VG9Nb2RlbFBvc2l0aW9uIiwieSIsImNvbnN0cmFpblZhbHVlIiwicCIsInJvdW5kVG9JbnRlcnZhbCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRm9jdXNNYW5pcHVsYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBGb2N1c01hbmlwdWxhdG9yIGlzIHRoZSBtYW5pcHVsYXRvciBmb3IgZWRpdGluZyBhIHF1YWRyYXRpYyAocGFyYWJvbGEpIGJ5IGNoYW5naW5nIGl0cyBmb2N1cy5cclxuICogSXQgZGlzcGxheXMgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBmb2N1cy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCB7IERyYWdMaXN0ZW5lciwgRHJhZ0xpc3RlbmVyT3B0aW9ucywgTm9kZSwgUHJlc3NlZERyYWdMaXN0ZW5lciB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBCb29sZWFuSU8gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0Jvb2xlYW5JTy5qcyc7XHJcbmltcG9ydCBHUUNvbG9ycyBmcm9tICcuLi8uLi9jb21tb24vR1FDb2xvcnMuanMnO1xyXG5pbXBvcnQgR1FDb25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0dRQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IEdRTWFuaXB1bGF0b3IsIHsgR1FNYW5pcHVsYXRvck9wdGlvbnMgfSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9HUU1hbmlwdWxhdG9yLmpzJztcclxuaW1wb3J0IGdyYXBoaW5nUXVhZHJhdGljcyBmcm9tICcuLi8uLi9ncmFwaGluZ1F1YWRyYXRpY3MuanMnO1xyXG5pbXBvcnQgUXVhZHJhdGljIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9RdWFkcmF0aWMuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBTdHJpY3RPbWl0IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9TdHJpY3RPbWl0LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBjb21iaW5lT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgR3JhcGggZnJvbSAnLi4vLi4vLi4vLi4vZ3JhcGhpbmctbGluZXMvanMvY29tbW9uL21vZGVsL0dyYXBoLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgQ09PUkRJTkFURVNfWV9TUEFDSU5HID0gMTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIGRyYWdnaW5nIHRoaXMgbWFuaXB1bGF0b3IgY2hhbmdlcyBwIHRvIGJlIGEgbXVsdGlwbGUgb2YgdGhpcyB2YWx1ZSwgaW4gbW9kZWwgY29vcmRpbmF0ZSBmcmFtZVxyXG4gIGludGVydmFsPzogbnVtYmVyO1xyXG59O1xyXG5cclxudHlwZSBGb2N1c01hbmlwdWxhdG9yT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgU3RyaWN0T21pdDxHUU1hbmlwdWxhdG9yT3B0aW9ucywgJ2xheW91dENvb3JkaW5hdGVzJz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBGb2N1c01hbmlwdWxhdG9yIGV4dGVuZHMgR1FNYW5pcHVsYXRvciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBwUHJvcGVydHkgLSBwIGNvZWZmaWNpZW50IG9mIGFsdGVybmF0ZSB2ZXJ0ZXggZm9ybVxyXG4gICAqIEBwYXJhbSBxdWFkcmF0aWNQcm9wZXJ0eSAtIHRoZSBpbnRlcmFjdGl2ZSBxdWFkcmF0aWNcclxuICAgKiBAcGFyYW0gZ3JhcGhcclxuICAgKiBAcGFyYW0gbW9kZWxWaWV3VHJhbnNmb3JtXHJcbiAgICogQHBhcmFtIGZvY3VzVmlzaWJsZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIGNvb3JkaW5hdGVzVmlzaWJsZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwUHJvcGVydHk6IE51bWJlclByb3BlcnR5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgcXVhZHJhdGljUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFF1YWRyYXRpYz4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBncmFwaDogR3JhcGgsXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBmb2N1c1Zpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBjb29yZGluYXRlc1Zpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IEZvY3VzTWFuaXB1bGF0b3JPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8Rm9jdXNNYW5pcHVsYXRvck9wdGlvbnMsIFNlbGZPcHRpb25zLCBHUU1hbmlwdWxhdG9yT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgaW50ZXJ2YWw6IEdRQ29uc3RhbnRzLkZPQ1VTX0FORF9ESVJFQ1RSSVhfSU5URVJWQUxfUCxcclxuXHJcbiAgICAgIC8vIEdRTWFuaXB1bGF0b3JPcHRpb25zXHJcbiAgICAgIHJhZGl1czogbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFYKCBHUUNvbnN0YW50cy5NQU5JUFVMQVRPUl9SQURJVVMgKSxcclxuICAgICAgY29sb3I6IEdRQ29sb3JzLkZPQ1VTLFxyXG4gICAgICBjb29yZGluYXRlc0ZvcmVncm91bmRDb2xvcjogJ3doaXRlJyxcclxuICAgICAgY29vcmRpbmF0ZXNCYWNrZ3JvdW5kQ29sb3I6IEdRQ29sb3JzLkZPQ1VTLFxyXG4gICAgICBjb29yZGluYXRlc0RlY2ltYWxzOiBHUUNvbnN0YW50cy5GT0NVU19ERUNJTUFMUyxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ21hbmlwdWxhdG9yIGZvciB0aGUgZm9jdXMnXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBwb3NpdGlvbiBjb29yZGluYXRlcyBiYXNlZCBvbiB3aGljaCB3YXkgdGhlIHBhcmFib2xhIG9wZW5zXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhb3B0aW9ucy5sYXlvdXRDb29yZGluYXRlcywgJ0ZvY3VzTWFuaXB1bGF0b3Igc2V0cyBsYXlvdXRDb29yZGluYXRlcycgKTtcclxuICAgIG9wdGlvbnMubGF5b3V0Q29vcmRpbmF0ZXMgPSAoIGNvb3JkaW5hdGVzLCBjb29yZGluYXRlc05vZGUsIHJhZGl1cyApID0+IHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggY29vcmRpbmF0ZXMsICdleHBlY3RlZCBjb29yZGluYXRlcycgKTtcclxuICAgICAgY29vcmRpbmF0ZXNOb2RlLmNlbnRlclggPSAwO1xyXG4gICAgICBjb25zdCB5T2Zmc2V0ID0gcmFkaXVzICsgQ09PUkRJTkFURVNfWV9TUEFDSU5HO1xyXG4gICAgICBpZiAoIHF1YWRyYXRpY1Byb3BlcnR5LnZhbHVlLmEgPiAwICkge1xyXG4gICAgICAgIGNvb3JkaW5hdGVzTm9kZS5ib3R0b20gPSAteU9mZnNldDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBjb29yZGluYXRlc05vZGUudG9wID0geU9mZnNldDtcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBjb29yZGluYXRlcyBjb3JyZXNwb25kIHRvIHRoZSBxdWFkcmF0aWMncyBmb2N1c1xyXG4gICAgY29uc3QgY29vcmRpbmF0ZXNQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgcXVhZHJhdGljUHJvcGVydHkgXSxcclxuICAgICAgcXVhZHJhdGljID0+IHF1YWRyYXRpYy5mb2N1cyB8fCBudWxsLCB7XHJcbiAgICAgICAgdmFsdWVUeXBlOiBWZWN0b3IyLFxyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnY29vcmRpbmF0ZXNQcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IFZlY3RvcjIuVmVjdG9yMklPLFxyXG4gICAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdjb29yZGluYXRlcyBkaXNwbGF5ZWQgb24gdGhlIGZvY3VzIG1hbmlwdWxhdG9yJ1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgLy8gdmlzaWJpbGl0eSBvZiB0aGlzIE5vZGVcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICFvcHRpb25zLnZpc2libGVQcm9wZXJ0eSwgJ0ZvY3VzTWFuaXB1bGF0b3Igc2V0cyB2aXNpYmxlUHJvcGVydHknICk7XHJcbiAgICBvcHRpb25zLnZpc2libGVQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgZm9jdXNWaXNpYmxlUHJvcGVydHksIHF1YWRyYXRpY1Byb3BlcnR5IF0sXHJcbiAgICAgICggZm9jdXNWaXNpYmxlLCBxdWFkcmF0aWMgKSA9PlxyXG4gICAgICAgIGZvY3VzVmlzaWJsZSAmJiAvLyB0aGUgRm9jdXMgY2hlY2tib3ggaXMgY2hlY2tlZFxyXG4gICAgICAgICggcXVhZHJhdGljLmZvY3VzICE9PSB1bmRlZmluZWQgKSAmJiAvLyB0aGUgcXVhZHJhdGljIGhhcyBhIGZvY3VzXHJcbiAgICAgICAgZ3JhcGguY29udGFpbnMoIHF1YWRyYXRpYy5mb2N1cyApLCAvLyB0aGUgZm9jdXMgaXMgb24gdGhlIGdyYXBoXHJcbiAgICAgIHtcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Zpc2libGVQcm9wZXJ0eScgKSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IEJvb2xlYW5JT1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgc3VwZXIoIGNvb3JkaW5hdGVzUHJvcGVydHksIGNvb3JkaW5hdGVzVmlzaWJsZVByb3BlcnR5LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBkcmFnIGxpc3RlbmVyXHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIG5ldyBGb2N1c0RyYWdMaXN0ZW5lciggdGhpcywgcFByb3BlcnR5LCBxdWFkcmF0aWNQcm9wZXJ0eSwgZ3JhcGgueVJhbmdlLFxyXG4gICAgICBtb2RlbFZpZXdUcmFuc2Zvcm0sIG9wdGlvbnMuaW50ZXJ2YWwsIHtcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RyYWdMaXN0ZW5lcicgKVxyXG4gICAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBtb3ZlIHRoZSBtYW5pcHVsYXRvclxyXG4gICAgcXVhZHJhdGljUHJvcGVydHkubGluayggcXVhZHJhdGljID0+IHtcclxuICAgICAgY29uc3QgZm9jdXMgPSBxdWFkcmF0aWMuZm9jdXMhO1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmb2N1cywgYGV4cGVjdGVkIGZvY3VzOiAke3F1YWRyYXRpYy5mb2N1c31gICk7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdQb3NpdGlvbiggZm9jdXMgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICBvcHRpb25zLnZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHtcclxuICAgICAgdGhpcy5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKTsgLy8gY2FuY2VsIGFueSBkcmFnIHRoYXQgaXMgaW4gcHJvZ3Jlc3NcclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIEZvY3VzRHJhZ0xpc3RlbmVyIGV4dGVuZHMgRHJhZ0xpc3RlbmVyIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHRhcmdldE5vZGUgLSB0aGUgTm9kZSB0aGF0IHdlIGF0dGFjaGVkIHRoaXMgbGlzdGVuZXIgdG9cclxuICAgKiBAcGFyYW0gcFByb3BlcnR5IC0gcCBjb2VmZmljaWVudCBvZiBhbHRlcm5hdGUgdmVydGV4IGZvcm1cclxuICAgKiBAcGFyYW0gcXVhZHJhdGljUHJvcGVydHkgLSB0aGUgaW50ZXJhY3RpdmUgcXVhZHJhdGljXHJcbiAgICogQHBhcmFtIHlSYW5nZSAtIHJhbmdlIG9mIHRoZSBncmFwaCdzIHktYXhpc1xyXG4gICAqIEBwYXJhbSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0gaW50ZXJ2YWwgLSBkcmFnZ2luZyB0aGlzIG1hbmlwdWxhdG9yIGNoYW5nZXMgcCB0byBiZSBhIG11bHRpcGxlIG9mIHRoaXMgdmFsdWUsIGluIG1vZGVsIGNvb3JkaW5hdGUgZnJhbWVcclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHRhcmdldE5vZGU6IE5vZGUsIHBQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHksIHF1YWRyYXRpY1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxRdWFkcmF0aWM+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgeVJhbmdlOiBSYW5nZSwgbW9kZWxWaWV3VHJhbnNmb3JtOiBNb2RlbFZpZXdUcmFuc2Zvcm0yLCBpbnRlcnZhbDogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZWRPcHRpb25zOiBEcmFnTGlzdGVuZXJPcHRpb25zPFByZXNzZWREcmFnTGlzdGVuZXI+ICkge1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHBQcm9wZXJ0eS5yYW5nZSwgJ3BQcm9wZXJ0eSBpcyBtaXNzaW5nIHJhbmdlJyApO1xyXG5cclxuICAgIGxldCBzdGFydE9mZnNldDogVmVjdG9yMjsgLy8gd2hlcmUgdGhlIGRyYWcgc3RhcnRlZCwgcmVsYXRpdmUgdG8gdGhlIG1hbmlwdWxhdG9yXHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IGNvbWJpbmVPcHRpb25zPERyYWdMaXN0ZW5lck9wdGlvbnM8UHJlc3NlZERyYWdMaXN0ZW5lcj4+KCB7XHJcblxyXG4gICAgICBhbGxvd1RvdWNoU25hZzogdHJ1ZSxcclxuXHJcbiAgICAgIC8vIG5vdGUgd2hlcmUgdGhlIGRyYWcgc3RhcnRlZFxyXG4gICAgICBzdGFydDogKCBldmVudCwgbGlzdGVuZXIgKSA9PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IGZvY3VzID0gcXVhZHJhdGljUHJvcGVydHkudmFsdWUuZm9jdXMhO1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIGZvY3VzLCBgZXhwZWN0ZWQgZm9jdXM6ICR7Zm9jdXN9YCApO1xyXG5cclxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCBmb2N1cyApO1xyXG4gICAgICAgIHN0YXJ0T2Zmc2V0ID0gdGFyZ2V0Tm9kZS5nbG9iYWxUb1BhcmVudFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICkubWludXMoIHBvc2l0aW9uICk7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICBkcmFnOiAoIGV2ZW50LCBsaXN0ZW5lciApID0+IHtcclxuXHJcbiAgICAgICAgY29uc3QgdmVydGV4ID0gcXVhZHJhdGljUHJvcGVydHkudmFsdWUudmVydGV4ITtcclxuICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB2ZXJ0ZXgsIGBleHBlY3RlZCB2ZXJ0ZXg6ICR7dmVydGV4fWAgKTtcclxuXHJcbiAgICAgICAgLy8gdHJhbnNmb3JtIHRoZSBkcmFnIHBvaW50IGZyb20gdmlldyB0byBtb2RlbCBjb29yZGluYXRlIGZyYW1lXHJcbiAgICAgICAgY29uc3QgcGFyZW50UG9pbnQgPSB0YXJnZXROb2RlLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKS5taW51cyggc3RhcnRPZmZzZXQgKTtcclxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IG1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbFBvc2l0aW9uKCBwYXJlbnRQb2ludCApO1xyXG5cclxuICAgICAgICAvLyBjb25zdHJhaW4gdG8gdGhlIGdyYXBoXHJcbiAgICAgICAgY29uc3QgeSA9IHlSYW5nZS5jb25zdHJhaW5WYWx1ZSggcG9zaXRpb24ueSApO1xyXG5cclxuICAgICAgICAvLyBjb25zdHJhaW4gYW5kIHJvdW5kXHJcbiAgICAgICAgbGV0IHAgPSBwUHJvcGVydHkucmFuZ2UuY29uc3RyYWluVmFsdWUoIHkgLSB2ZXJ0ZXgueSApO1xyXG4gICAgICAgIHAgPSBVdGlscy5yb3VuZFRvSW50ZXJ2YWwoIHAsIGludGVydmFsICk7XHJcblxyXG4gICAgICAgIC8vIHNraXAgb3ZlciBwID09PSAwXHJcbiAgICAgICAgaWYgKCBwID09PSAwICkge1xyXG4gICAgICAgICAgcCA9ICggcFByb3BlcnR5LnZhbHVlID4gMCApID8gaW50ZXJ2YWwgOiAtaW50ZXJ2YWw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHAgIT09IDAsICdwPTAgaXMgbm90IHN1cHBvcnRlZCcgKTtcclxuXHJcbiAgICAgICAgcFByb3BlcnR5LnZhbHVlID0gcDtcclxuICAgICAgfVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuICB9XHJcbn1cclxuXHJcbmdyYXBoaW5nUXVhZHJhdGljcy5yZWdpc3RlciggJ0ZvY3VzTWFuaXB1bGF0b3InLCBGb2N1c01hbmlwdWxhdG9yICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBRS9DLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsU0FBU0MsWUFBWSxRQUF3RCxtQ0FBbUM7QUFDaEgsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQztBQUNoRSxPQUFPQyxRQUFRLE1BQU0sMEJBQTBCO0FBQy9DLE9BQU9DLFdBQVcsTUFBTSw2QkFBNkI7QUFDckQsT0FBT0MsYUFBYSxNQUFnQyxvQ0FB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