// Copyright 2018-2023, University of Colorado Boulder

/**
 * VertexManipulator is the manipulator for editing a quadratic (parabola) by changing its vertex.
 * It displays the coordinates of the vertex.
 *
 * @author Andrea Lin
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { DragListener } from '../../../../scenery/js/imports.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import NullableIO from '../../../../tandem/js/types/NullableIO.js';
import graphingQuadratics from '../../graphingQuadratics.js';
import GQColors from '../GQColors.js';
import GQConstants from '../GQConstants.js';
import GQManipulator from './GQManipulator.js';
import optionize, { combineOptions } from '../../../../phet-core/js/optionize.js';

// constants
const COORDINATES_Y_SPACING = 1;
export default class VertexManipulator extends GQManipulator {
  /**
   * @param hProperty - h coefficient of the vertex form of the quadratic equation
   * @param kProperty - k coefficient of the vertex form of the quadratic equation
   * @param quadraticProperty - the interactive quadratic
   * @param graph
   * @param modelViewTransform
   * @param vertexVisibleProperty
   * @param coordinatesVisibleProperty
   * @param [providedOptions]
   */
  constructor(hProperty, kProperty, quadraticProperty, graph, modelViewTransform, vertexVisibleProperty, coordinatesVisibleProperty, providedOptions) {
    const options = optionize()({
      // GQManipulatorOptions
      radius: modelViewTransform.modelToViewDeltaX(GQConstants.MANIPULATOR_RADIUS),
      color: GQColors.VERTEX,
      coordinatesForegroundColor: 'white',
      coordinatesBackgroundColor: GQColors.VERTEX,
      coordinatesDecimals: GQConstants.VERTEX_DECIMALS,
      phetioDocumentation: 'manipulator for the vertex'
    }, providedOptions);

    // position coordinates based on which way the parabola opens
    options.layoutCoordinates = (coordinates, coordinatesNode, radius) => {
      if (coordinates) {
        coordinatesNode.centerX = 0;
        const yOffset = radius + COORDINATES_Y_SPACING;
        if (quadraticProperty.value.a > 0) {
          coordinatesNode.top = yOffset;
        } else {
          coordinatesNode.bottom = -yOffset;
        }
      }
    };

    // coordinates correspond to the quadratic's vertex (if it has one)
    const coordinatesProperty = new DerivedProperty([quadraticProperty], quadratic => quadratic.vertex ? quadratic.vertex : null, {
      valueType: [Vector2, null],
      tandem: options.tandem.createTandem('coordinatesProperty'),
      phetioDocumentation: 'coordinates displayed by on vertex manipulator, null means no vertex',
      phetioValueType: NullableIO(Vector2.Vector2IO)
    });

    // visibility of this Node
    assert && assert(!options.visibleProperty, 'VertexManipulator sets visibleProperty');
    options.visibleProperty = new DerivedProperty([vertexVisibleProperty, quadraticProperty], (vertexVisible, quadratic) => vertexVisible &&
    // the Vertex checkbox is checked
    quadratic.isaParabola() && quadratic.vertex !== undefined &&
    // the quadratic is a parabola, so has a vertex
    graph.contains(quadratic.vertex),
    // the vertex is on the graph
    {
      tandem: options.tandem.createTandem('visibleProperty'),
      phetioValueType: BooleanIO
    });
    super(coordinatesProperty, coordinatesVisibleProperty, options);

    // add the drag listener
    this.addInputListener(new VertexDragListener(this, hProperty, kProperty, graph, modelViewTransform, {
      tandem: options.tandem.createTandem('dragListener')
    }));

    // move the manipulator
    quadraticProperty.link(quadratic => {
      if (quadratic.vertex) {
        this.translation = modelViewTransform.modelToViewPosition(quadratic.vertex);
      }
    });
    options.visibleProperty.link(visible => {
      this.interruptSubtreeInput(); // cancel any drag that is in progress
    });
  }
}

class VertexDragListener extends DragListener {
  /**
   * @param targetNode - the Node that we attached this listener to
   * @param hProperty - h coefficient of vertex form
   * @param kProperty - k coefficient of vertex form
   * @param graph
   * @param modelViewTransform
   * @param [providedOptions]
   */
  constructor(targetNode, hProperty, kProperty, graph, modelViewTransform, providedOptions) {
    let startOffset; // where the drag started, relative to the manipulator

    const options = combineOptions({
      allowTouchSnag: true,
      // note where the drag started
      start: (event, listener) => {
        const position = modelViewTransform.modelToViewXY(hProperty.value, kProperty.value);
        startOffset = targetNode.globalToParentPoint(event.pointer.point).minus(position);
      },
      drag: (event, listener) => {
        // transform the drag point from view to model coordinate frame
        const parentPoint = targetNode.globalToParentPoint(event.pointer.point).minus(startOffset);
        let position = modelViewTransform.viewToModelPosition(parentPoint);

        // constrain to the graph
        position = graph.constrain(position);

        // constrain to range and snap to integer grid
        const h = Utils.roundSymmetric(hProperty.range.constrainValue(position.x));
        const k = Utils.roundSymmetric(kProperty.range.constrainValue(position.y));

        // Setting h and k separately results in an intermediate Quadratic.
        // We decided that this is OK, and we can live with it.
        hProperty.value = h;
        kProperty.value = k;
      }
    }, providedOptions);
    super(options);
  }
}
graphingQuadratics.register('VertexManipulator', VertexManipulator);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJVdGlscyIsIlZlY3RvcjIiLCJEcmFnTGlzdGVuZXIiLCJCb29sZWFuSU8iLCJOdWxsYWJsZUlPIiwiZ3JhcGhpbmdRdWFkcmF0aWNzIiwiR1FDb2xvcnMiLCJHUUNvbnN0YW50cyIsIkdRTWFuaXB1bGF0b3IiLCJvcHRpb25pemUiLCJjb21iaW5lT3B0aW9ucyIsIkNPT1JESU5BVEVTX1lfU1BBQ0lORyIsIlZlcnRleE1hbmlwdWxhdG9yIiwiY29uc3RydWN0b3IiLCJoUHJvcGVydHkiLCJrUHJvcGVydHkiLCJxdWFkcmF0aWNQcm9wZXJ0eSIsImdyYXBoIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwidmVydGV4VmlzaWJsZVByb3BlcnR5IiwiY29vcmRpbmF0ZXNWaXNpYmxlUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicmFkaXVzIiwibW9kZWxUb1ZpZXdEZWx0YVgiLCJNQU5JUFVMQVRPUl9SQURJVVMiLCJjb2xvciIsIlZFUlRFWCIsImNvb3JkaW5hdGVzRm9yZWdyb3VuZENvbG9yIiwiY29vcmRpbmF0ZXNCYWNrZ3JvdW5kQ29sb3IiLCJjb29yZGluYXRlc0RlY2ltYWxzIiwiVkVSVEVYX0RFQ0lNQUxTIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsImxheW91dENvb3JkaW5hdGVzIiwiY29vcmRpbmF0ZXMiLCJjb29yZGluYXRlc05vZGUiLCJjZW50ZXJYIiwieU9mZnNldCIsInZhbHVlIiwiYSIsInRvcCIsImJvdHRvbSIsImNvb3JkaW5hdGVzUHJvcGVydHkiLCJxdWFkcmF0aWMiLCJ2ZXJ0ZXgiLCJ2YWx1ZVR5cGUiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9WYWx1ZVR5cGUiLCJWZWN0b3IySU8iLCJhc3NlcnQiLCJ2aXNpYmxlUHJvcGVydHkiLCJ2ZXJ0ZXhWaXNpYmxlIiwiaXNhUGFyYWJvbGEiLCJ1bmRlZmluZWQiLCJjb250YWlucyIsImFkZElucHV0TGlzdGVuZXIiLCJWZXJ0ZXhEcmFnTGlzdGVuZXIiLCJsaW5rIiwidHJhbnNsYXRpb24iLCJtb2RlbFRvVmlld1Bvc2l0aW9uIiwidmlzaWJsZSIsImludGVycnVwdFN1YnRyZWVJbnB1dCIsInRhcmdldE5vZGUiLCJzdGFydE9mZnNldCIsImFsbG93VG91Y2hTbmFnIiwic3RhcnQiLCJldmVudCIsImxpc3RlbmVyIiwicG9zaXRpb24iLCJtb2RlbFRvVmlld1hZIiwiZ2xvYmFsVG9QYXJlbnRQb2ludCIsInBvaW50ZXIiLCJwb2ludCIsIm1pbnVzIiwiZHJhZyIsInBhcmVudFBvaW50Iiwidmlld1RvTW9kZWxQb3NpdGlvbiIsImNvbnN0cmFpbiIsImgiLCJyb3VuZFN5bW1ldHJpYyIsInJhbmdlIiwiY29uc3RyYWluVmFsdWUiLCJ4IiwiayIsInkiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlZlcnRleE1hbmlwdWxhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZlcnRleE1hbmlwdWxhdG9yIGlzIHRoZSBtYW5pcHVsYXRvciBmb3IgZWRpdGluZyBhIHF1YWRyYXRpYyAocGFyYWJvbGEpIGJ5IGNoYW5naW5nIGl0cyB2ZXJ0ZXguXHJcbiAqIEl0IGRpc3BsYXlzIHRoZSBjb29yZGluYXRlcyBvZiB0aGUgdmVydGV4LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEFuZHJlYSBMaW5cclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IE51bWJlclByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTnVtYmVyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBEcmFnTGlzdGVuZXIsIERyYWdMaXN0ZW5lck9wdGlvbnMsIE5vZGUsIFByZXNzZWREcmFnTGlzdGVuZXIgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgQm9vbGVhbklPIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9Cb29sZWFuSU8uanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBncmFwaGluZ1F1YWRyYXRpY3MgZnJvbSAnLi4vLi4vZ3JhcGhpbmdRdWFkcmF0aWNzLmpzJztcclxuaW1wb3J0IEdRQ29sb3JzIGZyb20gJy4uL0dRQ29sb3JzLmpzJztcclxuaW1wb3J0IEdRQ29uc3RhbnRzIGZyb20gJy4uL0dRQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IEdRTWFuaXB1bGF0b3IsIHsgR1FNYW5pcHVsYXRvck9wdGlvbnMgfSBmcm9tICcuL0dRTWFuaXB1bGF0b3IuanMnO1xyXG5pbXBvcnQgUXVhZHJhdGljIGZyb20gJy4uL21vZGVsL1F1YWRyYXRpYy5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IEdyYXBoIGZyb20gJy4uLy4uLy4uLy4uL2dyYXBoaW5nLWxpbmVzL2pzL2NvbW1vbi9tb2RlbC9HcmFwaC5qcyc7XHJcbmltcG9ydCBNb2RlbFZpZXdUcmFuc2Zvcm0yIGZyb20gJy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdmlldy9Nb2RlbFZpZXdUcmFuc2Zvcm0yLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IGNvbWJpbmVPcHRpb25zLCBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgQ09PUkRJTkFURVNfWV9TUEFDSU5HID0gMTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSBFbXB0eVNlbGZPcHRpb25zO1xyXG5cclxudHlwZSBWZXJ0ZXhNYW5pcHVsYXRvck9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFN0cmljdE9taXQ8R1FNYW5pcHVsYXRvck9wdGlvbnMsICdsYXlvdXRDb29yZGluYXRlcyc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmVydGV4TWFuaXB1bGF0b3IgZXh0ZW5kcyBHUU1hbmlwdWxhdG9yIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGhQcm9wZXJ0eSAtIGggY29lZmZpY2llbnQgb2YgdGhlIHZlcnRleCBmb3JtIG9mIHRoZSBxdWFkcmF0aWMgZXF1YXRpb25cclxuICAgKiBAcGFyYW0ga1Byb3BlcnR5IC0gayBjb2VmZmljaWVudCBvZiB0aGUgdmVydGV4IGZvcm0gb2YgdGhlIHF1YWRyYXRpYyBlcXVhdGlvblxyXG4gICAqIEBwYXJhbSBxdWFkcmF0aWNQcm9wZXJ0eSAtIHRoZSBpbnRlcmFjdGl2ZSBxdWFkcmF0aWNcclxuICAgKiBAcGFyYW0gZ3JhcGhcclxuICAgKiBAcGFyYW0gbW9kZWxWaWV3VHJhbnNmb3JtXHJcbiAgICogQHBhcmFtIHZlcnRleFZpc2libGVQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBjb29yZGluYXRlc1Zpc2libGVQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggaFByb3BlcnR5OiBOdW1iZXJQcm9wZXJ0eSxcclxuICAgICAgICAgICAgICAgICAgICAgIGtQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHksXHJcbiAgICAgICAgICAgICAgICAgICAgICBxdWFkcmF0aWNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8UXVhZHJhdGljPixcclxuICAgICAgICAgICAgICAgICAgICAgIGdyYXBoOiBHcmFwaCxcclxuICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMixcclxuICAgICAgICAgICAgICAgICAgICAgIHZlcnRleFZpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sIGNvb3JkaW5hdGVzVmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9uczogVmVydGV4TWFuaXB1bGF0b3JPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8VmVydGV4TWFuaXB1bGF0b3JPcHRpb25zLCBTZWxmT3B0aW9ucywgR1FNYW5pcHVsYXRvck9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIEdRTWFuaXB1bGF0b3JPcHRpb25zXHJcbiAgICAgIHJhZGl1czogbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3RGVsdGFYKCBHUUNvbnN0YW50cy5NQU5JUFVMQVRPUl9SQURJVVMgKSxcclxuICAgICAgY29sb3I6IEdRQ29sb3JzLlZFUlRFWCxcclxuICAgICAgY29vcmRpbmF0ZXNGb3JlZ3JvdW5kQ29sb3I6ICd3aGl0ZScsXHJcbiAgICAgIGNvb3JkaW5hdGVzQmFja2dyb3VuZENvbG9yOiBHUUNvbG9ycy5WRVJURVgsXHJcbiAgICAgIGNvb3JkaW5hdGVzRGVjaW1hbHM6IEdRQ29uc3RhbnRzLlZFUlRFWF9ERUNJTUFMUyxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ21hbmlwdWxhdG9yIGZvciB0aGUgdmVydGV4J1xyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gY29vcmRpbmF0ZXMgYmFzZWQgb24gd2hpY2ggd2F5IHRoZSBwYXJhYm9sYSBvcGVuc1xyXG4gICAgb3B0aW9ucy5sYXlvdXRDb29yZGluYXRlcyA9ICggY29vcmRpbmF0ZXMsIGNvb3JkaW5hdGVzTm9kZSwgcmFkaXVzICkgPT4ge1xyXG4gICAgICBpZiAoIGNvb3JkaW5hdGVzICkge1xyXG4gICAgICAgIGNvb3JkaW5hdGVzTm9kZS5jZW50ZXJYID0gMDtcclxuICAgICAgICBjb25zdCB5T2Zmc2V0ID0gcmFkaXVzICsgQ09PUkRJTkFURVNfWV9TUEFDSU5HO1xyXG4gICAgICAgIGlmICggcXVhZHJhdGljUHJvcGVydHkudmFsdWUuYSA+IDAgKSB7XHJcbiAgICAgICAgICBjb29yZGluYXRlc05vZGUudG9wID0geU9mZnNldDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBjb29yZGluYXRlc05vZGUuYm90dG9tID0gLXlPZmZzZXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGNvb3JkaW5hdGVzIGNvcnJlc3BvbmQgdG8gdGhlIHF1YWRyYXRpYydzIHZlcnRleCAoaWYgaXQgaGFzIG9uZSlcclxuICAgIGNvbnN0IGNvb3JkaW5hdGVzUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIHF1YWRyYXRpY1Byb3BlcnR5IF0sXHJcbiAgICAgIHF1YWRyYXRpYyA9PiAoIHF1YWRyYXRpYy52ZXJ0ZXggPyBxdWFkcmF0aWMudmVydGV4IDogbnVsbCApLCB7XHJcbiAgICAgICAgdmFsdWVUeXBlOiBbIFZlY3RvcjIsIG51bGwgXSxcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2Nvb3JkaW5hdGVzUHJvcGVydHknICksXHJcbiAgICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ2Nvb3JkaW5hdGVzIGRpc3BsYXllZCBieSBvbiB2ZXJ0ZXggbWFuaXB1bGF0b3IsIG51bGwgbWVhbnMgbm8gdmVydGV4JyxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IE51bGxhYmxlSU8oIFZlY3RvcjIuVmVjdG9yMklPIClcclxuICAgICAgfSApO1xyXG5cclxuICAgIC8vIHZpc2liaWxpdHkgb2YgdGhpcyBOb2RlXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhb3B0aW9ucy52aXNpYmxlUHJvcGVydHksICdWZXJ0ZXhNYW5pcHVsYXRvciBzZXRzIHZpc2libGVQcm9wZXJ0eScgKTtcclxuICAgIG9wdGlvbnMudmlzaWJsZVByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgWyB2ZXJ0ZXhWaXNpYmxlUHJvcGVydHksIHF1YWRyYXRpY1Byb3BlcnR5IF0sXHJcbiAgICAgICggdmVydGV4VmlzaWJsZSwgcXVhZHJhdGljICkgPT5cclxuICAgICAgICB2ZXJ0ZXhWaXNpYmxlICYmICAvLyB0aGUgVmVydGV4IGNoZWNrYm94IGlzIGNoZWNrZWRcclxuICAgICAgICBxdWFkcmF0aWMuaXNhUGFyYWJvbGEoKSAmJiAoIHF1YWRyYXRpYy52ZXJ0ZXggIT09IHVuZGVmaW5lZCApICYmIC8vIHRoZSBxdWFkcmF0aWMgaXMgYSBwYXJhYm9sYSwgc28gaGFzIGEgdmVydGV4XHJcbiAgICAgICAgZ3JhcGguY29udGFpbnMoIHF1YWRyYXRpYy52ZXJ0ZXggKSwgLy8gdGhlIHZlcnRleCBpcyBvbiB0aGUgZ3JhcGhcclxuICAgICAge1xyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICBzdXBlciggY29vcmRpbmF0ZXNQcm9wZXJ0eSwgY29vcmRpbmF0ZXNWaXNpYmxlUHJvcGVydHksIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGRyYWcgbGlzdGVuZXJcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggbmV3IFZlcnRleERyYWdMaXN0ZW5lciggdGhpcywgaFByb3BlcnR5LCBrUHJvcGVydHksIGdyYXBoLCBtb2RlbFZpZXdUcmFuc2Zvcm0sIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkcmFnTGlzdGVuZXInIClcclxuICAgIH0gKSApO1xyXG5cclxuICAgIC8vIG1vdmUgdGhlIG1hbmlwdWxhdG9yXHJcbiAgICBxdWFkcmF0aWNQcm9wZXJ0eS5saW5rKCBxdWFkcmF0aWMgPT4ge1xyXG4gICAgICBpZiAoIHF1YWRyYXRpYy52ZXJ0ZXggKSB7XHJcbiAgICAgICAgdGhpcy50cmFuc2xhdGlvbiA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1Bvc2l0aW9uKCBxdWFkcmF0aWMudmVydGV4ICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICBvcHRpb25zLnZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHtcclxuICAgICAgdGhpcy5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKTsgLy8gY2FuY2VsIGFueSBkcmFnIHRoYXQgaXMgaW4gcHJvZ3Jlc3NcclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFZlcnRleERyYWdMaXN0ZW5lciBleHRlbmRzIERyYWdMaXN0ZW5lciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB0YXJnZXROb2RlIC0gdGhlIE5vZGUgdGhhdCB3ZSBhdHRhY2hlZCB0aGlzIGxpc3RlbmVyIHRvXHJcbiAgICogQHBhcmFtIGhQcm9wZXJ0eSAtIGggY29lZmZpY2llbnQgb2YgdmVydGV4IGZvcm1cclxuICAgKiBAcGFyYW0ga1Byb3BlcnR5IC0gayBjb2VmZmljaWVudCBvZiB2ZXJ0ZXggZm9ybVxyXG4gICAqIEBwYXJhbSBncmFwaFxyXG4gICAqIEBwYXJhbSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHRhcmdldE5vZGU6IE5vZGUsIGhQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHksIGtQcm9wZXJ0eTogTnVtYmVyUHJvcGVydHksIGdyYXBoOiBHcmFwaCxcclxuICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMiwgcHJvdmlkZWRPcHRpb25zOiBEcmFnTGlzdGVuZXJPcHRpb25zPFByZXNzZWREcmFnTGlzdGVuZXI+ICkge1xyXG5cclxuICAgIGxldCBzdGFydE9mZnNldDogVmVjdG9yMjsgLy8gd2hlcmUgdGhlIGRyYWcgc3RhcnRlZCwgcmVsYXRpdmUgdG8gdGhlIG1hbmlwdWxhdG9yXHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IGNvbWJpbmVPcHRpb25zPERyYWdMaXN0ZW5lck9wdGlvbnM8UHJlc3NlZERyYWdMaXN0ZW5lcj4+KCB7XHJcblxyXG4gICAgICBhbGxvd1RvdWNoU25hZzogdHJ1ZSxcclxuXHJcbiAgICAgIC8vIG5vdGUgd2hlcmUgdGhlIGRyYWcgc3RhcnRlZFxyXG4gICAgICBzdGFydDogKCBldmVudCwgbGlzdGVuZXIgKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYWSggaFByb3BlcnR5LnZhbHVlLCBrUHJvcGVydHkudmFsdWUgKTtcclxuICAgICAgICBzdGFydE9mZnNldCA9IHRhcmdldE5vZGUuZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApLm1pbnVzKCBwb3NpdGlvbiApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgZHJhZzogKCBldmVudCwgbGlzdGVuZXIgKSA9PiB7XHJcblxyXG4gICAgICAgIC8vIHRyYW5zZm9ybSB0aGUgZHJhZyBwb2ludCBmcm9tIHZpZXcgdG8gbW9kZWwgY29vcmRpbmF0ZSBmcmFtZVxyXG4gICAgICAgIGNvbnN0IHBhcmVudFBvaW50ID0gdGFyZ2V0Tm9kZS5nbG9iYWxUb1BhcmVudFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICkubWludXMoIHN0YXJ0T2Zmc2V0ICk7XHJcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcblxyXG4gICAgICAgIC8vIGNvbnN0cmFpbiB0byB0aGUgZ3JhcGhcclxuICAgICAgICBwb3NpdGlvbiA9IGdyYXBoLmNvbnN0cmFpbiggcG9zaXRpb24gKTtcclxuXHJcbiAgICAgICAgLy8gY29uc3RyYWluIHRvIHJhbmdlIGFuZCBzbmFwIHRvIGludGVnZXIgZ3JpZFxyXG4gICAgICAgIGNvbnN0IGggPSBVdGlscy5yb3VuZFN5bW1ldHJpYyggaFByb3BlcnR5LnJhbmdlLmNvbnN0cmFpblZhbHVlKCBwb3NpdGlvbi54ICkgKTtcclxuICAgICAgICBjb25zdCBrID0gVXRpbHMucm91bmRTeW1tZXRyaWMoIGtQcm9wZXJ0eS5yYW5nZS5jb25zdHJhaW5WYWx1ZSggcG9zaXRpb24ueSApICk7XHJcblxyXG4gICAgICAgIC8vIFNldHRpbmcgaCBhbmQgayBzZXBhcmF0ZWx5IHJlc3VsdHMgaW4gYW4gaW50ZXJtZWRpYXRlIFF1YWRyYXRpYy5cclxuICAgICAgICAvLyBXZSBkZWNpZGVkIHRoYXQgdGhpcyBpcyBPSywgYW5kIHdlIGNhbiBsaXZlIHdpdGggaXQuXHJcbiAgICAgICAgaFByb3BlcnR5LnZhbHVlID0gaDtcclxuICAgICAgICBrUHJvcGVydHkudmFsdWUgPSBrO1xyXG4gICAgICB9XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG4gIH1cclxufVxyXG5cclxuZ3JhcGhpbmdRdWFkcmF0aWNzLnJlZ2lzdGVyKCAnVmVydGV4TWFuaXB1bGF0b3In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