// Copyright 2022-2023, University of Colorado Boulder

/**
 * Model for pipes and valves.
 * The pipes visually connect the 2D cup representations and the valves control whether water is shared or not.
 * When the valves are open the water flows between all connected cups, and when the valves are closed
 * water is not allowed to flow between cups.
 *
 * @author Marla Schulz (PhET Interactive Simulations)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import optionize from '../../../../phet-core/js/optionize.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import IOType from '../../../../tandem/js/types/IOType.js';
import meanShareAndBalance from '../../meanShareAndBalance.js';
export default class Pipe extends PhetioObject {
  // Whether pipe is enabled in view and data calculations

  // Property tracks if the pipe's valve is in a clicked state.
  isCurrentlyClickedProperty = new BooleanProperty(false);
  // The x and y positions of the pipe in the view.

  // Holds the valve node rotation value. Closed is 0, and open is Pi/2

  constructor(arePipesOpenProperty, providedOptions) {
    const options = optionize()({
      isActive: false,
      // phet-io
      phetioType: Pipe.PipeIO
    }, providedOptions);
    super(options);
    this.rotationProperty = new NumberProperty(0);
    this.arePipesOpenProperty = arePipesOpenProperty;
    this.isActiveProperty = new BooleanProperty(options.isActive);
    this.position = options.position;
  }
  reset() {
    this.isActiveProperty.reset();
    this.rotationProperty.reset();
  }

  // Valve animation
  step(dt) {
    const currentRotation = this.rotationProperty.value;
    const targetRotation = this.arePipesOpenProperty.value ? Math.PI / 2 : 0;
    const delta = targetRotation - currentRotation;
    const rotationThreshold = Math.abs(this.rotationProperty.value - targetRotation) * 0.4;
    const proposedRotation = currentRotation + Math.sign(delta) * dt * 3;
    this.rotationProperty.value = rotationThreshold <= dt ? targetRotation : proposedRotation;
  }
  static PipeIO = new IOType('PipeIO', {
    valueType: Pipe,
    toStateObject: pipe => ({
      position: pipe.position
    }),
    stateObjectToCreateElementArguments: stateObject => {
      return [stateObject.position];
    },
    stateSchema: {
      position: Vector2.Vector2IO
    }
  });
}
meanShareAndBalance.register('Pipe', Pipe);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsIlZlY3RvcjIiLCJvcHRpb25pemUiLCJQaGV0aW9PYmplY3QiLCJJT1R5cGUiLCJtZWFuU2hhcmVBbmRCYWxhbmNlIiwiUGlwZSIsImlzQ3VycmVudGx5Q2xpY2tlZFByb3BlcnR5IiwiY29uc3RydWN0b3IiLCJhcmVQaXBlc09wZW5Qcm9wZXJ0eSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJpc0FjdGl2ZSIsInBoZXRpb1R5cGUiLCJQaXBlSU8iLCJyb3RhdGlvblByb3BlcnR5IiwiaXNBY3RpdmVQcm9wZXJ0eSIsInBvc2l0aW9uIiwicmVzZXQiLCJzdGVwIiwiZHQiLCJjdXJyZW50Um90YXRpb24iLCJ2YWx1ZSIsInRhcmdldFJvdGF0aW9uIiwiTWF0aCIsIlBJIiwiZGVsdGEiLCJyb3RhdGlvblRocmVzaG9sZCIsImFicyIsInByb3Bvc2VkUm90YXRpb24iLCJzaWduIiwidmFsdWVUeXBlIiwidG9TdGF0ZU9iamVjdCIsInBpcGUiLCJzdGF0ZU9iamVjdFRvQ3JlYXRlRWxlbWVudEFyZ3VtZW50cyIsInN0YXRlT2JqZWN0Iiwic3RhdGVTY2hlbWEiLCJWZWN0b3IySU8iLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBpcGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjItMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTW9kZWwgZm9yIHBpcGVzIGFuZCB2YWx2ZXMuXHJcbiAqIFRoZSBwaXBlcyB2aXN1YWxseSBjb25uZWN0IHRoZSAyRCBjdXAgcmVwcmVzZW50YXRpb25zIGFuZCB0aGUgdmFsdmVzIGNvbnRyb2wgd2hldGhlciB3YXRlciBpcyBzaGFyZWQgb3Igbm90LlxyXG4gKiBXaGVuIHRoZSB2YWx2ZXMgYXJlIG9wZW4gdGhlIHdhdGVyIGZsb3dzIGJldHdlZW4gYWxsIGNvbm5lY3RlZCBjdXBzLCBhbmQgd2hlbiB0aGUgdmFsdmVzIGFyZSBjbG9zZWRcclxuICogd2F0ZXIgaXMgbm90IGFsbG93ZWQgdG8gZmxvdyBiZXR3ZWVuIGN1cHMuXHJcbiAqXHJcbiAqIEBhdXRob3IgTWFybGEgU2NodWx6IChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgUGlja1JlcXVpcmVkIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrUmVxdWlyZWQuanMnO1xyXG5pbXBvcnQgU3RyaWN0T21pdCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvU3RyaWN0T21pdC5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QsIHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgbWVhblNoYXJlQW5kQmFsYW5jZSBmcm9tICcuLi8uLi9tZWFuU2hhcmVBbmRCYWxhbmNlLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgcG9zaXRpb246IFZlY3RvcjI7IC8vIHRoZSB4ICYgeS1wb3NpdGlvbiBvZiB0aGUgcGlwZSBpbiB0aGUgdmlld1xyXG4gIGlzQWN0aXZlPzogYm9vbGVhbjtcclxufTtcclxuXHJcbnR5cGUgU3RhdGVPYmplY3QgPSB7XHJcbiAgcG9zaXRpb246IFZlY3RvcjI7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBQaXBlT3B0aW9ucyA9XHJcbiAgU2VsZk9wdGlvbnNcclxuICAmIFN0cmljdE9taXQ8UGhldGlvT2JqZWN0T3B0aW9ucywgJ3BoZXRpb1R5cGUnPlxyXG4gICYgUGlja1JlcXVpcmVkPFBoZXRpb09iamVjdE9wdGlvbnMsICd0YW5kZW0nPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBpcGUgZXh0ZW5kcyBQaGV0aW9PYmplY3Qge1xyXG5cclxuICAvLyBXaGV0aGVyIHBpcGUgaXMgZW5hYmxlZCBpbiB2aWV3IGFuZCBkYXRhIGNhbGN1bGF0aW9uc1xyXG4gIHB1YmxpYyByZWFkb25seSBpc0FjdGl2ZVByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuICAvLyBQcm9wZXJ0eSB0cmFja3MgaWYgdGhlIHBpcGUncyB2YWx2ZSBpcyBpbiBhIGNsaWNrZWQgc3RhdGUuXHJcbiAgcHVibGljIHJlYWRvbmx5IGlzQ3VycmVudGx5Q2xpY2tlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuICAvLyBUaGUgeCBhbmQgeSBwb3NpdGlvbnMgb2YgdGhlIHBpcGUgaW4gdGhlIHZpZXcuXHJcbiAgcHVibGljIHJlYWRvbmx5IHBvc2l0aW9uOiBWZWN0b3IyO1xyXG4gIC8vIEhvbGRzIHRoZSB2YWx2ZSBub2RlIHJvdGF0aW9uIHZhbHVlLiBDbG9zZWQgaXMgMCwgYW5kIG9wZW4gaXMgUGkvMlxyXG4gIHB1YmxpYyByZWFkb25seSByb3RhdGlvblByb3BlcnR5OiBQcm9wZXJ0eTxudW1iZXI+O1xyXG4gIHB1YmxpYyByZWFkb25seSBhcmVQaXBlc09wZW5Qcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggYXJlUGlwZXNPcGVuUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+LCBwcm92aWRlZE9wdGlvbnM/OiBQaXBlT3B0aW9ucyApIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8UGlwZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBQaGV0aW9PYmplY3RPcHRpb25zPigpKCB7XHJcbiAgICAgIGlzQWN0aXZlOiBmYWxzZSxcclxuXHJcbiAgICAgIC8vIHBoZXQtaW9cclxuICAgICAgcGhldGlvVHlwZTogUGlwZS5QaXBlSU9cclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5yb3RhdGlvblByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwICk7XHJcbiAgICB0aGlzLmFyZVBpcGVzT3BlblByb3BlcnR5ID0gYXJlUGlwZXNPcGVuUHJvcGVydHk7XHJcbiAgICB0aGlzLmlzQWN0aXZlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBvcHRpb25zLmlzQWN0aXZlICk7XHJcblxyXG4gICAgdGhpcy5wb3NpdGlvbiA9IG9wdGlvbnMucG9zaXRpb247XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmlzQWN0aXZlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMucm90YXRpb25Qcm9wZXJ0eS5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gVmFsdmUgYW5pbWF0aW9uXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBjb25zdCBjdXJyZW50Um90YXRpb24gPSB0aGlzLnJvdGF0aW9uUHJvcGVydHkudmFsdWU7XHJcbiAgICBjb25zdCB0YXJnZXRSb3RhdGlvbiA9IHRoaXMuYXJlUGlwZXNPcGVuUHJvcGVydHkudmFsdWUgPyBNYXRoLlBJIC8gMiA6IDA7XHJcbiAgICBjb25zdCBkZWx0YSA9IHRhcmdldFJvdGF0aW9uIC0gY3VycmVudFJvdGF0aW9uO1xyXG4gICAgY29uc3Qgcm90YXRpb25UaHJlc2hvbGQgPSBNYXRoLmFicyggdGhpcy5yb3RhdGlvblByb3BlcnR5LnZhbHVlIC0gdGFyZ2V0Um90YXRpb24gKSAqIDAuNDtcclxuICAgIGNvbnN0IHByb3Bvc2VkUm90YXRpb24gPSBjdXJyZW50Um90YXRpb24gKyBNYXRoLnNpZ24oIGRlbHRhICkgKiBkdCAqIDM7XHJcbiAgICB0aGlzLnJvdGF0aW9uUHJvcGVydHkudmFsdWUgPSByb3RhdGlvblRocmVzaG9sZCA8PSBkdCA/IHRhcmdldFJvdGF0aW9uIDogcHJvcG9zZWRSb3RhdGlvbjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUGlwZUlPID0gbmV3IElPVHlwZTxQaXBlPiggJ1BpcGVJTycsIHtcclxuICAgIHZhbHVlVHlwZTogUGlwZSxcclxuICAgIHRvU3RhdGVPYmplY3Q6ICggcGlwZTogUGlwZSApID0+ICgge1xyXG4gICAgICBwb3NpdGlvbjogcGlwZS5wb3NpdGlvblxyXG4gICAgfSApLFxyXG4gICAgc3RhdGVPYmplY3RUb0NyZWF0ZUVsZW1lbnRBcmd1bWVudHM6ICggc3RhdGVPYmplY3Q6IFN0YXRlT2JqZWN0ICkgPT4ge1xyXG4gICAgICByZXR1cm4gWyBzdGF0ZU9iamVjdC5wb3NpdGlvbiBdO1xyXG4gICAgfSxcclxuICAgIHN0YXRlU2NoZW1hOiB7XHJcbiAgICAgIHBvc2l0aW9uOiBWZWN0b3IyLlZlY3RvcjJJT1xyXG4gICAgfVxyXG4gIH0gKTtcclxufVxyXG5cclxuXHJcbm1lYW5TaGFyZUFuZEJhbGFuY2UucmVnaXN0ZXIoICdQaXBlJywgUGlwZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNB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