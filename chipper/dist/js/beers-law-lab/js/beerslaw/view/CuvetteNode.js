// Copyright 2013-2023, University of Colorado Boulder

/**
 * Visual representation of the cuvette.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Utils from '../../../../dot/js/Utils.js';
import { Shape } from '../../../../kite/js/imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import ArrowNode from '../../../../scenery-phet/js/ArrowNode.js';
import { Color, DragListener, Node, Path, PressListener, Rectangle } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import beersLawLab from '../../beersLawLab.js';
// constants
const PERCENT_FULL = 0.92;
const SOLUTION_ALPHA = 0.6;
const ARROW_LENGTH = 110;
const ARROW_HEAD_HEIGHT = 38;
const ARROW_HEAD_WIDTH = 45;
const ARROW_TAIL_WIDTH = 23;
const ARROW_FILL = Color.ORANGE;
export default class CuvetteNode extends Node {
  constructor(cuvette, solutionProperty, modelViewTransform, providedOptions) {
    const options = optionize()({
      // NodeOptions
      phetioVisiblePropertyInstrumented: false
    }, providedOptions);
    super(options);
    const cuvetteNode = new Path(null, {
      stroke: 'black',
      lineWidth: 3,
      pickable: false
    });
    const solutionNode = new Rectangle(0, 0, 1, 1, {
      lineWidth: 0.5,
      pickable: false
    });
    const arrowNode = new ArrowNode(-ARROW_LENGTH / 2, 0, ARROW_LENGTH / 2, 0, {
      cursor: 'pointer',
      tailWidth: ARROW_TAIL_WIDTH,
      headWidth: ARROW_HEAD_WIDTH,
      headHeight: ARROW_HEAD_HEIGHT,
      doubleHead: true,
      fill: ARROW_FILL,
      stroke: 'black',
      lineWidth: 1,
      tandem: options.tandem.createTandem('arrowNode')
    });

    // rendering order
    this.children = [solutionNode, cuvetteNode, arrowNode];

    // when the cuvette width changes ...
    cuvette.widthProperty.link(() => {
      const width = modelViewTransform.modelToViewDeltaX(cuvette.widthProperty.value);
      const height = modelViewTransform.modelToViewDeltaY(cuvette.height);
      cuvetteNode.setShape(new Shape().moveTo(0, 0).lineTo(0, height).lineTo(width, height).lineTo(width, 0));
      solutionNode.setRect(0, 0, width, PERCENT_FULL * height);
      solutionNode.left = cuvetteNode.left;
      solutionNode.bottom = cuvetteNode.bottom;
      arrowNode.x = cuvetteNode.right;
      arrowNode.bottom = cuvetteNode.bottom - 10;
    });

    // when the fluid color changes ...
    const colorObserver = color => {
      solutionNode.fill = color.withAlpha(SOLUTION_ALPHA);
      solutionNode.stroke = color.darkerColor();
    };

    // when the solution changes, rewire the color observer
    solutionProperty.link((newSolution, oldSolution) => {
      if (oldSolution) {
        oldSolution.fluidColorProperty.unlink(colorObserver);
      }
      newSolution.fluidColorProperty.link(colorObserver);
    });

    // Highlight the arrow
    const pressListener = new PressListener({
      attach: false,
      tandem: Tandem.OPT_OUT
    });
    arrowNode.addInputListener(pressListener);
    pressListener.isHighlightedProperty.link(isHighlighted => {
      arrowNode.fill = isHighlighted ? ARROW_FILL.brighterColor() : ARROW_FILL;
    });
    arrowNode.addInputListener(new CuvetteDragListener(cuvette, modelViewTransform, options.tandem.createTandem('cuvetteDragListener')));

    // adjust touch area for the arrow
    const dx = 0.25 * arrowNode.width;
    const dy = arrowNode.height;
    arrowNode.touchArea = arrowNode.localBounds.dilatedXY(dx, dy);

    // position of the cuvette
    const position = modelViewTransform.modelToViewPosition(cuvette.position);
    this.x = position.x;
    this.y = position.y;
    this.addLinkedElement(cuvette, {
      tandem: options.tandem.createTandem('cuvette')
    });
  }
}

/**
 * Drag listener that is attached to the cuvette's handle.
 */
class CuvetteDragListener extends DragListener {
  constructor(cuvette, modelViewTransform, tandem) {
    const widthRange = cuvette.widthProperty.range;
    let startX; // x coordinate of mouse click
    let startWidth; // width of the cuvette when the drag started

    super({
      allowTouchSnag: true,
      start: event => {
        startX = event.pointer.point.x;
        startWidth = cuvette.widthProperty.value;
      },
      drag: event => {
        const dragX = event.pointer.point.x;
        const deltaWidth = modelViewTransform.viewToModelDeltaX(dragX - startX);
        cuvette.widthProperty.value = Utils.clamp(startWidth + deltaWidth, widthRange.min, widthRange.max);
      },
      end: () => {
        const snapInterval = cuvette.snapIntervalProperty.value;
        if (snapInterval > 0) {
          cuvette.widthProperty.value = Utils.roundToInterval(cuvette.widthProperty.value, snapInterval);
        }
      },
      // phet-io
      tandem: tandem
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
}
beersLawLab.register('CuvetteNode', CuvetteNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlNoYXBlIiwib3B0aW9uaXplIiwiQXJyb3dOb2RlIiwiQ29sb3IiLCJEcmFnTGlzdGVuZXIiLCJOb2RlIiwiUGF0aCIsIlByZXNzTGlzdGVuZXIiLCJSZWN0YW5nbGUiLCJUYW5kZW0iLCJiZWVyc0xhd0xhYiIsIlBFUkNFTlRfRlVMTCIsIlNPTFVUSU9OX0FMUEhBIiwiQVJST1dfTEVOR1RIIiwiQVJST1dfSEVBRF9IRUlHSFQiLCJBUlJPV19IRUFEX1dJRFRIIiwiQVJST1dfVEFJTF9XSURUSCIsIkFSUk9XX0ZJTEwiLCJPUkFOR0UiLCJDdXZldHRlTm9kZSIsImNvbnN0cnVjdG9yIiwiY3V2ZXR0ZSIsInNvbHV0aW9uUHJvcGVydHkiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwicGhldGlvVmlzaWJsZVByb3BlcnR5SW5zdHJ1bWVudGVkIiwiY3V2ZXR0ZU5vZGUiLCJzdHJva2UiLCJsaW5lV2lkdGgiLCJwaWNrYWJsZSIsInNvbHV0aW9uTm9kZSIsImFycm93Tm9kZSIsImN1cnNvciIsInRhaWxXaWR0aCIsImhlYWRXaWR0aCIsImhlYWRIZWlnaHQiLCJkb3VibGVIZWFkIiwiZmlsbCIsInRhbmRlbSIsImNyZWF0ZVRhbmRlbSIsImNoaWxkcmVuIiwid2lkdGhQcm9wZXJ0eSIsImxpbmsiLCJ3aWR0aCIsIm1vZGVsVG9WaWV3RGVsdGFYIiwidmFsdWUiLCJoZWlnaHQiLCJtb2RlbFRvVmlld0RlbHRhWSIsInNldFNoYXBlIiwibW92ZVRvIiwibGluZVRvIiwic2V0UmVjdCIsImxlZnQiLCJib3R0b20iLCJ4IiwicmlnaHQiLCJjb2xvck9ic2VydmVyIiwiY29sb3IiLCJ3aXRoQWxwaGEiLCJkYXJrZXJDb2xvciIsIm5ld1NvbHV0aW9uIiwib2xkU29sdXRpb24iLCJmbHVpZENvbG9yUHJvcGVydHkiLCJ1bmxpbmsiLCJwcmVzc0xpc3RlbmVyIiwiYXR0YWNoIiwiT1BUX09VVCIsImFkZElucHV0TGlzdGVuZXIiLCJpc0hpZ2hsaWdodGVkUHJvcGVydHkiLCJpc0hpZ2hsaWdodGVkIiwiYnJpZ2h0ZXJDb2xvciIsIkN1dmV0dGVEcmFnTGlzdGVuZXIiLCJkeCIsImR5IiwidG91Y2hBcmVhIiwibG9jYWxCb3VuZHMiLCJkaWxhdGVkWFkiLCJwb3NpdGlvbiIsIm1vZGVsVG9WaWV3UG9zaXRpb24iLCJ5IiwiYWRkTGlua2VkRWxlbWVudCIsIndpZHRoUmFuZ2UiLCJyYW5nZSIsInN0YXJ0WCIsInN0YXJ0V2lkdGgiLCJhbGxvd1RvdWNoU25hZyIsInN0YXJ0IiwiZXZlbnQiLCJwb2ludGVyIiwicG9pbnQiLCJkcmFnIiwiZHJhZ1giLCJkZWx0YVdpZHRoIiwidmlld1RvTW9kZWxEZWx0YVgiLCJjbGFtcCIsIm1pbiIsIm1heCIsImVuZCIsInNuYXBJbnRlcnZhbCIsInNuYXBJbnRlcnZhbFByb3BlcnR5Iiwicm91bmRUb0ludGVydmFsIiwiZGlzcG9zZSIsImFzc2VydCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQ3V2ZXR0ZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjdXZldHRlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcbmltcG9ydCBNb2RlbFZpZXdUcmFuc2Zvcm0yIGZyb20gJy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdmlldy9Nb2RlbFZpZXdUcmFuc2Zvcm0yLmpzJztcclxuaW1wb3J0IEFycm93Tm9kZSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvQXJyb3dOb2RlLmpzJztcclxuaW1wb3J0IHsgQ29sb3IsIERyYWdMaXN0ZW5lciwgTm9kZSwgTm9kZU9wdGlvbnMsIFBhdGgsIFByZXNzTGlzdGVuZXIsIFJlY3RhbmdsZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBiZWVyc0xhd0xhYiBmcm9tICcuLi8uLi9iZWVyc0xhd0xhYi5qcyc7XHJcbmltcG9ydCBCZWVyc0xhd1NvbHV0aW9uIGZyb20gJy4uL21vZGVsL0JlZXJzTGF3U29sdXRpb24uanMnO1xyXG5pbXBvcnQgQ3V2ZXR0ZSBmcm9tICcuLi9tb2RlbC9DdXZldHRlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBQRVJDRU5UX0ZVTEwgPSAwLjkyO1xyXG5jb25zdCBTT0xVVElPTl9BTFBIQSA9IDAuNjtcclxuY29uc3QgQVJST1dfTEVOR1RIID0gMTEwO1xyXG5jb25zdCBBUlJPV19IRUFEX0hFSUdIVCA9IDM4O1xyXG5jb25zdCBBUlJPV19IRUFEX1dJRFRIID0gNDU7XHJcbmNvbnN0IEFSUk9XX1RBSUxfV0lEVEggPSAyMztcclxuY29uc3QgQVJST1dfRklMTCA9IENvbG9yLk9SQU5HRTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSBFbXB0eVNlbGZPcHRpb25zO1xyXG5cclxudHlwZSBDdXZldHRlTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tSZXF1aXJlZDxOb2RlT3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ3V2ZXR0ZU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBjdXZldHRlOiBDdXZldHRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgc29sdXRpb25Qcm9wZXJ0eTogUHJvcGVydHk8QmVlcnNMYXdTb2x1dGlvbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IEN1dmV0dGVOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEN1dmV0dGVOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBOb2RlT3B0aW9uc1xyXG4gICAgICBwaGV0aW9WaXNpYmxlUHJvcGVydHlJbnN0cnVtZW50ZWQ6IGZhbHNlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IGN1dmV0dGVOb2RlID0gbmV3IFBhdGgoIG51bGwsIHtcclxuICAgICAgc3Ryb2tlOiAnYmxhY2snLFxyXG4gICAgICBsaW5lV2lkdGg6IDMsXHJcbiAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHNvbHV0aW9uTm9kZSA9IG5ldyBSZWN0YW5nbGUoIDAsIDAsIDEsIDEsIHtcclxuICAgICAgbGluZVdpZHRoOiAwLjUsXHJcbiAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGFycm93Tm9kZSA9IG5ldyBBcnJvd05vZGUoIC1BUlJPV19MRU5HVEggLyAyLCAwLCBBUlJPV19MRU5HVEggLyAyLCAwLCB7XHJcbiAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxyXG4gICAgICB0YWlsV2lkdGg6IEFSUk9XX1RBSUxfV0lEVEgsXHJcbiAgICAgIGhlYWRXaWR0aDogQVJST1dfSEVBRF9XSURUSCxcclxuICAgICAgaGVhZEhlaWdodDogQVJST1dfSEVBRF9IRUlHSFQsXHJcbiAgICAgIGRvdWJsZUhlYWQ6IHRydWUsXHJcbiAgICAgIGZpbGw6IEFSUk9XX0ZJTEwsXHJcbiAgICAgIHN0cm9rZTogJ2JsYWNrJyxcclxuICAgICAgbGluZVdpZHRoOiAxLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2Fycm93Tm9kZScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHJlbmRlcmluZyBvcmRlclxyXG4gICAgdGhpcy5jaGlsZHJlbiA9IFsgc29sdXRpb25Ob2RlLCBjdXZldHRlTm9kZSwgYXJyb3dOb2RlIF07XHJcblxyXG4gICAgLy8gd2hlbiB0aGUgY3V2ZXR0ZSB3aWR0aCBjaGFuZ2VzIC4uLlxyXG4gICAgY3V2ZXR0ZS53aWR0aFByb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgY29uc3Qgd2lkdGggPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGN1dmV0dGUud2lkdGhQcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgICBjb25zdCBoZWlnaHQgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIGN1dmV0dGUuaGVpZ2h0ICk7XHJcbiAgICAgIGN1dmV0dGVOb2RlLnNldFNoYXBlKCBuZXcgU2hhcGUoKS5tb3ZlVG8oIDAsIDAgKS5saW5lVG8oIDAsIGhlaWdodCApLmxpbmVUbyggd2lkdGgsIGhlaWdodCApLmxpbmVUbyggd2lkdGgsIDAgKSApO1xyXG4gICAgICBzb2x1dGlvbk5vZGUuc2V0UmVjdCggMCwgMCwgd2lkdGgsIFBFUkNFTlRfRlVMTCAqIGhlaWdodCApO1xyXG4gICAgICBzb2x1dGlvbk5vZGUubGVmdCA9IGN1dmV0dGVOb2RlLmxlZnQ7XHJcbiAgICAgIHNvbHV0aW9uTm9kZS5ib3R0b20gPSBjdXZldHRlTm9kZS5ib3R0b207XHJcbiAgICAgIGFycm93Tm9kZS54ID0gY3V2ZXR0ZU5vZGUucmlnaHQ7XHJcbiAgICAgIGFycm93Tm9kZS5ib3R0b20gPSBjdXZldHRlTm9kZS5ib3R0b20gLSAxMDtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyB3aGVuIHRoZSBmbHVpZCBjb2xvciBjaGFuZ2VzIC4uLlxyXG4gICAgY29uc3QgY29sb3JPYnNlcnZlciA9ICggY29sb3I6IENvbG9yICkgPT4ge1xyXG4gICAgICBzb2x1dGlvbk5vZGUuZmlsbCA9IGNvbG9yLndpdGhBbHBoYSggU09MVVRJT05fQUxQSEEgKTtcclxuICAgICAgc29sdXRpb25Ob2RlLnN0cm9rZSA9IGNvbG9yLmRhcmtlckNvbG9yKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHdoZW4gdGhlIHNvbHV0aW9uIGNoYW5nZXMsIHJld2lyZSB0aGUgY29sb3Igb2JzZXJ2ZXJcclxuICAgIHNvbHV0aW9uUHJvcGVydHkubGluayggKCBuZXdTb2x1dGlvbiwgb2xkU29sdXRpb24gKSA9PiB7XHJcbiAgICAgIGlmICggb2xkU29sdXRpb24gKSB7XHJcbiAgICAgICAgb2xkU29sdXRpb24uZmx1aWRDb2xvclByb3BlcnR5LnVubGluayggY29sb3JPYnNlcnZlciApO1xyXG4gICAgICB9XHJcbiAgICAgIG5ld1NvbHV0aW9uLmZsdWlkQ29sb3JQcm9wZXJ0eS5saW5rKCBjb2xvck9ic2VydmVyICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gSGlnaGxpZ2h0IHRoZSBhcnJvd1xyXG4gICAgY29uc3QgcHJlc3NMaXN0ZW5lciA9IG5ldyBQcmVzc0xpc3RlbmVyKCB7XHJcbiAgICAgIGF0dGFjaDogZmFsc2UsXHJcbiAgICAgIHRhbmRlbTogVGFuZGVtLk9QVF9PVVRcclxuICAgIH0gKTtcclxuICAgIGFycm93Tm9kZS5hZGRJbnB1dExpc3RlbmVyKCBwcmVzc0xpc3RlbmVyICk7XHJcbiAgICBwcmVzc0xpc3RlbmVyLmlzSGlnaGxpZ2h0ZWRQcm9wZXJ0eS5saW5rKCBpc0hpZ2hsaWdodGVkID0+IHtcclxuICAgICAgYXJyb3dOb2RlLmZpbGwgPSBpc0hpZ2hsaWdodGVkID8gQVJST1dfRklMTC5icmlnaHRlckNvbG9yKCkgOiBBUlJPV19GSUxMO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGFycm93Tm9kZS5hZGRJbnB1dExpc3RlbmVyKCBuZXcgQ3V2ZXR0ZURyYWdMaXN0ZW5lciggY3V2ZXR0ZSwgbW9kZWxWaWV3VHJhbnNmb3JtLFxyXG4gICAgICBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdjdXZldHRlRHJhZ0xpc3RlbmVyJyApICkgKTtcclxuXHJcbiAgICAvLyBhZGp1c3QgdG91Y2ggYXJlYSBmb3IgdGhlIGFycm93XHJcbiAgICBjb25zdCBkeCA9IDAuMjUgKiBhcnJvd05vZGUud2lkdGg7XHJcbiAgICBjb25zdCBkeSA9IGFycm93Tm9kZS5oZWlnaHQ7XHJcbiAgICBhcnJvd05vZGUudG91Y2hBcmVhID0gYXJyb3dOb2RlLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggZHgsIGR5ICk7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gb2YgdGhlIGN1dmV0dGVcclxuICAgIGNvbnN0IHBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIGN1dmV0dGUucG9zaXRpb24gKTtcclxuICAgIHRoaXMueCA9IHBvc2l0aW9uLng7XHJcbiAgICB0aGlzLnkgPSBwb3NpdGlvbi55O1xyXG5cclxuICAgIHRoaXMuYWRkTGlua2VkRWxlbWVudCggY3V2ZXR0ZSwge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2N1dmV0dGUnIClcclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEcmFnIGxpc3RlbmVyIHRoYXQgaXMgYXR0YWNoZWQgdG8gdGhlIGN1dmV0dGUncyBoYW5kbGUuXHJcbiAqL1xyXG5jbGFzcyBDdXZldHRlRHJhZ0xpc3RlbmVyIGV4dGVuZHMgRHJhZ0xpc3RlbmVyIHtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBjdXZldHRlOiBDdXZldHRlLCBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsIHRhbmRlbTogVGFuZGVtICkge1xyXG5cclxuICAgIGNvbnN0IHdpZHRoUmFuZ2UgPSBjdXZldHRlLndpZHRoUHJvcGVydHkucmFuZ2U7XHJcblxyXG4gICAgbGV0IHN0YXJ0WDogbnVtYmVyOyAvLyB4IGNvb3JkaW5hdGUgb2YgbW91c2UgY2xpY2tcclxuICAgIGxldCBzdGFydFdpZHRoOiBudW1iZXI7IC8vIHdpZHRoIG9mIHRoZSBjdXZldHRlIHdoZW4gdGhlIGRyYWcgc3RhcnRlZFxyXG5cclxuICAgIHN1cGVyKCB7XHJcblxyXG4gICAgICBhbGxvd1RvdWNoU25hZzogdHJ1ZSxcclxuXHJcbiAgICAgIHN0YXJ0OiBldmVudCA9PiB7XHJcbiAgICAgICAgc3RhcnRYID0gZXZlbnQucG9pbnRlci5wb2ludC54O1xyXG4gICAgICAgIHN0YXJ0V2lkdGggPSBjdXZldHRlLndpZHRoUHJvcGVydHkudmFsdWU7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICBkcmFnOiBldmVudCA9PiB7XHJcbiAgICAgICAgY29uc3QgZHJhZ1ggPSBldmVudC5wb2ludGVyLnBvaW50Lng7XHJcbiAgICAgICAgY29uc3QgZGVsdGFXaWR0aCA9IG1vZGVsVmlld1RyYW5zZm9ybS52aWV3VG9Nb2RlbERlbHRhWCggZHJhZ1ggLSBzdGFydFggKTtcclxuICAgICAgICBjdXZldHRlLndpZHRoUHJvcGVydHkudmFsdWUgPSBVdGlscy5jbGFtcCggc3RhcnRXaWR0aCArIGRlbHRhV2lkdGgsIHdpZHRoUmFuZ2UubWluLCB3aWR0aFJhbmdlLm1heCApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgZW5kOiAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc25hcEludGVydmFsID0gY3V2ZXR0ZS5zbmFwSW50ZXJ2YWxQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgICBpZiAoIHNuYXBJbnRlcnZhbCA+IDAgKSB7XHJcbiAgICAgICAgICBjdXZldHRlLndpZHRoUHJvcGVydHkudmFsdWUgPSBVdGlscy5yb3VuZFRvSW50ZXJ2YWwoIGN1dmV0dGUud2lkdGhQcm9wZXJ0eS52YWx1ZSwgc25hcEludGVydmFsICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG5cclxuICAgICAgLy8gcGhldC1pb1xyXG4gICAgICB0YW5kZW06IHRhbmRlbVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmJlZXJzTGF3TGFiLnJlZ2lzdGVyKCAnQ3V2ZXR0ZU5vZGUnLCBDdXZldHRlTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFHQSxPQUFPQSxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLFNBQVNDLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsT0FBT0MsU0FBUyxNQUE0Qix1Q0FBdUM7QUFHbkYsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQztBQUNoRSxTQUFTQyxLQUFLLEVBQUVDLFlBQVksRUFBRUMsSUFBSSxFQUFlQyxJQUFJLEVBQUVDLGFBQWEsRUFBRUMsU0FBUyxRQUFRLG1DQUFtQztBQUMxSCxPQUFPQyxNQUFNLE1BQU0saUNBQWlDO0FBQ3BELE9BQU9DLFdBQVcsTUFBTSxzQkFBc0I7QUFJOUM7QUFDQSxNQUFNQyxZQUFZLEdBQUcsSUFBSTtBQUN6QixNQUFNQyxjQUFjLEdBQUcsR0FBRztBQUMxQixNQUFNQyxZQUFZLEdBQUcsR0FBRztBQUN4QixNQUFNQyxpQkFBaUIsR0FBRyxFQUFFO0FBQzVCLE1BQU1DLGdCQUFnQixHQUFHLEVBQUU7QUFDM0IsTUFBTUMsZ0JBQWdCLEdBQUcsRUFBRTtBQUMzQixNQUFNQyxVQUFVLEdBQUdkLEtBQUssQ0FBQ2UsTUFBTTtBQU0vQixlQUFlLE1BQU1DLFdBQVcsU0FBU2QsSUFBSSxDQUFDO0VBRXJDZSxXQUFXQSxDQUFFQyxPQUFnQixFQUNoQkMsZ0JBQTRDLEVBQzVDQyxrQkFBdUMsRUFDdkNDLGVBQW1DLEVBQUc7SUFFeEQsTUFBTUMsT0FBTyxHQUFHeEIsU0FBUyxDQUErQyxDQUFDLENBQUU7TUFFekU7TUFDQXlCLGlDQUFpQyxFQUFFO0lBQ3JDLENBQUMsRUFBRUYsZUFBZ0IsQ0FBQztJQUVwQixLQUFLLENBQUVDLE9BQVEsQ0FBQztJQUVoQixNQUFNRSxXQUFXLEdBQUcsSUFBSXJCLElBQUksQ0FBRSxJQUFJLEVBQUU7TUFDbENzQixNQUFNLEVBQUUsT0FBTztNQUNmQyxTQUFTLEVBQUUsQ0FBQztNQUNaQyxRQUFRLEVBQUU7SUFDWixDQUFFLENBQUM7SUFFSCxNQUFNQyxZQUFZLEdBQUcsSUFBSXZCLFNBQVMsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUU7TUFDOUNxQixTQUFTLEVBQUUsR0FBRztNQUNkQyxRQUFRLEVBQUU7SUFDWixDQUFFLENBQUM7SUFFSCxNQUFNRSxTQUFTLEdBQUcsSUFBSTlCLFNBQVMsQ0FBRSxDQUFDVyxZQUFZLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRUEsWUFBWSxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7TUFDMUVvQixNQUFNLEVBQUUsU0FBUztNQUNqQkMsU0FBUyxFQUFFbEIsZ0JBQWdCO01BQzNCbUIsU0FBUyxFQUFFcEIsZ0JBQWdCO01BQzNCcUIsVUFBVSxFQUFFdEIsaUJBQWlCO01BQzdCdUIsVUFBVSxFQUFFLElBQUk7TUFDaEJDLElBQUksRUFBRXJCLFVBQVU7TUFDaEJXLE1BQU0sRUFBRSxPQUFPO01BQ2ZDLFNBQVMsRUFBRSxDQUFDO01BQ1pVLE1BQU0sRUFBRWQsT0FBTyxDQUFDYyxNQUFNLENBQUNDLFlBQVksQ0FBRSxXQUFZO0lBQ25ELENBQUUsQ0FBQzs7SUFFSDtJQUNBLElBQUksQ0FBQ0MsUUFBUSxHQUFHLENBQUVWLFlBQVksRUFBRUosV0FBVyxFQUFFSyxTQUFTLENBQUU7O0lBRXhEO0lBQ0FYLE9BQU8sQ0FBQ3FCLGFBQWEsQ0FBQ0MsSUFBSSxDQUFFLE1BQU07TUFDaEMsTUFBTUMsS0FBSyxHQUFHckIsa0JBQWtCLENBQUNzQixpQkFBaUIsQ0FBRXhCLE9BQU8sQ0FBQ3FCLGFBQWEsQ0FBQ0ksS0FBTSxDQUFDO01BQ2pGLE1BQU1DLE1BQU0sR0FBR3hCLGtCQUFrQixDQUFDeUIsaUJBQWlCLENBQUUzQixPQUFPLENBQUMwQixNQUFPLENBQUM7TUFDckVwQixXQUFXLENBQUNzQixRQUFRLENBQUUsSUFBSWpELEtBQUssQ0FBQyxDQUFDLENBQUNrRCxNQUFNLENBQUUsQ0FBQyxFQUFFLENBQUUsQ0FBQyxDQUFDQyxNQUFNLENBQUUsQ0FBQyxFQUFFSixNQUFPLENBQUMsQ0FBQ0ksTUFBTSxDQUFFUCxLQUFLLEVBQUVHLE1BQU8sQ0FBQyxDQUFDSSxNQUFNLENBQUVQLEtBQUssRUFBRSxDQUFFLENBQUUsQ0FBQztNQUNqSGIsWUFBWSxDQUFDcUIsT0FBTyxDQUFFLENBQUMsRUFBRSxDQUFDLEVBQUVSLEtBQUssRUFBRWpDLFlBQVksR0FBR29DLE1BQU8sQ0FBQztNQUMxRGhCLFlBQVksQ0FBQ3NCLElBQUksR0FBRzFCLFdBQVcsQ0FBQzBCLElBQUk7TUFDcEN0QixZQUFZLENBQUN1QixNQUFNLEdBQUczQixXQUFXLENBQUMyQixNQUFNO01BQ3hDdEIsU0FBUyxDQUFDdUIsQ0FBQyxHQUFHNUIsV0FBVyxDQUFDNkIsS0FBSztNQUMvQnhCLFNBQVMsQ0FBQ3NCLE1BQU0sR0FBRzNCLFdBQVcsQ0FBQzJCLE1BQU0sR0FBRyxFQUFFO0lBQzVDLENBQUUsQ0FBQzs7SUFFSDtJQUNBLE1BQU1HLGFBQWEsR0FBS0MsS0FBWSxJQUFNO01BQ3hDM0IsWUFBWSxDQUFDTyxJQUFJLEdBQUdvQixLQUFLLENBQUNDLFNBQVMsQ0FBRS9DLGNBQWUsQ0FBQztNQUNyRG1CLFlBQVksQ0FBQ0gsTUFBTSxHQUFHOEIsS0FBSyxDQUFDRSxXQUFXLENBQUMsQ0FBQztJQUMzQyxDQUFDOztJQUVEO0lBQ0F0QyxnQkFBZ0IsQ0FBQ3FCLElBQUksQ0FBRSxDQUFFa0IsV0FBVyxFQUFFQyxXQUFXLEtBQU07TUFDckQsSUFBS0EsV0FBVyxFQUFHO1FBQ2pCQSxXQUFXLENBQUNDLGtCQUFrQixDQUFDQyxNQUFNLENBQUVQLGFBQWMsQ0FBQztNQUN4RDtNQUNBSSxXQUFXLENBQUNFLGtCQUFrQixDQUFDcEIsSUFBSSxDQUFFYyxhQUFjLENBQUM7SUFDdEQsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTVEsYUFBYSxHQUFHLElBQUkxRCxhQUFhLENBQUU7TUFDdkMyRCxNQUFNLEVBQUUsS0FBSztNQUNiM0IsTUFBTSxFQUFFOUIsTUFBTSxDQUFDMEQ7SUFDakIsQ0FBRSxDQUFDO0lBQ0huQyxTQUFTLENBQUNvQyxnQkFBZ0IsQ0FBRUgsYUFBYyxDQUFDO0lBQzNDQSxhQUFhLENBQUNJLHFCQUFxQixDQUFDMUIsSUFBSSxDQUFFMkIsYUFBYSxJQUFJO01BQ3pEdEMsU0FBUyxDQUFDTSxJQUFJLEdBQUdnQyxhQUFhLEdBQUdyRCxVQUFVLENBQUNzRCxhQUFhLENBQUMsQ0FBQyxHQUFHdEQsVUFBVTtJQUMxRSxDQUFFLENBQUM7SUFFSGUsU0FBUyxDQUFDb0MsZ0JBQWdCLENBQUUsSUFBSUksbUJBQW1CLENBQUVuRCxPQUFPLEVBQUVFLGtCQUFrQixFQUM5RUUsT0FBTyxDQUFDYyxNQUFNLENBQUNDLFlBQVksQ0FBRSxxQkFBc0IsQ0FBRSxDQUFFLENBQUM7O0lBRTFEO0lBQ0EsTUFBTWlDLEVBQUUsR0FBRyxJQUFJLEdBQUd6QyxTQUFTLENBQUNZLEtBQUs7SUFDakMsTUFBTThCLEVBQUUsR0FBRzFDLFNBQVMsQ0FBQ2UsTUFBTTtJQUMzQmYsU0FBUyxDQUFDMkMsU0FBUyxHQUFHM0MsU0FBUyxDQUFDNEMsV0FBVyxDQUFDQyxTQUFTLENBQUVKLEVBQUUsRUFBRUMsRUFBRyxDQUFDOztJQUUvRDtJQUNBLE1BQU1JLFFBQVEsR0FBR3ZELGtCQUFrQixDQUFDd0QsbUJBQW1CLENBQUUxRCxPQUFPLENBQUN5RCxRQUFTLENBQUM7SUFDM0UsSUFBSSxDQUFDdkIsQ0FBQyxHQUFHdUIsUUFBUSxDQUFDdkIsQ0FBQztJQUNuQixJQUFJLENBQUN5QixDQUFDLEdBQUdGLFFBQVEsQ0FBQ0UsQ0FBQztJQUVuQixJQUFJLENBQUNDLGdCQUFnQixDQUFFNUQsT0FBTyxFQUFFO01BQzlCa0IsTUFBTSxFQUFFZCxPQUFPLENBQUNjLE1BQU0sQ0FBQ0MsWUFBWSxDQUFFLFNBQVU7SUFDakQsQ0FBRSxDQUFDO0VBQ0w7QUFDRjs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxNQUFNZ0MsbUJBQW1CLFNBQVNwRSxZQUFZLENBQUM7RUFFdENnQixXQUFXQSxDQUFFQyxPQUFnQixFQUFFRSxrQkFBdUMsRUFBRWdCLE1BQWMsRUFBRztJQUU5RixNQUFNMkMsVUFBVSxHQUFHN0QsT0FBTyxDQUFDcUIsYUFBYSxDQUFDeUMsS0FBSztJQUU5QyxJQUFJQyxNQUFjLENBQUMsQ0FBQztJQUNwQixJQUFJQyxVQUFrQixDQUFDLENBQUM7O0lBRXhCLEtBQUssQ0FBRTtNQUVMQyxjQUFjLEVBQUUsSUFBSTtNQUVwQkMsS0FBSyxFQUFFQyxLQUFLLElBQUk7UUFDZEosTUFBTSxHQUFHSSxLQUFLLENBQUNDLE9BQU8sQ0FBQ0MsS0FBSyxDQUFDbkMsQ0FBQztRQUM5QjhCLFVBQVUsR0FBR2hFLE9BQU8sQ0FBQ3FCLGFBQWEsQ0FBQ0ksS0FBSztNQUMxQyxDQUFDO01BRUQ2QyxJQUFJLEVBQUVILEtBQUssSUFBSTtRQUNiLE1BQU1JLEtBQUssR0FBR0osS0FBSyxDQUFDQyxPQUFPLENBQUNDLEtBQUssQ0FBQ25DLENBQUM7UUFDbkMsTUFBTXNDLFVBQVUsR0FBR3RFLGtCQUFrQixDQUFDdUUsaUJBQWlCLENBQUVGLEtBQUssR0FBR1IsTUFBTyxDQUFDO1FBQ3pFL0QsT0FBTyxDQUFDcUIsYUFBYSxDQUFDSSxLQUFLLEdBQUcvQyxLQUFLLENBQUNnRyxLQUFLLENBQUVWLFVBQVUsR0FBR1EsVUFBVSxFQUFFWCxVQUFVLENBQUNjLEdBQUcsRUFBRWQsVUFBVSxDQUFDZSxHQUFJLENBQUM7TUFDdEcsQ0FBQztNQUVEQyxHQUFHLEVBQUVBLENBQUEsS0FBTTtRQUNULE1BQU1DLFlBQVksR0FBRzlFLE9BQU8sQ0FBQytFLG9CQUFvQixDQUFDdEQsS0FBSztRQUN2RCxJQUFLcUQsWUFBWSxHQUFHLENBQUMsRUFBRztVQUN0QjlFLE9BQU8sQ0FBQ3FCLGFBQWEsQ0FBQ0ksS0FBSyxHQUFHL0MsS0FBSyxDQUFDc0csZUFBZSxDQUFFaEYsT0FBTyxDQUFDcUIsYUFBYSxDQUFDSSxLQUFLLEVBQUVxRCxZQUFhLENBQUM7UUFDbEc7TUFDRixDQUFDO01BRUQ7TUFDQTVELE1BQU0sRUFBRUE7SUFDVixDQUFFLENBQUM7RUFDTDtFQUVnQitELE9BQU9BLENBQUEsRUFBUztJQUM5QkMsTUFBTSxJQUFJQSxNQUFNLENBQUUsS0FBSyxFQUFFLDhEQUErRCxDQUFDO0lBQ3pGLEtBQUssQ0FBQ0QsT0FBTyxDQUFDLENBQUM7RUFDakI7QUFDRjtBQUVBNUYsV0FBVyxDQUFDOEYsUUFBUSxDQUFFLGFBQWEsRUFBRXJGLFdBQVksQ0FBQyJ9