// Copyright 2015-2020, University of Colorado Boulder

/**
 * main view for the Expression Exchange 'Game' screen
 *
 * @author John Blanco
 */

import ScreenView from '../../../../joist/js/ScreenView.js';
import Animation from '../../../../twixt/js/Animation.js';
import Easing from '../../../../twixt/js/Easing.js';
import GameAudioPlayer from '../../../../vegas/js/GameAudioPlayer.js';
import expressionExchange from '../../expressionExchange.js';
import EEGameModel from '../model/EEGameModel.js';
import EEGameLevelIconFactory from './EEGameLevelIconFactory.js';
import EEGameLevelView from './EEGameLevelView.js';
import LevelSelectionNode from './LevelSelectionNode.js';

// constants
const SCREEN_CHANGE_TIME = 1; // seconds

class EEGameScreenView extends ScreenView {
  /**
   * @param {EEGameLevel} gameModel
   */
  constructor(gameModel) {
    super();
    // @private {EEGameModel}
    this.gameModel = gameModel;

    // create the sound player for the game sounds
    const gameAudioPlayer = new GameAudioPlayer();

    // consolidate the level scores into an array for the level selection node
    const levelScoreProperties = [];
    gameModel.gameLevels.forEach(gameLevelModel => {
      levelScoreProperties.push(gameLevelModel.scoreProperty);
    });

    // create the icons used on the level selection buttons
    const levelSelectionItemNodeIcons = [];
    _.times(EEGameModel.NUMBER_OF_LEVELS, level => {
      levelSelectionItemNodeIcons.push(EEGameLevelIconFactory.createIcon(level));
    });

    // add the node that allows the user to choose a game level to play
    const levelSelectionNode = new LevelSelectionNode(level => {
      gameModel.selectLevel(level);
    }, () => {
      gameModel.reset();
    }, levelSelectionItemNodeIcons, levelScoreProperties, {
      layoutBoundsProperty: this.visibleBoundsProperty,
      centerX: this.layoutBounds.centerX
    });
    this.addChild(levelSelectionNode);

    // currently displayed level or level selection node
    let nodeInViewport = levelSelectionNode;

    // create the game level views and add them to the main game play node
    this.gameLevelViews = [];
    gameModel.gameLevels.forEach(levelModel => {
      const gameLevelView = new EEGameLevelView(gameModel, levelModel, this.layoutBounds, this.visibleBoundsProperty, gameAudioPlayer);
      gameLevelView.visible = false; // will be made visible when the corresponding level is activated
      this.gameLevelViews.push(gameLevelView);
      this.addChild(gameLevelView);
    });

    // hook up the animations for moving between level selection and game play
    gameModel.currentLevelProperty.lazyLink((newLevel, oldLevel) => {
      const slideDistance = this.visibleBoundsProperty.get().width;
      const incomingViewNode = newLevel === null ? levelSelectionNode : this.gameLevelViews[newLevel.levelNumber];
      const outgoingViewNode = oldLevel === null ? levelSelectionNode : this.gameLevelViews[oldLevel.levelNumber];
      let outgoingNodeDestinationX;
      let incomingNodeStartX;

      // prevent interaction during animation
      incomingViewNode.pickable = false;
      outgoingViewNode.pickable = false;

      // determine how the incoming and outgoing nodes should move
      if (newLevel === null) {
        // level selection screen is coming in, which is a left-to-right motion
        incomingNodeStartX = this.layoutBounds.minX - slideDistance;
        outgoingNodeDestinationX = this.layoutBounds.minX + slideDistance;
      } else {
        // a game level node is coming in, which is a right-to-left motion
        incomingNodeStartX = this.layoutBounds.minX + slideDistance;
        outgoingNodeDestinationX = this.layoutBounds.minX - slideDistance;
      }

      // move out the old node
      const moveOutAnimation = new Animation({
        duration: SCREEN_CHANGE_TIME,
        easing: Easing.CUBIC_IN_OUT,
        setValue: newXPosition => {
          nodeInViewport.x = newXPosition;
        },
        from: nodeInViewport.x,
        to: outgoingNodeDestinationX
      });
      moveOutAnimation.beginEmitter.addListener(() => {
        outgoingViewNode.inViewportProperty && outgoingViewNode.inViewportProperty.set(false);
      });
      moveOutAnimation.finishEmitter.addListener(() => {
        outgoingViewNode.visible = false;
      });
      moveOutAnimation.start();

      // move in the new node
      const moveInAnimation = new Animation({
        duration: SCREEN_CHANGE_TIME,
        easing: Easing.CUBIC_IN_OUT,
        setValue: newXPosition => {
          incomingViewNode.x = newXPosition;
        },
        from: incomingNodeStartX,
        to: this.layoutBounds.minX
      });
      moveInAnimation.beginEmitter.addListener(() => {
        incomingViewNode.visible = true;
      });
      moveInAnimation.finishEmitter.addListener(() => {
        nodeInViewport = incomingViewNode;
        nodeInViewport.pickable = true;
        nodeInViewport.inViewportProperty && nodeInViewport.inViewportProperty.set(true);
      });
      moveInAnimation.start();
    });
  }

  /**
   * step the view, needed for animations
   * @param {number} dt
   * @public
   */
  step(dt) {
    const currentLevel = this.gameModel.currentLevelProperty.get();
    if (currentLevel !== null) {
      this.gameLevelViews[currentLevel.levelNumber].step(dt);
    }
  }
}
expressionExchange.register('EEGameScreenView', EEGameScreenView);
export default EEGameScreenView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY3JlZW5WaWV3IiwiQW5pbWF0aW9uIiwiRWFzaW5nIiwiR2FtZUF1ZGlvUGxheWVyIiwiZXhwcmVzc2lvbkV4Y2hhbmdlIiwiRUVHYW1lTW9kZWwiLCJFRUdhbWVMZXZlbEljb25GYWN0b3J5IiwiRUVHYW1lTGV2ZWxWaWV3IiwiTGV2ZWxTZWxlY3Rpb25Ob2RlIiwiU0NSRUVOX0NIQU5HRV9USU1FIiwiRUVHYW1lU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwiZ2FtZU1vZGVsIiwiZ2FtZUF1ZGlvUGxheWVyIiwibGV2ZWxTY29yZVByb3BlcnRpZXMiLCJnYW1lTGV2ZWxzIiwiZm9yRWFjaCIsImdhbWVMZXZlbE1vZGVsIiwicHVzaCIsInNjb3JlUHJvcGVydHkiLCJsZXZlbFNlbGVjdGlvbkl0ZW1Ob2RlSWNvbnMiLCJfIiwidGltZXMiLCJOVU1CRVJfT0ZfTEVWRUxTIiwibGV2ZWwiLCJjcmVhdGVJY29uIiwibGV2ZWxTZWxlY3Rpb25Ob2RlIiwic2VsZWN0TGV2ZWwiLCJyZXNldCIsImxheW91dEJvdW5kc1Byb3BlcnR5IiwidmlzaWJsZUJvdW5kc1Byb3BlcnR5IiwiY2VudGVyWCIsImxheW91dEJvdW5kcyIsImFkZENoaWxkIiwibm9kZUluVmlld3BvcnQiLCJnYW1lTGV2ZWxWaWV3cyIsImxldmVsTW9kZWwiLCJnYW1lTGV2ZWxWaWV3IiwidmlzaWJsZSIsImN1cnJlbnRMZXZlbFByb3BlcnR5IiwibGF6eUxpbmsiLCJuZXdMZXZlbCIsIm9sZExldmVsIiwic2xpZGVEaXN0YW5jZSIsImdldCIsIndpZHRoIiwiaW5jb21pbmdWaWV3Tm9kZSIsImxldmVsTnVtYmVyIiwib3V0Z29pbmdWaWV3Tm9kZSIsIm91dGdvaW5nTm9kZURlc3RpbmF0aW9uWCIsImluY29taW5nTm9kZVN0YXJ0WCIsInBpY2thYmxlIiwibWluWCIsIm1vdmVPdXRBbmltYXRpb24iLCJkdXJhdGlvbiIsImVhc2luZyIsIkNVQklDX0lOX09VVCIsInNldFZhbHVlIiwibmV3WFBvc2l0aW9uIiwieCIsImZyb20iLCJ0byIsImJlZ2luRW1pdHRlciIsImFkZExpc3RlbmVyIiwiaW5WaWV3cG9ydFByb3BlcnR5Iiwic2V0IiwiZmluaXNoRW1pdHRlciIsInN0YXJ0IiwibW92ZUluQW5pbWF0aW9uIiwic3RlcCIsImR0IiwiY3VycmVudExldmVsIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFRUdhbWVTY3JlZW5WaWV3LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE1LTIwMjAsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIG1haW4gdmlldyBmb3IgdGhlIEV4cHJlc3Npb24gRXhjaGFuZ2UgJ0dhbWUnIHNjcmVlblxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IFNjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvU2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCBBbmltYXRpb24gZnJvbSAnLi4vLi4vLi4vLi4vdHdpeHQvanMvQW5pbWF0aW9uLmpzJztcclxuaW1wb3J0IEVhc2luZyBmcm9tICcuLi8uLi8uLi8uLi90d2l4dC9qcy9FYXNpbmcuanMnO1xyXG5pbXBvcnQgR2FtZUF1ZGlvUGxheWVyIGZyb20gJy4uLy4uLy4uLy4uL3ZlZ2FzL2pzL0dhbWVBdWRpb1BsYXllci5qcyc7XHJcbmltcG9ydCBleHByZXNzaW9uRXhjaGFuZ2UgZnJvbSAnLi4vLi4vZXhwcmVzc2lvbkV4Y2hhbmdlLmpzJztcclxuaW1wb3J0IEVFR2FtZU1vZGVsIGZyb20gJy4uL21vZGVsL0VFR2FtZU1vZGVsLmpzJztcclxuaW1wb3J0IEVFR2FtZUxldmVsSWNvbkZhY3RvcnkgZnJvbSAnLi9FRUdhbWVMZXZlbEljb25GYWN0b3J5LmpzJztcclxuaW1wb3J0IEVFR2FtZUxldmVsVmlldyBmcm9tICcuL0VFR2FtZUxldmVsVmlldy5qcyc7XHJcbmltcG9ydCBMZXZlbFNlbGVjdGlvbk5vZGUgZnJvbSAnLi9MZXZlbFNlbGVjdGlvbk5vZGUuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFNDUkVFTl9DSEFOR0VfVElNRSA9IDE7IC8vIHNlY29uZHNcclxuXHJcbmNsYXNzIEVFR2FtZVNjcmVlblZpZXcgZXh0ZW5kcyBTY3JlZW5WaWV3IHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtFRUdhbWVMZXZlbH0gZ2FtZU1vZGVsXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGdhbWVNb2RlbCApIHtcclxuXHJcbiAgICBzdXBlcigpO1xyXG4gICAgLy8gQHByaXZhdGUge0VFR2FtZU1vZGVsfVxyXG4gICAgdGhpcy5nYW1lTW9kZWwgPSBnYW1lTW9kZWw7XHJcblxyXG4gICAgLy8gY3JlYXRlIHRoZSBzb3VuZCBwbGF5ZXIgZm9yIHRoZSBnYW1lIHNvdW5kc1xyXG4gICAgY29uc3QgZ2FtZUF1ZGlvUGxheWVyID0gbmV3IEdhbWVBdWRpb1BsYXllcigpO1xyXG5cclxuICAgIC8vIGNvbnNvbGlkYXRlIHRoZSBsZXZlbCBzY29yZXMgaW50byBhbiBhcnJheSBmb3IgdGhlIGxldmVsIHNlbGVjdGlvbiBub2RlXHJcbiAgICBjb25zdCBsZXZlbFNjb3JlUHJvcGVydGllcyA9IFtdO1xyXG4gICAgZ2FtZU1vZGVsLmdhbWVMZXZlbHMuZm9yRWFjaCggZ2FtZUxldmVsTW9kZWwgPT4ge1xyXG4gICAgICBsZXZlbFNjb3JlUHJvcGVydGllcy5wdXNoKCBnYW1lTGV2ZWxNb2RlbC5zY29yZVByb3BlcnR5ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gY3JlYXRlIHRoZSBpY29ucyB1c2VkIG9uIHRoZSBsZXZlbCBzZWxlY3Rpb24gYnV0dG9uc1xyXG4gICAgY29uc3QgbGV2ZWxTZWxlY3Rpb25JdGVtTm9kZUljb25zID0gW107XHJcbiAgICBfLnRpbWVzKCBFRUdhbWVNb2RlbC5OVU1CRVJfT0ZfTEVWRUxTLCBsZXZlbCA9PiB7XHJcbiAgICAgIGxldmVsU2VsZWN0aW9uSXRlbU5vZGVJY29ucy5wdXNoKCBFRUdhbWVMZXZlbEljb25GYWN0b3J5LmNyZWF0ZUljb24oIGxldmVsICkgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIG5vZGUgdGhhdCBhbGxvd3MgdGhlIHVzZXIgdG8gY2hvb3NlIGEgZ2FtZSBsZXZlbCB0byBwbGF5XHJcbiAgICBjb25zdCBsZXZlbFNlbGVjdGlvbk5vZGUgPSBuZXcgTGV2ZWxTZWxlY3Rpb25Ob2RlKFxyXG4gICAgICBsZXZlbCA9PiB7IGdhbWVNb2RlbC5zZWxlY3RMZXZlbCggbGV2ZWwgKTsgfSxcclxuICAgICAgKCkgPT4geyBnYW1lTW9kZWwucmVzZXQoKTsgfSxcclxuICAgICAgbGV2ZWxTZWxlY3Rpb25JdGVtTm9kZUljb25zLFxyXG4gICAgICBsZXZlbFNjb3JlUHJvcGVydGllcyxcclxuICAgICAge1xyXG4gICAgICAgIGxheW91dEJvdW5kc1Byb3BlcnR5OiB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgICBjZW50ZXJYOiB0aGlzLmxheW91dEJvdW5kcy5jZW50ZXJYXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggbGV2ZWxTZWxlY3Rpb25Ob2RlICk7XHJcblxyXG4gICAgLy8gY3VycmVudGx5IGRpc3BsYXllZCBsZXZlbCBvciBsZXZlbCBzZWxlY3Rpb24gbm9kZVxyXG4gICAgbGV0IG5vZGVJblZpZXdwb3J0ID0gbGV2ZWxTZWxlY3Rpb25Ob2RlO1xyXG5cclxuICAgIC8vIGNyZWF0ZSB0aGUgZ2FtZSBsZXZlbCB2aWV3cyBhbmQgYWRkIHRoZW0gdG8gdGhlIG1haW4gZ2FtZSBwbGF5IG5vZGVcclxuICAgIHRoaXMuZ2FtZUxldmVsVmlld3MgPSBbXTtcclxuICAgIGdhbWVNb2RlbC5nYW1lTGV2ZWxzLmZvckVhY2goIGxldmVsTW9kZWwgPT4ge1xyXG4gICAgICBjb25zdCBnYW1lTGV2ZWxWaWV3ID0gbmV3IEVFR2FtZUxldmVsVmlldyhcclxuICAgICAgICBnYW1lTW9kZWwsXHJcbiAgICAgICAgbGV2ZWxNb2RlbCxcclxuICAgICAgICB0aGlzLmxheW91dEJvdW5kcyxcclxuICAgICAgICB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgICBnYW1lQXVkaW9QbGF5ZXJcclxuICAgICAgKTtcclxuICAgICAgZ2FtZUxldmVsVmlldy52aXNpYmxlID0gZmFsc2U7IC8vIHdpbGwgYmUgbWFkZSB2aXNpYmxlIHdoZW4gdGhlIGNvcnJlc3BvbmRpbmcgbGV2ZWwgaXMgYWN0aXZhdGVkXHJcbiAgICAgIHRoaXMuZ2FtZUxldmVsVmlld3MucHVzaCggZ2FtZUxldmVsVmlldyApO1xyXG4gICAgICB0aGlzLmFkZENoaWxkKCBnYW1lTGV2ZWxWaWV3ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gaG9vayB1cCB0aGUgYW5pbWF0aW9ucyBmb3IgbW92aW5nIGJldHdlZW4gbGV2ZWwgc2VsZWN0aW9uIGFuZCBnYW1lIHBsYXlcclxuICAgIGdhbWVNb2RlbC5jdXJyZW50TGV2ZWxQcm9wZXJ0eS5sYXp5TGluayggKCBuZXdMZXZlbCwgb2xkTGV2ZWwgKSA9PiB7XHJcblxyXG4gICAgICBjb25zdCBzbGlkZURpc3RhbmNlID0gdGhpcy52aXNpYmxlQm91bmRzUHJvcGVydHkuZ2V0KCkud2lkdGg7XHJcbiAgICAgIGNvbnN0IGluY29taW5nVmlld05vZGUgPSBuZXdMZXZlbCA9PT0gbnVsbCA/IGxldmVsU2VsZWN0aW9uTm9kZSA6IHRoaXMuZ2FtZUxldmVsVmlld3NbIG5ld0xldmVsLmxldmVsTnVtYmVyIF07XHJcbiAgICAgIGNvbnN0IG91dGdvaW5nVmlld05vZGUgPSBvbGRMZXZlbCA9PT0gbnVsbCA/IGxldmVsU2VsZWN0aW9uTm9kZSA6IHRoaXMuZ2FtZUxldmVsVmlld3NbIG9sZExldmVsLmxldmVsTnVtYmVyIF07XHJcbiAgICAgIGxldCBvdXRnb2luZ05vZGVEZXN0aW5hdGlvblg7XHJcbiAgICAgIGxldCBpbmNvbWluZ05vZGVTdGFydFg7XHJcblxyXG4gICAgICAvLyBwcmV2ZW50IGludGVyYWN0aW9uIGR1cmluZyBhbmltYXRpb25cclxuICAgICAgaW5jb21pbmdWaWV3Tm9kZS5waWNrYWJsZSA9IGZhbHNlO1xyXG4gICAgICBvdXRnb2luZ1ZpZXdOb2RlLnBpY2thYmxlID0gZmFsc2U7XHJcblxyXG4gICAgICAvLyBkZXRlcm1pbmUgaG93IHRoZSBpbmNvbWluZyBhbmQgb3V0Z29pbmcgbm9kZXMgc2hvdWxkIG1vdmVcclxuICAgICAgaWYgKCBuZXdMZXZlbCA9PT0gbnVsbCApIHtcclxuXHJcbiAgICAgICAgLy8gbGV2ZWwgc2VsZWN0aW9uIHNjcmVlbiBpcyBjb21pbmcgaW4sIHdoaWNoIGlzIGEgbGVmdC10by1yaWdodCBtb3Rpb25cclxuICAgICAgICBpbmNvbWluZ05vZGVTdGFydFggPSB0aGlzLmxheW91dEJvdW5kcy5taW5YIC0gc2xpZGVEaXN0YW5jZTtcclxuICAgICAgICBvdXRnb2luZ05vZGVEZXN0aW5hdGlvblggPSB0aGlzLmxheW91dEJvdW5kcy5taW5YICsgc2xpZGVEaXN0YW5jZTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgLy8gYSBnYW1lIGxldmVsIG5vZGUgaXMgY29taW5nIGluLCB3aGljaCBpcyBhIHJpZ2h0LXRvLWxlZnQgbW90aW9uXHJcbiAgICAgICAgaW5jb21pbmdOb2RlU3RhcnRYID0gdGhpcy5sYXlvdXRCb3VuZHMubWluWCArIHNsaWRlRGlzdGFuY2U7XHJcbiAgICAgICAgb3V0Z29pbmdOb2RlRGVzdGluYXRpb25YID0gdGhpcy5sYXlvdXRCb3VuZHMubWluWCAtIHNsaWRlRGlzdGFuY2U7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIG1vdmUgb3V0IHRoZSBvbGQgbm9kZVxyXG4gICAgICBjb25zdCBtb3ZlT3V0QW5pbWF0aW9uID0gbmV3IEFuaW1hdGlvbigge1xyXG4gICAgICAgIGR1cmF0aW9uOiBTQ1JFRU5fQ0hBTkdFX1RJTUUsXHJcbiAgICAgICAgZWFzaW5nOiBFYXNpbmcuQ1VCSUNfSU5fT1VULFxyXG4gICAgICAgIHNldFZhbHVlOiBuZXdYUG9zaXRpb24gPT4ge1xyXG4gICAgICAgICAgbm9kZUluVmlld3BvcnQueCA9IG5ld1hQb3NpdGlvbjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGZyb206IG5vZGVJblZpZXdwb3J0LngsXHJcbiAgICAgICAgdG86IG91dGdvaW5nTm9kZURlc3RpbmF0aW9uWFxyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVPdXRBbmltYXRpb24uYmVnaW5FbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcbiAgICAgICAgb3V0Z29pbmdWaWV3Tm9kZS5pblZpZXdwb3J0UHJvcGVydHkgJiYgb3V0Z29pbmdWaWV3Tm9kZS5pblZpZXdwb3J0UHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVPdXRBbmltYXRpb24uZmluaXNoRW1pdHRlci5hZGRMaXN0ZW5lciggKCkgPT4ge1xyXG4gICAgICAgIG91dGdvaW5nVmlld05vZGUudmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVPdXRBbmltYXRpb24uc3RhcnQoKTtcclxuXHJcbiAgICAgIC8vIG1vdmUgaW4gdGhlIG5ldyBub2RlXHJcbiAgICAgIGNvbnN0IG1vdmVJbkFuaW1hdGlvbiA9IG5ldyBBbmltYXRpb24oIHtcclxuICAgICAgICBkdXJhdGlvbjogU0NSRUVOX0NIQU5HRV9USU1FLFxyXG4gICAgICAgIGVhc2luZzogRWFzaW5nLkNVQklDX0lOX09VVCxcclxuICAgICAgICBzZXRWYWx1ZTogbmV3WFBvc2l0aW9uID0+IHtcclxuICAgICAgICAgIGluY29taW5nVmlld05vZGUueCA9IG5ld1hQb3NpdGlvbjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGZyb206IGluY29taW5nTm9kZVN0YXJ0WCxcclxuICAgICAgICB0bzogdGhpcy5sYXlvdXRCb3VuZHMubWluWFxyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVJbkFuaW1hdGlvbi5iZWdpbkVtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuICAgICAgICBpbmNvbWluZ1ZpZXdOb2RlLnZpc2libGUgPSB0cnVlO1xyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVJbkFuaW1hdGlvbi5maW5pc2hFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcbiAgICAgICAgbm9kZUluVmlld3BvcnQgPSBpbmNvbWluZ1ZpZXdOb2RlO1xyXG4gICAgICAgIG5vZGVJblZpZXdwb3J0LnBpY2thYmxlID0gdHJ1ZTtcclxuICAgICAgICBub2RlSW5WaWV3cG9ydC5pblZpZXdwb3J0UHJvcGVydHkgJiYgbm9kZUluVmlld3BvcnQuaW5WaWV3cG9ydFByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG4gICAgICB9ICk7XHJcbiAgICAgIG1vdmVJbkFuaW1hdGlvbi5zdGFydCgpO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogc3RlcCB0aGUgdmlldywgbmVlZGVkIGZvciBhbmltYXRpb25zXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGR0ICkge1xyXG4gICAgY29uc3QgY3VycmVudExldmVsID0gdGhpcy5nYW1lTW9kZWwuY3VycmVudExldmVsUHJvcGVydHkuZ2V0KCk7XHJcbiAgICBpZiAoIGN1cnJlbnRMZXZlbCAhPT0gbnVsbCApIHtcclxuICAgICAgdGhpcy5nYW1lTGV2ZWxWaWV3c1sgY3VycmVudExldmVsLmxldmVsTnVtYmVyIF0uc3RlcCggZHQgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cHJlc3Npb25FeGNoYW5nZS5yZWdpc3RlciggJ0VFR2FtZVNjcmVlblZpZXcnLCBFRUdhbWVTY3JlZW5WaWV3ICk7XHJcbmV4cG9ydCBkZWZhdWx0IEVFR2FtZVNjcmVlblZpZXc7Il0sIm1hcHBpbmdzIjoi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