// Copyright 2016-2022, University of Colorado Boulder

/**
 * view for a single level of the Expression Exchange game
 *
 * @author John Blanco
 */

import Property from '../../../../axon/js/Property.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import BackButton from '../../../../scenery-phet/js/buttons/BackButton.js';
import RefreshButton from '../../../../scenery-phet/js/buttons/RefreshButton.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Node, Rectangle, Text } from '../../../../scenery/js/imports.js';
import Checkbox from '../../../../sun/js/Checkbox.js';
import AllLevelsCompletedNode from '../../../../vegas/js/AllLevelsCompletedNode.js';
import EEQueryParameters from '../../common/EEQueryParameters.js';
import CoinTermCreatorBoxFactory from '../../common/view/CoinTermCreatorBoxFactory.js';
import ExpressionManipulationView from '../../common/view/ExpressionManipulationView.js';
import ShowSubtractionIcon from '../../common/view/ShowSubtractionIcon.js';
import expressionExchange from '../../expressionExchange.js';
import ExpressionExchangeStrings from '../../ExpressionExchangeStrings.js';
import EERewardNode from './EERewardNode.js';
import NextLevelNode from './NextLevelNode.js';
const levelNumberPatternString = ExpressionExchangeStrings.levelNumberPattern;

// constants
const BUTTON_XY_TOUCH_DILATION = 4;
class EEGameLevelView extends Node {
  /**
   * @param {EEGameModel} gameModel - main model for the game
   * @param {EEGameLevel} levelModel - model for the level depicted by this view object
   * @param {Bounds2} screenLayoutBounds
   * @param {Property.<Bounds2>} visibleBoundsProperty
   * @param {GameAudioPlayer} gameAudioPlayer
   */
  constructor(gameModel, levelModel, screenLayoutBounds, visibleBoundsProperty, gameAudioPlayer) {
    super();

    // @public {Property.<boolean>} - a property that is externally set to true when this node is in the view port and
    // available for interaction with the user.  This is done in the view rather than in the model because the model has
    // no awareness of the slide in/out animations, and clocking the reward node during those animations caused
    // performance issues, and this property can be used to only clock when this is in the viewport.
    this.inViewportProperty = new Property(false);

    // add an invisible background rectangle so that bounds are correct, this is needed for animation of game level views
    const background = new Rectangle(screenLayoutBounds, {
      stroke: 'transparent' // increase opacity to make the outline visible if desired (for debugging)
    });

    this.addChild(background);

    // layer where everything else should appear
    const middleLayer = new Node();
    this.addChild(middleLayer);

    // layer where the coin term nodes live
    const coinTermLayer = new Node();
    this.addChild(coinTermLayer);

    // layer where the dialog-ish nodes are shown
    const notificationsLayer = new Node();
    this.addChild(notificationsLayer);

    // set the bounds for coin term retrieval in the model
    levelModel.setRetrievalBounds(screenLayoutBounds);

    // add the level label
    const title = new Text(StringUtils.fillIn(levelNumberPatternString, {
      levelNumber: levelModel.levelNumber + 1
    }), {
      font: new PhetFont(20),
      centerX: screenLayoutBounds.width * 0.4,
      top: 20
    });
    middleLayer.addChild(title);

    // add the back button
    const backButton = new BackButton({
      left: screenLayoutBounds.left + 30,
      top: screenLayoutBounds.top + 30,
      listener: gameModel.returnToLevelSelection.bind(gameModel),
      touchAreaXDilation: BUTTON_XY_TOUCH_DILATION,
      touchAreaYDilation: BUTTON_XY_TOUCH_DILATION
    });
    middleLayer.addChild(backButton);

    // add the refresh button
    const refreshButton = new RefreshButton({
      iconHeight: 27,
      xMargin: 9,
      yMargin: 7,
      listener: () => {
        levelModel.refresh();
      },
      left: backButton.left,
      top: backButton.bottom + 8,
      touchAreaXDilation: BUTTON_XY_TOUCH_DILATION,
      touchAreaYDilation: BUTTON_XY_TOUCH_DILATION
    });
    middleLayer.addChild(refreshButton);

    // create the expression manipulation view
    const expressionManipulationView = new ExpressionManipulationView(levelModel, visibleBoundsProperty, {
      coinTermBreakApartButtonMode: 'inverted'
    });
    coinTermLayer.addChild(expressionManipulationView);

    // add the coin term creator box
    let coinTermCreatorBox = null;
    levelModel.currentChallengeProperty.link(currentChallenge => {
      if (coinTermCreatorBox) {
        middleLayer.removeChild(coinTermCreatorBox);
        coinTermCreatorBox.dispose();
      }
      coinTermCreatorBox = CoinTermCreatorBoxFactory.createGameScreenCreatorBox(currentChallenge, levelModel, expressionManipulationView, {
        centerX: title.centerX,
        bottom: screenLayoutBounds.bottom - 40
      });
      middleLayer.addChild(coinTermCreatorBox);

      // let the model know where the creator box is so that it knows when the user returns coin terms
      levelModel.creatorBoxBounds = coinTermCreatorBox.bounds;
    });

    // add the checkbox that allows expressions with negative values to be simplified
    const boundsOfLowestCollectionArea = _.last(levelModel.collectionAreas).bounds;
    const showSubtractionCheckbox = new Checkbox(levelModel.simplifyNegativesProperty, new ShowSubtractionIcon(), {
      left: boundsOfLowestCollectionArea.left,
      top: boundsOfLowestCollectionArea.bottom + 20,
      maxWidth: boundsOfLowestCollectionArea.minX
    });
    middleLayer.addChild(showSubtractionCheckbox);

    // only show the checkbox for simplifying expressions with negative values if some are present in the challenge
    levelModel.currentChallengeProperty.link(currentChallenge => {
      // determine whether negative values are present in this challenge
      let negativesExist = false;
      currentChallenge.carouselContents.forEach(carouselContent => {
        if (carouselContent.minimumDecomposition < 0) {
          negativesExist = true;
        }
      });
      showSubtractionCheckbox.visible = negativesExist;
    });

    // add the node for moving to the next level, only shown when all challenges on this level have been answered
    this.nextLevelNode = new NextLevelNode(gameModel.nextLevel.bind(gameModel), {
      centerX: title.centerX,
      centerY: screenLayoutBounds.height * 0.33 // multiplier empirically determined
    });

    notificationsLayer.addChild(this.nextLevelNode);

    // create the dialog that is shown when all levels reach completion
    this.allLevelsCompletedDialog = new AllLevelsCompletedNode(gameModel.returnToLevelSelection.bind(gameModel), {
      centerX: title.centerX,
      centerY: screenLayoutBounds.height * 0.4,
      // empirically determined
      visible: false
    });
    notificationsLayer.addChild(this.allLevelsCompletedDialog);

    // helper function for showing the reward node
    const showRewardNode = () => {
      if (!this.rewardNode) {
        this.rewardNode = new EERewardNode();
        background.addChild(this.rewardNode);
      }
      if (this.rewardNode) {
        this.rewardNode.visible = true;
      }
    };

    // the reward node is removed rather then hidden in order to conserve memory
    const removeRewardNode = () => {
      if (this.rewardNode) {
        background.removeChild(this.rewardNode);
        this.rewardNode.dispose();
        this.rewardNode = null;
      }
    };

    // define a property that tracks whether the 'next level' node should be visible.  This is done as a separate
    // view-only property because the logic that decides whether to show it is somewhat complex.
    const showNextLevelNodeProperty = new Property(false);

    // show the "next level" node when this level becomes completed
    levelModel.completedSinceLastClearProperty.link(currentlyCompleted => {
      showNextLevelNodeProperty.set(currentlyCompleted && !gameModel.allLevelsCompletedProperty.get());

      // if the appropriate query param is set, show the reward node every time this level is successfully completed
      if (EEQueryParameters.showRewardNodeEveryLevel) {
        if (currentlyCompleted) {
          showRewardNode();
        } else {
          removeRewardNode();
        }
      }
    });
    showNextLevelNodeProperty.linkAttribute(this.nextLevelNode, 'visible');
    gameModel.allLevelsCompletedProperty.link((allLevelsCompleted, allLevelsWereCompleted) => {
      // when all levels become completed, we no longer show the "Next Level" nodes, see
      // https://github.com/phetsims/expression-exchange/issues/108 for more information about why
      if (allLevelsCompleted) {
        showNextLevelNodeProperty.set(false);
        if (this.inViewportProperty.get()) {
          // show the 'all levels completed' dialog
          this.allLevelsCompletedDialog.visible = true;

          // show the reward node
          showRewardNode();

          // play the sound that indicates all levels have been completed
          gameAudioPlayer.gameOverPerfectScore();
        }
      }

      // this handles the case where the user presses the refresh button while in the "all levels completed" state
      if (!allLevelsCompleted && allLevelsWereCompleted && this.inViewportProperty.get()) {
        this.allLevelsCompletedDialog.visible = false;
        removeRewardNode();
        gameModel.clearAllLevelsCompleted();
      }
    });

    // when this node leaves the view port, check whether all levels had been completed and, if so, hide the associated
    // celebratory nodes and reset the flag in the model.
    this.inViewportProperty.link((inViewPort, wasInViewPort) => {
      if (!inViewPort && wasInViewPort && gameModel.allLevelsCompletedProperty.get()) {
        removeRewardNode();
        this.allLevelsCompletedDialog.visible = false;
        gameModel.clearAllLevelsCompleted();
      }
    });

    // hook up listeners to the collection areas to play the appropriate sounds upon collection or rejection of a user-
    // submitted answer
    levelModel.collectionAreas.forEach(collectionArea => {
      collectionArea.collectionAttemptedEmitter.addListener(itemCollected => {
        if (itemCollected) {
          gameAudioPlayer.correctAnswer();
        } else if (!itemCollected && collectionArea.isEmpty()) {
          gameAudioPlayer.wrongAnswer();
        }
      });
    });
  }

  /**
   * @param {number} dt
   * @public
   */
  step(dt) {
    if (this.inViewportProperty.get() && this.rewardNode && this.rewardNode.visible) {
      this.rewardNode.step(Math.min(dt, 1));
    }
  }
}
expressionExchange.register('EEGameLevelView', EEGameLevelView);
export default EEGameLevelView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIlN0cmluZ1V0aWxzIiwiQmFja0J1dHRvbiIsIlJlZnJlc2hCdXR0b24iLCJQaGV0Rm9udCIsIk5vZGUiLCJSZWN0YW5nbGUiLCJUZXh0IiwiQ2hlY2tib3giLCJBbGxMZXZlbHNDb21wbGV0ZWROb2RlIiwiRUVRdWVyeVBhcmFtZXRlcnMiLCJDb2luVGVybUNyZWF0b3JCb3hGYWN0b3J5IiwiRXhwcmVzc2lvbk1hbmlwdWxhdGlvblZpZXciLCJTaG93U3VidHJhY3Rpb25JY29uIiwiZXhwcmVzc2lvbkV4Y2hhbmdlIiwiRXhwcmVzc2lvbkV4Y2hhbmdlU3RyaW5ncyIsIkVFUmV3YXJkTm9kZSIsIk5leHRMZXZlbE5vZGUiLCJsZXZlbE51bWJlclBhdHRlcm5TdHJpbmciLCJsZXZlbE51bWJlclBhdHRlcm4iLCJCVVRUT05fWFlfVE9VQ0hfRElMQVRJT04iLCJFRUdhbWVMZXZlbFZpZXciLCJjb25zdHJ1Y3RvciIsImdhbWVNb2RlbCIsImxldmVsTW9kZWwiLCJzY3JlZW5MYXlvdXRCb3VuZHMiLCJ2aXNpYmxlQm91bmRzUHJvcGVydHkiLCJnYW1lQXVkaW9QbGF5ZXIiLCJpblZpZXdwb3J0UHJvcGVydHkiLCJiYWNrZ3JvdW5kIiwic3Ryb2tlIiwiYWRkQ2hpbGQiLCJtaWRkbGVMYXllciIsImNvaW5UZXJtTGF5ZXIiLCJub3RpZmljYXRpb25zTGF5ZXIiLCJzZXRSZXRyaWV2YWxCb3VuZHMiLCJ0aXRsZSIsImZpbGxJbiIsImxldmVsTnVtYmVyIiwiZm9udCIsImNlbnRlclgiLCJ3aWR0aCIsInRvcCIsImJhY2tCdXR0b24iLCJsZWZ0IiwibGlzdGVuZXIiLCJyZXR1cm5Ub0xldmVsU2VsZWN0aW9uIiwiYmluZCIsInRvdWNoQXJlYVhEaWxhdGlvbiIsInRvdWNoQXJlYVlEaWxhdGlvbiIsInJlZnJlc2hCdXR0b24iLCJpY29uSGVpZ2h0IiwieE1hcmdpbiIsInlNYXJnaW4iLCJyZWZyZXNoIiwiYm90dG9tIiwiZXhwcmVzc2lvbk1hbmlwdWxhdGlvblZpZXciLCJjb2luVGVybUJyZWFrQXBhcnRCdXR0b25Nb2RlIiwiY29pblRlcm1DcmVhdG9yQm94IiwiY3VycmVudENoYWxsZW5nZVByb3BlcnR5IiwibGluayIsImN1cnJlbnRDaGFsbGVuZ2UiLCJyZW1vdmVDaGlsZCIsImRpc3Bvc2UiLCJjcmVhdGVHYW1lU2NyZWVuQ3JlYXRvckJveCIsImNyZWF0b3JCb3hCb3VuZHMiLCJib3VuZHMiLCJib3VuZHNPZkxvd2VzdENvbGxlY3Rpb25BcmVhIiwiXyIsImxhc3QiLCJjb2xsZWN0aW9uQXJlYXMiLCJzaG93U3VidHJhY3Rpb25DaGVja2JveCIsInNpbXBsaWZ5TmVnYXRpdmVzUHJvcGVydHkiLCJtYXhXaWR0aCIsIm1pblgiLCJuZWdhdGl2ZXNFeGlzdCIsImNhcm91c2VsQ29udGVudHMiLCJmb3JFYWNoIiwiY2Fyb3VzZWxDb250ZW50IiwibWluaW11bURlY29tcG9zaXRpb24iLCJ2aXNpYmxlIiwibmV4dExldmVsTm9kZSIsIm5leHRMZXZlbCIsImNlbnRlclkiLCJoZWlnaHQiLCJhbGxMZXZlbHNDb21wbGV0ZWREaWFsb2ciLCJzaG93UmV3YXJkTm9kZSIsInJld2FyZE5vZGUiLCJyZW1vdmVSZXdhcmROb2RlIiwic2hvd05leHRMZXZlbE5vZGVQcm9wZXJ0eSIsImNvbXBsZXRlZFNpbmNlTGFzdENsZWFyUHJvcGVydHkiLCJjdXJyZW50bHlDb21wbGV0ZWQiLCJzZXQiLCJhbGxMZXZlbHNDb21wbGV0ZWRQcm9wZXJ0eSIsImdldCIsInNob3dSZXdhcmROb2RlRXZlcnlMZXZlbCIsImxpbmtBdHRyaWJ1dGUiLCJhbGxMZXZlbHNDb21wbGV0ZWQiLCJhbGxMZXZlbHNXZXJlQ29tcGxldGVkIiwiZ2FtZU92ZXJQZXJmZWN0U2NvcmUiLCJjbGVhckFsbExldmVsc0NvbXBsZXRlZCIsImluVmlld1BvcnQiLCJ3YXNJblZpZXdQb3J0IiwiY29sbGVjdGlvbkFyZWEiLCJjb2xsZWN0aW9uQXR0ZW1wdGVkRW1pdHRlciIsImFkZExpc3RlbmVyIiwiaXRlbUNvbGxlY3RlZCIsImNvcnJlY3RBbnN3ZXIiLCJpc0VtcHR5Iiwid3JvbmdBbnN3ZXIiLCJzdGVwIiwiZHQiLCJNYXRoIiwibWluIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFRUdhbWVMZXZlbFZpZXcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogdmlldyBmb3IgYSBzaW5nbGUgbGV2ZWwgb2YgdGhlIEV4cHJlc3Npb24gRXhjaGFuZ2UgZ2FtZVxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgU3RyaW5nVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy91dGlsL1N0cmluZ1V0aWxzLmpzJztcclxuaW1wb3J0IEJhY2tCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvQmFja0J1dHRvbi5qcyc7XHJcbmltcG9ydCBSZWZyZXNoQnV0dG9uIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9idXR0b25zL1JlZnJlc2hCdXR0b24uanMnO1xyXG5pbXBvcnQgUGhldEZvbnQgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1BoZXRGb250LmpzJztcclxuaW1wb3J0IHsgTm9kZSwgUmVjdGFuZ2xlLCBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IENoZWNrYm94IGZyb20gJy4uLy4uLy4uLy4uL3N1bi9qcy9DaGVja2JveC5qcyc7XHJcbmltcG9ydCBBbGxMZXZlbHNDb21wbGV0ZWROb2RlIGZyb20gJy4uLy4uLy4uLy4uL3ZlZ2FzL2pzL0FsbExldmVsc0NvbXBsZXRlZE5vZGUuanMnO1xyXG5pbXBvcnQgRUVRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vLi4vY29tbW9uL0VFUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IENvaW5UZXJtQ3JlYXRvckJveEZhY3RvcnkgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvQ29pblRlcm1DcmVhdG9yQm94RmFjdG9yeS5qcyc7XHJcbmltcG9ydCBFeHByZXNzaW9uTWFuaXB1bGF0aW9uVmlldyBmcm9tICcuLi8uLi9jb21tb24vdmlldy9FeHByZXNzaW9uTWFuaXB1bGF0aW9uVmlldy5qcyc7XHJcbmltcG9ydCBTaG93U3VidHJhY3Rpb25JY29uIGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L1Nob3dTdWJ0cmFjdGlvbkljb24uanMnO1xyXG5pbXBvcnQgZXhwcmVzc2lvbkV4Y2hhbmdlIGZyb20gJy4uLy4uL2V4cHJlc3Npb25FeGNoYW5nZS5qcyc7XHJcbmltcG9ydCBFeHByZXNzaW9uRXhjaGFuZ2VTdHJpbmdzIGZyb20gJy4uLy4uL0V4cHJlc3Npb25FeGNoYW5nZVN0cmluZ3MuanMnO1xyXG5pbXBvcnQgRUVSZXdhcmROb2RlIGZyb20gJy4vRUVSZXdhcmROb2RlLmpzJztcclxuaW1wb3J0IE5leHRMZXZlbE5vZGUgZnJvbSAnLi9OZXh0TGV2ZWxOb2RlLmpzJztcclxuXHJcbmNvbnN0IGxldmVsTnVtYmVyUGF0dGVyblN0cmluZyA9IEV4cHJlc3Npb25FeGNoYW5nZVN0cmluZ3MubGV2ZWxOdW1iZXJQYXR0ZXJuO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEJVVFRPTl9YWV9UT1VDSF9ESUxBVElPTiA9IDQ7XHJcblxyXG5jbGFzcyBFRUdhbWVMZXZlbFZpZXcgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtFRUdhbWVNb2RlbH0gZ2FtZU1vZGVsIC0gbWFpbiBtb2RlbCBmb3IgdGhlIGdhbWVcclxuICAgKiBAcGFyYW0ge0VFR2FtZUxldmVsfSBsZXZlbE1vZGVsIC0gbW9kZWwgZm9yIHRoZSBsZXZlbCBkZXBpY3RlZCBieSB0aGlzIHZpZXcgb2JqZWN0XHJcbiAgICogQHBhcmFtIHtCb3VuZHMyfSBzY3JlZW5MYXlvdXRCb3VuZHNcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5LjxCb3VuZHMyPn0gdmlzaWJsZUJvdW5kc1Byb3BlcnR5XHJcbiAgICogQHBhcmFtIHtHYW1lQXVkaW9QbGF5ZXJ9IGdhbWVBdWRpb1BsYXllclxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBnYW1lTW9kZWwsIGxldmVsTW9kZWwsIHNjcmVlbkxheW91dEJvdW5kcywgdmlzaWJsZUJvdW5kc1Byb3BlcnR5LCBnYW1lQXVkaW9QbGF5ZXIgKSB7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtQcm9wZXJ0eS48Ym9vbGVhbj59IC0gYSBwcm9wZXJ0eSB0aGF0IGlzIGV4dGVybmFsbHkgc2V0IHRvIHRydWUgd2hlbiB0aGlzIG5vZGUgaXMgaW4gdGhlIHZpZXcgcG9ydCBhbmRcclxuICAgIC8vIGF2YWlsYWJsZSBmb3IgaW50ZXJhY3Rpb24gd2l0aCB0aGUgdXNlci4gIFRoaXMgaXMgZG9uZSBpbiB0aGUgdmlldyByYXRoZXIgdGhhbiBpbiB0aGUgbW9kZWwgYmVjYXVzZSB0aGUgbW9kZWwgaGFzXHJcbiAgICAvLyBubyBhd2FyZW5lc3Mgb2YgdGhlIHNsaWRlIGluL291dCBhbmltYXRpb25zLCBhbmQgY2xvY2tpbmcgdGhlIHJld2FyZCBub2RlIGR1cmluZyB0aG9zZSBhbmltYXRpb25zIGNhdXNlZFxyXG4gICAgLy8gcGVyZm9ybWFuY2UgaXNzdWVzLCBhbmQgdGhpcyBwcm9wZXJ0eSBjYW4gYmUgdXNlZCB0byBvbmx5IGNsb2NrIHdoZW4gdGhpcyBpcyBpbiB0aGUgdmlld3BvcnQuXHJcbiAgICB0aGlzLmluVmlld3BvcnRQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggZmFsc2UgKTtcclxuXHJcbiAgICAvLyBhZGQgYW4gaW52aXNpYmxlIGJhY2tncm91bmQgcmVjdGFuZ2xlIHNvIHRoYXQgYm91bmRzIGFyZSBjb3JyZWN0LCB0aGlzIGlzIG5lZWRlZCBmb3IgYW5pbWF0aW9uIG9mIGdhbWUgbGV2ZWwgdmlld3NcclxuICAgIGNvbnN0IGJhY2tncm91bmQgPSBuZXcgUmVjdGFuZ2xlKCBzY3JlZW5MYXlvdXRCb3VuZHMsIHtcclxuICAgICAgc3Ryb2tlOiAndHJhbnNwYXJlbnQnIC8vIGluY3JlYXNlIG9wYWNpdHkgdG8gbWFrZSB0aGUgb3V0bGluZSB2aXNpYmxlIGlmIGRlc2lyZWQgKGZvciBkZWJ1Z2dpbmcpXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBiYWNrZ3JvdW5kICk7XHJcblxyXG4gICAgLy8gbGF5ZXIgd2hlcmUgZXZlcnl0aGluZyBlbHNlIHNob3VsZCBhcHBlYXJcclxuICAgIGNvbnN0IG1pZGRsZUxheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIG1pZGRsZUxheWVyICk7XHJcblxyXG4gICAgLy8gbGF5ZXIgd2hlcmUgdGhlIGNvaW4gdGVybSBub2RlcyBsaXZlXHJcbiAgICBjb25zdCBjb2luVGVybUxheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGNvaW5UZXJtTGF5ZXIgKTtcclxuXHJcbiAgICAvLyBsYXllciB3aGVyZSB0aGUgZGlhbG9nLWlzaCBub2RlcyBhcmUgc2hvd25cclxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbnNMYXllciA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBub3RpZmljYXRpb25zTGF5ZXIgKTtcclxuXHJcbiAgICAvLyBzZXQgdGhlIGJvdW5kcyBmb3IgY29pbiB0ZXJtIHJldHJpZXZhbCBpbiB0aGUgbW9kZWxcclxuICAgIGxldmVsTW9kZWwuc2V0UmV0cmlldmFsQm91bmRzKCBzY3JlZW5MYXlvdXRCb3VuZHMgKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGxldmVsIGxhYmVsXHJcbiAgICBjb25zdCB0aXRsZSA9IG5ldyBUZXh0KFxyXG4gICAgICBTdHJpbmdVdGlscy5maWxsSW4oIGxldmVsTnVtYmVyUGF0dGVyblN0cmluZywgeyBsZXZlbE51bWJlcjogKCBsZXZlbE1vZGVsLmxldmVsTnVtYmVyICsgMSApIH0gKSxcclxuICAgICAge1xyXG4gICAgICAgIGZvbnQ6IG5ldyBQaGV0Rm9udCggMjAgKSxcclxuICAgICAgICBjZW50ZXJYOiBzY3JlZW5MYXlvdXRCb3VuZHMud2lkdGggKiAwLjQsXHJcbiAgICAgICAgdG9wOiAyMFxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gICAgbWlkZGxlTGF5ZXIuYWRkQ2hpbGQoIHRpdGxlICk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBiYWNrIGJ1dHRvblxyXG4gICAgY29uc3QgYmFja0J1dHRvbiA9IG5ldyBCYWNrQnV0dG9uKCB7XHJcbiAgICAgIGxlZnQ6IHNjcmVlbkxheW91dEJvdW5kcy5sZWZ0ICsgMzAsXHJcbiAgICAgIHRvcDogc2NyZWVuTGF5b3V0Qm91bmRzLnRvcCArIDMwLFxyXG4gICAgICBsaXN0ZW5lcjogZ2FtZU1vZGVsLnJldHVyblRvTGV2ZWxTZWxlY3Rpb24uYmluZCggZ2FtZU1vZGVsICksXHJcbiAgICAgIHRvdWNoQXJlYVhEaWxhdGlvbjogQlVUVE9OX1hZX1RPVUNIX0RJTEFUSU9OLFxyXG4gICAgICB0b3VjaEFyZWFZRGlsYXRpb246IEJVVFRPTl9YWV9UT1VDSF9ESUxBVElPTlxyXG4gICAgfSApO1xyXG4gICAgbWlkZGxlTGF5ZXIuYWRkQ2hpbGQoIGJhY2tCdXR0b24gKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIHJlZnJlc2ggYnV0dG9uXHJcbiAgICBjb25zdCByZWZyZXNoQnV0dG9uID0gbmV3IFJlZnJlc2hCdXR0b24oIHtcclxuICAgICAgaWNvbkhlaWdodDogMjcsXHJcbiAgICAgIHhNYXJnaW46IDksXHJcbiAgICAgIHlNYXJnaW46IDcsXHJcbiAgICAgIGxpc3RlbmVyOiAoKSA9PiB7IGxldmVsTW9kZWwucmVmcmVzaCgpOyB9LFxyXG4gICAgICBsZWZ0OiBiYWNrQnV0dG9uLmxlZnQsXHJcbiAgICAgIHRvcDogYmFja0J1dHRvbi5ib3R0b20gKyA4LFxyXG4gICAgICB0b3VjaEFyZWFYRGlsYXRpb246IEJVVFRPTl9YWV9UT1VDSF9ESUxBVElPTixcclxuICAgICAgdG91Y2hBcmVhWURpbGF0aW9uOiBCVVRUT05fWFlfVE9VQ0hfRElMQVRJT05cclxuICAgIH0gKTtcclxuICAgIG1pZGRsZUxheWVyLmFkZENoaWxkKCByZWZyZXNoQnV0dG9uICk7XHJcblxyXG4gICAgLy8gY3JlYXRlIHRoZSBleHByZXNzaW9uIG1hbmlwdWxhdGlvbiB2aWV3XHJcbiAgICBjb25zdCBleHByZXNzaW9uTWFuaXB1bGF0aW9uVmlldyA9IG5ldyBFeHByZXNzaW9uTWFuaXB1bGF0aW9uVmlldyhcclxuICAgICAgbGV2ZWxNb2RlbCxcclxuICAgICAgdmlzaWJsZUJvdW5kc1Byb3BlcnR5LFxyXG4gICAgICB7IGNvaW5UZXJtQnJlYWtBcGFydEJ1dHRvbk1vZGU6ICdpbnZlcnRlZCcgfVxyXG4gICAgKTtcclxuICAgIGNvaW5UZXJtTGF5ZXIuYWRkQ2hpbGQoIGV4cHJlc3Npb25NYW5pcHVsYXRpb25WaWV3ICk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBjb2luIHRlcm0gY3JlYXRvciBib3hcclxuICAgIGxldCBjb2luVGVybUNyZWF0b3JCb3ggPSBudWxsO1xyXG4gICAgbGV2ZWxNb2RlbC5jdXJyZW50Q2hhbGxlbmdlUHJvcGVydHkubGluayggY3VycmVudENoYWxsZW5nZSA9PiB7XHJcbiAgICAgIGlmICggY29pblRlcm1DcmVhdG9yQm94ICkge1xyXG4gICAgICAgIG1pZGRsZUxheWVyLnJlbW92ZUNoaWxkKCBjb2luVGVybUNyZWF0b3JCb3ggKTtcclxuICAgICAgICBjb2luVGVybUNyZWF0b3JCb3guZGlzcG9zZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvaW5UZXJtQ3JlYXRvckJveCA9IENvaW5UZXJtQ3JlYXRvckJveEZhY3RvcnkuY3JlYXRlR2FtZVNjcmVlbkNyZWF0b3JCb3goXHJcbiAgICAgICAgY3VycmVudENoYWxsZW5nZSxcclxuICAgICAgICBsZXZlbE1vZGVsLFxyXG4gICAgICAgIGV4cHJlc3Npb25NYW5pcHVsYXRpb25WaWV3LFxyXG4gICAgICAgIHsgY2VudGVyWDogdGl0bGUuY2VudGVyWCwgYm90dG9tOiBzY3JlZW5MYXlvdXRCb3VuZHMuYm90dG9tIC0gNDAgfVxyXG4gICAgICApO1xyXG4gICAgICBtaWRkbGVMYXllci5hZGRDaGlsZCggY29pblRlcm1DcmVhdG9yQm94ICk7XHJcblxyXG4gICAgICAvLyBsZXQgdGhlIG1vZGVsIGtub3cgd2hlcmUgdGhlIGNyZWF0b3IgYm94IGlzIHNvIHRoYXQgaXQga25vd3Mgd2hlbiB0aGUgdXNlciByZXR1cm5zIGNvaW4gdGVybXNcclxuICAgICAgbGV2ZWxNb2RlbC5jcmVhdG9yQm94Qm91bmRzID0gY29pblRlcm1DcmVhdG9yQm94LmJvdW5kcztcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBhZGQgdGhlIGNoZWNrYm94IHRoYXQgYWxsb3dzIGV4cHJlc3Npb25zIHdpdGggbmVnYXRpdmUgdmFsdWVzIHRvIGJlIHNpbXBsaWZpZWRcclxuICAgIGNvbnN0IGJvdW5kc09mTG93ZXN0Q29sbGVjdGlvbkFyZWEgPSBfLmxhc3QoIGxldmVsTW9kZWwuY29sbGVjdGlvbkFyZWFzICkuYm91bmRzO1xyXG4gICAgY29uc3Qgc2hvd1N1YnRyYWN0aW9uQ2hlY2tib3ggPSBuZXcgQ2hlY2tib3goIGxldmVsTW9kZWwuc2ltcGxpZnlOZWdhdGl2ZXNQcm9wZXJ0eSwgbmV3IFNob3dTdWJ0cmFjdGlvbkljb24oKSwge1xyXG4gICAgICBsZWZ0OiBib3VuZHNPZkxvd2VzdENvbGxlY3Rpb25BcmVhLmxlZnQsXHJcbiAgICAgIHRvcDogYm91bmRzT2ZMb3dlc3RDb2xsZWN0aW9uQXJlYS5ib3R0b20gKyAyMCxcclxuICAgICAgbWF4V2lkdGg6IGJvdW5kc09mTG93ZXN0Q29sbGVjdGlvbkFyZWEubWluWFxyXG4gICAgfSApO1xyXG4gICAgbWlkZGxlTGF5ZXIuYWRkQ2hpbGQoIHNob3dTdWJ0cmFjdGlvbkNoZWNrYm94ICk7XHJcblxyXG4gICAgLy8gb25seSBzaG93IHRoZSBjaGVja2JveCBmb3Igc2ltcGxpZnlpbmcgZXhwcmVzc2lvbnMgd2l0aCBuZWdhdGl2ZSB2YWx1ZXMgaWYgc29tZSBhcmUgcHJlc2VudCBpbiB0aGUgY2hhbGxlbmdlXHJcbiAgICBsZXZlbE1vZGVsLmN1cnJlbnRDaGFsbGVuZ2VQcm9wZXJ0eS5saW5rKCBjdXJyZW50Q2hhbGxlbmdlID0+IHtcclxuXHJcbiAgICAgIC8vIGRldGVybWluZSB3aGV0aGVyIG5lZ2F0aXZlIHZhbHVlcyBhcmUgcHJlc2VudCBpbiB0aGlzIGNoYWxsZW5nZVxyXG4gICAgICBsZXQgbmVnYXRpdmVzRXhpc3QgPSBmYWxzZTtcclxuICAgICAgY3VycmVudENoYWxsZW5nZS5jYXJvdXNlbENvbnRlbnRzLmZvckVhY2goIGNhcm91c2VsQ29udGVudCA9PiB7XHJcbiAgICAgICAgaWYgKCBjYXJvdXNlbENvbnRlbnQubWluaW11bURlY29tcG9zaXRpb24gPCAwICkge1xyXG4gICAgICAgICAgbmVnYXRpdmVzRXhpc3QgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgICBzaG93U3VidHJhY3Rpb25DaGVja2JveC52aXNpYmxlID0gbmVnYXRpdmVzRXhpc3Q7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gYWRkIHRoZSBub2RlIGZvciBtb3ZpbmcgdG8gdGhlIG5leHQgbGV2ZWwsIG9ubHkgc2hvd24gd2hlbiBhbGwgY2hhbGxlbmdlcyBvbiB0aGlzIGxldmVsIGhhdmUgYmVlbiBhbnN3ZXJlZFxyXG4gICAgdGhpcy5uZXh0TGV2ZWxOb2RlID0gbmV3IE5leHRMZXZlbE5vZGUoIGdhbWVNb2RlbC5uZXh0TGV2ZWwuYmluZCggZ2FtZU1vZGVsICksIHtcclxuICAgICAgY2VudGVyWDogdGl0bGUuY2VudGVyWCxcclxuICAgICAgY2VudGVyWTogc2NyZWVuTGF5b3V0Qm91bmRzLmhlaWdodCAqIDAuMzMgLy8gbXVsdGlwbGllciBlbXBpcmljYWxseSBkZXRlcm1pbmVkXHJcbiAgICB9ICk7XHJcbiAgICBub3RpZmljYXRpb25zTGF5ZXIuYWRkQ2hpbGQoIHRoaXMubmV4dExldmVsTm9kZSApO1xyXG5cclxuICAgIC8vIGNyZWF0ZSB0aGUgZGlhbG9nIHRoYXQgaXMgc2hvd24gd2hlbiBhbGwgbGV2ZWxzIHJlYWNoIGNvbXBsZXRpb25cclxuICAgIHRoaXMuYWxsTGV2ZWxzQ29tcGxldGVkRGlhbG9nID0gbmV3IEFsbExldmVsc0NvbXBsZXRlZE5vZGUoIGdhbWVNb2RlbC5yZXR1cm5Ub0xldmVsU2VsZWN0aW9uLmJpbmQoIGdhbWVNb2RlbCApLCB7XHJcbiAgICAgIGNlbnRlclg6IHRpdGxlLmNlbnRlclgsXHJcbiAgICAgIGNlbnRlclk6IHNjcmVlbkxheW91dEJvdW5kcy5oZWlnaHQgKiAwLjQsIC8vIGVtcGlyaWNhbGx5IGRldGVybWluZWRcclxuICAgICAgdmlzaWJsZTogZmFsc2VcclxuICAgIH0gKTtcclxuICAgIG5vdGlmaWNhdGlvbnNMYXllci5hZGRDaGlsZCggdGhpcy5hbGxMZXZlbHNDb21wbGV0ZWREaWFsb2cgKTtcclxuXHJcbiAgICAvLyBoZWxwZXIgZnVuY3Rpb24gZm9yIHNob3dpbmcgdGhlIHJld2FyZCBub2RlXHJcbiAgICBjb25zdCBzaG93UmV3YXJkTm9kZSA9ICgpID0+IHtcclxuICAgICAgaWYgKCAhdGhpcy5yZXdhcmROb2RlICkge1xyXG4gICAgICAgIHRoaXMucmV3YXJkTm9kZSA9IG5ldyBFRVJld2FyZE5vZGUoKTtcclxuICAgICAgICBiYWNrZ3JvdW5kLmFkZENoaWxkKCB0aGlzLnJld2FyZE5vZGUgKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIHRoaXMucmV3YXJkTm9kZSApIHtcclxuICAgICAgICB0aGlzLnJld2FyZE5vZGUudmlzaWJsZSA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gdGhlIHJld2FyZCBub2RlIGlzIHJlbW92ZWQgcmF0aGVyIHRoZW4gaGlkZGVuIGluIG9yZGVyIHRvIGNvbnNlcnZlIG1lbW9yeVxyXG4gICAgY29uc3QgcmVtb3ZlUmV3YXJkTm9kZSA9ICgpID0+IHtcclxuICAgICAgaWYgKCB0aGlzLnJld2FyZE5vZGUgKSB7XHJcbiAgICAgICAgYmFja2dyb3VuZC5yZW1vdmVDaGlsZCggdGhpcy5yZXdhcmROb2RlICk7XHJcbiAgICAgICAgdGhpcy5yZXdhcmROb2RlLmRpc3Bvc2UoKTtcclxuICAgICAgICB0aGlzLnJld2FyZE5vZGUgPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGRlZmluZSBhIHByb3BlcnR5IHRoYXQgdHJhY2tzIHdoZXRoZXIgdGhlICduZXh0IGxldmVsJyBub2RlIHNob3VsZCBiZSB2aXNpYmxlLiAgVGhpcyBpcyBkb25lIGFzIGEgc2VwYXJhdGVcclxuICAgIC8vIHZpZXctb25seSBwcm9wZXJ0eSBiZWNhdXNlIHRoZSBsb2dpYyB0aGF0IGRlY2lkZXMgd2hldGhlciB0byBzaG93IGl0IGlzIHNvbWV3aGF0IGNvbXBsZXguXHJcbiAgICBjb25zdCBzaG93TmV4dExldmVsTm9kZVByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBmYWxzZSApO1xyXG5cclxuICAgIC8vIHNob3cgdGhlIFwibmV4dCBsZXZlbFwiIG5vZGUgd2hlbiB0aGlzIGxldmVsIGJlY29tZXMgY29tcGxldGVkXHJcbiAgICBsZXZlbE1vZGVsLmNvbXBsZXRlZFNpbmNlTGFzdENsZWFyUHJvcGVydHkubGluayggY3VycmVudGx5Q29tcGxldGVkID0+IHtcclxuICAgICAgc2hvd05leHRMZXZlbE5vZGVQcm9wZXJ0eS5zZXQoIGN1cnJlbnRseUNvbXBsZXRlZCAmJiAhZ2FtZU1vZGVsLmFsbExldmVsc0NvbXBsZXRlZFByb3BlcnR5LmdldCgpICk7XHJcblxyXG4gICAgICAvLyBpZiB0aGUgYXBwcm9wcmlhdGUgcXVlcnkgcGFyYW0gaXMgc2V0LCBzaG93IHRoZSByZXdhcmQgbm9kZSBldmVyeSB0aW1lIHRoaXMgbGV2ZWwgaXMgc3VjY2Vzc2Z1bGx5IGNvbXBsZXRlZFxyXG4gICAgICBpZiAoIEVFUXVlcnlQYXJhbWV0ZXJzLnNob3dSZXdhcmROb2RlRXZlcnlMZXZlbCApIHtcclxuICAgICAgICBpZiAoIGN1cnJlbnRseUNvbXBsZXRlZCApIHtcclxuICAgICAgICAgIHNob3dSZXdhcmROb2RlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgcmVtb3ZlUmV3YXJkTm9kZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIHNob3dOZXh0TGV2ZWxOb2RlUHJvcGVydHkubGlua0F0dHJpYnV0ZSggdGhpcy5uZXh0TGV2ZWxOb2RlLCAndmlzaWJsZScgKTtcclxuXHJcbiAgICBnYW1lTW9kZWwuYWxsTGV2ZWxzQ29tcGxldGVkUHJvcGVydHkubGluayggKCBhbGxMZXZlbHNDb21wbGV0ZWQsIGFsbExldmVsc1dlcmVDb21wbGV0ZWQgKSA9PiB7XHJcblxyXG4gICAgICAvLyB3aGVuIGFsbCBsZXZlbHMgYmVjb21lIGNvbXBsZXRlZCwgd2Ugbm8gbG9uZ2VyIHNob3cgdGhlIFwiTmV4dCBMZXZlbFwiIG5vZGVzLCBzZWVcclxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2V4cHJlc3Npb24tZXhjaGFuZ2UvaXNzdWVzLzEwOCBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCB3aHlcclxuICAgICAgaWYgKCBhbGxMZXZlbHNDb21wbGV0ZWQgKSB7XHJcbiAgICAgICAgc2hvd05leHRMZXZlbE5vZGVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcblxyXG4gICAgICAgIGlmICggdGhpcy5pblZpZXdwb3J0UHJvcGVydHkuZ2V0KCkgKSB7XHJcblxyXG4gICAgICAgICAgLy8gc2hvdyB0aGUgJ2FsbCBsZXZlbHMgY29tcGxldGVkJyBkaWFsb2dcclxuICAgICAgICAgIHRoaXMuYWxsTGV2ZWxzQ29tcGxldGVkRGlhbG9nLnZpc2libGUgPSB0cnVlO1xyXG5cclxuICAgICAgICAgIC8vIHNob3cgdGhlIHJld2FyZCBub2RlXHJcbiAgICAgICAgICBzaG93UmV3YXJkTm9kZSgpO1xyXG5cclxuICAgICAgICAgIC8vIHBsYXkgdGhlIHNvdW5kIHRoYXQgaW5kaWNhdGVzIGFsbCBsZXZlbHMgaGF2ZSBiZWVuIGNvbXBsZXRlZFxyXG4gICAgICAgICAgZ2FtZUF1ZGlvUGxheWVyLmdhbWVPdmVyUGVyZmVjdFNjb3JlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyB0aGlzIGhhbmRsZXMgdGhlIGNhc2Ugd2hlcmUgdGhlIHVzZXIgcHJlc3NlcyB0aGUgcmVmcmVzaCBidXR0b24gd2hpbGUgaW4gdGhlIFwiYWxsIGxldmVscyBjb21wbGV0ZWRcIiBzdGF0ZVxyXG4gICAgICBpZiAoICFhbGxMZXZlbHNDb21wbGV0ZWQgJiYgYWxsTGV2ZWxzV2VyZUNvbXBsZXRlZCAmJiB0aGlzLmluVmlld3BvcnRQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgICB0aGlzLmFsbExldmVsc0NvbXBsZXRlZERpYWxvZy52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgcmVtb3ZlUmV3YXJkTm9kZSgpO1xyXG4gICAgICAgIGdhbWVNb2RlbC5jbGVhckFsbExldmVsc0NvbXBsZXRlZCgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gd2hlbiB0aGlzIG5vZGUgbGVhdmVzIHRoZSB2aWV3IHBvcnQsIGNoZWNrIHdoZXRoZXIgYWxsIGxldmVscyBoYWQgYmVlbiBjb21wbGV0ZWQgYW5kLCBpZiBzbywgaGlkZSB0aGUgYXNzb2NpYXRlZFxyXG4gICAgLy8gY2VsZWJyYXRvcnkgbm9kZXMgYW5kIHJlc2V0IHRoZSBmbGFnIGluIHRoZSBtb2RlbC5cclxuICAgIHRoaXMuaW5WaWV3cG9ydFByb3BlcnR5LmxpbmsoICggaW5WaWV3UG9ydCwgd2FzSW5WaWV3UG9ydCApID0+IHtcclxuICAgICAgaWYgKCAhaW5WaWV3UG9ydCAmJiB3YXNJblZpZXdQb3J0ICYmIGdhbWVNb2RlbC5hbGxMZXZlbHNDb21wbGV0ZWRQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgICByZW1vdmVSZXdhcmROb2RlKCk7XHJcbiAgICAgICAgdGhpcy5hbGxMZXZlbHNDb21wbGV0ZWREaWFsb2cudmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIGdhbWVNb2RlbC5jbGVhckFsbExldmVsc0NvbXBsZXRlZCgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gaG9vayB1cCBsaXN0ZW5lcnMgdG8gdGhlIGNvbGxlY3Rpb24gYXJlYXMgdG8gcGxheSB0aGUgYXBwcm9wcmlhdGUgc291bmRzIHVwb24gY29sbGVjdGlvbiBvciByZWplY3Rpb24gb2YgYSB1c2VyLVxyXG4gICAgLy8gc3VibWl0dGVkIGFuc3dlclxyXG4gICAgbGV2ZWxNb2RlbC5jb2xsZWN0aW9uQXJlYXMuZm9yRWFjaCggY29sbGVjdGlvbkFyZWEgPT4ge1xyXG4gICAgICBjb2xsZWN0aW9uQXJlYS5jb2xsZWN0aW9uQXR0ZW1wdGVkRW1pdHRlci5hZGRMaXN0ZW5lciggaXRlbUNvbGxlY3RlZCA9PiB7XHJcbiAgICAgICAgaWYgKCBpdGVtQ29sbGVjdGVkICkge1xyXG4gICAgICAgICAgZ2FtZUF1ZGlvUGxheWVyLmNvcnJlY3RBbnN3ZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoICFpdGVtQ29sbGVjdGVkICYmIGNvbGxlY3Rpb25BcmVhLmlzRW1wdHkoKSApIHtcclxuICAgICAgICAgIGdhbWVBdWRpb1BsYXllci53cm9uZ0Fuc3dlcigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGR0ICkge1xyXG4gICAgaWYgKCB0aGlzLmluVmlld3BvcnRQcm9wZXJ0eS5nZXQoKSAmJiB0aGlzLnJld2FyZE5vZGUgJiYgdGhpcy5yZXdhcmROb2RlLnZpc2libGUgKSB7XHJcbiAgICAgIHRoaXMucmV3YXJkTm9kZS5zdGVwKCBNYXRoLm1pbiggZHQsIDEgKSApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwcmVzc2lvbkV4Y2hhbmdlLnJlZ2lzdGVyKCAnRUVHYW1lTGV2ZWxWaWV3JywgRUVHYW1lTGV2ZWxWaWV3ICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBFRUdhbWVMZXZlbFZpZXc7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFFBQVEsTUFBTSxpQ0FBaUM7QUFDdEQsT0FBT0MsV0FBVyxNQUFNLCtDQUErQztBQUN2RSxPQUFPQyxVQUFVLE1BQU0sbURBQW1EO0FBQzFFLE9BQU9DLGFBQWEsTUFBTSxzREFBc0Q7QUFDaEYsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUM5RCxTQUFTQyxJQUFJLEVBQUVDLFNBQVMsRUFBRUMsSUFBSSxRQUFRLG1DQUFtQztBQUN6RSxPQUFPQyxRQUFRLE1BQU0sZ0NBQWdDO0FBQ3JELE9BQU9DLHNCQUFzQixNQUFNLGdEQUFnRDtBQUNuRixPQUFPQyxpQkFBaUIsTUFBTSxtQ0FBbUM7QUFDakUsT0FBT0MseUJBQXlCLE1BQU0sZ0RBQWdEO0FBQ3RGLE9BQU9DLDBCQUEwQixNQUFNLGlEQUFpRDtBQUN4RixPQUFPQyxtQkFBbUIsTUFBTSwwQ0FBMEM7QUFDMUUsT0FBT0Msa0JBQWtCLE1BQU0sNkJBQTZCO0FBQzVELE9BQU9DLHlCQUF5QixNQUFNLG9DQUFvQztBQUMxRSxPQUFPQyxZQUFZLE1BQU0sbUJBQW1CO0FBQzVDLE9BQU9DLGFBQWEsTUFBTSxvQkFBb0I7QUFFOUMsTUFBTUMsd0JBQXdCLEdBQUdILHlCQUF5QixDQUFDSSxrQkFBa0I7O0FBRTdF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