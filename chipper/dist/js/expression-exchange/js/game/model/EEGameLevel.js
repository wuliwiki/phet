// Copyright 2017-2020, University of Colorado Boulder

/**
 * model for a single level of the Expression Exchange game
 *
 * @author John Blanco
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Property from '../../../../axon/js/Property.js';
import AllowedRepresentations from '../../common/enum/AllowedRepresentations.js';
import ViewMode from '../../common/enum/ViewMode.js';
import ExpressionManipulationModel from '../../common/model/ExpressionManipulationModel.js';
import expressionExchange from '../../expressionExchange.js';
import EEChallengeDescriptors from './EEChallengeDescriptors.js';
import EECollectionArea from './EECollectionArea.js';

// constants
const EXPRESSION_COLLECTION_AREA_X_OFFSET = 750;
const EXPRESSION_COLLECTION_AREA_INITIAL_Y_OFFSET = 50;
const EXPRESSION_COLLECTION_AREA_Y_SPACING = 60;
const NUM_EXPRESSION_COLLECTION_AREAS = 3;
class EEGameLevel extends ExpressionManipulationModel {
  /**
   * @param {number} levelNumber
   * @param {AllowedRepresentations} allowedRepresentations
   */
  constructor(levelNumber, allowedRepresentations) {
    assert && assert(allowedRepresentations !== AllowedRepresentations.COINS_AND_VARIABLES, 'games do not support switching between coin and variable view');
    super({
      allowedRepresentations: allowedRepresentations,
      partialCancellationEnabled: false,
      // partial cancellation isn't performed in the games
      simplifyNegativesDefault: true
    });
    const self = this;
    this.levelNumber = levelNumber; // @public (read-only) {number}
    this.currentChallengeNumber = 0; // {number} @private

    // @public (read-only) {EEChallengeDescriptor} - property that refers to the current challenge
    this.currentChallengeProperty = new Property(EEChallengeDescriptors.getChallengeDescriptor(levelNumber, this.currentChallengeNumber));

    // @public (read-only) {Property.<number>} - current score for this level
    this.scoreProperty = new Property(0);

    // @private {boolean}
    this.scoreWasZeroSinceLastCompletion = true;

    // @public (read-only) {Property.<boolean>} - a flag used to track whether this level has been completed since the
    // last time this flag was cleared.  For this to be true, the score must have gone from zero to the max since the
    // last time this flag was set.
    this.completedSinceLastClearProperty = new Property(false);

    // update the variable that track whether the user has fully solved the level since the last time this flag was
    // cleared
    this.scoreProperty.link(score => {
      if (score === 0) {
        this.scoreWasZeroSinceLastCompletion = true;
      }
      this.completedSinceLastClearProperty.set(score === NUM_EXPRESSION_COLLECTION_AREAS && this.scoreWasZeroSinceLastCompletion);
    });

    // helper function to update the score when items are collected or un-collected
    function updateScore() {
      let score = 0;
      self.collectionAreas.forEach(collectionArea => {
        if (!collectionArea.isEmpty()) {
          score++;
        }
      });
      self.scoreProperty.set(score);
    }

    // create a property that indicate whether undo of collection areas should be allowed
    const undoAllowedProperty = new DerivedProperty([this.scoreProperty], score => score < NUM_EXPRESSION_COLLECTION_AREAS);

    // initialize the collection areas
    let collectionAreaYPos = EXPRESSION_COLLECTION_AREA_INITIAL_Y_OFFSET;
    _.times(NUM_EXPRESSION_COLLECTION_AREAS, () => {
      const collectionArea = new EECollectionArea(EXPRESSION_COLLECTION_AREA_X_OFFSET, collectionAreaYPos, allowedRepresentations === AllowedRepresentations.COINS_ONLY ? ViewMode.COINS : ViewMode.VARIABLES, undoAllowedProperty);
      collectionArea.collectedItemProperty.link(updateScore);
      this.collectionAreas.push(collectionArea);
      collectionAreaYPos += collectionArea.bounds.height + EXPRESSION_COLLECTION_AREA_Y_SPACING;
    });

    // update the expression description associated with the expression collection areas each time a new challenge is set
    this.currentChallengeProperty.link(currentChallenge => {
      this.collectionAreas.forEach((expressionCollectionArea, index) => {
        expressionCollectionArea.expressionDescriptionProperty.set(currentChallenge.expressionsToCollect[index]);
      });
    });
  }

  /**
   * @public
   */
  reset() {
    super.reset();
    this.scoreProperty.reset();
    this.currentChallengeNumber = 0;
    this.currentChallengeProperty.set(EEChallengeDescriptors.getChallengeDescriptor(this.levelNumber, this.currentChallengeNumber));
  }

  /**
   * @public
   */
  refresh() {
    this.collectionAreas.forEach(collectionArea => {
      collectionArea.reset();
    });
    super.reset();
    this.loadNextChallenge();
  }

  /**
   * increment the challenge number and load the associated challenge
   * @private
   */
  loadNextChallenge() {
    this.currentChallengeNumber = (this.currentChallengeNumber + 1) % EEChallengeDescriptors.CHALLENGES_PER_LEVEL;
    this.currentChallengeProperty.set(EEChallengeDescriptors.getChallengeDescriptor(this.levelNumber, this.currentChallengeNumber));
  }
}
expressionExchange.register('EEGameLevel', EEGameLevel);
export default EEGameLevel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJQcm9wZXJ0eSIsIkFsbG93ZWRSZXByZXNlbnRhdGlvbnMiLCJWaWV3TW9kZSIsIkV4cHJlc3Npb25NYW5pcHVsYXRpb25Nb2RlbCIsImV4cHJlc3Npb25FeGNoYW5nZSIsIkVFQ2hhbGxlbmdlRGVzY3JpcHRvcnMiLCJFRUNvbGxlY3Rpb25BcmVhIiwiRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFfWF9PRkZTRVQiLCJFWFBSRVNTSU9OX0NPTExFQ1RJT05fQVJFQV9JTklUSUFMX1lfT0ZGU0VUIiwiRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFfWV9TUEFDSU5HIiwiTlVNX0VYUFJFU1NJT05fQ09MTEVDVElPTl9BUkVBUyIsIkVFR2FtZUxldmVsIiwiY29uc3RydWN0b3IiLCJsZXZlbE51bWJlciIsImFsbG93ZWRSZXByZXNlbnRhdGlvbnMiLCJhc3NlcnQiLCJDT0lOU19BTkRfVkFSSUFCTEVTIiwicGFydGlhbENhbmNlbGxhdGlvbkVuYWJsZWQiLCJzaW1wbGlmeU5lZ2F0aXZlc0RlZmF1bHQiLCJzZWxmIiwiY3VycmVudENoYWxsZW5nZU51bWJlciIsImN1cnJlbnRDaGFsbGVuZ2VQcm9wZXJ0eSIsImdldENoYWxsZW5nZURlc2NyaXB0b3IiLCJzY29yZVByb3BlcnR5Iiwic2NvcmVXYXNaZXJvU2luY2VMYXN0Q29tcGxldGlvbiIsImNvbXBsZXRlZFNpbmNlTGFzdENsZWFyUHJvcGVydHkiLCJsaW5rIiwic2NvcmUiLCJzZXQiLCJ1cGRhdGVTY29yZSIsImNvbGxlY3Rpb25BcmVhcyIsImZvckVhY2giLCJjb2xsZWN0aW9uQXJlYSIsImlzRW1wdHkiLCJ1bmRvQWxsb3dlZFByb3BlcnR5IiwiY29sbGVjdGlvbkFyZWFZUG9zIiwiXyIsInRpbWVzIiwiQ09JTlNfT05MWSIsIkNPSU5TIiwiVkFSSUFCTEVTIiwiY29sbGVjdGVkSXRlbVByb3BlcnR5IiwicHVzaCIsImJvdW5kcyIsImhlaWdodCIsImN1cnJlbnRDaGFsbGVuZ2UiLCJleHByZXNzaW9uQ29sbGVjdGlvbkFyZWEiLCJpbmRleCIsImV4cHJlc3Npb25EZXNjcmlwdGlvblByb3BlcnR5IiwiZXhwcmVzc2lvbnNUb0NvbGxlY3QiLCJyZXNldCIsInJlZnJlc2giLCJsb2FkTmV4dENoYWxsZW5nZSIsIkNIQUxMRU5HRVNfUEVSX0xFVkVMIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFRUdhbWVMZXZlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIwLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBtb2RlbCBmb3IgYSBzaW5nbGUgbGV2ZWwgb2YgdGhlIEV4cHJlc3Npb24gRXhjaGFuZ2UgZ2FtZVxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IEFsbG93ZWRSZXByZXNlbnRhdGlvbnMgZnJvbSAnLi4vLi4vY29tbW9uL2VudW0vQWxsb3dlZFJlcHJlc2VudGF0aW9ucy5qcyc7XHJcbmltcG9ydCBWaWV3TW9kZSBmcm9tICcuLi8uLi9jb21tb24vZW51bS9WaWV3TW9kZS5qcyc7XHJcbmltcG9ydCBFeHByZXNzaW9uTWFuaXB1bGF0aW9uTW9kZWwgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0V4cHJlc3Npb25NYW5pcHVsYXRpb25Nb2RlbC5qcyc7XHJcbmltcG9ydCBleHByZXNzaW9uRXhjaGFuZ2UgZnJvbSAnLi4vLi4vZXhwcmVzc2lvbkV4Y2hhbmdlLmpzJztcclxuaW1wb3J0IEVFQ2hhbGxlbmdlRGVzY3JpcHRvcnMgZnJvbSAnLi9FRUNoYWxsZW5nZURlc2NyaXB0b3JzLmpzJztcclxuaW1wb3J0IEVFQ29sbGVjdGlvbkFyZWEgZnJvbSAnLi9FRUNvbGxlY3Rpb25BcmVhLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBFWFBSRVNTSU9OX0NPTExFQ1RJT05fQVJFQV9YX09GRlNFVCA9IDc1MDtcclxuY29uc3QgRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFfSU5JVElBTF9ZX09GRlNFVCA9IDUwO1xyXG5jb25zdCBFWFBSRVNTSU9OX0NPTExFQ1RJT05fQVJFQV9ZX1NQQUNJTkcgPSA2MDtcclxuY29uc3QgTlVNX0VYUFJFU1NJT05fQ09MTEVDVElPTl9BUkVBUyA9IDM7XHJcblxyXG5jbGFzcyBFRUdhbWVMZXZlbCBleHRlbmRzIEV4cHJlc3Npb25NYW5pcHVsYXRpb25Nb2RlbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBsZXZlbE51bWJlclxyXG4gICAqIEBwYXJhbSB7QWxsb3dlZFJlcHJlc2VudGF0aW9uc30gYWxsb3dlZFJlcHJlc2VudGF0aW9uc1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBsZXZlbE51bWJlciwgYWxsb3dlZFJlcHJlc2VudGF0aW9ucyApIHtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KFxyXG4gICAgICBhbGxvd2VkUmVwcmVzZW50YXRpb25zICE9PSBBbGxvd2VkUmVwcmVzZW50YXRpb25zLkNPSU5TX0FORF9WQVJJQUJMRVMsXHJcbiAgICAgICdnYW1lcyBkbyBub3Qgc3VwcG9ydCBzd2l0Y2hpbmcgYmV0d2VlbiBjb2luIGFuZCB2YXJpYWJsZSB2aWV3J1xyXG4gICAgKTtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICBhbGxvd2VkUmVwcmVzZW50YXRpb25zOiBhbGxvd2VkUmVwcmVzZW50YXRpb25zLFxyXG4gICAgICBwYXJ0aWFsQ2FuY2VsbGF0aW9uRW5hYmxlZDogZmFsc2UsIC8vIHBhcnRpYWwgY2FuY2VsbGF0aW9uIGlzbid0IHBlcmZvcm1lZCBpbiB0aGUgZ2FtZXNcclxuICAgICAgc2ltcGxpZnlOZWdhdGl2ZXNEZWZhdWx0OiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgdGhpcy5sZXZlbE51bWJlciA9IGxldmVsTnVtYmVyOyAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtudW1iZXJ9XHJcbiAgICB0aGlzLmN1cnJlbnRDaGFsbGVuZ2VOdW1iZXIgPSAwOyAvLyB7bnVtYmVyfSBAcHJpdmF0ZVxyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkge0VFQ2hhbGxlbmdlRGVzY3JpcHRvcn0gLSBwcm9wZXJ0eSB0aGF0IHJlZmVycyB0byB0aGUgY3VycmVudCBjaGFsbGVuZ2VcclxuICAgIHRoaXMuY3VycmVudENoYWxsZW5nZVByb3BlcnR5ID0gbmV3IFByb3BlcnR5KFxyXG4gICAgICBFRUNoYWxsZW5nZURlc2NyaXB0b3JzLmdldENoYWxsZW5nZURlc2NyaXB0b3IoIGxldmVsTnVtYmVyLCB0aGlzLmN1cnJlbnRDaGFsbGVuZ2VOdW1iZXIgKVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtQcm9wZXJ0eS48bnVtYmVyPn0gLSBjdXJyZW50IHNjb3JlIGZvciB0aGlzIGxldmVsXHJcbiAgICB0aGlzLnNjb3JlUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIDAgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Ym9vbGVhbn1cclxuICAgIHRoaXMuc2NvcmVXYXNaZXJvU2luY2VMYXN0Q29tcGxldGlvbiA9IHRydWU7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSB7UHJvcGVydHkuPGJvb2xlYW4+fSAtIGEgZmxhZyB1c2VkIHRvIHRyYWNrIHdoZXRoZXIgdGhpcyBsZXZlbCBoYXMgYmVlbiBjb21wbGV0ZWQgc2luY2UgdGhlXHJcbiAgICAvLyBsYXN0IHRpbWUgdGhpcyBmbGFnIHdhcyBjbGVhcmVkLiAgRm9yIHRoaXMgdG8gYmUgdHJ1ZSwgdGhlIHNjb3JlIG11c3QgaGF2ZSBnb25lIGZyb20gemVybyB0byB0aGUgbWF4IHNpbmNlIHRoZVxyXG4gICAgLy8gbGFzdCB0aW1lIHRoaXMgZmxhZyB3YXMgc2V0LlxyXG4gICAgdGhpcy5jb21wbGV0ZWRTaW5jZUxhc3RDbGVhclByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBmYWxzZSApO1xyXG5cclxuICAgIC8vIHVwZGF0ZSB0aGUgdmFyaWFibGUgdGhhdCB0cmFjayB3aGV0aGVyIHRoZSB1c2VyIGhhcyBmdWxseSBzb2x2ZWQgdGhlIGxldmVsIHNpbmNlIHRoZSBsYXN0IHRpbWUgdGhpcyBmbGFnIHdhc1xyXG4gICAgLy8gY2xlYXJlZFxyXG4gICAgdGhpcy5zY29yZVByb3BlcnR5LmxpbmsoIHNjb3JlID0+IHtcclxuICAgICAgaWYgKCBzY29yZSA9PT0gMCApIHtcclxuICAgICAgICB0aGlzLnNjb3JlV2FzWmVyb1NpbmNlTGFzdENvbXBsZXRpb24gPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuY29tcGxldGVkU2luY2VMYXN0Q2xlYXJQcm9wZXJ0eS5zZXQoIHNjb3JlID09PSBOVU1fRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFTICYmIHRoaXMuc2NvcmVXYXNaZXJvU2luY2VMYXN0Q29tcGxldGlvbiApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGhlbHBlciBmdW5jdGlvbiB0byB1cGRhdGUgdGhlIHNjb3JlIHdoZW4gaXRlbXMgYXJlIGNvbGxlY3RlZCBvciB1bi1jb2xsZWN0ZWRcclxuICAgIGZ1bmN0aW9uIHVwZGF0ZVNjb3JlKCkge1xyXG4gICAgICBsZXQgc2NvcmUgPSAwO1xyXG4gICAgICBzZWxmLmNvbGxlY3Rpb25BcmVhcy5mb3JFYWNoKCBjb2xsZWN0aW9uQXJlYSA9PiB7XHJcbiAgICAgICAgaWYgKCAhY29sbGVjdGlvbkFyZWEuaXNFbXB0eSgpICkge1xyXG4gICAgICAgICAgc2NvcmUrKztcclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuICAgICAgc2VsZi5zY29yZVByb3BlcnR5LnNldCggc2NvcmUgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjcmVhdGUgYSBwcm9wZXJ0eSB0aGF0IGluZGljYXRlIHdoZXRoZXIgdW5kbyBvZiBjb2xsZWN0aW9uIGFyZWFzIHNob3VsZCBiZSBhbGxvd2VkXHJcbiAgICBjb25zdCB1bmRvQWxsb3dlZFByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyB0aGlzLnNjb3JlUHJvcGVydHkgXSwgc2NvcmUgPT4gc2NvcmUgPCBOVU1fRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFTICk7XHJcblxyXG4gICAgLy8gaW5pdGlhbGl6ZSB0aGUgY29sbGVjdGlvbiBhcmVhc1xyXG4gICAgbGV0IGNvbGxlY3Rpb25BcmVhWVBvcyA9IEVYUFJFU1NJT05fQ09MTEVDVElPTl9BUkVBX0lOSVRJQUxfWV9PRkZTRVQ7XHJcbiAgICBfLnRpbWVzKCBOVU1fRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFTLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb25BcmVhID0gbmV3IEVFQ29sbGVjdGlvbkFyZWEoXHJcbiAgICAgICAgRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFfWF9PRkZTRVQsXHJcbiAgICAgICAgY29sbGVjdGlvbkFyZWFZUG9zLFxyXG4gICAgICAgIGFsbG93ZWRSZXByZXNlbnRhdGlvbnMgPT09IEFsbG93ZWRSZXByZXNlbnRhdGlvbnMuQ09JTlNfT05MWSA/IFZpZXdNb2RlLkNPSU5TIDogVmlld01vZGUuVkFSSUFCTEVTLFxyXG4gICAgICAgIHVuZG9BbGxvd2VkUHJvcGVydHlcclxuICAgICAgKTtcclxuICAgICAgY29sbGVjdGlvbkFyZWEuY29sbGVjdGVkSXRlbVByb3BlcnR5LmxpbmsoIHVwZGF0ZVNjb3JlICk7XHJcbiAgICAgIHRoaXMuY29sbGVjdGlvbkFyZWFzLnB1c2goIGNvbGxlY3Rpb25BcmVhICk7XHJcbiAgICAgIGNvbGxlY3Rpb25BcmVhWVBvcyArPSBjb2xsZWN0aW9uQXJlYS5ib3VuZHMuaGVpZ2h0ICsgRVhQUkVTU0lPTl9DT0xMRUNUSU9OX0FSRUFfWV9TUEFDSU5HO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHVwZGF0ZSB0aGUgZXhwcmVzc2lvbiBkZXNjcmlwdGlvbiBhc3NvY2lhdGVkIHdpdGggdGhlIGV4cHJlc3Npb24gY29sbGVjdGlvbiBhcmVhcyBlYWNoIHRpbWUgYSBuZXcgY2hhbGxlbmdlIGlzIHNldFxyXG4gICAgdGhpcy5jdXJyZW50Q2hhbGxlbmdlUHJvcGVydHkubGluayggY3VycmVudENoYWxsZW5nZSA9PiB7XHJcbiAgICAgIHRoaXMuY29sbGVjdGlvbkFyZWFzLmZvckVhY2goICggZXhwcmVzc2lvbkNvbGxlY3Rpb25BcmVhLCBpbmRleCApID0+IHtcclxuICAgICAgICBleHByZXNzaW9uQ29sbGVjdGlvbkFyZWEuZXhwcmVzc2lvbkRlc2NyaXB0aW9uUHJvcGVydHkuc2V0KCBjdXJyZW50Q2hhbGxlbmdlLmV4cHJlc3Npb25zVG9Db2xsZWN0WyBpbmRleCBdICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZXNldCgpIHtcclxuICAgIHN1cGVyLnJlc2V0KCk7XHJcbiAgICB0aGlzLnNjb3JlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuY3VycmVudENoYWxsZW5nZU51bWJlciA9IDA7XHJcbiAgICB0aGlzLmN1cnJlbnRDaGFsbGVuZ2VQcm9wZXJ0eS5zZXQoXHJcbiAgICAgIEVFQ2hhbGxlbmdlRGVzY3JpcHRvcnMuZ2V0Q2hhbGxlbmdlRGVzY3JpcHRvciggdGhpcy5sZXZlbE51bWJlciwgdGhpcy5jdXJyZW50Q2hhbGxlbmdlTnVtYmVyIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVmcmVzaCgpIHtcclxuICAgIHRoaXMuY29sbGVjdGlvbkFyZWFzLmZvckVhY2goIGNvbGxlY3Rpb25BcmVhID0+IHtcclxuICAgICAgY29sbGVjdGlvbkFyZWEucmVzZXQoKTtcclxuICAgIH0gKTtcclxuICAgIHN1cGVyLnJlc2V0KCk7XHJcbiAgICB0aGlzLmxvYWROZXh0Q2hhbGxlbmdlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBpbmNyZW1lbnQgdGhlIGNoYWxsZW5nZSBudW1iZXIgYW5kIGxvYWQgdGhlIGFzc29jaWF0ZWQgY2hhbGxlbmdlXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBsb2FkTmV4dENoYWxsZW5nZSgpIHtcclxuICAgIHRoaXMuY3VycmVudENoYWxsZW5nZU51bWJlciA9ICggdGhpcy5jdXJyZW50Q2hhbGxlbmdlTnVtYmVyICsgMSApICUgRUVDaGFsbGVuZ2VEZXNjcmlwdG9ycy5DSEFMTEVOR0VTX1BFUl9MRVZFTDtcclxuICAgIHRoaXMuY3VycmVudENoYWxsZW5nZVByb3BlcnR5LnNldCggRUVDaGFsbGVuZ2VEZXNjcmlwdG9ycy5nZXRDaGFsbGVuZ2VEZXNjcmlwdG9yKFxyXG4gICAgICB0aGlzLmxldmVsTnVtYmVyLFxyXG4gICAgICB0aGlzLmN1cnJlbnRDaGFsbGVuZ2VOdW1iZXJcclxuICAgICkgKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cHJlc3Npb25FeGNoYW5nZS5yZWdpc3RlciggJ0VFR2FtZUxldmVsJywgRUVHYW1lTGV2ZWwgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IEVFR2FtZUxldmVsOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBQ3BFLE9BQU9DLFFBQVEsTUFBTSxpQ0FBaUM7QUFDdEQsT0FBT0Msc0JBQXNCLE1BQU0sNkNBQTZDO0FBQ2hGLE9BQU9DLFFBQVEsTUFBTSwrQkFBK0I7QUFDcEQsT0FBT0MsMkJBQTJCLE1BQU0sbURBQW1EO0FBQzNGLE9BQU9DLGtCQUFrQixNQUFNLDZCQUE2QjtBQUM1RCxPQUFPQyxzQkFBc0IsTUFB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