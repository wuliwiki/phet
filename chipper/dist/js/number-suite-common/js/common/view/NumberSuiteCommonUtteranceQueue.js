// Copyright 2023, University of Colorado Boulder

/**
 * A subclass of UtteranceQueue that is used for voicing specific to Number Suite sims. This is needed because
 * Number Sims don't have the Voicing feature, but they still need to use speech synthesis.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 */

import UtteranceQueue from '../../../../utterance-queue/js/UtteranceQueue.js';
import numberSuiteCommon from '../../numberSuiteCommon.js';
import Utterance from '../../../../utterance-queue/js/Utterance.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberSuiteCommonConstants from '../NumberSuiteCommonConstants.js';
import NumberSuiteCommonStrings from '../../NumberSuiteCommonStrings.js';

// constants
const ONE_TWO_THREE_STRING_KEY = `${NumberSuiteCommonConstants.NUMBER_SUITE_COMMON_REQUIREJS_NAMESPACE}/oneTwoThree`;

// This reference exists to ensure that the string from the string key above does not get stripped out of the sim
// during a build. Since we need to be able to get the string in ANY language requested (instead of the language that
// the sim is running in), we can't use this string Property like normal.
NumberSuiteCommonStrings.oneTwoThreeStringProperty;
export default class NumberSuiteCommonUtteranceQueue extends UtteranceQueue {
  // Data that can be spoken to the user. The data comes from the screen that is currently being interacted with.

  // Whether this class has been initialized.
  initialized = false;

  // The Utterance used for speaking speechData.
  speechDataUtterance = new Utterance();

  // The Utterance used for speaking when the user is testing a voice in Preferences.
  testVoiceUtterance = new Utterance();

  // See doc in NumberSuiteCommonPreferences.

  constructor(numberSuiteCommonAnnouncer, isPrimaryLocaleProperty, primaryLocaleProperty, secondLocaleProperty, autoHearEnabledProperty) {
    super(numberSuiteCommonAnnouncer);
    this.isPrimaryLocaleProperty = isPrimaryLocaleProperty;
    this.primaryLocaleProperty = primaryLocaleProperty;
    this.secondLocaleProperty = secondLocaleProperty;
    this.autoHearEnabledProperty = autoHearEnabledProperty;
  }

  /**
   * Speaks the value of this.speechDataProperty.
   */
  speakSpeechData() {
    assert && assert(this.initialized && this.speechDataProperty, 'Cannot speak before initialization');
    const speechData = this.speechDataProperty.value;

    // determine which voice to use based on isPrimaryLocaleProperty
    const voice = this.isPrimaryLocaleProperty.value ? this.primaryLocaleProperty.value : this.secondLocaleProperty.value;
    speechData && voice && this.speak(speechData, this.speechDataUtterance, voice);
  }

  /**
   * Cancels any ongoing speaking of speechData.
   */
  cancelSpeechDataSpeaking() {
    this.cancelUtterance(this.speechDataUtterance);
  }

  /**
   * Speaks a 'test' string in the provided voice and locale.
   */
  speakTestVoice(voiceToTest, locale) {
    voiceToTest && this.speak(this.getTestStringForLocale(locale), this.testVoiceUtterance, voiceToTest);
  }

  /**
   * Speaks the provided string.
   */
  speak(string, utterance, voice) {
    assert && assert(voice, 'No voice set for voiceProperty: ', voice);

    // Set the provided voice before speaking.
    utterance.announcerOptions.voice = voice;
    utterance.alert = string;
    this.addToBack(utterance);
  }

  /**
   * Returns a test string in the provided locale. If the string isn't found in the desired locale, the english version
   * of the string is returned instead.
   */
  getTestStringForLocale(locale) {
    const strings = phet.chipper.strings;
    const translatedStrings = strings[locale];
    const backupStrings = strings.en;
    const testString = translatedStrings && translatedStrings[ONE_TWO_THREE_STRING_KEY] ? translatedStrings[ONE_TWO_THREE_STRING_KEY] : backupStrings[ONE_TWO_THREE_STRING_KEY];
    assert && assert(testString, `No test string found for locales ${locale} or en.`);
    return testString;
  }

  /**
   * Initializes this UtteranceQueue by providing speechDataProperty to use for speaking.
   */
  initializeNumberSuiteCommonUtteranceQueue(speechDataProperty) {
    assert && assert(!this.initialized, 'Tried to initialize NumberSuiteCommonUtteranceQueue more than once.');
    this.speechDataProperty = speechDataProperty;

    // Speak the speechData if autoHear is turned on or the speechData changes. Also check that the announcer has a
    // voice because even if the voiceProperty is set to null, the browser still speaks with a default voice.
    Multilink.lazyMultilink([this.autoHearEnabledProperty, this.speechDataProperty], autoHearEnabled => autoHearEnabled && this.speakSpeechData());
    this.initialized = true;
  }
}
numberSuiteCommon.register('NumberSuiteCommonUtteranceQueue', NumberSuiteCommonUtteranceQueue);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdHRlcmFuY2VRdWV1ZSIsIm51bWJlclN1aXRlQ29tbW9uIiwiVXR0ZXJhbmNlIiwiTXVsdGlsaW5rIiwiTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMiLCJOdW1iZXJTdWl0ZUNvbW1vblN0cmluZ3MiLCJPTkVfVFdPX1RIUkVFX1NUUklOR19LRVkiLCJOVU1CRVJfU1VJVEVfQ09NTU9OX1JFUVVJUkVKU19OQU1FU1BBQ0UiLCJvbmVUd29UaHJlZVN0cmluZ1Byb3BlcnR5IiwiTnVtYmVyU3VpdGVDb21tb25VdHRlcmFuY2VRdWV1ZSIsImluaXRpYWxpemVkIiwic3BlZWNoRGF0YVV0dGVyYW5jZSIsInRlc3RWb2ljZVV0dGVyYW5jZSIsImNvbnN0cnVjdG9yIiwibnVtYmVyU3VpdGVDb21tb25Bbm5vdW5jZXIiLCJpc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eSIsInByaW1hcnlMb2NhbGVQcm9wZXJ0eSIsInNlY29uZExvY2FsZVByb3BlcnR5IiwiYXV0b0hlYXJFbmFibGVkUHJvcGVydHkiLCJzcGVha1NwZWVjaERhdGEiLCJhc3NlcnQiLCJzcGVlY2hEYXRhUHJvcGVydHkiLCJzcGVlY2hEYXRhIiwidmFsdWUiLCJ2b2ljZSIsInNwZWFrIiwiY2FuY2VsU3BlZWNoRGF0YVNwZWFraW5nIiwiY2FuY2VsVXR0ZXJhbmNlIiwic3BlYWtUZXN0Vm9pY2UiLCJ2b2ljZVRvVGVzdCIsImxvY2FsZSIsImdldFRlc3RTdHJpbmdGb3JMb2NhbGUiLCJzdHJpbmciLCJ1dHRlcmFuY2UiLCJhbm5vdW5jZXJPcHRpb25zIiwiYWxlcnQiLCJhZGRUb0JhY2siLCJzdHJpbmdzIiwicGhldCIsImNoaXBwZXIiLCJ0cmFuc2xhdGVkU3RyaW5ncyIsImJhY2t1cFN0cmluZ3MiLCJlbiIsInRlc3RTdHJpbmciLCJpbml0aWFsaXplTnVtYmVyU3VpdGVDb21tb25VdHRlcmFuY2VRdWV1ZSIsImxhenlNdWx0aWxpbmsiLCJhdXRvSGVhckVuYWJsZWQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk51bWJlclN1aXRlQ29tbW9uVXR0ZXJhbmNlUXVldWUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEEgc3ViY2xhc3Mgb2YgVXR0ZXJhbmNlUXVldWUgdGhhdCBpcyB1c2VkIGZvciB2b2ljaW5nIHNwZWNpZmljIHRvIE51bWJlciBTdWl0ZSBzaW1zLiBUaGlzIGlzIG5lZWRlZCBiZWNhdXNlXHJcbiAqIE51bWJlciBTaW1zIGRvbid0IGhhdmUgdGhlIFZvaWNpbmcgZmVhdHVyZSwgYnV0IHRoZXkgc3RpbGwgbmVlZCB0byB1c2Ugc3BlZWNoIHN5bnRoZXNpcy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBLbHVzZW5kb3JmIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IExvY2FsZSB9IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL2kxOG4vbG9jYWxlUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVXR0ZXJhbmNlUXVldWUgZnJvbSAnLi4vLi4vLi4vLi4vdXR0ZXJhbmNlLXF1ZXVlL2pzL1V0dGVyYW5jZVF1ZXVlLmpzJztcclxuaW1wb3J0IE51bWJlclN1aXRlQ29tbW9uU3BlZWNoU3ludGhlc2lzQW5ub3VuY2VyIGZyb20gJy4vTnVtYmVyU3VpdGVDb21tb25TcGVlY2hTeW50aGVzaXNBbm5vdW5jZXIuanMnO1xyXG5pbXBvcnQgbnVtYmVyU3VpdGVDb21tb24gZnJvbSAnLi4vLi4vbnVtYmVyU3VpdGVDb21tb24uanMnO1xyXG5pbXBvcnQgVXR0ZXJhbmNlIGZyb20gJy4uLy4uLy4uLy4uL3V0dGVyYW5jZS1xdWV1ZS9qcy9VdHRlcmFuY2UuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMgZnJvbSAnLi4vTnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgTnVtYmVyU3VpdGVDb21tb25TdHJpbmdzIGZyb20gJy4uLy4uL051bWJlclN1aXRlQ29tbW9uU3RyaW5ncy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgT05FX1RXT19USFJFRV9TVFJJTkdfS0VZID0gYCR7TnVtYmVyU3VpdGVDb21tb25Db25zdGFudHMuTlVNQkVSX1NVSVRFX0NPTU1PTl9SRVFVSVJFSlNfTkFNRVNQQUNFfS9vbmVUd29UaHJlZWA7XHJcblxyXG4vLyBUaGlzIHJlZmVyZW5jZSBleGlzdHMgdG8gZW5zdXJlIHRoYXQgdGhlIHN0cmluZyBmcm9tIHRoZSBzdHJpbmcga2V5IGFib3ZlIGRvZXMgbm90IGdldCBzdHJpcHBlZCBvdXQgb2YgdGhlIHNpbVxyXG4vLyBkdXJpbmcgYSBidWlsZC4gU2luY2Ugd2UgbmVlZCB0byBiZSBhYmxlIHRvIGdldCB0aGUgc3RyaW5nIGluIEFOWSBsYW5ndWFnZSByZXF1ZXN0ZWQgKGluc3RlYWQgb2YgdGhlIGxhbmd1YWdlIHRoYXRcclxuLy8gdGhlIHNpbSBpcyBydW5uaW5nIGluKSwgd2UgY2FuJ3QgdXNlIHRoaXMgc3RyaW5nIFByb3BlcnR5IGxpa2Ugbm9ybWFsLlxyXG5OdW1iZXJTdWl0ZUNvbW1vblN0cmluZ3Mub25lVHdvVGhyZWVTdHJpbmdQcm9wZXJ0eTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGFic3RyYWN0IGNsYXNzIE51bWJlclN1aXRlQ29tbW9uVXR0ZXJhbmNlUXVldWUgZXh0ZW5kcyBVdHRlcmFuY2VRdWV1ZTxOdW1iZXJTdWl0ZUNvbW1vblNwZWVjaFN5bnRoZXNpc0Fubm91bmNlcj4ge1xyXG5cclxuICAvLyBEYXRhIHRoYXQgY2FuIGJlIHNwb2tlbiB0byB0aGUgdXNlci4gVGhlIGRhdGEgY29tZXMgZnJvbSB0aGUgc2NyZWVuIHRoYXQgaXMgY3VycmVudGx5IGJlaW5nIGludGVyYWN0ZWQgd2l0aC5cclxuICBwcml2YXRlIHNwZWVjaERhdGFQcm9wZXJ0eSE6IFRSZWFkT25seVByb3BlcnR5PHN0cmluZyB8IG51bGw+O1xyXG5cclxuICAvLyBXaGV0aGVyIHRoaXMgY2xhc3MgaGFzIGJlZW4gaW5pdGlhbGl6ZWQuXHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAvLyBUaGUgVXR0ZXJhbmNlIHVzZWQgZm9yIHNwZWFraW5nIHNwZWVjaERhdGEuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBzcGVlY2hEYXRhVXR0ZXJhbmNlID0gbmV3IFV0dGVyYW5jZSgpO1xyXG5cclxuICAvLyBUaGUgVXR0ZXJhbmNlIHVzZWQgZm9yIHNwZWFraW5nIHdoZW4gdGhlIHVzZXIgaXMgdGVzdGluZyBhIHZvaWNlIGluIFByZWZlcmVuY2VzLlxyXG4gIHByaXZhdGUgcmVhZG9ubHkgdGVzdFZvaWNlVXR0ZXJhbmNlID0gbmV3IFV0dGVyYW5jZSgpO1xyXG5cclxuICAvLyBTZWUgZG9jIGluIE51bWJlclN1aXRlQ29tbW9uUHJlZmVyZW5jZXMuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBpc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBwcmltYXJ5TG9jYWxlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFNwZWVjaFN5bnRoZXNpc1ZvaWNlIHwgbnVsbD47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBzZWNvbmRMb2NhbGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8U3BlZWNoU3ludGhlc2lzVm9pY2UgfCBudWxsPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGF1dG9IZWFyRW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKCBudW1iZXJTdWl0ZUNvbW1vbkFubm91bmNlcjogTnVtYmVyU3VpdGVDb21tb25TcGVlY2hTeW50aGVzaXNBbm5vdW5jZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBpc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBwcmltYXJ5TG9jYWxlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PFNwZWVjaFN5bnRoZXNpc1ZvaWNlIHwgbnVsbD4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBzZWNvbmRMb2NhbGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8U3BlZWNoU3ludGhlc2lzVm9pY2UgfCBudWxsPixcclxuICAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9IZWFyRW5hYmxlZFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPlxyXG4gICkge1xyXG4gICAgc3VwZXIoIG51bWJlclN1aXRlQ29tbW9uQW5ub3VuY2VyICk7XHJcblxyXG4gICAgdGhpcy5pc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eSA9IGlzUHJpbWFyeUxvY2FsZVByb3BlcnR5O1xyXG4gICAgdGhpcy5wcmltYXJ5TG9jYWxlUHJvcGVydHkgPSBwcmltYXJ5TG9jYWxlUHJvcGVydHk7XHJcbiAgICB0aGlzLnNlY29uZExvY2FsZVByb3BlcnR5ID0gc2Vjb25kTG9jYWxlUHJvcGVydHk7XHJcbiAgICB0aGlzLmF1dG9IZWFyRW5hYmxlZFByb3BlcnR5ID0gYXV0b0hlYXJFbmFibGVkUHJvcGVydHk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTcGVha3MgdGhlIHZhbHVlIG9mIHRoaXMuc3BlZWNoRGF0YVByb3BlcnR5LlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzcGVha1NwZWVjaERhdGEoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmluaXRpYWxpemVkICYmIHRoaXMuc3BlZWNoRGF0YVByb3BlcnR5LCAnQ2Fubm90IHNwZWFrIGJlZm9yZSBpbml0aWFsaXphdGlvbicgKTtcclxuICAgIGNvbnN0IHNwZWVjaERhdGEgPSB0aGlzLnNwZWVjaERhdGFQcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICAvLyBkZXRlcm1pbmUgd2hpY2ggdm9pY2UgdG8gdXNlIGJhc2VkIG9uIGlzUHJpbWFyeUxvY2FsZVByb3BlcnR5XHJcbiAgICBjb25zdCB2b2ljZSA9IHRoaXMuaXNQcmltYXJ5TG9jYWxlUHJvcGVydHkudmFsdWUgPyB0aGlzLnByaW1hcnlMb2NhbGVQcm9wZXJ0eS52YWx1ZSA6IHRoaXMuc2Vjb25kTG9jYWxlUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgc3BlZWNoRGF0YSAmJiB2b2ljZSAmJiB0aGlzLnNwZWFrKCBzcGVlY2hEYXRhLCB0aGlzLnNwZWVjaERhdGFVdHRlcmFuY2UsIHZvaWNlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDYW5jZWxzIGFueSBvbmdvaW5nIHNwZWFraW5nIG9mIHNwZWVjaERhdGEuXHJcbiAgICovXHJcbiAgcHVibGljIGNhbmNlbFNwZWVjaERhdGFTcGVha2luZygpOiB2b2lkIHtcclxuICAgIHRoaXMuY2FuY2VsVXR0ZXJhbmNlKCB0aGlzLnNwZWVjaERhdGFVdHRlcmFuY2UgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNwZWFrcyBhICd0ZXN0JyBzdHJpbmcgaW4gdGhlIHByb3ZpZGVkIHZvaWNlIGFuZCBsb2NhbGUuXHJcbiAgICovXHJcbiAgcHVibGljIHNwZWFrVGVzdFZvaWNlKCB2b2ljZVRvVGVzdDogU3BlZWNoU3ludGhlc2lzVm9pY2UgfCBudWxsLCBsb2NhbGU6IExvY2FsZSApOiB2b2lkIHtcclxuICAgIHZvaWNlVG9UZXN0ICYmIHRoaXMuc3BlYWsoIHRoaXMuZ2V0VGVzdFN0cmluZ0ZvckxvY2FsZSggbG9jYWxlICksIHRoaXMudGVzdFZvaWNlVXR0ZXJhbmNlLCB2b2ljZVRvVGVzdCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3BlYWtzIHRoZSBwcm92aWRlZCBzdHJpbmcuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzcGVhayggc3RyaW5nOiBzdHJpbmcsIHV0dGVyYW5jZTogVXR0ZXJhbmNlLCB2b2ljZTogU3BlZWNoU3ludGhlc2lzVm9pY2UgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB2b2ljZSwgJ05vIHZvaWNlIHNldCBmb3Igdm9pY2VQcm9wZXJ0eTogJywgdm9pY2UgKTtcclxuXHJcbiAgICAvLyBTZXQgdGhlIHByb3ZpZGVkIHZvaWNlIGJlZm9yZSBzcGVha2luZy5cclxuICAgIHV0dGVyYW5jZS5hbm5vdW5jZXJPcHRpb25zLnZvaWNlID0gdm9pY2U7XHJcblxyXG4gICAgdXR0ZXJhbmNlLmFsZXJ0ID0gc3RyaW5nO1xyXG4gICAgdGhpcy5hZGRUb0JhY2soIHV0dGVyYW5jZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIHRlc3Qgc3RyaW5nIGluIHRoZSBwcm92aWRlZCBsb2NhbGUuIElmIHRoZSBzdHJpbmcgaXNuJ3QgZm91bmQgaW4gdGhlIGRlc2lyZWQgbG9jYWxlLCB0aGUgZW5nbGlzaCB2ZXJzaW9uXHJcbiAgICogb2YgdGhlIHN0cmluZyBpcyByZXR1cm5lZCBpbnN0ZWFkLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VGVzdFN0cmluZ0ZvckxvY2FsZSggbG9jYWxlOiBMb2NhbGUgKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHN0cmluZ3MgPSBwaGV0LmNoaXBwZXIuc3RyaW5ncztcclxuICAgIGNvbnN0IHRyYW5zbGF0ZWRTdHJpbmdzID0gc3RyaW5nc1sgbG9jYWxlIF07XHJcbiAgICBjb25zdCBiYWNrdXBTdHJpbmdzID0gc3RyaW5ncy5lbjtcclxuXHJcbiAgICBjb25zdCB0ZXN0U3RyaW5nID0gdHJhbnNsYXRlZFN0cmluZ3MgJiYgdHJhbnNsYXRlZFN0cmluZ3NbIE9ORV9UV09fVEhSRUVfU1RSSU5HX0tFWSBdID9cclxuICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVkU3RyaW5nc1sgT05FX1RXT19USFJFRV9TVFJJTkdfS0VZIF0gOiBiYWNrdXBTdHJpbmdzWyBPTkVfVFdPX1RIUkVFX1NUUklOR19LRVkgXTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0ZXN0U3RyaW5nLCBgTm8gdGVzdCBzdHJpbmcgZm91bmQgZm9yIGxvY2FsZXMgJHtsb2NhbGV9IG9yIGVuLmAgKTtcclxuXHJcbiAgICByZXR1cm4gdGVzdFN0cmluZztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaXRpYWxpemVzIHRoaXMgVXR0ZXJhbmNlUXVldWUgYnkgcHJvdmlkaW5nIHNwZWVjaERhdGFQcm9wZXJ0eSB0byB1c2UgZm9yIHNwZWFraW5nLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBpbml0aWFsaXplTnVtYmVyU3VpdGVDb21tb25VdHRlcmFuY2VRdWV1ZSggc3BlZWNoRGF0YVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmcgfCBudWxsPiApOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLmluaXRpYWxpemVkLCAnVHJpZWQgdG8gaW5pdGlhbGl6ZSBOdW1iZXJTdWl0ZUNvbW1vblV0dGVyYW5jZVF1ZXVlIG1vcmUgdGhhbiBvbmNlLicgKTtcclxuXHJcbiAgICB0aGlzLnNwZWVjaERhdGFQcm9wZXJ0eSA9IHNwZWVjaERhdGFQcm9wZXJ0eTtcclxuXHJcbiAgICAvLyBTcGVhayB0aGUgc3BlZWNoRGF0YSBpZiBhdXRvSGVhciBpcyB0dXJuZWQgb24gb3IgdGhlIHNwZWVjaERhdGEgY2hhbmdlcy4gQWxzbyBjaGVjayB0aGF0IHRoZSBhbm5vdW5jZXIgaGFzIGFcclxuICAgIC8vIHZvaWNlIGJlY2F1c2UgZXZlbiBpZiB0aGUgdm9pY2VQcm9wZXJ0eSBpcyBzZXQgdG8gbnVsbCwgdGhlIGJyb3dzZXIgc3RpbGwgc3BlYWtzIHdpdGggYSBkZWZhdWx0IHZvaWNlLlxyXG4gICAgTXVsdGlsaW5rLmxhenlNdWx0aWxpbmsoIFtcclxuICAgICAgICB0aGlzLmF1dG9IZWFyRW5hYmxlZFByb3BlcnR5LCB0aGlzLnNwZWVjaERhdGFQcm9wZXJ0eVxyXG4gICAgICBdLCBhdXRvSGVhckVuYWJsZWQgPT4gYXV0b0hlYXJFbmFibGVkICYmIHRoaXMuc3BlYWtTcGVlY2hEYXRhKClcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XHJcbiAgfVxyXG59XHJcblxyXG5udW1iZXJTdWl0ZUNvbW1vbi5yZWdpc3RlciggJ051bWJlclN1aXRlQ29tbW9uVXR0ZXJhbmNlUXVldWUnLCBOdW1iZXJTdWl0ZUNvbW1vblV0dGVyYW5jZVF1ZXVlICk7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLGNBQWMsTUFBTSxrREFBa0Q7QUFFN0UsT0FBT0MsaUJBQWlCLE1BQU0sNEJBQTRCO0FBQzFELE9BQU9DLFNBQVMsTUFBTSw2Q0FBNkM7QUFFbkUsT0FBT0MsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQywwQkFBMEIsTUFBTSxrQ0FBa0M7QUFDekUsT0FBT0Msd0JBQXdCLE1BQU0sbUNBQW1DOztBQUV4RTtBQUNBLE1BQU1DLHdCQUF3QixHQUFJLEdBQUVGLDBCQUEwQixDQUFDRyx1Q0FBd0MsY0FBYTs7QUFFcEg7QUFDQTtBQUNBO0FBQ0FGLHdCQUF3QixDQUFDRyx5QkFBeUI7QUFFbEQsZUFBZSxNQUFlQywrQkFBK0IsU0FBU1QsY0FBYyxDQUE0QztFQUU5SDs7RUFHQTtFQUNRVSxXQUFXLEdBQUcsS0FBSzs7RUFFM0I7RUFDaUJDLG1CQUFtQixHQUFHLElBQUlULFNBQVMsQ0FBQyxDQUFDOztFQUV0RDtFQUNpQlUsa0JBQWtCLEdBQUcsSUFBSVYsU0FBUyxDQUFDLENBQUM7O0VBRXJEOztFQU1VVyxXQUFXQSxDQUFFQywwQkFBcUUsRUFD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