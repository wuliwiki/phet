// Copyright 2019-2023, University of Colorado Boulder

/**
 * A ten frame node that can be dragged around and hold countingObjects.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 */

import ReturnButton from '../../../../scenery-phet/js/buttons/ReturnButton.js';
import { DragListener, Node } from '../../../../scenery/js/imports.js';
import TenFrameNode from '../../common/view/TenFrameNode.js';
import numberSuiteCommon from '../../numberSuiteCommon.js';
import TenFrame from '../model/TenFrame.js';
const RETURN_BUTTON_MARGIN = 5;
class DraggableTenFrameNode extends Node {
  constructor(tenFrame, selectedTenFrameProperty, dragBoundsProperty, options) {
    super();
    this.tenFrame = tenFrame;
    const tenFrameNode = TenFrameNode.getTenFramePath({
      sideLength: TenFrame.SQUARE_SIDE_LENGTH
    });
    this.addChild(tenFrameNode);
    const returnButton = new ReturnButton(() => {
      tenFrame.removeCountingObject();
    }, {
      visible: false
    });

    // expand touchArea of returnButton and shift so it doesn't overlap with the tenFrame
    returnButton.touchArea = returnButton.localBounds.dilatedY(RETURN_BUTTON_MARGIN * 2).dilatedX(RETURN_BUTTON_MARGIN * 1.5).shiftX(-RETURN_BUTTON_MARGIN * 0.5);
    returnButton.x = tenFrameNode.left - returnButton.width - 5;
    this.addChild(returnButton);

    // It was decided to always constrain the tenFrame's drag bounds by the potential space that the return button could have, see https://github.com/phetsims/number-compare/issues/29
    const constrainBoundsForReturnButton = dragBounds => {
      return dragBounds.withOffsets(-returnButton.width - RETURN_BUTTON_MARGIN, 0, 0, 0);
    };
    this.dragListener = new DragListener({
      start: () => {
        selectedTenFrameProperty.value = tenFrame;
      },
      drag: (event, listener) => {
        // Constrain position in a way that always leaves room for the return button on the left side of the ten frame, see https://github.com/phetsims/number-compare/issues/29
        tenFrame.setConstrainedDestination(constrainBoundsForReturnButton(dragBoundsProperty.value), listener.parentPoint);
      },
      end: () => {
        options.dropListener(this);
      }
    });
    this.addInputListener(this.dragListener);
    this.cursor = 'pointer';
    tenFrame.positionProperty.link(position => {
      this.translation = position;
    });
    tenFrame.scaleProperty.link(scale => this.setScaleMagnitude(scale));
    const dragBoundsListener = dragBounds => {
      tenFrame.setConstrainedDestination(constrainBoundsForReturnButton(dragBounds), tenFrame.positionProperty.value);
    };
    dragBoundsProperty.link(dragBoundsListener);
    tenFrame.countingObjects.addItemAddedListener(countingObject => {
      const countingObjectNode = options.getCountingObjectNode(countingObject);

      // make the countingObjectNode pickable:false instead of inputEnabled:false because we still want to be able to
      // drag this tenFrameNode that the countingObjectNode is on top of
      countingObjectNode.pickable = false;

      // animate the countingObject to the next available space in the tenFrame
      countingObject.setDestination(tenFrame.getCountingObjectSpot(countingObject), true);

      // make the tenFrame selected so the user knows they can remove the newly added countingObject
      selectedTenFrameProperty.value = tenFrame;
    });
    tenFrame.countingObjects.addItemRemovedListener(countingObject => {
      options.removeCountingObjectListener(countingObject);

      // If the last countingObject was removed, hide the returnButton.
      if (tenFrame.countingObjects.lengthProperty.value === 0) {
        returnButton.visible = false;
      }
    });

    // Management for when this tenFrame becomes selected. Requires disposal as it is storing references that point
    // outside DraggableTenFrameNode and TenFrame.
    const selectedTenFramePropertyListener = selectedTenFrame => {
      const thisTenFrameIsSelected = selectedTenFrame === tenFrame;

      // Show the returnButton if this is the selected tenFrame and if there's at least one countingObject contained
      // in the tenFrame.
      returnButton.visible = thisTenFrameIsSelected && tenFrame.countingObjects.lengthProperty.value > 0;

      // Whenever we are selected, move ourselves and any countingObjects we contain to front.
      if (thisTenFrameIsSelected) {
        this.moveToFront();
        tenFrame.countingObjects.forEach(countingObject => {
          const countingObjectNode = options.getCountingObjectNode(countingObject);
          countingObjectNode.moveToFront();
        });
      }
    };
    selectedTenFrameProperty.link(selectedTenFramePropertyListener);
    this.disposeDraggableTenFrameNode = () => {
      selectedTenFrameProperty.unlink(selectedTenFramePropertyListener);
      dragBoundsProperty.unlink(dragBoundsListener);
    };
  }
  dispose() {
    this.disposeDraggableTenFrameNode();
    super.dispose();
  }
}
numberSuiteCommon.register('DraggableTenFrameNode', DraggableTenFrameNode);
export default DraggableTenFrameNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSZXR1cm5CdXR0b24iLCJEcmFnTGlzdGVuZXIiLCJOb2RlIiwiVGVuRnJhbWVOb2RlIiwibnVtYmVyU3VpdGVDb21tb24iLCJUZW5GcmFtZSIsIlJFVFVSTl9CVVRUT05fTUFSR0lOIiwiRHJhZ2dhYmxlVGVuRnJhbWVOb2RlIiwiY29uc3RydWN0b3IiLCJ0ZW5GcmFtZSIsInNlbGVjdGVkVGVuRnJhbWVQcm9wZXJ0eSIsImRyYWdCb3VuZHNQcm9wZXJ0eSIsIm9wdGlvbnMiLCJ0ZW5GcmFtZU5vZGUiLCJnZXRUZW5GcmFtZVBhdGgiLCJzaWRlTGVuZ3RoIiwiU1FVQVJFX1NJREVfTEVOR1RIIiwiYWRkQ2hpbGQiLCJyZXR1cm5CdXR0b24iLCJyZW1vdmVDb3VudGluZ09iamVjdCIsInZpc2libGUiLCJ0b3VjaEFyZWEiLCJsb2NhbEJvdW5kcyIsImRpbGF0ZWRZIiwiZGlsYXRlZFgiLCJzaGlmdFgiLCJ4IiwibGVmdCIsIndpZHRoIiwiY29uc3RyYWluQm91bmRzRm9yUmV0dXJuQnV0dG9uIiwiZHJhZ0JvdW5kcyIsIndpdGhPZmZzZXRzIiwiZHJhZ0xpc3RlbmVyIiwic3RhcnQiLCJ2YWx1ZSIsImRyYWciLCJldmVudCIsImxpc3RlbmVyIiwic2V0Q29uc3RyYWluZWREZXN0aW5hdGlvbiIsInBhcmVudFBvaW50IiwiZW5kIiwiZHJvcExpc3RlbmVyIiwiYWRkSW5wdXRMaXN0ZW5lciIsImN1cnNvciIsInBvc2l0aW9uUHJvcGVydHkiLCJsaW5rIiwicG9zaXRpb24iLCJ0cmFuc2xhdGlvbiIsInNjYWxlUHJvcGVydHkiLCJzY2FsZSIsInNldFNjYWxlTWFnbml0dWRlIiwiZHJhZ0JvdW5kc0xpc3RlbmVyIiwiY291bnRpbmdPYmplY3RzIiwiYWRkSXRlbUFkZGVkTGlzdGVuZXIiLCJjb3VudGluZ09iamVjdCIsImNvdW50aW5nT2JqZWN0Tm9kZSIsImdldENvdW50aW5nT2JqZWN0Tm9kZSIsInBpY2thYmxlIiwic2V0RGVzdGluYXRpb24iLCJnZXRDb3VudGluZ09iamVjdFNwb3QiLCJhZGRJdGVtUmVtb3ZlZExpc3RlbmVyIiwicmVtb3ZlQ291bnRpbmdPYmplY3RMaXN0ZW5lciIsImxlbmd0aFByb3BlcnR5Iiwic2VsZWN0ZWRUZW5GcmFtZVByb3BlcnR5TGlzdGVuZXIiLCJzZWxlY3RlZFRlbkZyYW1lIiwidGhpc1RlbkZyYW1lSXNTZWxlY3RlZCIsIm1vdmVUb0Zyb250IiwiZm9yRWFjaCIsImRpc3Bvc2VEcmFnZ2FibGVUZW5GcmFtZU5vZGUiLCJ1bmxpbmsiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJEcmFnZ2FibGVUZW5GcmFtZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSB0ZW4gZnJhbWUgbm9kZSB0aGF0IGNhbiBiZSBkcmFnZ2VkIGFyb3VuZCBhbmQgaG9sZCBjb3VudGluZ09iamVjdHMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgS2x1c2VuZG9yZiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgVFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5LCB7IFByb3BlcnR5TGlua0xpc3RlbmVyIH0gZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBDb3VudGluZ09iamVjdCBmcm9tICcuLi8uLi8uLi8uLi9jb3VudGluZy1jb21tb24vanMvY29tbW9uL21vZGVsL0NvdW50aW5nT2JqZWN0LmpzJztcclxuaW1wb3J0IENvdW50aW5nT2JqZWN0Tm9kZSBmcm9tICcuLi8uLi8uLi8uLi9jb3VudGluZy1jb21tb24vanMvY29tbW9uL3ZpZXcvQ291bnRpbmdPYmplY3ROb2RlLmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgUmV0dXJuQnV0dG9uIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9idXR0b25zL1JldHVybkJ1dHRvbi5qcyc7XHJcbmltcG9ydCB7IERyYWdMaXN0ZW5lciwgTm9kZSwgUHJlc3NMaXN0ZW5lckV2ZW50IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFRlbkZyYW1lTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9UZW5GcmFtZU5vZGUuanMnO1xyXG5pbXBvcnQgbnVtYmVyU3VpdGVDb21tb24gZnJvbSAnLi4vLi4vbnVtYmVyU3VpdGVDb21tb24uanMnO1xyXG5pbXBvcnQgVGVuRnJhbWUgZnJvbSAnLi4vbW9kZWwvVGVuRnJhbWUuanMnO1xyXG5cclxuY29uc3QgUkVUVVJOX0JVVFRPTl9NQVJHSU4gPSA1O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICBkcm9wTGlzdGVuZXI6ICggdGVuRnJhbWVOb2RlOiBEcmFnZ2FibGVUZW5GcmFtZU5vZGUgKSA9PiB2b2lkO1xyXG4gIHJlbW92ZUNvdW50aW5nT2JqZWN0TGlzdGVuZXI6ICggY291bnRpbmdPYmplY3Q6IENvdW50aW5nT2JqZWN0ICkgPT4gdm9pZDtcclxuICBnZXRDb3VudGluZ09iamVjdE5vZGU6ICggY291bnRpbmdPYmplY3Q6IENvdW50aW5nT2JqZWN0ICkgPT4gQ291bnRpbmdPYmplY3ROb2RlO1xyXG59O1xyXG50eXBlIERyYWdnYWJsZVRlbkZyYW1lTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucztcclxuXHJcbmNsYXNzIERyYWdnYWJsZVRlbkZyYW1lTm9kZSBleHRlbmRzIE5vZGUge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zZURyYWdnYWJsZVRlbkZyYW1lTm9kZTogKCkgPT4gdm9pZDtcclxuICBwdWJsaWMgcmVhZG9ubHkgdGVuRnJhbWU6IFRlbkZyYW1lO1xyXG4gIHB1YmxpYyByZWFkb25seSBkcmFnTGlzdGVuZXI6IERyYWdMaXN0ZW5lcjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB0ZW5GcmFtZTogVGVuRnJhbWUsIHNlbGVjdGVkVGVuRnJhbWVQcm9wZXJ0eTogVFByb3BlcnR5PFRlbkZyYW1lIHwgbnVsbD4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBkcmFnQm91bmRzUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEJvdW5kczI+LCBvcHRpb25zOiBEcmFnZ2FibGVUZW5GcmFtZU5vZGVPcHRpb25zICkge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLnRlbkZyYW1lID0gdGVuRnJhbWU7XHJcblxyXG4gICAgY29uc3QgdGVuRnJhbWVOb2RlID0gVGVuRnJhbWVOb2RlLmdldFRlbkZyYW1lUGF0aCgge1xyXG4gICAgICBzaWRlTGVuZ3RoOiBUZW5GcmFtZS5TUVVBUkVfU0lERV9MRU5HVEhcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHRlbkZyYW1lTm9kZSApO1xyXG5cclxuICAgIGNvbnN0IHJldHVybkJ1dHRvbiA9IG5ldyBSZXR1cm5CdXR0b24oICgpID0+IHtcclxuICAgICAgdGVuRnJhbWUucmVtb3ZlQ291bnRpbmdPYmplY3QoKTtcclxuICAgIH0sIHtcclxuICAgICAgdmlzaWJsZTogZmFsc2VcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBleHBhbmQgdG91Y2hBcmVhIG9mIHJldHVybkJ1dHRvbiBhbmQgc2hpZnQgc28gaXQgZG9lc24ndCBvdmVybGFwIHdpdGggdGhlIHRlbkZyYW1lXHJcbiAgICByZXR1cm5CdXR0b24udG91Y2hBcmVhID0gcmV0dXJuQnV0dG9uLmxvY2FsQm91bmRzXHJcbiAgICAgIC5kaWxhdGVkWSggUkVUVVJOX0JVVFRPTl9NQVJHSU4gKiAyICkuZGlsYXRlZFgoIFJFVFVSTl9CVVRUT05fTUFSR0lOICogMS41ICkuc2hpZnRYKCAtUkVUVVJOX0JVVFRPTl9NQVJHSU4gKiAwLjUgKTtcclxuICAgIHJldHVybkJ1dHRvbi54ID0gdGVuRnJhbWVOb2RlLmxlZnQgLSByZXR1cm5CdXR0b24ud2lkdGggLSA1O1xyXG4gICAgdGhpcy5hZGRDaGlsZCggcmV0dXJuQnV0dG9uICk7XHJcblxyXG4gICAgLy8gSXQgd2FzIGRlY2lkZWQgdG8gYWx3YXlzIGNvbnN0cmFpbiB0aGUgdGVuRnJhbWUncyBkcmFnIGJvdW5kcyBieSB0aGUgcG90ZW50aWFsIHNwYWNlIHRoYXQgdGhlIHJldHVybiBidXR0b24gY291bGQgaGF2ZSwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9udW1iZXItY29tcGFyZS9pc3N1ZXMvMjlcclxuICAgIGNvbnN0IGNvbnN0cmFpbkJvdW5kc0ZvclJldHVybkJ1dHRvbiA9ICggZHJhZ0JvdW5kczogQm91bmRzMiApOiBCb3VuZHMyID0+IHtcclxuICAgICAgcmV0dXJuIGRyYWdCb3VuZHMud2l0aE9mZnNldHMoIC1yZXR1cm5CdXR0b24ud2lkdGggLSBSRVRVUk5fQlVUVE9OX01BUkdJTiwgMCwgMCwgMCApO1xyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLmRyYWdMaXN0ZW5lciA9IG5ldyBEcmFnTGlzdGVuZXIoIHtcclxuICAgICAgc3RhcnQ6ICgpID0+IHtcclxuICAgICAgICBzZWxlY3RlZFRlbkZyYW1lUHJvcGVydHkudmFsdWUgPSB0ZW5GcmFtZTtcclxuICAgICAgfSxcclxuICAgICAgZHJhZzogKCBldmVudDogUHJlc3NMaXN0ZW5lckV2ZW50LCBsaXN0ZW5lcjogRHJhZ0xpc3RlbmVyICkgPT4ge1xyXG5cclxuICAgICAgICAvLyBDb25zdHJhaW4gcG9zaXRpb24gaW4gYSB3YXkgdGhhdCBhbHdheXMgbGVhdmVzIHJvb20gZm9yIHRoZSByZXR1cm4gYnV0dG9uIG9uIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIHRlbiBmcmFtZSwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9udW1iZXItY29tcGFyZS9pc3N1ZXMvMjlcclxuICAgICAgICB0ZW5GcmFtZS5zZXRDb25zdHJhaW5lZERlc3RpbmF0aW9uKCBjb25zdHJhaW5Cb3VuZHNGb3JSZXR1cm5CdXR0b24oIGRyYWdCb3VuZHNQcm9wZXJ0eS52YWx1ZSApLCBsaXN0ZW5lci5wYXJlbnRQb2ludCApO1xyXG4gICAgICB9LFxyXG4gICAgICBlbmQ6ICgpID0+IHtcclxuICAgICAgICBvcHRpb25zLmRyb3BMaXN0ZW5lciggdGhpcyApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIHRoaXMuZHJhZ0xpc3RlbmVyICk7XHJcblxyXG4gICAgdGhpcy5jdXJzb3IgPSAncG9pbnRlcic7XHJcblxyXG4gICAgdGVuRnJhbWUucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBwb3NpdGlvbiA9PiB7IHRoaXMudHJhbnNsYXRpb24gPSBwb3NpdGlvbjsgfSApO1xyXG4gICAgdGVuRnJhbWUuc2NhbGVQcm9wZXJ0eS5saW5rKCBzY2FsZSA9PiB0aGlzLnNldFNjYWxlTWFnbml0dWRlKCBzY2FsZSApICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ0JvdW5kc0xpc3RlbmVyOiBQcm9wZXJ0eUxpbmtMaXN0ZW5lcjxCb3VuZHMyPiA9IGRyYWdCb3VuZHMgPT4ge1xyXG4gICAgICB0ZW5GcmFtZS5zZXRDb25zdHJhaW5lZERlc3RpbmF0aW9uKCBjb25zdHJhaW5Cb3VuZHNGb3JSZXR1cm5CdXR0b24oIGRyYWdCb3VuZHMgKSwgdGVuRnJhbWUucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgfTtcclxuICAgIGRyYWdCb3VuZHNQcm9wZXJ0eS5saW5rKCBkcmFnQm91bmRzTGlzdGVuZXIgKTtcclxuXHJcbiAgICB0ZW5GcmFtZS5jb3VudGluZ09iamVjdHMuYWRkSXRlbUFkZGVkTGlzdGVuZXIoIGNvdW50aW5nT2JqZWN0ID0+IHtcclxuICAgICAgY29uc3QgY291bnRpbmdPYmplY3ROb2RlID0gb3B0aW9ucy5nZXRDb3VudGluZ09iamVjdE5vZGUoIGNvdW50aW5nT2JqZWN0ICk7XHJcblxyXG4gICAgICAvLyBtYWtlIHRoZSBjb3VudGluZ09iamVjdE5vZGUgcGlja2FibGU6ZmFsc2UgaW5zdGVhZCBvZiBpbnB1dEVuYWJsZWQ6ZmFsc2UgYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvIGJlIGFibGUgdG9cclxuICAgICAgLy8gZHJhZyB0aGlzIHRlbkZyYW1lTm9kZSB0aGF0IHRoZSBjb3VudGluZ09iamVjdE5vZGUgaXMgb24gdG9wIG9mXHJcbiAgICAgIGNvdW50aW5nT2JqZWN0Tm9kZS5waWNrYWJsZSA9IGZhbHNlO1xyXG5cclxuICAgICAgLy8gYW5pbWF0ZSB0aGUgY291bnRpbmdPYmplY3QgdG8gdGhlIG5leHQgYXZhaWxhYmxlIHNwYWNlIGluIHRoZSB0ZW5GcmFtZVxyXG4gICAgICBjb3VudGluZ09iamVjdC5zZXREZXN0aW5hdGlvbiggdGVuRnJhbWUuZ2V0Q291bnRpbmdPYmplY3RTcG90KCBjb3VudGluZ09iamVjdCApLCB0cnVlICk7XHJcblxyXG4gICAgICAvLyBtYWtlIHRoZSB0ZW5GcmFtZSBzZWxlY3RlZCBzbyB0aGUgdXNlciBrbm93cyB0aGV5IGNhbiByZW1vdmUgdGhlIG5ld2x5IGFkZGVkIGNvdW50aW5nT2JqZWN0XHJcbiAgICAgIHNlbGVjdGVkVGVuRnJhbWVQcm9wZXJ0eS52YWx1ZSA9IHRlbkZyYW1lO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRlbkZyYW1lLmNvdW50aW5nT2JqZWN0cy5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCBjb3VudGluZ09iamVjdCA9PiB7XHJcbiAgICAgIG9wdGlvbnMucmVtb3ZlQ291bnRpbmdPYmplY3RMaXN0ZW5lciggY291bnRpbmdPYmplY3QgKTtcclxuXHJcbiAgICAgIC8vIElmIHRoZSBsYXN0IGNvdW50aW5nT2JqZWN0IHdhcyByZW1vdmVkLCBoaWRlIHRoZSByZXR1cm5CdXR0b24uXHJcbiAgICAgIGlmICggdGVuRnJhbWUuY291bnRpbmdPYmplY3RzLmxlbmd0aFByb3BlcnR5LnZhbHVlID09PSAwICkge1xyXG4gICAgICAgIHJldHVybkJ1dHRvbi52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBNYW5hZ2VtZW50IGZvciB3aGVuIHRoaXMgdGVuRnJhbWUgYmVjb21lcyBzZWxlY3RlZC4gUmVxdWlyZXMgZGlzcG9zYWwgYXMgaXQgaXMgc3RvcmluZyByZWZlcmVuY2VzIHRoYXQgcG9pbnRcclxuICAgIC8vIG91dHNpZGUgRHJhZ2dhYmxlVGVuRnJhbWVOb2RlIGFuZCBUZW5GcmFtZS5cclxuICAgIGNvbnN0IHNlbGVjdGVkVGVuRnJhbWVQcm9wZXJ0eUxpc3RlbmVyID0gKCBzZWxlY3RlZFRlbkZyYW1lOiBUZW5GcmFtZSB8IG51bGwgKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRoaXNUZW5GcmFtZUlzU2VsZWN0ZWQgPSBzZWxlY3RlZFRlbkZyYW1lID09PSB0ZW5GcmFtZTtcclxuXHJcbiAgICAgIC8vIFNob3cgdGhlIHJldHVybkJ1dHRvbiBpZiB0aGlzIGlzIHRoZSBzZWxlY3RlZCB0ZW5GcmFtZSBhbmQgaWYgdGhlcmUncyBhdCBsZWFzdCBvbmUgY291bnRpbmdPYmplY3QgY29udGFpbmVkXHJcbiAgICAgIC8vIGluIHRoZSB0ZW5GcmFtZS5cclxuICAgICAgcmV0dXJuQnV0dG9uLnZpc2libGUgPSB0aGlzVGVuRnJhbWVJc1NlbGVjdGVkICYmIHRlbkZyYW1lLmNvdW50aW5nT2JqZWN0cy5sZW5ndGhQcm9wZXJ0eS52YWx1ZSA+IDA7XHJcblxyXG4gICAgICAvLyBXaGVuZXZlciB3ZSBhcmUgc2VsZWN0ZWQsIG1vdmUgb3Vyc2VsdmVzIGFuZCBhbnkgY291bnRpbmdPYmplY3RzIHdlIGNvbnRhaW4gdG8gZnJvbnQuXHJcbiAgICAgIGlmICggdGhpc1RlbkZyYW1lSXNTZWxlY3RlZCApIHtcclxuICAgICAgICB0aGlzLm1vdmVUb0Zyb250KCk7XHJcbiAgICAgICAgdGVuRnJhbWUuY291bnRpbmdPYmplY3RzLmZvckVhY2goIGNvdW50aW5nT2JqZWN0ID0+IHtcclxuICAgICAgICAgIGNvbnN0IGNvdW50aW5nT2JqZWN0Tm9kZSA9IG9wdGlvbnMuZ2V0Q291bnRpbmdPYmplY3ROb2RlKCBjb3VudGluZ09iamVjdCApO1xyXG4gICAgICAgICAgY291bnRpbmdPYmplY3ROb2RlLm1vdmVUb0Zyb250KCk7XHJcbiAgICAgICAgfSApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgc2VsZWN0ZWRUZW5GcmFtZVByb3BlcnR5LmxpbmsoIHNlbGVjdGVkVGVuRnJhbWVQcm9wZXJ0eUxpc3RlbmVyICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlRHJhZ2dhYmxlVGVuRnJhbWVOb2RlID0gKCkgPT4ge1xyXG4gICAgICBzZWxlY3RlZFRlbkZyYW1lUHJvcGVydHkudW5saW5rKCBzZWxlY3RlZFRlbkZyYW1lUHJvcGVydHlMaXN0ZW5lciApO1xyXG4gICAgICBkcmFnQm91bmRzUHJvcGVydHkudW5saW5rKCBkcmFnQm91bmRzTGlzdGVuZXIgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZURyYWdnYWJsZVRlbkZyYW1lTm9kZSgpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxubnVtYmVyU3VpdGVDb21tb24ucmVnaXN0ZXIoICdEcmFnZ2FibGVUZW5GcmFtZU5vZGUnLCBEcmFnZ2FibGVUZW5GcmFtZU5vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgRHJhZ2dhYmxlVGVuRnJhbWVOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFPQSxPQUFPQSxZQUFZLE1BQU0scURBQXFEO0FBQzlFLFNBQVNDLFlBQVksRUFBRUMsSUFBSSxRQUE0QixtQ0FBbUM7QUFDMUYsT0FBT0MsWUFBWSxNQUFNLG1DQUFtQztBQUM1RCxPQUFPQyxp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