// Copyright 2015-2022, University of Colorado Boulder

/**
 * EquationAccordionBox is the accordion box that shows the equation of the curve on the graph.
 * It displays 'undefined' if the curve is undefined.
 *
 * @author Andrey Zelenkov (Mlearner)
 * @author Saurabh Totey
 */

import Emitter from '../../../../axon/js/Emitter.js';
import Utils from '../../../../dot/js/Utils.js';
import merge from '../../../../phet-core/js/merge.js';
import MathSymbols from '../../../../scenery-phet/js/MathSymbols.js';
import { HBox, Text, VStrut } from '../../../../scenery/js/imports.js';
import ExpandCollapseButton from '../../../../sun/js/ExpandCollapseButton.js';
import Panel from '../../../../sun/js/Panel.js';
import curveFitting from '../../curveFitting.js';
import CurveFittingStrings from '../../CurveFittingStrings.js';
import CurveFittingConstants from '../CurveFittingConstants.js';
import EquationNode from './EquationNode.js';
const equationString = CurveFittingStrings.equation;
const undefinedString = CurveFittingStrings.undefined;

// max number of digits for coefficients in ascending order of polynomials
const MAX_DIGITS = [2, 3, 4, 4];
class EquationAccordionBox extends Panel {
  /**
   * @param {Curve} curve
   * @param {Property.<number>} orderProperty - order of the polynomial:(1,2,3)
   * @param {Property.<boolean>} equationPanelExpandedProperty
   * @param {Property.<boolean>} curveVisibleProperty
   * @param {Object} [options] for slider node.
   */
  constructor(curve, orderProperty, equationPanelExpandedProperty, curveVisibleProperty, options) {
    options = merge({
      equationNodeMaxWidth: 250,
      fill: 'white',
      opacity: 0.8,
      cornerRadius: CurveFittingConstants.PANEL_CORNER_RADIUS,
      xMargin: CurveFittingConstants.PANEL_MARGIN,
      yMargin: CurveFittingConstants.PANEL_MARGIN
    }, options);

    // visible text node when panel is not expanded
    const titleNode = new Text(equationString, {
      font: CurveFittingConstants.ACCORDION_BOX_TITLE_FONT,
      maxWidth: options.equationNodeMaxWidth
    });

    // create expand button
    const expandCollapseButton = new ExpandCollapseButton(equationPanelExpandedProperty, {
      sideLength: 16
    });
    expandCollapseButton.touchArea = expandCollapseButton.localBounds.dilated(expandCollapseButton.width / 3);

    // visible node when panel is expanded
    const equationNode = new EquationNode(orderProperty, {
      coefficientSignTextOptions: {
        fill: CurveFittingConstants.BLUE_COLOR
      },
      maxWidth: options.equationNodeMaxWidth
    });

    // visible node when panel is expanded but there is no equation
    const undefinedEquationText = new Text(undefinedString, {
      font: CurveFittingConstants.ACCORDION_BOX_TITLE_FONT,
      maxWidth: options.equationNodeMaxWidth
    });

    // So that the panel's height doesn't change.
    const vStrut = new VStrut(equationNode.height);
    const content = new HBox({
      spacing: 8
    });
    super(content, options);

    // @public (read-only) is used by the screen view to bump out points from below; see #131
    this.expandCollapseButton = expandCollapseButton;

    // @public an emitter that is fired whenever this panel is updated: is used for background node for #126
    this.updatedEmitter = new Emitter();

    /**
     * This method rounds the given number to the given amount of digits
     * Rounds the number to the nearest whole number if the nearest whole number has as many or more digits than maxDigits
     * Returns an array of two strings: the first string is the number's sign, and the second string is the absolute number
     *
     * @param {number} number
     * @param {number} maxDigits
     * @returns {Array.<string>} - first string is number's sign, second string is number's absolute value
     */
    const getRoundedParameterStrings = (number, maxDigits) => {
      // number = mantissa times 10^(exponent) where the mantissa is between 1 and 10 (or -1 to -10)
      const exponent = Math.floor(Utils.log10(Math.abs(number)));
      let decimalPlaces;
      if (exponent >= maxDigits) {
        decimalPlaces = 0;
      } else if (exponent > 0) {
        decimalPlaces = maxDigits - exponent - 1;
      } else {
        decimalPlaces = maxDigits - 1;
      }
      const roundedNumber = Utils.toFixedNumber(number, decimalPlaces);
      const signToString = roundedNumber >= 0 ? MathSymbols.PLUS : MathSymbols.MINUS; // N.B.
      const absoluteNumberToString = Utils.toFixed(Math.abs(number), decimalPlaces); // N.B.

      return [signToString, absoluteNumberToString];
    };

    /**
     * updates all the coefficients and panel content
     */
    const updateContent = () => {
      this.visible = curveVisibleProperty.value;
      const coefficientStrings = _.flatMap(curve.coefficients, (coefficient, index) => getRoundedParameterStrings(coefficient, MAX_DIGITS[index]));
      equationNode.setCoefficients(coefficientStrings);
      const children = [expandCollapseButton];
      if (equationPanelExpandedProperty.value) {
        children.push(curve.isCurvePresent() ? equationNode : undefinedEquationText);
      } else {
        children.push(titleNode);
      }
      children.push(vStrut);
      content.children = children;
      this.updatedEmitter.emit();
    };

    // add observers which don't need to be disposed because this is present for the lifetime of the simulation
    curveVisibleProperty.link(updateContent);
    equationPanelExpandedProperty.link(updateContent);
    curve.updateCurveEmitter.addListener(updateContent);
    orderProperty.link(updateContent);
  }
}
curveFitting.register('EquationAccordionBox', EquationAccordionBox);
export default EquationAccordionBox;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbWl0dGVyIiwiVXRpbHMiLCJtZXJnZSIsIk1hdGhTeW1ib2xzIiwiSEJveCIsIlRleHQiLCJWU3RydXQiLCJFeHBhbmRDb2xsYXBzZUJ1dHRvbiIsIlBhbmVsIiwiY3VydmVGaXR0aW5nIiwiQ3VydmVGaXR0aW5nU3RyaW5ncyIsIkN1cnZlRml0dGluZ0NvbnN0YW50cyIsIkVxdWF0aW9uTm9kZSIsImVxdWF0aW9uU3RyaW5nIiwiZXF1YXRpb24iLCJ1bmRlZmluZWRTdHJpbmciLCJ1bmRlZmluZWQiLCJNQVhfRElHSVRTIiwiRXF1YXRpb25BY2NvcmRpb25Cb3giLCJjb25zdHJ1Y3RvciIsImN1cnZlIiwib3JkZXJQcm9wZXJ0eSIsImVxdWF0aW9uUGFuZWxFeHBhbmRlZFByb3BlcnR5IiwiY3VydmVWaXNpYmxlUHJvcGVydHkiLCJvcHRpb25zIiwiZXF1YXRpb25Ob2RlTWF4V2lkdGgiLCJmaWxsIiwib3BhY2l0eSIsImNvcm5lclJhZGl1cyIsIlBBTkVMX0NPUk5FUl9SQURJVVMiLCJ4TWFyZ2luIiwiUEFORUxfTUFSR0lOIiwieU1hcmdpbiIsInRpdGxlTm9kZSIsImZvbnQiLCJBQ0NPUkRJT05fQk9YX1RJVExFX0ZPTlQiLCJtYXhXaWR0aCIsImV4cGFuZENvbGxhcHNlQnV0dG9uIiwic2lkZUxlbmd0aCIsInRvdWNoQXJlYSIsImxvY2FsQm91bmRzIiwiZGlsYXRlZCIsIndpZHRoIiwiZXF1YXRpb25Ob2RlIiwiY29lZmZpY2llbnRTaWduVGV4dE9wdGlvbnMiLCJCTFVFX0NPTE9SIiwidW5kZWZpbmVkRXF1YXRpb25UZXh0IiwidlN0cnV0IiwiaGVpZ2h0IiwiY29udGVudCIsInNwYWNpbmciLCJ1cGRhdGVkRW1pdHRlciIsImdldFJvdW5kZWRQYXJhbWV0ZXJTdHJpbmdzIiwibnVtYmVyIiwibWF4RGlnaXRzIiwiZXhwb25lbnQiLCJNYXRoIiwiZmxvb3IiLCJsb2cxMCIsImFicyIsImRlY2ltYWxQbGFjZXMiLCJyb3VuZGVkTnVtYmVyIiwidG9GaXhlZE51bWJlciIsInNpZ25Ub1N0cmluZyIsIlBMVVMiLCJNSU5VUyIsImFic29sdXRlTnVtYmVyVG9TdHJpbmciLCJ0b0ZpeGVkIiwidXBkYXRlQ29udGVudCIsInZpc2libGUiLCJ2YWx1ZSIsImNvZWZmaWNpZW50U3RyaW5ncyIsIl8iLCJmbGF0TWFwIiwiY29lZmZpY2llbnRzIiwiY29lZmZpY2llbnQiLCJpbmRleCIsInNldENvZWZmaWNpZW50cyIsImNoaWxkcmVuIiwicHVzaCIsImlzQ3VydmVQcmVzZW50IiwiZW1pdCIsImxpbmsiLCJ1cGRhdGVDdXJ2ZUVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRXF1YXRpb25BY2NvcmRpb25Cb3guanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTUtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRXF1YXRpb25BY2NvcmRpb25Cb3ggaXMgdGhlIGFjY29yZGlvbiBib3ggdGhhdCBzaG93cyB0aGUgZXF1YXRpb24gb2YgdGhlIGN1cnZlIG9uIHRoZSBncmFwaC5cclxuICogSXQgZGlzcGxheXMgJ3VuZGVmaW5lZCcgaWYgdGhlIGN1cnZlIGlzIHVuZGVmaW5lZC5cclxuICpcclxuICogQGF1dGhvciBBbmRyZXkgWmVsZW5rb3YgKE1sZWFybmVyKVxyXG4gKiBAYXV0aG9yIFNhdXJhYmggVG90ZXlcclxuICovXHJcblxyXG5pbXBvcnQgRW1pdHRlciBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VtaXR0ZXIuanMnO1xyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBNYXRoU3ltYm9scyBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvTWF0aFN5bWJvbHMuanMnO1xyXG5pbXBvcnQgeyBIQm94LCBUZXh0LCBWU3RydXQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgRXhwYW5kQ29sbGFwc2VCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc3VuL2pzL0V4cGFuZENvbGxhcHNlQnV0dG9uLmpzJztcclxuaW1wb3J0IFBhbmVsIGZyb20gJy4uLy4uLy4uLy4uL3N1bi9qcy9QYW5lbC5qcyc7XHJcbmltcG9ydCBjdXJ2ZUZpdHRpbmcgZnJvbSAnLi4vLi4vY3VydmVGaXR0aW5nLmpzJztcclxuaW1wb3J0IEN1cnZlRml0dGluZ1N0cmluZ3MgZnJvbSAnLi4vLi4vQ3VydmVGaXR0aW5nU3RyaW5ncy5qcyc7XHJcbmltcG9ydCBDdXJ2ZUZpdHRpbmdDb25zdGFudHMgZnJvbSAnLi4vQ3VydmVGaXR0aW5nQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IEVxdWF0aW9uTm9kZSBmcm9tICcuL0VxdWF0aW9uTm9kZS5qcyc7XHJcblxyXG5jb25zdCBlcXVhdGlvblN0cmluZyA9IEN1cnZlRml0dGluZ1N0cmluZ3MuZXF1YXRpb247XHJcbmNvbnN0IHVuZGVmaW5lZFN0cmluZyA9IEN1cnZlRml0dGluZ1N0cmluZ3MudW5kZWZpbmVkO1xyXG5cclxuLy8gbWF4IG51bWJlciBvZiBkaWdpdHMgZm9yIGNvZWZmaWNpZW50cyBpbiBhc2NlbmRpbmcgb3JkZXIgb2YgcG9seW5vbWlhbHNcclxuY29uc3QgTUFYX0RJR0lUUyA9IFsgMiwgMywgNCwgNCBdO1xyXG5cclxuY2xhc3MgRXF1YXRpb25BY2NvcmRpb25Cb3ggZXh0ZW5kcyBQYW5lbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7Q3VydmV9IGN1cnZlXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48bnVtYmVyPn0gb3JkZXJQcm9wZXJ0eSAtIG9yZGVyIG9mIHRoZSBwb2x5bm9taWFsOigxLDIsMylcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5Ljxib29sZWFuPn0gZXF1YXRpb25QYW5lbEV4cGFuZGVkUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5Ljxib29sZWFuPn0gY3VydmVWaXNpYmxlUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIGZvciBzbGlkZXIgbm9kZS5cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggY3VydmUsIG9yZGVyUHJvcGVydHksIGVxdWF0aW9uUGFuZWxFeHBhbmRlZFByb3BlcnR5LCBjdXJ2ZVZpc2libGVQcm9wZXJ0eSwgb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuICAgICAgZXF1YXRpb25Ob2RlTWF4V2lkdGg6IDI1MCxcclxuICAgICAgZmlsbDogJ3doaXRlJyxcclxuICAgICAgb3BhY2l0eTogMC44LFxyXG4gICAgICBjb3JuZXJSYWRpdXM6IEN1cnZlRml0dGluZ0NvbnN0YW50cy5QQU5FTF9DT1JORVJfUkFESVVTLFxyXG4gICAgICB4TWFyZ2luOiBDdXJ2ZUZpdHRpbmdDb25zdGFudHMuUEFORUxfTUFSR0lOLFxyXG4gICAgICB5TWFyZ2luOiBDdXJ2ZUZpdHRpbmdDb25zdGFudHMuUEFORUxfTUFSR0lOXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gdmlzaWJsZSB0ZXh0IG5vZGUgd2hlbiBwYW5lbCBpcyBub3QgZXhwYW5kZWRcclxuICAgIGNvbnN0IHRpdGxlTm9kZSA9IG5ldyBUZXh0KCBlcXVhdGlvblN0cmluZywge1xyXG4gICAgICBmb250OiBDdXJ2ZUZpdHRpbmdDb25zdGFudHMuQUNDT1JESU9OX0JPWF9USVRMRV9GT05ULFxyXG4gICAgICBtYXhXaWR0aDogb3B0aW9ucy5lcXVhdGlvbk5vZGVNYXhXaWR0aFxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGNyZWF0ZSBleHBhbmQgYnV0dG9uXHJcbiAgICBjb25zdCBleHBhbmRDb2xsYXBzZUJ1dHRvbiA9IG5ldyBFeHBhbmRDb2xsYXBzZUJ1dHRvbiggZXF1YXRpb25QYW5lbEV4cGFuZGVkUHJvcGVydHksIHtcclxuICAgICAgc2lkZUxlbmd0aDogMTZcclxuICAgIH0gKTtcclxuICAgIGV4cGFuZENvbGxhcHNlQnV0dG9uLnRvdWNoQXJlYSA9IGV4cGFuZENvbGxhcHNlQnV0dG9uLmxvY2FsQm91bmRzLmRpbGF0ZWQoIGV4cGFuZENvbGxhcHNlQnV0dG9uLndpZHRoIC8gMyApO1xyXG5cclxuICAgIC8vIHZpc2libGUgbm9kZSB3aGVuIHBhbmVsIGlzIGV4cGFuZGVkXHJcbiAgICBjb25zdCBlcXVhdGlvbk5vZGUgPSBuZXcgRXF1YXRpb25Ob2RlKCBvcmRlclByb3BlcnR5LCB7XHJcbiAgICAgIGNvZWZmaWNpZW50U2lnblRleHRPcHRpb25zOiB7XHJcbiAgICAgICAgZmlsbDogQ3VydmVGaXR0aW5nQ29uc3RhbnRzLkJMVUVfQ09MT1JcclxuICAgICAgfSxcclxuICAgICAgbWF4V2lkdGg6IG9wdGlvbnMuZXF1YXRpb25Ob2RlTWF4V2lkdGhcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyB2aXNpYmxlIG5vZGUgd2hlbiBwYW5lbCBpcyBleHBhbmRlZCBidXQgdGhlcmUgaXMgbm8gZXF1YXRpb25cclxuICAgIGNvbnN0IHVuZGVmaW5lZEVxdWF0aW9uVGV4dCA9IG5ldyBUZXh0KCB1bmRlZmluZWRTdHJpbmcsIHtcclxuICAgICAgZm9udDogQ3VydmVGaXR0aW5nQ29uc3RhbnRzLkFDQ09SRElPTl9CT1hfVElUTEVfRk9OVCxcclxuICAgICAgbWF4V2lkdGg6IG9wdGlvbnMuZXF1YXRpb25Ob2RlTWF4V2lkdGhcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBTbyB0aGF0IHRoZSBwYW5lbCdzIGhlaWdodCBkb2Vzbid0IGNoYW5nZS5cclxuICAgIGNvbnN0IHZTdHJ1dCA9IG5ldyBWU3RydXQoIGVxdWF0aW9uTm9kZS5oZWlnaHQgKTtcclxuXHJcbiAgICBjb25zdCBjb250ZW50ID0gbmV3IEhCb3goIHtcclxuICAgICAgc3BhY2luZzogOFxyXG4gICAgfSApO1xyXG5cclxuICAgIHN1cGVyKCBjb250ZW50LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSBpcyB1c2VkIGJ5IHRoZSBzY3JlZW4gdmlldyB0byBidW1wIG91dCBwb2ludHMgZnJvbSBiZWxvdzsgc2VlICMxMzFcclxuICAgIHRoaXMuZXhwYW5kQ29sbGFwc2VCdXR0b24gPSBleHBhbmRDb2xsYXBzZUJ1dHRvbjtcclxuXHJcbiAgICAvLyBAcHVibGljIGFuIGVtaXR0ZXIgdGhhdCBpcyBmaXJlZCB3aGVuZXZlciB0aGlzIHBhbmVsIGlzIHVwZGF0ZWQ6IGlzIHVzZWQgZm9yIGJhY2tncm91bmQgbm9kZSBmb3IgIzEyNlxyXG4gICAgdGhpcy51cGRhdGVkRW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGlzIG1ldGhvZCByb3VuZHMgdGhlIGdpdmVuIG51bWJlciB0byB0aGUgZ2l2ZW4gYW1vdW50IG9mIGRpZ2l0c1xyXG4gICAgICogUm91bmRzIHRoZSBudW1iZXIgdG8gdGhlIG5lYXJlc3Qgd2hvbGUgbnVtYmVyIGlmIHRoZSBuZWFyZXN0IHdob2xlIG51bWJlciBoYXMgYXMgbWFueSBvciBtb3JlIGRpZ2l0cyB0aGFuIG1heERpZ2l0c1xyXG4gICAgICogUmV0dXJucyBhbiBhcnJheSBvZiB0d28gc3RyaW5nczogdGhlIGZpcnN0IHN0cmluZyBpcyB0aGUgbnVtYmVyJ3Mgc2lnbiwgYW5kIHRoZSBzZWNvbmQgc3RyaW5nIGlzIHRoZSBhYnNvbHV0ZSBudW1iZXJcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4RGlnaXRzXHJcbiAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IC0gZmlyc3Qgc3RyaW5nIGlzIG51bWJlcidzIHNpZ24sIHNlY29uZCBzdHJpbmcgaXMgbnVtYmVyJ3MgYWJzb2x1dGUgdmFsdWVcclxuICAgICAqL1xyXG4gICAgY29uc3QgZ2V0Um91bmRlZFBhcmFtZXRlclN0cmluZ3MgPSAoIG51bWJlciwgbWF4RGlnaXRzICkgPT4ge1xyXG5cclxuICAgICAgLy8gbnVtYmVyID0gbWFudGlzc2EgdGltZXMgMTBeKGV4cG9uZW50KSB3aGVyZSB0aGUgbWFudGlzc2EgaXMgYmV0d2VlbiAxIGFuZCAxMCAob3IgLTEgdG8gLTEwKVxyXG4gICAgICBjb25zdCBleHBvbmVudCA9IE1hdGguZmxvb3IoIFV0aWxzLmxvZzEwKCBNYXRoLmFicyggbnVtYmVyICkgKSApO1xyXG5cclxuICAgICAgbGV0IGRlY2ltYWxQbGFjZXM7XHJcbiAgICAgIGlmICggZXhwb25lbnQgPj0gbWF4RGlnaXRzICkge1xyXG4gICAgICAgIGRlY2ltYWxQbGFjZXMgPSAwO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2UgaWYgKCBleHBvbmVudCA+IDAgKSB7XHJcbiAgICAgICAgZGVjaW1hbFBsYWNlcyA9IG1heERpZ2l0cyAtIGV4cG9uZW50IC0gMTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBkZWNpbWFsUGxhY2VzID0gbWF4RGlnaXRzIC0gMTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgcm91bmRlZE51bWJlciA9IFV0aWxzLnRvRml4ZWROdW1iZXIoIG51bWJlciwgZGVjaW1hbFBsYWNlcyApO1xyXG4gICAgICBjb25zdCBzaWduVG9TdHJpbmcgPSAoIHJvdW5kZWROdW1iZXIgPj0gMCApID8gTWF0aFN5bWJvbHMuUExVUyA6IE1hdGhTeW1ib2xzLk1JTlVTOyAvLyBOLkIuXHJcbiAgICAgIGNvbnN0IGFic29sdXRlTnVtYmVyVG9TdHJpbmcgPSBVdGlscy50b0ZpeGVkKCBNYXRoLmFicyggbnVtYmVyICksIGRlY2ltYWxQbGFjZXMgKTsgLy8gTi5CLlxyXG5cclxuICAgICAgcmV0dXJuIFsgc2lnblRvU3RyaW5nLCBhYnNvbHV0ZU51bWJlclRvU3RyaW5nIF07XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogdXBkYXRlcyBhbGwgdGhlIGNvZWZmaWNpZW50cyBhbmQgcGFuZWwgY29udGVudFxyXG4gICAgICovXHJcbiAgICBjb25zdCB1cGRhdGVDb250ZW50ID0gKCkgPT4ge1xyXG5cclxuICAgICAgdGhpcy52aXNpYmxlID0gY3VydmVWaXNpYmxlUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgICBjb25zdCBjb2VmZmljaWVudFN0cmluZ3MgPSBfLmZsYXRNYXAoXHJcbiAgICAgICAgY3VydmUuY29lZmZpY2llbnRzLFxyXG4gICAgICAgICggY29lZmZpY2llbnQsIGluZGV4ICkgPT4gZ2V0Um91bmRlZFBhcmFtZXRlclN0cmluZ3MoIGNvZWZmaWNpZW50LCBNQVhfRElHSVRTWyBpbmRleCBdIClcclxuICAgICAgKTtcclxuICAgICAgZXF1YXRpb25Ob2RlLnNldENvZWZmaWNpZW50cyggY29lZmZpY2llbnRTdHJpbmdzICk7XHJcblxyXG4gICAgICBjb25zdCBjaGlsZHJlbiA9IFsgZXhwYW5kQ29sbGFwc2VCdXR0b24gXTtcclxuICAgICAgaWYgKCBlcXVhdGlvblBhbmVsRXhwYW5kZWRQcm9wZXJ0eS52YWx1ZSApIHtcclxuICAgICAgICBjaGlsZHJlbi5wdXNoKCBjdXJ2ZS5pc0N1cnZlUHJlc2VudCgpID8gZXF1YXRpb25Ob2RlIDogdW5kZWZpbmVkRXF1YXRpb25UZXh0ICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgY2hpbGRyZW4ucHVzaCggdGl0bGVOb2RlICk7XHJcbiAgICAgIH1cclxuICAgICAgY2hpbGRyZW4ucHVzaCggdlN0cnV0ICk7XHJcblxyXG4gICAgICBjb250ZW50LmNoaWxkcmVuID0gY2hpbGRyZW47XHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZWRFbWl0dGVyLmVtaXQoKTtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGFkZCBvYnNlcnZlcnMgd2hpY2ggZG9uJ3QgbmVlZCB0byBiZSBkaXNwb3NlZCBiZWNhdXNlIHRoaXMgaXMgcHJlc2VudCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW11bGF0aW9uXHJcbiAgICBjdXJ2ZVZpc2libGVQcm9wZXJ0eS5saW5rKCB1cGRhdGVDb250ZW50ICk7XHJcbiAgICBlcXVhdGlvblBhbmVsRXhwYW5kZWRQcm9wZXJ0eS5saW5rKCB1cGRhdGVDb250ZW50ICk7XHJcbiAgICBjdXJ2ZS51cGRhdGVDdXJ2ZUVtaXR0ZXIuYWRkTGlzdGVuZXIoIHVwZGF0ZUNvbnRlbnQgKTtcclxuICAgIG9yZGVyUHJvcGVydHkubGluayggdXBkYXRlQ29udGVudCApO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmN1cnZlRml0dGluZy5yZWdpc3RlciggJ0VxdWF0aW9uQWNjb3JkaW9uQm94JywgRXF1YXRpb25BY2NvcmRpb25Cb3ggKTtcclxuZXhwb3J0IGRlZmF1bHQgRXF1YXRpb25BY2NvcmRpb25Cb3g7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxPQUFPLE1BQU0sZ0NBQWdDO0FBQ3BELE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxXQUFXLE1BQU0sNENBQTRDO0FBQ3BFLFNBQVNDLElBQUksRUFBRUMsSUFBSSxFQUFFQyxNQUFNLFFBQVEsbUNBQW1DO0FBQ3RFLE9BQU9DLG9CQUFvQixNQUFNLDRDQUE0QztBQUM3RSxPQUFPQyxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLFlBQVksTUFBTSx1QkFBdUI7QUFDaEQsT0FBT0MsbUJBQW1CLE1BQU0sOEJBQThCO0FBQzlELE9BQU9DLHFCQUFxQixNQUFNLDZCQUE2QjtBQUMvRCxPQUFPQyxZQUFZLE1BQU0sbUJBQW1CO0FBRTVDLE1BQU1DLGNBQWMsR0FBR0gsbUJBQW1CLENBQUNJLFFBQVE7QUFDbkQsTUFBTUMsZUFBZSxHQUFHTCxtQkFBbUIsQ0FBQ00sU0FBUzs7QUFFckQ7QUFDQSxNQUFNQyxVQUFVLEdBQUcsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUU7QUFFakMsTUFBTUMsb0JBQW9CLFNBQVNWLEtBQUssQ0FBQztFQUV2QztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFVyxXQUFXQSxDQUFFQyxLQUFLLEVBQUVDLGFBQWEsRUFBRUMsNkJBQTZCLEVBQUVDLG9CQUFvQixFQUFFQyxPQUFPLEVBQUc7SUFFaEdBLE9BQU8sR0FBR3RCLEtBQUssQ0FBRTtNQUNmdUIsb0JBQW9CLEVBQUUsR0FBRztNQUN6QkMsSUFBSSxFQUFFLE9BQU87TUFDYkMsT0FBTyxFQUFFLEdBQUc7TUFDWkMsWUFBWSxFQUFFakIscUJBQXFCLENBQUNrQixtQkFBbUI7TUFDdkRDLE9BQU8sRUFBRW5CLHFCQUFxQixDQUFDb0IsWUFBWTtNQUMzQ0MsT0FBTyxFQUFFckIscUJBQXFCLENBQUNvQjtJQUNqQyxDQUFDLEVBQUVQLE9BQVEsQ0FBQzs7SUFFWjtJQUNBLE1BQU1TLFNBQVMsR0FBRyxJQUFJNUIsSUFBSSxDQUFFUSxjQUFjLEVBQUU7TUFDMUNxQixJQUFJLEVBQUV2QixxQkFBcUIsQ0FBQ3dCLHdCQUF3QjtNQUNwREMsUUFBUSxFQUFFWixPQUFPLENBQUNDO0lBQ3BCLENBQUUsQ0FBQzs7SUFFSDtJQUNBLE1BQU1ZLG9CQUFvQixHQUFHLElBQUk5QixvQkFBb0IsQ0FBRWUsNkJBQTZCLEVBQUU7TUFDcEZnQixVQUFVLEVBQUU7SUFDZCxDQUFFLENBQUM7SUFDSEQsb0JBQW9CLENBQUNFLFNBQVMsR0FBR0Ysb0JBQW9CLENBQUNHLFdBQVcsQ0FBQ0MsT0FBTyxDQUFFSixvQkFBb0IsQ0FBQ0ssS0FBSyxHQUFHLENBQUUsQ0FBQzs7SUFFM0c7SUFDQSxNQUFNQyxZQUFZLEdBQUcsSUFBSS9CLFlBQVksQ0FBRVMsYUFBYSxFQUFFO01BQ3BEdUIsMEJBQTBCLEVBQUU7UUFDMUJsQixJQUFJLEVBQUVmLHFCQUFxQixDQUFDa0M7TUFDOUIsQ0FBQztNQUNEVCxRQUFRLEVBQUVaLE9BQU8sQ0FBQ0M7SUFDcEIsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTXFCLHFCQUFxQixHQUFHLElBQUl6QyxJQUFJLENBQUVVLGVBQWUsRUFBRTtNQUN2RG1CLElBQUksRUFBRXZCLHFCQUFxQixDQUFDd0Isd0JBQXdCO01BQ3BEQyxRQUFRLEVBQUVaLE9BQU8sQ0FBQ0M7SUFDcEIsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTXNCLE1BQU0sR0FBRyxJQUFJekMsTUFBTSxDQUFFcUMsWUFBWSxDQUFDSyxNQUFPLENBQUM7SUFFaEQsTUFBTUMsT0FBTyxHQUFHLElBQUk3QyxJQUFJLENBQUU7TUFDeEI4QyxPQUFPLEVBQUU7SUFDWCxDQUFFLENBQUM7SUFFSCxLQUFLLENBQUVELE9BQU8sRUFBRXpCLE9BQVEsQ0FBQzs7SUFFekI7SUFDQSxJQUFJLENBQUNhLG9CQUFvQixHQUFHQSxvQkFBb0I7O0lBRWhEO0lBQ0EsSUFBSSxDQUFDYyxjQUFjLEdBQUcsSUFBSW5ELE9BQU8sQ0FBQyxDQUFDOztJQUVuQztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7SUFDSSxNQUFNb0QsMEJBQTBCLEdBQUdBLENBQUVDLE1BQU0sRUFBRUMsU0FBUyxLQUFNO01BRTFEO01BQ0EsTUFBTUMsUUFBUSxHQUFHQyxJQUFJLENBQUNDLEtBQUssQ0FBRXhELEtBQUssQ0FBQ3lELEtBQUssQ0FBRUYsSUFBSSxDQUFDRyxHQUFHLENBQUVOLE1BQU8sQ0FBRSxDQUFFLENBQUM7TUFFaEUsSUFBSU8sYUFBYTtNQUNqQixJQUFLTCxRQUFRLElBQUlELFNBQVMsRUFBRztRQUMzQk0sYUFBYSxHQUFHLENBQUM7TUFDbkIsQ0FBQyxNQUNJLElBQUtMLFFBQVEsR0FBRyxDQUFDLEVBQUc7UUFDdkJLLGFBQWEsR0FBR04sU0FBUyxHQUFHQyxRQUFRLEdBQUcsQ0FBQztNQUMxQyxDQUFDLE1BQ0k7UUFDSEssYUFBYSxHQUFHTixTQUFTLEdBQUcsQ0FBQztNQUMvQjtNQUVBLE1BQU1PLGFBQWEsR0FBRzVELEtBQUssQ0FBQzZELGFBQWEsQ0FBRVQsTUFBTSxFQUFFTyxhQUFjLENBQUM7TUFDbEUsTUFBTUcsWUFBWSxHQUFLRixhQUFhLElBQUksQ0FBQyxHQUFLMUQsV0FBVyxDQUFDNkQsSUFBSSxHQUFHN0QsV0FBVyxDQUFDOEQsS0FBSyxDQUFDLENBQUM7TUFDcEYsTUFBTUMsc0JBQXNCLEdBQUdqRSxLQUFLLENBQUNrRSxPQUFPLENBQUVYLElBQUksQ0FBQ0csR0FBRyxDQUFFTixNQUFPLENBQUMsRUFBRU8sYUFBYyxDQUFDLENBQUMsQ0FBQzs7TUFFbkYsT0FBTyxDQUFFRyxZQUFZLEVBQUVHLHNCQUFzQixDQUFFO0lBQ2pELENBQUM7O0lBRUQ7QUFDSjtBQUNBO0lBQ0ksTUFBTUUsYUFBYSxHQUFHQSxDQUFBLEtBQU07TUFFMUIsSUFBSSxDQUFDQyxPQUFPLEdBQUc5QyxvQkFBb0IsQ0FBQytDLEtBQUs7TUFFekMsTUFBTUMsa0JBQWtCLEdBQUdDLENBQUMsQ0FBQ0MsT0FBTyxDQUNsQ3JELEtBQUssQ0FBQ3NELFlBQVksRUFDbEIsQ0FBRUMsV0FBVyxFQUFFQyxLQUFLLEtBQU14QiwwQkFBMEIsQ0FBRXVCLFdBQVcsRUFBRTFELFVBQVUsQ0FBRTJELEtBQUssQ0FBRyxDQUN6RixDQUFDO01BQ0RqQyxZQUFZLENBQUNrQyxlQUFlLENBQUVOLGtCQUFtQixDQUFDO01BRWxELE1BQU1PLFFBQVEsR0FBRyxDQUFFekMsb0JBQW9CLENBQUU7TUFDekMsSUFBS2YsNkJBQTZCLENBQUNnRCxLQUFLLEVBQUc7UUFDekNRLFFBQVEsQ0FBQ0MsSUFBSSxDQUFFM0QsS0FBSyxDQUFDNEQsY0FBYyxDQUFDLENBQUMsR0FBR3JDLFlBQVksR0FBR0cscUJBQXNCLENBQUM7TUFDaEYsQ0FBQyxNQUNJO1FBQ0hnQyxRQUFRLENBQUNDLElBQUksQ0FBRTlDLFNBQVUsQ0FBQztNQUM1QjtNQUNBNkMsUUFBUSxDQUFDQyxJQUFJLENBQUVoQyxNQUFPLENBQUM7TUFFdkJFLE9BQU8sQ0FBQzZCLFFBQVEsR0FBR0EsUUFBUTtNQUUzQixJQUFJLENBQUMzQixjQUFjLENBQUM4QixJQUFJLENBQUMsQ0FBQztJQUU1QixDQUFDOztJQUVEO0lBQ0ExRCxvQkFBb0IsQ0FBQzJELElBQUksQ0FBRWQsYUFBYyxDQUFDO0lBQzFDOUMsNkJBQTZCLENBQUM0RCxJQUFJLENBQUVkLGFBQWMsQ0FBQztJQUNuRGhELEtBQUssQ0FBQytELGtCQUFrQixDQUFDQyxXQUFXLENBQUVoQixhQUFjLENBQUM7SUFDckQvQyxhQUFhLENBQUM2RCxJQUFJLENBQUVkLGFBQWMsQ0FBQztFQUNyQztBQUVGO0FBRUEzRCxZQUFZLENBQUM0RSxRQUFRLENBQUUsc0JBQXNCLEVBQUVuRSxvQkFBcUIsQ0FBQztBQUNyRSxlQUFlQSxvQkFBb0IifQ==