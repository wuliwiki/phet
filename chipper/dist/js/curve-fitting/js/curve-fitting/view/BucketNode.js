// Copyright 2015-2022, University of Colorado Boulder

/**
 * Bucket node with points in 'Curve Fitting' simulation.
 *
 * @author Andrey Zelenkov (Mlearner)
 * @author Saurabh Totey
 */

import Dimension2 from '../../../../dot/js/Dimension2.js';
import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Bucket from '../../../../phetcommon/js/model/Bucket.js';
import BucketFront from '../../../../scenery-phet/js/bucket/BucketFront.js';
import BucketHole from '../../../../scenery-phet/js/bucket/BucketHole.js';
import { Circle, DragListener, Node } from '../../../../scenery/js/imports.js';
import curveFitting from '../../curveFitting.js';
import CurveFittingConstants from '../CurveFittingConstants.js';
import CurveFittingQueryParameters from '../CurveFittingQueryParameters.js';
import Point from '../model/Point.js';
import PointNode from './PointNode.js';

// constants
const BUCKET_WIDTH = 4.45; // in model coordinates
const BUCKET_HEIGHT = BUCKET_WIDTH * 0.50;
const BUCKET_COLOR = 'rgb( 65, 63, 117 )';

// bucket position is to the left and up from the bottom left corner of graph, in model coordinates
const BUCKET_POSITION_X = CurveFittingConstants.GRAPH_NODE_MODEL_BOUNDS.minX - 1.5;
const BUCKET_POSITION_Y = CurveFittingConstants.GRAPH_NODE_MODEL_BOUNDS.minY + 4;

// position of points inside bucket
const POINT_POSITIONS = [{
  x: -41.25,
  y: 10
}, {
  x: -31.25,
  y: 12.5
}, {
  x: -31.25,
  y: -1.25
}, {
  x: -25,
  y: 3.75
}, {
  x: -23.75,
  y: -5
}, {
  x: -18.75,
  y: 10
}, {
  x: -15,
  y: -12.5
}, {
  x: -12.5,
  y: -3.75
}, {
  x: -6.25,
  y: 10
}, {
  x: -6.25,
  y: -15
}, {
  x: -3.75,
  y: 12.5
}, {
  x: 0,
  y: -12.5
}, {
  x: 2.5,
  y: -2.5
}, {
  x: 6.25,
  y: 2.5
}, {
  x: 6.25,
  y: 11.25
}, {
  x: 12.5,
  y: -6.25
}, {
  x: 10,
  y: -15
}, {
  x: 22.5,
  y: 2.5
}, {
  x: 28.75,
  y: 11.25
}, {
  x: 0,
  y: 5
}, {
  x: 21.25,
  y: -10
}, {
  x: 12.5,
  y: 11.25
}, {
  x: 30,
  y: -1.25
}, {
  x: 18.75,
  y: 11.25
}, {
  x: 15,
  y: -12.5
}, {
  x: 12.5,
  y: 2.5
}, {
  x: -8.75,
  y: 2.5
}, {
  x: 41.25,
  y: 11.25
}, {
  x: 41.25,
  y: 5
}];
class BucketNode extends Node {
  /**
   * @param {Points} points
   * @param {function} bumpOutFunction - the function that bumps points out of invalid positions (see #131)
   * @param {Property.<boolean>} residualsVisibleProperty
   * @param {Property.<boolean>} valuesVisibleProperty
   * @param {ModelViewTransform2} modelViewTransform
   */
  constructor(points, bumpOutFunction, residualsVisibleProperty, valuesVisibleProperty, modelViewTransform) {
    super();

    // model of the bucket
    const bucket = new Bucket({
      position: new Vector2(BUCKET_POSITION_X, BUCKET_POSITION_Y),
      size: new Dimension2(BUCKET_WIDTH, BUCKET_HEIGHT),
      baseColor: BUCKET_COLOR
    });

    // front of the bucket
    const bucketFrontNode = new BucketFront(bucket, modelViewTransform);

    // back of the bucket
    const bucketHoleNode = new BucketHole(bucket, modelViewTransform);

    // an array that records which points are being interacted with currently
    // used by points to determine when they should display their halos (see #133)
    const currentlyInteractingPoints = [];

    /**
     * creates a drag listener that adds a point to the model
     * @returns {DragListener}
     */
    const createDragHandler = () => {
      let point = null;
      return new DragListener({
        allowTouchSnag: true,
        start: event => {
          // create a model point
          const viewPosition = this.globalToLocalPoint(event.pointer.point);
          const modelPosition = modelViewTransform.viewToModelPosition(viewPosition);
          point = new Point({
            position: modelPosition,
            dragging: true
          });

          // add the model point to the observable array in model curve
          points.add(point);
          currentlyInteractingPoints.push(point);
        },
        drag: event => {
          const viewPosition = this.globalToLocalPoint(event.pointer.point);
          point.positionProperty.value = modelViewTransform.viewToModelPosition(viewPosition);
        },
        end: () => {
          bumpOutFunction();
          if (CurveFittingQueryParameters.snapToGrid) {
            point.positionProperty.value = new Vector2(Utils.toFixedNumber(point.positionProperty.value.x, 0), Utils.toFixedNumber(point.positionProperty.value.y, 0));
          }
          currentlyInteractingPoints.splice(currentlyInteractingPoints.indexOf(point), 1);
          point.draggingProperty.value = false;
          point = null;
        }
      });
    };

    // points in the bucket
    const pointsNode = new Node();
    POINT_POSITIONS.forEach(position => {
      const circle = new Circle({
        fill: CurveFittingConstants.POINT_FILL,
        radius: CurveFittingConstants.POINT_RADIUS,
        stroke: CurveFittingConstants.POINT_STROKE,
        lineWidth: CurveFittingConstants.POINT_LINE_WIDTH,
        x: position.x,
        y: position.y,
        cursor: 'pointer'
      });
      circle.addInputListener(createDragHandler());
      pointsNode.addChild(circle);
    });
    pointsNode.center = bucketHoleNode.center.plusXY(0, -6); // tuned by hand, slightly above bucket

    // add children, the z-order is critical here.
    this.addChild(bucketHoleNode);
    this.addChild(pointsNode);
    this.addChild(bucketFrontNode);

    // handle the coming and going of points
    points.addItemAddedListener(addedPoint => {
      const pointNode = new PointNode(addedPoint, bumpOutFunction, currentlyInteractingPoints, residualsVisibleProperty, valuesVisibleProperty, modelViewTransform);
      this.addChild(pointNode);
      const removalListener = removedPoint => {
        if (removedPoint === addedPoint) {
          this.removeChild(pointNode);
          pointNode.dispose();
          points.removeItemRemovedListener(removalListener);
        }
      };
      points.addItemRemovedListener(removalListener);
    });
  }
}
curveFitting.register('BucketNode', BucketNode);
export default BucketNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEaW1lbnNpb24yIiwiVXRpbHMiLCJWZWN0b3IyIiwiQnVja2V0IiwiQnVja2V0RnJvbnQiLCJCdWNrZXRIb2xlIiwiQ2lyY2xlIiwiRHJhZ0xpc3RlbmVyIiwiTm9kZSIsImN1cnZlRml0dGluZyIsIkN1cnZlRml0dGluZ0NvbnN0YW50cyIsIkN1cnZlRml0dGluZ1F1ZXJ5UGFyYW1ldGVycyIsIlBvaW50IiwiUG9pbnROb2RlIiwiQlVDS0VUX1dJRFRIIiwiQlVDS0VUX0hFSUdIVCIsIkJVQ0tFVF9DT0xPUiIsIkJVQ0tFVF9QT1NJVElPTl9YIiwiR1JBUEhfTk9ERV9NT0RFTF9CT1VORFMiLCJtaW5YIiwiQlVDS0VUX1BPU0lUSU9OX1kiLCJtaW5ZIiwiUE9JTlRfUE9TSVRJT05TIiwieCIsInkiLCJCdWNrZXROb2RlIiwiY29uc3RydWN0b3IiLCJwb2ludHMiLCJidW1wT3V0RnVuY3Rpb24iLCJyZXNpZHVhbHNWaXNpYmxlUHJvcGVydHkiLCJ2YWx1ZXNWaXNpYmxlUHJvcGVydHkiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJidWNrZXQiLCJwb3NpdGlvbiIsInNpemUiLCJiYXNlQ29sb3IiLCJidWNrZXRGcm9udE5vZGUiLCJidWNrZXRIb2xlTm9kZSIsImN1cnJlbnRseUludGVyYWN0aW5nUG9pbnRzIiwiY3JlYXRlRHJhZ0hhbmRsZXIiLCJwb2ludCIsImFsbG93VG91Y2hTbmFnIiwic3RhcnQiLCJldmVudCIsInZpZXdQb3NpdGlvbiIsImdsb2JhbFRvTG9jYWxQb2ludCIsInBvaW50ZXIiLCJtb2RlbFBvc2l0aW9uIiwidmlld1RvTW9kZWxQb3NpdGlvbiIsImRyYWdnaW5nIiwiYWRkIiwicHVzaCIsImRyYWciLCJwb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJlbmQiLCJzbmFwVG9HcmlkIiwidG9GaXhlZE51bWJlciIsInNwbGljZSIsImluZGV4T2YiLCJkcmFnZ2luZ1Byb3BlcnR5IiwicG9pbnRzTm9kZSIsImZvckVhY2giLCJjaXJjbGUiLCJmaWxsIiwiUE9JTlRfRklMTCIsInJhZGl1cyIsIlBPSU5UX1JBRElVUyIsInN0cm9rZSIsIlBPSU5UX1NUUk9LRSIsImxpbmVXaWR0aCIsIlBPSU5UX0xJTkVfV0lEVEgiLCJjdXJzb3IiLCJhZGRJbnB1dExpc3RlbmVyIiwiYWRkQ2hpbGQiLCJjZW50ZXIiLCJwbHVzWFkiLCJhZGRJdGVtQWRkZWRMaXN0ZW5lciIsImFkZGVkUG9pbnQiLCJwb2ludE5vZGUiLCJyZW1vdmFsTGlzdGVuZXIiLCJyZW1vdmVkUG9pbnQiLCJyZW1vdmVDaGlsZCIsImRpc3Bvc2UiLCJyZW1vdmVJdGVtUmVtb3ZlZExpc3RlbmVyIiwiYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQnVja2V0Tm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBCdWNrZXQgbm9kZSB3aXRoIHBvaW50cyBpbiAnQ3VydmUgRml0dGluZycgc2ltdWxhdGlvbi5cclxuICpcclxuICogQGF1dGhvciBBbmRyZXkgWmVsZW5rb3YgKE1sZWFybmVyKVxyXG4gKiBAYXV0aG9yIFNhdXJhYmggVG90ZXlcclxuICovXHJcblxyXG5pbXBvcnQgRGltZW5zaW9uMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvRGltZW5zaW9uMi5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBCdWNrZXQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy9tb2RlbC9CdWNrZXQuanMnO1xyXG5pbXBvcnQgQnVja2V0RnJvbnQgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1Y2tldC9CdWNrZXRGcm9udC5qcyc7XHJcbmltcG9ydCBCdWNrZXRIb2xlIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9idWNrZXQvQnVja2V0SG9sZS5qcyc7XHJcbmltcG9ydCB7IENpcmNsZSwgRHJhZ0xpc3RlbmVyLCBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGN1cnZlRml0dGluZyBmcm9tICcuLi8uLi9jdXJ2ZUZpdHRpbmcuanMnO1xyXG5pbXBvcnQgQ3VydmVGaXR0aW5nQ29uc3RhbnRzIGZyb20gJy4uL0N1cnZlRml0dGluZ0NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBDdXJ2ZUZpdHRpbmdRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vQ3VydmVGaXR0aW5nUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IFBvaW50IGZyb20gJy4uL21vZGVsL1BvaW50LmpzJztcclxuaW1wb3J0IFBvaW50Tm9kZSBmcm9tICcuL1BvaW50Tm9kZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgQlVDS0VUX1dJRFRIID0gNC40NTsgLy8gaW4gbW9kZWwgY29vcmRpbmF0ZXNcclxuY29uc3QgQlVDS0VUX0hFSUdIVCA9IEJVQ0tFVF9XSURUSCAqIDAuNTA7XHJcbmNvbnN0IEJVQ0tFVF9DT0xPUiA9ICdyZ2IoIDY1LCA2MywgMTE3ICknO1xyXG5cclxuLy8gYnVja2V0IHBvc2l0aW9uIGlzIHRvIHRoZSBsZWZ0IGFuZCB1cCBmcm9tIHRoZSBib3R0b20gbGVmdCBjb3JuZXIgb2YgZ3JhcGgsIGluIG1vZGVsIGNvb3JkaW5hdGVzXHJcbmNvbnN0IEJVQ0tFVF9QT1NJVElPTl9YID0gQ3VydmVGaXR0aW5nQ29uc3RhbnRzLkdSQVBIX05PREVfTU9ERUxfQk9VTkRTLm1pblggLSAxLjU7XHJcbmNvbnN0IEJVQ0tFVF9QT1NJVElPTl9ZID0gQ3VydmVGaXR0aW5nQ29uc3RhbnRzLkdSQVBIX05PREVfTU9ERUxfQk9VTkRTLm1pblkgKyA0O1xyXG5cclxuLy8gcG9zaXRpb24gb2YgcG9pbnRzIGluc2lkZSBidWNrZXRcclxuY29uc3QgUE9JTlRfUE9TSVRJT05TID0gW1xyXG4gIHsgeDogLTQxLjI1LCB5OiAxMCB9LFxyXG4gIHsgeDogLTMxLjI1LCB5OiAxMi41IH0sXHJcbiAgeyB4OiAtMzEuMjUsIHk6IC0xLjI1IH0sXHJcbiAgeyB4OiAtMjUsIHk6IDMuNzUgfSxcclxuICB7IHg6IC0yMy43NSwgeTogLTUgfSxcclxuICB7IHg6IC0xOC43NSwgeTogMTAgfSxcclxuICB7IHg6IC0xNSwgeTogLTEyLjUgfSxcclxuICB7IHg6IC0xMi41LCB5OiAtMy43NSB9LFxyXG4gIHsgeDogLTYuMjUsIHk6IDEwIH0sXHJcbiAgeyB4OiAtNi4yNSwgeTogLTE1IH0sXHJcbiAgeyB4OiAtMy43NSwgeTogMTIuNSB9LFxyXG4gIHsgeDogMCwgeTogLTEyLjUgfSxcclxuICB7IHg6IDIuNSwgeTogLTIuNSB9LFxyXG4gIHsgeDogNi4yNSwgeTogMi41IH0sXHJcbiAgeyB4OiA2LjI1LCB5OiAxMS4yNSB9LFxyXG4gIHsgeDogMTIuNSwgeTogLTYuMjUgfSxcclxuICB7IHg6IDEwLCB5OiAtMTUgfSxcclxuICB7IHg6IDIyLjUsIHk6IDIuNSB9LFxyXG4gIHsgeDogMjguNzUsIHk6IDExLjI1IH0sXHJcbiAgeyB4OiAwLCB5OiA1IH0sXHJcbiAgeyB4OiAyMS4yNSwgeTogLTEwIH0sXHJcbiAgeyB4OiAxMi41LCB5OiAxMS4yNSB9LFxyXG4gIHsgeDogMzAsIHk6IC0xLjI1IH0sXHJcbiAgeyB4OiAxOC43NSwgeTogMTEuMjUgfSxcclxuICB7IHg6IDE1LCB5OiAtMTIuNSB9LFxyXG4gIHsgeDogMTIuNSwgeTogMi41IH0sXHJcbiAgeyB4OiAtOC43NSwgeTogMi41IH0sXHJcbiAgeyB4OiA0MS4yNSwgeTogMTEuMjUgfSxcclxuICB7IHg6IDQxLjI1LCB5OiA1IH1cclxuXTtcclxuXHJcbmNsYXNzIEJ1Y2tldE5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtQb2ludHN9IHBvaW50c1xyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGJ1bXBPdXRGdW5jdGlvbiAtIHRoZSBmdW5jdGlvbiB0aGF0IGJ1bXBzIHBvaW50cyBvdXQgb2YgaW52YWxpZCBwb3NpdGlvbnMgKHNlZSAjMTMxKVxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPGJvb2xlYW4+fSByZXNpZHVhbHNWaXNpYmxlUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5Ljxib29sZWFuPn0gdmFsdWVzVmlzaWJsZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggcG9pbnRzLCBidW1wT3V0RnVuY3Rpb24sIHJlc2lkdWFsc1Zpc2libGVQcm9wZXJ0eSwgdmFsdWVzVmlzaWJsZVByb3BlcnR5LCBtb2RlbFZpZXdUcmFuc2Zvcm0gKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIC8vIG1vZGVsIG9mIHRoZSBidWNrZXRcclxuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBCdWNrZXQoIHtcclxuICAgICAgcG9zaXRpb246IG5ldyBWZWN0b3IyKCBCVUNLRVRfUE9TSVRJT05fWCwgQlVDS0VUX1BPU0lUSU9OX1kgKSxcclxuICAgICAgc2l6ZTogbmV3IERpbWVuc2lvbjIoIEJVQ0tFVF9XSURUSCwgQlVDS0VUX0hFSUdIVCApLFxyXG4gICAgICBiYXNlQ29sb3I6IEJVQ0tFVF9DT0xPUlxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGZyb250IG9mIHRoZSBidWNrZXRcclxuICAgIGNvbnN0IGJ1Y2tldEZyb250Tm9kZSA9IG5ldyBCdWNrZXRGcm9udCggYnVja2V0LCBtb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuXHJcbiAgICAvLyBiYWNrIG9mIHRoZSBidWNrZXRcclxuICAgIGNvbnN0IGJ1Y2tldEhvbGVOb2RlID0gbmV3IEJ1Y2tldEhvbGUoIGJ1Y2tldCwgbW9kZWxWaWV3VHJhbnNmb3JtICk7XHJcblxyXG4gICAgLy8gYW4gYXJyYXkgdGhhdCByZWNvcmRzIHdoaWNoIHBvaW50cyBhcmUgYmVpbmcgaW50ZXJhY3RlZCB3aXRoIGN1cnJlbnRseVxyXG4gICAgLy8gdXNlZCBieSBwb2ludHMgdG8gZGV0ZXJtaW5lIHdoZW4gdGhleSBzaG91bGQgZGlzcGxheSB0aGVpciBoYWxvcyAoc2VlICMxMzMpXHJcbiAgICBjb25zdCBjdXJyZW50bHlJbnRlcmFjdGluZ1BvaW50cyA9IFtdO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogY3JlYXRlcyBhIGRyYWcgbGlzdGVuZXIgdGhhdCBhZGRzIGEgcG9pbnQgdG8gdGhlIG1vZGVsXHJcbiAgICAgKiBAcmV0dXJucyB7RHJhZ0xpc3RlbmVyfVxyXG4gICAgICovXHJcbiAgICBjb25zdCBjcmVhdGVEcmFnSGFuZGxlciA9ICgpID0+IHtcclxuICAgICAgbGV0IHBvaW50ID0gbnVsbDtcclxuICAgICAgcmV0dXJuIG5ldyBEcmFnTGlzdGVuZXIoIHtcclxuXHJcbiAgICAgICAgYWxsb3dUb3VjaFNuYWc6IHRydWUsXHJcblxyXG4gICAgICAgIHN0YXJ0OiBldmVudCA9PiB7XHJcblxyXG4gICAgICAgICAgLy8gY3JlYXRlIGEgbW9kZWwgcG9pbnRcclxuICAgICAgICAgIGNvbnN0IHZpZXdQb3NpdGlvbiA9IHRoaXMuZ2xvYmFsVG9Mb2NhbFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICk7XHJcbiAgICAgICAgICBjb25zdCBtb2RlbFBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHZpZXdQb3NpdGlvbiApO1xyXG4gICAgICAgICAgcG9pbnQgPSBuZXcgUG9pbnQoIHtcclxuICAgICAgICAgICAgcG9zaXRpb246IG1vZGVsUG9zaXRpb24sXHJcbiAgICAgICAgICAgIGRyYWdnaW5nOiB0cnVlXHJcbiAgICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgICAgLy8gYWRkIHRoZSBtb2RlbCBwb2ludCB0byB0aGUgb2JzZXJ2YWJsZSBhcnJheSBpbiBtb2RlbCBjdXJ2ZVxyXG4gICAgICAgICAgcG9pbnRzLmFkZCggcG9pbnQgKTtcclxuXHJcbiAgICAgICAgICBjdXJyZW50bHlJbnRlcmFjdGluZ1BvaW50cy5wdXNoKCBwb2ludCApO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGRyYWc6IGV2ZW50ID0+IHtcclxuICAgICAgICAgIGNvbnN0IHZpZXdQb3NpdGlvbiA9IHRoaXMuZ2xvYmFsVG9Mb2NhbFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICk7XHJcbiAgICAgICAgICBwb2ludC5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHZpZXdQb3NpdGlvbiApO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIGVuZDogKCkgPT4ge1xyXG4gICAgICAgICAgYnVtcE91dEZ1bmN0aW9uKCk7XHJcbiAgICAgICAgICBpZiAoIEN1cnZlRml0dGluZ1F1ZXJ5UGFyYW1ldGVycy5zbmFwVG9HcmlkICkge1xyXG4gICAgICAgICAgICBwb2ludC5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoXHJcbiAgICAgICAgICAgICAgVXRpbHMudG9GaXhlZE51bWJlciggcG9pbnQucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54LCAwICksXHJcbiAgICAgICAgICAgICAgVXRpbHMudG9GaXhlZE51bWJlciggcG9pbnQucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55LCAwIClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGN1cnJlbnRseUludGVyYWN0aW5nUG9pbnRzLnNwbGljZSggY3VycmVudGx5SW50ZXJhY3RpbmdQb2ludHMuaW5kZXhPZiggcG9pbnQgKSwgMSApO1xyXG4gICAgICAgICAgcG9pbnQuZHJhZ2dpbmdQcm9wZXJ0eS52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgcG9pbnQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBwb2ludHMgaW4gdGhlIGJ1Y2tldFxyXG4gICAgY29uc3QgcG9pbnRzTm9kZSA9IG5ldyBOb2RlKCk7XHJcbiAgICBQT0lOVF9QT1NJVElPTlMuZm9yRWFjaCggcG9zaXRpb24gPT4ge1xyXG4gICAgICBjb25zdCBjaXJjbGUgPSBuZXcgQ2lyY2xlKCB7XHJcbiAgICAgICAgZmlsbDogQ3VydmVGaXR0aW5nQ29uc3RhbnRzLlBPSU5UX0ZJTEwsXHJcbiAgICAgICAgcmFkaXVzOiBDdXJ2ZUZpdHRpbmdDb25zdGFudHMuUE9JTlRfUkFESVVTLFxyXG4gICAgICAgIHN0cm9rZTogQ3VydmVGaXR0aW5nQ29uc3RhbnRzLlBPSU5UX1NUUk9LRSxcclxuICAgICAgICBsaW5lV2lkdGg6IEN1cnZlRml0dGluZ0NvbnN0YW50cy5QT0lOVF9MSU5FX1dJRFRILFxyXG4gICAgICAgIHg6IHBvc2l0aW9uLngsXHJcbiAgICAgICAgeTogcG9zaXRpb24ueSxcclxuICAgICAgICBjdXJzb3I6ICdwb2ludGVyJ1xyXG4gICAgICB9ICk7XHJcbiAgICAgIGNpcmNsZS5hZGRJbnB1dExpc3RlbmVyKCBjcmVhdGVEcmFnSGFuZGxlcigpICk7XHJcbiAgICAgIHBvaW50c05vZGUuYWRkQ2hpbGQoIGNpcmNsZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHBvaW50c05vZGUuY2VudGVyID0gYnVja2V0SG9sZU5vZGUuY2VudGVyLnBsdXNYWSggMCwgLTYgKTsgLy8gdHVuZWQgYnkgaGFuZCwgc2xpZ2h0bHkgYWJvdmUgYnVja2V0XHJcblxyXG4gICAgLy8gYWRkIGNoaWxkcmVuLCB0aGUgei1vcmRlciBpcyBjcml0aWNhbCBoZXJlLlxyXG4gICAgdGhpcy5hZGRDaGlsZCggYnVja2V0SG9sZU5vZGUgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHBvaW50c05vZGUgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGJ1Y2tldEZyb250Tm9kZSApO1xyXG5cclxuICAgIC8vIGhhbmRsZSB0aGUgY29taW5nIGFuZCBnb2luZyBvZiBwb2ludHNcclxuICAgIHBvaW50cy5hZGRJdGVtQWRkZWRMaXN0ZW5lciggYWRkZWRQb2ludCA9PiB7XHJcbiAgICAgIGNvbnN0IHBvaW50Tm9kZSA9IG5ldyBQb2ludE5vZGUoXHJcbiAgICAgICAgYWRkZWRQb2ludCxcclxuICAgICAgICBidW1wT3V0RnVuY3Rpb24sXHJcbiAgICAgICAgY3VycmVudGx5SW50ZXJhY3RpbmdQb2ludHMsXHJcbiAgICAgICAgcmVzaWR1YWxzVmlzaWJsZVByb3BlcnR5LFxyXG4gICAgICAgIHZhbHVlc1Zpc2libGVQcm9wZXJ0eSxcclxuICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgICAgKTtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggcG9pbnROb2RlICk7XHJcblxyXG4gICAgICBjb25zdCByZW1vdmFsTGlzdGVuZXIgPSByZW1vdmVkUG9pbnQgPT4ge1xyXG4gICAgICAgIGlmICggcmVtb3ZlZFBvaW50ID09PSBhZGRlZFBvaW50ICkge1xyXG4gICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZCggcG9pbnROb2RlICk7XHJcbiAgICAgICAgICBwb2ludE5vZGUuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgcG9pbnRzLnJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIoIHJlbW92YWxMaXN0ZW5lciApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgcG9pbnRzLmFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIoIHJlbW92YWxMaXN0ZW5lciApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmN1cnZlRml0dGluZy5yZWdpc3RlciggJ0J1Y2tldE5vZGUnLCBCdWNrZXROb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IEJ1Y2tldE5vZGU7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFVBQVUsTUFBTSxrQ0FBa0M7QUFDekQsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLE1BQU0sTUFBTSwyQ0FBMkM7QUFDOUQsT0FBT0MsV0FBVyxNQUFNLG1EQUFtRDtBQUMzRSxPQUFPQyxVQUFVLE1BQU0sa0RBQWtEO0FBQ3pFLFNBQVNDLE1BQU0sRUFBRUMsWUFBWSxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQzlFLE9BQU9DLFlBQVksTUFBTSx1QkFBdUI7QUFDaEQsT0FBT0MscUJBQXFCLE1BQU0sNkJBQTZCO0FBQy9ELE9BQU9DLDJCQUEyQixNQUFNLG1DQUFtQztBQUMzRSxPQUFPQyxLQUFLLE1BQU0sbUJBQW1CO0FBQ3JDLE9BQU9DLFNBQVMsTUFBTSxnQkFBZ0I7O0FBRXRDO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQzNCLE1BQU1DLGFBQWEsR0FBR0QsWUFBWSxHQUFHLElBQUk7QUFDekMsTUFBTUUsWUFBWSxHQUFHLG9CQUFvQjs7QUFFekM7QUFDQSxNQUFNQyxpQkFBaUIsR0FBR1AscUJBQXFCLENBQUNRLHVCQUF1QixDQUFDQyxJQUFJLEdBQUcsR0FBRztBQUNsRixNQUFNQyxpQkFBaUIsR0FBR1YscUJBQXFCLENBQUNRLHVCQUF1QixDQUFDRyxJQUFJLEdBQUcsQ0FBQzs7QUFFaEY7QUFDQSxNQUFNQyxlQUFlLEdBQUcsQ0FDdEI7RUFBRUMsQ0FBQyxFQUFFLENBQUMsS0FBSztFQUFFQyxDQUFDLEVBQUU7QUFBRyxDQUFDLEVBQ3BCO0VBQUVELENBQUMsRUFBRSxDQUFDLEtBQUs7RUFBRUMsQ0FBQyxFQUFFO0FBQUssQ0FBQyxFQUN0QjtFQUFFRCxDQUFDLEVBQUUsQ0FBQyxLQUFLO0VBQUVDLENBQUMsRUFBRSxDQUFDO0FBQUssQ0FBQyxFQUN2QjtFQUFFRCxDQUFDLEVBQUUsQ0FBQyxFQUFFO0VBQUVDLENBQUMsRUFBRTtBQUFLLENBQUMsRUFDbkI7RUFBRUQsQ0FBQyxFQUFFLENBQUMsS0FBSztFQUFFQyxDQUFDLEVBQUUsQ0FBQztBQUFFLENBQUMsRUFDcEI7RUFBRUQsQ0FBQyxFQUFFLENBQUMsS0FBSztFQUFFQyxDQUFDLEVBQUU7QUFBRyxDQUFDLEVBQ3BCO0VBQUVELENBQUMsRUFBRSxDQUFDLEVBQUU7RUFBRUMsQ0FBQyxFQUFFLENBQUM7QUFBSyxDQUFDLEVBQ3BCO0VBQUVELENBQUMsRUFBRSxDQUFDLElBQUk7RUFBRUMsQ0FBQyxFQUFFLENBQUM7QUFBSyxDQUFDLEVBQ3RCO0VBQUVELENBQUMsRUFBRSxDQUFDLElBQUk7RUFBRUMsQ0FBQyxFQUFFO0FBQUcsQ0FBQyxFQUNuQjtFQUFFRCxDQUFDLEVBQUUsQ0FBQyxJQUFJO0VBQUVDLENBQUMsRUFBRSxDQUFDO0FBQUcsQ0FBQyxFQUNwQjtFQUFFRCxDQUFDLEVBQUUsQ0FBQyxJQUFJO0VBQUVDLENBQUMsRUFBRTtBQUFLLENBQUMsRUFDckI7RUFBRUQsQ0FBQyxFQUFFLENBQUM7RUFBRUMsQ0FBQyxFQUFFLENBQUM7QUFBSyxDQUFDLEVBQ2xCO0VBQUVELENBQUMsRUFBRSxHQUFHO0VBQUVDLENBQUMsRUFBRSxDQUFDO0FBQUksQ0FBQyxFQUNuQjtFQUFFRCxDQUFDLEVBQUUsSUFBSTtFQUFFQyxDQUFDLEVBQUU7QUFBSSxDQUFDLEVBQ25CO0VBQUVELENBQUMsRUFBRSxJQUFJO0VBQUVDLENBQUMsRUFBRTtBQUFNLENBQUMsRUFDckI7RUFBRUQsQ0FBQyxFQUFFLElBQUk7RUFBRUMsQ0FBQyxFQUFFLENBQUM7QUFBSyxDQUFDLEVBQ3JCO0VBQUVELENBQUMsRUFBRSxFQUFFO0VBQUVDLENBQUMsRUFBRSxDQUFDO0FBQUcsQ0FBQyxFQUNqQjtFQUFFRCxDQUFDLEVBQUUsSUFBSTtFQUFFQyxDQUFDLEVBQUU7QUFBSSxDQUFDLEVBQ25CO0VBQUVELENBQUMsRUFBRSxLQUFLO0VBQUVDLENBQUMsRUFBRTtBQUFNLENBQUMsRUFDdEI7RUFBRUQsQ0FBQyxF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