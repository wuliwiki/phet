// Copyright 2016-2023, University of Colorado Boulder

/**
 * View components that are specific to a scene in both the 'Shopping' and 'Shopping Lab' screens.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import merge from '../../../../phet-core/js/merge.js';
import ResetButton from '../../../../scenery-phet/js/buttons/ResetButton.js';
import { Node } from '../../../../scenery/js/imports.js';
import URColors from '../../common/URColors.js';
import URConstants from '../../common/URConstants.js';
import URQueryParameters from '../../common/URQueryParameters.js';
import DoubleNumberLineAccordionBox from '../../common/view/DoubleNumberLineAccordionBox.js';
import unitRates from '../../unitRates.js';
import BagNode from './BagNode.js';
import RowOfMovablesNode from './RowOfMovablesNode.js';
import ScaleNode from './ScaleNode.js';
import ShelfNode from './ShelfNode.js';
import ShoppingItemNode from './ShoppingItemNode.js';
export default class BaseShoppingSceneNode extends Node {
  /**
   * @param {ShoppingScene} shoppingScene
   * @param {Bounds2} layoutBounds
   * @param {KeypadLayer} keypadLayer
   * @param {ShoppingViewProperties} viewProperties
   * @param {Object} [options]
   */
  constructor(shoppingScene, layoutBounds, keypadLayer, viewProperties, options) {
    options = merge({
      extraCostDecimalVisible: false // {boolean} does the scale show an extra decimal place for cost?
    }, options);

    // Double number line, dispose required
    const doubleNumberLineAccordionBox = new DoubleNumberLineAccordionBox(shoppingScene.doubleNumberLine, shoppingScene.markerEditor, keypadLayer, {
      axisViewLength: URConstants.SHOPPING_AXIS_LENGTH,
      expandedProperty: viewProperties.doubleNumberLineExpandedProperty,
      left: layoutBounds.minX + URConstants.SCREEN_X_MARGIN,
      top: layoutBounds.minY + URConstants.SCREEN_Y_MARGIN
    });

    // shelf, dispose required
    const shelfNode = new ShelfNode(shoppingScene.shelf);

    // scale, dispose required
    const scaleNode = new ScaleNode(shoppingScene.scale, {
      costExpandedProperty: viewProperties.scaleCostExpandedProperty,
      extraCostDecimalVisible: options.extraCostDecimalVisible,
      quantityIsDisplayed: shoppingScene.scaleQuantityIsDisplayed
    });

    // button that resets the shelf to its initial state
    const resetShelfButton = new ResetButton({
      listener: () => {
        dragLayer.interruptSubtreeInput();
        shoppingScene.resetShelfAndScale();
      },
      baseColor: URColors.resetShelfButton,
      scale: 0.65,
      touchAreaDilation: 5,
      right: scaleNode.left,
      top: scaleNode.bottom + 20
    });

    // Disable the button when all bags are on the shelf
    const numberOfBagsObserver = numberOfBags => {
      resetShelfButton.enabled = numberOfBags !== shoppingScene.numberOfBags;
    };
    shoppingScene.shelf.numberOfBagsProperty.link(numberOfBagsObserver); // unlink in dispose

    // layers for bags and items
    const dragLayer = new Node(); // all Nodes are in this layer while being dragged
    const bagLayer = new Node(); // the row of bags
    const frontItemLayer = new Node(); // the front row of items
    const backItemLayer = new Node(); // the back row of items

    // bags and items, dispose required
    const bagNodes = [];
    const itemNodes = [];
    let bagsOpen = false;
    shoppingScene.bags.forEach(bag => {
      // create the bag's Node, put it in the bag layer
      const bagNode = new BagNode(bag, shoppingScene.shelf, shoppingScene.scale, bagLayer, dragLayer);
      bagNodes.push(bagNode);
      bagLayer.addChild(bagNode);

      // optional items in the bag
      if (bag.items) {
        bagsOpen = true;
        bag.items.forEach(item => {
          // Create the item's Node. Adds itself to the proper layer, so there is no addChild here.
          const itemNode = new ShoppingItemNode(item, shoppingScene.shelf, shoppingScene.scale, frontItemLayer, backItemLayer, dragLayer);
          itemNodes.push(itemNode);
        });
      }
    });
    assert && assert(!options.children, 'decoration not supported');
    options.children = [doubleNumberLineAccordionBox, scaleNode, shelfNode, resetShelfButton, bagLayer, backItemLayer, frontItemLayer, dragLayer];
    super(options);

    // Debug: show the cells that bags and items can occupy on the shelf and scale
    if (URQueryParameters.showCells) {
      // cells for bags
      const bagRowOptions = {
        stroke: 'green'
      };
      this.addChild(new RowOfMovablesNode(shoppingScene.shelf.bagRow, bagRowOptions));
      this.addChild(new RowOfMovablesNode(shoppingScene.scale.bagRow, bagRowOptions));

      // cells for items
      if (bagsOpen) {
        const itemRowOptions = {
          stroke: 'blue'
        };
        this.addChild(new RowOfMovablesNode(shoppingScene.shelf.backItemRow, itemRowOptions));
        this.addChild(new RowOfMovablesNode(shoppingScene.shelf.frontItemRow, itemRowOptions));
        this.addChild(new RowOfMovablesNode(shoppingScene.scale.backItemRow, itemRowOptions));
        this.addChild(new RowOfMovablesNode(shoppingScene.scale.frontItemRow, itemRowOptions));
      }
    }

    // @private
    this.disposeBaseShoppingSceneNode = () => {
      shoppingScene.shelf.numberOfBagsProperty.unlink(numberOfBagsObserver);
      doubleNumberLineAccordionBox.dispose();
      shelfNode.dispose();
      scaleNode.dispose();
      bagNodes.forEach(node => node.dispose());
      itemNodes.forEach(node => node.dispose());
    };

    // @private
    this.dragLayer = dragLayer;

    // @protected for layout in subtypes
    this.doubleNumberLineAccordionBox = doubleNumberLineAccordionBox;
  }

  /**
   * @public
   * @override
   */
  dispose() {
    this.disposeBaseShoppingSceneNode();
    super.dispose();
  }
}
unitRates.register('BaseShoppingSceneNode', BaseShoppingSceneNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtZXJnZSIsIlJlc2V0QnV0dG9uIiwiTm9kZSIsIlVSQ29sb3JzIiwiVVJDb25zdGFudHMiLCJVUlF1ZXJ5UGFyYW1ldGVycyIsIkRvdWJsZU51bWJlckxpbmVBY2NvcmRpb25Cb3giLCJ1bml0UmF0ZXMiLCJCYWdOb2RlIiwiUm93T2ZNb3ZhYmxlc05vZGUiLCJTY2FsZU5vZGUiLCJTaGVsZk5vZGUiLCJTaG9wcGluZ0l0ZW1Ob2RlIiwiQmFzZVNob3BwaW5nU2NlbmVOb2RlIiwiY29uc3RydWN0b3IiLCJzaG9wcGluZ1NjZW5lIiwibGF5b3V0Qm91bmRzIiwia2V5cGFkTGF5ZXIiLCJ2aWV3UHJvcGVydGllcyIsIm9wdGlvbnMiLCJleHRyYUNvc3REZWNpbWFsVmlzaWJsZSIsImRvdWJsZU51bWJlckxpbmVBY2NvcmRpb25Cb3giLCJkb3VibGVOdW1iZXJMaW5lIiwibWFya2VyRWRpdG9yIiwiYXhpc1ZpZXdMZW5ndGgiLCJTSE9QUElOR19BWElTX0xFTkdUSCIsImV4cGFuZGVkUHJvcGVydHkiLCJkb3VibGVOdW1iZXJMaW5lRXhwYW5kZWRQcm9wZXJ0eSIsImxlZnQiLCJtaW5YIiwiU0NSRUVOX1hfTUFSR0lOIiwidG9wIiwibWluWSIsIlNDUkVFTl9ZX01BUkdJTiIsInNoZWxmTm9kZSIsInNoZWxmIiwic2NhbGVOb2RlIiwic2NhbGUiLCJjb3N0RXhwYW5kZWRQcm9wZXJ0eSIsInNjYWxlQ29zdEV4cGFuZGVkUHJvcGVydHkiLCJxdWFudGl0eUlzRGlzcGxheWVkIiwic2NhbGVRdWFudGl0eUlzRGlzcGxheWVkIiwicmVzZXRTaGVsZkJ1dHRvbiIsImxpc3RlbmVyIiwiZHJhZ0xheWVyIiwiaW50ZXJydXB0U3VidHJlZUlucHV0IiwicmVzZXRTaGVsZkFuZFNjYWxlIiwiYmFzZUNvbG9yIiwidG91Y2hBcmVhRGlsYXRpb24iLCJyaWdodCIsImJvdHRvbSIsIm51bWJlck9mQmFnc09ic2VydmVyIiwibnVtYmVyT2ZCYWdzIiwiZW5hYmxlZCIsIm51bWJlck9mQmFnc1Byb3BlcnR5IiwibGluayIsImJhZ0xheWVyIiwiZnJvbnRJdGVtTGF5ZXIiLCJiYWNrSXRlbUxheWVyIiwiYmFnTm9kZXMiLCJpdGVtTm9kZXMiLCJiYWdzT3BlbiIsImJhZ3MiLCJmb3JFYWNoIiwiYmFnIiwiYmFnTm9kZSIsInB1c2giLCJhZGRDaGlsZCIsIml0ZW1zIiwiaXRlbSIsIml0ZW1Ob2RlIiwiYXNzZXJ0IiwiY2hpbGRyZW4iLCJzaG93Q2VsbHMiLCJiYWdSb3dPcHRpb25zIiwic3Ryb2tlIiwiYmFnUm93IiwiaXRlbVJvd09wdGlvbnMiLCJiYWNrSXRlbVJvdyIsImZyb250SXRlbVJvdyIsImRpc3Bvc2VCYXNlU2hvcHBpbmdTY2VuZU5vZGUiLCJ1bmxpbmsiLCJkaXNwb3NlIiwibm9kZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiQmFzZVNob3BwaW5nU2NlbmVOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZpZXcgY29tcG9uZW50cyB0aGF0IGFyZSBzcGVjaWZpYyB0byBhIHNjZW5lIGluIGJvdGggdGhlICdTaG9wcGluZycgYW5kICdTaG9wcGluZyBMYWInIHNjcmVlbnMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBSZXNldEJ1dHRvbiBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvYnV0dG9ucy9SZXNldEJ1dHRvbi5qcyc7XHJcbmltcG9ydCB7IE5vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVVJDb2xvcnMgZnJvbSAnLi4vLi4vY29tbW9uL1VSQ29sb3JzLmpzJztcclxuaW1wb3J0IFVSQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9VUkNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBVUlF1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi9jb21tb24vVVJRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgRG91YmxlTnVtYmVyTGluZUFjY29yZGlvbkJveCBmcm9tICcuLi8uLi9jb21tb24vdmlldy9Eb3VibGVOdW1iZXJMaW5lQWNjb3JkaW9uQm94LmpzJztcclxuaW1wb3J0IHVuaXRSYXRlcyBmcm9tICcuLi8uLi91bml0UmF0ZXMuanMnO1xyXG5pbXBvcnQgQmFnTm9kZSBmcm9tICcuL0JhZ05vZGUuanMnO1xyXG5pbXBvcnQgUm93T2ZNb3ZhYmxlc05vZGUgZnJvbSAnLi9Sb3dPZk1vdmFibGVzTm9kZS5qcyc7XHJcbmltcG9ydCBTY2FsZU5vZGUgZnJvbSAnLi9TY2FsZU5vZGUuanMnO1xyXG5pbXBvcnQgU2hlbGZOb2RlIGZyb20gJy4vU2hlbGZOb2RlLmpzJztcclxuaW1wb3J0IFNob3BwaW5nSXRlbU5vZGUgZnJvbSAnLi9TaG9wcGluZ0l0ZW1Ob2RlLmpzJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJhc2VTaG9wcGluZ1NjZW5lTm9kZSBleHRlbmRzIE5vZGUge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7U2hvcHBpbmdTY2VuZX0gc2hvcHBpbmdTY2VuZVxyXG4gICAqIEBwYXJhbSB7Qm91bmRzMn0gbGF5b3V0Qm91bmRzXHJcbiAgICogQHBhcmFtIHtLZXlwYWRMYXllcn0ga2V5cGFkTGF5ZXJcclxuICAgKiBAcGFyYW0ge1Nob3BwaW5nVmlld1Byb3BlcnRpZXN9IHZpZXdQcm9wZXJ0aWVzXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBzaG9wcGluZ1NjZW5lLCBsYXlvdXRCb3VuZHMsIGtleXBhZExheWVyLCB2aWV3UHJvcGVydGllcywgb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuICAgICAgZXh0cmFDb3N0RGVjaW1hbFZpc2libGU6IGZhbHNlIC8vIHtib29sZWFufSBkb2VzIHRoZSBzY2FsZSBzaG93IGFuIGV4dHJhIGRlY2ltYWwgcGxhY2UgZm9yIGNvc3Q/XHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gRG91YmxlIG51bWJlciBsaW5lLCBkaXNwb3NlIHJlcXVpcmVkXHJcbiAgICBjb25zdCBkb3VibGVOdW1iZXJMaW5lQWNjb3JkaW9uQm94ID0gbmV3IERvdWJsZU51bWJlckxpbmVBY2NvcmRpb25Cb3goIHNob3BwaW5nU2NlbmUuZG91YmxlTnVtYmVyTGluZSwgc2hvcHBpbmdTY2VuZS5tYXJrZXJFZGl0b3IsIGtleXBhZExheWVyLCB7XHJcbiAgICAgIGF4aXNWaWV3TGVuZ3RoOiBVUkNvbnN0YW50cy5TSE9QUElOR19BWElTX0xFTkdUSCxcclxuICAgICAgZXhwYW5kZWRQcm9wZXJ0eTogdmlld1Byb3BlcnRpZXMuZG91YmxlTnVtYmVyTGluZUV4cGFuZGVkUHJvcGVydHksXHJcbiAgICAgIGxlZnQ6IGxheW91dEJvdW5kcy5taW5YICsgVVJDb25zdGFudHMuU0NSRUVOX1hfTUFSR0lOLFxyXG4gICAgICB0b3A6IGxheW91dEJvdW5kcy5taW5ZICsgVVJDb25zdGFudHMuU0NSRUVOX1lfTUFSR0lOXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gc2hlbGYsIGRpc3Bvc2UgcmVxdWlyZWRcclxuICAgIGNvbnN0IHNoZWxmTm9kZSA9IG5ldyBTaGVsZk5vZGUoIHNob3BwaW5nU2NlbmUuc2hlbGYgKTtcclxuXHJcbiAgICAvLyBzY2FsZSwgZGlzcG9zZSByZXF1aXJlZFxyXG4gICAgY29uc3Qgc2NhbGVOb2RlID0gbmV3IFNjYWxlTm9kZSggc2hvcHBpbmdTY2VuZS5zY2FsZSwge1xyXG4gICAgICBjb3N0RXhwYW5kZWRQcm9wZXJ0eTogdmlld1Byb3BlcnRpZXMuc2NhbGVDb3N0RXhwYW5kZWRQcm9wZXJ0eSxcclxuICAgICAgZXh0cmFDb3N0RGVjaW1hbFZpc2libGU6IG9wdGlvbnMuZXh0cmFDb3N0RGVjaW1hbFZpc2libGUsXHJcbiAgICAgIHF1YW50aXR5SXNEaXNwbGF5ZWQ6IHNob3BwaW5nU2NlbmUuc2NhbGVRdWFudGl0eUlzRGlzcGxheWVkXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gYnV0dG9uIHRoYXQgcmVzZXRzIHRoZSBzaGVsZiB0byBpdHMgaW5pdGlhbCBzdGF0ZVxyXG4gICAgY29uc3QgcmVzZXRTaGVsZkJ1dHRvbiA9IG5ldyBSZXNldEJ1dHRvbigge1xyXG4gICAgICBsaXN0ZW5lcjogKCkgPT4ge1xyXG4gICAgICAgIGRyYWdMYXllci5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKTtcclxuICAgICAgICBzaG9wcGluZ1NjZW5lLnJlc2V0U2hlbGZBbmRTY2FsZSgpO1xyXG4gICAgICB9LFxyXG4gICAgICBiYXNlQ29sb3I6IFVSQ29sb3JzLnJlc2V0U2hlbGZCdXR0b24sXHJcbiAgICAgIHNjYWxlOiAwLjY1LFxyXG4gICAgICB0b3VjaEFyZWFEaWxhdGlvbjogNSxcclxuICAgICAgcmlnaHQ6IHNjYWxlTm9kZS5sZWZ0LFxyXG4gICAgICB0b3A6IHNjYWxlTm9kZS5ib3R0b20gKyAyMFxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIERpc2FibGUgdGhlIGJ1dHRvbiB3aGVuIGFsbCBiYWdzIGFyZSBvbiB0aGUgc2hlbGZcclxuICAgIGNvbnN0IG51bWJlck9mQmFnc09ic2VydmVyID0gbnVtYmVyT2ZCYWdzID0+IHtcclxuICAgICAgcmVzZXRTaGVsZkJ1dHRvbi5lbmFibGVkID0gKCBudW1iZXJPZkJhZ3MgIT09IHNob3BwaW5nU2NlbmUubnVtYmVyT2ZCYWdzICk7XHJcbiAgICB9O1xyXG4gICAgc2hvcHBpbmdTY2VuZS5zaGVsZi5udW1iZXJPZkJhZ3NQcm9wZXJ0eS5saW5rKCBudW1iZXJPZkJhZ3NPYnNlcnZlciApOyAvLyB1bmxpbmsgaW4gZGlzcG9zZVxyXG5cclxuICAgIC8vIGxheWVycyBmb3IgYmFncyBhbmQgaXRlbXNcclxuICAgIGNvbnN0IGRyYWdMYXllciA9IG5ldyBOb2RlKCk7IC8vIGFsbCBOb2RlcyBhcmUgaW4gdGhpcyBsYXllciB3aGlsZSBiZWluZyBkcmFnZ2VkXHJcbiAgICBjb25zdCBiYWdMYXllciA9IG5ldyBOb2RlKCk7ICAvLyB0aGUgcm93IG9mIGJhZ3NcclxuICAgIGNvbnN0IGZyb250SXRlbUxheWVyID0gbmV3IE5vZGUoKTsgLy8gdGhlIGZyb250IHJvdyBvZiBpdGVtc1xyXG4gICAgY29uc3QgYmFja0l0ZW1MYXllciA9IG5ldyBOb2RlKCk7IC8vIHRoZSBiYWNrIHJvdyBvZiBpdGVtc1xyXG5cclxuICAgIC8vIGJhZ3MgYW5kIGl0ZW1zLCBkaXNwb3NlIHJlcXVpcmVkXHJcbiAgICBjb25zdCBiYWdOb2RlcyA9IFtdO1xyXG4gICAgY29uc3QgaXRlbU5vZGVzID0gW107XHJcbiAgICBsZXQgYmFnc09wZW4gPSBmYWxzZTtcclxuICAgIHNob3BwaW5nU2NlbmUuYmFncy5mb3JFYWNoKCBiYWcgPT4ge1xyXG5cclxuICAgICAgLy8gY3JlYXRlIHRoZSBiYWcncyBOb2RlLCBwdXQgaXQgaW4gdGhlIGJhZyBsYXllclxyXG4gICAgICBjb25zdCBiYWdOb2RlID0gbmV3IEJhZ05vZGUoIGJhZywgc2hvcHBpbmdTY2VuZS5zaGVsZiwgc2hvcHBpbmdTY2VuZS5zY2FsZSwgYmFnTGF5ZXIsIGRyYWdMYXllciApO1xyXG4gICAgICBiYWdOb2Rlcy5wdXNoKCBiYWdOb2RlICk7XHJcbiAgICAgIGJhZ0xheWVyLmFkZENoaWxkKCBiYWdOb2RlICk7XHJcblxyXG4gICAgICAvLyBvcHRpb25hbCBpdGVtcyBpbiB0aGUgYmFnXHJcbiAgICAgIGlmICggYmFnLml0ZW1zICkge1xyXG4gICAgICAgIGJhZ3NPcGVuID0gdHJ1ZTtcclxuICAgICAgICBiYWcuaXRlbXMuZm9yRWFjaCggaXRlbSA9PiB7XHJcblxyXG4gICAgICAgICAgLy8gQ3JlYXRlIHRoZSBpdGVtJ3MgTm9kZS4gQWRkcyBpdHNlbGYgdG8gdGhlIHByb3BlciBsYXllciwgc28gdGhlcmUgaXMgbm8gYWRkQ2hpbGQgaGVyZS5cclxuICAgICAgICAgIGNvbnN0IGl0ZW1Ob2RlID0gbmV3IFNob3BwaW5nSXRlbU5vZGUoIGl0ZW0sIHNob3BwaW5nU2NlbmUuc2hlbGYsIHNob3BwaW5nU2NlbmUuc2NhbGUsXHJcbiAgICAgICAgICAgIGZyb250SXRlbUxheWVyLCBiYWNrSXRlbUxheWVyLCBkcmFnTGF5ZXIgKTtcclxuICAgICAgICAgIGl0ZW1Ob2Rlcy5wdXNoKCBpdGVtTm9kZSApO1xyXG4gICAgICAgIH0gKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICFvcHRpb25zLmNoaWxkcmVuLCAnZGVjb3JhdGlvbiBub3Qgc3VwcG9ydGVkJyApO1xyXG4gICAgb3B0aW9ucy5jaGlsZHJlbiA9IFtcclxuICAgICAgZG91YmxlTnVtYmVyTGluZUFjY29yZGlvbkJveCwgc2NhbGVOb2RlLCBzaGVsZk5vZGUsIHJlc2V0U2hlbGZCdXR0b24sXHJcbiAgICAgIGJhZ0xheWVyLCBiYWNrSXRlbUxheWVyLCBmcm9udEl0ZW1MYXllciwgZHJhZ0xheWVyXHJcbiAgICBdO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gRGVidWc6IHNob3cgdGhlIGNlbGxzIHRoYXQgYmFncyBhbmQgaXRlbXMgY2FuIG9jY3VweSBvbiB0aGUgc2hlbGYgYW5kIHNjYWxlXHJcbiAgICBpZiAoIFVSUXVlcnlQYXJhbWV0ZXJzLnNob3dDZWxscyApIHtcclxuXHJcbiAgICAgIC8vIGNlbGxzIGZvciBiYWdzXHJcbiAgICAgIGNvbnN0IGJhZ1Jvd09wdGlvbnMgPSB7IHN0cm9rZTogJ2dyZWVuJyB9O1xyXG4gICAgICB0aGlzLmFkZENoaWxkKCBuZXcgUm93T2ZNb3ZhYmxlc05vZGUoIHNob3BwaW5nU2NlbmUuc2hlbGYuYmFnUm93LCBiYWdSb3dPcHRpb25zICkgKTtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggbmV3IFJvd09mTW92YWJsZXNOb2RlKCBzaG9wcGluZ1NjZW5lLnNjYWxlLmJhZ1JvdywgYmFnUm93T3B0aW9ucyApICk7XHJcblxyXG4gICAgICAvLyBjZWxscyBmb3IgaXRlbXNcclxuICAgICAgaWYgKCBiYWdzT3BlbiApIHtcclxuICAgICAgICBjb25zdCBpdGVtUm93T3B0aW9ucyA9IHsgc3Ryb2tlOiAnYmx1ZScgfTtcclxuICAgICAgICB0aGlzLmFkZENoaWxkKCBuZXcgUm93T2ZNb3ZhYmxlc05vZGUoIHNob3BwaW5nU2NlbmUuc2hlbGYuYmFja0l0ZW1Sb3csIGl0ZW1Sb3dPcHRpb25zICkgKTtcclxuICAgICAgICB0aGlzLmFkZENoaWxkKCBuZXcgUm93T2ZNb3ZhYmxlc05vZGUoIHNob3BwaW5nU2NlbmUuc2hlbGYuZnJvbnRJdGVtUm93LCBpdGVtUm93T3B0aW9ucyApICk7XHJcbiAgICAgICAgdGhpcy5hZGRDaGlsZCggbmV3IFJvd09mTW92YWJsZXNOb2RlKCBzaG9wcGluZ1NjZW5lLnNjYWxlLmJhY2tJdGVtUm93LCBpdGVtUm93T3B0aW9ucyApICk7XHJcbiAgICAgICAgdGhpcy5hZGRDaGlsZCggbmV3IFJvd09mTW92YWJsZXNOb2RlKCBzaG9wcGluZ1NjZW5lLnNjYWxlLmZyb250SXRlbVJvdywgaXRlbVJvd09wdGlvbnMgKSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuZGlzcG9zZUJhc2VTaG9wcGluZ1NjZW5lTm9kZSA9ICgpID0+IHtcclxuXHJcbiAgICAgIHNob3BwaW5nU2NlbmUuc2hlbGYubnVtYmVyT2ZCYWdzUHJvcGVydHkudW5saW5rKCBudW1iZXJPZkJhZ3NPYnNlcnZlciApO1xyXG5cclxuICAgICAgZG91YmxlTnVtYmVyTGluZUFjY29yZGlvbkJveC5kaXNwb3NlKCk7XHJcbiAgICAgIHNoZWxmTm9kZS5kaXNwb3NlKCk7XHJcbiAgICAgIHNjYWxlTm9kZS5kaXNwb3NlKCk7XHJcbiAgICAgIGJhZ05vZGVzLmZvckVhY2goIG5vZGUgPT4gbm9kZS5kaXNwb3NlKCkgKTtcclxuICAgICAgaXRlbU5vZGVzLmZvckVhY2goIG5vZGUgPT4gbm9kZS5kaXNwb3NlKCkgKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuZHJhZ0xheWVyID0gZHJhZ0xheWVyO1xyXG5cclxuICAgIC8vIEBwcm90ZWN0ZWQgZm9yIGxheW91dCBpbiBzdWJ0eXBlc1xyXG4gICAgdGhpcy5kb3VibGVOdW1iZXJMaW5lQWNjb3JkaW9uQm94ID0gZG91YmxlTnVtYmVyTGluZUFjY29yZGlvbkJveDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy5kaXNwb3NlQmFzZVNob3BwaW5nU2NlbmVOb2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG51bml0UmF0ZXMucmVnaXN0ZXIoICdCYXNlU2hvcHBpbmdTY2VuZU5vZGUnLCBCYXNlU2hvcHBpbmdTY2VuZU5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxXQUFXLE1BQU0sb0RBQW9EO0FBQzVFLFNBQVNDLElBQUksUUFBUSxtQ0FBbUM7QUFDeEQsT0FBT0MsUUFBUSxNQUFNLDBCQUEwQjtBQUMvQyxPQUFPQyxXQUFXLE1BQU0sNkJBQTZCO0FBQ3JELE9BQU9DLGlCQUFpQixNQUFNLG1DQUFtQztBQUNqRSxPQUFPQyw0QkFBNEIsTUFBTSxtREFBbUQ7QUFDNUYsT0FBT0MsU0FBUyxNQUFNLG9CQUFvQjtBQUMxQyxPQUFPQyxPQUFPLE1BQU0sY0FBYztBQUNsQyxPQUFPQyxpQkFBaUIsTUFBTSx3QkFBd0I7QUFDdEQsT0FBT0MsU0FBUyxNQUFNLGdCQUFnQjtBQUN0QyxPQUFPQyxTQUFTLE1BQU0sZ0JBQWdCO0FBQ3RDLE9BQU9DLGdCQUFnQixNQUFNLHVCQUF1QjtBQUVwRCxlQUFlLE1BQU1DLHFCQUFxQixTQUFTWCxJQUFJLENBQUM7RUFDdEQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRVksV0FBV0EsQ0FBRUMsYUFBYSxFQUFFQyxZQUFZLEVBQUVDLFdBQVcsRUFBRUMsY0FBYyxFQUFFQyxPQUFPLEVBQUc7SUFFL0VBLE9BQU8sR0FBR25CLEtBQUssQ0FBRTtNQUNmb0IsdUJBQXVCLEVBQUUsS0FBSyxDQUFDO0lBQ2pDLENBQUMsRUFBRUQsT0FBUSxDQUFDOztJQUVaO0lBQ0EsTUFBTUUsNEJBQTRCLEdBQUcsSUFBSWYsNEJBQTRCLENBQUVTLGFBQWEsQ0FBQ08sZ0JBQWdCLEVBQUVQLGFBQWEsQ0FBQ1EsWUFBWSxFQUFFTixXQUFXLEVBQUU7TUFDOUlPLGNBQWMsRUFBRXBCLFdBQVcsQ0FBQ3FCLG9CQUFvQjtNQUNoREMsZ0JBQWdCLEVBQUVSLGNBQWMsQ0FBQ1MsZ0NBQWdDO01BQ2pFQyxJQUFJLEVBQUVaLFlBQVksQ0FBQ2EsSUFBSSxHQUFHekIsV0FBVyxDQUFDMEIsZUFBZTtNQUNyREMsR0FBRyxFQUFFZixZQUFZLENBQUNnQixJQUFJLEdBQUc1QixXQUFXLENBQUM2QjtJQUN2QyxDQUFFLENBQUM7O0lBRUg7SUFDQSxNQUFNQyxTQUFTLEdBQUcsSUFBSXZCLFNBQVMsQ0FBRUksYUFBYSxDQUFDb0IsS0FBTSxDQUFDOztJQUV0RDtJQUNBLE1BQU1DLFNBQVMsR0FBRyxJQUFJMUIsU0FBUyxDQUFFSyxhQUFhLENBQUNzQixLQUFLLEVBQUU7TUFDcERDLG9CQUFvQixFQUFFcEIsY0FBYyxDQUFDcUIseUJBQXlCO01BQzlEbkIsdUJBQXVCLEVBQUVELE9BQU8sQ0FBQ0MsdUJBQXVCO01BQ3hEb0IsbUJBQW1CLEVBQUV6QixhQUFhLENBQUMwQjtJQUNyQyxDQUFFLENBQUM7O0lBRUg7SUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxJQUFJekMsV0FBVyxDQUFFO01BQ3hDMEMsUUFBUSxFQUFFQSxDQUFBLEtBQU07UUFDZEMsU0FBUyxDQUFDQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2pDOUIsYUFBYSxDQUFDK0Isa0JBQWtCLENBQUMsQ0FBQztNQUNwQyxDQUFDO01BQ0RDLFNBQVMsRUFBRTVDLFFBQVEsQ0FBQ3VDLGdCQUFnQjtNQUNwQ0wsS0FBSyxFQUFFLElBQUk7TUFDWFcsaUJBQWlCLEVBQUUsQ0FBQztNQUNwQkMsS0FBSyxFQUFFYixTQUFTLENBQUNSLElBQUk7TUFDckJHLEdBQUcsRUFBRUssU0FBUyxDQUFDYyxNQUFNLEdBQUc7SUFDMUIsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTUMsb0JBQW9CLEdBQUdDLFlBQVksSUFBSTtNQUMzQ1YsZ0JBQWdCLENBQUNXLE9BQU8sR0FBS0QsWUFBWSxLQUFLckMsYUFBYSxDQUFDcUMsWUFBYztJQUM1RSxDQUFDO0lBQ0RyQyxhQUFhLENBQUNvQixLQUFLLENBQUNtQixvQkFBb0IsQ0FBQ0MsSUFBSSxDQUFFSixvQkFBcUIsQ0FBQyxDQUFDLENBQUM7O0lBRXZFO0lBQ0EsTUFBTVAsU0FBUyxHQUFHLElBQUkxQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUIsTUFBTXNELFFBQVEsR0FBRyxJQUFJdEQsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFFO0lBQzlCLE1BQU11RCxjQUFjLEdBQUcsSUFBSXZELElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuQyxNQUFNd0QsYUFBYSxHQUFHLElBQUl4RCxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7O0lBRWxDO0lBQ0EsTUFBTXlELFFBQVEsR0FBRyxFQUFFO0lBQ25CLE1BQU1DLFNBQVMsR0FBRyxFQUFFO0lBQ3BCLElBQUlDLFFBQVEsR0FBRyxLQUFLO0lBQ3BCOUMsYUFBYSxDQUFDK0MsSUFBSSxDQUFDQyxPQUFPLENBQUVDLEdBQUcsSUFBSTtNQUVqQztNQUNBLE1BQU1DLE9BQU8sR0FBRyxJQUFJekQsT0FBTyxDQUFFd0QsR0FBRyxFQUFFakQsYUFBYSxDQUFDb0IsS0FBSyxFQUFFcEIsYUFBYSxDQUFDc0IsS0FBSyxFQUFFbUIsUUFBUSxFQUFFWixTQUFVLENBQUM7TUFDakdlLFFBQVEsQ0FBQ08sSUFBSSxDQUFFRCxPQUFRLENBQUM7TUFDeEJULFFBQVEsQ0FBQ1csUUFBUSxDQUFFRixPQUFRLENBQUM7O01BRTVCO01BQ0EsSUFBS0QsR0FBRyxDQUFDSSxLQUFLLEVBQUc7UUFDZlAsUUFBUSxHQUFHLElBQUk7UUFDZkcsR0FBRyxDQUFDSSxLQUFLLENBQUNMLE9BQU8sQ0FBRU0sSUFBSSxJQUFJO1VBRXpCO1VBQ0EsTUFBTUMsUUFBUSxHQUFHLElBQUkxRCxnQkFBZ0IsQ0FBRXlELElBQUksRUFBRXRELGFBQWEsQ0FBQ29CLEtBQUssRUFBRXBCLGFBQWEsQ0FBQ3NCLEtBQUssRUFDbkZvQixjQUFjLEVBQUVDLGFBQWEsRUFBRWQsU0FBVSxDQUFDO1VBQzVDZ0IsU0FBUyxDQUFDTSxJQUFJLENBQUVJLFFBQVMsQ0FBQztRQUM1QixDQUFFLENBQUM7TUFDTDtJQUNGLENBQUUsQ0FBQztJQUVIQyxNQUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDcEQsT0FBTyxDQUFDcUQsUUFBUSxFQUFFLDBCQUEyQixDQUFDO0lBQ2pFckQsT0FBTyxDQUFDcUQsUUFBUSxHQUFHLENBQ2pCbkQsNEJBQTRCLEVBQUVlLFNBQVMsRUFBRUYsU0FBUyxFQUFFUSxnQkFBZ0IsRUFDcEVjLFFBQVEsRUFBRUUsYUFBYSxFQUFFRCxjQUFjLEVBQUViLFNBQVMsQ0FDbkQ7SUFFRCxLQUFLLENBQUV6QixPQUFRLENBQUM7O0lBRWhCO0lBQ0EsSUFBS2QsaUJBQWlCLENBQUNvRSxTQUFTLEVBQUc7TUFFakM7TUFDQSxNQUFNQyxhQUFhLEdBQUc7UUFBRUMsTUFBTSxFQUFFO01BQVEsQ0FBQztNQUN6QyxJQUFJLENBQUNSLFFBQVEsQ0FBRSxJQUFJMUQsaUJBQWlCLENBQUVNLGFBQWEsQ0FBQ29CLEtBQUssQ0FBQ3lDLE1BQU0sRUFBRUYsYUFBYyxDQUFFLENBQUM7TUFDbkYsSUFBSSxDQUFDUCxRQUFRLENBQUUsSUFBSTFELGlCQUFpQixDQUFFTSxhQUFhLENBQUNzQixLQUFLLENBQUN1QyxNQUFNLEVBQUVGLGFBQWMsQ0FBRSxDQUFDOztNQUVuRjtNQUNBLElBQUtiLFFBQVEsRUFBRztRQUNkLE1BQU1nQixjQUFjLEdBQUc7VUFBRUYsTUFBTSxFQUFFO1FBQU8sQ0FBQztRQUN6QyxJQUFJLENBQUNSLFFBQVEsQ0FBRSxJQUFJMUQsaUJBQWlCLENBQUVNLGFBQWEsQ0FBQ29CLEtBQUssQ0FBQzJDLFdBQVcsRUFBRUQsY0FBZSxDQUFFLENBQUM7UUFDekYsSUFBSSxDQUFDVixRQUFRLENBQUUsSUFBSTFELGlCQUFpQixDQUFFTSxhQUFhLENBQUNvQixLQUFLLENBQUM0QyxZQUFZLEVBQUVGLGNBQWUsQ0FBRSxDQUFDO1FBQzFGLElBQUksQ0FBQ1YsUUFBUSxDQUFFLElBQUkxRCxpQkFBaUIsQ0FBRU0sYUFBYSxDQUFDc0IsS0FBSyxDQUFDeUMsV0FBVyxFQUFFRCxjQUFlLENBQUUsQ0FBQztRQUN6RixJQUFJLENBQUNWLFFBQVEsQ0FBRSxJQUFJMUQsaUJBQWlCLENBQUVNLGFBQWEsQ0FBQ3NCLEtBQUssQ0FBQzBDLFlBQVksRUFBRUYsY0FBZSxDQUFFLENBQUM7TUFDNUY7SUFDRjs7SUFFQTtJQUNBLElBQUksQ0FBQ0csNEJBQTRCLEdBQUcsTUFBTTtNQUV4Q2pFLGFBQWEsQ0FBQ29CLEtBQUssQ0FBQ21CLG9CQUFvQixDQUFDMkIsTUFBTSxDQUFFOUIsb0JBQXFCLENBQUM7TUFFdkU5Qiw0QkFBNEIsQ0FBQzZELE9BQU8sQ0FBQyxDQUFDO01BQ3RDaEQsU0FBUyxDQUFDZ0QsT0FBTyxDQUFDLENBQUM7TUFDbkI5QyxTQUFTLENBQUM4QyxPQUFPLENBQUMsQ0FBQztNQUNuQnZCLFFBQVEsQ0FBQ0ksT0FBTyxDQUFFb0IsSUFBSSxJQUFJQSxJQUFJLENBQUNELE9BQU8sQ0FBQyxDQUFFLENBQUM7TUFDMUN0QixTQUFTLENBQUNHLE9BQU8sQ0FBRW9CLElBQUksSUFBSUEsSUFBSSxDQUFDRCxPQUFPLENBQUMsQ0FBRSxDQUFDO0lBQzdDLENBQUM7O0lBRUQ7SUFDQSxJQUFJLENBQUN0QyxTQUFTLEdBQUdBLFNBQVM7O0lBRTFCO0lBQ0EsSUFBSSxDQUFDdkIsNEJBQTRCLEdBQUdBLDRCQUE0QjtFQUNsRTs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtFQUNFNkQsT0FBT0EsQ0FBQSxFQUFHO0lBQ1IsSUFBSSxDQUFDRiw0QkFBNEIsQ0FBQyxDQUFDO0lBQ25DLEtBQUssQ0FBQ0UsT0FBTyxDQUFDLENBQUM7RUFDakI7QUFDRjtBQUVBM0UsU0FBUyxDQUFDNkUsUUFBUSxDQUFFLHVCQUF1QixFQUFFdkUscUJBQXNCLENBQUMifQ==