// Copyright 2017-2022, University of Colorado Boulder

/**
 * View for GenericArea.
 *
 * NOTE: This type is designed to be persistent, and will not need to release references to avoid memory leaks.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Property from '../../../../axon/js/Property.js';
import ReadOnlyProperty from '../../../../axon/js/ReadOnlyProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Orientation from '../../../../phet-core/js/Orientation.js';
import { Line, Node } from '../../../../scenery/js/imports.js';
import areaModelCommon from '../../areaModelCommon.js';
import AreaModelCommonConstants from '../../common/AreaModelCommonConstants.js';
import AreaDisplayNode from '../../common/view/AreaDisplayNode.js';
import AreaModelCommonColors from '../../common/view/AreaModelCommonColors.js';
import PoolableLayerNode from '../../common/view/PoolableLayerNode.js';
import GenericPartitionedAreaNode from './GenericPartitionedAreaNode.js';
import PartitionSizeEditNode from './PartitionSizeEditNode.js';
import TermKeypadPanel from './TermKeypadPanel.js';
class GenericAreaDisplayNode extends AreaDisplayNode {
  /**
   * @param {GenericAreaDisplay} areaDisplay
   * @param {boolean} allowExponents - Whether the user is able to add powers of x.
   * @param {Property.<PartialProductsChoice>} partialProductsChoiceProperty
   * @param {Object} [nodeOptions]
   */
  constructor(areaDisplay, allowExponents, partialProductsChoiceProperty, nodeOptions) {
    assert && assert(typeof allowExponents === 'boolean');
    assert && assert(partialProductsChoiceProperty instanceof ReadOnlyProperty);
    super(areaDisplay, partialProductsChoiceProperty, {
      allowExponents: allowExponents,
      isProportional: false
    });
    this.areaLayer.addChild(this.backgroundNode);

    // Sign-colored partition area backgrounds (effectively pooled)
    this.areaLayer.addChild(new PoolableLayerNode({
      arrayProperty: areaDisplay.partitionedAreasProperty,
      createNode: partitionedArea => new GenericPartitionedAreaNode(new Property(partitionedArea), this.modelViewTransformProperty),
      getItemProperty: partitionedAreaNode => partitionedAreaNode.partitionedAreaProperty
    }));
    this.areaLayer.addChild(this.borderNode);

    // Partition lines
    this.areaLayer.addChild(GenericAreaDisplayNode.createPartitionLines(areaDisplay.layoutProperty, this.viewSize));

    // Edit readouts/buttons
    this.labelLayer.addChild(new PoolableLayerNode({
      arrayProperty: areaDisplay.allPartitionsProperty,
      createNode: partition => new PartitionSizeEditNode(areaDisplay.activePartitionProperty, new Property(partition), this.modelViewTransformProperty, allowExponents),
      getItemProperty: editNode => editNode.partitionProperty
    }));

    // Keypad
    const digitCountProperty = new DerivedProperty([areaDisplay.activePartitionProperty], activePartition => activePartition === null ? 1 : activePartition.digitCount);
    const termKeypadPanel = new TermKeypadPanel(digitCountProperty, allowExponents, true, term => {
      // Update the size of the partition.
      areaDisplay.activePartitionProperty.value.sizeProperty.value = term;

      // Hide the keypad.
      areaDisplay.activePartitionProperty.value = null;
    }, {
      x: this.viewSize + AreaModelCommonConstants.KEYPAD_LEFT_PADDING,
      centerY: this.viewSize / 2
    });
    this.labelLayer.addChild(termKeypadPanel);

    // If this changes, we clear and switch to it
    areaDisplay.activePartitionProperty.link(newArea => {
      termKeypadPanel.visible = newArea !== null;
      termKeypadPanel.clear();
    });
    this.mutate(nodeOptions);
  }

  /**
   * Positions all of the partial products labels.
   * @protected
   * @override
   */
  positionProductLabels() {
    this.productLabels.forEach(productLabel => {
      Orientation.enumeration.values.forEach(orientation => {
        const range = productLabel.partitionedAreaProperty.value.partitions.get(orientation).coordinateRangeProperty.value;
        if (range !== null) {
          productLabel[orientation.coordinate] = orientation.modelToView(this.modelViewTransformProperty.value, range.getCenter());
        }
      });
    });
  }

  /**
   * Creates a partition line (view only)
   * @private
   *
   * @param {Orientation} orientation
   * @param {number} offset
   * @param {number} viewSize - In view units, the size of the main area
   * @param {Property.<boolean>} visibilityProperty
   */
  static createPartitionLine(orientation, offset, viewSize, visibilityProperty) {
    const firstPoint = new Vector2(0, 0);
    const secondPoint = new Vector2(0, 0);
    firstPoint[orientation.coordinate] = offset;
    secondPoint[orientation.coordinate] = offset;
    firstPoint[orientation.opposite.coordinate] = viewSize;
    secondPoint[orientation.opposite.coordinate] = 0;
    const line = new Line({
      p1: firstPoint,
      p2: secondPoint,
      stroke: AreaModelCommonColors.partitionLineStrokeProperty
    });
    visibilityProperty.linkAttribute(line, 'visible');
    return line;
  }

  /**
   * Creates a set of generic partition lines.
   * @public
   *
   * @param {Property.<GenericLayout>} layoutProperty
   * @param {number} viewSize
   * @returns {Node}
   */
  static createPartitionLines(layoutProperty, viewSize) {
    const singleOffset = viewSize * AreaModelCommonConstants.GENERIC_SINGLE_OFFSET;
    const firstOffset = viewSize * AreaModelCommonConstants.GENERIC_FIRST_OFFSET;
    const secondOffset = viewSize * AreaModelCommonConstants.GENERIC_SECOND_OFFSET;
    const resultNode = new Node();
    Orientation.enumeration.values.forEach(orientation => {
      const hasTwoProperty = new DerivedProperty([layoutProperty], layout => layout.getPartitionQuantity(orientation) === 2);
      const hasThreeProperty = new DerivedProperty([layoutProperty], layout => layout.getPartitionQuantity(orientation) === 3);
      const singleLine = GenericAreaDisplayNode.createPartitionLine(orientation, singleOffset, viewSize, hasTwoProperty);
      const firstLine = GenericAreaDisplayNode.createPartitionLine(orientation, firstOffset, viewSize, hasThreeProperty);
      const secondLine = GenericAreaDisplayNode.createPartitionLine(orientation, secondOffset, viewSize, hasThreeProperty);
      resultNode.addChild(singleLine);
      resultNode.addChild(firstLine);
      resultNode.addChild(secondLine);
    });
    return resultNode;
  }
}
areaModelCommon.register('GenericAreaDisplayNode', GenericAreaDisplayNode);
export default GenericAreaDisplayNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJQcm9wZXJ0eSIsIlJlYWRPbmx5UHJvcGVydHkiLCJWZWN0b3IyIiwiT3JpZW50YXRpb24iLCJMaW5lIiwiTm9kZSIsImFyZWFNb2RlbENvbW1vbiIsIkFyZWFNb2RlbENvbW1vbkNvbnN0YW50cyIsIkFyZWFEaXNwbGF5Tm9kZSIsIkFyZWFNb2RlbENvbW1vbkNvbG9ycyIsIlBvb2xhYmxlTGF5ZXJOb2RlIiwiR2VuZXJpY1BhcnRpdGlvbmVkQXJlYU5vZGUiLCJQYXJ0aXRpb25TaXplRWRpdE5vZGUiLCJUZXJtS2V5cGFkUGFuZWwiLCJHZW5lcmljQXJlYURpc3BsYXlOb2RlIiwiY29uc3RydWN0b3IiLCJhcmVhRGlzcGxheSIsImFsbG93RXhwb25lbnRzIiwicGFydGlhbFByb2R1Y3RzQ2hvaWNlUHJvcGVydHkiLCJub2RlT3B0aW9ucyIsImFzc2VydCIsImlzUHJvcG9ydGlvbmFsIiwiYXJlYUxheWVyIiwiYWRkQ2hpbGQiLCJiYWNrZ3JvdW5kTm9kZSIsImFycmF5UHJvcGVydHkiLCJwYXJ0aXRpb25lZEFyZWFzUHJvcGVydHkiLCJjcmVhdGVOb2RlIiwicGFydGl0aW9uZWRBcmVhIiwibW9kZWxWaWV3VHJhbnNmb3JtUHJvcGVydHkiLCJnZXRJdGVtUHJvcGVydHkiLCJwYXJ0aXRpb25lZEFyZWFOb2RlIiwicGFydGl0aW9uZWRBcmVhUHJvcGVydHkiLCJib3JkZXJOb2RlIiwiY3JlYXRlUGFydGl0aW9uTGluZXMiLCJsYXlvdXRQcm9wZXJ0eSIsInZpZXdTaXplIiwibGFiZWxMYXllciIsImFsbFBhcnRpdGlvbnNQcm9wZXJ0eSIsInBhcnRpdGlvbiIsImFjdGl2ZVBhcnRpdGlvblByb3BlcnR5IiwiZWRpdE5vZGUiLCJwYXJ0aXRpb25Qcm9wZXJ0eSIsImRpZ2l0Q291bnRQcm9wZXJ0eSIsImFjdGl2ZVBhcnRpdGlvbiIsImRpZ2l0Q291bnQiLCJ0ZXJtS2V5cGFkUGFuZWwiLCJ0ZXJtIiwidmFsdWUiLCJzaXplUHJvcGVydHkiLCJ4IiwiS0VZUEFEX0xFRlRfUEFERElORyIsImNlbnRlclkiLCJsaW5rIiwibmV3QXJlYSIsInZpc2libGUiLCJjbGVhciIsIm11dGF0ZSIsInBvc2l0aW9uUHJvZHVjdExhYmVscyIsInByb2R1Y3RMYWJlbHMiLCJmb3JFYWNoIiwicHJvZHVjdExhYmVsIiwiZW51bWVyYXRpb24iLCJ2YWx1ZXMiLCJvcmllbnRhdGlvbiIsInJhbmdlIiwicGFydGl0aW9ucyIsImdldCIsImNvb3JkaW5hdGVSYW5nZVByb3BlcnR5IiwiY29vcmRpbmF0ZSIsIm1vZGVsVG9WaWV3IiwiZ2V0Q2VudGVyIiwiY3JlYXRlUGFydGl0aW9uTGluZSIsIm9mZnNldCIsInZpc2liaWxpdHlQcm9wZXJ0eSIsImZpcnN0UG9pbnQiLCJzZWNvbmRQb2ludCIsIm9wcG9zaXRlIiwibGluZSIsInAxIiwicDIiLCJzdHJva2UiLCJwYXJ0aXRpb25MaW5lU3Ryb2tlUHJvcGVydHkiLCJsaW5rQXR0cmlidXRlIiwic2luZ2xlT2Zmc2V0IiwiR0VORVJJQ19TSU5HTEVfT0ZGU0VUIiwiZmlyc3RPZmZzZXQiLCJHRU5FUklDX0ZJUlNUX09GRlNFVCIsInNlY29uZE9mZnNldCIsIkdFTkVSSUNfU0VDT05EX09GRlNFVCIsInJlc3VsdE5vZGUiLCJoYXNUd29Qcm9wZXJ0eSIsImxheW91dCIsImdldFBhcnRpdGlvblF1YW50aXR5IiwiaGFzVGhyZWVQcm9wZXJ0eSIsInNpbmdsZUxpbmUiLCJmaXJzdExpbmUiLCJzZWNvbmRMaW5lIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJHZW5lcmljQXJlYURpc3BsYXlOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFZpZXcgZm9yIEdlbmVyaWNBcmVhLlxyXG4gKlxyXG4gKiBOT1RFOiBUaGlzIHR5cGUgaXMgZGVzaWduZWQgdG8gYmUgcGVyc2lzdGVudCwgYW5kIHdpbGwgbm90IG5lZWQgdG8gcmVsZWFzZSByZWZlcmVuY2VzIHRvIGF2b2lkIG1lbW9yeSBsZWFrcy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IE9yaWVudGF0aW9uIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9PcmllbnRhdGlvbi5qcyc7XHJcbmltcG9ydCB7IExpbmUsIE5vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYXJlYU1vZGVsQ29tbW9uIGZyb20gJy4uLy4uL2FyZWFNb2RlbENvbW1vbi5qcyc7XHJcbmltcG9ydCBBcmVhTW9kZWxDb21tb25Db25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0FyZWFNb2RlbENvbW1vbkNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBBcmVhRGlzcGxheU5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvQXJlYURpc3BsYXlOb2RlLmpzJztcclxuaW1wb3J0IEFyZWFNb2RlbENvbW1vbkNvbG9ycyBmcm9tICcuLi8uLi9jb21tb24vdmlldy9BcmVhTW9kZWxDb21tb25Db2xvcnMuanMnO1xyXG5pbXBvcnQgUG9vbGFibGVMYXllck5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvUG9vbGFibGVMYXllck5vZGUuanMnO1xyXG5pbXBvcnQgR2VuZXJpY1BhcnRpdGlvbmVkQXJlYU5vZGUgZnJvbSAnLi9HZW5lcmljUGFydGl0aW9uZWRBcmVhTm9kZS5qcyc7XHJcbmltcG9ydCBQYXJ0aXRpb25TaXplRWRpdE5vZGUgZnJvbSAnLi9QYXJ0aXRpb25TaXplRWRpdE5vZGUuanMnO1xyXG5pbXBvcnQgVGVybUtleXBhZFBhbmVsIGZyb20gJy4vVGVybUtleXBhZFBhbmVsLmpzJztcclxuXHJcbmNsYXNzIEdlbmVyaWNBcmVhRGlzcGxheU5vZGUgZXh0ZW5kcyBBcmVhRGlzcGxheU5vZGUge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7R2VuZXJpY0FyZWFEaXNwbGF5fSBhcmVhRGlzcGxheVxyXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gYWxsb3dFeHBvbmVudHMgLSBXaGV0aGVyIHRoZSB1c2VyIGlzIGFibGUgdG8gYWRkIHBvd2VycyBvZiB4LlxyXG4gICAqIEBwYXJhbSB7UHJvcGVydHkuPFBhcnRpYWxQcm9kdWN0c0Nob2ljZT59IHBhcnRpYWxQcm9kdWN0c0Nob2ljZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtub2RlT3B0aW9uc11cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggYXJlYURpc3BsYXksIGFsbG93RXhwb25lbnRzLCBwYXJ0aWFsUHJvZHVjdHNDaG9pY2VQcm9wZXJ0eSwgbm9kZU9wdGlvbnMgKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0eXBlb2YgYWxsb3dFeHBvbmVudHMgPT09ICdib29sZWFuJyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggcGFydGlhbFByb2R1Y3RzQ2hvaWNlUHJvcGVydHkgaW5zdGFuY2VvZiBSZWFkT25seVByb3BlcnR5ICk7XHJcblxyXG4gICAgc3VwZXIoIGFyZWFEaXNwbGF5LCBwYXJ0aWFsUHJvZHVjdHNDaG9pY2VQcm9wZXJ0eSwge1xyXG4gICAgICBhbGxvd0V4cG9uZW50czogYWxsb3dFeHBvbmVudHMsXHJcbiAgICAgIGlzUHJvcG9ydGlvbmFsOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYXJlYUxheWVyLmFkZENoaWxkKCB0aGlzLmJhY2tncm91bmROb2RlICk7XHJcblxyXG4gICAgLy8gU2lnbi1jb2xvcmVkIHBhcnRpdGlvbiBhcmVhIGJhY2tncm91bmRzIChlZmZlY3RpdmVseSBwb29sZWQpXHJcbiAgICB0aGlzLmFyZWFMYXllci5hZGRDaGlsZCggbmV3IFBvb2xhYmxlTGF5ZXJOb2RlKCB7XHJcbiAgICAgIGFycmF5UHJvcGVydHk6IGFyZWFEaXNwbGF5LnBhcnRpdGlvbmVkQXJlYXNQcm9wZXJ0eSxcclxuICAgICAgY3JlYXRlTm9kZTogcGFydGl0aW9uZWRBcmVhID0+IG5ldyBHZW5lcmljUGFydGl0aW9uZWRBcmVhTm9kZSggbmV3IFByb3BlcnR5KCBwYXJ0aXRpb25lZEFyZWEgKSwgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm1Qcm9wZXJ0eSApLFxyXG4gICAgICBnZXRJdGVtUHJvcGVydHk6IHBhcnRpdGlvbmVkQXJlYU5vZGUgPT4gcGFydGl0aW9uZWRBcmVhTm9kZS5wYXJ0aXRpb25lZEFyZWFQcm9wZXJ0eVxyXG4gICAgfSApICk7XHJcblxyXG4gICAgdGhpcy5hcmVhTGF5ZXIuYWRkQ2hpbGQoIHRoaXMuYm9yZGVyTm9kZSApO1xyXG5cclxuICAgIC8vIFBhcnRpdGlvbiBsaW5lc1xyXG4gICAgdGhpcy5hcmVhTGF5ZXIuYWRkQ2hpbGQoIEdlbmVyaWNBcmVhRGlzcGxheU5vZGUuY3JlYXRlUGFydGl0aW9uTGluZXMoIGFyZWFEaXNwbGF5LmxheW91dFByb3BlcnR5LCB0aGlzLnZpZXdTaXplICkgKTtcclxuXHJcbiAgICAvLyBFZGl0IHJlYWRvdXRzL2J1dHRvbnNcclxuICAgIHRoaXMubGFiZWxMYXllci5hZGRDaGlsZCggbmV3IFBvb2xhYmxlTGF5ZXJOb2RlKCB7XHJcbiAgICAgIGFycmF5UHJvcGVydHk6IGFyZWFEaXNwbGF5LmFsbFBhcnRpdGlvbnNQcm9wZXJ0eSxcclxuICAgICAgY3JlYXRlTm9kZTogcGFydGl0aW9uID0+IG5ldyBQYXJ0aXRpb25TaXplRWRpdE5vZGUoXHJcbiAgICAgICAgYXJlYURpc3BsYXkuYWN0aXZlUGFydGl0aW9uUHJvcGVydHksXHJcbiAgICAgICAgbmV3IFByb3BlcnR5KCBwYXJ0aXRpb24gKSxcclxuICAgICAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybVByb3BlcnR5LFxyXG4gICAgICAgIGFsbG93RXhwb25lbnRzXHJcbiAgICAgICksXHJcbiAgICAgIGdldEl0ZW1Qcm9wZXJ0eTogZWRpdE5vZGUgPT4gZWRpdE5vZGUucGFydGl0aW9uUHJvcGVydHlcclxuICAgIH0gKSApO1xyXG5cclxuICAgIC8vIEtleXBhZFxyXG4gICAgY29uc3QgZGlnaXRDb3VudFByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyBhcmVhRGlzcGxheS5hY3RpdmVQYXJ0aXRpb25Qcm9wZXJ0eSBdLCBhY3RpdmVQYXJ0aXRpb24gPT4gYWN0aXZlUGFydGl0aW9uID09PSBudWxsID8gMSA6IGFjdGl2ZVBhcnRpdGlvbi5kaWdpdENvdW50ICk7XHJcbiAgICBjb25zdCB0ZXJtS2V5cGFkUGFuZWwgPSBuZXcgVGVybUtleXBhZFBhbmVsKCBkaWdpdENvdW50UHJvcGVydHksIGFsbG93RXhwb25lbnRzLCB0cnVlLCB0ZXJtID0+IHtcclxuICAgICAgLy8gVXBkYXRlIHRoZSBzaXplIG9mIHRoZSBwYXJ0aXRpb24uXHJcbiAgICAgIGFyZWFEaXNwbGF5LmFjdGl2ZVBhcnRpdGlvblByb3BlcnR5LnZhbHVlLnNpemVQcm9wZXJ0eS52YWx1ZSA9IHRlcm07XHJcblxyXG4gICAgICAvLyBIaWRlIHRoZSBrZXlwYWQuXHJcbiAgICAgIGFyZWFEaXNwbGF5LmFjdGl2ZVBhcnRpdGlvblByb3BlcnR5LnZhbHVlID0gbnVsbDtcclxuICAgIH0sIHtcclxuICAgICAgeDogdGhpcy52aWV3U2l6ZSArIEFyZWFNb2RlbENvbW1vbkNvbnN0YW50cy5LRVlQQURfTEVGVF9QQURESU5HLFxyXG4gICAgICBjZW50ZXJZOiB0aGlzLnZpZXdTaXplIC8gMlxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5sYWJlbExheWVyLmFkZENoaWxkKCB0ZXJtS2V5cGFkUGFuZWwgKTtcclxuXHJcbiAgICAvLyBJZiB0aGlzIGNoYW5nZXMsIHdlIGNsZWFyIGFuZCBzd2l0Y2ggdG8gaXRcclxuICAgIGFyZWFEaXNwbGF5LmFjdGl2ZVBhcnRpdGlvblByb3BlcnR5LmxpbmsoIG5ld0FyZWEgPT4ge1xyXG4gICAgICB0ZXJtS2V5cGFkUGFuZWwudmlzaWJsZSA9IG5ld0FyZWEgIT09IG51bGw7XHJcbiAgICAgIHRlcm1LZXlwYWRQYW5lbC5jbGVhcigpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubXV0YXRlKCBub2RlT3B0aW9ucyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUG9zaXRpb25zIGFsbCBvZiB0aGUgcGFydGlhbCBwcm9kdWN0cyBsYWJlbHMuXHJcbiAgICogQHByb3RlY3RlZFxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqL1xyXG4gIHBvc2l0aW9uUHJvZHVjdExhYmVscygpIHtcclxuICAgIHRoaXMucHJvZHVjdExhYmVscy5mb3JFYWNoKCBwcm9kdWN0TGFiZWwgPT4ge1xyXG4gICAgICBPcmllbnRhdGlvbi5lbnVtZXJhdGlvbi52YWx1ZXMuZm9yRWFjaCggb3JpZW50YXRpb24gPT4ge1xyXG4gICAgICAgIGNvbnN0IHJhbmdlID0gcHJvZHVjdExhYmVsLnBhcnRpdGlvbmVkQXJlYVByb3BlcnR5LnZhbHVlLnBhcnRpdGlvbnMuZ2V0KCBvcmllbnRhdGlvbiApLmNvb3JkaW5hdGVSYW5nZVByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgIGlmICggcmFuZ2UgIT09IG51bGwgKSB7XHJcbiAgICAgICAgICBwcm9kdWN0TGFiZWxbIG9yaWVudGF0aW9uLmNvb3JkaW5hdGUgXSA9IG9yaWVudGF0aW9uLm1vZGVsVG9WaWV3KCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybVByb3BlcnR5LnZhbHVlLCByYW5nZS5nZXRDZW50ZXIoKSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyBhIHBhcnRpdGlvbiBsaW5lICh2aWV3IG9ubHkpXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7T3JpZW50YXRpb259IG9yaWVudGF0aW9uXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IG9mZnNldFxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB2aWV3U2l6ZSAtIEluIHZpZXcgdW5pdHMsIHRoZSBzaXplIG9mIHRoZSBtYWluIGFyZWFcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5Ljxib29sZWFuPn0gdmlzaWJpbGl0eVByb3BlcnR5XHJcbiAgICovXHJcbiAgc3RhdGljIGNyZWF0ZVBhcnRpdGlvbkxpbmUoIG9yaWVudGF0aW9uLCBvZmZzZXQsIHZpZXdTaXplLCB2aXNpYmlsaXR5UHJvcGVydHkgKSB7XHJcbiAgICBjb25zdCBmaXJzdFBvaW50ID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuICAgIGNvbnN0IHNlY29uZFBvaW50ID0gbmV3IFZlY3RvcjIoIDAsIDAgKTtcclxuXHJcbiAgICBmaXJzdFBvaW50WyBvcmllbnRhdGlvbi5jb29yZGluYXRlIF0gPSBvZmZzZXQ7XHJcbiAgICBzZWNvbmRQb2ludFsgb3JpZW50YXRpb24uY29vcmRpbmF0ZSBdID0gb2Zmc2V0O1xyXG4gICAgZmlyc3RQb2ludFsgb3JpZW50YXRpb24ub3Bwb3NpdGUuY29vcmRpbmF0ZSBdID0gdmlld1NpemU7XHJcbiAgICBzZWNvbmRQb2ludFsgb3JpZW50YXRpb24ub3Bwb3NpdGUuY29vcmRpbmF0ZSBdID0gMDtcclxuXHJcbiAgICBjb25zdCBsaW5lID0gbmV3IExpbmUoIHtcclxuICAgICAgcDE6IGZpcnN0UG9pbnQsXHJcbiAgICAgIHAyOiBzZWNvbmRQb2ludCxcclxuICAgICAgc3Ryb2tlOiBBcmVhTW9kZWxDb21tb25Db2xvcnMucGFydGl0aW9uTGluZVN0cm9rZVByb3BlcnR5XHJcbiAgICB9ICk7XHJcbiAgICB2aXNpYmlsaXR5UHJvcGVydHkubGlua0F0dHJpYnV0ZSggbGluZSwgJ3Zpc2libGUnICk7XHJcbiAgICByZXR1cm4gbGluZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZXMgYSBzZXQgb2YgZ2VuZXJpYyBwYXJ0aXRpb24gbGluZXMuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHBhcmFtIHtQcm9wZXJ0eS48R2VuZXJpY0xheW91dD59IGxheW91dFByb3BlcnR5XHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHZpZXdTaXplXHJcbiAgICogQHJldHVybnMge05vZGV9XHJcbiAgICovXHJcbiAgc3RhdGljIGNyZWF0ZVBhcnRpdGlvbkxpbmVzKCBsYXlvdXRQcm9wZXJ0eSwgdmlld1NpemUgKSB7XHJcbiAgICBjb25zdCBzaW5nbGVPZmZzZXQgPSB2aWV3U2l6ZSAqIEFyZWFNb2RlbENvbW1vbkNvbnN0YW50cy5HRU5FUklDX1NJTkdMRV9PRkZTRVQ7XHJcbiAgICBjb25zdCBmaXJzdE9mZnNldCA9IHZpZXdTaXplICogQXJlYU1vZGVsQ29tbW9uQ29uc3RhbnRzLkdFTkVSSUNfRklSU1RfT0ZGU0VUO1xyXG4gICAgY29uc3Qgc2Vjb25kT2Zmc2V0ID0gdmlld1NpemUgKiBBcmVhTW9kZWxDb21tb25Db25zdGFudHMuR0VORVJJQ19TRUNPTkRfT0ZGU0VUO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdE5vZGUgPSBuZXcgTm9kZSgpO1xyXG5cclxuICAgIE9yaWVudGF0aW9uLmVudW1lcmF0aW9uLnZhbHVlcy5mb3JFYWNoKCBvcmllbnRhdGlvbiA9PiB7XHJcbiAgICAgIGNvbnN0IGhhc1R3b1Byb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyBsYXlvdXRQcm9wZXJ0eSBdLCBsYXlvdXQgPT4gbGF5b3V0LmdldFBhcnRpdGlvblF1YW50aXR5KCBvcmllbnRhdGlvbiApID09PSAyICk7XHJcbiAgICAgIGNvbnN0IGhhc1RocmVlUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIGxheW91dFByb3BlcnR5IF0sIGxheW91dCA9PiBsYXlvdXQuZ2V0UGFydGl0aW9uUXVhbnRpdHkoIG9yaWVudGF0aW9uICkgPT09IDMgKTtcclxuXHJcbiAgICAgIGNvbnN0IHNpbmdsZUxpbmUgPSBHZW5lcmljQXJlYURpc3BsYXlOb2RlLmNyZWF0ZVBhcnRpdGlvbkxpbmUoIG9yaWVudGF0aW9uLCBzaW5nbGVPZmZzZXQsIHZpZXdTaXplLCBoYXNUd29Qcm9wZXJ0eSApO1xyXG4gICAgICBjb25zdCBmaXJzdExpbmUgPSBHZW5lcmljQXJlYURpc3BsYXlOb2RlLmNyZWF0ZVBhcnRpdGlvbkxpbmUoIG9yaWVudGF0aW9uLCBmaXJzdE9mZnNldCwgdmlld1NpemUsIGhhc1RocmVlUHJvcGVydHkgKTtcclxuICAgICAgY29uc3Qgc2Vjb25kTGluZSA9IEdlbmVyaWNBcmVhRGlzcGxheU5vZGUuY3JlYXRlUGFydGl0aW9uTGluZSggb3JpZW50YXRpb24sIHNlY29uZE9mZnNldCwgdmlld1NpemUsIGhhc1RocmVlUHJvcGVydHkgKTtcclxuICAgICAgcmVzdWx0Tm9kZS5hZGRDaGlsZCggc2luZ2xlTGluZSApO1xyXG4gICAgICByZXN1bHROb2RlLmFkZENoaWxkKCBmaXJzdExpbmUgKTtcclxuICAgICAgcmVzdWx0Tm9kZS5hZGRDaGlsZCggc2Vjb25kTGluZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHJldHVybiByZXN1bHROb2RlO1xyXG4gIH1cclxufVxyXG5cclxuYXJlYU1vZGVsQ29tbW9uLnJlZ2lzdGVyKCAnR2VuZXJpY0FyZWFEaXNwbGF5Tm9kZScsIEdlbmVyaWNBcmVhRGlzcGxheU5vZGUgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IEdlbmVyaWNBcmVhRGlzcGxheU5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FB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