// Copyright 2021-2023, University of Colorado Boulder

/**
 * WavePacketSumChartNode is the view for the 'Sum' chart in the 'Wave Packet' screen.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import CanvasLinePlot from '../../../../bamboo/js/CanvasLinePlot.js';
import ChartCanvasNode from '../../../../bamboo/js/ChartCanvasNode.js';
import merge from '../../../../phet-core/js/merge.js';
import { Node } from '../../../../scenery/js/imports.js';
import FMWColors from '../../common/FMWColors.js';
import FMWConstants from '../../common/FMWConstants.js';
import FMWSymbols from '../../common/FMWSymbols.js';
import DomainChartNode from '../../common/view/DomainChartNode.js';
import TickLabelUtils from '../../common/view/TickLabelUtils.js';
import ZoomLevelProperty from '../../common/view/ZoomLevelProperty.js';
import fourierMakingWaves from '../../fourierMakingWaves.js';
import WavePacketSumChart from '../model/WavePacketSumChart.js';
import WidthIndicatorPlot from './WidthIndicatorPlot.js';

// constants
const X_TICK_LABEL_DECIMALS = 1;
const Y_TICK_LABEL_DECIMALS = 2;
export default class WavePacketSumChartNode extends DomainChartNode {
  /**
   * @param {WavePacketSumChart} sumChart
   * @param {Object} [options]
   */
  constructor(sumChart, options) {
    assert && assert(sumChart instanceof WavePacketSumChart);
    assert && assert(options && options.tandem);

    // Fields of interest in sumChart, to improve readability
    const domainProperty = sumChart.domainProperty;
    const xAxisDescriptionProperty = sumChart.xAxisDescriptionProperty;
    const widthIndicatorWidthProperty = sumChart.widthIndicatorWidthProperty;
    const widthIndicatorPositionProperty = sumChart.widthIndicatorPositionProperty;
    const widthIndicatorsVisibleProperty = sumChart.widthIndicatorsVisibleProperty;
    const sumDataSetProperty = sumChart.sumDataSetProperty;
    const waveformEnvelopeDataSetProperty = sumChart.waveformEnvelopeDataSetProperty;
    const yAxisDescription = sumChart.yAxisDescription;
    options = merge({
      // x-axis with dynamic scale and zoom buttons
      xZoomLevelProperty: new ZoomLevelProperty(xAxisDescriptionProperty, options.tandem.createTandem('xZoomLevelProperty')),
      xTickLabelSetOptions: {
        createLabel: value => TickLabelUtils.createNumericTickLabel(value, X_TICK_LABEL_DECIMALS)
      },
      yTickLabelSetOptions: {
        createLabel: value => TickLabelUtils.createNumericTickLabel(value, Y_TICK_LABEL_DECIMALS)
      },
      // y axis with fixed scale
      chartTransformOptions: {
        modelYRange: yAxisDescription.range
      },
      yGridLineSpacing: yAxisDescription.gridLineSpacing,
      yTickMarkSpacing: yAxisDescription.tickMarkSpacing,
      yTickLabelSpacing: yAxisDescription.tickLabelSpacing
    }, options);
    super(sumChart, options);

    // NOTE: CanvasLinePlot dataSets are initialized to [] because the listeners to their data set Properties
    // also handle y-axis scaling.

    // Plots the sum
    const sumPlot = new CanvasLinePlot(this.chartTransform, [], {
      stroke: FMWColors.sumPlotStrokeProperty.value
    });

    // Render sumPlot using Canvas. Remember! When sumPlot is updated, you must call update().
    // This ChartCanvasNode renders only sumPlot because it has its own clipArea requirements.
    const sumChartCanvasNode = new ChartCanvasNode(this.chartTransform, [sumPlot]);

    // CanvasLinePlot stroke does not support Property, so handle updates here.
    FMWColors.sumPlotStrokeProperty.lazyLink(stroke => {
      sumPlot.setStroke(stroke);
      sumChartCanvasNode.update();
    });

    // Plots the waveform envelope of the sum.  There is no need to handle this plot's visibility, because its
    // data set will be empty when it's not a visible - a performance optimization in the model.  CanvasLinePlot
    // also does not support visibleProperty.
    const waveformEnvelopePlot = new CanvasLinePlot(this.chartTransform, [], {
      stroke: FMWColors.secondaryWaveformStrokeProperty.value,
      lineWidth: FMWConstants.SECONDARY_WAVEFORM_LINE_WIDTH
    });

    // Render waveformEnvelopePlot using Canvas. Remember! When waveformEnvelopePlot is updated, you must call update().
    const waveformEnvelopeChartCanvasNode = new ChartCanvasNode(this.chartTransform, [waveformEnvelopePlot]);

    // CanvasLinePlot stroke does not support Property, so handle updates here.
    FMWColors.secondaryWaveformStrokeProperty.lazyLink(stroke => {
      waveformEnvelopePlot.setStroke(stroke);
      waveformEnvelopeChartCanvasNode.update();
    });

    // Width indicator, labeled dimensional arrows
    const widthIndicatorPlot = new WidthIndicatorPlot(this.chartTransform, widthIndicatorWidthProperty, widthIndicatorPositionProperty, domainProperty, FMWSymbols.xStringProperty, FMWSymbols.tStringProperty, {
      visibleProperty: widthIndicatorsVisibleProperty
    });

    // Clip these elements to the chartRectangle bounds.
    const clipNode = new Node({
      children: [waveformEnvelopeChartCanvasNode, sumChartCanvasNode, widthIndicatorPlot]
    });
    this.addChild(clipNode);

    // Update the sum plot.
    sumDataSetProperty.link(dataSet => {
      sumPlot.setDataSet(dataSet);
      sumChartCanvasNode.update();
    });

    // Update the waveform envelope plot.
    waveformEnvelopeDataSetProperty.link(dataSet => {
      waveformEnvelopePlot.setDataSet(dataSet);
      waveformEnvelopeChartCanvasNode.update();
    });
  }

  /**
   * @public
   * @override
   */
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
}
fourierMakingWaves.register('WavePacketSumChartNode', WavePacketSumChartNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDYW52YXNMaW5lUGxvdCIsIkNoYXJ0Q2FudmFzTm9kZSIsIm1lcmdlIiwiTm9kZSIsIkZNV0NvbG9ycyIsIkZNV0NvbnN0YW50cyIsIkZNV1N5bWJvbHMiLCJEb21haW5DaGFydE5vZGUiLCJUaWNrTGFiZWxVdGlscyIsIlpvb21MZXZlbFByb3BlcnR5IiwiZm91cmllck1ha2luZ1dhdmVzIiwiV2F2ZVBhY2tldFN1bUNoYXJ0IiwiV2lkdGhJbmRpY2F0b3JQbG90IiwiWF9USUNLX0xBQkVMX0RFQ0lNQUxTIiwiWV9USUNLX0xBQkVMX0RFQ0lNQUxTIiwiV2F2ZVBhY2tldFN1bUNoYXJ0Tm9kZSIsImNvbnN0cnVjdG9yIiwic3VtQ2hhcnQiLCJvcHRpb25zIiwiYXNzZXJ0IiwidGFuZGVtIiwiZG9tYWluUHJvcGVydHkiLCJ4QXhpc0Rlc2NyaXB0aW9uUHJvcGVydHkiLCJ3aWR0aEluZGljYXRvcldpZHRoUHJvcGVydHkiLCJ3aWR0aEluZGljYXRvclBvc2l0aW9uUHJvcGVydHkiLCJ3aWR0aEluZGljYXRvcnNWaXNpYmxlUHJvcGVydHkiLCJzdW1EYXRhU2V0UHJvcGVydHkiLCJ3YXZlZm9ybUVudmVsb3BlRGF0YVNldFByb3BlcnR5IiwieUF4aXNEZXNjcmlwdGlvbiIsInhab29tTGV2ZWxQcm9wZXJ0eSIsImNyZWF0ZVRhbmRlbSIsInhUaWNrTGFiZWxTZXRPcHRpb25zIiwiY3JlYXRlTGFiZWwiLCJ2YWx1ZSIsImNyZWF0ZU51bWVyaWNUaWNrTGFiZWwiLCJ5VGlja0xhYmVsU2V0T3B0aW9ucyIsImNoYXJ0VHJhbnNmb3JtT3B0aW9ucyIsIm1vZGVsWVJhbmdlIiwicmFuZ2UiLCJ5R3JpZExpbmVTcGFjaW5nIiwiZ3JpZExpbmVTcGFjaW5nIiwieVRpY2tNYXJrU3BhY2luZyIsInRpY2tNYXJrU3BhY2luZyIsInlUaWNrTGFiZWxTcGFjaW5nIiwidGlja0xhYmVsU3BhY2luZyIsInN1bVBsb3QiLCJjaGFydFRyYW5zZm9ybSIsInN0cm9rZSIsInN1bVBsb3RTdHJva2VQcm9wZXJ0eSIsInN1bUNoYXJ0Q2FudmFzTm9kZSIsImxhenlMaW5rIiwic2V0U3Ryb2tlIiwidXBkYXRlIiwid2F2ZWZvcm1FbnZlbG9wZVBsb3QiLCJzZWNvbmRhcnlXYXZlZm9ybVN0cm9rZVByb3BlcnR5IiwibGluZVdpZHRoIiwiU0VDT05EQVJZX1dBVkVGT1JNX0xJTkVfV0lEVEgiLCJ3YXZlZm9ybUVudmVsb3BlQ2hhcnRDYW52YXNOb2RlIiwid2lkdGhJbmRpY2F0b3JQbG90IiwieFN0cmluZ1Byb3BlcnR5IiwidFN0cmluZ1Byb3BlcnR5IiwidmlzaWJsZVByb3BlcnR5IiwiY2xpcE5vZGUiLCJjaGlsZHJlbiIsImFkZENoaWxkIiwibGluayIsImRhdGFTZXQiLCJzZXREYXRhU2V0IiwiZGlzcG9zZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiV2F2ZVBhY2tldFN1bUNoYXJ0Tm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMS0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBXYXZlUGFja2V0U3VtQ2hhcnROb2RlIGlzIHRoZSB2aWV3IGZvciB0aGUgJ1N1bScgY2hhcnQgaW4gdGhlICdXYXZlIFBhY2tldCcgc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBDYW52YXNMaW5lUGxvdCBmcm9tICcuLi8uLi8uLi8uLi9iYW1ib28vanMvQ2FudmFzTGluZVBsb3QuanMnO1xyXG5pbXBvcnQgQ2hhcnRDYW52YXNOb2RlIGZyb20gJy4uLy4uLy4uLy4uL2JhbWJvby9qcy9DaGFydENhbnZhc05vZGUuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBGTVdDb2xvcnMgZnJvbSAnLi4vLi4vY29tbW9uL0ZNV0NvbG9ycy5qcyc7XHJcbmltcG9ydCBGTVdDb25zdGFudHMgZnJvbSAnLi4vLi4vY29tbW9uL0ZNV0NvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBGTVdTeW1ib2xzIGZyb20gJy4uLy4uL2NvbW1vbi9GTVdTeW1ib2xzLmpzJztcclxuaW1wb3J0IERvbWFpbkNoYXJ0Tm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9Eb21haW5DaGFydE5vZGUuanMnO1xyXG5pbXBvcnQgVGlja0xhYmVsVXRpbHMgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvVGlja0xhYmVsVXRpbHMuanMnO1xyXG5pbXBvcnQgWm9vbUxldmVsUHJvcGVydHkgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvWm9vbUxldmVsUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgZm91cmllck1ha2luZ1dhdmVzIGZyb20gJy4uLy4uL2ZvdXJpZXJNYWtpbmdXYXZlcy5qcyc7XHJcbmltcG9ydCBXYXZlUGFja2V0U3VtQ2hhcnQgZnJvbSAnLi4vbW9kZWwvV2F2ZVBhY2tldFN1bUNoYXJ0LmpzJztcclxuaW1wb3J0IFdpZHRoSW5kaWNhdG9yUGxvdCBmcm9tICcuL1dpZHRoSW5kaWNhdG9yUGxvdC5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgWF9USUNLX0xBQkVMX0RFQ0lNQUxTID0gMTtcclxuY29uc3QgWV9USUNLX0xBQkVMX0RFQ0lNQUxTID0gMjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdhdmVQYWNrZXRTdW1DaGFydE5vZGUgZXh0ZW5kcyBEb21haW5DaGFydE5vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1dhdmVQYWNrZXRTdW1DaGFydH0gc3VtQ2hhcnRcclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHN1bUNoYXJ0LCBvcHRpb25zICkge1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHN1bUNoYXJ0IGluc3RhbmNlb2YgV2F2ZVBhY2tldFN1bUNoYXJ0ICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBvcHRpb25zICYmIG9wdGlvbnMudGFuZGVtICk7XHJcblxyXG4gICAgLy8gRmllbGRzIG9mIGludGVyZXN0IGluIHN1bUNoYXJ0LCB0byBpbXByb3ZlIHJlYWRhYmlsaXR5XHJcbiAgICBjb25zdCBkb21haW5Qcm9wZXJ0eSA9IHN1bUNoYXJ0LmRvbWFpblByb3BlcnR5O1xyXG4gICAgY29uc3QgeEF4aXNEZXNjcmlwdGlvblByb3BlcnR5ID0gc3VtQ2hhcnQueEF4aXNEZXNjcmlwdGlvblByb3BlcnR5O1xyXG4gICAgY29uc3Qgd2lkdGhJbmRpY2F0b3JXaWR0aFByb3BlcnR5ID0gc3VtQ2hhcnQud2lkdGhJbmRpY2F0b3JXaWR0aFByb3BlcnR5O1xyXG4gICAgY29uc3Qgd2lkdGhJbmRpY2F0b3JQb3NpdGlvblByb3BlcnR5ID0gc3VtQ2hhcnQud2lkdGhJbmRpY2F0b3JQb3NpdGlvblByb3BlcnR5O1xyXG4gICAgY29uc3Qgd2lkdGhJbmRpY2F0b3JzVmlzaWJsZVByb3BlcnR5ID0gc3VtQ2hhcnQud2lkdGhJbmRpY2F0b3JzVmlzaWJsZVByb3BlcnR5O1xyXG4gICAgY29uc3Qgc3VtRGF0YVNldFByb3BlcnR5ID0gc3VtQ2hhcnQuc3VtRGF0YVNldFByb3BlcnR5O1xyXG4gICAgY29uc3Qgd2F2ZWZvcm1FbnZlbG9wZURhdGFTZXRQcm9wZXJ0eSA9IHN1bUNoYXJ0LndhdmVmb3JtRW52ZWxvcGVEYXRhU2V0UHJvcGVydHk7XHJcbiAgICBjb25zdCB5QXhpc0Rlc2NyaXB0aW9uID0gc3VtQ2hhcnQueUF4aXNEZXNjcmlwdGlvbjtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuXHJcbiAgICAgIC8vIHgtYXhpcyB3aXRoIGR5bmFtaWMgc2NhbGUgYW5kIHpvb20gYnV0dG9uc1xyXG4gICAgICB4Wm9vbUxldmVsUHJvcGVydHk6IG5ldyBab29tTGV2ZWxQcm9wZXJ0eSggeEF4aXNEZXNjcmlwdGlvblByb3BlcnR5LCBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICd4Wm9vbUxldmVsUHJvcGVydHknICkgKSxcclxuICAgICAgeFRpY2tMYWJlbFNldE9wdGlvbnM6IHtcclxuICAgICAgICBjcmVhdGVMYWJlbDogdmFsdWUgPT4gVGlja0xhYmVsVXRpbHMuY3JlYXRlTnVtZXJpY1RpY2tMYWJlbCggdmFsdWUsIFhfVElDS19MQUJFTF9ERUNJTUFMUyApXHJcbiAgICAgIH0sXHJcbiAgICAgIHlUaWNrTGFiZWxTZXRPcHRpb25zOiB7XHJcbiAgICAgICAgY3JlYXRlTGFiZWw6IHZhbHVlID0+IFRpY2tMYWJlbFV0aWxzLmNyZWF0ZU51bWVyaWNUaWNrTGFiZWwoIHZhbHVlLCBZX1RJQ0tfTEFCRUxfREVDSU1BTFMgKVxyXG4gICAgICB9LFxyXG5cclxuICAgICAgLy8geSBheGlzIHdpdGggZml4ZWQgc2NhbGVcclxuICAgICAgY2hhcnRUcmFuc2Zvcm1PcHRpb25zOiB7XHJcbiAgICAgICAgbW9kZWxZUmFuZ2U6IHlBeGlzRGVzY3JpcHRpb24ucmFuZ2VcclxuICAgICAgfSxcclxuICAgICAgeUdyaWRMaW5lU3BhY2luZzogeUF4aXNEZXNjcmlwdGlvbi5ncmlkTGluZVNwYWNpbmcsXHJcbiAgICAgIHlUaWNrTWFya1NwYWNpbmc6IHlBeGlzRGVzY3JpcHRpb24udGlja01hcmtTcGFjaW5nLFxyXG4gICAgICB5VGlja0xhYmVsU3BhY2luZzogeUF4aXNEZXNjcmlwdGlvbi50aWNrTGFiZWxTcGFjaW5nXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIHN1bUNoYXJ0LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gTk9URTogQ2FudmFzTGluZVBsb3QgZGF0YVNldHMgYXJlIGluaXRpYWxpemVkIHRvIFtdIGJlY2F1c2UgdGhlIGxpc3RlbmVycyB0byB0aGVpciBkYXRhIHNldCBQcm9wZXJ0aWVzXHJcbiAgICAvLyBhbHNvIGhhbmRsZSB5LWF4aXMgc2NhbGluZy5cclxuXHJcbiAgICAvLyBQbG90cyB0aGUgc3VtXHJcbiAgICBjb25zdCBzdW1QbG90ID0gbmV3IENhbnZhc0xpbmVQbG90KCB0aGlzLmNoYXJ0VHJhbnNmb3JtLCBbXSwge1xyXG4gICAgICBzdHJva2U6IEZNV0NvbG9ycy5zdW1QbG90U3Ryb2tlUHJvcGVydHkudmFsdWVcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBSZW5kZXIgc3VtUGxvdCB1c2luZyBDYW52YXMuIFJlbWVtYmVyISBXaGVuIHN1bVBsb3QgaXMgdXBkYXRlZCwgeW91IG11c3QgY2FsbCB1cGRhdGUoKS5cclxuICAgIC8vIFRoaXMgQ2hhcnRDYW52YXNOb2RlIHJlbmRlcnMgb25seSBzdW1QbG90IGJlY2F1c2UgaXQgaGFzIGl0cyBvd24gY2xpcEFyZWEgcmVxdWlyZW1lbnRzLlxyXG4gICAgY29uc3Qgc3VtQ2hhcnRDYW52YXNOb2RlID0gbmV3IENoYXJ0Q2FudmFzTm9kZSggdGhpcy5jaGFydFRyYW5zZm9ybSwgWyBzdW1QbG90IF0gKTtcclxuXHJcbiAgICAvLyBDYW52YXNMaW5lUGxvdCBzdHJva2UgZG9lcyBub3Qgc3VwcG9ydCBQcm9wZXJ0eSwgc28gaGFuZGxlIHVwZGF0ZXMgaGVyZS5cclxuICAgIEZNV0NvbG9ycy5zdW1QbG90U3Ryb2tlUHJvcGVydHkubGF6eUxpbmsoIHN0cm9rZSA9PiB7XHJcbiAgICAgIHN1bVBsb3Quc2V0U3Ryb2tlKCBzdHJva2UgKTtcclxuICAgICAgc3VtQ2hhcnRDYW52YXNOb2RlLnVwZGF0ZSgpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFBsb3RzIHRoZSB3YXZlZm9ybSBlbnZlbG9wZSBvZiB0aGUgc3VtLiAgVGhlcmUgaXMgbm8gbmVlZCB0byBoYW5kbGUgdGhpcyBwbG90J3MgdmlzaWJpbGl0eSwgYmVjYXVzZSBpdHNcclxuICAgIC8vIGRhdGEgc2V0IHdpbGwgYmUgZW1wdHkgd2hlbiBpdCdzIG5vdCBhIHZpc2libGUgLSBhIHBlcmZvcm1hbmNlIG9wdGltaXphdGlvbiBpbiB0aGUgbW9kZWwuICBDYW52YXNMaW5lUGxvdFxyXG4gICAgLy8gYWxzbyBkb2VzIG5vdCBzdXBwb3J0IHZpc2libGVQcm9wZXJ0eS5cclxuICAgIGNvbnN0IHdhdmVmb3JtRW52ZWxvcGVQbG90ID0gbmV3IENhbnZhc0xpbmVQbG90KCB0aGlzLmNoYXJ0VHJhbnNmb3JtLCBbXSwge1xyXG4gICAgICBzdHJva2U6IEZNV0NvbG9ycy5zZWNvbmRhcnlXYXZlZm9ybVN0cm9rZVByb3BlcnR5LnZhbHVlLFxyXG4gICAgICBsaW5lV2lkdGg6IEZNV0NvbnN0YW50cy5TRUNPTkRBUllfV0FWRUZPUk1fTElORV9XSURUSFxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFJlbmRlciB3YXZlZm9ybUVudmVsb3BlUGxvdCB1c2luZyBDYW52YXMuIFJlbWVtYmVyISBXaGVuIHdhdmVmb3JtRW52ZWxvcGVQbG90IGlzIHVwZGF0ZWQsIHlvdSBtdXN0IGNhbGwgdXBkYXRlKCkuXHJcbiAgICBjb25zdCB3YXZlZm9ybUVudmVsb3BlQ2hhcnRDYW52YXNOb2RlID0gbmV3IENoYXJ0Q2FudmFzTm9kZSggdGhpcy5jaGFydFRyYW5zZm9ybSwgWyB3YXZlZm9ybUVudmVsb3BlUGxvdCBdICk7XHJcblxyXG4gICAgLy8gQ2FudmFzTGluZVBsb3Qgc3Ryb2tlIGRvZXMgbm90IHN1cHBvcnQgUHJvcGVydHksIHNvIGhhbmRsZSB1cGRhdGVzIGhlcmUuXHJcbiAgICBGTVdDb2xvcnMuc2Vjb25kYXJ5V2F2ZWZvcm1TdHJva2VQcm9wZXJ0eS5sYXp5TGluayggc3Ryb2tlID0+IHtcclxuICAgICAgd2F2ZWZvcm1FbnZlbG9wZVBsb3Quc2V0U3Ryb2tlKCBzdHJva2UgKTtcclxuICAgICAgd2F2ZWZvcm1FbnZlbG9wZUNoYXJ0Q2FudmFzTm9kZS51cGRhdGUoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBXaWR0aCBpbmRpY2F0b3IsIGxhYmVsZWQgZGltZW5zaW9uYWwgYXJyb3dzXHJcbiAgICBjb25zdCB3aWR0aEluZGljYXRvclBsb3QgPSBuZXcgV2lkdGhJbmRpY2F0b3JQbG90KCB0aGlzLmNoYXJ0VHJhbnNmb3JtLCB3aWR0aEluZGljYXRvcldpZHRoUHJvcGVydHksXHJcbiAgICAgIHdpZHRoSW5kaWNhdG9yUG9zaXRpb25Qcm9wZXJ0eSwgZG9tYWluUHJvcGVydHksIEZNV1N5bWJvbHMueFN0cmluZ1Byb3BlcnR5LCBGTVdTeW1ib2xzLnRTdHJpbmdQcm9wZXJ0eSwge1xyXG4gICAgICAgIHZpc2libGVQcm9wZXJ0eTogd2lkdGhJbmRpY2F0b3JzVmlzaWJsZVByb3BlcnR5XHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAvLyBDbGlwIHRoZXNlIGVsZW1lbnRzIHRvIHRoZSBjaGFydFJlY3RhbmdsZSBib3VuZHMuXHJcbiAgICBjb25zdCBjbGlwTm9kZSA9IG5ldyBOb2RlKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIHdhdmVmb3JtRW52ZWxvcGVDaGFydENhbnZhc05vZGUsIHN1bUNoYXJ0Q2FudmFzTm9kZSwgd2lkdGhJbmRpY2F0b3JQbG90IF1cclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGNsaXBOb2RlICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBzdW0gcGxvdC5cclxuICAgIHN1bURhdGFTZXRQcm9wZXJ0eS5saW5rKCBkYXRhU2V0ID0+IHtcclxuICAgICAgc3VtUGxvdC5zZXREYXRhU2V0KCBkYXRhU2V0ICk7XHJcbiAgICAgIHN1bUNoYXJ0Q2FudmFzTm9kZS51cGRhdGUoKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHdhdmVmb3JtIGVudmVsb3BlIHBsb3QuXHJcbiAgICB3YXZlZm9ybUVudmVsb3BlRGF0YVNldFByb3BlcnR5LmxpbmsoIGRhdGFTZXQgPT4ge1xyXG4gICAgICB3YXZlZm9ybUVudmVsb3BlUGxvdC5zZXREYXRhU2V0KCBkYXRhU2V0ICk7XHJcbiAgICAgIHdhdmVmb3JtRW52ZWxvcGVDaGFydENhbnZhc05vZGUudXBkYXRlKCk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuZm91cmllck1ha2luZ1dhdmVzLnJlZ2lzdGVyKCAnV2F2ZVBhY2tldFN1bUNoYXJ0Tm9kZScsIFdhdmVQYWNrZXRTdW1DaGFydE5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsY0FBYyxNQUFNLHlDQUF5QztBQUNwRSxPQUFPQyxlQUFlLE1BQU0sMENBQTBDO0FBQ3RFLE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsU0FBU0MsSUFBSSxRQUFRLG1DQUFtQztBQUN4RCxPQUFPQyxTQUFTLE1BQU0sMkJBQTJCO0FBQ2pELE9BQU9DLFlBQVksTUFBTSw4QkFBOEI7QUFDdkQsT0FBT0MsVUFBVSxNQUFNLDRCQUE0QjtBQUNuRCxPQUFPQyxlQUFlLE1BQU0sc0NBQXNDO0FBQ2xFLE9BQU9DLGNBQWMsTUFBTSxxQ0FBcUM7QUFDaEUsT0FBT0MsaUJBQWlCLE1BQU0sd0NBQXdDO0FBQ3RFLE9BQU9DLGtCQUFrQixNQUFNLDZCQUE2QjtBQUM1RCxPQUFPQyxrQkFBa0IsTUFBTSxnQ0FBZ0M7QUFDL0QsT0FBT0Msa0JBQWtCLE1BQU0seUJBQXlCOztBQUV4RDtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLENBQUM7QUFDL0IsTUFBTUMscUJBQXFCLEdBQUcsQ0FBQztBQUUvQixlQUFlLE1BQU1DLHNCQUFzQixTQUFTUixlQUFlLENBQUM7RUFFbEU7QUFDRjtBQUNBO0FBQ0E7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