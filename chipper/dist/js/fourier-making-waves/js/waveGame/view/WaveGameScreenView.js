// Copyright 2020-2023, University of Colorado Boulder

/**
 * WaveGameScreenView is the view for the 'Wave Game' screen.
 *
 * @author Chris Malley (PixelZoom, Inc.
 */

import ScreenView from '../../../../joist/js/ScreenView.js';
import { PDOMUtils } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import Easing from '../../../../twixt/js/Easing.js';
import TransitionNode from '../../../../twixt/js/TransitionNode.js';
import GameAudioPlayer from '../../../../vegas/js/GameAudioPlayer.js';
import fourierMakingWaves from '../../fourierMakingWaves.js';
import WaveGameModel from '../model/WaveGameModel.js';
import WaveGameLevelNode from './WaveGameLevelNode.js';
import WaveGameLevelSelectionNode from './WaveGameLevelSelectionNode.js';
import WaveGameRewardDialog from './WaveGameRewardDialog.js';
import WaveGameRewardNode from './WaveGameRewardNode.js';

// constants
const TRANSITION_OPTIONS = {
  duration: 0.5,
  // sec
  targetOptions: {
    easing: Easing.QUADRATIC_IN_OUT
  }
};
export default class WaveGameScreenView extends ScreenView {
  /**
   * @param {WaveGameModel} model
   * @param {Tandem} tandem
   */
  constructor(model, tandem) {
    assert && assert(model instanceof WaveGameModel);
    assert && assert(tandem instanceof Tandem);
    super({
      tandem: tandem
    });

    // To improve readability
    const layoutBounds = this.layoutBounds;
    const gameAudioPlayer = new GameAudioPlayer();

    // UI for level selection and other game settings
    const levelSelectionNode = new WaveGameLevelSelectionNode(model, layoutBounds, {
      resetCallback: () => {
        model.reset();
      },
      tandem: tandem.createTandem('levelSelectionNode')
    });

    // @private The reward shown while rewardDialog is open.
    this.rewardNode = new WaveGameRewardNode({
      visible: false,
      tandem: tandem.createTandem('rewardNode'),
      phetioReadOnly: true
    });

    // Dialog that is displayed when the score reaches the reward value.
    const rewardDialog = new WaveGameRewardDialog(model.levelProperty, this.rewardNode, model.rewardScore, {
      tandem: tandem.createTandem('rewardDialog')
    });

    // @private {SolveItLevelNode[]} a Node for each level of the game
    this.levelNodes = model.levels.map(level => new WaveGameLevelNode(level, model.levelProperty, layoutBounds, this.visibleBoundsProperty, gameAudioPlayer, this.rewardNode, rewardDialog, model.rewardScore, {
      tandem: tandem.createTandem(`level${level.levelNumber}Node`)
    }));

    // @private Handles the animated 'slide' transition between levelSelectionNode and a level.
    this.transitionNode = new TransitionNode(this.visibleBoundsProperty, {
      content: levelSelectionNode,
      cachedNodes: [levelSelectionNode, ...this.levelNodes]
    });

    // Transition between levelSelectionNode and the selected level.
    // A null value for levelProperty indicates that no level is selected, and levelSelectionNode should be shown.
    model.levelProperty.lazyLink((level, previousLevel) => {
      this.interruptSubtreeInput();
      if (level) {
        // Transition to the selected level.
        const selectedLevelNode = _.find(this.levelNodes, levelNode => levelNode.level === level);
        const transition = this.transitionNode.slideLeftTo(selectedLevelNode, TRANSITION_OPTIONS);

        // Set focus to the first focusable element in selectedLevelNode.
        // See specification at https://github.com/phetsims/vegas/issues/90#issuecomment-854034816
        const transitionEndedListener = () => {
          assert && assert(this.transitionNode.hasChild(selectedLevelNode) && selectedLevelNode.visible);

          // This is a little brittle. If anything else is added to the screen in the future that is
          // not associated with transitionNode, then it might get the focus.
          PDOMUtils.getFirstFocusable().focus();
          transition.endedEmitter.removeListener(transitionEndedListener);
        };
        transition.endedEmitter.addListener(transitionEndedListener);
      } else {
        // Selected level was null, so transition to levelSelectionNode.
        const transition = this.transitionNode.slideRightTo(levelSelectionNode, TRANSITION_OPTIONS);

        // Set focus to the level-selection button that is associated with previousLevel.
        // See specification at https://github.com/phetsims/vegas/issues/90#issuecomment-854034816
        const transitionEndedListener = () => {
          assert && assert(this.transitionNode.hasChild(levelSelectionNode) && levelSelectionNode.visible);
          levelSelectionNode.focusLevelSelectionButton(previousLevel);
          transition.endedEmitter.removeListener(transitionEndedListener);
        };
        transition.endedEmitter.addListener(transitionEndedListener);
      }
    });
    this.addChild(this.transitionNode);
    this.addChild(this.rewardNode);
  }

  /**
   * @public
   * @override
   */
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }

  /**
   * Steps the view.
   * @param {number} dt - time step, in seconds
   * @public
   */
  step(dt) {
    this.rewardNode.visible && this.rewardNode.step(dt);

    // animate the view for the selected level
    for (let i = 0; i < this.levelNodes.length; i++) {
      const levelNode = this.levelNodes[i];
      if (levelNode.visible) {
        levelNode.step(dt);
        break;
      }
    }
  }
}
fourierMakingWaves.register('WaveGameScreenView', WaveGameScreenView);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY3JlZW5WaWV3IiwiUERPTVV0aWxzIiwiVGFuZGVtIiwiRWFzaW5nIiwiVHJhbnNpdGlvbk5vZGUiLCJHYW1lQXVkaW9QbGF5ZXIiLCJmb3VyaWVyTWFraW5nV2F2ZXMiLCJXYXZlR2FtZU1vZGVsIiwiV2F2ZUdhbWVMZXZlbE5vZGUiLCJXYXZlR2FtZUxldmVsU2VsZWN0aW9uTm9kZSIsIldhdmVHYW1lUmV3YXJkRGlhbG9nIiwiV2F2ZUdhbWVSZXdhcmROb2RlIiwiVFJBTlNJVElPTl9PUFRJT05TIiwiZHVyYXRpb24iLCJ0YXJnZXRPcHRpb25zIiwiZWFzaW5nIiwiUVVBRFJBVElDX0lOX09VVCIsIldhdmVHYW1lU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJ0YW5kZW0iLCJhc3NlcnQiLCJsYXlvdXRCb3VuZHMiLCJnYW1lQXVkaW9QbGF5ZXIiLCJsZXZlbFNlbGVjdGlvbk5vZGUiLCJyZXNldENhbGxiYWNrIiwicmVzZXQiLCJjcmVhdGVUYW5kZW0iLCJyZXdhcmROb2RlIiwidmlzaWJsZSIsInBoZXRpb1JlYWRPbmx5IiwicmV3YXJkRGlhbG9nIiwibGV2ZWxQcm9wZXJ0eSIsInJld2FyZFNjb3JlIiwibGV2ZWxOb2RlcyIsImxldmVscyIsIm1hcCIsImxldmVsIiwidmlzaWJsZUJvdW5kc1Byb3BlcnR5IiwibGV2ZWxOdW1iZXIiLCJ0cmFuc2l0aW9uTm9kZSIsImNvbnRlbnQiLCJjYWNoZWROb2RlcyIsImxhenlMaW5rIiwicHJldmlvdXNMZXZlbCIsImludGVycnVwdFN1YnRyZWVJbnB1dCIsInNlbGVjdGVkTGV2ZWxOb2RlIiwiXyIsImZpbmQiLCJsZXZlbE5vZGUiLCJ0cmFuc2l0aW9uIiwic2xpZGVMZWZ0VG8iLCJ0cmFuc2l0aW9uRW5kZWRMaXN0ZW5lciIsImhhc0NoaWxkIiwiZ2V0Rmlyc3RGb2N1c2FibGUiLCJmb2N1cyIsImVuZGVkRW1pdHRlciIsInJlbW92ZUxpc3RlbmVyIiwiYWRkTGlzdGVuZXIiLCJzbGlkZVJpZ2h0VG8iLCJmb2N1c0xldmVsU2VsZWN0aW9uQnV0dG9uIiwiYWRkQ2hpbGQiLCJkaXNwb3NlIiwic3RlcCIsImR0IiwiaSIsImxlbmd0aCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiV2F2ZUdhbWVTY3JlZW5WaWV3LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFdhdmVHYW1lU2NyZWVuVmlldyBpcyB0aGUgdmlldyBmb3IgdGhlICdXYXZlIEdhbWUnIHNjcmVlbi5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLlxyXG4gKi9cclxuXHJcbmltcG9ydCBTY3JlZW5WaWV3IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1NjcmVlblZpZXcuanMnO1xyXG5pbXBvcnQgeyBQRE9NVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgRWFzaW5nIGZyb20gJy4uLy4uLy4uLy4uL3R3aXh0L2pzL0Vhc2luZy5qcyc7XHJcbmltcG9ydCBUcmFuc2l0aW9uTm9kZSBmcm9tICcuLi8uLi8uLi8uLi90d2l4dC9qcy9UcmFuc2l0aW9uTm9kZS5qcyc7XHJcbmltcG9ydCBHYW1lQXVkaW9QbGF5ZXIgZnJvbSAnLi4vLi4vLi4vLi4vdmVnYXMvanMvR2FtZUF1ZGlvUGxheWVyLmpzJztcclxuaW1wb3J0IGZvdXJpZXJNYWtpbmdXYXZlcyBmcm9tICcuLi8uLi9mb3VyaWVyTWFraW5nV2F2ZXMuanMnO1xyXG5pbXBvcnQgV2F2ZUdhbWVNb2RlbCBmcm9tICcuLi9tb2RlbC9XYXZlR2FtZU1vZGVsLmpzJztcclxuaW1wb3J0IFdhdmVHYW1lTGV2ZWxOb2RlIGZyb20gJy4vV2F2ZUdhbWVMZXZlbE5vZGUuanMnO1xyXG5pbXBvcnQgV2F2ZUdhbWVMZXZlbFNlbGVjdGlvbk5vZGUgZnJvbSAnLi9XYXZlR2FtZUxldmVsU2VsZWN0aW9uTm9kZS5qcyc7XHJcbmltcG9ydCBXYXZlR2FtZVJld2FyZERpYWxvZyBmcm9tICcuL1dhdmVHYW1lUmV3YXJkRGlhbG9nLmpzJztcclxuaW1wb3J0IFdhdmVHYW1lUmV3YXJkTm9kZSBmcm9tICcuL1dhdmVHYW1lUmV3YXJkTm9kZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgVFJBTlNJVElPTl9PUFRJT05TID0ge1xyXG4gIGR1cmF0aW9uOiAwLjUsIC8vIHNlY1xyXG4gIHRhcmdldE9wdGlvbnM6IHtcclxuICAgIGVhc2luZzogRWFzaW5nLlFVQURSQVRJQ19JTl9PVVRcclxuICB9XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXYXZlR2FtZVNjcmVlblZpZXcgZXh0ZW5kcyBTY3JlZW5WaWV3IHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtXYXZlR2FtZU1vZGVsfSBtb2RlbFxyXG4gICAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbW9kZWwsIHRhbmRlbSApIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIG1vZGVsIGluc3RhbmNlb2YgV2F2ZUdhbWVNb2RlbCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGFuZGVtIGluc3RhbmNlb2YgVGFuZGVtICk7XHJcblxyXG4gICAgc3VwZXIoIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBUbyBpbXByb3ZlIHJlYWRhYmlsaXR5XHJcbiAgICBjb25zdCBsYXlvdXRCb3VuZHMgPSB0aGlzLmxheW91dEJvdW5kcztcclxuXHJcbiAgICBjb25zdCBnYW1lQXVkaW9QbGF5ZXIgPSBuZXcgR2FtZUF1ZGlvUGxheWVyKCk7XHJcblxyXG4gICAgLy8gVUkgZm9yIGxldmVsIHNlbGVjdGlvbiBhbmQgb3RoZXIgZ2FtZSBzZXR0aW5nc1xyXG4gICAgY29uc3QgbGV2ZWxTZWxlY3Rpb25Ob2RlID0gbmV3IFdhdmVHYW1lTGV2ZWxTZWxlY3Rpb25Ob2RlKCBtb2RlbCwgbGF5b3V0Qm91bmRzLCB7XHJcbiAgICAgIHJlc2V0Q2FsbGJhY2s6ICgpID0+IHtcclxuICAgICAgICBtb2RlbC5yZXNldCgpO1xyXG4gICAgICB9LFxyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdsZXZlbFNlbGVjdGlvbk5vZGUnIClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSBUaGUgcmV3YXJkIHNob3duIHdoaWxlIHJld2FyZERpYWxvZyBpcyBvcGVuLlxyXG4gICAgdGhpcy5yZXdhcmROb2RlID0gbmV3IFdhdmVHYW1lUmV3YXJkTm9kZSgge1xyXG4gICAgICB2aXNpYmxlOiBmYWxzZSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAncmV3YXJkTm9kZScgKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWVcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBEaWFsb2cgdGhhdCBpcyBkaXNwbGF5ZWQgd2hlbiB0aGUgc2NvcmUgcmVhY2hlcyB0aGUgcmV3YXJkIHZhbHVlLlxyXG4gICAgY29uc3QgcmV3YXJkRGlhbG9nID0gbmV3IFdhdmVHYW1lUmV3YXJkRGlhbG9nKCBtb2RlbC5sZXZlbFByb3BlcnR5LCB0aGlzLnJld2FyZE5vZGUsIG1vZGVsLnJld2FyZFNjb3JlLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Jld2FyZERpYWxvZycgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtTb2x2ZUl0TGV2ZWxOb2RlW119IGEgTm9kZSBmb3IgZWFjaCBsZXZlbCBvZiB0aGUgZ2FtZVxyXG4gICAgdGhpcy5sZXZlbE5vZGVzID0gbW9kZWwubGV2ZWxzLm1hcCggbGV2ZWwgPT4gbmV3IFdhdmVHYW1lTGV2ZWxOb2RlKCBsZXZlbCwgbW9kZWwubGV2ZWxQcm9wZXJ0eSxcclxuICAgICAgbGF5b3V0Qm91bmRzLCB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSwgZ2FtZUF1ZGlvUGxheWVyLCB0aGlzLnJld2FyZE5vZGUsIHJld2FyZERpYWxvZywgbW9kZWwucmV3YXJkU2NvcmUsIHtcclxuICAgICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oIGBsZXZlbCR7bGV2ZWwubGV2ZWxOdW1iZXJ9Tm9kZWAgKVxyXG4gICAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSBIYW5kbGVzIHRoZSBhbmltYXRlZCAnc2xpZGUnIHRyYW5zaXRpb24gYmV0d2VlbiBsZXZlbFNlbGVjdGlvbk5vZGUgYW5kIGEgbGV2ZWwuXHJcbiAgICB0aGlzLnRyYW5zaXRpb25Ob2RlID0gbmV3IFRyYW5zaXRpb25Ob2RlKCB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSwge1xyXG4gICAgICBjb250ZW50OiBsZXZlbFNlbGVjdGlvbk5vZGUsXHJcbiAgICAgIGNhY2hlZE5vZGVzOiBbIGxldmVsU2VsZWN0aW9uTm9kZSwgLi4udGhpcy5sZXZlbE5vZGVzIF1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBUcmFuc2l0aW9uIGJldHdlZW4gbGV2ZWxTZWxlY3Rpb25Ob2RlIGFuZCB0aGUgc2VsZWN0ZWQgbGV2ZWwuXHJcbiAgICAvLyBBIG51bGwgdmFsdWUgZm9yIGxldmVsUHJvcGVydHkgaW5kaWNhdGVzIHRoYXQgbm8gbGV2ZWwgaXMgc2VsZWN0ZWQsIGFuZCBsZXZlbFNlbGVjdGlvbk5vZGUgc2hvdWxkIGJlIHNob3duLlxyXG4gICAgbW9kZWwubGV2ZWxQcm9wZXJ0eS5sYXp5TGluayggKCBsZXZlbCwgcHJldmlvdXNMZXZlbCApID0+IHtcclxuXHJcbiAgICAgIHRoaXMuaW50ZXJydXB0U3VidHJlZUlucHV0KCk7XHJcblxyXG4gICAgICBpZiAoIGxldmVsICkge1xyXG5cclxuICAgICAgICAvLyBUcmFuc2l0aW9uIHRvIHRoZSBzZWxlY3RlZCBsZXZlbC5cclxuICAgICAgICBjb25zdCBzZWxlY3RlZExldmVsTm9kZSA9IF8uZmluZCggdGhpcy5sZXZlbE5vZGVzLCBsZXZlbE5vZGUgPT4gKCBsZXZlbE5vZGUubGV2ZWwgPT09IGxldmVsICkgKTtcclxuICAgICAgICBjb25zdCB0cmFuc2l0aW9uID0gdGhpcy50cmFuc2l0aW9uTm9kZS5zbGlkZUxlZnRUbyggc2VsZWN0ZWRMZXZlbE5vZGUsIFRSQU5TSVRJT05fT1BUSU9OUyApO1xyXG5cclxuICAgICAgICAvLyBTZXQgZm9jdXMgdG8gdGhlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50IGluIHNlbGVjdGVkTGV2ZWxOb2RlLlxyXG4gICAgICAgIC8vIFNlZSBzcGVjaWZpY2F0aW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy92ZWdhcy9pc3N1ZXMvOTAjaXNzdWVjb21tZW50LTg1NDAzNDgxNlxyXG4gICAgICAgIGNvbnN0IHRyYW5zaXRpb25FbmRlZExpc3RlbmVyID0gKCkgPT4ge1xyXG4gICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy50cmFuc2l0aW9uTm9kZS5oYXNDaGlsZCggc2VsZWN0ZWRMZXZlbE5vZGUgKSAmJiBzZWxlY3RlZExldmVsTm9kZS52aXNpYmxlICk7XHJcblxyXG4gICAgICAgICAgLy8gVGhpcyBpcyBhIGxpdHRsZSBicml0dGxlLiBJZiBhbnl0aGluZyBlbHNlIGlzIGFkZGVkIHRvIHRoZSBzY3JlZW4gaW4gdGhlIGZ1dHVyZSB0aGF0IGlzXHJcbiAgICAgICAgICAvLyBub3QgYXNzb2NpYXRlZCB3aXRoIHRyYW5zaXRpb25Ob2RlLCB0aGVuIGl0IG1pZ2h0IGdldCB0aGUgZm9jdXMuXHJcbiAgICAgICAgICBQRE9NVXRpbHMuZ2V0Rmlyc3RGb2N1c2FibGUoKS5mb2N1cygpO1xyXG4gICAgICAgICAgdHJhbnNpdGlvbi5lbmRlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRyYW5zaXRpb25FbmRlZExpc3RlbmVyICk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0cmFuc2l0aW9uLmVuZGVkRW1pdHRlci5hZGRMaXN0ZW5lciggdHJhbnNpdGlvbkVuZGVkTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgLy8gU2VsZWN0ZWQgbGV2ZWwgd2FzIG51bGwsIHNvIHRyYW5zaXRpb24gdG8gbGV2ZWxTZWxlY3Rpb25Ob2RlLlxyXG4gICAgICAgIGNvbnN0IHRyYW5zaXRpb24gPSB0aGlzLnRyYW5zaXRpb25Ob2RlLnNsaWRlUmlnaHRUbyggbGV2ZWxTZWxlY3Rpb25Ob2RlLCBUUkFOU0lUSU9OX09QVElPTlMgKTtcclxuXHJcbiAgICAgICAgLy8gU2V0IGZvY3VzIHRvIHRoZSBsZXZlbC1zZWxlY3Rpb24gYnV0dG9uIHRoYXQgaXMgYXNzb2NpYXRlZCB3aXRoIHByZXZpb3VzTGV2ZWwuXHJcbiAgICAgICAgLy8gU2VlIHNwZWNpZmljYXRpb24gYXQgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3ZlZ2FzL2lzc3Vlcy85MCNpc3N1ZWNvbW1lbnQtODU0MDM0ODE2XHJcbiAgICAgICAgY29uc3QgdHJhbnNpdGlvbkVuZGVkTGlzdGVuZXIgPSAoKSA9PiB7XHJcbiAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLnRyYW5zaXRpb25Ob2RlLmhhc0NoaWxkKCBsZXZlbFNlbGVjdGlvbk5vZGUgKSAmJiBsZXZlbFNlbGVjdGlvbk5vZGUudmlzaWJsZSApO1xyXG4gICAgICAgICAgbGV2ZWxTZWxlY3Rpb25Ob2RlLmZvY3VzTGV2ZWxTZWxlY3Rpb25CdXR0b24oIHByZXZpb3VzTGV2ZWwgKTtcclxuICAgICAgICAgIHRyYW5zaXRpb24uZW5kZWRFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCB0cmFuc2l0aW9uRW5kZWRMaXN0ZW5lciApO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdHJhbnNpdGlvbi5lbmRlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRyYW5zaXRpb25FbmRlZExpc3RlbmVyICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLnRyYW5zaXRpb25Ob2RlICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLnJld2FyZE5vZGUgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZmFsc2UsICdkaXNwb3NlIGlzIG5vdCBzdXBwb3J0ZWQsIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0nICk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGVwcyB0aGUgdmlldy5cclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHQgLSB0aW1lIHN0ZXAsIGluIHNlY29uZHNcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgc3RlcCggZHQgKSB7XHJcblxyXG4gICAgdGhpcy5yZXdhcmROb2RlLnZpc2libGUgJiYgdGhpcy5yZXdhcmROb2RlLnN0ZXAoIGR0ICk7XHJcblxyXG4gICAgLy8gYW5pbWF0ZSB0aGUgdmlldyBmb3IgdGhlIHNlbGVjdGVkIGxldmVsXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmxldmVsTm9kZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IGxldmVsTm9kZSA9IHRoaXMubGV2ZWxOb2Rlc1sgaSBdO1xyXG4gICAgICBpZiAoIGxldmVsTm9kZS52aXNpYmxlICkge1xyXG4gICAgICAgIGxldmVsTm9kZS5zdGVwKCBkdCApO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mb3VyaWVyTWFraW5nV2F2ZXMucmVnaXN0ZXIoICdXYXZlR2FtZVNjcmVlblZpZXcnLCBXYXZlR2FtZVNjcmVl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