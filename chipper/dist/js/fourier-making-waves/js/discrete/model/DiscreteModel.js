// Copyright 2020-2023, University of Colorado Boulder

/**
 * DiscreteModel is the top-level model for the 'Discrete' screen.
 *
 * @author Chris Malley (PixelZoom, Inc.
 */

import animationFrameTimer from '../../../../axon/js/animationFrameTimer.js';
import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Emitter from '../../../../axon/js/Emitter.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Property from '../../../../axon/js/Property.js';
import FMWSymbols from '../../common/FMWSymbols.js';
import Domain from '../../common/model/Domain.js';
import EmphasizedHarmonics from '../../common/model/EmphasizedHarmonics.js';
import SeriesType from '../../common/model/SeriesType.js';
import TickLabelFormat from '../../common/model/TickLabelFormat.js';
import fourierMakingWaves from '../../fourierMakingWaves.js';
import DiscreteAmplitudesChart from './DiscreteAmplitudesChart.js';
import DiscreteAxisDescriptions from './DiscreteAxisDescriptions.js';
import DiscreteFourierSeries from './DiscreteFourierSeries.js';
import DiscreteHarmonicsChart from './DiscreteHarmonicsChart.js';
import DiscreteMeasurementTool from './DiscreteMeasurementTool.js';
import DiscreteSumChart from './DiscreteSumChart.js';
import EquationForm from './EquationForm.js';
import Waveform from './Waveform.js';

// This factor slows down time for the 'space & time' Domain, determined empirically.
const TIME_SCALE = 0.001;

// How much to step the simulation when the Step button is pressed, in milliseconds, determined empirically.
const STEP_DT = 50;
export default class DiscreteModel {
  // time (t), updated only when domainProperty is Domain.SPACE_AND_TIME
  // While the units are in milliseconds, the value is scaled so that it's practical to show high-frequency
  // phenomena in the sim, specifically in the 'space & time' Domain.
  // the wavelength measurement tool
  // the period measurement tool
  // emits if you try to make a sawtooth wave with cosines
  constructor(tandem) {
    this.isPlayingProperty = new BooleanProperty(true, {
      tandem: tandem.createTandem('isPlayingProperty')
    });
    this.tProperty = new NumberProperty(0, {
      phetioDocumentation: 'time in millisecond, relevant only for function of space & time',
      phetioReadOnly: true,
      tandem: tandem.createTandem('tProperty')
    });
    this.waveformProperty = new Property(Waveform.SINUSOID, {
      tandem: tandem.createTandem('waveformProperty'),
      phetioValueType: Waveform.WaveformIO
    });
    this.seriesTypeProperty = new EnumerationProperty(SeriesType.SIN, {
      tandem: tandem.createTandem('seriesTypeProperty')
    });
    this.domainProperty = new EnumerationProperty(Domain.SPACE, {
      validValues: Domain.enumeration.values,
      // all Domain values are supported
      tandem: tandem.createTandem('domainProperty')
    });
    this.equationFormProperty = new EnumerationProperty(EquationForm.HIDDEN, {
      tandem: tandem.createTandem('equationFormProperty')
    });
    this.fourierSeries = new DiscreteFourierSeries({
      tandem: tandem.createTandem('fourierSeries')
    });

    // the harmonics to be emphasized in the Harmonics chart, as the result of UI interactions
    const emphasizedHarmonics = new EmphasizedHarmonics();

    // Group elements related to measurement tools under this tandem.
    const measurementToolsTandem = tandem.createTandem('measurementTools');
    this.wavelengthTool = new DiscreteMeasurementTool(FMWSymbols.lambdaStringProperty, this.fourierSeries.numberOfHarmonicsProperty, measurementToolsTandem.createTandem('wavelengthTool'));
    this.periodTool = new DiscreteMeasurementTool(FMWSymbols.TStringProperty, this.fourierSeries.numberOfHarmonicsProperty, measurementToolsTandem.createTandem('periodTool'));

    // {DerivedProperty.<TickLabelFormat>}
    // Determines the format of the x-axis tick labels, shared by the Harmonics and Sum charts.
    const xAxisTickLabelFormatProperty = new DerivedProperty([this.equationFormProperty], equationForm => equationForm === EquationForm.HIDDEN ? TickLabelFormat.NUMERIC : TickLabelFormat.SYMBOLIC);

    // {Property.<AxisDescription>} the x-axis description is shared by the Harmonics and Sum charts.
    const xAxisDescriptionProperty = new Property(DiscreteAxisDescriptions.DEFAULT_X_AXIS_DESCRIPTION, {
      validValues: DiscreteAxisDescriptions.X_AXIS_DESCRIPTIONS
    });

    // Parent tandem for all charts
    const chartsTandem = tandem.createTandem('charts');
    this.amplitudesChart = new DiscreteAmplitudesChart(this.fourierSeries, emphasizedHarmonics, chartsTandem.createTandem('amplitudesChart'));
    this.harmonicsChart = new DiscreteHarmonicsChart(this.fourierSeries, emphasizedHarmonics, this.domainProperty, this.seriesTypeProperty, this.tProperty, xAxisTickLabelFormatProperty, xAxisDescriptionProperty, chartsTandem.createTandem('harmonicsChart'));
    this.sumChart = new DiscreteSumChart(this.fourierSeries, this.domainProperty, this.seriesTypeProperty, this.tProperty, xAxisTickLabelFormatProperty, xAxisDescriptionProperty, this.waveformProperty, chartsTandem.createTandem('sumChart'));
    this.oopsSawtoothWithCosinesEmitter = new Emitter({
      tandem: tandem.createTandem('oopsSawtoothWithCosinesEmitter')
    });

    // Update the amplitudes
    Multilink.multilink([this.fourierSeries.numberOfHarmonicsProperty, this.waveformProperty, this.seriesTypeProperty], () => this.updateAmplitudes());

    // Changing these things resets time (t).
    Multilink.multilink([this.waveformProperty, this.domainProperty], () => this.tProperty.reset());

    // Ensure that the math form is appropriate for the Domain. EquationForm.MODE is supported for all Domain values.
    this.domainProperty.link(() => {
      if (this.equationFormProperty.value !== EquationForm.MODE) {
        this.equationFormProperty.value = EquationForm.HIDDEN;
      }
    });
    this.resetDiscreteModel = () => {
      // Reset Properties
      this.isPlayingProperty.reset();
      this.tProperty.reset();
      this.waveformProperty.reset();
      this.seriesTypeProperty.reset();
      this.domainProperty.reset();
      this.equationFormProperty.reset();
      xAxisDescriptionProperty.reset();

      // Reset subcomponents
      this.fourierSeries.reset();
      emphasizedHarmonics.reset();
      this.wavelengthTool.reset();
      this.periodTool.reset();
      this.harmonicsChart.reset();
      this.sumChart.reset();

      // Update the amplitudes of the Fourier series to match Property settings.
      this.updateAmplitudes();
    };
  }
  reset() {
    this.resetDiscreteModel();
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }

  /**
   * Steps the model.
   * @param dt - time step, in seconds
   */
  step(dt) {
    if (this.isPlayingProperty.value && this.domainProperty.value === Domain.SPACE_AND_TIME) {
      const milliseconds = dt * 1000;
      this.tProperty.value += milliseconds * TIME_SCALE;
    }
  }

  /**
   * Steps the model once step. This is called when the Step button is pressed.
   */
  stepOnce() {
    this.tProperty.value += STEP_DT * TIME_SCALE;
  }

  /**
   * Updates amplitudes to match a pre-defined waveform.
   */
  updateAmplitudes() {
    const waveform = this.waveformProperty.value; // {Waveform}
    const seriesType = this.seriesTypeProperty.value; // {SeriesType}

    if (waveform === Waveform.SAWTOOTH && seriesType === SeriesType.COS) {
      phet.log && phet.log('not possible to make a sawtooth out of cosines, switching to sine');
      this.oopsSawtoothWithCosinesEmitter.emit();

      // Set all amplitudes to zero, so that we don't briefly see a bogus Sum plot.
      // See https://github.com/phetsims/fourier-making-waves/issues/111
      this.fourierSeries.setAllAmplitudes(0);

      // Switch to sine on the next frame, so that we don't have a reentry problem with seriesTypeProperty.
      // We'd prefer not to set seriesTypeProperty to reentrant: true. And AquaRadioButton seems to have a
      // problem setting its state correctly when its associated Property is reentered in the same frame.
      animationFrameTimer.runOnNextTick(() => {
        this.seriesTypeProperty.value = SeriesType.SIN;
      });
    } else if (waveform !== Waveform.CUSTOM) {
      const numberOfHarmonics = this.fourierSeries.numberOfHarmonicsProperty.value;
      const amplitudes = waveform.getAmplitudes(numberOfHarmonics, seriesType);

      // Add zero amplitudes as needed, so that we have an amplitude for every harmonic in fourierSeries.
      for (let i = amplitudes.length; i < this.fourierSeries.harmonics.length; i++) {
        amplitudes.push(0);
      }
      this.fourierSeries.setAmplitudes(amplitudes);
    }
  }
}
fourierMakingWaves.register('DiscreteModel', DiscreteModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhbmltYXRpb25GcmFtZVRpbWVyIiwiQm9vbGVhblByb3BlcnR5IiwiRGVyaXZlZFByb3BlcnR5IiwiRW1pdHRlciIsIkVudW1lcmF0aW9uUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJOdW1iZXJQcm9wZXJ0eSIsIlByb3BlcnR5IiwiRk1XU3ltYm9scyIsIkRvbWFpbiIsIkVtcGhhc2l6ZWRIYXJtb25pY3MiLCJTZXJpZXNUeXBlIiwiVGlja0xhYmVsRm9ybWF0IiwiZm91cmllck1ha2luZ1dhdmVzIiwiRGlzY3JldGVBbXBsaXR1ZGVzQ2hhcnQiLCJEaXNjcmV0ZUF4aXNEZXNjcmlwdGlvbnMiLCJEaXNjcmV0ZUZvdXJpZXJTZXJpZXMiLCJEaXNjcmV0ZUhhcm1vbmljc0NoYXJ0IiwiRGlzY3JldGVNZWFzdXJlbWVudFRvb2wiLCJEaXNjcmV0ZVN1bUNoYXJ0IiwiRXF1YXRpb25Gb3JtIiwiV2F2ZWZvcm0iLCJUSU1FX1NDQUxFIiwiU1RFUF9EVCIsIkRpc2NyZXRlTW9kZWwiLCJjb25zdHJ1Y3RvciIsInRhbmRlbSIsImlzUGxheWluZ1Byb3BlcnR5IiwiY3JlYXRlVGFuZGVtIiwidFByb3BlcnR5IiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInBoZXRpb1JlYWRPbmx5Iiwid2F2ZWZvcm1Qcm9wZXJ0eSIsIlNJTlVTT0lEIiwicGhldGlvVmFsdWVUeXBlIiwiV2F2ZWZvcm1JTyIsInNlcmllc1R5cGVQcm9wZXJ0eSIsIlNJTiIsImRvbWFpblByb3BlcnR5IiwiU1BBQ0UiLCJ2YWxpZFZhbHVlcyIsImVudW1lcmF0aW9uIiwidmFsdWVzIiwiZXF1YXRpb25Gb3JtUHJvcGVydHkiLCJISURERU4iLCJmb3VyaWVyU2VyaWVzIiwiZW1waGFzaXplZEhhcm1vbmljcyIsIm1lYXN1cmVtZW50VG9vbHNUYW5kZW0iLCJ3YXZlbGVuZ3RoVG9vbCIsImxhbWJkYVN0cmluZ1Byb3BlcnR5IiwibnVtYmVyT2ZIYXJtb25pY3NQcm9wZXJ0eSIsInBlcmlvZFRvb2wiLCJUU3RyaW5nUHJvcGVydHkiLCJ4QXhpc1RpY2tMYWJlbEZvcm1hdFByb3BlcnR5IiwiZXF1YXRpb25Gb3JtIiwiTlVNRVJJQyIsIlNZTUJPTElDIiwieEF4aXNEZXNjcmlwdGlvblByb3BlcnR5IiwiREVGQVVMVF9YX0FYSVNfREVTQ1JJUFRJT04iLCJYX0FYSVNfREVTQ1JJUFRJT05TIiwiY2hhcnRzVGFuZGVtIiwiYW1wbGl0dWRlc0NoYXJ0IiwiaGFybW9uaWNzQ2hhcnQiLCJzdW1DaGFydCIsIm9vcHNTYXd0b290aFdpdGhDb3NpbmVzRW1pdHRlciIsIm11bHRpbGluayIsInVwZGF0ZUFtcGxpdHVkZXMiLCJyZXNldCIsImxpbmsiLCJ2YWx1ZSIsIk1PREUiLCJyZXNldERpc2NyZXRlTW9kZWwiLCJkaXNwb3NlIiwiYXNzZXJ0Iiwic3RlcCIsImR0IiwiU1BBQ0VfQU5EX1RJTUUiLCJtaWxsaXNlY29uZHMiLCJzdGVwT25jZSIsIndhdmVmb3JtIiwic2VyaWVzVHlwZSIsIlNBV1RPT1RIIiwiQ09TIiwicGhldCIsImxvZyIsImVtaXQiLCJzZXRBbGxBbXBsaXR1ZGVzIiwicnVuT25OZXh0VGljayIsIkNVU1RPTSIsIm51bWJlck9mSGFybW9uaWNzIiwiYW1wbGl0dWRlcyIsImdldEFtcGxpdHVkZXMiLCJpIiwibGVuZ3RoIiwiaGFybW9uaWNzIiwicHVzaCIsInNldEFtcGxpdHVkZXMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkRpc2NyZXRlTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGlzY3JldGVNb2RlbCBpcyB0aGUgdG9wLWxldmVsIG1vZGVsIGZvciB0aGUgJ0Rpc2NyZXRlJyBzY3JlZW4uXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy5cclxuICovXHJcblxyXG5pbXBvcnQgYW5pbWF0aW9uRnJhbWVUaW1lciBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL2FuaW1hdGlvbkZyYW1lVGltZXIuanMnO1xyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW51bWVyYXRpb25Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFRNb2RlbCBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9UTW9kZWwuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgRk1XU3ltYm9scyBmcm9tICcuLi8uLi9jb21tb24vRk1XU3ltYm9scy5qcyc7XHJcbmltcG9ydCBEb21haW4gZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0RvbWFpbi5qcyc7XHJcbmltcG9ydCBFbXBoYXNpemVkSGFybW9uaWNzIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9FbXBoYXNpemVkSGFybW9uaWNzLmpzJztcclxuaW1wb3J0IFNlcmllc1R5cGUgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL1Nlcmllc1R5cGUuanMnO1xyXG5pbXBvcnQgVGlja0xhYmVsRm9ybWF0IGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9UaWNrTGFiZWxGb3JtYXQuanMnO1xyXG5pbXBvcnQgZm91cmllck1ha2luZ1dhdmVzIGZyb20gJy4uLy4uL2ZvdXJpZXJNYWtpbmdXYXZlcy5qcyc7XHJcbmltcG9ydCBEaXNjcmV0ZUFtcGxpdHVkZXNDaGFydCBmcm9tICcuL0Rpc2NyZXRlQW1wbGl0dWRlc0NoYXJ0LmpzJztcclxuaW1wb3J0IERpc2NyZXRlQXhpc0Rlc2NyaXB0aW9ucyBmcm9tICcuL0Rpc2NyZXRlQXhpc0Rlc2NyaXB0aW9ucy5qcyc7XHJcbmltcG9ydCBEaXNjcmV0ZUZvdXJpZXJTZXJpZXMgZnJvbSAnLi9EaXNjcmV0ZUZvdXJpZXJTZXJpZXMuanMnO1xyXG5pbXBvcnQgRGlzY3JldGVIYXJtb25pY3NDaGFydCBmcm9tICcuL0Rpc2NyZXRlSGFybW9uaWNzQ2hhcnQuanMnO1xyXG5pbXBvcnQgRGlzY3JldGVNZWFzdXJlbWVudFRvb2wgZnJvbSAnLi9EaXNjcmV0ZU1lYXN1cmVtZW50VG9vbC5qcyc7XHJcbmltcG9ydCBEaXNjcmV0ZVN1bUNoYXJ0IGZyb20gJy4vRGlzY3JldGVTdW1DaGFydC5qcyc7XHJcbmltcG9ydCBFcXVhdGlvbkZvcm0gZnJvbSAnLi9FcXVhdGlvbkZvcm0uanMnO1xyXG5pbXBvcnQgV2F2ZWZvcm0gZnJvbSAnLi9XYXZlZm9ybS5qcyc7XHJcblxyXG4vLyBUaGlzIGZhY3RvciBzbG93cyBkb3duIHRpbWUgZm9yIHRoZSAnc3BhY2UgJiB0aW1lJyBEb21haW4sIGRldGVybWluZWQgZW1waXJpY2FsbHkuXHJcbmNvbnN0IFRJTUVfU0NBTEUgPSAwLjAwMTtcclxuXHJcbi8vIEhvdyBtdWNoIHRvIHN0ZXAgdGhlIHNpbXVsYXRpb24gd2hlbiB0aGUgU3RlcCBidXR0b24gaXMgcHJlc3NlZCwgaW4gbWlsbGlzZWNvbmRzLCBkZXRlcm1pbmVkIGVtcGlyaWNhbGx5LlxyXG5jb25zdCBTVEVQX0RUID0gNTA7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEaXNjcmV0ZU1vZGVsIGltcGxlbWVudHMgVE1vZGVsIHtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGlzUGxheWluZ1Byb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gdGltZSAodCksIHVwZGF0ZWQgb25seSB3aGVuIGRvbWFpblByb3BlcnR5IGlzIERvbWFpbi5TUEFDRV9BTkRfVElNRVxyXG4gIC8vIFdoaWxlIHRoZSB1bml0cyBhcmUgaW4gbWlsbGlzZWNvbmRzLCB0aGUgdmFsdWUgaXMgc2NhbGVkIHNvIHRoYXQgaXQncyBwcmFjdGljYWwgdG8gc2hvdyBoaWdoLWZyZXF1ZW5jeVxyXG4gIC8vIHBoZW5vbWVuYSBpbiB0aGUgc2ltLCBzcGVjaWZpY2FsbHkgaW4gdGhlICdzcGFjZSAmIHRpbWUnIERvbWFpbi5cclxuICBwdWJsaWMgcmVhZG9ubHkgdFByb3BlcnR5OiBOdW1iZXJQcm9wZXJ0eTtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IHdhdmVmb3JtUHJvcGVydHk6IFByb3BlcnR5PFdhdmVmb3JtPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgc2VyaWVzVHlwZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PFNlcmllc1R5cGU+O1xyXG4gIHB1YmxpYyByZWFkb25seSBkb21haW5Qcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxEb21haW4+O1xyXG4gIHB1YmxpYyByZWFkb25seSBlcXVhdGlvbkZvcm1Qcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxFcXVhdGlvbkZvcm0+O1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgZm91cmllclNlcmllczogRGlzY3JldGVGb3VyaWVyU2VyaWVzO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgd2F2ZWxlbmd0aFRvb2w6IERpc2NyZXRlTWVhc3VyZW1lbnRUb29sOyAvLyB0aGUgd2F2ZWxlbmd0aCBtZWFzdXJlbWVudCB0b29sXHJcbiAgcHVibGljIHJlYWRvbmx5IHBlcmlvZFRvb2w6IERpc2NyZXRlTWVhc3VyZW1lbnRUb29sOyAvLyB0aGUgcGVyaW9kIG1lYXN1cmVtZW50IHRvb2xcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGFtcGxpdHVkZXNDaGFydDogRGlzY3JldGVBbXBsaXR1ZGVzQ2hhcnQ7XHJcbiAgcHVibGljIHJlYWRvbmx5IGhhcm1vbmljc0NoYXJ0OiBEaXNjcmV0ZUhhcm1vbmljc0NoYXJ0O1xyXG4gIHB1YmxpYyByZWFkb25seSBzdW1DaGFydDogRGlzY3JldGVTdW1DaGFydDtcclxuXHJcbiAgLy8gZW1pdHMgaWYgeW91IHRyeSB0byBtYWtlIGEgc2F3dG9vdGggd2F2ZSB3aXRoIGNvc2luZXNcclxuICBwdWJsaWMgcmVhZG9ubHkgb29wc1Nhd3Rvb3RoV2l0aENvc2luZXNFbWl0dGVyOiBFbWl0dGVyO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHJlc2V0RGlzY3JldGVNb2RlbDogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICB0aGlzLmlzUGxheWluZ1Byb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdpc1BsYXlpbmdQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudFByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwLCB7XHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICd0aW1lIGluIG1pbGxpc2Vjb25kLCByZWxldmFudCBvbmx5IGZvciBmdW5jdGlvbiBvZiBzcGFjZSAmIHRpbWUnLFxyXG4gICAgICBwaGV0aW9SZWFkT25seTogdHJ1ZSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAndFByb3BlcnR5JyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy53YXZlZm9ybVByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBXYXZlZm9ybS5TSU5VU09JRCwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICd3YXZlZm9ybVByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9WYWx1ZVR5cGU6IFdhdmVmb3JtLldhdmVmb3JtSU9cclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnNlcmllc1R5cGVQcm9wZXJ0eSA9IG5ldyBFbnVtZXJhdGlvblByb3BlcnR5KCBTZXJpZXNUeXBlLlNJTiwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdzZXJpZXNUeXBlUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmRvbWFpblByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIERvbWFpbi5TUEFDRSwge1xyXG4gICAgICB2YWxpZFZhbHVlczogRG9tYWluLmVudW1lcmF0aW9uLnZhbHVlcywgLy8gYWxsIERvbWFpbiB2YWx1ZXMgYXJlIHN1cHBvcnRlZFxyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdkb21haW5Qcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuZXF1YXRpb25Gb3JtUHJvcGVydHkgPSBuZXcgRW51bWVyYXRpb25Qcm9wZXJ0eSggRXF1YXRpb25Gb3JtLkhJRERFTiwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdlcXVhdGlvbkZvcm1Qcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuZm91cmllclNlcmllcyA9IG5ldyBEaXNjcmV0ZUZvdXJpZXJTZXJpZXMoIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnZm91cmllclNlcmllcycgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHRoZSBoYXJtb25pY3MgdG8gYmUgZW1waGFzaXplZCBpbiB0aGUgSGFybW9uaWNzIGNoYXJ0LCBhcyB0aGUgcmVzdWx0IG9mIFVJIGludGVyYWN0aW9uc1xyXG4gICAgY29uc3QgZW1waGFzaXplZEhhcm1vbmljcyA9IG5ldyBFbXBoYXNpemVkSGFybW9uaWNzKCk7XHJcblxyXG4gICAgLy8gR3JvdXAgZWxlbWVudHMgcmVsYXRlZCB0byBtZWFzdXJlbWVudCB0b29scyB1bmRlciB0aGlzIHRhbmRlbS5cclxuICAgIGNvbnN0IG1lYXN1cmVtZW50VG9vbHNUYW5kZW0gPSB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnbWVhc3VyZW1lbnRUb29scycgKTtcclxuXHJcbiAgICB0aGlzLndhdmVsZW5ndGhUb29sID0gbmV3IERpc2NyZXRlTWVhc3VyZW1lbnRUb29sKCBGTVdTeW1ib2xzLmxhbWJkYVN0cmluZ1Byb3BlcnR5LFxyXG4gICAgICB0aGlzLmZvdXJpZXJTZXJpZXMubnVtYmVyT2ZIYXJtb25pY3NQcm9wZXJ0eSwgbWVhc3VyZW1lbnRUb29sc1RhbmRlbS5jcmVhdGVUYW5kZW0oICd3YXZlbGVuZ3RoVG9vbCcgKSApO1xyXG5cclxuICAgIHRoaXMucGVyaW9kVG9vbCA9IG5ldyBEaXNjcmV0ZU1lYXN1cmVtZW50VG9vbCggRk1XU3ltYm9scy5UU3RyaW5nUHJvcGVydHksXHJcbiAgICAgIHRoaXMuZm91cmllclNlcmllcy5udW1iZXJPZkhhcm1vbmljc1Byb3BlcnR5LCBtZWFzdXJlbWVudFRvb2xzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3BlcmlvZFRvb2wnICkgKTtcclxuXHJcbiAgICAvLyB7RGVyaXZlZFByb3BlcnR5LjxUaWNrTGFiZWxGb3JtYXQ+fVxyXG4gICAgLy8gRGV0ZXJtaW5lcyB0aGUgZm9ybWF0IG9mIHRoZSB4LWF4aXMgdGljayBsYWJlbHMsIHNoYXJlZCBieSB0aGUgSGFybW9uaWNzIGFuZCBTdW0gY2hhcnRzLlxyXG4gICAgY29uc3QgeEF4aXNUaWNrTGFiZWxGb3JtYXRQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgdGhpcy5lcXVhdGlvbkZvcm1Qcm9wZXJ0eSBdLFxyXG4gICAgICBlcXVhdGlvbkZvcm0gPT4gKCBlcXVhdGlvbkZvcm0gPT09IEVxdWF0aW9uRm9ybS5ISURERU4gKSA/IFRpY2tMYWJlbEZvcm1hdC5OVU1FUklDIDogVGlja0xhYmVsRm9ybWF0LlNZTUJPTElDXHJcbiAgICApO1xyXG5cclxuICAgIC8vIHtQcm9wZXJ0eS48QXhpc0Rlc2NyaXB0aW9uPn0gdGhlIHgtYXhpcyBkZXNjcmlwdGlvbiBpcyBzaGFyZWQgYnkgdGhlIEhhcm1vbmljcyBhbmQgU3VtIGNoYXJ0cy5cclxuICAgIGNvbnN0IHhBeGlzRGVzY3JpcHRpb25Qcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggRGlzY3JldGVBeGlzRGVzY3JpcHRpb25zLkRFRkFVTFRfWF9BWElTX0RFU0NSSVBUSU9OLCB7XHJcbiAgICAgIHZhbGlkVmFsdWVzOiBEaXNjcmV0ZUF4aXNEZXNjcmlwdGlvbnMuWF9BWElTX0RFU0NSSVBUSU9OU1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFBhcmVudCB0YW5kZW0gZm9yIGFsbCBjaGFydHNcclxuICAgIGNvbnN0IGNoYXJ0c1RhbmRlbSA9IHRhbmRlbS5jcmVhdGVUYW5kZW0oICdjaGFydHMnICk7XHJcblxyXG4gICAgdGhpcy5hbXBsaXR1ZGVzQ2hhcnQgPSBuZXcgRGlzY3JldGVBbXBsaXR1ZGVzQ2hhcnQoIHRoaXMuZm91cmllclNlcmllcywgZW1waGFzaXplZEhhcm1vbmljcyxcclxuICAgICAgY2hhcnRzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2FtcGxpdHVkZXNDaGFydCcgKSApO1xyXG5cclxuICAgIHRoaXMuaGFybW9uaWNzQ2hhcnQgPSBuZXcgRGlzY3JldGVIYXJtb25pY3NDaGFydCggdGhpcy5mb3VyaWVyU2VyaWVzLCBlbXBoYXNpemVkSGFybW9uaWNzLCB0aGlzLmRvbWFpblByb3BlcnR5LFxyXG4gICAgICB0aGlzLnNlcmllc1R5cGVQcm9wZXJ0eSwgdGhpcy50UHJvcGVydHksIHhBeGlzVGlja0xhYmVsRm9ybWF0UHJvcGVydHksIHhBeGlzRGVzY3JpcHRpb25Qcm9wZXJ0eSxcclxuICAgICAgY2hhcnRzVGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2hhcm1vbmljc0NoYXJ0JyApICk7XHJcblxyXG4gICAgdGhpcy5zdW1DaGFydCA9IG5ldyBEaXNjcmV0ZVN1bUNoYXJ0KCB0aGlzLmZvdXJpZXJTZXJpZXMsIHRoaXMuZG9tYWluUHJvcGVydHksIHRoaXMuc2VyaWVzVHlwZVByb3BlcnR5LFxyXG4gICAgICB0aGlzLnRQcm9wZXJ0eSwgeEF4aXNUaWNrTGFiZWxGb3JtYXRQcm9wZXJ0eSwgeEF4aXNEZXNjcmlwdGlvblByb3BlcnR5LCB0aGlzLndhdmVmb3JtUHJvcGVydHksXHJcbiAgICAgIGNoYXJ0c1RhbmRlbS5jcmVhdGVUYW5kZW0oICdzdW1DaGFydCcgKSApO1xyXG5cclxuICAgIHRoaXMub29wc1Nhd3Rvb3RoV2l0aENvc2luZXNFbWl0dGVyID0gbmV3IEVtaXR0ZXIoIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnb29wc1Nhd3Rvb3RoV2l0aENvc2luZXNFbWl0dGVyJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBhbXBsaXR1ZGVzXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKFxyXG4gICAgICBbIHRoaXMuZm91cmllclNlcmllcy5udW1iZXJPZkhhcm1vbmljc1Byb3BlcnR5LCB0aGlzLndhdmVmb3JtUHJvcGVydHksIHRoaXMuc2VyaWVzVHlwZVByb3BlcnR5IF0sXHJcbiAgICAgICgpID0+IHRoaXMudXBkYXRlQW1wbGl0dWRlcygpXHJcbiAgICApO1xyXG5cclxuICAgIC8vIENoYW5naW5nIHRoZXNlIHRoaW5ncyByZXNldHMgdGltZSAodCkuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKFxyXG4gICAgICBbIHRoaXMud2F2ZWZvcm1Qcm9wZXJ0eSwgdGhpcy5kb21haW5Qcm9wZXJ0eSBdLFxyXG4gICAgICAoKSA9PiB0aGlzLnRQcm9wZXJ0eS5yZXNldCgpXHJcbiAgICApO1xyXG5cclxuICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBtYXRoIGZvcm0gaXMgYXBwcm9wcmlhdGUgZm9yIHRoZSBEb21haW4uIEVxdWF0aW9uRm9ybS5NT0RFIGlzIHN1cHBvcnRlZCBmb3IgYWxsIERvbWFpbiB2YWx1ZXMuXHJcbiAgICB0aGlzLmRvbWFpblByb3BlcnR5LmxpbmsoICgpID0+IHtcclxuICAgICAgaWYgKCB0aGlzLmVxdWF0aW9uRm9ybVByb3BlcnR5LnZhbHVlICE9PSBFcXVhdGlvbkZvcm0uTU9ERSApIHtcclxuICAgICAgICB0aGlzLmVxdWF0aW9uRm9ybVByb3BlcnR5LnZhbHVlID0gRXF1YXRpb25Gb3JtLkhJRERFTjtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMucmVzZXREaXNjcmV0ZU1vZGVsID0gKCkgPT4ge1xyXG5cclxuICAgICAgLy8gUmVzZXQgUHJvcGVydGllc1xyXG4gICAgICB0aGlzLmlzUGxheWluZ1Byb3BlcnR5LnJlc2V0KCk7XHJcbiAgICAgIHRoaXMudFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICAgIHRoaXMud2F2ZWZvcm1Qcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgICB0aGlzLnNlcmllc1R5cGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgICB0aGlzLmRvbWFpblByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICAgIHRoaXMuZXF1YXRpb25Gb3JtUHJvcGVydHkucmVzZXQoKTtcclxuICAgICAgeEF4aXNEZXNjcmlwdGlvblByb3BlcnR5LnJlc2V0KCk7XHJcblxyXG4gICAgICAvLyBSZXNldCBzdWJjb21wb25lbnRzXHJcbiAgICAgIHRoaXMuZm91cmllclNlcmllcy5yZXNldCgpO1xyXG4gICAgICBlbXBoYXNpemVkSGFybW9uaWNzLnJlc2V0KCk7XHJcbiAgICAgIHRoaXMud2F2ZWxlbmd0aFRvb2wucmVzZXQoKTtcclxuICAgICAgdGhpcy5wZXJpb2RUb29sLnJlc2V0KCk7XHJcbiAgICAgIHRoaXMuaGFybW9uaWNzQ2hhcnQucmVzZXQoKTtcclxuICAgICAgdGhpcy5zdW1DaGFydC5yZXNldCgpO1xyXG5cclxuICAgICAgLy8gVXBkYXRlIHRoZSBhbXBsaXR1ZGVzIG9mIHRoZSBGb3VyaWVyIHNlcmllcyB0byBtYXRjaCBQcm9wZXJ0eSBzZXR0aW5ncy5cclxuICAgICAgdGhpcy51cGRhdGVBbXBsaXR1ZGVzKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5yZXNldERpc2NyZXRlTW9kZWwoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZmFsc2UsICdkaXNwb3NlIGlzIG5vdCBzdXBwb3J0ZWQsIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0nICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGVwcyB0aGUgbW9kZWwuXHJcbiAgICogQHBhcmFtIGR0IC0gdGltZSBzdGVwLCBpbiBzZWNvbmRzXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkudmFsdWUgJiYgKCB0aGlzLmRvbWFpblByb3BlcnR5LnZhbHVlID09PSBEb21haW4uU1BBQ0VfQU5EX1RJTUUgKSApIHtcclxuICAgICAgY29uc3QgbWlsbGlzZWNvbmRzID0gZHQgKiAxMDAwO1xyXG4gICAgICB0aGlzLnRQcm9wZXJ0eS52YWx1ZSArPSAoIG1pbGxpc2Vjb25kcyAqIFRJTUVfU0NBTEUgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0ZXBzIHRoZSBtb2RlbCBvbmNlIHN0ZXAuIFRoaXMgaXMgY2FsbGVkIHdoZW4gdGhlIFN0ZXAgYnV0dG9uIGlzIHByZXNzZWQuXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXBPbmNlKCk6IHZvaWQge1xyXG4gICAgdGhpcy50UHJvcGVydHkudmFsdWUgKz0gKCBTVEVQX0RUICogVElNRV9TQ0FMRSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyBhbXBsaXR1ZGVzIHRvIG1hdGNoIGEgcHJlLWRlZmluZWQgd2F2ZWZvcm0uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVBbXBsaXR1ZGVzKCk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHdhdmVmb3JtID0gdGhpcy53YXZlZm9ybVByb3BlcnR5LnZhbHVlOyAvLyB7V2F2ZWZvcm19XHJcbiAgICBjb25zdCBzZXJpZXNUeXBlID0gdGhpcy5zZXJpZXNUeXBlUHJvcGVydHkudmFsdWU7IC8vIHtTZXJpZXNUeXBlfVxyXG5cclxuICAgIGlmICggd2F2ZWZvcm0gPT09IFdhdmVmb3JtLlNBV1RPT1RIICYmIHNlcmllc1R5cGUgPT09IFNlcmllc1R5cGUuQ09TICkge1xyXG4gICAgICBwaGV0LmxvZyAmJiBwaGV0LmxvZyggJ25vdCBwb3NzaWJsZSB0byBtYWtlIGEgc2F3dG9vdGggb3V0IG9mIGNvc2luZXMsIHN3aXRjaGluZyB0byBzaW5lJyApO1xyXG4gICAgICB0aGlzLm9vcHNTYXd0b290aFdpdGhDb3NpbmVzRW1pdHRlci5lbWl0KCk7XHJcblxyXG4gICAgICAvLyBTZXQgYWxsIGFtcGxpdHVkZXMgdG8gemVybywgc28gdGhhdCB3ZSBkb24ndCBicmllZmx5IHNlZSBhIGJvZ3VzIFN1bSBwbG90LlxyXG4gICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2ZvdXJpZXItbWFraW5nLXdhdmVzL2lzc3Vlcy8xMTFcclxuICAgICAgdGhpcy5mb3VyaWVyU2VyaWVzLnNldEFsbEFtcGxpdHVkZXMoIDAgKTtcclxuXHJcbiAgICAgIC8vIFN3aXRjaCB0byBzaW5lIG9uIHRoZSBuZXh0IGZyYW1lLCBzbyB0aGF0IHdlIGRvbid0IGhhdmUgYSByZWVudHJ5IHByb2JsZW0gd2l0aCBzZXJpZXNUeXBlUHJvcGVydHkuXHJcbiAgICAgIC8vIFdlJ2QgcHJlZmVyIG5vdCB0byBzZXQgc2VyaWVzVHlwZVByb3BlcnR5IHRvIHJlZW50cmFudDogdHJ1ZS4gQW5kIEFxdWFSYWRpb0J1dHRvbiBzZWVtcyB0byBoYXZlIGFcclxuICAgICAgLy8gcHJvYmxlbSBzZXR0aW5nIGl0cyBzdGF0ZSBjb3JyZWN0bHkgd2hlbiBpdHMgYXNzb2NpYXRlZCBQcm9wZXJ0eSBpcyByZWVudGVyZWQgaW4gdGhlIHNhbWUgZnJhbWUuXHJcbiAgICAgIGFuaW1hdGlvbkZyYW1lVGltZXIucnVuT25OZXh0VGljayggKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2VyaWVzVHlwZVByb3BlcnR5LnZhbHVlID0gU2VyaWVzVHlwZS5TSU47XHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCB3YXZlZm9ybSAhPT0gV2F2ZWZvcm0uQ1VTVE9NICkge1xyXG4gICAgICBjb25zdCBudW1iZXJPZkhhcm1vbmljcyA9IHRoaXMuZm91cmllclNlcmllcy5udW1iZXJPZkhhcm1vbmljc1Byb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBhbXBsaXR1ZGVzID0gd2F2ZWZvcm0uZ2V0QW1wbGl0dWRlcyggbnVtYmVyT2ZIYXJtb25pY3MsIHNlcmllc1R5cGUgKTtcclxuXHJcbiAgICAgIC8vIEFkZCB6ZXJvIGFtcGxpdHVkZXMgYXMgbmVlZGVkLCBzbyB0aGF0IHdlIGhhdmUgYW4gYW1wbGl0dWRlIGZvciBldmVyeSBoYXJtb25pYyBpbiBmb3VyaWVyU2VyaWVzLlxyXG4gICAgICBmb3IgKCBsZXQgaSA9IGFtcGxpdHVkZXMubGVuZ3RoOyBpIDwgdGhpcy5mb3VyaWVyU2VyaWVzLmhhcm1vbmljcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBhbXBsaXR1ZGVzLnB1c2goIDAgKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmZvdXJpZXJTZXJpZXMuc2V0QW1wbGl0dWRlcyggYW1wbGl0dWRlcyApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZm91cmllck1ha2luZ1dh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