// Copyright 2021-2023, University of Colorado Boulder

/**
 * DiscreteMeasurementToolNode is the base class for tools that are used to measure harmonics in the 'Discrete' screen.
 * Responsibilities include:
 * - positioning the tool
 * - visibility
 * - updating when the associated harmonic changes
 * - emphasizing the associated harmonic on ( isPressed || isHovering )
 * - dragging, constrained to dynamic drag bounds
 * - keeping the tool inside dynamic drag bounds
 * - interrupting a drag
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import Property from '../../../../axon/js/Property.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Vector2Property from '../../../../dot/js/Vector2Property.js';
import merge from '../../../../phet-core/js/merge.js';
import AssertUtils from '../../../../phetcommon/js/AssertUtils.js';
import { Circle, DragListener, KeyboardDragListener, Node } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import FMWQueryParameters from '../../common/FMWQueryParameters.js';
import EmphasizedHarmonics from '../../common/model/EmphasizedHarmonics.js';
import Harmonic from '../../common/model/Harmonic.js';
import fourierMakingWaves from '../../fourierMakingWaves.js';
import DiscreteMeasurementTool from '../model/DiscreteMeasurementTool.js';
export default class DiscreteMeasurementToolNode extends Node {
  /**
   * @param {DiscreteMeasurementTool} tool
   * @param {ReadOnlyProperty.<Harmonic>} harmonicProperty
   * @param {EmphasizedHarmonics} emphasizedHarmonics
   * @param {EnumerationProperty.<Domain>} domainProperty
   * @param {Domain[]} relevantDomains - the Domain values that are relevant for this tool
   * @param {Object} [options]
   */
  constructor(tool, harmonicProperty, emphasizedHarmonics, domainProperty, relevantDomains, options) {
    assert && assert(tool instanceof DiscreteMeasurementTool);
    assert && AssertUtils.assertAbstractPropertyOf(harmonicProperty, Harmonic);
    assert && assert(emphasizedHarmonics instanceof EmphasizedHarmonics);
    assert && assert(domainProperty instanceof EnumerationProperty);
    assert && assert(Array.isArray(relevantDomains));
    options = merge({
      position: new Vector2(0, 0),
      dragBounds: null,
      // {Bounds2|null}

      // For debugging
      debugName: 'tool',
      // Node options
      cursor: 'pointer',
      // pdom
      tagName: 'div',
      focusable: true,
      // phet-io options
      tandem: Tandem.REQUIRED
    }, options);
    assert && assert(!options.visibleProperty, 'DiscreteMeasurementToolNode sets visibleProperty');
    options.visibleProperty = new DerivedProperty([tool.isSelectedProperty, domainProperty], (isSelected, domain) => isSelected && relevantDomains.includes(domain), {
      tandem: options.tandem.createTandem('visibleProperty'),
      phetioValueType: BooleanIO
    });
    super(options);

    // @private
    this.harmonicProperty = harmonicProperty;
    this.emphasizedHarmonics = emphasizedHarmonics;

    // Show a red dot at the tool's origin.
    if (FMWQueryParameters.debugTools) {
      this.addChild(new Circle(2, {
        fill: 'red'
      }));
    }
    const positionProperty = new Vector2Property(options.position, {
      tandem: options.tandem.createTandem('positionProperty'),
      phetioDocumentation: 'position of this tool, in view coordinates'
    });
    positionProperty.link(position => {
      this.translation = position;
    });

    // {Property.<Bounds2>} This is a fixed value, but DragListener requires a Property.
    const dragBoundsProperty = new Property(options.dragBounds, {
      validValues: [options.dragBounds]
    });

    // Constrained dragging of the tool. Some tools (e.g. calipers) may be wider than the ScreenView, so we cannot
    // constrain the entire tool to be within the drag bounds. So just the origin is constrained.
    const dragListener = new DragListener({
      positionProperty: positionProperty,
      dragBoundsProperty: dragBoundsProperty,
      tandem: options.tandem.createTandem('dragListener'),
      phetioEnabledPropertyInstrumented: true
    });
    this.addInputListener(dragListener);

    // Whether this slider has keyboard focus.
    const hasFocusProperty = new BooleanProperty(this.focused);
    this.addInputListener({
      focus: () => {
        hasFocusProperty.value = true;
      },
      blur: () => {
        hasFocusProperty.value = false;
      }
    });

    // {DerivedProperty.<boolean>}
    // The associated harmonic is emphasized if we're interacting with the tool in some way.
    const isEmphasizedProperty = DerivedProperty.or([dragListener.isHighlightedProperty, hasFocusProperty]);

    // Emphasize the associated harmonic while interacting with this tool.
    isEmphasizedProperty.lazyLink(isEmphasized => {
      const harmonic = harmonicProperty.value;
      phet.log && phet.log(`${options.debugName} isEmphasized=${isEmphasized} n=${harmonic.order}`);
      if (isEmphasized) {
        emphasizedHarmonics.push(this, harmonic);
      } else if (emphasizedHarmonics.includesNode(this)) {
        emphasizedHarmonics.remove(this);
      }
    });

    // Interrupt interaction
    harmonicProperty.lazyLink(() => this.interruptSubtreeInput());
    this.visibleProperty.lazyLink(() => this.interruptSubtreeInput());

    // pdom - dragging using the keyboard
    const keyboardDragListener = new KeyboardDragListener({
      positionProperty: positionProperty,
      dragBoundsProperty: dragBoundsProperty,
      dragVelocity: 100,
      // velocity - change in position per second
      shiftDragVelocity: 20,
      // finer-grained
      tandem: options.tandem.createTandem('keyboardDragListener')
    });
    this.addInputListener(keyboardDragListener);

    // @public
    this.positionProperty = positionProperty; // {Property.<Vector2>}
  }

  /**
   * @public
   * @override
   */
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }

  /**
   * @public
   */
  reset() {
    this.positionProperty.reset();
  }
}
fourierMakingWaves.register('DiscreteMeasurementToolNode', DiscreteMeasurementToolNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJFbnVtZXJhdGlvblByb3BlcnR5IiwiUHJvcGVydHkiLCJWZWN0b3IyIiwiVmVjdG9yMlByb3BlcnR5IiwibWVyZ2UiLCJBc3NlcnRVdGlscyIsIkNpcmNsZSIsIkRyYWdMaXN0ZW5lciIsIktleWJvYXJkRHJhZ0xpc3RlbmVyIiwiTm9kZSIsIlRhbmRlbSIsIkJvb2xlYW5JTyIsIkZNV1F1ZXJ5UGFyYW1ldGVycyIsIkVtcGhhc2l6ZWRIYXJtb25pY3MiLCJIYXJtb25pYyIsImZvdXJpZXJNYWtpbmdXYXZlcyIsIkRpc2NyZXRlTWVhc3VyZW1lbnRUb29sIiwiRGlzY3JldGVNZWFzdXJlbWVudFRvb2xOb2RlIiwiY29uc3RydWN0b3IiLCJ0b29sIiwiaGFybW9uaWNQcm9wZXJ0eSIsImVtcGhhc2l6ZWRIYXJtb25pY3MiLCJkb21haW5Qcm9wZXJ0eSIsInJlbGV2YW50RG9tYWlucyIsIm9wdGlvbnMiLCJhc3NlcnQiLCJhc3NlcnRBYnN0cmFjdFByb3BlcnR5T2YiLCJBcnJheSIsImlzQXJyYXkiLCJwb3NpdGlvbiIsImRyYWdCb3VuZHMiLCJkZWJ1Z05hbWUiLCJjdXJzb3IiLCJ0YWdOYW1lIiwiZm9jdXNhYmxlIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJ2aXNpYmxlUHJvcGVydHkiLCJpc1NlbGVjdGVkUHJvcGVydHkiLCJpc1NlbGVjdGVkIiwiZG9tYWluIiwiaW5jbHVkZXMiLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9WYWx1ZVR5cGUiLCJkZWJ1Z1Rvb2xzIiwiYWRkQ2hpbGQiLCJmaWxsIiwicG9zaXRpb25Qcm9wZXJ0eSIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJsaW5rIiwidHJhbnNsYXRpb24iLCJkcmFnQm91bmRzUHJvcGVydHkiLCJ2YWxpZFZhbHVlcyIsImRyYWdMaXN0ZW5lciIsInBoZXRpb0VuYWJsZWRQcm9wZXJ0eUluc3RydW1lbnRlZCIsImFkZElucHV0TGlzdGVuZXIiLCJoYXNGb2N1c1Byb3BlcnR5IiwiZm9jdXNlZCIsImZvY3VzIiwidmFsdWUiLCJibHVyIiwiaXNFbXBoYXNpemVkUHJvcGVydHkiLCJvciIsImlzSGlnaGxpZ2h0ZWRQcm9wZXJ0eSIsImxhenlMaW5rIiwiaXNFbXBoYXNpemVkIiwiaGFybW9uaWMiLCJwaGV0IiwibG9nIiwib3JkZXIiLCJwdXNoIiwiaW5jbHVkZXNOb2RlIiwicmVtb3ZlIiwiaW50ZXJydXB0U3VidHJlZUlucHV0Iiwia2V5Ym9hcmREcmFnTGlzdGVuZXIiLCJkcmFnVmVsb2NpdHkiLCJzaGlmdERyYWdWZWxvY2l0eSIsImRpc3Bvc2UiLCJyZXNldCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRGlzY3JldGVNZWFzdXJlbWVudFRvb2xOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIxLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIERpc2NyZXRlTWVhc3VyZW1lbnRUb29sTm9kZSBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgdG9vbHMgdGhhdCBhcmUgdXNlZCB0byBtZWFzdXJlIGhhcm1vbmljcyBpbiB0aGUgJ0Rpc2NyZXRlJyBzY3JlZW4uXHJcbiAqIFJlc3BvbnNpYmlsaXRpZXMgaW5jbHVkZTpcclxuICogLSBwb3NpdGlvbmluZyB0aGUgdG9vbFxyXG4gKiAtIHZpc2liaWxpdHlcclxuICogLSB1cGRhdGluZyB3aGVuIHRoZSBhc3NvY2lhdGVkIGhhcm1vbmljIGNoYW5nZXNcclxuICogLSBlbXBoYXNpemluZyB0aGUgYXNzb2NpYXRlZCBoYXJtb25pYyBvbiAoIGlzUHJlc3NlZCB8fCBpc0hvdmVyaW5nIClcclxuICogLSBkcmFnZ2luZywgY29uc3RyYWluZWQgdG8gZHluYW1pYyBkcmFnIGJvdW5kc1xyXG4gKiAtIGtlZXBpbmcgdGhlIHRvb2wgaW5zaWRlIGR5bmFtaWMgZHJhZyBib3VuZHNcclxuICogLSBpbnRlcnJ1cHRpbmcgYSBkcmFnXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFZlY3RvcjJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMlByb3BlcnR5LmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBBc3NlcnRVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL0Fzc2VydFV0aWxzLmpzJztcclxuaW1wb3J0IHsgQ2lyY2xlLCBEcmFnTGlzdGVuZXIsIEtleWJvYXJkRHJhZ0xpc3RlbmVyLCBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IEJvb2xlYW5JTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvQm9vbGVhbklPLmpzJztcclxuaW1wb3J0IEZNV1F1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi9jb21tb24vRk1XUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IEVtcGhhc2l6ZWRIYXJtb25pY3MgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0VtcGhhc2l6ZWRIYXJtb25pY3MuanMnO1xyXG5pbXBvcnQgSGFybW9uaWMgZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0hhcm1vbmljLmpzJztcclxuaW1wb3J0IGZvdXJpZXJNYWtpbmdXYXZlcyBmcm9tICcuLi8uLi9mb3VyaWVyTWFraW5nV2F2ZXMuanMnO1xyXG5pbXBvcnQgRGlzY3JldGVNZWFzdXJlbWVudFRvb2wgZnJvbSAnLi4vbW9kZWwvRGlzY3JldGVNZWFzdXJlbWVudFRvb2wuanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGlzY3JldGVNZWFzdXJlbWVudFRvb2xOb2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7RGlzY3JldGVNZWFzdXJlbWVudFRvb2x9IHRvb2xcclxuICAgKiBAcGFyYW0ge1JlYWRPbmx5UHJvcGVydHkuPEhhcm1vbmljPn0gaGFybW9uaWNQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSB7RW1waGFzaXplZEhhcm1vbmljc30gZW1waGFzaXplZEhhcm1vbmljc1xyXG4gICAqIEBwYXJhbSB7RW51bWVyYXRpb25Qcm9wZXJ0eS48RG9tYWluPn0gZG9tYWluUHJvcGVydHlcclxuICAgKiBAcGFyYW0ge0RvbWFpbltdfSByZWxldmFudERvbWFpbnMgLSB0aGUgRG9tYWluIHZhbHVlcyB0aGF0IGFyZSByZWxldmFudCBmb3IgdGhpcyB0b29sXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCB0b29sLCBoYXJtb25pY1Byb3BlcnR5LCBlbXBoYXNpemVkSGFybW9uaWNzLCBkb21haW5Qcm9wZXJ0eSwgcmVsZXZhbnREb21haW5zLCBvcHRpb25zICkge1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRvb2wgaW5zdGFuY2VvZiBEaXNjcmV0ZU1lYXN1cmVtZW50VG9vbCApO1xyXG4gICAgYXNzZXJ0ICYmIEFzc2VydFV0aWxzLmFzc2VydEFic3RyYWN0UHJvcGVydHlPZiggaGFybW9uaWNQcm9wZXJ0eSwgSGFybW9uaWMgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGVtcGhhc2l6ZWRIYXJtb25pY3MgaW5zdGFuY2VvZiBFbXBoYXNpemVkSGFybW9uaWNzICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBkb21haW5Qcm9wZXJ0eSBpbnN0YW5jZW9mIEVudW1lcmF0aW9uUHJvcGVydHkgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIEFycmF5LmlzQXJyYXkoIHJlbGV2YW50RG9tYWlucyApICk7XHJcblxyXG4gICAgb3B0aW9ucyA9IG1lcmdlKCB7XHJcblxyXG4gICAgICBwb3NpdGlvbjogbmV3IFZlY3RvcjIoIDAsIDAgKSxcclxuICAgICAgZHJhZ0JvdW5kczogbnVsbCwgLy8ge0JvdW5kczJ8bnVsbH1cclxuXHJcbiAgICAgIC8vIEZvciBkZWJ1Z2dpbmdcclxuICAgICAgZGVidWdOYW1lOiAndG9vbCcsXHJcblxyXG4gICAgICAvLyBOb2RlIG9wdGlvbnNcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcblxyXG4gICAgICAvLyBwZG9tXHJcbiAgICAgIHRhZ05hbWU6ICdkaXYnLFxyXG4gICAgICBmb2N1c2FibGU6IHRydWUsXHJcblxyXG4gICAgICAvLyBwaGV0LWlvIG9wdGlvbnNcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRURcclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhb3B0aW9ucy52aXNpYmxlUHJvcGVydHksICdEaXNjcmV0ZU1lYXN1cmVtZW50VG9vbE5vZGUgc2V0cyB2aXNpYmxlUHJvcGVydHknICk7XHJcbiAgICBvcHRpb25zLnZpc2libGVQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgdG9vbC5pc1NlbGVjdGVkUHJvcGVydHksIGRvbWFpblByb3BlcnR5IF0sXHJcbiAgICAgICggaXNTZWxlY3RlZCwgZG9tYWluICkgPT4gKCBpc1NlbGVjdGVkICYmIHJlbGV2YW50RG9tYWlucy5pbmNsdWRlcyggZG9tYWluICkgKSwge1xyXG4gICAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLmhhcm1vbmljUHJvcGVydHkgPSBoYXJtb25pY1Byb3BlcnR5O1xyXG4gICAgdGhpcy5lbXBoYXNpemVkSGFybW9uaWNzID0gZW1waGFzaXplZEhhcm1vbmljcztcclxuXHJcbiAgICAvLyBTaG93IGEgcmVkIGRvdCBhdCB0aGUgdG9vbCdzIG9yaWdpbi5cclxuICAgIGlmICggRk1XUXVlcnlQYXJhbWV0ZXJzLmRlYnVnVG9vbHMgKSB7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIG5ldyBDaXJjbGUoIDIsIHsgZmlsbDogJ3JlZCcgfSApICk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBWZWN0b3IyUHJvcGVydHkoIG9wdGlvbnMucG9zaXRpb24sIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdwb3NpdGlvblByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAncG9zaXRpb24gb2YgdGhpcyB0b29sLCBpbiB2aWV3IGNvb3JkaW5hdGVzJ1xyXG4gICAgfSApO1xyXG4gICAgcG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBwb3NpdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBwb3NpdGlvbjtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyB7UHJvcGVydHkuPEJvdW5kczI+fSBUaGlzIGlzIGEgZml4ZWQgdmFsdWUsIGJ1dCBEcmFnTGlzdGVuZXIgcmVxdWlyZXMgYSBQcm9wZXJ0eS5cclxuICAgIGNvbnN0IGRyYWdCb3VuZHNQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggb3B0aW9ucy5kcmFnQm91bmRzLCB7XHJcbiAgICAgIHZhbGlkVmFsdWVzOiBbIG9wdGlvbnMuZHJhZ0JvdW5kcyBdXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQ29uc3RyYWluZWQgZHJhZ2dpbmcgb2YgdGhlIHRvb2wuIFNvbWUgdG9vbHMgKGUuZy4gY2FsaXBlcnMpIG1heSBiZSB3aWRlciB0aGFuIHRoZSBTY3JlZW5WaWV3LCBzbyB3ZSBjYW5ub3RcclxuICAgIC8vIGNvbnN0cmFpbiB0aGUgZW50aXJlIHRvb2wgdG8gYmUgd2l0aGluIHRoZSBkcmFnIGJvdW5kcy4gU28ganVzdCB0aGUgb3JpZ2luIGlzIGNvbnN0cmFpbmVkLlxyXG4gICAgY29uc3QgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICBwb3NpdGlvblByb3BlcnR5OiBwb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICBkcmFnQm91bmRzUHJvcGVydHk6IGRyYWdCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkcmFnTGlzdGVuZXInICksXHJcbiAgICAgIHBoZXRpb0VuYWJsZWRQcm9wZXJ0eUluc3RydW1lbnRlZDogdHJ1ZVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRJbnB1dExpc3RlbmVyKCBkcmFnTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBXaGV0aGVyIHRoaXMgc2xpZGVyIGhhcyBrZXlib2FyZCBmb2N1cy5cclxuICAgIGNvbnN0IGhhc0ZvY3VzUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0aGlzLmZvY3VzZWQgKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lcigge1xyXG4gICAgICBmb2N1czogKCkgPT4geyBoYXNGb2N1c1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTsgfSxcclxuICAgICAgYmx1cjogKCkgPT4geyBoYXNGb2N1c1Byb3BlcnR5LnZhbHVlID0gZmFsc2U7IH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyB7RGVyaXZlZFByb3BlcnR5Ljxib29sZWFuPn1cclxuICAgIC8vIFRoZSBhc3NvY2lhdGVkIGhhcm1vbmljIGlzIGVtcGhhc2l6ZWQgaWYgd2UncmUgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgdG9vbCBpbiBzb21lIHdheS5cclxuICAgIGNvbnN0IGlzRW1waGFzaXplZFByb3BlcnR5ID0gRGVyaXZlZFByb3BlcnR5Lm9yKCBbIGRyYWdMaXN0ZW5lci5pc0hpZ2hsaWdodGVkUHJvcGVydHksIGhhc0ZvY3VzUHJvcGVydHkgXSApO1xyXG5cclxuICAgIC8vIEVtcGhhc2l6ZSB0aGUgYXNzb2NpYXRlZCBoYXJtb25pYyB3aGlsZSBpbnRlcmFjdGluZyB3aXRoIHRoaXMgdG9vbC5cclxuICAgIGlzRW1waGFzaXplZFByb3BlcnR5LmxhenlMaW5rKCBpc0VtcGhhc2l6ZWQgPT4ge1xyXG4gICAgICBjb25zdCBoYXJtb25pYyA9IGhhcm1vbmljUHJvcGVydHkudmFsdWU7XHJcbiAgICAgIHBoZXQubG9nICYmIHBoZXQubG9nKCBgJHtvcHRpb25zLmRlYnVnTmFtZX0gaXNFbXBoYXNpemVkPSR7aXNFbXBoYXNpemVkfSBuPSR7aGFybW9uaWMub3JkZXJ9YCApO1xyXG4gICAgICBpZiAoIGlzRW1waGFzaXplZCApIHtcclxuICAgICAgICBlbXBoYXNpemVkSGFybW9uaWNzLnB1c2goIHRoaXMsIGhhcm1vbmljICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAoIGVtcGhhc2l6ZWRIYXJtb25pY3MuaW5jbHVkZXNOb2RlKCB0aGlzICkgKSB7XHJcbiAgICAgICAgZW1waGFzaXplZEhhcm1vbmljcy5yZW1vdmUoIHRoaXMgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEludGVycnVwdCBpbnRlcmFjdGlvblxyXG4gICAgaGFybW9uaWNQcm9wZXJ0eS5sYXp5TGluayggKCkgPT4gdGhpcy5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKSApO1xyXG4gICAgdGhpcy52aXNpYmxlUHJvcGVydHkubGF6eUxpbmsoICgpID0+IHRoaXMuaW50ZXJydXB0U3VidHJlZUlucHV0KCkgKTtcclxuXHJcbiAgICAvLyBwZG9tIC0gZHJhZ2dpbmcgdXNpbmcgdGhlIGtleWJvYXJkXHJcbiAgICBjb25zdCBrZXlib2FyZERyYWdMaXN0ZW5lciA9IG5ldyBLZXlib2FyZERyYWdMaXN0ZW5lcigge1xyXG4gICAgICBwb3NpdGlvblByb3BlcnR5OiBwb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICBkcmFnQm91bmRzUHJvcGVydHk6IGRyYWdCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgZHJhZ1ZlbG9jaXR5OiAxMDAsIC8vIHZlbG9jaXR5IC0gY2hhbmdlIGluIHBvc2l0aW9uIHBlciBzZWNvbmRcclxuICAgICAgc2hpZnREcmFnVmVsb2NpdHk6IDIwLCAvLyBmaW5lci1ncmFpbmVkXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAna2V5Ym9hcmREcmFnTGlzdGVuZXInIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lcigga2V5Ym9hcmREcmFnTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBAcHVibGljXHJcbiAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkgPSBwb3NpdGlvblByb3BlcnR5OyAvLyB7UHJvcGVydHkuPFZlY3RvcjI+fVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZXNldCgpIHtcclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5yZXNldCgpO1xyXG4gIH1cclxufVxyXG5cclxuZm91cmllck1ha2luZ1dhdmVzLnJlZ2lzdGVyKCAnRGlzY3JldGVNZWFzdXJlbWVudFRvb2xOb2RlJywgRGlzY3JldGVNZWFzdXJlbWVudFRvb2xOb2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sd0NBQXdDO0FBQ3BFLE9BQU9DLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsbUJBQW1CLE1BQU0sNENBQTRDO0FBQzVFLE9BQU9DLFFBQVEsTUFBTSxpQ0FBaUM7QUFDdEQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxlQUFlLE1BQU0sdUNBQXVDO0FBQ25FLE9BQU9DLEtBQUssTUFBTSxtQ0FBbUM7QUFDckQsT0FBT0MsV0FBVyxNQUFNLDBDQUEwQztBQUNsRSxTQUFTQyxNQUFNLEVBQUVDLFlBQVksRUFBRUMsb0JBQW9CLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDcEcsT0FBT0MsTUFBTSxNQUFNLGlDQUFpQztBQUNwRCxPQUFPQyxTQUFTLE1BQU0sMENBQTBDO0FBQ2hFLE9BQU9DLGtCQUFrQixNQUFNLG9DQUFvQztBQUNuRSxPQUFPQyxtQkFBbUIsTUFBTSwyQ0FBMkM7QUFDM0UsT0FBT0MsUUFBUSxNQUFNLGdDQUFnQztBQUNyRCxPQUFPQyxrQkFBa0IsTUFBTSw2QkFBNkI7QUFDNUQsT0FBT0MsdUJBQXVCLE1BQU0scUNBQXFDO0FBRXpFLGVBQWUsTUFBTUMsMkJBQTJCLFNBQVNSLElBQUksQ0FBQztFQUU1RDtBQUNGO0FBQ0E7QUFD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