// Copyright 2020, University of Colorado Boulder

/**
 * Collision subtype for detecting https://github.com/phetsims/collision-lab/issues/184
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import collisionLab from '../../collisionLab.js';
import CollisionEngine from '../../common/model/CollisionEngine.js';
class Explore1DCollisionEngine extends CollisionEngine {
  /**
   * Finds all balls that share the same velocity AND are adjacent.
   * @private
   *
   * @param {Array.<Ball>} balls
   * @returns {Array.<Ball>}
   */
  findGroupedBalls(balls) {
    const result = this.ballSystem.balls.filter(ball => {
      return _.some(balls, referenceBall => {
        const positionDifference = Math.abs(ball.positionProperty.value.x - referenceBall.positionProperty.value.x);
        const velocityDifference = Math.abs(ball.velocityProperty.value.x - referenceBall.velocityProperty.value.x);
        const separation = Math.abs(positionDifference - ball.radiusProperty.value - referenceBall.radiusProperty.value);
        return ball === referenceBall || velocityDifference < 1e-10 && separation < 1e-7;
      });
    });
    if (result.length > balls.length) {
      return this.findGroupedBalls(result);
    } else {
      return result;
    }
  }

  /**
   * Processes and responds to a collision between two balls. Overridden to respond to perfectly inelastic 'stick'
   * collisions between two Balls, in which this method will create and reference a RotatingBallCluster instance.
   * @override
   * @protected
   *
   * @param {Ball} ball1 - the first Ball involved in the collision.
   * @param {Ball} ball2 - the second Ball involved in the collision.
   * @param {number} dt
   */
  handleBallToBallCollision(ball1, ball2, dt) {
    if (this.playArea.elasticityPercentProperty.value === 0) {
      const balls = this.findGroupedBalls([ball1, ball2]);
      const totalMomentum = _.sum(balls.map(ball => ball.momentumProperty.value.x));
      const totalMass = _.sum(balls.map(ball => ball.massProperty.value));
      balls.forEach(ball => {
        ball.velocityProperty.value = new Vector2(totalMomentum / totalMass, 0);
        this.invalidateCollisions(ball);
      });
    } else {
      super.handleBallToBallCollision(ball1, ball2, dt);
    }
  }

  /**
   * Processes a ball-to-border collision and updates the velocity and the position of the Ball. Overridden to respond
   * to perfectly inelastic 'stick' collisions, in which the Ball's velocity is set to 0.
   * @override
   * @protected
   *
   * @param {Ball} ball - the Ball involved in the collision.
   * @param {number} dt
   */
  handleBallToBorderCollision(ball, dt) {
    if (this.playArea.elasticityPercentProperty.value === 0) {
      const balls = this.findGroupedBalls([ball]);
      balls.forEach(ball => {
        ball.velocityProperty.value = new Vector2(0, 0);
        this.invalidateCollisions(ball);
      });
    } else {
      super.handleBallToBorderCollision(ball, dt);
    }
  }
}
collisionLab.register('Explore1DCollisionEngine', Explore1DCollisionEngine);
export default Explore1DCollisionEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwiY29sbGlzaW9uTGFiIiwiQ29sbGlzaW9uRW5naW5lIiwiRXhwbG9yZTFEQ29sbGlzaW9uRW5naW5lIiwiZmluZEdyb3VwZWRCYWxscyIsImJhbGxzIiwicmVzdWx0IiwiYmFsbFN5c3RlbSIsImZpbHRlciIsImJhbGwiLCJfIiwic29tZSIsInJlZmVyZW5jZUJhbGwiLCJwb3NpdGlvbkRpZmZlcmVuY2UiLCJNYXRoIiwiYWJzIiwicG9zaXRpb25Qcm9wZXJ0eSIsInZhbHVlIiwieCIsInZlbG9jaXR5RGlmZmVyZW5jZSIsInZlbG9jaXR5UHJvcGVydHkiLCJzZXBhcmF0aW9uIiwicmFkaXVzUHJvcGVydHkiLCJsZW5ndGgiLCJoYW5kbGVCYWxsVG9CYWxsQ29sbGlzaW9uIiwiYmFsbDEiLCJiYWxsMiIsImR0IiwicGxheUFyZWEiLCJlbGFzdGljaXR5UGVyY2VudFByb3BlcnR5IiwidG90YWxNb21lbnR1bSIsInN1bSIsIm1hcCIsIm1vbWVudHVtUHJvcGVydHkiLCJ0b3RhbE1hc3MiLCJtYXNzUHJvcGVydHkiLCJmb3JFYWNoIiwiaW52YWxpZGF0ZUNvbGxpc2lvbnMiLCJoYW5kbGVCYWxsVG9Cb3JkZXJDb2xsaXNpb24iLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkV4cGxvcmUxRENvbGxpc2lvbkVuZ2luZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQ29sbGlzaW9uIHN1YnR5cGUgZm9yIGRldGVjdGluZyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY29sbGlzaW9uLWxhYi9pc3N1ZXMvMTg0XHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBjb2xsaXNpb25MYWIgZnJvbSAnLi4vLi4vY29sbGlzaW9uTGFiLmpzJztcclxuaW1wb3J0IENvbGxpc2lvbkVuZ2luZSBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvQ29sbGlzaW9uRW5naW5lLmpzJztcclxuXHJcbmNsYXNzIEV4cGxvcmUxRENvbGxpc2lvbkVuZ2luZSBleHRlbmRzIENvbGxpc2lvbkVuZ2luZSB7XHJcbiAgLyoqXHJcbiAgICogRmluZHMgYWxsIGJhbGxzIHRoYXQgc2hhcmUgdGhlIHNhbWUgdmVsb2NpdHkgQU5EIGFyZSBhZGphY2VudC5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtBcnJheS48QmFsbD59IGJhbGxzXHJcbiAgICogQHJldHVybnMge0FycmF5LjxCYWxsPn1cclxuICAgKi9cclxuICBmaW5kR3JvdXBlZEJhbGxzKCBiYWxscyApIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYmFsbFN5c3RlbS5iYWxscy5maWx0ZXIoIGJhbGwgPT4ge1xyXG4gICAgICByZXR1cm4gXy5zb21lKCBiYWxscywgcmVmZXJlbmNlQmFsbCA9PiB7XHJcbiAgICAgICAgY29uc3QgcG9zaXRpb25EaWZmZXJlbmNlID0gTWF0aC5hYnMoIGJhbGwucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54IC0gcmVmZXJlbmNlQmFsbC5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggKTtcclxuICAgICAgICBjb25zdCB2ZWxvY2l0eURpZmZlcmVuY2UgPSBNYXRoLmFicyggYmFsbC52ZWxvY2l0eVByb3BlcnR5LnZhbHVlLnggLSByZWZlcmVuY2VCYWxsLnZlbG9jaXR5UHJvcGVydHkudmFsdWUueCApO1xyXG4gICAgICAgIGNvbnN0IHNlcGFyYXRpb24gPSBNYXRoLmFicyggcG9zaXRpb25EaWZmZXJlbmNlIC0gYmFsbC5yYWRpdXNQcm9wZXJ0eS52YWx1ZSAtIHJlZmVyZW5jZUJhbGwucmFkaXVzUHJvcGVydHkudmFsdWUgKTtcclxuICAgICAgICByZXR1cm4gKCBiYWxsID09PSByZWZlcmVuY2VCYWxsICkgfHwgKCB2ZWxvY2l0eURpZmZlcmVuY2UgPCAxZS0xMCAmJiBzZXBhcmF0aW9uIDwgMWUtNyApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgaWYgKCByZXN1bHQubGVuZ3RoID4gYmFsbHMubGVuZ3RoICkge1xyXG4gICAgICByZXR1cm4gdGhpcy5maW5kR3JvdXBlZEJhbGxzKCByZXN1bHQgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUHJvY2Vzc2VzIGFuZCByZXNwb25kcyB0byBhIGNvbGxpc2lvbiBiZXR3ZWVuIHR3byBiYWxscy4gT3ZlcnJpZGRlbiB0byByZXNwb25kIHRvIHBlcmZlY3RseSBpbmVsYXN0aWMgJ3N0aWNrJ1xyXG4gICAqIGNvbGxpc2lvbnMgYmV0d2VlbiB0d28gQmFsbHMsIGluIHdoaWNoIHRoaXMgbWV0aG9kIHdpbGwgY3JlYXRlIGFuZCByZWZlcmVuY2UgYSBSb3RhdGluZ0JhbGxDbHVzdGVyIGluc3RhbmNlLlxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwcm90ZWN0ZWRcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7QmFsbH0gYmFsbDEgLSB0aGUgZmlyc3QgQmFsbCBpbnZvbHZlZCBpbiB0aGUgY29sbGlzaW9uLlxyXG4gICAqIEBwYXJhbSB7QmFsbH0gYmFsbDIgLSB0aGUgc2Vjb25kIEJhbGwgaW52b2x2ZWQgaW4gdGhlIGNvbGxpc2lvbi5cclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHRcclxuICAgKi9cclxuICBoYW5kbGVCYWxsVG9CYWxsQ29sbGlzaW9uKCBiYWxsMSwgYmFsbDIsIGR0ICkge1xyXG4gICAgaWYgKCB0aGlzLnBsYXlBcmVhLmVsYXN0aWNpdHlQZXJjZW50UHJvcGVydHkudmFsdWUgPT09IDAgKSB7XHJcblxyXG4gICAgICBjb25zdCBiYWxscyA9IHRoaXMuZmluZEdyb3VwZWRCYWxscyggWyBiYWxsMSwgYmFsbDIgXSApO1xyXG5cclxuICAgICAgY29uc3QgdG90YWxNb21lbnR1bSA9IF8uc3VtKCBiYWxscy5tYXAoIGJhbGwgPT4gYmFsbC5tb21lbnR1bVByb3BlcnR5LnZhbHVlLnggKSApO1xyXG4gICAgICBjb25zdCB0b3RhbE1hc3MgPSBfLnN1bSggYmFsbHMubWFwKCBiYWxsID0+IGJhbGwubWFzc1Byb3BlcnR5LnZhbHVlICkgKTtcclxuXHJcbiAgICAgIGJhbGxzLmZvckVhY2goIGJhbGwgPT4ge1xyXG4gICAgICAgIGJhbGwudmVsb2NpdHlQcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCB0b3RhbE1vbWVudHVtIC8gdG90YWxNYXNzLCAwICk7XHJcbiAgICAgICAgdGhpcy5pbnZhbGlkYXRlQ29sbGlzaW9ucyggYmFsbCApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgc3VwZXIuaGFuZGxlQmFsbFRvQmFsbENvbGxpc2lvbiggYmFsbDEsIGJhbGwyLCBkdCApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUHJvY2Vzc2VzIGEgYmFsbC10by1ib3JkZXIgY29sbGlzaW9uIGFuZCB1cGRhdGVzIHRoZSB2ZWxvY2l0eSBhbmQgdGhlIHBvc2l0aW9uIG9mIHRoZSBCYWxsLiBPdmVycmlkZGVuIHRvIHJlc3BvbmRcclxuICAgKiB0byBwZXJmZWN0bHkgaW5lbGFzdGljICdzdGljaycgY29sbGlzaW9ucywgaW4gd2hpY2ggdGhlIEJhbGwncyB2ZWxvY2l0eSBpcyBzZXQgdG8gMC5cclxuICAgKiBAb3ZlcnJpZGVcclxuICAgKiBAcHJvdGVjdGVkXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge0JhbGx9IGJhbGwgLSB0aGUgQmFsbCBpbnZvbHZlZCBpbiB0aGUgY29sbGlzaW9uLlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBkdFxyXG4gICAqL1xyXG4gIGhhbmRsZUJhbGxUb0JvcmRlckNvbGxpc2lvbiggYmFsbCwgZHQgKSB7XHJcbiAgICBpZiAoIHRoaXMucGxheUFyZWEuZWxhc3RpY2l0eVBlcmNlbnRQcm9wZXJ0eS52YWx1ZSA9PT0gMCApIHtcclxuICAgICAgY29uc3QgYmFsbHMgPSB0aGlzLmZpbmRHcm91cGVkQmFsbHMoIFsgYmFsbCBdICk7XHJcblxyXG4gICAgICBiYWxscy5mb3JFYWNoKCBiYWxsID0+IHtcclxuICAgICAgICBiYWxsLnZlbG9jaXR5UHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG4gICAgICAgIHRoaXMuaW52YWxpZGF0ZUNvbGxpc2lvbnMoIGJhbGwgKTtcclxuICAgICAgfSApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHN1cGVyLmhhbmRsZUJhbGxUb0JvcmRlckNvbGxpc2lvbiggYmFsbCwgZHQgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNvbGxpc2lvbkxhYi5yZWdpc3RlciggJ0V4cGxvcmUxRENvbGxpc2lvbkVuZ2luZScsIEV4cGxvcmUxRENvbGxpc2lvbkVuZ2luZSApO1xyXG5leHBvcnQgZGVmYXVsdCBFeHBsb3JlMURDb2xsaXNpb25FbmdpbmU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsWUFBWSxNQUFNLHVCQUF1QjtBQUNoRCxPQUFPQyxlQUFlLE1BQU0sdUNBQXVDO0FBRW5FLE1BQU1DLHdCQUF3QixTQUFTRCxlQUFlLENBQUM7RUFDckQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRUUsZ0JBQWdCQSxDQUFFQyxLQUFLLEVBQUc7SUFDeEIsTUFBTUMsTUFBTSxHQUFHLElBQUksQ0FBQ0MsVUFBVSxDQUFDRixLQUFLLENBQUNHLE1BQU0sQ0FBRUMsSUFBSSxJQUFJO01BQ25ELE9BQU9DLENBQUMsQ0FBQ0MsSUFBSSxDQUFFTixLQUFLLEVB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