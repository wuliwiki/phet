// Copyright 2020-2022, University of Colorado Boulder

/**
 * The Model representation for the 'Momenta Diagram', which appears at the bottom right of each screen. Features the
 * momentum Vectors of each Ball in the BallSystem, along with a 'total' momentum vector, in a completely separate
 * coordinate frame from the PlayArea.
 *
 * Responsibilities are:
 *   - Keeping track of the zoom and Bounds of the MomentaDiagram.
 *   - Create a MomentaDiagramVector for all possible Balls and one for the total Momentum Vector. Momenta Diagram takes
 *     advantage of the prepopulatedBalls, which all Balls in the system must be apart of. Instead of creating a
 *     MomentaDiagramVector each time a Ball is added to the system, it creates one for each prepopulatedBall and
 *     only updates it if the associated Ball is in the system, which eliminates the necessity to dispose
 *     MomentaDiagramVectors.
 *
 *   - Update the tail positions and components of the MomentaDiagramVectors when necessary. MomentaDiagrams are
 *     designed and implemented to be minimally invasive to optimize the performance of the simulation. The position
 *     and components of the MomentaDiagramVectors are only updated if the Momenta Diagram accordion box is expanded.
 *     The positioning also differs depending on the dimension of the PlayArea.
 *
 * MomentaDiagrams are created at the start of the sim and are never disposed, so no dispose method is necessary.
 *
 * @author Brandon Li
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import AssertUtils from '../../../../phetcommon/js/AssertUtils.js';
import collisionLab from '../../collisionLab.js';
import CollisionLabConstants from '../CollisionLabConstants.js';
import CollisionLabUtils from '../CollisionLabUtils.js';
import Ball from './Ball.js';
import MomentaDiagramVector from './MomentaDiagramVector.js';
import PlayArea from './PlayArea.js';

// constants
const MOMENTA_DIAGRAM_ZOOM_RANGE = CollisionLabConstants.MOMENTA_DIAGRAM_ZOOM_RANGE;
const MOMENTA_DIAGRAM_ASPECT_RATIO = CollisionLabConstants.MOMENTA_DIAGRAM_ASPECT_RATIO;
const ZOOM_MULTIPLIER = 2;
const DEFAULT_1D_VERTICAL_SPACING = 0.3;
class MomentaDiagram {
  /**
   * @param {Balls[]} prepopulatedBalls - an array of All possible balls in the system.
   * @param {ObservableArrayDef.<Ball>} balls - the balls in the system. Must belong in prepopulatedBalls.
   * @param {number} dimension - the dimension of the PlayArea, used for positioning differences. Either 1 or 2.
   */
  constructor(prepopulatedBalls, balls, dimension) {
    assert && AssertUtils.assertArrayOf(prepopulatedBalls, Ball);
    assert && assert(Array.isArray(balls)) && AssertUtils.assertArrayOf(balls, Ball);
    assert && assert(PlayArea.Dimension.includes(dimension), `invalid dimension: ${dimension}`);

    // @public {Property.<number>} - the zoom factor of the MomentaDiagram. This is set externally in the view.
    this.zoomProperty = new NumberProperty(MOMENTA_DIAGRAM_ZOOM_RANGE.defaultValue, {
      range: MOMENTA_DIAGRAM_ZOOM_RANGE
    });

    // @public (read-only) {Property.<Bounds2>} - the Bounds of the MomentaDiagram, in kg*(m/s). Derived from the zoom
    //                                            factor. This is inside the model to make the spacing between
    //                                            MomentaDiagramVectors visually uniform for 1D screens. See
    //                                            https://github.com/phetsims/collision-lab/issues/164.
    this.boundsProperty = new DerivedProperty([this.zoomProperty], zoomFactor => {
      // The center of the MomentaDiagram is the origin.
      return new Bounds2(-MOMENTA_DIAGRAM_ASPECT_RATIO.width / 2 / zoomFactor, -MOMENTA_DIAGRAM_ASPECT_RATIO.height / 2 / zoomFactor, MOMENTA_DIAGRAM_ASPECT_RATIO.width / 2 / zoomFactor, MOMENTA_DIAGRAM_ASPECT_RATIO.height / 2 / zoomFactor);
    });

    // @public {Property.<boolean>} - indicates if the MomentaDiagram is expanded. This is in the model since the positions
    //                             and components of the Momenta Vectors are only updated if this is true.
    this.expandedProperty = new BooleanProperty(false);

    //----------------------------------------------------------------------------------------

    // @public (read-only) {Map.<Ball, MomentaDiagramVector>} - Map prepopulatedBalls to an associated Momenta Vector.
    this.ballToMomentaVectorMap = new Map();

    // Populate the Map with MomentaDiagramVectors.
    prepopulatedBalls.forEach(ball => {
      this.ballToMomentaVectorMap.set(ball, new MomentaDiagramVector());
    });

    // @public (read-only) {MomentaDiagramVector} - the total sum of the Momenta Vectors of the system.
    this.totalMomentumVector = new MomentaDiagramVector();

    // @private {ObservableArrayDef.<Balls>} - reference to the Balls in the BallSystem.
    this.balls = balls;

    // @public {number} - reference to the passed-in dimension of the PlayArea.
    this.dimension = dimension;

    //----------------------------------------------------------------------------------------

    // Create a Multilink to update the positioning and components of the Momenta Vectors.
    //
    // For the dependencies, we use:
    //  - expandedProperty; for performance reasons, the MomentaDiagram isn't updated it isn't visible.
    //  - The momentum Properties of the prepopulatedBalls. Only the balls in the BallSystem are positioned and used in
    //    the total momentum calculation.
    //  - balls.lengthProperty, since removing or adding a Ball changes the total momentum.
    //  - this.zoomProperty, since changing the zoom changes the vertical spacing between vectors for 1D screens.
    //
    // This Multilink is never disposed and lasts for the lifetime of the sim.
    Multilink.multilink([this.expandedProperty, ...prepopulatedBalls.map(ball => ball.momentumProperty), balls.lengthProperty, this.zoomProperty], expanded => {
      expanded && this.updateVectors(); // Only update if the MomentaDiagram is visible (expanded).
    });
  }

  /**
   * Resets the MomentaDiagram.
   * @public
   *
   * Called when the reset-all button is pressed.
   */
  reset() {
    this.zoomProperty.reset();
    this.expandedProperty.reset();
    this.ballToMomentaVectorMap.forEach(momentaVector => {
      momentaVector.reset();
    });
    this.totalMomentumVector.reset();
  }

  /**
   * Updates the components and positions of the momentum Vectors to match the Balls in the BallSystem. Only the Balls
   * in the BallSystem are updated and used to calculate the total momentum.
   * @private
   *
   * The positioning of the momentum Vectors are different for each dimension:
   *
   *   For 2D Screens:
   *     - The first momentum and the total momentum Vectors are placed at the origin.
   *     - Momentum vectors are placed tip-to-tail
   *
   *   For 1D screens:
   *     - The momentum vectors are stacked vertically on top of each other, with the first vector on top and
   *       the tailY coordinates of the other vectors are one-off of each other.
   *     - The first momentum Vector and the total momentum Vector's tailX are placed at x = 0. The vectors are then
   *       placed tipX-to-tailX.
   */
  updateVectors() {
    // First update the components of the Vectors.
    this.balls.forEach(ball => {
      this.ballToMomentaVectorMap.get(ball).componentsProperty.value = ball.momentumProperty.value;
    });

    // Compute the components of the total Momenta Vector.
    const totalMomentum = Vector2.ZERO.copy();

    // Loop through and calculate the total momentum of the Balls in the BallSystem.
    this.balls.forEach(ball => {
      totalMomentum.add(ball.momentumProperty.value);
    });
    this.totalMomentumVector.componentsProperty.value = totalMomentum;

    //----------------------------------------------------------------------------------------

    // Reference the Momenta Vector associated with the first Ball in the system.
    const firstMomentaVector = this.ballToMomentaVectorMap.get(this.balls[0]);

    // Calculate the vertical spacing between the vectors for 1D screens, which is dependent on the zoom-level.
    const verticalSpacing = DEFAULT_1D_VERTICAL_SPACING / this.zoomProperty.value * MOMENTA_DIAGRAM_ZOOM_RANGE.defaultValue;

    // Position the first Momenta Vector and the total Momenta Vector in the correct position.
    if (this.dimension === PlayArea.Dimension.TWO) {
      // Set the first Momenta Vector's tail and the total Momenta Vector's tail at the origin.
      firstMomentaVector.tailPositionProperty.value = this.boundsProperty.value.center;
      this.totalMomentumVector.tailPositionProperty.value = this.boundsProperty.value.center;
    } else {
      // Set the first Momenta Vector's tail and the total Momenta Vector's tail at x = 0.
      firstMomentaVector.tailPositionProperty.value = new Vector2(0, firstMomentaVector.tailPositionProperty.value.y);
      this.totalMomentumVector.tailPositionProperty.value = new Vector2(0, this.totalMomentumVector.tailPositionProperty.value.y);

      // Set the y-value of the first Momenta Vector's tail and the total Momenta Vector's tail which depends on the
      // number of balls in the system.
      firstMomentaVector.tailPositionProperty.value = new Vector2(firstMomentaVector.tailPositionProperty.value.x, verticalSpacing * (this.balls.length / 2 + 0.9));
      this.totalMomentumVector.tailPositionProperty.value = new Vector2(this.totalMomentumVector.tailPositionProperty.value.x, firstMomentaVector.tailPositionProperty.value.y - this.balls.length * verticalSpacing);
    }

    // Position the rest of the Momentum vectors. Loop in pairs.
    CollisionLabUtils.forEachAdjacentPair(this.balls, (ball, previousBall) => {
      const momentaVector = this.ballToMomentaVectorMap.get(ball);
      const previousMomentaVector = this.ballToMomentaVectorMap.get(previousBall);
      if (this.dimension === PlayArea.Dimension.TWO) {
        // tip-to-tail
        momentaVector.tailPositionProperty.value = previousMomentaVector.tipPositionProperty.value;
      } else {
        // tipX-to-tailX
        momentaVector.tailPositionProperty.value = new Vector2(previousMomentaVector.tipPositionProperty.value.x, momentaVector.tailPositionProperty.value.y);

        // Stack vertically on top of each other by progressively decrementing the tipY.
        momentaVector.tailPositionProperty.value = new Vector2(momentaVector.tailPositionProperty.value.x, previousMomentaVector.tailPositionProperty.value.y - verticalSpacing);
      }
    });
  }

  /**
   * Zooms the MomentaDiagram in. Called when the zoom-in button is pressed.
   * @public
   */
  zoomIn() {
    this.zoomProperty.value *= ZOOM_MULTIPLIER;
  }

  /**
   * Zooms the MomentaDiagram out. Called when the zoom-out button is pressed.
   * @public
   */
  zoomOut() {
    this.zoomProperty.value /= ZOOM_MULTIPLIER;
  }
}
collisionLab.register('MomentaDiagram', MomentaDiagram);
export default MomentaDiagram;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJOdW1iZXJQcm9wZXJ0eSIsIkJvdW5kczIiLCJWZWN0b3IyIiwiQXNzZXJ0VXRpbHMiLCJjb2xsaXNpb25MYWIiLCJDb2xsaXNpb25MYWJDb25zdGFudHMiLCJDb2xsaXNpb25MYWJVdGlscyIsIkJhbGwiLCJNb21lbnRhRGlhZ3JhbVZlY3RvciIsIlBsYXlBcmVhIiwiTU9NRU5UQV9ESUFHUkFNX1pPT01fUkFOR0UiLCJNT01FTlRBX0RJQUdSQU1fQVNQRUNUX1JBVElPIiwiWk9PTV9NVUxUSVBMSUVSIiwiREVGQVVMVF8xRF9WRVJUSUNBTF9TUEFDSU5HIiwiTW9tZW50YURpYWdyYW0iLCJjb25zdHJ1Y3RvciIsInByZXBvcHVsYXRlZEJhbGxzIiwiYmFsbHMiLCJkaW1lbnNpb24iLCJhc3NlcnQiLCJhc3NlcnRBcnJheU9mIiwiQXJyYXkiLCJpc0FycmF5IiwiRGltZW5zaW9uIiwiaW5jbHVkZXMiLCJ6b29tUHJvcGVydHkiLCJkZWZhdWx0VmFsdWUiLCJyYW5nZSIsImJvdW5kc1Byb3BlcnR5Iiwiem9vbUZhY3RvciIsIndpZHRoIiwiaGVpZ2h0IiwiZXhwYW5kZWRQcm9wZXJ0eSIsImJhbGxUb01vbWVudGFWZWN0b3JNYXAiLCJNYXAiLCJmb3JFYWNoIiwiYmFsbCIsInNldCIsInRvdGFsTW9tZW50dW1WZWN0b3IiLCJtdWx0aWxpbmsiLCJtYXAiLCJtb21lbnR1bVByb3BlcnR5IiwibGVuZ3RoUHJvcGVydHkiLCJleHBhbmRlZCIsInVwZGF0ZVZlY3RvcnMiLCJyZXNldCIsIm1vbWVudGFWZWN0b3IiLCJnZXQiLCJjb21wb25lbnRzUHJvcGVydHkiLCJ2YWx1ZSIsInRvdGFsTW9tZW50dW0iLCJaRVJPIiwiY29weSIsImFkZCIsImZpcnN0TW9tZW50YVZlY3RvciIsInZlcnRpY2FsU3BhY2luZyIsIlRXTyIsInRhaWxQb3NpdGlvblByb3BlcnR5IiwiY2VudGVyIiwieSIsIngiLCJsZW5ndGgiLCJmb3JFYWNoQWRqYWNlbnRQYWlyIiwicHJldmlvdXNCYWxsIiwicHJldmlvdXNNb21lbnRhVmVjdG9yIiwidGlwUG9zaXRpb25Qcm9wZXJ0eSIsInpvb21JbiIsInpvb21PdXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk1vbWVudGFEaWFncmFtLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoZSBNb2RlbCByZXByZXNlbnRhdGlvbiBmb3IgdGhlICdNb21lbnRhIERpYWdyYW0nLCB3aGljaCBhcHBlYXJzIGF0IHRoZSBib3R0b20gcmlnaHQgb2YgZWFjaCBzY3JlZW4uIEZlYXR1cmVzIHRoZVxyXG4gKiBtb21lbnR1bSBWZWN0b3JzIG9mIGVhY2ggQmFsbCBpbiB0aGUgQmFsbFN5c3RlbSwgYWxvbmcgd2l0aCBhICd0b3RhbCcgbW9tZW50dW0gdmVjdG9yLCBpbiBhIGNvbXBsZXRlbHkgc2VwYXJhdGVcclxuICogY29vcmRpbmF0ZSBmcmFtZSBmcm9tIHRoZSBQbGF5QXJlYS5cclxuICpcclxuICogUmVzcG9uc2liaWxpdGllcyBhcmU6XHJcbiAqICAgLSBLZWVwaW5nIHRyYWNrIG9mIHRoZSB6b29tIGFuZCBCb3VuZHMgb2YgdGhlIE1vbWVudGFEaWFncmFtLlxyXG4gKiAgIC0gQ3JlYXRlIGEgTW9tZW50YURpYWdyYW1WZWN0b3IgZm9yIGFsbCBwb3NzaWJsZSBCYWxscyBhbmQgb25lIGZvciB0aGUgdG90YWwgTW9tZW50dW0gVmVjdG9yLiBNb21lbnRhIERpYWdyYW0gdGFrZXNcclxuICogICAgIGFkdmFudGFnZSBvZiB0aGUgcHJlcG9wdWxhdGVkQmFsbHMsIHdoaWNoIGFsbCBCYWxscyBpbiB0aGUgc3lzdGVtIG11c3QgYmUgYXBhcnQgb2YuIEluc3RlYWQgb2YgY3JlYXRpbmcgYVxyXG4gKiAgICAgTW9tZW50YURpYWdyYW1WZWN0b3IgZWFjaCB0aW1lIGEgQmFsbCBpcyBhZGRlZCB0byB0aGUgc3lzdGVtLCBpdCBjcmVhdGVzIG9uZSBmb3IgZWFjaCBwcmVwb3B1bGF0ZWRCYWxsIGFuZFxyXG4gKiAgICAgb25seSB1cGRhdGVzIGl0IGlmIHRoZSBhc3NvY2lhdGVkIEJhbGwgaXMgaW4gdGhlIHN5c3RlbSwgd2hpY2ggZWxpbWluYXRlcyB0aGUgbmVjZXNzaXR5IHRvIGRpc3Bvc2VcclxuICogICAgIE1vbWVudGFEaWFncmFtVmVjdG9ycy5cclxuICpcclxuICogICAtIFVwZGF0ZSB0aGUgdGFpbCBwb3NpdGlvbnMgYW5kIGNvbXBvbmVudHMgb2YgdGhlIE1vbWVudGFEaWFncmFtVmVjdG9ycyB3aGVuIG5lY2Vzc2FyeS4gTW9tZW50YURpYWdyYW1zIGFyZVxyXG4gKiAgICAgZGVzaWduZWQgYW5kIGltcGxlbWVudGVkIHRvIGJlIG1pbmltYWxseSBpbnZhc2l2ZSB0byBvcHRpbWl6ZSB0aGUgcGVyZm9ybWFuY2Ugb2YgdGhlIHNpbXVsYXRpb24uIFRoZSBwb3NpdGlvblxyXG4gKiAgICAgYW5kIGNvbXBvbmVudHMgb2YgdGhlIE1vbWVudGFEaWFncmFtVmVjdG9ycyBhcmUgb25seSB1cGRhdGVkIGlmIHRoZSBNb21lbnRhIERpYWdyYW0gYWNjb3JkaW9uIGJveCBpcyBleHBhbmRlZC5cclxuICogICAgIFRoZSBwb3NpdGlvbmluZyBhbHNvIGRpZmZlcnMgZGVwZW5kaW5nIG9uIHRoZSBkaW1lbnNpb24gb2YgdGhlIFBsYXlBcmVhLlxyXG4gKlxyXG4gKiBNb21lbnRhRGlhZ3JhbXMgYXJlIGNyZWF0ZWQgYXQgdGhlIHN0YXJ0IG9mIHRoZSBzaW0gYW5kIGFyZSBuZXZlciBkaXNwb3NlZCwgc28gbm8gZGlzcG9zZSBtZXRob2QgaXMgbmVjZXNzYXJ5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgQXNzZXJ0VXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy9Bc3NlcnRVdGlscy5qcyc7XHJcbmltcG9ydCBjb2xsaXNpb25MYWIgZnJvbSAnLi4vLi4vY29sbGlzaW9uTGFiLmpzJztcclxuaW1wb3J0IENvbGxpc2lvbkxhYkNvbnN0YW50cyBmcm9tICcuLi9Db2xsaXNpb25MYWJDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgQ29sbGlzaW9uTGFiVXRpbHMgZnJvbSAnLi4vQ29sbGlzaW9uTGFiVXRpbHMuanMnO1xyXG5pbXBvcnQgQmFsbCBmcm9tICcuL0JhbGwuanMnO1xyXG5pbXBvcnQgTW9tZW50YURpYWdyYW1WZWN0b3IgZnJvbSAnLi9Nb21lbnRhRGlhZ3JhbVZlY3Rvci5qcyc7XHJcbmltcG9ydCBQbGF5QXJlYSBmcm9tICcuL1BsYXlBcmVhLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBNT01FTlRBX0RJQUdSQU1fWk9PTV9SQU5HRSA9IENvbGxpc2lvbkxhYkNvbnN0YW50cy5NT01FTlRBX0RJQUdSQU1fWk9PTV9SQU5HRTtcclxuY29uc3QgTU9NRU5UQV9ESUFHUkFNX0FTUEVDVF9SQVRJTyA9IENvbGxpc2lvbkxhYkNvbnN0YW50cy5NT01FTlRBX0RJQUdSQU1fQVNQRUNUX1JBVElPO1xyXG5jb25zdCBaT09NX01VTFRJUExJRVIgPSAyO1xyXG5jb25zdCBERUZBVUxUXzFEX1ZFUlRJQ0FMX1NQQUNJTkcgPSAwLjM7XHJcblxyXG5jbGFzcyBNb21lbnRhRGlhZ3JhbSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7QmFsbHNbXX0gcHJlcG9wdWxhdGVkQmFsbHMgLSBhbiBhcnJheSBvZiBBbGwgcG9zc2libGUgYmFsbHMgaW4gdGhlIHN5c3RlbS5cclxuICAgKiBAcGFyYW0ge09ic2VydmFibGVBcnJheURlZi48QmFsbD59IGJhbGxzIC0gdGhlIGJhbGxzIGluIHRoZSBzeXN0ZW0uIE11c3QgYmVsb25nIGluIHByZXBvcHVsYXRlZEJhbGxzLlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBkaW1lbnNpb24gLSB0aGUgZGltZW5zaW9uIG9mIHRoZSBQbGF5QXJlYSwgdXNlZCBmb3IgcG9zaXRpb25pbmcgZGlmZmVyZW5jZXMuIEVpdGhlciAxIG9yIDIuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHByZXBvcHVsYXRlZEJhbGxzLCBiYWxscywgZGltZW5zaW9uICkge1xyXG4gICAgYXNzZXJ0ICYmIEFzc2VydFV0aWxzLmFzc2VydEFycmF5T2YoIHByZXBvcHVsYXRlZEJhbGxzLCBCYWxsICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBBcnJheS5pc0FycmF5KCBiYWxscyApICkgJiYgQXNzZXJ0VXRpbHMuYXNzZXJ0QXJyYXlPZiggYmFsbHMsIEJhbGwgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIFBsYXlBcmVhLkRpbWVuc2lvbi5pbmNsdWRlcyggZGltZW5zaW9uICksIGBpbnZhbGlkIGRpbWVuc2lvbjogJHtkaW1lbnNpb259YCApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge1Byb3BlcnR5LjxudW1iZXI+fSAtIHRoZSB6b29tIGZhY3RvciBvZiB0aGUgTW9tZW50YURpYWdyYW0uIFRoaXMgaXMgc2V0IGV4dGVybmFsbHkgaW4gdGhlIHZpZXcuXHJcbiAgICB0aGlzLnpvb21Qcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggTU9NRU5UQV9ESUFHUkFNX1pPT01fUkFOR0UuZGVmYXVsdFZhbHVlLCB7XHJcbiAgICAgIHJhbmdlOiBNT01FTlRBX0RJQUdSQU1fWk9PTV9SQU5HRVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkge1Byb3BlcnR5LjxCb3VuZHMyPn0gLSB0aGUgQm91bmRzIG9mIHRoZSBNb21lbnRhRGlhZ3JhbSwgaW4ga2cqKG0vcykuIERlcml2ZWQgZnJvbSB0aGUgem9vbVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhY3Rvci4gVGhpcyBpcyBpbnNpZGUgdGhlIG1vZGVsIHRvIG1ha2UgdGhlIHNwYWNpbmcgYmV0d2VlblxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1vbWVudGFEaWFncmFtVmVjdG9ycyB2aXN1YWxseSB1bmlmb3JtIGZvciAxRCBzY3JlZW5zLiBTZWVcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY29sbGlzaW9uLWxhYi9pc3N1ZXMvMTY0LlxyXG4gICAgdGhpcy5ib3VuZHNQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgdGhpcy56b29tUHJvcGVydHkgXSwgem9vbUZhY3RvciA9PiB7XHJcblxyXG4gICAgICAvLyBUaGUgY2VudGVyIG9mIHRoZSBNb21lbnRhRGlhZ3JhbSBpcyB0aGUgb3JpZ2luLlxyXG4gICAgICByZXR1cm4gbmV3IEJvdW5kczIoXHJcbiAgICAgICAgLU1PTUVOVEFfRElBR1JBTV9BU1BFQ1RfUkFUSU8ud2lkdGggLyAyIC8gem9vbUZhY3RvcixcclxuICAgICAgICAtTU9NRU5UQV9ESUFHUkFNX0FTUEVDVF9SQVRJTy5oZWlnaHQgLyAyIC8gem9vbUZhY3RvcixcclxuICAgICAgICBNT01FTlRBX0RJQUdSQU1fQVNQRUNUX1JBVElPLndpZHRoIC8gMiAvIHpvb21GYWN0b3IsXHJcbiAgICAgICAgTU9NRU5UQV9ESUFHUkFNX0FTUEVDVF9SQVRJTy5oZWlnaHQgLyAyIC8gem9vbUZhY3RvclxyXG4gICAgICApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge1Byb3BlcnR5Ljxib29sZWFuPn0gLSBpbmRpY2F0ZXMgaWYgdGhlIE1vbWVudGFEaWFncmFtIGlzIGV4cGFuZGVkLiBUaGlzIGlzIGluIHRoZSBtb2RlbCBzaW5jZSB0aGUgcG9zaXRpb25zXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGNvbXBvbmVudHMgb2YgdGhlIE1vbWVudGEgVmVjdG9ycyBhcmUgb25seSB1cGRhdGVkIGlmIHRoaXMgaXMgdHJ1ZS5cclxuICAgIHRoaXMuZXhwYW5kZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSB7TWFwLjxCYWxsLCBNb21lbnRhRGlhZ3JhbVZlY3Rvcj59IC0gTWFwIHByZXBvcHVsYXRlZEJhbGxzIHRvIGFuIGFzc29jaWF0ZWQgTW9tZW50YSBWZWN0b3IuXHJcbiAgICB0aGlzLmJhbGxUb01vbWVudGFWZWN0b3JNYXAgPSBuZXcgTWFwKCk7XHJcblxyXG4gICAgLy8gUG9wdWxhdGUgdGhlIE1hcCB3aXRoIE1vbWVudGFEaWFncmFtVmVjdG9ycy5cclxuICAgIHByZXBvcHVsYXRlZEJhbGxzLmZvckVhY2goIGJhbGwgPT4ge1xyXG4gICAgICB0aGlzLmJhbGxUb01vbWVudGFWZWN0b3JNYXAuc2V0KCBiYWxsLCBuZXcgTW9tZW50YURpYWdyYW1WZWN0b3IoKSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkge01vbWVudGFEaWFncmFtVmVjdG9yfSAtIHRoZSB0b3RhbCBzdW0gb2YgdGhlIE1vbWVudGEgVmVjdG9ycyBvZiB0aGUgc3lzdGVtLlxyXG4gICAgdGhpcy50b3RhbE1vbWVudHVtVmVjdG9yID0gbmV3IE1vbWVudGFEaWFncmFtVmVjdG9yKCk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge09ic2VydmFibGVBcnJheURlZi48QmFsbHM+fSAtIHJlZmVyZW5jZSB0byB0aGUgQmFsbHMgaW4gdGhlIEJhbGxTeXN0ZW0uXHJcbiAgICB0aGlzLmJhbGxzID0gYmFsbHM7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7bnVtYmVyfSAtIHJlZmVyZW5jZSB0byB0aGUgcGFzc2VkLWluIGRpbWVuc2lvbiBvZiB0aGUgUGxheUFyZWEuXHJcbiAgICB0aGlzLmRpbWVuc2lvbiA9IGRpbWVuc2lvbjtcclxuXHJcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgICAvLyBDcmVhdGUgYSBNdWx0aWxpbmsgdG8gdXBkYXRlIHRoZSBwb3NpdGlvbmluZyBhbmQgY29tcG9uZW50cyBvZiB0aGUgTW9tZW50YSBWZWN0b3JzLlxyXG4gICAgLy9cclxuICAgIC8vIEZvciB0aGUgZGVwZW5kZW5jaWVzLCB3ZSB1c2U6XHJcbiAgICAvLyAgLSBleHBhbmRlZFByb3BlcnR5OyBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucywgdGhlIE1vbWVudGFEaWFncmFtIGlzbid0IHVwZGF0ZWQgaXQgaXNuJ3QgdmlzaWJsZS5cclxuICAgIC8vICAtIFRoZSBtb21lbnR1bSBQcm9wZXJ0aWVzIG9mIHRoZSBwcmVwb3B1bGF0ZWRCYWxscy4gT25seSB0aGUgYmFsbHMgaW4gdGhlIEJhbGxTeXN0ZW0gYXJlIHBvc2l0aW9uZWQgYW5kIHVzZWQgaW5cclxuICAgIC8vICAgIHRoZSB0b3RhbCBtb21lbnR1bSBjYWxjdWxhdGlvbi5cclxuICAgIC8vICAtIGJhbGxzLmxlbmd0aFByb3BlcnR5LCBzaW5jZSByZW1vdmluZyBvciBhZGRpbmcgYSBCYWxsIGNoYW5nZXMgdGhlIHRvdGFsIG1vbWVudHVtLlxyXG4gICAgLy8gIC0gdGhpcy56b29tUHJvcGVydHksIHNpbmNlIGNoYW5naW5nIHRoZSB6b29tIGNoYW5nZXMgdGhlIHZlcnRpY2FsIHNwYWNpbmcgYmV0d2VlbiB2ZWN0b3JzIGZvciAxRCBzY3JlZW5zLlxyXG4gICAgLy9cclxuICAgIC8vIFRoaXMgTXVsdGlsaW5rIGlzIG5ldmVyIGRpc3Bvc2VkIGFuZCBsYXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKFxyXG4gICAgICBbIHRoaXMuZXhwYW5kZWRQcm9wZXJ0eSwgLi4ucHJlcG9wdWxhdGVkQmFsbHMubWFwKCBiYWxsID0+IGJhbGwubW9tZW50dW1Qcm9wZXJ0eSApLCBiYWxscy5sZW5ndGhQcm9wZXJ0eSwgdGhpcy56b29tUHJvcGVydHkgXSxcclxuICAgICAgZXhwYW5kZWQgPT4ge1xyXG4gICAgICAgIGV4cGFuZGVkICYmIHRoaXMudXBkYXRlVmVjdG9ycygpOyAvLyBPbmx5IHVwZGF0ZSBpZiB0aGUgTW9tZW50YURpYWdyYW0gaXMgdmlzaWJsZSAoZXhwYW5kZWQpLlxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIHRoZSBNb21lbnRhRGlhZ3JhbS5cclxuICAgKiBAcHVibGljXHJcbiAgICpcclxuICAgKiBDYWxsZWQgd2hlbiB0aGUgcmVzZXQtYWxsIGJ1dHRvbiBpcyBwcmVzc2VkLlxyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy56b29tUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuZXhwYW5kZWRQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5iYWxsVG9Nb21lbnRhVmVjdG9yTWFwLmZvckVhY2goIG1vbWVudGFWZWN0b3IgPT4geyBtb21lbnRhVmVjdG9yLnJlc2V0KCk7IH0gKTtcclxuICAgIHRoaXMudG90YWxNb21lbnR1bVZlY3Rvci5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB0aGUgY29tcG9uZW50cyBhbmQgcG9zaXRpb25zIG9mIHRoZSBtb21lbnR1bSBWZWN0b3JzIHRvIG1hdGNoIHRoZSBCYWxscyBpbiB0aGUgQmFsbFN5c3RlbS4gT25seSB0aGUgQmFsbHNcclxuICAgKiBpbiB0aGUgQmFsbFN5c3RlbSBhcmUgdXBkYXRlZCBhbmQgdXNlZCB0byBjYWxjdWxhdGUgdGhlIHRvdGFsIG1vbWVudHVtLlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICpcclxuICAgKiBUaGUgcG9zaXRpb25pbmcgb2YgdGhlIG1vbWVudHVtIFZlY3RvcnMgYXJlIGRpZmZlcmVudCBmb3IgZWFjaCBkaW1lbnNpb246XHJcbiAgICpcclxuICAgKiAgIEZvciAyRCBTY3JlZW5zOlxyXG4gICAqICAgICAtIFRoZSBmaXJzdCBtb21lbnR1bSBhbmQgdGhlIHRvdGFsIG1vbWVudHVtIFZlY3RvcnMgYXJlIHBsYWNlZCBhdCB0aGUgb3JpZ2luLlxyXG4gICAqICAgICAtIE1vbWVudHVtIHZlY3RvcnMgYXJlIHBsYWNlZCB0aXAtdG8tdGFpbFxyXG4gICAqXHJcbiAgICogICBGb3IgMUQgc2NyZWVuczpcclxuICAgKiAgICAgLSBUaGUgbW9tZW50dW0gdmVjdG9ycyBhcmUgc3RhY2tlZCB2ZXJ0aWNhbGx5IG9uIHRvcCBvZiBlYWNoIG90aGVyLCB3aXRoIHRoZSBmaXJzdCB2ZWN0b3Igb24gdG9wIGFuZFxyXG4gICAqICAgICAgIHRoZSB0YWlsWSBjb29yZGluYXRlcyBvZiB0aGUgb3RoZXIgdmVjdG9ycyBhcmUgb25lLW9mZiBvZiBlYWNoIG90aGVyLlxyXG4gICAqICAgICAtIFRoZSBmaXJzdCBtb21lbnR1bSBWZWN0b3IgYW5kIHRoZSB0b3RhbCBtb21lbnR1bSBWZWN0b3IncyB0YWlsWCBhcmUgcGxhY2VkIGF0IHggPSAwLiBUaGUgdmVjdG9ycyBhcmUgdGhlblxyXG4gICAqICAgICAgIHBsYWNlZCB0aXBYLXRvLXRhaWxYLlxyXG4gICAqL1xyXG4gIHVwZGF0ZVZlY3RvcnMoKSB7XHJcblxyXG4gICAgLy8gRmlyc3QgdXBkYXRlIHRoZSBjb21wb25lbnRzIG9mIHRoZSBWZWN0b3JzLlxyXG4gICAgdGhpcy5iYWxscy5mb3JFYWNoKCBiYWxsID0+IHtcclxuICAgICAgdGhpcy5iYWxsVG9Nb21lbnRhVmVjdG9yTWFwLmdldCggYmFsbCApLmNvbXBvbmVudHNQcm9wZXJ0eS52YWx1ZSA9IGJhbGwubW9tZW50dW1Qcm9wZXJ0eS52YWx1ZTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBDb21wdXRlIHRoZSBjb21wb25lbnRzIG9mIHRoZSB0b3RhbCBNb21lbnRhIFZlY3Rvci5cclxuICAgIGNvbnN0IHRvdGFsTW9tZW50dW0gPSBWZWN0b3IyLlpFUk8uY29weSgpO1xyXG5cclxuICAgIC8vIExvb3AgdGhyb3VnaCBhbmQgY2FsY3VsYXRlIHRoZSB0b3RhbCBtb21lbnR1bSBvZiB0aGUgQmFsbHMgaW4gdGhlIEJhbGxTeXN0ZW0uXHJcbiAgICB0aGlzLmJhbGxzLmZvckVhY2goIGJhbGwgPT4geyB0b3RhbE1vbWVudHVtLmFkZCggYmFsbC5tb21lbnR1bVByb3BlcnR5LnZhbHVlICk7IH0gKTtcclxuICAgIHRoaXMudG90YWxNb21lbnR1bVZlY3Rvci5jb21wb25lbnRzUHJvcGVydHkudmFsdWUgPSB0b3RhbE1vbWVudHVtO1xyXG5cclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuICAgIC8vIFJlZmVyZW5jZSB0aGUgTW9tZW50YSBWZWN0b3IgYXNzb2NpYXRlZCB3aXRoIHRoZSBmaXJzdCBCYWxsIGluIHRoZSBzeXN0ZW0uXHJcbiAgICBjb25zdCBmaXJzdE1vbWVudGFWZWN0b3IgPSB0aGlzLmJhbGxUb01vbWVudGFWZWN0b3JNYXAuZ2V0KCB0aGlzLmJhbGxzWyAwIF0gKTtcclxuXHJcbiAgICAvLyBDYWxjdWxhdGUgdGhlIHZlcnRpY2FsIHNwYWNpbmcgYmV0d2VlbiB0aGUgdmVjdG9ycyBmb3IgMUQgc2NyZWVucywgd2hpY2ggaXMgZGVwZW5kZW50IG9uIHRoZSB6b29tLWxldmVsLlxyXG4gICAgY29uc3QgdmVydGljYWxTcGFjaW5nID0gREVGQVVMVF8xRF9WRVJUSUNBTF9TUEFDSU5HIC8gdGhpcy56b29tUHJvcGVydHkudmFsdWUgKiBNT01FTlRBX0RJQUdSQU1fWk9PTV9SQU5HRS5kZWZhdWx0VmFsdWU7XHJcblxyXG4gICAgLy8gUG9zaXRpb24gdGhlIGZpcnN0IE1vbWVudGEgVmVjdG9yIGFuZCB0aGUgdG90YWwgTW9tZW50YSBWZWN0b3IgaW4gdGhlIGNvcnJlY3QgcG9zaXRpb24uXHJcbiAgICBpZiAoIHRoaXMuZGltZW5zaW9uID09PSBQbGF5QXJlYS5EaW1lbnNpb24uVFdPICkge1xyXG5cclxuICAgICAgLy8gU2V0IHRoZSBmaXJzdCBNb21lbnRhIFZlY3RvcidzIHRhaWwgYW5kIHRoZSB0b3RhbCBNb21lbnRhIFZlY3RvcidzIHRhaWwgYXQgdGhlIG9yaWdpbi5cclxuICAgICAgZmlyc3RNb21lbnRhVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gdGhpcy5ib3VuZHNQcm9wZXJ0eS52YWx1ZS5jZW50ZXI7XHJcbiAgICAgIHRoaXMudG90YWxNb21lbnR1bVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IHRoaXMuYm91bmRzUHJvcGVydHkudmFsdWUuY2VudGVyO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICAvLyBTZXQgdGhlIGZpcnN0IE1vbWVudGEgVmVjdG9yJ3MgdGFpbCBhbmQgdGhlIHRvdGFsIE1vbWVudGEgVmVjdG9yJ3MgdGFpbCBhdCB4ID0gMC5cclxuICAgICAgZmlyc3RNb21lbnRhVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIDAsIGZpcnN0TW9tZW50YVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55ICk7XHJcbiAgICAgIHRoaXMudG90YWxNb21lbnR1bVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCAwLCB0aGlzLnRvdGFsTW9tZW50dW1WZWN0b3IudGFpbFBvc2l0aW9uUHJvcGVydHkudmFsdWUueSApO1xyXG5cclxuICAgICAgLy8gU2V0IHRoZSB5LXZhbHVlIG9mIHRoZSBmaXJzdCBNb21lbnRhIFZlY3RvcidzIHRhaWwgYW5kIHRoZSB0b3RhbCBNb21lbnRhIFZlY3RvcidzIHRhaWwgd2hpY2ggZGVwZW5kcyBvbiB0aGVcclxuICAgICAgLy8gbnVtYmVyIG9mIGJhbGxzIGluIHRoZSBzeXN0ZW0uXHJcbiAgICAgIGZpcnN0TW9tZW50YVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCBmaXJzdE1vbWVudGFWZWN0b3IudGFpbFBvc2l0aW9uUHJvcGVydHkudmFsdWUueCwgdmVydGljYWxTcGFjaW5nICogKCB0aGlzLmJhbGxzLmxlbmd0aCAvIDIgKyAwLjkgKSApO1xyXG4gICAgICB0aGlzLnRvdGFsTW9tZW50dW1WZWN0b3IudGFpbFBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMiggdGhpcy50b3RhbE1vbWVudHVtVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlLngsIGZpcnN0TW9tZW50YVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55IC0gdGhpcy5iYWxscy5sZW5ndGggKiB2ZXJ0aWNhbFNwYWNpbmcgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQb3NpdGlvbiB0aGUgcmVzdCBvZiB0aGUgTW9tZW50dW0gdmVjdG9ycy4gTG9vcCBpbiBwYWlycy5cclxuICAgIENvbGxpc2lvbkxhYlV0aWxzLmZvckVhY2hBZGphY2VudFBhaXIoIHRoaXMuYmFsbHMsICggYmFsbCwgcHJldmlvdXNCYWxsICkgPT4ge1xyXG4gICAgICBjb25zdCBtb21lbnRhVmVjdG9yID0gdGhpcy5iYWxsVG9Nb21lbnRhVmVjdG9yTWFwLmdldCggYmFsbCApO1xyXG4gICAgICBjb25zdCBwcmV2aW91c01vbWVudGFWZWN0b3IgPSB0aGlzLmJhbGxUb01vbWVudGFWZWN0b3JNYXAuZ2V0KCBwcmV2aW91c0JhbGwgKTtcclxuXHJcbiAgICAgIGlmICggdGhpcy5kaW1lbnNpb24gPT09IFBsYXlBcmVhLkRpbWVuc2lvbi5UV08gKSB7XHJcblxyXG4gICAgICAgIC8vIHRpcC10by10YWlsXHJcbiAgICAgICAgbW9tZW50YVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IHByZXZpb3VzTW9tZW50YVZlY3Rvci50aXBQb3NpdGlvblByb3BlcnR5LnZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyB0aXBYLXRvLXRhaWxYXHJcbiAgICAgICAgbW9tZW50YVZlY3Rvci50YWlsUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCBwcmV2aW91c01vbWVudGFWZWN0b3IudGlwUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54LCBtb21lbnRhVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlLnkgKTtcclxuXHJcbiAgICAgICAgLy8gU3RhY2sgdmVydGljYWxseSBvbiB0b3Agb2YgZWFjaCBvdGhlciBieSBwcm9ncmVzc2l2ZWx5IGRlY3JlbWVudGluZyB0aGUgdGlwWS5cclxuICAgICAgICBtb21lbnRhVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIG1vbWVudGFWZWN0b3IudGFpbFBvc2l0aW9uUHJvcGVydHkudmFsdWUueCwgcHJldmlvdXNNb21lbnRhVmVjdG9yLnRhaWxQb3NpdGlvblByb3BlcnR5LnZhbHVlLnkgLSB2ZXJ0aWNhbFNwYWNpbmcgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogWm9vbXMgdGhlIE1vbWVudGFEaWFncmFtIGluLiBDYWxsZWQgd2hlbiB0aGUgem9vbS1pbiBidXR0b24gaXMgcHJlc3NlZC5cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgem9vbUluKCkge1xyXG4gICAgdGhpcy56b29tUHJvcGVydHkudmFsdWUgKj0gWk9PTV9NVUxUSVBMSUVSO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogWm9vbXMgdGhlIE1vbWVudGFEaWFncmFtIG91dC4gQ2FsbGVkIHdoZW4gdGhlIHpvb20tb3V0IGJ1dHRvbiBpcyBwcmVzc2VkLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICB6b29tT3V0KCkge1xyXG4gICAgdGhpcy56b29tUHJvcGVydHkudmFsdWUgLz0gWk9PTV9NVUxUSVBMSUVSO1xyXG4gIH1cclxufVxyXG5cclxuY29sbGlzaW9uTGFiLnJlZ2lzdGVyKCAnTW9tZW50YURpYWdyYW0nLCBNb21lbnRhRGlhZ3JhbSApO1xyXG5leHBvcnQgZGVmYXVsdCBNb21lbnRhRGlhZ3JhbTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLGNBQWMsTUFBTSx1Q0FBdUM7QUFDbEUs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