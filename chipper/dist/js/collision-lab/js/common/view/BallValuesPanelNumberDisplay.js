// Copyright 2020-2022, University of Colorado Boulder

/**
 * BallValuesPanelNumberDisplay is a subclass of NumberDisplay for displaying a value that is associated with a Ball.
 * Instances appear in the BallValuesPanel.
 *
 * Adds the following functionality to NumberDisplay:
 *   - Displays a single component of a Ball Vector (i.e. x-position | x-velocity ... ) of a single Ball. Each
 *     BallValuesPanelNumberDisplay is associated with a BallValuesPanelColumnNode.
 *
 *   - If BallValuesPanelColumnTypes is X_MOMENTUM or Y_MOMENTUM, it solely displays the Ball Property.
 *     Otherwise the Ball Property is editable, meaning when the NumberDisplay is pressed, the KeypadDialog is opened,
 *     allowing the user to edit the value of the Ball quantity.
 *
 *   - If the user is controlling the associated BallProperty, a highlight is added to the NumberDisplay. See
 *     https://github.com/phetsims/collision-lab/issues/95.
 *
 * For the 'Collision Lab' sim, BallValuesPanelNumberDisplays are instantiated at the start and are never disposed.
 * See BallValuesPanelColumnNode for more background.
 *
 * @author Brandon Li
 */

import PatternStringProperty from '../../../../axon/js/PatternStringProperty.js';
import Range from '../../../../dot/js/Range.js';
import Utils from '../../../../dot/js/Utils.js';
import merge from '../../../../phet-core/js/merge.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import NumberDisplay from '../../../../scenery-phet/js/NumberDisplay.js';
import { Color, FireListener } from '../../../../scenery/js/imports.js';
import collisionLab from '../../collisionLab.js';
import CollisionLabStrings from '../../CollisionLabStrings.js';
import CollisionLabColors from '../CollisionLabColors.js';
import CollisionLabConstants from '../CollisionLabConstants.js';
import Ball from '../model/Ball.js';
import BallSystem from '../model/BallSystem.js';
import BallValuesPanelColumnTypes from './BallValuesPanelColumnTypes.js';
import KeypadDialog from '../../../../scenery-phet/js/keypad/KeypadDialog.js';

// constants
const DISPLAY_RANGE = new Range(-10, 10); // Display range for the NumberDisplay (used to determine width).

class BallValuesPanelNumberDisplay extends NumberDisplay {
  /**
   * @param {Ball} ball - the Ball model
   * @param {BallValuesPanelColumnTypes} columnType - the type of column that this NumberDisplay appears in.
   * @param {ballSystem} ballSystem
   * @param {KeypadDialog} keypadDialog
   * @param {Object} [options]
   */
  constructor(ball, columnType, ballSystem, keypadDialog, options) {
    assert && assert(ball instanceof Ball, `invalid Ball: ${ball}`);
    assert && assert(ballSystem instanceof BallSystem, `invalid ballSystem: ${ballSystem}`);
    assert && assert(keypadDialog instanceof KeypadDialog, `invalid keypadDialog: ${keypadDialog}`);
    assert && assert(BallValuesPanelColumnTypes.includes(columnType) && columnType !== BallValuesPanelColumnTypes.BALL_ICONS && columnType !== BallValuesPanelColumnTypes.MASS_SLIDERS, `invalid columnType: ${columnType}`);

    // Indicates if the Ball Property can be edited.
    const canEdit = columnType.editConfig !== null;

    // Gets the property of the Ball that is associated with the BallValuesPanelColumnType.
    const ballProperty = columnType.createDisplayProperty(ball);
    options = merge({
      align: 'center',
      textOptions: {
        font: CollisionLabConstants.DISPLAY_FONT
      },
      backgroundStroke: canEdit ? Color.BLACK : null,
      backgroundFill: canEdit ? Color.WHITE : null,
      cursor: canEdit ? 'pointer' : null,
      backgroundLineWidth: 0.5,
      yMargin: 3,
      xMargin: 10,
      decimalPlaces: CollisionLabConstants.DISPLAY_DECIMAL_PLACES
    }, options);
    const decimalPlaces = options.decimalPlaces;
    options = _.omit(options, ['decimalPlaces']);
    options.numberFormatter = value => {
      let numberString = Utils.toFixed(value, decimalPlaces);
      const absValue = Math.abs(value);
      // For non-position columns, show approximates, see https://github.com/phetsims/collision-lab/issues/182
      if (columnType !== BallValuesPanelColumnTypes.X_POSITION && columnType !== BallValuesPanelColumnTypes.Y_POSITION && absValue > 1e-9 && absValue < 0.005) {
        numberString = StringUtils.fillIn(CollisionLabStrings.approximatePattern, {
          value: '0.00'
        });
      }
      return numberString;
    };
    super(ballProperty, DISPLAY_RANGE, options);

    //----------------------------------------------------------------------------------------

    if (canEdit) {
      // Get the Property that indicates if the user is controlling the associated BallProperty.
      const userControlledProperty = columnType.editConfig.getUserControlledProperty(ball);

      // Observe when the user is controlling the associated BallProperty and a highlight to the NumberDisplay. See
      // https://github.com/phetsims/collision-lab/issues/95. Link is never disposed since BallValuesPanelNumberDisplays
      // are never disposed.
      userControlledProperty.link(userControlled => {
        this.backgroundFill = userControlled ? CollisionLabColors.HIGHLIGHTED_NUMBER_DISPLAY_FILL : options.backgroundFill;
      });

      // Get the unit displayed when the user is editing the BallProperty.
      const unit = columnType.editConfig.editingUnit;
      const editValue = value => columnType.editConfig.editValue(ball, value);

      // Observe when the user presses the NumberDisplay and open the KeypadDialog to allow the user to edit the
      // ballProperty. Listener is never removed since BallValuesPanelNumberDisplays are never disposed.
      this.addInputListener(new FireListener({
        fire: () => {
          // Indicate that the BallProperty is currently being user controlled.
          userControlledProperty.value = true;

          // Get the editing Range of the BallProperty. Must be recomputed every time the KeypadDialog is opened.
          const editingRange = columnType.editConfig.getEditingRange(ball);
          keypadDialog.beginEdit(editValue, editingRange, new PatternStringProperty(CollisionLabStrings.pattern.rangeStringProperty, {
            units: unit || ''
          }), () => {
            // When the user is finished editing the BallProperty, bump the Ball away from the other Balls that it is
            // overlapping with. See https://github.com/phetsims/collision-lab/issues/100.
            ballSystem.bumpBallAwayFromOthers(ball);

            // Now indicate that the user is finished editing this BallProperty.
            userControlledProperty.value = false;
          });
        },
        fireOnDown: true
      }));
    }
  }
}
collisionLab.register('BallValuesPanelNumberDisplay', BallValuesPanelNumberDisplay);
export default BallValuesPanelNumberDisplay;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQYXR0ZXJuU3RyaW5nUHJvcGVydHkiLCJSYW5nZSIsIlV0aWxzIiwibWVyZ2UiLCJTdHJpbmdVdGlscyIsIk51bWJlckRpc3BsYXkiLCJDb2xvciIsIkZpcmVMaXN0ZW5lciIsImNvbGxpc2lvbkxhYiIsIkNvbGxpc2lvbkxhYlN0cmluZ3MiLCJDb2xsaXNpb25MYWJDb2xvcnMiLCJDb2xsaXNpb25MYWJDb25zdGFudHMiLCJCYWxsIiwiQmFsbFN5c3RlbSIsIkJhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGVzIiwiS2V5cGFkRGlhbG9nIiwiRElTUExBWV9SQU5HRSIsIkJhbGxWYWx1ZXNQYW5lbE51bWJlckRpc3BsYXkiLCJjb25zdHJ1Y3RvciIsImJhbGwiLCJjb2x1bW5UeXBlIiwiYmFsbFN5c3RlbSIsImtleXBhZERpYWxvZyIsIm9wdGlvbnMiLCJhc3NlcnQiLCJpbmNsdWRlcyIsIkJBTExfSUNPTlMiLCJNQVNTX1NMSURFUlMiLCJjYW5FZGl0IiwiZWRpdENvbmZpZyIsImJhbGxQcm9wZXJ0eSIsImNyZWF0ZURpc3BsYXlQcm9wZXJ0eSIsImFsaWduIiwidGV4dE9wdGlvbnMiLCJmb250IiwiRElTUExBWV9GT05UIiwiYmFja2dyb3VuZFN0cm9rZSIsIkJMQUNLIiwiYmFja2dyb3VuZEZpbGwiLCJXSElURSIsImN1cnNvciIsImJhY2tncm91bmRMaW5lV2lkdGgiLCJ5TWFyZ2luIiwieE1hcmdpbiIsImRlY2ltYWxQbGFjZXMiLCJESVNQTEFZX0RFQ0lNQUxfUExBQ0VTIiwiXyIsIm9taXQiLCJudW1iZXJGb3JtYXR0ZXIiLCJ2YWx1ZSIsIm51bWJlclN0cmluZyIsInRvRml4ZWQiLCJhYnNWYWx1ZSIsIk1hdGgiLCJhYnMiLCJYX1BPU0lUSU9OIiwiWV9QT1NJVElPTiIsImZpbGxJbiIsImFwcHJveGltYXRlUGF0dGVybiIsInVzZXJDb250cm9sbGVkUHJvcGVydHkiLCJnZXRVc2VyQ29udHJvbGxlZFByb3BlcnR5IiwibGluayIsInVzZXJDb250cm9sbGVkIiwiSElHSExJR0hURURfTlVNQkVSX0RJU1BMQVlfRklMTCIsInVuaXQiLCJlZGl0aW5nVW5pdCIsImVkaXRWYWx1ZSIsImFkZElucHV0TGlzdGVuZXIiLCJmaXJlIiwiZWRpdGluZ1JhbmdlIiwiZ2V0RWRpdGluZ1JhbmdlIiwiYmVnaW5FZGl0IiwicGF0dGVybiIsInJhbmdlU3RyaW5nUHJvcGVydHkiLCJ1bml0cyIsImJ1bXBCYWxsQXdheUZyb21PdGhlcnMiLCJmaXJlT25Eb3duIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJCYWxsVmFsdWVzUGFuZWxOdW1iZXJEaXNwbGF5LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEJhbGxWYWx1ZXNQYW5lbE51bWJlckRpc3BsYXkgaXMgYSBzdWJjbGFzcyBvZiBOdW1iZXJEaXNwbGF5IGZvciBkaXNwbGF5aW5nIGEgdmFsdWUgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggYSBCYWxsLlxyXG4gKiBJbnN0YW5jZXMgYXBwZWFyIGluIHRoZSBCYWxsVmFsdWVzUGFuZWwuXHJcbiAqXHJcbiAqIEFkZHMgdGhlIGZvbGxvd2luZyBmdW5jdGlvbmFsaXR5IHRvIE51bWJlckRpc3BsYXk6XHJcbiAqICAgLSBEaXNwbGF5cyBhIHNpbmdsZSBjb21wb25lbnQgb2YgYSBCYWxsIFZlY3RvciAoaS5lLiB4LXBvc2l0aW9uIHwgeC12ZWxvY2l0eSAuLi4gKSBvZiBhIHNpbmdsZSBCYWxsLiBFYWNoXHJcbiAqICAgICBCYWxsVmFsdWVzUGFuZWxOdW1iZXJEaXNwbGF5IGlzIGFzc29jaWF0ZWQgd2l0aCBhIEJhbGxWYWx1ZXNQYW5lbENvbHVtbk5vZGUuXHJcbiAqXHJcbiAqICAgLSBJZiBCYWxsVmFsdWVzUGFuZWxDb2x1bW5UeXBlcyBpcyBYX01PTUVOVFVNIG9yIFlfTU9NRU5UVU0sIGl0IHNvbGVseSBkaXNwbGF5cyB0aGUgQmFsbCBQcm9wZXJ0eS5cclxuICogICAgIE90aGVyd2lzZSB0aGUgQmFsbCBQcm9wZXJ0eSBpcyBlZGl0YWJsZSwgbWVhbmluZyB3aGVuIHRoZSBOdW1iZXJEaXNwbGF5IGlzIHByZXNzZWQsIHRoZSBLZXlwYWREaWFsb2cgaXMgb3BlbmVkLFxyXG4gKiAgICAgYWxsb3dpbmcgdGhlIHVzZXIgdG8gZWRpdCB0aGUgdmFsdWUgb2YgdGhlIEJhbGwgcXVhbnRpdHkuXHJcbiAqXHJcbiAqICAgLSBJZiB0aGUgdXNlciBpcyBjb250cm9sbGluZyB0aGUgYXNzb2NpYXRlZCBCYWxsUHJvcGVydHksIGEgaGlnaGxpZ2h0IGlzIGFkZGVkIHRvIHRoZSBOdW1iZXJEaXNwbGF5LiBTZWVcclxuICogICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9jb2xsaXNpb24tbGFiL2lzc3Vlcy85NS5cclxuICpcclxuICogRm9yIHRoZSAnQ29sbGlzaW9uIExhYicgc2ltLCBCYWxsVmFsdWVzUGFuZWxOdW1iZXJEaXNwbGF5cyBhcmUgaW5zdGFudGlhdGVkIGF0IHRoZSBzdGFydCBhbmQgYXJlIG5ldmVyIGRpc3Bvc2VkLlxyXG4gKiBTZWUgQmFsbFZhbHVlc1BhbmVsQ29sdW1uTm9kZSBmb3IgbW9yZSBiYWNrZ3JvdW5kLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEJyYW5kb24gTGlcclxuICovXHJcblxyXG5pbXBvcnQgUGF0dGVyblN0cmluZ1Byb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUGF0dGVyblN0cmluZ1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFN0cmluZ1V0aWxzIGZyb20gJy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdXRpbC9TdHJpbmdVdGlscy5qcyc7XHJcbmltcG9ydCBOdW1iZXJEaXNwbGF5IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9OdW1iZXJEaXNwbGF5LmpzJztcclxuaW1wb3J0IHsgQ29sb3IsIEZpcmVMaXN0ZW5lciB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBjb2xsaXNpb25MYWIgZnJvbSAnLi4vLi4vY29sbGlzaW9uTGFiLmpzJztcclxuaW1wb3J0IENvbGxpc2lvbkxhYlN0cmluZ3MgZnJvbSAnLi4vLi4vQ29sbGlzaW9uTGFiU3RyaW5ncy5qcyc7XHJcbmltcG9ydCBDb2xsaXNpb25MYWJDb2xvcnMgZnJvbSAnLi4vQ29sbGlzaW9uTGFiQ29sb3JzLmpzJztcclxuaW1wb3J0IENvbGxpc2lvbkxhYkNvbnN0YW50cyBmcm9tICcuLi9Db2xsaXNpb25MYWJDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgQmFsbCBmcm9tICcuLi9tb2RlbC9CYWxsLmpzJztcclxuaW1wb3J0IEJhbGxTeXN0ZW0gZnJvbSAnLi4vbW9kZWwvQmFsbFN5c3RlbS5qcyc7XHJcbmltcG9ydCBCYWxsVmFsdWVzUGFuZWxDb2x1bW5UeXBlcyBmcm9tICcuL0JhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGVzLmpzJztcclxuaW1wb3J0IEtleXBhZERpYWxvZyBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMva2V5cGFkL0tleXBhZERpYWxvZy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgRElTUExBWV9SQU5HRSA9IG5ldyBSYW5nZSggLTEwLCAxMCApOyAvLyBEaXNwbGF5IHJhbmdlIGZvciB0aGUgTnVtYmVyRGlzcGxheSAodXNlZCB0byBkZXRlcm1pbmUgd2lkdGgpLlxyXG5cclxuY2xhc3MgQmFsbFZhbHVlc1BhbmVsTnVtYmVyRGlzcGxheSBleHRlbmRzIE51bWJlckRpc3BsYXkge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge0JhbGx9IGJhbGwgLSB0aGUgQmFsbCBtb2RlbFxyXG4gICAqIEBwYXJhbSB7QmFsbFZhbHVlc1BhbmVsQ29sdW1uVHlwZXN9IGNvbHVtblR5cGUgLSB0aGUgdHlwZSBvZiBjb2x1bW4gdGhhdCB0aGlzIE51bWJlckRpc3BsYXkgYXBwZWFycyBpbi5cclxuICAgKiBAcGFyYW0ge2JhbGxTeXN0ZW19IGJhbGxTeXN0ZW1cclxuICAgKiBAcGFyYW0ge0tleXBhZERpYWxvZ30ga2V5cGFkRGlhbG9nXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBiYWxsLCBjb2x1bW5UeXBlLCBiYWxsU3lzdGVtLCBrZXlwYWREaWFsb2csIG9wdGlvbnMgKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBiYWxsIGluc3RhbmNlb2YgQmFsbCwgYGludmFsaWQgQmFsbDogJHtiYWxsfWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGJhbGxTeXN0ZW0gaW5zdGFuY2VvZiBCYWxsU3lzdGVtLCBgaW52YWxpZCBiYWxsU3lzdGVtOiAke2JhbGxTeXN0ZW19YCApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCgga2V5cGFkRGlhbG9nIGluc3RhbmNlb2YgS2V5cGFkRGlhbG9nLCBgaW52YWxpZCBrZXlwYWREaWFsb2c6ICR7a2V5cGFkRGlhbG9nfWAgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIEJhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGVzLmluY2x1ZGVzKCBjb2x1bW5UeXBlIClcclxuICAgICYmIGNvbHVtblR5cGUgIT09IEJhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGVzLkJBTExfSUNPTlNcclxuICAgICYmIGNvbHVtblR5cGUgIT09IEJhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGVzLk1BU1NfU0xJREVSUywgYGludmFsaWQgY29sdW1uVHlwZTogJHtjb2x1bW5UeXBlfWAgKTtcclxuXHJcbiAgICAvLyBJbmRpY2F0ZXMgaWYgdGhlIEJhbGwgUHJvcGVydHkgY2FuIGJlIGVkaXRlZC5cclxuICAgIGNvbnN0IGNhbkVkaXQgPSBjb2x1bW5UeXBlLmVkaXRDb25maWcgIT09IG51bGw7XHJcblxyXG4gICAgLy8gR2V0cyB0aGUgcHJvcGVydHkgb2YgdGhlIEJhbGwgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggdGhlIEJhbGxWYWx1ZXNQYW5lbENvbHVtblR5cGUuXHJcbiAgICBjb25zdCBiYWxsUHJvcGVydHkgPSBjb2x1bW5UeXBlLmNyZWF0ZURpc3BsYXlQcm9wZXJ0eSggYmFsbCApO1xyXG5cclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBhbGlnbjogJ2NlbnRlcicsXHJcbiAgICAgIHRleHRPcHRpb25zOiB7XHJcbiAgICAgICAgZm9udDogQ29sbGlzaW9uTGFiQ29uc3RhbnRzLkRJU1BMQVlfRk9OVFxyXG4gICAgICB9LFxyXG4gICAgICBiYWNrZ3JvdW5kU3Ryb2tlOiBjYW5FZGl0ID8gQ29sb3IuQkxBQ0sgOiBudWxsLFxyXG4gICAgICBiYWNrZ3JvdW5kRmlsbDogY2FuRWRpdCA/IENvbG9yLldISVRFIDogbnVsbCxcclxuICAgICAgY3Vyc29yOiBjYW5FZGl0ID8gJ3BvaW50ZXInIDogbnVsbCxcclxuICAgICAgYmFja2dyb3VuZExpbmVXaWR0aDogMC41LFxyXG4gICAgICB5TWFyZ2luOiAzLFxyXG4gICAgICB4TWFyZ2luOiAxMCxcclxuICAgICAgZGVjaW1hbFBsYWNlczogQ29sbGlzaW9uTGFiQ29uc3RhbnRzLkRJU1BMQVlfREVDSU1BTF9QTEFDRVNcclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICBjb25zdCBkZWNpbWFsUGxhY2VzID0gb3B0aW9ucy5kZWNpbWFsUGxhY2VzO1xyXG4gICAgb3B0aW9ucyA9IF8ub21pdCggb3B0aW9ucywgWyAnZGVjaW1hbFBsYWNlcycgXSApO1xyXG4gICAgb3B0aW9ucy5udW1iZXJGb3JtYXR0ZXIgPSB2YWx1ZSA9PiB7XHJcbiAgICAgIGxldCBudW1iZXJTdHJpbmcgPSBVdGlscy50b0ZpeGVkKCB2YWx1ZSwgZGVjaW1hbFBsYWNlcyApO1xyXG5cclxuICAgICAgY29uc3QgYWJzVmFsdWUgPSBNYXRoLmFicyggdmFsdWUgKTtcclxuICAgICAgLy8gRm9yIG5vbi1wb3NpdGlvbiBjb2x1bW5zLCBzaG93IGFwcHJveGltYXRlcywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9jb2xsaXNpb24tbGFiL2lzc3Vlcy8xODJcclxuICAgICAgaWYgKCBjb2x1bW5UeXBlICE9PSBCYWxsVmFsdWVzUGFuZWxDb2x1bW5UeXBlcy5YX1BPU0lUSU9OICYmXHJcbiAgICAgICAgICAgY29sdW1uVHlwZSAhPT0gQmFsbFZhbHVlc1BhbmVsQ29sdW1uVHlwZXMuWV9QT1NJVElPTiAmJlxyXG4gICAgICAgICAgIGFic1ZhbHVlID4gMWUtOSAmJlxyXG4gICAgICAgICAgIGFic1ZhbHVlIDwgMC4wMDUgKSB7XHJcbiAgICAgICAgbnVtYmVyU3RyaW5nID0gU3RyaW5nVXRpbHMuZmlsbEluKCBDb2xsaXNpb25MYWJTdHJpbmdzLmFwcHJveGltYXRlUGF0dGVybiwge1xyXG4gICAgICAgICAgdmFsdWU6ICcwLjAwJ1xyXG4gICAgICAgIH0gKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIG51bWJlclN0cmluZztcclxuICAgIH07XHJcblxyXG4gICAgc3VwZXIoIGJhbGxQcm9wZXJ0eSwgRElTUExBWV9SQU5HRSwgb3B0aW9ucyApO1xyXG5cclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuICAgIGlmICggY2FuRWRpdCApIHtcclxuXHJcbiAgICAgIC8vIEdldCB0aGUgUHJvcGVydHkgdGhhdCBpbmRpY2F0ZXMgaWYgdGhlIHVzZXIgaXMgY29udHJvbGxpbmcgdGhlIGFzc29jaWF0ZWQgQmFsbFByb3BlcnR5LlxyXG4gICAgICBjb25zdCB1c2VyQ29udHJvbGxlZFByb3BlcnR5ID0gY29sdW1uVHlwZS5lZGl0Q29uZmlnLmdldFVzZXJDb250cm9sbGVkUHJvcGVydHkoIGJhbGwgKTtcclxuXHJcbiAgICAgIC8vIE9ic2VydmUgd2hlbiB0aGUgdXNlciBpcyBjb250cm9sbGluZyB0aGUgYXNzb2NpYXRlZCBCYWxsUHJvcGVydHkgYW5kIGEgaGlnaGxpZ2h0IHRvIHRoZSBOdW1iZXJEaXNwbGF5LiBTZWVcclxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NvbGxpc2lvbi1sYWIvaXNzdWVzLzk1LiBMaW5rIGlzIG5ldmVyIGRpc3Bvc2VkIHNpbmNlIEJhbGxWYWx1ZXNQYW5lbE51bWJlckRpc3BsYXlzXHJcbiAgICAgIC8vIGFyZSBuZXZlciBkaXNwb3NlZC5cclxuICAgICAgdXNlckNvbnRyb2xsZWRQcm9wZXJ0eS5saW5rKCB1c2VyQ29udHJvbGxlZCA9PiB7XHJcbiAgICAgICAgdGhpcy5iYWNrZ3JvdW5kRmlsbCA9IHVzZXJDb250cm9sbGVkID8gQ29sbGlzaW9uTGFiQ29sb3JzLkhJR0hMSUdIVEVEX05VTUJFUl9ESVNQTEFZX0ZJTEwgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmJhY2tncm91bmRGaWxsO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyBHZXQgdGhlIHVuaXQgZGlzcGxheWVkIHdoZW4gdGhlIHVzZXIgaXMgZWRpdGluZyB0aGUgQmFsbFByb3BlcnR5LlxyXG4gICAgICBjb25zdCB1bml0ID0gY29sdW1uVHlwZS5lZGl0Q29uZmlnLmVkaXRpbmdVbml0O1xyXG4gICAgICBjb25zdCBlZGl0VmFsdWUgPSB2YWx1ZSA9PiBjb2x1bW5UeXBlLmVkaXRDb25maWcuZWRpdFZhbHVlKCBiYWxsLCB2YWx1ZSApO1xyXG5cclxuICAgICAgLy8gT2JzZXJ2ZSB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIE51bWJlckRpc3BsYXkgYW5kIG9wZW4gdGhlIEtleXBhZERpYWxvZyB0byBhbGxvdyB0aGUgdXNlciB0byBlZGl0IHRoZVxyXG4gICAgICAvLyBiYWxsUHJvcGVydHkuIExpc3RlbmVyIGlzIG5ldmVyIHJlbW92ZWQgc2luY2UgQmFsbFZhbHVlc1BhbmVsTnVtYmVyRGlzcGxheXMgYXJlIG5ldmVyIGRpc3Bvc2VkLlxyXG4gICAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIG5ldyBGaXJlTGlzdGVuZXIoIHtcclxuICAgICAgICBmaXJlOiAoKSA9PiB7XHJcblxyXG4gICAgICAgICAgLy8gSW5kaWNhdGUgdGhhdCB0aGUgQmFsbFByb3BlcnR5IGlzIGN1cnJlbnRseSBiZWluZyB1c2VyIGNvbnRyb2xsZWQuXHJcbiAgICAgICAgICB1c2VyQ29udHJvbGxlZFByb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAvLyBHZXQgdGhlIGVkaXRpbmcgUmFuZ2Ugb2YgdGhlIEJhbGxQcm9wZXJ0eS4gTXVzdCBiZSByZWNvbXB1dGVkIGV2ZXJ5IHRpbWUgdGhlIEtleXBhZERpYWxvZyBpcyBvcGVuZWQuXHJcbiAgICAgICAgICBjb25zdCBlZGl0aW5nUmFuZ2UgPSBjb2x1bW5UeXBlLmVkaXRDb25maWcuZ2V0RWRpdGluZ1JhbmdlKCBiYWxsICk7XHJcblxyXG4gICAgICAgICAga2V5cGFkRGlhbG9nLmJlZ2luRWRpdCggZWRpdFZhbHVlLCBlZGl0aW5nUmFuZ2UsIG5ldyBQYXR0ZXJuU3RyaW5nUHJvcGVydHkoIENvbGxpc2lvbkxhYlN0cmluZ3MucGF0dGVybi5yYW5nZVN0cmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgICAgICAgIHVuaXRzOiB1bml0IHx8ICcnXHJcbiAgICAgICAgICB9ICksICgpID0+IHtcclxuXHJcbiAgICAgICAgICAgIC8vIFdoZW4gdGhlIHVzZXIgaXMgZmluaXNoZWQgZWRpdGluZyB0aGUgQmFsbFByb3BlcnR5LCBidW1wIHRoZSBCYWxsIGF3YXkgZnJvbSB0aGUgb3RoZXIgQmFsbHMgdGhhdCBpdCBpc1xyXG4gICAgICAgICAgICAvLyBvdmVybGFwcGluZyB3aXRoLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NvbGxpc2lvbi1sYWIvaXNzdWVzLzEwMC5cclxuICAgICAgICAgICAgYmFsbFN5c3RlbS5idW1wQmFsbEF3YXlGcm9tT3RoZXJzKCBiYWxsICk7XHJcblxyXG4gICAgICAgICAgICAvLyBOb3cgaW5kaWNhdGUgdGhhdCB0aGUgdXNlciBpcyBmaW5pc2hlZCBlZGl0aW5nIHRoaXMgQmFsbFByb3BlcnR5LlxyXG4gICAgICAgICAgICB1c2VyQ29udHJvbGxlZFByb3BlcnR5LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICB9ICk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBmaXJlT25Eb3duOiB0cnVlXHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuY29sbGlzaW9uTGFiLnJlZ2lzdGVyKCAnQmFsbFZhbHVlc1BhbmVsTnVtYmVyRGlzcGxheScsIEJhbGxWYWx1ZXNQYW5lbE51bWJlckRpc3BsYXkgKTtcclxuZXhwb3J0IGRlZmF1bHQgQmFsbFZhbHVlc1BhbmVsTnVtYmVyRGlzcGxheTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EscUJBQXFCLE1BQU0sOENBQThDO0FBQ2hGLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxLQUFLLE1BQU0sbUNBQW1DO0FBQ3JELE9BQU9DLFdBQVcsTUFBTSwrQ0FBK0M7QUFDdkUsT0FBT0MsYUFBYSxNQUFNLDhDQUE4QztBQUN4RSxTQUFTQyxLQUFLLEVBQUVDLFlBQVksUUFBUSxtQ0FBbUM7QUFDdkUsT0FBT0MsWUFBWSxNQUFNLHVCQUF1QjtBQUNo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