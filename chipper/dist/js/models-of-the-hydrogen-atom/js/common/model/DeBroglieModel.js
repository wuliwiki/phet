// Copyright 2019-2023, University of Colorado Boulder

/**
 * DeBroglieModel is a predictive model of the hydrogen atom.
 *
 * DeBroglieModel is identical to BohrModel, but has different visual representations. The different visual
 * representations (see DeBroglieView) mean that it requires different methods of handling collision detection
 * and determining electron position. The algorithms for collision detection and calculation of electron position
 * differ greatly for 2D and 3D views. Therefore, this model needs to know something about the view in order to
 * make things look right in 3D. So this model cannot be shown in both 2D and 3D views simultaneously. There are
 * undoubtedly ways to do this, but this simulation does not require multiple simultaneous views of the model.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import deBroglieButton_png from '../../../images/deBroglieButton_png.js';
import optionize from '../../../../phet-core/js/optionize.js';
import modelsOfTheHydrogenAtom from '../../modelsOfTheHydrogenAtom.js';
import ModelsOfTheHydrogenAtomStrings from '../../ModelsOfTheHydrogenAtomStrings.js';
import BohrModel from './BohrModel.js';
import StringUnionProperty from '../../../../axon/js/StringUnionProperty.js';
import Electron from './Electron.js';
import { DeBroglieViewValues } from './DeBroglieView.js';
export default class DeBroglieModel extends BohrModel {
  // How much to scale the y dimension for 3D orbits
  static ORBIT_3D_Y_SCALE = 0.35;

  // radial width of the ring for 'brightness' representation,
  static BRIGHTNESS_RING_THICKNESS = 3;

  // electron for the '3D' view

  constructor(zoomedInBox, providedOptions) {
    const options = optionize()({
      // DeBroglieModelOptions
      displayNameProperty: ModelsOfTheHydrogenAtomStrings.deBroglieStringProperty,
      iconHTMLImageElement: deBroglieButton_png
    }, providedOptions);
    super(zoomedInBox, options);
    this.electron3D = new Electron({
      //TODO position is not properly initialized
      tandem: options.tandem.createTandem('electron3D')
    });
    this.deBroglieViewProperty = new StringUnionProperty('radial', {
      validValues: DeBroglieViewValues,
      tandem: options.tandem.createTandem('deBroglieViewProperty')
    });
    this.electronOffsetProperty.link(electronOffset => {
      const xOffset = electronOffset.x;
      const yOffset = (electronOffset.y - this.position.y) * DeBroglieModel.ORBIT_3D_Y_SCALE;
      this.electron3D.positionProperty.value = this.position.plusXY(xOffset, yOffset);
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
  reset() {
    this.electron3D.reset();
    this.deBroglieViewProperty.reset();
    super.reset();
  }

  /**
   * Gets the amplitude [-1,1] of a standing wave at some angle, in some specified state of the electron.
   */
  getAmplitude(angle, state) {
    const amplitude = Math.sin(state * angle) * Math.sin(this.electronAngleProperty.value);
    assert && assert(amplitude >= -1 && amplitude <= 1);
    return amplitude;
  }

  //TODO normalize the return value to [0,2*Math.PI]
  /**
   * Calculates the new electron angle for some time step. For de Broglie, the change in angle (and thus
   * the oscillation frequency) is the same for all states of the electron.
   */
  calculateNewElectronAngle(dt) {
    const deltaAngle = dt * BohrModel.ELECTRON_ANGLE_DELTA;
    return this.electronAngleProperty.value - deltaAngle; //TODO clockwise
  }

  //--------------------------------------------------------------------------------------------------------------------
  // Collision Detection
  //--------------------------------------------------------------------------------------------------------------------

  /**
   * Determines whether a photon collides with this atom.
   * Uses different algorithms depending on whether the view is 2D or 3D.
   */
  collides(photon) {
    if (this.deBroglieViewProperty.value === '3D') {
      return this.collides3D(photon);
    } else {
      return this.collides2D(photon);
    }
  }

  /**
   * Determines whether a photon collides with this atom in the 3D view. In this case, the photon collides with
   * the atom if it hits the ellipse that is the 2D projection of the electron's 3D orbit.
   */
  collides3D(photon) {
    // position of photon relative to atom's center
    const photonOffset = this.getPhotonOffset(photon);
    const angle = Math.atan(photonOffset.y / photonOffset.x);

    // position on orbit at corresponding angle
    const orbitRadius = this.getElectronOrbitRadius(this.getElectronState());
    const orbitX = orbitRadius * Math.cos(angle);
    const orbitY = DeBroglieModel.ORBIT_3D_Y_SCALE * orbitRadius * Math.sin(angle);

    // distance from electron to the closest point on orbit
    const distance = photonOffset.distanceXY(orbitX, orbitY);

    // how close the photon's center must be to a point on the electron's orbit
    //TODO why is getClosenessForCollision used for '3D' when it's a function of BRIGHTNESS_RING_THICKNESS?
    const closeness = this.getClosenessForCollision(photon);
    return distance <= closeness;
  }

  /**
   * Determines whether a photon collides with this atom in one of the 2D views.
   * In all 2D views (including "radial distance"), the photon collides with
   * the atom if it hits the ring used to represent the standing wave in one
   * of the brightness views.
   */
  collides2D(photon) {
    // position of photon relative to atom's center
    const photonOffset = this.getPhotonOffset(photon);

    // distance of photon and electron from atom's center
    const photonRadius = Math.sqrt(photonOffset.x * photonOffset.x + photonOffset.y * photonOffset.y);
    const orbitRadius = this.getElectronOrbitRadius(this.getElectronState());

    //TODO why is getClosenessForCollision used for 'radial' when it's a function of BRIGHTNESS_RING_THICKNESS?
    return Math.abs(photonRadius - orbitRadius) <= this.getClosenessForCollision(photon);
  }

  /**
   * Gets the offset of a photon from the atom's position.
   */
  getPhotonOffset(photon) {
    return photon.positionProperty.value.minus(this.position);
  }

  //TODO why isn't this adjusted for '3D' view?
  /**
   * How close the photon's center must be to a point on the electron's orbit in order for a collision to occur.
   */
  getClosenessForCollision(photon) {
    return photon.radius + this.electron.radius + DeBroglieModel.BRIGHTNESS_RING_THICKNESS;
  }
}
modelsOfTheHydrogenAtom.register('DeBroglieModel', DeBroglieModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZUJyb2dsaWVCdXR0b25fcG5nIiwib3B0aW9uaXplIiwibW9kZWxzT2ZUaGVIeWRyb2dlbkF0b20iLCJNb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbVN0cmluZ3MiLCJCb2hyTW9kZWwiLCJTdHJpbmdVbmlvblByb3BlcnR5IiwiRWxlY3Ryb24iLCJEZUJyb2dsaWVWaWV3VmFsdWVzIiwiRGVCcm9nbGllTW9kZWwiLCJPUkJJVF8zRF9ZX1NDQUxFIiwiQlJJR0hUTkVTU19SSU5HX1RISUNLTkVTUyIsImNvbnN0cnVjdG9yIiwiem9vbWVkSW5Cb3giLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZGlzcGxheU5hbWVQcm9wZXJ0eSIsImRlQnJvZ2xpZVN0cmluZ1Byb3BlcnR5IiwiaWNvbkhUTUxJbWFnZUVsZW1lbnQiLCJlbGVjdHJvbjNEIiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwiZGVCcm9nbGllVmlld1Byb3BlcnR5IiwidmFsaWRWYWx1ZXMiLCJlbGVjdHJvbk9mZnNldFByb3BlcnR5IiwibGluayIsImVsZWN0cm9uT2Zmc2V0IiwieE9mZnNldCIsIngiLCJ5T2Zmc2V0IiwieSIsInBvc2l0aW9uIiwicG9zaXRpb25Qcm9wZXJ0eSIsInZhbHVlIiwicGx1c1hZIiwiZGlzcG9zZSIsImFzc2VydCIsInJlc2V0IiwiZ2V0QW1wbGl0dWRlIiwiYW5nbGUiLCJzdGF0ZSIsImFtcGxpdHVkZSIsIk1hdGgiLCJzaW4iLCJlbGVjdHJvbkFuZ2xlUHJvcGVydHkiLCJjYWxjdWxhdGVOZXdFbGVjdHJvbkFuZ2xlIiwiZHQiLCJkZWx0YUFuZ2xlIiwiRUxFQ1RST05fQU5HTEVfREVMVEEiLCJjb2xsaWRlcyIsInBob3RvbiIsImNvbGxpZGVzM0QiLCJjb2xsaWRlczJEIiwicGhvdG9uT2Zmc2V0IiwiZ2V0UGhvdG9uT2Zmc2V0IiwiYXRhbiIsIm9yYml0UmFkaXVzIiwiZ2V0RWxlY3Ryb25PcmJpdFJhZGl1cyIsImdldEVsZWN0cm9uU3RhdGUiLCJvcmJpdFgiLCJjb3MiLCJvcmJpdFkiLCJkaXN0YW5jZSIsImRpc3RhbmNlWFkiLCJjbG9zZW5lc3MiLCJnZXRDbG9zZW5lc3NGb3JDb2xsaXNpb24iLCJwaG90b25SYWRpdXMiLCJzcXJ0IiwiYWJzIiwibWludXMiLCJyYWRpdXMiLCJlbGVjdHJvbiIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRGVCcm9nbGllTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGVCcm9nbGllTW9kZWwgaXMgYSBwcmVkaWN0aXZlIG1vZGVsIG9mIHRoZSBoeWRyb2dlbiBhdG9tLlxyXG4gKlxyXG4gKiBEZUJyb2dsaWVNb2RlbCBpcyBpZGVudGljYWwgdG8gQm9ock1vZGVsLCBidXQgaGFzIGRpZmZlcmVudCB2aXN1YWwgcmVwcmVzZW50YXRpb25zLiBUaGUgZGlmZmVyZW50IHZpc3VhbFxyXG4gKiByZXByZXNlbnRhdGlvbnMgKHNlZSBEZUJyb2dsaWVWaWV3KSBtZWFuIHRoYXQgaXQgcmVxdWlyZXMgZGlmZmVyZW50IG1ldGhvZHMgb2YgaGFuZGxpbmcgY29sbGlzaW9uIGRldGVjdGlvblxyXG4gKiBhbmQgZGV0ZXJtaW5pbmcgZWxlY3Ryb24gcG9zaXRpb24uIFRoZSBhbGdvcml0aG1zIGZvciBjb2xsaXNpb24gZGV0ZWN0aW9uIGFuZCBjYWxjdWxhdGlvbiBvZiBlbGVjdHJvbiBwb3NpdGlvblxyXG4gKiBkaWZmZXIgZ3JlYXRseSBmb3IgMkQgYW5kIDNEIHZpZXdzLiBUaGVyZWZvcmUsIHRoaXMgbW9kZWwgbmVlZHMgdG8ga25vdyBzb21ldGhpbmcgYWJvdXQgdGhlIHZpZXcgaW4gb3JkZXIgdG9cclxuICogbWFrZSB0aGluZ3MgbG9vayByaWdodCBpbiAzRC4gU28gdGhpcyBtb2RlbCBjYW5ub3QgYmUgc2hvd24gaW4gYm90aCAyRCBhbmQgM0Qgdmlld3Mgc2ltdWx0YW5lb3VzbHkuIFRoZXJlIGFyZVxyXG4gKiB1bmRvdWJ0ZWRseSB3YXlzIHRvIGRvIHRoaXMsIGJ1dCB0aGlzIHNpbXVsYXRpb24gZG9lcyBub3QgcmVxdWlyZSBtdWx0aXBsZSBzaW11bHRhbmVvdXMgdmlld3Mgb2YgdGhlIG1vZGVsLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBkZUJyb2dsaWVCdXR0b25fcG5nIGZyb20gJy4uLy4uLy4uL2ltYWdlcy9kZUJyb2dsaWVCdXR0b25fcG5nLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBtb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbSBmcm9tICcuLi8uLi9tb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbS5qcyc7XHJcbmltcG9ydCBNb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbVN0cmluZ3MgZnJvbSAnLi4vLi4vTW9kZWxzT2ZUaGVIeWRyb2dlbkF0b21TdHJpbmdzLmpzJztcclxuaW1wb3J0IFpvb21lZEluQm94IGZyb20gJy4vWm9vbWVkSW5Cb3guanMnO1xyXG5pbXBvcnQgUGhvdG9uIGZyb20gJy4vUGhvdG9uLmpzJztcclxuaW1wb3J0IEJvaHJNb2RlbCwgeyBCb2hyTW9kZWxPcHRpb25zIH0gZnJvbSAnLi9Cb2hyTW9kZWwuanMnO1xyXG5pbXBvcnQgU3RyaW5nVW5pb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1N0cmluZ1VuaW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBFbGVjdHJvbiBmcm9tICcuL0VsZWN0cm9uLmpzJztcclxuaW1wb3J0IHsgRGVCcm9nbGllVmlldywgRGVCcm9nbGllVmlld1ZhbHVlcyB9IGZyb20gJy4vRGVCcm9nbGllVmlldy5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0gRW1wdHlTZWxmT3B0aW9ucztcclxuXHJcbmV4cG9ydCB0eXBlIERlQnJvZ2xpZU1vZGVsT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgQm9ock1vZGVsT3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERlQnJvZ2xpZU1vZGVsIGV4dGVuZHMgQm9ock1vZGVsIHtcclxuXHJcbiAgLy8gSG93IG11Y2ggdG8gc2NhbGUgdGhlIHkgZGltZW5zaW9uIGZvciAzRCBvcmJpdHNcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IE9SQklUXzNEX1lfU0NBTEUgPSAwLjM1O1xyXG5cclxuICAvLyByYWRpYWwgd2lkdGggb2YgdGhlIHJpbmcgZm9yICdicmlnaHRuZXNzJyByZXByZXNlbnRhdGlvbixcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEJSSUdIVE5FU1NfUklOR19USElDS05FU1MgPSAzO1xyXG5cclxuICAvLyBlbGVjdHJvbiBmb3IgdGhlICczRCcgdmlld1xyXG4gIHB1YmxpYyByZWFkb25seSBlbGVjdHJvbjNEOiBFbGVjdHJvbjtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGRlQnJvZ2xpZVZpZXdQcm9wZXJ0eTogU3RyaW5nVW5pb25Qcm9wZXJ0eTxEZUJyb2dsaWVWaWV3PjtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB6b29tZWRJbkJveDogWm9vbWVkSW5Cb3gsIHByb3ZpZGVkT3B0aW9uczogRGVCcm9nbGllTW9kZWxPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8RGVCcm9nbGllTW9kZWxPcHRpb25zLCBTZWxmT3B0aW9ucywgQm9ock1vZGVsT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gRGVCcm9nbGllTW9kZWxPcHRpb25zXHJcbiAgICAgIGRpc3BsYXlOYW1lUHJvcGVydHk6IE1vZGVsc09mVGhlSHlkcm9nZW5BdG9tU3RyaW5ncy5kZUJyb2dsaWVTdHJpbmdQcm9wZXJ0eSxcclxuICAgICAgaWNvbkhUTUxJbWFnZUVsZW1lbnQ6IGRlQnJvZ2xpZUJ1dHRvbl9wbmdcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCB6b29tZWRJbkJveCwgb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuZWxlY3Ryb24zRCA9IG5ldyBFbGVjdHJvbigge1xyXG4gICAgICAvL1RPRE8gcG9zaXRpb24gaXMgbm90IHByb3Blcmx5IGluaXRpYWxpemVkXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZWxlY3Ryb24zRCcgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuZGVCcm9nbGllVmlld1Byb3BlcnR5ID0gbmV3IFN0cmluZ1VuaW9uUHJvcGVydHkoICdyYWRpYWwnLCB7XHJcbiAgICAgIHZhbGlkVmFsdWVzOiBEZUJyb2dsaWVWaWV3VmFsdWVzLFxyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RlQnJvZ2xpZVZpZXdQcm9wZXJ0eScgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuZWxlY3Ryb25PZmZzZXRQcm9wZXJ0eS5saW5rKCBlbGVjdHJvbk9mZnNldCA9PiB7XHJcbiAgICAgIGNvbnN0IHhPZmZzZXQgPSBlbGVjdHJvbk9mZnNldC54O1xyXG4gICAgICBjb25zdCB5T2Zmc2V0ID0gKCAoIGVsZWN0cm9uT2Zmc2V0LnkgLSB0aGlzLnBvc2l0aW9uLnkgKSAqIERlQnJvZ2xpZU1vZGVsLk9SQklUXzNEX1lfU0NBTEUgKTtcclxuICAgICAgdGhpcy5lbGVjdHJvbjNELnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSB0aGlzLnBvc2l0aW9uLnBsdXNYWSggeE9mZnNldCwgeU9mZnNldCApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMuZWxlY3Ryb24zRC5yZXNldCgpO1xyXG4gICAgdGhpcy5kZUJyb2dsaWVWaWV3UHJvcGVydHkucmVzZXQoKTtcclxuICAgIHN1cGVyLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBhbXBsaXR1ZGUgWy0xLDFdIG9mIGEgc3RhbmRpbmcgd2F2ZSBhdCBzb21lIGFuZ2xlLCBpbiBzb21lIHNwZWNpZmllZCBzdGF0ZSBvZiB0aGUgZWxlY3Ryb24uXHJcbiAgICovXHJcbiAgcHVibGljIGdldEFtcGxpdHVkZSggYW5nbGU6IG51bWJlciwgc3RhdGU6IG51bWJlciApOiBudW1iZXIge1xyXG4gICAgY29uc3QgYW1wbGl0dWRlID0gTWF0aC5zaW4oIHN0YXRlICogYW5nbGUgKSAqIE1hdGguc2luKCB0aGlzLmVsZWN0cm9uQW5nbGVQcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggYW1wbGl0dWRlID49IC0xICYmIGFtcGxpdHVkZSA8PSAxICk7XHJcbiAgICByZXR1cm4gYW1wbGl0dWRlO1xyXG4gIH1cclxuXHJcbiAgLy9UT0RPIG5vcm1hbGl6ZSB0aGUgcmV0dXJuIHZhbHVlIHRvIFswLDIqTWF0aC5QSV1cclxuICAvKipcclxuICAgKiBDYWxjdWxhdGVzIHRoZSBuZXcgZWxlY3Ryb24gYW5nbGUgZm9yIHNvbWUgdGltZSBzdGVwLiBGb3IgZGUgQnJvZ2xpZSwgdGhlIGNoYW5nZSBpbiBhbmdsZSAoYW5kIHRodXNcclxuICAgKiB0aGUgb3NjaWxsYXRpb24gZnJlcXVlbmN5KSBpcyB0aGUgc2FtZSBmb3IgYWxsIHN0YXRlcyBvZiB0aGUgZWxlY3Ryb24uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIG92ZXJyaWRlIGNhbGN1bGF0ZU5ld0VsZWN0cm9uQW5nbGUoIGR0OiBudW1iZXIgKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IGRlbHRhQW5nbGUgPSBkdCAqIEJvaHJNb2RlbC5FTEVDVFJPTl9BTkdMRV9ERUxUQTtcclxuICAgIHJldHVybiB0aGlzLmVsZWN0cm9uQW5nbGVQcm9wZXJ0eS52YWx1ZSAtIGRlbHRhQW5nbGU7IC8vVE9ETyBjbG9ja3dpc2VcclxuICB9XHJcblxyXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAvLyBDb2xsaXNpb24gRGV0ZWN0aW9uXHJcbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuICAvKipcclxuICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYSBwaG90b24gY29sbGlkZXMgd2l0aCB0aGlzIGF0b20uXHJcbiAgICogVXNlcyBkaWZmZXJlbnQgYWxnb3JpdGhtcyBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgdmlldyBpcyAyRCBvciAzRC5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgb3ZlcnJpZGUgY29sbGlkZXMoIHBob3RvbjogUGhvdG9uICk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKCB0aGlzLmRlQnJvZ2xpZVZpZXdQcm9wZXJ0eS52YWx1ZSA9PT0gJzNEJyApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY29sbGlkZXMzRCggcGhvdG9uICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY29sbGlkZXMyRCggcGhvdG9uICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYSBwaG90b24gY29sbGlkZXMgd2l0aCB0aGlzIGF0b20gaW4gdGhlIDNEIHZpZXcuIEluIHRoaXMgY2FzZSwgdGhlIHBob3RvbiBjb2xsaWRlcyB3aXRoXHJcbiAgICogdGhlIGF0b20gaWYgaXQgaGl0cyB0aGUgZWxsaXBzZSB0aGF0IGlzIHRoZSAyRCBwcm9qZWN0aW9uIG9mIHRoZSBlbGVjdHJvbidzIDNEIG9yYml0LlxyXG4gICAqL1xyXG4gIHByaXZhdGUgY29sbGlkZXMzRCggcGhvdG9uOiBQaG90b24gKTogYm9vbGVhbiB7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gb2YgcGhvdG9uIHJlbGF0aXZlIHRvIGF0b20ncyBjZW50ZXJcclxuICAgIGNvbnN0IHBob3Rvbk9mZnNldCA9IHRoaXMuZ2V0UGhvdG9uT2Zmc2V0KCBwaG90b24gKTtcclxuICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuKCBwaG90b25PZmZzZXQueSAvIHBob3Rvbk9mZnNldC54ICk7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gb24gb3JiaXQgYXQgY29ycmVzcG9uZGluZyBhbmdsZVxyXG4gICAgY29uc3Qgb3JiaXRSYWRpdXMgPSB0aGlzLmdldEVsZWN0cm9uT3JiaXRSYWRpdXMoIHRoaXMuZ2V0RWxlY3Ryb25TdGF0ZSgpICk7XHJcbiAgICBjb25zdCBvcmJpdFggPSBvcmJpdFJhZGl1cyAqIE1hdGguY29zKCBhbmdsZSApO1xyXG4gICAgY29uc3Qgb3JiaXRZID0gRGVCcm9nbGllTW9kZWwuT1JCSVRfM0RfWV9TQ0FMRSAqIG9yYml0UmFkaXVzICogTWF0aC5zaW4oIGFuZ2xlICk7XHJcblxyXG4gICAgLy8gZGlzdGFuY2UgZnJvbSBlbGVjdHJvbiB0byB0aGUgY2xvc2VzdCBwb2ludCBvbiBvcmJpdFxyXG4gICAgY29uc3QgZGlzdGFuY2UgPSBwaG90b25PZmZzZXQuZGlzdGFuY2VYWSggb3JiaXRYLCBvcmJpdFkgKTtcclxuXHJcbiAgICAvLyBob3cgY2xvc2UgdGhlIHBob3RvbidzIGNlbnRlciBtdXN0IGJlIHRvIGEgcG9pbnQgb24gdGhlIGVsZWN0cm9uJ3Mgb3JiaXRcclxuICAgIC8vVE9ETyB3aHkgaXMgZ2V0Q2xvc2VuZXNzRm9yQ29sbGlzaW9uIHVzZWQgZm9yICczRCcgd2hlbiBpdCdzIGEgZnVuY3Rpb24gb2YgQlJJR0hUTkVTU19SSU5HX1RISUNLTkVTUz9cclxuICAgIGNvbnN0IGNsb3NlbmVzcyA9IHRoaXMuZ2V0Q2xvc2VuZXNzRm9yQ29sbGlzaW9uKCBwaG90b24gKTtcclxuXHJcbiAgICByZXR1cm4gKCBkaXN0YW5jZSA8PSBjbG9zZW5lc3MgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERldGVybWluZXMgd2hldGhlciBhIHBob3RvbiBjb2xsaWRlcyB3aXRoIHRoaXMgYXRvbSBpbiBvbmUgb2YgdGhlIDJEIHZpZXdzLlxyXG4gICAqIEluIGFsbCAyRCB2aWV3cyAoaW5jbHVkaW5nIFwicmFkaWFsIGRpc3RhbmNlXCIpLCB0aGUgcGhvdG9uIGNvbGxpZGVzIHdpdGhcclxuICAgKiB0aGUgYXRvbSBpZiBpdCBoaXRzIHRoZSByaW5nIHVzZWQgdG8gcmVwcmVzZW50IHRoZSBzdGFuZGluZyB3YXZlIGluIG9uZVxyXG4gICAqIG9mIHRoZSBicmlnaHRuZXNzIHZpZXdzLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgY29sbGlkZXMyRCggcGhvdG9uOiBQaG90b24gKTogYm9vbGVhbiB7XHJcblxyXG4gICAgLy8gcG9zaXRpb24gb2YgcGhvdG9uIHJlbGF0aXZlIHRvIGF0b20ncyBjZW50ZXJcclxuICAgIGNvbnN0IHBob3Rvbk9mZnNldCA9IHRoaXMuZ2V0UGhvdG9uT2Zmc2V0KCBwaG90b24gKTtcclxuXHJcbiAgICAvLyBkaXN0YW5jZSBvZiBwaG90b24gYW5kIGVsZWN0cm9uIGZyb20gYXRvbSdzIGNlbnRlclxyXG4gICAgY29uc3QgcGhvdG9uUmFkaXVzID0gTWF0aC5zcXJ0KCAoIHBob3Rvbk9mZnNldC54ICogcGhvdG9uT2Zmc2V0LnggKSArICggcGhvdG9uT2Zmc2V0LnkgKiBwaG90b25PZmZzZXQueSApICk7XHJcbiAgICBjb25zdCBvcmJpdFJhZGl1cyA9IHRoaXMuZ2V0RWxlY3Ryb25PcmJpdFJhZGl1cyggdGhpcy5nZXRFbGVjdHJvblN0YXRlKCkgKTtcclxuXHJcbiAgICAvL1RPRE8gd2h5IGlzIGdldENsb3NlbmVzc0ZvckNvbGxpc2lvbiB1c2VkIGZvciAncmFkaWFsJyB3aGVuIGl0J3MgYSBmdW5jdGlvbiBvZiBCUklHSFRORVNTX1JJTkdfVEhJQ0tORVNTP1xyXG4gICAgcmV0dXJuICggTWF0aC5hYnMoIHBob3RvblJhZGl1cyAtIG9yYml0UmFkaXVzICkgPD0gdGhpcy5nZXRDbG9zZW5lc3NGb3JDb2xsaXNpb24oIHBob3RvbiApICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBvZmZzZXQgb2YgYSBwaG90b24gZnJvbSB0aGUgYXRvbSdzIHBvc2l0aW9uLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UGhvdG9uT2Zmc2V0KCBwaG90b246IFBob3RvbiApOiBWZWN0b3IyIHtcclxuICAgIHJldHVybiBwaG90b24ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS5taW51cyggdGhpcy5wb3NpdGlvbiApO1xyXG4gIH1cclxuXHJcbiAgLy9UT0RPIHdoeSBpc24ndCB0aGlzIGFkanVzdGVkIGZvciAnM0QnIHZpZXc/XHJcbiAgLyoqXHJcbiAgICogSG93IGNsb3NlIHRoZSBwaG90b24ncyBjZW50ZXIgbXVzdCBiZSB0byBhIHBvaW50IG9uIHRoZSBlbGVjdHJvbidzIG9yYml0IGluIG9yZGVyIGZvciBhIGNvbGxpc2lvbiB0byBvY2N1ci5cclxuICAgKi9cclxuICBwcml2YXRlIGdldENsb3NlbmVzc0ZvckNvbGxpc2lvbiggcGhvdG9uOiBQaG90b24gKTogbnVtYmVyIHtcclxuICAgIHJldHVybiAoIHBob3Rvbi5yYWRpdXMgKyB0aGlzLmVsZWN0cm9uLnJhZGl1cyArIERlQnJvZ2xpZU1vZGVsLkJSSUdIVE5FU1NfUklOR19USElDS05FU1MgKTtcclxuICB9XHJcbn1cclxuXHJcbm1vZGVsc09mVGhlSHlkcm9nZW5BdG9tLnJlZ2lzdGVyKCAnRGVCcm9nbGllTW9kZWwnLCBEZUJyb2dsaWVNb2RlbCApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLG1CQUFtQixNQUFNLHdDQUF3QztBQUN4RSxPQUFPQyxTQUFTLE1BQTRCLHVDQUF1QztBQUNuRixPQUFPQyx1QkFBdUIsTUFBTSxrQ0FBa0M7QUFDdEUsT0FBT0MsOEJBQThCLE1BQU0seUNBQXlDO0FBR3BGLE9BQU9DLFNBQVMsTUFBNEIsZ0JBQWdCO0FBQzVELE9BQU9DLG1CQUFtQixNQUFNLDRDQUE0QztBQUU1RSxPQUFPQyxRQUFRLE1BQU0sZUFBZTtBQUNwQyxTQUF3QkMsbUJBQW1CLFFBQVEsb0JBQW9CO0FBTXZFLGVBQWUsTUFBTUMsY0FBYyxTQUFTSixTQUFTLENBQUM7RUFFcEQ7RUFDQSxPQUF1QkssZ0JBQWdCLEdBQUcsSUFBSTs7RUFFOUM7RUFDQSxPQUF1QkMseUJBQXlCLEdBQUcsQ0FBQzs7RUFFcEQ7O0VBS09DLFdBQVdBLENBQUVDLFdBQXdCLEVBQUVDLGVBQXNDLEVBQUc7SUFFckYsTUFBTUMsT0FBTyxHQUFHYixTQUFTLENBQXVELENBQUMsQ0FBRTtNQUVqRjtNQUNBYyxtQkFBbUIsRUFBRVosOEJBQThCLENBQUNhLHVCQUF1QjtNQUMzRUMsb0JBQW9CLEVBQUVqQjtJQUN4QixDQUFDLEVBQUVhLGVBQWdCLENBQUM7SUFFcEIsS0FBSyxDQUFFRCxXQUFXLEVBQUVFLE9BQVEsQ0FBQztJQUU3QixJQUFJLENBQUNJLFVBQVUsR0FBRyxJQUFJWixRQUFRLENBQUU7TUFDOUI7TUFDQWEsTUFBTSxFQUFFTCxPQUFPLENBQUNLLE1BQU0sQ0FBQ0MsWUFBWSxD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