// Copyright 2022, University of Colorado Boulder

/**
 * DeBroglie3DNode show the '3D' view for the de Broglie model.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Multilink from '../../../../axon/js/Multilink.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Utils from '../../../../dot/js/Utils.js';
import Vector3 from '../../../../dot/js/Vector3.js';
import optionize from '../../../../phet-core/js/optionize.js';
import { Node } from '../../../../scenery/js/imports.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';
import modelsOfTheHydrogenAtom from '../../modelsOfTheHydrogenAtom.js';
import DeBroglieModel from '../model/DeBroglieModel.js';
import MOTHAColors from '../MOTHAColors.js';
import WireframeMatrix from './WireframeMatrix.js';
import WireframeModel from './WireframeModel.js';
import WireframeNode from './WireframeNode.js';
import MOTHAConstants from '../MOTHAConstants.js';
const MAX_WAVE_HEIGHT = 15; // max height of the standing wave, in view coordinates
const NUMBER_OF_ORBIT_VERTICES = 200;
const NUMBER_OF_WAVE_VERTICES = 200;

// The final view angle (rotation about the x-axis), after the model has rotated into place.
// If you change this value, you must also change DeBroglieModel.ORBIT_3D_Y_SCALE !! TODO why?
const FINAL_VIEW_ANGLE = Utils.toRadians(70);

// change is angle during view animation
const VIEW_ANGLE_DELTA = Utils.toRadians(5);
export default class DeBroglie3DNode extends Node {
  //TODO viewMatrix needs to be a Property to save state, switch to Property<Matrix3>
  // matrix used to set the view angle
  //TODO can we get this from viewMatrix?
  // the current view angle
  // reusable vertices for orbits
  // reusable vertices for wave
  //TODO does this have PhET-iO state?
  //TODO does this have PhET-iO state?
  constructor(hydrogenAtom, modelViewTransform, providedOptions) {
    const options = optionize()({
      // NodeOptions
      visibleProperty: new DerivedProperty([hydrogenAtom.deBroglieViewProperty], deBroglieView => deBroglieView === '3D', {
        tandem: providedOptions.tandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      })
    }, providedOptions);
    super(options);
    this.hydrogenAtom = hydrogenAtom;
    this.modelViewTransform = modelViewTransform;
    this.viewMatrix = new WireframeMatrix();

    //TODO needs to be reset
    this.currentViewAngleProperty = new NumberProperty(0, {
      tandem: options.tandem.createTandem('currentViewAngleProperty')
    });
    this.orbitVertices = [];
    for (let i = 0; i < NUMBER_OF_ORBIT_VERTICES; i++) {
      this.orbitVertices.push(new Vector3(0, 0, 0));
    }
    this.waveVertices = [];
    for (let i = 0; i < NUMBER_OF_WAVE_VERTICES; i++) {
      this.waveVertices.push(new Vector3(0, 0, 0));
    }
    this.orbitFrontColorProperty = MOTHAColors.orbitStrokeProperty;
    this.orbitBackColorProperty = new DerivedProperty([this.orbitFrontColorProperty], orbitFrontColor => orbitFrontColor.darkerColor().darkerColor().darkerColor());
    this.waveFrontColorProperty = MOTHAColors.electronBaseColorProperty;
    this.waveBackColorProperty = new DerivedProperty([this.waveFrontColorProperty], waveFrontColor => waveFrontColor.darkerColor().darkerColor().darkerColor());

    // 3D orbits
    const orbitNodes = [];
    const groundState = MOTHAConstants.GROUND_STATE;
    const maxState = DeBroglieModel.getMaxElectronState();
    for (let state = groundState; state < maxState; state++) {
      const radius = modelViewTransform.modelToViewDeltaX(hydrogenAtom.getElectronOrbitRadius(state));
      const orbitNode = this.createOrbitNode(radius, this.viewMatrix, this.orbitVertices);
      orbitNodes.push(orbitNode);
    }
    const orbitsNode = new Node({
      children: orbitNodes,
      tandem: options.tandem.createTandem('orbitsNode')
    });
    this.addChild(orbitsNode);
    this.waveModel = new WireframeModel({
      frontColor: this.waveFrontColorProperty,
      backColor: this.waveBackColorProperty,
      lineWidth: 2
    });
    this.waveNode = new WireframeNode(this.waveModel, {
      tandem: options.tandem.createTandem('waveNode')
    });

    //TODO are these dependencies correct?
    Multilink.multilink([hydrogenAtom.getElectronStateProperty(), hydrogenAtom.electronAngleProperty, this.visibleProperty], (electronState, electronAngle, visible) => {
      visible && this.update();
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
  step(dt) {
    //TODO implement or delete step
  }
  update() {
    this.updateWaveNode();
    if (this.currentViewAngleProperty.value === FINAL_VIEW_ANGLE) {
      this.updateViewMatrix();
    }
  }

  /**
   * Updates the wave.
   */
  updateWaveNode() {
    // Update the vertices
    this.waveVertices = updateWaveVertices(this.hydrogenAtom, this.modelViewTransform, this.waveVertices);

    // Create the wireframe model
    this.waveModel.reset();
    this.waveModel.addVertices(this.waveVertices);
    for (let i = 0; i < this.waveVertices.length - 1; i++) {
      this.waveModel.addLine(i, i + 1);
    }
    this.waveModel.addLine(this.waveVertices.length - 1, 0); // close the path

    // Transform the model
    const matrix = this.waveModel.getMatrix();
    matrix.unit();
    const xt = -(this.waveModel.getXMin() + this.waveModel.getXMax()) / 2;
    const yt = -(this.waveModel.getYMin() + this.waveModel.getYMax()) / 2;
    const zt = -(this.waveModel.getZMin() + this.waveModel.getZMax()) / 2;
    matrix.translate(xt, yt, zt);
    matrix.multiply(this.viewMatrix);
    this.waveModel.setMatrix(matrix);

    //TODO how does this.waveNode get notified to update?
  }

  /*
   * Updates the view matrix until the view is rotated into place.
   */
  updateViewMatrix() {
    if (this.currentViewAngleProperty.value !== FINAL_VIEW_ANGLE) {
      this.currentViewAngleProperty.value = Math.min(FINAL_VIEW_ANGLE, this.currentViewAngleProperty.value + VIEW_ANGLE_DELTA);
      this.viewMatrix.unit();
      this.viewMatrix.rotateX(this.currentViewAngleProperty.value);

      //TODO what needs to be notified that the.viewMatrix has changed?
    }
  }

  //TODO convert this to: class OrbitNode extends WireframeNode
  /**
   * Creates a Node for an electron orbit.
   */
  createOrbitNode(radius, viewMatrix, vertices) {
    // Update the vertices
    vertices = updateOrbitVertices(radius, vertices);

    // Create the wireframe model
    const wireframeModel = new WireframeModel({
      vertices: vertices,
      frontColor: this.orbitFrontColorProperty,
      backColor: this.orbitBackColorProperty,
      lineWidth: 2
    });

    // Connect every-other pair of vertices to simulate a dashed line.
    for (let i = 0; i < vertices.length - 1; i += 2) {
      wireframeModel.addLine(i, i + 1);
    }

    // Transform the model
    const matrix = wireframeModel.getMatrix();
    matrix.unit();
    const xt = -(wireframeModel.getXMin() + wireframeModel.getXMax()) / 2;
    const yt = -(wireframeModel.getYMin() + wireframeModel.getYMax()) / 2;
    const zt = -(wireframeModel.getZMin() + wireframeModel.getZMax()) / 2;
    matrix.translate(xt, yt, zt);
    matrix.multiply(viewMatrix);
    wireframeModel.setMatrix(matrix);
    return new WireframeNode(wireframeModel);
  }
}

/**
 * Updates the vertices that approximate an electron orbit.
 */
function updateOrbitVertices(orbitRadius, vertices) {
  const numberOfVertices = vertices.length;
  const deltaAngle = 2 * Math.PI / numberOfVertices;
  for (let i = 0; i < numberOfVertices; i++) {
    const angle = i * deltaAngle;
    const x = orbitRadius * Math.cos(angle);
    const y = orbitRadius * Math.sin(angle);
    const z = 0;
    vertices[i].setXYZ(x, y, z);
  }
  return vertices;
}

/**
 * Updates the vertices that approximate the standing wave.
 */
function updateWaveVertices(hydrogenAtom, modelViewTransform, vertices) {
  const electronState = hydrogenAtom.getElectronState();
  const radius = modelViewTransform.modelToViewDeltaX(hydrogenAtom.getElectronOrbitRadius(electronState));
  const numberOfVertices = vertices.length;
  const deltaAngle = 2 * Math.PI / numberOfVertices;
  for (let i = 0; i < numberOfVertices; i++) {
    const angle = i * deltaAngle;
    const x = radius * Math.cos(angle);
    const y = radius * Math.sin(angle);
    const z = MAX_WAVE_HEIGHT * hydrogenAtom.getAmplitude(angle, electronState);
    vertices[i].setXYZ(x, y, z);
  }
  return vertices;
}
modelsOfTheHydrogenAtom.register('DeBroglie3DNode', DeBroglie3DNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJNdWx0aWxpbmsiLCJOdW1iZXJQcm9wZXJ0eSIsIlV0aWxzIiwiVmVjdG9yMyIsIm9wdGlvbml6ZSIsIk5vZGUiLCJCb29sZWFuSU8iLCJtb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbSIsIkRlQnJvZ2xpZU1vZGVsIiwiTU9USEFDb2xvcnMiLCJXaXJlZnJhbWVNYXRyaXgiLCJXaXJlZnJhbWVNb2RlbCIsIldpcmVmcmFtZU5vZGUiLCJNT1RIQUNvbnN0YW50cyIsIk1BWF9XQVZFX0hFSUdIVCIsIk5VTUJFUl9PRl9PUkJJVF9WRVJUSUNFUyIsIk5VTUJFUl9PRl9XQVZFX1ZFUlRJQ0VTIiwiRklOQUxfVklFV19BTkdMRSIsInRvUmFkaWFucyIsIlZJRVdfQU5HTEVfREVMVEEiLCJEZUJyb2dsaWUzRE5vZGUiLCJjb25zdHJ1Y3RvciIsImh5ZHJvZ2VuQXRvbSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJ2aXNpYmxlUHJvcGVydHkiLCJkZUJyb2dsaWVWaWV3UHJvcGVydHkiLCJkZUJyb2dsaWVWaWV3IiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwicGhldGlvVmFsdWVUeXBlIiwidmlld01hdHJpeCIsImN1cnJlbnRWaWV3QW5nbGVQcm9wZXJ0eSIsIm9yYml0VmVydGljZXMiLCJpIiwicHVzaCIsIndhdmVWZXJ0aWNlcyIsIm9yYml0RnJvbnRDb2xvclByb3BlcnR5Iiwib3JiaXRTdHJva2VQcm9wZXJ0eSIsIm9yYml0QmFja0NvbG9yUHJvcGVydHkiLCJvcmJpdEZyb250Q29sb3IiLCJkYXJrZXJDb2xvciIsIndhdmVGcm9udENvbG9yUHJvcGVydHkiLCJlbGVjdHJvbkJhc2VDb2xvclByb3BlcnR5Iiwid2F2ZUJhY2tDb2xvclByb3BlcnR5Iiwid2F2ZUZyb250Q29sb3IiLCJvcmJpdE5vZGVzIiwiZ3JvdW5kU3RhdGUiLCJHUk9VTkRfU1RBVEUiLCJtYXhTdGF0ZSIsImdldE1heEVsZWN0cm9uU3RhdGUiLCJzdGF0ZSIsInJhZGl1cyIsIm1vZGVsVG9WaWV3RGVsdGFYIiwiZ2V0RWxlY3Ryb25PcmJpdFJhZGl1cyIsIm9yYml0Tm9kZSIsImNyZWF0ZU9yYml0Tm9kZSIsIm9yYml0c05vZGUiLCJjaGlsZHJlbiIsImFkZENoaWxkIiwid2F2ZU1vZGVsIiwiZnJvbnRDb2xvciIsImJhY2tDb2xvciIsImxpbmVXaWR0aCIsIndhdmVOb2RlIiwibXVsdGlsaW5rIiwiZ2V0RWxlY3Ryb25TdGF0ZVByb3BlcnR5IiwiZWxlY3Ryb25BbmdsZVByb3BlcnR5IiwiZWxlY3Ryb25TdGF0ZSIsImVsZWN0cm9uQW5nbGUiLCJ2aXNpYmxlIiwidXBkYXRlIiwiZGlzcG9zZSIsImFzc2VydCIsInN0ZXAiLCJkdCIsInVwZGF0ZVdhdmVOb2RlIiwidmFsdWUiLCJ1cGRhdGVWaWV3TWF0cml4IiwidXBkYXRlV2F2ZVZlcnRpY2VzIiwicmVzZXQiLCJhZGRWZXJ0aWNlcyIsImxlbmd0aCIsImFkZExpbmUiLCJtYXRyaXgiLCJnZXRNYXRyaXgiLCJ1bml0IiwieHQiLCJnZXRYTWluIiwiZ2V0WE1heCIsInl0IiwiZ2V0WU1pbiIsImdldFlNYXgiLCJ6dCIsImdldFpNaW4iLCJnZXRaTWF4IiwidHJhbnNsYXRlIiwibXVsdGlwbHkiLCJzZXRNYXRyaXgiLCJNYXRoIiwibWluIiwicm90YXRlWCIsInZlcnRpY2VzIiwidXBkYXRlT3JiaXRWZXJ0aWNlcyIsIndpcmVmcmFtZU1vZGVsIiwib3JiaXRSYWRpdXMiLCJudW1iZXJPZlZlcnRpY2VzIiwiZGVsdGFBbmdsZSIsIlBJIiwiYW5nbGUiLCJ4IiwiY29zIiwieSIsInNpbiIsInoiLCJzZXRYWVoiLCJnZXRFbGVjdHJvblN0YXRlIiwiZ2V0QW1wbGl0dWRlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJEZUJyb2dsaWUzRE5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIERlQnJvZ2xpZTNETm9kZSBzaG93IHRoZSAnM0QnIHZpZXcgZm9yIHRoZSBkZSBCcm9nbGllIG1vZGVsLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBWZWN0b3IzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcbmltcG9ydCBNb2RlbFZpZXdUcmFuc2Zvcm0yIGZyb20gJy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdmlldy9Nb2RlbFZpZXdUcmFuc2Zvcm0yLmpzJztcclxuaW1wb3J0IHsgQ29sb3IsIE5vZGUsIE5vZGVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IEJvb2xlYW5JTyBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvQm9vbGVhbklPLmpzJztcclxuaW1wb3J0IG1vZGVsc09mVGhlSHlkcm9nZW5BdG9tIGZyb20gJy4uLy4uL21vZGVsc09mVGhlSHlkcm9nZW5BdG9tLmpzJztcclxuaW1wb3J0IERlQnJvZ2xpZU1vZGVsIGZyb20gJy4uL21vZGVsL0RlQnJvZ2xpZU1vZGVsLmpzJztcclxuaW1wb3J0IE1PVEhBQ29sb3JzIGZyb20gJy4uL01PVEhBQ29sb3JzLmpzJztcclxuaW1wb3J0IFdpcmVmcmFtZU1hdHJpeCBmcm9tICcuL1dpcmVmcmFtZU1hdHJpeC5qcyc7XHJcbmltcG9ydCBXaXJlZnJhbWVNb2RlbCBmcm9tICcuL1dpcmVmcmFtZU1vZGVsLmpzJztcclxuaW1wb3J0IFdpcmVmcmFtZU5vZGUgZnJvbSAnLi9XaXJlZnJhbWVOb2RlLmpzJztcclxuaW1wb3J0IE1PVEhBQ29uc3RhbnRzIGZyb20gJy4uL01PVEhBQ29uc3RhbnRzLmpzJztcclxuXHJcbmNvbnN0IE1BWF9XQVZFX0hFSUdIVCA9IDE1OyAvLyBtYXggaGVpZ2h0IG9mIHRoZSBzdGFuZGluZyB3YXZlLCBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbmNvbnN0IE5VTUJFUl9PRl9PUkJJVF9WRVJUSUNFUyA9IDIwMDtcclxuY29uc3QgTlVNQkVSX09GX1dBVkVfVkVSVElDRVMgPSAyMDA7XHJcblxyXG4vLyBUaGUgZmluYWwgdmlldyBhbmdsZSAocm90YXRpb24gYWJvdXQgdGhlIHgtYXhpcyksIGFmdGVyIHRoZSBtb2RlbCBoYXMgcm90YXRlZCBpbnRvIHBsYWNlLlxyXG4vLyBJZiB5b3UgY2hhbmdlIHRoaXMgdmFsdWUsIHlvdSBtdXN0IGFsc28gY2hhbmdlIERlQnJvZ2xpZU1vZGVsLk9SQklUXzNEX1lfU0NBTEUgISEgVE9ETyB3aHk/XHJcbmNvbnN0IEZJTkFMX1ZJRVdfQU5HTEUgPSBVdGlscy50b1JhZGlhbnMoIDcwICk7XHJcblxyXG4vLyBjaGFuZ2UgaXMgYW5nbGUgZHVyaW5nIHZpZXcgYW5pbWF0aW9uXHJcbmNvbnN0IFZJRVdfQU5HTEVfREVMVEEgPSBVdGlscy50b1JhZGlhbnMoIDUgKTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSBFbXB0eVNlbGZPcHRpb25zO1xyXG5cclxudHlwZSBEZUJyb2dsaWUzRE5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaWNrUmVxdWlyZWQ8Tm9kZU9wdGlvbnMsICd0YW5kZW0nPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERlQnJvZ2xpZTNETm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGh5ZHJvZ2VuQXRvbTogRGVCcm9nbGllTW9kZWw7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTI7XHJcblxyXG4gIC8vVE9ETyB2aWV3TWF0cml4IG5lZWRzIHRvIGJlIGEgUHJvcGVydHkgdG8gc2F2ZSBzdGF0ZSwgc3dpdGNoIHRvIFByb3BlcnR5PE1hdHJpeDM+XHJcbiAgcHJpdmF0ZSByZWFkb25seSB2aWV3TWF0cml4OiBXaXJlZnJhbWVNYXRyaXg7IC8vIG1hdHJpeCB1c2VkIHRvIHNldCB0aGUgdmlldyBhbmdsZVxyXG5cclxuICAvL1RPRE8gY2FuIHdlIGdldCB0aGlzIGZyb20gdmlld01hdHJpeD9cclxuICBwcml2YXRlIGN1cnJlbnRWaWV3QW5nbGVQcm9wZXJ0eTogUHJvcGVydHk8bnVtYmVyPjsgLy8gdGhlIGN1cnJlbnQgdmlldyBhbmdsZVxyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IG9yYml0VmVydGljZXM6IFZlY3RvcjNbXTsgLy8gcmV1c2FibGUgdmVydGljZXMgZm9yIG9yYml0c1xyXG4gIHByaXZhdGUgd2F2ZVZlcnRpY2VzOiBWZWN0b3IzW107IC8vIHJldXNhYmxlIHZlcnRpY2VzIGZvciB3YXZlXHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgb3JiaXRGcm9udENvbG9yUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PENvbG9yPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IG9yYml0QmFja0NvbG9yUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PENvbG9yPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHdhdmVGcm9udENvbG9yUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PENvbG9yPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHdhdmVCYWNrQ29sb3JQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Q29sb3I+O1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHdhdmVNb2RlbDogV2lyZWZyYW1lTW9kZWw7IC8vVE9ETyBkb2VzIHRoaXMgaGF2ZSBQaEVULWlPIHN0YXRlP1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgd2F2ZU5vZGU6IFdpcmVmcmFtZU5vZGU7IC8vVE9ETyBkb2VzIHRoaXMgaGF2ZSBQaEVULWlPIHN0YXRlP1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGh5ZHJvZ2VuQXRvbTogRGVCcm9nbGllTW9kZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IERlQnJvZ2xpZTNETm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxEZUJyb2dsaWUzRE5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIE5vZGVPcHRpb25zXHJcbiAgICAgIHZpc2libGVQcm9wZXJ0eTogbmV3IERlcml2ZWRQcm9wZXJ0eSggWyBoeWRyb2dlbkF0b20uZGVCcm9nbGllVmlld1Byb3BlcnR5IF0sXHJcbiAgICAgICAgZGVCcm9nbGllVmlldyA9PiAoIGRlQnJvZ2xpZVZpZXcgPT09ICczRCcgKSwge1xyXG4gICAgICAgICAgdGFuZGVtOiBwcm92aWRlZE9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3Zpc2libGVQcm9wZXJ0eScgKSxcclxuICAgICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgICAgfSApXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuaHlkcm9nZW5BdG9tID0gaHlkcm9nZW5BdG9tO1xyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBtb2RlbFZpZXdUcmFuc2Zvcm07XHJcblxyXG4gICAgdGhpcy52aWV3TWF0cml4ID0gbmV3IFdpcmVmcmFtZU1hdHJpeCgpO1xyXG5cclxuICAgIC8vVE9ETyBuZWVkcyB0byBiZSByZXNldFxyXG4gICAgdGhpcy5jdXJyZW50Vmlld0FuZ2xlUHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIDAsIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdjdXJyZW50Vmlld0FuZ2xlUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm9yYml0VmVydGljZXMgPSBbXTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IE5VTUJFUl9PRl9PUkJJVF9WRVJUSUNFUzsgaSsrICkge1xyXG4gICAgICB0aGlzLm9yYml0VmVydGljZXMucHVzaCggbmV3IFZlY3RvcjMoIDAsIDAsIDAgKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMud2F2ZVZlcnRpY2VzID0gW107XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBOVU1CRVJfT0ZfV0FWRV9WRVJUSUNFUzsgaSsrICkge1xyXG4gICAgICB0aGlzLndhdmVWZXJ0aWNlcy5wdXNoKCBuZXcgVmVjdG9yMyggMCwgMCwgMCApICk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5vcmJpdEZyb250Q29sb3JQcm9wZXJ0eSA9IE1PVEhBQ29sb3JzLm9yYml0U3Ryb2tlUHJvcGVydHk7XHJcbiAgICB0aGlzLm9yYml0QmFja0NvbG9yUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIHRoaXMub3JiaXRGcm9udENvbG9yUHJvcGVydHkgXSxcclxuICAgICAgb3JiaXRGcm9udENvbG9yID0+IG9yYml0RnJvbnRDb2xvci5kYXJrZXJDb2xvcigpLmRhcmtlckNvbG9yKCkuZGFya2VyQ29sb3IoKVxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLndhdmVGcm9udENvbG9yUHJvcGVydHkgPSBNT1RIQUNvbG9ycy5lbGVjdHJvbkJhc2VDb2xvclByb3BlcnR5O1xyXG4gICAgdGhpcy53YXZlQmFja0NvbG9yUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIHRoaXMud2F2ZUZyb250Q29sb3JQcm9wZXJ0eSBdLFxyXG4gICAgICB3YXZlRnJvbnRDb2xvciA9PiB3YXZlRnJvbnRDb2xvci5kYXJrZXJDb2xvcigpLmRhcmtlckNvbG9yKCkuZGFya2VyQ29sb3IoKVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyAzRCBvcmJpdHNcclxuICAgIGNvbnN0IG9yYml0Tm9kZXM6IFdpcmVmcmFtZU5vZGVbXSA9IFtdO1xyXG4gICAgY29uc3QgZ3JvdW5kU3RhdGUgPSBNT1RIQUNvbnN0YW50cy5HUk9VTkRfU1RBVEU7XHJcbiAgICBjb25zdCBtYXhTdGF0ZSA9IERlQnJvZ2xpZU1vZGVsLmdldE1heEVsZWN0cm9uU3RhdGUoKTtcclxuICAgIGZvciAoIGxldCBzdGF0ZSA9IGdyb3VuZFN0YXRlOyBzdGF0ZSA8IG1heFN0YXRlOyBzdGF0ZSsrICkge1xyXG4gICAgICBjb25zdCByYWRpdXMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIGh5ZHJvZ2VuQXRvbS5nZXRFbGVjdHJvbk9yYml0UmFkaXVzKCBzdGF0ZSApICk7XHJcbiAgICAgIGNvbnN0IG9yYml0Tm9kZSA9IHRoaXMuY3JlYXRlT3JiaXROb2RlKCByYWRpdXMsIHRoaXMudmlld01hdHJpeCwgdGhpcy5vcmJpdFZlcnRpY2VzICk7XHJcbiAgICAgIG9yYml0Tm9kZXMucHVzaCggb3JiaXROb2RlICk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBvcmJpdHNOb2RlID0gbmV3IE5vZGUoIHtcclxuICAgICAgY2hpbGRyZW46IG9yYml0Tm9kZXMsXHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnb3JiaXRzTm9kZScgKVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggb3JiaXRzTm9kZSApO1xyXG5cclxuICAgIHRoaXMud2F2ZU1vZGVsID0gbmV3IFdpcmVmcmFtZU1vZGVsKCB7XHJcbiAgICAgIGZyb250Q29sb3I6IHRoaXMud2F2ZUZyb250Q29sb3JQcm9wZXJ0eSxcclxuICAgICAgYmFja0NvbG9yOiB0aGlzLndhdmVCYWNrQ29sb3JQcm9wZXJ0eSxcclxuICAgICAgbGluZVdpZHRoOiAyXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy53YXZlTm9kZSA9IG5ldyBXaXJlZnJhbWVOb2RlKCB0aGlzLndhdmVNb2RlbCwge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3dhdmVOb2RlJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy9UT0RPIGFyZSB0aGVzZSBkZXBlbmRlbmNpZXMgY29ycmVjdD9cclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgaHlkcm9nZW5BdG9tLmdldEVsZWN0cm9uU3RhdGVQcm9wZXJ0eSgpLCBoeWRyb2dlbkF0b20uZWxlY3Ryb25BbmdsZVByb3BlcnR5LCB0aGlzLnZpc2libGVQcm9wZXJ0eSBdLFxyXG4gICAgICAoIGVsZWN0cm9uU3RhdGUsIGVsZWN0cm9uQW5nbGUsIHZpc2libGUgKSA9PiB7XHJcbiAgICAgICAgdmlzaWJsZSAmJiB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICAvL1RPRE8gaW1wbGVtZW50IG9yIGRlbGV0ZSBzdGVwXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMudXBkYXRlV2F2ZU5vZGUoKTtcclxuICAgIGlmICggdGhpcy5jdXJyZW50Vmlld0FuZ2xlUHJvcGVydHkudmFsdWUgPT09IEZJTkFMX1ZJRVdfQU5HTEUgKSB7XHJcbiAgICAgIHRoaXMudXBkYXRlVmlld01hdHJpeCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB0aGUgd2F2ZS5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZVdhdmVOb2RlKCk6IHZvaWQge1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgdmVydGljZXNcclxuICAgIHRoaXMud2F2ZVZlcnRpY2VzID0gdXBkYXRlV2F2ZVZlcnRpY2VzKCB0aGlzLmh5ZHJvZ2VuQXRvbSwgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0sIHRoaXMud2F2ZVZlcnRpY2VzICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSB3aXJlZnJhbWUgbW9kZWxcclxuICAgIHRoaXMud2F2ZU1vZGVsLnJlc2V0KCk7XHJcbiAgICB0aGlzLndhdmVNb2RlbC5hZGRWZXJ0aWNlcyggdGhpcy53YXZlVmVydGljZXMgKTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMud2F2ZVZlcnRpY2VzLmxlbmd0aCAtIDE7IGkrKyApIHtcclxuICAgICAgdGhpcy53YXZlTW9kZWwuYWRkTGluZSggaSwgaSArIDEgKTtcclxuICAgIH1cclxuICAgIHRoaXMud2F2ZU1vZGVsLmFkZExpbmUoIHRoaXMud2F2ZVZlcnRpY2VzLmxlbmd0aCAtIDEsIDAgKTsgLy8gY2xvc2UgdGhlIHBhdGhcclxuXHJcbiAgICAvLyBUcmFuc2Zvcm0gdGhlIG1vZGVsXHJcbiAgICBjb25zdCBtYXRyaXggPSB0aGlzLndhdmVNb2RlbC5nZXRNYXRyaXgoKTtcclxuICAgIG1hdHJpeC51bml0KCk7XHJcbiAgICBjb25zdCB4dCA9IC0oIHRoaXMud2F2ZU1vZGVsLmdldFhNaW4oKSArIHRoaXMud2F2ZU1vZGVsLmdldFhNYXgoKSApIC8gMjtcclxuICAgIGNvbnN0IHl0ID0gLSggdGhpcy53YXZlTW9kZWwuZ2V0WU1pbigpICsgdGhpcy53YXZlTW9kZWwuZ2V0WU1heCgpICkgLyAyO1xyXG4gICAgY29uc3QgenQgPSAtKCB0aGlzLndhdmVNb2RlbC5nZXRaTWluKCkgKyB0aGlzLndhdmVNb2RlbC5nZXRaTWF4KCkgKSAvIDI7XHJcbiAgICBtYXRyaXgudHJhbnNsYXRlKCB4dCwgeXQsIHp0ICk7XHJcbiAgICBtYXRyaXgubXVsdGlwbHkoIHRoaXMudmlld01hdHJpeCApO1xyXG4gICAgdGhpcy53YXZlTW9kZWwuc2V0TWF0cml4KCBtYXRyaXggKTtcclxuXHJcbiAgICAvL1RPRE8gaG93IGRvZXMgdGhpcy53YXZlTm9kZSBnZXQgbm90aWZpZWQgdG8gdXBkYXRlP1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBVcGRhdGVzIHRoZSB2aWV3IG1hdHJpeCB1bnRpbCB0aGUgdmlldyBpcyByb3RhdGVkIGludG8gcGxhY2UuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVWaWV3TWF0cml4KCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLmN1cnJlbnRWaWV3QW5nbGVQcm9wZXJ0eS52YWx1ZSAhPT0gRklOQUxfVklFV19BTkdMRSApIHtcclxuICAgICAgdGhpcy5jdXJyZW50Vmlld0FuZ2xlUHJvcGVydHkudmFsdWUgPSBNYXRoLm1pbiggRklOQUxfVklFV19BTkdMRSwgdGhpcy5jdXJyZW50Vmlld0FuZ2xlUHJvcGVydHkudmFsdWUgKyBWSUVXX0FOR0xFX0RFTFRBICk7XHJcbiAgICAgIHRoaXMudmlld01hdHJpeC51bml0KCk7XHJcbiAgICAgIHRoaXMudmlld01hdHJpeC5yb3RhdGVYKCB0aGlzLmN1cnJlbnRWaWV3QW5nbGVQcm9wZXJ0eS52YWx1ZSApO1xyXG5cclxuICAgICAgLy9UT0RPIHdoYXQgbmVlZHMgdG8gYmUgbm90aWZpZWQgdGhhdCB0aGUudmlld01hdHJpeCBoYXMgY2hhbmdlZD9cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vVE9ETyBjb252ZXJ0IHRoaXMgdG86IGNsYXNzIE9yYml0Tm9kZSBleHRlbmRzIFdpcmVmcmFtZU5vZGVcclxuICAvKipcclxuICAgKiBDcmVhdGVzIGEgTm9kZSBmb3IgYW4gZWxlY3Ryb24gb3JiaXQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVPcmJpdE5vZGUoIHJhZGl1czogbnVtYmVyLCB2aWV3TWF0cml4OiBXaXJlZnJhbWVNYXRyaXgsIHZlcnRpY2VzOiBWZWN0b3IzW10gKTogV2lyZWZyYW1lTm9kZSB7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSB2ZXJ0aWNlc1xyXG4gICAgdmVydGljZXMgPSB1cGRhdGVPcmJpdFZlcnRpY2VzKCByYWRpdXMsIHZlcnRpY2VzICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSB3aXJlZnJhbWUgbW9kZWxcclxuICAgIGNvbnN0IHdpcmVmcmFtZU1vZGVsOiBXaXJlZnJhbWVNb2RlbCA9IG5ldyBXaXJlZnJhbWVNb2RlbCgge1xyXG4gICAgICB2ZXJ0aWNlczogdmVydGljZXMsXHJcbiAgICAgIGZyb250Q29sb3I6IHRoaXMub3JiaXRGcm9udENvbG9yUHJvcGVydHksXHJcbiAgICAgIGJhY2tDb2xvcjogdGhpcy5vcmJpdEJhY2tDb2xvclByb3BlcnR5LFxyXG4gICAgICBsaW5lV2lkdGg6IDJcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBDb25uZWN0IGV2ZXJ5LW90aGVyIHBhaXIgb2YgdmVydGljZXMgdG8gc2ltdWxhdGUgYSBkYXNoZWQgbGluZS5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aCAtIDE7IGkgKz0gMiApIHtcclxuICAgICAgd2lyZWZyYW1lTW9kZWwuYWRkTGluZSggaSwgaSArIDEgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUcmFuc2Zvcm0gdGhlIG1vZGVsXHJcbiAgICBjb25zdCBtYXRyaXggPSB3aXJlZnJhbWVNb2RlbC5nZXRNYXRyaXgoKTtcclxuICAgIG1hdHJpeC51bml0KCk7XHJcbiAgICBjb25zdCB4dCA9IC0oIHdpcmVmcmFtZU1vZGVsLmdldFhNaW4oKSArIHdpcmVmcmFtZU1vZGVsLmdldFhNYXgoKSApIC8gMjtcclxuICAgIGNvbnN0IHl0ID0gLSggd2lyZWZyYW1lTW9kZWwuZ2V0WU1pbigpICsgd2lyZWZyYW1lTW9kZWwuZ2V0WU1heCgpICkgLyAyO1xyXG4gICAgY29uc3QgenQgPSAtKCB3aXJlZnJhbWVNb2RlbC5nZXRaTWluKCkgKyB3aXJlZnJhbWVNb2RlbC5nZXRaTWF4KCkgKSAvIDI7XHJcbiAgICBtYXRyaXgudHJhbnNsYXRlKCB4dCwgeXQsIHp0ICk7XHJcbiAgICBtYXRyaXgubXVsdGlwbHkoIHZpZXdNYXRyaXggKTtcclxuICAgIHdpcmVmcmFtZU1vZGVsLnNldE1hdHJpeCggbWF0cml4ICk7XHJcblxyXG4gICAgcmV0dXJuIG5ldyBXaXJlZnJhbWVOb2RlKCB3aXJlZnJhbWVNb2RlbCApO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFVwZGF0ZXMgdGhlIHZlcnRpY2VzIHRoYXQgYXBwcm94aW1hdGUgYW4gZWxlY3Ryb24gb3JiaXQuXHJcbiAqL1xyXG5mdW5jdGlvbiB1cGRhdGVPcmJpdFZlcnRpY2VzKCBvcmJpdFJhZGl1czogbnVtYmVyLCB2ZXJ0aWNlczogVmVjdG9yM1tdICk6IFZlY3RvcjNbXSB7XHJcblxyXG4gIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSB2ZXJ0aWNlcy5sZW5ndGg7XHJcbiAgY29uc3QgZGVsdGFBbmdsZSA9ICggMiAqIE1hdGguUEkgKSAvIG51bWJlck9mVmVydGljZXM7XHJcblxyXG4gIGZvciAoIGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7IGkrKyApIHtcclxuICAgIGNvbnN0IGFuZ2xlID0gaSAqIGRlbHRhQW5nbGU7XHJcbiAgICBjb25zdCB4ID0gb3JiaXRSYWRpdXMgKiBNYXRoLmNvcyggYW5nbGUgKTtcclxuICAgIGNvbnN0IHkgPSBvcmJpdFJhZGl1cyAqIE1hdGguc2luKCBhbmdsZSApO1xyXG4gICAgY29uc3QgeiA9IDA7XHJcbiAgICB2ZXJ0aWNlc1sgaSBdLnNldFhZWiggeCwgeSwgeiApO1xyXG4gIH1cclxuICByZXR1cm4gdmVydGljZXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBVcGRhdGVzIHRoZSB2ZXJ0aWNlcyB0aGF0IGFwcHJveGltYXRlIHRoZSBzdGFuZGluZyB3YXZlLlxyXG4gKi9cclxuZnVuY3Rpb24gdXBkYXRlV2F2ZVZlcnRpY2VzKCBoeWRyb2dlbkF0b206IERlQnJvZ2xpZU1vZGVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsVmlld1RyYW5zZm9ybTogTW9kZWxWaWV3VHJhbnNmb3JtMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZXJ0aWNlczogVmVjdG9yM1tdICk6IFZlY3RvcjNbXSB7XHJcblxyXG4gIGNvbnN0IGVsZWN0cm9uU3RhdGUgPSBoeWRyb2dlbkF0b20uZ2V0RWxlY3Ryb25TdGF0ZSgpO1xyXG4gIGNvbnN0IHJhZGl1cyA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWCggaHlkcm9nZW5BdG9tLmdldEVsZWN0cm9uT3JiaXRSYWRpdXMoIGVsZWN0cm9uU3RhdGUgKSApO1xyXG5cclxuICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gdmVydGljZXMubGVuZ3RoO1xyXG4gIGNvbnN0IGRlbHRhQW5nbGUgPSAoIDIgKiBNYXRoLlBJICkgLyBudW1iZXJPZlZlcnRpY2VzO1xyXG5cclxuICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBudW1iZXJPZlZlcnRpY2VzOyBpKysgKSB7XHJcbiAgICBjb25zdCBhbmdsZSA9IGkgKiBkZWx0YUFuZ2xlO1xyXG4gICAgY29uc3QgeCA9IHJhZGl1cyAqIE1hdGguY29zKCBhbmdsZSApO1xyXG4gICAgY29uc3QgeSA9IHJhZGl1cyAqIE1hdGguc2luKCBhbmdsZSApO1xyXG4gICAgY29uc3QgeiA9IE1BWF9XQVZFX0hFSUdIVCAqIGh5ZHJvZ2VuQXRvbS5nZXRBbXBsaXR1ZGUoIGFuZ2xlLCBlbGVjdHJvblN0YXRlICk7XHJcbiAgICB2ZXJ0aWNlc1sgaSBdLnNldFhZWiggeCwgeSwgeiApO1xyXG4gIH1cclxuICByZXR1cm4gdmVydGljZXM7XHJcbn1cclxuXHJcbm1vZGVsc09mVGhlSHlkcm9nZW5BdG9tLnJlZ2lzdGVyKCAnRGVCcm9nbGllM0ROb2RlJywgRGVCcm9nbGllM0ROb2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFFcEUsT0FBT0MsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBRWxFLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxTQUFTLE1BQTRCLHVDQUF1QztBQUduRixTQUFnQkMsSUFBSSxRQUFxQixtQ0FBbUM7QUFDNUUsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQztBQUNoRSxPQUFPQyx1QkFBdUIsTUFBTSxrQ0FBa0M7QUFDdEUsT0FBT0MsY0FBYyxNQUFNLDRCQUE0QjtBQUN2RCxPQUFPQyxXQUFXLE1BQU0sbUJBQW1CO0FBQzNDLE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFD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