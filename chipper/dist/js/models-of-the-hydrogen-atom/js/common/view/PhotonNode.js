// Copyright 2022, University of Colorado Boulder

/**
 * PhotonNode is the visual representation of a photon. A round "orb" has an outer "halo" and a whimsical "sparkle"
 * in the middle. Origin is at center of the Node's bounding rectangle. The look is loosely based on examples that
 * Wendy Adams found on a Disney website at http://disney.go.com/fairies/meetfairies.html.
 *
 * By default, the colorscheme is as follows:
 * - visible wavelengths are mapped to visible colors.
 * - UV photons are rendered as gray orbs with violet crosshairs.
 * - IR photos are rendered as gray orbs with red crosshairs.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Utils from '../../../../dot/js/Utils.js';
import { Shape } from '../../../../kite/js/imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import VisibleColor from '../../../../scenery-phet/js/VisibleColor.js';
import { Circle, Color, Node, Path, RadialGradient, Rectangle } from '../../../../scenery/js/imports.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import modelsOfTheHydrogenAtom from '../../modelsOfTheHydrogenAtom.js';
import Photon from '../model/Photon.js';
import MOTHAQueryParameters from '../MOTHAQueryParameters.js';

// constants
const INVISIBLE_WAVELENGTH_COLOR = new Color(160, 160, 160);
const WAVELENGTH_TO_COLOR_OPTIONS = {
  uvColor: INVISIBLE_WAVELENGTH_COLOR,
  irColor: INVISIBLE_WAVELENGTH_COLOR
};

// Sparkle
const SPARKLE_COLOR = new Color(255, 255, 255, 0.4); // sparkle color for visible wavelengths
const UV_SPARKLE_COLOR = VisibleColor.wavelengthToColor(400, WAVELENGTH_TO_COLOR_OPTIONS);
const IR_SPARKLE_COLOR = VisibleColor.wavelengthToColor(715, WAVELENGTH_TO_COLOR_OPTIONS);
export default class PhotonNode extends Node {
  constructor(photon, modelViewTransform, providedOptions) {
    const options = optionize()({
      //TODO default values for options
    }, providedOptions);
    const wavelength = photon.wavelength;
    const photonRadius = modelViewTransform.modelToViewDeltaX(photon.radius);
    const haloRadius = photonRadius;
    const haloNode = new Circle(haloRadius, {
      fill: getHaloColor(wavelength, haloRadius)
    });
    const orbRadius = 0.5 * photonRadius;
    const orbNode = new Circle(orbRadius, {
      fill: getOrbColor(wavelength, orbRadius)
    });
    const sparkleRadius = 0.575 * photonRadius;
    const sparkleNode = new SparkleNode(wavelength, sparkleRadius);
    options.children = [haloNode, orbNode, sparkleNode];

    // Draw a red rectangle around emitted photons.
    if (MOTHAQueryParameters.debugEmission && photon.wasEmitted) {
      const size = 2 * haloRadius;
      options.children.push(new Rectangle(-size / 2, -size / 2, size, size, {
        stroke: 'red',
        lineWidth: 4
      }));
    }
    super(options);
    const positionListener = position => {
      this.translation = modelViewTransform.modelToViewPosition(position);
    };
    photon.positionProperty.link(positionListener);
    this.photon = photon;
    this.disposePhotonNode = () => {
      if (photon.positionProperty.hasListener(positionListener)) {
        photon.positionProperty.unlink(positionListener);
      }
    };
  }
  dispose() {
    this.disposePhotonNode();
    super.dispose();
  }

  /**
   * Creates a photon icon, used in the Key.
   */
  static createIcon(wavelength, scale = 1) {
    const photon = new Photon({
      wavelength: wavelength,
      tandem: Tandem.OPT_OUT
    });
    const modelViewTransform = ModelViewTransform2.createIdentity();
    return new PhotonNode(photon, modelViewTransform, {
      scale: scale,
      tandem: Tandem.OPT_OUT
    });
  }
}
class SparkleNode extends Node {
  constructor(wavelength, radius) {
    const fill = getSparkleColor(wavelength);
    const bigCrosshairs = new CrosshairsNode(radius, fill);
    const smallCrosshairs = new CrosshairsNode(0.7 * radius, fill, Utils.toRadians(45));
    super({
      children: [bigCrosshairs, smallCrosshairs],
      rotation: Utils.toRadians(18)
    });
  }
}
class CrosshairsNode extends Node {
  constructor(radius, fill, rotation = 0) {
    const crosshairShape = Shape.ellipse(0, 0, radius, 0.1 * radius, 0);
    const horizontalPart = new Path(crosshairShape, {
      fill: fill
    });
    const verticalPart = new Path(crosshairShape, {
      fill: fill,
      rotation: Utils.toRadians(90)
    });
    super({
      children: [horizontalPart, verticalPart],
      rotation: rotation
    });
  }
}
function getHaloColor(wavelength, radius) {
  const innerColor = VisibleColor.wavelengthToColor(wavelength, WAVELENGTH_TO_COLOR_OPTIONS);
  const outerColor = innerColor.withAlpha(0);
  return new RadialGradient(0, 0, 0, 0, 0, radius).addColorStop(0.4, innerColor).addColorStop(1, outerColor);
}
function getOrbColor(wavelength, radius) {
  const innerColor = new Color(255, 255, 255, 0.7);
  const outerColor = VisibleColor.wavelengthToColor(wavelength, WAVELENGTH_TO_COLOR_OPTIONS).withAlpha(0.5);
  return new RadialGradient(0, 0, 0, 0, 0, radius).addColorStop(0.25, innerColor).addColorStop(1, outerColor);
}

/*
 * Returns the color for the 'sparkle' in the center of the photon.
 */
function getSparkleColor(wavelength) {
  if (wavelength < VisibleColor.MIN_WAVELENGTH) {
    return UV_SPARKLE_COLOR;
  } else if (wavelength > VisibleColor.MAX_WAVELENGTH) {
    return IR_SPARKLE_COLOR;
  } else {
    return SPARKLE_COLOR;
  }
}
modelsOfTheHydrogenAtom.register('PhotonNode', PhotonNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlNoYXBlIiwib3B0aW9uaXplIiwiTW9kZWxWaWV3VHJhbnNmb3JtMiIsIlZpc2libGVDb2xvciIsIkNpcmNsZSIsIkNvbG9yIiwiTm9kZSIsIlBhdGgiLCJSYWRpYWxHcmFkaWVudCIsIlJlY3RhbmdsZSIsIlRhbmRlbSIsIm1vZGVsc09mVGhlSHlkcm9nZW5BdG9tIiwiUGhvdG9uIiwiTU9USEFRdWVyeVBhcmFtZXRlcnMiLCJJTlZJU0lCTEVfV0FWRUxFTkdUSF9DT0xPUiIsIldBVkVMRU5HVEhfVE9fQ09MT1JfT1BUSU9OUyIsInV2Q29sb3IiLCJpckNvbG9yIiwiU1BBUktMRV9DT0xPUiIsIlVWX1NQQVJLTEVfQ09MT1IiLCJ3YXZlbGVuZ3RoVG9Db2xvciIsIklSX1NQQVJLTEVfQ09MT1IiLCJQaG90b25Ob2RlIiwiY29uc3RydWN0b3IiLCJwaG90b24iLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwid2F2ZWxlbmd0aCIsInBob3RvblJhZGl1cyIsIm1vZGVsVG9WaWV3RGVsdGFYIiwicmFkaXVzIiwiaGFsb1JhZGl1cyIsImhhbG9Ob2RlIiwiZmlsbCIsImdldEhhbG9Db2xvciIsIm9yYlJhZGl1cyIsIm9yYk5vZGUiLCJnZXRPcmJDb2xvciIsInNwYXJrbGVSYWRpdXMiLCJzcGFya2xlTm9kZSIsIlNwYXJrbGVOb2RlIiwiY2hpbGRyZW4iLCJkZWJ1Z0VtaXNzaW9uIiwid2FzRW1pdHRlZCIsInNpemUiLCJwdXNoIiwic3Ryb2tlIiwibGluZVdpZHRoIiwicG9zaXRpb25MaXN0ZW5lciIsInBvc2l0aW9uIiwidHJhbnNsYXRpb24iLCJtb2RlbFRvVmlld1Bvc2l0aW9uIiwicG9zaXRpb25Qcm9wZXJ0eSIsImxpbmsiLCJkaXNwb3NlUGhvdG9uTm9kZSIsImhhc0xpc3RlbmVyIiwidW5saW5rIiwiZGlzcG9zZSIsImNyZWF0ZUljb24iLCJzY2FsZSIsInRhbmRlbSIsIk9QVF9PVVQiLCJjcmVhdGVJZGVudGl0eSIsImdldFNwYXJrbGVDb2xvciIsImJpZ0Nyb3NzaGFpcnMiLCJDcm9zc2hhaXJzTm9kZSIsInNtYWxsQ3Jvc3NoYWlycyIsInRvUmFkaWFucyIsInJvdGF0aW9uIiwiY3Jvc3NoYWlyU2hhcGUiLCJlbGxpcHNlIiwiaG9yaXpvbnRhbFBhcnQiLCJ2ZXJ0aWNhbFBhcnQiLCJpbm5lckNvbG9yIiwib3V0ZXJDb2xvciIsIndpdGhBbHBoYSIsImFkZENvbG9yU3RvcCIsIk1JTl9XQVZFTEVOR1RIIiwiTUFYX1dBVkVMRU5HVEgiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBob3Rvbk5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFBob3Rvbk5vZGUgaXMgdGhlIHZpc3VhbCByZXByZXNlbnRhdGlvbiBvZiBhIHBob3Rvbi4gQSByb3VuZCBcIm9yYlwiIGhhcyBhbiBvdXRlciBcImhhbG9cIiBhbmQgYSB3aGltc2ljYWwgXCJzcGFya2xlXCJcclxuICogaW4gdGhlIG1pZGRsZS4gT3JpZ2luIGlzIGF0IGNlbnRlciBvZiB0aGUgTm9kZSdzIGJvdW5kaW5nIHJlY3RhbmdsZS4gVGhlIGxvb2sgaXMgbG9vc2VseSBiYXNlZCBvbiBleGFtcGxlcyB0aGF0XHJcbiAqIFdlbmR5IEFkYW1zIGZvdW5kIG9uIGEgRGlzbmV5IHdlYnNpdGUgYXQgaHR0cDovL2Rpc25leS5nby5jb20vZmFpcmllcy9tZWV0ZmFpcmllcy5odG1sLlxyXG4gKlxyXG4gKiBCeSBkZWZhdWx0LCB0aGUgY29sb3JzY2hlbWUgaXMgYXMgZm9sbG93czpcclxuICogLSB2aXNpYmxlIHdhdmVsZW5ndGhzIGFyZSBtYXBwZWQgdG8gdmlzaWJsZSBjb2xvcnMuXHJcbiAqIC0gVVYgcGhvdG9ucyBhcmUgcmVuZGVyZWQgYXMgZ3JheSBvcmJzIHdpdGggdmlvbGV0IGNyb3NzaGFpcnMuXHJcbiAqIC0gSVIgcGhvdG9zIGFyZSByZW5kZXJlZCBhcyBncmF5IG9yYnMgd2l0aCByZWQgY3Jvc3NoYWlycy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1V0aWxzLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUsIHsgRW1wdHlTZWxmT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgUGlja09wdGlvbmFsIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrT3B0aW9uYWwuanMnO1xyXG5pbXBvcnQgUGlja1JlcXVpcmVkIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrUmVxdWlyZWQuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCB7IFNoYWRlZFNwaGVyZU5vZGVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1NoYWRlZFNwaGVyZU5vZGUuanMnO1xyXG5pbXBvcnQgVmlzaWJsZUNvbG9yIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9WaXNpYmxlQ29sb3IuanMnO1xyXG5pbXBvcnQgeyBDaXJjbGUsIENvbG9yLCBUQ29sb3IsIE5vZGUsIE5vZGVPcHRpb25zLCBQYXRoLCBSYWRpYWxHcmFkaWVudCwgUmVjdGFuZ2xlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IG1vZGVsc09mVGhlSHlkcm9nZW5BdG9tIGZyb20gJy4uLy4uL21vZGVsc09mVGhlSHlkcm9nZW5BdG9tLmpzJztcclxuaW1wb3J0IFBob3RvbiBmcm9tICcuLi9tb2RlbC9QaG90b24uanMnO1xyXG5pbXBvcnQgTU9USEFRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vTU9USEFRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IElOVklTSUJMRV9XQVZFTEVOR1RIX0NPTE9SID0gbmV3IENvbG9yKCAxNjAsIDE2MCwgMTYwICk7XHJcbmNvbnN0IFdBVkVMRU5HVEhfVE9fQ09MT1JfT1BUSU9OUyA9IHtcclxuICB1dkNvbG9yOiBJTlZJU0lCTEVfV0FWRUxFTkdUSF9DT0xPUixcclxuICBpckNvbG9yOiBJTlZJU0lCTEVfV0FWRUxFTkdUSF9DT0xPUlxyXG59O1xyXG5cclxuLy8gU3BhcmtsZVxyXG5jb25zdCBTUEFSS0xFX0NPTE9SID0gbmV3IENvbG9yKCAyNTUsIDI1NSwgMjU1LCAwLjQgKTsgLy8gc3BhcmtsZSBjb2xvciBmb3IgdmlzaWJsZSB3YXZlbGVuZ3Roc1xyXG5jb25zdCBVVl9TUEFSS0xFX0NPTE9SID0gVmlzaWJsZUNvbG9yLndhdmVsZW5ndGhUb0NvbG9yKCA0MDAsIFdBVkVMRU5HVEhfVE9fQ09MT1JfT1BUSU9OUyApO1xyXG5jb25zdCBJUl9TUEFSS0xFX0NPTE9SID0gVmlzaWJsZUNvbG9yLndhdmVsZW5ndGhUb0NvbG9yKCA3MTUsIFdBVkVMRU5HVEhfVE9fQ09MT1JfT1BUSU9OUyApO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIFBob3Rvbk5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQaWNrT3B0aW9uYWw8Tm9kZU9wdGlvbnMsICdzY2FsZSc+ICYgUGlja1JlcXVpcmVkPE5vZGVPcHRpb25zLCAndGFuZGVtJz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQaG90b25Ob2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSBwaG90b246IFBob3RvbjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VQaG90b25Ob2RlOiAoKSA9PiB2b2lkO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHBob3RvbjogUGhvdG9uLCBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIsIHByb3ZpZGVkT3B0aW9ucz86IFBob3Rvbk5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8UGhvdG9uTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBTaGFkZWRTcGhlcmVOb2RlT3B0aW9ucz4oKSgge1xyXG4gICAgICAvL1RPRE8gZGVmYXVsdCB2YWx1ZXMgZm9yIG9wdGlvbnNcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHdhdmVsZW5ndGggPSBwaG90b24ud2F2ZWxlbmd0aDtcclxuXHJcbiAgICBjb25zdCBwaG90b25SYWRpdXMgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIHBob3Rvbi5yYWRpdXMgKTtcclxuXHJcbiAgICBjb25zdCBoYWxvUmFkaXVzID0gcGhvdG9uUmFkaXVzO1xyXG4gICAgY29uc3QgaGFsb05vZGUgPSBuZXcgQ2lyY2xlKCBoYWxvUmFkaXVzLCB7XHJcbiAgICAgIGZpbGw6IGdldEhhbG9Db2xvciggd2F2ZWxlbmd0aCwgaGFsb1JhZGl1cyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgb3JiUmFkaXVzID0gMC41ICogcGhvdG9uUmFkaXVzO1xyXG4gICAgY29uc3Qgb3JiTm9kZSA9IG5ldyBDaXJjbGUoIG9yYlJhZGl1cywge1xyXG4gICAgICBmaWxsOiBnZXRPcmJDb2xvciggd2F2ZWxlbmd0aCwgb3JiUmFkaXVzIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBzcGFya2xlUmFkaXVzID0gMC41NzUgKiBwaG90b25SYWRpdXM7XHJcbiAgICBjb25zdCBzcGFya2xlTm9kZSA9IG5ldyBTcGFya2xlTm9kZSggd2F2ZWxlbmd0aCwgc3BhcmtsZVJhZGl1cyApO1xyXG5cclxuICAgIG9wdGlvbnMuY2hpbGRyZW4gPSBbIGhhbG9Ob2RlLCBvcmJOb2RlLCBzcGFya2xlTm9kZSBdO1xyXG5cclxuICAgIC8vIERyYXcgYSByZWQgcmVjdGFuZ2xlIGFyb3VuZCBlbWl0dGVkIHBob3RvbnMuXHJcbiAgICBpZiAoIE1PVEhBUXVlcnlQYXJhbWV0ZXJzLmRlYnVnRW1pc3Npb24gJiYgcGhvdG9uLndhc0VtaXR0ZWQgKSB7XHJcbiAgICAgIGNvbnN0IHNpemUgPSAyICogaGFsb1JhZGl1cztcclxuICAgICAgb3B0aW9ucy5jaGlsZHJlbi5wdXNoKCBuZXcgUmVjdGFuZ2xlKCAtc2l6ZSAvIDIsIC1zaXplIC8gMiwgc2l6ZSwgc2l6ZSwge1xyXG4gICAgICAgIHN0cm9rZTogJ3JlZCcsXHJcbiAgICAgICAgbGluZVdpZHRoOiA0XHJcbiAgICAgIH0gKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgcG9zaXRpb25MaXN0ZW5lciA9ICggcG9zaXRpb246IFZlY3RvcjIgKSA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdQb3NpdGlvbiggcG9zaXRpb24gKTtcclxuICAgIH07XHJcbiAgICBwaG90b24ucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBwb3NpdGlvbkxpc3RlbmVyICk7XHJcblxyXG4gICAgdGhpcy5waG90b24gPSBwaG90b247XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlUGhvdG9uTm9kZSA9ICgpID0+IHtcclxuICAgICAgaWYgKCBwaG90b24ucG9zaXRpb25Qcm9wZXJ0eS5oYXNMaXN0ZW5lciggcG9zaXRpb25MaXN0ZW5lciApICkge1xyXG4gICAgICAgIHBob3Rvbi5wb3NpdGlvblByb3BlcnR5LnVubGluayggcG9zaXRpb25MaXN0ZW5lciApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3Bvc2VQaG90b25Ob2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIGEgcGhvdG9uIGljb24sIHVzZWQgaW4gdGhlIEtleS5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZUljb24oIHdhdmVsZW5ndGg6IG51bWJlciwgc2NhbGUgPSAxICk6IE5vZGUge1xyXG4gICAgY29uc3QgcGhvdG9uID0gbmV3IFBob3Rvbigge1xyXG4gICAgICB3YXZlbGVuZ3RoOiB3YXZlbGVuZ3RoLFxyXG4gICAgICB0YW5kZW06IFRhbmRlbS5PUFRfT1VUXHJcbiAgICB9ICk7XHJcbiAgICBjb25zdCBtb2RlbFZpZXdUcmFuc2Zvcm0gPSBNb2RlbFZpZXdUcmFuc2Zvcm0yLmNyZWF0ZUlkZW50aXR5KCk7XHJcbiAgICByZXR1cm4gbmV3IFBob3Rvbk5vZGUoIHBob3RvbiwgbW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgIHNjYWxlOiBzY2FsZSxcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uT1BUX09VVFxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgU3BhcmtsZU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHdhdmVsZW5ndGg6IG51bWJlciwgcmFkaXVzOiBudW1iZXIgKSB7XHJcbiAgICBjb25zdCBmaWxsID0gZ2V0U3BhcmtsZUNvbG9yKCB3YXZlbGVuZ3RoICk7XHJcbiAgICBjb25zdCBiaWdDcm9zc2hhaXJzID0gbmV3IENyb3NzaGFpcnNOb2RlKCByYWRpdXMsIGZpbGwgKTtcclxuICAgIGNvbnN0IHNtYWxsQ3Jvc3NoYWlycyA9IG5ldyBDcm9zc2hhaXJzTm9kZSggMC43ICogcmFkaXVzLCBmaWxsLCBVdGlscy50b1JhZGlhbnMoIDQ1ICkgKTtcclxuICAgIHN1cGVyKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIGJpZ0Nyb3NzaGFpcnMsIHNtYWxsQ3Jvc3NoYWlycyBdLFxyXG4gICAgICByb3RhdGlvbjogVXRpbHMudG9SYWRpYW5zKCAxOCApXHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5jbGFzcyBDcm9zc2hhaXJzTm9kZSBleHRlbmRzIE5vZGUge1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcmFkaXVzOiBudW1iZXIsIGZpbGw6IFRDb2xvciwgcm90YXRpb24gPSAwICkge1xyXG5cclxuICAgIGNvbnN0IGNyb3NzaGFpclNoYXBlID0gU2hhcGUuZWxsaXBzZSggMCwgMCwgcmFkaXVzLCAwLjEgKiByYWRpdXMsIDAgKTtcclxuXHJcbiAgICBjb25zdCBob3Jpem9udGFsUGFydCA9IG5ldyBQYXRoKCBjcm9zc2hhaXJTaGFwZSwge1xyXG4gICAgICBmaWxsOiBmaWxsXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgdmVydGljYWxQYXJ0ID0gbmV3IFBhdGgoIGNyb3NzaGFpclNoYXBlLCB7XHJcbiAgICAgIGZpbGw6IGZpbGwsXHJcbiAgICAgIHJvdGF0aW9uOiBVdGlscy50b1JhZGlhbnMoIDkwIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICBjaGlsZHJlbjogWyBob3Jpem9udGFsUGFydCwgdmVydGljYWxQYXJ0IF0sXHJcbiAgICAgIHJvdGF0aW9uOiByb3RhdGlvblxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SGFsb0NvbG9yKCB3YXZlbGVuZ3RoOiBudW1iZXIsIHJhZGl1czogbnVtYmVyICk6IFJhZGlhbEdyYWRpZW50IHtcclxuICBjb25zdCBpbm5lckNvbG9yID0gVmlzaWJsZUNvbG9yLndhdmVsZW5ndGhUb0NvbG9yKCB3YXZlbGVuZ3RoLCBXQVZFTEVOR1RIX1RPX0NPTE9SX09QVElPTlMgKTtcclxuICBjb25zdCBvdXRlckNvbG9yID0gaW5uZXJDb2xvci53aXRoQWxwaGEoIDAgKTtcclxuICByZXR1cm4gbmV3IFJhZGlhbEdyYWRpZW50KCAwLCAwLCAwLCAwLCAwLCByYWRpdXMgKVxyXG4gICAgLmFkZENvbG9yU3RvcCggMC40LCBpbm5lckNvbG9yIClcclxuICAgIC5hZGRDb2xvclN0b3AoIDEsIG91dGVyQ29sb3IgKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0T3JiQ29sb3IoIHdhdmVsZW5ndGg6IG51bWJlciwgcmFkaXVzOiBudW1iZXIgKTogUmFkaWFsR3JhZGllbnQge1xyXG4gIGNvbnN0IGlubmVyQ29sb3IgPSBuZXcgQ29sb3IoIDI1NSwgMjU1LCAyNTUsIDAuNyApO1xyXG4gIGNvbnN0IG91dGVyQ29sb3IgPSBWaXNpYmxlQ29sb3Iud2F2ZWxlbmd0aFRvQ29sb3IoIHdhdmVsZW5ndGgsIFdBVkVMRU5HVEhfVE9fQ09MT1JfT1BUSU9OUyApLndpdGhBbHBoYSggMC41ICk7XHJcbiAgcmV0dXJuIG5ldyBSYWRpYWxHcmFkaWVudCggMCwgMCwgMCwgMCwgMCwgcmFkaXVzIClcclxuICAgIC5hZGRDb2xvclN0b3AoIDAuMjUsIGlubmVyQ29sb3IgKVxyXG4gICAgLmFkZENvbG9yU3RvcCggMSwgb3V0ZXJDb2xvciApO1xyXG59XHJcblxyXG4vKlxyXG4gKiBSZXR1cm5zIHRoZSBjb2xvciBmb3IgdGhlICdzcGFya2xlJyBpbiB0aGUgY2VudGVyIG9mIHRoZSBwaG90b24uXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRTcGFya2xlQ29sb3IoIHdhdmVsZW5ndGg6IG51bWJlciApOiBDb2xvciB7XHJcbiAgaWYgKCB3YXZlbGVuZ3RoIDwgVmlzaWJsZUNvbG9yLk1JTl9XQVZFTEVOR1RIICkge1xyXG4gICAgcmV0dXJuIFVWX1NQQVJLTEVfQ09MT1I7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCB3YXZlbGVuZ3RoID4gVmlzaWJsZUNvbG9yLk1BWF9XQVZFTEVOR1RIICkge1xyXG4gICAgcmV0dXJuIElSX1NQQVJLTEVfQ09MT1I7XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgcmV0dXJuIFNQQVJLTEVfQ09MT1I7XHJcbiAgfVxyXG59XHJcblxyXG5tb2RlbHNPZlRoZUh5ZHJvZ2VuQXRvbS5yZWdpc3RlciggJ1Bob3Rvbk5vZGUnLCBQaG90b25Ob2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsS0FBSyxNQUFNLDZCQUE2QjtBQUUvQyxTQUFTQyxLQUFLLFFBQVEsZ0NBQWdDO0FBQ3RELE9BQU9DLFNBQVMsTUFBNEIsdUNBQXVDO0FBR25GLE9BQU9DLG1CQUFtQixNQUFNLHVEQUF1RDtBQUV2RixPQUFPQyxZQUFZLE1BQU0sNkNBQTZDO0FBQ3RFLFNBQVNDLE1BQU0sRUFBRUMsS0FBSyxFQUFVQyxJQUFJLEVBQWVDLElBQUksRUFBRUMsY0FBYyxFQUFFQyxTQUFTLFFBQVEsbUNBQW1DO0FBQzdILE9BQU9DLE1BQU0sTUFBTSxpQ0FBaUM7QUFDcEQsT0FBT0MsdUJBQXVCLE1BQU0sa0NBQWtDO0FBQ3RFLE9BQU9DLE1BQU0sTUFBTSxvQkFBb0I7QUFDdkMsT0FBT0Msb0JBQW9CLE1BQU0sNEJBQTRCOztBQUU3RDtBQUNBLE1BQU1DLDBCQUEwQixHQUFHLElBQUlULEtBQUssQ0FBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUksQ0FBQztBQUM3RCxNQUFNVSwyQkFBMkIsR0FBRztFQUNsQ0MsT0FBTyxFQUFFRiwwQkFBMEI7RUFDbkNHLE9BQU8sRUFBRUg7QUFDWCxDQUFDOztBQUVEO0FBQ0EsTUFBTUksYUFBYSxHQUFHLElBQUliLEtBQUssQ0FBRSxHQUFHLEVBQUUs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