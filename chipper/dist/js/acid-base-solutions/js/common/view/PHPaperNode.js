// Copyright 2014-2023, University of Colorado Boulder

/**
 * Visual representation for pH paper in the 'Acid-Base Solutions' sim.
 * Origin is at the bottom-center of the paper.
 *
 * @author Andrey Zelenkov (Mlearner)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { Circle, Color, DragListener, Node, Rectangle } from '../../../../scenery/js/imports.js';
import acidBaseSolutions from '../../acidBaseSolutions.js';
import ABSColors from '../ABSColors.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import BooleanIO from '../../../../tandem/js/types/BooleanIO.js';

// constants
const SHOW_ORIGIN = false; // draws a red circle at the origin, for debugging
const PAPER_STROKE = 'rgb(100, 100, 100)';
export default class PHPaperNode extends Node {
  // is the paper animating?

  constructor(pHPaper, toolModeProperty, tandem) {
    // blank paper
    const paperNode = new Rectangle(0, 0, pHPaper.paperSize.width, pHPaper.paperSize.height, {
      fill: ABSColors.PH_PAPER,
      stroke: PAPER_STROKE,
      lineWidth: 0.5,
      // origin at bottom of paper
      centerX: 0,
      bottom: 0
    });

    // portion of the paper that changes color
    const indicatorNode = new Rectangle(0, 0, pHPaper.paperSize.width, 0, {
      stroke: PAPER_STROKE,
      lineWidth: 0.5
    });
    indicatorNode.rotate(Math.PI); // so that indicator rectangle expands upward
    indicatorNode.centerX = 0;
    indicatorNode.top = 0;
    const children = [paperNode, indicatorNode];
    if (SHOW_ORIGIN) {
      children.push(new Circle(2, {
        fill: 'red'
      }));
    }
    super({
      children: children,
      cursor: 'pointer',
      visibleProperty: new DerivedProperty([toolModeProperty], toolMode => toolMode === 'pHPaper', {
        tandem: tandem.createTandem('visibleProperty'),
        phetioValueType: BooleanIO
      }),
      tandem: tandem
    });

    // expand touch area
    this.touchArea = this.localBounds.dilatedXY(10, 10);

    // Constrained dragging
    let clickOffset;
    this.dragListener = new DragListener({
      start: event => {
        clickOffset = this.globalToParentPoint(event.pointer.point).subtract(event.currentTarget.translation);
      },
      drag: event => {
        const v = this.globalToParentPoint(event.pointer.point).subtract(clickOffset);
        pHPaper.positionProperty.value = new Vector2(Utils.clamp(v.x, pHPaper.dragBounds.minX, pHPaper.dragBounds.maxX), Utils.clamp(v.y, pHPaper.dragBounds.minY, pHPaper.dragBounds.maxY));
      },
      tandem: tandem.createTandem('dragListener')
    });
    this.addInputListener(this.dragListener);

    // add observers
    pHPaper.positionProperty.link(position => {
      this.translation = position;
    });
    pHPaper.indicatorHeightProperty.link(height => {
      indicatorNode.setRectHeight(height);
    });
    this.updateColor = () => {
      if (this.visible) {
        indicatorNode.fill = pHToColor(pHPaper.pHProperty.value);
      }
    };
    pHPaper.pHProperty.link(this.updateColor);
    this.pHPaper = pHPaper;
    this.animating = false;
    this.addLinkedElement(pHPaper, {
      tandem: tandem.createTandem(pHPaper.tandem.name)
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
  step(dt) {
    if (!this.dragListener.isPressed) {
      const position = this.pHPaper.positionProperty.value;
      const minY = this.pHPaper.beaker.top + 0.6 * this.pHPaper.paperSize.height;

      // If the paper is fully submerged in the solution, float to the top of the beaker,
      // with part of the paper above the surface.
      if (this.animating && position.y > minY || this.pHPaper.top > this.pHPaper.beaker.top) {
        this.animating = true;
        const dy = dt * 250; // move at a constant speed of 250 pixels per second
        const y = Math.max(minY, position.y - dy);
        this.pHPaper.positionProperty.value = new Vector2(position.x, y);
      }
    } else {
      this.animating = false;
    }

    // Update when this Node becomes visible.
    this.visibleProperty.link(visible => visible && this.updateColor());
  }

  /**
   * Creates an icon that represents the pH paper.
   */
  static createIcon(width, height) {
    return new Node({
      children: [
      // full paper
      new Rectangle(0, 0, width, height, {
        fill: ABSColors.PH_PAPER,
        stroke: PAPER_STROKE,
        lineWidth: 0.5
      }),
      // portion of paper that's colored
      new Rectangle(0, 0.6 * height, width, 0.4 * height, {
        fill: ABSColors.PH[2],
        stroke: PAPER_STROKE,
        lineWidth: 0.5
      })]
    });
  }
}

// Creates a {Color} color for a given {number} pH.
function pHToColor(pH) {
  assert && assert(pH >= 0 && pH <= ABSColors.PH.length);
  let color;
  if (Number.isInteger(pH)) {
    // pH value is an integer, look up color
    color = ABSColors.PH[pH];
  } else {
    // pH value is not an integer, interpolate between 2 closest colors
    const lowerPH = Math.floor(pH);
    const upperPH = lowerPH + 1;
    color = Color.interpolateRGBA(ABSColors.PH[lowerPH], ABSColors.PH[upperPH], pH - lowerPH);
  }
  return color;
}
acidBaseSolutions.register('PHPaperNode', PHPaperNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlZlY3RvcjIiLCJDaXJjbGUiLCJDb2xvciIsIkRyYWdMaXN0ZW5lciIsIk5vZGUiLCJSZWN0YW5nbGUiLCJhY2lkQmFzZVNvbHV0aW9ucyIsIkFCU0NvbG9ycyIsIkRlcml2ZWRQcm9wZXJ0eSIsIkJvb2xlYW5JTyIsIlNIT1dfT1JJR0lOIiwiUEFQRVJfU1RST0tFIiwiUEhQYXBlck5vZGUiLCJjb25zdHJ1Y3RvciIsInBIUGFwZXIiLCJ0b29sTW9kZVByb3BlcnR5IiwidGFuZGVtIiwicGFwZXJOb2RlIiwicGFwZXJTaXplIiwid2lkdGgiLCJoZWlnaHQiLCJmaWxsIiwiUEhfUEFQRVIiLCJzdHJva2UiLCJsaW5lV2lkdGgiLCJjZW50ZXJYIiwiYm90dG9tIiwiaW5kaWNhdG9yTm9kZSIsInJvdGF0ZSIsIk1hdGgiLCJQSSIsInRvcCIsImNoaWxkcmVuIiwicHVzaCIsImN1cnNvciIsInZpc2libGVQcm9wZXJ0eSIsInRvb2xNb2RlIiwiY3JlYXRlVGFuZGVtIiwicGhldGlvVmFsdWVUeXBlIiwidG91Y2hBcmVhIiwibG9jYWxCb3VuZHMiLCJkaWxhdGVkWFkiLCJjbGlja09mZnNldCIsImRyYWdMaXN0ZW5lciIsInN0YXJ0IiwiZXZlbnQiLCJnbG9iYWxUb1BhcmVudFBvaW50IiwicG9pbnRlciIsInBvaW50Iiwic3VidHJhY3QiLCJjdXJyZW50VGFyZ2V0IiwidHJhbnNsYXRpb24iLCJkcmFnIiwidiIsInBvc2l0aW9uUHJvcGVydHkiLCJ2YWx1ZSIsImNsYW1wIiwieCIsImRyYWdCb3VuZHMiLCJtaW5YIiwibWF4WCIsInkiLCJtaW5ZIiwibWF4WSIsImFkZElucHV0TGlzdGVuZXIiLCJsaW5rIiwicG9zaXRpb24iLCJpbmRpY2F0b3JIZWlnaHRQcm9wZXJ0eSIsInNldFJlY3RIZWlnaHQiLCJ1cGRhdGVDb2xvciIsInZpc2libGUiLCJwSFRvQ29sb3IiLCJwSFByb3BlcnR5IiwiYW5pbWF0aW5nIiwiYWRkTGlua2VkRWxlbWVudCIsIm5hbWUiLCJkaXNwb3NlIiwiYXNzZXJ0Iiwic3RlcCIsImR0IiwiaXNQcmVzc2VkIiwiYmVha2VyIiwiZHkiLCJtYXgiLCJjcmVhdGVJY29uIiwiUEgiLCJwSCIsImxlbmd0aCIsImNvbG9yIiwiTnVtYmVyIiwiaXNJbnRlZ2VyIiwibG93ZXJQSCIsImZsb29yIiwidXBwZXJQSCIsImludGVycG9sYXRlUkdCQSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUEhQYXBlck5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlzdWFsIHJlcHJlc2VudGF0aW9uIGZvciBwSCBwYXBlciBpbiB0aGUgJ0FjaWQtQmFzZSBTb2x1dGlvbnMnIHNpbS5cclxuICogT3JpZ2luIGlzIGF0IHRoZSBib3R0b20tY2VudGVyIG9mIHRoZSBwYXBlci5cclxuICpcclxuICogQGF1dGhvciBBbmRyZXkgWmVsZW5rb3YgKE1sZWFybmVyKVxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCB7IENpcmNsZSwgQ29sb3IsIERyYWdMaXN0ZW5lciwgTm9kZSwgUmVjdGFuZ2xlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGFjaWRCYXNlU29sdXRpb25zIGZyb20gJy4uLy4uL2FjaWRCYXNlU29sdXRpb25zLmpzJztcclxuaW1wb3J0IEFCU0NvbG9ycyBmcm9tICcuLi9BQlNDb2xvcnMuanMnO1xyXG5pbXBvcnQgUEhQYXBlciBmcm9tICcuLi9tb2RlbC9QSFBhcGVyLmpzJztcclxuaW1wb3J0IHsgVG9vbE1vZGUgfSBmcm9tICcuL1Rvb2xNb2RlLmpzJztcclxuaW1wb3J0IFN0cmluZ1VuaW9uUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9TdHJpbmdVbmlvblByb3BlcnR5LmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb29sZWFuSU8gZnJvbSAnLi4vLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0Jvb2xlYW5JTy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgU0hPV19PUklHSU4gPSBmYWxzZTsgLy8gZHJhd3MgYSByZWQgY2lyY2xlIGF0IHRoZSBvcmlnaW4sIGZvciBkZWJ1Z2dpbmdcclxuY29uc3QgUEFQRVJfU1RST0tFID0gJ3JnYigxMDAsIDEwMCwgMTAwKSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQSFBhcGVyTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGRyYWdMaXN0ZW5lcjogRHJhZ0xpc3RlbmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdXBkYXRlQ29sb3I6ICgpID0+IHZvaWQ7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBwSFBhcGVyOiBQSFBhcGVyO1xyXG4gIHByaXZhdGUgYW5pbWF0aW5nOiBib29sZWFuOyAvLyBpcyB0aGUgcGFwZXIgYW5pbWF0aW5nP1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHBIUGFwZXI6IFBIUGFwZXIsIHRvb2xNb2RlUHJvcGVydHk6IFN0cmluZ1VuaW9uUHJvcGVydHk8VG9vbE1vZGU+LCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICAvLyBibGFuayBwYXBlclxyXG4gICAgY29uc3QgcGFwZXJOb2RlID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgcEhQYXBlci5wYXBlclNpemUud2lkdGgsIHBIUGFwZXIucGFwZXJTaXplLmhlaWdodCwge1xyXG4gICAgICBmaWxsOiBBQlNDb2xvcnMuUEhfUEFQRVIsXHJcbiAgICAgIHN0cm9rZTogUEFQRVJfU1RST0tFLFxyXG4gICAgICBsaW5lV2lkdGg6IDAuNSxcclxuXHJcbiAgICAgIC8vIG9yaWdpbiBhdCBib3R0b20gb2YgcGFwZXJcclxuICAgICAgY2VudGVyWDogMCxcclxuICAgICAgYm90dG9tOiAwXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gcG9ydGlvbiBvZiB0aGUgcGFwZXIgdGhhdCBjaGFuZ2VzIGNvbG9yXHJcbiAgICBjb25zdCBpbmRpY2F0b3JOb2RlID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgcEhQYXBlci5wYXBlclNpemUud2lkdGgsIDAsIHtcclxuICAgICAgc3Ryb2tlOiBQQVBFUl9TVFJPS0UsXHJcbiAgICAgIGxpbmVXaWR0aDogMC41XHJcbiAgICB9ICk7XHJcbiAgICBpbmRpY2F0b3JOb2RlLnJvdGF0ZSggTWF0aC5QSSApOyAvLyBzbyB0aGF0IGluZGljYXRvciByZWN0YW5nbGUgZXhwYW5kcyB1cHdhcmRcclxuICAgIGluZGljYXRvck5vZGUuY2VudGVyWCA9IDA7XHJcbiAgICBpbmRpY2F0b3JOb2RlLnRvcCA9IDA7XHJcblxyXG4gICAgY29uc3QgY2hpbGRyZW46IE5vZGVbXSA9IFsgcGFwZXJOb2RlLCBpbmRpY2F0b3JOb2RlIF07XHJcbiAgICBpZiAoIFNIT1dfT1JJR0lOICkge1xyXG4gICAgICBjaGlsZHJlbi5wdXNoKCBuZXcgQ2lyY2xlKCAyLCB7IGZpbGw6ICdyZWQnIH0gKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHN1cGVyKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBjaGlsZHJlbixcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcbiAgICAgIHZpc2libGVQcm9wZXJ0eTogbmV3IERlcml2ZWRQcm9wZXJ0eSggWyB0b29sTW9kZVByb3BlcnR5IF0sIHRvb2xNb2RlID0+ICggdG9vbE1vZGUgPT09ICdwSFBhcGVyJyApLCB7XHJcbiAgICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAndmlzaWJsZVByb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogQm9vbGVhbklPXHJcbiAgICAgIH0gKSxcclxuICAgICAgdGFuZGVtOiB0YW5kZW1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBleHBhbmQgdG91Y2ggYXJlYVxyXG4gICAgdGhpcy50b3VjaEFyZWEgPSB0aGlzLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggMTAsIDEwICk7XHJcblxyXG4gICAgLy8gQ29uc3RyYWluZWQgZHJhZ2dpbmdcclxuICAgIGxldCBjbGlja09mZnNldDogVmVjdG9yMjtcclxuICAgIHRoaXMuZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG5cclxuICAgICAgc3RhcnQ6IGV2ZW50ID0+IHtcclxuICAgICAgICBjbGlja09mZnNldCA9IHRoaXMuZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApLnN1YnRyYWN0KCBldmVudC5jdXJyZW50VGFyZ2V0IS50cmFuc2xhdGlvbiApO1xyXG4gICAgICB9LFxyXG5cclxuICAgICAgZHJhZzogZXZlbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IHYgPSB0aGlzLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKS5zdWJ0cmFjdCggY2xpY2tPZmZzZXQgKTtcclxuICAgICAgICBwSFBhcGVyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMihcclxuICAgICAgICAgIFV0aWxzLmNsYW1wKCB2LngsIHBIUGFwZXIuZHJhZ0JvdW5kcy5taW5YLCBwSFBhcGVyLmRyYWdCb3VuZHMubWF4WCApLFxyXG4gICAgICAgICAgVXRpbHMuY2xhbXAoIHYueSwgcEhQYXBlci5kcmFnQm91bmRzLm1pblksIHBIUGFwZXIuZHJhZ0JvdW5kcy5tYXhZICkgKTtcclxuICAgICAgfSxcclxuXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RyYWdMaXN0ZW5lcicgKVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRJbnB1dExpc3RlbmVyKCB0aGlzLmRyYWdMaXN0ZW5lciApO1xyXG5cclxuICAgIC8vIGFkZCBvYnNlcnZlcnNcclxuICAgIHBIUGFwZXIucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBwb3NpdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBwb3NpdGlvbjtcclxuICAgIH0gKTtcclxuXHJcbiAgICBwSFBhcGVyLmluZGljYXRvckhlaWdodFByb3BlcnR5LmxpbmsoIGhlaWdodCA9PiB7XHJcbiAgICAgIGluZGljYXRvck5vZGUuc2V0UmVjdEhlaWdodCggaGVpZ2h0ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy51cGRhdGVDb2xvciA9ICgpID0+IHtcclxuICAgICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcbiAgICAgICAgaW5kaWNhdG9yTm9kZS5maWxsID0gcEhUb0NvbG9yKCBwSFBhcGVyLnBIUHJvcGVydHkudmFsdWUgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHBIUGFwZXIucEhQcm9wZXJ0eS5saW5rKCB0aGlzLnVwZGF0ZUNvbG9yICk7XHJcblxyXG4gICAgdGhpcy5wSFBhcGVyID0gcEhQYXBlcjtcclxuICAgIHRoaXMuYW5pbWF0aW5nID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5hZGRMaW5rZWRFbGVtZW50KCBwSFBhcGVyLCB7XHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggcEhQYXBlci50YW5kZW0ubmFtZSApXHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBpZiAoICF0aGlzLmRyYWdMaXN0ZW5lci5pc1ByZXNzZWQgKSB7XHJcblxyXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMucEhQYXBlci5wb3NpdGlvblByb3BlcnR5LnZhbHVlO1xyXG4gICAgICBjb25zdCBtaW5ZID0gdGhpcy5wSFBhcGVyLmJlYWtlci50b3AgKyAoIDAuNiAqIHRoaXMucEhQYXBlci5wYXBlclNpemUuaGVpZ2h0ICk7XHJcblxyXG4gICAgICAvLyBJZiB0aGUgcGFwZXIgaXMgZnVsbHkgc3VibWVyZ2VkIGluIHRoZSBzb2x1dGlvbiwgZmxvYXQgdG8gdGhlIHRvcCBvZiB0aGUgYmVha2VyLFxyXG4gICAgICAvLyB3aXRoIHBhcnQgb2YgdGhlIHBhcGVyIGFib3ZlIHRoZSBzdXJmYWNlLlxyXG4gICAgICBpZiAoICggdGhpcy5hbmltYXRpbmcgJiYgcG9zaXRpb24ueSA+IG1pblkgKSB8fCAoIHRoaXMucEhQYXBlci50b3AgPiB0aGlzLnBIUGFwZXIuYmVha2VyLnRvcCApICkge1xyXG4gICAgICAgIHRoaXMuYW5pbWF0aW5nID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBkeSA9IGR0ICogMjUwOyAvLyBtb3ZlIGF0IGEgY29uc3RhbnQgc3BlZWQgb2YgMjUwIHBpeGVscyBwZXIgc2Vjb25kXHJcbiAgICAgICAgY29uc3QgeSA9IE1hdGgubWF4KCBtaW5ZLCBwb3NpdGlvbi55IC0gZHkgKTtcclxuICAgICAgICB0aGlzLnBIUGFwZXIucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCBwb3NpdGlvbi54LCB5ICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmFuaW1hdGluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSB3aGVuIHRoaXMgTm9kZSBiZWNvbWVzIHZpc2libGUuXHJcbiAgICB0aGlzLnZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHZpc2libGUgJiYgdGhpcy51cGRhdGVDb2xvcigpICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIGFuIGljb24gdGhhdCByZXByZXNlbnRzIHRoZSBwSCBwYXBlci5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZUljb24oIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyICk6IE5vZGUge1xyXG4gICAgcmV0dXJuIG5ldyBOb2RlKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbXHJcbiAgICAgICAgLy8gZnVsbCBwYXBlclxyXG4gICAgICAgIG5ldyBSZWN0YW5nbGUoIDAsIDAsIHdpZHRoLCBoZWlnaHQsIHsgZmlsbDogQUJTQ29sb3JzLlBIX1BBUEVSLCBzdHJva2U6IFBBUEVSX1NUUk9LRSwgbGluZVdpZHRoOiAwLjUgfSApLFxyXG4gICAgICAgIC8vIHBvcnRpb24gb2YgcGFwZXIgdGhhdCdzIGNvbG9yZWRcclxuICAgICAgICBuZXcgUmVjdGFuZ2xlKCAwLCAwLjYgKiBoZWlnaHQsIHdpZHRoLCAwLjQgKiBoZWlnaHQsIHtcclxuICAgICAgICAgIGZpbGw6IEFCU0NvbG9ycy5QSFsgMiBdLFxyXG4gICAgICAgICAgc3Ryb2tlOiBQQVBFUl9TVFJPS0UsXHJcbiAgICAgICAgICBsaW5lV2lkdGg6IDAuNVxyXG4gICAgICAgIH0gKVxyXG4gICAgICBdXHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG4vLyBDcmVhdGVzIGEge0NvbG9yfSBjb2xvciBmb3IgYSBnaXZlbiB7bnVtYmVyfSBwSC5cclxuZnVuY3Rpb24gcEhUb0NvbG9yKCBwSDogbnVtYmVyICk6IENvbG9yIHtcclxuICBhc3NlcnQgJiYgYXNzZXJ0KCBwSCA+PSAwICYmIHBIIDw9IEFCU0NvbG9ycy5QSC5sZW5ndGggKTtcclxuICBsZXQgY29sb3I7XHJcbiAgaWYgKCBOdW1iZXIuaXNJbnRlZ2VyKCBwSCApICkge1xyXG4gICAgLy8gcEggdmFsdWUgaXMgYW4gaW50ZWdlciwgbG9vayB1cCBjb2xvclxyXG4gICAgY29sb3IgPSBBQlNDb2xvcnMuUEhbIHBIIF07XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgLy8gcEggdmFsdWUgaXMgbm90IGFuIGludGVnZXIsIGludGVycG9sYXRlIGJldHdlZW4gMiBjbG9zZXN0IGNvbG9yc1xyXG4gICAgY29uc3QgbG93ZXJQSCA9IE1hdGguZmxvb3IoIHBIICk7XHJcbiAgICBjb25zdCB1cHBlclBIID0gbG93ZXJQSCArIDE7XHJcbiAgICBjb2xvciA9IENvbG9yLmludGVycG9sYXRlUkdCQSggQUJTQ29sb3JzLlBIWyBsb3dlclBIIF0sIEFCU0NvbG9ycy5QSFsgdXBwZXJQSCBdLCAoIHBIIC0gbG93ZXJQSCApICk7XHJcbiAgfVxyXG4gIHJldHVybiBjb2xvcjtcclxufVxyXG5cclxuYWNpZEJhc2VTb2x1dGlvbnMucmVnaXN0ZXIoICdQSFBhcGVyTm9kZScsIFBIUGFwZXJOb2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsU0FBU0MsTUFBTSxFQUFFQyxLQUFLLEVBQUVDLFlBQVksRUFBRUMsSUFBSSxFQUFFQyxTQUFTLFFBQVEsbUNBQW1DO0FBQ2hHLE9BQU9DLGlCQUFpQixNQUFNLDRCQUE0QjtBQUMxRCxPQUFPQyxTQUFTLE1BQU0saUJBQWlCO0FBS3ZDLE9BQU9DLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQzs7QUFFaEU7QUFDQSxNQUFNQyxXQUFXLEdBQUcsS0FBSyxDQUFDLENBQUM7QUFDM0IsTUFBTUMsWUFBWSxHQUFHLG9CQUFvQjtB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