// Copyright 2022-2023, University of Colorado Boulder

/**
 * Popupable trait
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Andrea Lin (PhET Interactive Simulations)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../axon/js/BooleanProperty.js';
import ScreenView from '../../joist/js/ScreenView.js';
import gracefulBind from '../../phet-core/js/gracefulBind.js';
import optionize from '../../phet-core/js/optionize.js';
import { FocusManager, Node } from '../../scenery/js/imports.js';
import Tandem from '../../tandem/js/Tandem.js';
import sun from './sun.js';
const Popupable = (type, optionsArgPosition) => {
  // eslint-disable-line @typescript-eslint/explicit-module-boundary-types

  return class extends type {
    // The Node to return focus to after the Popupable has been hidden. A reference to this Node is saved when
    // the Popupable is shown. By default, focus is returned to Node that has focus when the Popupable is open
    // but can be overridden with `options.focusOnHideNode`.
    // The node provided to showPopup, with the transform applied
    // Whether the popup is being shown
    // Support the same signature as the type we mix into.  However, we also have our own options, which we assume
    // are passed in the last arg.
    // TODO - We're trying not to use "any", so how can we specify the types more specifically?  See https://github.com/phetsims/sun/issues/777.
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    constructor(...args) {
      super(...args);
      const providedOptions = args[optionsArgPosition] || {};

      // `config` is required for Popupable, to work well with ...args but all fields of the config are optional
      const requiredConfig = args[args.length - 1];
      assert && assert(requiredConfig !== undefined, 'config object is required for Popupable.');
      const showPopup = gracefulBind('phet.joist.sim.showPopup');
      const hidePopup = gracefulBind('phet.joist.sim.hidePopup');
      const options = optionize()({
        showPopup: showPopup,
        hidePopup: hidePopup,
        isModal: true,
        layoutBounds: null,
        tandem: Tandem.OPTIONAL,
        focusOnShowNode: null,
        focusOnHideNode: null
      }, providedOptions);

      // see https://github.com/phetsims/joist/issues/293
      assert && assert(options.isModal, 'Non-modal popups not currently supported');
      this.layoutBounds = options.layoutBounds;
      this._focusOnShowNode = options.focusOnShowNode;
      this._focusOnHideNode = options.focusOnHideNode;
      this._nodeToFocusOnHide = null;
      this.popupParent = new PopupParentNode(this, {
        show: this.show.bind(this),
        hide: this.hide.bind(this),
        layout: this.layout.bind(this)
      });
      this.isShowingProperty = new BooleanProperty(false, {
        tandem: options.tandem.createTandem('isShowingProperty'),
        phetioReadOnly: true,
        phetioFeatured: true
      });
      this.isShowingProperty.lazyLink(isShowing => {
        if (isShowing) {
          options.showPopup(this.popupParent, options.isModal);
        } else {
          options.hidePopup(this.popupParent, options.isModal);
        }
      });
    }
    layout(bounds) {
      if (this.layoutBounds) {
        this.popupParent.matrix = ScreenView.getLayoutMatrix(this.layoutBounds, bounds);
      }
    }
    show() {
      // save a reference before setting isShowingProperty because listeners on the isShowingProperty may modify or
      // clear focus from FocusManager.pdomFocusedNode.
      this._nodeToFocusOnHide = this._focusOnHideNode || FocusManager.pdomFocusedNode;
      this.isShowingProperty.value = true;

      // after it is shown, move focus to the focusOnShownNode, presumably moving focus into the Popupable content
      if (this._focusOnShowNode && this._focusOnShowNode.focusable) {
        this._focusOnShowNode.focus();
      }
    }

    /**
     * Hide the popup. If you create a new popup next time you show(), be sure to dispose this popup instead.
     */
    hide() {
      this.interruptSubtreeInput();
      this.isShowingProperty.value = false;

      // return focus to the Node that had focus when the Popupable was opened (or the focusOnHideNode if provided)
      if (this._nodeToFocusOnHide && this._nodeToFocusOnHide.focusable) {
        this._nodeToFocusOnHide.focus();
      }
    }
    get focusOnHideNode() {
      return this._focusOnHideNode;
    }

    /**
     * Releases references
     */
    dispose() {
      this.hide();
      this.isShowingProperty.dispose();
      super.dispose();
    }
  };
};
class PopupParentNode extends Node {
  constructor(popupableNode, providedOptions) {
    const options = optionize()({
      children: [popupableNode]
    }, providedOptions);
    super(options);
    this.show = options.show;
    this.hide = options.hide;
    this.layout = options.layout;
  }
}

// Export a type that lets you check if your Node is composed with Popupable
const wrapper = () => Popupable(Node, 0);
sun.register('Popupable', Popupable);
export default Popupable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJTY3JlZW5WaWV3IiwiZ3JhY2VmdWxCaW5kIiwib3B0aW9uaXplIiwiRm9jdXNNYW5hZ2VyIiwiTm9kZSIsIlRhbmRlbSIsInN1biIsIlBvcHVwYWJsZSIsInR5cGUiLCJvcHRpb25zQXJnUG9zaXRpb24iLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJwcm92aWRlZE9wdGlvbnMiLCJyZXF1aXJlZENvbmZpZyIsImxlbmd0aCIsImFzc2VydCIsInVuZGVmaW5lZCIsInNob3dQb3B1cCIsImhpZGVQb3B1cCIsIm9wdGlvbnMiLCJpc01vZGFsIiwibGF5b3V0Qm91bmRzIiwidGFuZGVtIiwiT1BUSU9OQUwiLCJmb2N1c09uU2hvd05vZGUiLCJmb2N1c09uSGlkZU5vZGUiLCJfZm9jdXNPblNob3dOb2RlIiwiX2ZvY3VzT25IaWRlTm9kZSIsIl9ub2RlVG9Gb2N1c09uSGlkZSIsInBvcHVwUGFyZW50IiwiUG9wdXBQYXJlbnROb2RlIiwic2hvdyIsImJpbmQiLCJoaWRlIiwibGF5b3V0IiwiaXNTaG93aW5nUHJvcGVydHkiLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9SZWFkT25seSIsInBoZXRpb0ZlYXR1cmVkIiwibGF6eUxpbmsiLCJpc1Nob3dpbmciLCJib3VuZHMiLCJtYXRyaXgiLCJnZXRMYXlvdXRNYXRyaXgiLCJwZG9tRm9jdXNlZE5vZGUiLCJ2YWx1ZSIsImZvY3VzYWJsZSIsImZvY3VzIiwiaW50ZXJydXB0U3VidHJlZUlucHV0IiwiZGlzcG9zZSIsInBvcHVwYWJsZU5vZGUiLCJjaGlsZHJlbiIsIndyYXBwZXIiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBvcHVwYWJsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBQb3B1cGFibGUgdHJhaXRcclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEFuZHJlYSBMaW4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgU2NyZWVuVmlldyBmcm9tICcuLi8uLi9qb2lzdC9qcy9TY3JlZW5WaWV3LmpzJztcclxuaW1wb3J0IGdyYWNlZnVsQmluZCBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvZ3JhY2VmdWxCaW5kLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IENvbnN0cnVjdG9yIGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9Db25zdHJ1Y3Rvci5qcyc7XHJcbmltcG9ydCBQaWNrT3B0aW9uYWwgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tPcHRpb25hbC5qcyc7XHJcbmltcG9ydCB7IEZvY3VzTWFuYWdlciwgTm9kZSwgTm9kZU9wdGlvbnMgfSBmcm9tICcuLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgc3VuIGZyb20gJy4vc3VuLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIERvbid0IHVzZSBQb3B1cGFibGVOb2RlIGhlcmUgKGl0IGNyZWF0ZXMuLi4gYSBsb3Qgb2YgdHlwZSBpc3N1ZXMgYW5kIGNpcmN1bGFyaXR5KVxyXG4gIHNob3dQb3B1cD86ICggcG9wdXA6IE5vZGUsIGlzTW9kYWw6IGJvb2xlYW4gKSA9PiB2b2lkO1xyXG4gIGhpZGVQb3B1cD86ICggcG9wdXA6IE5vZGUsIGlzTW9kYWw6IGJvb2xlYW4gKSA9PiB2b2lkO1xyXG5cclxuICAvLyBtb2RhbCBwb3B1cHMgcHJldmVudCBpbnRlcmFjdGlvbiB3aXRoIHRoZSByZXN0IG9mIHRoZSBzaW0gd2hpbGUgb3BlblxyXG4gIGlzTW9kYWw/OiBib29sZWFuO1xyXG5cclxuICAvLyBJZiBkZXNpcmVkLCB0aGUgbGF5b3V0Qm91bmRzIHRoYXQgc2hvdWxkIGJlIHVzZWQgZm9yIGxheW91dFxyXG4gIGxheW91dEJvdW5kcz86IEJvdW5kczIgfCBudWxsO1xyXG5cclxuICAvLyBUaGUgTm9kZSB0aGF0IHJlY2VpdmVzIGZvY3VzIHdoZW4gdGhlIFBvcHVwYWJsZSBpcyBzaG93bi4gSWYgbnVsbCwgZm9jdXMgaXMgbm90IHNldC5cclxuICBmb2N1c09uU2hvd05vZGU/OiBOb2RlIHwgbnVsbDtcclxuXHJcbiAgLy8gVGhlIE5vZGUgdGhhdCByZWNlaXZlcyBmb2N1cyB3aGVuIHRoZSBQb3B1cGFibGUgaXMgY2xvc2VkLiBJZiBudWxsLCBmb2N1cyB3aWxsIHJldHVyblxyXG4gIC8vIHRvIHRoZSBOb2RlIHRoYXQgaGFkIGZvY3VzIHdoZW4gdGhlIERpYWxvZyBvcGVuZWQuXHJcbiAgZm9jdXNPbkhpZGVOb2RlPzogTm9kZSB8IG51bGw7XHJcbn07XHJcbmV4cG9ydCB0eXBlIFBvcHVwYWJsZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tPcHRpb25hbDxOb2RlT3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuY29uc3QgUG9wdXBhYmxlID0gPFN1cGVyVHlwZSBleHRlbmRzIENvbnN0cnVjdG9yPE5vZGU+PiggdHlwZTogU3VwZXJUeXBlLCBvcHRpb25zQXJnUG9zaXRpb246IG51bWJlciApID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvZXhwbGljaXQtbW9kdWxlLWJvdW5kYXJ5LXR5cGVzXHJcblxyXG4gIHJldHVybiBjbGFzcyBleHRlbmRzIHR5cGUge1xyXG5cclxuICAgIHB1YmxpYyByZWFkb25seSBsYXlvdXRCb3VuZHM6IEJvdW5kczIgfCBudWxsO1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2ZvY3VzT25TaG93Tm9kZTogTm9kZSB8IG51bGw7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9mb2N1c09uSGlkZU5vZGU6IE5vZGUgfCBudWxsO1xyXG5cclxuICAgIC8vIFRoZSBOb2RlIHRvIHJldHVybiBmb2N1cyB0byBhZnRlciB0aGUgUG9wdXBhYmxlIGhhcyBiZWVuIGhpZGRlbi4gQSByZWZlcmVuY2UgdG8gdGhpcyBOb2RlIGlzIHNhdmVkIHdoZW5cclxuICAgIC8vIHRoZSBQb3B1cGFibGUgaXMgc2hvd24uIEJ5IGRlZmF1bHQsIGZvY3VzIGlzIHJldHVybmVkIHRvIE5vZGUgdGhhdCBoYXMgZm9jdXMgd2hlbiB0aGUgUG9wdXBhYmxlIGlzIG9wZW5cclxuICAgIC8vIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbiB3aXRoIGBvcHRpb25zLmZvY3VzT25IaWRlTm9kZWAuXHJcbiAgICBwcml2YXRlIF9ub2RlVG9Gb2N1c09uSGlkZTogTm9kZSB8IG51bGw7XHJcblxyXG4gICAgLy8gVGhlIG5vZGUgcHJvdmlkZWQgdG8gc2hvd1BvcHVwLCB3aXRoIHRoZSB0cmFuc2Zvcm0gYXBwbGllZFxyXG4gICAgcHVibGljIHJlYWRvbmx5IHBvcHVwUGFyZW50OiBOb2RlO1xyXG5cclxuICAgIC8vIFdoZXRoZXIgdGhlIHBvcHVwIGlzIGJlaW5nIHNob3duXHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgaXNTaG93aW5nUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAgIC8vIFN1cHBvcnQgdGhlIHNhbWUgc2lnbmF0dXJlIGFzIHRoZSB0eXBlIHdlIG1peCBpbnRvLiAgSG93ZXZlciwgd2UgYWxzbyBoYXZlIG91ciBvd24gb3B0aW9ucywgd2hpY2ggd2UgYXNzdW1lXHJcbiAgICAvLyBhcmUgcGFzc2VkIGluIHRoZSBsYXN0IGFyZy5cclxuICAgIC8vIFRPRE8gLSBXZSdyZSB0cnlpbmcgbm90IHRvIHVzZSBcImFueVwiLCBzbyBob3cgY2FuIHdlIHNwZWNpZnkgdGhlIHR5cGVzIG1vcmUgc3BlY2lmaWNhbGx5PyAgU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zdW4vaXNzdWVzLzc3Ny5cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoIC4uLmFyZ3M6IGFueVtdICkge1xyXG4gICAgICBzdXBlciggLi4uYXJncyApO1xyXG5cclxuICAgICAgY29uc3QgcHJvdmlkZWRPcHRpb25zID0gKCBhcmdzWyBvcHRpb25zQXJnUG9zaXRpb24gXSB8fCB7fSApIGFzIFBvcHVwYWJsZU9wdGlvbnM7XHJcblxyXG4gICAgICAvLyBgY29uZmlnYCBpcyByZXF1aXJlZCBmb3IgUG9wdXBhYmxlLCB0byB3b3JrIHdlbGwgd2l0aCAuLi5hcmdzIGJ1dCBhbGwgZmllbGRzIG9mIHRoZSBjb25maWcgYXJlIG9wdGlvbmFsXHJcbiAgICAgIGNvbnN0IHJlcXVpcmVkQ29uZmlnID0gYXJnc1sgYXJncy5sZW5ndGggLSAxIF07XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHJlcXVpcmVkQ29uZmlnICE9PSB1bmRlZmluZWQsICdjb25maWcgb2JqZWN0IGlzIHJlcXVpcmVkIGZvciBQb3B1cGFibGUuJyApO1xyXG5cclxuICAgICAgY29uc3Qgc2hvd1BvcHVwID0gZ3JhY2VmdWxCaW5kKCAncGhldC5qb2lzdC5zaW0uc2hvd1BvcHVwJyApIGFzIEV4Y2x1ZGU8UG9wdXBhYmxlT3B0aW9uc1sgJ3Nob3dQb3B1cCcgXSwgdW5kZWZpbmVkPjtcclxuICAgICAgY29uc3QgaGlkZVBvcHVwID0gZ3JhY2VmdWxCaW5kKCAncGhldC5qb2lzdC5zaW0uaGlkZVBvcHVwJyApIGFzIEV4Y2x1ZGU8UG9wdXBhYmxlT3B0aW9uc1sgJ2hpZGVQb3B1cCcgXSwgdW5kZWZpbmVkPjtcclxuXHJcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8UG9wdXBhYmxlT3B0aW9ucz4oKSgge1xyXG4gICAgICAgIHNob3dQb3B1cDogc2hvd1BvcHVwLFxyXG4gICAgICAgIGhpZGVQb3B1cDogaGlkZVBvcHVwLFxyXG4gICAgICAgIGlzTW9kYWw6IHRydWUsXHJcbiAgICAgICAgbGF5b3V0Qm91bmRzOiBudWxsLFxyXG4gICAgICAgIHRhbmRlbTogVGFuZGVtLk9QVElPTkFMLFxyXG4gICAgICAgIGZvY3VzT25TaG93Tm9kZTogbnVsbCxcclxuICAgICAgICBmb2N1c09uSGlkZU5vZGU6IG51bGxcclxuICAgICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaXN0L2lzc3Vlcy8yOTNcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy5pc01vZGFsLCAnTm9uLW1vZGFsIHBvcHVwcyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCcgKTtcclxuXHJcbiAgICAgIHRoaXMubGF5b3V0Qm91bmRzID0gb3B0aW9ucy5sYXlvdXRCb3VuZHM7XHJcbiAgICAgIHRoaXMuX2ZvY3VzT25TaG93Tm9kZSA9IG9wdGlvbnMuZm9jdXNPblNob3dOb2RlO1xyXG4gICAgICB0aGlzLl9mb2N1c09uSGlkZU5vZGUgPSBvcHRpb25zLmZvY3VzT25IaWRlTm9kZTtcclxuICAgICAgdGhpcy5fbm9kZVRvRm9jdXNPbkhpZGUgPSBudWxsO1xyXG4gICAgICB0aGlzLnBvcHVwUGFyZW50ID0gbmV3IFBvcHVwUGFyZW50Tm9kZSggdGhpcywge1xyXG4gICAgICAgIHNob3c6IHRoaXMuc2hvdy5iaW5kKCB0aGlzICksXHJcbiAgICAgICAgaGlkZTogdGhpcy5oaWRlLmJpbmQoIHRoaXMgKSxcclxuICAgICAgICBsYXlvdXQ6IHRoaXMubGF5b3V0LmJpbmQoIHRoaXMgKVxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICB0aGlzLmlzU2hvd2luZ1Byb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UsIHtcclxuICAgICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2lzU2hvd2luZ1Byb3BlcnR5JyApLFxyXG4gICAgICAgIHBoZXRpb1JlYWRPbmx5OiB0cnVlLFxyXG4gICAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICAgIHRoaXMuaXNTaG93aW5nUHJvcGVydHkubGF6eUxpbmsoIGlzU2hvd2luZyA9PiB7XHJcbiAgICAgICAgaWYgKCBpc1Nob3dpbmcgKSB7XHJcbiAgICAgICAgICBvcHRpb25zLnNob3dQb3B1cCggdGhpcy5wb3B1cFBhcmVudCwgb3B0aW9ucy5pc01vZGFsICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgb3B0aW9ucy5oaWRlUG9wdXAoIHRoaXMucG9wdXBQYXJlbnQsIG9wdGlvbnMuaXNNb2RhbCApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsYXlvdXQoIGJvdW5kczogQm91bmRzMiApOiB2b2lkIHtcclxuICAgICAgaWYgKCB0aGlzLmxheW91dEJvdW5kcyApIHtcclxuICAgICAgICB0aGlzLnBvcHVwUGFyZW50Lm1hdHJpeCA9IFNjcmVlblZpZXcuZ2V0TGF5b3V0TWF0cml4KCB0aGlzLmxheW91dEJvdW5kcywgYm91bmRzICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2hvdygpOiB2b2lkIHtcclxuXHJcbiAgICAgIC8vIHNhdmUgYSByZWZlcmVuY2UgYmVmb3JlIHNldHRpbmcgaXNTaG93aW5nUHJvcGVydHkgYmVjYXVzZSBsaXN0ZW5lcnMgb24gdGhlIGlzU2hvd2luZ1Byb3BlcnR5IG1heSBtb2RpZnkgb3JcclxuICAgICAgLy8gY2xlYXIgZm9jdXMgZnJvbSBGb2N1c01hbmFnZXIucGRvbUZvY3VzZWROb2RlLlxyXG4gICAgICB0aGlzLl9ub2RlVG9Gb2N1c09uSGlkZSA9IHRoaXMuX2ZvY3VzT25IaWRlTm9kZSB8fCBGb2N1c01hbmFnZXIucGRvbUZvY3VzZWROb2RlO1xyXG4gICAgICB0aGlzLmlzU2hvd2luZ1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICAgIC8vIGFmdGVyIGl0IGlzIHNob3duLCBtb3ZlIGZvY3VzIHRvIHRoZSBmb2N1c09uU2hvd25Ob2RlLCBwcmVzdW1hYmx5IG1vdmluZyBmb2N1cyBpbnRvIHRoZSBQb3B1cGFibGUgY29udGVudFxyXG4gICAgICBpZiAoIHRoaXMuX2ZvY3VzT25TaG93Tm9kZSAmJiB0aGlzLl9mb2N1c09uU2hvd05vZGUuZm9jdXNhYmxlICkge1xyXG4gICAgICAgIHRoaXMuX2ZvY3VzT25TaG93Tm9kZS5mb2N1cygpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIaWRlIHRoZSBwb3B1cC4gSWYgeW91IGNyZWF0ZSBhIG5ldyBwb3B1cCBuZXh0IHRpbWUgeW91IHNob3coKSwgYmUgc3VyZSB0byBkaXNwb3NlIHRoaXMgcG9wdXAgaW5zdGVhZC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGhpZGUoKTogdm9pZCB7XHJcbiAgICAgIHRoaXMuaW50ZXJydXB0U3VidHJlZUlucHV0KCk7XHJcblxyXG4gICAgICB0aGlzLmlzU2hvd2luZ1Byb3BlcnR5LnZhbHVlID0gZmFsc2U7XHJcblxyXG4gICAgICAvLyByZXR1cm4gZm9jdXMgdG8gdGhlIE5vZGUgdGhhdCBoYWQgZm9jdXMgd2hlbiB0aGUgUG9wdXBhYmxlIHdhcyBvcGVuZWQgKG9yIHRoZSBmb2N1c09uSGlkZU5vZGUgaWYgcHJvdmlkZWQpXHJcbiAgICAgIGlmICggdGhpcy5fbm9kZVRvRm9jdXNPbkhpZGUgJiYgdGhpcy5fbm9kZVRvRm9jdXNPbkhpZGUuZm9jdXNhYmxlICkge1xyXG4gICAgICAgIHRoaXMuX25vZGVUb0ZvY3VzT25IaWRlLmZvY3VzKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0IGZvY3VzT25IaWRlTm9kZSgpOiBOb2RlIHwgbnVsbCB7XHJcbiAgICAgIHJldHVybiB0aGlzLl9mb2N1c09uSGlkZU5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWxlYXNlcyByZWZlcmVuY2VzXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgICB0aGlzLmhpZGUoKTtcclxuXHJcbiAgICAgIHRoaXMuaXNTaG93aW5nUHJvcGVydHkuZGlzcG9zZSgpO1xyXG5cclxuICAgICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gICAgfVxyXG4gIH07XHJcbn07XHJcblxyXG50eXBlIFBvcHVwYWJsZVBhcmVudE5vZGVTZWxmT3B0aW9ucyA9IHtcclxuICBzaG93OiAoKSA9PiB2b2lkO1xyXG4gIGhpZGU6ICgpID0+IHZvaWQ7XHJcbiAgbGF5b3V0OiAoIGJvdW5kczogQm91bmRzMiApID0+IHZvaWQ7XHJcbn07XHJcbnR5cGUgUG9wdXBhYmxlUGFyZW50Tm9kZU9wdGlvbnMgPSBQb3B1cGFibGVQYXJlbnROb2RlU2VsZk9wdGlvbnMgJiBOb2RlT3B0aW9ucztcclxuXHJcbmNsYXNzIFBvcHVwUGFyZW50Tm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgc2hvdzogUG9wdXBhYmxlUGFyZW50Tm9kZVNlbGZPcHRpb25zWyAnc2hvdycgXTtcclxuICBwdWJsaWMgcmVhZG9ubHkgaGlkZTogUG9wdXBhYmxlUGFyZW50Tm9kZVNlbGZPcHRpb25zWyAnaGlkZScgXTtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGF5b3V0OiBQb3B1cGFibGVQYXJlbnROb2RlU2VsZk9wdGlvbnNbICdsYXlvdXQnIF07XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcG9wdXBhYmxlTm9kZTogTm9kZSwgcHJvdmlkZWRPcHRpb25zOiBQb3B1cGFibGVQYXJlbnROb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFBvcHVwYWJsZVBhcmVudE5vZGVPcHRpb25zLCBQb3B1cGFibGVQYXJlbnROb2RlU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIHBvcHVwYWJsZU5vZGUgXVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLnNob3cgPSBvcHRpb25zLnNob3c7XHJcbiAgICB0aGlzLmhpZGUgPSBvcHRpb25zLmhpZGU7XHJcbiAgICB0aGlzLmxheW91dCA9IG9wdGlvbnMubGF5b3V0O1xyXG4gIH1cclxufVxyXG5cclxuLy8gRXhwb3J0IGEgdHlwZSB0aGF0IGxldHMgeW91IGNoZWNrIGlmIHlvdXIgTm9kZSBpcyBjb21wb3NlZCB3aXRoIFBvcHVwYWJsZVxyXG5jb25zdCB3cmFwcGVyID0gKCkgPT4gUG9wdXBhYmxlKCBOb2RlLCAwICk7XHJcbmV4cG9ydCB0eXBlIFBvcHVwYWJsZU5vZGUgPSBJbnN0YW5jZVR5cGU8UmV0dXJuVHlwZTx0eXBlb2Ygd3JhcHBlcj4+ICYgTm9kZTtcclxuXHJcbnN1bi5yZWdpc3RlciggJ1BvcHVwYWJsZScsIFBvcHVwYWJsZSApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgUG9wdXBhYmxlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7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