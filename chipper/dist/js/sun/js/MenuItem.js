// Copyright 2017-2023, University of Colorado Boulder

/**
 * MenuItem is an item in the PhetMenu.
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import PhetFont from '../../scenery-phet/js/PhetFont.js';
import { allowLinksProperty, FireListener, ManualConstraint, Node, Path, Rectangle, Text, Voicing, WidthSizable } from '../../scenery/js/imports.js';
import checkSolidShape from '../../sherpa/js/fontawesome-5/checkSolidShape.js';
import EventType from '../../tandem/js/EventType.js';
import Tandem from '../../tandem/js/Tandem.js';
import sun from './sun.js';
import optionize from '../../phet-core/js/optionize.js';
// the check mark used for toggle-able menu items
const CHECK_MARK_NODE = new Path(checkSolidShape, {
  fill: 'rgba(0,0,0,0.7)',
  maxWidth: 15.5
});

// constants
const FONT_SIZE = 18;
const HIGHLIGHT_COLOR = '#a6d2f4';
const MAX_ITEM_WIDTH = 400;
const CHECK_PADDING = 2; // padding between the check and text
const CHECK_OFFSET = CHECK_MARK_NODE.width + CHECK_PADDING; // offset that includes the check mark's width and padding
const LEFT_X_MARGIN = 2;
const RIGHT_X_MARGIN = 5;
const Y_MARGIN = 3;
const CORNER_RADIUS = 5;
export default class MenuItem extends WidthSizable(Voicing(Node)) {
  // if this MenuItem will be shown in the menu. Some items are just created to maintain a
  // consistent PhET-iO API for all sim runtimes, see https://github.com/phetsims/phet-io/issues/1457

  // if there should be a horizontal separator between this MenuItem and the one above it

  /**
   * @param closeCallback - called when firing the menu item, most likely this should close the PhetMenu.
   * @param labelStringProperty - label for the menu item
   * @param callback - called when the menu item is selected
   * @param present - see present field
   * @param shouldBeHiddenWhenLinksAreNotAllowed
   * @param [providedOptions]
   */
  constructor(closeCallback, labelStringProperty, callback, present, shouldBeHiddenWhenLinksAreNotAllowed, providedOptions) {
    // Extend the object with defaults.
    const options = optionize()({
      // SelfOptions
      separatorBefore: false,
      checkedProperty: null,
      textFill: 'black',
      // VoicingOptions
      cursor: 'pointer',
      // phet-io
      tandem: Tandem.OPTIONAL,
      phetioDocumentation: 'Item buttons shown in a popup menu',
      phetioEventType: EventType.USER,
      // pdom
      tagName: 'button',
      containerTagName: 'li',
      containerAriaRole: 'none',
      // this is required for JAWS to handle focus correctly, see https://github.com/phetsims/john-travoltage/issues/225
      ariaRole: 'menuitem',
      // 'menuitem' role does not get click events on iOS VoiceOver, position siblings so that
      // we get Pointer events instead
      positionInPDOM: true
    }, providedOptions);
    super();
    if (shouldBeHiddenWhenLinksAreNotAllowed) {
      this.setVisibleProperty(allowLinksProperty);
    }
    const labelStringListener = labelString => {
      this.innerContent = labelString;
      this.voicingNameResponse = labelString;
    };
    labelStringProperty.link(labelStringListener);
    this.present = present;
    const labelText = new Text(labelStringProperty, {
      font: new PhetFont(FONT_SIZE),
      fill: options.textFill,
      maxWidth: MAX_ITEM_WIDTH
    });
    const highlight = new Rectangle({
      cornerRadius: CORNER_RADIUS
    });
    labelText.boundsProperty.link(textBounds => {
      this.localMinimumWidth = textBounds.width + LEFT_X_MARGIN + RIGHT_X_MARGIN + CHECK_OFFSET;
      highlight.rectHeight = textBounds.height + Y_MARGIN + Y_MARGIN;
    });
    this.localPreferredWidthProperty.link(preferredWidth => {
      if (preferredWidth === null) {
        preferredWidth = this.localMinimumWidth;
      }
      if (preferredWidth) {
        highlight.rectWidth = preferredWidth;
      }
    });
    this.addChild(highlight);
    this.addChild(labelText);
    ManualConstraint.create(this, [highlight, labelText], (highlightProxy, labelTextProxy) => {
      labelTextProxy.left = highlightProxy.left + LEFT_X_MARGIN + CHECK_OFFSET; // labelStringProperty is left aligned
      labelTextProxy.centerY = highlightProxy.centerY;
    });
    this.addInputListener({
      enter: () => {
        highlight.fill = HIGHLIGHT_COLOR;
      },
      exit: () => {
        highlight.fill = null;
      }
    });
    this.addInputListener(new FireListener({
      tandem: options.tandem.createTandem('fireListener'),
      fire: event => {
        closeCallback(event);
        callback(event);
      }
    }));
    this.separatorBefore = options.separatorBefore;

    // Optionally add a check mark and hook up visibility changes.
    let checkedListener = null;
    if (options.checkedProperty) {
      const checkMarkWrapper = new Node({
        children: [CHECK_MARK_NODE],
        right: labelText.left - CHECK_PADDING,
        centerY: labelText.centerY
      });
      checkedListener = isChecked => {
        checkMarkWrapper.visible = isChecked;
      };
      options.checkedProperty.link(checkedListener);
      this.addChild(checkMarkWrapper);
    }
    this.mutate(options);
    this.disposeMenuItem = () => {
      if (options.checkedProperty && checkedListener && options.checkedProperty.hasListener(checkedListener)) {
        options.checkedProperty.unlink(checkedListener);
      }
      if (labelStringProperty.hasListener(labelStringListener)) {
        labelStringProperty.unlink(labelStringListener);
      }
      labelText.dispose();
    };
  }
  dispose() {
    this.disposeMenuItem();
    super.dispose();
  }
}
sun.register('MenuItem', MenuItem);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQaGV0Rm9udCIsImFsbG93TGlua3NQcm9wZXJ0eSIsIkZpcmVMaXN0ZW5lciIsIk1hbnVhbENvbnN0cmFpbnQiLCJOb2RlIiwiUGF0aCIsIlJlY3RhbmdsZSIsIlRleHQiLCJWb2ljaW5nIiwiV2lkdGhTaXphYmxlIiwiY2hlY2tTb2xpZFNoYXBlIiwiRXZlbnRUeXBlIiwiVGFuZGVtIiwic3VuIiwib3B0aW9uaXplIiwiQ0hFQ0tfTUFSS19OT0RFIiwiZmlsbCIsIm1heFdpZHRoIiwiRk9OVF9TSVpFIiwiSElHSExJR0hUX0NPTE9SIiwiTUFYX0lURU1fV0lEVEgiLCJDSEVDS19QQURESU5HIiwiQ0hFQ0tfT0ZGU0VUIiwid2lkdGgiLCJMRUZUX1hfTUFSR0lOIiwiUklHSFRfWF9NQVJHSU4iLCJZX01BUkdJTiIsIkNPUk5FUl9SQURJVVMiLCJNZW51SXRlbSIsImNvbnN0cnVjdG9yIiwiY2xvc2VDYWxsYmFjayIsImxhYmVsU3RyaW5nUHJvcGVydHkiLCJjYWxsYmFjayIsInByZXNlbnQiLCJzaG91bGRCZUhpZGRlbldoZW5MaW5rc0FyZU5vdEFsbG93ZWQiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwic2VwYXJhdG9yQmVmb3JlIiwiY2hlY2tlZFByb3BlcnR5IiwidGV4dEZpbGwiLCJjdXJzb3IiLCJ0YW5kZW0iLCJPUFRJT05BTCIsInBoZXRpb0RvY3VtZW50YXRpb24iLCJwaGV0aW9FdmVudFR5cGUiLCJVU0VSIiwidGFnTmFtZSIsImNvbnRhaW5lclRhZ05hbWUiLCJjb250YWluZXJBcmlhUm9sZSIsImFyaWFSb2xlIiwicG9zaXRpb25JblBET00iLCJzZXRWaXNpYmxlUHJvcGVydHkiLCJsYWJlbFN0cmluZ0xpc3RlbmVyIiwibGFiZWxTdHJpbmciLCJpbm5lckNvbnRlbnQiLCJ2b2ljaW5nTmFtZVJlc3BvbnNlIiwibGluayIsImxhYmVsVGV4dCIsImZvbnQiLCJoaWdobGlnaHQiLCJjb3JuZXJSYWRpdXMiLCJib3VuZHNQcm9wZXJ0eSIsInRleHRCb3VuZHMiLCJsb2NhbE1pbmltdW1XaWR0aCIsInJlY3RIZWlnaHQiLCJoZWlnaHQiLCJsb2NhbFByZWZlcnJlZFdpZHRoUHJvcGVydHkiLCJwcmVmZXJyZWRXaWR0aCIsInJlY3RXaWR0aCIsImFkZENoaWxkIiwiY3JlYXRlIiwiaGlnaGxpZ2h0UHJveHkiLCJsYWJlbFRleHRQcm94eSIsImxlZnQiLCJjZW50ZXJZIiwiYWRkSW5wdXRMaXN0ZW5lciIsImVudGVyIiwiZXhpdCIsImNyZWF0ZVRhbmRlbSIsImZpcmUiLCJldmVudCIsImNoZWNrZWRMaXN0ZW5lciIsImNoZWNrTWFya1dyYXBwZXIiLCJjaGlsZHJlbiIsInJpZ2h0IiwiaXNDaGVja2VkIiwidmlzaWJsZSIsIm11dGF0ZSIsImRpc3Bvc2VNZW51SXRlbSIsImhhc0xpc3RlbmVyIiwidW5saW5rIiwiZGlzcG9zZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTWVudUl0ZW0udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTctMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTWVudUl0ZW0gaXMgYW4gaXRlbSBpbiB0aGUgUGhldE1lbnUuXHJcbiAqXHJcbiAqIEBhdXRob3IgTWljaGFlbCBLYXV6bWFubiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgVFByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvVFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IGFsbG93TGlua3NQcm9wZXJ0eSwgRmlyZUxpc3RlbmVyLCBNYW51YWxDb25zdHJhaW50LCBOb2RlLCBOb2RlT3B0aW9ucywgUGF0aCwgUmVjdGFuZ2xlLCBTY2VuZXJ5RXZlbnQsIFRleHQsIFRQYWludCwgVm9pY2luZywgVm9pY2luZ09wdGlvbnMsIFdpZHRoU2l6YWJsZSB9IGZyb20gJy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBjaGVja1NvbGlkU2hhcGUgZnJvbSAnLi4vLi4vc2hlcnBhL2pzL2ZvbnRhd2Vzb21lLTUvY2hlY2tTb2xpZFNoYXBlLmpzJztcclxuaW1wb3J0IEV2ZW50VHlwZSBmcm9tICcuLi8uLi90YW5kZW0vanMvRXZlbnRUeXBlLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IHN1biBmcm9tICcuL3N1bi5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuXHJcbi8vIHRoZSBjaGVjayBtYXJrIHVzZWQgZm9yIHRvZ2dsZS1hYmxlIG1lbnUgaXRlbXNcclxuY29uc3QgQ0hFQ0tfTUFSS19OT0RFID0gbmV3IFBhdGgoIGNoZWNrU29saWRTaGFwZSwge1xyXG4gIGZpbGw6ICdyZ2JhKDAsMCwwLDAuNyknLFxyXG4gIG1heFdpZHRoOiAxNS41XHJcbn0gKTtcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBGT05UX1NJWkUgPSAxODtcclxuY29uc3QgSElHSExJR0hUX0NPTE9SID0gJyNhNmQyZjQnO1xyXG5jb25zdCBNQVhfSVRFTV9XSURUSCA9IDQwMDtcclxuY29uc3QgQ0hFQ0tfUEFERElORyA9IDI7ICAvLyBwYWRkaW5nIGJldHdlZW4gdGhlIGNoZWNrIGFuZCB0ZXh0XHJcbmNvbnN0IENIRUNLX09GRlNFVCA9IENIRUNLX01BUktfTk9ERS53aWR0aCArIENIRUNLX1BBRERJTkc7IC8vIG9mZnNldCB0aGF0IGluY2x1ZGVzIHRoZSBjaGVjayBtYXJrJ3Mgd2lkdGggYW5kIHBhZGRpbmdcclxuY29uc3QgTEVGVF9YX01BUkdJTiA9IDI7XHJcbmNvbnN0IFJJR0hUX1hfTUFSR0lOID0gNTtcclxuY29uc3QgWV9NQVJHSU4gPSAzO1xyXG5jb25zdCBDT1JORVJfUkFESVVTID0gNTtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcblxyXG4gIC8vIGlmIHRoZXJlIHNob3VsZCBiZSBhIGhvcml6b250YWwgc2VwYXJhdG9yIGJldHdlZW4gdGhpcyBNZW51SXRlbSBhbmQgdGhlIG9uZSBpbW1lZGlhdGVseSBwcmV2aW91c1xyXG4gIHNlcGFyYXRvckJlZm9yZT86IGJvb2xlYW47XHJcblxyXG4gIC8vIGlmIHByb3ZpZGVkIGFkZCBhIGNoZWNrbWFyayBuZXh0IHRvIHRoZSBNZW51SXRlbSB0ZXh0IHdoZW5ldmVyIHRoaXMgUHJvcGVydHkgaXMgdHJ1ZS5cclxuICBjaGVja2VkUHJvcGVydHk/OiBUUHJvcGVydHk8Ym9vbGVhbj4gfCBudWxsO1xyXG5cclxuICB0ZXh0RmlsbD86IFRQYWludDtcclxufTtcclxudHlwZSBQYXJlbnRPcHRpb25zID0gVm9pY2luZ09wdGlvbnMgJiBOb2RlT3B0aW9ucztcclxuZXhwb3J0IHR5cGUgTWVudUl0ZW1PcHRpb25zID0gU2VsZk9wdGlvbnMgJiBQYXJlbnRPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVudUl0ZW0gZXh0ZW5kcyBXaWR0aFNpemFibGUoIFZvaWNpbmcoIE5vZGUgKSApIHtcclxuXHJcbiAgLy8gaWYgdGhpcyBNZW51SXRlbSB3aWxsIGJlIHNob3duIGluIHRoZSBtZW51LiBTb21lIGl0ZW1zIGFyZSBqdXN0IGNyZWF0ZWQgdG8gbWFpbnRhaW4gYVxyXG4gIC8vIGNvbnNpc3RlbnQgUGhFVC1pTyBBUEkgZm9yIGFsbCBzaW0gcnVudGltZXMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcGhldC1pby9pc3N1ZXMvMTQ1N1xyXG4gIHB1YmxpYyByZWFkb25seSBwcmVzZW50OiBib29sZWFuO1xyXG5cclxuICAvLyBpZiB0aGVyZSBzaG91bGQgYmUgYSBob3Jpem9udGFsIHNlcGFyYXRvciBiZXR3ZWVuIHRoaXMgTWVudUl0ZW0gYW5kIHRoZSBvbmUgYWJvdmUgaXRcclxuICBwdWJsaWMgcmVhZG9ubHkgc2VwYXJhdG9yQmVmb3JlOiBib29sZWFuO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VNZW51SXRlbTogKCkgPT4gdm9pZDtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGNsb3NlQ2FsbGJhY2sgLSBjYWxsZWQgd2hlbiBmaXJpbmcgdGhlIG1lbnUgaXRlbSwgbW9zdCBsaWtlbHkgdGhpcyBzaG91bGQgY2xvc2UgdGhlIFBoZXRNZW51LlxyXG4gICAqIEBwYXJhbSBsYWJlbFN0cmluZ1Byb3BlcnR5IC0gbGFiZWwgZm9yIHRoZSBtZW51IGl0ZW1cclxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBjYWxsZWQgd2hlbiB0aGUgbWVudSBpdGVtIGlzIHNlbGVjdGVkXHJcbiAgICogQHBhcmFtIHByZXNlbnQgLSBzZWUgcHJlc2VudCBmaWVsZFxyXG4gICAqIEBwYXJhbSBzaG91bGRCZUhpZGRlbldoZW5MaW5rc0FyZU5vdEFsbG93ZWRcclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGNsb3NlQ2FsbGJhY2s6ICggZXZlbnQ6IFNjZW5lcnlFdmVudCApID0+IHZvaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICBsYWJlbFN0cmluZ1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxzdHJpbmc+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6ICggZXZlbnQ6IFNjZW5lcnlFdmVudCApID0+IHZvaWQsIHByZXNlbnQ6IGJvb2xlYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBzaG91bGRCZUhpZGRlbldoZW5MaW5rc0FyZU5vdEFsbG93ZWQ6IGJvb2xlYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM/OiBNZW51SXRlbU9wdGlvbnMgKSB7XHJcblxyXG4gICAgLy8gRXh0ZW5kIHRoZSBvYmplY3Qgd2l0aCBkZWZhdWx0cy5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8TWVudUl0ZW1PcHRpb25zLCBTZWxmT3B0aW9ucywgUGFyZW50T3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgc2VwYXJhdG9yQmVmb3JlOiBmYWxzZSxcclxuICAgICAgY2hlY2tlZFByb3BlcnR5OiBudWxsLFxyXG4gICAgICB0ZXh0RmlsbDogJ2JsYWNrJyxcclxuXHJcbiAgICAgIC8vIFZvaWNpbmdPcHRpb25zXHJcbiAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxyXG5cclxuICAgICAgLy8gcGhldC1pb1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5PUFRJT05BTCxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ0l0ZW0gYnV0dG9ucyBzaG93biBpbiBhIHBvcHVwIG1lbnUnLFxyXG4gICAgICBwaGV0aW9FdmVudFR5cGU6IEV2ZW50VHlwZS5VU0VSLFxyXG5cclxuICAgICAgLy8gcGRvbVxyXG4gICAgICB0YWdOYW1lOiAnYnV0dG9uJyxcclxuICAgICAgY29udGFpbmVyVGFnTmFtZTogJ2xpJyxcclxuICAgICAgY29udGFpbmVyQXJpYVJvbGU6ICdub25lJywgLy8gdGhpcyBpcyByZXF1aXJlZCBmb3IgSkFXUyB0byBoYW5kbGUgZm9jdXMgY29ycmVjdGx5LCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2pvaG4tdHJhdm9sdGFnZS9pc3N1ZXMvMjI1XHJcbiAgICAgIGFyaWFSb2xlOiAnbWVudWl0ZW0nLFxyXG5cclxuICAgICAgLy8gJ21lbnVpdGVtJyByb2xlIGRvZXMgbm90IGdldCBjbGljayBldmVudHMgb24gaU9TIFZvaWNlT3ZlciwgcG9zaXRpb24gc2libGluZ3Mgc28gdGhhdFxyXG4gICAgICAvLyB3ZSBnZXQgUG9pbnRlciBldmVudHMgaW5zdGVhZFxyXG4gICAgICBwb3NpdGlvbkluUERPTTogdHJ1ZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICBpZiAoIHNob3VsZEJlSGlkZGVuV2hlbkxpbmtzQXJlTm90QWxsb3dlZCApIHtcclxuICAgICAgdGhpcy5zZXRWaXNpYmxlUHJvcGVydHkoIGFsbG93TGlua3NQcm9wZXJ0eSApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGxhYmVsU3RyaW5nTGlzdGVuZXIgPSAoIGxhYmVsU3RyaW5nOiBzdHJpbmcgKSA9PiB7XHJcbiAgICAgIHRoaXMuaW5uZXJDb250ZW50ID0gbGFiZWxTdHJpbmc7XHJcbiAgICAgIHRoaXMudm9pY2luZ05hbWVSZXNwb25zZSA9IGxhYmVsU3RyaW5nO1xyXG4gICAgfTtcclxuICAgIGxhYmVsU3RyaW5nUHJvcGVydHkubGluayggbGFiZWxTdHJpbmdMaXN0ZW5lciApO1xyXG5cclxuICAgIHRoaXMucHJlc2VudCA9IHByZXNlbnQ7XHJcblxyXG4gICAgY29uc3QgbGFiZWxUZXh0ID0gbmV3IFRleHQoIGxhYmVsU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgZm9udDogbmV3IFBoZXRGb250KCBGT05UX1NJWkUgKSxcclxuICAgICAgZmlsbDogb3B0aW9ucy50ZXh0RmlsbCxcclxuICAgICAgbWF4V2lkdGg6IE1BWF9JVEVNX1dJRFRIXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgaGlnaGxpZ2h0ID0gbmV3IFJlY3RhbmdsZSgge1xyXG4gICAgICBjb3JuZXJSYWRpdXM6IENPUk5FUl9SQURJVVNcclxuICAgIH0gKTtcclxuXHJcbiAgICBsYWJlbFRleHQuYm91bmRzUHJvcGVydHkubGluayggdGV4dEJvdW5kcyA9PiB7XHJcbiAgICAgIHRoaXMubG9jYWxNaW5pbXVtV2lkdGggPSB0ZXh0Qm91bmRzLndpZHRoICsgTEVGVF9YX01BUkdJTiArIFJJR0hUX1hfTUFSR0lOICsgQ0hFQ0tfT0ZGU0VUO1xyXG4gICAgICBoaWdobGlnaHQucmVjdEhlaWdodCA9IHRleHRCb3VuZHMuaGVpZ2h0ICsgWV9NQVJHSU4gKyBZX01BUkdJTjtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmxvY2FsUHJlZmVycmVkV2lkdGhQcm9wZXJ0eS5saW5rKCBwcmVmZXJyZWRXaWR0aCA9PiB7XHJcbiAgICAgIGlmICggcHJlZmVycmVkV2lkdGggPT09IG51bGwgKSB7XHJcbiAgICAgICAgcHJlZmVycmVkV2lkdGggPSB0aGlzLmxvY2FsTWluaW11bVdpZHRoO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICggcHJlZmVycmVkV2lkdGggKSB7XHJcbiAgICAgICAgaGlnaGxpZ2h0LnJlY3RXaWR0aCA9IHByZWZlcnJlZFdpZHRoO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggaGlnaGxpZ2h0ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBsYWJlbFRleHQgKTtcclxuXHJcbiAgICBNYW51YWxDb25zdHJhaW50LmNyZWF0ZSggdGhpcywgWyBoaWdobGlnaHQsIGxhYmVsVGV4dCBdLCAoIGhpZ2hsaWdodFByb3h5LCBsYWJlbFRleHRQcm94eSApID0+IHtcclxuICAgICAgbGFiZWxUZXh0UHJveHkubGVmdCA9IGhpZ2hsaWdodFByb3h5LmxlZnQgKyBMRUZUX1hfTUFSR0lOICsgQ0hFQ0tfT0ZGU0VUOyAvLyBsYWJlbFN0cmluZ1Byb3BlcnR5IGlzIGxlZnQgYWxpZ25lZFxyXG4gICAgICBsYWJlbFRleHRQcm94eS5jZW50ZXJZID0gaGlnaGxpZ2h0UHJveHkuY2VudGVyWTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIHtcclxuICAgICAgZW50ZXI6ICgpID0+IHsgaGlnaGxpZ2h0LmZpbGwgPSBISUdITElHSFRfQ09MT1I7IH0sXHJcbiAgICAgIGV4aXQ6ICgpID0+IHsgaGlnaGxpZ2h0LmZpbGwgPSBudWxsOyB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5hZGRJbnB1dExpc3RlbmVyKCBuZXcgRmlyZUxpc3RlbmVyKCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZmlyZUxpc3RlbmVyJyApLFxyXG4gICAgICBmaXJlOiAoIGV2ZW50OiBTY2VuZXJ5RXZlbnQgKSA9PiB7XHJcbiAgICAgICAgY2xvc2VDYWxsYmFjayggZXZlbnQgKTtcclxuICAgICAgICBjYWxsYmFjayggZXZlbnQgKTtcclxuICAgICAgfVxyXG4gICAgfSApICk7XHJcblxyXG4gICAgdGhpcy5zZXBhcmF0b3JCZWZvcmUgPSBvcHRpb25zLnNlcGFyYXRvckJlZm9yZTtcclxuXHJcbiAgICAvLyBPcHRpb25hbGx5IGFkZCBhIGNoZWNrIG1hcmsgYW5kIGhvb2sgdXAgdmlzaWJpbGl0eSBjaGFuZ2VzLlxyXG4gICAgbGV0IGNoZWNrZWRMaXN0ZW5lcjogKCAoIGlzQ2hlY2tlZDogYm9vbGVhbiApID0+IHZvaWQgKSB8IG51bGwgPSBudWxsO1xyXG4gICAgaWYgKCBvcHRpb25zLmNoZWNrZWRQcm9wZXJ0eSApIHtcclxuICAgICAgY29uc3QgY2hlY2tNYXJrV3JhcHBlciA9IG5ldyBOb2RlKCB7XHJcbiAgICAgICAgY2hpbGRyZW46IFsgQ0hFQ0tfTUFSS19OT0RFIF0sXHJcbiAgICAgICAgcmlnaHQ6IGxhYmVsVGV4dC5sZWZ0IC0gQ0hFQ0tfUEFERElORyxcclxuICAgICAgICBjZW50ZXJZOiBsYWJlbFRleHQuY2VudGVyWVxyXG4gICAgICB9ICk7XHJcbiAgICAgIGNoZWNrZWRMaXN0ZW5lciA9ICggaXNDaGVja2VkOiBib29sZWFuICkgPT4ge1xyXG4gICAgICAgIGNoZWNrTWFya1dyYXBwZXIudmlzaWJsZSA9IGlzQ2hlY2tlZDtcclxuICAgICAgfTtcclxuICAgICAgb3B0aW9ucy5jaGVja2VkUHJvcGVydHkubGluayggY2hlY2tlZExpc3RlbmVyICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIGNoZWNrTWFya1dyYXBwZXIgKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuZGlzcG9zZU1lbnVJdGVtID0gKCkgPT4ge1xyXG4gICAgICBpZiAoIG9wdGlvbnMuY2hlY2tlZFByb3BlcnR5ICYmIGNoZWNrZWRMaXN0ZW5lciAmJiBvcHRpb25zLmNoZWNrZWRQcm9wZXJ0eS5oYXNMaXN0ZW5lciggY2hlY2tlZExpc3RlbmVyICkgKSB7XHJcbiAgICAgICAgb3B0aW9ucy5jaGVja2VkUHJvcGVydHkudW5saW5rKCBjaGVja2VkTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKCBsYWJlbFN0cmluZ1Byb3BlcnR5Lmhhc0xpc3RlbmVyKCBsYWJlbFN0cmluZ0xpc3RlbmVyICkgKSB7XHJcbiAgICAgICAgbGFiZWxTdHJpbmdQcm9wZXJ0eS51bmxpbmsoIGxhYmVsU3RyaW5nTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgbGFiZWxUZXh0LmRpc3Bvc2UoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZU1lbnVJdGVtKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5zdW4ucmVnaXN0ZXIoICdNZW51SXRlbScsIE1lbnVJdGVtICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLFFBQVEsTUFBTSxtQ0FBbUM7QUFDeEQsU0FBU0Msa0JBQWtCLEVBQUVDLFlBQVksRUFBRUMsZ0JBQWdCLEVBQUVDLElBQUksRUFBZUMsSUFBSSxFQUFFQyxTQUFTLEVBQWdCQyxJQUFJLEVBQVVDLE9BQU8sRUFBa0JDLFlBQVksUUFBUSw2QkFBNkI7QUFDdk0sT0FBT0MsZUFBZSxNQUFNLGtEQUFrRDtBQUM5RSxPQUFPQyxTQUFTLE1BQU0sOEJB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