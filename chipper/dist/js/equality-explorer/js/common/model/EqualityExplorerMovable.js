// Copyright 2017-2022, University of Colorado Boulder

/**
 * EqualityExplorerMovable is a model element that is movable. It has a current position and a desired destination.
 *
 * The model element can be moved using either moveTo or animateTo.
 * moveTo moves immediately to a position, and is typically used while the user is dragging the model element.
 * animateTo animates to a position, and is typically used after the user releases the model element.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Vector2Property from '../../../../dot/js/Vector2Property.js';
import optionize from '../../../../phet-core/js/optionize.js';
import PhetioObject from '../../../../tandem/js/PhetioObject.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import equalityExplorer from '../../equalityExplorer.js';

//TODO https://github.com/phetsims/equality-explorer/issues/200 add required tandem to EqualityExplorerMovableOptions

export default class EqualityExplorerMovable extends PhetioObject {
  // The same Property as _positionProperty, but with a read-only API.
  // Callers should use moveTo or animateTo instead of setting positionProperty.
  // drag handlers must manage this flag during a drag sequence
  // destination to animate to, set using animateTo
  // Called when animation step occurs, set using animateTo. Don't do anything expensive here!
  // called when animation to destination completes, set using animateTo
  constructor(providedOptions) {
    const options = optionize()({
      // SelfOptions
      position: Vector2.ZERO,
      dragBounds: Bounds2.EVERYTHING,
      animationSpeed: 400,
      // PhetioObjectOptions
      tandem: Tandem.OPTIONAL,
      //TODO https://github.com/phetsims/equality-explorer/issues/200 delete when tandem is required by EqualityExplorerMovableOptions
      phetioState: false
    }, providedOptions);
    super(options);
    this._positionProperty = new Vector2Property(options.position, {
      tandem: options.tandem.createTandem('positionProperty'),
      phetioReadOnly: false
    });
    this.positionProperty = this._positionProperty;
    this.draggingProperty = new BooleanProperty(false, {
      tandem: options.tandem.createTandem('draggingProperty'),
      phetioReadOnly: false
    });
    this.dragBounds = options.dragBounds;
    this.animationSpeed = options.animationSpeed;
    this.destination = options.position.copy();
    this.animationStepCallback = null;
    this.animationCompletedCallback = null;
  }
  dispose() {
    this.positionProperty.dispose();
    this.draggingProperty.dispose();
    super.dispose();
  }

  /**
   * Creates the options that would be needed to instantiate a copy of this object.
   * This is used by subclasses that implement copy.
   */
  copyOptions() {
    return {
      position: this.positionProperty.value.copy(),
      dragBounds: this.dragBounds.copy(),
      animationSpeed: this.animationSpeed
    };
  }
  reset() {
    // call moveTo instead of positionProperty.set, so that any animation in progress is cancelled
    this.moveTo(this._positionProperty.initialValue);
  }

  /**
   * Moves immediately to the specified position, without animation.
   */
  moveTo(position) {
    // cancel any pending callbacks
    this.animationStepCallback = null;
    this.animationCompletedCallback = null;

    // move immediately to the position
    this.destination = position;
    this._positionProperty.set(position);
  }

  /**
   * Animates to the specified position, with optional callbacks.
   */
  animateTo(destination, providedOptions) {
    this.destination = destination;
    this.animationStepCallback = providedOptions && providedOptions.animationStepCallback || null;
    this.animationCompletedCallback = providedOptions && providedOptions.animationCompletedCallback || null;
  }

  /**
   * Is this model element animating?
   */
  isAnimating() {
    return !this.draggingProperty.value && (!this.positionProperty.get().equals(this.destination) || !!this.animationCompletedCallback);
  }

  /**
   * Animates position, when not being dragged by the user.
   * @param dt - time since the previous step, in seconds
   */
  step(dt) {
    if (this.isAnimating()) {
      // optional callback
      this.animationStepCallback && this.animationStepCallback();

      // distance from destination
      const totalDistance = this.positionProperty.get().distance(this.destination);

      // distance to move on this step
      const stepDistance = this.animationSpeed * dt;
      if (totalDistance <= stepDistance) {
        // move directly to the destination
        this._positionProperty.set(this.destination);

        // Perform the animationCompletedCallback, which may set a new callback by calling animateTo.
        // The new callback must be a new function instance, since equality is used to check whether
        // a new callback was set.
        const saveAnimationCompletedCallback = this.animationCompletedCallback;
        this.animationCompletedCallback && this.animationCompletedCallback();
        if (saveAnimationCompletedCallback === this.animationCompletedCallback) {
          this.animationCompletedCallback = null;
        }
      } else {
        // move one step towards the destination
        const stepAngle = Math.atan2(this.destination.y - this.positionProperty.get().y, this.destination.x - this.positionProperty.get().x);
        const stepVector = Vector2.createPolar(stepDistance, stepAngle);
        this._positionProperty.set(this.positionProperty.get().plus(stepVector));
      }
    }
  }
}
equalityExplorer.register('EqualityExplorerMovable', EqualityExplorerMovable);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJCb3VuZHMyIiwiVmVjdG9yMiIsIlZlY3RvcjJQcm9wZXJ0eSIsIm9wdGlvbml6ZSIsIlBoZXRpb09iamVjdCIsIlRhbmRlbSIsImVxdWFsaXR5RXhwbG9yZXIiLCJFcXVhbGl0eUV4cGxvcmVyTW92YWJsZSIsImNvbnN0cnVjdG9yIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInBvc2l0aW9uIiwiWkVSTyIsImRyYWdCb3VuZHMiLCJFVkVSWVRISU5HIiwiYW5pbWF0aW9uU3BlZWQiLCJ0YW5kZW0iLCJPUFRJT05BTCIsInBoZXRpb1N0YXRlIiwiX3Bvc2l0aW9uUHJvcGVydHkiLCJjcmVhdGVUYW5kZW0iLCJwaGV0aW9SZWFkT25seSIsInBvc2l0aW9uUHJvcGVydHkiLCJkcmFnZ2luZ1Byb3BlcnR5IiwiZGVzdGluYXRpb24iLCJjb3B5IiwiYW5pbWF0aW9uU3RlcENhbGxiYWNrIiwiYW5pbWF0aW9uQ29tcGxldGVkQ2FsbGJhY2siLCJkaXNwb3NlIiwiY29weU9wdGlvbnMiLCJ2YWx1ZSIsInJlc2V0IiwibW92ZVRvIiwiaW5pdGlhbFZhbHVlIiwic2V0IiwiYW5pbWF0ZVRvIiwiaXNBbmltYXRpbmciLCJnZXQiLCJlcXVhbHMiLCJzdGVwIiwiZHQiLCJ0b3RhbERpc3RhbmNlIiwiZGlzdGFuY2UiLCJzdGVwRGlzdGFuY2UiLCJzYXZlQW5pbWF0aW9uQ29tcGxldGVkQ2FsbGJhY2siLCJzdGVwQW5nbGUiLCJNYXRoIiwiYXRhbjIiLCJ5IiwieCIsInN0ZXBWZWN0b3IiLCJjcmVhdGVQb2xhciIsInBsdXMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVxdWFsaXR5RXhwbG9yZXJNb3ZhYmxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEVxdWFsaXR5RXhwbG9yZXJNb3ZhYmxlIGlzIGEgbW9kZWwgZWxlbWVudCB0aGF0IGlzIG1vdmFibGUuIEl0IGhhcyBhIGN1cnJlbnQgcG9zaXRpb24gYW5kIGEgZGVzaXJlZCBkZXN0aW5hdGlvbi5cclxuICpcclxuICogVGhlIG1vZGVsIGVsZW1lbnQgY2FuIGJlIG1vdmVkIHVzaW5nIGVpdGhlciBtb3ZlVG8gb3IgYW5pbWF0ZVRvLlxyXG4gKiBtb3ZlVG8gbW92ZXMgaW1tZWRpYXRlbHkgdG8gYSBwb3NpdGlvbiwgYW5kIGlzIHR5cGljYWxseSB1c2VkIHdoaWxlIHRoZSB1c2VyIGlzIGRyYWdnaW5nIHRoZSBtb2RlbCBlbGVtZW50LlxyXG4gKiBhbmltYXRlVG8gYW5pbWF0ZXMgdG8gYSBwb3NpdGlvbiwgYW5kIGlzIHR5cGljYWxseSB1c2VkIGFmdGVyIHRoZSB1c2VyIHJlbGVhc2VzIHRoZSBtb2RlbCBlbGVtZW50LlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBWZWN0b3IyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrT3B0aW9uYWwgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tPcHRpb25hbC5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QsIHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgZXF1YWxpdHlFeHBsb3JlciBmcm9tICcuLi8uLi9lcXVhbGl0eUV4cGxvcmVyLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgcG9zaXRpb24/OiBWZWN0b3IyOyAvLyBpbml0aWFsIHBvc2l0aW9uXHJcbiAgZHJhZ0JvdW5kcz86IEJvdW5kczI7IC8vIGJvdW5kcyB0aGF0IGNvbnN0cmFpbiBkcmFnZ2luZ1xyXG4gIGFuaW1hdGlvblNwZWVkPzogbnVtYmVyOyAvLyBkaXN0YW5jZS9zZWNvbmQgd2hlbiBhbmltYXRpbmdcclxufTtcclxuXHJcbi8vVE9ETyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZXF1YWxpdHktZXhwbG9yZXIvaXNzdWVzLzIwMCBhZGQgcmVxdWlyZWQgdGFuZGVtIHRvIEVxdWFsaXR5RXhwbG9yZXJNb3ZhYmxlT3B0aW9uc1xyXG5leHBvcnQgdHlwZSBFcXVhbGl0eUV4cGxvcmVyTW92YWJsZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tPcHRpb25hbDxQaGV0aW9PYmplY3RPcHRpb25zLCAndGFuZGVtJz47XHJcblxyXG50eXBlIEFuaW1hdGlvbkNhbGxiYWNrID0gKCAoKSA9PiB2b2lkICkgfCBudWxsO1xyXG5cclxudHlwZSBBbmltYXRlVG9PcHRpb25zID0ge1xyXG4gIGFuaW1hdGlvblN0ZXBDYWxsYmFjaz86IEFuaW1hdGlvbkNhbGxiYWNrOyAvLyBjYWxsZWQgd2hlbiBhbmltYXRpb24gc3RlcCBvY2N1cnNcclxuICBhbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjaz86IEFuaW1hdGlvbkNhbGxiYWNrOyAvLyBjYWxsZWQgd2hlbiBhbmltYXRpb24gaGFzIGNvbXBsZXRlZFxyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXF1YWxpdHlFeHBsb3Jlck1vdmFibGUgZXh0ZW5kcyBQaGV0aW9PYmplY3Qge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IF9wb3NpdGlvblByb3BlcnR5OiBQcm9wZXJ0eTxWZWN0b3IyPjtcclxuXHJcbiAgLy8gVGhlIHNhbWUgUHJvcGVydHkgYXMgX3Bvc2l0aW9uUHJvcGVydHksIGJ1dCB3aXRoIGEgcmVhZC1vbmx5IEFQSS5cclxuICAvLyBDYWxsZXJzIHNob3VsZCB1c2UgbW92ZVRvIG9yIGFuaW1hdGVUbyBpbnN0ZWFkIG9mIHNldHRpbmcgcG9zaXRpb25Qcm9wZXJ0eS5cclxuICBwdWJsaWMgcmVhZG9ubHkgcG9zaXRpb25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8VmVjdG9yMj47XHJcblxyXG4gIC8vIGRyYWcgaGFuZGxlcnMgbXVzdCBtYW5hZ2UgdGhpcyBmbGFnIGR1cmluZyBhIGRyYWcgc2VxdWVuY2VcclxuICBwdWJsaWMgcmVhZG9ubHkgZHJhZ2dpbmdQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIHB1YmxpYyBkcmFnQm91bmRzOiBCb3VuZHMyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgYW5pbWF0aW9uU3BlZWQ6IG51bWJlcjtcclxuXHJcbiAgLy8gZGVzdGluYXRpb24gdG8gYW5pbWF0ZSB0bywgc2V0IHVzaW5nIGFuaW1hdGVUb1xyXG4gIHByaXZhdGUgZGVzdGluYXRpb246IFZlY3RvcjI7XHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIGFuaW1hdGlvbiBzdGVwIG9jY3Vycywgc2V0IHVzaW5nIGFuaW1hdGVUby4gRG9uJ3QgZG8gYW55dGhpbmcgZXhwZW5zaXZlIGhlcmUhXHJcbiAgcHJpdmF0ZSBhbmltYXRpb25TdGVwQ2FsbGJhY2s6IEFuaW1hdGlvbkNhbGxiYWNrO1xyXG5cclxuICAvLyBjYWxsZWQgd2hlbiBhbmltYXRpb24gdG8gZGVzdGluYXRpb24gY29tcGxldGVzLCBzZXQgdXNpbmcgYW5pbWF0ZVRvXHJcbiAgcHJpdmF0ZSBhbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjazogQW5pbWF0aW9uQ2FsbGJhY2s7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zPzogRXF1YWxpdHlFeHBsb3Jlck1vdmFibGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8RXF1YWxpdHlFeHBsb3Jlck1vdmFibGVPcHRpb25zLCBTZWxmT3B0aW9ucywgUGhldGlvT2JqZWN0T3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgcG9zaXRpb246IFZlY3RvcjIuWkVSTyxcclxuICAgICAgZHJhZ0JvdW5kczogQm91bmRzMi5FVkVSWVRISU5HLFxyXG4gICAgICBhbmltYXRpb25TcGVlZDogNDAwLFxyXG5cclxuICAgICAgLy8gUGhldGlvT2JqZWN0T3B0aW9uc1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5PUFRJT05BTCwgLy9UT0RPIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9lcXVhbGl0eS1leHBsb3Jlci9pc3N1ZXMvMjAwIGRlbGV0ZSB3aGVuIHRhbmRlbSBpcyByZXF1aXJlZCBieSBFcXVhbGl0eUV4cGxvcmVyTW92YWJsZU9wdGlvbnNcclxuICAgICAgcGhldGlvU3RhdGU6IGZhbHNlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuX3Bvc2l0aW9uUHJvcGVydHkgPSBuZXcgVmVjdG9yMlByb3BlcnR5KCBvcHRpb25zLnBvc2l0aW9uLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAncG9zaXRpb25Qcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IGZhbHNlXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkgPSB0aGlzLl9wb3NpdGlvblByb3BlcnR5O1xyXG5cclxuICAgIHRoaXMuZHJhZ2dpbmdQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZHJhZ2dpbmdQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IGZhbHNlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5kcmFnQm91bmRzID0gb3B0aW9ucy5kcmFnQm91bmRzO1xyXG4gICAgdGhpcy5hbmltYXRpb25TcGVlZCA9IG9wdGlvbnMuYW5pbWF0aW9uU3BlZWQ7XHJcbiAgICB0aGlzLmRlc3RpbmF0aW9uID0gb3B0aW9ucy5wb3NpdGlvbi5jb3B5KCk7XHJcbiAgICB0aGlzLmFuaW1hdGlvblN0ZXBDYWxsYmFjayA9IG51bGw7XHJcbiAgICB0aGlzLmFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrID0gbnVsbDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3NpdGlvblByb3BlcnR5LmRpc3Bvc2UoKTtcclxuICAgIHRoaXMuZHJhZ2dpbmdQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIHRoZSBvcHRpb25zIHRoYXQgd291bGQgYmUgbmVlZGVkIHRvIGluc3RhbnRpYXRlIGEgY29weSBvZiB0aGlzIG9iamVjdC5cclxuICAgKiBUaGlzIGlzIHVzZWQgYnkgc3ViY2xhc3NlcyB0aGF0IGltcGxlbWVudCBjb3B5LlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb3B5T3B0aW9ucygpOiBFcXVhbGl0eUV4cGxvcmVyTW92YWJsZU9wdGlvbnMge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcG9zaXRpb246IHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS5jb3B5KCksXHJcbiAgICAgIGRyYWdCb3VuZHM6IHRoaXMuZHJhZ0JvdW5kcy5jb3B5KCksXHJcbiAgICAgIGFuaW1hdGlvblNwZWVkOiB0aGlzLmFuaW1hdGlvblNwZWVkXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG5cclxuICAgIC8vIGNhbGwgbW92ZVRvIGluc3RlYWQgb2YgcG9zaXRpb25Qcm9wZXJ0eS5zZXQsIHNvIHRoYXQgYW55IGFuaW1hdGlvbiBpbiBwcm9ncmVzcyBpcyBjYW5jZWxsZWRcclxuICAgIHRoaXMubW92ZVRvKCB0aGlzLl9wb3NpdGlvblByb3BlcnR5LmluaXRpYWxWYWx1ZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTW92ZXMgaW1tZWRpYXRlbHkgdG8gdGhlIHNwZWNpZmllZCBwb3NpdGlvbiwgd2l0aG91dCBhbmltYXRpb24uXHJcbiAgICovXHJcbiAgcHVibGljIG1vdmVUbyggcG9zaXRpb246IFZlY3RvcjIgKTogdm9pZCB7XHJcblxyXG4gICAgLy8gY2FuY2VsIGFueSBwZW5kaW5nIGNhbGxiYWNrc1xyXG4gICAgdGhpcy5hbmltYXRpb25TdGVwQ2FsbGJhY2sgPSBudWxsO1xyXG4gICAgdGhpcy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayA9IG51bGw7XHJcblxyXG4gICAgLy8gbW92ZSBpbW1lZGlhdGVseSB0byB0aGUgcG9zaXRpb25cclxuICAgIHRoaXMuZGVzdGluYXRpb24gPSBwb3NpdGlvbjtcclxuICAgIHRoaXMuX3Bvc2l0aW9uUHJvcGVydHkuc2V0KCBwb3NpdGlvbiApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQW5pbWF0ZXMgdG8gdGhlIHNwZWNpZmllZCBwb3NpdGlvbiwgd2l0aCBvcHRpb25hbCBjYWxsYmFja3MuXHJcbiAgICovXHJcbiAgcHVibGljIGFuaW1hdGVUbyggZGVzdGluYXRpb246IFZlY3RvcjIsIHByb3ZpZGVkT3B0aW9ucz86IEFuaW1hdGVUb09wdGlvbnMgKTogdm9pZCB7XHJcbiAgICB0aGlzLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb247XHJcbiAgICB0aGlzLmFuaW1hdGlvblN0ZXBDYWxsYmFjayA9ICggcHJvdmlkZWRPcHRpb25zICYmIHByb3ZpZGVkT3B0aW9ucy5hbmltYXRpb25TdGVwQ2FsbGJhY2sgKSB8fCBudWxsO1xyXG4gICAgdGhpcy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayA9ICggcHJvdmlkZWRPcHRpb25zICYmIHByb3ZpZGVkT3B0aW9ucy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayApIHx8IG51bGw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJcyB0aGlzIG1vZGVsIGVsZW1lbnQgYW5pbWF0aW5nP1xyXG4gICAqL1xyXG4gIHB1YmxpYyBpc0FuaW1hdGluZygpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhdGhpcy5kcmFnZ2luZ1Byb3BlcnR5LnZhbHVlICYmXHJcbiAgICAgICAgICAgKCAhdGhpcy5wb3NpdGlvblByb3BlcnR5LmdldCgpLmVxdWFscyggdGhpcy5kZXN0aW5hdGlvbiApIHx8ICEhdGhpcy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQW5pbWF0ZXMgcG9zaXRpb24sIHdoZW4gbm90IGJlaW5nIGRyYWdnZWQgYnkgdGhlIHVzZXIuXHJcbiAgICogQHBhcmFtIGR0IC0gdGltZSBzaW5jZSB0aGUgcHJldmlvdXMgc3RlcCwgaW4gc2Vjb25kc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGVwKCBkdDogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLmlzQW5pbWF0aW5nKCkgKSB7XHJcblxyXG4gICAgICAvLyBvcHRpb25hbCBjYWxsYmFja1xyXG4gICAgICB0aGlzLmFuaW1hdGlvblN0ZXBDYWxsYmFjayAmJiB0aGlzLmFuaW1hdGlvblN0ZXBDYWxsYmFjaygpO1xyXG5cclxuICAgICAgLy8gZGlzdGFuY2UgZnJvbSBkZXN0aW5hdGlvblxyXG4gICAgICBjb25zdCB0b3RhbERpc3RhbmNlID0gdGhpcy5wb3NpdGlvblByb3BlcnR5LmdldCgpLmRpc3RhbmNlKCB0aGlzLmRlc3RpbmF0aW9uICk7XHJcblxyXG4gICAgICAvLyBkaXN0YW5jZSB0byBtb3ZlIG9uIHRoaXMgc3RlcFxyXG4gICAgICBjb25zdCBzdGVwRGlzdGFuY2UgPSB0aGlzLmFuaW1hdGlvblNwZWVkICogZHQ7XHJcblxyXG4gICAgICBpZiAoIHRvdGFsRGlzdGFuY2UgPD0gc3RlcERpc3RhbmNlICkge1xyXG5cclxuICAgICAgICAvLyBtb3ZlIGRpcmVjdGx5IHRvIHRoZSBkZXN0aW5hdGlvblxyXG4gICAgICAgIHRoaXMuX3Bvc2l0aW9uUHJvcGVydHkuc2V0KCB0aGlzLmRlc3RpbmF0aW9uICk7XHJcblxyXG4gICAgICAgIC8vIFBlcmZvcm0gdGhlIGFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrLCB3aGljaCBtYXkgc2V0IGEgbmV3IGNhbGxiYWNrIGJ5IGNhbGxpbmcgYW5pbWF0ZVRvLlxyXG4gICAgICAgIC8vIFRoZSBuZXcgY2FsbGJhY2sgbXVzdCBiZSBhIG5ldyBmdW5jdGlvbiBpbnN0YW5jZSwgc2luY2UgZXF1YWxpdHkgaXMgdXNlZCB0byBjaGVjayB3aGV0aGVyXHJcbiAgICAgICAgLy8gYSBuZXcgY2FsbGJhY2sgd2FzIHNldC5cclxuICAgICAgICBjb25zdCBzYXZlQW5pbWF0aW9uQ29tcGxldGVkQ2FsbGJhY2sgPSB0aGlzLmFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrO1xyXG4gICAgICAgIHRoaXMuYW5pbWF0aW9uQ29tcGxldGVkQ2FsbGJhY2sgJiYgdGhpcy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjaygpO1xyXG4gICAgICAgIGlmICggc2F2ZUFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrID09PSB0aGlzLmFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrICkge1xyXG4gICAgICAgICAgdGhpcy5hbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBtb3ZlIG9uZSBzdGVwIHRvd2FyZHMgdGhlIGRlc3RpbmF0aW9uXHJcbiAgICAgICAgY29uc3Qgc3RlcEFuZ2xlID0gTWF0aC5hdGFuMihcclxuICAgICAgICAgIHRoaXMuZGVzdGluYXRpb24ueSAtIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKS55LFxyXG4gICAgICAgICAgdGhpcy5kZXN0aW5hdGlvbi54IC0gdGhpcy5wb3NpdGlvblByb3BlcnR5LmdldCgpLnggKTtcclxuICAgICAgICBjb25zdCBzdGVwVmVjdG9yID0gVmVjdG9yMi5jcmVhdGVQb2xhciggc3RlcERpc3RhbmNlLCBzdGVwQW5nbGUgKTtcclxuICAgICAgICB0aGlzLl9wb3NpdGlvblByb3BlcnR5LnNldCggdGhpcy5wb3NpdGlvblByb3BlcnR5LmdldCgpLnBsdXMoIHN0ZXBWZWN0b3IgKSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5lcXVhbGl0eUV4cGxvcmVyLnJlZ2lzdGVyKCAnRXF1YWxpdHlFeHBsb3Jlck1vdmFibGUnLCBFcXVhbGl0eUV4cGxvcmVyTW92YWJsZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFHcEUsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLGVBQWUsTUFBTSx1Q0FBdUM7QUFDbkUsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQUU3RCxPQUFPQyxZQUFZLE1BQStCLHVDQUF1QztB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