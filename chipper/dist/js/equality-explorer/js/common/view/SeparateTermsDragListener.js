// Copyright 2018-2022, University of Colorado Boulder

/**
 * SeparateTermsDragListener is used when like terms occupy separate cells on a plate.
 * Like terms are combined only if they sum to zero.
 * See terminology and requirements in TermDragListener superclass.
 * See https://github.com/phetsims/equality-explorer/blob/master/doc/lock-scenarios.md for scenarios that
 * describe how this feature works.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import { combineOptions } from '../../../../phet-core/js/optionize.js';
import equalityExplorer from '../../equalityExplorer.js';
import TermDragListener from './TermDragListener.js';
import EqualityExplorerSceneNode from './EqualityExplorerSceneNode.js';
export default class SeparateTermsDragListener extends TermDragListener {
  // inverse term on opposite plate, for lock feature

  // If the inverse term is dragged, break the association between equivalentTerm and inverseTerm

  /**
   * @param termNode - Node that the listener is attached to
   * @param term - the term being dragged
   * @param termCreator - the creator of term
   * @param [providedOptions]
   */
  constructor(termNode, term, termCreator, providedOptions) {
    assert && assert(!termCreator.combineLikeTermsEnabled, 'SeparateTermsDragListener is used when like terms occupy separate cells');
    super(termNode, term, termCreator, providedOptions);
    this.inverseTerm = null;
    this.inverseTermDraggingListener = dragging => {
      const inverseTerm = this.inverseTerm;
      assert && assert(inverseTerm, 'there is no associated inverse term');
      if (dragging) {
        if (inverseTerm.draggingProperty.hasListener(this.inverseTermDraggingListener)) {
          inverseTerm.draggingProperty.unlink(this.inverseTermDraggingListener);
        }
        this.inverseTerm = null;
      }
    };
    this.disposeSeparateTermsDragListener = () => {
      if (this.inverseTerm && this.inverseTerm.draggingProperty.hasListener(this.inverseTermDraggingListener)) {
        this.inverseTerm.draggingProperty.unlink(this.inverseTermDraggingListener);
      }
    };
  }
  dispose() {
    this.disposeSeparateTermsDragListener();
    super.dispose();
  }

  //-------------------------------------------------------------------------------------------------
  // Below here is the implementation of the TermDragListener API
  //-------------------------------------------------------------------------------------------------

  /**
   * Called at the start of a drag cycle, when lock is on, to handle related terms on the opposite side.
   * @returns true=success, false=failure
   */
  startOpposite() {
    assert && assert(this.termCreator.lockedProperty.value, 'startOpposite should only be called when lock is on');
    const termCell = this.plate.getCellForTerm(this.term);
    assert && assert(termCell !== null);
    this.equivalentTerm = this.oppositePlate.getClosestEquivalentTerm(this.term, termCell);
    if (this.equivalentTerm) {
      // found equivalent term on opposite plate, remove it from plate
      this.equivalentTermCreator.removeTermFromPlate(this.equivalentTerm);
    } else if (this.oppositePlate.isFull()) {
      // Opposite plate is full, cannot create inverse term, show 'Oops' message.
      // To test this, see doc for EqualityExplorerSceneNode.leftSideFullDialog and rightSideFullDialog.
      const thisIsLeftSide = this.termCreator.positivePosition.x < this.equivalentTermCreator.positivePosition.x;
      if (thisIsLeftSide) {
        EqualityExplorerSceneNode.rightSideFullDialog.show();
      } else {
        EqualityExplorerSceneNode.leftSideFullDialog.show();
      }

      // interrupt this drag sequence, since we can't take term off the plate
      this.interrupt();
      return false;
    } else {
      // no equivalent term on opposite plate, create an inverse term
      this.inverseTerm = this.equivalentTermCreator.createTerm(combineOptions({}, this.term.copyOptions(), {
        sign: -1
      }));
      const inverseTermPosition = this.termCreator.getEquivalentTermPosition(this.term);
      const inverseCell = this.oppositePlate.getBestEmptyCell(inverseTermPosition);
      assert && assert(inverseCell !== null);
      this.equivalentTermCreator.putTermOnPlate(this.inverseTerm, inverseCell);

      // if the inverse term is dragged, break the association to equivalentTerm
      this.inverseTerm.draggingProperty.lazyLink(this.inverseTermDraggingListener);

      // create the equivalent term on the opposite side
      // Do this after creating inverseTerm so that it appear in front of inverseTerm.
      this.equivalentTerm = this.equivalentTermCreator.createTerm(this.term.copyOptions());
    }
    return true;
  }

  /**
   * Called at the end of a drag cycle, when lock is on, to handle related terms on the opposite side.
   * @returns non-null if the drag results in terms on the opposite plate summing to zero
   */
  endOpposite() {
    assert && assert(this.termCreator.lockedProperty.value, 'endOpposite should only be called when lock is on');
    const equivalentTerm = this.equivalentTerm;
    assert && assert(equivalentTerm);

    // put equivalent term in an empty cell
    const emptyCell = this.oppositePlate.getBestEmptyCell(equivalentTerm.positionProperty.value);
    assert && assert(emptyCell !== null);
    this.equivalentTermCreator.putTermOnPlate(equivalentTerm, emptyCell);

    // always null for this subclass, since terms on the opposite side don't combine
    return null;
  }

  /**
   * Animates terms to empty cells.
   * In this scenario, each term occupies a cell on the plate, and like terms are not combined.
   * If there are no empty cells on the plate, the term is returned to the toolbox where it was created.
   */
  animateToPlate() {
    assert && assert(!this.termCreator.combineLikeTermsEnabled, 'should NOT be called when combining like terms');
    if (this.plate.isFull() || this.equivalentTerm && this.oppositePlate.isFull()) {
      // Plate is full, return to the toolbox.
      this.animateToToolbox();
    } else {
      // the target cell and its position
      const cell = this.plate.getBestEmptyCell(this.term.positionProperty.value);
      assert && assert(cell !== null);
      const cellPosition = this.plate.getPositionOfCell(cell);
      this.term.pickableProperty.value = this.pickableWhileAnimating;
      this.term.animateTo(cellPosition, {
        // On each animation step...
        animationStepCallback: () => {
          // If the target cell has become occupied, or the opposite plate is full, try again.
          if (!this.plate.isEmptyCell(cell) || this.equivalentTerm && this.oppositePlate.isFull()) {
            this.animateToPlate();
          }
        },
        // When the term reaches the cell...
        animationCompletedCallback: () => {
          assert && assert(!this.plate.isFull(), 'plate is full');
          assert && assert(!(this.equivalentTerm && this.oppositePlate.isFull()), 'opposite plate is full');

          // Compute cell again, in case a term has been removed below the cell that we were animating to.
          const cell = this.plate.getBestEmptyCell(this.term.positionProperty.value);
          assert && assert(cell !== null);

          // Put the term on the plate
          this.termCreator.putTermOnPlate(this.term, cell);
          this.term.pickableProperty.value = true;

          // Handle related terms on opposite side.
          // Note that equivalentTerm and/or inverseTerm may have been disposed of, so handle that.
          if (this.equivalentTerm) {
            if (this.inverseTerm) {
              // Equivalent and inverse term cancel each other out.
              !this.inverseTerm.isDisposed && this.inverseTerm.dispose();
              this.inverseTerm = null;
              !this.equivalentTerm.isDisposed && this.equivalentTerm.dispose();
              this.equivalentTerm = null;
            } else if (!this.equivalentTerm.isDisposed) {
              // Transfer this.equivalentTerm to a local variable and set to null, so that equivalentTerm
              // no longer tracks movement of term. See https://github.com/phetsims/equality-explorer/issues/90
              const equivalentTerm = this.equivalentTerm;
              this.equivalentTerm = null;

              // Put equivalent term on the opposite plate
              const equivalentCell = this.oppositePlate.getBestEmptyCell(equivalentTerm.positionProperty.value);
              assert && assert(equivalentCell !== null);
              this.equivalentTermCreator.putTermOnPlate(equivalentTerm, equivalentCell);
              equivalentTerm.pickableProperty.value = true;
            } else {
              // Do nothing - equivalentTerm was disposed before animationCompletedCallback was called.
              // See https://github.com/phetsims/equality-explorer/issues/88
              this.equivalentTerm = null;
            }
          }
          assert && assert(this.equivalentTerm === null, 'equivalentTerm should be null');
          assert && assert(this.inverseTerm === null, 'inverseTerm should be null');
        }
      });
    }
  }
}
equalityExplorer.register('SeparateTermsDragListener', SeparateTermsDragListener);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21iaW5lT3B0aW9ucyIsImVxdWFsaXR5RXhwbG9yZXIiLCJUZXJtRHJhZ0xpc3RlbmVyIiwiRXF1YWxpdHlFeHBsb3JlclNjZW5lTm9kZSIsIlNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXIiLCJjb25zdHJ1Y3RvciIsInRlcm1Ob2RlIiwidGVybSIsInRlcm1DcmVhdG9yIiwicHJvdmlkZWRPcHRpb25zIiwiYXNzZXJ0IiwiY29tYmluZUxpa2VUZXJtc0VuYWJsZWQiLCJpbnZlcnNlVGVybSIsImludmVyc2VUZXJtRHJhZ2dpbmdMaXN0ZW5lciIsImRyYWdnaW5nIiwiZHJhZ2dpbmdQcm9wZXJ0eSIsImhhc0xpc3RlbmVyIiwidW5saW5rIiwiZGlzcG9zZVNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXIiLCJkaXNwb3NlIiwic3RhcnRPcHBvc2l0ZSIsImxvY2tlZFByb3BlcnR5IiwidmFsdWUiLCJ0ZXJtQ2VsbCIsInBsYXRlIiwiZ2V0Q2VsbEZvclRlcm0iLCJlcXVpdmFsZW50VGVybSIsIm9wcG9zaXRlUGxhdGUiLCJnZXRDbG9zZXN0RXF1aXZhbGVudFRlcm0iLCJlcXVpdmFsZW50VGVybUNyZWF0b3IiLCJyZW1vdmVUZXJtRnJvbVBsYXRlIiwiaXNGdWxsIiwidGhpc0lzTGVmdFNpZGUiLCJwb3NpdGl2ZVBvc2l0aW9uIiwieCIsInJpZ2h0U2lkZUZ1bGxEaWFsb2ciLCJzaG93IiwibGVmdFNpZGVGdWxsRGlhbG9nIiwiaW50ZXJydXB0IiwiY3JlYXRlVGVybSIsImNvcHlPcHRpb25zIiwic2lnbiIsImludmVyc2VUZXJtUG9zaXRpb24iLCJnZXRFcXVpdmFsZW50VGVybVBvc2l0aW9uIiwiaW52ZXJzZUNlbGwiLCJnZXRCZXN0RW1wdHlDZWxsIiwicHV0VGVybU9uUGxhdGUiLCJsYXp5TGluayIsImVuZE9wcG9zaXRlIiwiZW1wdHlDZWxsIiwicG9zaXRpb25Qcm9wZXJ0eSIsImFuaW1hdGVUb1BsYXRlIiwiYW5pbWF0ZVRvVG9vbGJveCIsImNlbGwiLCJjZWxsUG9zaXRpb24iLCJnZXRQb3NpdGlvbk9mQ2VsbCIsInBpY2thYmxlUHJvcGVydHkiLCJwaWNrYWJsZVdoaWxlQW5pbWF0aW5nIiwiYW5pbWF0ZVRvIiwiYW5pbWF0aW9uU3RlcENhbGxiYWNrIiwiaXNFbXB0eUNlbGwiLCJhbmltYXRpb25Db21wbGV0ZWRDYWxsYmFjayIsImlzRGlzcG9zZWQiLCJlcXVpdmFsZW50Q2VsbCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiU2VwYXJhdGVUZXJtc0RyYWdMaXN0ZW5lci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTZXBhcmF0ZVRlcm1zRHJhZ0xpc3RlbmVyIGlzIHVzZWQgd2hlbiBsaWtlIHRlcm1zIG9jY3VweSBzZXBhcmF0ZSBjZWxscyBvbiBhIHBsYXRlLlxyXG4gKiBMaWtlIHRlcm1zIGFyZSBjb21iaW5lZCBvbmx5IGlmIHRoZXkgc3VtIHRvIHplcm8uXHJcbiAqIFNlZSB0ZXJtaW5vbG9neSBhbmQgcmVxdWlyZW1lbnRzIGluIFRlcm1EcmFnTGlzdGVuZXIgc3VwZXJjbGFzcy5cclxuICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9lcXVhbGl0eS1leHBsb3Jlci9ibG9iL21hc3Rlci9kb2MvbG9jay1zY2VuYXJpb3MubWQgZm9yIHNjZW5hcmlvcyB0aGF0XHJcbiAqIGRlc2NyaWJlIGhvdyB0aGlzIGZlYXR1cmUgd29ya3MuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgY29tYmluZU9wdGlvbnMsIEVtcHR5U2VsZk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IGVxdWFsaXR5RXhwbG9yZXIgZnJvbSAnLi4vLi4vZXF1YWxpdHlFeHBsb3Jlci5qcyc7XHJcbmltcG9ydCBUZXJtIGZyb20gJy4uL21vZGVsL1Rlcm0uanMnO1xyXG5pbXBvcnQgVGVybUNyZWF0b3IsIHsgQ3JlYXRlVGVybU9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbC9UZXJtQ3JlYXRvci5qcyc7XHJcbmltcG9ydCBUZXJtRHJhZ0xpc3RlbmVyLCB7IFRlcm1EcmFnTGlzdGVuZXJPcHRpb25zIH0gZnJvbSAnLi9UZXJtRHJhZ0xpc3RlbmVyLmpzJztcclxuaW1wb3J0IFRlcm1Ob2RlIGZyb20gJy4vVGVybU5vZGUuanMnO1xyXG5pbXBvcnQgU3VtVG9aZXJvTm9kZSBmcm9tICcuL1N1bVRvWmVyb05vZGUuanMnO1xyXG5pbXBvcnQgRXF1YWxpdHlFeHBsb3JlclNjZW5lTm9kZSBmcm9tICcuL0VxdWFsaXR5RXhwbG9yZXJTY2VuZU5vZGUuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIFNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXJPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBUZXJtRHJhZ0xpc3RlbmVyT3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXIgZXh0ZW5kcyBUZXJtRHJhZ0xpc3RlbmVyIHtcclxuXHJcbiAgLy8gaW52ZXJzZSB0ZXJtIG9uIG9wcG9zaXRlIHBsYXRlLCBmb3IgbG9jayBmZWF0dXJlXHJcbiAgcHJpdmF0ZSBpbnZlcnNlVGVybTogVGVybSB8IG51bGw7XHJcblxyXG4gIC8vIElmIHRoZSBpbnZlcnNlIHRlcm0gaXMgZHJhZ2dlZCwgYnJlYWsgdGhlIGFzc29jaWF0aW9uIGJldHdlZW4gZXF1aXZhbGVudFRlcm0gYW5kIGludmVyc2VUZXJtXHJcbiAgcHJpdmF0ZSByZWFkb25seSBpbnZlcnNlVGVybURyYWdnaW5nTGlzdGVuZXI6ICggZHJhZ2dpbmc6IGJvb2xlYW4gKSA9PiB2b2lkO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VTZXBhcmF0ZVRlcm1zRHJhZ0xpc3RlbmVyOiAoKSA9PiB2b2lkO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gdGVybU5vZGUgLSBOb2RlIHRoYXQgdGhlIGxpc3RlbmVyIGlzIGF0dGFjaGVkIHRvXHJcbiAgICogQHBhcmFtIHRlcm0gLSB0aGUgdGVybSBiZWluZyBkcmFnZ2VkXHJcbiAgICogQHBhcmFtIHRlcm1DcmVhdG9yIC0gdGhlIGNyZWF0b3Igb2YgdGVybVxyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggdGVybU5vZGU6IFRlcm1Ob2RlLCB0ZXJtOiBUZXJtLCB0ZXJtQ3JlYXRvcjogVGVybUNyZWF0b3IsIHByb3ZpZGVkT3B0aW9ucz86IFNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXJPcHRpb25zICkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggIXRlcm1DcmVhdG9yLmNvbWJpbmVMaWtlVGVybXNFbmFibGVkLFxyXG4gICAgICAnU2VwYXJhdGVUZXJtc0RyYWdMaXN0ZW5lciBpcyB1c2VkIHdoZW4gbGlrZSB0ZXJtcyBvY2N1cHkgc2VwYXJhdGUgY2VsbHMnICk7XHJcblxyXG4gICAgc3VwZXIoIHRlcm1Ob2RlLCB0ZXJtLCB0ZXJtQ3JlYXRvciwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5pbnZlcnNlVGVybSA9IG51bGw7XHJcblxyXG4gICAgdGhpcy5pbnZlcnNlVGVybURyYWdnaW5nTGlzdGVuZXIgPSBkcmFnZ2luZyA9PiB7XHJcbiAgICAgIGNvbnN0IGludmVyc2VUZXJtID0gdGhpcy5pbnZlcnNlVGVybSE7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIGludmVyc2VUZXJtLCAndGhlcmUgaXMgbm8gYXNzb2NpYXRlZCBpbnZlcnNlIHRlcm0nICk7XHJcbiAgICAgIGlmICggZHJhZ2dpbmcgKSB7XHJcbiAgICAgICAgaWYgKCBpbnZlcnNlVGVybS5kcmFnZ2luZ1Byb3BlcnR5Lmhhc0xpc3RlbmVyKCB0aGlzLmludmVyc2VUZXJtRHJhZ2dpbmdMaXN0ZW5lciApICkge1xyXG4gICAgICAgICAgaW52ZXJzZVRlcm0uZHJhZ2dpbmdQcm9wZXJ0eS51bmxpbmsoIHRoaXMuaW52ZXJzZVRlcm1EcmFnZ2luZ0xpc3RlbmVyICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW52ZXJzZVRlcm0gPSBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuZGlzcG9zZVNlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXIgPSAoKSA9PiB7XHJcbiAgICAgIGlmICggdGhpcy5pbnZlcnNlVGVybSAmJiB0aGlzLmludmVyc2VUZXJtLmRyYWdnaW5nUHJvcGVydHkuaGFzTGlzdGVuZXIoIHRoaXMuaW52ZXJzZVRlcm1EcmFnZ2luZ0xpc3RlbmVyICkgKSB7XHJcbiAgICAgICAgdGhpcy5pbnZlcnNlVGVybS5kcmFnZ2luZ1Byb3BlcnR5LnVubGluayggdGhpcy5pbnZlcnNlVGVybURyYWdnaW5nTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlU2VwYXJhdGVUZXJtc0RyYWdMaXN0ZW5lcigpO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgLy8gQmVsb3cgaGVyZSBpcyB0aGUgaW1wbGVtZW50YXRpb24gb2YgdGhlIFRlcm1EcmFnTGlzdGVuZXIgQVBJXHJcbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxlZCBhdCB0aGUgc3RhcnQgb2YgYSBkcmFnIGN5Y2xlLCB3aGVuIGxvY2sgaXMgb24sIHRvIGhhbmRsZSByZWxhdGVkIHRlcm1zIG9uIHRoZSBvcHBvc2l0ZSBzaWRlLlxyXG4gICAqIEByZXR1cm5zIHRydWU9c3VjY2VzcywgZmFsc2U9ZmFpbHVyZVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBvdmVycmlkZSBzdGFydE9wcG9zaXRlKCk6IGJvb2xlYW4ge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy50ZXJtQ3JlYXRvci5sb2NrZWRQcm9wZXJ0eS52YWx1ZSwgJ3N0YXJ0T3Bwb3NpdGUgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4gbG9jayBpcyBvbicgKTtcclxuXHJcbiAgICBjb25zdCB0ZXJtQ2VsbCA9IHRoaXMucGxhdGUuZ2V0Q2VsbEZvclRlcm0oIHRoaXMudGVybSApITtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRlcm1DZWxsICE9PSBudWxsICk7XHJcbiAgICB0aGlzLmVxdWl2YWxlbnRUZXJtID0gdGhpcy5vcHBvc2l0ZVBsYXRlLmdldENsb3Nlc3RFcXVpdmFsZW50VGVybSggdGhpcy50ZXJtLCB0ZXJtQ2VsbCApO1xyXG5cclxuICAgIGlmICggdGhpcy5lcXVpdmFsZW50VGVybSApIHtcclxuXHJcbiAgICAgIC8vIGZvdW5kIGVxdWl2YWxlbnQgdGVybSBvbiBvcHBvc2l0ZSBwbGF0ZSwgcmVtb3ZlIGl0IGZyb20gcGxhdGVcclxuICAgICAgdGhpcy5lcXVpdmFsZW50VGVybUNyZWF0b3IucmVtb3ZlVGVybUZyb21QbGF0ZSggdGhpcy5lcXVpdmFsZW50VGVybSApO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIHRoaXMub3Bwb3NpdGVQbGF0ZS5pc0Z1bGwoKSApIHtcclxuXHJcbiAgICAgIC8vIE9wcG9zaXRlIHBsYXRlIGlzIGZ1bGwsIGNhbm5vdCBjcmVhdGUgaW52ZXJzZSB0ZXJtLCBzaG93ICdPb3BzJyBtZXNzYWdlLlxyXG4gICAgICAvLyBUbyB0ZXN0IHRoaXMsIHNlZSBkb2MgZm9yIEVxdWFsaXR5RXhwbG9yZXJTY2VuZU5vZGUubGVmdFNpZGVGdWxsRGlhbG9nIGFuZCByaWdodFNpZGVGdWxsRGlhbG9nLlxyXG4gICAgICBjb25zdCB0aGlzSXNMZWZ0U2lkZSA9ICggdGhpcy50ZXJtQ3JlYXRvci5wb3NpdGl2ZVBvc2l0aW9uLnggPCB0aGlzLmVxdWl2YWxlbnRUZXJtQ3JlYXRvci5wb3NpdGl2ZVBvc2l0aW9uLnggKTtcclxuICAgICAgaWYgKCB0aGlzSXNMZWZ0U2lkZSApIHtcclxuICAgICAgICBFcXVhbGl0eUV4cGxvcmVyU2NlbmVOb2RlLnJpZ2h0U2lkZUZ1bGxEaWFsb2cuc2hvdygpO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIEVxdWFsaXR5RXhwbG9yZXJTY2VuZU5vZGUubGVmdFNpZGVGdWxsRGlhbG9nLnNob3coKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gaW50ZXJydXB0IHRoaXMgZHJhZyBzZXF1ZW5jZSwgc2luY2Ugd2UgY2FuJ3QgdGFrZSB0ZXJtIG9mZiB0aGUgcGxhdGVcclxuICAgICAgdGhpcy5pbnRlcnJ1cHQoKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICAvLyBubyBlcXVpdmFsZW50IHRlcm0gb24gb3Bwb3NpdGUgcGxhdGUsIGNyZWF0ZSBhbiBpbnZlcnNlIHRlcm1cclxuICAgICAgdGhpcy5pbnZlcnNlVGVybSA9IHRoaXMuZXF1aXZhbGVudFRlcm1DcmVhdG9yLmNyZWF0ZVRlcm0oXHJcbiAgICAgICAgY29tYmluZU9wdGlvbnM8Q3JlYXRlVGVybU9wdGlvbnM+KCB7fSwgdGhpcy50ZXJtLmNvcHlPcHRpb25zKCksIHtcclxuICAgICAgICAgIHNpZ246IC0xXHJcbiAgICAgICAgfSApICk7XHJcbiAgICAgIGNvbnN0IGludmVyc2VUZXJtUG9zaXRpb24gPSB0aGlzLnRlcm1DcmVhdG9yLmdldEVxdWl2YWxlbnRUZXJtUG9zaXRpb24oIHRoaXMudGVybSApO1xyXG4gICAgICBjb25zdCBpbnZlcnNlQ2VsbCA9IHRoaXMub3Bwb3NpdGVQbGF0ZS5nZXRCZXN0RW1wdHlDZWxsKCBpbnZlcnNlVGVybVBvc2l0aW9uICkhO1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBpbnZlcnNlQ2VsbCAhPT0gbnVsbCApO1xyXG4gICAgICB0aGlzLmVxdWl2YWxlbnRUZXJtQ3JlYXRvci5wdXRUZXJtT25QbGF0ZSggdGhpcy5pbnZlcnNlVGVybSwgaW52ZXJzZUNlbGwgKTtcclxuXHJcbiAgICAgIC8vIGlmIHRoZSBpbnZlcnNlIHRlcm0gaXMgZHJhZ2dlZCwgYnJlYWsgdGhlIGFzc29jaWF0aW9uIHRvIGVxdWl2YWxlbnRUZXJtXHJcbiAgICAgIHRoaXMuaW52ZXJzZVRlcm0uZHJhZ2dpbmdQcm9wZXJ0eS5sYXp5TGluayggdGhpcy5pbnZlcnNlVGVybURyYWdnaW5nTGlzdGVuZXIgKTtcclxuXHJcbiAgICAgIC8vIGNyZWF0ZSB0aGUgZXF1aXZhbGVudCB0ZXJtIG9uIHRoZSBvcHBvc2l0ZSBzaWRlXHJcbiAgICAgIC8vIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgaW52ZXJzZVRlcm0gc28gdGhhdCBpdCBhcHBlYXIgaW4gZnJvbnQgb2YgaW52ZXJzZVRlcm0uXHJcbiAgICAgIHRoaXMuZXF1aXZhbGVudFRlcm0gPSB0aGlzLmVxdWl2YWxlbnRUZXJtQ3JlYXRvci5jcmVhdGVUZXJtKCB0aGlzLnRlcm0uY29weU9wdGlvbnMoKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FsbGVkIGF0IHRoZSBlbmQgb2YgYSBkcmFnIGN5Y2xlLCB3aGVuIGxvY2sgaXMgb24sIHRvIGhhbmRsZSByZWxhdGVkIHRlcm1zIG9uIHRoZSBvcHBvc2l0ZSBzaWRlLlxyXG4gICAqIEByZXR1cm5zIG5vbi1udWxsIGlmIHRoZSBkcmFnIHJlc3VsdHMgaW4gdGVybXMgb24gdGhlIG9wcG9zaXRlIHBsYXRlIHN1bW1pbmcgdG8gemVyb1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBvdmVycmlkZSBlbmRPcHBvc2l0ZSgpOiBTdW1Ub1plcm9Ob2RlIHwgbnVsbCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLnRlcm1DcmVhdG9yLmxvY2tlZFByb3BlcnR5LnZhbHVlLCAnZW5kT3Bwb3NpdGUgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4gbG9jayBpcyBvbicgKTtcclxuXHJcbiAgICBjb25zdCBlcXVpdmFsZW50VGVybSA9IHRoaXMuZXF1aXZhbGVudFRlcm0hO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZXF1aXZhbGVudFRlcm0gKTtcclxuXHJcbiAgICAvLyBwdXQgZXF1aXZhbGVudCB0ZXJtIGluIGFuIGVtcHR5IGNlbGxcclxuICAgIGNvbnN0IGVtcHR5Q2VsbCA9IHRoaXMub3Bwb3NpdGVQbGF0ZS5nZXRCZXN0RW1wdHlDZWxsKCBlcXVpdmFsZW50VGVybS5wb3NpdGlvblByb3BlcnR5LnZhbHVlICkhO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggZW1wdHlDZWxsICE9PSBudWxsICk7XHJcbiAgICB0aGlzLmVxdWl2YWxlbnRUZXJtQ3JlYXRvci5wdXRUZXJtT25QbGF0ZSggZXF1aXZhbGVudFRlcm0sIGVtcHR5Q2VsbCApO1xyXG5cclxuICAgIC8vIGFsd2F5cyBudWxsIGZvciB0aGlzIHN1YmNsYXNzLCBzaW5jZSB0ZXJtcyBvbiB0aGUgb3Bwb3NpdGUgc2lkZSBkb24ndCBjb21iaW5lXHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFuaW1hdGVzIHRlcm1zIHRvIGVtcHR5IGNlbGxzLlxyXG4gICAqIEluIHRoaXMgc2NlbmFyaW8sIGVhY2ggdGVybSBvY2N1cGllcyBhIGNlbGwgb24gdGhlIHBsYXRlLCBhbmQgbGlrZSB0ZXJtcyBhcmUgbm90IGNvbWJpbmVkLlxyXG4gICAqIElmIHRoZXJlIGFyZSBubyBlbXB0eSBjZWxscyBvbiB0aGUgcGxhdGUsIHRoZSB0ZXJtIGlzIHJldHVybmVkIHRvIHRoZSB0b29sYm94IHdoZXJlIGl0IHdhcyBjcmVhdGVkLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBvdmVycmlkZSBhbmltYXRlVG9QbGF0ZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICF0aGlzLnRlcm1DcmVhdG9yLmNvbWJpbmVMaWtlVGVybXNFbmFibGVkLCAnc2hvdWxkIE5PVCBiZSBjYWxsZWQgd2hlbiBjb21iaW5pbmcgbGlrZSB0ZXJtcycgKTtcclxuXHJcbiAgICBpZiAoIHRoaXMucGxhdGUuaXNGdWxsKCkgfHwgKCB0aGlzLmVxdWl2YWxlbnRUZXJtICYmIHRoaXMub3Bwb3NpdGVQbGF0ZS5pc0Z1bGwoKSApICkge1xyXG5cclxuICAgICAgLy8gUGxhdGUgaXMgZnVsbCwgcmV0dXJuIHRvIHRoZSB0b29sYm94LlxyXG4gICAgICB0aGlzLmFuaW1hdGVUb1Rvb2xib3goKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG5cclxuICAgICAgLy8gdGhlIHRhcmdldCBjZWxsIGFuZCBpdHMgcG9zaXRpb25cclxuICAgICAgY29uc3QgY2VsbCA9IHRoaXMucGxhdGUuZ2V0QmVzdEVtcHR5Q2VsbCggdGhpcy50ZXJtLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgKSE7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIGNlbGwgIT09IG51bGwgKTtcclxuICAgICAgY29uc3QgY2VsbFBvc2l0aW9uID0gdGhpcy5wbGF0ZS5nZXRQb3NpdGlvbk9mQ2VsbCggY2VsbCApO1xyXG5cclxuICAgICAgdGhpcy50ZXJtLnBpY2thYmxlUHJvcGVydHkudmFsdWUgPSB0aGlzLnBpY2thYmxlV2hpbGVBbmltYXRpbmc7XHJcblxyXG4gICAgICB0aGlzLnRlcm0uYW5pbWF0ZVRvKCBjZWxsUG9zaXRpb24sIHtcclxuXHJcbiAgICAgICAgLy8gT24gZWFjaCBhbmltYXRpb24gc3RlcC4uLlxyXG4gICAgICAgIGFuaW1hdGlvblN0ZXBDYWxsYmFjazogKCkgPT4ge1xyXG5cclxuICAgICAgICAgIC8vIElmIHRoZSB0YXJnZXQgY2VsbCBoYXMgYmVjb21lIG9jY3VwaWVkLCBvciB0aGUgb3Bwb3NpdGUgcGxhdGUgaXMgZnVsbCwgdHJ5IGFnYWluLlxyXG4gICAgICAgICAgaWYgKCAhdGhpcy5wbGF0ZS5pc0VtcHR5Q2VsbCggY2VsbCApIHx8ICggdGhpcy5lcXVpdmFsZW50VGVybSAmJiB0aGlzLm9wcG9zaXRlUGxhdGUuaXNGdWxsKCkgKSApIHtcclxuICAgICAgICAgICAgdGhpcy5hbmltYXRlVG9QbGF0ZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8vIFdoZW4gdGhlIHRlcm0gcmVhY2hlcyB0aGUgY2VsbC4uLlxyXG4gICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZENhbGxiYWNrOiAoKSA9PiB7XHJcblxyXG4gICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIXRoaXMucGxhdGUuaXNGdWxsKCksICdwbGF0ZSBpcyBmdWxsJyApO1xyXG4gICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggISggdGhpcy5lcXVpdmFsZW50VGVybSAmJiB0aGlzLm9wcG9zaXRlUGxhdGUuaXNGdWxsKCkgKSwgJ29wcG9zaXRlIHBsYXRlIGlzIGZ1bGwnICk7XHJcblxyXG4gICAgICAgICAgLy8gQ29tcHV0ZSBjZWxsIGFnYWluLCBpbiBjYXNlIGEgdGVybSBoYXMgYmVlbiByZW1vdmVkIGJlbG93IHRoZSBjZWxsIHRoYXQgd2Ugd2VyZSBhbmltYXRpbmcgdG8uXHJcbiAgICAgICAgICBjb25zdCBjZWxsID0gdGhpcy5wbGF0ZS5nZXRCZXN0RW1wdHlDZWxsKCB0aGlzLnRlcm0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSApITtcclxuICAgICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIGNlbGwgIT09IG51bGwgKTtcclxuXHJcbiAgICAgICAgICAvLyBQdXQgdGhlIHRlcm0gb24gdGhlIHBsYXRlXHJcbiAgICAgICAgICB0aGlzLnRlcm1DcmVhdG9yLnB1dFRlcm1PblBsYXRlKCB0aGlzLnRlcm0sIGNlbGwgKTtcclxuICAgICAgICAgIHRoaXMudGVybS5waWNrYWJsZVByb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAvLyBIYW5kbGUgcmVsYXRlZCB0ZXJtcyBvbiBvcHBvc2l0ZSBzaWRlLlxyXG4gICAgICAgICAgLy8gTm90ZSB0aGF0IGVxdWl2YWxlbnRUZXJtIGFuZC9vciBpbnZlcnNlVGVybSBtYXkgaGF2ZSBiZWVuIGRpc3Bvc2VkIG9mLCBzbyBoYW5kbGUgdGhhdC5cclxuICAgICAgICAgIGlmICggdGhpcy5lcXVpdmFsZW50VGVybSApIHtcclxuICAgICAgICAgICAgaWYgKCB0aGlzLmludmVyc2VUZXJtICkge1xyXG5cclxuICAgICAgICAgICAgICAvLyBFcXVpdmFsZW50IGFuZCBpbnZlcnNlIHRlcm0gY2FuY2VsIGVhY2ggb3RoZXIgb3V0LlxyXG4gICAgICAgICAgICAgICF0aGlzLmludmVyc2VUZXJtLmlzRGlzcG9zZWQgJiYgdGhpcy5pbnZlcnNlVGVybS5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5pbnZlcnNlVGVybSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgIXRoaXMuZXF1aXZhbGVudFRlcm0uaXNEaXNwb3NlZCAmJiB0aGlzLmVxdWl2YWxlbnRUZXJtLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgICB0aGlzLmVxdWl2YWxlbnRUZXJtID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICggIXRoaXMuZXF1aXZhbGVudFRlcm0uaXNEaXNwb3NlZCApIHtcclxuXHJcbiAgICAgICAgICAgICAgLy8gVHJhbnNmZXIgdGhpcy5lcXVpdmFsZW50VGVybSB0byBhIGxvY2FsIHZhcmlhYmxlIGFuZCBzZXQgdG8gbnVsbCwgc28gdGhhdCBlcXVpdmFsZW50VGVybVxyXG4gICAgICAgICAgICAgIC8vIG5vIGxvbmdlciB0cmFja3MgbW92ZW1lbnQgb2YgdGVybS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9lcXVhbGl0eS1leHBsb3Jlci9pc3N1ZXMvOTBcclxuICAgICAgICAgICAgICBjb25zdCBlcXVpdmFsZW50VGVybSA9IHRoaXMuZXF1aXZhbGVudFRlcm07XHJcbiAgICAgICAgICAgICAgdGhpcy5lcXVpdmFsZW50VGVybSA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgIC8vIFB1dCBlcXVpdmFsZW50IHRlcm0gb24gdGhlIG9wcG9zaXRlIHBsYXRlXHJcbiAgICAgICAgICAgICAgY29uc3QgZXF1aXZhbGVudENlbGwgPSB0aGlzLm9wcG9zaXRlUGxhdGUuZ2V0QmVzdEVtcHR5Q2VsbCggZXF1aXZhbGVudFRlcm0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSApITtcclxuICAgICAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBlcXVpdmFsZW50Q2VsbCAhPT0gbnVsbCApO1xyXG4gICAgICAgICAgICAgIHRoaXMuZXF1aXZhbGVudFRlcm1DcmVhdG9yLnB1dFRlcm1PblBsYXRlKCBlcXVpdmFsZW50VGVybSwgZXF1aXZhbGVudENlbGwgKTtcclxuICAgICAgICAgICAgICBlcXVpdmFsZW50VGVybS5waWNrYWJsZVByb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgLy8gRG8gbm90aGluZyAtIGVxdWl2YWxlbnRUZXJtIHdhcyBkaXNwb3NlZCBiZWZvcmUgYW5pbWF0aW9uQ29tcGxldGVkQ2FsbGJhY2sgd2FzIGNhbGxlZC5cclxuICAgICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2VxdWFsaXR5LWV4cGxvcmVyL2lzc3Vlcy84OFxyXG4gICAgICAgICAgICAgIHRoaXMuZXF1aXZhbGVudFRlcm0gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5lcXVpdmFsZW50VGVybSA9PT0gbnVsbCwgJ2VxdWl2YWxlbnRUZXJtIHNob3VsZCBiZSBudWxsJyApO1xyXG4gICAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5pbnZlcnNlVGVybSA9PT0gbnVsbCwgJ2ludmVyc2VUZXJtIHNob3VsZCBiZSBudWxsJyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXF1YWxpdHlFeHBsb3Jlci5yZWdpc3RlciggJ1NlcGFyYXRlVGVybXNEcmFnTGlzdGVuZXInLCBTZXBhcmF0ZVRlcm1zRHJhZ0xpc3RlbmVyICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsU0FBU0EsY0FBYyxRQUEwQix1Q0FBdUM7QUFDeEYsT0FBT0MsZ0JBQWdCLE1BQU0sMkJBQTJCO0FBR3hELE9BQU9DLGdCQUFnQixNQUFtQyx1QkFBdUI7QUFHakYsT0FBT0MseUJBQXlCLE1BQU0sZ0NBQWdDO0FBTXRFLGVBQWUsTUFBTUMseUJBQXlCLFNBQVNGLGdCQUFnQixDQUFDO0VBRXRFOztFQUdBOztFQUtBO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTRyxXQUFXQSxDQUFFQyxRQUFrQixFQUFFQyxJQUFVLEVBQUVDLFdBQXdCLEVBQUVDLGVBQWtELEVBQUc7SUFDaklDLE1BQU0sSUFBSUEsTUFBTSxDQUFFLENBQUNGLFdBQVcsQ0FBQ0csdUJBQXVCLEVBQ3BELHlFQUEwRSxDQUFDO0lBRTdFLEtBQUssQ0FBRUwsUUFBUSxFQUFFQyxJQUFJLEVBQUVDLFdBQVcsRUFBRUMsZUFBZ0IsQ0FBQztJQUVyRCxJQUFJLENBQUNHLFdBQVcsR0FBRyxJQUFJO0lBRXZCLElBQUksQ0FBQ0Ms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