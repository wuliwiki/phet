// Copyright 2017-2023, University of Colorado Boulder

//TODO https://github.com/phetsims/equality-explorer/issues/202 presentation of equations in Studio and data stream
/**
 * Displays an equation or inequality, possibly involving multiple variables.
 * Origin is at the center of the relational operator, to facilitate horizontal alignment with the scale.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import optionize from '../../../../phet-core/js/optionize.js';
import Fraction from '../../../../phetcommon/js/model/Fraction.js';
import MathSymbolFont from '../../../../scenery-phet/js/MathSymbolFont.js';
import MathSymbols from '../../../../scenery-phet/js/MathSymbols.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { HBox, Node, Text } from '../../../../scenery/js/imports.js';
import ObjectTermCreator from '../model/ObjectTermCreator.js';
import ObjectTermNode from './ObjectTermNode.js';
import equalityExplorer from '../../equalityExplorer.js';
import ConstantTermCreator from '../model/ConstantTermCreator.js';
import VariableTermCreator from '../model/VariableTermCreator.js';
import ConstantTermNode from './ConstantTermNode.js';
import VariableTermNode from './VariableTermNode.js';
import Tandem from '../../../../tandem/js/Tandem.js';

// constants
const DEFAULT_FONT_SIZE = 30;
export default class EquationNode extends Node {
  // left side of the equation
  // right side of the equation
  /**
   * @param leftTermCreators - left side of equation, terms appear in this order
   * @param rightTermCreators - right side of equation, terms appear in this order
   * @param [providedOptions]
   */
  constructor(leftTermCreators, rightTermCreators, providedOptions) {
    const options = optionize()({
      // SelfOptions
      updateEnabled: true,
      symbolFontSize: DEFAULT_FONT_SIZE,
      operatorFontSize: DEFAULT_FONT_SIZE,
      integerFontSize: DEFAULT_FONT_SIZE,
      fractionFontSize: 0.6 * DEFAULT_FONT_SIZE,
      relationalOperatorFontSize: 1.5 * DEFAULT_FONT_SIZE,
      relationalOperatorFontWeight: 'bold',
      coefficientSpacing: 3,
      plusSpacing: 8,
      relationalOperatorSpacing: 20,
      // NodeOptions
      tandem: Tandem.OPTIONAL,
      phetioVisiblePropertyInstrumented: false
    }, providedOptions);
    super(options);
    this.leftTermCreators = leftTermCreators;
    this.rightTermCreators = rightTermCreators;
    this.relationalOperatorSpacing = options.relationalOperatorSpacing;

    // expressions for the left and right sides of the equation
    this.leftExpressionNode = null;
    this.rightExpressionNode = null;

    // relational operator that separates the two expressions
    this.relationalOperatorText = new Text('?', {
      font: new PhetFont({
        size: options.relationalOperatorFontSize,
        weight: options.relationalOperatorFontWeight
      })
    });

    // information for one side of the equation, passed to createExpressionNode
    this.expressionNodeOptions = {
      symbolFont: new MathSymbolFont(options.symbolFontSize),
      operatorFont: new PhetFont(options.operatorFontSize),
      integerFont: new PhetFont(options.integerFontSize),
      fractionFont: new PhetFont(options.fractionFontSize),
      coefficientSpacing: options.coefficientSpacing,
      plusSpacing: options.plusSpacing
    };
    if (options.updateEnabled) {
      // The equation needs to be dynamically updated.
      const allTermCreators = leftTermCreators.concat(rightTermCreators);

      // Update the relational operator when weight on either plate changes.
      Multilink.multilinkAny(allTermCreators.map(termCreator => termCreator.weightOnPlateProperty), () => this.updateRelationalOperator());

      // Update the expressions number of terms on either plate changes.
      Multilink.multilinkAny(allTermCreators.map(termCreator => termCreator.numberOfTermsOnPlateProperty), () => this.updateExpressions());
    } else {
      this.update();
    }
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }

  /**
   * Use this to update a static equation that was created with updateEnabled: false.
   */
  update() {
    this.updateRelationalOperator();
    this.updateExpressions();
  }

  /**
   * Updates the equation's left and right expressions, on either side of the relational operator.
   */
  updateExpressions() {
    // Existing expressions may be linked to translated StringProperties, so they must be disposed.
    this.leftExpressionNode && this.leftExpressionNode.dispose();
    this.rightExpressionNode && this.rightExpressionNode.dispose();

    // Create new expressions.
    this.leftExpressionNode = new ExpressionNode(this.leftTermCreators, this.expressionNodeOptions);
    this.rightExpressionNode = new ExpressionNode(this.rightTermCreators, this.expressionNodeOptions);
    this.children = [this.leftExpressionNode, this.relationalOperatorText, this.rightExpressionNode];
    this.updateLayout();
  }

  /**
   * Updates the relational operator, based on left vs right weight.
   */
  updateRelationalOperator() {
    this.relationalOperatorText.string = getRelationalOperator(this.leftTermCreators, this.rightTermCreators);
    this.updateLayout();
  }

  /**
   * Updates the equation's layout. Origin must be at the center of the relational operator, so that we
   * can align the equation properly above the balance scale.
   */
  updateLayout() {
    if (this.leftExpressionNode && this.rightExpressionNode) {
      this.relationalOperatorText.centerX = 0;
      this.relationalOperatorText.centerY = 0;
      this.leftExpressionNode.right = this.relationalOperatorText.left - this.relationalOperatorSpacing;
      this.leftExpressionNode.centerY = this.relationalOperatorText.centerY;
      this.rightExpressionNode.left = this.relationalOperatorText.right + this.relationalOperatorSpacing;
      this.rightExpressionNode.centerY = this.relationalOperatorText.centerY;
    }
  }
}

/**
 * Gets the operator that describes the relationship between the left and right sides.
 */
function getRelationalOperator(leftTermCreators, rightTermCreators) {
  // evaluate the left side
  let leftWeight = Fraction.fromInteger(0);
  for (let i = 0; i < leftTermCreators.length; i++) {
    leftWeight = leftWeight.plus(leftTermCreators[i].weightOnPlateProperty.value);
  }

  // evaluate the right side
  let rightWeight = Fraction.fromInteger(0);
  for (let i = 0; i < rightTermCreators.length; i++) {
    rightWeight = rightWeight.plus(rightTermCreators[i].weightOnPlateProperty.value);
  }

  // determine the operator that describes the relationship between left and right sides
  let relationalOperator;
  if (leftWeight.isLessThan(rightWeight)) {
    relationalOperator = MathSymbols.LESS_THAN;
  } else if (rightWeight.isLessThan(leftWeight)) {
    relationalOperator = MathSymbols.GREATER_THAN;
  } else {
    relationalOperator = MathSymbols.EQUAL_TO;
  }
  return relationalOperator;
}
/**
 * An expression is one side of the equation.
 */
class ExpressionNode extends HBox {
  constructor(termCreators, providedOptions) {
    const children = [];
    const childrenToDispose = [];
    for (let i = 0; i < termCreators.length; i++) {
      const termCreator = termCreators[i];
      const numberOfTermsOnPlate = termCreator.numberOfTermsOnPlateProperty.value;
      if (numberOfTermsOnPlate > 0) {
        if (termCreator instanceof ObjectTermCreator) {
          // if there were previous terms, add an operator
          if (children.length > 0) {
            children.push(valueToOperatorText(numberOfTermsOnPlate, providedOptions.operatorFont));
          }

          // Each ObjectTerm has an implicit coefficient of 1, so use the number of terms as the coefficient.
          children.push(ObjectTermNode.createEquationTermNode(numberOfTermsOnPlate, termCreator.createIcon(), {
            font: providedOptions.integerFont,
            spacing: providedOptions.coefficientSpacing
          }));
        } else if (termCreator instanceof VariableTermCreator) {
          let coefficient = termCreator.sumCoefficientsOnPlate();
          if (coefficient.getValue() !== 0) {
            // if there were previous terms, replace the coefficient's sign with an operator
            if (children.length > 0) {
              children.push(valueToOperatorText(coefficient.getValue(), providedOptions.operatorFont));
              coefficient = coefficient.abs();
            }
            const variable = termCreator.variable;
            assert && assert(variable);

            // Must be disposed because it links to a translated StringProperty.
            const equationTermNode = VariableTermNode.createEquationTermNode(coefficient, variable.symbolProperty, {
              integerFont: providedOptions.integerFont,
              fractionFont: providedOptions.fractionFont,
              symbolFont: providedOptions.symbolFont
            });
            children.push(equationTermNode);
            childrenToDispose.push(equationTermNode);
          }
        } else if (termCreator instanceof ConstantTermCreator) {
          let constantValue = termCreator.sumConstantsOnPlate();
          if (constantValue.getValue() !== 0) {
            // if there were previous terms, replace the constant's sign with an operator
            if (children.length > 0) {
              children.push(valueToOperatorText(constantValue.getValue(), providedOptions.operatorFont));
              constantValue = constantValue.abs();
            }
            children.push(ConstantTermNode.createEquationTermNode(constantValue, {
              integerFont: providedOptions.integerFont,
              fractionFont: providedOptions.fractionFont
            }));
          }
        } else {
          throw new Error(`unsupported termCreator: ${termCreator}`);
        }
      }
    }

    // if there were no terms, then this side of the equation evaluated to zero
    if (children.length === 0) {
      children.push(new Text('0', {
        font: providedOptions.integerFont
      }));
    }
    super({
      spacing: providedOptions.plusSpacing,
      children: children
    });
    this.disposeExpressionNode = () => {
      childrenToDispose.forEach(node => node.dispose());
    };
  }
  dispose() {
    this.disposeExpressionNode();
    super.dispose();
  }
}

/**
 * Given the value that determines a term's sign, create the corresponding operator node.
 */
function valueToOperatorText(value, operatorFont) {
  const operator = value > 0 ? MathSymbols.PLUS : MathSymbols.MINUS;
  return new Text(operator, {
    font: operatorFont
  });
}
equalityExplorer.register('EquationNode', EquationNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJvcHRpb25pemUiLCJGcmFjdGlvbiIsIk1hdGhTeW1ib2xGb250IiwiTWF0aFN5bWJvbHMiLCJQaGV0Rm9udCIsIkhCb3giLCJOb2RlIiwiVGV4dCIsIk9iamVjdFRlcm1DcmVhdG9yIiwiT2JqZWN0VGVybU5vZGUiLCJlcXVhbGl0eUV4cGxvcmVyIiwiQ29uc3RhbnRUZXJtQ3JlYXRvciIsIlZhcmlhYmxlVGVybUNyZWF0b3IiLCJDb25zdGFudFRlcm1Ob2RlIiwiVmFyaWFibGVUZXJtTm9kZSIsIlRhbmRlbSIsIkRFRkFVTFRfRk9OVF9TSVpFIiwiRXF1YXRpb25Ob2RlIiwiY29uc3RydWN0b3IiLCJsZWZ0VGVybUNyZWF0b3JzIiwicmlnaHRUZXJtQ3JlYXRvcnMiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwidXBkYXRlRW5hYmxlZCIsInN5bWJvbEZvbnRTaXplIiwib3BlcmF0b3JGb250U2l6ZSIsImludGVnZXJGb250U2l6ZSIsImZyYWN0aW9uRm9udFNpemUiLCJyZWxhdGlvbmFsT3BlcmF0b3JGb250U2l6ZSIsInJlbGF0aW9uYWxPcGVyYXRvckZvbnRXZWlnaHQiLCJjb2VmZmljaWVudFNwYWNpbmciLCJwbHVzU3BhY2luZyIsInJlbGF0aW9uYWxPcGVyYXRvclNwYWNpbmciLCJ0YW5kZW0iLCJPUFRJT05BTCIsInBoZXRpb1Zpc2libGVQcm9wZXJ0eUluc3RydW1lbnRlZCIsImxlZnRFeHByZXNzaW9uTm9kZSIsInJpZ2h0RXhwcmVzc2lvbk5vZGUiLCJyZWxhdGlvbmFsT3BlcmF0b3JUZXh0IiwiZm9udCIsInNpemUiLCJ3ZWlnaHQiLCJleHByZXNzaW9uTm9kZU9wdGlvbnMiLCJzeW1ib2xGb250Iiwib3BlcmF0b3JGb250IiwiaW50ZWdlckZvbnQiLCJmcmFjdGlvbkZvbnQiLCJhbGxUZXJtQ3JlYXRvcnMiLCJjb25jYXQiLCJtdWx0aWxpbmtBbnkiLCJtYXAiLCJ0ZXJtQ3JlYXRvciIsIndlaWdodE9uUGxhdGVQcm9wZXJ0eSIsInVwZGF0ZVJlbGF0aW9uYWxPcGVyYXRvciIsIm51bWJlck9mVGVybXNPblBsYXRlUHJvcGVydHkiLCJ1cGRhdGVFeHByZXNzaW9ucyIsInVwZGF0ZSIsImRpc3Bvc2UiLCJhc3NlcnQiLCJFeHByZXNzaW9uTm9kZSIsImNoaWxkcmVuIiwidXBkYXRlTGF5b3V0Iiwic3RyaW5nIiwiZ2V0UmVsYXRpb25hbE9wZXJhdG9yIiwiY2VudGVyWCIsImNlbnRlclkiLCJyaWdodCIsImxlZnQiLCJsZWZ0V2VpZ2h0IiwiZnJvbUludGVnZXIiLCJpIiwibGVuZ3RoIiwicGx1cyIsInZhbHVlIiwicmlnaHRXZWlnaHQiLCJyZWxhdGlvbmFsT3BlcmF0b3IiLCJpc0xlc3NUaGFuIiwiTEVTU19USEFOIiwiR1JFQVRFUl9USEFOIiwiRVFVQUxfVE8iLCJ0ZXJtQ3JlYXRvcnMiLCJjaGlsZHJlblRvRGlzcG9zZSIsIm51bWJlck9mVGVybXNPblBsYXRlIiwicHVzaCIsInZhbHVlVG9PcGVyYXRvclRleHQiLCJjcmVhdGVFcXVhdGlvblRlcm1Ob2RlIiwiY3JlYXRlSWNvbiIsInNwYWNpbmciLCJjb2VmZmljaWVudCIsInN1bUNvZWZmaWNpZW50c09uUGxhdGUiLCJnZXRWYWx1ZSIsImFicyIsInZhcmlhYmxlIiwiZXF1YXRpb25UZXJtTm9kZSIsInN5bWJvbFByb3BlcnR5IiwiY29uc3RhbnRWYWx1ZSIsInN1bUNvbnN0YW50c09uUGxhdGUiLCJFcnJvciIsImRpc3Bvc2VFeHByZXNzaW9uTm9kZSIsImZvckVhY2giLCJub2RlIiwib3BlcmF0b3IiLCJQTFVTIiwiTUlOVVMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVxdWF0aW9uTm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8vVE9ETyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZXF1YWxpdHktZXhwbG9yZXIvaXNzdWVzLzIwMiBwcmVzZW50YXRpb24gb2YgZXF1YXRpb25zIGluIFN0dWRpbyBhbmQgZGF0YSBzdHJlYW1cclxuLyoqXHJcbiAqIERpc3BsYXlzIGFuIGVxdWF0aW9uIG9yIGluZXF1YWxpdHksIHBvc3NpYmx5IGludm9sdmluZyBtdWx0aXBsZSB2YXJpYWJsZXMuXHJcbiAqIE9yaWdpbiBpcyBhdCB0aGUgY2VudGVyIG9mIHRoZSByZWxhdGlvbmFsIG9wZXJhdG9yLCB0byBmYWNpbGl0YXRlIGhvcml6b250YWwgYWxpZ25tZW50IHdpdGggdGhlIHNjYWxlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgRnJhY3Rpb24gZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy9tb2RlbC9GcmFjdGlvbi5qcyc7XHJcbmltcG9ydCBNYXRoU3ltYm9sRm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvTWF0aFN5bWJvbEZvbnQuanMnO1xyXG5pbXBvcnQgTWF0aFN5bWJvbHMgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL01hdGhTeW1ib2xzLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IEZvbnQsIEZvbnRXZWlnaHQsIEhCb3gsIE5vZGUsIE5vZGVPcHRpb25zLCBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IE9iamVjdFRlcm1DcmVhdG9yIGZyb20gJy4uL21vZGVsL09iamVjdFRlcm1DcmVhdG9yLmpzJztcclxuaW1wb3J0IE9iamVjdFRlcm1Ob2RlIGZyb20gJy4vT2JqZWN0VGVybU5vZGUuanMnO1xyXG5pbXBvcnQgZXF1YWxpdHlFeHBsb3JlciBmcm9tICcuLi8uLi9lcXVhbGl0eUV4cGxvcmVyLmpzJztcclxuaW1wb3J0IENvbnN0YW50VGVybUNyZWF0b3IgZnJvbSAnLi4vbW9kZWwvQ29uc3RhbnRUZXJtQ3JlYXRvci5qcyc7XHJcbmltcG9ydCBUZXJtQ3JlYXRvciBmcm9tICcuLi9tb2RlbC9UZXJtQ3JlYXRvci5qcyc7XHJcbmltcG9ydCBWYXJpYWJsZVRlcm1DcmVhdG9yIGZyb20gJy4uL21vZGVsL1ZhcmlhYmxlVGVybUNyZWF0b3IuanMnO1xyXG5pbXBvcnQgQ29uc3RhbnRUZXJtTm9kZSBmcm9tICcuL0NvbnN0YW50VGVybU5vZGUuanMnO1xyXG5pbXBvcnQgVmFyaWFibGVUZXJtTm9kZSBmcm9tICcuL1ZhcmlhYmxlVGVybU5vZGUuanMnO1xyXG5pbXBvcnQgeyBSZWxhdGlvbmFsT3BlcmF0b3IgfSBmcm9tICcuLi9tb2RlbC9SZWxhdGlvbmFsT3BlcmF0b3IuanMnO1xyXG5pbXBvcnQgUGlja09wdGlvbmFsIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9QaWNrT3B0aW9uYWwuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IERFRkFVTFRfRk9OVF9TSVpFID0gMzA7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBVcGRhdGUgdGhlIHZpZXcgd2hlbiB0aGUgbW9kZWwgY2hhbmdlcz8gU2V0dGluZyB0byBmYWxzZSBjcmVhdGVzIGEgc3RhdGljIGVxdWF0aW9uLlxyXG4gIHVwZGF0ZUVuYWJsZWQ/OiBib29sZWFuO1xyXG5cclxuICAvLyBmb250cyBzaXplcywgb3B0aW1pemVkIGZvciBFcXVhdGlvbkFjY29yZGlvbkJveFxyXG4gIHN5bWJvbEZvbnRTaXplPzogbnVtYmVyO1xyXG4gIG9wZXJhdG9yRm9udFNpemU/OiBudW1iZXI7XHJcbiAgaW50ZWdlckZvbnRTaXplPzogbnVtYmVyO1xyXG4gIGZyYWN0aW9uRm9udFNpemU/OiBudW1iZXI7XHJcbiAgcmVsYXRpb25hbE9wZXJhdG9yRm9udFNpemU/OiBudW1iZXI7XHJcblxyXG4gIHJlbGF0aW9uYWxPcGVyYXRvckZvbnRXZWlnaHQ/OiBGb250V2VpZ2h0O1xyXG5cclxuICAvLyBob3Jpem9udGFsIHNwYWNpbmdcclxuICBjb2VmZmljaWVudFNwYWNpbmc/OiBudW1iZXI7IC8vIHNwYWNlIGJldHdlZW4gY29lZmZpY2llbnQgYW5kIGljb25cclxuICBwbHVzU3BhY2luZz86IG51bWJlcjsgLy8gc3BhY2UgYXJvdW5kIHBsdXMgb3BlcmF0b3JcclxuICByZWxhdGlvbmFsT3BlcmF0b3JTcGFjaW5nPzogbnVtYmVyOyAvLyBzcGFjZSBhcm91bmQgdGhlIHJlbGF0aW9uYWwgb3BlcmF0b3JcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEVxdWF0aW9uTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tPcHRpb25hbDxOb2RlT3B0aW9ucywgJ3BpY2thYmxlJyB8ICd0YW5kZW0nPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVxdWF0aW9uTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGxlZnRUZXJtQ3JlYXRvcnM6IFRlcm1DcmVhdG9yW107XHJcbiAgcHJpdmF0ZSByZWFkb25seSByaWdodFRlcm1DcmVhdG9yczogVGVybUNyZWF0b3JbXTtcclxuICBwcml2YXRlIHJlYWRvbmx5IHJlbGF0aW9uYWxPcGVyYXRvclRleHQ6IFRleHQ7XHJcbiAgcHJpdmF0ZSByZWFkb25seSByZWxhdGlvbmFsT3BlcmF0b3JTcGFjaW5nOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBleHByZXNzaW9uTm9kZU9wdGlvbnM6IEV4cHJlc3Npb25Ob2RlT3B0aW9ucztcclxuXHJcbiAgcHJpdmF0ZSBsZWZ0RXhwcmVzc2lvbk5vZGU6IE5vZGUgfCBudWxsOyAgLy8gbGVmdCBzaWRlIG9mIHRoZSBlcXVhdGlvblxyXG4gIHByaXZhdGUgcmlnaHRFeHByZXNzaW9uTm9kZTogTm9kZSB8IG51bGw7IC8vIHJpZ2h0IHNpZGUgb2YgdGhlIGVxdWF0aW9uXHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBsZWZ0VGVybUNyZWF0b3JzIC0gbGVmdCBzaWRlIG9mIGVxdWF0aW9uLCB0ZXJtcyBhcHBlYXIgaW4gdGhpcyBvcmRlclxyXG4gICAqIEBwYXJhbSByaWdodFRlcm1DcmVhdG9ycyAtIHJpZ2h0IHNpZGUgb2YgZXF1YXRpb24sIHRlcm1zIGFwcGVhciBpbiB0aGlzIG9yZGVyXHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBsZWZ0VGVybUNyZWF0b3JzOiBUZXJtQ3JlYXRvcltdLCByaWdodFRlcm1DcmVhdG9yczogVGVybUNyZWF0b3JbXSxcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IEVxdWF0aW9uTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxFcXVhdGlvbk5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIHVwZGF0ZUVuYWJsZWQ6IHRydWUsXHJcbiAgICAgIHN5bWJvbEZvbnRTaXplOiBERUZBVUxUX0ZPTlRfU0laRSxcclxuICAgICAgb3BlcmF0b3JGb250U2l6ZTogREVGQVVMVF9GT05UX1NJWkUsXHJcbiAgICAgIGludGVnZXJGb250U2l6ZTogREVGQVVMVF9GT05UX1NJWkUsXHJcbiAgICAgIGZyYWN0aW9uRm9udFNpemU6IDAuNiAqIERFRkFVTFRfRk9OVF9TSVpFLFxyXG4gICAgICByZWxhdGlvbmFsT3BlcmF0b3JGb250U2l6ZTogMS41ICogREVGQVVMVF9GT05UX1NJWkUsXHJcbiAgICAgIHJlbGF0aW9uYWxPcGVyYXRvckZvbnRXZWlnaHQ6ICdib2xkJyxcclxuICAgICAgY29lZmZpY2llbnRTcGFjaW5nOiAzLFxyXG4gICAgICBwbHVzU3BhY2luZzogOCxcclxuICAgICAgcmVsYXRpb25hbE9wZXJhdG9yU3BhY2luZzogMjAsXHJcblxyXG4gICAgICAvLyBOb2RlT3B0aW9uc1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5PUFRJT05BTCxcclxuICAgICAgcGhldGlvVmlzaWJsZVByb3BlcnR5SW5zdHJ1bWVudGVkOiBmYWxzZVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLmxlZnRUZXJtQ3JlYXRvcnMgPSBsZWZ0VGVybUNyZWF0b3JzO1xyXG4gICAgdGhpcy5yaWdodFRlcm1DcmVhdG9ycyA9IHJpZ2h0VGVybUNyZWF0b3JzO1xyXG5cclxuICAgIHRoaXMucmVsYXRpb25hbE9wZXJhdG9yU3BhY2luZyA9IG9wdGlvbnMucmVsYXRpb25hbE9wZXJhdG9yU3BhY2luZztcclxuXHJcbiAgICAvLyBleHByZXNzaW9ucyBmb3IgdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGVzIG9mIHRoZSBlcXVhdGlvblxyXG4gICAgdGhpcy5sZWZ0RXhwcmVzc2lvbk5vZGUgPSBudWxsO1xyXG4gICAgdGhpcy5yaWdodEV4cHJlc3Npb25Ob2RlID0gbnVsbDtcclxuXHJcbiAgICAvLyByZWxhdGlvbmFsIG9wZXJhdG9yIHRoYXQgc2VwYXJhdGVzIHRoZSB0d28gZXhwcmVzc2lvbnNcclxuICAgIHRoaXMucmVsYXRpb25hbE9wZXJhdG9yVGV4dCA9IG5ldyBUZXh0KCAnPycsIHtcclxuICAgICAgZm9udDogbmV3IFBoZXRGb250KCB7XHJcbiAgICAgICAgc2l6ZTogb3B0aW9ucy5yZWxhdGlvbmFsT3BlcmF0b3JGb250U2l6ZSxcclxuICAgICAgICB3ZWlnaHQ6IG9wdGlvbnMucmVsYXRpb25hbE9wZXJhdG9yRm9udFdlaWdodFxyXG4gICAgICB9IClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBpbmZvcm1hdGlvbiBmb3Igb25lIHNpZGUgb2YgdGhlIGVxdWF0aW9uLCBwYXNzZWQgdG8gY3JlYXRlRXhwcmVzc2lvbk5vZGVcclxuICAgIHRoaXMuZXhwcmVzc2lvbk5vZGVPcHRpb25zID0ge1xyXG4gICAgICBzeW1ib2xGb250OiBuZXcgTWF0aFN5bWJvbEZvbnQoIG9wdGlvbnMuc3ltYm9sRm9udFNpemUgKSxcclxuICAgICAgb3BlcmF0b3JGb250OiBuZXcgUGhldEZvbnQoIG9wdGlvbnMub3BlcmF0b3JGb250U2l6ZSApLFxyXG4gICAgICBpbnRlZ2VyRm9udDogbmV3IFBoZXRGb250KCBvcHRpb25zLmludGVnZXJGb250U2l6ZSApLFxyXG4gICAgICBmcmFjdGlvbkZvbnQ6IG5ldyBQaGV0Rm9udCggb3B0aW9ucy5mcmFjdGlvbkZvbnRTaXplICksXHJcbiAgICAgIGNvZWZmaWNpZW50U3BhY2luZzogb3B0aW9ucy5jb2VmZmljaWVudFNwYWNpbmcsXHJcbiAgICAgIHBsdXNTcGFjaW5nOiBvcHRpb25zLnBsdXNTcGFjaW5nXHJcbiAgICB9O1xyXG5cclxuICAgIGlmICggb3B0aW9ucy51cGRhdGVFbmFibGVkICkge1xyXG5cclxuICAgICAgLy8gVGhlIGVxdWF0aW9uIG5lZWRzIHRvIGJlIGR5bmFtaWNhbGx5IHVwZGF0ZWQuXHJcbiAgICAgIGNvbnN0IGFsbFRlcm1DcmVhdG9ycyA9IGxlZnRUZXJtQ3JlYXRvcnMuY29uY2F0KCByaWdodFRlcm1DcmVhdG9ycyApO1xyXG5cclxuICAgICAgLy8gVXBkYXRlIHRoZSByZWxhdGlvbmFsIG9wZXJhdG9yIHdoZW4gd2VpZ2h0IG9uIGVpdGhlciBwbGF0ZSBjaGFuZ2VzLlxyXG4gICAgICBNdWx0aWxpbmsubXVsdGlsaW5rQW55KFxyXG4gICAgICAgIGFsbFRlcm1DcmVhdG9ycy5tYXAoIHRlcm1DcmVhdG9yID0+IHRlcm1DcmVhdG9yLndlaWdodE9uUGxhdGVQcm9wZXJ0eSApLFxyXG4gICAgICAgICgpID0+IHRoaXMudXBkYXRlUmVsYXRpb25hbE9wZXJhdG9yKClcclxuICAgICAgKTtcclxuXHJcbiAgICAgIC8vIFVwZGF0ZSB0aGUgZXhwcmVzc2lvbnMgbnVtYmVyIG9mIHRlcm1zIG9uIGVpdGhlciBwbGF0ZSBjaGFuZ2VzLlxyXG4gICAgICBNdWx0aWxpbmsubXVsdGlsaW5rQW55KFxyXG4gICAgICAgIGFsbFRlcm1DcmVhdG9ycy5tYXAoIHRlcm1DcmVhdG9yID0+IHRlcm1DcmVhdG9yLm51bWJlck9mVGVybXNPblBsYXRlUHJvcGVydHkgKSxcclxuICAgICAgICAoKSA9PiB0aGlzLnVwZGF0ZUV4cHJlc3Npb25zKClcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVzZSB0aGlzIHRvIHVwZGF0ZSBhIHN0YXRpYyBlcXVhdGlvbiB0aGF0IHdhcyBjcmVhdGVkIHdpdGggdXBkYXRlRW5hYmxlZDogZmFsc2UuXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMudXBkYXRlUmVsYXRpb25hbE9wZXJhdG9yKCk7XHJcbiAgICB0aGlzLnVwZGF0ZUV4cHJlc3Npb25zKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoZSBlcXVhdGlvbidzIGxlZnQgYW5kIHJpZ2h0IGV4cHJlc3Npb25zLCBvbiBlaXRoZXIgc2lkZSBvZiB0aGUgcmVsYXRpb25hbCBvcGVyYXRvci5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZUV4cHJlc3Npb25zKCk6IHZvaWQge1xyXG5cclxuICAgIC8vIEV4aXN0aW5nIGV4cHJlc3Npb25zIG1heSBiZSBsaW5rZWQgdG8gdHJhbnNsYXRlZCBTdHJpbmdQcm9wZXJ0aWVzLCBzbyB0aGV5IG11c3QgYmUgZGlzcG9zZWQuXHJcbiAgICB0aGlzLmxlZnRFeHByZXNzaW9uTm9kZSAmJiB0aGlzLmxlZnRFeHByZXNzaW9uTm9kZS5kaXNwb3NlKCk7XHJcbiAgICB0aGlzLnJpZ2h0RXhwcmVzc2lvbk5vZGUgJiYgdGhpcy5yaWdodEV4cHJlc3Npb25Ob2RlLmRpc3Bvc2UoKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgbmV3IGV4cHJlc3Npb25zLlxyXG4gICAgdGhpcy5sZWZ0RXhwcmVzc2lvbk5vZGUgPSBuZXcgRXhwcmVzc2lvbk5vZGUoIHRoaXMubGVmdFRlcm1DcmVhdG9ycywgdGhpcy5leHByZXNzaW9uTm9kZU9wdGlvbnMgKTtcclxuICAgIHRoaXMucmlnaHRFeHByZXNzaW9uTm9kZSA9IG5ldyBFeHByZXNzaW9uTm9kZSggdGhpcy5yaWdodFRlcm1DcmVhdG9ycywgdGhpcy5leHByZXNzaW9uTm9kZU9wdGlvbnMgKTtcclxuICAgIHRoaXMuY2hpbGRyZW4gPSBbIHRoaXMubGVmdEV4cHJlc3Npb25Ob2RlLCB0aGlzLnJlbGF0aW9uYWxPcGVyYXRvclRleHQsIHRoaXMucmlnaHRFeHByZXNzaW9uTm9kZSBdO1xyXG4gICAgdGhpcy51cGRhdGVMYXlvdXQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhlIHJlbGF0aW9uYWwgb3BlcmF0b3IsIGJhc2VkIG9uIGxlZnQgdnMgcmlnaHQgd2VpZ2h0LlxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlUmVsYXRpb25hbE9wZXJhdG9yKCk6IHZvaWQge1xyXG4gICAgdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JUZXh0LnN0cmluZyA9IGdldFJlbGF0aW9uYWxPcGVyYXRvciggdGhpcy5sZWZ0VGVybUNyZWF0b3JzLCB0aGlzLnJpZ2h0VGVybUNyZWF0b3JzICk7XHJcbiAgICB0aGlzLnVwZGF0ZUxheW91dCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB0aGUgZXF1YXRpb24ncyBsYXlvdXQuIE9yaWdpbiBtdXN0IGJlIGF0IHRoZSBjZW50ZXIgb2YgdGhlIHJlbGF0aW9uYWwgb3BlcmF0b3IsIHNvIHRoYXQgd2VcclxuICAgKiBjYW4gYWxpZ24gdGhlIGVxdWF0aW9uIHByb3Blcmx5IGFib3ZlIHRoZSBiYWxhbmNlIHNjYWxlLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlTGF5b3V0KCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLmxlZnRFeHByZXNzaW9uTm9kZSAmJiB0aGlzLnJpZ2h0RXhwcmVzc2lvbk5vZGUgKSB7XHJcbiAgICAgIHRoaXMucmVsYXRpb25hbE9wZXJhdG9yVGV4dC5jZW50ZXJYID0gMDtcclxuICAgICAgdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JUZXh0LmNlbnRlclkgPSAwO1xyXG4gICAgICB0aGlzLmxlZnRFeHByZXNzaW9uTm9kZS5yaWdodCA9IHRoaXMucmVsYXRpb25hbE9wZXJhdG9yVGV4dC5sZWZ0IC0gdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JTcGFjaW5nO1xyXG4gICAgICB0aGlzLmxlZnRFeHByZXNzaW9uTm9kZS5jZW50ZXJZID0gdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JUZXh0LmNlbnRlclk7XHJcbiAgICAgIHRoaXMucmlnaHRFeHByZXNzaW9uTm9kZS5sZWZ0ID0gdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JUZXh0LnJpZ2h0ICsgdGhpcy5yZWxhdGlvbmFsT3BlcmF0b3JTcGFjaW5nO1xyXG4gICAgICB0aGlzLnJpZ2h0RXhwcmVzc2lvbk5vZGUuY2VudGVyWSA9IHRoaXMucmVsYXRpb25hbE9wZXJhdG9yVGV4dC5jZW50ZXJZO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIEdldHMgdGhlIG9wZXJhdG9yIHRoYXQgZGVzY3JpYmVzIHRoZSByZWxhdGlvbnNoaXAgYmV0d2VlbiB0aGUgbGVmdCBhbmQgcmlnaHQgc2lkZXMuXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRSZWxhdGlvbmFsT3BlcmF0b3IoIGxlZnRUZXJtQ3JlYXRvcnM6IFRlcm1DcmVhdG9yW10sIHJpZ2h0VGVybUNyZWF0b3JzOiBUZXJtQ3JlYXRvcltdICk6IFJlbGF0aW9uYWxPcGVyYXRvciB7XHJcblxyXG4gIC8vIGV2YWx1YXRlIHRoZSBsZWZ0IHNpZGVcclxuICBsZXQgbGVmdFdlaWdodCA9IEZyYWN0aW9uLmZyb21JbnRlZ2VyKCAwICk7XHJcbiAgZm9yICggbGV0IGkgPSAwOyBpIDwgbGVmdFRlcm1DcmVhdG9ycy5sZW5ndGg7IGkrKyApIHtcclxuICAgIGxlZnRXZWlnaHQgPSBsZWZ0V2VpZ2h0LnBsdXMoIGxlZnRUZXJtQ3JlYXRvcnNbIGkgXS53ZWlnaHRPblBsYXRlUHJvcGVydHkudmFsdWUgKTtcclxuICB9XHJcblxyXG4gIC8vIGV2YWx1YXRlIHRoZSByaWdodCBzaWRlXHJcbiAgbGV0IHJpZ2h0V2VpZ2h0ID0gRnJhY3Rpb24uZnJvbUludGVnZXIoIDAgKTtcclxuICBmb3IgKCBsZXQgaSA9IDA7IGkgPCByaWdodFRlcm1DcmVhdG9ycy5sZW5ndGg7IGkrKyApIHtcclxuICAgIHJpZ2h0V2VpZ2h0ID0gcmlnaHRXZWlnaHQucGx1cyggcmlnaHRUZXJtQ3JlYXRvcnNbIGkgXS53ZWlnaHRPblBsYXRlUHJvcGVydHkudmFsdWUgKTtcclxuICB9XHJcblxyXG4gIC8vIGRldGVybWluZSB0aGUgb3BlcmF0b3IgdGhhdCBkZXNjcmliZXMgdGhlIHJlbGF0aW9uc2hpcCBiZXR3ZWVuIGxlZnQgYW5kIHJpZ2h0IHNpZGVzXHJcbiAgbGV0IHJlbGF0aW9uYWxPcGVyYXRvcjogUmVsYXRpb25hbE9wZXJhdG9yO1xyXG4gIGlmICggbGVmdFdlaWdodC5pc0xlc3NUaGFuKCByaWdodFdlaWdodCApICkge1xyXG4gICAgcmVsYXRpb25hbE9wZXJhdG9yID0gTWF0aFN5bWJvbHMuTEVTU19USEFOO1xyXG4gIH1cclxuICBlbHNlIGlmICggcmlnaHRXZWlnaHQuaXNMZXNzVGhhbiggbGVmdFdlaWdodCApICkge1xyXG4gICAgcmVsYXRpb25hbE9wZXJhdG9yID0gTWF0aFN5bWJvbHMuR1JFQVRFUl9USEFOO1xyXG4gIH1cclxuICBlbHNlIHtcclxuICAgIHJlbGF0aW9uYWxPcGVyYXRvciA9IE1hdGhTeW1ib2xzLkVRVUFMX1RPO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHJlbGF0aW9uYWxPcGVyYXRvcjtcclxufVxyXG5cclxudHlwZSBFeHByZXNzaW9uTm9kZU9wdGlvbnMgPSB7XHJcbiAgc3ltYm9sRm9udDogRm9udDtcclxuICBvcGVyYXRvckZvbnQ6IEZvbnQ7XHJcbiAgaW50ZWdlckZvbnQ6IEZvbnQ7XHJcbiAgZnJhY3Rpb25Gb250OiBGb250O1xyXG4gIGNvZWZmaWNpZW50U3BhY2luZzogbnVtYmVyO1xyXG4gIHBsdXNTcGFjaW5nOiBudW1iZXI7XHJcbn07XHJcblxyXG4vKipcclxuICogQW4gZXhwcmVzc2lvbiBpcyBvbmUgc2lkZSBvZiB0aGUgZXF1YXRpb24uXHJcbiAqL1xyXG5jbGFzcyBFeHByZXNzaW9uTm9kZSBleHRlbmRzIEhCb3gge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VFeHByZXNzaW9uTm9kZTogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB0ZXJtQ3JlYXRvcnM6IFRlcm1DcmVhdG9yW10sIHByb3ZpZGVkT3B0aW9uczogRXhwcmVzc2lvbk5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IGNoaWxkcmVuOiBOb2RlW10gPSBbXTtcclxuICAgIGNvbnN0IGNoaWxkcmVuVG9EaXNwb3NlOiBOb2RlW10gPSBbXTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRlcm1DcmVhdG9ycy5sZW5ndGg7IGkrKyApIHtcclxuXHJcbiAgICAgIGNvbnN0IHRlcm1DcmVhdG9yID0gdGVybUNyZWF0b3JzWyBpIF07XHJcblxyXG4gICAgICBjb25zdCBudW1iZXJPZlRlcm1zT25QbGF0ZSA9IHRlcm1DcmVhdG9yLm51bWJlck9mVGVybXNPblBsYXRlUHJvcGVydHkudmFsdWU7XHJcbiAgICAgIGlmICggbnVtYmVyT2ZUZXJtc09uUGxhdGUgPiAwICkge1xyXG5cclxuICAgICAgICBpZiAoIHRlcm1DcmVhdG9yIGluc3RhbmNlb2YgT2JqZWN0VGVybUNyZWF0b3IgKSB7XHJcblxyXG4gICAgICAgICAgLy8gaWYgdGhlcmUgd2VyZSBwcmV2aW91cyB0ZXJtcywgYWRkIGFuIG9wZXJhdG9yXHJcbiAgICAgICAgICBpZiAoIGNoaWxkcmVuLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goIHZhbHVlVG9PcGVyYXRvclRleHQoIG51bWJlck9mVGVybXNPblBsYXRlLCBwcm92aWRlZE9wdGlvbnMub3BlcmF0b3JGb250ICkgKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAvLyBFYWNoIE9iamVjdFRlcm0gaGFzIGFuIGltcGxpY2l0IGNvZWZmaWNpZW50IG9mIDEsIHNvIHVzZSB0aGUgbnVtYmVyIG9mIHRlcm1zIGFzIHRoZSBjb2VmZmljaWVudC5cclxuICAgICAgICAgIGNoaWxkcmVuLnB1c2goIE9iamVjdFRlcm1Ob2RlLmNyZWF0ZUVxdWF0aW9uVGVybU5vZGUoIG51bWJlck9mVGVybXNPblBsYXRlLCB0ZXJtQ3JlYXRvci5jcmVhdGVJY29uKCksIHtcclxuICAgICAgICAgICAgZm9udDogcHJvdmlkZWRPcHRpb25zLmludGVnZXJGb250LFxyXG4gICAgICAgICAgICBzcGFjaW5nOiBwcm92aWRlZE9wdGlvbnMuY29lZmZpY2llbnRTcGFjaW5nXHJcbiAgICAgICAgICB9ICkgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIHRlcm1DcmVhdG9yIGluc3RhbmNlb2YgVmFyaWFibGVUZXJtQ3JlYXRvciApIHtcclxuXHJcbiAgICAgICAgICBsZXQgY29lZmZpY2llbnQgPSB0ZXJtQ3JlYXRvci5zdW1Db2VmZmljaWVudHNPblBsYXRlKCk7XHJcblxyXG4gICAgICAgICAgaWYgKCBjb2VmZmljaWVudC5nZXRWYWx1ZSgpICE9PSAwICkge1xyXG5cclxuICAgICAgICAgICAgLy8gaWYgdGhlcmUgd2VyZSBwcmV2aW91cyB0ZXJtcywgcmVwbGFjZSB0aGUgY29lZmZpY2llbnQncyBzaWduIHdpdGggYW4gb3BlcmF0b3JcclxuICAgICAgICAgICAgaWYgKCBjaGlsZHJlbi5sZW5ndGggPiAwICkge1xyXG4gICAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goIHZhbHVlVG9PcGVyYXRvclRleHQoIGNvZWZmaWNpZW50LmdldFZhbHVlKCksIHByb3ZpZGVkT3B0aW9ucy5vcGVyYXRvckZvbnQgKSApO1xyXG4gICAgICAgICAgICAgIGNvZWZmaWNpZW50ID0gY29lZmZpY2llbnQuYWJzKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHZhcmlhYmxlID0gdGVybUNyZWF0b3IudmFyaWFibGUhO1xyXG4gICAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB2YXJpYWJsZSApO1xyXG5cclxuICAgICAgICAgICAgLy8gTXVzdCBiZSBkaXNwb3NlZCBiZWNhdXNlIGl0IGxpbmtzIHRvIGEgdHJhbnNsYXRlZCBTdHJpbmdQcm9wZXJ0eS5cclxuICAgICAgICAgICAgY29uc3QgZXF1YXRpb25UZXJtTm9kZSA9IFZhcmlhYmxlVGVybU5vZGUuY3JlYXRlRXF1YXRpb25UZXJtTm9kZSggY29lZmZpY2llbnQsIHZhcmlhYmxlLnN5bWJvbFByb3BlcnR5LCB7XHJcbiAgICAgICAgICAgICAgaW50ZWdlckZvbnQ6IHByb3ZpZGVkT3B0aW9ucy5pbnRlZ2VyRm9udCxcclxuICAgICAgICAgICAgICBmcmFjdGlvbkZvbnQ6IHByb3ZpZGVkT3B0aW9ucy5mcmFjdGlvbkZvbnQsXHJcbiAgICAgICAgICAgICAgc3ltYm9sRm9udDogcHJvdmlkZWRPcHRpb25zLnN5bWJvbEZvbnRcclxuICAgICAgICAgICAgfSApO1xyXG5cclxuICAgICAgICAgICAgY2hpbGRyZW4ucHVzaCggZXF1YXRpb25UZXJtTm9kZSApO1xyXG4gICAgICAgICAgICBjaGlsZHJlblRvRGlzcG9zZS5wdXNoKCBlcXVhdGlvblRlcm1Ob2RlICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCB0ZXJtQ3JlYXRvciBpbnN0YW5jZW9mIENvbnN0YW50VGVybUNyZWF0b3IgKSB7XHJcblxyXG4gICAgICAgICAgbGV0IGNvbnN0YW50VmFsdWUgPSB0ZXJtQ3JlYXRvci5zdW1Db25zdGFudHNPblBsYXRlKCk7XHJcblxyXG4gICAgICAgICAgaWYgKCBjb25zdGFudFZhbHVlLmdldFZhbHVlKCkgIT09IDAgKSB7XHJcblxyXG4gICAgICAgICAgICAvLyBpZiB0aGVyZSB3ZXJlIHByZXZpb3VzIHRlcm1zLCByZXBsYWNlIHRoZSBjb25zdGFudCdzIHNpZ24gd2l0aCBhbiBvcGVyYXRvclxyXG4gICAgICAgICAgICBpZiAoIGNoaWxkcmVuLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgY2hpbGRyZW4ucHVzaCggdmFsdWVUb09wZXJhdG9yVGV4dCggY29uc3RhbnRWYWx1ZS5nZXRWYWx1ZSgpLCBwcm92aWRlZE9wdGlvbnMub3BlcmF0b3JGb250ICkgKTtcclxuICAgICAgICAgICAgICBjb25zdGFudFZhbHVlID0gY29uc3RhbnRWYWx1ZS5hYnMoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY2hpbGRyZW4ucHVzaCggQ29uc3RhbnRUZXJtTm9kZS5jcmVhdGVFcXVhdGlvblRlcm1Ob2RlKCBjb25zdGFudFZhbHVlLCB7XHJcbiAgICAgICAgICAgICAgaW50ZWdlckZvbnQ6IHByb3ZpZGVkT3B0aW9ucy5pbnRlZ2VyRm9udCxcclxuICAgICAgICAgICAgICBmcmFjdGlvbkZvbnQ6IHByb3ZpZGVkT3B0aW9ucy5mcmFjdGlvbkZvbnRcclxuICAgICAgICAgICAgfSApICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCBgdW5zdXBwb3J0ZWQgdGVybUNyZWF0b3I6ICR7dGVybUNyZWF0b3J9YCApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGlmIHRoZXJlIHdlcmUgbm8gdGVybXMsIHRoZW4gdGhpcyBzaWRlIG9mIHRoZSBlcXVhdGlvbiBldmFsdWF0ZWQgdG8gemVyb1xyXG4gICAgaWYgKCBjaGlsZHJlbi5sZW5ndGggPT09IDAgKSB7XHJcbiAgICAgIGNoaWxkcmVuLnB1c2goIG5ldyBUZXh0KCAnMCcsIHsgZm9udDogcHJvdmlkZWRPcHRpb25zLmludGVnZXJGb250IH0gKSApO1xyXG4gICAgfVxyXG5cclxuICAgIHN1cGVyKCB7XHJcbiAgICAgIHNwYWNpbmc6IHByb3ZpZGVkT3B0aW9ucy5wbHVzU3BhY2luZyxcclxuICAgICAgY2hpbGRyZW46IGNoaWxkcmVuXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlRXhwcmVzc2lvbk5vZGUgPSAoKSA9PiB7XHJcbiAgICAgIGNoaWxkcmVuVG9EaXNwb3NlLmZvckVhY2goIG5vZGUgPT4gbm9kZS5kaXNwb3NlKCkgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZUV4cHJlc3Npb25Ob2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2l2ZW4gdGhlIHZhbHVlIHRoYXQgZGV0ZXJtaW5lcyBhIHRlcm0ncyBzaWduLCBjcmVhdGUgdGhlIGNvcnJlc3BvbmRpbmcgb3BlcmF0b3Igbm9kZS5cclxuICovXHJcbmZ1bmN0aW9uIHZhbHVlVG9PcGVyYXRvclRleHQoIHZhbHVlOiBudW1iZXIsIG9wZXJhdG9yRm9udDogRm9udCApOiBOb2RlIHtcclxuICBjb25zdCBvcGVyYXRvciA9ICggdmFsdWUgPiAwICkgPyBNYXRoU3ltYm9scy5QTFVTIDogTWF0aFN5bWJvbHMuTUlOVVM7XHJcbiAgcmV0dXJuIG5ldyBUZXh0KCBvcGVyYXRvciwgeyBmb250OiBvcGVyYXRvckZvbnQgfSApO1xyXG59XHJcblxyXG5lcXVhbGl0eUV4cGxvcmVyLnJlZ2lzdGVyKCAnRXF1YXRpb25Ob2RlJywgRXF1YXRpb25Ob2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFDN0QsT0FBT0MsUUFBUSxNQUFNLDZDQUE2QztBQUNsRSxPQUFPQyxjQUFjLE1BQU0sK0NBQStDO0FBQzFFLE9BQU9DLFdBQVcsTUFBTSw0Q0FBNEM7QUFDcEUsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUM5RCxTQUEyQkMsSUFBSSxFQUFFQyxJQUFJLEVBQWVDLElBQUksUUFBUSxtQ0FBbUM7QUFDbkcsT0FBT0MsaUJBQWlCLE1BQU0sK0JBQStCO0FBQzdELE9BQU9DLGNBQWMsTUFBTSxxQkFBcUI7QUFDaEQsT0FBT0MsZ0JBQWdCLE1BQU0sMkJBQTJCO0FBQ3hELE9BQU9DLG1CQUFtQixNQUFNLGlDQUFpQztBQUVqRSxPQUFPQyxtQkFBbUIsTUFBTSxpQ0FBaUM7QUFDakUsT0FBT0MsZ0JBQWdCLE1BQU0sdUJBQXVCO0FBQ3BELE9BQU9DLGdCQUFnQixNQUFNLHVCQUF1QjtBQUdwRCxPQUFPQyxNQUFNLE1BQU0saUNBQWlDOztBQUVwRDtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLEVBQUU7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