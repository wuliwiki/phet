// Copyright 2015-2022, University of Colorado Boulder

/**
 * Screen View for Messenger Rna Production Screen
 *
 * @author Mohamed Safi
 * @author John Blanco
 * @author Aadish Gupta
 */

import Property from '../../../../axon/js/Property.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import ScreenView from '../../../../joist/js/ScreenView.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import ResetAllButton from '../../../../scenery-phet/js/buttons/ResetAllButton.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import TimeControlNode from '../../../../scenery-phet/js/TimeControlNode.js';
import { Node, Text } from '../../../../scenery/js/imports.js';
import Checkbox from '../../../../sun/js/Checkbox.js';
import DnaMoleculeNode from '../../common/view/DnaMoleculeNode.js';
import MessengerRnaNode from '../../common/view/MessengerRnaNode.js';
import MobileBiomoleculeNode from '../../common/view/MobileBiomoleculeNode.js';
import geneExpressionEssentials from '../../geneExpressionEssentials.js';
import GeneExpressionEssentialsStrings from '../../GeneExpressionEssentialsStrings.js';
import MessengerRnaProductionModel from '../model/MessengerRnaProductionModel.js';
import PolymeraseAffinityControlPanel from './PolymeraseAffinityControlPanel.js';
import TranscriptionFactorControlPanel from './TranscriptionFactorControlPanel.js';

// constants
const INSET = 10; // Inset for several of the controls.

const negativeTranscriptionFactorString = GeneExpressionEssentialsStrings.negativeTranscriptionFactor;
class MessengerRnaProductionScreenView extends ScreenView {
  /**
   * @param {MessengerRnaProductionModel} model
   */
  constructor(model) {
    // due to odd behavior of flickering on this screen, we run it with preventFit
    super({
      preventFit: true
    });
    this.model = model;
    this.negativeTranscriptionFactorEnabled = new Property(false);
    const viewPortPosition = new Vector2(this.layoutBounds.width * 0.48, this.layoutBounds.height * 0.4);

    // Set up the model-view transform.
    this.modelViewTransform = ModelViewTransform2.createSinglePointScaleInvertedYMapping(Vector2.ZERO, viewPortPosition, 0.2 // "Zoom factor" - smaller zooms out, larger zooms in.
    );

    // Set up the root node for all model objects. Nodes placed under this one will scroll when the user moves along the
    // DNA strand.
    this.modelRootNode = new Node();
    this.addChild(this.modelRootNode);

    // Add some layers for enforcing some z-order relationships needed in order to keep things looking good.
    const dnaLayer = new Node();
    this.modelRootNode.addChild(dnaLayer);
    dnaLayer.setPickable(false);
    const messengerRnaLayer = new Node();
    messengerRnaLayer.setPickable(false);
    this.modelRootNode.addChild(messengerRnaLayer);
    const transcribingPolymeraseLayer = new Node();
    transcribingPolymeraseLayer.setPickable(false);
    this.modelRootNode.addChild(transcribingPolymeraseLayer);
    const topBiomoleculeLayer = new Node();
    topBiomoleculeLayer.setPickable(false);
    this.modelRootNode.addChild(topBiomoleculeLayer);
    const placementHintLayer = new Node();
    this.modelRootNode.addChild(placementHintLayer);
    const controlsNode = new Node();
    this.addChild(controlsNode);

    // Add the representation of the DNA strand.
    this.dnaMoleculeNode = new DnaMoleculeNode(model.getDnaMolecule(), this.modelViewTransform, 5, false);
    dnaLayer.addChild(this.dnaMoleculeNode);

    // Get a reference to the gene being controlled.
    const gene = model.getDnaMolecule().getGenes()[0];

    // Add the nodes that allow the user to control the concentrations and affinities.
    const positiveTranscriptionFactorControlPanel = new TranscriptionFactorControlPanel(model, MessengerRnaProductionModel.POSITIVE_TRANSCRIPTION_FACTOR_CONFIG, gene.getTranscriptionFactorAffinityProperty(MessengerRnaProductionModel.POSITIVE_TRANSCRIPTION_FACTOR_CONFIG));
    controlsNode.addChild(positiveTranscriptionFactorControlPanel);
    const polymeraseAffinityControlPanel = new PolymeraseAffinityControlPanel(MessengerRnaProductionModel.POSITIVE_TRANSCRIPTION_FACTOR_CONFIG, positiveTranscriptionFactorControlPanel.bounds.height, gene.getPolymeraseAffinityProperty());
    controlsNode.addChild(polymeraseAffinityControlPanel);
    const negativeTranscriptionFactorControlPanel = new TranscriptionFactorControlPanel(model, MessengerRnaProductionModel.NEGATIVE_TRANSCRIPTION_FACTOR_CONFIG, gene.getTranscriptionFactorAffinityProperty(MessengerRnaProductionModel.NEGATIVE_TRANSCRIPTION_FACTOR_CONFIG));
    controlsNode.addChild(negativeTranscriptionFactorControlPanel);

    // Add the checkbox for showing/hiding the control panel for the negative transcription factor.
    const negativeFactorEnabledCheckbox = new Checkbox(this.negativeTranscriptionFactorEnabled, new Text(negativeTranscriptionFactorString, {
      font: new PhetFont(18),
      maxWidth: 275
    }), {
      boxWidth: 20
    });
    controlsNode.addChild(negativeFactorEnabledCheckbox);

    // Only show the control for the negative transcription factor if it is enabled.
    this.negativeTranscriptionFactorEnabled.link(enabled => {
      negativeTranscriptionFactorControlPanel.setVisible(enabled);
      if (!enabled) {
        // When the negative transcription factor control is hidden, there should be no negative factors.
        this.model.negativeTranscriptionFactorCountProperty.reset();
      }
    });

    // Adds the node that has the buttons for controlling time and pausing and stepping forward
    const timeControlNode = new TimeControlNode(model.clockRunningProperty, {
      playPauseStepButtonOptions: {
        playPauseStepXSpacing: INSET,
        playPauseButtonOptions: {
          radius: 23,
          touchAreaDilation: 5
        },
        stepForwardButtonOptions: {
          listener: () => {
            model.stepInTime(0.016);
          },
          radius: 15,
          touchAreaDilation: 5
        }
      }
    });
    this.addChild(timeControlNode);

    // Add the Reset All button.
    const resetAllButton = new ResetAllButton({
      listener: () => {
        this.interruptSubtreeInput(); // cancel user interactions
        this.model.reset();
        this.negativeTranscriptionFactorEnabled.reset();
      },
      right: this.layoutBounds.maxX - INSET,
      bottom: this.layoutBounds.maxY - INSET
    });
    controlsNode.addChild(resetAllButton);

    // Lay out the controls.

    positiveTranscriptionFactorControlPanel.left = INSET;
    positiveTranscriptionFactorControlPanel.bottom = this.layoutBounds.maxY - INSET;
    polymeraseAffinityControlPanel.left = positiveTranscriptionFactorControlPanel.right + INSET;
    polymeraseAffinityControlPanel.bottom = positiveTranscriptionFactorControlPanel.bottom;
    negativeTranscriptionFactorControlPanel.left = polymeraseAffinityControlPanel.right + INSET;
    negativeTranscriptionFactorControlPanel.bottom = polymeraseAffinityControlPanel.bottom;
    negativeFactorEnabledCheckbox.left = negativeTranscriptionFactorControlPanel.right + INSET;
    negativeFactorEnabledCheckbox.centerY = resetAllButton.centerY;
    timeControlNode.bottom = negativeFactorEnabledCheckbox.top - 2 * INSET;
    timeControlNode.centerX = negativeFactorEnabledCheckbox.centerX;

    // define a function for adding views of biomolecules
    const addBiomoleculeView = addedBiomolecule => {
      const biomoleculeNode = new MobileBiomoleculeNode(this.modelViewTransform, addedBiomolecule);

      // On this screen, users can't directly interact with individual biomolecules.
      biomoleculeNode.setPickable(false);
      topBiomoleculeLayer.addChild(biomoleculeNode);

      // Add a listener that moves the child on to a lower layer when it connects to the DNA so that we see the desired
      // overlap behavior.
      const positionBiomolecule = attachedToDna => {
        if (attachedToDna) {
          if (topBiomoleculeLayer.hasChild(biomoleculeNode)) {
            topBiomoleculeLayer.removeChild(biomoleculeNode);
          }
          transcribingPolymeraseLayer.addChild(biomoleculeNode);
        } else {
          if (transcribingPolymeraseLayer.hasChild(biomoleculeNode)) {
            transcribingPolymeraseLayer.removeChild(biomoleculeNode);
          }
          topBiomoleculeLayer.addChild(biomoleculeNode);
        }
      };
      addedBiomolecule.attachedToDnaProperty.lazyLink(positionBiomolecule);
      model.mobileBiomoleculeList.addItemRemovedListener(function removalListener(removedBiomolecule) {
        if (removedBiomolecule === addedBiomolecule) {
          if (topBiomoleculeLayer.hasChild(biomoleculeNode)) {
            topBiomoleculeLayer.removeChild(biomoleculeNode);
          } else if (dnaLayer.hasChild(biomoleculeNode)) {
            dnaLayer.removeChild(biomoleculeNode);
          }
          addedBiomolecule.attachedToDnaProperty.unlink(positionBiomolecule);
          biomoleculeNode.dispose();
          model.mobileBiomoleculeList.removeItemRemovedListener(removalListener);
        }
      });
    };
    model.mobileBiomoleculeList.forEach(bioMolecule => {
      addBiomoleculeView(bioMolecule);
    });

    // Watch for and handle comings and goings of biomolecules in the model. Most, but not all, of the biomolecules are
    // handled by this. A few others are handled as special cases.
    model.mobileBiomoleculeList.addItemAddedListener(addedBiomolecule => {
      addBiomoleculeView(addedBiomolecule);
    });

    // Watch for and handle comings and goings of messenger RNA.
    model.messengerRnaList.addItemAddedListener(addedMessengerRna => {
      const messengerRnaNode = new MessengerRnaNode(this.modelViewTransform, addedMessengerRna);
      messengerRnaLayer.addChild(messengerRnaNode);
      model.messengerRnaList.addItemRemovedListener(function removalListener(removedMessengerRna) {
        if (removedMessengerRna === addedMessengerRna) {
          messengerRnaLayer.removeChild(messengerRnaNode);
          messengerRnaNode.dispose();
          model.messengerRnaList.removeItemRemovedListener(removalListener);
        }
      });
    });
  }

  /**
   * Step function for this view
   * @public
   */
  step() {
    this.dnaMoleculeNode.step();
  }
}
geneExpressionEssentials.register('MessengerRnaProductionScreenView', MessengerRnaProductionScreenView);
export default MessengerRnaProductionScreenView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIlZlY3RvcjIiLCJTY3JlZW5WaWV3IiwiTW9kZWxWaWV3VHJhbnNmb3JtMiIsIlJlc2V0QWxsQnV0dG9uIiwiUGhldEZvbnQiLCJUaW1lQ29udHJvbE5vZGUiLCJOb2RlIiwiVGV4dCIsIkNoZWNrYm94IiwiRG5hTW9sZWN1bGVOb2RlIiwiTWVzc2VuZ2VyUm5hTm9kZSIsIk1vYmlsZUJpb21vbGVjdWxlTm9kZSIsImdlbmVFeHByZXNzaW9uRXNzZW50aWFscyIsIkdlbmVFeHByZXNzaW9uRXNzZW50aWFsc1N0cmluZ3MiLCJNZXNzZW5nZXJSbmFQcm9kdWN0aW9uTW9kZWwiLCJQb2x5bWVyYXNlQWZmaW5pdHlDb250cm9sUGFuZWwiLCJUcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsIiwiSU5TRVQiLCJuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JTdHJpbmciLCJuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3IiLCJNZXNzZW5nZXJSbmFQcm9kdWN0aW9uU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJwcmV2ZW50Rml0IiwibmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yRW5hYmxlZCIsInZpZXdQb3J0UG9zaXRpb24iLCJsYXlvdXRCb3VuZHMiLCJ3aWR0aCIsImhlaWdodCIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImNyZWF0ZVNpbmdsZVBvaW50U2NhbGVJbnZlcnRlZFlNYXBwaW5nIiwiWkVSTyIsIm1vZGVsUm9vdE5vZGUiLCJhZGRDaGlsZCIsImRuYUxheWVyIiwic2V0UGlja2FibGUiLCJtZXNzZW5nZXJSbmFMYXllciIsInRyYW5zY3JpYmluZ1BvbHltZXJhc2VMYXllciIsInRvcEJpb21vbGVjdWxlTGF5ZXIiLCJwbGFjZW1lbnRIaW50TGF5ZXIiLCJjb250cm9sc05vZGUiLCJkbmFNb2xlY3VsZU5vZGUiLCJnZXREbmFNb2xlY3VsZSIsImdlbmUiLCJnZXRHZW5lcyIsInBvc2l0aXZlVHJhbnNjcmlwdGlvbkZhY3RvckNvbnRyb2xQYW5lbCIsIlBPU0lUSVZFX1RSQU5TQ1JJUFRJT05fRkFDVE9SX0NPTkZJRyIsImdldFRyYW5zY3JpcHRpb25GYWN0b3JBZmZpbml0eVByb3BlcnR5IiwicG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsIiwiYm91bmRzIiwiZ2V0UG9seW1lcmFzZUFmZmluaXR5UHJvcGVydHkiLCJuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwiLCJORUdBVElWRV9UUkFOU0NSSVBUSU9OX0ZBQ1RPUl9DT05GSUciLCJuZWdhdGl2ZUZhY3RvckVuYWJsZWRDaGVja2JveCIsImZvbnQiLCJtYXhXaWR0aCIsImJveFdpZHRoIiwibGluayIsImVuYWJsZWQiLCJzZXRWaXNpYmxlIiwibmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yQ291bnRQcm9wZXJ0eSIsInJlc2V0IiwidGltZUNvbnRyb2xOb2RlIiwiY2xvY2tSdW5uaW5nUHJvcGVydHkiLCJwbGF5UGF1c2VTdGVwQnV0dG9uT3B0aW9ucyIsInBsYXlQYXVzZVN0ZXBYU3BhY2luZyIsInBsYXlQYXVzZUJ1dHRvbk9wdGlvbnMiLCJyYWRpdXMiLCJ0b3VjaEFyZWFEaWxhdGlvbiIsInN0ZXBGb3J3YXJkQnV0dG9uT3B0aW9ucyIsImxpc3RlbmVyIiwic3RlcEluVGltZSIsInJlc2V0QWxsQnV0dG9uIiwiaW50ZXJydXB0U3VidHJlZUlucHV0IiwicmlnaHQiLCJtYXhYIiwiYm90dG9tIiwibWF4WSIsImxlZnQiLCJjZW50ZXJZIiwidG9wIiwiY2VudGVyWCIsImFkZEJpb21vbGVjdWxlVmlldyIsImFkZGVkQmlvbW9sZWN1bGUiLCJiaW9tb2xlY3VsZU5vZGUiLCJwb3NpdGlvbkJpb21vbGVjdWxlIiwiYXR0YWNoZWRUb0RuYSIsImhhc0NoaWxkIiwicmVtb3ZlQ2hpbGQiLCJhdHRhY2hlZFRvRG5hUHJvcGVydHkiLCJsYXp5TGluayIsIm1vYmlsZUJpb21vbGVjdWxlTGlzdCIsImFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJyZW1vdmFsTGlzdGVuZXIiLCJyZW1vdmVkQmlvbW9sZWN1bGUiLCJ1bmxpbmsiLCJkaXNwb3NlIiwicmVtb3ZlSXRlbVJlbW92ZWRMaXN0ZW5lciIsImZvckVhY2giLCJiaW9Nb2xlY3VsZSIsImFkZEl0ZW1BZGRlZExpc3RlbmVyIiwibWVzc2VuZ2VyUm5hTGlzdCIsImFkZGVkTWVzc2VuZ2VyUm5hIiwibWVzc2VuZ2VyUm5hTm9kZSIsInJlbW92ZWRNZXNzZW5nZXJSbmEiLCJzdGVwIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNZXNzZW5nZXJSbmFQcm9kdWN0aW9uU2NyZWVuVmlldy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTY3JlZW4gVmlldyBmb3IgTWVzc2VuZ2VyIFJuYSBQcm9kdWN0aW9uIFNjcmVlblxyXG4gKlxyXG4gKiBAYXV0aG9yIE1vaGFtZWQgU2FmaVxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqIEBhdXRob3IgQWFkaXNoIEd1cHRhXHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBTY3JlZW5WaWV3IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1NjcmVlblZpZXcuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCBSZXNldEFsbEJ1dHRvbiBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvYnV0dG9ucy9SZXNldEFsbEJ1dHRvbi5qcyc7XHJcbmltcG9ydCBQaGV0Rm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldEZvbnQuanMnO1xyXG5pbXBvcnQgVGltZUNvbnRyb2xOb2RlIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9UaW1lQ29udHJvbE5vZGUuanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IENoZWNrYm94IGZyb20gJy4uLy4uLy4uLy4uL3N1bi9qcy9DaGVja2JveC5qcyc7XHJcbmltcG9ydCBEbmFNb2xlY3VsZU5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvRG5hTW9sZWN1bGVOb2RlLmpzJztcclxuaW1wb3J0IE1lc3NlbmdlclJuYU5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvTWVzc2VuZ2VyUm5hTm9kZS5qcyc7XHJcbmltcG9ydCBNb2JpbGVCaW9tb2xlY3VsZU5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvTW9iaWxlQmlvbW9sZWN1bGVOb2RlLmpzJztcclxuaW1wb3J0IGdlbmVFeHByZXNzaW9uRXNzZW50aWFscyBmcm9tICcuLi8uLi9nZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMuanMnO1xyXG5pbXBvcnQgR2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzU3RyaW5ncyBmcm9tICcuLi8uLi9HZW5lRXhwcmVzc2lvbkVzc2VudGlhbHNTdHJpbmdzLmpzJztcclxuaW1wb3J0IE1lc3NlbmdlclJuYVByb2R1Y3Rpb25Nb2RlbCBmcm9tICcuLi9tb2RlbC9NZXNzZW5nZXJSbmFQcm9kdWN0aW9uTW9kZWwuanMnO1xyXG5pbXBvcnQgUG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsIGZyb20gJy4vUG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsLmpzJztcclxuaW1wb3J0IFRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwgZnJvbSAnLi9UcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBJTlNFVCA9IDEwOyAgLy8gSW5zZXQgZm9yIHNldmVyYWwgb2YgdGhlIGNvbnRyb2xzLlxyXG5cclxuY29uc3QgbmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yU3RyaW5nID0gR2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzU3RyaW5ncy5uZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3I7XHJcblxyXG5jbGFzcyBNZXNzZW5nZXJSbmFQcm9kdWN0aW9uU2NyZWVuVmlldyBleHRlbmRzIFNjcmVlblZpZXcge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge01lc3NlbmdlclJuYVByb2R1Y3Rpb25Nb2RlbH0gbW9kZWxcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbW9kZWwgKSB7XHJcblxyXG4gICAgLy8gZHVlIHRvIG9kZCBiZWhhdmlvciBvZiBmbGlja2VyaW5nIG9uIHRoaXMgc2NyZWVuLCB3ZSBydW4gaXQgd2l0aCBwcmV2ZW50Rml0XHJcbiAgICBzdXBlciggeyBwcmV2ZW50Rml0OiB0cnVlIH0gKTtcclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuICAgIHRoaXMubmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yRW5hYmxlZCA9IG5ldyBQcm9wZXJ0eSggZmFsc2UgKTtcclxuICAgIGNvbnN0IHZpZXdQb3J0UG9zaXRpb24gPSBuZXcgVmVjdG9yMiggdGhpcy5sYXlvdXRCb3VuZHMud2lkdGggKiAwLjQ4LCB0aGlzLmxheW91dEJvdW5kcy5oZWlnaHQgKiAwLjQgKTtcclxuXHJcbiAgICAvLyBTZXQgdXAgdGhlIG1vZGVsLXZpZXcgdHJhbnNmb3JtLlxyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBNb2RlbFZpZXdUcmFuc2Zvcm0yLmNyZWF0ZVNpbmdsZVBvaW50U2NhbGVJbnZlcnRlZFlNYXBwaW5nKFxyXG4gICAgICBWZWN0b3IyLlpFUk8sXHJcbiAgICAgIHZpZXdQb3J0UG9zaXRpb24sXHJcbiAgICAgIDAuMiAgLy8gXCJab29tIGZhY3RvclwiIC0gc21hbGxlciB6b29tcyBvdXQsIGxhcmdlciB6b29tcyBpbi5cclxuICAgICk7XHJcblxyXG4gICAgLy8gU2V0IHVwIHRoZSByb290IG5vZGUgZm9yIGFsbCBtb2RlbCBvYmplY3RzLiBOb2RlcyBwbGFjZWQgdW5kZXIgdGhpcyBvbmUgd2lsbCBzY3JvbGwgd2hlbiB0aGUgdXNlciBtb3ZlcyBhbG9uZyB0aGVcclxuICAgIC8vIEROQSBzdHJhbmQuXHJcbiAgICB0aGlzLm1vZGVsUm9vdE5vZGUgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5tb2RlbFJvb3ROb2RlICk7XHJcblxyXG4gICAgLy8gQWRkIHNvbWUgbGF5ZXJzIGZvciBlbmZvcmNpbmcgc29tZSB6LW9yZGVyIHJlbGF0aW9uc2hpcHMgbmVlZGVkIGluIG9yZGVyIHRvIGtlZXAgdGhpbmdzIGxvb2tpbmcgZ29vZC5cclxuICAgIGNvbnN0IGRuYUxheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMubW9kZWxSb290Tm9kZS5hZGRDaGlsZCggZG5hTGF5ZXIgKTtcclxuICAgIGRuYUxheWVyLnNldFBpY2thYmxlKCBmYWxzZSApO1xyXG4gICAgY29uc3QgbWVzc2VuZ2VyUm5hTGF5ZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgbWVzc2VuZ2VyUm5hTGF5ZXIuc2V0UGlja2FibGUoIGZhbHNlICk7XHJcbiAgICB0aGlzLm1vZGVsUm9vdE5vZGUuYWRkQ2hpbGQoIG1lc3NlbmdlclJuYUxheWVyICk7XHJcbiAgICBjb25zdCB0cmFuc2NyaWJpbmdQb2x5bWVyYXNlTGF5ZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgdHJhbnNjcmliaW5nUG9seW1lcmFzZUxheWVyLnNldFBpY2thYmxlKCBmYWxzZSApO1xyXG4gICAgdGhpcy5tb2RlbFJvb3ROb2RlLmFkZENoaWxkKCB0cmFuc2NyaWJpbmdQb2x5bWVyYXNlTGF5ZXIgKTtcclxuICAgIGNvbnN0IHRvcEJpb21vbGVjdWxlTGF5ZXIgPSBuZXcgTm9kZSgpO1xyXG4gICAgdG9wQmlvbW9sZWN1bGVMYXllci5zZXRQaWNrYWJsZSggZmFsc2UgKTtcclxuICAgIHRoaXMubW9kZWxSb290Tm9kZS5hZGRDaGlsZCggdG9wQmlvbW9sZWN1bGVMYXllciApO1xyXG4gICAgY29uc3QgcGxhY2VtZW50SGludExheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIHRoaXMubW9kZWxSb290Tm9kZS5hZGRDaGlsZCggcGxhY2VtZW50SGludExheWVyICk7XHJcbiAgICBjb25zdCBjb250cm9sc05vZGUgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggY29udHJvbHNOb2RlICk7XHJcblxyXG4gICAgLy8gQWRkIHRoZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgRE5BIHN0cmFuZC5cclxuICAgIHRoaXMuZG5hTW9sZWN1bGVOb2RlID0gbmV3IERuYU1vbGVjdWxlTm9kZSggbW9kZWwuZ2V0RG5hTW9sZWN1bGUoKSwgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0sIDUsIGZhbHNlICk7XHJcbiAgICBkbmFMYXllci5hZGRDaGlsZCggdGhpcy5kbmFNb2xlY3VsZU5vZGUgKTtcclxuXHJcbiAgICAvLyBHZXQgYSByZWZlcmVuY2UgdG8gdGhlIGdlbmUgYmVpbmcgY29udHJvbGxlZC5cclxuICAgIGNvbnN0IGdlbmUgPSBtb2RlbC5nZXREbmFNb2xlY3VsZSgpLmdldEdlbmVzKClbIDAgXTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIG5vZGVzIHRoYXQgYWxsb3cgdGhlIHVzZXIgdG8gY29udHJvbCB0aGUgY29uY2VudHJhdGlvbnMgYW5kIGFmZmluaXRpZXMuXHJcbiAgICBjb25zdCBwb3NpdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwgPSBuZXcgVHJhbnNjcmlwdGlvbkZhY3RvckNvbnRyb2xQYW5lbChcclxuICAgICAgbW9kZWwsXHJcbiAgICAgIE1lc3NlbmdlclJuYVByb2R1Y3Rpb25Nb2RlbC5QT1NJVElWRV9UUkFOU0NSSVBUSU9OX0ZBQ1RPUl9DT05GSUcsXHJcbiAgICAgIGdlbmUuZ2V0VHJhbnNjcmlwdGlvbkZhY3RvckFmZmluaXR5UHJvcGVydHkoIE1lc3NlbmdlclJuYVByb2R1Y3Rpb25Nb2RlbC5QT1NJVElWRV9UUkFOU0NSSVBUSU9OX0ZBQ1RPUl9DT05GSUcgKVxyXG4gICAgKTtcclxuICAgIGNvbnRyb2xzTm9kZS5hZGRDaGlsZCggcG9zaXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsICk7XHJcblxyXG4gICAgY29uc3QgcG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsID0gbmV3IFBvbHltZXJhc2VBZmZpbml0eUNvbnRyb2xQYW5lbChcclxuICAgICAgTWVzc2VuZ2VyUm5hUHJvZHVjdGlvbk1vZGVsLlBPU0lUSVZFX1RSQU5TQ1JJUFRJT05fRkFDVE9SX0NPTkZJRyxcclxuICAgICAgcG9zaXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsLmJvdW5kcy5oZWlnaHQsXHJcbiAgICAgIGdlbmUuZ2V0UG9seW1lcmFzZUFmZmluaXR5UHJvcGVydHkoKVxyXG4gICAgKTtcclxuICAgIGNvbnRyb2xzTm9kZS5hZGRDaGlsZCggcG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsICk7XHJcblxyXG4gICAgY29uc3QgbmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsID0gbmV3IFRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwoXHJcbiAgICAgIG1vZGVsLFxyXG4gICAgICBNZXNzZW5nZXJSbmFQcm9kdWN0aW9uTW9kZWwuTkVHQVRJVkVfVFJBTlNDUklQVElPTl9GQUNUT1JfQ09ORklHLFxyXG4gICAgICBnZW5lLmdldFRyYW5zY3JpcHRpb25GYWN0b3JBZmZpbml0eVByb3BlcnR5KCBNZXNzZW5nZXJSbmFQcm9kdWN0aW9uTW9kZWwuTkVHQVRJVkVfVFJBTlNDUklQVElPTl9GQUNUT1JfQ09ORklHIClcclxuICAgICk7XHJcbiAgICBjb250cm9sc05vZGUuYWRkQ2hpbGQoIG5lZ2F0aXZlVHJhbnNjcmlwdGlvbkZhY3RvckNvbnRyb2xQYW5lbCApO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgY2hlY2tib3ggZm9yIHNob3dpbmcvaGlkaW5nIHRoZSBjb250cm9sIHBhbmVsIGZvciB0aGUgbmVnYXRpdmUgdHJhbnNjcmlwdGlvbiBmYWN0b3IuXHJcbiAgICBjb25zdCBuZWdhdGl2ZUZhY3RvckVuYWJsZWRDaGVja2JveCA9IG5ldyBDaGVja2JveCggdGhpcy5uZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JFbmFibGVkLCBuZXcgVGV4dCggbmVnYXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yU3RyaW5nLCB7IGZvbnQ6IG5ldyBQaGV0Rm9udCggMTggKSwgbWF4V2lkdGg6IDI3NSB9ICksIHsgYm94V2lkdGg6IDIwIH0gKTtcclxuICAgIGNvbnRyb2xzTm9kZS5hZGRDaGlsZCggbmVnYXRpdmVGYWN0b3JFbmFibGVkQ2hlY2tib3ggKTtcclxuXHJcbiAgICAvLyBPbmx5IHNob3cgdGhlIGNvbnRyb2wgZm9yIHRoZSBuZWdhdGl2ZSB0cmFuc2NyaXB0aW9uIGZhY3RvciBpZiBpdCBpcyBlbmFibGVkLlxyXG4gICAgdGhpcy5uZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JFbmFibGVkLmxpbmsoIGVuYWJsZWQgPT4ge1xyXG4gICAgICBuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwuc2V0VmlzaWJsZSggZW5hYmxlZCApO1xyXG4gICAgICBpZiAoICFlbmFibGVkICkge1xyXG4gICAgICAgIC8vIFdoZW4gdGhlIG5lZ2F0aXZlIHRyYW5zY3JpcHRpb24gZmFjdG9yIGNvbnRyb2wgaXMgaGlkZGVuLCB0aGVyZSBzaG91bGQgYmUgbm8gbmVnYXRpdmUgZmFjdG9ycy5cclxuICAgICAgICB0aGlzLm1vZGVsLm5lZ2F0aXZlVHJhbnNjcmlwdGlvbkZhY3RvckNvdW50UHJvcGVydHkucmVzZXQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEFkZHMgdGhlIG5vZGUgdGhhdCBoYXMgdGhlIGJ1dHRvbnMgZm9yIGNvbnRyb2xsaW5nIHRpbWUgYW5kIHBhdXNpbmcgYW5kIHN0ZXBwaW5nIGZvcndhcmRcclxuICAgIGNvbnN0IHRpbWVDb250cm9sTm9kZSA9IG5ldyBUaW1lQ29udHJvbE5vZGUoIG1vZGVsLmNsb2NrUnVubmluZ1Byb3BlcnR5LCB7XHJcbiAgICAgIHBsYXlQYXVzZVN0ZXBCdXR0b25PcHRpb25zOiB7XHJcbiAgICAgICAgcGxheVBhdXNlU3RlcFhTcGFjaW5nOiBJTlNFVCxcclxuICAgICAgICBwbGF5UGF1c2VCdXR0b25PcHRpb25zOiB7XHJcbiAgICAgICAgICByYWRpdXM6IDIzLFxyXG4gICAgICAgICAgdG91Y2hBcmVhRGlsYXRpb246IDVcclxuICAgICAgICB9LFxyXG4gICAgICAgIHN0ZXBGb3J3YXJkQnV0dG9uT3B0aW9uczoge1xyXG4gICAgICAgICAgbGlzdGVuZXI6ICgpID0+IHsgbW9kZWwuc3RlcEluVGltZSggMC4wMTYgKTsgfSxcclxuICAgICAgICAgIHJhZGl1czogMTUsXHJcbiAgICAgICAgICB0b3VjaEFyZWFEaWxhdGlvbjogNVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGltZUNvbnRyb2xOb2RlICk7XHJcblxyXG4gICAgLy8gQWRkIHRoZSBSZXNldCBBbGwgYnV0dG9uLlxyXG4gICAgY29uc3QgcmVzZXRBbGxCdXR0b24gPSBuZXcgUmVzZXRBbGxCdXR0b24oIHtcclxuICAgICAgbGlzdGVuZXI6ICgpID0+IHtcclxuICAgICAgICB0aGlzLmludGVycnVwdFN1YnRyZWVJbnB1dCgpOyAvLyBjYW5jZWwgdXNlciBpbnRlcmFjdGlvbnNcclxuICAgICAgICB0aGlzLm1vZGVsLnJlc2V0KCk7XHJcbiAgICAgICAgdGhpcy5uZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JFbmFibGVkLnJlc2V0KCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJpZ2h0OiB0aGlzLmxheW91dEJvdW5kcy5tYXhYIC0gSU5TRVQsXHJcbiAgICAgIGJvdHRvbTogdGhpcy5sYXlvdXRCb3VuZHMubWF4WSAtIElOU0VUXHJcbiAgICB9ICk7XHJcbiAgICBjb250cm9sc05vZGUuYWRkQ2hpbGQoIHJlc2V0QWxsQnV0dG9uICk7XHJcblxyXG4gICAgLy8gTGF5IG91dCB0aGUgY29udHJvbHMuXHJcblxyXG4gICAgcG9zaXRpdmVUcmFuc2NyaXB0aW9uRmFjdG9yQ29udHJvbFBhbmVsLmxlZnQgPSBJTlNFVDtcclxuICAgIHBvc2l0aXZlVHJhbnNjcmlwdGlvbkZhY3RvckNvbnRyb2xQYW5lbC5ib3R0b20gPSB0aGlzLmxheW91dEJvdW5kcy5tYXhZIC0gSU5TRVQ7XHJcblxyXG4gICAgcG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsLmxlZnQgPSBwb3NpdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwucmlnaHQgKyBJTlNFVDtcclxuICAgIHBvbHltZXJhc2VBZmZpbml0eUNvbnRyb2xQYW5lbC5ib3R0b20gPSBwb3NpdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwuYm90dG9tO1xyXG5cclxuICAgIG5lZ2F0aXZlVHJhbnNjcmlwdGlvbkZhY3RvckNvbnRyb2xQYW5lbC5sZWZ0ID0gcG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsLnJpZ2h0ICsgSU5TRVQ7XHJcbiAgICBuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwuYm90dG9tID0gcG9seW1lcmFzZUFmZmluaXR5Q29udHJvbFBhbmVsLmJvdHRvbTtcclxuICAgIG5lZ2F0aXZlRmFjdG9yRW5hYmxlZENoZWNrYm94LmxlZnQgPSBuZWdhdGl2ZVRyYW5zY3JpcHRpb25GYWN0b3JDb250cm9sUGFuZWwucmlnaHQgKyBJTlNFVDtcclxuICAgIG5lZ2F0aXZlRmFjdG9yRW5hYmxlZENoZWNrYm94LmNlbnRlclkgPSByZXNldEFsbEJ1dHRvbi5jZW50ZXJZO1xyXG5cclxuICAgIHRpbWVDb250cm9sTm9kZS5ib3R0b20gPSBuZWdhdGl2ZUZhY3RvckVuYWJsZWRDaGVja2JveC50b3AgLSAyICogSU5TRVQ7XHJcbiAgICB0aW1lQ29udHJvbE5vZGUuY2VudGVyWCA9IG5lZ2F0aXZlRmFjdG9yRW5hYmxlZENoZWNrYm94LmNlbnRlclg7XHJcblxyXG4gICAgLy8gZGVmaW5lIGEgZnVuY3Rpb24gZm9yIGFkZGluZyB2aWV3cyBvZiBiaW9tb2xlY3VsZXNcclxuICAgIGNvbnN0IGFkZEJpb21vbGVjdWxlVmlldyA9IGFkZGVkQmlvbW9sZWN1bGUgPT4ge1xyXG4gICAgICBjb25zdCBiaW9tb2xlY3VsZU5vZGUgPSBuZXcgTW9iaWxlQmlvbW9sZWN1bGVOb2RlKCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSwgYWRkZWRCaW9tb2xlY3VsZSApO1xyXG5cclxuICAgICAgLy8gT24gdGhpcyBzY3JlZW4sIHVzZXJzIGNhbid0IGRpcmVjdGx5IGludGVyYWN0IHdpdGggaW5kaXZpZHVhbCBiaW9tb2xlY3VsZXMuXHJcbiAgICAgIGJpb21vbGVjdWxlTm9kZS5zZXRQaWNrYWJsZSggZmFsc2UgKTtcclxuICAgICAgdG9wQmlvbW9sZWN1bGVMYXllci5hZGRDaGlsZCggYmlvbW9sZWN1bGVOb2RlICk7XHJcblxyXG4gICAgICAvLyBBZGQgYSBsaXN0ZW5lciB0aGF0IG1vdmVzIHRoZSBjaGlsZCBvbiB0byBhIGxvd2VyIGxheWVyIHdoZW4gaXQgY29ubmVjdHMgdG8gdGhlIEROQSBzbyB0aGF0IHdlIHNlZSB0aGUgZGVzaXJlZFxyXG4gICAgICAvLyBvdmVybGFwIGJlaGF2aW9yLlxyXG4gICAgICBjb25zdCBwb3NpdGlvbkJpb21vbGVjdWxlID0gYXR0YWNoZWRUb0RuYSA9PiB7XHJcbiAgICAgICAgaWYgKCBhdHRhY2hlZFRvRG5hICkge1xyXG4gICAgICAgICAgaWYgKCB0b3BCaW9tb2xlY3VsZUxheWVyLmhhc0NoaWxkKCBiaW9tb2xlY3VsZU5vZGUgKSApIHtcclxuICAgICAgICAgICAgdG9wQmlvbW9sZWN1bGVMYXllci5yZW1vdmVDaGlsZCggYmlvbW9sZWN1bGVOb2RlICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0cmFuc2NyaWJpbmdQb2x5bWVyYXNlTGF5ZXIuYWRkQ2hpbGQoIGJpb21vbGVjdWxlTm9kZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGlmICggdHJhbnNjcmliaW5nUG9seW1lcmFzZUxheWVyLmhhc0NoaWxkKCBiaW9tb2xlY3VsZU5vZGUgKSApIHtcclxuICAgICAgICAgICAgdHJhbnNjcmliaW5nUG9seW1lcmFzZUxheWVyLnJlbW92ZUNoaWxkKCBiaW9tb2xlY3VsZU5vZGUgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRvcEJpb21vbGVjdWxlTGF5ZXIuYWRkQ2hpbGQoIGJpb21vbGVjdWxlTm9kZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgYWRkZWRCaW9tb2xlY3VsZS5hdHRhY2hlZFRvRG5hUHJvcGVydHkubGF6eUxpbmsoIHBvc2l0aW9uQmlvbW9sZWN1bGUgKTtcclxuXHJcbiAgICAgIG1vZGVsLm1vYmlsZUJpb21vbGVjdWxlTGlzdC5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCBmdW5jdGlvbiByZW1vdmFsTGlzdGVuZXIoIHJlbW92ZWRCaW9tb2xlY3VsZSApIHtcclxuICAgICAgICBpZiAoIHJlbW92ZWRCaW9tb2xlY3VsZSA9PT0gYWRkZWRCaW9tb2xlY3VsZSApIHtcclxuICAgICAgICAgIGlmICggdG9wQmlvbW9sZWN1bGVMYXllci5oYXNDaGlsZCggYmlvbW9sZWN1bGVOb2RlICkgKSB7XHJcbiAgICAgICAgICAgIHRvcEJpb21vbGVjdWxlTGF5ZXIucmVtb3ZlQ2hpbGQoIGJpb21vbGVjdWxlTm9kZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSBpZiAoIGRuYUxheWVyLmhhc0NoaWxkKCBiaW9tb2xlY3VsZU5vZGUgKSApIHtcclxuICAgICAgICAgICAgZG5hTGF5ZXIucmVtb3ZlQ2hpbGQoIGJpb21vbGVjdWxlTm9kZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgYWRkZWRCaW9tb2xlY3VsZS5hdHRhY2hlZFRvRG5hUHJvcGVydHkudW5saW5rKCBwb3NpdGlvbkJpb21vbGVjdWxlICk7XHJcbiAgICAgICAgICBiaW9tb2xlY3VsZU5vZGUuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgbW9kZWwubW9iaWxlQmlvbW9sZWN1bGVMaXN0LnJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIoIHJlbW92YWxMaXN0ZW5lciApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfTtcclxuXHJcbiAgICBtb2RlbC5tb2JpbGVCaW9tb2xlY3VsZUxpc3QuZm9yRWFjaCggYmlvTW9sZWN1bGUgPT4ge1xyXG4gICAgICBhZGRCaW9tb2xlY3VsZVZpZXcoIGJpb01vbGVjdWxlICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gV2F0Y2ggZm9yIGFuZCBoYW5kbGUgY29taW5ncyBhbmQgZ29pbmdzIG9mIGJpb21vbGVjdWxlcyBpbiB0aGUgbW9kZWwuIE1vc3QsIGJ1dCBub3QgYWxsLCBvZiB0aGUgYmlvbW9sZWN1bGVzIGFyZVxyXG4gICAgLy8gaGFuZGxlZCBieSB0aGlzLiBBIGZldyBvdGhlcnMgYXJlIGhhbmRsZWQgYXMgc3BlY2lhbCBjYXNlcy5cclxuICAgIG1vZGVsLm1vYmlsZUJpb21vbGVjdWxlTGlzdC5hZGRJdGVtQWRkZWRMaXN0ZW5lciggYWRkZWRCaW9tb2xlY3VsZSA9PiB7XHJcbiAgICAgIGFkZEJpb21vbGVjdWxlVmlldyggYWRkZWRCaW9tb2xlY3VsZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFdhdGNoIGZvciBhbmQgaGFuZGxlIGNvbWluZ3MgYW5kIGdvaW5ncyBvZiBtZXNzZW5nZXIgUk5BLlxyXG4gICAgbW9kZWwubWVzc2VuZ2VyUm5hTGlzdC5hZGRJdGVtQWRkZWRMaXN0ZW5lciggYWRkZWRNZXNzZW5nZXJSbmEgPT4ge1xyXG5cclxuICAgICAgY29uc3QgbWVzc2VuZ2VyUm5hTm9kZSA9IG5ldyBNZXNzZW5nZXJSbmFOb2RlKCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSwgYWRkZWRNZXNzZW5nZXJSbmEgKTtcclxuICAgICAgbWVzc2VuZ2VyUm5hTGF5ZXIuYWRkQ2hpbGQoIG1lc3NlbmdlclJuYU5vZGUgKTtcclxuXHJcbiAgICAgIG1vZGVsLm1lc3NlbmdlclJuYUxpc3QuYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciggZnVuY3Rpb24gcmVtb3ZhbExpc3RlbmVyKCByZW1vdmVkTWVzc2VuZ2VyUm5hICkge1xyXG4gICAgICAgIGlmICggcmVtb3ZlZE1lc3NlbmdlclJuYSA9PT0gYWRkZWRNZXNzZW5nZXJSbmEgKSB7XHJcbiAgICAgICAgICBtZXNzZW5nZXJSbmFMYXllci5yZW1vdmVDaGlsZCggbWVzc2VuZ2VyUm5hTm9kZSApO1xyXG4gICAgICAgICAgbWVzc2VuZ2VyUm5hTm9kZS5kaXNwb3NlKCk7XHJcbiAgICAgICAgICBtb2RlbC5tZXNzZW5nZXJSbmFMaXN0LnJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIoIHJlbW92YWxMaXN0ZW5lciApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RlcCBmdW5jdGlvbiBmb3IgdGhpcyB2aWV3XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoKSB7XHJcbiAgICB0aGlzLmRuYU1vbGVjdWxlTm9kZS5zdGVwKCk7XHJcbiAgfVxyXG59XHJcblxyXG5nZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMucmVnaXN0ZXIoICdNZXNzZW5nZXJSbmFQcm9kdWN0aW9uU2NyZWVuVmlldycsIE1lc3NlbmdlclJuYVByb2R1Y3Rpb25TY3JlZW5WaWV3ICk7XHJcbmV4cG9ydCBkZWZhdWx0IE1lc3Nlbmdl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