// Copyright 2015-2021, University of Colorado Boulder
/**
 * One of the states for TranscriptionFactorAttachmentStateMachine. Subclass of the "attached" state.
 *
 * @author Sharfudeen Ashraf
 * @author John Blanco
 * @author Aadish Gupta
 */

import dotRandom from '../../../../../dot/js/dotRandom.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import geneExpressionEssentials from '../../../geneExpressionEssentials.js';
import GEEConstants from '../../GEEConstants.js';
import FollowAttachmentSite from '../motion-strategies/FollowAttachmentSite.js';
import MoveDirectlyToDestinationMotionStrategy from '../motion-strategies/MoveDirectlyToDestinationMotionStrategy.js';
import WanderInGeneralDirectionMotionStrategy from '../motion-strategies/WanderInGeneralDirectionMotionStrategy.js';
import GenericAttachedState from './GenericAttachedState.js';

// constants
const HALF_LIFE_FOR_HALF_AFFINITY = 1.5; // In seconds.

class TranscriptionFactorAttachedState extends GenericAttachedState {
  /**
   * @param {TranscriptionFactorAttachmentStateMachine} transcriptionFactorAttachmentStateMachine
   */
  constructor(transcriptionFactorAttachmentStateMachine) {
    super();
    this.transcriptionFactorAttachmentStateMachine = transcriptionFactorAttachmentStateMachine; //@public
  }

  /**
   * Calculate the probability of detachment from the current base pair during the provided time interval. This uses
   * the same mathematics as is used for calculating probabilities of decay for radioactive
   * atomic nuclei.
   *
   * @param {number} affinity
   * @param {number} dt
   * @returns {number}
   * @public
   */
  calculateProbabilityOfDetachment(affinity, dt) {
    // Map affinity to a half life. Units are in seconds. This formula can be tweaked as needed in order to make the
    // half life longer or shorter. However, zero affinity should always map to zero half life, and an affinity of one
    // should always map to an infinite half life.
    const halfLife = HALF_LIFE_FOR_HALF_AFFINITY * (affinity / (1 - affinity));

    // Use standard half-life formula to decide on probability of detachment.
    return 1 - Math.exp(-0.693 * dt / halfLife);
  }

  /**
   * @param {AttachmentStateMachine} asm
   * @private
   */
  detachFromDnaMolecule(asm) {
    const biomolecule = this.transcriptionFactorAttachmentStateMachine.biomolecule;
    asm.attachmentSite.attachedOrAttachingMoleculeProperty.set(null);
    asm.attachmentSite = null;
    asm.setState(this.transcriptionFactorAttachmentStateMachine.unattachedButUnavailableState);
    biomolecule.setMotionStrategy(new WanderInGeneralDirectionMotionStrategy(biomolecule.getDetachDirection(), biomolecule.motionBoundsProperty));
    this.transcriptionFactorAttachmentStateMachine.detachFromDnaThreshold = 1; // Reset this threshold.
    asm.biomolecule.attachedToDnaProperty.set(false); // Update externally visible state indication.
  }

  /**
   * @override
   * @param {AttachmentStateMachine} asm
   * @param {number} dt
   * @public
   */
  step(asm, dt) {
    let attachmentSite = this.transcriptionFactorAttachmentStateMachine.attachmentSite;
    const detachFromDnaThreshold = this.transcriptionFactorAttachmentStateMachine.detachFromDnaThreshold;
    const biomolecule = this.transcriptionFactorAttachmentStateMachine.biomolecule;
    const movingTowardsAttachmentState = this.transcriptionFactorAttachmentStateMachine.movingTowardsAttachmentState;

    // Decide whether or not to detach from the current attachment site.
    if (dotRandom.nextDouble() > 1 - this.calculateProbabilityOfDetachment(attachmentSite.getAffinity(), dt)) {
      // The decision has been made to detach. Next, decide whether to detach completely from the DNA strand or just
      // jump to an adjacent base pair.
      if (dotRandom.nextDouble() > detachFromDnaThreshold) {
        // Detach completely from the DNA.
        this.detachFromDnaMolecule(asm);
      } else {
        // Move to an adjacent base pair. Start by making a list of candidate base pairs.
        let attachmentSites = biomolecule.getModel().getDnaMolecule().getAdjacentAttachmentSitesTranscriptionFactor(biomolecule, asm.attachmentSite);

        // Eliminate sites that, if moved to, would put the biomolecule out of bounds.
        _.remove(attachmentSites, site => !biomolecule.motionBoundsProperty.get().testIfInMotionBounds(biomolecule.bounds, site.positionProperty.get()));

        // Shuffle in order to produce random-ish behavior.
        attachmentSites = dotRandom.shuffle(attachmentSites);
        if (attachmentSites.length === 0) {
          // No valid adjacent sites, so detach completely.
          this.detachFromDnaMolecule(asm);
        } else {
          // Clear the previous attachment site.
          attachmentSite.attachedOrAttachingMoleculeProperty.set(null);

          // Set a new attachment site.
          attachmentSite = attachmentSites[0];
          assert && assert(attachmentSite.attachedOrAttachingMoleculeProperty.get() === null);
          attachmentSite.attachedOrAttachingMoleculeProperty.set(biomolecule);

          // Set up the state to move to the new attachment site.
          this.transcriptionFactorAttachmentStateMachine.setState(movingTowardsAttachmentState);
          this.transcriptionFactorAttachmentStateMachine.attachmentSite = attachmentSite;
          biomolecule.setMotionStrategy(new MoveDirectlyToDestinationMotionStrategy(attachmentSite.positionProperty, biomolecule.motionBoundsProperty, new Vector2(0, 0), GEEConstants.VELOCITY_ON_DNA));

          // Update the detachment threshold. It gets lower over time to increase the probability of detachment.
          // Tweak as needed.
          this.transcriptionFactorAttachmentStateMachine.detachFromDnaThreshold = detachFromDnaThreshold * Math.pow(0.5, GEEConstants.DEFAULT_ATTACH_TIME);
        }
      }
    }
  }

  /**
   * @override
   * @param {AttachmentStateMachine} enclosingStateMachine
   * @public
   */
  entered(enclosingStateMachine) {
    enclosingStateMachine.biomolecule.setMotionStrategy(new FollowAttachmentSite(enclosingStateMachine.attachmentSite));
    enclosingStateMachine.biomolecule.attachedToDnaProperty.set(true); // Update externally visible state indication.
  }
}

geneExpressionEssentials.register('TranscriptionFactorAttachedState', TranscriptionFactorAttachedState);
export default TranscriptionFactorAttachedState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3RSYW5kb20iLCJWZWN0b3IyIiwiZ2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzIiwiR0VFQ29uc3RhbnRzIiwiRm9sbG93QXR0YWNobWVudFNpdGUiLCJNb3ZlRGlyZWN0bHlUb0Rlc3RpbmF0aW9uTW90aW9uU3RyYXRlZ3kiLCJXYW5kZXJJbkdlbmVyYWxEaXJlY3Rpb25Nb3Rpb25TdHJhdGVneSIsIkdlbmVyaWNBdHRhY2hlZFN0YXRlIiwiSEFMRl9MSUZFX0ZPUl9IQUxGX0FGRklOSVRZIiwiVHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaGVkU3RhdGUiLCJjb25zdHJ1Y3RvciIsInRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lIiwiY2FsY3VsYXRlUHJvYmFiaWxpdHlPZkRldGFjaG1lbnQiLCJhZmZpbml0eSIsImR0IiwiaGFsZkxpZmUiLCJNYXRoIiwiZXhwIiwiZGV0YWNoRnJvbURuYU1vbGVjdWxlIiwiYXNtIiwiYmlvbW9sZWN1bGUiLCJhdHRhY2htZW50U2l0ZSIsImF0dGFjaGVkT3JBdHRhY2hpbmdNb2xlY3VsZVByb3BlcnR5Iiwic2V0Iiwic2V0U3RhdGUiLCJ1bmF0dGFjaGVkQnV0VW5hdmFpbGFibGVTdGF0ZSIsInNldE1vdGlvblN0cmF0ZWd5IiwiZ2V0RGV0YWNoRGlyZWN0aW9uIiwibW90aW9uQm91bmRzUHJvcGVydHkiLCJkZXRhY2hGcm9tRG5hVGhyZXNob2xkIiwiYXR0YWNoZWRUb0RuYVByb3BlcnR5Iiwic3RlcCIsIm1vdmluZ1Rvd2FyZHNBdHRhY2htZW50U3RhdGUiLCJuZXh0RG91YmxlIiwiZ2V0QWZmaW5pdHkiLCJhdHRhY2htZW50U2l0ZXMiLCJnZXRNb2RlbCIsImdldERuYU1vbGVjdWxlIiwiZ2V0QWRqYWNlbnRBdHRhY2htZW50U2l0ZXNUcmFuc2NyaXB0aW9uRmFjdG9yIiwiXyIsInJlbW92ZSIsInNpdGUiLCJnZXQiLCJ0ZXN0SWZJbk1vdGlvbkJvdW5kcyIsImJvdW5kcyIsInBvc2l0aW9uUHJvcGVydHkiLCJzaHVmZmxlIiwibGVuZ3RoIiwiYXNzZXJ0IiwiVkVMT0NJVFlfT05fRE5BIiwicG93IiwiREVGQVVMVF9BVFRBQ0hfVElNRSIsImVudGVyZWQiLCJlbmNsb3NpbmdTdGF0ZU1hY2hpbmUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2hlZFN0YXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE1LTIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG4vKipcclxuICogT25lIG9mIHRoZSBzdGF0ZXMgZm9yIFRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lLiBTdWJjbGFzcyBvZiB0aGUgXCJhdHRhY2hlZFwiIHN0YXRlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNoYXJmdWRlZW4gQXNocmFmXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY29cclxuICogQGF1dGhvciBBYWRpc2ggR3VwdGFcclxuICovXHJcblxyXG5pbXBvcnQgZG90UmFuZG9tIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9kb3RSYW5kb20uanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBnZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMgZnJvbSAnLi4vLi4vLi4vZ2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzLmpzJztcclxuaW1wb3J0IEdFRUNvbnN0YW50cyBmcm9tICcuLi8uLi9HRUVDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgRm9sbG93QXR0YWNobWVudFNpdGUgZnJvbSAnLi4vbW90aW9uLXN0cmF0ZWdpZXMvRm9sbG93QXR0YWNobWVudFNpdGUuanMnO1xyXG5pbXBvcnQgTW92ZURpcmVjdGx5VG9EZXN0aW5hdGlvbk1vdGlvblN0cmF0ZWd5IGZyb20gJy4uL21vdGlvbi1zdHJhdGVnaWVzL01vdmVEaXJlY3RseVRvRGVzdGluYXRpb25Nb3Rpb25TdHJhdGVneS5qcyc7XHJcbmltcG9ydCBXYW5kZXJJbkdlbmVyYWxEaXJlY3Rpb25Nb3Rpb25TdHJhdGVneSBmcm9tICcuLi9tb3Rpb24tc3RyYXRlZ2llcy9XYW5kZXJJbkdlbmVyYWxEaXJlY3Rpb25Nb3Rpb25TdHJhdGVneS5qcyc7XHJcbmltcG9ydCBHZW5lcmljQXR0YWNoZWRTdGF0ZSBmcm9tICcuL0dlbmVyaWNBdHRhY2hlZFN0YXRlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBIQUxGX0xJRkVfRk9SX0hBTEZfQUZGSU5JVFkgPSAxLjU7IC8vIEluIHNlY29uZHMuXHJcblxyXG5jbGFzcyBUcmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNoZWRTdGF0ZSBleHRlbmRzIEdlbmVyaWNBdHRhY2hlZFN0YXRlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtUcmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNobWVudFN0YXRlTWFjaGluZX0gdHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmVcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggdHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUgKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy50cmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNobWVudFN0YXRlTWFjaGluZSA9IHRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lOyAvL0BwdWJsaWNcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGN1bGF0ZSB0aGUgcHJvYmFiaWxpdHkgb2YgZGV0YWNobWVudCBmcm9tIHRoZSBjdXJyZW50IGJhc2UgcGFpciBkdXJpbmcgdGhlIHByb3ZpZGVkIHRpbWUgaW50ZXJ2YWwuIFRoaXMgdXNlc1xyXG4gICAqIHRoZSBzYW1lIG1hdGhlbWF0aWNzIGFzIGlzIHVzZWQgZm9yIGNhbGN1bGF0aW5nIHByb2JhYmlsaXRpZXMgb2YgZGVjYXkgZm9yIHJhZGlvYWN0aXZlXHJcbiAgICogYXRvbWljIG51Y2xlaS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBhZmZpbml0eVxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBkdFxyXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGNhbGN1bGF0ZVByb2JhYmlsaXR5T2ZEZXRhY2htZW50KCBhZmZpbml0eSwgZHQgKSB7XHJcblxyXG4gICAgLy8gTWFwIGFmZmluaXR5IHRvIGEgaGFsZiBsaWZlLiBVbml0cyBhcmUgaW4gc2Vjb25kcy4gVGhpcyBmb3JtdWxhIGNhbiBiZSB0d2Vha2VkIGFzIG5lZWRlZCBpbiBvcmRlciB0byBtYWtlIHRoZVxyXG4gICAgLy8gaGFsZiBsaWZlIGxvbmdlciBvciBzaG9ydGVyLiBIb3dldmVyLCB6ZXJvIGFmZmluaXR5IHNob3VsZCBhbHdheXMgbWFwIHRvIHplcm8gaGFsZiBsaWZlLCBhbmQgYW4gYWZmaW5pdHkgb2Ygb25lXHJcbiAgICAvLyBzaG91bGQgYWx3YXlzIG1hcCB0byBhbiBpbmZpbml0ZSBoYWxmIGxpZmUuXHJcbiAgICBjb25zdCBoYWxmTGlmZSA9IEhBTEZfTElGRV9GT1JfSEFMRl9BRkZJTklUWSAqICggYWZmaW5pdHkgLyAoIDEgLSBhZmZpbml0eSApICk7XHJcblxyXG4gICAgLy8gVXNlIHN0YW5kYXJkIGhhbGYtbGlmZSBmb3JtdWxhIHRvIGRlY2lkZSBvbiBwcm9iYWJpbGl0eSBvZiBkZXRhY2htZW50LlxyXG4gICAgcmV0dXJuIDEgLSBNYXRoLmV4cCggLTAuNjkzICogZHQgLyBoYWxmTGlmZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtBdHRhY2htZW50U3RhdGVNYWNoaW5lfSBhc21cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGRldGFjaEZyb21EbmFNb2xlY3VsZSggYXNtICkge1xyXG4gICAgY29uc3QgYmlvbW9sZWN1bGUgPSB0aGlzLnRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lLmJpb21vbGVjdWxlO1xyXG4gICAgYXNtLmF0dGFjaG1lbnRTaXRlLmF0dGFjaGVkT3JBdHRhY2hpbmdNb2xlY3VsZVByb3BlcnR5LnNldCggbnVsbCApO1xyXG4gICAgYXNtLmF0dGFjaG1lbnRTaXRlID0gbnVsbDtcclxuICAgIGFzbS5zZXRTdGF0ZSggdGhpcy50cmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNobWVudFN0YXRlTWFjaGluZS51bmF0dGFjaGVkQnV0VW5hdmFpbGFibGVTdGF0ZSApO1xyXG4gICAgYmlvbW9sZWN1bGUuc2V0TW90aW9uU3RyYXRlZ3koIG5ldyBXYW5kZXJJbkdlbmVyYWxEaXJlY3Rpb25Nb3Rpb25TdHJhdGVneSggYmlvbW9sZWN1bGUuZ2V0RGV0YWNoRGlyZWN0aW9uKCksXHJcbiAgICAgIGJpb21vbGVjdWxlLm1vdGlvbkJvdW5kc1Byb3BlcnR5ICkgKTtcclxuICAgIHRoaXMudHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuZGV0YWNoRnJvbURuYVRocmVzaG9sZCA9IDE7IC8vIFJlc2V0IHRoaXMgdGhyZXNob2xkLlxyXG4gICAgYXNtLmJpb21vbGVjdWxlLmF0dGFjaGVkVG9EbmFQcm9wZXJ0eS5zZXQoIGZhbHNlICk7IC8vIFVwZGF0ZSBleHRlcm5hbGx5IHZpc2libGUgc3RhdGUgaW5kaWNhdGlvbi5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwYXJhbSB7QXR0YWNobWVudFN0YXRlTWFjaGluZX0gYXNtXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGR0XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGFzbSwgZHQgKSB7XHJcbiAgICBsZXQgYXR0YWNobWVudFNpdGUgPSB0aGlzLnRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lLmF0dGFjaG1lbnRTaXRlO1xyXG4gICAgY29uc3QgZGV0YWNoRnJvbURuYVRocmVzaG9sZCA9IHRoaXMudHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuZGV0YWNoRnJvbURuYVRocmVzaG9sZDtcclxuICAgIGNvbnN0IGJpb21vbGVjdWxlID0gdGhpcy50cmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNobWVudFN0YXRlTWFjaGluZS5iaW9tb2xlY3VsZTtcclxuICAgIGNvbnN0IG1vdmluZ1Rvd2FyZHNBdHRhY2htZW50U3RhdGUgPSB0aGlzLnRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lLm1vdmluZ1Rvd2FyZHNBdHRhY2htZW50U3RhdGU7XHJcblxyXG4gICAgLy8gRGVjaWRlIHdoZXRoZXIgb3Igbm90IHRvIGRldGFjaCBmcm9tIHRoZSBjdXJyZW50IGF0dGFjaG1lbnQgc2l0ZS5cclxuICAgIGlmICggZG90UmFuZG9tLm5leHREb3VibGUoKSA+ICggMSAtIHRoaXMuY2FsY3VsYXRlUHJvYmFiaWxpdHlPZkRldGFjaG1lbnQoIGF0dGFjaG1lbnRTaXRlLmdldEFmZmluaXR5KCksIGR0ICkgKSApIHtcclxuXHJcbiAgICAgIC8vIFRoZSBkZWNpc2lvbiBoYXMgYmVlbiBtYWRlIHRvIGRldGFjaC4gTmV4dCwgZGVjaWRlIHdoZXRoZXIgdG8gZGV0YWNoIGNvbXBsZXRlbHkgZnJvbSB0aGUgRE5BIHN0cmFuZCBvciBqdXN0XHJcbiAgICAgIC8vIGp1bXAgdG8gYW4gYWRqYWNlbnQgYmFzZSBwYWlyLlxyXG4gICAgICBpZiAoIGRvdFJhbmRvbS5uZXh0RG91YmxlKCkgPiBkZXRhY2hGcm9tRG5hVGhyZXNob2xkICkge1xyXG5cclxuICAgICAgICAvLyBEZXRhY2ggY29tcGxldGVseSBmcm9tIHRoZSBETkEuXHJcbiAgICAgICAgdGhpcy5kZXRhY2hGcm9tRG5hTW9sZWN1bGUoIGFzbSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBNb3ZlIHRvIGFuIGFkamFjZW50IGJhc2UgcGFpci4gU3RhcnQgYnkgbWFraW5nIGEgbGlzdCBvZiBjYW5kaWRhdGUgYmFzZSBwYWlycy5cclxuICAgICAgICBsZXQgYXR0YWNobWVudFNpdGVzID0gYmlvbW9sZWN1bGUuZ2V0TW9kZWwoKS5nZXREbmFNb2xlY3VsZSgpLmdldEFkamFjZW50QXR0YWNobWVudFNpdGVzVHJhbnNjcmlwdGlvbkZhY3RvciggYmlvbW9sZWN1bGUsIGFzbS5hdHRhY2htZW50U2l0ZSApO1xyXG5cclxuICAgICAgICAvLyBFbGltaW5hdGUgc2l0ZXMgdGhhdCwgaWYgbW92ZWQgdG8sIHdvdWxkIHB1dCB0aGUgYmlvbW9sZWN1bGUgb3V0IG9mIGJvdW5kcy5cclxuICAgICAgICBfLnJlbW92ZSggYXR0YWNobWVudFNpdGVzLCBzaXRlID0+ICFiaW9tb2xlY3VsZS5tb3Rpb25Cb3VuZHNQcm9wZXJ0eS5nZXQoKS50ZXN0SWZJbk1vdGlvbkJvdW5kcyggYmlvbW9sZWN1bGUuYm91bmRzLFxyXG4gICAgICAgICAgc2l0ZS5wb3NpdGlvblByb3BlcnR5LmdldCgpICkgKTtcclxuXHJcbiAgICAgICAgLy8gU2h1ZmZsZSBpbiBvcmRlciB0byBwcm9kdWNlIHJhbmRvbS1pc2ggYmVoYXZpb3IuXHJcbiAgICAgICAgYXR0YWNobWVudFNpdGVzID0gZG90UmFuZG9tLnNodWZmbGUoIGF0dGFjaG1lbnRTaXRlcyApO1xyXG5cclxuICAgICAgICBpZiAoIGF0dGFjaG1lbnRTaXRlcy5sZW5ndGggPT09IDAgKSB7XHJcblxyXG4gICAgICAgICAgLy8gTm8gdmFsaWQgYWRqYWNlbnQgc2l0ZXMsIHNvIGRldGFjaCBjb21wbGV0ZWx5LlxyXG4gICAgICAgICAgdGhpcy5kZXRhY2hGcm9tRG5hTW9sZWN1bGUoIGFzbSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgICAvLyBDbGVhciB0aGUgcHJldmlvdXMgYXR0YWNobWVudCBzaXRlLlxyXG4gICAgICAgICAgYXR0YWNobWVudFNpdGUuYXR0YWNoZWRPckF0dGFjaGluZ01vbGVjdWxlUHJvcGVydHkuc2V0KCBudWxsICk7XHJcblxyXG4gICAgICAgICAgLy8gU2V0IGEgbmV3IGF0dGFjaG1lbnQgc2l0ZS5cclxuICAgICAgICAgIGF0dGFjaG1lbnRTaXRlID0gYXR0YWNobWVudFNpdGVzWyAwIF07XHJcbiAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBhdHRhY2htZW50U2l0ZS5hdHRhY2hlZE9yQXR0YWNoaW5nTW9sZWN1bGVQcm9wZXJ0eS5nZXQoKSA9PT0gbnVsbCApO1xyXG4gICAgICAgICAgYXR0YWNobWVudFNpdGUuYXR0YWNoZWRPckF0dGFjaGluZ01vbGVjdWxlUHJvcGVydHkuc2V0KCBiaW9tb2xlY3VsZSApO1xyXG5cclxuICAgICAgICAgIC8vIFNldCB1cCB0aGUgc3RhdGUgdG8gbW92ZSB0byB0aGUgbmV3IGF0dGFjaG1lbnQgc2l0ZS5cclxuICAgICAgICAgIHRoaXMudHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuc2V0U3RhdGUoIG1vdmluZ1Rvd2FyZHNBdHRhY2htZW50U3RhdGUgKTtcclxuICAgICAgICAgIHRoaXMudHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuYXR0YWNobWVudFNpdGUgPSBhdHRhY2htZW50U2l0ZTtcclxuICAgICAgICAgIGJpb21vbGVjdWxlLnNldE1vdGlvblN0cmF0ZWd5KCBuZXcgTW92ZURpcmVjdGx5VG9EZXN0aW5hdGlvbk1vdGlvblN0cmF0ZWd5KCBhdHRhY2htZW50U2l0ZS5wb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICAgICAgICBiaW9tb2xlY3VsZS5tb3Rpb25Cb3VuZHNQcm9wZXJ0eSwgbmV3IFZlY3RvcjIoIDAsIDAgKSwgR0VFQ29uc3RhbnRzLlZFTE9DSVRZX09OX0ROQSApICk7XHJcblxyXG4gICAgICAgICAgLy8gVXBkYXRlIHRoZSBkZXRhY2htZW50IHRocmVzaG9sZC4gSXQgZ2V0cyBsb3dlciBvdmVyIHRpbWUgdG8gaW5jcmVhc2UgdGhlIHByb2JhYmlsaXR5IG9mIGRldGFjaG1lbnQuXHJcbiAgICAgICAgICAvLyBUd2VhayBhcyBuZWVkZWQuXHJcbiAgICAgICAgICB0aGlzLnRyYW5zY3JpcHRpb25GYWN0b3JBdHRhY2htZW50U3RhdGVNYWNoaW5lLmRldGFjaEZyb21EbmFUaHJlc2hvbGQgPVxyXG4gICAgICAgICAgICBkZXRhY2hGcm9tRG5hVGhyZXNob2xkICogTWF0aC5wb3coIDAuNSwgR0VFQ29uc3RhbnRzLkRFRkFVTFRfQVRUQUNIX1RJTUUgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwYXJhbSB7QXR0YWNobWVudFN0YXRlTWFjaGluZX0gZW5jbG9zaW5nU3RhdGVNYWNoaW5lXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGVudGVyZWQoIGVuY2xvc2luZ1N0YXRlTWFjaGluZSApIHtcclxuICAgIGVuY2xvc2luZ1N0YXRlTWFjaGluZS5iaW9tb2xlY3VsZS5zZXRNb3Rpb25TdHJhdGVneSggbmV3IEZvbGxvd0F0dGFjaG1lbnRTaXRlKCBlbmNsb3NpbmdTdGF0ZU1hY2hpbmUuYXR0YWNobWVudFNpdGUgKSApO1xyXG4gICAgZW5jbG9zaW5nU3RhdGVNYWNoaW5lLmJpb21vbGVjdWxlLmF0dGFjaGVkVG9EbmFQcm9wZXJ0eS5zZXQoIHRydWUgKTsgLy8gVXBkYXRlIGV4dGVybmFsbHkgdmlzaWJsZSBzdGF0ZSBpbmRpY2F0aW9uLlxyXG4gIH1cclxufVxyXG5cclxuZ2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzLnJlZ2lzdGVyKCAnVHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaGVkU3RhdGUnLCBUcmFuc2NyaXB0aW9uRmFjdG9yQXR0YWNoZWRTdGF0ZSApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgVHJhbnNjcmlwdGlvbkZhY3RvckF0dGFjaGVkU3RhdGU7Il0sIm1hcHBpbmdz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