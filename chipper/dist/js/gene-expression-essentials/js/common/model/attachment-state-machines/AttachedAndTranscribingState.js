// Copyright 2015-2020, University of Colorado Boulder

/**
 * One of the states for RnaPolymeraseAttachmentStateMachine. RnaPolymerase enters this state after conformation of
 * RnaPolymerase is complete
 *
 * @author Sharfudeen Ashraf
 * @author John Blanco
 * @author Aadish Gupta
 */

import Property from '../../../../../axon/js/Property.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import geneExpressionEssentials from '../../../geneExpressionEssentials.js';
import GEEConstants from '../../GEEConstants.js';
import MessengerRna from '../MessengerRna.js';
import MoveDirectlyToDestinationMotionStrategy from '../motion-strategies/MoveDirectlyToDestinationMotionStrategy.js';
import AttachmentState from './AttachmentState.js';

// constants
const MRNA_GROWTH_FACTOR = 0.63; // empirically determined adjustment factor to make mRNA appear to be about the right length

// used for comparing the position of Biomolecule and endOfGene's position.
const BIO_MOLECULE_POSITION_COMPARISON_EPSILON = 0.000001;
class AttachedAndTranscribingState extends AttachmentState {
  /**
   * @param {RnaPolymeraseAttachmentStateMachine} rnaPolymeraseAttachmentStateMachine
   */
  constructor(rnaPolymeraseAttachmentStateMachine) {
    super();

    // @public (read-ony) {RnaPolymeraseAttachmentStateMachine}
    this.rnaPolymeraseAttachmentStateMachine = rnaPolymeraseAttachmentStateMachine;

    // @private
    this.endOfGene = null;
    this.messengerRna = null;
  }

  /**
   * @override
   * @param {AttachmentStateMachine} asm
   * @param {number} dt - delta time
   * @public
   */
  step(asm, dt) {
    const rnaPolymerase = this.rnaPolymeraseAttachmentStateMachine.rnaPolymerase;
    const dnaStrandSeparation = this.rnaPolymeraseAttachmentStateMachine.dnaStrandSeparation;
    const biomolecule = this.rnaPolymeraseAttachmentStateMachine.biomolecule;
    let attachedState = this.rnaPolymeraseAttachmentStateMachine.attachedState;
    const attachedAndDeconformingState = this.rnaPolymeraseAttachmentStateMachine.attachedAndDeconformingState;

    // Verify that state is consistent
    assert && assert(asm.attachmentSite !== null);
    assert && assert(asm.attachmentSite.attachedOrAttachingMoleculeProperty.get() === biomolecule);

    // Grow the messenger RNA and position it to be attached to the polymerase.
    this.messengerRna.addLength(GEEConstants.TRANSCRIPTION_SPEED * MRNA_GROWTH_FACTOR * dt);
    this.messengerRna.setLowerRightPositionXY(rnaPolymerase.getPosition().x + rnaPolymerase.messengerRnaGenerationOffset.x, rnaPolymerase.getPosition().y + rnaPolymerase.messengerRnaGenerationOffset.y);

    // Move the DNA strand separator.
    dnaStrandSeparation.setXPosition(rnaPolymerase.getPosition().x);

    // Check for molecules that are in the way.
    const molecules = asm.biomolecule.getModel().getOverlappingBiomolecules(asm.biomolecule.bounds);
    molecules.forEach(molecule => {
      if (molecule.getPosition().x > asm.biomolecule.getPosition().x && molecule.attachedToDnaProperty.get()) {
        // This molecule is blocking transcription, so bump it off
        // of the DNA strand.
        molecule.forceDetach();
      }
    });

    // If we've reached the end of the gene, detach.
    if (biomolecule.getPosition().equalsEpsilon(this.endOfGene, BIO_MOLECULE_POSITION_COMPARISON_EPSILON)) {
      attachedState = attachedAndDeconformingState;
      this.rnaPolymeraseAttachmentStateMachine.setState(attachedState);
      this.messengerRna.releaseFromPolymerase();
      this.messengerRna.movableByUserProperty.set(true);
      this.messengerRna = null;
      this.endOfGene = null;
    }
  }

  /**
   * @override
   * @param {AttachmentStateMachine} asm
   * @public
   */
  entered(asm) {
    const biomolecule = this.rnaPolymeraseAttachmentStateMachine.biomolecule;
    const transcribingAttachmentSite = this.rnaPolymeraseAttachmentStateMachine.transcribingAttachmentSite;
    const attachmentSite = this.rnaPolymeraseAttachmentStateMachine.attachmentSite;

    // Prevent user interaction.
    asm.biomolecule.movableByUserProperty.set(false);

    // Determine the gene that is being transcribed.
    const geneToTranscribe = biomolecule.getModel().getDnaMolecule().getGeneAtPosition(biomolecule.getPosition());
    assert && assert(geneToTranscribe !== null);

    // Set up the motion strategy to move to the end of the transcribed region of the gene.
    this.endOfGene = new Vector2(geneToTranscribe.getEndX(), GEEConstants.DNA_MOLECULE_Y_POS);
    asm.biomolecule.setMotionStrategy(new MoveDirectlyToDestinationMotionStrategy(new Property(this.endOfGene.copy()), biomolecule.motionBoundsProperty, new Vector2(0, 0), GEEConstants.TRANSCRIPTION_SPEED));

    // Create the mRNA that will be grown as a result of this transcription.
    this.messengerRna = new MessengerRna(biomolecule.getModel(), geneToTranscribe.getProteinPrototype(), biomolecule.getPosition().plus(biomolecule.messengerRnaGenerationOffset), {
      windingParamSet: geneToTranscribe.windingAlgorithmParameterSet
    });
    biomolecule.spawnMessengerRna(this.messengerRna);
    this.messengerRna.movableByUserProperty.set(false);

    // Free up the initial attachment site by hooking up to a somewhat fictional attachment site instead.
    attachmentSite.attachedOrAttachingMoleculeProperty.set(null);
    transcribingAttachmentSite.attachedOrAttachingMoleculeProperty.set(asm.biomolecule);
    this.rnaPolymeraseAttachmentStateMachine.attachmentSite = transcribingAttachmentSite;
  }
}
geneExpressionEssentials.register('AttachedAndTranscribingState', AttachedAndTranscribingState);
export default AttachedAndTranscribingState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIlZlY3RvcjIiLCJnZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMiLCJHRUVDb25zdGFudHMiLCJNZXNzZW5nZXJSbmEiLCJNb3ZlRGlyZWN0bHlUb0Rlc3RpbmF0aW9uTW90aW9uU3RyYXRlZ3kiLCJBdHRhY2htZW50U3RhdGUiLCJNUk5BX0dST1dUSF9GQUNUT1IiLCJCSU9fTU9MRUNVTEVfUE9TSVRJT05fQ09NUEFSSVNPTl9FUFNJTE9OIiwiQXR0YWNoZWRBbmRUcmFuc2NyaWJpbmdTdGF0ZSIsImNvbnN0cnVjdG9yIiwicm5hUG9seW1lcmFzZUF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUiLCJlbmRPZkdlbmUiLCJtZXNzZW5nZXJSbmEiLCJzdGVwIiwiYXNtIiwiZHQiLCJybmFQb2x5bWVyYXNlIiwiZG5hU3RyYW5kU2VwYXJhdGlvbiIsImJpb21vbGVjdWxlIiwiYXR0YWNoZWRTdGF0ZSIsImF0dGFjaGVkQW5kRGVjb25mb3JtaW5nU3RhdGUiLCJhc3NlcnQiLCJhdHRhY2htZW50U2l0ZSIsImF0dGFjaGVkT3JBdHRhY2hpbmdNb2xlY3VsZVByb3BlcnR5IiwiZ2V0IiwiYWRkTGVuZ3RoIiwiVFJBTlNDUklQVElPTl9TUEVFRCIsInNldExvd2VyUmlnaHRQb3NpdGlvblhZIiwiZ2V0UG9zaXRpb24iLCJ4IiwibWVzc2VuZ2VyUm5hR2VuZXJhdGlvbk9mZnNldCIsInkiLCJzZXRYUG9zaXRpb24iLCJtb2xlY3VsZXMiLCJnZXRNb2RlbCIsImdldE92ZXJsYXBwaW5nQmlvbW9sZWN1bGVzIiwiYm91bmRzIiwiZm9yRWFjaCIsIm1vbGVjdWxlIiwiYXR0YWNoZWRUb0RuYVByb3BlcnR5IiwiZm9yY2VEZXRhY2giLCJlcXVhbHNFcHNpbG9uIiwic2V0U3RhdGUiLCJyZWxlYXNlRnJvbVBvbHltZXJhc2UiLCJtb3ZhYmxlQnlVc2VyUHJvcGVydHkiLCJzZXQiLCJlbnRlcmVkIiwidHJhbnNjcmliaW5nQXR0YWNobWVudFNpdGUiLCJnZW5lVG9UcmFuc2NyaWJlIiwiZ2V0RG5hTW9sZWN1bGUiLCJnZXRHZW5lQXRQb3NpdGlvbiIsImdldEVuZFgiLCJETkFfTU9MRUNVTEVfWV9QT1MiLCJzZXRNb3Rpb25TdHJhdGVneSIsImNvcHkiLCJtb3Rpb25Cb3VuZHNQcm9wZXJ0eSIsImdldFByb3RlaW5Qcm90b3R5cGUiLCJwbHVzIiwid2luZGluZ1BhcmFtU2V0Iiwid2luZGluZ0FsZ29yaXRobVBhcmFtZXRlclNldCIsInNwYXduTWVzc2VuZ2VyUm5hIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBdHRhY2hlZEFuZFRyYW5zY3JpYmluZ1N0YXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE1LTIwMjAsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE9uZSBvZiB0aGUgc3RhdGVzIGZvciBSbmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS4gUm5hUG9seW1lcmFzZSBlbnRlcnMgdGhpcyBzdGF0ZSBhZnRlciBjb25mb3JtYXRpb24gb2ZcclxuICogUm5hUG9seW1lcmFzZSBpcyBjb21wbGV0ZVxyXG4gKlxyXG4gKiBAYXV0aG9yIFNoYXJmdWRlZW4gQXNocmFmXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY29cclxuICogQGF1dGhvciBBYWRpc2ggR3VwdGFcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IGdlbmVFeHByZXNzaW9uRXNzZW50aWFscyBmcm9tICcuLi8uLi8uLi9nZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMuanMnO1xyXG5pbXBvcnQgR0VFQ29uc3RhbnRzIGZyb20gJy4uLy4uL0dFRUNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBNZXNzZW5nZXJSbmEgZnJvbSAnLi4vTWVzc2VuZ2VyUm5hLmpzJztcclxuaW1wb3J0IE1vdmVEaXJlY3RseVRvRGVzdGluYXRpb25Nb3Rpb25TdHJhdGVneSBmcm9tICcuLi9tb3Rpb24tc3RyYXRlZ2llcy9Nb3ZlRGlyZWN0bHlUb0Rlc3RpbmF0aW9uTW90aW9uU3RyYXRlZ3kuanMnO1xyXG5pbXBvcnQgQXR0YWNobWVudFN0YXRlIGZyb20gJy4vQXR0YWNobWVudFN0YXRlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBNUk5BX0dST1dUSF9GQUNUT1IgPSAwLjYzOyAvLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIGFkanVzdG1lbnQgZmFjdG9yIHRvIG1ha2UgbVJOQSBhcHBlYXIgdG8gYmUgYWJvdXQgdGhlIHJpZ2h0IGxlbmd0aFxyXG5cclxuLy8gdXNlZCBmb3IgY29tcGFyaW5nIHRoZSBwb3NpdGlvbiBvZiBCaW9tb2xlY3VsZSBhbmQgZW5kT2ZHZW5lJ3MgcG9zaXRpb24uXHJcbmNvbnN0IEJJT19NT0xFQ1VMRV9QT1NJVElPTl9DT01QQVJJU09OX0VQU0lMT04gPSAwLjAwMDAwMTtcclxuXHJcbmNsYXNzIEF0dGFjaGVkQW5kVHJhbnNjcmliaW5nU3RhdGUgZXh0ZW5kcyBBdHRhY2htZW50U3RhdGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1JuYVBvbHltZXJhc2VBdHRhY2htZW50U3RhdGVNYWNoaW5lfSBybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZSApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbnkpIHtSbmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZX1cclxuICAgIHRoaXMucm5hUG9seW1lcmFzZUF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUgPSBybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZVxyXG4gICAgdGhpcy5lbmRPZkdlbmUgPSBudWxsO1xyXG4gICAgdGhpcy5tZXNzZW5nZXJSbmEgPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICogQHBhcmFtIHtBdHRhY2htZW50U3RhdGVNYWNoaW5lfSBhc21cclxuICAgKiBAcGFyYW0ge251bWJlcn0gZHQgLSBkZWx0YSB0aW1lXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXAoIGFzbSwgZHQgKSB7XHJcbiAgICBjb25zdCBybmFQb2x5bWVyYXNlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5ybmFQb2x5bWVyYXNlO1xyXG4gICAgY29uc3QgZG5hU3RyYW5kU2VwYXJhdGlvbiA9IHRoaXMucm5hUG9seW1lcmFzZUF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuZG5hU3RyYW5kU2VwYXJhdGlvbjtcclxuICAgIGNvbnN0IGJpb21vbGVjdWxlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5iaW9tb2xlY3VsZTtcclxuICAgIGxldCBhdHRhY2hlZFN0YXRlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5hdHRhY2hlZFN0YXRlO1xyXG4gICAgY29uc3QgYXR0YWNoZWRBbmREZWNvbmZvcm1pbmdTdGF0ZSA9IHRoaXMucm5hUG9seW1lcmFzZUF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuYXR0YWNoZWRBbmREZWNvbmZvcm1pbmdTdGF0ZTtcclxuXHJcbiAgICAvLyBWZXJpZnkgdGhhdCBzdGF0ZSBpcyBjb25zaXN0ZW50XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBhc20uYXR0YWNobWVudFNpdGUgIT09IG51bGwgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGFzbS5hdHRhY2htZW50U2l0ZS5hdHRhY2hlZE9yQXR0YWNoaW5nTW9sZWN1bGVQcm9wZXJ0eS5nZXQoKSA9PT0gYmlvbW9sZWN1bGUgKTtcclxuXHJcbiAgICAvLyBHcm93IHRoZSBtZXNzZW5nZXIgUk5BIGFuZCBwb3NpdGlvbiBpdCB0byBiZSBhdHRhY2hlZCB0byB0aGUgcG9seW1lcmFzZS5cclxuICAgIHRoaXMubWVzc2VuZ2VyUm5hLmFkZExlbmd0aCggR0VFQ29uc3RhbnRzLlRSQU5TQ1JJUFRJT05fU1BFRUQgKiBNUk5BX0dST1dUSF9GQUNUT1IgKiBkdCApO1xyXG4gICAgdGhpcy5tZXNzZW5nZXJSbmEuc2V0TG93ZXJSaWdodFBvc2l0aW9uWFkoXHJcbiAgICAgIHJuYVBvbHltZXJhc2UuZ2V0UG9zaXRpb24oKS54ICsgcm5hUG9seW1lcmFzZS5tZXNzZW5nZXJSbmFHZW5lcmF0aW9uT2Zmc2V0LngsXHJcbiAgICAgIHJuYVBvbHltZXJhc2UuZ2V0UG9zaXRpb24oKS55ICsgcm5hUG9seW1lcmFzZS5tZXNzZW5nZXJSbmFHZW5lcmF0aW9uT2Zmc2V0LnlcclxuICAgICk7XHJcblxyXG4gICAgLy8gTW92ZSB0aGUgRE5BIHN0cmFuZCBzZXBhcmF0b3IuXHJcbiAgICBkbmFTdHJhbmRTZXBhcmF0aW9uLnNldFhQb3NpdGlvbiggcm5hUG9seW1lcmFzZS5nZXRQb3NpdGlvbigpLnggKTtcclxuXHJcbiAgICAvLyBDaGVjayBmb3IgbW9sZWN1bGVzIHRoYXQgYXJlIGluIHRoZSB3YXkuXHJcbiAgICBjb25zdCBtb2xlY3VsZXMgPSBhc20uYmlvbW9sZWN1bGUuZ2V0TW9kZWwoKS5nZXRPdmVybGFwcGluZ0Jpb21vbGVjdWxlcyggYXNtLmJpb21vbGVjdWxlLmJvdW5kcyApO1xyXG4gICAgbW9sZWN1bGVzLmZvckVhY2goIG1vbGVjdWxlID0+IHtcclxuICAgICAgaWYgKCBtb2xlY3VsZS5nZXRQb3NpdGlvbigpLnggPiBhc20uYmlvbW9sZWN1bGUuZ2V0UG9zaXRpb24oKS54ICYmIG1vbGVjdWxlLmF0dGFjaGVkVG9EbmFQcm9wZXJ0eS5nZXQoKSApIHtcclxuXHJcbiAgICAgICAgLy8gVGhpcyBtb2xlY3VsZSBpcyBibG9ja2luZyB0cmFuc2NyaXB0aW9uLCBzbyBidW1wIGl0IG9mZlxyXG4gICAgICAgIC8vIG9mIHRoZSBETkEgc3RyYW5kLlxyXG4gICAgICAgIG1vbGVjdWxlLmZvcmNlRGV0YWNoKCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBJZiB3ZSd2ZSByZWFjaGVkIHRoZSBlbmQgb2YgdGhlIGdlbmUsIGRldGFjaC5cclxuICAgIGlmICggYmlvbW9sZWN1bGUuZ2V0UG9zaXRpb24oKS5lcXVhbHNFcHNpbG9uKCB0aGlzLmVuZE9mR2VuZSwgQklPX01PTEVDVUxFX1BPU0lUSU9OX0NPTVBBUklTT05fRVBTSUxPTiApICkge1xyXG4gICAgICBhdHRhY2hlZFN0YXRlID0gYXR0YWNoZWRBbmREZWNvbmZvcm1pbmdTdGF0ZTtcclxuICAgICAgdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5zZXRTdGF0ZSggYXR0YWNoZWRTdGF0ZSApO1xyXG4gICAgICB0aGlzLm1lc3NlbmdlclJuYS5yZWxlYXNlRnJvbVBvbHltZXJhc2UoKTtcclxuICAgICAgdGhpcy5tZXNzZW5nZXJSbmEubW92YWJsZUJ5VXNlclByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG4gICAgICB0aGlzLm1lc3NlbmdlclJuYSA9IG51bGw7XHJcbiAgICAgIHRoaXMuZW5kT2ZHZW5lID0gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwYXJhbSB7QXR0YWNobWVudFN0YXRlTWFjaGluZX0gYXNtXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGVudGVyZWQoIGFzbSApIHtcclxuICAgIGNvbnN0IGJpb21vbGVjdWxlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5iaW9tb2xlY3VsZTtcclxuICAgIGNvbnN0IHRyYW5zY3JpYmluZ0F0dGFjaG1lbnRTaXRlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS50cmFuc2NyaWJpbmdBdHRhY2htZW50U2l0ZTtcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRTaXRlID0gdGhpcy5ybmFQb2x5bWVyYXNlQXR0YWNobWVudFN0YXRlTWFjaGluZS5hdHRhY2htZW50U2l0ZTtcclxuXHJcbiAgICAvLyBQcmV2ZW50IHVzZXIgaW50ZXJhY3Rpb24uXHJcbiAgICBhc20uYmlvbW9sZWN1bGUubW92YWJsZUJ5VXNlclByb3BlcnR5LnNldCggZmFsc2UgKTtcclxuXHJcbiAgICAvLyBEZXRlcm1pbmUgdGhlIGdlbmUgdGhhdCBpcyBiZWluZyB0cmFuc2NyaWJlZC5cclxuICAgIGNvbnN0IGdlbmVUb1RyYW5zY3JpYmUgPSBiaW9tb2xlY3VsZS5nZXRNb2RlbCgpLmdldERuYU1vbGVjdWxlKCkuZ2V0R2VuZUF0UG9zaXRpb24oIGJpb21vbGVjdWxlLmdldFBvc2l0aW9uKCkgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGdlbmVUb1RyYW5zY3JpYmUgIT09IG51bGwgKTtcclxuXHJcbiAgICAvLyBTZXQgdXAgdGhlIG1vdGlvbiBzdHJhdGVneSB0byBtb3ZlIHRvIHRoZSBlbmQgb2YgdGhlIHRyYW5zY3JpYmVkIHJlZ2lvbiBvZiB0aGUgZ2VuZS5cclxuICAgIHRoaXMuZW5kT2ZHZW5lID0gbmV3IFZlY3RvcjIoIGdlbmVUb1RyYW5zY3JpYmUuZ2V0RW5kWCgpLCBHRUVDb25zdGFudHMuRE5BX01PTEVDVUxFX1lfUE9TICk7XHJcblxyXG4gICAgYXNtLmJpb21vbGVjdWxlLnNldE1vdGlvblN0cmF0ZWd5KCBuZXcgTW92ZURpcmVjdGx5VG9EZXN0aW5hdGlvbk1vdGlvblN0cmF0ZWd5KFxyXG4gICAgICBuZXcgUHJvcGVydHkoIHRoaXMuZW5kT2ZHZW5lLmNvcHkoKSApLFxyXG4gICAgICBiaW9tb2xlY3VsZS5tb3Rpb25Cb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgbmV3IFZlY3RvcjIoIDAsIDAgKSxcclxuICAgICAgR0VFQ29uc3RhbnRzLlRSQU5TQ1JJUFRJT05fU1BFRURcclxuICAgICkgKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgdGhlIG1STkEgdGhhdCB3aWxsIGJlIGdyb3duIGFzIGEgcmVzdWx0IG9mIHRoaXMgdHJhbnNjcmlwdGlvbi5cclxuICAgIHRoaXMubWVzc2VuZ2VyUm5hID0gbmV3IE1lc3NlbmdlclJuYShcclxuICAgICAgYmlvbW9sZWN1bGUuZ2V0TW9kZWwoKSxcclxuICAgICAgZ2VuZVRvVHJhbnNjcmliZS5nZXRQcm90ZWluUHJvdG90eXBlKCksXHJcbiAgICAgIGJpb21vbGVjdWxlLmdldFBvc2l0aW9uKCkucGx1cyggYmlvbW9sZWN1bGUubWVzc2VuZ2VyUm5hR2VuZXJhdGlvbk9mZnNldCApLFxyXG4gICAgICB7IHdpbmRpbmdQYXJhbVNldDogZ2VuZVRvVHJhbnNjcmliZS53aW5kaW5nQWxnb3JpdGhtUGFyYW1ldGVyU2V0IH1cclxuICAgICk7XHJcbiAgICBiaW9tb2xlY3VsZS5zcGF3bk1lc3NlbmdlclJuYSggdGhpcy5tZXNzZW5nZXJSbmEgKTtcclxuICAgIHRoaXMubWVzc2VuZ2VyUm5hLm1vdmFibGVCeVVzZXJQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcblxyXG4gICAgLy8gRnJlZSB1cCB0aGUgaW5pdGlhbCBhdHRhY2htZW50IHNpdGUgYnkgaG9va2luZyB1cCB0byBhIHNvbWV3aGF0IGZpY3Rpb25hbCBhdHRhY2htZW50IHNpdGUgaW5zdGVhZC5cclxuICAgIGF0dGFjaG1lbnRTaXRlLmF0dGFjaGVkT3JBdHRhY2hpbmdNb2xlY3VsZVByb3BlcnR5LnNldCggbnVsbCApO1xyXG4gICAgdHJhbnNjcmliaW5nQXR0YWNobWVudFNpdGUuYXR0YWNoZWRPckF0dGFjaGluZ01vbGVjdWxlUHJvcGVydHkuc2V0KCBhc20uYmlvbW9sZWN1bGUgKTtcclxuICAgIHRoaXMucm5hUG9seW1lcmFzZUF0dGFjaG1lbnRTdGF0ZU1hY2hpbmUuYXR0YWNobWVudFNpdGUgPSB0cmFuc2NyaWJpbmdBdHRhY2htZW50U2l0ZTtcclxuICB9XHJcbn1cclxuXHJcbmdlbmVFeHByZXNzaW9uRXNzZW50aWFscy5yZWdpc3RlciggJ0F0dGFjaGVkQW5kVHJhbnNjcmliaW5nU3RhdGUnLCBBdHRhY2hlZEFuZFRyYW5zY3JpYmluZ1N0YXRlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBBdHRhY2hlZEFuZFRyYW5zY3JpYmluZ1N0YXRlO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsUUFBUSxNQUFNLG9DQUFvQztBQUN6RCxPQUFPQyxPQUFPLE1BQU0sa0NBQWtDO0FBQ3RELE9BQU9DLHdCQUF3QixNQUFNLHNDQUFzQztBQUMzRSxPQUFPQyxZQUFZLE1BQU0sdUJBQXVCO0FBQ2hELE9BQU9DLFlBQVksTUFBTSxvQkFBb0I7QUFDN0MsT0FBT0MsdUNBQXVDLE1BQU0saUVBQWlFO0FBQ3JILE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7O0FBRWxEO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLENBQUM7O0FBRWpDO0FBQ0EsTUFBTUMsd0NBQXdDLEdBQUcsUUFBUTtBQUV6RCxNQUFNQyw0QkFBNEIsU0FBU0gsZUFBZSxDQUFDO0VBRXpEO0FBQ0Y7QUFDQTtFQUNFSSxXQUFXQSxDQUFFQyxtQ0FBbUMsRUFBRztJQUNqRCxLQUFLLENBQUMsQ0FBQzs7SUFFUDtJQUNBLElBQUksQ0FBQ0EsbUNBQW1DLEdBQUdBLG1DQUFtQzs7SUFFOUU7SUFDQSxJQUFJLENBQUNDLFNBQVMsR0FBRyxJQUFJO0lBQ3JCLElBQUksQ0FBQ0MsWUFBWSxHQUFHLElBQUk7RUFDMUI7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VDLElBQUlBLENBQUVDLEdBQUcsRUFBRUMsRUFBRSxFQUFHO0lBQ2QsTUFBTUMsYUFBYSxHQUFHLElBQUksQ0FBQ04sbUNBQW1DLENBQUNNLGFBQWE7SUFDNUUsTUFBTUMs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