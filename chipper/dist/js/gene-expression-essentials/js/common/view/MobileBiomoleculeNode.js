// Copyright 2015-2022, University of Colorado Boulder

/**
 * Base class for displaying and interacting with mobile biomolecules. In essence, this observes the shape of the
 * biomolecule, which changes as it moves.
 *
 * @author Sharfudeen Ashraf
 * @author John Blanco
 * @author Aadish Gupta
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import { Shape } from '../../../../kite/js/imports.js';
import merge from '../../../../phet-core/js/merge.js';
import ModelViewTransform2 from '../../../../phetcommon/js/view/ModelViewTransform2.js';
import { Color, Node, Path } from '../../../../scenery/js/imports.js';
import geneExpressionEssentials from '../../geneExpressionEssentials.js';
import RnaPolymerase from '../model/RnaPolymerase.js';
import GradientUtils from '../util/GradientUtils.js';
import BiomoleculeDragHandler from './BiomoleculeDragHandler.js';
class MobileBiomoleculeNode extends Node {
  /**
   * @param {ModelViewTransform2} modelViewTransform
   * @param {MobileBiomolecule} mobileBiomolecule
   * @param {Object} [options]
   */
  constructor(modelViewTransform, mobileBiomolecule, options) {
    super({
      cursor: 'pointer'
    });
    options = merge({
      lineWidth: 1
    }, options);

    // @protected (read-only) {ModelViewTransform2} - scale-only transform for scaling the shape without translation
    this.scaleOnlyModelViewTransform = ModelViewTransform2.createSinglePointScaleInvertedYMapping(Vector2.ZERO, Vector2.ZERO, modelViewTransform.getMatrix().getScaleVector().x);

    // @protected {Path} - main path that represents the biomolecule
    this.shapeNode = new Path(new Shape(), {
      stroke: Color.BLACK,
      lineWidth: options.lineWidth,
      lineJoin: 'round'
    });
    this.addChild(this.shapeNode);

    // update the shape whenever it changes
    const handleShapeChanged = shape => {
      // update the shape
      this.shapeNode.shape = null;
      const transformedShape = this.scaleOnlyModelViewTransform.modelToViewShape(shape);
      this.shapeNode.setShape(transformedShape);
      this.mouseArea = transformedShape.bounds.dilated(2);
      this.touchArea = transformedShape.bounds.dilated(5);
    };
    mobileBiomolecule.shapeProperty.link(handleShapeChanged);

    // update this node's position when the corresponding model element moves
    const handlePositionChanged = position => {
      this.setTranslation(modelViewTransform.modelToViewPosition(position));
    };
    mobileBiomolecule.positionProperty.link(handlePositionChanged);
    const handleColorChanged = color => {
      // see the comment above on gradientPaint
      if (this.shapeNode.shape.bounds.isFinite()) {
        this.shapeNode.fill = GradientUtils.createGradientPaint(this.shapeNode.shape, color);
      }
    };

    // Update the color whenever it changes.
    mobileBiomolecule.colorProperty.link(handleColorChanged);
    const handleExistenceStrengthChanged = existenceStrength => {
      assert && assert(existenceStrength >= 0 && existenceStrength <= 1); // Bounds checking.
      this.setOpacity(Math.min(Number(existenceStrength), 1 + mobileBiomolecule.zPositionProperty.get()));
    };

    // Update its existence strength (i.e. fade level) whenever it changes.
    mobileBiomolecule.existenceStrengthProperty.link(handleExistenceStrengthChanged);
    const handleZPositionChanged = zPosition => {
      assert && assert(zPosition >= -1 && zPosition <= 0); // Parameter checking.

      // The further back the biomolecule is, the more transparent it is in order to make it look more distant.
      this.setOpacity(Math.min(1 + zPosition, mobileBiomolecule.existenceStrengthProperty.get()));

      // Also, as it goes further back, this node is scaled down a bit, also to make it look further away.
      this.setScaleMagnitude(1);
      this.setScaleMagnitude(1 + 0.15 * zPosition);
    };

    // Update the "closeness" whenever it changes.
    mobileBiomolecule.zPositionProperty.link(handleZPositionChanged);
    const handleAttachedToDnaChanged = attachedToDna => {
      if (mobileBiomolecule instanceof RnaPolymerase && attachedToDna) {
        this.moveToBack();
      }
    };

    // If a polymerase molecule attaches to the DNA strand, move it to the back of its current layer so that nothing can
    // go between it and the DNA molecule. Otherwise odd-looking things can happen.
    mobileBiomolecule.attachedToDnaProperty.link(handleAttachedToDnaChanged);

    // @public (read-only) {DragListener} - drag handling
    this.dragHandler = new BiomoleculeDragHandler(mobileBiomolecule, modelViewTransform);
    this.addInputListener(this.dragHandler);
    const handleMovableByUserChanged = movableByUser => {
      this.setPickable(movableByUser);
    };

    // interactivity control
    mobileBiomolecule.movableByUserProperty.link(handleMovableByUserChanged);
    const handleUserControlledChanged = userControlled => {
      this.moveToFront();
    };

    // Move this biomolecule to the top of its layer when grabbed.
    mobileBiomolecule.userControlledProperty.link(handleUserControlledChanged);
    this.disposeMobileBiomoleculeNode = () => {
      mobileBiomolecule.positionProperty.unlink(handlePositionChanged);
      mobileBiomolecule.shapeProperty.unlink(handleShapeChanged);
      mobileBiomolecule.colorProperty.unlink(handleColorChanged);
      mobileBiomolecule.existenceStrengthProperty.unlink(handleExistenceStrengthChanged);
      mobileBiomolecule.zPositionProperty.unlink(handleZPositionChanged);
      mobileBiomolecule.attachedToDnaProperty.unlink(handleAttachedToDnaChanged);
      this.removeInputListener(this.dragHandler);
      this.dragHandler.dispose();
      mobileBiomolecule.movableByUserProperty.unlink(handleMovableByUserChanged);
      mobileBiomolecule.userControlledProperty.unlink(handleUserControlledChanged);
      this.shapeNode.shape = null;
      this.shapeNode.dispose();
    };
  }

  /**
   * @public
   */
  dispose() {
    this.disposeMobileBiomoleculeNode();
    super.dispose();
  }
}
geneExpressionEssentials.register('MobileBiomoleculeNode', MobileBiomoleculeNode);
export default MobileBiomoleculeNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwiU2hhcGUiLCJtZXJnZSIsIk1vZGVsVmlld1RyYW5zZm9ybTIiLCJDb2xvciIsIk5vZGUiLCJQYXRoIiwiZ2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzIiwiUm5hUG9seW1lcmFzZSIsIkdyYWRpZW50VXRpbHMiLCJCaW9tb2xlY3VsZURyYWdIYW5kbGVyIiwiTW9iaWxlQmlvbW9sZWN1bGVOb2RlIiwiY29uc3RydWN0b3IiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJtb2JpbGVCaW9tb2xlY3VsZSIsIm9wdGlvbnMiLCJjdXJzb3IiLCJsaW5lV2lkdGgiLCJzY2FsZU9ubHlNb2RlbFZpZXdUcmFuc2Zvcm0iLCJjcmVhdGVTaW5nbGVQb2ludFNjYWxlSW52ZXJ0ZWRZTWFwcGluZyIsIlpFUk8iLCJnZXRNYXRyaXgiLCJnZXRTY2FsZVZlY3RvciIsIngiLCJzaGFwZU5vZGUiLCJzdHJva2UiLCJCTEFDSyIsImxpbmVKb2luIiwiYWRkQ2hpbGQiLCJoYW5kbGVTaGFwZUNoYW5nZWQiLCJzaGFwZSIsInRyYW5zZm9ybWVkU2hhcGUiLCJtb2RlbFRvVmlld1NoYXBlIiwic2V0U2hhcGUiLCJtb3VzZUFyZWEiLCJib3VuZHMiLCJkaWxhdGVkIiwidG91Y2hBcmVhIiwic2hhcGVQcm9wZXJ0eSIsImxpbmsiLCJoYW5kbGVQb3NpdGlvbkNoYW5nZWQiLCJwb3NpdGlvbiIsInNldFRyYW5zbGF0aW9uIiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsInBvc2l0aW9uUHJvcGVydHkiLCJoYW5kbGVDb2xvckNoYW5nZWQiLCJjb2xvciIsImlzRmluaXRlIiwiZmlsbCIsImNyZWF0ZUdyYWRpZW50UGFpbnQiLCJjb2xvclByb3BlcnR5IiwiaGFuZGxlRXhpc3RlbmNlU3RyZW5ndGhDaGFuZ2VkIiwiZXhpc3RlbmNlU3RyZW5ndGgiLCJhc3NlcnQiLCJzZXRPcGFjaXR5IiwiTWF0aCIsIm1pbiIsIk51bWJlciIsInpQb3NpdGlvblByb3BlcnR5IiwiZ2V0IiwiZXhpc3RlbmNlU3RyZW5ndGhQcm9wZXJ0eSIsImhhbmRsZVpQb3NpdGlvbkNoYW5nZWQiLCJ6UG9zaXRpb24iLCJzZXRTY2FsZU1hZ25pdHVkZSIsImhhbmRsZUF0dGFjaGVkVG9EbmFDaGFuZ2VkIiwiYXR0YWNoZWRUb0RuYSIsIm1vdmVUb0JhY2siLCJhdHRhY2hlZFRvRG5hUHJvcGVydHkiLCJkcmFnSGFuZGxlciIsImFkZElucHV0TGlzdGVuZXIiLCJoYW5kbGVNb3ZhYmxlQnlVc2VyQ2hhbmdlZCIsIm1vdmFibGVCeVVzZXIiLCJzZXRQaWNrYWJsZSIsIm1vdmFibGVCeVVzZXJQcm9wZXJ0eSIsImhhbmRsZVVzZXJDb250cm9sbGVkQ2hhbmdlZCIsInVzZXJDb250cm9sbGVkIiwibW92ZVRvRnJvbnQiLCJ1c2VyQ29udHJvbGxlZFByb3BlcnR5IiwiZGlzcG9zZU1vYmlsZUJpb21vbGVjdWxlTm9kZSIsInVubGluayIsInJlbW92ZUlucHV0TGlzdGVuZXIiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNb2JpbGVCaW9tb2xlY3VsZU5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTUtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQmFzZSBjbGFzcyBmb3IgZGlzcGxheWluZyBhbmQgaW50ZXJhY3Rpbmcgd2l0aCBtb2JpbGUgYmlvbW9sZWN1bGVzLiBJbiBlc3NlbmNlLCB0aGlzIG9ic2VydmVzIHRoZSBzaGFwZSBvZiB0aGVcclxuICogYmlvbW9sZWN1bGUsIHdoaWNoIGNoYW5nZXMgYXMgaXQgbW92ZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2hhcmZ1ZGVlbiBBc2hyYWZcclxuICogQGF1dGhvciBKb2huIEJsYW5jb1xyXG4gKiBAYXV0aG9yIEFhZGlzaCBHdXB0YVxyXG4gKi9cclxuXHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHsgU2hhcGUgfSBmcm9tICcuLi8uLi8uLi8uLi9raXRlL2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IE1vZGVsVmlld1RyYW5zZm9ybTIgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy92aWV3L01vZGVsVmlld1RyYW5zZm9ybTIuanMnO1xyXG5pbXBvcnQgeyBDb2xvciwgTm9kZSwgUGF0aCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBnZW5lRXhwcmVzc2lvbkVzc2VudGlhbHMgZnJvbSAnLi4vLi4vZ2VuZUV4cHJlc3Npb25Fc3NlbnRpYWxzLmpzJztcclxuaW1wb3J0IFJuYVBvbHltZXJhc2UgZnJvbSAnLi4vbW9kZWwvUm5hUG9seW1lcmFzZS5qcyc7XHJcbmltcG9ydCBHcmFkaWVudFV0aWxzIGZyb20gJy4uL3V0aWwvR3JhZGllbnRVdGlscy5qcyc7XHJcbmltcG9ydCBCaW9tb2xlY3VsZURyYWdIYW5kbGVyIGZyb20gJy4vQmlvbW9sZWN1bGVEcmFnSGFuZGxlci5qcyc7XHJcblxyXG5jbGFzcyBNb2JpbGVCaW9tb2xlY3VsZU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm1cclxuICAgKiBAcGFyYW0ge01vYmlsZUJpb21vbGVjdWxlfSBtb2JpbGVCaW9tb2xlY3VsZVxyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc11cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggbW9kZWxWaWV3VHJhbnNmb3JtLCBtb2JpbGVCaW9tb2xlY3VsZSwgb3B0aW9ucyApIHtcclxuICAgIHN1cGVyKCB7IGN1cnNvcjogJ3BvaW50ZXInIH0gKTtcclxuICAgIG9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBsaW5lV2lkdGg6IDFcclxuICAgIH0sIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBAcHJvdGVjdGVkIChyZWFkLW9ubHkpIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSAtIHNjYWxlLW9ubHkgdHJhbnNmb3JtIGZvciBzY2FsaW5nIHRoZSBzaGFwZSB3aXRob3V0IHRyYW5zbGF0aW9uXHJcbiAgICB0aGlzLnNjYWxlT25seU1vZGVsVmlld1RyYW5zZm9ybSA9IE1vZGVsVmlld1RyYW5zZm9ybTIuY3JlYXRlU2luZ2xlUG9pbnRTY2FsZUludmVydGVkWU1hcHBpbmcoXHJcbiAgICAgIFZlY3RvcjIuWkVSTyxcclxuICAgICAgVmVjdG9yMi5aRVJPLFxyXG4gICAgICBtb2RlbFZpZXdUcmFuc2Zvcm0uZ2V0TWF0cml4KCkuZ2V0U2NhbGVWZWN0b3IoKS54XHJcbiAgICApO1xyXG5cclxuICAgIC8vIEBwcm90ZWN0ZWQge1BhdGh9IC0gbWFpbiBwYXRoIHRoYXQgcmVwcmVzZW50cyB0aGUgYmlvbW9sZWN1bGVcclxuICAgIHRoaXMuc2hhcGVOb2RlID0gbmV3IFBhdGgoIG5ldyBTaGFwZSgpLCB7XHJcbiAgICAgIHN0cm9rZTogQ29sb3IuQkxBQ0ssXHJcbiAgICAgIGxpbmVXaWR0aDogb3B0aW9ucy5saW5lV2lkdGgsXHJcbiAgICAgIGxpbmVKb2luOiAncm91bmQnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5zaGFwZU5vZGUgKTtcclxuXHJcbiAgICAvLyB1cGRhdGUgdGhlIHNoYXBlIHdoZW5ldmVyIGl0IGNoYW5nZXNcclxuICAgIGNvbnN0IGhhbmRsZVNoYXBlQ2hhbmdlZCA9IHNoYXBlID0+IHtcclxuXHJcbiAgICAgIC8vIHVwZGF0ZSB0aGUgc2hhcGVcclxuICAgICAgdGhpcy5zaGFwZU5vZGUuc2hhcGUgPSBudWxsO1xyXG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZFNoYXBlID0gdGhpcy5zY2FsZU9ubHlNb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdTaGFwZSggc2hhcGUgKTtcclxuICAgICAgdGhpcy5zaGFwZU5vZGUuc2V0U2hhcGUoIHRyYW5zZm9ybWVkU2hhcGUgKTtcclxuICAgICAgdGhpcy5tb3VzZUFyZWEgPSB0cmFuc2Zvcm1lZFNoYXBlLmJvdW5kcy5kaWxhdGVkKCAyICk7XHJcbiAgICAgIHRoaXMudG91Y2hBcmVhID0gdHJhbnNmb3JtZWRTaGFwZS5ib3VuZHMuZGlsYXRlZCggNSApO1xyXG4gICAgfTtcclxuXHJcbiAgICBtb2JpbGVCaW9tb2xlY3VsZS5zaGFwZVByb3BlcnR5LmxpbmsoIGhhbmRsZVNoYXBlQ2hhbmdlZCApO1xyXG5cclxuICAgIC8vIHVwZGF0ZSB0aGlzIG5vZGUncyBwb3NpdGlvbiB3aGVuIHRoZSBjb3JyZXNwb25kaW5nIG1vZGVsIGVsZW1lbnQgbW92ZXNcclxuICAgIGNvbnN0IGhhbmRsZVBvc2l0aW9uQ2hhbmdlZCA9IHBvc2l0aW9uID0+IHtcclxuICAgICAgdGhpcy5zZXRUcmFuc2xhdGlvbiggbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIHBvc2l0aW9uICkgKTtcclxuICAgIH07XHJcblxyXG4gICAgbW9iaWxlQmlvbW9sZWN1bGUucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCBoYW5kbGVQb3NpdGlvbkNoYW5nZWQgKTtcclxuXHJcbiAgICBjb25zdCBoYW5kbGVDb2xvckNoYW5nZWQgPSBjb2xvciA9PiB7XHJcblxyXG4gICAgICAvLyBzZWUgdGhlIGNvbW1lbnQgYWJvdmUgb24gZ3JhZGllbnRQYWludFxyXG4gICAgICBpZiAoIHRoaXMuc2hhcGVOb2RlLnNoYXBlLmJvdW5kcy5pc0Zpbml0ZSgpICkge1xyXG4gICAgICAgIHRoaXMuc2hhcGVOb2RlLmZpbGwgPSBHcmFkaWVudFV0aWxzLmNyZWF0ZUdyYWRpZW50UGFpbnQoIHRoaXMuc2hhcGVOb2RlLnNoYXBlLCBjb2xvciApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgY29sb3Igd2hlbmV2ZXIgaXQgY2hhbmdlcy5cclxuICAgIG1vYmlsZUJpb21vbGVjdWxlLmNvbG9yUHJvcGVydHkubGluayggaGFuZGxlQ29sb3JDaGFuZ2VkICk7XHJcblxyXG4gICAgY29uc3QgaGFuZGxlRXhpc3RlbmNlU3RyZW5ndGhDaGFuZ2VkID0gZXhpc3RlbmNlU3RyZW5ndGggPT4ge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBleGlzdGVuY2VTdHJlbmd0aCA+PSAwICYmIGV4aXN0ZW5jZVN0cmVuZ3RoIDw9IDEgKTsgLy8gQm91bmRzIGNoZWNraW5nLlxyXG4gICAgICB0aGlzLnNldE9wYWNpdHkoIE1hdGgubWluKCBOdW1iZXIoIGV4aXN0ZW5jZVN0cmVuZ3RoICksIDEgKyBtb2JpbGVCaW9tb2xlY3VsZS56UG9zaXRpb25Qcm9wZXJ0eS5nZXQoKSApICk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFVwZGF0ZSBpdHMgZXhpc3RlbmNlIHN0cmVuZ3RoIChpLmUuIGZhZGUgbGV2ZWwpIHdoZW5ldmVyIGl0IGNoYW5nZXMuXHJcbiAgICBtb2JpbGVCaW9tb2xlY3VsZS5leGlzdGVuY2VTdHJlbmd0aFByb3BlcnR5LmxpbmsoIGhhbmRsZUV4aXN0ZW5jZVN0cmVuZ3RoQ2hhbmdlZCApO1xyXG5cclxuICAgIGNvbnN0IGhhbmRsZVpQb3NpdGlvbkNoYW5nZWQgPSB6UG9zaXRpb24gPT4ge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB6UG9zaXRpb24gPj0gLTEgJiYgelBvc2l0aW9uIDw9IDAgKTsgLy8gUGFyYW1ldGVyIGNoZWNraW5nLlxyXG5cclxuICAgICAgLy8gVGhlIGZ1cnRoZXIgYmFjayB0aGUgYmlvbW9sZWN1bGUgaXMsIHRoZSBtb3JlIHRyYW5zcGFyZW50IGl0IGlzIGluIG9yZGVyIHRvIG1ha2UgaXQgbG9vayBtb3JlIGRpc3RhbnQuXHJcbiAgICAgIHRoaXMuc2V0T3BhY2l0eSggTWF0aC5taW4oIDEgKyB6UG9zaXRpb24sIG1vYmlsZUJpb21vbGVjdWxlLmV4aXN0ZW5jZVN0cmVuZ3RoUHJvcGVydHkuZ2V0KCkgKSApO1xyXG5cclxuICAgICAgLy8gQWxzbywgYXMgaXQgZ29lcyBmdXJ0aGVyIGJhY2ssIHRoaXMgbm9kZSBpcyBzY2FsZWQgZG93biBhIGJpdCwgYWxzbyB0byBtYWtlIGl0IGxvb2sgZnVydGhlciBhd2F5LlxyXG4gICAgICB0aGlzLnNldFNjYWxlTWFnbml0dWRlKCAxICk7XHJcbiAgICAgIHRoaXMuc2V0U2NhbGVNYWduaXR1ZGUoIDEgKyAwLjE1ICogelBvc2l0aW9uICk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgXCJjbG9zZW5lc3NcIiB3aGVuZXZlciBpdCBjaGFuZ2VzLlxyXG4gICAgbW9iaWxlQmlvbW9sZWN1bGUuelBvc2l0aW9uUHJvcGVydHkubGluayggaGFuZGxlWlBvc2l0aW9uQ2hhbmdlZCApO1xyXG5cclxuICAgIGNvbnN0IGhhbmRsZUF0dGFjaGVkVG9EbmFDaGFuZ2VkID0gYXR0YWNoZWRUb0RuYSA9PiB7XHJcbiAgICAgIGlmICggbW9iaWxlQmlvbW9sZWN1bGUgaW5zdGFuY2VvZiBSbmFQb2x5bWVyYXNlICYmIGF0dGFjaGVkVG9EbmEgKSB7XHJcbiAgICAgICAgdGhpcy5tb3ZlVG9CYWNrKCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gSWYgYSBwb2x5bWVyYXNlIG1vbGVjdWxlIGF0dGFjaGVzIHRvIHRoZSBETkEgc3RyYW5kLCBtb3ZlIGl0IHRvIHRoZSBiYWNrIG9mIGl0cyBjdXJyZW50IGxheWVyIHNvIHRoYXQgbm90aGluZyBjYW5cclxuICAgIC8vIGdvIGJldHdlZW4gaXQgYW5kIHRoZSBETkEgbW9sZWN1bGUuIE90aGVyd2lzZSBvZGQtbG9va2luZyB0aGluZ3MgY2FuIGhhcHBlbi5cclxuICAgIG1vYmlsZUJpb21vbGVjdWxlLmF0dGFjaGVkVG9EbmFQcm9wZXJ0eS5saW5rKCBoYW5kbGVBdHRhY2hlZFRvRG5hQ2hhbmdlZCApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkge0RyYWdMaXN0ZW5lcn0gLSBkcmFnIGhhbmRsaW5nXHJcbiAgICB0aGlzLmRyYWdIYW5kbGVyID0gbmV3IEJpb21vbGVjdWxlRHJhZ0hhbmRsZXIoIG1vYmlsZUJpb21vbGVjdWxlLCBtb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggdGhpcy5kcmFnSGFuZGxlciApO1xyXG5cclxuICAgIGNvbnN0IGhhbmRsZU1vdmFibGVCeVVzZXJDaGFuZ2VkID0gbW92YWJsZUJ5VXNlciA9PiB7XHJcbiAgICAgIHRoaXMuc2V0UGlja2FibGUoIG1vdmFibGVCeVVzZXIgKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gaW50ZXJhY3Rpdml0eSBjb250cm9sXHJcbiAgICBtb2JpbGVCaW9tb2xlY3VsZS5tb3ZhYmxlQnlVc2VyUHJvcGVydHkubGluayggaGFuZGxlTW92YWJsZUJ5VXNlckNoYW5nZWQgKTtcclxuXHJcbiAgICBjb25zdCBoYW5kbGVVc2VyQ29udHJvbGxlZENoYW5nZWQgPSB1c2VyQ29udHJvbGxlZCA9PiB7XHJcbiAgICAgIHRoaXMubW92ZVRvRnJvbnQoKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gTW92ZSB0aGlzIGJpb21vbGVjdWxlIHRvIHRoZSB0b3Agb2YgaXRzIGxheWVyIHdoZW4gZ3JhYmJlZC5cclxuICAgIG1vYmlsZUJpb21vbGVjdWxlLnVzZXJDb250cm9sbGVkUHJvcGVydHkubGluayggaGFuZGxlVXNlckNvbnRyb2xsZWRDaGFuZ2VkICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlTW9iaWxlQmlvbW9sZWN1bGVOb2RlID0gKCkgPT4ge1xyXG4gICAgICBtb2JpbGVCaW9tb2xlY3VsZS5wb3NpdGlvblByb3BlcnR5LnVubGluayggaGFuZGxlUG9zaXRpb25DaGFuZ2VkICk7XHJcbiAgICAgIG1vYmlsZUJpb21vbGVjdWxlLnNoYXBlUHJvcGVydHkudW5saW5rKCBoYW5kbGVTaGFwZUNoYW5nZWQgKTtcclxuICAgICAgbW9iaWxlQmlvbW9sZWN1bGUuY29sb3JQcm9wZXJ0eS51bmxpbmsoIGhhbmRsZUNvbG9yQ2hhbmdlZCApO1xyXG4gICAgICBtb2JpbGVCaW9tb2xlY3VsZS5leGlzdGVuY2VTdHJlbmd0aFByb3BlcnR5LnVubGluayggaGFuZGxlRXhpc3RlbmNlU3RyZW5ndGhDaGFuZ2VkICk7XHJcbiAgICAgIG1vYmlsZUJpb21vbGVjdWxlLnpQb3NpdGlvblByb3BlcnR5LnVubGluayggaGFuZGxlWlBvc2l0aW9uQ2hhbmdlZCApO1xyXG4gICAgICBtb2JpbGVCaW9tb2xlY3VsZS5hdHRhY2hlZFRvRG5hUHJvcGVydHkudW5saW5rKCBoYW5kbGVBdHRhY2hlZFRvRG5hQ2hhbmdlZCApO1xyXG4gICAgICB0aGlzLnJlbW92ZUlucHV0TGlzdGVuZXIoIHRoaXMuZHJhZ0hhbmRsZXIgKTtcclxuICAgICAgdGhpcy5kcmFnSGFuZGxlci5kaXNwb3NlKCk7XHJcbiAgICAgIG1vYmlsZUJpb21vbGVjdWxlLm1vdmFibGVCeVVzZXJQcm9wZXJ0eS51bmxpbmsoIGhhbmRsZU1vdmFibGVCeVVzZXJDaGFuZ2VkICk7XHJcbiAgICAgIG1vYmlsZUJpb21vbGVjdWxlLnVzZXJDb250cm9sbGVkUHJvcGVydHkudW5saW5rKCBoYW5kbGVVc2VyQ29udHJvbGxlZENoYW5nZWQgKTtcclxuICAgICAgdGhpcy5zaGFwZU5vZGUuc2hhcGUgPSBudWxsO1xyXG4gICAgICB0aGlzLnNoYXBlTm9kZS5kaXNwb3NlKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLmRpc3Bvc2VNb2JpbGVCaW9tb2xlY3VsZU5vZGUoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmdlbmVFeHByZXNzaW9uRXNzZW50aWFscy5yZWdpc3RlciggJ01vYmlsZUJpb21vbGVjdWxlTm9kZScsIE1vYmlsZUJpb21vbGVjdWxlTm9kZSApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgTW9iaWxlQmlvbW9sZWN1bGVOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELFNBQVNDLEtBQUssUUFBUSxnQ0FBZ0M7QUFDdEQsT0FBT0MsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxtQkFBbUIsTUFBTSx1REFBdUQ7QUFDdkYsU0FBU0MsS0FBSyxFQUFFQyxJQUFJLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDckUsT0FBT0Msd0JBQXdCLE1BQU0sbUNBQW1DO0FBQ3hFLE9BQU9DLGFBQWEsTUFBTSwyQkFBMkI7QUFDckQsT0FBT0MsYUFBYSxNQUFNLDBCQUEwQjtBQUNwRCxPQUFPQyxzQkFBc0IsTUFBTSw2QkFBNkI7QUFFaEUsTUFBTUMscUJBQXFCLFNBQVNOLElBQUksQ0FBQztFQUV2QztBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ0VPLFdBQVdBLENBQUVDLGtCQUFrQixFQUFFQyxpQkFBaUIsRUFBRUMsT0FBTyxFQUFHO0lBQzVELEtBQUssQ0FBRTtNQUFFQyxNQUFNLEVBQUU7SUFBVSxDQUFFLENBQUM7SUFDOUJELE9BQU8sR0FBR2IsS0FBSyxDQUFFO01BQ2ZlLFNBQVMsRUFBRTtJQUNiLENBQUMsRUFBRUYsT0FBUSxDQUFDOztJQUVaO0lBQ0EsSUFBSSxDQUFDRywyQkFBMkIsR0FBR2YsbUJBQW1CLENBQUNnQixzQ0FBc0MsQ0FDM0ZuQixPQUFPLENBQUNvQixJQUFJLEVBQ1pwQixPQUFPLENBQUNvQixJQUFJLEVBQ1pQLGtCQUFrQixDQUFDUSxTQUFTLENBQUMsQ0FBQyxDQUFDQyxjQUFjLENBQUMsQ0FBQyxDQUFDQyxDQUNsRCxDQUFDOztJQUVEO0lBQ0EsSUFBSSxDQUFDQyxTQUFTLEdBQUcsSUFBSWxCLElBQUksQ0FBRSxJQUFJTCxLQUFLLENBQUMsQ0FBQyxFQUFFO01BQ3RDd0IsTUFBTSxFQUFFckIsS0FBSyxDQUFDc0IsS0FBSztNQUNuQlQsU0FBUyxFQUFFRixPQUFPLENBQUNFLFNBQVM7TUFDNUJVLFFBQVEsRUFBRTtJQUNaLENBQUUsQ0FBQztJQUVILElBQUksQ0FBQ0MsUUFBUSxDQUFFLElBQUksQ0FBQ0osU0FBVSxDQUFDOztJQUUvQjtJQUNBLE1BQU1LLGtCQUFrQixHQUFHQyxLQUFLLElBQUk7TUFFbEM7TUFDQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ00sS0FBSyxHQUFHLElBQUk7TUFDM0IsTUFBTUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDYiwyQkFBMkIsQ0FBQ2MsZ0JBQWdCLENBQUVGLEtBQU0sQ0FBQztNQUNuRixJQUFJLENBQUNOLFNBQVMsQ0FBQ1MsUUFBUSxDQUFFRixnQkFBaUIsQ0FBQztNQUMzQyxJQUFJLENBQUNHLFNBQVMsR0FBR0gsZ0JBQWdCLENBQUNJLE1BQU0sQ0FBQ0MsT0FBTyxDQUFFLENBQUUsQ0FBQztNQUNyRCxJQUFJLENBQUNDLFNBQVMsR0FBR04sZ0JBQWdCLENBQUNJLE1BQU0sQ0FBQ0MsT0FBTyxDQUFFLENBQUUsQ0FBQztJQUN2RCxDQUFDO0lBRUR0QixpQkFBaUIsQ0FBQ3dCLGFBQWEsQ0FBQ0MsSUFBSSxDQUFFVixrQkFBbUIsQ0FBQzs7SUFFMUQ7SUFDQSxNQUFNVyxxQkFBcUIsR0FBR0MsUUFBUSxJQUFJO01BQ3hDLElBQUksQ0FBQ0MsY0FBYyxDQUFFN0Isa0JBQWtCLENBQUM4QixtQkFBbUIsQ0FBRUYsUUFBUyxDQUFFLENBQUM7SUFDM0UsQ0FBQztJQUVEM0IsaUJBQWlCLENBQUM4QixnQkFBZ0IsQ0FBQ0wsSUFBSSxDQUFFQyxxQkFBc0IsQ0FBQztJQUVoRSxNQUFNSyxrQkFBa0IsR0FBR0MsS0FBSyxJQUFJO01BRWxDO01BQ0EsSUFBSyxJQUFJLENBQUN0QixTQUFTLENBQUNNLEtBQUssQ0FBQ0ssTUFBTSxDQUFDWSxRQUFRLENBQUMsQ0FBQyxFQUFHO1FBQzVDLElBQUksQ0FBQ3ZCLFNBQVMsQ0FBQ3dCLElBQUksR0FBR3ZDLGFBQWEsQ0FBQ3dDLG1CQUFtQixDQUFFLElBQUksQ0FBQ3pCLFNBQVMsQ0FBQ00sS0FBSyxFQUFFZ0IsS0FBTSxDQUFDO01BQ3hGO0lBQ0YsQ0FBQzs7SUFFRDtJQUNBaEMsaUJBQWlCLENBQUNvQyxhQUFhLENBQUNYLElBQUksQ0FBRU0sa0JBQW1CLENBQUM7SUFFMUQsTUFBTU0sOEJBQThCLEdBQUdDLGlCQUFpQixJQUFJO01BQzFEQyxNQUFNLElBQUlBLE1BQU0sQ0FBRUQsaUJBQWlCLElBQUksQ0FBQyxJQUFJQSxpQkFBaUIsSUFBSSxDQUFFLENBQUMsQ0FBQyxDQUFDO01BQ3RFLElBQUksQ0FBQ0UsVUFBVSxDQUFFQyxJQUFJLENBQUNDLEdBQUcsQ0FBRUMsTUFBTSxDQUFFTCxpQkFBa0IsQ0FBQyxFQUFFLENBQUMsR0FBR3RDLGlCQUFpQixDQUFDNEMsaUJBQWlCLENBQUNDLEdBQUcsQ0FBQyxDQUFFLENBQUUsQ0FBQztJQUMzRyxDQUFDOztJQUVEO0lBQ0E3QyxpQkFBaUIsQ0FBQzhDLHlCQUF5QixDQUFDckIsSUFBSSxDQUFFWSw4QkFBK0IsQ0FBQztJQUVsRixNQUFNVSxzQkFBc0IsR0FBR0MsU0FBUyxJQUFJO01BQzFDVCxNQUFNLElBQUlBLE1BQU0sQ0FBRVMsU0FBUyxJQUFJLENBQUMsQ0FBQyxJQUFJQSxTQUFTLElBQUksQ0FBRSxDQUFDLENBQUMsQ0FBQzs7TUFFdkQ7TUFDQSxJQUFJLENBQUNSLFVBQVUsQ0FBRUMsSUFBSSxDQUFDQyxHQUFHLENBQUUsQ0FBQyxHQUFHTSxTQUFTLEVBQUVoRCxpQkFBaUIsQ0FBQzhDLHlCQUF5QixDQUFDRCxHQUFHLENBQUMsQ0FBRSxDQUFFLENBQUM7O01BRS9GO01BQ0EsSUFBSSxDQUFDSSxpQkFBaUIsQ0FBRSxDQUFFLENBQUM7TUFDM0IsSUFBSSxDQUFDQSxpQkFBaUIsQ0FBRSxDQUFDLEdBQUcsSUFBSSxHQUFHRCxTQUFVLENBQUM7SUFDaEQsQ0FBQzs7SUFFRDtJQUNBaEQsaUJBQWlCLENBQUM0QyxpQkFBaUIsQ0FBQ25CLElBQUksQ0FBRXNCLHNCQUF1QixDQUFDO0lBRWxFLE1BQU1HLDBCQUEwQixHQUFHQyxhQUFhLElBQUk7TUFDbEQsSUFBS25ELGlCQUFpQixZQUFZTixhQUFhLElBQUl5RCxhQUFhLEVBQUc7UUFDakUsSUFBSSxDQUFDQyxVQUFVLENBQUMsQ0FBQztNQUNuQjtJQUNGLENBQUM7O0lBRUQ7SUFDQTtJQUNBcEQsaUJBQWlCLENBQUNxRCxxQkFBcUIsQ0FBQzVCLElBQUksQ0FBRXlCLDBCQUEyQixDQUFDOztJQUUxRTtJQUNBLElBQUksQ0FBQ0ksV0FBVyxHQUFHLElBQUkxRCxzQkFBc0IsQ0FBRUksaUJBQWlCLEVBQUVELGtCQUFtQixDQUFDO0lBQ3RGLElBQUksQ0FBQ3dELGdCQUFnQixDQUFFLElBQUksQ0FBQ0QsV0FBWSxDQUFDO0lBRXpDLE1BQU1FLDBCQUEwQixHQUFHQyxhQUFhLElBQUk7TUFDbEQsSUFBSSxDQUFDQyxXQUFXLENBQUVELGFBQWMsQ0FBQztJQUNuQyxDQUFDOztJQUVEO0lBQ0F6RCxpQkFBaUIsQ0FBQzJELHFCQUFxQixDQUFDbEMsSUFBSSxDQUFFK0IsMEJBQTJCLENBQUM7SUFFMUUsTUFBTUksMkJBQTJCLEdBQUdDLGNBQWMsSUFBSTtNQUNwRCxJQUFJLENBQUNDLFdBQVcsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7O0lBRUQ7SUFDQTlELGlCQUFpQixDQUFDK0Qsc0JBQXNCLENBQUN0QyxJQUFJLENBQUVtQywyQkFBNEIsQ0FBQztJQUU1RSxJQUFJLENBQUNJLDRCQUE0QixHQUFHLE1BQU07TUFDeENoRSxpQkFBaUIsQ0FBQzhCLGdCQUFnQixDQUFDbUMsTUFBTSxDQUFFdkMscUJBQXNCLENBQUM7TUFDbEUxQixpQkFBaUIsQ0FBQ3dCLGFBQWEsQ0FBQ3lDLE1BQU0sQ0FBRWxELGtCQUFtQixDQUFDO01BQzVEZixpQkFBaUIsQ0FBQ29DLGFBQWEsQ0FBQzZCLE1BQU0sQ0FBRWxDLGtCQUFtQixDQUFDO01BQzVEL0IsaUJBQWlCLENBQUM4Qyx5QkFBeUIsQ0FBQ21CLE1BQU0sQ0FBRTVCLDhCQUErQixDQUFDO01BQ3BGckMsaUJBQWlCLENBQUM0QyxpQkFBaUIsQ0FBQ3FCLE1BQU0sQ0FBRWxCLHNCQUF1QixDQUFDO01BQ3BFL0MsaUJBQWlCLENBQUNxRCxxQkFBcUIsQ0FBQ1ksTUFBTSxDQUFFZiwwQkFBMkIsQ0FBQztNQUM1RSxJQUFJLENBQUNnQixtQkFBbUIsQ0FBRSxJQUFJLENBQUNaLFdBQVksQ0FBQztNQUM1QyxJQUFJLENBQUNBLFdBQVcsQ0FBQ2EsT0FBTyxDQUFDLENBQUM7TUFDMUJuRSxpQkFBaUIsQ0FBQzJELHFCQUFxQixDQUFDTSxNQUFNLENBQUVULDBCQUEyQixDQUFDO01BQzVFeEQsaUJBQWlCLENBQUMrRCxzQkFBc0IsQ0FBQ0UsTUFBTSxDQUFFTCwyQkFBNEIsQ0FBQztNQUM5RSxJQUFJLENBQUNsRCxTQUFTLENBQUNNLEtBQUssR0FBRyxJQUFJO01BQzNCLElBQUksQ0FBQ04sU0FBUyxDQUFDeUQsT0FBTyxDQUFDLENBQUM7SUFDMUIsQ0FBQztFQUNIOztFQUVBO0FBQ0Y7QUFDQTtFQUNFQSxPQUFPQSxDQUFBLEVBQUc7SUFDUixJQUFJLENBQUNILDRCQUE0QixDQUFDLENBQUM7SUFDbkMsS0FBSyxDQUFDRyxPQUFPLENBQUMsQ0FBQztFQUNqQjtBQUNGO0FBRUExRSx3QkFBd0IsQ0FBQzJFLFFBQVEsQ0FBRSx1QkFBdUIsRUFBRXZFLHFCQUFzQixDQUFDO0FBRW5GLGVBQWVBLHFCQUFxQiJ9