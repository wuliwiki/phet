// Copyright 2020-2022, University of Colorado Boulder

/**
 * PedigreeBunnyNode is the view of a bunny in the Pedigree graph. It ignores bunny motion, and displays
 * only the information that is relevant to pedigree.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../../axon/js/DerivedProperty.js';
import optionize from '../../../../../phet-core/js/optionize.js';
import PhetFont from '../../../../../scenery-phet/js/PhetFont.js';
import { Node, Text } from '../../../../../scenery/js/imports.js';
import naturalSelection from '../../../naturalSelection.js';
import NaturalSelectionConstants from '../../NaturalSelectionConstants.js';
import NaturalSelectionQueryParameters from '../../NaturalSelectionQueryParameters.js';
import BunnySelectionRectangle from '../BunnySelectionRectangle.js';
import MutationIconNode from '../MutationIconNode.js';
import OriginNode from '../OriginNode.js';

// constants
const GENOTYPE_FONT = new PhetFont(16);
const DEAD_SYMBOL_FONT = new PhetFont(20);
const UNICODE_RED_CROSS_MARK = '\u274c';
export default class PedigreeBunnyNode extends Node {
  constructor(bunny, bunnyImageMap, furAllelesVisibleProperty, earsAllelesVisibleProperty, teethAllelesVisibleProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      showMutationIcon: true,
      bunnyIsSelected: false

      // Not PhET-iO instrumented: PedigreeBunnyNode is created dynamically, and clients generally have no need to inspect them.
    }, providedOptions);
    const children = [];

    // Node that corresponds to the bunny's phenotype (appearance)
    const bunnyNode = bunnyImageMap.getNode(bunny, {
      scale: NaturalSelectionConstants.BUNNY_IMAGE_SCALE,
      centerX: 0,
      bottom: 0
    });
    children.push(bunnyNode);

    // Label original mutant with an icon
    if (bunny.isOriginalMutant()) {
      children.push(new MutationIconNode({
        right: bunnyNode.centerX,
        bottom: bunnyNode.bottom,
        pickable: false
      }));
    }

    // Update the genotype abbreviation, must be disposed
    // Not instrumented because we decided not to instrument PedigreeBunnyNode.
    const genotypeDerivedStringProperty = DerivedProperty.deriveAny([furAllelesVisibleProperty, earsAllelesVisibleProperty, teethAllelesVisibleProperty, ...bunny.genotype.getAbbreviationStringDependencies()], () => getGenotypeAbbreviation(bunny, furAllelesVisibleProperty.value, earsAllelesVisibleProperty.value, teethAllelesVisibleProperty.value));

    // Must be disposed
    const genotypeTextVisibleProperty = new DerivedProperty([furAllelesVisibleProperty, earsAllelesVisibleProperty, teethAllelesVisibleProperty], (furAllelesVisible, earsAllelesVisible, teethAllelesVisible) => furAllelesVisible || earsAllelesVisible || teethAllelesVisible);

    // Genotype abbreviation
    // Not instrumented because we decided not to instrument PedigreeBunnyNode.
    const genotypeText = new Text(genotypeDerivedStringProperty, {
      visibleProperty: genotypeTextVisibleProperty,
      font: GENOTYPE_FONT,
      maxWidth: bunnyNode.width
    });
    children.push(genotypeText);

    // Center the genotype abbreviation above the bunny.
    genotypeText.boundsProperty.link(() => {
      genotypeText.centerX = bunnyNode.centerX;
      genotypeText.top = bunnyNode.bottom + 5;
    });

    // Optional selection rectangle, prepended to children
    if (options.bunnyIsSelected) {
      children.unshift(new BunnySelectionRectangle(bunnyNode.bounds.dilated(3), {
        center: bunnyNode.center
      }));
    }
    if (NaturalSelectionQueryParameters.showOrigin) {
      children.push(new OriginNode());
    }
    options.children = children;
    super(options);

    // Label a dead bunny with a red cross mark.  This Text node does not take a string Property because it
    // displays a static symbol that is not translatable.
    const addRedCrossMark = () => {
      this.addChild(new Text(UNICODE_RED_CROSS_MARK, {
        font: DEAD_SYMBOL_FONT,
        right: bunnyNode.centerX,
        bottom: bunnyNode.centerY
      }));
    };
    if (bunny.isAlive) {
      // removeListener in dispose. Not necessary to removeListener when diedEmitter fires, because it disposes itself.
      bunny.diedEmitter.addListener(addRedCrossMark);
    } else {
      addRedCrossMark();
    }
    this.disposePedigreeBunnyNode = () => {
      genotypeDerivedStringProperty.dispose();
      genotypeTextVisibleProperty.dispose();
      if (bunny.diedEmitter.hasListener(addRedCrossMark)) {
        bunny.diedEmitter.removeListener(addRedCrossMark);
      }

      // Un-parent the bunnyNode from the shared DAG
      bunnyNode.dispose();
    };

    // If logging is enabled, pressing on a bunny logs its details to the console.
    // removeInput listener is not necessary.
    if (phet.log) {
      this.addInputListener({
        down: () => phet.log(`Pedigree press: ${bunny.toString()}`)
      });
    }
  }
  dispose() {
    this.disposePedigreeBunnyNode();
    super.dispose();
  }
}

/**
 * Gets the abbreviations that describe a Bunny's genotype, e.g. 'FfEEtt'.
 */
function getGenotypeAbbreviation(bunny, furAllelesVisible, earsAllelesVisible, teethAllelesVisible) {
  let genotypeString = '';
  if (furAllelesVisible) {
    genotypeString += bunny.genotype.furGenePair.getGenotypeAbbreviation();
  }
  if (earsAllelesVisible) {
    genotypeString += bunny.genotype.earsGenePair.getGenotypeAbbreviation();
  }
  if (teethAllelesVisible) {
    genotypeString += bunny.genotype.teethGenePair.getGenotypeAbbreviation();
  }
  return genotypeString;
}
naturalSelection.register('PedigreeBunnyNode', PedigreeBunnyNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJvcHRpb25pemUiLCJQaGV0Rm9udCIsIk5vZGUiLCJUZXh0IiwibmF0dXJhbFNlbGVjdGlvbiIsIk5hdHVyYWxTZWxlY3Rpb25Db25zdGFudHMiLCJOYXR1cmFsU2VsZWN0aW9uUXVlcnlQYXJhbWV0ZXJzIiwiQnVubnlTZWxlY3Rpb25SZWN0YW5nbGUiLCJNdXRhdGlvbkljb25Ob2RlIiwiT3JpZ2luTm9kZSIsIkdFTk9UWVBFX0ZPTlQiLCJERUFEX1NZTUJPTF9GT05UIiwiVU5JQ09ERV9SRURfQ1JPU1NfTUFSSyIsIlBlZGlncmVlQnVubnlOb2RlIiwiY29uc3RydWN0b3IiLCJidW5ueSIsImJ1bm55SW1hZ2VNYXAiLCJmdXJBbGxlbGVzVmlzaWJsZVByb3BlcnR5IiwiZWFyc0FsbGVsZXNWaXNpYmxlUHJvcGVydHkiLCJ0ZWV0aEFsbGVsZXNWaXNpYmxlUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwic2hvd011dGF0aW9uSWNvbiIsImJ1bm55SXNTZWxlY3RlZCIsImNoaWxkcmVuIiwiYnVubnlOb2RlIiwiZ2V0Tm9kZSIsInNjYWxlIiwiQlVOTllfSU1BR0VfU0NBTEUiLCJjZW50ZXJYIiwiYm90dG9tIiwicHVzaCIsImlzT3JpZ2luYWxNdXRhbnQiLCJyaWdodCIsInBpY2thYmxlIiwiZ2Vub3R5cGVEZXJpdmVkU3RyaW5nUHJvcGVydHkiLCJkZXJpdmVBbnkiLCJnZW5vdHlwZSIsImdldEFiYnJldmlhdGlvblN0cmluZ0RlcGVuZGVuY2llcyIsImdldEdlbm90eXBlQWJicmV2aWF0aW9uIiwidmFsdWUiLCJnZW5vdHlwZVRleHRWaXNpYmxlUHJvcGVydHkiLCJmdXJBbGxlbGVzVmlzaWJsZSIsImVhcnNBbGxlbGVzVmlzaWJsZSIsInRlZXRoQWxsZWxlc1Zpc2libGUiLCJnZW5vdHlwZVRleHQiLCJ2aXNpYmxlUHJvcGVydHkiLCJmb250IiwibWF4V2lkdGgiLCJ3aWR0aCIsImJvdW5kc1Byb3BlcnR5IiwibGluayIsInRvcCIsInVuc2hpZnQiLCJib3VuZHMiLCJkaWxhdGVkIiwiY2VudGVyIiwic2hvd09yaWdpbiIsImFkZFJlZENyb3NzTWFyayIsImFkZENoaWxkIiwiY2VudGVyWSIsImlzQWxpdmUiLCJkaWVkRW1pdHRlciIsImFkZExpc3RlbmVyIiwiZGlzcG9zZVBlZGlncmVlQnVubnlOb2RlIiwiZGlzcG9zZSIsImhhc0xpc3RlbmVyIiwicmVtb3ZlTGlzdGVuZXIiLCJwaGV0IiwibG9nIiwiYWRkSW5wdXRMaXN0ZW5lciIsImRvd24iLCJ0b1N0cmluZyIsImdlbm90eXBlU3RyaW5nIiwiZnVyR2VuZVBhaXIiLCJlYXJzR2VuZVBhaXIiLCJ0ZWV0aEdlbmVQYWlyIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQZWRpZ3JlZUJ1bm55Tm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBQZWRpZ3JlZUJ1bm55Tm9kZSBpcyB0aGUgdmlldyBvZiBhIGJ1bm55IGluIHRoZSBQZWRpZ3JlZSBncmFwaC4gSXQgaWdub3JlcyBidW5ueSBtb3Rpb24sIGFuZCBkaXNwbGF5c1xyXG4gKiBvbmx5IHRoZSBpbmZvcm1hdGlvbiB0aGF0IGlzIHJlbGV2YW50IHRvIHBlZGlncmVlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaGV0Rm9udCBmcm9tICcuLi8uLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldEZvbnQuanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBOb2RlT3B0aW9ucywgVGV4dCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBuYXR1cmFsU2VsZWN0aW9uIGZyb20gJy4uLy4uLy4uL25hdHVyYWxTZWxlY3Rpb24uanMnO1xyXG5pbXBvcnQgQnVubnkgZnJvbSAnLi4vLi4vbW9kZWwvQnVubnkuanMnO1xyXG5pbXBvcnQgTmF0dXJhbFNlbGVjdGlvbkNvbnN0YW50cyBmcm9tICcuLi8uLi9OYXR1cmFsU2VsZWN0aW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IE5hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vLi4vTmF0dXJhbFNlbGVjdGlvblF1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCBCdW5ueUltYWdlTWFwIGZyb20gJy4uL0J1bm55SW1hZ2VNYXAuanMnO1xyXG5pbXBvcnQgQnVubnlTZWxlY3Rpb25SZWN0YW5nbGUgZnJvbSAnLi4vQnVubnlTZWxlY3Rpb25SZWN0YW5nbGUuanMnO1xyXG5pbXBvcnQgTXV0YXRpb25JY29uTm9kZSBmcm9tICcuLi9NdXRhdGlvbkljb25Ob2RlLmpzJztcclxuaW1wb3J0IE9yaWdpbk5vZGUgZnJvbSAnLi4vT3JpZ2luTm9kZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgR0VOT1RZUEVfRk9OVCA9IG5ldyBQaGV0Rm9udCggMTYgKTtcclxuY29uc3QgREVBRF9TWU1CT0xfRk9OVCA9IG5ldyBQaGV0Rm9udCggMjAgKTtcclxuY29uc3QgVU5JQ09ERV9SRURfQ1JPU1NfTUFSSyA9ICdcXHUyNzRjJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgc2hvd011dGF0aW9uSWNvbj86IGJvb2xlYW47IC8vIHRydWUgPSBzaG93IHRoZSBtdXRhdGlvbiBpY29uIG9uIHRoZSBidW5ueVxyXG4gIGJ1bm55SXNTZWxlY3RlZD86IGJvb2xlYW47IC8vIHRydWUgPSBwdXQgYSBzZWxlY3Rpb24gaWNvbiBhcm91bmQgdGhlIGJ1bm55XHJcbn07XHJcblxyXG50eXBlIFBlZGlncmVlQnVubnlOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGVkaWdyZWVCdW5ueU5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXNwb3NlUGVkaWdyZWVCdW5ueU5vZGU6ICgpID0+IHZvaWQ7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggYnVubnk6IEJ1bm55LFxyXG4gICAgICAgICAgICAgICAgICAgICAgYnVubnlJbWFnZU1hcDogQnVubnlJbWFnZU1hcCxcclxuICAgICAgICAgICAgICAgICAgICAgIGZ1ckFsbGVsZXNWaXNpYmxlUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgZWFyc0FsbGVsZXNWaXNpYmxlUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgdGVldGhBbGxlbGVzVmlzaWJsZVByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IFBlZGlncmVlQnVubnlOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFBlZGlncmVlQnVubnlOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBzaG93TXV0YXRpb25JY29uOiB0cnVlLFxyXG4gICAgICBidW5ueUlzU2VsZWN0ZWQ6IGZhbHNlXHJcblxyXG4gICAgICAvLyBOb3QgUGhFVC1pTyBpbnN0cnVtZW50ZWQ6IFBlZGlncmVlQnVubnlOb2RlIGlzIGNyZWF0ZWQgZHluYW1pY2FsbHksIGFuZCBjbGllbnRzIGdlbmVyYWxseSBoYXZlIG5vIG5lZWQgdG8gaW5zcGVjdCB0aGVtLlxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgY2hpbGRyZW4gPSBbXTtcclxuXHJcbiAgICAvLyBOb2RlIHRoYXQgY29ycmVzcG9uZHMgdG8gdGhlIGJ1bm55J3MgcGhlbm90eXBlIChhcHBlYXJhbmNlKVxyXG4gICAgY29uc3QgYnVubnlOb2RlID0gYnVubnlJbWFnZU1hcC5nZXROb2RlKCBidW5ueSwge1xyXG4gICAgICBzY2FsZTogTmF0dXJhbFNlbGVjdGlvbkNvbnN0YW50cy5CVU5OWV9JTUFHRV9TQ0FMRSxcclxuICAgICAgY2VudGVyWDogMCxcclxuICAgICAgYm90dG9tOiAwXHJcbiAgICB9ICk7XHJcbiAgICBjaGlsZHJlbi5wdXNoKCBidW5ueU5vZGUgKTtcclxuXHJcbiAgICAvLyBMYWJlbCBvcmlnaW5hbCBtdXRhbnQgd2l0aCBhbiBpY29uXHJcbiAgICBpZiAoIGJ1bm55LmlzT3JpZ2luYWxNdXRhbnQoKSApIHtcclxuICAgICAgY2hpbGRyZW4ucHVzaCggbmV3IE11dGF0aW9uSWNvbk5vZGUoIHtcclxuICAgICAgICByaWdodDogYnVubnlOb2RlLmNlbnRlclgsXHJcbiAgICAgICAgYm90dG9tOiBidW5ueU5vZGUuYm90dG9tLFxyXG4gICAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgICB9ICkgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGdlbm90eXBlIGFiYnJldmlhdGlvbiwgbXVzdCBiZSBkaXNwb3NlZFxyXG4gICAgLy8gTm90IGluc3RydW1lbnRlZCBiZWNhdXNlIHdlIGRlY2lkZWQgbm90IHRvIGluc3RydW1lbnQgUGVkaWdyZWVCdW5ueU5vZGUuXHJcbiAgICBjb25zdCBnZW5vdHlwZURlcml2ZWRTdHJpbmdQcm9wZXJ0eSA9IERlcml2ZWRQcm9wZXJ0eS5kZXJpdmVBbnkoXHJcbiAgICAgIFtcclxuICAgICAgICBmdXJBbGxlbGVzVmlzaWJsZVByb3BlcnR5LCBlYXJzQWxsZWxlc1Zpc2libGVQcm9wZXJ0eSwgdGVldGhBbGxlbGVzVmlzaWJsZVByb3BlcnR5LFxyXG4gICAgICAgIC4uLmJ1bm55Lmdlbm90eXBlLmdldEFiYnJldmlhdGlvblN0cmluZ0RlcGVuZGVuY2llcygpXHJcbiAgICAgIF0sXHJcbiAgICAgICgpID0+XHJcbiAgICAgICAgZ2V0R2Vub3R5cGVBYmJyZXZpYXRpb24oIGJ1bm55LCBmdXJBbGxlbGVzVmlzaWJsZVByb3BlcnR5LnZhbHVlLCBlYXJzQWxsZWxlc1Zpc2libGVQcm9wZXJ0eS52YWx1ZSwgdGVldGhBbGxlbGVzVmlzaWJsZVByb3BlcnR5LnZhbHVlIClcclxuICAgICk7XHJcblxyXG4gICAgLy8gTXVzdCBiZSBkaXNwb3NlZFxyXG4gICAgY29uc3QgZ2Vub3R5cGVUZXh0VmlzaWJsZVByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eShcclxuICAgICAgWyBmdXJBbGxlbGVzVmlzaWJsZVByb3BlcnR5LCBlYXJzQWxsZWxlc1Zpc2libGVQcm9wZXJ0eSwgdGVldGhBbGxlbGVzVmlzaWJsZVByb3BlcnR5IF0sXHJcbiAgICAgICggZnVyQWxsZWxlc1Zpc2libGUsIGVhcnNBbGxlbGVzVmlzaWJsZSwgdGVldGhBbGxlbGVzVmlzaWJsZSApID0+XHJcbiAgICAgICAgKCBmdXJBbGxlbGVzVmlzaWJsZSB8fCBlYXJzQWxsZWxlc1Zpc2libGUgfHwgdGVldGhBbGxlbGVzVmlzaWJsZSApXHJcbiAgICApO1xyXG5cclxuICAgIC8vIEdlbm90eXBlIGFiYnJldmlhdGlvblxyXG4gICAgLy8gTm90IGluc3RydW1lbnRlZCBiZWNhdXNlIHdlIGRlY2lkZWQgbm90IHRvIGluc3RydW1lbnQgUGVkaWdyZWVCdW5ueU5vZGUuXHJcbiAgICBjb25zdCBnZW5vdHlwZVRleHQgPSBuZXcgVGV4dCggZ2Vub3R5cGVEZXJpdmVkU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgdmlzaWJsZVByb3BlcnR5OiBnZW5vdHlwZVRleHRWaXNpYmxlUHJvcGVydHksXHJcbiAgICAgIGZvbnQ6IEdFTk9UWVBFX0ZPTlQsXHJcbiAgICAgIG1heFdpZHRoOiBidW5ueU5vZGUud2lkdGhcclxuICAgIH0gKTtcclxuICAgIGNoaWxkcmVuLnB1c2goIGdlbm90eXBlVGV4dCApO1xyXG5cclxuICAgIC8vIENlbnRlciB0aGUgZ2Vub3R5cGUgYWJicmV2aWF0aW9uIGFib3ZlIHRoZSBidW5ueS5cclxuICAgIGdlbm90eXBlVGV4dC5ib3VuZHNQcm9wZXJ0eS5saW5rKCAoKSA9PiB7XHJcbiAgICAgIGdlbm90eXBlVGV4dC5jZW50ZXJYID0gYnVubnlOb2RlLmNlbnRlclg7XHJcbiAgICAgIGdlbm90eXBlVGV4dC50b3AgPSBidW5ueU5vZGUuYm90dG9tICsgNTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBPcHRpb25hbCBzZWxlY3Rpb24gcmVjdGFuZ2xlLCBwcmVwZW5kZWQgdG8gY2hpbGRyZW5cclxuICAgIGlmICggb3B0aW9ucy5idW5ueUlzU2VsZWN0ZWQgKSB7XHJcbiAgICAgIGNoaWxkcmVuLnVuc2hpZnQoIG5ldyBCdW5ueVNlbGVjdGlvblJlY3RhbmdsZSggYnVubnlOb2RlLmJvdW5kcy5kaWxhdGVkKCAzICksIHtcclxuICAgICAgICBjZW50ZXI6IGJ1bm55Tm9kZS5jZW50ZXJcclxuICAgICAgfSApICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCBOYXR1cmFsU2VsZWN0aW9uUXVlcnlQYXJhbWV0ZXJzLnNob3dPcmlnaW4gKSB7XHJcbiAgICAgIGNoaWxkcmVuLnB1c2goIG5ldyBPcmlnaW5Ob2RlKCkgKTtcclxuICAgIH1cclxuXHJcbiAgICBvcHRpb25zLmNoaWxkcmVuID0gY2hpbGRyZW47XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBMYWJlbCBhIGRlYWQgYnVubnkgd2l0aCBhIHJlZCBjcm9zcyBtYXJrLiAgVGhpcyBUZXh0IG5vZGUgZG9lcyBub3QgdGFrZSBhIHN0cmluZyBQcm9wZXJ0eSBiZWNhdXNlIGl0XHJcbiAgICAvLyBkaXNwbGF5cyBhIHN0YXRpYyBzeW1ib2wgdGhhdCBpcyBub3QgdHJhbnNsYXRhYmxlLlxyXG4gICAgY29uc3QgYWRkUmVkQ3Jvc3NNYXJrID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLmFkZENoaWxkKCBuZXcgVGV4dCggVU5JQ09ERV9SRURfQ1JPU1NfTUFSSywge1xyXG4gICAgICAgIGZvbnQ6IERFQURfU1lNQk9MX0ZPTlQsXHJcbiAgICAgICAgcmlnaHQ6IGJ1bm55Tm9kZS5jZW50ZXJYLFxyXG4gICAgICAgIGJvdHRvbTogYnVubnlOb2RlLmNlbnRlcllcclxuICAgICAgfSApICk7XHJcbiAgICB9O1xyXG4gICAgaWYgKCBidW5ueS5pc0FsaXZlICkge1xyXG5cclxuICAgICAgLy8gcmVtb3ZlTGlzdGVuZXIgaW4gZGlzcG9zZS4gTm90IG5lY2Vzc2FyeSB0byByZW1vdmVMaXN0ZW5lciB3aGVuIGRpZWRFbWl0dGVyIGZpcmVzLCBiZWNhdXNlIGl0IGRpc3Bvc2VzIGl0c2VsZi5cclxuICAgICAgYnVubnkuZGllZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIGFkZFJlZENyb3NzTWFyayApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGFkZFJlZENyb3NzTWFyaygpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZGlzcG9zZVBlZGlncmVlQnVubnlOb2RlID0gKCkgPT4ge1xyXG4gICAgICBnZW5vdHlwZURlcml2ZWRTdHJpbmdQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICAgIGdlbm90eXBlVGV4dFZpc2libGVQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICAgIGlmICggYnVubnkuZGllZEVtaXR0ZXIuaGFzTGlzdGVuZXIoIGFkZFJlZENyb3NzTWFyayApICkge1xyXG4gICAgICAgIGJ1bm55LmRpZWRFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCBhZGRSZWRDcm9zc01hcmsgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gVW4tcGFyZW50IHRoZSBidW5ueU5vZGUgZnJvbSB0aGUgc2hhcmVkIERBR1xyXG4gICAgICBidW5ueU5vZGUuZGlzcG9zZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBJZiBsb2dnaW5nIGlzIGVuYWJsZWQsIHByZXNzaW5nIG9uIGEgYnVubnkgbG9ncyBpdHMgZGV0YWlscyB0byB0aGUgY29uc29sZS5cclxuICAgIC8vIHJlbW92ZUlucHV0IGxpc3RlbmVyIGlzIG5vdCBuZWNlc3NhcnkuXHJcbiAgICBpZiAoIHBoZXQubG9nICkge1xyXG4gICAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIHtcclxuICAgICAgICBkb3duOiAoKSA9PiBwaGV0LmxvZyggYFBlZGlncmVlIHByZXNzOiAke2J1bm55LnRvU3RyaW5nKCl9YCApXHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlUGVkaWdyZWVCdW5ueU5vZGUoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXRzIHRoZSBhYmJyZXZpYXRpb25zIHRoYXQgZGVzY3JpYmUgYSBCdW5ueSdzIGdlbm90eXBlLCBlLmcuICdGZkVFdHQnLlxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0R2Vub3R5cGVBYmJyZXZpYXRpb24oIGJ1bm55OiBCdW5ueSwgZnVyQWxsZWxlc1Zpc2libGU6IGJvb2xlYW4sIGVhcnNBbGxlbGVzVmlzaWJsZTogYm9vbGVhbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlZXRoQWxsZWxlc1Zpc2libGU6IGJvb2xlYW4gKTogc3RyaW5nIHtcclxuXHJcbiAgbGV0IGdlbm90eXBlU3RyaW5nID0gJyc7XHJcblxyXG4gIGlmICggZnVyQWxsZWxlc1Zpc2libGUgKSB7XHJcbiAgICBnZW5vdHlwZVN0cmluZyArPSBidW5ueS5nZW5vdHlwZS5mdXJHZW5lUGFpci5nZXRHZW5vdHlwZUFiYnJldmlhdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgaWYgKCBlYXJzQWxsZWxlc1Zpc2libGUgKSB7XHJcbiAgICBnZW5vdHlwZVN0cmluZyArPSBidW5ueS5nZW5vdHlwZS5lYXJzR2VuZVBhaXIuZ2V0R2Vub3R5cGVBYmJyZXZpYXRpb24oKTtcclxuICB9XHJcblxyXG4gIGlmICggdGVldGhBbGxlbGVzVmlzaWJsZSApIHtcclxuICAgIGdlbm90eXBlU3RyaW5nICs9IGJ1bm55Lmdlbm90eXBlLnRlZXRoR2VuZVBhaXIuZ2V0R2Vub3R5cGVBYmJyZXZpYXRpb24oKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBnZW5vdHlwZVN0cmluZztcclxufVxyXG5cclxubmF0dXJhbFNlbGVjdGlvbi5yZWdpc3RlciggJ1BlZGlncmVlQnVubnlOb2RlJywgUGVkaWdyZWVCdW5ueU5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sMkNBQTJDO0FBRXZFLE9BQU9DLFNBQVMsTUFBTSwwQ0FBMEM7QUFDaEUsT0FBT0MsUUFBUSxNQUFNLDRDQUE0QztBQUNqRSxTQUFTQyxJQUFJLEVBQWVDLElBQUksUUFBUSxzQ0FBc0M7QUFDOUUsT0FBT0MsZ0JBQWdCLE1BQU0sOEJBQThCO0FBRTNELE9BQU9DLHlCQUF5QixNQUFNLG9DQUFvQztBQUMxRSxPQUFPQywrQkFBK0IsTUFBTSwwQ0FBMEM7QUFFdEYsT0FBT0MsdUJBQXVCLE1BQU0sK0JBQStCO0FBQ25FLE9BQU9DLGdCQUFnQixNQUFNLHdCQUF3QjtBQUNyRCxPQUFPQyxVQUFVLE1BQU0sa0JBQWtCOztBQUV6QztBQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUFJVCxRQUFRLENBQUUsRUFBRyxDQUFDO0FBQ3hDLE1BQU1VLGdCQUFnQixHQUFHLElBQUlWLFFBQVEsQ0FB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