// Copyright 2020-2022, University of Colorado Boulder

/**
 * PopulationPlotNode plots one set of data on the Population graph, updated only when visible.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Multilink from '../../../../../axon/js/Multilink.js';
import { Shape } from '../../../../../kite/js/imports.js';
import optionize from '../../../../../phet-core/js/optionize.js';
import { Node, Path } from '../../../../../scenery/js/imports.js';
import naturalSelection from '../../../naturalSelection.js';
import NaturalSelectionConstants from '../../NaturalSelectionConstants.js';

// constants
const NORMAL_LINE_DASH = [];
const MUTANT_LINE_DASH = NaturalSelectionConstants.POPULATION_MUTANT_LINE_DASH;
const MUTANT_LINE_DASH_SUM = _.sum(MUTANT_LINE_DASH);
export default class PopulationPlotNode extends Node {
  constructor(providedOptions) {
    const options = optionize()({
      // SelfOptions
      isMutant: false
    }, providedOptions);

    // Points will be drawn as circles
    const pointsPath = new Path(new Shape(), {
      fill: options.color
    });

    // Points will be connected using line segments that create a step plot
    const stepPath = new Path(new Shape(), {
      stroke: options.color,
      lineWidth: NaturalSelectionConstants.POPULATION_LINE_WIDTH,
      lineDash: options.isMutant ? MUTANT_LINE_DASH : NORMAL_LINE_DASH
    });
    options.children = [stepPath, pointsPath];
    super(options);
    this.points = options.points;
    this.xAxisLength = options.xAxisLength;
    this.xRangeProperty = options.xRangeProperty;
    this.yRangeProperty = options.yRangeProperty;
    this.timeInGenerationsProperty = options.timeInGenerationsProperty;
    this.gridWidth = options.gridWidth;
    this.gridHeight = options.gridHeight;
    this.pointsPath = pointsPath; // {Path}
    this.stepPath = stepPath; // {Path}
    this.isDashed = _.sum(stepPath.lineDash) > 0;

    // unlink is not necessary.
    options.plotVisibleProperty.link(plotVisible => {
      this.visible = plotVisible;
    });

    // Points are only added, and are not deleted until they are all deleted. So this is optimized to avoid doing
    // work as each individual point is deleted.
    // unlink is not necessary.
    this.points.lengthProperty.link((length, previousLength) => {
      if (previousLength === null || length > previousLength || length === 0) {
        this.updatePlot();
      }
    });

    // Until data fills the width of the graph and the graph starts scrolling, update the plot when generation changes.
    // After that, it's sufficient to update the plot when xRangeProperty changes.
    // unlink is not necessary.
    this.timeInGenerationsProperty.link(timeInGenerations => {
      if (timeInGenerations < this.xAxisLength) {
        this.updatePlot();
      }
    });

    // Update when visibility or range changes. unmultilink is not necessary.
    Multilink.multilink([this.visibleProperty, this.xRangeProperty, this.yRangeProperty], visible => visible ? this.updatePlot() : this.clearPlot());
  }

  /**
   * Plots the points and line segments that are within the x range of the graph.
   * The y range is handled by a clipArea on PopulationPlotsNode (the parent Node).
   */
  updatePlot() {
    // Draw only if visible
    if (this.visible) {
      const pointsShape = new Shape();
      const stepShape = new Shape();
      const numberOfPoints = this.points.length;

      // If we have points and any of them fall within the x range...
      if (numberOfPoints > 0 && this.points[0].x <= this.xRangeProperty.value.max) {
        // Index of the point to start with. Defaults to the first point in the array.
        let startIndex = 0;

        // If there is at least one point that is < xMin, find the index of the first point that is <= xMin.
        // Do a brute-force search from the end of the array, to optimize for the case where the graph is scrolling
        // (animated). If the graph is not scrolling, then the sim is paused, and the graph is being used to examine
        // data for a previous generation. In that case, the time for this search is not critical.
        if (this.points[0].x < this.xRangeProperty.value.min) {
          for (let i = numberOfPoints - 1; i >= 0; i--) {
            const point = this.points[i];
            if (point.x <= this.xRangeProperty.value.min) {
              startIndex = i;
              break;
            }
          }
        }

        // Start with this point, and plot from left to right.
        const startPoint = this.points[startIndex];

        // For mutant plots (drawn with a lineDash), adjust lineDashOffset so that the dash appears to scroll.
        // See https://github.com/phetsims/natural-selection/issues/111
        if (this.isDashed && this.points.length > 0) {
          const xRemainderModel = startPoint.x % 1;
          const xRemainderView = this.modelToViewX(xRemainderModel);
          this.stepPath.lineDashOffset = -(xRemainderView % MUTANT_LINE_DASH_SUM);
        }

        // Plot the start point, if it's within the x range of the grid.
        const startXView = this.modelToViewX(Math.max(startPoint.x, this.xRangeProperty.value.min));
        const startYView = this.modelToViewY(startPoint.y);
        if (startPoint.x >= this.xRangeProperty.value.min) {
          pointsShape.circle(startXView, startYView, NaturalSelectionConstants.POPULATION_POINT_RADIUS);
        }
        stepShape.moveTo(startXView, startYView);

        // Keep track of the previous point that was plotted.
        let previousPoint = startPoint;

        // Starting with the next point, plot from left to right.
        for (let i = startIndex + 1; i < numberOfPoints; i++) {
          const point = this.points[i];
          if (point.x <= this.xRangeProperty.value.max) {
            // Compute view coordinates
            const xView = this.modelToViewX(point.x);
            const yView = this.modelToViewY(point.y);
            const yViewPrevious = this.modelToViewY(previousPoint.y);

            // Plot the point
            pointsShape.circle(xView, yView, NaturalSelectionConstants.POPULATION_POINT_RADIUS);

            // Plot the line segments
            stepShape.lineTo(xView, yViewPrevious); // horizontal line from the previous point
            stepShape.lineTo(xView, yView); // vertical line to the current point
          } else {
            // Extend the plot from previousPoint to the right edge of the grid.
            const xViewMax = this.modelToViewX(this.xRangeProperty.value.max);
            const yViewPrevious = this.modelToViewY(previousPoint.y);
            stepShape.lineTo(xViewMax, yViewPrevious); // horizontal line from the previous point
          }

          previousPoint = point;

          // Bail out if when we reach the right edge of grid.
          if (point.x >= this.xRangeProperty.value.max) {
            break;
          }
        }

        // Plot from previousPoint to current generation time
        if (previousPoint.x < this.xRangeProperty.value.max && previousPoint.x < this.timeInGenerationsProperty.value) {
          const xView = this.modelToViewX(this.timeInGenerationsProperty.value);
          const yView = this.modelToViewY(previousPoint.y);
          stepShape.lineTo(xView, yView);
        }
      }
      this.pointsPath.setShape(pointsShape);
      this.stepPath.setShape(stepShape);
    }
  }

  /**
   * Clears the plot. While a plot is invisible, it is not updated.  So when a plot is made invisible, it must
   * also be cleared. This is important because bounds are used to decide if the graph is displaying data, and
   * whether the "Zoom out to show data" message should be displayed.  Bounds computation includes invisible Nodes,
   * and if the plot still contains geometry, then it will be incorrectly contributing to bounds.
   * See https://github.com/phetsims/natural-selection/issues/209
   */
  clearPlot() {
    this.pointsPath.setShape(null);
    this.stepPath.setShape(null);
  }

  /**
   * Model-view transform for x-axis.
   * @param xModel - x model value, in generations
   * @returns x view value
   */
  modelToViewX(xModel) {
    return this.gridWidth * (xModel - this.xRangeProperty.value.min) / (this.xRangeProperty.value.max - this.xRangeProperty.value.min);
  }

  /**
   * Model-view transform for y-axis. The y-axis is inverted (+y up in model, +y down in view).
   * @param yModel - y model value, population
   * @returns y view value
   */
  modelToViewY(yModel) {
    return this.gridHeight - this.gridHeight * (yModel - this.yRangeProperty.value.min) / (this.yRangeProperty.value.max - this.yRangeProperty.value.min);
  }
}
naturalSelection.register('PopulationPlotNode', PopulationPlotNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJTaGFwZSIsIm9wdGlvbml6ZSIsIk5vZGUiLCJQYXRoIiwibmF0dXJhbFNlbGVjdGlvbiIsIk5hdHVyYWxTZWxlY3Rpb25Db25zdGFudHMiLCJOT1JNQUxfTElORV9EQVNIIiwiTVVUQU5UX0xJTkVfREFTSCIsIlBPUFVMQVRJT05fTVVUQU5UX0xJTkVfREFTSCIsIk1VVEFOVF9MSU5FX0RBU0hfU1VNIiwiXyIsInN1bSIsIlBvcHVsYXRpb25QbG90Tm9kZSIsImNvbnN0cnVjdG9yIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImlzTXV0YW50IiwicG9pbnRzUGF0aCIsImZpbGwiLCJjb2xvciIsInN0ZXBQYXRoIiwic3Ryb2tlIiwibGluZVdpZHRoIiwiUE9QVUxBVElPTl9MSU5FX1dJRFRIIiwibGluZURhc2giLCJjaGlsZHJlbiIsInBvaW50cyIsInhBeGlzTGVuZ3RoIiwieFJhbmdlUHJvcGVydHkiLCJ5UmFuZ2VQcm9wZXJ0eSIsInRpbWVJbkdlbmVyYXRpb25zUHJvcGVydHkiLCJncmlkV2lkdGgiLCJncmlkSGVpZ2h0IiwiaXNEYXNoZWQiLCJwbG90VmlzaWJsZVByb3BlcnR5IiwibGluayIsInBsb3RWaXNpYmxlIiwidmlzaWJsZSIsImxlbmd0aFByb3BlcnR5IiwibGVuZ3RoIiwicHJldmlvdXNMZW5ndGgiLCJ1cGRhdGVQbG90IiwidGltZUluR2VuZXJhdGlvbnMiLCJtdWx0aWxpbmsiLCJ2aXNpYmxlUHJvcGVydHkiLCJjbGVhclBsb3QiLCJwb2ludHNTaGFwZSIsInN0ZXBTaGFwZSIsIm51bWJlck9mUG9pbnRzIiwieCIsInZhbHVlIiwibWF4Iiwic3RhcnRJbmRleCIsIm1pbiIsImkiLCJwb2ludCIsInN0YXJ0UG9pbnQiLCJ4UmVtYWluZGVyTW9kZWwiLCJ4UmVtYWluZGVyVmlldyIsIm1vZGVsVG9WaWV3WCIsImxpbmVEYXNoT2Zmc2V0Iiwic3RhcnRYVmlldyIsIk1hdGgiLCJzdGFydFlWaWV3IiwibW9kZWxUb1ZpZXdZIiwieSIsImNpcmNsZSIsIlBPUFVMQVRJT05fUE9JTlRfUkFESVVTIiwibW92ZVRvIiwicHJldmlvdXNQb2ludCIsInhWaWV3IiwieVZpZXciLCJ5Vmlld1ByZXZpb3VzIiwibGluZVRvIiwieFZpZXdNYXgiLCJzZXRTaGFwZSIsInhNb2RlbCIsInlNb2RlbCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUG9wdWxhdGlvblBsb3ROb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFBvcHVsYXRpb25QbG90Tm9kZSBwbG90cyBvbmUgc2V0IG9mIGRhdGEgb24gdGhlIFBvcHVsYXRpb24gZ3JhcGgsIHVwZGF0ZWQgb25seSB3aGVuIHZpc2libGUuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZUFycmF5IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9jcmVhdGVPYnNlcnZhYmxlQXJyYXkuanMnO1xyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIE5vZGVPcHRpb25zLCBQYXRoLCBUQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgbmF0dXJhbFNlbGVjdGlvbiBmcm9tICcuLi8uLi8uLi9uYXR1cmFsU2VsZWN0aW9uLmpzJztcclxuaW1wb3J0IE5hdHVyYWxTZWxlY3Rpb25Db25zdGFudHMgZnJvbSAnLi4vLi4vTmF0dXJhbFNlbGVjdGlvbkNvbnN0YW50cy5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgTk9STUFMX0xJTkVfREFTSDogbnVtYmVyW10gPSBbXTtcclxuY29uc3QgTVVUQU5UX0xJTkVfREFTSCA9IE5hdHVyYWxTZWxlY3Rpb25Db25zdGFudHMuUE9QVUxBVElPTl9NVVRBTlRfTElORV9EQVNIO1xyXG5jb25zdCBNVVRBTlRfTElORV9EQVNIX1NVTSA9IF8uc3VtKCBNVVRBTlRfTElORV9EQVNIICk7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBkYXRhIHBvaW50cywgaW4gbW9kZWwgY29vcmRpbmF0ZXMgKHg9R2VuZXJhdGlvbiwgeT1Qb3B1bGF0aW9uKVxyXG4gIHBvaW50czogT2JzZXJ2YWJsZUFycmF5PFZlY3RvcjI+O1xyXG5cclxuICAvLyB3aGV0aGVyIHRoaXMgcGxvdCBpcyB2aXNpYmxlXHJcbiAgcGxvdFZpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIGxlbmd0aCBvZiB0aGUgeC1heGlzLCBpbiBnZW5lcmF0aW9uc1xyXG4gIHhBeGlzTGVuZ3RoOiBudW1iZXI7XHJcblxyXG4gIC8vIHJhbmdlcyBmb3IgdGhlIGF4ZXNcclxuICB4UmFuZ2VQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8UmFuZ2U+O1xyXG4gIHlSYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT47XHJcblxyXG4gIC8vIHRpbWUgb24gdGhlIGdlbmVyYXRpb24gY2xvY2ssIGluIGdlbmVyYXRpb25zXHJcbiAgdGltZUluR2VuZXJhdGlvbnNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gZGltZW5zaW9ucyBvZiB0aGUgZ3JpZCAoc2FucyB0aWNrIG1hcmtzKSBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgZ3JpZFdpZHRoOiBudW1iZXI7XHJcbiAgZ3JpZEhlaWdodDogbnVtYmVyO1xyXG5cclxuICAvLyBjb2xvciB1c2VkIHRvIHJlbmRlciB0aGUgcGxvdFxyXG4gIGNvbG9yOiBUQ29sb3I7XHJcblxyXG4gIC8vIGlzIHRoaXMgcGxvdCBmb3IgYSBtdXRhbnQgYWxsZWxlP1xyXG4gIGlzTXV0YW50PzogYm9vbGVhbjtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFBvcHVsYXRpb25QbG90Tm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvcHVsYXRpb25QbG90Tm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHBvaW50czogT2JzZXJ2YWJsZUFycmF5PFZlY3RvcjI+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgeEF4aXNMZW5ndGg6IG51bWJlcjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHhSYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT47XHJcbiAgcHJpdmF0ZSByZWFkb25seSB5UmFuZ2VQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8UmFuZ2U+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdGltZUluR2VuZXJhdGlvbnNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGdyaWRXaWR0aDogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZ3JpZEhlaWdodDogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcG9pbnRzUGF0aDogUGF0aDtcclxuICBwcml2YXRlIHJlYWRvbmx5IHN0ZXBQYXRoOiBQYXRoO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgaXNEYXNoZWQ6IGJvb2xlYW47XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zOiBQb3B1bGF0aW9uUGxvdE5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8UG9wdWxhdGlvblBsb3ROb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBpc011dGFudDogZmFsc2VcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIC8vIFBvaW50cyB3aWxsIGJlIGRyYXduIGFzIGNpcmNsZXNcclxuICAgIGNvbnN0IHBvaW50c1BhdGggPSBuZXcgUGF0aCggbmV3IFNoYXBlKCksIHtcclxuICAgICAgZmlsbDogb3B0aW9ucy5jb2xvclxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFBvaW50cyB3aWxsIGJlIGNvbm5lY3RlZCB1c2luZyBsaW5lIHNlZ21lbnRzIHRoYXQgY3JlYXRlIGEgc3RlcCBwbG90XHJcbiAgICBjb25zdCBzdGVwUGF0aCA9IG5ldyBQYXRoKCBuZXcgU2hhcGUoKSwge1xyXG4gICAgICBzdHJva2U6IG9wdGlvbnMuY29sb3IsXHJcbiAgICAgIGxpbmVXaWR0aDogTmF0dXJhbFNlbGVjdGlvbkNvbnN0YW50cy5QT1BVTEFUSU9OX0xJTkVfV0lEVEgsXHJcbiAgICAgIGxpbmVEYXNoOiBvcHRpb25zLmlzTXV0YW50ID8gTVVUQU5UX0xJTkVfREFTSCA6IE5PUk1BTF9MSU5FX0RBU0hcclxuICAgIH0gKTtcclxuXHJcbiAgICBvcHRpb25zLmNoaWxkcmVuID0gWyBzdGVwUGF0aCwgcG9pbnRzUGF0aCBdO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5wb2ludHMgPSBvcHRpb25zLnBvaW50cztcclxuICAgIHRoaXMueEF4aXNMZW5ndGggPSBvcHRpb25zLnhBeGlzTGVuZ3RoO1xyXG4gICAgdGhpcy54UmFuZ2VQcm9wZXJ0eSA9IG9wdGlvbnMueFJhbmdlUHJvcGVydHk7XHJcbiAgICB0aGlzLnlSYW5nZVByb3BlcnR5ID0gb3B0aW9ucy55UmFuZ2VQcm9wZXJ0eTtcclxuICAgIHRoaXMudGltZUluR2VuZXJhdGlvbnNQcm9wZXJ0eSA9IG9wdGlvbnMudGltZUluR2VuZXJhdGlvbnNQcm9wZXJ0eTtcclxuICAgIHRoaXMuZ3JpZFdpZHRoID0gb3B0aW9ucy5ncmlkV2lkdGg7XHJcbiAgICB0aGlzLmdyaWRIZWlnaHQgPSBvcHRpb25zLmdyaWRIZWlnaHQ7XHJcbiAgICB0aGlzLnBvaW50c1BhdGggPSBwb2ludHNQYXRoOyAvLyB7UGF0aH1cclxuICAgIHRoaXMuc3RlcFBhdGggPSBzdGVwUGF0aDsgLy8ge1BhdGh9XHJcbiAgICB0aGlzLmlzRGFzaGVkID0gXy5zdW0oIHN0ZXBQYXRoLmxpbmVEYXNoICkgPiAwO1xyXG5cclxuICAgIC8vIHVubGluayBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gICAgb3B0aW9ucy5wbG90VmlzaWJsZVByb3BlcnR5LmxpbmsoIHBsb3RWaXNpYmxlID0+IHtcclxuICAgICAgdGhpcy52aXNpYmxlID0gcGxvdFZpc2libGU7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gUG9pbnRzIGFyZSBvbmx5IGFkZGVkLCBhbmQgYXJlIG5vdCBkZWxldGVkIHVudGlsIHRoZXkgYXJlIGFsbCBkZWxldGVkLiBTbyB0aGlzIGlzIG9wdGltaXplZCB0byBhdm9pZCBkb2luZ1xyXG4gICAgLy8gd29yayBhcyBlYWNoIGluZGl2aWR1YWwgcG9pbnQgaXMgZGVsZXRlZC5cclxuICAgIC8vIHVubGluayBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gICAgdGhpcy5wb2ludHMubGVuZ3RoUHJvcGVydHkubGluayggKCBsZW5ndGgsIHByZXZpb3VzTGVuZ3RoICkgPT4ge1xyXG4gICAgICBpZiAoICggcHJldmlvdXNMZW5ndGggPT09IG51bGwgKSB8fCBsZW5ndGggPiBwcmV2aW91c0xlbmd0aCB8fCBsZW5ndGggPT09IDAgKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVQbG90KCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVbnRpbCBkYXRhIGZpbGxzIHRoZSB3aWR0aCBvZiB0aGUgZ3JhcGggYW5kIHRoZSBncmFwaCBzdGFydHMgc2Nyb2xsaW5nLCB1cGRhdGUgdGhlIHBsb3Qgd2hlbiBnZW5lcmF0aW9uIGNoYW5nZXMuXHJcbiAgICAvLyBBZnRlciB0aGF0LCBpdCdzIHN1ZmZpY2llbnQgdG8gdXBkYXRlIHRoZSBwbG90IHdoZW4geFJhbmdlUHJvcGVydHkgY2hhbmdlcy5cclxuICAgIC8vIHVubGluayBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gICAgdGhpcy50aW1lSW5HZW5lcmF0aW9uc1Byb3BlcnR5LmxpbmsoIHRpbWVJbkdlbmVyYXRpb25zID0+IHtcclxuICAgICAgaWYgKCB0aW1lSW5HZW5lcmF0aW9ucyA8IHRoaXMueEF4aXNMZW5ndGggKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVQbG90KCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgd2hlbiB2aXNpYmlsaXR5IG9yIHJhbmdlIGNoYW5nZXMuIHVubXVsdGlsaW5rIGlzIG5vdCBuZWNlc3NhcnkuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbIHRoaXMudmlzaWJsZVByb3BlcnR5LCB0aGlzLnhSYW5nZVByb3BlcnR5LCB0aGlzLnlSYW5nZVByb3BlcnR5IF0sXHJcbiAgICAgIHZpc2libGUgPT4gdmlzaWJsZSA/IHRoaXMudXBkYXRlUGxvdCgpIDogdGhpcy5jbGVhclBsb3QoKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBsb3RzIHRoZSBwb2ludHMgYW5kIGxpbmUgc2VnbWVudHMgdGhhdCBhcmUgd2l0aGluIHRoZSB4IHJhbmdlIG9mIHRoZSBncmFwaC5cclxuICAgKiBUaGUgeSByYW5nZSBpcyBoYW5kbGVkIGJ5IGEgY2xpcEFyZWEgb24gUG9wdWxhdGlvblBsb3RzTm9kZSAodGhlIHBhcmVudCBOb2RlKS5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZVBsb3QoKTogdm9pZCB7XHJcblxyXG4gICAgLy8gRHJhdyBvbmx5IGlmIHZpc2libGVcclxuICAgIGlmICggdGhpcy52aXNpYmxlICkge1xyXG5cclxuICAgICAgY29uc3QgcG9pbnRzU2hhcGUgPSBuZXcgU2hhcGUoKTtcclxuICAgICAgY29uc3Qgc3RlcFNoYXBlID0gbmV3IFNoYXBlKCk7XHJcblxyXG4gICAgICBjb25zdCBudW1iZXJPZlBvaW50cyA9IHRoaXMucG9pbnRzLmxlbmd0aDtcclxuXHJcbiAgICAgIC8vIElmIHdlIGhhdmUgcG9pbnRzIGFuZCBhbnkgb2YgdGhlbSBmYWxsIHdpdGhpbiB0aGUgeCByYW5nZS4uLlxyXG4gICAgICBpZiAoIG51bWJlck9mUG9pbnRzID4gMCAmJiB0aGlzLnBvaW50c1sgMCBdLnggPD0gdGhpcy54UmFuZ2VQcm9wZXJ0eS52YWx1ZS5tYXggKSB7XHJcblxyXG4gICAgICAgIC8vIEluZGV4IG9mIHRoZSBwb2ludCB0byBzdGFydCB3aXRoLiBEZWZhdWx0cyB0byB0aGUgZmlyc3QgcG9pbnQgaW4gdGhlIGFycmF5LlxyXG4gICAgICAgIGxldCBzdGFydEluZGV4ID0gMDtcclxuXHJcbiAgICAgICAgLy8gSWYgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHBvaW50IHRoYXQgaXMgPCB4TWluLCBmaW5kIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QgcG9pbnQgdGhhdCBpcyA8PSB4TWluLlxyXG4gICAgICAgIC8vIERvIGEgYnJ1dGUtZm9yY2Ugc2VhcmNoIGZyb20gdGhlIGVuZCBvZiB0aGUgYXJyYXksIHRvIG9wdGltaXplIGZvciB0aGUgY2FzZSB3aGVyZSB0aGUgZ3JhcGggaXMgc2Nyb2xsaW5nXHJcbiAgICAgICAgLy8gKGFuaW1hdGVkKS4gSWYgdGhlIGdyYXBoIGlzIG5vdCBzY3JvbGxpbmcsIHRoZW4gdGhlIHNpbSBpcyBwYXVzZWQsIGFuZCB0aGUgZ3JhcGggaXMgYmVpbmcgdXNlZCB0byBleGFtaW5lXHJcbiAgICAgICAgLy8gZGF0YSBmb3IgYSBwcmV2aW91cyBnZW5lcmF0aW9uLiBJbiB0aGF0IGNhc2UsIHRoZSB0aW1lIGZvciB0aGlzIHNlYXJjaCBpcyBub3QgY3JpdGljYWwuXHJcbiAgICAgICAgaWYgKCB0aGlzLnBvaW50c1sgMCBdLnggPCB0aGlzLnhSYW5nZVByb3BlcnR5LnZhbHVlLm1pbiApIHtcclxuICAgICAgICAgIGZvciAoIGxldCBpID0gbnVtYmVyT2ZQb2ludHMgLSAxOyBpID49IDA7IGktLSApIHtcclxuICAgICAgICAgICAgY29uc3QgcG9pbnQgPSB0aGlzLnBvaW50c1sgaSBdO1xyXG4gICAgICAgICAgICBpZiAoIHBvaW50LnggPD0gdGhpcy54UmFuZ2VQcm9wZXJ0eS52YWx1ZS5taW4gKSB7XHJcbiAgICAgICAgICAgICAgc3RhcnRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFN0YXJ0IHdpdGggdGhpcyBwb2ludCwgYW5kIHBsb3QgZnJvbSBsZWZ0IHRvIHJpZ2h0LlxyXG4gICAgICAgIGNvbnN0IHN0YXJ0UG9pbnQgPSB0aGlzLnBvaW50c1sgc3RhcnRJbmRleCBdO1xyXG5cclxuICAgICAgICAvLyBGb3IgbXV0YW50IHBsb3RzIChkcmF3biB3aXRoIGEgbGluZURhc2gpLCBhZGp1c3QgbGluZURhc2hPZmZzZXQgc28gdGhhdCB0aGUgZGFzaCBhcHBlYXJzIHRvIHNjcm9sbC5cclxuICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy8xMTFcclxuICAgICAgICBpZiAoIHRoaXMuaXNEYXNoZWQgJiYgdGhpcy5wb2ludHMubGVuZ3RoID4gMCApIHtcclxuICAgICAgICAgIGNvbnN0IHhSZW1haW5kZXJNb2RlbCA9IHN0YXJ0UG9pbnQueCAlIDE7XHJcbiAgICAgICAgICBjb25zdCB4UmVtYWluZGVyVmlldyA9IHRoaXMubW9kZWxUb1ZpZXdYKCB4UmVtYWluZGVyTW9kZWwgKTtcclxuICAgICAgICAgIHRoaXMuc3RlcFBhdGgubGluZURhc2hPZmZzZXQgPSAtKCB4UmVtYWluZGVyVmlldyAlIE1VVEFOVF9MSU5FX0RBU0hfU1VNICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBQbG90IHRoZSBzdGFydCBwb2ludCwgaWYgaXQncyB3aXRoaW4gdGhlIHggcmFuZ2Ugb2YgdGhlIGdyaWQuXHJcbiAgICAgICAgY29uc3Qgc3RhcnRYVmlldyA9IHRoaXMubW9kZWxUb1ZpZXdYKCBNYXRoLm1heCggc3RhcnRQb2ludC54LCB0aGlzLnhSYW5nZVByb3BlcnR5LnZhbHVlLm1pbiApICk7XHJcbiAgICAgICAgY29uc3Qgc3RhcnRZVmlldyA9IHRoaXMubW9kZWxUb1ZpZXdZKCBzdGFydFBvaW50LnkgKTtcclxuICAgICAgICBpZiAoIHN0YXJ0UG9pbnQueCA+PSB0aGlzLnhSYW5nZVByb3BlcnR5LnZhbHVlLm1pbiApIHtcclxuICAgICAgICAgIHBvaW50c1NoYXBlLmNpcmNsZSggc3RhcnRYVmlldywgc3RhcnRZVmlldywgTmF0dXJhbFNlbGVjdGlvbkNvbnN0YW50cy5QT1BVTEFUSU9OX1BPSU5UX1JBRElVUyApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzdGVwU2hhcGUubW92ZVRvKCBzdGFydFhWaWV3LCBzdGFydFlWaWV3ICk7XHJcblxyXG4gICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIHByZXZpb3VzIHBvaW50IHRoYXQgd2FzIHBsb3R0ZWQuXHJcbiAgICAgICAgbGV0IHByZXZpb3VzUG9pbnQgPSBzdGFydFBvaW50O1xyXG5cclxuICAgICAgICAvLyBTdGFydGluZyB3aXRoIHRoZSBuZXh0IHBvaW50LCBwbG90IGZyb20gbGVmdCB0byByaWdodC5cclxuICAgICAgICBmb3IgKCBsZXQgaSA9IHN0YXJ0SW5kZXggKyAxOyBpIDwgbnVtYmVyT2ZQb2ludHM7IGkrKyApIHtcclxuXHJcbiAgICAgICAgICBjb25zdCBwb2ludCA9IHRoaXMucG9pbnRzWyBpIF07XHJcblxyXG4gICAgICAgICAgaWYgKCBwb2ludC54IDw9IHRoaXMueFJhbmdlUHJvcGVydHkudmFsdWUubWF4ICkge1xyXG5cclxuICAgICAgICAgICAgLy8gQ29tcHV0ZSB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgICAgICAgICAgIGNvbnN0IHhWaWV3ID0gdGhpcy5tb2RlbFRvVmlld1goIHBvaW50LnggKTtcclxuICAgICAgICAgICAgY29uc3QgeVZpZXcgPSB0aGlzLm1vZGVsVG9WaWV3WSggcG9pbnQueSApO1xyXG4gICAgICAgICAgICBjb25zdCB5Vmlld1ByZXZpb3VzID0gdGhpcy5tb2RlbFRvVmlld1koIHByZXZpb3VzUG9pbnQueSApO1xyXG5cclxuICAgICAgICAgICAgLy8gUGxvdCB0aGUgcG9pbnRcclxuICAgICAgICAgICAgcG9pbnRzU2hhcGUuY2lyY2xlKCB4VmlldywgeVZpZXcsIE5hdHVyYWxTZWxlY3Rpb25Db25zdGFudHMuUE9QVUxBVElPTl9QT0lOVF9SQURJVVMgKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFBsb3QgdGhlIGxpbmUgc2VnbWVudHNcclxuICAgICAgICAgICAgc3RlcFNoYXBlLmxpbmVUbyggeFZpZXcsIHlWaWV3UHJldmlvdXMgKTsgLy8gaG9yaXpvbnRhbCBsaW5lIGZyb20gdGhlIHByZXZpb3VzIHBvaW50XHJcbiAgICAgICAgICAgIHN0ZXBTaGFwZS5saW5lVG8oIHhWaWV3LCB5VmlldyApOyAvLyB2ZXJ0aWNhbCBsaW5lIHRvIHRoZSBjdXJyZW50IHBvaW50XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgIC8vIEV4dGVuZCB0aGUgcGxvdCBmcm9tIHByZXZpb3VzUG9pbnQgdG8gdGhlIHJpZ2h0IGVkZ2Ugb2YgdGhlIGdyaWQuXHJcbiAgICAgICAgICAgIGNvbnN0IHhWaWV3TWF4ID0gdGhpcy5tb2RlbFRvVmlld1goIHRoaXMueFJhbmdlUHJvcGVydHkudmFsdWUubWF4ICk7XHJcbiAgICAgICAgICAgIGNvbnN0IHlWaWV3UHJldmlvdXMgPSB0aGlzLm1vZGVsVG9WaWV3WSggcHJldmlvdXNQb2ludC55ICk7XHJcbiAgICAgICAgICAgIHN0ZXBTaGFwZS5saW5lVG8oIHhWaWV3TWF4LCB5Vmlld1ByZXZpb3VzICk7IC8vIGhvcml6b250YWwgbGluZSBmcm9tIHRoZSBwcmV2aW91cyBwb2ludFxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHByZXZpb3VzUG9pbnQgPSBwb2ludDtcclxuXHJcbiAgICAgICAgICAvLyBCYWlsIG91dCBpZiB3aGVuIHdlIHJlYWNoIHRoZSByaWdodCBlZGdlIG9mIGdyaWQuXHJcbiAgICAgICAgICBpZiAoIHBvaW50LnggPj0gdGhpcy54UmFuZ2VQcm9wZXJ0eS52YWx1ZS5tYXggKSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUGxvdCBmcm9tIHByZXZpb3VzUG9pbnQgdG8gY3VycmVudCBnZW5lcmF0aW9uIHRpbWVcclxuICAgICAgICBpZiAoICggcHJldmlvdXNQb2ludC54IDwgdGhpcy54UmFuZ2VQcm9wZXJ0eS52YWx1ZS5tYXggKSAmJiAoIHByZXZpb3VzUG9pbnQueCA8IHRoaXMudGltZUluR2VuZXJhdGlvbnNQcm9wZXJ0eS52YWx1ZSApICkge1xyXG4gICAgICAgICAgY29uc3QgeFZpZXcgPSB0aGlzLm1vZGVsVG9WaWV3WCggdGhpcy50aW1lSW5HZW5lcmF0aW9uc1Byb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgICAgICBjb25zdCB5VmlldyA9IHRoaXMubW9kZWxUb1ZpZXdZKCBwcmV2aW91c1BvaW50LnkgKTtcclxuICAgICAgICAgIHN0ZXBTaGFwZS5saW5lVG8oIHhWaWV3LCB5VmlldyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5wb2ludHNQYXRoLnNldFNoYXBlKCBwb2ludHNTaGFwZSApO1xyXG4gICAgICB0aGlzLnN0ZXBQYXRoLnNldFNoYXBlKCBzdGVwU2hhcGUgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsZWFycyB0aGUgcGxvdC4gV2hpbGUgYSBwbG90IGlzIGludmlzaWJsZSwgaXQgaXMgbm90IHVwZGF0ZWQuICBTbyB3aGVuIGEgcGxvdCBpcyBtYWRlIGludmlzaWJsZSwgaXQgbXVzdFxyXG4gICAqIGFsc28gYmUgY2xlYXJlZC4gVGhpcyBpcyBpbXBvcnRhbnQgYmVjYXVzZSBib3VuZHMgYXJlIHVzZWQgdG8gZGVjaWRlIGlmIHRoZSBncmFwaCBpcyBkaXNwbGF5aW5nIGRhdGEsIGFuZFxyXG4gICAqIHdoZXRoZXIgdGhlIFwiWm9vbSBvdXQgdG8gc2hvdyBkYXRhXCIgbWVzc2FnZSBzaG91bGQgYmUgZGlzcGxheWVkLiAgQm91bmRzIGNvbXB1dGF0aW9uIGluY2x1ZGVzIGludmlzaWJsZSBOb2RlcyxcclxuICAgKiBhbmQgaWYgdGhlIHBsb3Qgc3RpbGwgY29udGFpbnMgZ2VvbWV0cnksIHRoZW4gaXQgd2lsbCBiZSBpbmNvcnJlY3RseSBjb250cmlidXRpbmcgdG8gYm91bmRzLlxyXG4gICAqIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvbmF0dXJhbC1zZWxlY3Rpb24vaXNzdWVzLzIwOVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xlYXJQbG90KCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb2ludHNQYXRoLnNldFNoYXBlKCBudWxsICk7XHJcbiAgICB0aGlzLnN0ZXBQYXRoLnNldFNoYXBlKCBudWxsICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNb2RlbC12aWV3IHRyYW5zZm9ybSBmb3IgeC1heGlzLlxyXG4gICAqIEBwYXJhbSB4TW9kZWwgLSB4IG1vZGVsIHZhbHVlLCBpbiBnZW5lcmF0aW9uc1xyXG4gICAqIEByZXR1cm5zIHggdmlldyB2YWx1ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbW9kZWxUb1ZpZXdYKCB4TW9kZWw6IG51bWJlciApOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JpZFdpZHRoICogKCB4TW9kZWwgLSB0aGlzLnhSYW5nZVByb3BlcnR5LnZhbHVlLm1pbiApIC8gKCB0aGlzLnhSYW5nZVByb3BlcnR5LnZhbHVlLm1heCAtIHRoaXMueFJhbmdlUHJvcGVydHkudmFsdWUubWluICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNb2RlbC12aWV3IHRyYW5zZm9ybSBmb3IgeS1heGlzLiBUaGUgeS1heGlzIGlzIGludmVydGVkICgreSB1cCBpbiBtb2RlbCwgK3kgZG93biBpbiB2aWV3KS5cclxuICAgKiBAcGFyYW0geU1vZGVsIC0geSBtb2RlbCB2YWx1ZSwgcG9wdWxhdGlvblxyXG4gICAqIEByZXR1cm5zIHkgdmlldyB2YWx1ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbW9kZWxUb1ZpZXdZKCB5TW9kZWw6IG51bWJlciApOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JpZEhlaWdodCAtIHRoaXMuZ3JpZEhlaWdodCAqICggeU1vZGVsIC0gdGhpcy55UmFuZ2VQcm9wZXJ0eS52YWx1ZS5taW4gKSAvICggdGhpcy55UmFuZ2VQcm9wZXJ0eS52YWx1ZS5tYXggLSB0aGlzLnlSYW5nZVByb3BlcnR5LnZhbHVlLm1pbiApO1xyXG4gIH1cclxufVxyXG5cclxubmF0dXJhbFNlbGVjdGlvbi5yZWdpc3RlciggJ1BvcHVsYXRpb25QbG90Tm9kZScsIFBvcHVsYXRpb25QbG90Tm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FB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