// Copyright 2019-2022, University of Colorado Boulder

/**
 * DataProbeNode displays population (y-axis) values for a specific generation (x-axis) value.
 * It can be dragged along the x-axis. The origin is at the top center of barNode.
 * Historical information and requirements can be found in https://github.com/phetsims/natural-selection/issues/14.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import DerivedProperty from '../../../../../axon/js/DerivedProperty.js';
import Property from '../../../../../axon/js/Property.js';
import Bounds2 from '../../../../../dot/js/Bounds2.js';
import Range from '../../../../../dot/js/Range.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import { Shape } from '../../../../../kite/js/imports.js';
import optionize, { optionize4 } from '../../../../../phet-core/js/optionize.js';
import ModelViewTransform2 from '../../../../../phetcommon/js/view/ModelViewTransform2.js';
import NumberDisplay from '../../../../../scenery-phet/js/NumberDisplay.js';
import PhetFont from '../../../../../scenery-phet/js/PhetFont.js';
import ShadedSphereNode from '../../../../../scenery-phet/js/ShadedSphereNode.js';
import { Color, DragListener, HStrut, Node, Rectangle, VBox, VStrut } from '../../../../../scenery/js/imports.js';
import Tandem from '../../../../../tandem/js/Tandem.js';
import naturalSelection from '../../../naturalSelection.js';
import NaturalSelectionColors from '../../NaturalSelectionColors.js';
import NaturalSelectionQueryParameters from '../../NaturalSelectionQueryParameters.js';

// Options to createNumberDisplay function

// constants
const MANIPULATOR_RADIUS = 7;
const NUMBER_DISPLAY_RANGE = new Range(0, 10 * NaturalSelectionQueryParameters.maxPopulation);
const NUMBER_DISPLAY_BACKGROUND_FILL_OPACITY = 0.7;
const NUMBER_DISPLAY_DEFAULTS = {
  textOptions: {
    font: new PhetFont(12)
  },
  backgroundLineWidth: 2,
  noValueAlign: 'center'
};
export default class DataProbeNode extends Node {
  constructor(populationModel, providedOptions) {
    const options = optionize()({
      // SelfOptions
      gridWidth: 100,
      gridHeight: 100,
      offset: Vector2.ZERO,
      // NodeOptions
      cursor: 'ew-resize' // east-west arrows, <->
    }, providedOptions);
    const dataProbe = populationModel.dataProbe;
    options.visibleProperty = dataProbe.visibleProperty;

    // Transform for data probe offset from the top-left of the grid
    const offsetTransform = ModelViewTransform2.createOffsetScaleMapping(options.offset, options.gridWidth / populationModel.xAxisLength);

    // Which side of the bar the displays are on: true = right, false = left
    let displaysOnRight = true;

    // Vertical bar
    const barNode = new Rectangle(0, 0, 3, options.gridHeight, {
      fill: NaturalSelectionColors.DATA_PROBE_BAR_COLOR,
      opacity: 0.6,
      centerX: 0,
      y: 0
    });
    barNode.mouseArea = barNode.localBounds.dilatedXY(5, 0);
    barNode.touchArea = barNode.localBounds.dilatedXY(10, 0);

    // Manipulator at bottom of the bar
    const manipulator = new ShadedSphereNode(2 * MANIPULATOR_RADIUS, {
      mainColor: NaturalSelectionColors.DATA_PROBE_MANIPULATOR_COLOR,
      mouseArea: Shape.circle(0, 0, 2 * MANIPULATOR_RADIUS),
      touchArea: Shape.circle(0, 0, 2 * MANIPULATOR_RADIUS),
      centerX: barNode.centerX,
      centerY: barNode.bottom
    });

    // NumberDisplay instances
    const genePool = populationModel.genePool;
    const totalDisplay = createSolidNumberDisplay(dataProbe.countsProperty, 'totalCount', NaturalSelectionColors.POPULATION_TOTAL_COUNT, populationModel.totalVisibleProperty);
    const whiteFurDisplay = createSolidNumberDisplay(dataProbe.countsProperty, 'whiteFurCount', genePool.furGene.color, populationModel.whiteFurVisibleProperty);
    const brownFurDisplay = createDashedNumberDisplay(dataProbe.countsProperty, 'brownFurCount', genePool.furGene.color, populationModel.brownFurVisibleProperty);
    const straightEarsDisplay = createSolidNumberDisplay(dataProbe.countsProperty, 'straightEarsCount', genePool.earsGene.color, populationModel.straightEarsVisibleProperty);
    const floppyEarsDisplay = createDashedNumberDisplay(dataProbe.countsProperty, 'floppyEarsCount', genePool.earsGene.color, populationModel.floppyEarsVisibleProperty);
    const shortTeethDisplay = createSolidNumberDisplay(dataProbe.countsProperty, 'shortTeethCount', genePool.teethGene.color, populationModel.shortTeethVisibleProperty);
    const longTeethDisplay = createDashedNumberDisplay(dataProbe.countsProperty, 'longTeethCount', genePool.teethGene.color, populationModel.longTeethVisibleProperty);

    // vertical layout of NumberDisplays 
    const numberDisplaysParent = new VBox({
      spacing: 3,
      align: 'left',
      children: [new VStrut(5),
      // a bit of space at the top
      new HStrut(totalDisplay.width),
      // so that numberDisplaysParent always has consistent non-zero width
      totalDisplay, whiteFurDisplay, brownFurDisplay, straightEarsDisplay, floppyEarsDisplay, shortTeethDisplay, longTeethDisplay],
      top: barNode.top
    });
    assert && assert(!options.children, 'DataProbeNode sets children');
    options.children = [barNode, manipulator, numberDisplaysParent];
    super(options);

    // removeInputListener is not necessary
    this.addInputListener(new DragListener({
      positionProperty: dataProbe.offsetProperty,
      transform: offsetTransform,
      dragBoundsProperty: new Property(new Bounds2(0, 0, populationModel.xAxisLength, 0)),
      // model coordinates
      tandem: options.tandem.createTandem('dragListener')
    }));

    // Interrupt interaction when visibility changes.
    this.visibleProperty.link(visible => this.interruptSubtreeInput());

    // Flip NumberDisplays around the y-axis at edges of the graph, so that they stay inside the bounds of the graph.
    // unlink is not necessary.
    dataProbe.offsetProperty.link(offset => {
      this.x = offsetTransform.modelToViewPosition(offset).x;

      // flip NumberDisplays around y-axis at edges of graph
      if (this.left < options.offset.x && !displaysOnRight) {
        displaysOnRight = true;
        numberDisplaysParent.left = barNode.right;
      } else if (this.right > +options.offset.x + options.gridWidth && displaysOnRight) {
        displaysOnRight = false;
        numberDisplaysParent.right = barNode.left;
      }
    });

    // Create a Studio link to the model
    this.addLinkedElement(dataProbe, {
      tandem: options.tandem.createTandem('dataProbe')
    });
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
    super.dispose();
  }
}

/**
 * Creates a NumberDisplay whose background is filled with a solid color.  This is used for normal allele counts.
 */
function createSolidNumberDisplay(bunnyCountsProperty, bunnyCountsFieldName, color, visibleProperty) {
  const colorWithAlpha = Color.toColor(color).withAlpha(NUMBER_DISPLAY_BACKGROUND_FILL_OPACITY);
  return createNumberDisplay(bunnyCountsProperty, bunnyCountsFieldName, {
    visibleProperty: visibleProperty,
    backgroundFill: colorWithAlpha,
    backgroundStroke: colorWithAlpha
  });
}

/**
 * Creates a NumberDisplay whose background is stroked with a dashed line. This is used for mutant allele counts.
 */
function createDashedNumberDisplay(bunnyCountsProperty, bunnyCountsFieldName, color, visibleProperty) {
  return createNumberDisplay(bunnyCountsProperty, bunnyCountsFieldName, {
    visibleProperty: visibleProperty,
    backgroundFill: new Color(255, 255, 255, NUMBER_DISPLAY_BACKGROUND_FILL_OPACITY),
    backgroundStroke: color,
    backgroundLineDash: [3, 3]
  });
}

/**
 * Creates a NumberDisplay for the data probe.
 */
function createNumberDisplay(bunnyCountsProperty, bunnyCountsFieldName, providedOptions) {
  const options = optionize4()({}, NUMBER_DISPLAY_DEFAULTS, {
    backgroundFill: 'white'
  }, providedOptions);

  // Set the text fill based on whether the background color is dark or light.
  if (!options.textOptions || options.textOptions.fill === undefined) {
    options.textOptions = options.textOptions || {};
    options.textOptions.fill = Color.isDarkColor(options.backgroundFill) ? 'white' : 'black';
  }

  // Adapter Property, for interfacing with NumberDisplay. dispose is not necessary.
  const countProperty = new DerivedProperty([bunnyCountsProperty], bunnyCounts => {
    if (bunnyCounts) {
      const count = bunnyCounts[bunnyCountsFieldName];
      assert && assert(typeof count === 'number'); // eslint-disable-line no-simple-type-checking-assertions
      return count;
    } else {
      return null;
    }
  }, {
    tandem: Tandem.OPT_OUT
  });
  const numberDisplay = new NumberDisplay(countProperty, NUMBER_DISPLAY_RANGE, options);

  // Set non-dilated pointer areas so that they will be rendered by ?showPointerAreas.
  numberDisplay.touchArea = numberDisplay.localBounds.dilated(0);
  numberDisplay.mouseArea = numberDisplay.localBounds.dilated(0);
  return numberDisplay;
}
naturalSelection.register('DataProbeNode', DataProbeNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJQcm9wZXJ0eSIsIkJvdW5kczIiLCJSYW5nZSIsIlZlY3RvcjIiLCJTaGFwZSIsIm9wdGlvbml6ZSIsIm9wdGlvbml6ZTQiLCJNb2RlbFZpZXdUcmFuc2Zvcm0yIiwiTnVtYmVyRGlzcGxheSIsIlBoZXRGb250IiwiU2hhZGVkU3BoZXJlTm9kZSIsIkNvbG9yIiwiRHJhZ0xpc3RlbmVyIiwiSFN0cnV0IiwiTm9kZSIsIlJlY3RhbmdsZSIsIlZCb3giLCJWU3RydXQiLCJUYW5kZW0iLCJuYXR1cmFsU2VsZWN0aW9uIiwiTmF0dXJhbFNlbGVjdGlvbkNvbG9ycyIsIk5hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMiLCJNQU5JUFVMQVRPUl9SQURJVVMiLCJOVU1CRVJfRElTUExBWV9SQU5HRSIsIm1heFBvcHVsYXRpb24iLCJOVU1CRVJfRElTUExBWV9CQUNLR1JPVU5EX0ZJTExfT1BBQ0lUWSIsIk5VTUJFUl9ESVNQTEFZX0RFRkFVTFRTIiwidGV4dE9wdGlvbnMiLCJmb250IiwiYmFja2dyb3VuZExpbmVXaWR0aCIsIm5vVmFsdWVBbGlnbiIsIkRhdGFQcm9iZU5vZGUiLCJjb25zdHJ1Y3RvciIsInBvcHVsYXRpb25Nb2RlbCIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJncmlkV2lkdGgiLCJncmlkSGVpZ2h0Iiwib2Zmc2V0IiwiWkVSTyIsImN1cnNvciIsImRhdGFQcm9iZSIsInZpc2libGVQcm9wZXJ0eSIsIm9mZnNldFRyYW5zZm9ybSIsImNyZWF0ZU9mZnNldFNjYWxlTWFwcGluZyIsInhBeGlzTGVuZ3RoIiwiZGlzcGxheXNPblJpZ2h0IiwiYmFyTm9kZSIsImZpbGwiLCJEQVRBX1BST0JFX0JBUl9DT0xPUiIsIm9wYWNpdHkiLCJjZW50ZXJYIiwieSIsIm1vdXNlQXJlYSIsImxvY2FsQm91bmRzIiwiZGlsYXRlZFhZIiwidG91Y2hBcmVhIiwibWFuaXB1bGF0b3IiLCJtYWluQ29sb3IiLCJEQVRBX1BST0JFX01BTklQVUxBVE9SX0NPTE9SIiwiY2lyY2xlIiwiY2VudGVyWSIsImJvdHRvbSIsImdlbmVQb29sIiwidG90YWxEaXNwbGF5IiwiY3JlYXRlU29saWROdW1iZXJEaXNwbGF5IiwiY291bnRzUHJvcGVydHkiLCJQT1BVTEFUSU9OX1RPVEFMX0NPVU5UIiwidG90YWxWaXNpYmxlUHJvcGVydHkiLCJ3aGl0ZUZ1ckRpc3BsYXkiLCJmdXJHZW5lIiwiY29sb3IiLCJ3aGl0ZUZ1clZpc2libGVQcm9wZXJ0eSIsImJyb3duRnVyRGlzcGxheSIsImNyZWF0ZURhc2hlZE51bWJlckRpc3BsYXkiLCJicm93bkZ1clZpc2libGVQcm9wZXJ0eSIsInN0cmFpZ2h0RWFyc0Rpc3BsYXkiLCJlYXJzR2VuZSIsInN0cmFpZ2h0RWFyc1Zpc2libGVQcm9wZXJ0eSIsImZsb3BweUVhcnNEaXNwbGF5IiwiZmxvcHB5RWFyc1Zpc2libGVQcm9wZXJ0eSIsInNob3J0VGVldGhEaXNwbGF5IiwidGVldGhHZW5lIiwic2hvcnRUZWV0aFZpc2libGVQcm9wZXJ0eSIsImxvbmdUZWV0aERpc3BsYXkiLCJsb25nVGVldGhWaXNpYmxlUHJvcGVydHkiLCJudW1iZXJEaXNwbGF5c1BhcmVudCIsInNwYWNpbmciLCJhbGlnbiIsImNoaWxkcmVuIiwid2lkdGgiLCJ0b3AiLCJhc3NlcnQiLCJhZGRJbnB1dExpc3RlbmVyIiwicG9zaXRpb25Qcm9wZXJ0eSIsIm9mZnNldFByb3BlcnR5IiwidHJhbnNmb3JtIiwiZHJhZ0JvdW5kc1Byb3BlcnR5IiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwibGluayIsInZpc2libGUiLCJpbnRlcnJ1cHRTdWJ0cmVlSW5wdXQiLCJ4IiwibW9kZWxUb1ZpZXdQb3NpdGlvbiIsImxlZnQiLCJyaWdodCIsImFkZExpbmtlZEVsZW1lbnQiLCJkaXNwb3NlIiwiYnVubnlDb3VudHNQcm9wZXJ0eSIsImJ1bm55Q291bnRzRmllbGROYW1lIiwiY29sb3JXaXRoQWxwaGEiLCJ0b0NvbG9yIiwid2l0aEFscGhhIiwiY3JlYXRlTnVtYmVyRGlzcGxheSIsImJhY2tncm91bmRGaWxsIiwiYmFja2dyb3VuZFN0cm9rZSIsImJhY2tncm91bmRMaW5lRGFzaCIsInVuZGVmaW5lZCIsImlzRGFya0NvbG9yIiwiY291bnRQcm9wZXJ0eSIsImJ1bm55Q291bnRzIiwiY291bnQiLCJPUFRfT1VUIiwibnVtYmVyRGlzcGxheSIsImRpbGF0ZWQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkRhdGFQcm9iZU5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGF0YVByb2JlTm9kZSBkaXNwbGF5cyBwb3B1bGF0aW9uICh5LWF4aXMpIHZhbHVlcyBmb3IgYSBzcGVjaWZpYyBnZW5lcmF0aW9uICh4LWF4aXMpIHZhbHVlLlxyXG4gKiBJdCBjYW4gYmUgZHJhZ2dlZCBhbG9uZyB0aGUgeC1heGlzLiBUaGUgb3JpZ2luIGlzIGF0IHRoZSB0b3AgY2VudGVyIG9mIGJhck5vZGUuXHJcbiAqIEhpc3RvcmljYWwgaW5mb3JtYXRpb24gYW5kIHJlcXVpcmVtZW50cyBjYW4gYmUgZm91bmQgaW4gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy8xNC5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgRGVyaXZlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uLy4uL2F4b24vanMvRGVyaXZlZFByb3BlcnR5LmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHsgU2hhcGUgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9raXRlL2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IEVtcHR5U2VsZk9wdGlvbnMsIG9wdGlvbml6ZTQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgTW9kZWxWaWV3VHJhbnNmb3JtMiBmcm9tICcuLi8uLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3ZpZXcvTW9kZWxWaWV3VHJhbnNmb3JtMi5qcyc7XHJcbmltcG9ydCBOdW1iZXJEaXNwbGF5LCB7IE51bWJlckRpc3BsYXlPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL051bWJlckRpc3BsYXkuanMnO1xyXG5pbXBvcnQgUGhldEZvbnQgZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1BoZXRGb250LmpzJztcclxuaW1wb3J0IFNoYWRlZFNwaGVyZU5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1NoYWRlZFNwaGVyZU5vZGUuanMnO1xyXG5pbXBvcnQgeyBDb2xvciwgRHJhZ0xpc3RlbmVyLCBIU3RydXQsIE5vZGUsIE5vZGVPcHRpb25zLCBSZWN0YW5nbGUsIFRDb2xvciwgVkJveCwgVlN0cnV0IH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IG5hdHVyYWxTZWxlY3Rpb24gZnJvbSAnLi4vLi4vLi4vbmF0dXJhbFNlbGVjdGlvbi5qcyc7XHJcbmltcG9ydCBCdW5ueUNvdW50cyBmcm9tICcuLi8uLi9tb2RlbC9CdW5ueUNvdW50cy5qcyc7XHJcbmltcG9ydCBQb3B1bGF0aW9uTW9kZWwgZnJvbSAnLi4vLi4vbW9kZWwvUG9wdWxhdGlvbk1vZGVsLmpzJztcclxuaW1wb3J0IE5hdHVyYWxTZWxlY3Rpb25Db2xvcnMgZnJvbSAnLi4vLi4vTmF0dXJhbFNlbGVjdGlvbkNvbG9ycy5qcyc7XHJcbmltcG9ydCBOYXR1cmFsU2VsZWN0aW9uUXVlcnlQYXJhbWV0ZXJzIGZyb20gJy4uLy4uL05hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5cclxuLy8gT3B0aW9ucyB0byBjcmVhdGVOdW1iZXJEaXNwbGF5IGZ1bmN0aW9uXHJcbnR5cGUgQ3JlYXRlTnVtYmVyRGlzcGxheU9wdGlvbnMgPSB7XHJcbiAgYmFja2dyb3VuZEZpbGw/OiBDb2xvciB8IHN0cmluZztcclxufSAmIFN0cmljdE9taXQ8TnVtYmVyRGlzcGxheU9wdGlvbnMsICdiYWNrZ3JvdW5kRmlsbCc+O1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IE1BTklQVUxBVE9SX1JBRElVUyA9IDc7XHJcbmNvbnN0IE5VTUJFUl9ESVNQTEFZX1JBTkdFID0gbmV3IFJhbmdlKCAwLCAxMCAqIE5hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMubWF4UG9wdWxhdGlvbiApO1xyXG5jb25zdCBOVU1CRVJfRElTUExBWV9CQUNLR1JPVU5EX0ZJTExfT1BBQ0lUWSA9IDAuNztcclxuY29uc3QgTlVNQkVSX0RJU1BMQVlfREVGQVVMVFM6IENyZWF0ZU51bWJlckRpc3BsYXlPcHRpb25zID0ge1xyXG4gIHRleHRPcHRpb25zOiB7XHJcbiAgICBmb250OiBuZXcgUGhldEZvbnQoIDEyIClcclxuICB9LFxyXG4gIGJhY2tncm91bmRMaW5lV2lkdGg6IDIsXHJcbiAgbm9WYWx1ZUFsaWduOiAnY2VudGVyJ1xyXG59O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuXHJcbiAgLy8gZGltZW5zaW9ucyBvZiB0aGUgZ3JpZCAoc2FucyB0aWNrIG1hcmtzKSBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgZ3JpZFdpZHRoPzogbnVtYmVyO1xyXG4gIGdyaWRIZWlnaHQ/OiBudW1iZXI7XHJcblxyXG4gIC8vIG9mZnNldCBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgb2Zmc2V0PzogVmVjdG9yMjtcclxufTtcclxuXHJcbnR5cGUgRGF0YVByb2JlTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tSZXF1aXJlZDxOb2RlT3B0aW9ucywgJ3RhbmRlbSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGF0YVByb2JlTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHBvcHVsYXRpb25Nb2RlbDogUG9wdWxhdGlvbk1vZGVsLCBwcm92aWRlZE9wdGlvbnM6IERhdGFQcm9iZU5vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8RGF0YVByb2JlTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBOb2RlT3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgZ3JpZFdpZHRoOiAxMDAsXHJcbiAgICAgIGdyaWRIZWlnaHQ6IDEwMCxcclxuICAgICAgb2Zmc2V0OiBWZWN0b3IyLlpFUk8sXHJcblxyXG4gICAgICAvLyBOb2RlT3B0aW9uc1xyXG4gICAgICBjdXJzb3I6ICdldy1yZXNpemUnIC8vIGVhc3Qtd2VzdCBhcnJvd3MsIDwtPlxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgZGF0YVByb2JlID0gcG9wdWxhdGlvbk1vZGVsLmRhdGFQcm9iZTtcclxuXHJcbiAgICBvcHRpb25zLnZpc2libGVQcm9wZXJ0eSA9IGRhdGFQcm9iZS52aXNpYmxlUHJvcGVydHk7XHJcblxyXG4gICAgLy8gVHJhbnNmb3JtIGZvciBkYXRhIHByb2JlIG9mZnNldCBmcm9tIHRoZSB0b3AtbGVmdCBvZiB0aGUgZ3JpZFxyXG4gICAgY29uc3Qgb2Zmc2V0VHJhbnNmb3JtID1cclxuICAgICAgTW9kZWxWaWV3VHJhbnNmb3JtMi5jcmVhdGVPZmZzZXRTY2FsZU1hcHBpbmcoIG9wdGlvbnMub2Zmc2V0LCBvcHRpb25zLmdyaWRXaWR0aCAvIHBvcHVsYXRpb25Nb2RlbC54QXhpc0xlbmd0aCApO1xyXG5cclxuICAgIC8vIFdoaWNoIHNpZGUgb2YgdGhlIGJhciB0aGUgZGlzcGxheXMgYXJlIG9uOiB0cnVlID0gcmlnaHQsIGZhbHNlID0gbGVmdFxyXG4gICAgbGV0IGRpc3BsYXlzT25SaWdodCA9IHRydWU7XHJcblxyXG4gICAgLy8gVmVydGljYWwgYmFyXHJcbiAgICBjb25zdCBiYXJOb2RlID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMywgb3B0aW9ucy5ncmlkSGVpZ2h0LCB7XHJcbiAgICAgIGZpbGw6IE5hdHVyYWxTZWxlY3Rpb25Db2xvcnMuREFUQV9QUk9CRV9CQVJfQ09MT1IsXHJcbiAgICAgIG9wYWNpdHk6IDAuNixcclxuICAgICAgY2VudGVyWDogMCxcclxuICAgICAgeTogMFxyXG4gICAgfSApO1xyXG4gICAgYmFyTm9kZS5tb3VzZUFyZWEgPSBiYXJOb2RlLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggNSwgMCApO1xyXG4gICAgYmFyTm9kZS50b3VjaEFyZWEgPSBiYXJOb2RlLmxvY2FsQm91bmRzLmRpbGF0ZWRYWSggMTAsIDAgKTtcclxuXHJcbiAgICAvLyBNYW5pcHVsYXRvciBhdCBib3R0b20gb2YgdGhlIGJhclxyXG4gICAgY29uc3QgbWFuaXB1bGF0b3IgPSBuZXcgU2hhZGVkU3BoZXJlTm9kZSggMiAqIE1BTklQVUxBVE9SX1JBRElVUywge1xyXG4gICAgICBtYWluQ29sb3I6IE5hdHVyYWxTZWxlY3Rpb25Db2xvcnMuREFUQV9QUk9CRV9NQU5JUFVMQVRPUl9DT0xPUixcclxuICAgICAgbW91c2VBcmVhOiBTaGFwZS5jaXJjbGUoIDAsIDAsIDIgKiBNQU5JUFVMQVRPUl9SQURJVVMgKSxcclxuICAgICAgdG91Y2hBcmVhOiBTaGFwZS5jaXJjbGUoIDAsIDAsIDIgKiBNQU5JUFVMQVRPUl9SQURJVVMgKSxcclxuICAgICAgY2VudGVyWDogYmFyTm9kZS5jZW50ZXJYLFxyXG4gICAgICBjZW50ZXJZOiBiYXJOb2RlLmJvdHRvbVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE51bWJlckRpc3BsYXkgaW5zdGFuY2VzXHJcbiAgICBjb25zdCBnZW5lUG9vbCA9IHBvcHVsYXRpb25Nb2RlbC5nZW5lUG9vbDtcclxuICAgIGNvbnN0IHRvdGFsRGlzcGxheSA9IGNyZWF0ZVNvbGlkTnVtYmVyRGlzcGxheSggZGF0YVByb2JlLmNvdW50c1Byb3BlcnR5LCAndG90YWxDb3VudCcsXHJcbiAgICAgIE5hdHVyYWxTZWxlY3Rpb25Db2xvcnMuUE9QVUxBVElPTl9UT1RBTF9DT1VOVCwgcG9wdWxhdGlvbk1vZGVsLnRvdGFsVmlzaWJsZVByb3BlcnR5ICk7XHJcbiAgICBjb25zdCB3aGl0ZUZ1ckRpc3BsYXkgPSBjcmVhdGVTb2xpZE51bWJlckRpc3BsYXkoIGRhdGFQcm9iZS5jb3VudHNQcm9wZXJ0eSwgJ3doaXRlRnVyQ291bnQnLFxyXG4gICAgICBnZW5lUG9vbC5mdXJHZW5lLmNvbG9yLCBwb3B1bGF0aW9uTW9kZWwud2hpdGVGdXJWaXNpYmxlUHJvcGVydHkgKTtcclxuICAgIGNvbnN0IGJyb3duRnVyRGlzcGxheSA9IGNyZWF0ZURhc2hlZE51bWJlckRpc3BsYXkoIGRhdGFQcm9iZS5jb3VudHNQcm9wZXJ0eSwgJ2Jyb3duRnVyQ291bnQnLFxyXG4gICAgICBnZW5lUG9vbC5mdXJHZW5lLmNvbG9yLCBwb3B1bGF0aW9uTW9kZWwuYnJvd25GdXJWaXNpYmxlUHJvcGVydHkgKTtcclxuICAgIGNvbnN0IHN0cmFpZ2h0RWFyc0Rpc3BsYXkgPSBjcmVhdGVTb2xpZE51bWJlckRpc3BsYXkoIGRhdGFQcm9iZS5jb3VudHNQcm9wZXJ0eSwgJ3N0cmFpZ2h0RWFyc0NvdW50JyxcclxuICAgICAgZ2VuZVBvb2wuZWFyc0dlbmUuY29sb3IsIHBvcHVsYXRpb25Nb2RlbC5zdHJhaWdodEVhcnNWaXNpYmxlUHJvcGVydHkgKTtcclxuICAgIGNvbnN0IGZsb3BweUVhcnNEaXNwbGF5ID0gY3JlYXRlRGFzaGVkTnVtYmVyRGlzcGxheSggZGF0YVByb2JlLmNvdW50c1Byb3BlcnR5LCAnZmxvcHB5RWFyc0NvdW50JyxcclxuICAgICAgZ2VuZVBvb2wuZWFyc0dlbmUuY29sb3IsIHBvcHVsYXRpb25Nb2RlbC5mbG9wcHlFYXJzVmlzaWJsZVByb3BlcnR5ICk7XHJcbiAgICBjb25zdCBzaG9ydFRlZXRoRGlzcGxheSA9IGNyZWF0ZVNvbGlkTnVtYmVyRGlzcGxheSggZGF0YVByb2JlLmNvdW50c1Byb3BlcnR5LCAnc2hvcnRUZWV0aENvdW50JyxcclxuICAgICAgZ2VuZVBvb2wudGVldGhHZW5lLmNvbG9yLCBwb3B1bGF0aW9uTW9kZWwuc2hvcnRUZWV0aFZpc2libGVQcm9wZXJ0eSApO1xyXG4gICAgY29uc3QgbG9uZ1RlZXRoRGlzcGxheSA9IGNyZWF0ZURhc2hlZE51bWJlckRpc3BsYXkoIGRhdGFQcm9iZS5jb3VudHNQcm9wZXJ0eSwgJ2xvbmdUZWV0aENvdW50JyxcclxuICAgICAgZ2VuZVBvb2wudGVldGhHZW5lLmNvbG9yLCBwb3B1bGF0aW9uTW9kZWwubG9uZ1RlZXRoVmlzaWJsZVByb3BlcnR5ICk7XHJcblxyXG4gICAgLy8gdmVydGljYWwgbGF5b3V0IG9mIE51bWJlckRpc3BsYXlzIFxyXG4gICAgY29uc3QgbnVtYmVyRGlzcGxheXNQYXJlbnQgPSBuZXcgVkJveCgge1xyXG4gICAgICBzcGFjaW5nOiAzLFxyXG4gICAgICBhbGlnbjogJ2xlZnQnLFxyXG4gICAgICBjaGlsZHJlbjogW1xyXG4gICAgICAgIG5ldyBWU3RydXQoIDUgKSwgLy8gYSBiaXQgb2Ygc3BhY2UgYXQgdGhlIHRvcFxyXG4gICAgICAgIG5ldyBIU3RydXQoIHRvdGFsRGlzcGxheS53aWR0aCApLCAvLyBzbyB0aGF0IG51bWJlckRpc3BsYXlzUGFyZW50IGFsd2F5cyBoYXMgY29uc2lzdGVudCBub24temVybyB3aWR0aFxyXG4gICAgICAgIHRvdGFsRGlzcGxheSxcclxuICAgICAgICB3aGl0ZUZ1ckRpc3BsYXksIGJyb3duRnVyRGlzcGxheSxcclxuICAgICAgICBzdHJhaWdodEVhcnNEaXNwbGF5LCBmbG9wcHlFYXJzRGlzcGxheSxcclxuICAgICAgICBzaG9ydFRlZXRoRGlzcGxheSwgbG9uZ1RlZXRoRGlzcGxheVxyXG4gICAgICBdLFxyXG4gICAgICB0b3A6IGJhck5vZGUudG9wXHJcbiAgICB9ICk7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggIW9wdGlvbnMuY2hpbGRyZW4sICdEYXRhUHJvYmVOb2RlIHNldHMgY2hpbGRyZW4nICk7XHJcbiAgICBvcHRpb25zLmNoaWxkcmVuID0gWyBiYXJOb2RlLCBtYW5pcHVsYXRvciwgbnVtYmVyRGlzcGxheXNQYXJlbnQgXTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIHJlbW92ZUlucHV0TGlzdGVuZXIgaXMgbm90IG5lY2Vzc2FyeVxyXG4gICAgdGhpcy5hZGRJbnB1dExpc3RlbmVyKCBuZXcgRHJhZ0xpc3RlbmVyKCB7XHJcbiAgICAgIHBvc2l0aW9uUHJvcGVydHk6IGRhdGFQcm9iZS5vZmZzZXRQcm9wZXJ0eSxcclxuICAgICAgdHJhbnNmb3JtOiBvZmZzZXRUcmFuc2Zvcm0sXHJcbiAgICAgIGRyYWdCb3VuZHNQcm9wZXJ0eTogbmV3IFByb3BlcnR5KCBuZXcgQm91bmRzMiggMCwgMCwgcG9wdWxhdGlvbk1vZGVsLnhBeGlzTGVuZ3RoLCAwICkgKSwgLy8gbW9kZWwgY29vcmRpbmF0ZXNcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdkcmFnTGlzdGVuZXInIClcclxuICAgIH0gKSApO1xyXG5cclxuICAgIC8vIEludGVycnVwdCBpbnRlcmFjdGlvbiB3aGVuIHZpc2liaWxpdHkgY2hhbmdlcy5cclxuICAgIHRoaXMudmlzaWJsZVByb3BlcnR5LmxpbmsoIHZpc2libGUgPT4gdGhpcy5pbnRlcnJ1cHRTdWJ0cmVlSW5wdXQoKSApO1xyXG5cclxuICAgIC8vIEZsaXAgTnVtYmVyRGlzcGxheXMgYXJvdW5kIHRoZSB5LWF4aXMgYXQgZWRnZXMgb2YgdGhlIGdyYXBoLCBzbyB0aGF0IHRoZXkgc3RheSBpbnNpZGUgdGhlIGJvdW5kcyBvZiB0aGUgZ3JhcGguXHJcbiAgICAvLyB1bmxpbmsgaXMgbm90IG5lY2Vzc2FyeS5cclxuICAgIGRhdGFQcm9iZS5vZmZzZXRQcm9wZXJ0eS5saW5rKCBvZmZzZXQgPT4ge1xyXG5cclxuICAgICAgdGhpcy54ID0gb2Zmc2V0VHJhbnNmb3JtLm1vZGVsVG9WaWV3UG9zaXRpb24oIG9mZnNldCApLng7XHJcblxyXG4gICAgICAvLyBmbGlwIE51bWJlckRpc3BsYXlzIGFyb3VuZCB5LWF4aXMgYXQgZWRnZXMgb2YgZ3JhcGhcclxuICAgICAgaWYgKCB0aGlzLmxlZnQgPCBvcHRpb25zLm9mZnNldC54ICYmICFkaXNwbGF5c09uUmlnaHQgKSB7XHJcbiAgICAgICAgZGlzcGxheXNPblJpZ2h0ID0gdHJ1ZTtcclxuICAgICAgICBudW1iZXJEaXNwbGF5c1BhcmVudC5sZWZ0ID0gYmFyTm9kZS5yaWdodDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIGlmICggdGhpcy5yaWdodCA+ICtvcHRpb25zLm9mZnNldC54ICsgb3B0aW9ucy5ncmlkV2lkdGggJiYgZGlzcGxheXNPblJpZ2h0ICkge1xyXG4gICAgICAgIGRpc3BsYXlzT25SaWdodCA9IGZhbHNlO1xyXG4gICAgICAgIG51bWJlckRpc3BsYXlzUGFyZW50LnJpZ2h0ID0gYmFyTm9kZS5sZWZ0O1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIGEgU3R1ZGlvIGxpbmsgdG8gdGhlIG1vZGVsXHJcbiAgICB0aGlzLmFkZExpbmtlZEVsZW1lbnQoIGRhdGFQcm9iZSwge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2RhdGFQcm9iZScgKVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDcmVhdGVzIGEgTnVtYmVyRGlzcGxheSB3aG9zZSBiYWNrZ3JvdW5kIGlzIGZpbGxlZCB3aXRoIGEgc29saWQgY29sb3IuICBUaGlzIGlzIHVzZWQgZm9yIG5vcm1hbCBhbGxlbGUgY291bnRzLlxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlU29saWROdW1iZXJEaXNwbGF5KCBidW5ueUNvdW50c1Byb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxCdW5ueUNvdW50cyB8IG51bGw+LCBidW5ueUNvdW50c0ZpZWxkTmFtZTogc3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBUQ29sb3IsIHZpc2libGVQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj4gKTogTnVtYmVyRGlzcGxheSB7XHJcbiAgY29uc3QgY29sb3JXaXRoQWxwaGEgPSBDb2xvci50b0NvbG9yKCBjb2xvciApLndpdGhBbHBoYSggTlVNQkVSX0RJU1BMQVlfQkFDS0dST1VORF9GSUxMX09QQUNJVFkgKTtcclxuICByZXR1cm4gY3JlYXRlTnVtYmVyRGlzcGxheSggYnVubnlDb3VudHNQcm9wZXJ0eSwgYnVubnlDb3VudHNGaWVsZE5hbWUsIHtcclxuICAgIHZpc2libGVQcm9wZXJ0eTogdmlzaWJsZVByb3BlcnR5LFxyXG4gICAgYmFja2dyb3VuZEZpbGw6IGNvbG9yV2l0aEFscGhhLFxyXG4gICAgYmFja2dyb3VuZFN0cm9rZTogY29sb3JXaXRoQWxwaGFcclxuICB9ICk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDcmVhdGVzIGEgTnVtYmVyRGlzcGxheSB3aG9zZSBiYWNrZ3JvdW5kIGlzIHN0cm9rZWQgd2l0aCBhIGRhc2hlZCBsaW5lLiBUaGlzIGlzIHVzZWQgZm9yIG11dGFudCBhbGxlbGUgY291bnRzLlxyXG4gKi9cclxuZnVuY3Rpb24gY3JlYXRlRGFzaGVkTnVtYmVyRGlzcGxheSggYnVubnlDb3VudHNQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8QnVubnlDb3VudHMgfCBudWxsPiwgYnVubnlDb3VudHNGaWVsZE5hbWU6IHN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IFRDb2xvciwgdmlzaWJsZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxib29sZWFuPiApOiBOdW1iZXJEaXNwbGF5IHtcclxuICByZXR1cm4gY3JlYXRlTnVtYmVyRGlzcGxheSggYnVubnlDb3VudHNQcm9wZXJ0eSwgYnVubnlDb3VudHNGaWVsZE5hbWUsIHtcclxuICAgIHZpc2libGVQcm9wZXJ0eTogdmlzaWJsZVByb3BlcnR5LFxyXG4gICAgYmFja2dyb3VuZEZpbGw6IG5ldyBDb2xvciggMjU1LCAyNTUsIDI1NSwgTlVNQkVSX0RJU1BMQVlfQkFDS0dST1VORF9GSUxMX09QQUNJVFkgKSxcclxuICAgIGJhY2tncm91bmRTdHJva2U6IGNvbG9yLFxyXG4gICAgYmFja2dyb3VuZExpbmVEYXNoOiBbIDMsIDMgXVxyXG4gIH0gKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYSBOdW1iZXJEaXNwbGF5IGZvciB0aGUgZGF0YSBwcm9iZS5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZU51bWJlckRpc3BsYXkoIGJ1bm55Q291bnRzUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEJ1bm55Q291bnRzIHwgbnVsbD4sIGJ1bm55Q291bnRzRmllbGROYW1lOiBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IENyZWF0ZU51bWJlckRpc3BsYXlPcHRpb25zICk6IE51bWJlckRpc3BsYXkge1xyXG5cclxuICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplNDxDcmVhdGVOdW1iZXJEaXNwbGF5T3B0aW9ucywgRW1wdHlTZWxmT3B0aW9ucywgQ3JlYXRlTnVtYmVyRGlzcGxheU9wdGlvbnM+KCkoXHJcbiAgICB7fSwgTlVNQkVSX0RJU1BMQVlfREVGQVVMVFMsIHtcclxuICAgICAgYmFja2dyb3VuZEZpbGw6ICd3aGl0ZSdcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAvLyBTZXQgdGhlIHRleHQgZmlsbCBiYXNlZCBvbiB3aGV0aGVyIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIGlzIGRhcmsgb3IgbGlnaHQuXHJcbiAgaWYgKCAhb3B0aW9ucy50ZXh0T3B0aW9ucyB8fCBvcHRpb25zLnRleHRPcHRpb25zLmZpbGwgPT09IHVuZGVmaW5lZCApIHtcclxuICAgIG9wdGlvbnMudGV4dE9wdGlvbnMgPSBvcHRpb25zLnRleHRPcHRpb25zIHx8IHt9O1xyXG4gICAgb3B0aW9ucy50ZXh0T3B0aW9ucy5maWxsID0gQ29sb3IuaXNEYXJrQ29sb3IoIG9wdGlvbnMuYmFja2dyb3VuZEZpbGwgKSA/ICd3aGl0ZScgOiAnYmxhY2snO1xyXG4gIH1cclxuXHJcbiAgLy8gQWRhcHRlciBQcm9wZXJ0eSwgZm9yIGludGVyZmFjaW5nIHdpdGggTnVtYmVyRGlzcGxheS4gZGlzcG9zZSBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gIGNvbnN0IGNvdW50UHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIGJ1bm55Q291bnRzUHJvcGVydHkgXSxcclxuICAgIGJ1bm55Q291bnRzID0+IHtcclxuICAgICAgaWYgKCBidW5ueUNvdW50cyApIHtcclxuICAgICAgICB0eXBlIEJ1bm55Q291bnRLZXkgPSBrZXlvZiB0eXBlb2YgYnVubnlDb3VudHM7XHJcbiAgICAgICAgY29uc3QgY291bnQgPSBidW5ueUNvdW50c1sgYnVubnlDb3VudHNGaWVsZE5hbWUgYXMgQnVubnlDb3VudEtleSBdIGFzIG51bWJlcjtcclxuICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0eXBlb2YgY291bnQgPT09ICdudW1iZXInICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2ltcGxlLXR5cGUtY2hlY2tpbmctYXNzZXJ0aW9uc1xyXG4gICAgICAgIHJldHVybiBjb3VudDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfSwge1xyXG4gICAgICB0YW5kZW06IFRhbmRlbS5PUFRfT1VUXHJcbiAgICB9ICk7XHJcblxyXG4gIGNvbnN0IG51bWJlckRpc3BsYXkgPSBuZXcgTnVtYmVyRGlzcGxheSggY291bnRQcm9wZXJ0eSwgTlVNQkVSX0RJU1BMQVlfUkFOR0UsIG9wdGlvbnMgKTtcclxuXHJcbiAgLy8gU2V0IG5vbi1kaWxhdGVkIHBvaW50ZXIgYXJlYXMgc28gdGhhdCB0aGV5IHdpbGwgYmUgcmVuZGVyZWQgYnkgP3Nob3dQb2ludGVyQXJlYXMuXHJcbiAgbnVtYmVyRGlzcGxheS50b3VjaEFyZWEgPSBudW1iZXJEaXNwbGF5LmxvY2FsQm91bmRzLmRpbGF0ZWQoIDAgKTtcclxuICBudW1iZXJEaXNwbGF5Lm1vdXNlQXJlYSA9IG51bWJlckRpc3BsYXkubG9jYWxCb3VuZHMuZGlsYXRlZCggMCApO1xyXG5cclxuICByZXR1cm4gbnVtYmVyRGlzcGxheTtcclxufVxyXG5cclxubmF0dXJhbFNlbGVjdGlvbi5yZWdpc3RlciggJ0RhdGFQcm9iZU5vZGUnLCBEYXRhUHJvYmVOb2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0sMkNBQTJDO0FBQ3ZFLE9BQU9DLFFBQVEsTUFBTSxvQ0FBb0M7QUFFekQsT0FBT0MsT0FBTyxNQUFNLGtDQUFrQztBQUN0RCxPQUFPQyxLQUFLLE1BQU0sZ0NBQWdDO0FBQ2xELE9BQU9DLE9BQU8sTUFBTSxrQ0FBa0M7QUFDdEQsU0FBU0MsS0FBSyxRQUFRLG1DQUFtQztBQUN6RCxPQUFPQyxTQUFTLElBQXNCQyxVQUFVLFFBQVEsMENBQTBDO0FBR2xHLE9BQU9DLG1CQUFtQixNQUFNLDBEQUEwRDtBQUMxRixPQUFPQyxhQUFhLE1BQWdDLGlEQUFpRDtBQUNyRyxPQUFPQyxRQUFRLE1BQU0sNENBQTRDO0FBQ2pFLE9BQU9DLGdCQUFnQixNQUFNLG9EQUFvRDtBQUNqRixTQUFTQyxLQUFLLEVBQUVDLFlBQVksRUFBRUMsTUFBTSxFQUFFQyxJQUFJLEVBQWVDLFNBQVMsRUFBVUMsSUFBSSxFQUFFQyxNQUFNLFFBQVEsc0NBQXNDO0FBQ3RJLE9BQU9DLE1BQU0sTUFBTSxvQ0FBb0M7QUFDdkQsT0FBT0MsZ0JBQWdCLE1BQU0sOEJBQThCO0FBRzNELE9BQU9DLHNCQUFzQixNQUFNLGlDQUFpQztBQUNwRSxPQUFPQywrQkFBK0IsTUFBTSwwQ0FBMEM7O0FBRXRGOztBQUtBO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsQ0FBQztBQUM1QixNQUFNQyxvQkFBb0IsR0FBRyxJQUFJckIsS0FBSyxDQUFFLENBQUMsRUFBRSxFQUFFLEdBQUdtQiwrQkFBK0IsQ0FBQ0csYUFBYyxDQUFDO0FBQy9GLE1BQU1DLHNDQUFzQyxHQUFHLEdBQUc7QUFDbEQsTUFBTUMsdUJBQW1ELEdBQUc7RUFDMURDLFdBQVcsRUFBRTtJQUNYQyxJQUFJLEVBQUUsSUFBSW5CLFFBQVEsQ0FBRSxFQUFHO0VBQ3pCLENBQUM7RUFDRG9CLG1CQUFtQixFQUFFLENBQUM7RUFDdEJDLFlBQVksRUFBRTtBQUNoQixDQUFDO0FBY0QsZUFBZSxNQUFNQyxhQUFhLFNBQVNqQixJQUFJLENBQUM7RUFFdkNrQixXQUFXQSxDQUFFQyxlQUFnQyxFQUFFQyxlQUFxQyxFQUFHO0lBRTVGLE1BQU1DLE9BQU8sR0FBRzlCLFNBQVMsQ0FBaUQsQ0FBQyxDQUFFO01BRTNFO01BQ0ErQixTQUFTLEVBQUUsR0FBRztNQUNkQyxVQUFVLEVBQUUsR0FBRztNQUNmQyxNQUFNLEVBQUVuQyxPQUFPLENBQUNvQyxJQUFJO01BRXBCO01BQ0FDLE1BQU0sRUFBRSxXQUFXLENBQUM7SUFDdEIsQ0FBQyxFQUFFTixlQUFnQixDQUFDO0lBRXBCLE1BQU1PLFNBQVMsR0FBR1IsZUFBZSxDQUFDUSxTQUFTO0lBRTNDTixPQUFPLENBQUNPLGVBQWUsR0FBR0QsU0FBUyxDQUFDQyxlQUFlOztJQUVuRDtJQUNBLE1BQU1DLGVBQWUsR0FDbkJwQyxtQkFBbUIsQ0FBQ3FDLHdCQUF3QixDQUFFVCxPQUFPLENBQUNHLE1BQU0sRUFBRUgsT0FBTyxDQUFDQyxTQUFTLEdBQUdILGVBQWUsQ0FBQ1ksV0FBWSxDQUFDOztJQUVqSDtJQUNBLElBQUlDLGVBQWUsR0FBRyxJQUFJOztJQUUxQjtJQUNBLE1BQU1DLE9BQU8sR0FBRyxJQUFJaEMsU0FBUyxDQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFb0IsT0FBTyxDQUFDRSxVQUFVLEVBQUU7TUFDMURXLElBQUksRUFBRTVCLHNCQUFzQixDQUFDNkIsb0JBQW9CO01BQ2pEQyxPQUFPLEVBQUUsR0FBRztNQUNaQyxPQUFPLEVBQUUsQ0FBQztNQUNWQyxDQUFDLEVBQUU7SUFDTCxDQUFFLENBQUM7SUFDSEwsT0FBTyxDQUFDTSxTQUFTLEdBQUdOLE9BQU8sQ0FBQ08sV0FBVyxDQUFDQyxTQUFTLENBQUUsQ0FBQyxFQUFFLENBQUUsQ0FBQztJQUN6RFIsT0FBTyxDQUFDUyxTQUFTLEdBQUdULE9BQU8sQ0FBQ08sV0FBVyxDQUFDQyxTQUFTLENBQUUsRUFBRSxFQUFFLENBQUUsQ0FBQzs7SUFFMUQ7SUFDQSxNQUFNRSxXQUFXLEdBQUcsSUFBSS9DLGdCQUFnQixDQUFFLENBQUMsR0FBR1ksa0JBQWtCLEVBQUU7TUFDaEVvQyxTQUFTLEVBQUV0QyxzQkFBc0IsQ0FBQ3VDLDRCQUE0QjtNQUM5RE4sU0FBUyxFQUFFakQsS0FBSyxDQUFDd0QsTUFBTSxDQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHdEMsa0JBQW1CLENBQUM7TUFDdkRrQyxTQUFTLEVBQUVwRCxLQUFLLENBQUN3RCxNQUFNLENBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUd0QyxrQkFBbUIsQ0FBQztNQUN2RDZCLE9BQU8sRUFBRUosT0FBTyxDQUFDSSxPQUFPO01BQ3hCVSxPQUFPLEVBQUVkLE9BQU8sQ0FBQ2U7SUFDbkIsQ0FBRSxDQUFDOztJQUVIO0lBQ0EsTUFBTUMsUUFBUSxHQUFHOUIsZUFBZSxDQUFDOEIsUUFBUTtJQUN6QyxNQUFNQyxZQUFZLEdBQUdDLHdCQUF3QixDQUFFeEIsU0FBUyxDQUFDeUIsY0FBYyxFQUFFLFlBQVksRUFDbkY5QyxzQkFBc0IsQ0FBQytDLHNCQUFzQixFQUFFbEMsZUFBZSxDQUFDbUMsb0JBQXFCLENBQUM7SUFDdkYsTUFBTUMsZUFBZSxHQUFHSix3QkFBd0IsQ0FBRXhCLFNBQVMsQ0FBQ3lCLGNBQWMsRUFBRSxlQUFlLEVBQ3pGSCxRQUFRLENBQUNPLE9BQU8sQ0FBQ0MsS0FBSyxFQUFFdEMsZUFBZSxDQUFDdUMsdUJBQXdCLENBQUM7SUFDbkUsTUFBTUMsZUFBZSxHQUFHQyx5QkFBeUIsQ0FBRWpDLFNBQVMsQ0FBQ3lCLGNBQWMsRUFBRSxlQUFlLEVBQzFGSCxRQUFRLENBQUNPLE9BQU8sQ0FBQ0MsS0FBSyxFQUFFdEMsZUFBZSxDQUFDMEMsdUJBQXdCLENBQUM7SUFDbkUsTUFBTUMsbUJBQW1CLEdBQUdYLHdCQUF3QixDQUFFeEIsU0FBUyxDQUFDeUIsY0FBYyxFQUFFLG1CQUFtQixFQUNqR0gsUUFBUSxDQUFDYyxRQUFRLENBQUNOLEtBQUssRUFBRXRDLGVBQWUsQ0FBQzZDLDJCQUE0QixDQUFDO0lBQ3hFLE1BQU1DLGlCQUFpQixHQUFHTCx5QkFBeUIsQ0FBRWpDLFNBQVMsQ0FBQ3lCLGNBQWMsRUFBRSxpQkFBaUIsRUFDOUZILFFBQVEsQ0FBQ2MsUUFBUSxDQUFDTixLQUFLLEVBQUV0QyxlQUFlLENBQUMrQyx5QkFBMEIsQ0FBQztJQUN0RSxNQUFNQyxpQkFBaUIsR0FBR2hCLHdCQUF3QixDQUFFeEIsU0FBUyxDQUFDeUIsY0FBYyxFQUFFLGlCQUFpQixFQUM3RkgsUUFBUSxDQUFDbUIsU0FBUyxDQUFDWCxLQUFLLEVBQUV0QyxlQUFlLENBQUNrRCx5QkFBMEIsQ0FBQztJQUN2RSxNQUFNQyxnQkFBZ0IsR0FBR1YseUJBQXlCLENBQUVqQyxTQUFTLENBQUN5QixjQUFjLEVBQUUsZ0JBQWdCLEVBQzVGSCxRQUFRLENBQUNtQixTQUFTLENBQUNYLEtBQUssRUFBRXRDLGVBQWUsQ0FBQ29ELHdCQUF5QixDQUFDOztJQUV0RTtJQUNBLE1BQU1DLG9CQUFvQixHQUFHLElBQUl0RSxJQUFJLENBQUU7TUFDckN1RSxPQUFPLEVBQUUsQ0FBQztNQUNWQyxLQUFLLEVBQUUsTUFBTTtNQUNiQyxRQUFRLEVBQUUsQ0FDUixJQUFJeEUsTUFBTSxDQUFFLENBQUUsQ0FBQztNQUFFO01BQ2pCLElBQUlKLE1BQU0sQ0FBRW1ELFlBQVksQ0FBQzBCLEtBQU0sQ0FBQztNQUFFO01BQ2xDMUIsWUFBWSxFQUNaSyxlQUFlLEVBQUVJLGVBQWUsRUFDaENHLG1CQUFtQixFQUFFRyxpQkFBaUIsRUFDdENFLGlCQUFpQixFQUFFRyxnQkFBZ0IsQ0FDcEM7TUFDRE8sR0FBRyxFQUFFNUMsT0FBTyxDQUFDNEM7SUFDZixDQUFFLENBQUM7SUFFSEMsTUFBTSxJQUFJQSxNQUFNLENBQUUsQ0FBQ3pELE9BQU8sQ0FBQ3NELFFBQVEsRUFBRSw2QkFBOEIsQ0FBQztJQUNwRXRELE9BQU8sQ0FBQ3NELFFBQVEsR0FBRyxDQUFFMUMsT0FBTyxFQUFFVSxXQUFXLEVBQUU2QixvQkFBb0IsQ0FBRTtJQUVqRSxLQUFLLENBQUVuRCxPQUFRLENBQUM7O0lBRWhCO0lBQ0EsSUFBSSxDQUFDMEQsZ0JBQWdCLENBQUUsSUFBSWpGLFlBQVksQ0FBRTtNQUN2Q2tGLGdCQUFnQixFQUFFckQsU0FBUyxDQUFDc0QsY0FBYztNQUMxQ0MsU0FBUyxFQUFFckQsZUFBZTtNQUMxQnNELGtCQUFrQixFQUFFLElBQUlqRyxRQUFRLENBQUUsSUFBSUMsT0FBTyxDQUFFLENBQUMsRUFBRSxDQUFDLEVBQUVnQyxlQUFlLENBQUNZLFdBQVcsRUFBRSxDQUFFLENBQUUsQ0FBQztNQUFFO01BQ3pGcUQsTUFBTSxFQUFFL0QsT0FBTyxDQUFDK0QsTUFBTSxDQUFDQyxZQUFZLENBQUUsY0FBZTtJQUN0RCxDQUFFLENBQUUsQ0FBQzs7SUFFTDtJQUNBLElBQUksQ0FBQ3pELGVBQWUsQ0FBQzBELElBQUksQ0FBRUMsT0FBTyxJQUFJLElBQUksQ0FBQ0MscUJBQXFCLENBQUMsQ0FBRSxDQUFDOztJQUVwRTtJQUNBO0lBQ0E3RCxTQUFTLENBQUNzRCxjQUFjLENBQUNLLElBQUksQ0FBRTlELE1BQU0sSUFBSTtNQUV2QyxJQUFJLENBQUNpRSxDQUFDLEdBQUc1RCxlQUFlLENBQUM2RCxtQkFBbUIsQ0FBRWxFLE1BQU8sQ0FBQyxDQUFDaUUsQ0FBQzs7TUFFeEQ7TUFDQSxJQUFLLElBQUksQ0FBQ0UsSUFBSSxHQUFHdEUsT0FBTyxDQUFDRyxNQUFNLENBQUNpRSxDQUFDLElBQUksQ0FBQ3pELGVBQWUsRUFBRztRQUN0REEsZUFBZSxHQUFHLElBQUk7UUFDdEJ3QyxvQkFBb0IsQ0FBQ21CLElBQUksR0FBRzFELE9BQU8sQ0FBQzJELEtBQUs7TUFDM0MsQ0FBQyxNQUNJLElBQUssSUFBSSxDQUFDQSxLQUFLLEdBQUcsQ0FBQ3ZFLE9BQU8sQ0FBQ0csTUFBTSxDQUFDaUUsQ0FBQyxHQUFHcEUsT0FBTyxDQUFDQyxTQUFTLElBQUlVLGVBQWUsRUFBRztRQUNoRkEsZUFBZSxHQUFHLEtBQUs7UUFDdkJ3QyxvQkFBb0IsQ0FBQ29CLEtBQUssR0FBRzNELE9BQU8sQ0FBQzBELElBQUk7TUFDM0M7SUFDRixDQUFFLENBQUM7O0lBRUg7SUFDQSxJQUFJLENBQUNFLGdCQUFnQixDQUFFbEUsU0FBUyxFQUFFO01BQ2hDeUQsTUFBTSxFQUFFL0QsT0FBTyxDQUFDK0QsTUFBTSxDQUFDQyxZQUFZLENBQUUsV0FBWTtJQUNuRCxDQUFFLENBQUM7RUFDTDtFQUVnQlMsT0FBT0EsQ0FBQSxFQUFTO0lBQzlCaEIsTUFBTSxJQUFJQSxNQUFNLENBQUUsS0FBSyxFQUFFLDhEQUErRCxDQUFDO0lBQ3pGLEtBQUssQ0FBQ2dCLE9BQU8sQ0FBQyxDQUFDO0VBQ2pCO0FBQ0Y7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsU0FBUzNDLHdCQUF3QkEsQ0FBRTRDLG1CQUEwRCxFQUFFQyxvQkFBNEIsRUFDeEZ2QyxLQUFhLEVBQUU3QixlQUEyQyxFQUFrQjtFQUM3RyxNQUFNcUUsY0FBYyxHQUFHcEcsS0FBSyxDQUFDcUcsT0FBTyxDQUFFekMsS0FBTSxDQUFDLENBQUMwQyxTQUFTLENBQUV4RixzQ0FBdUMsQ0FBQztFQUNqRyxPQUFPeUYsbUJBQW1CLENBQUVMLG1CQUFtQixFQUFFQyxvQkFBb0IsRUFBRTtJQUNyRXBFLGVBQWUsRUFBRUEsZUFBZTtJQUNoQ3lFLGNBQWMsRUFBRUosY0FBYztJQUM5QkssZ0JBQWdCLEVBQUVMO0VBQ3BCLENBQUUsQ0FBQztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBLFNBQVNyQyx5QkFBeUJBLENBQUVtQyxtQkFBMEQsRUFBRUMsb0JBQTRCLEVBQ3hGdkMsS0FBYSxFQUFFN0IsZUFBMkMsRUFBa0I7RUFDOUcsT0FBT3dFLG1CQUFtQixDQUFFTCxtQkFBbUIsRUFBRUMsb0JBQW9CLEVBQUU7SUFDckVwRSxlQUFlLEVBQUVBLGVBQWU7SUFDaEN5RSxjQUFjLEVBQUUsSUFBSXhHLEtBQUssQ0FBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRWMsc0NBQXVDLENBQUM7SUFDbEYyRixnQkFBZ0IsRUFBRTdDLEtBQUs7SUFDdkI4QyxrQkFBa0IsRUFBRSxDQUFFLENBQUMsRUFBRSxDQUFDO0VBQzVCLENBQUUsQ0FBQztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBLFNBQVNILG1CQUFtQkEsQ0FBRUwsbUJBQTBELEVBQUVDLG9CQUE0QixFQUN4RjVFLGVBQTRDLEVBQWtCO0VBRTFGLE1BQU1DLE9BQU8sR0FBRzdCLFVBQVUsQ0FBMkUsQ0FBQyxDQUNwRyxDQUFDLENBQUMsRUFBRW9CLHVCQUF1QixFQUFFO0lBQzNCeUYsY0FBYyxFQUFFO0VBQ2xCLENBQUMsRUFBRWpGLGVBQWdCLENBQUM7O0VBRXRCO0VBQ0EsSUFBSyxDQUFDQyxPQUFPLENBQUNSLFdBQVcsSUFBSVEsT0FBTyxDQUFDUixXQUFXLENBQUNxQixJQUFJLEtBQUtzRSxTQUFTLEVBQUc7SUFDcEVuRixPQUFPLENBQUNSLFdBQVcsR0FBR1EsT0FBTyxDQUFDUixXQUFXLElBQUksQ0FBQyxDQUFDO0lBQy9DUSxPQUFPLENBQUNSLFdBQVcsQ0FBQ3FCLElBQUksR0FBR3JDLEtBQUssQ0FBQzRHLFdBQVcsQ0FBRXBGLE9BQU8sQ0FBQ2dGLGNBQWUsQ0FBQyxHQUFHLE9BQU8sR0FBRyxPQUFPO0VBQzVGOztFQUVBO0VBQ0EsTUFBTUssYUFBYSxHQUFHLElBQUl6SCxlQUFlLENBQUUsQ0FBRThHLG1CQUFtQixDQUFFLEVBQ2hFWSxXQUFXLElBQUk7SUFDYixJQUFLQSxXQUFXLEVBQUc7TUFFakIsTUFBTUMsS0FBSyxHQUFHRCxXQUFXLENBQUVYLG9CQUFvQixDQUE2QjtNQUM1RWxCLE1BQU0sSUFBSUEsTUFBTSxDQUFFLE9BQU84QixLQUFLLEtBQUssUUFBUyxDQUFDLENBQUMsQ0FBQztNQUMvQyxPQUFPQSxLQUFLO0lBQ2QsQ0FBQyxNQUNJO01BQ0gsT0FBTyxJQUFJO0lBQ2I7RUFDRixDQUFDLEVBQUU7SUFDRHhCLE1BQU0sRUFBRWhGLE1BQU0sQ0FBQ3lHO0VBQ2pCLENBQUUsQ0FBQztFQUVMLE1BQU1DLGFBQWEsR0FBRyxJQUFJcEgsYUFBYSxDQUFFZ0gsYUFBYSxFQUFFakcsb0JBQW9CLEVBQUVZLE9BQVEsQ0FBQzs7RUFFdkY7RUFDQXlGLGFBQWEsQ0FBQ3BFLFNBQVMsR0FBR29FLGFBQWEsQ0FBQ3RFLFdBQVcsQ0FBQ3VFLE9BQU8sQ0FBRSxDQUFFLENBQUM7RUFDaEVELGFBQWEsQ0FBQ3ZFLFNBQVMsR0FBR3VFLGFBQWEsQ0FBQ3RFLFdBQVcsQ0FBQ3VFLE9BQU8sQ0FBRSxDQUFFLENBQUM7RUFFaEUsT0FBT0QsYUFBYTtBQUN0QjtBQUVBekcsZ0JBQWdCLENBQUMyRyxRQUFRLENBQUUsZUFBZSxFQUFFL0YsYUFBYyxDQUFDIn0=