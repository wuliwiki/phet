// Copyright 2020-2022, University of Colorado Boulder

/**
 * BunnyImageMap maps a bunny to a visual representation that corresponds to its phenotype.
 * The visual representation can be a Sprite (for use in OrganismSprites) or a Node (for use in the Pedigree graph).
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import { combineOptions } from '../../../../phet-core/js/optionize.js';
import { AlignBox, AlignGroup, Image, Node, Sprite } from '../../../../scenery/js/imports.js';
import bunnyBrownFurFloppyEarsLongTeeth_png from '../../../images/bunnyBrownFurFloppyEarsLongTeeth_png.js';
import bunnyBrownFurFloppyEarsShortTeeth_png from '../../../images/bunnyBrownFurFloppyEarsShortTeeth_png.js';
import bunnyBrownFurStraightEarsLongTeeth_png from '../../../images/bunnyBrownFurStraightEarsLongTeeth_png.js';
import bunnyBrownFurStraightEarsShortTeeth_png from '../../../images/bunnyBrownFurStraightEarsShortTeeth_png.js';
import bunnyWhiteFurFloppyEarsLongTeeth_png from '../../../images/bunnyWhiteFurFloppyEarsLongTeeth_png.js';
import bunnyWhiteFurFloppyEarsShortTeeth_png from '../../../images/bunnyWhiteFurFloppyEarsShortTeeth_png.js';
import bunnyWhiteFurStraightEarsLongTeeth_png from '../../../images/bunnyWhiteFurStraightEarsLongTeeth_png.js';
import bunnyWhiteFurStraightEarsShortTeeth_png from '../../../images/bunnyWhiteFurStraightEarsShortTeeth_png.js';
import naturalSelection from '../../naturalSelection.js';
import BunnySpriteImage from './environment/BunnySpriteImage.js';

// Keys for all maps herein. See getKey().

export default class BunnyImageMap {
  // Sprites for each bunny phenotype, used in OrganismSprites. Uses the same keys as const imageMap.

  // Nodes for each bunny phenotype, used in the Pedigree graph. Uses the same keys as const imageMap.
  // All of these Nodes have the same origin and effective size.
  constructor() {
    // Maps a bunny's phenotype to an HTMLImageElement.
    // This map is not static because the images need to be loaded before they can be used by SpriteImage.
    const imageMap = new Map();
    imageMap.set('true-true-true', bunnyWhiteFurStraightEarsShortTeeth_png);
    imageMap.set('true-true-false', bunnyWhiteFurStraightEarsLongTeeth_png);
    imageMap.set('true-false-true', bunnyWhiteFurFloppyEarsShortTeeth_png);
    imageMap.set('true-false-false', bunnyWhiteFurFloppyEarsLongTeeth_png);
    imageMap.set('false-true-true', bunnyBrownFurStraightEarsShortTeeth_png);
    imageMap.set('false-true-false', bunnyBrownFurStraightEarsLongTeeth_png);
    imageMap.set('false-false-true', bunnyBrownFurFloppyEarsShortTeeth_png);
    imageMap.set('false-false-false', bunnyBrownFurFloppyEarsLongTeeth_png);
    assert && assert(imageMap.size === 8, 'imageMap is incomplete');

    // Create a Sprite for each entry in imageMap.
    this.spriteMap = new Map();
    imageMap.forEach((htmlImageElement, key) => this.spriteMap.set(key, new Sprite(new BunnySpriteImage(htmlImageElement))));

    // Hit test on non-transparent pixels, to make it easier to select overlapping bunnies.
    // See https://github.com/phetsims/natural-selection/issues/63
    const imageOptions = {
      hitTestPixels: true
    };

    // Make all Nodes have the same origin and effective dimensions.
    const alignBoxOptions = {
      xAlign: 'center',
      yAlign: 'bottom',
      group: new AlignGroup()
    };

    // Create a Node for each entry in imageMap.
    this.nodeMap = new Map();
    imageMap.forEach((htmlImageElement, key) => this.nodeMap.set(key, new AlignBox(new Image(htmlImageElement, imageOptions), alignBoxOptions)));
  }

  /**
   * Gets the complete set of Sprites for all bunny phenotypes.
   */
  getSprites() {
    return Array.from(this.spriteMap.values());
  }

  /**
   * Gets the Sprite that matches a bunny's phenotype, for use in OrganismSprites.
   */
  getSprite(bunny) {
    // Create the key that corresponds to the bunny's phenotype.
    const key = getKey(bunny);

    // Look up the Sprite in the map.
    const sprite = this.spriteMap.get(key);
    assert && assert(sprite, `no sprite found for key ${key}`);
    return sprite;
  }

  /**
   * Gets the Node that matches a bunny's phenotype, for use in the Pedigree graph. Since this Node is used in multiple
   * places in scenery's DAG, the Node is wrapped with another Node, so that it can be transformed without causing
   * problems.
   */
  getNode(bunny, providedOptions) {
    const options = combineOptions({}, providedOptions);

    // Create the key that corresponds to the bunny's phenotype.
    const key = getKey(bunny);

    // Look up the Node in the map.
    const node = this.nodeMap.get(key);
    assert && assert(node, `no Node found for key ${key}`);
    options.children = [node];
    return new Node(options);
  }
}

/**
 * Gets the key that corresponds to a bunny's phenotype. Instead of a big if-then-else statement for each
 * permutation of gene, this implementation converts the phenotype to a string key. The key pattern is
 * '{{hasWhiteFur}}-{{hasStraightEars}}-{{hasShortTeeth}}', where the value for each placeholder is 'true' or 'false'.
 */
function getKey(bunny) {
  return `${bunny.phenotype.hasWhiteFur()}-${bunny.phenotype.hasStraightEars()}-${bunny.phenotype.hasShortTeeth()}`;
}
naturalSelection.register('BunnyImageMap', BunnyImageMap);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21iaW5lT3B0aW9ucyIsIkFsaWduQm94IiwiQWxpZ25Hcm91cCIsIkltYWdlIiwiTm9kZSIsIlNwcml0ZSIsImJ1bm55QnJvd25GdXJGbG9wcHlFYXJzTG9uZ1RlZXRoX3BuZyIsImJ1bm55QnJvd25GdXJGbG9wcHlFYXJzU2hvcnRUZWV0aF9wbmciLCJidW5ueUJyb3duRnVyU3RyYWlnaHRFYXJzTG9uZ1RlZXRoX3BuZyIsImJ1bm55QnJvd25GdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZyIsImJ1bm55V2hpdGVGdXJGbG9wcHlFYXJzTG9uZ1RlZXRoX3BuZyIsImJ1bm55V2hpdGVGdXJGbG9wcHlFYXJzU2hvcnRUZWV0aF9wbmciLCJidW5ueVdoaXRlRnVyU3RyYWlnaHRFYXJzTG9uZ1RlZXRoX3BuZyIsImJ1bm55V2hpdGVGdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZyIsIm5hdHVyYWxTZWxlY3Rpb24iLCJCdW5ueVNwcml0ZUltYWdlIiwiQnVubnlJbWFnZU1hcCIsImNvbnN0cnVjdG9yIiwiaW1hZ2VNYXAiLCJNYXAiLCJzZXQiLCJhc3NlcnQiLCJzaXplIiwic3ByaXRlTWFwIiwiZm9yRWFjaCIsImh0bWxJbWFnZUVsZW1lbnQiLCJrZXkiLCJpbWFnZU9wdGlvbnMiLCJoaXRUZXN0UGl4ZWxzIiwiYWxpZ25Cb3hPcHRpb25zIiwieEFsaWduIiwieUFsaWduIiwiZ3JvdXAiLCJub2RlTWFwIiwiZ2V0U3ByaXRlcyIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsImdldFNwcml0ZSIsImJ1bm55IiwiZ2V0S2V5Iiwic3ByaXRlIiwiZ2V0IiwiZ2V0Tm9kZSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJub2RlIiwiY2hpbGRyZW4iLCJwaGVub3R5cGUiLCJoYXNXaGl0ZUZ1ciIsImhhc1N0cmFpZ2h0RWFycyIsImhhc1Nob3J0VGVldGgiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJ1bm55SW1hZ2VNYXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQnVubnlJbWFnZU1hcCBtYXBzIGEgYnVubnkgdG8gYSB2aXN1YWwgcmVwcmVzZW50YXRpb24gdGhhdCBjb3JyZXNwb25kcyB0byBpdHMgcGhlbm90eXBlLlxyXG4gKiBUaGUgdmlzdWFsIHJlcHJlc2VudGF0aW9uIGNhbiBiZSBhIFNwcml0ZSAoZm9yIHVzZSBpbiBPcmdhbmlzbVNwcml0ZXMpIG9yIGEgTm9kZSAoZm9yIHVzZSBpbiB0aGUgUGVkaWdyZWUgZ3JhcGgpLlxyXG4gKlxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IGNvbWJpbmVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCB7IEFsaWduQm94LCBBbGlnbkJveE9wdGlvbnMsIEFsaWduR3JvdXAsIEltYWdlLCBOb2RlLCBOb2RlT3B0aW9ucywgTm9kZVRyYW5zZm9ybU9wdGlvbnMsIFNwcml0ZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBidW5ueUJyb3duRnVyRmxvcHB5RWFyc0xvbmdUZWV0aF9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL2J1bm55QnJvd25GdXJGbG9wcHlFYXJzTG9uZ1RlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBidW5ueUJyb3duRnVyRmxvcHB5RWFyc1Nob3J0VGVldGhfcG5nIGZyb20gJy4uLy4uLy4uL2ltYWdlcy9idW5ueUJyb3duRnVyRmxvcHB5RWFyc1Nob3J0VGVldGhfcG5nLmpzJztcclxuaW1wb3J0IGJ1bm55QnJvd25GdXJTdHJhaWdodEVhcnNMb25nVGVldGhfcG5nIGZyb20gJy4uLy4uLy4uL2ltYWdlcy9idW5ueUJyb3duRnVyU3RyYWlnaHRFYXJzTG9uZ1RlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBidW5ueUJyb3duRnVyU3RyYWlnaHRFYXJzU2hvcnRUZWV0aF9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL2J1bm55QnJvd25GdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBidW5ueVdoaXRlRnVyRmxvcHB5RWFyc0xvbmdUZWV0aF9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL2J1bm55V2hpdGVGdXJGbG9wcHlFYXJzTG9uZ1RlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBidW5ueVdoaXRlRnVyRmxvcHB5RWFyc1Nob3J0VGVldGhfcG5nIGZyb20gJy4uLy4uLy4uL2ltYWdlcy9idW5ueVdoaXRlRnVyRmxvcHB5RWFyc1Nob3J0VGVldGhfcG5nLmpzJztcclxuaW1wb3J0IGJ1bm55V2hpdGVGdXJTdHJhaWdodEVhcnNMb25nVGVldGhfcG5nIGZyb20gJy4uLy4uLy4uL2ltYWdlcy9idW5ueVdoaXRlRnVyU3RyYWlnaHRFYXJzTG9uZ1RlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBidW5ueVdoaXRlRnVyU3RyYWlnaHRFYXJzU2hvcnRUZWV0aF9wbmcgZnJvbSAnLi4vLi4vLi4vaW1hZ2VzL2J1bm55V2hpdGVGdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZy5qcyc7XHJcbmltcG9ydCBuYXR1cmFsU2VsZWN0aW9uIGZyb20gJy4uLy4uL25hdHVyYWxTZWxlY3Rpb24uanMnO1xyXG5pbXBvcnQgQnVubnkgZnJvbSAnLi4vbW9kZWwvQnVubnkuanMnO1xyXG5pbXBvcnQgQnVubnlTcHJpdGVJbWFnZSBmcm9tICcuL2Vudmlyb25tZW50L0J1bm55U3ByaXRlSW1hZ2UuanMnO1xyXG5cclxuLy8gS2V5cyBmb3IgYWxsIG1hcHMgaGVyZWluLiBTZWUgZ2V0S2V5KCkuXHJcbnR5cGUgS2V5ID1cclxuICAndHJ1ZS10cnVlLXRydWUnIHwgJ3RydWUtdHJ1ZS1mYWxzZScgfCAndHJ1ZS1mYWxzZS10cnVlJyB8ICd0cnVlLWZhbHNlLWZhbHNlJyB8XHJcbiAgJ2ZhbHNlLXRydWUtdHJ1ZScgfCAnZmFsc2UtdHJ1ZS1mYWxzZScgfCAnZmFsc2UtZmFsc2UtdHJ1ZScgfCAnZmFsc2UtZmFsc2UtZmFsc2UnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQnVubnlJbWFnZU1hcCB7XHJcblxyXG4gIC8vIFNwcml0ZXMgZm9yIGVhY2ggYnVubnkgcGhlbm90eXBlLCB1c2VkIGluIE9yZ2FuaXNtU3ByaXRlcy4gVXNlcyB0aGUgc2FtZSBrZXlzIGFzIGNvbnN0IGltYWdlTWFwLlxyXG4gIHByaXZhdGUgcmVhZG9ubHkgc3ByaXRlTWFwOiBNYXA8S2V5LCBTcHJpdGU+O1xyXG5cclxuICAvLyBOb2RlcyBmb3IgZWFjaCBidW5ueSBwaGVub3R5cGUsIHVzZWQgaW4gdGhlIFBlZGlncmVlIGdyYXBoLiBVc2VzIHRoZSBzYW1lIGtleXMgYXMgY29uc3QgaW1hZ2VNYXAuXHJcbiAgLy8gQWxsIG9mIHRoZXNlIE5vZGVzIGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFuZCBlZmZlY3RpdmUgc2l6ZS5cclxuICBwcml2YXRlIHJlYWRvbmx5IG5vZGVNYXA6IE1hcDxLZXksIE5vZGU+O1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XHJcblxyXG4gICAgLy8gTWFwcyBhIGJ1bm55J3MgcGhlbm90eXBlIHRvIGFuIEhUTUxJbWFnZUVsZW1lbnQuXHJcbiAgICAvLyBUaGlzIG1hcCBpcyBub3Qgc3RhdGljIGJlY2F1c2UgdGhlIGltYWdlcyBuZWVkIHRvIGJlIGxvYWRlZCBiZWZvcmUgdGhleSBjYW4gYmUgdXNlZCBieSBTcHJpdGVJbWFnZS5cclxuICAgIGNvbnN0IGltYWdlTWFwID0gbmV3IE1hcDxLZXksIEhUTUxJbWFnZUVsZW1lbnQ+KCk7XHJcbiAgICBpbWFnZU1hcC5zZXQoICd0cnVlLXRydWUtdHJ1ZScsIGJ1bm55V2hpdGVGdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZyApO1xyXG4gICAgaW1hZ2VNYXAuc2V0KCAndHJ1ZS10cnVlLWZhbHNlJywgYnVubnlXaGl0ZUZ1clN0cmFpZ2h0RWFyc0xvbmdUZWV0aF9wbmcgKTtcclxuICAgIGltYWdlTWFwLnNldCggJ3RydWUtZmFsc2UtdHJ1ZScsIGJ1bm55V2hpdGVGdXJGbG9wcHlFYXJzU2hvcnRUZWV0aF9wbmcgKTtcclxuICAgIGltYWdlTWFwLnNldCggJ3RydWUtZmFsc2UtZmFsc2UnLCBidW5ueVdoaXRlRnVyRmxvcHB5RWFyc0xvbmdUZWV0aF9wbmcgKTtcclxuICAgIGltYWdlTWFwLnNldCggJ2ZhbHNlLXRydWUtdHJ1ZScsIGJ1bm55QnJvd25GdXJTdHJhaWdodEVhcnNTaG9ydFRlZXRoX3BuZyApO1xyXG4gICAgaW1hZ2VNYXAuc2V0KCAnZmFsc2UtdHJ1ZS1mYWxzZScsIGJ1bm55QnJvd25GdXJTdHJhaWdodEVhcnNMb25nVGVldGhfcG5nICk7XHJcbiAgICBpbWFnZU1hcC5zZXQoICdmYWxzZS1mYWxzZS10cnVlJywgYnVubnlCcm93bkZ1ckZsb3BweUVhcnNTaG9ydFRlZXRoX3BuZyApO1xyXG4gICAgaW1hZ2VNYXAuc2V0KCAnZmFsc2UtZmFsc2UtZmFsc2UnLCBidW5ueUJyb3duRnVyRmxvcHB5RWFyc0xvbmdUZWV0aF9wbmcgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGltYWdlTWFwLnNpemUgPT09IDgsICdpbWFnZU1hcCBpcyBpbmNvbXBsZXRlJyApO1xyXG5cclxuICAgIC8vIENyZWF0ZSBhIFNwcml0ZSBmb3IgZWFjaCBlbnRyeSBpbiBpbWFnZU1hcC5cclxuICAgIHRoaXMuc3ByaXRlTWFwID0gbmV3IE1hcDxLZXksIFNwcml0ZT4oKTtcclxuICAgIGltYWdlTWFwLmZvckVhY2goICggaHRtbEltYWdlRWxlbWVudCwga2V5ICkgPT5cclxuICAgICAgdGhpcy5zcHJpdGVNYXAuc2V0KCBrZXksIG5ldyBTcHJpdGUoIG5ldyBCdW5ueVNwcml0ZUltYWdlKCBodG1sSW1hZ2VFbGVtZW50ICkgKSApICk7XHJcblxyXG4gICAgLy8gSGl0IHRlc3Qgb24gbm9uLXRyYW5zcGFyZW50IHBpeGVscywgdG8gbWFrZSBpdCBlYXNpZXIgdG8gc2VsZWN0IG92ZXJsYXBwaW5nIGJ1bm5pZXMuXHJcbiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy82M1xyXG4gICAgY29uc3QgaW1hZ2VPcHRpb25zID0ge1xyXG4gICAgICBoaXRUZXN0UGl4ZWxzOiB0cnVlXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIE1ha2UgYWxsIE5vZGVzIGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFuZCBlZmZlY3RpdmUgZGltZW5zaW9ucy5cclxuICAgIGNvbnN0IGFsaWduQm94T3B0aW9uczogQWxpZ25Cb3hPcHRpb25zID0ge1xyXG4gICAgICB4QWxpZ246ICdjZW50ZXInLFxyXG4gICAgICB5QWxpZ246ICdib3R0b20nLFxyXG4gICAgICBncm91cDogbmV3IEFsaWduR3JvdXAoKVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBDcmVhdGUgYSBOb2RlIGZvciBlYWNoIGVudHJ5IGluIGltYWdlTWFwLlxyXG4gICAgdGhpcy5ub2RlTWFwID0gbmV3IE1hcDxLZXksIE5vZGU+KCk7XHJcbiAgICBpbWFnZU1hcC5mb3JFYWNoKCAoIGh0bWxJbWFnZUVsZW1lbnQsIGtleSApID0+XHJcbiAgICAgIHRoaXMubm9kZU1hcC5zZXQoIGtleSwgbmV3IEFsaWduQm94KCBuZXcgSW1hZ2UoIGh0bWxJbWFnZUVsZW1lbnQsIGltYWdlT3B0aW9ucyApLCBhbGlnbkJveE9wdGlvbnMgKSApICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBjb21wbGV0ZSBzZXQgb2YgU3ByaXRlcyBmb3IgYWxsIGJ1bm55IHBoZW5vdHlwZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGdldFNwcml0ZXMoKTogU3ByaXRlW10ge1xyXG4gICAgcmV0dXJuIEFycmF5LmZyb20oIHRoaXMuc3ByaXRlTWFwLnZhbHVlcygpICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBTcHJpdGUgdGhhdCBtYXRjaGVzIGEgYnVubnkncyBwaGVub3R5cGUsIGZvciB1c2UgaW4gT3JnYW5pc21TcHJpdGVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRTcHJpdGUoIGJ1bm55OiBCdW5ueSApOiBTcHJpdGUge1xyXG5cclxuICAgIC8vIENyZWF0ZSB0aGUga2V5IHRoYXQgY29ycmVzcG9uZHMgdG8gdGhlIGJ1bm55J3MgcGhlbm90eXBlLlxyXG4gICAgY29uc3Qga2V5ID0gZ2V0S2V5KCBidW5ueSApO1xyXG5cclxuICAgIC8vIExvb2sgdXAgdGhlIFNwcml0ZSBpbiB0aGUgbWFwLlxyXG4gICAgY29uc3Qgc3ByaXRlID0gdGhpcy5zcHJpdGVNYXAuZ2V0KCBrZXkgKSE7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBzcHJpdGUsIGBubyBzcHJpdGUgZm91bmQgZm9yIGtleSAke2tleX1gICk7XHJcblxyXG4gICAgcmV0dXJuIHNwcml0ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHMgdGhlIE5vZGUgdGhhdCBtYXRjaGVzIGEgYnVubnkncyBwaGVub3R5cGUsIGZvciB1c2UgaW4gdGhlIFBlZGlncmVlIGdyYXBoLiBTaW5jZSB0aGlzIE5vZGUgaXMgdXNlZCBpbiBtdWx0aXBsZVxyXG4gICAqIHBsYWNlcyBpbiBzY2VuZXJ5J3MgREFHLCB0aGUgTm9kZSBpcyB3cmFwcGVkIHdpdGggYW5vdGhlciBOb2RlLCBzbyB0aGF0IGl0IGNhbiBiZSB0cmFuc2Zvcm1lZCB3aXRob3V0IGNhdXNpbmdcclxuICAgKiBwcm9ibGVtcy5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Tm9kZSggYnVubnk6IEJ1bm55LCBwcm92aWRlZE9wdGlvbnM/OiBOb2RlVHJhbnNmb3JtT3B0aW9ucyApOiBOb2RlIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gY29tYmluZU9wdGlvbnM8Tm9kZU9wdGlvbnM+KCB7fSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIHRoZSBrZXkgdGhhdCBjb3JyZXNwb25kcyB0byB0aGUgYnVubnkncyBwaGVub3R5cGUuXHJcbiAgICBjb25zdCBrZXkgPSBnZXRLZXkoIGJ1bm55ICk7XHJcblxyXG4gICAgLy8gTG9vayB1cCB0aGUgTm9kZSBpbiB0aGUgbWFwLlxyXG4gICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZU1hcC5nZXQoIGtleSApITtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIG5vZGUsIGBubyBOb2RlIGZvdW5kIGZvciBrZXkgJHtrZXl9YCApO1xyXG5cclxuICAgIG9wdGlvbnMuY2hpbGRyZW4gPSBbIG5vZGUgXTtcclxuXHJcbiAgICByZXR1cm4gbmV3IE5vZGUoIG9wdGlvbnMgKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXRzIHRoZSBrZXkgdGhhdCBjb3JyZXNwb25kcyB0byBhIGJ1bm55J3MgcGhlbm90eXBlLiBJbnN0ZWFkIG9mIGEgYmlnIGlmLXRoZW4tZWxzZSBzdGF0ZW1lbnQgZm9yIGVhY2hcclxuICogcGVybXV0YXRpb24gb2YgZ2VuZSwgdGhpcyBpbXBsZW1lbnRhdGlvbiBjb252ZXJ0cyB0aGUgcGhlbm90eXBlIHRvIGEgc3RyaW5nIGtleS4gVGhlIGtleSBwYXR0ZXJuIGlzXHJcbiAqICd7e2hhc1doaXRlRnVyfX0te3toYXNTdHJhaWdodEVhcnN9fS17e2hhc1Nob3J0VGVldGh9fScsIHdoZXJlIHRoZSB2YWx1ZSBmb3IgZWFjaCBwbGFjZWhvbGRlciBpcyAndHJ1ZScgb3IgJ2ZhbHNlJy5cclxuICovXHJcbmZ1bmN0aW9uIGdldEtleSggYnVubnk6IEJ1bm55ICk6IEtleSB7XHJcbiAgcmV0dXJuIGAke2J1bm55LnBoZW5vdHlwZS5oYXNXaGl0ZUZ1cigpfS0ke2J1bm55LnBoZW5vdHlwZS5oYXNTdHJhaWdodEVhcnMoKX0tJHtidW5ueS5waGVub3R5cGUuaGFzU2hvcnRUZWV0aCgpfWA7XHJcbn1cclxuXHJcbm5hdHVyYWxTZWxlY3Rpb24u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