// Copyright 2019-2023, University of Colorado Boulder

/**
 * NaturalSelectionModel is the base class model for all screens.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import Emitter from '../../../../axon/js/Emitter.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import TimeSpeed from '../../../../scenery-phet/js/TimeSpeed.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import naturalSelection from '../../naturalSelection.js';
import NaturalSelectionQueryParameters from '../NaturalSelectionQueryParameters.js';
import NaturalSelectionUtils from '../NaturalSelectionUtils.js';
import BunnyCollection from './BunnyCollection.js';
import Environment from './Environment.js';
import EnvironmentModelViewTransform from './EnvironmentModelViewTransform.js';
import Food from './Food.js';
import GenePool from './GenePool.js';
import GenerationClock from './GenerationClock.js';
import parseInitialPopulation from './parseInitialPopulation.js';
import PedigreeModel from './PedigreeModel.js';
import PopulationModel from './PopulationModel.js';
import ProportionsModel from './ProportionsModel.js';
import SimulationMode from './SimulationMode.js';
import WolfCollection from './WolfCollection.js';
export default class NaturalSelectionModel {
  // the transform between 3D model coordinates and 2D view coordinates

  // see SimulationMode

  // pool of genes for the bunny population
  // the collection of Bunny instances

  // The time that it took to execute bunnyCollection.mateBunnies, in ms
  // For performance profiling, see https://github.com/phetsims/natural-selection/issues/60
  // describes the initial population
  constructor(screenKey, shrubsSeed, providedOptions) {
    const options = providedOptions;
    this.modelViewTransform = new EnvironmentModelViewTransform();
    this.simulationModeProperty = new EnumerationProperty(SimulationMode.STAGED, {
      tandem: options.tandem.createTandem('simulationModeProperty'),
      phetioDocumentation: 'for internal PhET use only',
      // see https://github.com/phetsims/phet-io/issues/1660
      phetioReadOnly: true
    });
    this.isPlayingProperty = new BooleanProperty(true, {
      tandem: options.tandem.createTandem('isPlayingProperty'),
      phetioDocumentation: 'whether time is advancing in the simulation, controlled by the Play/Pause button'
    });
    this.timeSpeedProperty = new EnumerationProperty(TimeSpeed.NORMAL, {
      validValues: [TimeSpeed.NORMAL, TimeSpeed.FAST],
      tandem: options.tandem.createTandem('timeSpeedProperty'),
      phetioDocumentation: 'controls the speed of the generation clock',
      phetioReadOnly: true
    });
    this.timeScaleProperty = new DerivedProperty([this.timeSpeedProperty], timeSpeed => timeSpeed === TimeSpeed.NORMAL ? 1 : NaturalSelectionQueryParameters.fastForwardScale, {
      tandem: Tandem.OPT_OUT
    });
    this.generationClock = new GenerationClock({
      tandem: options.tandem.createTandem('generationClock')
    });
    phet.log && phet.log('====== Generation 0 ======');
    this.genePool = new GenePool({
      tandem: options.tandem.createTandem('genePool')
    });
    this.initialBunnyVarieties = parseInitialPopulation(screenKey, this.genePool);
    this.bunnyCollection = new BunnyCollection(this.modelViewTransform, this.genePool, options.tandem.createTandem('bunnyCollection'));
    this.initializeGenerationZero();
    this.environmentProperty = new EnumerationProperty(Environment.EQUATOR, {
      tandem: options.tandem.createTandem('environmentProperty')
    });
    this.wolfCollection = new WolfCollection(this.generationClock, this.environmentProperty, this.bunnyCollection, this.modelViewTransform, options.tandem.createTandem('wolfCollection'));
    this.food = new Food(this.generationClock, this.bunnyCollection, this.modelViewTransform, shrubsSeed, {
      tandem: options.tandem.createTandem('food')
    });

    // Organize all graphs under this tandem
    const graphsTandem = options.tandem.createTandem('graphs');
    this.populationModel = new PopulationModel(this.genePool, this.generationClock.timeInGenerationsProperty, this.isPlayingProperty, {
      tandem: graphsTandem.createTandem('populationModel')
    });
    this.proportionsModel = new ProportionsModel(this.bunnyCollection.liveBunnies.countsProperty, this.generationClock.clockGenerationProperty, this.isPlayingProperty, {
      tandem: graphsTandem.createTandem('proportionsModel')
    });
    this.pedigreeModel = new PedigreeModel({
      tandem: graphsTandem.createTandem('pedigreeModel')
    });

    // When the simulation state changes... unlink is not necessary.
    this.simulationModeProperty.link(simulationMode => {
      // SimulationMode indicates which mode the simulation is in. It does not describe a full state of that mode.
      // So do nothing when PhET-iO is restoring state, or saved state will be overwritten.
      if (!phet.joist.sim.isSettingPhetioStateProperty.value) {
        // When the simulation begins, record 'start' data for the graphs.
        if (simulationMode === SimulationMode.ACTIVE) {
          const clockGeneration = this.generationClock.clockGenerationProperty.value;
          const counts = this.bunnyCollection.getLiveBunnyCounts();
          this.proportionsModel.recordStartCounts(clockGeneration, counts);
          this.populationModel.recordCounts(clockGeneration, counts);
        }

        // Adjust the sim playback and generation clock
        if (simulationMode === SimulationMode.STAGED) {
          this.isPlayingProperty.value = true;
          this.generationClock.isRunningProperty.value = false;
        } else if (simulationMode === SimulationMode.ACTIVE) {
          this.generationClock.isRunningProperty.value = true;
        } else if (simulationMode === SimulationMode.COMPLETED) {
          this.isPlayingProperty.value = false;
          this.generationClock.isRunningProperty.value = false;
        } else {
          throw new Error(`unsupported simulationMode: ${simulationMode}`);
        }
      }
    });
    this.timeToMateProperty = new NumberProperty(0, {
      tandem: Tandem.OPT_OUT
    });
    this.memoryLimitEmitter = new Emitter({
      tandem: options.tandem.createTandem('memoryLimitEmitter'),
      phetioReadOnly: true,
      phetioDocumentation: 'fires when the memory limit is reached and the simulation must be ended'
    });

    // removeListener is not necessary.
    this.generationClock.clockGenerationProperty.link(clockGeneration => {
      if (clockGeneration >= NaturalSelectionQueryParameters.maxGenerations) {
        this.memoryLimitEmitter.emit();
      }
    });

    // All the stuff that happens at 12:00 on the generation clock.
    // unlink is not necessary.
    this.generationClock.clockGenerationProperty.lazyLink(clockGeneration => {
      // When restoring PhET-iO state, skip this code, because downstream elements are already stateful.
      if (!phet.joist.sim.isSettingPhetioStateProperty.value) {
        // Generation 0 is initialized elsewhere, this code is for subsequent generations.
        if (clockGeneration !== 0) {
          phet.log && phet.log(`====== Generation ${clockGeneration} ======`);

          // Before bunnies are aged or mated, Record 'End of Generation' counts for the Proportions graph.
          this.proportionsModel.recordEndCounts(clockGeneration - 1, this.bunnyCollection.getLiveBunnyCounts());
          phet.log && phet.log(`live bunnies = ${this.bunnyCollection.getNumberOfLiveBunnies()}`);
          phet.log && phet.log(`dead bunnies = ${this.bunnyCollection.getNumberOfDeadBunnies()}`);
          phet.log && phet.log(`recessive mutants = ${this.bunnyCollection.getNumberOfRecessiveMutants()}`);

          // Age bunnies, some may die of old age.
          this.bunnyCollection.ageBunnies();
          this.bunnyCollection.pruneDeadBunnies(clockGeneration);

          // Mate bunnies, with performance profiling, see see https://github.com/phetsims/natural-selection/issues/60
          this.timeToMateProperty.value = NaturalSelectionUtils.time(() => this.bunnyCollection.mateBunnies(clockGeneration));

          // After bunnies are aged and mated, record counts for graphs.
          const counts = this.bunnyCollection.getLiveBunnyCounts();
          this.proportionsModel.recordStartCounts(clockGeneration, counts);
          this.populationModel.recordCounts(clockGeneration, counts);
        }
      }
    });

    // Record data for the Population graph when the population is changed by environmental factors.
    const recordCounts = timeInGenerations => {
      const counts = this.bunnyCollection.getLiveBunnyCounts();
      this.populationModel.recordCounts(timeInGenerations, counts);
    };
    this.wolfCollection.bunniesEatenEmitter.addListener(recordCounts); // removeListener is not necessary.
    this.food.bunniesStarvedEmitter.addListener(recordCounts); // removeListener is not necessary.
  }

  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }

  /**
   * Resets the entire model when the 'Reset All' button is pressed.
   */
  reset() {
    // These Properties are not reset by startOver
    this.timeSpeedProperty.reset();
    this.environmentProperty.reset();

    // Everything else is the same as startOver
    this.startOver();
  }

  /**
   * Resets part of the model when the 'Start Over' button is pressed.
   */
  startOver() {
    phet.log && phet.log('====== Generation 0 ======');
    this.isPlayingProperty.reset(); // see https://github.com/phetsims/natural-selection/issues/55
    this.generationClock.reset();
    this.genePool.reset();
    this.bunnyCollection.reset();
    this.initializeGenerationZero();

    // See https://github.com/phetsims/natural-selection/issues/91
    this.wolfCollection.reset();
    this.food.reset();
    this.populationModel.reset();
    this.proportionsModel.reset();
    this.pedigreeModel.reset();

    // Reset the mode last, because listeners may inspect other model state.
    this.simulationModeProperty.reset();
  }

  /**
   * Steps the model.
   * @param dt - time step, in seconds
   */
  step(dt) {
    if (this.isPlayingProperty.value) {
      // So we can't make the sim run so fast that it skips generations,
      dt = GenerationClock.constrainDt(dt);

      // step the generation clock
      this.generationClock.step(dt * this.timeScaleProperty.value);

      // move the bunnies
      this.bunnyCollection.moveBunnies(dt);

      // move the wolves
      this.wolfCollection.moveWolves(dt);
    }
  }

  /**
   * Adds a mate for a lone bunny.
   */
  addAMate() {
    assert && assert(this.bunnyCollection.getNumberOfLiveBunnies() === 1, 'there should only be 1 live bunny');
    assert && assert(this.generationClock.clockGenerationProperty.value === 0, 'unexpected clockGeneration');
    this.bunnyCollection.createBunnyZero();
  }

  /**
   * Initializes the generation-zero bunny population.
   */
  initializeGenerationZero() {
    phet.log && phet.log('NaturalSelectionModel.initializeGenerationZero');
    assert && assert(this.bunnyCollection.getNumberOfLiveBunnies() === 0, 'bunnies already exist');
    assert && assert(this.generationClock.clockGenerationProperty.value === 0, 'unexpected clockGeneration');

    // For each {BunnyVariety} in the initial population, create bunnies of that variety.
    this.initialBunnyVarieties.forEach(variety => {
      phet.log && phet.log(`creating ${variety.count} bunnies with genotype '${variety.genotypeString}'`);
      for (let i = 0; i < variety.count; i++) {
        this.bunnyCollection.createBunnyZero({
          genotypeOptions: {
            fatherFurAllele: variety.fatherFurAllele,
            motherFurAllele: variety.motherFurAllele,
            fatherEarsAllele: variety.fatherEarsAllele,
            motherEarsAllele: variety.motherEarsAllele,
            fatherTeethAllele: variety.fatherTeethAllele,
            motherTeethAllele: variety.motherTeethAllele
          }
        });
      }
    });
  }
}
naturalSelection.register('NaturalSelectionModel', NaturalSelectionModel);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJFbWl0dGVyIiwiRW51bWVyYXRpb25Qcm9wZXJ0eSIsIk51bWJlclByb3BlcnR5IiwiVGltZVNwZWVkIiwiVGFuZGVtIiwibmF0dXJhbFNlbGVjdGlvbiIsIk5hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMiLCJOYXR1cmFsU2VsZWN0aW9uVXRpbHMiLCJCdW5ueUNvbGxlY3Rpb24iLCJFbnZpcm9ubWVudCIsIkVudmlyb25tZW50TW9kZWxWaWV3VHJhbnNmb3JtIiwiRm9vZCIsIkdlbmVQb29sIiwiR2VuZXJhdGlvbkNsb2NrIiwicGFyc2VJbml0aWFsUG9wdWxhdGlvbiIsIlBlZGlncmVlTW9kZWwiLCJQb3B1bGF0aW9uTW9kZWwiLCJQcm9wb3J0aW9uc01vZGVsIiwiU2ltdWxhdGlvbk1vZGUiLCJXb2xmQ29sbGVjdGlvbiIsIk5hdHVyYWxTZWxlY3Rpb25Nb2RlbCIsImNvbnN0cnVjdG9yIiwic2NyZWVuS2V5Iiwic2hydWJzU2VlZCIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJzaW11bGF0aW9uTW9kZVByb3BlcnR5IiwiU1RBR0VEIiwidGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInBoZXRpb1JlYWRPbmx5IiwiaXNQbGF5aW5nUHJvcGVydHkiLCJ0aW1lU3BlZWRQcm9wZXJ0eSIsIk5PUk1BTCIsInZhbGlkVmFsdWVzIiwiRkFTVCIsInRpbWVTY2FsZVByb3BlcnR5IiwidGltZVNwZWVkIiwiZmFzdEZvcndhcmRTY2FsZSIsIk9QVF9PVVQiLCJnZW5lcmF0aW9uQ2xvY2siLCJwaGV0IiwibG9nIiwiZ2VuZVBvb2wiLCJpbml0aWFsQnVubnlWYXJpZXRpZXMiLCJidW5ueUNvbGxlY3Rpb24iLCJpbml0aWFsaXplR2VuZXJhdGlvblplcm8iLCJlbnZpcm9ubWVudFByb3BlcnR5IiwiRVFVQVRPUiIsIndvbGZDb2xsZWN0aW9uIiwiZm9vZCIsImdyYXBoc1RhbmRlbSIsInBvcHVsYXRpb25Nb2RlbCIsInRpbWVJbkdlbmVyYXRpb25zUHJvcGVydHkiLCJwcm9wb3J0aW9uc01vZGVsIiwibGl2ZUJ1bm5pZXMiLCJjb3VudHNQcm9wZXJ0eSIsImNsb2NrR2VuZXJhdGlvblByb3BlcnR5IiwicGVkaWdyZWVNb2RlbCIsImxpbmsiLCJzaW11bGF0aW9uTW9kZSIsImpvaXN0Iiwic2ltIiwiaXNTZXR0aW5nUGhldGlvU3RhdGVQcm9wZXJ0eSIsInZhbHVlIiwiQUNUSVZFIiwiY2xvY2tHZW5lcmF0aW9uIiwiY291bnRzIiwiZ2V0TGl2ZUJ1bm55Q291bnRzIiwicmVjb3JkU3RhcnRDb3VudHMiLCJyZWNvcmRDb3VudHMiLCJpc1J1bm5pbmdQcm9wZXJ0eSIsIkNPTVBMRVRFRCIsIkVycm9yIiwidGltZVRvTWF0ZVByb3BlcnR5IiwibWVtb3J5TGltaXRFbWl0dGVyIiwibWF4R2VuZXJhdGlvbnMiLCJlbWl0IiwibGF6eUxpbmsiLCJyZWNvcmRFbmRDb3VudHMiLCJnZXROdW1iZXJPZkxpdmVCdW5uaWVzIiwiZ2V0TnVtYmVyT2ZEZWFkQnVubmllcyIsImdldE51bWJlck9mUmVjZXNzaXZlTXV0YW50cyIsImFnZUJ1bm5pZXMiLCJwcnVuZURlYWRCdW5uaWVzIiwidGltZSIsIm1hdGVCdW5uaWVzIiwidGltZUluR2VuZXJhdGlvbnMiLCJidW5uaWVzRWF0ZW5FbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJidW5uaWVzU3RhcnZlZEVtaXR0ZXIiLCJkaXNwb3NlIiwiYXNzZXJ0IiwicmVzZXQiLCJzdGFydE92ZXIiLCJzdGVwIiwiZHQiLCJjb25zdHJhaW5EdCIsIm1vdmVCdW5uaWVzIiwibW92ZVdvbHZlcyIsImFkZEFNYXRlIiwiY3JlYXRlQnVubnlaZXJvIiwiZm9yRWFjaCIsInZhcmlldHkiLCJjb3VudCIsImdlbm90eXBlU3RyaW5nIiwiaSIsImdlbm90eXBlT3B0aW9ucyIsImZhdGhlckZ1ckFsbGVsZSIsIm1vdGhlckZ1ckFsbGVsZSIsImZhdGhlckVhcnNBbGxlbGUiLCJtb3RoZXJFYXJzQWxsZWxlIiwiZmF0aGVyVGVldGhBbGxlbGUiLCJtb3RoZXJUZWV0aEFsbGVsZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTmF0dXJhbFNlbGVjdGlvbk1vZGVsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE5LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE5hdHVyYWxTZWxlY3Rpb25Nb2RlbCBpcyB0aGUgYmFzZSBjbGFzcyBtb2RlbCBmb3IgYWxsIHNjcmVlbnMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBEZXJpdmVkUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9EZXJpdmVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgRW1pdHRlciBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VtaXR0ZXIuanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrUmVxdWlyZWQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tSZXF1aXJlZC5qcyc7XHJcbmltcG9ydCBUaW1lU3BlZWQgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1RpbWVTcGVlZC5qcyc7XHJcbmltcG9ydCB7IFBoZXRpb09iamVjdE9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvUGhldGlvT2JqZWN0LmpzJztcclxuaW1wb3J0IFRhbmRlbSBmcm9tICcuLi8uLi8uLi8uLi90YW5kZW0vanMvVGFuZGVtLmpzJztcclxuaW1wb3J0IG5hdHVyYWxTZWxlY3Rpb24gZnJvbSAnLi4vLi4vbmF0dXJhbFNlbGVjdGlvbi5qcyc7XHJcbmltcG9ydCBOYXR1cmFsU2VsZWN0aW9uUXVlcnlQYXJhbWV0ZXJzIGZyb20gJy4uL05hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgTmF0dXJhbFNlbGVjdGlvblV0aWxzIGZyb20gJy4uL05hdHVyYWxTZWxlY3Rpb25VdGlscy5qcyc7XHJcbmltcG9ydCBCdW5ueUNvbGxlY3Rpb24gZnJvbSAnLi9CdW5ueUNvbGxlY3Rpb24uanMnO1xyXG5pbXBvcnQgRW52aXJvbm1lbnQgZnJvbSAnLi9FbnZpcm9ubWVudC5qcyc7XHJcbmltcG9ydCBFbnZpcm9ubWVudE1vZGVsVmlld1RyYW5zZm9ybSBmcm9tICcuL0Vudmlyb25tZW50TW9kZWxWaWV3VHJhbnNmb3JtLmpzJztcclxuaW1wb3J0IEZvb2QgZnJvbSAnLi9Gb29kLmpzJztcclxuaW1wb3J0IEdlbmVQb29sIGZyb20gJy4vR2VuZVBvb2wuanMnO1xyXG5pbXBvcnQgR2VuZXJhdGlvbkNsb2NrIGZyb20gJy4vR2VuZXJhdGlvbkNsb2NrLmpzJztcclxuaW1wb3J0IHBhcnNlSW5pdGlhbFBvcHVsYXRpb24sIHsgU2NyZWVuS2V5IH0gZnJvbSAnLi9wYXJzZUluaXRpYWxQb3B1bGF0aW9uLmpzJztcclxuaW1wb3J0IFBlZGlncmVlTW9kZWwgZnJvbSAnLi9QZWRpZ3JlZU1vZGVsLmpzJztcclxuaW1wb3J0IFBvcHVsYXRpb25Nb2RlbCBmcm9tICcuL1BvcHVsYXRpb25Nb2RlbC5qcyc7XHJcbmltcG9ydCBQcm9wb3J0aW9uc01vZGVsIGZyb20gJy4vUHJvcG9ydGlvbnNNb2RlbC5qcyc7XHJcbmltcG9ydCBTaW11bGF0aW9uTW9kZSBmcm9tICcuL1NpbXVsYXRpb25Nb2RlLmpzJztcclxuaW1wb3J0IFdvbGZDb2xsZWN0aW9uIGZyb20gJy4vV29sZkNvbGxlY3Rpb24uanMnO1xyXG5pbXBvcnQgQnVubnlWYXJpZXR5IGZyb20gJy4vQnVubnlWYXJpZXR5LmpzJztcclxuaW1wb3J0IFRNb2RlbCBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9UTW9kZWwuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIE5hdHVyYWxTZWxlY3Rpb25Nb2RlbE9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIFBpY2tSZXF1aXJlZDxQaGV0aW9PYmplY3RPcHRpb25zLCAndGFuZGVtJz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBOYXR1cmFsU2VsZWN0aW9uTW9kZWwgaW1wbGVtZW50cyBUTW9kZWwge1xyXG5cclxuICAvLyB0aGUgdHJhbnNmb3JtIGJldHdlZW4gM0QgbW9kZWwgY29vcmRpbmF0ZXMgYW5kIDJEIHZpZXcgY29vcmRpbmF0ZXNcclxuICBwdWJsaWMgcmVhZG9ubHkgbW9kZWxWaWV3VHJhbnNmb3JtOiBFbnZpcm9ubWVudE1vZGVsVmlld1RyYW5zZm9ybTtcclxuXHJcbiAgLy8gc2VlIFNpbXVsYXRpb25Nb2RlXHJcbiAgcHVibGljIHJlYWRvbmx5IHNpbXVsYXRpb25Nb2RlUHJvcGVydHk6IEVudW1lcmF0aW9uUHJvcGVydHk8U2ltdWxhdGlvbk1vZGU+O1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgaXNQbGF5aW5nUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+O1xyXG4gIHB1YmxpYyByZWFkb25seSB0aW1lU3BlZWRQcm9wZXJ0eTogRW51bWVyYXRpb25Qcm9wZXJ0eTxUaW1lU3BlZWQ+O1xyXG4gIHB1YmxpYyByZWFkb25seSBnZW5lcmF0aW9uQ2xvY2s6IEdlbmVyYXRpb25DbG9jaztcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IGdlbmVQb29sOiBHZW5lUG9vbDsgLy8gcG9vbCBvZiBnZW5lcyBmb3IgdGhlIGJ1bm55IHBvcHVsYXRpb25cclxuICBwdWJsaWMgcmVhZG9ubHkgYnVubnlDb2xsZWN0aW9uOiBCdW5ueUNvbGxlY3Rpb247IC8vIHRoZSBjb2xsZWN0aW9uIG9mIEJ1bm55IGluc3RhbmNlc1xyXG4gIHB1YmxpYyByZWFkb25seSBlbnZpcm9ubWVudFByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PEVudmlyb25tZW50PjtcclxuICBwdWJsaWMgcmVhZG9ubHkgd29sZkNvbGxlY3Rpb246IFdvbGZDb2xsZWN0aW9uO1xyXG4gIHB1YmxpYyByZWFkb25seSBmb29kOiBGb29kO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgcG9wdWxhdGlvbk1vZGVsOiBQb3B1bGF0aW9uTW9kZWw7XHJcbiAgcHVibGljIHJlYWRvbmx5IHByb3BvcnRpb25zTW9kZWw6IFByb3BvcnRpb25zTW9kZWw7XHJcbiAgcHVibGljIHJlYWRvbmx5IHBlZGlncmVlTW9kZWw6IFBlZGlncmVlTW9kZWw7XHJcblxyXG4gIC8vIFRoZSB0aW1lIHRoYXQgaXQgdG9vayB0byBleGVjdXRlIGJ1bm55Q29sbGVjdGlvbi5tYXRlQnVubmllcywgaW4gbXNcclxuICAvLyBGb3IgcGVyZm9ybWFuY2UgcHJvZmlsaW5nLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy82MFxyXG4gIHB1YmxpYyByZWFkb25seSB0aW1lVG9NYXRlUHJvcGVydHk6IFByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSBtZW1vcnlMaW1pdEVtaXR0ZXI6IEVtaXR0ZXI7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgdGltZVNjYWxlUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PG51bWJlcj47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsQnVubnlWYXJpZXRpZXM6IEJ1bm55VmFyaWV0eVtdOyAvLyBkZXNjcmliZXMgdGhlIGluaXRpYWwgcG9wdWxhdGlvblxyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHNjcmVlbktleTogU2NyZWVuS2V5LCBzaHJ1YnNTZWVkOiBudW1iZXIsIHByb3ZpZGVkT3B0aW9uczogTmF0dXJhbFNlbGVjdGlvbk1vZGVsT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gcHJvdmlkZWRPcHRpb25zO1xyXG5cclxuICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtID0gbmV3IEVudmlyb25tZW50TW9kZWxWaWV3VHJhbnNmb3JtKCk7XHJcblxyXG4gICAgdGhpcy5zaW11bGF0aW9uTW9kZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIFNpbXVsYXRpb25Nb2RlLlNUQUdFRCwge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3NpbXVsYXRpb25Nb2RlUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdmb3IgaW50ZXJuYWwgUGhFVCB1c2Ugb25seScsIC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvcGhldC1pby9pc3N1ZXMvMTY2MFxyXG4gICAgICBwaGV0aW9SZWFkT25seTogdHJ1ZVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0cnVlLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnaXNQbGF5aW5nUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICd3aGV0aGVyIHRpbWUgaXMgYWR2YW5jaW5nIGluIHRoZSBzaW11bGF0aW9uLCBjb250cm9sbGVkIGJ5IHRoZSBQbGF5L1BhdXNlIGJ1dHRvbidcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnRpbWVTcGVlZFByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIFRpbWVTcGVlZC5OT1JNQUwsIHtcclxuICAgICAgdmFsaWRWYWx1ZXM6IFsgVGltZVNwZWVkLk5PUk1BTCwgVGltZVNwZWVkLkZBU1QgXSxcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICd0aW1lU3BlZWRQcm9wZXJ0eScgKSxcclxuICAgICAgcGhldGlvRG9jdW1lbnRhdGlvbjogJ2NvbnRyb2xzIHRoZSBzcGVlZCBvZiB0aGUgZ2VuZXJhdGlvbiBjbG9jaycsXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy50aW1lU2NhbGVQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoXHJcbiAgICAgIFsgdGhpcy50aW1lU3BlZWRQcm9wZXJ0eSBdLFxyXG4gICAgICB0aW1lU3BlZWQgPT4gKCB0aW1lU3BlZWQgPT09IFRpbWVTcGVlZC5OT1JNQUwgKSA/IDEgOiBOYXR1cmFsU2VsZWN0aW9uUXVlcnlQYXJhbWV0ZXJzLmZhc3RGb3J3YXJkU2NhbGUsIHtcclxuICAgICAgICB0YW5kZW06IFRhbmRlbS5PUFRfT1VUXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmdlbmVyYXRpb25DbG9jayA9IG5ldyBHZW5lcmF0aW9uQ2xvY2soIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdnZW5lcmF0aW9uQ2xvY2snIClcclxuICAgIH0gKTtcclxuICAgIHBoZXQubG9nICYmIHBoZXQubG9nKCAnPT09PT09IEdlbmVyYXRpb24gMCA9PT09PT0nICk7XHJcblxyXG4gICAgdGhpcy5nZW5lUG9vbCA9IG5ldyBHZW5lUG9vbCgge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2dlbmVQb29sJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5pbml0aWFsQnVubnlWYXJpZXRpZXMgPSBwYXJzZUluaXRpYWxQb3B1bGF0aW9uKCBzY3JlZW5LZXksIHRoaXMuZ2VuZVBvb2wgKTtcclxuXHJcbiAgICB0aGlzLmJ1bm55Q29sbGVjdGlvbiA9IG5ldyBCdW5ueUNvbGxlY3Rpb24oIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLCB0aGlzLmdlbmVQb29sLFxyXG4gICAgICBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdidW5ueUNvbGxlY3Rpb24nICkgKTtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZUdlbmVyYXRpb25aZXJvKCk7XHJcblxyXG4gICAgdGhpcy5lbnZpcm9ubWVudFByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIEVudmlyb25tZW50LkVRVUFUT1IsIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdlbnZpcm9ubWVudFByb3BlcnR5JyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy53b2xmQ29sbGVjdGlvbiA9IG5ldyBXb2xmQ29sbGVjdGlvbiggdGhpcy5nZW5lcmF0aW9uQ2xvY2ssIHRoaXMuZW52aXJvbm1lbnRQcm9wZXJ0eSwgdGhpcy5idW5ueUNvbGxlY3Rpb24sXHJcbiAgICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLCBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICd3b2xmQ29sbGVjdGlvbicgKSApO1xyXG5cclxuICAgIHRoaXMuZm9vZCA9IG5ldyBGb29kKCB0aGlzLmdlbmVyYXRpb25DbG9jaywgdGhpcy5idW5ueUNvbGxlY3Rpb24sIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLCBzaHJ1YnNTZWVkLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnZm9vZCcgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE9yZ2FuaXplIGFsbCBncmFwaHMgdW5kZXIgdGhpcyB0YW5kZW1cclxuICAgIGNvbnN0IGdyYXBoc1RhbmRlbSA9IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2dyYXBocycgKTtcclxuXHJcbiAgICB0aGlzLnBvcHVsYXRpb25Nb2RlbCA9IG5ldyBQb3B1bGF0aW9uTW9kZWwoXHJcbiAgICAgIHRoaXMuZ2VuZVBvb2wsXHJcbiAgICAgIHRoaXMuZ2VuZXJhdGlvbkNsb2NrLnRpbWVJbkdlbmVyYXRpb25zUHJvcGVydHksXHJcbiAgICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHksIHtcclxuICAgICAgICB0YW5kZW06IGdyYXBoc1RhbmRlbS5jcmVhdGVUYW5kZW0oICdwb3B1bGF0aW9uTW9kZWwnIClcclxuICAgICAgfSApO1xyXG5cclxuICAgIHRoaXMucHJvcG9ydGlvbnNNb2RlbCA9IG5ldyBQcm9wb3J0aW9uc01vZGVsKFxyXG4gICAgICB0aGlzLmJ1bm55Q29sbGVjdGlvbi5saXZlQnVubmllcy5jb3VudHNQcm9wZXJ0eSxcclxuICAgICAgdGhpcy5nZW5lcmF0aW9uQ2xvY2suY2xvY2tHZW5lcmF0aW9uUHJvcGVydHksXHJcbiAgICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHksIHtcclxuICAgICAgICB0YW5kZW06IGdyYXBoc1RhbmRlbS5jcmVhdGVUYW5kZW0oICdwcm9wb3J0aW9uc01vZGVsJyApXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnBlZGlncmVlTW9kZWwgPSBuZXcgUGVkaWdyZWVNb2RlbCgge1xyXG4gICAgICB0YW5kZW06IGdyYXBoc1RhbmRlbS5jcmVhdGVUYW5kZW0oICdwZWRpZ3JlZU1vZGVsJyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gV2hlbiB0aGUgc2ltdWxhdGlvbiBzdGF0ZSBjaGFuZ2VzLi4uIHVubGluayBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gICAgdGhpcy5zaW11bGF0aW9uTW9kZVByb3BlcnR5LmxpbmsoIHNpbXVsYXRpb25Nb2RlID0+IHtcclxuXHJcbiAgICAgIC8vIFNpbXVsYXRpb25Nb2RlIGluZGljYXRlcyB3aGljaCBtb2RlIHRoZSBzaW11bGF0aW9uIGlzIGluLiBJdCBkb2VzIG5vdCBkZXNjcmliZSBhIGZ1bGwgc3RhdGUgb2YgdGhhdCBtb2RlLlxyXG4gICAgICAvLyBTbyBkbyBub3RoaW5nIHdoZW4gUGhFVC1pTyBpcyByZXN0b3Jpbmcgc3RhdGUsIG9yIHNhdmVkIHN0YXRlIHdpbGwgYmUgb3ZlcndyaXR0ZW4uXHJcbiAgICAgIGlmICggIXBoZXQuam9pc3Quc2ltLmlzU2V0dGluZ1BoZXRpb1N0YXRlUHJvcGVydHkudmFsdWUgKSB7XHJcblxyXG4gICAgICAgIC8vIFdoZW4gdGhlIHNpbXVsYXRpb24gYmVnaW5zLCByZWNvcmQgJ3N0YXJ0JyBkYXRhIGZvciB0aGUgZ3JhcGhzLlxyXG4gICAgICAgIGlmICggc2ltdWxhdGlvbk1vZGUgPT09IFNpbXVsYXRpb25Nb2RlLkFDVElWRSApIHtcclxuICAgICAgICAgIGNvbnN0IGNsb2NrR2VuZXJhdGlvbiA9IHRoaXMuZ2VuZXJhdGlvbkNsb2NrLmNsb2NrR2VuZXJhdGlvblByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgICAgY29uc3QgY291bnRzID0gdGhpcy5idW5ueUNvbGxlY3Rpb24uZ2V0TGl2ZUJ1bm55Q291bnRzKCk7XHJcbiAgICAgICAgICB0aGlzLnByb3BvcnRpb25zTW9kZWwucmVjb3JkU3RhcnRDb3VudHMoIGNsb2NrR2VuZXJhdGlvbiwgY291bnRzICk7XHJcbiAgICAgICAgICB0aGlzLnBvcHVsYXRpb25Nb2RlbC5yZWNvcmRDb3VudHMoIGNsb2NrR2VuZXJhdGlvbiwgY291bnRzICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBBZGp1c3QgdGhlIHNpbSBwbGF5YmFjayBhbmQgZ2VuZXJhdGlvbiBjbG9ja1xyXG4gICAgICAgIGlmICggc2ltdWxhdGlvbk1vZGUgPT09IFNpbXVsYXRpb25Nb2RlLlNUQUdFRCApIHtcclxuICAgICAgICAgIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkudmFsdWUgPSB0cnVlO1xyXG4gICAgICAgICAgdGhpcy5nZW5lcmF0aW9uQ2xvY2suaXNSdW5uaW5nUHJvcGVydHkudmFsdWUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoIHNpbXVsYXRpb25Nb2RlID09PSBTaW11bGF0aW9uTW9kZS5BQ1RJVkUgKSB7XHJcbiAgICAgICAgICB0aGlzLmdlbmVyYXRpb25DbG9jay5pc1J1bm5pbmdQcm9wZXJ0eS52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCBzaW11bGF0aW9uTW9kZSA9PT0gU2ltdWxhdGlvbk1vZGUuQ09NUExFVEVEICkge1xyXG4gICAgICAgICAgdGhpcy5pc1BsYXlpbmdQcm9wZXJ0eS52YWx1ZSA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy5nZW5lcmF0aW9uQ2xvY2suaXNSdW5uaW5nUHJvcGVydHkudmFsdWUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIGB1bnN1cHBvcnRlZCBzaW11bGF0aW9uTW9kZTogJHtzaW11bGF0aW9uTW9kZX1gICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy50aW1lVG9NYXRlUHJvcGVydHkgPSBuZXcgTnVtYmVyUHJvcGVydHkoIDAsIHtcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uT1BUX09VVFxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubWVtb3J5TGltaXRFbWl0dGVyID0gbmV3IEVtaXR0ZXIoIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdtZW1vcnlMaW1pdEVtaXR0ZXInICksXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiB0cnVlLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnZmlyZXMgd2hlbiB0aGUgbWVtb3J5IGxpbWl0IGlzIHJlYWNoZWQgYW5kIHRoZSBzaW11bGF0aW9uIG11c3QgYmUgZW5kZWQnXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gcmVtb3ZlTGlzdGVuZXIgaXMgbm90IG5lY2Vzc2FyeS5cclxuICAgIHRoaXMuZ2VuZXJhdGlvbkNsb2NrLmNsb2NrR2VuZXJhdGlvblByb3BlcnR5LmxpbmsoIGNsb2NrR2VuZXJhdGlvbiA9PiB7XHJcbiAgICAgIGlmICggY2xvY2tHZW5lcmF0aW9uID49IE5hdHVyYWxTZWxlY3Rpb25RdWVyeVBhcmFtZXRlcnMubWF4R2VuZXJhdGlvbnMgKSB7XHJcbiAgICAgICAgdGhpcy5tZW1vcnlMaW1pdEVtaXR0ZXIuZW1pdCgpO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQWxsIHRoZSBzdHVmZiB0aGF0IGhhcHBlbnMgYXQgMTI6MDAgb24gdGhlIGdlbmVyYXRpb24gY2xvY2suXHJcbiAgICAvLyB1bmxpbmsgaXMgbm90IG5lY2Vzc2FyeS5cclxuICAgIHRoaXMuZ2VuZXJhdGlvbkNsb2NrLmNsb2NrR2VuZXJhdGlvblByb3BlcnR5LmxhenlMaW5rKCBjbG9ja0dlbmVyYXRpb24gPT4ge1xyXG5cclxuICAgICAgLy8gV2hlbiByZXN0b3JpbmcgUGhFVC1pTyBzdGF0ZSwgc2tpcCB0aGlzIGNvZGUsIGJlY2F1c2UgZG93bnN0cmVhbSBlbGVtZW50cyBhcmUgYWxyZWFkeSBzdGF0ZWZ1bC5cclxuICAgICAgaWYgKCAhcGhldC5qb2lzdC5zaW0uaXNTZXR0aW5nUGhldGlvU3RhdGVQcm9wZXJ0eS52YWx1ZSApIHtcclxuXHJcbiAgICAgICAgLy8gR2VuZXJhdGlvbiAwIGlzIGluaXRpYWxpemVkIGVsc2V3aGVyZSwgdGhpcyBjb2RlIGlzIGZvciBzdWJzZXF1ZW50IGdlbmVyYXRpb25zLlxyXG4gICAgICAgIGlmICggY2xvY2tHZW5lcmF0aW9uICE9PSAwICkge1xyXG5cclxuICAgICAgICAgIHBoZXQubG9nICYmIHBoZXQubG9nKCBgPT09PT09IEdlbmVyYXRpb24gJHtjbG9ja0dlbmVyYXRpb259ID09PT09PWAgKTtcclxuXHJcbiAgICAgICAgICAvLyBCZWZvcmUgYnVubmllcyBhcmUgYWdlZCBvciBtYXRlZCwgUmVjb3JkICdFbmQgb2YgR2VuZXJhdGlvbicgY291bnRzIGZvciB0aGUgUHJvcG9ydGlvbnMgZ3JhcGguXHJcbiAgICAgICAgICB0aGlzLnByb3BvcnRpb25zTW9kZWwucmVjb3JkRW5kQ291bnRzKCBjbG9ja0dlbmVyYXRpb24gLSAxLCB0aGlzLmJ1bm55Q29sbGVjdGlvbi5nZXRMaXZlQnVubnlDb3VudHMoKSApO1xyXG5cclxuICAgICAgICAgIHBoZXQubG9nICYmIHBoZXQubG9nKCBgbGl2ZSBidW5uaWVzID0gJHt0aGlzLmJ1bm55Q29sbGVjdGlvbi5nZXROdW1iZXJPZkxpdmVCdW5uaWVzKCl9YCApO1xyXG4gICAgICAgICAgcGhldC5sb2cgJiYgcGhldC5sb2coIGBkZWFkIGJ1bm5pZXMgPSAke3RoaXMuYnVubnlDb2xsZWN0aW9uLmdldE51bWJlck9mRGVhZEJ1bm5pZXMoKX1gICk7XHJcbiAgICAgICAgICBwaGV0LmxvZyAmJiBwaGV0LmxvZyggYHJlY2Vzc2l2ZSBtdXRhbnRzID0gJHt0aGlzLmJ1bm55Q29sbGVjdGlvbi5nZXROdW1iZXJPZlJlY2Vzc2l2ZU11dGFudHMoKX1gICk7XHJcblxyXG4gICAgICAgICAgLy8gQWdlIGJ1bm5pZXMsIHNvbWUgbWF5IGRpZSBvZiBvbGQgYWdlLlxyXG4gICAgICAgICAgdGhpcy5idW5ueUNvbGxlY3Rpb24uYWdlQnVubmllcygpO1xyXG5cclxuICAgICAgICAgIHRoaXMuYnVubnlDb2xsZWN0aW9uLnBydW5lRGVhZEJ1bm5pZXMoIGNsb2NrR2VuZXJhdGlvbiApO1xyXG5cclxuICAgICAgICAgIC8vIE1hdGUgYnVubmllcywgd2l0aCBwZXJmb3JtYW5jZSBwcm9maWxpbmcsIHNlZSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy82MFxyXG4gICAgICAgICAgdGhpcy50aW1lVG9NYXRlUHJvcGVydHkudmFsdWUgPSBOYXR1cmFsU2VsZWN0aW9uVXRpbHMudGltZSggKCkgPT4gdGhpcy5idW5ueUNvbGxlY3Rpb24ubWF0ZUJ1bm5pZXMoIGNsb2NrR2VuZXJhdGlvbiApICk7XHJcblxyXG4gICAgICAgICAgLy8gQWZ0ZXIgYnVubmllcyBhcmUgYWdlZCBhbmQgbWF0ZWQsIHJlY29yZCBjb3VudHMgZm9yIGdyYXBocy5cclxuICAgICAgICAgIGNvbnN0IGNvdW50cyA9IHRoaXMuYnVubnlDb2xsZWN0aW9uLmdldExpdmVCdW5ueUNvdW50cygpO1xyXG4gICAgICAgICAgdGhpcy5wcm9wb3J0aW9uc01vZGVsLnJlY29yZFN0YXJ0Q291bnRzKCBjbG9ja0dlbmVyYXRpb24sIGNvdW50cyApO1xyXG4gICAgICAgICAgdGhpcy5wb3B1bGF0aW9uTW9kZWwucmVjb3JkQ291bnRzKCBjbG9ja0dlbmVyYXRpb24sIGNvdW50cyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFJlY29yZCBkYXRhIGZvciB0aGUgUG9wdWxhdGlvbiBncmFwaCB3aGVuIHRoZSBwb3B1bGF0aW9uIGlzIGNoYW5nZWQgYnkgZW52aXJvbm1lbnRhbCBmYWN0b3JzLlxyXG4gICAgY29uc3QgcmVjb3JkQ291bnRzID0gKCB0aW1lSW5HZW5lcmF0aW9uczogbnVtYmVyICkgPT4ge1xyXG4gICAgICBjb25zdCBjb3VudHMgPSB0aGlzLmJ1bm55Q29sbGVjdGlvbi5nZXRMaXZlQnVubnlDb3VudHMoKTtcclxuICAgICAgdGhpcy5wb3B1bGF0aW9uTW9kZWwucmVjb3JkQ291bnRzKCB0aW1lSW5HZW5lcmF0aW9ucywgY291bnRzICk7XHJcbiAgICB9O1xyXG4gICAgdGhpcy53b2xmQ29sbGVjdGlvbi5idW5uaWVzRWF0ZW5FbWl0dGVyLmFkZExpc3RlbmVyKCByZWNvcmRDb3VudHMgKTsgLy8gcmVtb3ZlTGlzdGVuZXIgaXMgbm90IG5lY2Vzc2FyeS5cclxuICAgIHRoaXMuZm9vZC5idW5uaWVzU3RhcnZlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHJlY29yZENvdW50cyApOyAvLyByZW1vdmVMaXN0ZW5lciBpcyBub3QgbmVjZXNzYXJ5LlxyXG4gIH1cclxuXHJcbiAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Rpc3Bvc2UgaXMgbm90IHN1cHBvcnRlZCwgZXhpc3RzIGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIHNpbScgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc2V0cyB0aGUgZW50aXJlIG1vZGVsIHdoZW4gdGhlICdSZXNldCBBbGwnIGJ1dHRvbiBpcyBwcmVzc2VkLlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcclxuXHJcbiAgICAvLyBUaGVzZSBQcm9wZXJ0aWVzIGFyZSBub3QgcmVzZXQgYnkgc3RhcnRPdmVyXHJcbiAgICB0aGlzLnRpbWVTcGVlZFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmVudmlyb25tZW50UHJvcGVydHkucmVzZXQoKTtcclxuXHJcbiAgICAvLyBFdmVyeXRoaW5nIGVsc2UgaXMgdGhlIHNhbWUgYXMgc3RhcnRPdmVyXHJcbiAgICB0aGlzLnN0YXJ0T3ZlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXRzIHBhcnQgb2YgdGhlIG1vZGVsIHdoZW4gdGhlICdTdGFydCBPdmVyJyBidXR0b24gaXMgcHJlc3NlZC5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhcnRPdmVyKCk6IHZvaWQge1xyXG5cclxuICAgIHBoZXQubG9nICYmIHBoZXQubG9nKCAnPT09PT09IEdlbmVyYXRpb24gMCA9PT09PT0nICk7XHJcblxyXG4gICAgdGhpcy5pc1BsYXlpbmdQcm9wZXJ0eS5yZXNldCgpOyAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL25hdHVyYWwtc2VsZWN0aW9uL2lzc3Vlcy81NVxyXG4gICAgdGhpcy5nZW5lcmF0aW9uQ2xvY2sucmVzZXQoKTtcclxuXHJcbiAgICB0aGlzLmdlbmVQb29sLnJlc2V0KCk7XHJcblxyXG4gICAgdGhpcy5idW5ueUNvbGxlY3Rpb24ucmVzZXQoKTtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZUdlbmVyYXRpb25aZXJvKCk7XHJcblxyXG4gICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9uYXR1cmFsLXNlbGVjdGlvbi9pc3N1ZXMvOTFcclxuICAgIHRoaXMud29sZkNvbGxlY3Rpb24ucmVzZXQoKTtcclxuICAgIHRoaXMuZm9vZC5yZXNldCgpO1xyXG5cclxuICAgIHRoaXMucG9wdWxhdGlvbk1vZGVsLnJlc2V0KCk7XHJcbiAgICB0aGlzLnByb3BvcnRpb25zTW9kZWwucmVzZXQoKTtcclxuICAgIHRoaXMucGVkaWdyZWVNb2RlbC5yZXNldCgpO1xyXG5cclxuICAgIC8vIFJlc2V0IHRoZSBtb2RlIGxhc3QsIGJlY2F1c2UgbGlzdGVuZXJzIG1heSBpbnNwZWN0IG90aGVyIG1vZGVsIHN0YXRlLlxyXG4gICAgdGhpcy5zaW11bGF0aW9uTW9kZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGVwcyB0aGUgbW9kZWwuXHJcbiAgICogQHBhcmFtIGR0IC0gdGltZSBzdGVwLCBpbiBzZWNvbmRzXHJcbiAgICovXHJcbiAgcHVibGljIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMuaXNQbGF5aW5nUHJvcGVydHkudmFsdWUgKSB7XHJcblxyXG4gICAgICAvLyBTbyB3ZSBjYW4ndCBtYWtlIHRoZSBzaW0gcnVuIHNvIGZhc3QgdGhhdCBpdCBza2lwcyBnZW5lcmF0aW9ucyxcclxuICAgICAgZHQgPSBHZW5lcmF0aW9uQ2xvY2suY29uc3RyYWluRHQoIGR0ICk7XHJcblxyXG4gICAgICAvLyBzdGVwIHRoZSBnZW5lcmF0aW9uIGNsb2NrXHJcbiAgICAgIHRoaXMuZ2VuZXJhdGlvbkNsb2NrLnN0ZXAoIGR0ICogdGhpcy50aW1lU2NhbGVQcm9wZXJ0eS52YWx1ZSApO1xyXG5cclxuICAgICAgLy8gbW92ZSB0aGUgYnVubmllc1xyXG4gICAgICB0aGlzLmJ1bm55Q29sbGVjdGlvbi5tb3ZlQnVubmllcyggZHQgKTtcclxuXHJcbiAgICAgIC8vIG1vdmUgdGhlIHdvbHZlc1xyXG4gICAgICB0aGlzLndvbGZDb2xsZWN0aW9uLm1vdmVXb2x2ZXMoIGR0ICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIGEgbWF0ZSBmb3IgYSBsb25lIGJ1bm55LlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRBTWF0ZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMuYnVubnlDb2xsZWN0aW9uLmdldE51bWJlck9mTGl2ZUJ1bm5pZXMoKSA9PT0gMSwgJ3RoZXJlIHNob3VsZCBvbmx5IGJlIDEgbGl2ZSBidW5ueScgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMuZ2VuZXJhdGlvbkNsb2NrLmNsb2NrR2VuZXJhdGlvblByb3BlcnR5LnZhbHVlID09PSAwLCAndW5leHBlY3RlZCBjbG9ja0dlbmVyYXRpb24nICk7XHJcblxyXG4gICAgdGhpcy5idW5ueUNvbGxlY3Rpb24uY3JlYXRlQnVubnlaZXJvKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbml0aWFsaXplcyB0aGUgZ2VuZXJhdGlvbi16ZXJvIGJ1bm55IHBvcHVsYXRpb24uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplR2VuZXJhdGlvblplcm8oKTogdm9pZCB7XHJcblxyXG4gICAgcGhldC5sb2cgJiYgcGhldC5sb2coICdOYXR1cmFsU2VsZWN0aW9uTW9kZWwuaW5pdGlhbGl6ZUdlbmVyYXRpb25aZXJvJyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5idW5ueUNvbGxlY3Rpb24uZ2V0TnVtYmVyT2ZMaXZlQnVubmllcygpID09PSAwLCAnYnVubmllcyBhbHJlYWR5IGV4aXN0JyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5nZW5lcmF0aW9uQ2xvY2suY2xvY2tHZW5lcmF0aW9uUHJvcGVydHkudmFsdWUgPT09IDAsICd1bmV4cGVjdGVkIGNsb2NrR2VuZXJhdGlvbicgKTtcclxuXHJcbiAgICAvLyBGb3IgZWFjaCB7QnVubnlWYXJpZXR5fSBpbiB0aGUgaW5pdGlhbCBwb3B1bGF0aW9uLCBjcmVhdGUgYnVubmllcyBvZiB0aGF0IHZhcmlldHkuXHJcbiAgICB0aGlzLmluaXRpYWxCdW5ueVZhcmlldGllcy5mb3JFYWNoKCB2YXJpZXR5ID0+IHtcclxuICAgICAgcGhldC5sb2cgJiYgcGhldC5sb2coIGBjcmVhdGluZyAke3ZhcmlldHkuY291bnR9IGJ1bm5pZXMgd2l0aCBnZW5vdHlwZSAnJHt2YXJpZXR5Lmdlbm90eXBlU3RyaW5nfSdgICk7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHZhcmlldHkuY291bnQ7IGkrKyApIHtcclxuICAgICAgICB0aGlzLmJ1bm55Q29sbGVjdGlvbi5jcmVhdGVCdW5ueVplcm8oIHtcclxuICAgICAgICAgIGdlbm90eXBlT3B0aW9uczoge1xyXG4gICAgICAgICAgICBmYXRoZXJGdXJBbGxlbGU6IHZhcmlldHkuZmF0aGVyRnVyQWxsZWxlLFxyXG4gICAgICAgICAgICBtb3RoZXJGdXJBbGxlbGU6IHZhcmlldHkubW90aGVyRnVyQWxsZWxlLFxyXG4gICAgICAgICAgICBmYXRoZXJFYXJzQWxsZWxlOiB2YXJpZXR5LmZhdGhlckVhcnNBbGxlbGUsXHJcbiAgICAgICAgICAgIG1vdGhlckVhcnNBbGxlbGU6IHZhcmlldHkubW90aGVyRWFyc0FsbGVsZSxcclxuICAgICAgICAgICAgZmF0aGVyVGVldGhBbGxlbGU6IHZhcmlldHkuZmF0aGVyVGVldGhBbGxlbGUsXHJcbiAgICAgICAgICAgIG1vdGhlclRlZXRoQWxsZWxlOiB2YXJpZXR5Lm1vdGhlclRlZXRoQWxsZWxlXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5uYXR1cmFsU2VsZWN0aW9uLnJlZ2lzdGVyKCAnTmF0dXJhbFNlbGVjdGlvbk1vZGVsJywgTmF0dXJhbFNlbGVjdGlvbk1vZGVsICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxPQUFPLE1BQU0sZ0NBQWdDO0FBQ3BELE9BQU9DLG1CQUFtQixNQUFNLDRDQUE0QztBQUM1RSxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBS2xFLE9BQU9DLFNBQVMsTUFBTSwwQ0FBMEM7QUFFaEUsT0FBT0MsTUFBTSxNQUFNLGlDQUFpQztBQUNwRCxPQUFPQyxnQkFBZ0IsTUFBTSwyQkFBMkI7QUFDeEQsT0FBT0MsK0JBQStCLE1BQU0sdUNBQXVDO0FBQ25GLE9BQU9DLHFCQUFxQixNQUFNLDZCQUE2QjtBQUMvRCxPQUFPQyxlQUFlLE1BQU0sc0JBQXNCO0FBQ2xELE9BQU9DLFdBQVcsTUFBTSxrQkFBa0I7QUFDMUMsT0FBT0MsNkJBQTZCLE1BQU0sb0NBQW9DO0FBQzlFLE9BQU9DLElBQUksTUFBTSxXQUFXO0FBQzVCLE9BQU9DLFFBQVEsTUFBTSxlQUFlO0FBQ3BDLE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFDbEQsT0FBT0Msc0JBQXNCLE1BQXFCLDZCQUE2QjtBQUMvRSxPQUFPQyxhQUFhLE1BQU0sb0JBQW9CO0FBQzlDLE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFDbEQs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