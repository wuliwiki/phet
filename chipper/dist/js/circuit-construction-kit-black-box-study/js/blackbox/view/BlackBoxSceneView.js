// Copyright 2016-2023, University of Colorado Boulder
// TODO: Review, document, annotate, i18n, bring up to standards

/**
 * One scene focuses on one black box, and has a separate model + view because scenes are independent.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import stepTimer from '../../../../axon/js/stepTimer.js';
import CCKCConstants from '../../../../circuit-construction-kit-common/js/CCKCConstants.js';
import CCKCScreenView from '../../../../circuit-construction-kit-common/js/view/CCKCScreenView.js';
import CircuitElementToolFactory from '../../../../circuit-construction-kit-common/js/view/CircuitElementToolFactory.js';
import ScreenView from '../../../../joist/js/ScreenView.js';
import { Node, Text } from '../../../../scenery/js/imports.js';
import ComboBox from '../../../../sun/js/ComboBox.js';
import circuitConstructionKitBlackBoxStudy from '../../circuitConstructionKitBlackBoxStudy.js';
import BlackBoxQueryParameters from '../BlackBoxQueryParameters.js';
import ChallengeSet from '../model/ChallengeSet.js';
import BlackBoxNode from './BlackBoxNode.js';
import ModeRadioButtonGroup from './ModeRadioButtonGroup.js';
import RevealButton from './RevealButton.js';
import WhiteBoxNode from './WhiteBoxNode.js';

// constants
// const FADED_COLOR = new Color( '#e3edfc' );
// const SOLID_COLOR = CCKCColors.screenBackgroundColorProperty;

class BlackBoxSceneView extends CCKCScreenView {
  /**
   * @param {number} blackBoxWidth - the width of the black box in view coordinates
   * @param {number} blackBoxHeight - the height of the black box in view coordinates
   * @param {BlackBoxSceneModel} blackBoxSceneModel - the model for the scene to display
   * @param {Property.<string>} sceneProperty - for switching screens
   * @param {Tandem} tandem
   */
  constructor(blackBoxWidth, blackBoxHeight, blackBoxSceneModel, sceneProperty, tandem) {
    const circuitElementToolFactory = new CircuitElementToolFactory(blackBoxSceneModel.circuit, blackBoxSceneModel.showLabelsProperty, blackBoxSceneModel.viewTypeProperty, point => this.circuitNode.globalToLocalPoint(point), tandem.createTandem('circuitElementToolbox').createTandem('carousel').createTandem('circuitElementTools'));

    // Tool nodes that appear on every screen. Pagination for the carousel, each page should begin with wire node
    const circuitElementToolNodes = [
    // This page is duplicated in the Lab Screen View
    circuitElementToolFactory.createWireToolNode(), circuitElementToolFactory.createRightBatteryToolNode(), circuitElementToolFactory.createLightBulbToolNode(), circuitElementToolFactory.createResistorToolNode(), circuitElementToolFactory.createSwitchToolNode(), circuitElementToolFactory.createWireToolNode(), circuitElementToolFactory.createDollarBillToolNode(), circuitElementToolFactory.createPaperClipToolNode(), circuitElementToolFactory.createCoinToolNode(), circuitElementToolFactory.createEraserToolNode(), circuitElementToolFactory.createWireToolNode(), circuitElementToolFactory.createPencilToolNode()];
    super(blackBoxSceneModel, circuitElementToolNodes, tandem, {
      blackBoxStudy: true
    });

    // Add 'Explore' and 'Test' radio buttons under the sensor toolbox
    const modeRadioButtonGroup = new ModeRadioButtonGroup(blackBoxSceneModel.modeProperty, tandem.createTandem('modeRadioButtonGroup'));
    this.addChild(modeRadioButtonGroup);
    const revealButton = new RevealButton(blackBoxSceneModel.revealingProperty, blackBoxSceneModel.isRevealEnabledProperty, tandem.createTandem('revealButton'));

    // The reveal button can be hidden with a sim-specific query parameter
    if (BlackBoxQueryParameters.showRevealButton) {
      this.addChild(revealButton);
    }

    // Circuit components and ammeter/voltmeter should be in front of these controls
    modeRadioButtonGroup.moveToBack();
    revealButton.moveToBack();

    // Options for Text instances that will appear in the ComboBox
    const comboBoxTextOptions = {
      fontSize: 16
    };

    // A different ComboBox instance appears in each BlackBoxSceneView
    const elements = [{
      value: 'warmup',
      createNode: () => new Text('Warm-up', comboBoxTextOptions),
      // TODO: i18n
      tandemName: `warmup${ComboBox.ITEM_TANDEM_NAME_SUFFIX}`
    }];
    for (let i = 0; i < ChallengeSet.challengeArray.length; i++) {
      elements.push({
        value: `scene${i}`,
        createNode: () => new Text(`Black Box ${i + 1}`, comboBoxTextOptions),
        // TODO: i18n
        tandemName: `scene${i}${ComboBox.ITEM_TANDEM_NAME_SUFFIX}`
      });
    }

    // create a node to keep track of combo box popup menu
    const listParent = new Node();
    const sceneSelectionComboBox = new ComboBox(sceneProperty, elements, listParent, {
      xMargin: 12,
      yMargin: 10,
      cornerRadius: 6,
      tandem: tandem.createTandem('sceneSelectionComboBox')
    });
    this.addChild(sceneSelectionComboBox);
    this.addChild(listParent); // Must be in front of ComboBox

    // Layout when the screen view size changed
    this.visibleBoundsProperty.link(visibleBounds => {
      modeRadioButtonGroup.top = this.sensorToolbox.bottom + 20;
      modeRadioButtonGroup.right = this.sensorToolbox.right;
      revealButton.top = modeRadioButtonGroup.bottom + 10;
      revealButton.right = modeRadioButtonGroup.right;
      sceneSelectionComboBox.centerX = visibleBounds.centerX;
      sceneSelectionComboBox.top = visibleBounds.top + CCKCConstants.VERTICAL_MARGIN;
      listParent.left = sceneSelectionComboBox.left;
      listParent.top = sceneSelectionComboBox.bottom;
    });
    const blackBoxNode = new BlackBoxNode(blackBoxWidth, blackBoxHeight, blackBoxSceneModel.revealingProperty, {
      // Assumes the default layout bounds are used
      center: ScreenView.DEFAULT_LAYOUT_BOUNDS.center
    });

    // Expand the black box bounds so all of the black box vertices are inside the bounds, see #128
    blackBoxSceneModel.blackBoxBounds = blackBoxNode.bounds.dilated(7);
    blackBoxSceneModel.revealingProperty.link(revealing => {
      blackBoxNode.opacity = revealing ? 0.2 : 1.0;
    });
    blackBoxSceneModel.modeProperty.link(mode => {
      blackBoxNode.visible = mode === 'explore';
    });
    const whiteBoxNode = new WhiteBoxNode(blackBoxWidth, blackBoxHeight, {
      // Assumes the default layout bounds are used
      centerX: ScreenView.DEFAULT_LAYOUT_BOUNDS.width / 2,
      centerY: ScreenView.DEFAULT_LAYOUT_BOUNDS.height / 2
    });
    blackBoxSceneModel.modeProperty.link(mode => {
      whiteBoxNode.visible = mode === 'test';
    });

    // Interleave the black/white box node in the nodes, so things may go in front of it.
    this.circuitNode.afterCircuitElementsLayer.addChild(blackBoxNode);

    // Store the black box node reference for help with layering
    this.circuitNode.beforeCircuitElementsLayer.addChild(whiteBoxNode);

    // Update the layering of view objects when the mode changes
    Multilink.multilink([blackBoxSceneModel.modeProperty, blackBoxSceneModel.isValueDepictionEnabledProperty], (mode, isValueDepictionEnabled) => {
      const isTestMode = mode === 'test';

      // self.backgroundPlane.fill = !isValueDepictionEnabled ? 'gray' :
      //                             isTestMode ? FADED_COLOR :
      //                             SOLID_COLOR;
      if (isTestMode) {
        this.circuitElementToolbox.moveToFront();
      } else {

        // investigate mode - move black box circuit elements to the back so they won't appear in front of the black box
        // TODO: fix layering
      }
      whiteBoxNode.moveToBack();
    });

    // @private - When reset, move the boxes in front of the black box circuit elements
    this.resetBlackBoxSceneView = () => {
      blackBoxNode.moveToFront();
      whiteBoxNode.moveToBack();
    };

    // When dropping an object in "build mode", its vertices should pop inside the black box, see #113
    // TODO: Let's move this to the model, and make the blackBoxNodeBounds available there.
    blackBoxSceneModel.circuit.vertexDroppedEmitter.addListener(vertex => {
      // Allow the wire drag event to complete so that the wire won't think it was released near another target
      // and attach to it, see #173
      stepTimer.setTimeout(() => {
        // If the wire connected to a black box vertex, then it may no longer exist in the model. In this case there is
        // no need to move it inside the black box.
        if (blackBoxSceneModel.circuit.vertexGroup.includes(vertex) && blackBoxSceneModel.modeProperty.get() === 'test') {
          // Find all the vertices that must be translated into the box, translating wires
          (() => {
            const vertices = blackBoxSceneModel.circuit.findAllConnectedVertices(vertex);
            const connectedToBlackBox = vertices.filter(v => v.blackBoxInterfaceProperty.get()).length > 0;
            if (!connectedToBlackBox) {
              for (let i = 0; i < vertices.length; i++) {
                const vertexInGroup = vertices[i];
                const closestPoint = blackBoxNode.bounds.eroded(30).closestPointTo(vertexInGroup.positionProperty.get());
                const delta = closestPoint.minus(vertexInGroup.positionProperty.get());
                this.circuitNode.translateVertexGroup(vertexInGroup, vertices, delta, null, []);
              }
            }
          })();

          // Find all the vertices that must be translated into the box, shrinking wires
          // TODO: Factor out
          (() => {
            const vertices = blackBoxSceneModel.circuit.findAllFixedVertices(vertex);
            const connectedToBlackBox = vertices.filter(v => v.blackBoxInterfaceProperty.get()).length > 0;
            if (!connectedToBlackBox) {
              for (let i = 0; i < vertices.length; i++) {
                const vertexInGroup = vertices[i];
                const closestPoint = blackBoxNode.bounds.eroded(30).closestPointTo(vertexInGroup.positionProperty.get());
                const delta = closestPoint.minus(vertexInGroup.positionProperty.get());
                this.circuitNode.translateVertexGroup(vertexInGroup, vertices, delta, null, []);
              }
            }
          })();
        }
      }, 0);
    });
  }

  /**
   * Reset the BlackBoxSceneView
   * @public
   */
  reset() {
    super.reset();
    this.resetBlackBoxSceneView();
  }
}
circuitConstructionKitBlackBoxStudy.register('BlackBoxSceneView', BlackBoxSceneView);
export default BlackBoxSceneView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJzdGVwVGltZXIiLCJDQ0tDQ29uc3RhbnRzIiwiQ0NLQ1NjcmVlblZpZXciLCJDaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5IiwiU2NyZWVuVmlldyIsIk5vZGUiLCJUZXh0IiwiQ29tYm9Cb3giLCJjaXJjdWl0Q29uc3RydWN0aW9uS2l0QmxhY2tCb3hTdHVkeSIsIkJsYWNrQm94UXVlcnlQYXJhbWV0ZXJzIiwiQ2hhbGxlbmdlU2V0IiwiQmxhY2tCb3hOb2RlIiwiTW9kZVJhZGlvQnV0dG9uR3JvdXAiLCJSZXZlYWxCdXR0b24iLCJXaGl0ZUJveE5vZGUiLCJCbGFja0JveFNjZW5lVmlldyIsImNvbnN0cnVjdG9yIiwiYmxhY2tCb3hXaWR0aCIsImJsYWNrQm94SGVpZ2h0IiwiYmxhY2tCb3hTY2VuZU1vZGVsIiwic2NlbmVQcm9wZXJ0eSIsInRhbmRlbSIsImNpcmN1aXRFbGVtZW50VG9vbEZhY3RvcnkiLCJjaXJjdWl0Iiwic2hvd0xhYmVsc1Byb3BlcnR5Iiwidmlld1R5cGVQcm9wZXJ0eSIsInBvaW50IiwiY2lyY3VpdE5vZGUiLCJnbG9iYWxUb0xvY2FsUG9pbnQiLCJjcmVhdGVUYW5kZW0iLCJjaXJjdWl0RWxlbWVudFRvb2xOb2RlcyIsImNyZWF0ZVdpcmVUb29sTm9kZSIsImNyZWF0ZVJpZ2h0QmF0dGVyeVRvb2xOb2RlIiwiY3JlYXRlTGlnaHRCdWxiVG9vbE5vZGUiLCJjcmVhdGVSZXNpc3RvclRvb2xOb2RlIiwiY3JlYXRlU3dpdGNoVG9vbE5vZGUiLCJjcmVhdGVEb2xsYXJCaWxsVG9vbE5vZGUiLCJjcmVhdGVQYXBlckNsaXBUb29sTm9kZSIsImNyZWF0ZUNvaW5Ub29sTm9kZSIsImNyZWF0ZUVyYXNlclRvb2xOb2RlIiwiY3JlYXRlUGVuY2lsVG9vbE5vZGUiLCJibGFja0JveFN0dWR5IiwibW9kZVJhZGlvQnV0dG9uR3JvdXAiLCJtb2RlUHJvcGVydHkiLCJhZGRDaGlsZCIsInJldmVhbEJ1dHRvbiIsInJldmVhbGluZ1Byb3BlcnR5IiwiaXNSZXZlYWxFbmFibGVkUHJvcGVydHkiLCJzaG93UmV2ZWFsQnV0dG9uIiwibW92ZVRvQmFjayIsImNvbWJvQm94VGV4dE9wdGlvbnMiLCJmb250U2l6ZSIsImVsZW1lbnRzIiwidmFsdWUiLCJjcmVhdGVOb2RlIiwidGFuZGVtTmFtZSIsIklURU1fVEFOREVNX05BTUVfU1VGRklYIiwiaSIsImNoYWxsZW5nZUFycmF5IiwibGVuZ3RoIiwicHVzaCIsImxpc3RQYXJlbnQiLCJzY2VuZVNlbGVjdGlvbkNvbWJvQm94IiwieE1hcmdpbiIsInlNYXJnaW4iLCJjb3JuZXJSYWRpdXMiLCJ2aXNpYmxlQm91bmRzUHJvcGVydHkiLCJsaW5rIiwidmlzaWJsZUJvdW5kcyIsInRvcCIsInNlbnNvclRvb2xib3giLCJib3R0b20iLCJyaWdodCIsImNlbnRlclgiLCJWRVJUSUNBTF9NQVJHSU4iLCJsZWZ0IiwiYmxhY2tCb3hOb2RlIiwiY2VudGVyIiwiREVGQVVMVF9MQVlPVVRfQk9VTkRTIiwiYmxhY2tCb3hCb3VuZHMiLCJib3VuZHMiLCJkaWxhdGVkIiwicmV2ZWFsaW5nIiwib3BhY2l0eSIsIm1vZGUiLCJ2aXNpYmxlIiwid2hpdGVCb3hOb2RlIiwid2lkdGgiLCJjZW50ZXJZIiwiaGVpZ2h0IiwiYWZ0ZXJDaXJjdWl0RWxlbWVudHNMYXllciIsImJlZm9yZUNpcmN1aXRFbGVtZW50c0xheWVyIiwibXVsdGlsaW5rIiwiaXNWYWx1ZURlcGljdGlvbkVuYWJsZWRQcm9wZXJ0eSIsImlzVmFsdWVEZXBpY3Rpb25FbmFibGVkIiwiaXNUZXN0TW9kZSIsImNpcmN1aXRFbGVtZW50VG9vbGJveCIsIm1vdmVUb0Zyb250IiwicmVzZXRCbGFja0JveFNjZW5lVmlldyIsInZlcnRleERyb3BwZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJ2ZXJ0ZXgiLCJzZXRUaW1lb3V0IiwidmVydGV4R3JvdXAiLCJpbmNsdWRlcyIsImdldCIsInZlcnRpY2VzIiwiZmluZEFsbENvbm5lY3RlZFZlcnRpY2VzIiwiY29ubmVjdGVkVG9CbGFja0JveCIsImZpbHRlciIsInYiLCJibGFja0JveEludGVyZmFjZVByb3BlcnR5IiwidmVydGV4SW5Hcm91cCIsImNsb3Nlc3RQb2ludCIsImVyb2RlZCIsImNsb3Nlc3RQb2ludFRvIiwicG9zaXRpb25Qcm9wZXJ0eSIsImRlbHRhIiwibWludXMiLCJ0cmFuc2xhdGVWZXJ0ZXhHcm91cCIsImZpbmRBbGxGaXhlZFZlcnRpY2VzIiwicmVzZXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJsYWNrQm94U2NlbmVWaWV3LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG4vLyBUT0RPOiBSZXZpZXcsIGRvY3VtZW50LCBhbm5vdGF0ZSwgaTE4biwgYnJpbmcgdXAgdG8gc3RhbmRhcmRzXHJcblxyXG4vKipcclxuICogT25lIHNjZW5lIGZvY3VzZXMgb24gb25lIGJsYWNrIGJveCwgYW5kIGhhcyBhIHNlcGFyYXRlIG1vZGVsICsgdmlldyBiZWNhdXNlIHNjZW5lcyBhcmUgaW5kZXBlbmRlbnQuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBzdGVwVGltZXIgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9zdGVwVGltZXIuanMnO1xyXG5pbXBvcnQgQ0NLQ0NvbnN0YW50cyBmcm9tICcuLi8uLi8uLi8uLi9jaXJjdWl0LWNvbnN0cnVjdGlvbi1raXQtY29tbW9uL2pzL0NDS0NDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgQ0NLQ1NjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWNvbW1vbi9qcy92aWV3L0NDS0NTY3JlZW5WaWV3LmpzJztcclxuaW1wb3J0IENpcmN1aXRFbGVtZW50VG9vbEZhY3RvcnkgZnJvbSAnLi4vLi4vLi4vLi4vY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWNvbW1vbi9qcy92aWV3L0NpcmN1aXRFbGVtZW50VG9vbEZhY3RvcnkuanMnO1xyXG5pbXBvcnQgU2NyZWVuVmlldyBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9TY3JlZW5WaWV3LmpzJztcclxuaW1wb3J0IHsgTm9kZSwgVGV4dCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBDb21ib0JveCBmcm9tICcuLi8uLi8uLi8uLi9zdW4vanMvQ29tYm9Cb3guanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdEJsYWNrQm94U3R1ZHkgZnJvbSAnLi4vLi4vY2lyY3VpdENvbnN0cnVjdGlvbktpdEJsYWNrQm94U3R1ZHkuanMnO1xyXG5pbXBvcnQgQmxhY2tCb3hRdWVyeVBhcmFtZXRlcnMgZnJvbSAnLi4vQmxhY2tCb3hRdWVyeVBhcmFtZXRlcnMuanMnO1xyXG5pbXBvcnQgQ2hhbGxlbmdlU2V0IGZyb20gJy4uL21vZGVsL0NoYWxsZW5nZVNldC5qcyc7XHJcbmltcG9ydCBCbGFja0JveE5vZGUgZnJvbSAnLi9CbGFja0JveE5vZGUuanMnO1xyXG5pbXBvcnQgTW9kZVJhZGlvQnV0dG9uR3JvdXAgZnJvbSAnLi9Nb2RlUmFkaW9CdXR0b25Hcm91cC5qcyc7XHJcbmltcG9ydCBSZXZlYWxCdXR0b24gZnJvbSAnLi9SZXZlYWxCdXR0b24uanMnO1xyXG5pbXBvcnQgV2hpdGVCb3hOb2RlIGZyb20gJy4vV2hpdGVCb3hOb2RlLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG4vLyBjb25zdCBGQURFRF9DT0xPUiA9IG5ldyBDb2xvciggJyNlM2VkZmMnICk7XHJcbi8vIGNvbnN0IFNPTElEX0NPTE9SID0gQ0NLQ0NvbG9ycy5zY3JlZW5CYWNrZ3JvdW5kQ29sb3JQcm9wZXJ0eTtcclxuXHJcbmNsYXNzIEJsYWNrQm94U2NlbmVWaWV3IGV4dGVuZHMgQ0NLQ1NjcmVlblZpZXcge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBibGFja0JveFdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSBibGFjayBib3ggaW4gdmlldyBjb29yZGluYXRlc1xyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBibGFja0JveEhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIGJsYWNrIGJveCBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgICogQHBhcmFtIHtCbGFja0JveFNjZW5lTW9kZWx9IGJsYWNrQm94U2NlbmVNb2RlbCAtIHRoZSBtb2RlbCBmb3IgdGhlIHNjZW5lIHRvIGRpc3BsYXlcclxuICAgKiBAcGFyYW0ge1Byb3BlcnR5LjxzdHJpbmc+fSBzY2VuZVByb3BlcnR5IC0gZm9yIHN3aXRjaGluZyBzY3JlZW5zXHJcbiAgICogQHBhcmFtIHtUYW5kZW19IHRhbmRlbVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBibGFja0JveFdpZHRoLCBibGFja0JveEhlaWdodCwgYmxhY2tCb3hTY2VuZU1vZGVsLCBzY2VuZVByb3BlcnR5LCB0YW5kZW0gKSB7XHJcblxyXG4gICAgY29uc3QgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeSA9IG5ldyBDaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5KFxyXG4gICAgICBibGFja0JveFNjZW5lTW9kZWwuY2lyY3VpdCxcclxuICAgICAgYmxhY2tCb3hTY2VuZU1vZGVsLnNob3dMYWJlbHNQcm9wZXJ0eSxcclxuICAgICAgYmxhY2tCb3hTY2VuZU1vZGVsLnZpZXdUeXBlUHJvcGVydHksXHJcbiAgICAgIHBvaW50ID0+IHRoaXMuY2lyY3VpdE5vZGUuZ2xvYmFsVG9Mb2NhbFBvaW50KCBwb2ludCApLFxyXG4gICAgICB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnY2lyY3VpdEVsZW1lbnRUb29sYm94JyApLmNyZWF0ZVRhbmRlbSggJ2Nhcm91c2VsJyApLmNyZWF0ZVRhbmRlbSggJ2NpcmN1aXRFbGVtZW50VG9vbHMnIClcclxuICAgICk7XHJcblxyXG4gICAgLy8gVG9vbCBub2RlcyB0aGF0IGFwcGVhciBvbiBldmVyeSBzY3JlZW4uIFBhZ2luYXRpb24gZm9yIHRoZSBjYXJvdXNlbCwgZWFjaCBwYWdlIHNob3VsZCBiZWdpbiB3aXRoIHdpcmUgbm9kZVxyXG4gICAgY29uc3QgY2lyY3VpdEVsZW1lbnRUb29sTm9kZXMgPSBbXHJcblxyXG4gICAgICAvLyBUaGlzIHBhZ2UgaXMgZHVwbGljYXRlZCBpbiB0aGUgTGFiIFNjcmVlbiBWaWV3XHJcbiAgICAgIGNpcmN1aXRFbGVtZW50VG9vbEZhY3RvcnkuY3JlYXRlV2lyZVRvb2xOb2RlKCksXHJcbiAgICAgIGNpcmN1aXRFbGVtZW50VG9vbEZhY3RvcnkuY3JlYXRlUmlnaHRCYXR0ZXJ5VG9vbE5vZGUoKSxcclxuICAgICAgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeS5jcmVhdGVMaWdodEJ1bGJUb29sTm9kZSgpLFxyXG4gICAgICBjaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5LmNyZWF0ZVJlc2lzdG9yVG9vbE5vZGUoKSxcclxuICAgICAgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeS5jcmVhdGVTd2l0Y2hUb29sTm9kZSgpLFxyXG5cclxuICAgICAgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeS5jcmVhdGVXaXJlVG9vbE5vZGUoKSxcclxuICAgICAgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeS5jcmVhdGVEb2xsYXJCaWxsVG9vbE5vZGUoKSxcclxuICAgICAgY2lyY3VpdEVsZW1lbnRUb29sRmFjdG9yeS5jcmVhdGVQYXBlckNsaXBUb29sTm9kZSgpLFxyXG4gICAgICBjaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5LmNyZWF0ZUNvaW5Ub29sTm9kZSgpLFxyXG4gICAgICBjaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5LmNyZWF0ZUVyYXNlclRvb2xOb2RlKCksXHJcblxyXG4gICAgICBjaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5LmNyZWF0ZVdpcmVUb29sTm9kZSgpLFxyXG4gICAgICBjaXJjdWl0RWxlbWVudFRvb2xGYWN0b3J5LmNyZWF0ZVBlbmNpbFRvb2xOb2RlKClcclxuICAgIF07XHJcblxyXG4gICAgc3VwZXIoIGJsYWNrQm94U2NlbmVNb2RlbCwgY2lyY3VpdEVsZW1lbnRUb29sTm9kZXMsIHRhbmRlbSwge1xyXG4gICAgICBibGFja0JveFN0dWR5OiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQWRkICdFeHBsb3JlJyBhbmQgJ1Rlc3QnIHJhZGlvIGJ1dHRvbnMgdW5kZXIgdGhlIHNlbnNvciB0b29sYm94XHJcbiAgICBjb25zdCBtb2RlUmFkaW9CdXR0b25Hcm91cCA9IG5ldyBNb2RlUmFkaW9CdXR0b25Hcm91cCggYmxhY2tCb3hTY2VuZU1vZGVsLm1vZGVQcm9wZXJ0eSwgdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ21vZGVSYWRpb0J1dHRvbkdyb3VwJyApICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBtb2RlUmFkaW9CdXR0b25Hcm91cCApO1xyXG5cclxuICAgIGNvbnN0IHJldmVhbEJ1dHRvbiA9IG5ldyBSZXZlYWxCdXR0b24oXHJcbiAgICAgIGJsYWNrQm94U2NlbmVNb2RlbC5yZXZlYWxpbmdQcm9wZXJ0eSxcclxuICAgICAgYmxhY2tCb3hTY2VuZU1vZGVsLmlzUmV2ZWFsRW5hYmxlZFByb3BlcnR5LFxyXG4gICAgICB0YW5kZW0uY3JlYXRlVGFuZGVtKCAncmV2ZWFsQnV0dG9uJyApXHJcbiAgICApO1xyXG5cclxuICAgIC8vIFRoZSByZXZlYWwgYnV0dG9uIGNhbiBiZSBoaWRkZW4gd2l0aCBhIHNpbS1zcGVjaWZpYyBxdWVyeSBwYXJhbWV0ZXJcclxuICAgIGlmICggQmxhY2tCb3hRdWVyeVBhcmFtZXRlcnMuc2hvd1JldmVhbEJ1dHRvbiApIHtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggcmV2ZWFsQnV0dG9uICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2lyY3VpdCBjb21wb25lbnRzIGFuZCBhbW1ldGVyL3ZvbHRtZXRlciBzaG91bGQgYmUgaW4gZnJvbnQgb2YgdGhlc2UgY29udHJvbHNcclxuICAgIG1vZGVSYWRpb0J1dHRvbkdyb3VwLm1vdmVUb0JhY2soKTtcclxuICAgIHJldmVhbEJ1dHRvbi5tb3ZlVG9CYWNrKCk7XHJcblxyXG4gICAgLy8gT3B0aW9ucyBmb3IgVGV4dCBpbnN0YW5jZXMgdGhhdCB3aWxsIGFwcGVhciBpbiB0aGUgQ29tYm9Cb3hcclxuICAgIGNvbnN0IGNvbWJvQm94VGV4dE9wdGlvbnMgPSB7XHJcbiAgICAgIGZvbnRTaXplOiAxNlxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBBIGRpZmZlcmVudCBDb21ib0JveCBpbnN0YW5jZSBhcHBlYXJzIGluIGVhY2ggQmxhY2tCb3hTY2VuZVZpZXdcclxuICAgIGNvbnN0IGVsZW1lbnRzID0gWyB7XHJcbiAgICAgIHZhbHVlOiAnd2FybXVwJyxcclxuICAgICAgY3JlYXRlTm9kZTogKCkgPT4gbmV3IFRleHQoICdXYXJtLXVwJywgY29tYm9Cb3hUZXh0T3B0aW9ucyApLCAvLyBUT0RPOiBpMThuXHJcbiAgICAgIHRhbmRlbU5hbWU6IGB3YXJtdXAke0NvbWJvQm94LklURU1fVEFOREVNX05BTUVfU1VGRklYfWBcclxuICAgIH0gXTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IENoYWxsZW5nZVNldC5jaGFsbGVuZ2VBcnJheS5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgZWxlbWVudHMucHVzaCgge1xyXG4gICAgICAgIHZhbHVlOiBgc2NlbmUke2l9YCxcclxuICAgICAgICBjcmVhdGVOb2RlOiAoKSA9PiBuZXcgVGV4dCggYEJsYWNrIEJveCAke2kgKyAxfWAsIGNvbWJvQm94VGV4dE9wdGlvbnMgKSwgLy8gVE9ETzogaTE4blxyXG4gICAgICAgIHRhbmRlbU5hbWU6IGBzY2VuZSR7aX0ke0NvbWJvQm94LklURU1fVEFOREVNX05BTUVfU1VGRklYfWBcclxuICAgICAgfSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNyZWF0ZSBhIG5vZGUgdG8ga2VlcCB0cmFjayBvZiBjb21ibyBib3ggcG9wdXAgbWVudVxyXG4gICAgY29uc3QgbGlzdFBhcmVudCA9IG5ldyBOb2RlKCk7XHJcblxyXG4gICAgY29uc3Qgc2NlbmVTZWxlY3Rpb25Db21ib0JveCA9IG5ldyBDb21ib0JveCggc2NlbmVQcm9wZXJ0eSwgZWxlbWVudHMsIGxpc3RQYXJlbnQsIHtcclxuICAgICAgeE1hcmdpbjogMTIsXHJcbiAgICAgIHlNYXJnaW46IDEwLFxyXG4gICAgICBjb3JuZXJSYWRpdXM6IDYsXHJcbiAgICAgIHRhbmRlbTogdGFuZGVtLmNyZWF0ZVRhbmRlbSggJ3NjZW5lU2VsZWN0aW9uQ29tYm9Cb3gnIClcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHNjZW5lU2VsZWN0aW9uQ29tYm9Cb3ggKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGxpc3RQYXJlbnQgKTsgLy8gTXVzdCBiZSBpbiBmcm9udCBvZiBDb21ib0JveFxyXG5cclxuICAgIC8vIExheW91dCB3aGVuIHRoZSBzY3JlZW4gdmlldyBzaXplIGNoYW5nZWRcclxuICAgIHRoaXMudmlzaWJsZUJvdW5kc1Byb3BlcnR5LmxpbmsoIHZpc2libGVCb3VuZHMgPT4ge1xyXG4gICAgICBtb2RlUmFkaW9CdXR0b25Hcm91cC50b3AgPSB0aGlzLnNlbnNvclRvb2xib3guYm90dG9tICsgMjA7XHJcbiAgICAgIG1vZGVSYWRpb0J1dHRvbkdyb3VwLnJpZ2h0ID0gdGhpcy5zZW5zb3JUb29sYm94LnJpZ2h0O1xyXG5cclxuICAgICAgcmV2ZWFsQnV0dG9uLnRvcCA9IG1vZGVSYWRpb0J1dHRvbkdyb3VwLmJvdHRvbSArIDEwO1xyXG4gICAgICByZXZlYWxCdXR0b24ucmlnaHQgPSBtb2RlUmFkaW9CdXR0b25Hcm91cC5yaWdodDtcclxuXHJcbiAgICAgIHNjZW5lU2VsZWN0aW9uQ29tYm9Cb3guY2VudGVyWCA9IHZpc2libGVCb3VuZHMuY2VudGVyWDtcclxuICAgICAgc2NlbmVTZWxlY3Rpb25Db21ib0JveC50b3AgPSB2aXNpYmxlQm91bmRzLnRvcCArIENDS0NDb25zdGFudHMuVkVSVElDQUxfTUFSR0lOO1xyXG4gICAgICBsaXN0UGFyZW50LmxlZnQgPSBzY2VuZVNlbGVjdGlvbkNvbWJvQm94LmxlZnQ7XHJcbiAgICAgIGxpc3RQYXJlbnQudG9wID0gc2NlbmVTZWxlY3Rpb25Db21ib0JveC5ib3R0b207XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgYmxhY2tCb3hOb2RlID0gbmV3IEJsYWNrQm94Tm9kZSggYmxhY2tCb3hXaWR0aCwgYmxhY2tCb3hIZWlnaHQsIGJsYWNrQm94U2NlbmVNb2RlbC5yZXZlYWxpbmdQcm9wZXJ0eSwge1xyXG5cclxuICAgICAgLy8gQXNzdW1lcyB0aGUgZGVmYXVsdCBsYXlvdXQgYm91bmRzIGFyZSB1c2VkXHJcbiAgICAgIGNlbnRlcjogU2NyZWVuVmlldy5ERUZBVUxUX0xBWU9VVF9CT1VORFMuY2VudGVyXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gRXhwYW5kIHRoZSBibGFjayBib3ggYm91bmRzIHNvIGFsbCBvZiB0aGUgYmxhY2sgYm94IHZlcnRpY2VzIGFyZSBpbnNpZGUgdGhlIGJvdW5kcywgc2VlICMxMjhcclxuICAgIGJsYWNrQm94U2NlbmVNb2RlbC5ibGFja0JveEJvdW5kcyA9IGJsYWNrQm94Tm9kZS5ib3VuZHMuZGlsYXRlZCggNyApO1xyXG4gICAgYmxhY2tCb3hTY2VuZU1vZGVsLnJldmVhbGluZ1Byb3BlcnR5LmxpbmsoIHJldmVhbGluZyA9PiB7XHJcbiAgICAgIGJsYWNrQm94Tm9kZS5vcGFjaXR5ID0gcmV2ZWFsaW5nID8gMC4yIDogMS4wO1xyXG4gICAgfSApO1xyXG4gICAgYmxhY2tCb3hTY2VuZU1vZGVsLm1vZGVQcm9wZXJ0eS5saW5rKCBtb2RlID0+IHtcclxuICAgICAgYmxhY2tCb3hOb2RlLnZpc2libGUgPSBtb2RlID09PSAnZXhwbG9yZSc7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3Qgd2hpdGVCb3hOb2RlID0gbmV3IFdoaXRlQm94Tm9kZSggYmxhY2tCb3hXaWR0aCwgYmxhY2tCb3hIZWlnaHQsIHtcclxuXHJcbiAgICAgIC8vIEFzc3VtZXMgdGhlIGRlZmF1bHQgbGF5b3V0IGJvdW5kcyBhcmUgdXNlZFxyXG4gICAgICBjZW50ZXJYOiBTY3JlZW5WaWV3LkRFRkFVTFRfTEFZT1VUX0JPVU5EUy53aWR0aCAvIDIsXHJcbiAgICAgIGNlbnRlclk6IFNjcmVlblZpZXcuREVGQVVMVF9MQVlPVVRfQk9VTkRTLmhlaWdodCAvIDJcclxuICAgIH0gKTtcclxuICAgIGJsYWNrQm94U2NlbmVNb2RlbC5tb2RlUHJvcGVydHkubGluayggbW9kZSA9PiB7XHJcbiAgICAgIHdoaXRlQm94Tm9kZS52aXNpYmxlID0gbW9kZSA9PT0gJ3Rlc3QnO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEludGVybGVhdmUgdGhlIGJsYWNrL3doaXRlIGJveCBub2RlIGluIHRoZSBub2Rlcywgc28gdGhpbmdzIG1heSBnbyBpbiBmcm9udCBvZiBpdC5cclxuICAgIHRoaXMuY2lyY3VpdE5vZGUuYWZ0ZXJDaXJjdWl0RWxlbWVudHNMYXllci5hZGRDaGlsZCggYmxhY2tCb3hOb2RlICk7XHJcblxyXG4gICAgLy8gU3RvcmUgdGhlIGJsYWNrIGJveCBub2RlIHJlZmVyZW5jZSBmb3IgaGVscCB3aXRoIGxheWVyaW5nXHJcbiAgICB0aGlzLmNpcmN1aXROb2RlLmJlZm9yZUNpcmN1aXRFbGVtZW50c0xheWVyLmFkZENoaWxkKCB3aGl0ZUJveE5vZGUgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIGxheWVyaW5nIG9mIHZpZXcgb2JqZWN0cyB3aGVuIHRoZSBtb2RlIGNoYW5nZXNcclxuICAgIE11bHRpbGluay5tdWx0aWxpbmsoIFsgYmxhY2tCb3hTY2VuZU1vZGVsLm1vZGVQcm9wZXJ0eSwgYmxhY2tCb3hTY2VuZU1vZGVsLmlzVmFsdWVEZXBpY3Rpb25FbmFibGVkUHJvcGVydHkgXSwgKCBtb2RlLCBpc1ZhbHVlRGVwaWN0aW9uRW5hYmxlZCApID0+IHtcclxuICAgICAgY29uc3QgaXNUZXN0TW9kZSA9IG1vZGUgPT09ICd0ZXN0JztcclxuXHJcbiAgICAgIC8vIHNlbGYuYmFja2dyb3VuZFBsYW5lLmZpbGwgPSAhaXNWYWx1ZURlcGljdGlvbkVuYWJsZWQgPyAnZ3JheScgOlxyXG4gICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNUZXN0TW9kZSA/IEZBREVEX0NPTE9SIDpcclxuICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNPTElEX0NPTE9SO1xyXG4gICAgICBpZiAoIGlzVGVzdE1vZGUgKSB7XHJcbiAgICAgICAgdGhpcy5jaXJjdWl0RWxlbWVudFRvb2xib3gubW92ZVRvRnJvbnQoKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgLy8gaW52ZXN0aWdhdGUgbW9kZSAtIG1vdmUgYmxhY2sgYm94IGNpcmN1aXQgZWxlbWVudHMgdG8gdGhlIGJhY2sgc28gdGhleSB3b24ndCBhcHBlYXIgaW4gZnJvbnQgb2YgdGhlIGJsYWNrIGJveFxyXG4gICAgICAgIC8vIFRPRE86IGZpeCBsYXllcmluZ1xyXG4gICAgICB9XHJcbiAgICAgIHdoaXRlQm94Tm9kZS5tb3ZlVG9CYWNrKCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUgLSBXaGVuIHJlc2V0LCBtb3ZlIHRoZSBib3hlcyBpbiBmcm9udCBvZiB0aGUgYmxhY2sgYm94IGNpcmN1aXQgZWxlbWVudHNcclxuICAgIHRoaXMucmVzZXRCbGFja0JveFNjZW5lVmlldyA9ICgpID0+IHtcclxuICAgICAgYmxhY2tCb3hOb2RlLm1vdmVUb0Zyb250KCk7XHJcbiAgICAgIHdoaXRlQm94Tm9kZS5tb3ZlVG9CYWNrKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFdoZW4gZHJvcHBpbmcgYW4gb2JqZWN0IGluIFwiYnVpbGQgbW9kZVwiLCBpdHMgdmVydGljZXMgc2hvdWxkIHBvcCBpbnNpZGUgdGhlIGJsYWNrIGJveCwgc2VlICMxMTNcclxuICAgIC8vIFRPRE86IExldCdzIG1vdmUgdGhpcyB0byB0aGUgbW9kZWwsIGFuZCBtYWtlIHRoZSBibGFja0JveE5vZGVCb3VuZHMgYXZhaWxhYmxlIHRoZXJlLlxyXG4gICAgYmxhY2tCb3hTY2VuZU1vZGVsLmNpcmN1aXQudmVydGV4RHJvcHBlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHZlcnRleCA9PiB7XHJcblxyXG4gICAgICAvLyBBbGxvdyB0aGUgd2lyZSBkcmFnIGV2ZW50IHRvIGNvbXBsZXRlIHNvIHRoYXQgdGhlIHdpcmUgd29uJ3QgdGhpbmsgaXQgd2FzIHJlbGVhc2VkIG5lYXIgYW5vdGhlciB0YXJnZXRcclxuICAgICAgLy8gYW5kIGF0dGFjaCB0byBpdCwgc2VlICMxNzNcclxuICAgICAgc3RlcFRpbWVyLnNldFRpbWVvdXQoICgpID0+IHtcclxuXHJcbiAgICAgICAgLy8gSWYgdGhlIHdpcmUgY29ubmVjdGVkIHRvIGEgYmxhY2sgYm94IHZlcnRleCwgdGhlbiBpdCBtYXkgbm8gbG9uZ2VyIGV4aXN0IGluIHRoZSBtb2RlbC4gSW4gdGhpcyBjYXNlIHRoZXJlIGlzXHJcbiAgICAgICAgLy8gbm8gbmVlZCB0byBtb3ZlIGl0IGluc2lkZSB0aGUgYmxhY2sgYm94LlxyXG4gICAgICAgIGlmICggYmxhY2tCb3hTY2VuZU1vZGVsLmNpcmN1aXQudmVydGV4R3JvdXAuaW5jbHVkZXMoIHZlcnRleCApICYmIGJsYWNrQm94U2NlbmVNb2RlbC5tb2RlUHJvcGVydHkuZ2V0KCkgPT09ICd0ZXN0JyApIHtcclxuXHJcbiAgICAgICAgICAvLyBGaW5kIGFsbCB0aGUgdmVydGljZXMgdGhhdCBtdXN0IGJlIHRyYW5zbGF0ZWQgaW50byB0aGUgYm94LCB0cmFuc2xhdGluZyB3aXJlc1xyXG4gICAgICAgICAgKCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZlcnRpY2VzID0gYmxhY2tCb3hTY2VuZU1vZGVsLmNpcmN1aXQuZmluZEFsbENvbm5lY3RlZFZlcnRpY2VzKCB2ZXJ0ZXggKTtcclxuICAgICAgICAgICAgY29uc3QgY29ubmVjdGVkVG9CbGFja0JveCA9IHZlcnRpY2VzLmZpbHRlciggdiA9PiB2LmJsYWNrQm94SW50ZXJmYWNlUHJvcGVydHkuZ2V0KCkgKS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICBpZiAoICFjb25uZWN0ZWRUb0JsYWNrQm94ICkge1xyXG4gICAgICAgICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdmVydGV4SW5Hcm91cCA9IHZlcnRpY2VzWyBpIF07XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xvc2VzdFBvaW50ID0gYmxhY2tCb3hOb2RlLmJvdW5kcy5lcm9kZWQoIDMwICkuY2xvc2VzdFBvaW50VG8oIHZlcnRleEluR3JvdXAucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKSApO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVsdGEgPSBjbG9zZXN0UG9pbnQubWludXMoIHZlcnRleEluR3JvdXAucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKSApO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuY2lyY3VpdE5vZGUudHJhbnNsYXRlVmVydGV4R3JvdXAoIHZlcnRleEluR3JvdXAsIHZlcnRpY2VzLCBkZWx0YSwgbnVsbCwgW10gKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gKSgpO1xyXG5cclxuICAgICAgICAgIC8vIEZpbmQgYWxsIHRoZSB2ZXJ0aWNlcyB0aGF0IG11c3QgYmUgdHJhbnNsYXRlZCBpbnRvIHRoZSBib3gsIHNocmlua2luZyB3aXJlc1xyXG4gICAgICAgICAgLy8gVE9ETzogRmFjdG9yIG91dFxyXG4gICAgICAgICAgKCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZlcnRpY2VzID0gYmxhY2tCb3hTY2VuZU1vZGVsLmNpcmN1aXQuZmluZEFsbEZpeGVkVmVydGljZXMoIHZlcnRleCApO1xyXG4gICAgICAgICAgICBjb25zdCBjb25uZWN0ZWRUb0JsYWNrQm94ID0gdmVydGljZXMuZmlsdGVyKCB2ID0+IHYuYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5nZXQoKSApLmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgIGlmICggIWNvbm5lY3RlZFRvQmxhY2tCb3ggKSB7XHJcbiAgICAgICAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdmVydGljZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2ZXJ0ZXhJbkdyb3VwID0gdmVydGljZXNbIGkgXTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZXN0UG9pbnQgPSBibGFja0JveE5vZGUuYm91bmRzLmVyb2RlZCggMzAgKS5jbG9zZXN0UG9pbnRUbyggdmVydGV4SW5Hcm91cC5wb3NpdGlvblByb3BlcnR5LmdldCgpICk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZWx0YSA9IGNsb3Nlc3RQb2ludC5taW51cyggdmVydGV4SW5Hcm91cC5wb3NpdGlvblByb3BlcnR5LmdldCgpICk7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5jaXJjdWl0Tm9kZS50cmFuc2xhdGVWZXJ0ZXhHcm91cCggdmVydGV4SW5Hcm91cCwgdmVydGljZXMsIGRlbHRhLCBudWxsLCBbXSApO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSApKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCAwICk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNldCB0aGUgQmxhY2tCb3hTY2VuZVZpZXdcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVzZXQoKSB7XHJcbiAgICBzdXBlci5yZXNldCgpO1xyXG4gICAgdGhpcy5yZXNldEJsYWNrQm94U2NlbmVWaWV3KCk7XHJcbiAgfVxyXG59XHJcblxyXG5jaXJjdWl0Q29uc3RydWN0aW9uS2l0QmxhY2tCb3hTdHVkeS5yZWdpc3RlciggJ0JsYWNrQm94U2NlbmVWaWV3JywgQmxhY2tCb3hTY2VuZVZpZXcgKTtcclxuZXhwb3J0IGRlZmF1bHQgQmxhY2tCb3hTY2VuZVZpZXc7Il0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLGFBQWEsTUFBTSxpRUFBaUU7QUFDM0YsT0FBT0MsY0FBYyxNQUFNLHVFQUF1RTtBQUNsRyxPQUFPQyx5QkFBeUIsTUFBTSxrRkFBa0Y7QUFDeEgsT0FBT0MsVUFBVSxNQUFNLG9DQUFvQztBQUMzRCxTQUFTQyxJQUFJLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDOUQsT0FBT0MsUUFBUSxNQUFNLGdDQUFnQztBQUNyRCxPQUFPQyxtQ0FBbUMsTUFBTSw4Q0FBOEM7QUFDOUYsT0FBT0MsdUJBQXVCLE1BQU0sK0JBQStCO0FBQ25FLE9BQU9DLFlBQVksTUFBTSwwQkFBMEI7QUFDbkQsT0FBT0MsWUFBWSxNQUFNLG1CQUFtQjtBQUM1QyxPQUFPQyxvQkFBb0IsTUFBTSwyQkFBMkI7QUFDNUQsT0FBT0MsWUFBWSxNQUFNLG1CQUFtQjtBQUM1QyxPQUFPQyxZQUFZLE1BQU0sbUJBQW1COztBQUU1QztBQUNBO0FBQ0E7O0FBRUEsTUFBTUMsaUJBQWlCLFNBQVNiLGNBQWMsQ0FBQztFQUM3QztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFYyxXQUFXQSxDQUFFQyxhQUFhLEVBQUVDLGNBQWMsRUFBRUMsa0JBQWtCLEVBQUVDLGFBQWEsRUFBRUMsTUFBTSxFQUFHO0lBRXRGLE1BQU1DLHlCQUF5QixHQUFHLElBQUluQix5QkFBeUIsQ0FDN0RnQixrQkFBa0IsQ0FBQ0ksT0FB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