// Copyright 2016-2022, University of Colorado Boulder
// TODO: Review, document, annotate, i18n, bring up to standards

/**
 * One scene for the black box screen, which focuses on a single black box and deals with the contents of the
 * black box when the mode changes between investigate and build.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import Battery from '../../../../circuit-construction-kit-common/js/model/Battery.js';
import CircuitConstructionKitModel from '../../../../circuit-construction-kit-common/js/model/CircuitConstructionKitModel.js';
import CircuitStruct from '../../../../circuit-construction-kit-common/js/model/CircuitStruct.js';
import LightBulb from '../../../../circuit-construction-kit-common/js/model/LightBulb.js';
import Resistor from '../../../../circuit-construction-kit-common/js/model/Resistor.js';
import Switch from '../../../../circuit-construction-kit-common/js/model/Switch.js';
import Wire from '../../../../circuit-construction-kit-common/js/model/Wire.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Tandem from '../../../../tandem/js/Tandem.js';
import circuitConstructionKitBlackBoxStudy from '../../circuitConstructionKitBlackBoxStudy.js';
class BlackBoxSceneModel extends CircuitConstructionKitModel {
  /**
   * @param {Object} trueBlackBoxCircuitObject - plain object for the circuit inside the black box (the true one, not the user-created one)
   * @param {Tandem} tandem
   */
  constructor(trueBlackBoxCircuitObject, tandem) {
    super(true, false, tandem, {
      revealing: false,
      blackBoxStudy: true
    });
    const trueBlackBoxCircuitStruct = CircuitStruct.fromStateObject(this.circuit, trueBlackBoxCircuitObject, this.circuit.wireResistivityProperty, tandem.createTandem('circuitStruct'), {
      // All of the circuit elements in the true black box should be non-interactive
      interactive: false,
      insideTrueBlackBox: true
    });
    assert && assert(trueBlackBoxCircuitStruct instanceof CircuitStruct, 'circuit should be CircuitStruct');

    // When loading a black box circuit, none of the vertices should be draggable
    // TODO: Fix this in the saved/loaded data structures, not here as a post-hoc patch.
    for (let i = 0; i < trueBlackBoxCircuitStruct.vertices.length; i++) {
      trueBlackBoxCircuitStruct.vertices[i].draggableProperty.set(false);
      if (trueBlackBoxCircuitStruct.vertices[i].attachableProperty.get()) {
        trueBlackBoxCircuitStruct.vertices[i].blackBoxInterfaceProperty.set(true);
      } else {
        trueBlackBoxCircuitStruct.vertices[i].insideTrueBlackBoxProperty.set(true);
      }
    }

    // @public - true if the user has created a circuit for comparison with the black box (1+ terminal connected)
    this.isRevealEnabledProperty = new BooleanProperty(false, {
      tandem: tandem.createTandem('isRevealEnabledProperty')
    });

    // @public - or syntax highlighting and navigation only
    this.circuit = this.circuit || null;

    // When reveal is pressed, true black box circuit should be shown instead of the user-created circuit
    this.revealingProperty.lazyLink(revealing => this.modeProperty.set(revealing ? 'explore' : 'test'));

    // Keep track of what the user has built inside the black box so it may be restored.
    const userBlackBoxCircuitStruct = new CircuitStruct();
    const circuit = this.circuit;

    // Add wire stubs outside the black box, see https://github.com/phetsims/circuit-construction-kit-black-box-study/issues/21
    const addWireStubs = () => {
      for (let i = 0; i < trueBlackBoxCircuitStruct.vertices.length; i++) {
        const vertex = trueBlackBoxCircuitStruct.vertices[i];
        if (vertex.blackBoxInterfaceProperty.get()) {
          vertex.blackBoxInterfaceProperty.set(false);

          // the center of the black box is approximately (508, 305).  Point the wires away from the box.
          const side = vertex.positionProperty.value.x < 400 ? 'left' : vertex.positionProperty.value.x > 600 ? 'right' : vertex.positionProperty.value.y < 200 ? 'top' : 'bottom';
          const extentLength = 40;
          const dx = side === 'left' ? -extentLength : side === 'right' ? +extentLength : 0;
          const dy = side === 'top' ? -extentLength : side === 'bottom' ? +extentLength : 0;
          const outerVertex = this.circuit.vertexGroup.createNextElement(new Vector2(vertex.positionProperty.value.x + dx, vertex.positionProperty.value.y + dy));
          // const outerVertex = new Vertex( new Vector2( vertex.positionProperty.value.x + dx, vertex.positionProperty.value.y + dy ) );
          // outerVertex.attachable = true;
          outerVertex.blackBoxInterfaceProperty.set(true);
          outerVertex.draggableProperty.set(false);
          outerVertex.outerWireStub = true;
          vertex.blackBoxInterfaceProperty.set(true);
          const w = new Wire(vertex, outerVertex, this.circuit.wireResistivityProperty, Tandem.OPT_OUT, {
            wireStub: true,
            interactive: false
          });
          circuit.circuitElements.push(w);
        }
      }
    };
    addWireStubs();

    /**
     * Check whether the user built (at least part of) their own black box circuit, which enables the reveal button.
     * @returns {boolean}
     */
    const userBuiltSomething = () => {
      let count = 0;
      circuit.circuitElements.forEach(element => {
        const isConnectedToBlackBoxInterface = element.startVertexProperty.get().blackBoxInterfaceProperty.get() || element.endVertexProperty.get().blackBoxInterfaceProperty.get();
        if (element.interactiveProperty.get() && isConnectedToBlackBoxInterface) {
          count++;
        }
      });
      return count > 0;
    };

    // Enable the reveal button if the user has done something in build mode.
    circuit.circuitChangedEmitter.addListener(() => {
      const builtSomething = this.modeProperty.get() === 'test' && userBuiltSomething();
      this.isRevealEnabledProperty.set(this.revealingProperty.get() || builtSomething);
    });

    /**
     * Remove the true black box contents or user-created black box contents
     * @param {CircuitStruct} blackBoxCircuit
     */
    const removeBlackBoxContents = blackBoxCircuit => {
      // circuit.circuitElements.removeAll( blackBoxCircuit.wires );
      // circuit.circuitElements.removeAll( blackBoxCircuit.lightBulbs );
      // circuit.circuitElements.removeAll( blackBoxCircuit.resistors );
      // circuit.circuitElements.removeAll( blackBoxCircuit.batteries );

      // Remove the vertices but not those on the black box interface
      // for ( const i = 0; i < blackBoxCircuit.vertices.length; i++ ) {
      //   const vertex = blackBoxCircuit.vertexGroup.getElement(i);
      //   if ( !vertex.blackBoxInterfaceProperty.get() ) {
      //     circuit.vertices.remove( vertex );
      //   }
      // }
    };

    /**
     * Add the true black box contents or user-created black box contents
     * @param {CircuitStruct} blackBoxCircuit
     */
    const addBlackBoxContents = blackBoxCircuit => {

      // circuit.circuitElements.addAll( blackBoxCircuit.wires );
      // circuit.circuitElements.addAll( blackBoxCircuit.resistors );
      // circuit.circuitElements.addAll( blackBoxCircuit.batteries );
      // circuit.circuitElements.addAll( blackBoxCircuit.lightBulbs );
      //
      // blackBoxCircuit.circuitElements.forEach( function( circuitElement ) {
      //   circuitElement.moveToFrontEmitter.emit();
      // } );
    };

    // Logic for changing the contents of the black box when the mode changes
    // TODO: All of this logic must be re-read and re-evaluated.
    this.modeProperty.link(mode => {
      // When switching to InteractionMode.TEST mode, remove all of the black box circuitry and vice-versa
      if (mode === 'test') {
        removeBlackBoxContents(trueBlackBoxCircuitStruct);

        // Any draggable vertices that remain should be made unattachable and undraggable, so the user cannot update the
        // circuit outside the box
        circuit.vertexGroup.forEach(vertex => {
          if (!vertex.blackBoxInterfaceProperty.get()) {
            vertex.attachableProperty.set(false);
            vertex.draggableProperty.set(false);
            vertex.interactiveProperty.set(false);
          }
        });
        circuit.circuitElements.forEach(circuitElement => circuitElement.interactiveProperty.set(false));
        addBlackBoxContents(userBlackBoxCircuitStruct);
      } else {
        // Switched to InteractionMode.EXPLORE. Move interior elements to userBlackBoxCircuit
        userBlackBoxCircuitStruct.clear();
        circuit.vertexGroup.forEach(v => {
          if (v.interactiveProperty.get() && v.draggableProperty.get()) {
            userBlackBoxCircuitStruct.vertices.push(v);
          }
        });
        circuit.circuitElements.forEach(circuitElement => {
          if (circuitElement.interactiveProperty.get()) {
            // TODO: abstraction
            if (circuitElement instanceof Wire) {
              userBlackBoxCircuitStruct.wires.push(circuitElement);
            } else if (circuitElement instanceof Battery) {
              userBlackBoxCircuitStruct.batteries.push(circuitElement);
            } else if (circuitElement instanceof LightBulb) {
              userBlackBoxCircuitStruct.lightBulbs.push(circuitElement);
            } else if (circuitElement instanceof Resistor) {
              userBlackBoxCircuitStruct.resistors.push(circuitElement);
            } else if (circuitElement instanceof Switch) {
              userBlackBoxCircuitStruct.switches.push(circuitElement);
            }
          }
        });
        removeBlackBoxContents(userBlackBoxCircuitStruct);

        // Any attachable vertices outside the box should become attachable and draggable
        circuit.vertexGroup.forEach(vertex => {
          if (!vertex.blackBoxInterfaceProperty.get()) {
            vertex.draggableProperty.set(true);
            vertex.attachableProperty.set(true);
            vertex.interactiveProperty.set(true);
          }
        });
        circuit.circuitElements.forEach(circuitElement => {
          if (circuitElement.wireStub === true) {
            // no nop, wire stubs remain non-interactive
          } else {
            circuitElement.interactiveProperty.set(true);
          }
        });
        addBlackBoxContents(trueBlackBoxCircuitStruct);
      }
      circuit.markDirty();
    });

    // @private - called by reset
    this.resetBlackBoxSceneModel = () => {
      addWireStubs();
      addBlackBoxContents(trueBlackBoxCircuitStruct);
      userBlackBoxCircuitStruct.clear();
    };
  }

  /**
   * Reset the model.
   * @overrides
   * @public
   */
  reset() {
    super.reset();
    this.revealingProperty.reset();
    this.isRevealEnabledProperty.reset();
    this.resetBlackBoxSceneModel();
  }
}
circuitConstructionKitBlackBoxStudy.register('BlackBoxSceneModel', BlackBoxSceneModel);
export default BlackBoxSceneModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJCYXR0ZXJ5IiwiQ2lyY3VpdENvbnN0cnVjdGlvbktpdE1vZGVsIiwiQ2lyY3VpdFN0cnVjdCIsIkxpZ2h0QnVsYiIsIlJlc2lzdG9yIiwiU3dpdGNoIiwiV2lyZSIsIlZlY3RvcjIiLCJUYW5kZW0iLCJjaXJjdWl0Q29uc3RydWN0aW9uS2l0QmxhY2tCb3hTdHVkeSIsIkJsYWNrQm94U2NlbmVNb2RlbCIsImNvbnN0cnVjdG9yIiwidHJ1ZUJsYWNrQm94Q2lyY3VpdE9iamVjdCIsInRhbmRlbSIsInJldmVhbGluZyIsImJsYWNrQm94U3R1ZHkiLCJ0cnVlQmxhY2tCb3hDaXJjdWl0U3RydWN0IiwiZnJvbVN0YXRlT2JqZWN0IiwiY2lyY3VpdCIsIndpcmVSZXNpc3Rpdml0eVByb3BlcnR5IiwiY3JlYXRlVGFuZGVtIiwiaW50ZXJhY3RpdmUiLCJpbnNpZGVUcnVlQmxhY2tCb3giLCJhc3NlcnQiLCJpIiwidmVydGljZXMiLCJsZW5ndGgiLCJkcmFnZ2FibGVQcm9wZXJ0eSIsInNldCIsImF0dGFjaGFibGVQcm9wZXJ0eSIsImdldCIsImJsYWNrQm94SW50ZXJmYWNlUHJvcGVydHkiLCJpbnNpZGVUcnVlQmxhY2tCb3hQcm9wZXJ0eSIsImlzUmV2ZWFsRW5hYmxlZFByb3BlcnR5IiwicmV2ZWFsaW5nUHJvcGVydHkiLCJsYXp5TGluayIsIm1vZGVQcm9wZXJ0eSIsInVzZXJCbGFja0JveENpcmN1aXRTdHJ1Y3QiLCJhZGRXaXJlU3R1YnMiLCJ2ZXJ0ZXgiLCJzaWRlIiwicG9zaXRpb25Qcm9wZXJ0eSIsInZhbHVlIiwieCIsInkiLCJleHRlbnRMZW5ndGgiLCJkeCIsImR5Iiwib3V0ZXJWZXJ0ZXgiLCJ2ZXJ0ZXhHcm91cCIsImNyZWF0ZU5leHRFbGVtZW50Iiwib3V0ZXJXaXJlU3R1YiIsInciLCJPUFRfT1VUIiwid2lyZVN0dWIiLCJjaXJjdWl0RWxlbWVudHMiLCJwdXNoIiwidXNlckJ1aWx0U29tZXRoaW5nIiwiY291bnQiLCJmb3JFYWNoIiwiZWxlbWVudCIsImlzQ29ubmVjdGVkVG9CbGFja0JveEludGVyZmFjZSIsInN0YXJ0VmVydGV4UHJvcGVydHkiLCJlbmRWZXJ0ZXhQcm9wZXJ0eSIsImludGVyYWN0aXZlUHJvcGVydHkiLCJjaXJjdWl0Q2hhbmdlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsImJ1aWx0U29tZXRoaW5nIiwicmVtb3ZlQmxhY2tCb3hDb250ZW50cyIsImJsYWNrQm94Q2lyY3VpdCIsImFkZEJsYWNrQm94Q29udGVudHMiLCJsaW5rIiwibW9kZSIsImNpcmN1aXRFbGVtZW50IiwiY2xlYXIiLCJ2Iiwid2lyZXMiLCJiYXR0ZXJpZXMiLCJsaWdodEJ1bGJzIiwicmVzaXN0b3JzIiwic3dpdGNoZXMiLCJtYXJrRGlydHkiLCJyZXNldEJsYWNrQm94U2NlbmVNb2RlbCIsInJlc2V0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJCbGFja0JveFNjZW5lTW9kZWwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTYtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcbi8vIFRPRE86IFJldmlldywgZG9jdW1lbnQsIGFubm90YXRlLCBpMThuLCBicmluZyB1cCB0byBzdGFuZGFyZHNcclxuXHJcbi8qKlxyXG4gKiBPbmUgc2NlbmUgZm9yIHRoZSBibGFjayBib3ggc2NyZWVuLCB3aGljaCBmb2N1c2VzIG9uIGEgc2luZ2xlIGJsYWNrIGJveCBhbmQgZGVhbHMgd2l0aCB0aGUgY29udGVudHMgb2YgdGhlXHJcbiAqIGJsYWNrIGJveCB3aGVuIHRoZSBtb2RlIGNoYW5nZXMgYmV0d2VlbiBpbnZlc3RpZ2F0ZSBhbmQgYnVpbGQuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCYXR0ZXJ5IGZyb20gJy4uLy4uLy4uLy4uL2NpcmN1aXQtY29uc3RydWN0aW9uLWtpdC1jb21tb24vanMvbW9kZWwvQmF0dGVyeS5qcyc7XHJcbmltcG9ydCBDaXJjdWl0Q29uc3RydWN0aW9uS2l0TW9kZWwgZnJvbSAnLi4vLi4vLi4vLi4vY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWNvbW1vbi9qcy9tb2RlbC9DaXJjdWl0Q29uc3RydWN0aW9uS2l0TW9kZWwuanMnO1xyXG5pbXBvcnQgQ2lyY3VpdFN0cnVjdCBmcm9tICcuLi8uLi8uLi8uLi9jaXJjdWl0LWNvbnN0cnVjdGlvbi1raXQtY29tbW9uL2pzL21vZGVsL0NpcmN1aXRTdHJ1Y3QuanMnO1xyXG5pbXBvcnQgTGlnaHRCdWxiIGZyb20gJy4uLy4uLy4uLy4uL2NpcmN1aXQtY29uc3RydWN0aW9uLWtpdC1jb21tb24vanMvbW9kZWwvTGlnaHRCdWxiLmpzJztcclxuaW1wb3J0IFJlc2lzdG9yIGZyb20gJy4uLy4uLy4uLy4uL2NpcmN1aXQtY29uc3RydWN0aW9uLWtpdC1jb21tb24vanMvbW9kZWwvUmVzaXN0b3IuanMnO1xyXG5pbXBvcnQgU3dpdGNoIGZyb20gJy4uLy4uLy4uLy4uL2NpcmN1aXQtY29uc3RydWN0aW9uLWtpdC1jb21tb24vanMvbW9kZWwvU3dpdGNoLmpzJztcclxuaW1wb3J0IFdpcmUgZnJvbSAnLi4vLi4vLi4vLi4vY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWNvbW1vbi9qcy9tb2RlbC9XaXJlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdEJsYWNrQm94U3R1ZHkgZnJvbSAnLi4vLi4vY2lyY3VpdENvbnN0cnVjdGlvbktpdEJsYWNrQm94U3R1ZHkuanMnO1xyXG5cclxuY2xhc3MgQmxhY2tCb3hTY2VuZU1vZGVsIGV4dGVuZHMgQ2lyY3VpdENvbnN0cnVjdGlvbktpdE1vZGVsIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IHRydWVCbGFja0JveENpcmN1aXRPYmplY3QgLSBwbGFpbiBvYmplY3QgZm9yIHRoZSBjaXJjdWl0IGluc2lkZSB0aGUgYmxhY2sgYm94ICh0aGUgdHJ1ZSBvbmUsIG5vdCB0aGUgdXNlci1jcmVhdGVkIG9uZSlcclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIHRydWVCbGFja0JveENpcmN1aXRPYmplY3QsIHRhbmRlbSApIHtcclxuICAgIHN1cGVyKCB0cnVlLCBmYWxzZSwgdGFuZGVtLCB7XHJcbiAgICAgIHJldmVhbGluZzogZmFsc2UsXHJcbiAgICAgIGJsYWNrQm94U3R1ZHk6IHRydWVcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IHRydWVCbGFja0JveENpcmN1aXRTdHJ1Y3QgPSBDaXJjdWl0U3RydWN0LmZyb21TdGF0ZU9iamVjdCggdGhpcy5jaXJjdWl0LCB0cnVlQmxhY2tCb3hDaXJjdWl0T2JqZWN0LCB0aGlzLmNpcmN1aXQud2lyZVJlc2lzdGl2aXR5UHJvcGVydHksIHRhbmRlbS5jcmVhdGVUYW5kZW0oICdjaXJjdWl0U3RydWN0JyApLCB7XHJcblxyXG4gICAgICAvLyBBbGwgb2YgdGhlIGNpcmN1aXQgZWxlbWVudHMgaW4gdGhlIHRydWUgYmxhY2sgYm94IHNob3VsZCBiZSBub24taW50ZXJhY3RpdmVcclxuICAgICAgaW50ZXJhY3RpdmU6IGZhbHNlLFxyXG4gICAgICBpbnNpZGVUcnVlQmxhY2tCb3g6IHRydWVcclxuICAgIH0gKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0cnVlQmxhY2tCb3hDaXJjdWl0U3RydWN0IGluc3RhbmNlb2YgQ2lyY3VpdFN0cnVjdCwgJ2NpcmN1aXQgc2hvdWxkIGJlIENpcmN1aXRTdHJ1Y3QnICk7XHJcblxyXG4gICAgLy8gV2hlbiBsb2FkaW5nIGEgYmxhY2sgYm94IGNpcmN1aXQsIG5vbmUgb2YgdGhlIHZlcnRpY2VzIHNob3VsZCBiZSBkcmFnZ2FibGVcclxuICAgIC8vIFRPRE86IEZpeCB0aGlzIGluIHRoZSBzYXZlZC9sb2FkZWQgZGF0YSBzdHJ1Y3R1cmVzLCBub3QgaGVyZSBhcyBhIHBvc3QtaG9jIHBhdGNoLlxyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdHJ1ZUJsYWNrQm94Q2lyY3VpdFN0cnVjdC52ZXJ0aWNlcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgdHJ1ZUJsYWNrQm94Q2lyY3VpdFN0cnVjdC52ZXJ0aWNlc1sgaSBdLmRyYWdnYWJsZVByb3BlcnR5LnNldCggZmFsc2UgKTtcclxuXHJcbiAgICAgIGlmICggdHJ1ZUJsYWNrQm94Q2lyY3VpdFN0cnVjdC52ZXJ0aWNlc1sgaSBdLmF0dGFjaGFibGVQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgICB0cnVlQmxhY2tCb3hDaXJjdWl0U3RydWN0LnZlcnRpY2VzWyBpIF0uYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICB0cnVlQmxhY2tCb3hDaXJjdWl0U3RydWN0LnZlcnRpY2VzWyBpIF0uaW5zaWRlVHJ1ZUJsYWNrQm94UHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBAcHVibGljIC0gdHJ1ZSBpZiB0aGUgdXNlciBoYXMgY3JlYXRlZCBhIGNpcmN1aXQgZm9yIGNvbXBhcmlzb24gd2l0aCB0aGUgYmxhY2sgYm94ICgxKyB0ZXJtaW5hbCBjb25uZWN0ZWQpXHJcbiAgICB0aGlzLmlzUmV2ZWFsRW5hYmxlZFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UsIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnaXNSZXZlYWxFbmFibGVkUHJvcGVydHknIClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIC0gb3Igc3ludGF4IGhpZ2hsaWdodGluZyBhbmQgbmF2aWdhdGlvbiBvbmx5XHJcbiAgICB0aGlzLmNpcmN1aXQgPSB0aGlzLmNpcmN1aXQgfHwgbnVsbDtcclxuXHJcbiAgICAvLyBXaGVuIHJldmVhbCBpcyBwcmVzc2VkLCB0cnVlIGJsYWNrIGJveCBjaXJjdWl0IHNob3VsZCBiZSBzaG93biBpbnN0ZWFkIG9mIHRoZSB1c2VyLWNyZWF0ZWQgY2lyY3VpdFxyXG4gICAgdGhpcy5yZXZlYWxpbmdQcm9wZXJ0eS5sYXp5TGluayggcmV2ZWFsaW5nID0+IHRoaXMubW9kZVByb3BlcnR5LnNldCggcmV2ZWFsaW5nID8gJ2V4cGxvcmUnIDogJ3Rlc3QnICkgKTtcclxuXHJcbiAgICAvLyBLZWVwIHRyYWNrIG9mIHdoYXQgdGhlIHVzZXIgaGFzIGJ1aWx0IGluc2lkZSB0aGUgYmxhY2sgYm94IHNvIGl0IG1heSBiZSByZXN0b3JlZC5cclxuICAgIGNvbnN0IHVzZXJCbGFja0JveENpcmN1aXRTdHJ1Y3QgPSBuZXcgQ2lyY3VpdFN0cnVjdCgpO1xyXG4gICAgY29uc3QgY2lyY3VpdCA9IHRoaXMuY2lyY3VpdDtcclxuXHJcbiAgICAvLyBBZGQgd2lyZSBzdHVicyBvdXRzaWRlIHRoZSBibGFjayBib3gsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWJsYWNrLWJveC1zdHVkeS9pc3N1ZXMvMjFcclxuICAgIGNvbnN0IGFkZFdpcmVTdHVicyA9ICgpID0+IHtcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdHJ1ZUJsYWNrQm94Q2lyY3VpdFN0cnVjdC52ZXJ0aWNlcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBjb25zdCB2ZXJ0ZXggPSB0cnVlQmxhY2tCb3hDaXJjdWl0U3RydWN0LnZlcnRpY2VzWyBpIF07XHJcbiAgICAgICAgaWYgKCB2ZXJ0ZXguYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgICAgIHZlcnRleC5ibGFja0JveEludGVyZmFjZVByb3BlcnR5LnNldCggZmFsc2UgKTtcclxuXHJcbiAgICAgICAgICAvLyB0aGUgY2VudGVyIG9mIHRoZSBibGFjayBib3ggaXMgYXBwcm94aW1hdGVseSAoNTA4LCAzMDUpLiAgUG9pbnQgdGhlIHdpcmVzIGF3YXkgZnJvbSB0aGUgYm94LlxyXG4gICAgICAgICAgY29uc3Qgc2lkZSA9IHZlcnRleC5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggPCA0MDAgPyAnbGVmdCcgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgIHZlcnRleC5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnggPiA2MDAgPyAncmlnaHQnIDpcclxuICAgICAgICAgICAgICAgICAgICAgICB2ZXJ0ZXgucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55IDwgMjAwID8gJ3RvcCcgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICdib3R0b20nO1xyXG5cclxuICAgICAgICAgIGNvbnN0IGV4dGVudExlbmd0aCA9IDQwO1xyXG5cclxuICAgICAgICAgIGNvbnN0IGR4ID0gc2lkZSA9PT0gJ2xlZnQnID8gLWV4dGVudExlbmd0aCA6XHJcbiAgICAgICAgICAgICAgICAgICAgIHNpZGUgPT09ICdyaWdodCcgPyArZXh0ZW50TGVuZ3RoIDpcclxuICAgICAgICAgICAgICAgICAgICAgMDtcclxuICAgICAgICAgIGNvbnN0IGR5ID0gc2lkZSA9PT0gJ3RvcCcgPyAtZXh0ZW50TGVuZ3RoIDpcclxuICAgICAgICAgICAgICAgICAgICAgc2lkZSA9PT0gJ2JvdHRvbScgPyArZXh0ZW50TGVuZ3RoIDpcclxuICAgICAgICAgICAgICAgICAgICAgMDtcclxuICAgICAgICAgIGNvbnN0IG91dGVyVmVydGV4ID0gdGhpcy5jaXJjdWl0LnZlcnRleEdyb3VwLmNyZWF0ZU5leHRFbGVtZW50KCBuZXcgVmVjdG9yMiggdmVydGV4LnBvc2l0aW9uUHJvcGVydHkudmFsdWUueCArIGR4LCB2ZXJ0ZXgucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55ICsgZHkgKSApO1xyXG4gICAgICAgICAgLy8gY29uc3Qgb3V0ZXJWZXJ0ZXggPSBuZXcgVmVydGV4KCBuZXcgVmVjdG9yMiggdmVydGV4LnBvc2l0aW9uUHJvcGVydHkudmFsdWUueCArIGR4LCB2ZXJ0ZXgucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55ICsgZHkgKSApO1xyXG4gICAgICAgICAgLy8gb3V0ZXJWZXJ0ZXguYXR0YWNoYWJsZSA9IHRydWU7XHJcbiAgICAgICAgICBvdXRlclZlcnRleC5ibGFja0JveEludGVyZmFjZVByb3BlcnR5LnNldCggdHJ1ZSApO1xyXG4gICAgICAgICAgb3V0ZXJWZXJ0ZXguZHJhZ2dhYmxlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICAgICAgb3V0ZXJWZXJ0ZXgub3V0ZXJXaXJlU3R1YiA9IHRydWU7XHJcbiAgICAgICAgICB2ZXJ0ZXguYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuXHJcbiAgICAgICAgICBjb25zdCB3ID0gbmV3IFdpcmUoIHZlcnRleCwgb3V0ZXJWZXJ0ZXgsIHRoaXMuY2lyY3VpdC53aXJlUmVzaXN0aXZpdHlQcm9wZXJ0eSwgVGFuZGVtLk9QVF9PVVQsIHtcclxuICAgICAgICAgICAgd2lyZVN0dWI6IHRydWUsXHJcbiAgICAgICAgICAgIGludGVyYWN0aXZlOiBmYWxzZVxyXG4gICAgICAgICAgfSApO1xyXG4gICAgICAgICAgY2lyY3VpdC5jaXJjdWl0RWxlbWVudHMucHVzaCggdyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBhZGRXaXJlU3R1YnMoKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIHdoZXRoZXIgdGhlIHVzZXIgYnVpbHQgKGF0IGxlYXN0IHBhcnQgb2YpIHRoZWlyIG93biBibGFjayBib3ggY2lyY3VpdCwgd2hpY2ggZW5hYmxlcyB0aGUgcmV2ZWFsIGJ1dHRvbi5cclxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxyXG4gICAgICovXHJcbiAgICBjb25zdCB1c2VyQnVpbHRTb21ldGhpbmcgPSAoKSA9PiB7XHJcbiAgICAgIGxldCBjb3VudCA9IDA7XHJcbiAgICAgIGNpcmN1aXQuY2lyY3VpdEVsZW1lbnRzLmZvckVhY2goIGVsZW1lbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlzQ29ubmVjdGVkVG9CbGFja0JveEludGVyZmFjZSA9IGVsZW1lbnQuc3RhcnRWZXJ0ZXhQcm9wZXJ0eS5nZXQoKS5ibGFja0JveEludGVyZmFjZVByb3BlcnR5LmdldCgpIHx8IGVsZW1lbnQuZW5kVmVydGV4UHJvcGVydHkuZ2V0KCkuYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5nZXQoKTtcclxuICAgICAgICBpZiAoIGVsZW1lbnQuaW50ZXJhY3RpdmVQcm9wZXJ0eS5nZXQoKSAmJiBpc0Nvbm5lY3RlZFRvQmxhY2tCb3hJbnRlcmZhY2UgKSB7XHJcbiAgICAgICAgICBjb3VudCsrO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgICByZXR1cm4gY291bnQgPiAwO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBFbmFibGUgdGhlIHJldmVhbCBidXR0b24gaWYgdGhlIHVzZXIgaGFzIGRvbmUgc29tZXRoaW5nIGluIGJ1aWxkIG1vZGUuXHJcbiAgICBjaXJjdWl0LmNpcmN1aXRDaGFuZ2VkRW1pdHRlci5hZGRMaXN0ZW5lciggKCkgPT4ge1xyXG4gICAgICBjb25zdCBidWlsdFNvbWV0aGluZyA9IHRoaXMubW9kZVByb3BlcnR5LmdldCgpID09PSAndGVzdCcgJiYgdXNlckJ1aWx0U29tZXRoaW5nKCk7XHJcbiAgICAgIHRoaXMuaXNSZXZlYWxFbmFibGVkUHJvcGVydHkuc2V0KCB0aGlzLnJldmVhbGluZ1Byb3BlcnR5LmdldCgpIHx8IGJ1aWx0U29tZXRoaW5nICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmUgdGhlIHRydWUgYmxhY2sgYm94IGNvbnRlbnRzIG9yIHVzZXItY3JlYXRlZCBibGFjayBib3ggY29udGVudHNcclxuICAgICAqIEBwYXJhbSB7Q2lyY3VpdFN0cnVjdH0gYmxhY2tCb3hDaXJjdWl0XHJcbiAgICAgKi9cclxuICAgIGNvbnN0IHJlbW92ZUJsYWNrQm94Q29udGVudHMgPSBibGFja0JveENpcmN1aXQgPT4ge1xyXG4gICAgICAvLyBjaXJjdWl0LmNpcmN1aXRFbGVtZW50cy5yZW1vdmVBbGwoIGJsYWNrQm94Q2lyY3VpdC53aXJlcyApO1xyXG4gICAgICAvLyBjaXJjdWl0LmNpcmN1aXRFbGVtZW50cy5yZW1vdmVBbGwoIGJsYWNrQm94Q2lyY3VpdC5saWdodEJ1bGJzICk7XHJcbiAgICAgIC8vIGNpcmN1aXQuY2lyY3VpdEVsZW1lbnRzLnJlbW92ZUFsbCggYmxhY2tCb3hDaXJjdWl0LnJlc2lzdG9ycyApO1xyXG4gICAgICAvLyBjaXJjdWl0LmNpcmN1aXRFbGVtZW50cy5yZW1vdmVBbGwoIGJsYWNrQm94Q2lyY3VpdC5iYXR0ZXJpZXMgKTtcclxuXHJcbiAgICAgIC8vIFJlbW92ZSB0aGUgdmVydGljZXMgYnV0IG5vdCB0aG9zZSBvbiB0aGUgYmxhY2sgYm94IGludGVyZmFjZVxyXG4gICAgICAvLyBmb3IgKCBjb25zdCBpID0gMDsgaSA8IGJsYWNrQm94Q2lyY3VpdC52ZXJ0aWNlcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgLy8gICBjb25zdCB2ZXJ0ZXggPSBibGFja0JveENpcmN1aXQudmVydGV4R3JvdXAuZ2V0RWxlbWVudChpKTtcclxuICAgICAgLy8gICBpZiAoICF2ZXJ0ZXguYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgLy8gICAgIGNpcmN1aXQudmVydGljZXMucmVtb3ZlKCB2ZXJ0ZXggKTtcclxuICAgICAgLy8gICB9XHJcbiAgICAgIC8vIH1cclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGQgdGhlIHRydWUgYmxhY2sgYm94IGNvbnRlbnRzIG9yIHVzZXItY3JlYXRlZCBibGFjayBib3ggY29udGVudHNcclxuICAgICAqIEBwYXJhbSB7Q2lyY3VpdFN0cnVjdH0gYmxhY2tCb3hDaXJjdWl0XHJcbiAgICAgKi9cclxuICAgIGNvbnN0IGFkZEJsYWNrQm94Q29udGVudHMgPSBibGFja0JveENpcmN1aXQgPT4ge1xyXG5cclxuICAgICAgLy8gY2lyY3VpdC5jaXJjdWl0RWxlbWVudHMuYWRkQWxsKCBibGFja0JveENpcmN1aXQud2lyZXMgKTtcclxuICAgICAgLy8gY2lyY3VpdC5jaXJjdWl0RWxlbWVudHMuYWRkQWxsKCBibGFja0JveENpcmN1aXQucmVzaXN0b3JzICk7XHJcbiAgICAgIC8vIGNpcmN1aXQuY2lyY3VpdEVsZW1lbnRzLmFkZEFsbCggYmxhY2tCb3hDaXJjdWl0LmJhdHRlcmllcyApO1xyXG4gICAgICAvLyBjaXJjdWl0LmNpcmN1aXRFbGVtZW50cy5hZGRBbGwoIGJsYWNrQm94Q2lyY3VpdC5saWdodEJ1bGJzICk7XHJcbiAgICAgIC8vXHJcbiAgICAgIC8vIGJsYWNrQm94Q2lyY3VpdC5jaXJjdWl0RWxlbWVudHMuZm9yRWFjaCggZnVuY3Rpb24oIGNpcmN1aXRFbGVtZW50ICkge1xyXG4gICAgICAvLyAgIGNpcmN1aXRFbGVtZW50Lm1vdmVUb0Zyb250RW1pdHRlci5lbWl0KCk7XHJcbiAgICAgIC8vIH0gKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gTG9naWMgZm9yIGNoYW5naW5nIHRoZSBjb250ZW50cyBvZiB0aGUgYmxhY2sgYm94IHdoZW4gdGhlIG1vZGUgY2hhbmdlc1xyXG4gICAgLy8gVE9ETzogQWxsIG9mIHRoaXMgbG9naWMgbXVzdCBiZSByZS1yZWFkIGFuZCByZS1ldmFsdWF0ZWQuXHJcbiAgICB0aGlzLm1vZGVQcm9wZXJ0eS5saW5rKCBtb2RlID0+IHtcclxuXHJcbiAgICAgIC8vIFdoZW4gc3dpdGNoaW5nIHRvIEludGVyYWN0aW9uTW9kZS5URVNUIG1vZGUsIHJlbW92ZSBhbGwgb2YgdGhlIGJsYWNrIGJveCBjaXJjdWl0cnkgYW5kIHZpY2UtdmVyc2FcclxuICAgICAgaWYgKCBtb2RlID09PSAndGVzdCcgKSB7XHJcblxyXG4gICAgICAgIHJlbW92ZUJsYWNrQm94Q29udGVudHMoIHRydWVCbGFja0JveENpcmN1aXRTdHJ1Y3QgKTtcclxuXHJcbiAgICAgICAgLy8gQW55IGRyYWdnYWJsZSB2ZXJ0aWNlcyB0aGF0IHJlbWFpbiBzaG91bGQgYmUgbWFkZSB1bmF0dGFjaGFibGUgYW5kIHVuZHJhZ2dhYmxlLCBzbyB0aGUgdXNlciBjYW5ub3QgdXBkYXRlIHRoZVxyXG4gICAgICAgIC8vIGNpcmN1aXQgb3V0c2lkZSB0aGUgYm94XHJcbiAgICAgICAgY2lyY3VpdC52ZXJ0ZXhHcm91cC5mb3JFYWNoKCB2ZXJ0ZXggPT4ge1xyXG4gICAgICAgICAgaWYgKCAhdmVydGV4LmJsYWNrQm94SW50ZXJmYWNlUHJvcGVydHkuZ2V0KCkgKSB7XHJcbiAgICAgICAgICAgIHZlcnRleC5hdHRhY2hhYmxlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICAgICAgICB2ZXJ0ZXguZHJhZ2dhYmxlUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG4gICAgICAgICAgICB2ZXJ0ZXguaW50ZXJhY3RpdmVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIGNpcmN1aXQuY2lyY3VpdEVsZW1lbnRzLmZvckVhY2goIGNpcmN1aXRFbGVtZW50ID0+IGNpcmN1aXRFbGVtZW50LmludGVyYWN0aXZlUHJvcGVydHkuc2V0KCBmYWxzZSApICk7XHJcbiAgICAgICAgYWRkQmxhY2tCb3hDb250ZW50cyggdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdCApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG5cclxuICAgICAgICAvLyBTd2l0Y2hlZCB0byBJbnRlcmFjdGlvbk1vZGUuRVhQTE9SRS4gTW92ZSBpbnRlcmlvciBlbGVtZW50cyB0byB1c2VyQmxhY2tCb3hDaXJjdWl0XHJcbiAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC5jbGVhcigpO1xyXG4gICAgICAgIGNpcmN1aXQudmVydGV4R3JvdXAuZm9yRWFjaCggdiA9PiB7XHJcbiAgICAgICAgICBpZiAoIHYuaW50ZXJhY3RpdmVQcm9wZXJ0eS5nZXQoKSAmJiB2LmRyYWdnYWJsZVByb3BlcnR5LmdldCgpICkge1xyXG4gICAgICAgICAgICB1c2VyQmxhY2tCb3hDaXJjdWl0U3RydWN0LnZlcnRpY2VzLnB1c2goIHYgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9ICk7XHJcbiAgICAgICAgY2lyY3VpdC5jaXJjdWl0RWxlbWVudHMuZm9yRWFjaCggY2lyY3VpdEVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgaWYgKCBjaXJjdWl0RWxlbWVudC5pbnRlcmFjdGl2ZVByb3BlcnR5LmdldCgpICkge1xyXG5cclxuICAgICAgICAgICAgLy8gVE9ETzogYWJzdHJhY3Rpb25cclxuICAgICAgICAgICAgaWYgKCBjaXJjdWl0RWxlbWVudCBpbnN0YW5jZW9mIFdpcmUgKSB7XHJcbiAgICAgICAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC53aXJlcy5wdXNoKCBjaXJjdWl0RWxlbWVudCApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCBjaXJjdWl0RWxlbWVudCBpbnN0YW5jZW9mIEJhdHRlcnkgKSB7XHJcbiAgICAgICAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC5iYXR0ZXJpZXMucHVzaCggY2lyY3VpdEVsZW1lbnQgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICggY2lyY3VpdEVsZW1lbnQgaW5zdGFuY2VvZiBMaWdodEJ1bGIgKSB7XHJcbiAgICAgICAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC5saWdodEJ1bGJzLnB1c2goIGNpcmN1aXRFbGVtZW50ICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoIGNpcmN1aXRFbGVtZW50IGluc3RhbmNlb2YgUmVzaXN0b3IgKSB7XHJcbiAgICAgICAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC5yZXNpc3RvcnMucHVzaCggY2lyY3VpdEVsZW1lbnQgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICggY2lyY3VpdEVsZW1lbnQgaW5zdGFuY2VvZiBTd2l0Y2ggKSB7XHJcbiAgICAgICAgICAgICAgdXNlckJsYWNrQm94Q2lyY3VpdFN0cnVjdC5zd2l0Y2hlcy5wdXNoKCBjaXJjdWl0RWxlbWVudCApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIHJlbW92ZUJsYWNrQm94Q29udGVudHMoIHVzZXJCbGFja0JveENpcmN1aXRTdHJ1Y3QgKTtcclxuXHJcbiAgICAgICAgLy8gQW55IGF0dGFjaGFibGUgdmVydGljZXMgb3V0c2lkZSB0aGUgYm94IHNob3VsZCBiZWNvbWUgYXR0YWNoYWJsZSBhbmQgZHJhZ2dhYmxlXHJcbiAgICAgICAgY2lyY3VpdC52ZXJ0ZXhHcm91cC5mb3JFYWNoKCB2ZXJ0ZXggPT4ge1xyXG4gICAgICAgICAgaWYgKCAhdmVydGV4LmJsYWNrQm94SW50ZXJmYWNlUHJvcGVydHkuZ2V0KCkgKSB7XHJcbiAgICAgICAgICAgIHZlcnRleC5kcmFnZ2FibGVQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgICAgICAgdmVydGV4LmF0dGFjaGFibGVQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgICAgICAgdmVydGV4LmludGVyYWN0aXZlUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIGNpcmN1aXQuY2lyY3VpdEVsZW1lbnRzLmZvckVhY2goIGNpcmN1aXRFbGVtZW50ID0+IHtcclxuICAgICAgICAgIGlmICggY2lyY3VpdEVsZW1lbnQud2lyZVN0dWIgPT09IHRydWUgKSB7XHJcbiAgICAgICAgICAgIC8vIG5vIG5vcCwgd2lyZSBzdHVicyByZW1haW4gbm9uLWludGVyYWN0aXZlXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgY2lyY3VpdEVsZW1lbnQuaW50ZXJhY3RpdmVQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgIGFkZEJsYWNrQm94Q29udGVudHMoIHRydWVCbGFja0JveENpcmN1aXRTdHJ1Y3QgKTtcclxuICAgICAgfVxyXG4gICAgICBjaXJjdWl0Lm1hcmtEaXJ0eSgpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIC0gY2FsbGVkIGJ5IHJlc2V0XHJcbiAgICB0aGlzLnJlc2V0QmxhY2tCb3hTY2VuZU1vZGVsID0gKCkgPT4ge1xyXG4gICAgICBhZGRXaXJlU3R1YnMoKTtcclxuICAgICAgYWRkQmxhY2tCb3hDb250ZW50cyggdHJ1ZUJsYWNrQm94Q2lyY3VpdFN0cnVjdCApO1xyXG4gICAgICB1c2VyQmxhY2tCb3hDaXJjdWl0U3RydWN0LmNsZWFyKCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXQgdGhlIG1vZGVsLlxyXG4gICAqIEBvdmVycmlkZXNcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVzZXQoKSB7XHJcbiAgICBzdXBlci5yZXNldCgpO1xyXG4gICAgdGhpcy5yZXZlYWxpbmdQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5pc1JldmVhbEVuYWJsZWRQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5yZXNldEJsYWNrQm94U2NlbmVNb2RlbCgpO1xyXG4gIH1cclxufVxyXG5cclxuY2lyY3VpdENvbnN0cnVjdGlvbktpdEJsYWNrQm94U3R1ZHkucmVnaXN0ZXIoICdCbGFja0JveFNjZW5lTW9kZWwnLCBCbGFja0JveFNjZW5lTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgQmxhY2tCb3hTY2VuZU1vZGVsOyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxPQUFPLE1BQU0saUVBQWlFO0FBQ3JGLE9BQU9DLDJCQUEyQixNQUFNLHFGQUFxRjtBQUM3SCxPQUFPQyxhQUFhLE1BQU0sdUVBQXVFO0FBQ2pHLE9BQU9DLFNBQVMsTUFBTSxtRUFBbUU7QUFDekYsT0FBT0MsUUFBUSxNQUFNLGtFQUFrRTtBQUN2RixPQUFPQyxNQUFNLE1BQU0sZ0VBQWdFO0FBQ25GLE9BQU9DLElBQUksTUFBTSw4REFBOEQ7QUFDL0UsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxNQUFNLE1BQU0saUNBQWlDO0FBQ3BELE9BQU9DLG1DQUFtQyxNQUFNLDhDQUE4QztBQUU5RixNQUFNQyxrQkFBa0IsU0FBU1QsMkJBQTJCLENBQUM7RUFFM0Q7QUFDRjtBQUNBO0FBQ0E7RUFDRVUsV0FBV0EsQ0FBRUMseUJBQXlCLEVBQUVDLE1BQU0sRUFBRztJQUMvQyxLQUFLLENBQUUsSUFBSSxFQUFFLEtBQUssRUFBRUEsTUFBTSxFQUFFO01BQzFCQyxTQUFTLEVBQUUsS0FBSztNQUNoQkMsYUFBYSxFQUFFO0lBQ2pCLENBQUUsQ0FBQztJQUNILE1BQU1DLHlCQUF5QixHQUFHZCxhQUFhLENBQUNlLGVBQWUsQ0FBRSxJQUFJLENBQUNDLE9BQU8sRUFBRU4seUJBQXlCLEVBQUUsSUFBSSxDQUFDTSxPQUFPLENBQUNDLHVCQUF1QixFQUFFTixNQUFNLENBQUNPLFlBQVksQ0FBRSxlQUFnQixDQUFDLEVBQUU7TUFFdEw7TUFDQUMsV0FBVyxFQUFFLEtBQUs7TUFDbEJDLGtCQUFrQixFQUFFO0lBQ3RCLENBQUUsQ0FBQztJQUVI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