// Copyright 2016-2023, University of Colorado Boulder

/**
 * Light bulb, made to 'glow' by modulating opacity of the 'on' image. Forked from SCENERY_PHET/LightBulbNode
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Utils from '../../../dot/js/Utils.js';
import { Shape } from '../../../kite/js/imports.js';
import optionize from '../../../phet-core/js/optionize.js';
import LightRaysNode from '../../../scenery-phet/js/LightRaysNode.js';
import { Image, Node } from '../../../scenery/js/imports.js';
import lightBulbBack_png from '../../images/lightBulbBack_png.js';
import lightBulbFrontHigh_png from '../../images/lightBulbFrontHigh_png.js';
import lightBulbFrontReal_png from '../../images/lightBulbFrontReal_png.js';
import lightBulbFront_png from '../../images/lightBulbFront_png.js';
import lightBulbMiddleReal_png from '../../mipmaps/lightBulbMiddleReal_png.js';
import lightBulbMiddle_png from '../../mipmaps/lightBulbMiddle_png.js';
import CCKCConstants from '../CCKCConstants.js';
import circuitConstructionKitCommon from '../circuitConstructionKitCommon.js';

// constants
const BULB_IMAGE_SCALE = 0.125;
export default class CustomLightBulbNode extends Node {
  // Identifies the images used to render this node so they can be prepopulated in the WebGL sprite sheet.
  static webglSpriteNodes = [new Image(lightBulbBack_png), new Image(lightBulbMiddle_png), new Image(lightBulbFront_png), new Image(lightBulbFrontHigh_png)];

  /**
   * @param brightnessProperty 0 (off) to 1 (full brightness)
   * @param [providedOptions]
   */
  constructor(brightnessProperty, providedOptions) {
    assert && assert(brightnessProperty, 'brightness property should exist');
    const options = optionize()({
      baseOnly: false,
      isExtreme: true,
      scale: CCKCConstants.BULB_SCALE,
      isReal: false
    }, providedOptions);
    const baseOnly = options.baseOnly;
    const selectedSocketImage = options.isExtreme ? lightBulbFrontHigh_png : options.isReal ? lightBulbFrontReal_png : lightBulbFront_png;
    const selectedMiddleImage = options.isReal ? lightBulbMiddleReal_png : lightBulbMiddle_png;
    const backNode = new Image(options.baseOnly ? selectedSocketImage : lightBulbBack_png, {
      scale: BULB_IMAGE_SCALE,
      centerX: 0,
      bottom: 0,
      pickable: false
    });
    const middleNode = new Image(options.baseOnly ? selectedSocketImage : selectedMiddleImage, {
      scale: BULB_IMAGE_SCALE,
      centerBottom: backNode.centerBottom,
      pickable: false
    });
    let raysNode = null;

    // If it is only for showing the socket, omit the rays
    if (options.baseOnly) {
      options.children = [backNode];
    } else {
      // Show the rays here where they can be easily positioned, but only when more than the base is showing
      const bulbRadius = middleNode.width / 2;

      // {Node} - displays the light rays, not a child of this node
      raysNode = new LightRaysNode(bulbRadius, {
        // Since the raysNode is rendered in another node (not a child of the CustemLightBulbNode), it needs the same scale
        scale: options.scale,
        x: backNode.centerX,
        // The scale here seems essential to line up the rays on the bulb, not sure why, see https://github.com/phetsims/circuit-construction-kit-common/issues/397
        y: (middleNode.top + bulbRadius) * options.scale
      });
      options.children = [backNode, middleNode];
    }
    super(options);
    this.baseOnly = baseOnly;
    this.backNode = backNode;
    this.raysNode = raysNode;

    // brightness of the bulb
    this.brightnessProperty = brightnessProperty;

    // If it shows the rays, update their brightness
    if (!options.baseOnly) {
      this.brightnessObserver = this.update.bind(this);
      this.brightnessProperty.link(this.brightnessObserver);
    } else {
      this.brightnessObserver = null;
    }
    this.disposeCustomLightBulbNode = () => {
      if (!options.baseOnly) {
        this.brightnessProperty.unlink(this.brightnessObserver);
      }
    };

    // Custom mouse and touch area for the bulb, so it doesn't interfere with the vertices,
    // see https://github.com/phetsims/circuit-construction-kit-black-box-study/issues/5
    const w = this.localBounds.width;
    const h = this.localBounds.height;
    const fractionDown = 0.6; // How far the top part of the bulb extends over the image
    const fractionTrim = 0.1; // How much to trim off of the bottom of the bulb.
    const fractionHorizontalPadding = 0.25;
    this.mouseArea = new Shape().moveTo(this.localBounds.minX, this.localBounds.minY).lineToRelative(w, 0).lineToRelative(0, h * fractionDown).lineToRelative(-w * fractionHorizontalPadding, 0).lineToRelative(0, h * (1 - fractionDown - fractionTrim)).lineToRelative(-w * (1 - fractionHorizontalPadding * 2), 0).lineToRelative(0, -h * (1 - fractionDown - fractionTrim)).lineToRelative(-w * fractionHorizontalPadding, 0).lineTo(this.localBounds.minX, this.localBounds.minY);
    this.touchArea = this.mouseArea;

    // Update this Node when it becomes visible.
    this.visibleProperty.link(visible => visible && this.update());
  }
  dispose() {
    this.disposeCustomLightBulbNode();
  }

  /**
   * Move forward in time
   * @param time - total elapsed time in seconds
   * @param dt - seconds since last step
   */
  step(time, dt) {
    this.update();
  }

  // update when the brightness changes
  update() {
    if (this.visible && !this.baseOnly) {
      const brightness = this.brightnessProperty.value;
      assert && assert(brightness >= 0 && brightness <= 1);
      this.backNode.visible = brightness > 0;
      if (this.backNode.visible) {
        this.backNode.imageOpacity = Utils.clamp(Utils.linear(0, 0.5, 0, 1, brightness), 0, 1);
      }
      assert && assert(this.raysNode);
      if (this.raysNode) {
        this.raysNode.setBrightness(brightness);
      }
    }
  }
}
circuitConstructionKitCommon.register('CustomLightBulbNode', CustomLightBulbNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlNoYXBlIiwib3B0aW9uaXplIiwiTGlnaHRSYXlzTm9kZSIsIkltYWdlIiwiTm9kZSIsImxpZ2h0QnVsYkJhY2tfcG5nIiwibGlnaHRCdWxiRnJvbnRIaWdoX3BuZyIsImxpZ2h0QnVsYkZyb250UmVhbF9wbmciLCJsaWdodEJ1bGJGcm9udF9wbmciLCJsaWdodEJ1bGJNaWRkbGVSZWFsX3BuZyIsImxpZ2h0QnVsYk1pZGRsZV9wbmciLCJDQ0tDQ29uc3RhbnRzIiwiY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbiIsIkJVTEJfSU1BR0VfU0NBTEUiLCJDdXN0b21MaWdodEJ1bGJOb2RlIiwid2ViZ2xTcHJpdGVOb2RlcyIsImNvbnN0cnVjdG9yIiwiYnJpZ2h0bmVzc1Byb3BlcnR5IiwicHJvdmlkZWRPcHRpb25zIiwiYXNzZXJ0Iiwib3B0aW9ucyIsImJhc2VPbmx5IiwiaXNFeHRyZW1lIiwic2NhbGUiLCJCVUxCX1NDQUxFIiwiaXNSZWFsIiwic2VsZWN0ZWRTb2NrZXRJbWFnZSIsInNlbGVjdGVkTWlkZGxlSW1hZ2UiLCJiYWNrTm9kZSIsImNlbnRlclgiLCJib3R0b20iLCJwaWNrYWJsZSIsIm1pZGRsZU5vZGUiLCJjZW50ZXJCb3R0b20iLCJyYXlzTm9kZSIsImNoaWxkcmVuIiwiYnVsYlJhZGl1cyIsIndpZHRoIiwieCIsInkiLCJ0b3AiLCJicmlnaHRuZXNzT2JzZXJ2ZXIiLCJ1cGRhdGUiLCJiaW5kIiwibGluayIsImRpc3Bvc2VDdXN0b21MaWdodEJ1bGJOb2RlIiwidW5saW5rIiwidyIsImxvY2FsQm91bmRzIiwiaCIsImhlaWdodCIsImZyYWN0aW9uRG93biIsImZyYWN0aW9uVHJpbSIsImZyYWN0aW9uSG9yaXpvbnRhbFBhZGRpbmciLCJtb3VzZUFyZWEiLCJtb3ZlVG8iLCJtaW5YIiwibWluWSIsImxpbmVUb1JlbGF0aXZlIiwibGluZVRvIiwidG91Y2hBcmVhIiwidmlzaWJsZVByb3BlcnR5IiwidmlzaWJsZSIsImRpc3Bvc2UiLCJzdGVwIiwidGltZSIsImR0IiwiYnJpZ2h0bmVzcyIsInZhbHVlIiwiaW1hZ2VPcGFjaXR5IiwiY2xhbXAiLCJsaW5lYXIiLCJzZXRCcmlnaHRuZXNzIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDdXN0b21MaWdodEJ1bGJOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIExpZ2h0IGJ1bGIsIG1hZGUgdG8gJ2dsb3cnIGJ5IG1vZHVsYXRpbmcgb3BhY2l0eSBvZiB0aGUgJ29uJyBpbWFnZS4gRm9ya2VkIGZyb20gU0NFTkVSWV9QSEVUL0xpZ2h0QnVsYk5vZGVcclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBMaWdodFJheXNOb2RlIGZyb20gJy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9MaWdodFJheXNOb2RlLmpzJztcclxuaW1wb3J0IHsgSW1hZ2UsIE5vZGUsIE5vZGVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGxpZ2h0QnVsYkJhY2tfcG5nIGZyb20gJy4uLy4uL2ltYWdlcy9saWdodEJ1bGJCYWNrX3BuZy5qcyc7XHJcbmltcG9ydCBsaWdodEJ1bGJGcm9udEhpZ2hfcG5nIGZyb20gJy4uLy4uL2ltYWdlcy9saWdodEJ1bGJGcm9udEhpZ2hfcG5nLmpzJztcclxuaW1wb3J0IGxpZ2h0QnVsYkZyb250UmVhbF9wbmcgZnJvbSAnLi4vLi4vaW1hZ2VzL2xpZ2h0QnVsYkZyb250UmVhbF9wbmcuanMnO1xyXG5pbXBvcnQgbGlnaHRCdWxiRnJvbnRfcG5nIGZyb20gJy4uLy4uL2ltYWdlcy9saWdodEJ1bGJGcm9udF9wbmcuanMnO1xyXG5pbXBvcnQgbGlnaHRCdWxiTWlkZGxlUmVhbF9wbmcgZnJvbSAnLi4vLi4vbWlwbWFwcy9saWdodEJ1bGJNaWRkbGVSZWFsX3BuZy5qcyc7XHJcbmltcG9ydCBsaWdodEJ1bGJNaWRkbGVfcG5nIGZyb20gJy4uLy4uL21pcG1hcHMvbGlnaHRCdWxiTWlkZGxlX3BuZy5qcyc7XHJcbmltcG9ydCBDQ0tDQ29uc3RhbnRzIGZyb20gJy4uL0NDS0NDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbiBmcm9tICcuLi9jaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBCVUxCX0lNQUdFX1NDQUxFID0gMC4xMjU7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIGJhc2VPbmx5PzogYm9vbGVhbjtcclxuICBpc0V4dHJlbWU/OiBib29sZWFuO1xyXG4gIGlzUmVhbD86IGJvb2xlYW47XHJcbiAgc2NhbGU/OiBudW1iZXI7IC8vIE5vdGUgdGhpcyBkaWZmZXJzIGZyb20gTm9kZU9wdGlvbnNbJ3NjYWxlJ11cclxufTtcclxudHlwZSBDdXN0b21MaWdodEJ1bGJOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgTm9kZU9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDdXN0b21MaWdodEJ1bGJOb2RlIGV4dGVuZHMgTm9kZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBiYXNlT25seTogYm9vbGVhbjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGJhY2tOb2RlOiBJbWFnZTtcclxuICBwdWJsaWMgcmVhZG9ubHkgcmF5c05vZGU6IExpZ2h0UmF5c05vZGUgfCBudWxsO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgYnJpZ2h0bmVzc1Byb3BlcnR5OiBQcm9wZXJ0eTxudW1iZXI+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgYnJpZ2h0bmVzc09ic2VydmVyOiAoICggYnJpZ2h0bmVzczogbnVtYmVyICkgPT4gdm9pZCApIHwgbnVsbDtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VDdXN0b21MaWdodEJ1bGJOb2RlOiAoKSA9PiB2b2lkO1xyXG5cclxuICAvLyBJZGVudGlmaWVzIHRoZSBpbWFnZXMgdXNlZCB0byByZW5kZXIgdGhpcyBub2RlIHNvIHRoZXkgY2FuIGJlIHByZXBvcHVsYXRlZCBpbiB0aGUgV2ViR0wgc3ByaXRlIHNoZWV0LlxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgd2ViZ2xTcHJpdGVOb2RlcyA9IFtcclxuICAgIG5ldyBJbWFnZSggbGlnaHRCdWxiQmFja19wbmcgKSxcclxuICAgIG5ldyBJbWFnZSggbGlnaHRCdWxiTWlkZGxlX3BuZyApLFxyXG4gICAgbmV3IEltYWdlKCBsaWdodEJ1bGJGcm9udF9wbmcgKSxcclxuICAgIG5ldyBJbWFnZSggbGlnaHRCdWxiRnJvbnRIaWdoX3BuZyApIF07XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBicmlnaHRuZXNzUHJvcGVydHkgMCAob2ZmKSB0byAxIChmdWxsIGJyaWdodG5lc3MpXHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBicmlnaHRuZXNzUHJvcGVydHk6IFByb3BlcnR5PG51bWJlcj4sIHByb3ZpZGVkT3B0aW9ucz86IEN1c3RvbUxpZ2h0QnVsYk5vZGVPcHRpb25zICkge1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggYnJpZ2h0bmVzc1Byb3BlcnR5LCAnYnJpZ2h0bmVzcyBwcm9wZXJ0eSBzaG91bGQgZXhpc3QnICk7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxDdXN0b21MaWdodEJ1bGJOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcbiAgICAgIGJhc2VPbmx5OiBmYWxzZSxcclxuICAgICAgaXNFeHRyZW1lOiB0cnVlLFxyXG4gICAgICBzY2FsZTogQ0NLQ0NvbnN0YW50cy5CVUxCX1NDQUxFLFxyXG4gICAgICBpc1JlYWw6IGZhbHNlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBjb25zdCBiYXNlT25seSA9IG9wdGlvbnMuYmFzZU9ubHk7XHJcblxyXG4gICAgY29uc3Qgc2VsZWN0ZWRTb2NrZXRJbWFnZSA9IG9wdGlvbnMuaXNFeHRyZW1lID8gbGlnaHRCdWxiRnJvbnRIaWdoX3BuZyA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5pc1JlYWwgPyBsaWdodEJ1bGJGcm9udFJlYWxfcG5nIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodEJ1bGJGcm9udF9wbmc7XHJcblxyXG4gICAgY29uc3Qgc2VsZWN0ZWRNaWRkbGVJbWFnZSA9IG9wdGlvbnMuaXNSZWFsID8gbGlnaHRCdWxiTWlkZGxlUmVhbF9wbmcgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0QnVsYk1pZGRsZV9wbmc7XHJcblxyXG4gICAgY29uc3QgYmFja05vZGUgPSBuZXcgSW1hZ2UoIG9wdGlvbnMuYmFzZU9ubHkgPyBzZWxlY3RlZFNvY2tldEltYWdlIDogbGlnaHRCdWxiQmFja19wbmcsIHtcclxuICAgICAgc2NhbGU6IEJVTEJfSU1BR0VfU0NBTEUsXHJcbiAgICAgIGNlbnRlclg6IDAsXHJcbiAgICAgIGJvdHRvbTogMCxcclxuICAgICAgcGlja2FibGU6IGZhbHNlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgbWlkZGxlTm9kZSA9IG5ldyBJbWFnZSggb3B0aW9ucy5iYXNlT25seSA/IHNlbGVjdGVkU29ja2V0SW1hZ2UgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRNaWRkbGVJbWFnZSwge1xyXG4gICAgICBzY2FsZTogQlVMQl9JTUFHRV9TQ0FMRSxcclxuICAgICAgY2VudGVyQm90dG9tOiBiYWNrTm9kZS5jZW50ZXJCb3R0b20sXHJcbiAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgfSApO1xyXG5cclxuICAgIGxldCByYXlzTm9kZSA9IG51bGw7XHJcblxyXG4gICAgLy8gSWYgaXQgaXMgb25seSBmb3Igc2hvd2luZyB0aGUgc29ja2V0LCBvbWl0IHRoZSByYXlzXHJcbiAgICBpZiAoIG9wdGlvbnMuYmFzZU9ubHkgKSB7XHJcbiAgICAgIG9wdGlvbnMuY2hpbGRyZW4gPSBbIGJhY2tOb2RlIF07XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuXHJcbiAgICAgIC8vIFNob3cgdGhlIHJheXMgaGVyZSB3aGVyZSB0aGV5IGNhbiBiZSBlYXNpbHkgcG9zaXRpb25lZCwgYnV0IG9ubHkgd2hlbiBtb3JlIHRoYW4gdGhlIGJhc2UgaXMgc2hvd2luZ1xyXG4gICAgICBjb25zdCBidWxiUmFkaXVzID0gbWlkZGxlTm9kZS53aWR0aCAvIDI7XHJcblxyXG4gICAgICAvLyB7Tm9kZX0gLSBkaXNwbGF5cyB0aGUgbGlnaHQgcmF5cywgbm90IGEgY2hpbGQgb2YgdGhpcyBub2RlXHJcbiAgICAgIHJheXNOb2RlID0gbmV3IExpZ2h0UmF5c05vZGUoIGJ1bGJSYWRpdXMsIHtcclxuXHJcbiAgICAgICAgLy8gU2luY2UgdGhlIHJheXNOb2RlIGlzIHJlbmRlcmVkIGluIGFub3RoZXIgbm9kZSAobm90IGEgY2hpbGQgb2YgdGhlIEN1c3RlbUxpZ2h0QnVsYk5vZGUpLCBpdCBuZWVkcyB0aGUgc2FtZSBzY2FsZVxyXG4gICAgICAgIHNjYWxlOiBvcHRpb25zLnNjYWxlLFxyXG4gICAgICAgIHg6IGJhY2tOb2RlLmNlbnRlclgsXHJcblxyXG4gICAgICAgIC8vIFRoZSBzY2FsZSBoZXJlIHNlZW1zIGVzc2VudGlhbCB0byBsaW5lIHVwIHRoZSByYXlzIG9uIHRoZSBidWxiLCBub3Qgc3VyZSB3aHksIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWNvbW1vbi9pc3N1ZXMvMzk3XHJcbiAgICAgICAgeTogKCBtaWRkbGVOb2RlLnRvcCArIGJ1bGJSYWRpdXMgKSAqIG9wdGlvbnMuc2NhbGVcclxuICAgICAgfSApO1xyXG5cclxuICAgICAgb3B0aW9ucy5jaGlsZHJlbiA9IFsgYmFja05vZGUsIG1pZGRsZU5vZGUgXTtcclxuICAgIH1cclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuYmFzZU9ubHkgPSBiYXNlT25seTtcclxuICAgIHRoaXMuYmFja05vZGUgPSBiYWNrTm9kZTtcclxuICAgIHRoaXMucmF5c05vZGUgPSByYXlzTm9kZTtcclxuXHJcbiAgICAvLyBicmlnaHRuZXNzIG9mIHRoZSBidWxiXHJcbiAgICB0aGlzLmJyaWdodG5lc3NQcm9wZXJ0eSA9IGJyaWdodG5lc3NQcm9wZXJ0eTtcclxuXHJcbiAgICAvLyBJZiBpdCBzaG93cyB0aGUgcmF5cywgdXBkYXRlIHRoZWlyIGJyaWdodG5lc3NcclxuICAgIGlmICggIW9wdGlvbnMuYmFzZU9ubHkgKSB7XHJcblxyXG4gICAgICB0aGlzLmJyaWdodG5lc3NPYnNlcnZlciA9IHRoaXMudXBkYXRlLmJpbmQoIHRoaXMgKTtcclxuICAgICAgdGhpcy5icmlnaHRuZXNzUHJvcGVydHkubGluayggdGhpcy5icmlnaHRuZXNzT2JzZXJ2ZXIgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmJyaWdodG5lc3NPYnNlcnZlciA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlQ3VzdG9tTGlnaHRCdWxiTm9kZSA9ICgpID0+IHtcclxuICAgICAgaWYgKCAhb3B0aW9ucy5iYXNlT25seSApIHtcclxuICAgICAgICB0aGlzLmJyaWdodG5lc3NQcm9wZXJ0eS51bmxpbmsoIHRoaXMuYnJpZ2h0bmVzc09ic2VydmVyISApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIEN1c3RvbSBtb3VzZSBhbmQgdG91Y2ggYXJlYSBmb3IgdGhlIGJ1bGIsIHNvIGl0IGRvZXNuJ3QgaW50ZXJmZXJlIHdpdGggdGhlIHZlcnRpY2VzLFxyXG4gICAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9jaXJjdWl0LWNvbnN0cnVjdGlvbi1raXQtYmxhY2stYm94LXN0dWR5L2lzc3Vlcy81XHJcbiAgICBjb25zdCB3ID0gdGhpcy5sb2NhbEJvdW5kcy53aWR0aDtcclxuICAgIGNvbnN0IGggPSB0aGlzLmxvY2FsQm91bmRzLmhlaWdodDtcclxuICAgIGNvbnN0IGZyYWN0aW9uRG93biA9IDAuNjsgLy8gSG93IGZhciB0aGUgdG9wIHBhcnQgb2YgdGhlIGJ1bGIgZXh0ZW5kcyBvdmVyIHRoZSBpbWFnZVxyXG4gICAgY29uc3QgZnJhY3Rpb25UcmltID0gMC4xOyAvLyBIb3cgbXVjaCB0byB0cmltIG9mZiBvZiB0aGUgYm90dG9tIG9mIHRoZSBidWxiLlxyXG4gICAgY29uc3QgZnJhY3Rpb25Ib3Jpem9udGFsUGFkZGluZyA9IDAuMjU7XHJcbiAgICB0aGlzLm1vdXNlQXJlYSA9IG5ldyBTaGFwZSgpXHJcbiAgICAgIC5tb3ZlVG8oIHRoaXMubG9jYWxCb3VuZHMubWluWCwgdGhpcy5sb2NhbEJvdW5kcy5taW5ZIClcclxuICAgICAgLmxpbmVUb1JlbGF0aXZlKCB3LCAwIClcclxuICAgICAgLmxpbmVUb1JlbGF0aXZlKCAwLCBoICogZnJhY3Rpb25Eb3duIClcclxuICAgICAgLmxpbmVUb1JlbGF0aXZlKCAtdyAqIGZyYWN0aW9uSG9yaXpvbnRhbFBhZGRpbmcsIDAgKVxyXG4gICAgICAubGluZVRvUmVsYXRpdmUoIDAsIGggKiAoIDEgLSBmcmFjdGlvbkRvd24gLSBmcmFjdGlvblRyaW0gKSApXHJcbiAgICAgIC5saW5lVG9SZWxhdGl2ZSggLXcgKiAoIDEgLSBmcmFjdGlvbkhvcml6b250YWxQYWRkaW5nICogMiApLCAwIClcclxuICAgICAgLmxpbmVUb1JlbGF0aXZlKCAwLCAtaCAqICggMSAtIGZyYWN0aW9uRG93biAtIGZyYWN0aW9uVHJpbSApIClcclxuICAgICAgLmxpbmVUb1JlbGF0aXZlKCAtdyAqIGZyYWN0aW9uSG9yaXpvbnRhbFBhZGRpbmcsIDAgKVxyXG4gICAgICAubGluZVRvKCB0aGlzLmxvY2FsQm91bmRzLm1pblgsIHRoaXMubG9jYWxCb3VuZHMubWluWSApO1xyXG4gICAgdGhpcy50b3VjaEFyZWEgPSB0aGlzLm1vdXNlQXJlYTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhpcyBOb2RlIHdoZW4gaXQgYmVjb21lcyB2aXNpYmxlLlxyXG4gICAgdGhpcy52aXNpYmxlUHJvcGVydHkubGluayggKCB2aXNpYmxlOiBib29sZWFuICkgPT4gdmlzaWJsZSAmJiB0aGlzLnVwZGF0ZSgpICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZUN1c3RvbUxpZ2h0QnVsYk5vZGUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1vdmUgZm9yd2FyZCBpbiB0aW1lXHJcbiAgICogQHBhcmFtIHRpbWUgLSB0b3RhbCBlbGFwc2VkIHRpbWUgaW4gc2Vjb25kc1xyXG4gICAqIEBwYXJhbSBkdCAtIHNlY29uZHMgc2luY2UgbGFzdCBzdGVwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGVwKCB0aW1lOiBudW1iZXIsIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgLy8gdXBkYXRlIHdoZW4gdGhlIGJyaWdodG5lc3MgY2hhbmdlc1xyXG4gIHByaXZhdGUgdXBkYXRlKCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLnZpc2libGUgJiYgIXRoaXMuYmFzZU9ubHkgKSB7XHJcbiAgICAgIGNvbnN0IGJyaWdodG5lc3MgPSB0aGlzLmJyaWdodG5lc3NQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggYnJpZ2h0bmVzcyA+PSAwICYmIGJyaWdodG5lc3MgPD0gMSApO1xyXG4gICAgICB0aGlzLmJhY2tOb2RlLnZpc2libGUgPSAoIGJyaWdodG5lc3MgPiAwICk7XHJcbiAgICAgIGlmICggdGhpcy5iYWNrTm9kZS52aXNpYmxlICkge1xyXG4gICAgICAgIHRoaXMuYmFja05vZGUuaW1hZ2VPcGFjaXR5ID0gVXRpbHMuY2xhbXAoIFV0aWxzLmxpbmVhciggMCwgMC41LCAwLCAxLCBicmlnaHRuZXNzICksIDAsIDEgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5yYXlzTm9kZSApO1xyXG4gICAgICBpZiAoIHRoaXMucmF5c05vZGUgKSB7XHJcbiAgICAgICAgdGhpcy5yYXlzTm9kZS5zZXRCcmlnaHRuZXNzKCBicmlnaHRuZXNzICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNpcmN1aXRDb25zdHJ1Y3Rpb25LaXRDb21tb24ucmVnaXN0ZXIoICdDdXN0b21MaWdodEJ1bGJOb2RlJywgQ3VzdG9tTGlnaHRCdWxiTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLEtBQUssTUFBTSwwQkFBMEI7QUFDNUMsU0FBU0MsS0FBSyxRQUFRLDZCQUE2QjtBQUNuRCxPQUFPQyxTQUFTLE1BQU0sb0NBQW9DO0FBQzFELE9BQU9DLGFBQWEsTUFBTSwyQ0FBMkM7QUFDckUsU0FBU0MsS0FBSyxFQUFFQyxJQUFJLFFBQXFCLGdDQUFnQztB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