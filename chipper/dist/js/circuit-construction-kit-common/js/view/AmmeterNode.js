// Copyright 2016-2023, University of Colorado Boulder

/**
 * The user interface component with a single probe which reads current values from Wires (not from Vertex or
 * FixedCircuitElement instances). Exists for the life of the sim and hence does not require a dispose implementation.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import DerivedProperty from '../../../axon/js/DerivedProperty.js';
import Vector2 from '../../../dot/js/Vector2.js';
import Vector2Property from '../../../dot/js/Vector2Property.js';
import ProbeNode from '../../../scenery-phet/js/ProbeNode.js';
import WireNode from '../../../scenery-phet/js/WireNode.js';
import { Color, DragListener, Image, Node, Rectangle, Text } from '../../../scenery/js/imports.js';
import Tandem from '../../../tandem/js/Tandem.js';
import ammeterBody_png from '../../images/ammeterBody_png.js';
import CCKCConstants from '../CCKCConstants.js';
import CCKCUtils from '../CCKCUtils.js';
import CircuitConstructionKitCommonStrings from '../CircuitConstructionKitCommonStrings.js';
import circuitConstructionKitCommon from '../circuitConstructionKitCommon.js';
import ProbeTextNode from './ProbeTextNode.js';
import ammeterReadoutTypeProperty from './ammeterReadoutTypeProperty.js';
import optionize from '../../../phet-core/js/optionize.js';
import StringIO from '../../../tandem/js/types/StringIO.js';
const currentStringProperty = CircuitConstructionKitCommonStrings.currentStringProperty;

// constants
// measurements for the cubic curve for the wire nodes
const BODY_LEAD_Y = -30; // in model=view coordinates
const PROBE_LEAD_Y = 15; // in model=view coordinates
const HANDLE_WIDTH = 50;

// overall scale factor for the body and probe
const SCALE_FACTOR = 0.5;

// unsigned measurements for the circles on the voltmeter body image, for where the probe wires connect
const PROBE_CONNECTION_POINT_DY = 8;
export default class AmmeterNode extends Node {
  // the model associated with this view

  // so events can be forwarded from the toolbox

  /**
   * @param ammeter
   * @param circuitNode - for getting the currents, or null if rendering an icon
   * @param [providedOptions]
   */
  constructor(ammeter, circuitNode, providedOptions) {
    const options = optionize()({
      // true if it will be used as a toolbox icon
      isIcon: false,
      // allowable drag bounds in view coordinates
      visibleBoundsProperty: null,
      // For some CCK Black Box modes, when the user makes a change, the results are hidden
      showResultsProperty: new BooleanProperty(true),
      // For the black box study, there is a different current threshold in the readout
      blackBoxStudy: false,
      showPhetioIndex: false,
      phetioVisiblePropertyInstrumented: false,
      tandem: Tandem.REQUIRED
    }, providedOptions);
    const tandem = options.tandem;

    // if the AmmeterNode is an icon, do not instrument the details of the children
    const tandemForChildren = options.isIcon ? Tandem.OPT_OUT : tandem;
    const wireBodyPositionProperty = new Vector2Property(new Vector2(0, 0));
    const wireProbePositionProperty = new Vector2Property(new Vector2(0, 0));
    const wireNode = new WireNode(wireBodyPositionProperty, new Vector2Property(new Vector2(0, BODY_LEAD_Y)), wireProbePositionProperty, new Vector2Property(new Vector2(0, PROBE_LEAD_Y)), {
      stroke: Color.BLACK,
      lineWidth: 3,
      pickable: false
    });
    const currentReadoutProperty = new DerivedProperty([ammeter.currentProperty, ammeterReadoutTypeProperty, CircuitConstructionKitCommonStrings.currentUnitsStringProperty], current => CCKCUtils.createCurrentReadout(current, options.blackBoxStudy), {
      tandem: tandemForChildren.createTandem('probeReadoutText').createTandem(Text.STRING_PROPERTY_TANDEM_NAME),
      phetioValueType: StringIO
    });
    const probeTextProperty = new DerivedProperty([currentStringProperty], currentString => options.showPhetioIndex ? currentString + ' ' + ammeter.phetioIndex : currentString, {
      tandem: tandemForChildren.createTandem('probeTitleText').createTandem(Text.STRING_PROPERTY_TANDEM_NAME),
      phetioValueType: StringIO
    });
    const probeTextNode = new ProbeTextNode(currentReadoutProperty, options.showResultsProperty, probeTextProperty,
    // No need for an extra level of nesting in the tandem tree, since that is just an implementation detail
    // and not a feature
    tandemForChildren, {
      centerX: ammeterBody_png.width / 2,
      centerY: ammeterBody_png.height / 2 + 7 // adjust for the top notch design
    });

    const bodyNode = new Image(ammeterBody_png, {
      scale: SCALE_FACTOR,
      cursor: 'pointer',
      children: [probeTextNode]
    });
    const probeNode = new ProbeNode({
      cursor: 'pointer',
      sensorTypeFunction: ProbeNode.crosshairs(),
      scale: SCALE_FACTOR,
      handleWidth: HANDLE_WIDTH,
      color: '#2c2c2b',
      // The dark gray border
      innerRadius: 43,
      // Add a decoration on the handle to match the color scheme
      children: [new Rectangle(0, 52, HANDLE_WIDTH * 0.72, 19, {
        cornerRadius: 6,
        centerX: 0,
        fill: '#e79547' // Match the orange of the ammeter image
      })]
    });

    assert && assert(!options.hasOwnProperty('children'), 'children will be supplied by AmmeterNode');
    options.children = [bodyNode, wireNode, probeNode];
    super(options);
    this.probeNode = probeNode;
    this.ammeter = ammeter;
    const alignProbeToBody = () => {
      if (ammeter.isDraggingProbesWithBodyProperty.get()) {
        const constrain = pt => options.visibleBoundsProperty ? options.visibleBoundsProperty.value.eroded(CCKCConstants.DRAG_BOUNDS_EROSION).closestPointTo(pt) : pt;
        ammeter.probePositionProperty.set(constrain(ammeter.bodyPositionProperty.value.plusXY(40, -80)));
      }
    };

    // When the body position changes, update the body node and the wire
    ammeter.bodyPositionProperty.link(bodyPosition => {
      bodyNode.centerTop = bodyPosition;
      wireBodyPositionProperty.value = bodyNode.centerTop.plusXY(0, PROBE_CONNECTION_POINT_DY);
      alignProbeToBody();
    });

    // When the probe position changes, update the probe node and the wire
    ammeter.probePositionProperty.link(probePosition => {
      this.probeNode.centerTop = probePosition;
      wireProbePositionProperty.value = this.probeNode.centerBottom;
    });
    if (!options.isIcon) {
      // Show the ammeter in the play area when dragged from toolbox
      ammeter.isActiveProperty.linkAttribute(this, 'visible');
      ammeter.isActiveProperty.link(alignProbeToBody);
      const erodedDragBoundsProperty = new DerivedProperty([options.visibleBoundsProperty], visibleBounds => {
        return visibleBounds.eroded(CCKCConstants.DRAG_BOUNDS_EROSION);
      });
      const probeDragHandler = new DragListener({
        positionProperty: ammeter.probePositionProperty,
        useParentOffset: true,
        tandem: tandemForChildren.createTandem('probeDragHandler'),
        start: () => this.moveToFront(),
        dragBoundsProperty: erodedDragBoundsProperty
      });
      this.dragHandler = new DragListener({
        useParentOffset: true,
        positionProperty: ammeter.bodyPositionProperty,
        tandem: tandemForChildren.createTandem('dragListener'),
        start: () => this.moveToFront(),
        end: function () {
          ammeter.droppedEmitter.emit(bodyNode.globalBounds);

          // After dropping in the play area the probes move independently of the body
          ammeter.isDraggingProbesWithBodyProperty.set(false);
        },
        // adds support for zoomed coordinate frame, see
        // https://github.com/phetsims/circuit-construction-kit-common/issues/301
        targetNode: this,
        dragBoundsProperty: erodedDragBoundsProperty
      });
      bodyNode.addInputListener(this.dragHandler);
      erodedDragBoundsProperty.link(erodedDragBounds => {
        ammeter.bodyPositionProperty.value = erodedDragBounds.closestPointTo(ammeter.bodyPositionProperty.value);
        ammeter.probePositionProperty.value = erodedDragBounds.closestPointTo(ammeter.probePositionProperty.value);
      });
      this.probeNode.addInputListener(probeDragHandler);

      /**
       * Detection for ammeter probe + circuit intersection is done in the view since view bounds are used
       */
      const updateAmmeter = () => {
        // Skip work when ammeter is not out, to improve performance.
        if (ammeter.isActiveProperty.get()) {
          const ammeterConnection = circuitNode.getCurrent(this.probeNode);
          ammeter.setConnectionAndCurrent(ammeterConnection);
        }
      };
      circuitNode.circuit.circuitChangedEmitter.addListener(updateAmmeter);
      ammeter.probePositionProperty.link(updateAmmeter);
    } else {
      this.dragHandler = null;
    }

    // When rendered as an icon, the touch area should span the bounds (no gaps between probes and body)
    if (options.isIcon) {
      this.touchArea = this.bounds.copy();
      this.mouseArea = this.bounds.copy();
      this.cursor = 'pointer';
    }
    this.addLinkedElement(ammeter, {
      tandem: tandemForChildren.createTandem('ammeter')
    });
  }

  /**
   * Forward a drag from the toolbox to the play area node.
   */
  startDrag(event) {
    this.dragHandler && this.dragHandler.press(event);
  }
}
circuitConstructionKitCommon.register('AmmeterNode', AmmeterNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEZXJpdmVkUHJvcGVydHkiLCJWZWN0b3IyIiwiVmVjdG9yMlByb3BlcnR5IiwiUHJvYmVOb2RlIiwiV2lyZU5vZGUiLCJDb2xvciIsIkRyYWdMaXN0ZW5lciIsIkltYWdlIiwiTm9kZSIsIlJlY3RhbmdsZSIsIlRleHQiLCJUYW5kZW0iLCJhbW1ldGVyQm9keV9wbmciLCJDQ0tDQ29uc3RhbnRzIiwiQ0NLQ1V0aWxzIiwiQ2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vblN0cmluZ3MiLCJjaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uIiwiUHJvYmVUZXh0Tm9kZSIsImFtbWV0ZXJSZWFkb3V0VHlwZVByb3BlcnR5Iiwib3B0aW9uaXplIiwiU3RyaW5nSU8iLCJjdXJyZW50U3RyaW5nUHJvcGVydHkiLCJCT0RZX0xFQURfWSIsIlBST0JFX0xFQURfWSIsIkhBTkRMRV9XSURUSCIsIlNDQUxFX0ZBQ1RPUiIsIlBST0JFX0NPTk5FQ1RJT05fUE9JTlRfRFkiLCJBbW1ldGVyTm9kZSIsImNvbnN0cnVjdG9yIiwiYW1tZXRlciIsImNpcmN1aXROb2RlIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImlzSWNvbiIsInZpc2libGVCb3VuZHNQcm9wZXJ0eSIsInNob3dSZXN1bHRzUHJvcGVydHkiLCJibGFja0JveFN0dWR5Iiwic2hvd1BoZXRpb0luZGV4IiwicGhldGlvVmlzaWJsZVByb3BlcnR5SW5zdHJ1bWVudGVkIiwidGFuZGVtIiwiUkVRVUlSRUQiLCJ0YW5kZW1Gb3JDaGlsZHJlbiIsIk9QVF9PVVQiLCJ3aXJlQm9keVBvc2l0aW9uUHJvcGVydHkiLCJ3aXJlUHJvYmVQb3NpdGlvblByb3BlcnR5Iiwid2lyZU5vZGUiLCJzdHJva2UiLCJCTEFDSyIsImxpbmVXaWR0aCIsInBpY2thYmxlIiwiY3VycmVudFJlYWRvdXRQcm9wZXJ0eSIsImN1cnJlbnRQcm9wZXJ0eSIsImN1cnJlbnRVbml0c1N0cmluZ1Byb3BlcnR5IiwiY3VycmVudCIsImNyZWF0ZUN1cnJlbnRSZWFkb3V0IiwiY3JlYXRlVGFuZGVtIiwiU1RSSU5HX1BST1BFUlRZX1RBTkRFTV9OQU1FIiwicGhldGlvVmFsdWVUeXBlIiwicHJvYmVUZXh0UHJvcGVydHkiLCJjdXJyZW50U3RyaW5nIiwicGhldGlvSW5kZXgiLCJwcm9iZVRleHROb2RlIiwiY2VudGVyWCIsIndpZHRoIiwiY2VudGVyWSIsImhlaWdodCIsImJvZHlOb2RlIiwic2NhbGUiLCJjdXJzb3IiLCJjaGlsZHJlbiIsInByb2JlTm9kZSIsInNlbnNvclR5cGVGdW5jdGlvbiIsImNyb3NzaGFpcnMiLCJoYW5kbGVXaWR0aCIsImNvbG9yIiwiaW5uZXJSYWRpdXMiLCJjb3JuZXJSYWRpdXMiLCJmaWxsIiwiYXNzZXJ0IiwiaGFzT3duUHJvcGVydHkiLCJhbGlnblByb2JlVG9Cb2R5IiwiaXNEcmFnZ2luZ1Byb2Jlc1dpdGhCb2R5UHJvcGVydHkiLCJnZXQiLCJjb25zdHJhaW4iLCJwdCIsInZhbHVlIiwiZXJvZGVkIiwiRFJBR19CT1VORFNfRVJPU0lPTiIsImNsb3Nlc3RQb2ludFRvIiwicHJvYmVQb3NpdGlvblByb3BlcnR5Iiwic2V0IiwiYm9keVBvc2l0aW9uUHJvcGVydHkiLCJwbHVzWFkiLCJsaW5rIiwiYm9keVBvc2l0aW9uIiwiY2VudGVyVG9wIiwicHJvYmVQb3NpdGlvbiIsImNlbnRlckJvdHRvbSIsImlzQWN0aXZlUHJvcGVydHkiLCJsaW5rQXR0cmlidXRlIiwiZXJvZGVkRHJhZ0JvdW5kc1Byb3BlcnR5IiwidmlzaWJsZUJvdW5kcyIsInByb2JlRHJhZ0hhbmRsZXIiLCJwb3NpdGlvblByb3BlcnR5IiwidXNlUGFyZW50T2Zmc2V0Iiwic3RhcnQiLCJtb3ZlVG9Gcm9udCIsImRyYWdCb3VuZHNQcm9wZXJ0eSIsImRyYWdIYW5kbGVyIiwiZW5kIiwiZHJvcHBlZEVtaXR0ZXIiLCJlbWl0IiwiZ2xvYmFsQm91bmRzIiwidGFyZ2V0Tm9kZSIsImFkZElucHV0TGlzdGVuZXIiLCJlcm9kZWREcmFnQm91bmRzIiwidXBkYXRlQW1tZXRlciIsImFtbWV0ZXJDb25uZWN0aW9uIiwiZ2V0Q3VycmVudCIsInNldENvbm5lY3Rpb25BbmRDdXJyZW50IiwiY2lyY3VpdCIsImNpcmN1aXRDaGFuZ2VkRW1pdHRlciIsImFkZExpc3RlbmVyIiwidG91Y2hBcmVhIiwiYm91bmRzIiwiY29weSIsIm1vdXNlQXJlYSIsImFkZExpbmtlZEVsZW1lbnQiLCJzdGFydERyYWciLCJldmVudCIsInByZXNzIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJBbW1ldGVyTm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUaGUgdXNlciBpbnRlcmZhY2UgY29tcG9uZW50IHdpdGggYSBzaW5nbGUgcHJvYmUgd2hpY2ggcmVhZHMgY3VycmVudCB2YWx1ZXMgZnJvbSBXaXJlcyAobm90IGZyb20gVmVydGV4IG9yXHJcbiAqIEZpeGVkQ2lyY3VpdEVsZW1lbnQgaW5zdGFuY2VzKS4gRXhpc3RzIGZvciB0aGUgbGlmZSBvZiB0aGUgc2ltIGFuZCBoZW5jZSBkb2VzIG5vdCByZXF1aXJlIGEgZGlzcG9zZSBpbXBsZW1lbnRhdGlvbi5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFZlY3RvcjJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9kb3QvanMvVmVjdG9yMlByb3BlcnR5LmpzJztcclxuaW1wb3J0IFByb2JlTm9kZSBmcm9tICcuLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUHJvYmVOb2RlLmpzJztcclxuaW1wb3J0IFdpcmVOb2RlIGZyb20gJy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9XaXJlTm9kZS5qcyc7XHJcbmltcG9ydCB7IENvbG9yLCBEcmFnTGlzdGVuZXIsIEltYWdlLCBOb2RlLCBOb2RlT3B0aW9ucywgUmVjdGFuZ2xlLCBUZXh0LCBQcmVzc0xpc3RlbmVyRXZlbnQgfSBmcm9tICcuLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgYW1tZXRlckJvZHlfcG5nIGZyb20gJy4uLy4uL2ltYWdlcy9hbW1ldGVyQm9keV9wbmcuanMnO1xyXG5pbXBvcnQgQ0NLQ0NvbnN0YW50cyBmcm9tICcuLi9DQ0tDQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IENDS0NVdGlscyBmcm9tICcuLi9DQ0tDVXRpbHMuanMnO1xyXG5pbXBvcnQgQ2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vblN0cmluZ3MgZnJvbSAnLi4vQ2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vblN0cmluZ3MuanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbiBmcm9tICcuLi9jaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uLmpzJztcclxuaW1wb3J0IFByb2JlVGV4dE5vZGUgZnJvbSAnLi9Qcm9iZVRleHROb2RlLmpzJztcclxuaW1wb3J0IEFtbWV0ZXIgZnJvbSAnLi4vbW9kZWwvQW1tZXRlci5qcyc7XHJcbmltcG9ydCBDaXJjdWl0Tm9kZSBmcm9tICcuL0NpcmN1aXROb2RlLmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBhbW1ldGVyUmVhZG91dFR5cGVQcm9wZXJ0eSBmcm9tICcuL2FtbWV0ZXJSZWFkb3V0VHlwZVByb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFN0cmluZ0lPIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9TdHJpbmdJTy5qcyc7XHJcblxyXG5jb25zdCBjdXJyZW50U3RyaW5nUHJvcGVydHkgPSBDaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uU3RyaW5ncy5jdXJyZW50U3RyaW5nUHJvcGVydHk7XHJcblxyXG4vLyBjb25zdGFudHNcclxuLy8gbWVhc3VyZW1lbnRzIGZvciB0aGUgY3ViaWMgY3VydmUgZm9yIHRoZSB3aXJlIG5vZGVzXHJcbmNvbnN0IEJPRFlfTEVBRF9ZID0gLTMwOyAvLyBpbiBtb2RlbD12aWV3IGNvb3JkaW5hdGVzXHJcbmNvbnN0IFBST0JFX0xFQURfWSA9IDE1OyAvLyBpbiBtb2RlbD12aWV3IGNvb3JkaW5hdGVzXHJcbmNvbnN0IEhBTkRMRV9XSURUSCA9IDUwO1xyXG5cclxuLy8gb3ZlcmFsbCBzY2FsZSBmYWN0b3IgZm9yIHRoZSBib2R5IGFuZCBwcm9iZVxyXG5jb25zdCBTQ0FMRV9GQUNUT1IgPSAwLjU7XHJcblxyXG4vLyB1bnNpZ25lZCBtZWFzdXJlbWVudHMgZm9yIHRoZSBjaXJjbGVzIG9uIHRoZSB2b2x0bWV0ZXIgYm9keSBpbWFnZSwgZm9yIHdoZXJlIHRoZSBwcm9iZSB3aXJlcyBjb25uZWN0XHJcbmNvbnN0IFBST0JFX0NPTk5FQ1RJT05fUE9JTlRfRFkgPSA4O1xyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIGlzSWNvbj86IGJvb2xlYW47XHJcbiAgdmlzaWJsZUJvdW5kc1Byb3BlcnR5PzogUHJvcGVydHk8Qm91bmRzMj4gfCBudWxsO1xyXG4gIHNob3dSZXN1bHRzUHJvcGVydHk/OiBCb29sZWFuUHJvcGVydHk7XHJcbiAgYmxhY2tCb3hTdHVkeT86IGJvb2xlYW47XHJcbiAgc2hvd1BoZXRpb0luZGV4PzogYm9vbGVhbjtcclxufTtcclxudHlwZSBBbW1ldGVyTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIE5vZGVPcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQW1tZXRlck5vZGUgZXh0ZW5kcyBOb2RlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IHByb2JlTm9kZTogUHJvYmVOb2RlO1xyXG5cclxuICAvLyB0aGUgbW9kZWwgYXNzb2NpYXRlZCB3aXRoIHRoaXMgdmlld1xyXG4gIHB1YmxpYyByZWFkb25seSBhbW1ldGVyOiBBbW1ldGVyO1xyXG5cclxuICAvLyBzbyBldmVudHMgY2FuIGJlIGZvcndhcmRlZCBmcm9tIHRoZSB0b29sYm94XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkcmFnSGFuZGxlcjogRHJhZ0xpc3RlbmVyIHwgbnVsbDtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGFtbWV0ZXJcclxuICAgKiBAcGFyYW0gY2lyY3VpdE5vZGUgLSBmb3IgZ2V0dGluZyB0aGUgY3VycmVudHMsIG9yIG51bGwgaWYgcmVuZGVyaW5nIGFuIGljb25cclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGFtbWV0ZXI6IEFtbWV0ZXIsIGNpcmN1aXROb2RlOiBDaXJjdWl0Tm9kZSB8IG51bGwsIHByb3ZpZGVkT3B0aW9ucz86IEFtbWV0ZXJOb2RlT3B0aW9ucyApIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8QW1tZXRlck5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIHRydWUgaWYgaXQgd2lsbCBiZSB1c2VkIGFzIGEgdG9vbGJveCBpY29uXHJcbiAgICAgIGlzSWNvbjogZmFsc2UsXHJcblxyXG4gICAgICAvLyBhbGxvd2FibGUgZHJhZyBib3VuZHMgaW4gdmlldyBjb29yZGluYXRlc1xyXG4gICAgICB2aXNpYmxlQm91bmRzUHJvcGVydHk6IG51bGwsXHJcblxyXG4gICAgICAvLyBGb3Igc29tZSBDQ0sgQmxhY2sgQm94IG1vZGVzLCB3aGVuIHRoZSB1c2VyIG1ha2VzIGEgY2hhbmdlLCB0aGUgcmVzdWx0cyBhcmUgaGlkZGVuXHJcbiAgICAgIHNob3dSZXN1bHRzUHJvcGVydHk6IG5ldyBCb29sZWFuUHJvcGVydHkoIHRydWUgKSxcclxuXHJcbiAgICAgIC8vIEZvciB0aGUgYmxhY2sgYm94IHN0dWR5LCB0aGVyZSBpcyBhIGRpZmZlcmVudCBjdXJyZW50IHRocmVzaG9sZCBpbiB0aGUgcmVhZG91dFxyXG4gICAgICBibGFja0JveFN0dWR5OiBmYWxzZSxcclxuXHJcbiAgICAgIHNob3dQaGV0aW9JbmRleDogZmFsc2UsXHJcblxyXG4gICAgICBwaGV0aW9WaXNpYmxlUHJvcGVydHlJbnN0cnVtZW50ZWQ6IGZhbHNlLFxyXG5cclxuICAgICAgdGFuZGVtOiBUYW5kZW0uUkVRVUlSRURcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG4gICAgY29uc3QgdGFuZGVtID0gb3B0aW9ucy50YW5kZW07XHJcblxyXG4gICAgLy8gaWYgdGhlIEFtbWV0ZXJOb2RlIGlzIGFuIGljb24sIGRvIG5vdCBpbnN0cnVtZW50IHRoZSBkZXRhaWxzIG9mIHRoZSBjaGlsZHJlblxyXG4gICAgY29uc3QgdGFuZGVtRm9yQ2hpbGRyZW4gPSBvcHRpb25zLmlzSWNvbiA/IFRhbmRlbS5PUFRfT1VUIDogdGFuZGVtO1xyXG5cclxuICAgIGNvbnN0IHdpcmVCb2R5UG9zaXRpb25Qcm9wZXJ0eSA9IG5ldyBWZWN0b3IyUHJvcGVydHkoIG5ldyBWZWN0b3IyKCAwLCAwICkgKTtcclxuICAgIGNvbnN0IHdpcmVQcm9iZVBvc2l0aW9uUHJvcGVydHkgPSBuZXcgVmVjdG9yMlByb3BlcnR5KCBuZXcgVmVjdG9yMiggMCwgMCApICk7XHJcbiAgICBjb25zdCB3aXJlTm9kZSA9IG5ldyBXaXJlTm9kZShcclxuICAgICAgd2lyZUJvZHlQb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICBuZXcgVmVjdG9yMlByb3BlcnR5KCBuZXcgVmVjdG9yMiggMCwgQk9EWV9MRUFEX1kgKSApLFxyXG4gICAgICB3aXJlUHJvYmVQb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICBuZXcgVmVjdG9yMlByb3BlcnR5KCBuZXcgVmVjdG9yMiggMCwgUFJPQkVfTEVBRF9ZICkgKSwge1xyXG4gICAgICAgIHN0cm9rZTogQ29sb3IuQkxBQ0ssXHJcbiAgICAgICAgbGluZVdpZHRoOiAzLFxyXG4gICAgICAgIHBpY2thYmxlOiBmYWxzZVxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IGN1cnJlbnRSZWFkb3V0UHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbXHJcbiAgICAgICAgYW1tZXRlci5jdXJyZW50UHJvcGVydHksXHJcbiAgICAgICAgYW1tZXRlclJlYWRvdXRUeXBlUHJvcGVydHksXHJcbiAgICAgICAgQ2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vblN0cmluZ3MuY3VycmVudFVuaXRzU3RyaW5nUHJvcGVydHlcclxuICAgICAgXSxcclxuICAgICAgY3VycmVudCA9PiBDQ0tDVXRpbHMuY3JlYXRlQ3VycmVudFJlYWRvdXQoIGN1cnJlbnQsIG9wdGlvbnMuYmxhY2tCb3hTdHVkeSApLCB7XHJcbiAgICAgICAgdGFuZGVtOiB0YW5kZW1Gb3JDaGlsZHJlbi5jcmVhdGVUYW5kZW0oICdwcm9iZVJlYWRvdXRUZXh0JyApLmNyZWF0ZVRhbmRlbSggVGV4dC5TVFJJTkdfUFJPUEVSVFlfVEFOREVNX05BTUUgKSxcclxuICAgICAgICBwaGV0aW9WYWx1ZVR5cGU6IFN0cmluZ0lPXHJcbiAgICAgIH0gKTtcclxuXHJcbiAgICBjb25zdCBwcm9iZVRleHRQcm9wZXJ0eSA9IG5ldyBEZXJpdmVkUHJvcGVydHkoIFsgY3VycmVudFN0cmluZ1Byb3BlcnR5IF0sIGN1cnJlbnRTdHJpbmcgPT5cclxuICAgICAgICBvcHRpb25zLnNob3dQaGV0aW9JbmRleCA/IGN1cnJlbnRTdHJpbmcgKyAnICcgKyBhbW1ldGVyLnBoZXRpb0luZGV4IDogY3VycmVudFN0cmluZywge1xyXG4gICAgICAgIHRhbmRlbTogdGFuZGVtRm9yQ2hpbGRyZW4uY3JlYXRlVGFuZGVtKCAncHJvYmVUaXRsZVRleHQnICkuY3JlYXRlVGFuZGVtKCBUZXh0LlNUUklOR19QUk9QRVJUWV9UQU5ERU1fTkFNRSApLFxyXG4gICAgICAgIHBoZXRpb1ZhbHVlVHlwZTogU3RyaW5nSU9cclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBwcm9iZVRleHROb2RlID0gbmV3IFByb2JlVGV4dE5vZGUoXHJcbiAgICAgIGN1cnJlbnRSZWFkb3V0UHJvcGVydHksIG9wdGlvbnMuc2hvd1Jlc3VsdHNQcm9wZXJ0eSwgcHJvYmVUZXh0UHJvcGVydHksXHJcblxyXG4gICAgICAvLyBObyBuZWVkIGZvciBhbiBleHRyYSBsZXZlbCBvZiBuZXN0aW5nIGluIHRoZSB0YW5kZW0gdHJlZSwgc2luY2UgdGhhdCBpcyBqdXN0IGFuIGltcGxlbWVudGF0aW9uIGRldGFpbFxyXG4gICAgICAvLyBhbmQgbm90IGEgZmVhdHVyZVxyXG4gICAgICB0YW5kZW1Gb3JDaGlsZHJlbiwge1xyXG4gICAgICAgIGNlbnRlclg6IGFtbWV0ZXJCb2R5X3BuZy53aWR0aCAvIDIsXHJcbiAgICAgICAgY2VudGVyWTogYW1tZXRlckJvZHlfcG5nLmhlaWdodCAvIDIgKyA3IC8vIGFkanVzdCBmb3IgdGhlIHRvcCBub3RjaCBkZXNpZ25cclxuICAgICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGJvZHlOb2RlID0gbmV3IEltYWdlKCBhbW1ldGVyQm9keV9wbmcsIHtcclxuICAgICAgc2NhbGU6IFNDQUxFX0ZBQ1RPUixcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcbiAgICAgIGNoaWxkcmVuOiBbIHByb2JlVGV4dE5vZGUgXVxyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IHByb2JlTm9kZSA9IG5ldyBQcm9iZU5vZGUoIHtcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcbiAgICAgIHNlbnNvclR5cGVGdW5jdGlvbjogUHJvYmVOb2RlLmNyb3NzaGFpcnMoKSxcclxuICAgICAgc2NhbGU6IFNDQUxFX0ZBQ1RPUixcclxuICAgICAgaGFuZGxlV2lkdGg6IEhBTkRMRV9XSURUSCxcclxuICAgICAgY29sb3I6ICcjMmMyYzJiJywgLy8gVGhlIGRhcmsgZ3JheSBib3JkZXJcclxuICAgICAgaW5uZXJSYWRpdXM6IDQzLFxyXG5cclxuICAgICAgLy8gQWRkIGEgZGVjb3JhdGlvbiBvbiB0aGUgaGFuZGxlIHRvIG1hdGNoIHRoZSBjb2xvciBzY2hlbWVcclxuICAgICAgY2hpbGRyZW46IFtcclxuICAgICAgICBuZXcgUmVjdGFuZ2xlKCAwLCA1MiwgSEFORExFX1dJRFRIICogMC43MiwgMTksIHtcclxuICAgICAgICAgIGNvcm5lclJhZGl1czogNixcclxuICAgICAgICAgIGNlbnRlclg6IDAsXHJcbiAgICAgICAgICBmaWxsOiAnI2U3OTU0NycgLy8gTWF0Y2ggdGhlIG9yYW5nZSBvZiB0aGUgYW1tZXRlciBpbWFnZVxyXG4gICAgICAgIH0gKVxyXG4gICAgICBdXHJcbiAgICB9ICk7XHJcblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggIW9wdGlvbnMuaGFzT3duUHJvcGVydHkoICdjaGlsZHJlbicgKSwgJ2NoaWxkcmVuIHdpbGwgYmUgc3VwcGxpZWQgYnkgQW1tZXRlck5vZGUnICk7XHJcblxyXG4gICAgb3B0aW9ucy5jaGlsZHJlbiA9IFsgYm9keU5vZGUsIHdpcmVOb2RlLCBwcm9iZU5vZGUgXTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMucHJvYmVOb2RlID0gcHJvYmVOb2RlO1xyXG4gICAgdGhpcy5hbW1ldGVyID0gYW1tZXRlcjtcclxuXHJcbiAgICBjb25zdCBhbGlnblByb2JlVG9Cb2R5ID0gKCkgPT4ge1xyXG4gICAgICBpZiAoIGFtbWV0ZXIuaXNEcmFnZ2luZ1Byb2Jlc1dpdGhCb2R5UHJvcGVydHkuZ2V0KCkgKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbnN0cmFpbiA9ICggcHQ6IFZlY3RvcjIgKSA9PiBvcHRpb25zLnZpc2libGVCb3VuZHNQcm9wZXJ0eSA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudmlzaWJsZUJvdW5kc1Byb3BlcnR5LnZhbHVlLmVyb2RlZCggQ0NLQ0NvbnN0YW50cy5EUkFHX0JPVU5EU19FUk9TSU9OICkuY2xvc2VzdFBvaW50VG8oIHB0ICkgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdDtcclxuXHJcbiAgICAgICAgYW1tZXRlci5wcm9iZVBvc2l0aW9uUHJvcGVydHkuc2V0KCBjb25zdHJhaW4oIGFtbWV0ZXIuYm9keVBvc2l0aW9uUHJvcGVydHkudmFsdWUucGx1c1hZKCA0MCwgLTgwICkgKSApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFdoZW4gdGhlIGJvZHkgcG9zaXRpb24gY2hhbmdlcywgdXBkYXRlIHRoZSBib2R5IG5vZGUgYW5kIHRoZSB3aXJlXHJcbiAgICBhbW1ldGVyLmJvZHlQb3NpdGlvblByb3BlcnR5LmxpbmsoIGJvZHlQb3NpdGlvbiA9PiB7XHJcbiAgICAgIGJvZHlOb2RlLmNlbnRlclRvcCA9IGJvZHlQb3NpdGlvbjtcclxuICAgICAgd2lyZUJvZHlQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gYm9keU5vZGUuY2VudGVyVG9wLnBsdXNYWSggMCwgUFJPQkVfQ09OTkVDVElPTl9QT0lOVF9EWSApO1xyXG4gICAgICBhbGlnblByb2JlVG9Cb2R5KCk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gV2hlbiB0aGUgcHJvYmUgcG9zaXRpb24gY2hhbmdlcywgdXBkYXRlIHRoZSBwcm9iZSBub2RlIGFuZCB0aGUgd2lyZVxyXG4gICAgYW1tZXRlci5wcm9iZVBvc2l0aW9uUHJvcGVydHkubGluayggcHJvYmVQb3NpdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMucHJvYmVOb2RlLmNlbnRlclRvcCA9IHByb2JlUG9zaXRpb247XHJcbiAgICAgIHdpcmVQcm9iZVBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSB0aGlzLnByb2JlTm9kZS5jZW50ZXJCb3R0b207XHJcbiAgICB9ICk7XHJcblxyXG4gICAgaWYgKCAhb3B0aW9ucy5pc0ljb24gKSB7XHJcblxyXG4gICAgICAvLyBTaG93IHRoZSBhbW1ldGVyIGluIHRoZSBwbGF5IGFyZWEgd2hlbiBkcmFnZ2VkIGZyb20gdG9vbGJveFxyXG4gICAgICBhbW1ldGVyLmlzQWN0aXZlUHJvcGVydHkubGlua0F0dHJpYnV0ZSggdGhpcywgJ3Zpc2libGUnICk7XHJcbiAgICAgIGFtbWV0ZXIuaXNBY3RpdmVQcm9wZXJ0eS5saW5rKCBhbGlnblByb2JlVG9Cb2R5ICk7XHJcblxyXG4gICAgICBjb25zdCBlcm9kZWREcmFnQm91bmRzUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIG9wdGlvbnMudmlzaWJsZUJvdW5kc1Byb3BlcnR5ISBdLCB2aXNpYmxlQm91bmRzID0+IHtcclxuICAgICAgICByZXR1cm4gdmlzaWJsZUJvdW5kcy5lcm9kZWQoIENDS0NDb25zdGFudHMuRFJBR19CT1VORFNfRVJPU0lPTiApO1xyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICBjb25zdCBwcm9iZURyYWdIYW5kbGVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICAgIHBvc2l0aW9uUHJvcGVydHk6IGFtbWV0ZXIucHJvYmVQb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICAgIHVzZVBhcmVudE9mZnNldDogdHJ1ZSxcclxuICAgICAgICB0YW5kZW06IHRhbmRlbUZvckNoaWxkcmVuLmNyZWF0ZVRhbmRlbSggJ3Byb2JlRHJhZ0hhbmRsZXInICksXHJcbiAgICAgICAgc3RhcnQ6ICgpID0+IHRoaXMubW92ZVRvRnJvbnQoKSxcclxuICAgICAgICBkcmFnQm91bmRzUHJvcGVydHk6IGVyb2RlZERyYWdCb3VuZHNQcm9wZXJ0eVxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICB0aGlzLmRyYWdIYW5kbGVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICAgIHVzZVBhcmVudE9mZnNldDogdHJ1ZSxcclxuICAgICAgICBwb3NpdGlvblByb3BlcnR5OiBhbW1ldGVyLmJvZHlQb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICAgIHRhbmRlbTogdGFuZGVtRm9yQ2hpbGRyZW4uY3JlYXRlVGFuZGVtKCAnZHJhZ0xpc3RlbmVyJyApLFxyXG4gICAgICAgIHN0YXJ0OiAoKSA9PiB0aGlzLm1vdmVUb0Zyb250KCksXHJcbiAgICAgICAgZW5kOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgIGFtbWV0ZXIuZHJvcHBlZEVtaXR0ZXIuZW1pdCggYm9keU5vZGUuZ2xvYmFsQm91bmRzICk7XHJcblxyXG4gICAgICAgICAgLy8gQWZ0ZXIgZHJvcHBpbmcgaW4gdGhlIHBsYXkgYXJlYSB0aGUgcHJvYmVzIG1vdmUgaW5kZXBlbmRlbnRseSBvZiB0aGUgYm9keVxyXG4gICAgICAgICAgYW1tZXRlci5pc0RyYWdnaW5nUHJvYmVzV2l0aEJvZHlQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLy8gYWRkcyBzdXBwb3J0IGZvciB6b29tZWQgY29vcmRpbmF0ZSBmcmFtZSwgc2VlXHJcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NpcmN1aXQtY29uc3RydWN0aW9uLWtpdC1jb21tb24vaXNzdWVzLzMwMVxyXG4gICAgICAgIHRhcmdldE5vZGU6IHRoaXMsXHJcblxyXG4gICAgICAgIGRyYWdCb3VuZHNQcm9wZXJ0eTogZXJvZGVkRHJhZ0JvdW5kc1Byb3BlcnR5XHJcbiAgICAgIH0gKTtcclxuICAgICAgYm9keU5vZGUuYWRkSW5wdXRMaXN0ZW5lciggdGhpcy5kcmFnSGFuZGxlciApO1xyXG4gICAgICBlcm9kZWREcmFnQm91bmRzUHJvcGVydHkubGluayggZXJvZGVkRHJhZ0JvdW5kcyA9PiB7XHJcbiAgICAgICAgYW1tZXRlci5ib2R5UG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IGVyb2RlZERyYWdCb3VuZHMuY2xvc2VzdFBvaW50VG8oIGFtbWV0ZXIuYm9keVBvc2l0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuICAgICAgICBhbW1ldGVyLnByb2JlUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IGVyb2RlZERyYWdCb3VuZHMuY2xvc2VzdFBvaW50VG8oIGFtbWV0ZXIucHJvYmVQb3NpdGlvblByb3BlcnR5LnZhbHVlICk7XHJcbiAgICAgIH0gKTtcclxuICAgICAgdGhpcy5wcm9iZU5vZGUuYWRkSW5wdXRMaXN0ZW5lciggcHJvYmVEcmFnSGFuZGxlciApO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIERldGVjdGlvbiBmb3IgYW1tZXRlciBwcm9iZSArIGNpcmN1aXQgaW50ZXJzZWN0aW9uIGlzIGRvbmUgaW4gdGhlIHZpZXcgc2luY2UgdmlldyBib3VuZHMgYXJlIHVzZWRcclxuICAgICAgICovXHJcbiAgICAgIGNvbnN0IHVwZGF0ZUFtbWV0ZXIgPSAoKSA9PiB7XHJcblxyXG4gICAgICAgIC8vIFNraXAgd29yayB3aGVuIGFtbWV0ZXIgaXMgbm90IG91dCwgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZS5cclxuICAgICAgICBpZiAoIGFtbWV0ZXIuaXNBY3RpdmVQcm9wZXJ0eS5nZXQoKSApIHtcclxuICAgICAgICAgIGNvbnN0IGFtbWV0ZXJDb25uZWN0aW9uID0gY2lyY3VpdE5vZGUhLmdldEN1cnJlbnQoIHRoaXMucHJvYmVOb2RlICk7XHJcbiAgICAgICAgICBhbW1ldGVyLnNldENvbm5lY3Rpb25BbmRDdXJyZW50KCBhbW1ldGVyQ29ubmVjdGlvbiApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgY2lyY3VpdE5vZGUhLmNpcmN1aXQuY2lyY3VpdENoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB1cGRhdGVBbW1ldGVyICk7XHJcbiAgICAgIGFtbWV0ZXIucHJvYmVQb3NpdGlvblByb3BlcnR5LmxpbmsoIHVwZGF0ZUFtbWV0ZXIgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICB0aGlzLmRyYWdIYW5kbGVyID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBXaGVuIHJlbmRlcmVkIGFzIGFuIGljb24sIHRoZSB0b3VjaCBhcmVhIHNob3VsZCBzcGFuIHRoZSBib3VuZHMgKG5vIGdhcHMgYmV0d2VlbiBwcm9iZXMgYW5kIGJvZHkpXHJcbiAgICBpZiAoIG9wdGlvbnMuaXNJY29uICkge1xyXG4gICAgICB0aGlzLnRvdWNoQXJlYSA9IHRoaXMuYm91bmRzLmNvcHkoKTtcclxuICAgICAgdGhpcy5tb3VzZUFyZWEgPSB0aGlzLmJvdW5kcy5jb3B5KCk7XHJcbiAgICAgIHRoaXMuY3Vyc29yID0gJ3BvaW50ZXInO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYWRkTGlua2VkRWxlbWVudCggYW1tZXRlciwge1xyXG4gICAgICB0YW5kZW06IHRhbmRlbUZvckNoaWxkcmVuLmNyZWF0ZVRhbmRlbSggJ2FtbWV0ZXInIClcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZvcndhcmQgYSBkcmFnIGZyb20gdGhlIHRvb2xib3ggdG8gdGhlIHBsYXkgYXJlYSBub2RlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGFydERyYWcoIGV2ZW50OiBQcmVzc0xpc3RlbmVyRXZlbnQgKTogdm9pZCB7XHJcbiAgICB0aGlzLmRyYWdIYW5kbGVyICYmIHRoaXMuZHJhZ0hhbmRsZXIucHJlc3MoIGV2ZW50ICk7XHJcbiAgfVxyXG59XHJcblxyXG5jaXJjdWl0Q29uc3RydWN0aW9uS2l0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