// Copyright 2016-2023, University of Colorado Boulder

/**
 * Renders a single charge. Electrons are shown as a sphere with a minus sign and conventional current is shown as an
 * arrow.  Electrons are shown when current is zero, but conventional current is not shown for zero current.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import Utils from '../../../dot/js/Utils.js';
import { Shape } from '../../../kite/js/imports.js';
import ElectronChargeNode from '../../../scenery-phet/js/ElectronChargeNode.js';
import { Node } from '../../../scenery/js/imports.js';
import Tandem from '../../../tandem/js/Tandem.js';
import circuitConstructionKitCommon from '../circuitConstructionKitCommon.js';
import Capacitor from '../model/Capacitor.js';
import ConventionalCurrentArrowNode from './ConventionalCurrentArrowNode.js';
import CapacitorCircuitElementNode from './CapacitorCircuitElementNode.js';
import CircuitElementViewType from '../model/CircuitElementViewType.js';
import Multilink from '../../../axon/js/Multilink.js';
import CCKCColors from './CCKCColors.js';

// constants
const ELECTRON_CHARGE_NODE = new ElectronChargeNode({
  // Electrons are transparent to convey they are a representation rather than physical objects
  // Workaround for https://github.com/phetsims/circuit-construction-kit-dc/issues/160
  sphereOpacity: 0.75,
  minusSignOpacity: 0.75,
  // selected so an electron will exactly fit the width of a wire
  scale: 0.78
}).rasterized({
  wrap: false
});
const INITIAL_ARROW_NODE = new ConventionalCurrentArrowNode(Tandem.OPT_OUT).rasterized({
  wrap: false
});
const arrowNode = new Node({
  children: [INITIAL_ARROW_NODE]
});
Multilink.multilink([CCKCColors.conventionalCurrentArrowFillProperty, CCKCColors.conventionalCurrentArrowStrokeProperty], (arrowFill, arrowStroke) => {
  arrowNode.children = [new ConventionalCurrentArrowNode(Tandem.OPT_OUT).rasterized({
    wrap: false
  })];
});

// Below this amperage, no conventional current will be rendered.
const CONVENTIONAL_CHARGE_THRESHOLD = 1E-6;
export default class ChargeNode extends Node {
  // the model depicted by this node

  // Identifies the images used to render this node so they can be prepopulated in the WebGL sprite sheet.
  static webglSpriteNodes = [ELECTRON_CHARGE_NODE, arrowNode];

  /**
   * @param charge - the model element
   * @param circuitNode
   */
  constructor(charge, circuitNode) {
    const child = charge.charge > 0 ? arrowNode : ELECTRON_CHARGE_NODE;
    super({
      pickable: false,
      children: [child]
    });
    charge.disposeEmitter.addListener(() => this.dispose());

    // to look up the CapacitorNode for clipping
    this.circuitNode = circuitNode;
    this.charge = charge;
    this.outsideOfBlackBoxProperty = new BooleanProperty(false);

    // Update the visibility accordingly.  A multilink will not work because the charge circuitElement changes.
    this.updateVisibleListener = this.updateVisible.bind(this);

    // When the model position changes, update the node position.
    this.updateTransformListener = () => this.updateTransform();
    charge.changedEmitter.addListener(this.updateTransformListener);
    charge.visibleProperty.link(this.updateVisibleListener);
    this.outsideOfBlackBoxProperty.link(this.updateVisibleListener);
    this.updateTransformListener();
  }

  /**
   * Dispose resources when no longer used.
   */
  dispose() {
    this.charge.changedEmitter.removeListener(this.updateTransformListener);
    this.charge.visibleProperty.unlink(this.updateVisibleListener);
    this.outsideOfBlackBoxProperty.unlink(this.updateVisibleListener);
    super.dispose();
  }

  // update the transform of the charge node
  updateTransform() {
    const charge = this.charge;
    const current = charge.circuitElement.currentProperty.get();
    if (charge.charge > 0) {
      this.translation = charge.matrix.getTranslation();
      this.rotation = charge.matrix.getRotation() + (current > 0 ? Math.PI : 0);
      const opacity = Utils.linear(0.015, CONVENTIONAL_CHARGE_THRESHOLD, 1, 0, Math.abs(charge.circuitElement.currentProperty.get()));
      const clampedOpacity = Utils.clamp(opacity, 0, 1);
      this.setOpacity(clampedOpacity);
    } else {
      // Electrons are always upside up
      this.translation = charge.matrix.getTranslation();
    }
    this.updateVisible();
    this.outsideOfBlackBoxProperty.set(!charge.circuitElement.insideTrueBlackBoxProperty.get());

    // In order to show that no actual charges transfer between the plates of a capacitor, we clip their rendering.
    if (this.charge.circuitElement instanceof Capacitor) {
      const capacitorCircuitElementNode = this.circuitNode.getCircuitElementNode(this.charge.circuitElement);
      if (capacitorCircuitElementNode instanceof CapacitorCircuitElementNode) {
        // For unknown reasons, the x and y coordinates are swapped here.  The values were determined empirically.
        let globalClipShape = null;
        const isLifelike = this.circuitNode.model.viewTypeProperty.value === CircuitElementViewType.LIFELIKE;
        if (isLifelike) {
          // For the lifelike view, we clip based on the pseudo-3d effect, so the charges come from "behind" the edge
          // of the back plate and the "in front of" center of the front plate.
          // Clip area must be synchronized with CapacitorCircuitElementNode.js
          globalClipShape = this.charge.distance < this.charge.circuitElement.chargePathLength / 2 ? capacitorCircuitElementNode.capacitorCircuitElementLifelikeNode.getTopPlateClipShapeToGlobal() :
          // close half of the capacitor, clip at plate center
          capacitorCircuitElementNode.capacitorCircuitElementLifelikeNode.getBottomPlateClipShapeToGlobal(); // latter half of the capacitor, clip at plate edge
        } else {
          // For the schematic view, we clip out the center between the plates.
          // Tuned empirically based on metrics of the schematic shape.  If this is too fragile, the above approach can be used instead.
          const localShape = this.charge.distance < this.charge.circuitElement.chargePathLength / 2 ? Shape.rect(-19.5, -50, 60, 100) :
          // latter half of the capacitor, clip when leaving the far plate.
          Shape.rect(61.5, -50, 60, 100); // close half of the capacitor, clip when entering the plate

          globalClipShape = localShape.transformed(capacitorCircuitElementNode.capacitorCircuitElementSchematicNode.getLocalToGlobalMatrix());
        }
        this.clipArea = globalClipShape.transformed(this.getGlobalToLocalMatrix());
      }
    } else {
      this.clipArea = null;
    }
  }
  updateVisible() {
    this.visible = this.charge.visibleProperty.get() && this.outsideOfBlackBoxProperty.get();
  }
}
circuitConstructionKitCommon.register('ChargeNode', ChargeNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJVdGlscyIsIlNoYXBlIiwiRWxlY3Ryb25DaGFyZ2VOb2RlIiwiTm9kZSIsIlRhbmRlbSIsImNpcmN1aXRDb25zdHJ1Y3Rpb25LaXRDb21tb24iLCJDYXBhY2l0b3IiLCJDb252ZW50aW9uYWxDdXJyZW50QXJyb3dOb2RlIiwiQ2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnROb2RlIiwiQ2lyY3VpdEVsZW1lbnRWaWV3VHlwZSIsIk11bHRpbGluayIsIkNDS0NDb2xvcnMiLCJFTEVDVFJPTl9DSEFSR0VfTk9ERSIsInNwaGVyZU9wYWNpdHkiLCJtaW51c1NpZ25PcGFjaXR5Iiwic2NhbGUiLCJyYXN0ZXJpemVkIiwid3JhcCIsIklOSVRJQUxfQVJST1dfTk9ERSIsIk9QVF9PVVQiLCJhcnJvd05vZGUiLCJjaGlsZHJlbiIsIm11bHRpbGluayIsImNvbnZlbnRpb25hbEN1cnJlbnRBcnJvd0ZpbGxQcm9wZXJ0eSIsImNvbnZlbnRpb25hbEN1cnJlbnRBcnJvd1N0cm9rZVByb3BlcnR5IiwiYXJyb3dGaWxsIiwiYXJyb3dTdHJva2UiLCJDT05WRU5USU9OQUxfQ0hBUkdFX1RIUkVTSE9MRCIsIkNoYXJnZU5vZGUiLCJ3ZWJnbFNwcml0ZU5vZGVzIiwiY29uc3RydWN0b3IiLCJjaGFyZ2UiLCJjaXJjdWl0Tm9kZSIsImNoaWxkIiwicGlja2FibGUiLCJkaXNwb3NlRW1pdHRlciIsImFkZExpc3RlbmVyIiwiZGlzcG9zZSIsIm91dHNpZGVPZkJsYWNrQm94UHJvcGVydHkiLCJ1cGRhdGVWaXNpYmxlTGlzdGVuZXIiLCJ1cGRhdGVWaXNpYmxlIiwiYmluZCIsInVwZGF0ZVRyYW5zZm9ybUxpc3RlbmVyIiwidXBkYXRlVHJhbnNmb3JtIiwiY2hhbmdlZEVtaXR0ZXIiLCJ2aXNpYmxlUHJvcGVydHkiLCJsaW5rIiwicmVtb3ZlTGlzdGVuZXIiLCJ1bmxpbmsiLCJjdXJyZW50IiwiY2lyY3VpdEVsZW1lbnQiLCJjdXJyZW50UHJvcGVydHkiLCJnZXQiLCJ0cmFuc2xhdGlvbiIsIm1hdHJpeCIsImdldFRyYW5zbGF0aW9uIiwicm90YXRpb24iLCJnZXRSb3RhdGlvbiIsIk1hdGgiLCJQSSIsIm9wYWNpdHkiLCJsaW5lYXIiLCJhYnMiLCJjbGFtcGVkT3BhY2l0eSIsImNsYW1wIiwic2V0T3BhY2l0eSIsInNldCIsImluc2lkZVRydWVCbGFja0JveFByb3BlcnR5IiwiY2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnROb2RlIiwiZ2V0Q2lyY3VpdEVsZW1lbnROb2RlIiwiZ2xvYmFsQ2xpcFNoYXBlIiwiaXNMaWZlbGlrZSIsIm1vZGVsIiwidmlld1R5cGVQcm9wZXJ0eSIsInZhbHVlIiwiTElGRUxJS0UiLCJkaXN0YW5jZSIsImNoYXJnZVBhdGhMZW5ndGgiLCJjYXBhY2l0b3JDaXJjdWl0RWxlbWVudExpZmVsaWtlTm9kZSIsImdldFRvcFBsYXRlQ2xpcFNoYXBlVG9HbG9iYWwiLCJnZXRCb3R0b21QbGF0ZUNsaXBTaGFwZVRvR2xvYmFsIiwibG9jYWxTaGFwZSIsInJlY3QiLCJ0cmFuc2Zvcm1lZCIsImNhcGFjaXRvckNpcmN1aXRFbGVtZW50U2NoZW1hdGljTm9kZSIsImdldExvY2FsVG9HbG9iYWxNYXRyaXgiLCJjbGlwQXJlYSIsImdldEdsb2JhbFRvTG9jYWxNYXRyaXgiLCJ2aXNpYmxlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDaGFyZ2VOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFJlbmRlcnMgYSBzaW5nbGUgY2hhcmdlLiBFbGVjdHJvbnMgYXJlIHNob3duIGFzIGEgc3BoZXJlIHdpdGggYSBtaW51cyBzaWduIGFuZCBjb252ZW50aW9uYWwgY3VycmVudCBpcyBzaG93biBhcyBhblxyXG4gKiBhcnJvdy4gIEVsZWN0cm9ucyBhcmUgc2hvd24gd2hlbiBjdXJyZW50IGlzIHplcm8sIGJ1dCBjb252ZW50aW9uYWwgY3VycmVudCBpcyBub3Qgc2hvd24gZm9yIHplcm8gY3VycmVudC5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IEVsZWN0cm9uQ2hhcmdlTm9kZSBmcm9tICcuLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvRWxlY3Ryb25DaGFyZ2VOb2RlLmpzJztcclxuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCBjaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uIGZyb20gJy4uL2NpcmN1aXRDb25zdHJ1Y3Rpb25LaXRDb21tb24uanMnO1xyXG5pbXBvcnQgQ2FwYWNpdG9yIGZyb20gJy4uL21vZGVsL0NhcGFjaXRvci5qcyc7XHJcbmltcG9ydCBDaGFyZ2UgZnJvbSAnLi4vbW9kZWwvQ2hhcmdlLmpzJztcclxuaW1wb3J0IENpcmN1aXROb2RlIGZyb20gJy4vQ2lyY3VpdE5vZGUuanMnO1xyXG5pbXBvcnQgQ29udmVudGlvbmFsQ3VycmVudEFycm93Tm9kZSBmcm9tICcuL0NvbnZlbnRpb25hbEN1cnJlbnRBcnJvd05vZGUuanMnO1xyXG5pbXBvcnQgQ2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnROb2RlIGZyb20gJy4vQ2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnROb2RlLmpzJztcclxuaW1wb3J0IENpcmN1aXRFbGVtZW50Vmlld1R5cGUgZnJvbSAnLi4vbW9kZWwvQ2lyY3VpdEVsZW1lbnRWaWV3VHlwZS5qcyc7XHJcbmltcG9ydCBNdWx0aWxpbmsgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9NdWx0aWxpbmsuanMnO1xyXG5pbXBvcnQgQ0NLQ0NvbG9ycyBmcm9tICcuL0NDS0NDb2xvcnMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEVMRUNUUk9OX0NIQVJHRV9OT0RFID0gbmV3IEVsZWN0cm9uQ2hhcmdlTm9kZSgge1xyXG5cclxuICAvLyBFbGVjdHJvbnMgYXJlIHRyYW5zcGFyZW50IHRvIGNvbnZleSB0aGV5IGFyZSBhIHJlcHJlc2VudGF0aW9uIHJhdGhlciB0aGFuIHBoeXNpY2FsIG9iamVjdHNcclxuICAvLyBXb3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2lyY3VpdC1jb25zdHJ1Y3Rpb24ta2l0LWRjL2lzc3Vlcy8xNjBcclxuICBzcGhlcmVPcGFjaXR5OiAwLjc1LFxyXG4gIG1pbnVzU2lnbk9wYWNpdHk6IDAuNzUsXHJcblxyXG4gIC8vIHNlbGVjdGVkIHNvIGFuIGVsZWN0cm9uIHdpbGwgZXhhY3RseSBmaXQgdGhlIHdpZHRoIG9mIGEgd2lyZVxyXG4gIHNjYWxlOiAwLjc4XHJcbn0gKS5yYXN0ZXJpemVkKCB7IHdyYXA6IGZhbHNlIH0gKTtcclxuXHJcbmNvbnN0IElOSVRJQUxfQVJST1dfTk9ERSA9IG5ldyBDb252ZW50aW9uYWxDdXJyZW50QXJyb3dOb2RlKCBUYW5kZW0uT1BUX09VVCApLnJhc3Rlcml6ZWQoIHsgd3JhcDogZmFsc2UgfSApO1xyXG5cclxuY29uc3QgYXJyb3dOb2RlID0gbmV3IE5vZGUoIHsgY2hpbGRyZW46IFsgSU5JVElBTF9BUlJPV19OT0RFIF0gfSApO1xyXG5cclxuTXVsdGlsaW5rLm11bHRpbGluayggWyBDQ0tDQ29sb3JzLmNvbnZlbnRpb25hbEN1cnJlbnRBcnJvd0ZpbGxQcm9wZXJ0eSwgQ0NLQ0NvbG9ycy5jb252ZW50aW9uYWxDdXJyZW50QXJyb3dTdHJva2VQcm9wZXJ0eSBdLFxyXG4gICggYXJyb3dGaWxsLCBhcnJvd1N0cm9rZSApID0+IHtcclxuICAgIGFycm93Tm9kZS5jaGlsZHJlbiA9IFsgbmV3IENvbnZlbnRpb25hbEN1cnJlbnRBcnJvd05vZGUoIFRhbmRlbS5PUFRfT1VUICkucmFzdGVyaXplZCggeyB3cmFwOiBmYWxzZSB9ICkgXTtcclxuICB9ICk7XHJcblxyXG4vLyBCZWxvdyB0aGlzIGFtcGVyYWdlLCBubyBjb252ZW50aW9uYWwgY3VycmVudCB3aWxsIGJlIHJlbmRlcmVkLlxyXG5jb25zdCBDT05WRU5USU9OQUxfQ0hBUkdFX1RIUkVTSE9MRCA9IDFFLTY7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDaGFyZ2VOb2RlIGV4dGVuZHMgTm9kZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBjaXJjdWl0Tm9kZTogQ2lyY3VpdE5vZGU7XHJcblxyXG4gIC8vIHRoZSBtb2RlbCBkZXBpY3RlZCBieSB0aGlzIG5vZGVcclxuICBwcml2YXRlIHJlYWRvbmx5IGNoYXJnZTogQ2hhcmdlO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgb3V0c2lkZU9mQmxhY2tCb3hQcm9wZXJ0eTogQm9vbGVhblByb3BlcnR5O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdXBkYXRlVmlzaWJsZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdXBkYXRlVHJhbnNmb3JtTGlzdGVuZXI6ICgpID0+IHZvaWQ7XHJcblxyXG4gIC8vIElkZW50aWZpZXMgdGhlIGltYWdlcyB1c2VkIHRvIHJlbmRlciB0aGlzIG5vZGUgc28gdGhleSBjYW4gYmUgcHJlcG9wdWxhdGVkIGluIHRoZSBXZWJHTCBzcHJpdGUgc2hlZXQuXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSB3ZWJnbFNwcml0ZU5vZGVzID0gWyBFTEVDVFJPTl9DSEFSR0VfTk9ERSwgYXJyb3dOb2RlIF07XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBjaGFyZ2UgLSB0aGUgbW9kZWwgZWxlbWVudFxyXG4gICAqIEBwYXJhbSBjaXJjdWl0Tm9kZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggY2hhcmdlOiBDaGFyZ2UsIGNpcmN1aXROb2RlOiBDaXJjdWl0Tm9kZSApIHtcclxuXHJcbiAgICBjb25zdCBjaGlsZCA9IGNoYXJnZS5jaGFyZ2UgPiAwID8gYXJyb3dOb2RlIDogRUxFQ1RST05fQ0hBUkdFX05PREU7XHJcblxyXG4gICAgc3VwZXIoIHtcclxuICAgICAgcGlja2FibGU6IGZhbHNlLFxyXG4gICAgICBjaGlsZHJlbjogWyBjaGlsZCBdXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY2hhcmdlLmRpc3Bvc2VFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB0aGlzLmRpc3Bvc2UoKSApO1xyXG5cclxuICAgIC8vIHRvIGxvb2sgdXAgdGhlIENhcGFjaXRvck5vZGUgZm9yIGNsaXBwaW5nXHJcbiAgICB0aGlzLmNpcmN1aXROb2RlID0gY2lyY3VpdE5vZGU7XHJcblxyXG4gICAgdGhpcy5jaGFyZ2UgPSBjaGFyZ2U7XHJcblxyXG4gICAgdGhpcy5vdXRzaWRlT2ZCbGFja0JveFByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHZpc2liaWxpdHkgYWNjb3JkaW5nbHkuICBBIG11bHRpbGluayB3aWxsIG5vdCB3b3JrIGJlY2F1c2UgdGhlIGNoYXJnZSBjaXJjdWl0RWxlbWVudCBjaGFuZ2VzLlxyXG4gICAgdGhpcy51cGRhdGVWaXNpYmxlTGlzdGVuZXIgPSB0aGlzLnVwZGF0ZVZpc2libGUuYmluZCggdGhpcyApO1xyXG5cclxuICAgIC8vIFdoZW4gdGhlIG1vZGVsIHBvc2l0aW9uIGNoYW5nZXMsIHVwZGF0ZSB0aGUgbm9kZSBwb3NpdGlvbi5cclxuICAgIHRoaXMudXBkYXRlVHJhbnNmb3JtTGlzdGVuZXIgPSAoKSA9PiB0aGlzLnVwZGF0ZVRyYW5zZm9ybSgpO1xyXG4gICAgY2hhcmdlLmNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLnVwZGF0ZVRyYW5zZm9ybUxpc3RlbmVyICk7XHJcbiAgICBjaGFyZ2UudmlzaWJsZVByb3BlcnR5LmxpbmsoIHRoaXMudXBkYXRlVmlzaWJsZUxpc3RlbmVyICk7XHJcbiAgICB0aGlzLm91dHNpZGVPZkJsYWNrQm94UHJvcGVydHkubGluayggdGhpcy51cGRhdGVWaXNpYmxlTGlzdGVuZXIgKTtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZVRyYW5zZm9ybUxpc3RlbmVyKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEaXNwb3NlIHJlc291cmNlcyB3aGVuIG5vIGxvbmdlciB1c2VkLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jaGFyZ2UuY2hhbmdlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMudXBkYXRlVHJhbnNmb3JtTGlzdGVuZXIgKTtcclxuICAgIHRoaXMuY2hhcmdlLnZpc2libGVQcm9wZXJ0eS51bmxpbmsoIHRoaXMudXBkYXRlVmlzaWJsZUxpc3RlbmVyICk7XHJcbiAgICB0aGlzLm91dHNpZGVPZkJsYWNrQm94UHJvcGVydHkudW5saW5rKCB0aGlzLnVwZGF0ZVZpc2libGVMaXN0ZW5lciApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLy8gdXBkYXRlIHRoZSB0cmFuc2Zvcm0gb2YgdGhlIGNoYXJnZSBub2RlXHJcbiAgcHJpdmF0ZSB1cGRhdGVUcmFuc2Zvcm0oKTogdm9pZCB7XHJcbiAgICBjb25zdCBjaGFyZ2UgPSB0aGlzLmNoYXJnZTtcclxuICAgIGNvbnN0IGN1cnJlbnQgPSBjaGFyZ2UuY2lyY3VpdEVsZW1lbnQuY3VycmVudFByb3BlcnR5LmdldCgpO1xyXG5cclxuICAgIGlmICggY2hhcmdlLmNoYXJnZSA+IDAgKSB7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBjaGFyZ2UubWF0cml4LmdldFRyYW5zbGF0aW9uKCk7XHJcbiAgICAgIHRoaXMucm90YXRpb24gPSBjaGFyZ2UubWF0cml4LmdldFJvdGF0aW9uKCkgKyAoIGN1cnJlbnQgPiAwID8gTWF0aC5QSSA6IDAgKTtcclxuXHJcbiAgICAgIGNvbnN0IG9wYWNpdHkgPSBVdGlscy5saW5lYXIoIDAuMDE1LCBDT05WRU5USU9OQUxfQ0hBUkdFX1RIUkVTSE9MRCwgMSwgMCwgTWF0aC5hYnMoIGNoYXJnZS5jaXJjdWl0RWxlbWVudC5jdXJyZW50UHJvcGVydHkuZ2V0KCkgKSApO1xyXG4gICAgICBjb25zdCBjbGFtcGVkT3BhY2l0eSA9IFV0aWxzLmNsYW1wKCBvcGFjaXR5LCAwLCAxICk7XHJcbiAgICAgIHRoaXMuc2V0T3BhY2l0eSggY2xhbXBlZE9wYWNpdHkgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG5cclxuICAgICAgLy8gRWxlY3Ryb25zIGFyZSBhbHdheXMgdXBzaWRlIHVwXHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBjaGFyZ2UubWF0cml4LmdldFRyYW5zbGF0aW9uKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnVwZGF0ZVZpc2libGUoKTtcclxuICAgIHRoaXMub3V0c2lkZU9mQmxhY2tCb3hQcm9wZXJ0eS5zZXQoICFjaGFyZ2UuY2lyY3VpdEVsZW1lbnQuaW5zaWRlVHJ1ZUJsYWNrQm94UHJvcGVydHkuZ2V0KCkgKTtcclxuXHJcbiAgICAvLyBJbiBvcmRlciB0byBzaG93IHRoYXQgbm8gYWN0dWFsIGNoYXJnZXMgdHJhbnNmZXIgYmV0d2VlbiB0aGUgcGxhdGVzIG9mIGEgY2FwYWNpdG9yLCB3ZSBjbGlwIHRoZWlyIHJlbmRlcmluZy5cclxuICAgIGlmICggdGhpcy5jaGFyZ2UuY2lyY3VpdEVsZW1lbnQgaW5zdGFuY2VvZiBDYXBhY2l0b3IgKSB7XHJcbiAgICAgIGNvbnN0IGNhcGFjaXRvckNpcmN1aXRFbGVtZW50Tm9kZSA9IHRoaXMuY2lyY3VpdE5vZGUuZ2V0Q2lyY3VpdEVsZW1lbnROb2RlKCB0aGlzLmNoYXJnZS5jaXJjdWl0RWxlbWVudCApO1xyXG4gICAgICBpZiAoIGNhcGFjaXRvckNpcmN1aXRFbGVtZW50Tm9kZSBpbnN0YW5jZW9mIENhcGFjaXRvckNpcmN1aXRFbGVtZW50Tm9kZSApIHtcclxuXHJcbiAgICAgICAgLy8gRm9yIHVua25vd24gcmVhc29ucywgdGhlIHggYW5kIHkgY29vcmRpbmF0ZXMgYXJlIHN3YXBwZWQgaGVyZS4gIFRoZSB2YWx1ZXMgd2VyZSBkZXRlcm1pbmVkIGVtcGlyaWNhbGx5LlxyXG4gICAgICAgIGxldCBnbG9iYWxDbGlwU2hhcGUgPSBudWxsO1xyXG5cclxuICAgICAgICBjb25zdCBpc0xpZmVsaWtlID0gdGhpcy5jaXJjdWl0Tm9kZS5tb2RlbC52aWV3VHlwZVByb3BlcnR5LnZhbHVlID09PSBDaXJjdWl0RWxlbWVudFZpZXdUeXBlLkxJRkVMSUtFO1xyXG4gICAgICAgIGlmICggaXNMaWZlbGlrZSApIHtcclxuXHJcbiAgICAgICAgICAvLyBGb3IgdGhlIGxpZmVsaWtlIHZpZXcsIHdlIGNsaXAgYmFzZWQgb24gdGhlIHBzZXVkby0zZCBlZmZlY3QsIHNvIHRoZSBjaGFyZ2VzIGNvbWUgZnJvbSBcImJlaGluZFwiIHRoZSBlZGdlXHJcbiAgICAgICAgICAvLyBvZiB0aGUgYmFjayBwbGF0ZSBhbmQgdGhlIFwiaW4gZnJvbnQgb2ZcIiBjZW50ZXIgb2YgdGhlIGZyb250IHBsYXRlLlxyXG4gICAgICAgICAgLy8gQ2xpcCBhcmVhIG11c3QgYmUgc3luY2hyb25pemVkIHdpdGggQ2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnROb2RlLmpzXHJcbiAgICAgICAgICBnbG9iYWxDbGlwU2hhcGUgPSB0aGlzLmNoYXJnZS5kaXN0YW5jZSA8IHRoaXMuY2hhcmdlLmNpcmN1aXRFbGVtZW50LmNoYXJnZVBhdGhMZW5ndGggLyAyID9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcGFjaXRvckNpcmN1aXRFbGVtZW50Tm9kZS5jYXBhY2l0b3JDaXJjdWl0RWxlbWVudExpZmVsaWtlTm9kZS5nZXRUb3BQbGF0ZUNsaXBTaGFwZVRvR2xvYmFsKCkgOiAvLyBjbG9zZSBoYWxmIG9mIHRoZSBjYXBhY2l0b3IsIGNsaXAgYXQgcGxhdGUgY2VudGVyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXBhY2l0b3JDaXJjdWl0RWxlbWVudE5vZGUuY2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnRMaWZlbGlrZU5vZGUuZ2V0Qm90dG9tUGxhdGVDbGlwU2hhcGVUb0dsb2JhbCgpOyAvLyBsYXR0ZXIgaGFsZiBvZiB0aGUgY2FwYWNpdG9yLCBjbGlwIGF0IHBsYXRlIGVkZ2VcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgICAgLy8gRm9yIHRoZSBzY2hlbWF0aWMgdmlldywgd2UgY2xpcCBvdXQgdGhlIGNlbnRlciBiZXR3ZWVuIHRoZSBwbGF0ZXMuXHJcbiAgICAgICAgICAvLyBUdW5lZCBlbXBpcmljYWxseSBiYXNlZCBvbiBtZXRyaWNzIG9mIHRoZSBzY2hlbWF0aWMgc2hhcGUuICBJZiB0aGlzIGlzIHRvbyBmcmFnaWxlLCB0aGUgYWJvdmUgYXBwcm9hY2ggY2FuIGJlIHVzZWQgaW5zdGVhZC5cclxuICAgICAgICAgIGNvbnN0IGxvY2FsU2hhcGUgPSB0aGlzLmNoYXJnZS5kaXN0YW5jZSA8IHRoaXMuY2hhcmdlLmNpcmN1aXRFbGVtZW50LmNoYXJnZVBhdGhMZW5ndGggLyAyID9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTaGFwZS5yZWN0KCAtMTkuNSwgLTUwLCA2MCwgMTAwICkgOiAvLyBsYXR0ZXIgaGFsZiBvZiB0aGUgY2FwYWNpdG9yLCBjbGlwIHdoZW4gbGVhdmluZyB0aGUgZmFyIHBsYXRlLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNoYXBlLnJlY3QoIDYxLjUsIC01MCwgNjAsIDEwMCApOyAvLyBjbG9zZSBoYWxmIG9mIHRoZSBjYXBhY2l0b3IsIGNsaXAgd2hlbiBlbnRlcmluZyB0aGUgcGxhdGVcclxuXHJcbiAgICAgICAgICBnbG9iYWxDbGlwU2hhcGUgPSBsb2NhbFNoYXBlLnRyYW5zZm9ybWVkKCBjYXBhY2l0b3JDaXJjdWl0RWxlbWVudE5vZGUuY2FwYWNpdG9yQ2lyY3VpdEVsZW1lbnRTY2hlbWF0aWNOb2RlLmdldExvY2FsVG9HbG9iYWxNYXRyaXgoKSApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5jbGlwQXJlYSA9IGdsb2JhbENsaXBTaGFwZS50cmFuc2Zvcm1lZCggdGhpcy5nZXRHbG9iYWxUb0xvY2FsTWF0cml4KCkgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMuY2xpcEFyZWEgPSBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVWaXNpYmxlKCk6IHZvaWQge1xyXG4gICAgdGhpcy52aXNpYmxlID0gdGhpcy5jaGFyZ2UudmlzaWJsZVByb3BlcnR5LmdldCgpICYmXHJcbiAgICAgICAgICAgICAgICAgICB0aGlzLm91dHNpZGVPZkJsYWNrQm94UHJvcGVydHkuZ2V0KCk7XHJcbiAgfVxyXG59XHJcblxyXG5jaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uLnJlZ2lzdGVyKCAnQ2hhcmdlTm9kZScsIENoYXJnZU5vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxlQUFlLE1BQU0scUNBQXFDO0FBQ2pFLE9BQU9DLEtBQUssTUFBTSwwQkFBMEI7QUFDNUMsU0FBU0MsS0FBSyxRQUFRLDZCQUE2QjtBQUNuRCxPQUFPQyxrQkFBa0IsTUFBTSxnREFBZ0Q7QUFDL0UsU0FBU0MsSUFBSSxRQUFRLGdDQUFnQztBQUNyRCxPQUFPQyxNQUFNLE1BQU0sOEJBQThCO0FBQ2pELE9BQU9DLDRCQUE0QixNQUFNLG9DQUFvQztBQUM3RSxPQUFPQyxTQUFTLE1BQU0sdUJBQXVCO0FBRzdDLE9BQU9DLDRC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