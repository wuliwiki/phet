// Copyright 2017-2023, University of Colorado Boulder

/**
 * An icon in the circuit element toolbox/carousel that can be used to create circuit elements. Exists for the life of
 * the sim and hence does not require a dispose implementation.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import { DragListener, Grayscale, Text, VBox } from '../../../scenery/js/imports.js';
import CCKCConstants from '../CCKCConstants.js';
import circuitConstructionKitCommon from '../circuitConstructionKitCommon.js';
import Multilink from '../../../axon/js/Multilink.js';
import optionize from '../../../phet-core/js/optionize.js';
import CCKCColors from './CCKCColors.js';

// constants
const TOOLBOX_ICON_WIDTH = CCKCConstants.TOOLBOX_ICON_WIDTH;
export default class CircuitElementToolNode extends VBox {
  /**
   * @param labelStringProperty
   * @param showLabelsProperty
   * @param viewTypeProperty
   * @param circuit
   * @param globalToCircuitNodePoint Vector2=>Vector2 global point to coordinate frame of circuitNode
   * @param iconNode
   * @param maxNumber
   * @param count - () => number, gets the number of that kind of object in the model, so the icon can be
   *                         - hidden when all items have been created
   * @param createElement - (Vector2) => CircuitElement Function that creates a CircuitElement at the given position
   *                                 - for most components it is the center of the component.  For Light Bulbs, it is
   *                                 - in the center of the socket
   * @param [providedOptions]
   */
  constructor(labelStringProperty, showLabelsProperty, viewTypeProperty, circuit, globalToCircuitNodePoint, iconNode, maxNumber, count, createElement, providedOptions) {
    let labelText = null;
    if (labelStringProperty.value.length > 0 && providedOptions && providedOptions.tandem) {
      labelText = new Text(labelStringProperty, {
        fontSize: 12,
        maxWidth: TOOLBOX_ICON_WIDTH,
        fill: CCKCColors.textFillProperty,
        tandem: providedOptions.tandem.createTandem('labelText'),
        visiblePropertyOptions: {
          phetioReadOnly: true
        }
      });
      delete providedOptions.tandem;
      showLabelsProperty.linkAttribute(labelText, 'visible');
    }
    const options = optionize()({
      spacing: 2,
      // Spacing between the icon and the text
      cursor: 'pointer',
      // hack because the series ammeter tool node has text rendered separately (joined with probe ammeter)
      children: labelText ? [iconNode, labelText] : [iconNode],
      // Expand touch area around text, see https://github.com/phetsims/circuit-construction-kit-dc/issues/82
      touchAreaExpansionLeft: 0,
      touchAreaExpansionTop: 0,
      touchAreaExpansionRight: 0,
      touchAreaExpansionBottom: 0,
      excludeInvisibleChildrenFromBounds: false,
      additionalProperty: new BooleanProperty(true),
      ghostOpacity: 0.4
    }, providedOptions);
    super(options);
    this.addInputListener(DragListener.createForwardingListener(event => {
      // initial position of the pointer in the coordinate frame of the CircuitNode
      const v = event.pointer.point;
      const viewPosition = globalToCircuitNodePoint(v);

      // Adjust for touch.  The object should appear centered on the mouse but vertically above the finger so the finger
      // doesn't obscure the object
      viewPosition.y = viewPosition.y - (event.pointer.isTouchLike() ? 28 : 0);

      // Create the new CircuitElement at the correct position
      const circuitElement = createElement(viewPosition);

      // Add the CircuitElement to the Circuit
      circuit.circuitElements.add(circuitElement);

      // Send the start drag event through so the new element will begin dragging.
      circuitElement.startDragEmitter.emit(event);
    }, {
      allowTouchSnag: true
    }));

    // Make the tool icon visible if we can create more of the item. But be careful to only update visibility when
    // the specific count for this item changes, so we can support PhET-iO hiding the icons via visibility.
    let lastCount = null;
    let lastValue = null;
    Multilink.multilink([circuit.circuitElements.lengthProperty, options.additionalProperty], (length, existsAtAll) => {
      const currentCount = count();
      if (lastCount !== currentCount || lastValue !== existsAtAll) {
        // Gray out circuit elements that cannot be dragged out
        const hasMoreAvailable = currentCount < maxNumber;
        this.setOpacity(hasMoreAvailable ? 1 : options.ghostOpacity);
        this.filters = hasMoreAvailable ? [] : [Grayscale.FULL];
        this.inputEnabled = hasMoreAvailable;

        // For the non-ohmic real bulb, when it is not selected in the advanced control panel, the icon should not appear at all
        this.visible = existsAtAll;
      }
      lastCount = currentCount;
      lastValue = existsAtAll;
    });

    // Update touch areas when lifelike/schematic changes
    const updatePointerAreas = () => {
      // Expand touch area around text, see https://github.com/phetsims/circuit-construction-kit-dc/issues/82
      this.touchArea = this.localBounds.withOffsets(options.touchAreaExpansionLeft, options.touchAreaExpansionTop, options.touchAreaExpansionRight, options.touchAreaExpansionBottom);
      this.mouseArea = this.touchArea;
    };
    viewTypeProperty.link(updatePointerAreas);
    this.localBoundsProperty.link(updatePointerAreas);
  }
}
circuitConstructionKitCommon.register('CircuitElementToolNode', CircuitElementToolNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJEcmFnTGlzdGVuZXIiLCJHcmF5c2NhbGUiLCJUZXh0IiwiVkJveCIsIkNDS0NDb25zdGFudHMiLCJjaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uIiwiTXVsdGlsaW5rIiwib3B0aW9uaXplIiwiQ0NLQ0NvbG9ycyIsIlRPT0xCT1hfSUNPTl9XSURUSCIsIkNpcmN1aXRFbGVtZW50VG9vbE5vZGUiLCJjb25zdHJ1Y3RvciIsImxhYmVsU3RyaW5nUHJvcGVydHkiLCJzaG93TGFiZWxzUHJvcGVydHkiLCJ2aWV3VHlwZVByb3BlcnR5IiwiY2lyY3VpdCIsImdsb2JhbFRvQ2lyY3VpdE5vZGVQb2ludCIsImljb25Ob2RlIiwibWF4TnVtYmVyIiwiY291bnQiLCJjcmVhdGVFbGVtZW50IiwicHJvdmlkZWRPcHRpb25zIiwibGFiZWxUZXh0IiwidmFsdWUiLCJsZW5ndGgiLCJ0YW5kZW0iLCJmb250U2l6ZSIsIm1heFdpZHRoIiwiZmlsbCIsInRleHRGaWxsUHJvcGVydHkiLCJjcmVhdGVUYW5kZW0iLCJ2aXNpYmxlUHJvcGVydHlPcHRpb25zIiwicGhldGlvUmVhZE9ubHkiLCJsaW5rQXR0cmlidXRlIiwib3B0aW9ucyIsInNwYWNpbmciLCJjdXJzb3IiLCJjaGlsZHJlbiIsInRvdWNoQXJlYUV4cGFuc2lvbkxlZnQiLCJ0b3VjaEFyZWFFeHBhbnNpb25Ub3AiLCJ0b3VjaEFyZWFFeHBhbnNpb25SaWdodCIsInRvdWNoQXJlYUV4cGFuc2lvbkJvdHRvbSIsImV4Y2x1ZGVJbnZpc2libGVDaGlsZHJlbkZyb21Cb3VuZHMiLCJhZGRpdGlvbmFsUHJvcGVydHkiLCJnaG9zdE9wYWNpdHkiLCJhZGRJbnB1dExpc3RlbmVyIiwiY3JlYXRlRm9yd2FyZGluZ0xpc3RlbmVyIiwiZXZlbnQiLCJ2IiwicG9pbnRlciIsInBvaW50Iiwidmlld1Bvc2l0aW9uIiwieSIsImlzVG91Y2hMaWtlIiwiY2lyY3VpdEVsZW1lbnQiLCJjaXJjdWl0RWxlbWVudHMiLCJhZGQiLCJzdGFydERyYWdFbWl0dGVyIiwiZW1pdCIsImFsbG93VG91Y2hTbmFnIiwibGFzdENvdW50IiwibGFzdFZhbHVlIiwibXVsdGlsaW5rIiwibGVuZ3RoUHJvcGVydHkiLCJleGlzdHNBdEFsbCIsImN1cnJlbnRDb3VudCIsImhhc01vcmVBdmFpbGFibGUiLCJzZXRPcGFjaXR5IiwiZmlsdGVycyIsIkZVTEwiLCJpbnB1dEVuYWJsZWQiLCJ2aXNpYmxlIiwidXBkYXRlUG9pbnRlckFyZWFzIiwidG91Y2hBcmVhIiwibG9jYWxCb3VuZHMiLCJ3aXRoT2Zmc2V0cyIsIm1vdXNlQXJlYSIsImxpbmsiLCJsb2NhbEJvdW5kc1Byb3BlcnR5IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJDaXJjdWl0RWxlbWVudFRvb2xOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEFuIGljb24gaW4gdGhlIGNpcmN1aXQgZWxlbWVudCB0b29sYm94L2Nhcm91c2VsIHRoYXQgY2FuIGJlIHVzZWQgdG8gY3JlYXRlIGNpcmN1aXQgZWxlbWVudHMuIEV4aXN0cyBmb3IgdGhlIGxpZmUgb2ZcclxuICogdGhlIHNpbSBhbmQgaGVuY2UgZG9lcyBub3QgcmVxdWlyZSBhIGRpc3Bvc2UgaW1wbGVtZW50YXRpb24uXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9SZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBEcmFnTGlzdGVuZXIsIEdyYXlzY2FsZSwgTm9kZSwgUHJlc3NMaXN0ZW5lckV2ZW50LCBUZXh0LCBWQm94LCBWQm94T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBDQ0tDQ29uc3RhbnRzIGZyb20gJy4uL0NDS0NDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbiBmcm9tICcuLi9jaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uLmpzJztcclxuaW1wb3J0IENpcmN1aXQgZnJvbSAnLi4vbW9kZWwvQ2lyY3VpdC5qcyc7XHJcbmltcG9ydCBDaXJjdWl0RWxlbWVudCBmcm9tICcuLi9tb2RlbC9DaXJjdWl0RWxlbWVudC5qcyc7XHJcbmltcG9ydCBDaXJjdWl0RWxlbWVudFZpZXdUeXBlIGZyb20gJy4uL21vZGVsL0NpcmN1aXRFbGVtZW50Vmlld1R5cGUuanMnO1xyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFRSZWFkT25seVByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvVFJlYWRPbmx5UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQ0NLQ0NvbG9ycyBmcm9tICcuL0NDS0NDb2xvcnMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFRPT0xCT1hfSUNPTl9XSURUSCA9IENDS0NDb25zdGFudHMuVE9PTEJPWF9JQ09OX1dJRFRIO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICB0b3VjaEFyZWFFeHBhbnNpb25MZWZ0PzogbnVtYmVyO1xyXG4gIHRvdWNoQXJlYUV4cGFuc2lvblRvcD86IG51bWJlcjtcclxuICB0b3VjaEFyZWFFeHBhbnNpb25SaWdodD86IG51bWJlcjtcclxuICB0b3VjaEFyZWFFeHBhbnNpb25Cb3R0b20/OiBudW1iZXI7XHJcblxyXG4gIGFkZGl0aW9uYWxQcm9wZXJ0eT86IFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcbiAgZ2hvc3RPcGFjaXR5PzogbnVtYmVyO1xyXG59O1xyXG5leHBvcnQgdHlwZSBDaXJjdWl0RWxlbWVudFRvb2xOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgVkJveE9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDaXJjdWl0RWxlbWVudFRvb2xOb2RlIGV4dGVuZHMgVkJveCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBsYWJlbFN0cmluZ1Byb3BlcnR5XHJcbiAgICogQHBhcmFtIHNob3dMYWJlbHNQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSB2aWV3VHlwZVByb3BlcnR5XHJcbiAgICogQHBhcmFtIGNpcmN1aXRcclxuICAgKiBAcGFyYW0gZ2xvYmFsVG9DaXJjdWl0Tm9kZVBvaW50IFZlY3RvcjI9PlZlY3RvcjIgZ2xvYmFsIHBvaW50IHRvIGNvb3JkaW5hdGUgZnJhbWUgb2YgY2lyY3VpdE5vZGVcclxuICAgKiBAcGFyYW0gaWNvbk5vZGVcclxuICAgKiBAcGFyYW0gbWF4TnVtYmVyXHJcbiAgICogQHBhcmFtIGNvdW50IC0gKCkgPT4gbnVtYmVyLCBnZXRzIHRoZSBudW1iZXIgb2YgdGhhdCBraW5kIG9mIG9iamVjdCBpbiB0aGUgbW9kZWwsIHNvIHRoZSBpY29uIGNhbiBiZVxyXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgIC0gaGlkZGVuIHdoZW4gYWxsIGl0ZW1zIGhhdmUgYmVlbiBjcmVhdGVkXHJcbiAgICogQHBhcmFtIGNyZWF0ZUVsZW1lbnQgLSAoVmVjdG9yMikgPT4gQ2lyY3VpdEVsZW1lbnQgRnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgQ2lyY3VpdEVsZW1lbnQgYXQgdGhlIGdpdmVuIHBvc2l0aW9uXHJcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtIGZvciBtb3N0IGNvbXBvbmVudHMgaXQgaXMgdGhlIGNlbnRlciBvZiB0aGUgY29tcG9uZW50LiAgRm9yIExpZ2h0IEJ1bGJzLCBpdCBpc1xyXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLSBpbiB0aGUgY2VudGVyIG9mIHRoZSBzb2NrZXRcclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGxhYmVsU3RyaW5nUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PHN0cmluZz4sIHNob3dMYWJlbHNQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj4sIHZpZXdUeXBlUHJvcGVydHk6IFByb3BlcnR5PENpcmN1aXRFbGVtZW50Vmlld1R5cGU+LFxyXG4gICAgICAgICAgICAgICAgICAgICAgY2lyY3VpdDogQ2lyY3VpdCwgZ2xvYmFsVG9DaXJjdWl0Tm9kZVBvaW50OiAoIHY6IFZlY3RvcjIgKSA9PiBWZWN0b3IyLCBpY29uTm9kZTogTm9kZSwgbWF4TnVtYmVyOiBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBjb3VudDogKCkgPT4gbnVtYmVyLCBjcmVhdGVFbGVtZW50OiAoIHY6IFZlY3RvcjIgKSA9PiBDaXJjdWl0RWxlbWVudCwgcHJvdmlkZWRPcHRpb25zOiBDaXJjdWl0RWxlbWVudFRvb2xOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBsZXQgbGFiZWxUZXh0OiBOb2RlIHwgbnVsbCA9IG51bGw7XHJcbiAgICBpZiAoIGxhYmVsU3RyaW5nUHJvcGVydHkudmFsdWUubGVuZ3RoID4gMCAmJiBwcm92aWRlZE9wdGlvbnMgJiYgcHJvdmlkZWRPcHRpb25zLnRhbmRlbSApIHtcclxuICAgICAgbGFiZWxUZXh0ID0gbmV3IFRleHQoIGxhYmVsU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgICBmb250U2l6ZTogMTIsIG1heFdpZHRoOiBUT09MQk9YX0lDT05fV0lEVEgsXHJcbiAgICAgICAgZmlsbDogQ0NLQ0NvbG9ycy50ZXh0RmlsbFByb3BlcnR5LFxyXG4gICAgICAgIHRhbmRlbTogcHJvdmlkZWRPcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdsYWJlbFRleHQnICksXHJcbiAgICAgICAgdmlzaWJsZVByb3BlcnR5T3B0aW9uczoge1xyXG4gICAgICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWVcclxuICAgICAgICB9XHJcbiAgICAgIH0gKTtcclxuICAgICAgZGVsZXRlIHByb3ZpZGVkT3B0aW9ucy50YW5kZW07XHJcbiAgICAgIHNob3dMYWJlbHNQcm9wZXJ0eS5saW5rQXR0cmlidXRlKCBsYWJlbFRleHQsICd2aXNpYmxlJyApO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxDaXJjdWl0RWxlbWVudFRvb2xOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIFZCb3hPcHRpb25zPigpKCB7XHJcbiAgICAgIHNwYWNpbmc6IDIsIC8vIFNwYWNpbmcgYmV0d2VlbiB0aGUgaWNvbiBhbmQgdGhlIHRleHRcclxuICAgICAgY3Vyc29yOiAncG9pbnRlcicsXHJcblxyXG4gICAgICAvLyBoYWNrIGJlY2F1c2UgdGhlIHNlcmllcyBhbW1ldGVyIHRvb2wgbm9kZSBoYXMgdGV4dCByZW5kZXJlZCBzZXBhcmF0ZWx5IChqb2luZWQgd2l0aCBwcm9iZSBhbW1ldGVyKVxyXG4gICAgICBjaGlsZHJlbjogbGFiZWxUZXh0ID8gWyBpY29uTm9kZSwgbGFiZWxUZXh0IF0gOiBbIGljb25Ob2RlIF0sXHJcblxyXG4gICAgICAvLyBFeHBhbmQgdG91Y2ggYXJlYSBhcm91bmQgdGV4dCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9jaXJjdWl0LWNvbnN0cnVjdGlvbi1raXQtZGMvaXNzdWVzLzgyXHJcbiAgICAgIHRvdWNoQXJlYUV4cGFuc2lvbkxlZnQ6IDAsXHJcbiAgICAgIHRvdWNoQXJlYUV4cGFuc2lvblRvcDogMCxcclxuICAgICAgdG91Y2hBcmVhRXhwYW5zaW9uUmlnaHQ6IDAsXHJcbiAgICAgIHRvdWNoQXJlYUV4cGFuc2lvbkJvdHRvbTogMCxcclxuXHJcbiAgICAgIGV4Y2x1ZGVJbnZpc2libGVDaGlsZHJlbkZyb21Cb3VuZHM6IGZhbHNlLFxyXG4gICAgICBhZGRpdGlvbmFsUHJvcGVydHk6IG5ldyBCb29sZWFuUHJvcGVydHkoIHRydWUgKSxcclxuXHJcbiAgICAgIGdob3N0T3BhY2l0eTogMC40XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuYWRkSW5wdXRMaXN0ZW5lciggRHJhZ0xpc3RlbmVyLmNyZWF0ZUZvcndhcmRpbmdMaXN0ZW5lciggKCBldmVudDogUHJlc3NMaXN0ZW5lckV2ZW50ICkgPT4ge1xyXG5cclxuICAgICAgLy8gaW5pdGlhbCBwb3NpdGlvbiBvZiB0aGUgcG9pbnRlciBpbiB0aGUgY29vcmRpbmF0ZSBmcmFtZSBvZiB0aGUgQ2lyY3VpdE5vZGVcclxuICAgICAgY29uc3QgdjogVmVjdG9yMiA9IGV2ZW50LnBvaW50ZXIucG9pbnQ7XHJcbiAgICAgIGNvbnN0IHZpZXdQb3NpdGlvbiA9IGdsb2JhbFRvQ2lyY3VpdE5vZGVQb2ludCggdiApO1xyXG5cclxuICAgICAgLy8gQWRqdXN0IGZvciB0b3VjaC4gIFRoZSBvYmplY3Qgc2hvdWxkIGFwcGVhciBjZW50ZXJlZCBvbiB0aGUgbW91c2UgYnV0IHZlcnRpY2FsbHkgYWJvdmUgdGhlIGZpbmdlciBzbyB0aGUgZmluZ2VyXHJcbiAgICAgIC8vIGRvZXNuJ3Qgb2JzY3VyZSB0aGUgb2JqZWN0XHJcbiAgICAgIHZpZXdQb3NpdGlvbi55ID0gdmlld1Bvc2l0aW9uLnkgLSAoIGV2ZW50LnBvaW50ZXIuaXNUb3VjaExpa2UoKSA/IDI4IDogMCApO1xyXG5cclxuICAgICAgLy8gQ3JlYXRlIHRoZSBuZXcgQ2lyY3VpdEVsZW1lbnQgYXQgdGhlIGNvcnJlY3QgcG9zaXRpb25cclxuICAgICAgY29uc3QgY2lyY3VpdEVsZW1lbnQgPSBjcmVhdGVFbGVtZW50KCB2aWV3UG9zaXRpb24gKTtcclxuXHJcbiAgICAgIC8vIEFkZCB0aGUgQ2lyY3VpdEVsZW1lbnQgdG8gdGhlIENpcmN1aXRcclxuICAgICAgY2lyY3VpdC5jaXJjdWl0RWxlbWVudHMuYWRkKCBjaXJjdWl0RWxlbWVudCApO1xyXG5cclxuICAgICAgLy8gU2VuZCB0aGUgc3RhcnQgZHJhZyBldmVudCB0aHJvdWdoIHNvIHRoZSBuZXcgZWxlbWVudCB3aWxsIGJlZ2luIGRyYWdnaW5nLlxyXG4gICAgICBjaXJjdWl0RWxlbWVudC5zdGFydERyYWdFbWl0dGVyLmVtaXQoIGV2ZW50ICk7XHJcbiAgICB9LCB7XHJcbiAgICAgIGFsbG93VG91Y2hTbmFnOiB0cnVlXHJcbiAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBNYWtlIHRoZSB0b29sIGljb24gdmlzaWJsZSBpZiB3ZSBjYW4gY3JlYXRlIG1vcmUgb2YgdGhlIGl0ZW0uIEJ1dCBiZSBjYXJlZnVsIHRvIG9ubHkgdXBkYXRlIHZpc2liaWxpdHkgd2hlblxyXG4gICAgLy8gdGhlIHNwZWNpZmljIGNvdW50IGZvciB0aGlzIGl0ZW0gY2hhbmdlcywgc28gd2UgY2FuIHN1cHBvcnQgUGhFVC1pTyBoaWRpbmcgdGhlIGljb25zIHZpYSB2aXNpYmlsaXR5LlxyXG4gICAgbGV0IGxhc3RDb3VudDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XHJcbiAgICBsZXQgbGFzdFZhbHVlOiBib29sZWFuIHwgbnVsbCA9IG51bGw7XHJcblxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggWyBjaXJjdWl0LmNpcmN1aXRFbGVtZW50cy5sZW5ndGhQcm9wZXJ0eSwgb3B0aW9ucy5hZGRpdGlvbmFsUHJvcGVydHkgXSwgKCBsZW5ndGgsIGV4aXN0c0F0QWxsOiBib29sZWFuICkgPT4ge1xyXG4gICAgICBjb25zdCBjdXJyZW50Q291bnQgPSBjb3VudCgpO1xyXG4gICAgICBpZiAoIGxhc3RDb3VudCAhPT0gY3VycmVudENvdW50IHx8IGxhc3RWYWx1ZSAhPT0gZXhpc3RzQXRBbGwgKSB7XHJcblxyXG4gICAgICAgIC8vIEdyYXkgb3V0IGNpcmN1aXQgZWxlbWVudHMgdGhhdCBjYW5ub3QgYmUgZHJhZ2dlZCBvdXRcclxuICAgICAgICBjb25zdCBoYXNNb3JlQXZhaWxhYmxlID0gKCBjdXJyZW50Q291bnQgPCBtYXhOdW1iZXIgKTtcclxuICAgICAgICB0aGlzLnNldE9wYWNpdHkoIGhhc01vcmVBdmFpbGFibGUgPyAxIDogb3B0aW9ucy5naG9zdE9wYWNpdHkgKTtcclxuICAgICAgICB0aGlzLmZpbHRlcnMgPSBoYXNNb3JlQXZhaWxhYmxlID8gW10gOiBbIEdyYXlzY2FsZS5GVUxMIF07XHJcbiAgICAgICAgdGhpcy5pbnB1dEVuYWJsZWQgPSBoYXNNb3JlQXZhaWxhYmxlO1xyXG5cclxuICAgICAgICAvLyBGb3IgdGhlIG5vbi1vaG1pYyByZWFsIGJ1bGIsIHdoZW4gaXQgaXMgbm90IHNlbGVjdGVkIGluIHRoZSBhZHZhbmNlZCBjb250cm9sIHBhbmVsLCB0aGUgaWNvbiBzaG91bGQgbm90IGFwcGVhciBhdCBhbGxcclxuICAgICAgICB0aGlzLnZpc2libGUgPSBleGlzdHNBdEFsbDtcclxuICAgICAgfVxyXG4gICAgICBsYXN0Q291bnQgPSBjdXJyZW50Q291bnQ7XHJcbiAgICAgIGxhc3RWYWx1ZSA9IGV4aXN0c0F0QWxsO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0b3VjaCBhcmVhcyB3aGVuIGxpZmVsaWtlL3NjaGVtYXRpYyBjaGFuZ2VzXHJcbiAgICBjb25zdCB1cGRhdGVQb2ludGVyQXJlYXMgPSAoKSA9PiB7XHJcblxyXG4gICAgICAvLyBFeHBhbmQgdG91Y2ggYXJlYSBhcm91bmQgdGV4dCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9jaXJjdWl0LWNvbnN0cnVjdGlvbi1raXQtZGMvaXNzdWVzLzgyXHJcbiAgICAgIHRoaXMudG91Y2hBcmVhID0gdGhpcy5sb2NhbEJvdW5kcy53aXRoT2Zmc2V0cyhcclxuICAgICAgICBvcHRpb25zLnRvdWNoQXJlYUV4cGFuc2lvbkxlZnQsXHJcbiAgICAgICAgb3B0aW9ucy50b3VjaEFyZWFFeHBhbnNpb25Ub3AsXHJcbiAgICAgICAgb3B0aW9ucy50b3VjaEFyZWFFeHBhbnNpb25SaWdodCxcclxuICAgICAgICBvcHRpb25zLnRvdWNoQXJlYUV4cGFuc2lvbkJvdHRvbVxyXG4gICAgICApO1xyXG4gICAgICB0aGlzLm1vdXNlQXJlYSA9IHRoaXMudG91Y2hBcmVhO1xyXG4gICAgfTtcclxuICAgIHZpZXdUeXBlUHJvcGVydHkubGluayggdXBkYXRlUG9pbnRlckFyZWFzICk7XHJcblxyXG4gICAgdGhpcy5sb2NhbEJvdW5kc1Byb3BlcnR5LmxpbmsoIHVwZGF0ZVBvaW50ZXJBcmVhcyApO1xyXG4gIH1cclxufVxyXG5cclxuY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbi5yZWdpc3RlciggJ0NpcmN1aXRFbGVtZW50VG9vbE5vZGUnLCBDaXJjdWl0RWxlbWVudFRvb2xOb2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHFDQUFxQztBQUlqRSxTQUFTQyxZQUFZLEVBQUVDLFNBQVMsRUFBNEJDLElBQUksRUFBRUMsSUFBSSxRQUFxQixnQ0FBZ0M7QUFDM0gsT0FBT0MsYUFBYSxNQUFNLHFCQUFxQjtBQUMvQyxPQUFPQyw0QkFBNEIsTUFBTSxvQ0FBb0M7QUFJN0UsT0FBT0MsU0FBUyxNQUFNLCtCQUErQjtBQUNyRCxPQUFPQyxTQUFTLE1BQU0sb0NBQW9DO0FBRTFELE9BQU9DLFVBQVUsTUFBTSxpQkFBaUI7O0FBRXhDO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUdMLGFBQWEsQ0FBQ0ssa0JBQWtCO0FBYTNE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