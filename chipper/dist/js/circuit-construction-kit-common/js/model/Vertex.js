// Copyright 2016-2023, University of Colorado Boulder

/**
 * A Vertex indicates the end of one or more CircuitElements, or an open connection for the Black Box.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../axon/js/BooleanProperty.js';
import Emitter from '../../../axon/js/Emitter.js';
import NumberProperty from '../../../axon/js/NumberProperty.js';
import Vector2 from '../../../dot/js/Vector2.js';
import Vector2Property from '../../../dot/js/Vector2Property.js';
import optionize, { combineOptions } from '../../../phet-core/js/optionize.js';
import PhetioObject from '../../../tandem/js/PhetioObject.js';
import Tandem from '../../../tandem/js/Tandem.js';
import IOType from '../../../tandem/js/types/IOType.js';
import circuitConstructionKitCommon from '../circuitConstructionKitCommon.js';
import StringProperty from '../../../axon/js/StringProperty.js';

// Index counter for debugging
let counter = 0;
export default class Vertex extends PhetioObject {
  // Index counter for hashing in CircuitNode.  Also useful for debugging and can be shown with ?vertexDisplay=index

  // position of the vertex

  // where the vertex would be if it hadn't snapped to a proposed connection

  // Relative voltage of the node, determined by Circuit.solve

  // Some of the following properties overlap.  For example, if 'insideTrueBlackBox' is true, then the interactive
  // flag will be set to false when the circuit is in Circuit.InteractionMode.TEST mode.
  // Vertices on the black box interface persist between build/investigate, and cannot be moved/deleted
  // Black box interface vertices can be interactive (tap to select) without being draggable
  // whether the Vertex can be dragged or moved by dragging another part of the circuit must be observable.  When two
  // vertices are joined in Circuit.connect, non-interactivity propagates
  // whether the vertex is on the edge of a black box.  This means it cannot be deleted, but it can be attached to
  // whether the vertex is inside the true black box, not inside the user-created black box, on the interface or outside of the black box
  // indicate when the vertex has been moved to the front in z-ordering and layering in the view must be updated
  // added by Circuit.js so that listeners can be removed when vertices are removed
  // Whether the vertex is being actively dragged.
  // for black box study
  static VertexIO = new IOType('VertexIO', {
    valueType: Vertex,
    toStateObject: vertex => ({
      position: Vector2.Vector2IO.toStateObject(vertex.positionProperty.value)
    }),
    stateObjectToCreateElementArguments: stateObject => [Vector2.Vector2IO.fromStateObject(stateObject.position)],
    stateSchema: {
      position: Vector2.Vector2IO
    }
  });
  constructor(position, selectionProperty, providedOptions) {
    const options = optionize()({
      draggable: true,
      // whether the vertex can be dragged, false for Black Box elements
      attachable: true,
      // Black box interior elements cannot be connected while the box is closed
      interactive: true,
      // Black box interface vertices can be interactive (tap to select) without being draggable
      blackBoxInterface: false,
      // Black box interface vertices cannot be dragged or deleted, but can be connected to
      insideTrueBlackBox: false,
      // Behavior differs in explore vs test mode
      tandem: Tandem.OPTIONAL,
      // Temporary vertices (for icons) should not be instrumented since they
      phetioDynamicElement: true
      // are more of an implementation detail rather than a feature
    }, providedOptions);
    super(options);
    this.index = counter++;
    this.selectionProperty = selectionProperty;
    this.vertexTandem = options.tandem;
    this.positionProperty = new Vector2Property(position, {
      tandem: options.tandem && options.tandem.createTandem('positionProperty'),
      valueComparisonStrategy: 'equalsFunction',
      isValidValue: position => position.isFinite(),
      phetioReadOnly: true,
      phetioHighFrequency: true,
      phetioFeatured: true
    });
    this.unsnappedPositionProperty = new Vector2Property(position, {
      isValidValue: position => position.isFinite()
    });
    this.voltageProperty = new NumberProperty(0, {
      tandem: options.tandem && options.tandem.createTandem('voltageProperty'),
      units: 'V',
      phetioReadOnly: true,
      phetioHighFrequency: true,
      phetioFeatured: true
    });
    this.isDraggableProperty = new BooleanProperty(options.draggable, {
      tandem: options.tandem && options.tandem.createTandem('isDraggableProperty'),
      phetioFeatured: true
    });
    this.interactiveProperty = new BooleanProperty(options.interactive);
    this.attachableProperty = new BooleanProperty(options.attachable);
    this.blackBoxInterfaceProperty = new BooleanProperty(options.blackBoxInterface);
    this.insideTrueBlackBoxProperty = new BooleanProperty(options.insideTrueBlackBox);
    this.relayerEmitter = new Emitter();
    this.vertexSelectedPropertyListener = null;
    this.isDragged = false;
    this.outerWireStub = false;
    this.isCuttableProperty = new BooleanProperty(true, {
      tandem: options.tandem.createTandem('isCuttableProperty'),
      phetioFeatured: true
    });
    this.labelStringProperty = new StringProperty('', combineOptions({
      tandem: options.tandem.createTandem('labelStringProperty'),
      phetioDocumentation: 'Shows a custom text label next to the Vertex',
      phetioFeatured: true
    }));
  }

  /**
   * Called when vertices are cut.
   */
  setPosition(position) {
    this.positionProperty.set(position);
    this.unsnappedPositionProperty.set(position);
  }

  /**
   * Dispose of this and PhET-iO instrumented children, so they will be unregistered.
   */
  dispose() {
    if (this.isSelected()) {
      this.selectionProperty.value = null;
    }
    this.positionProperty.dispose();
    this.voltageProperty.dispose();
    this.isDraggableProperty.dispose();
    this.isCuttableProperty.dispose();
    this.labelStringProperty.dispose();
    super.dispose();
  }
  isSelected() {
    return this.selectionProperty.value === this;
  }
}
circuitConstructionKitCommon.register('Vertex', Vertex);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJFbWl0dGVyIiwiTnVtYmVyUHJvcGVydHkiLCJWZWN0b3IyIiwiVmVjdG9yMlByb3BlcnR5Iiwib3B0aW9uaXplIiwiY29tYmluZU9wdGlvbnMiLCJQaGV0aW9PYmplY3QiLCJUYW5kZW0iLCJJT1R5cGUiLCJjaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uIiwiU3RyaW5nUHJvcGVydHkiLCJjb3VudGVyIiwiVmVydGV4IiwiVmVydGV4SU8iLCJ2YWx1ZVR5cGUiLCJ0b1N0YXRlT2JqZWN0IiwidmVydGV4IiwicG9zaXRpb24iLCJWZWN0b3IySU8iLCJwb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJzdGF0ZU9iamVjdFRvQ3JlYXRlRWxlbWVudEFyZ3VtZW50cyIsInN0YXRlT2JqZWN0IiwiZnJvbVN0YXRlT2JqZWN0Iiwic3RhdGVTY2hlbWEiLCJjb25zdHJ1Y3RvciIsInNlbGVjdGlvblByb3BlcnR5IiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsImRyYWdnYWJsZSIsImF0dGFjaGFibGUiLCJpbnRlcmFjdGl2ZSIsImJsYWNrQm94SW50ZXJmYWNlIiwiaW5zaWRlVHJ1ZUJsYWNrQm94IiwidGFuZGVtIiwiT1BUSU9OQUwiLCJwaGV0aW9EeW5hbWljRWxlbWVudCIsImluZGV4IiwidmVydGV4VGFuZGVtIiwiY3JlYXRlVGFuZGVtIiwidmFsdWVDb21wYXJpc29uU3RyYXRlZ3kiLCJpc1ZhbGlkVmFsdWUiLCJpc0Zpbml0ZSIsInBoZXRpb1JlYWRPbmx5IiwicGhldGlvSGlnaEZyZXF1ZW5jeSIsInBoZXRpb0ZlYXR1cmVkIiwidW5zbmFwcGVkUG9zaXRpb25Qcm9wZXJ0eSIsInZvbHRhZ2VQcm9wZXJ0eSIsInVuaXRzIiwiaXNEcmFnZ2FibGVQcm9wZXJ0eSIsImludGVyYWN0aXZlUHJvcGVydHkiLCJhdHRhY2hhYmxlUHJvcGVydHkiLCJibGFja0JveEludGVyZmFjZVByb3BlcnR5IiwiaW5zaWRlVHJ1ZUJsYWNrQm94UHJvcGVydHkiLCJyZWxheWVyRW1pdHRlciIsInZlcnRleFNlbGVjdGVkUHJvcGVydHlMaXN0ZW5lciIsImlzRHJhZ2dlZCIsIm91dGVyV2lyZVN0dWIiLCJpc0N1dHRhYmxlUHJvcGVydHkiLCJsYWJlbFN0cmluZ1Byb3BlcnR5IiwicGhldGlvRG9jdW1lbnRhdGlvbiIsInNldFBvc2l0aW9uIiwic2V0IiwiZGlzcG9zZSIsImlzU2VsZWN0ZWQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlZlcnRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIFZlcnRleCBpbmRpY2F0ZXMgdGhlIGVuZCBvZiBvbmUgb3IgbW9yZSBDaXJjdWl0RWxlbWVudHMsIG9yIGFuIG9wZW4gY29ubmVjdGlvbiBmb3IgdGhlIEJsYWNrIEJveC5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IEVtaXR0ZXIgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9FbWl0dGVyLmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSwgeyBQcm9wZXJ0eU9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMlByb3BlcnR5IGZyb20gJy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplLCB7IGNvbWJpbmVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaGV0aW9PYmplY3QsIHsgUGhldGlvT2JqZWN0T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgY2lyY3VpdENvbnN0cnVjdGlvbktpdENvbW1vbiBmcm9tICcuLi9jaXJjdWl0Q29uc3RydWN0aW9uS2l0Q29tbW9uLmpzJztcclxuaW1wb3J0IFRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL1RQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBDaXJjdWl0RWxlbWVudCBmcm9tICcuL0NpcmN1aXRFbGVtZW50LmpzJztcclxuaW1wb3J0IFN0cmluZ1Byb3BlcnR5IGZyb20gJy4uLy4uLy4uL2F4b24vanMvU3RyaW5nUHJvcGVydHkuanMnO1xyXG5cclxuLy8gSW5kZXggY291bnRlciBmb3IgZGVidWdnaW5nXHJcbmxldCBjb3VudGVyID0gMDtcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgZHJhZ2dhYmxlPzogYm9vbGVhbjtcclxuICBhdHRhY2hhYmxlPzogYm9vbGVhbjtcclxuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW47XHJcbiAgYmxhY2tCb3hJbnRlcmZhY2U/OiBib29sZWFuO1xyXG4gIGluc2lkZVRydWVCbGFja0JveD86IGJvb2xlYW47XHJcbn07XHJcbnR5cGUgVmVydGV4T3B0aW9ucyA9IFNlbGZPcHRpb25zICYgUGhldGlvT2JqZWN0T3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZlcnRleCBleHRlbmRzIFBoZXRpb09iamVjdCB7XHJcblxyXG4gIC8vIEluZGV4IGNvdW50ZXIgZm9yIGhhc2hpbmcgaW4gQ2lyY3VpdE5vZGUuICBBbHNvIHVzZWZ1bCBmb3IgZGVidWdnaW5nIGFuZCBjYW4gYmUgc2hvd24gd2l0aCA/dmVydGV4RGlzcGxheT1pbmRleFxyXG4gIHB1YmxpYyByZWFkb25seSBpbmRleDogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdmVydGV4VGFuZGVtOiBUYW5kZW07XHJcblxyXG4gIC8vIHBvc2l0aW9uIG9mIHRoZSB2ZXJ0ZXhcclxuICBwdWJsaWMgcmVhZG9ubHkgcG9zaXRpb25Qcm9wZXJ0eTogUHJvcGVydHk8VmVjdG9yMj47XHJcblxyXG4gIC8vIHdoZXJlIHRoZSB2ZXJ0ZXggd291bGQgYmUgaWYgaXQgaGFkbid0IHNuYXBwZWQgdG8gYSBwcm9wb3NlZCBjb25uZWN0aW9uXHJcbiAgcHVibGljIHJlYWRvbmx5IHVuc25hcHBlZFBvc2l0aW9uUHJvcGVydHk6IFByb3BlcnR5PFZlY3RvcjI+O1xyXG5cclxuICAvLyBSZWxhdGl2ZSB2b2x0YWdlIG9mIHRoZSBub2RlLCBkZXRlcm1pbmVkIGJ5IENpcmN1aXQuc29sdmVcclxuICBwdWJsaWMgcmVhZG9ubHkgdm9sdGFnZVByb3BlcnR5OiBQcm9wZXJ0eTxudW1iZXI+O1xyXG5cclxuICAvLyBTb21lIG9mIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcyBvdmVybGFwLiAgRm9yIGV4YW1wbGUsIGlmICdpbnNpZGVUcnVlQmxhY2tCb3gnIGlzIHRydWUsIHRoZW4gdGhlIGludGVyYWN0aXZlXHJcbiAgLy8gZmxhZyB3aWxsIGJlIHNldCB0byBmYWxzZSB3aGVuIHRoZSBjaXJjdWl0IGlzIGluIENpcmN1aXQuSW50ZXJhY3Rpb25Nb2RlLlRFU1QgbW9kZS5cclxuXHJcbiAgLy8gVmVydGljZXMgb24gdGhlIGJsYWNrIGJveCBpbnRlcmZhY2UgcGVyc2lzdCBiZXR3ZWVuIGJ1aWxkL2ludmVzdGlnYXRlLCBhbmQgY2Fubm90IGJlIG1vdmVkL2RlbGV0ZWRcclxuICBwdWJsaWMgcmVhZG9ubHkgaXNEcmFnZ2FibGVQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIEJsYWNrIGJveCBpbnRlcmZhY2UgdmVydGljZXMgY2FuIGJlIGludGVyYWN0aXZlICh0YXAgdG8gc2VsZWN0KSB3aXRob3V0IGJlaW5nIGRyYWdnYWJsZVxyXG4gIHB1YmxpYyByZWFkb25seSBpbnRlcmFjdGl2ZVByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gd2hldGhlciB0aGUgVmVydGV4IGNhbiBiZSBkcmFnZ2VkIG9yIG1vdmVkIGJ5IGRyYWdnaW5nIGFub3RoZXIgcGFydCBvZiB0aGUgY2lyY3VpdCBtdXN0IGJlIG9ic2VydmFibGUuICBXaGVuIHR3b1xyXG4gIC8vIHZlcnRpY2VzIGFyZSBqb2luZWQgaW4gQ2lyY3VpdC5jb25uZWN0LCBub24taW50ZXJhY3Rpdml0eSBwcm9wYWdhdGVzXHJcbiAgcHVibGljIHJlYWRvbmx5IGF0dGFjaGFibGVQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIHdoZXRoZXIgdGhlIHZlcnRleCBpcyBvbiB0aGUgZWRnZSBvZiBhIGJsYWNrIGJveC4gIFRoaXMgbWVhbnMgaXQgY2Fubm90IGJlIGRlbGV0ZWQsIGJ1dCBpdCBjYW4gYmUgYXR0YWNoZWQgdG9cclxuICBwdWJsaWMgcmVhZG9ubHkgYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIHdoZXRoZXIgdGhlIHZlcnRleCBpcyBpbnNpZGUgdGhlIHRydWUgYmxhY2sgYm94LCBub3QgaW5zaWRlIHRoZSB1c2VyLWNyZWF0ZWQgYmxhY2sgYm94LCBvbiB0aGUgaW50ZXJmYWNlIG9yIG91dHNpZGUgb2YgdGhlIGJsYWNrIGJveFxyXG4gIHB1YmxpYyByZWFkb25seSBpbnNpZGVUcnVlQmxhY2tCb3hQcm9wZXJ0eTogUHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIC8vIGluZGljYXRlIHdoZW4gdGhlIHZlcnRleCBoYXMgYmVlbiBtb3ZlZCB0byB0aGUgZnJvbnQgaW4gei1vcmRlcmluZyBhbmQgbGF5ZXJpbmcgaW4gdGhlIHZpZXcgbXVzdCBiZSB1cGRhdGVkXHJcbiAgcHVibGljIHJlYWRvbmx5IHJlbGF5ZXJFbWl0dGVyOiBURW1pdHRlcjtcclxuXHJcbiAgLy8gYWRkZWQgYnkgQ2lyY3VpdC5qcyBzbyB0aGF0IGxpc3RlbmVycyBjYW4gYmUgcmVtb3ZlZCB3aGVuIHZlcnRpY2VzIGFyZSByZW1vdmVkXHJcbiAgcHVibGljIHZlcnRleFNlbGVjdGVkUHJvcGVydHlMaXN0ZW5lcjogKCAoIHNlbGVjdGVkOiBib29sZWFuICkgPT4gdm9pZCApIHwgbnVsbDtcclxuXHJcbiAgLy8gV2hldGhlciB0aGUgdmVydGV4IGlzIGJlaW5nIGFjdGl2ZWx5IGRyYWdnZWQuXHJcbiAgcHVibGljIGlzRHJhZ2dlZDogYm9vbGVhbjtcclxuXHJcbiAgLy8gZm9yIGJsYWNrIGJveCBzdHVkeVxyXG4gIHB1YmxpYyBvdXRlcldpcmVTdHViOiBib29sZWFuO1xyXG4gIHB1YmxpYyBpc0N1dHRhYmxlUHJvcGVydHk6IEJvb2xlYW5Qcm9wZXJ0eTtcclxuICBwdWJsaWMgbGFiZWxTdHJpbmdQcm9wZXJ0eTogVFByb3BlcnR5PHN0cmluZz47XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVmVydGV4SU8gPSBuZXcgSU9UeXBlPFZlcnRleCwgVmVydGV4U3RhdGU+KCAnVmVydGV4SU8nLCB7XHJcbiAgICB2YWx1ZVR5cGU6IFZlcnRleCxcclxuICAgIHRvU3RhdGVPYmplY3Q6ICggdmVydGV4OiBWZXJ0ZXggKSA9PiAoIHsgcG9zaXRpb246IFZlY3RvcjIuVmVjdG9yMklPLnRvU3RhdGVPYmplY3QoIHZlcnRleC5wb3NpdGlvblByb3BlcnR5LnZhbHVlICkgfSApLFxyXG4gICAgc3RhdGVPYmplY3RUb0NyZWF0ZUVsZW1lbnRBcmd1bWVudHM6ICggc3RhdGVPYmplY3Q6IFZlcnRleFN0YXRlICkgPT4gWyBWZWN0b3IyLlZlY3RvcjJJTy5mcm9tU3RhdGVPYmplY3QoIHN0YXRlT2JqZWN0LnBvc2l0aW9uICkgXSxcclxuICAgIHN0YXRlU2NoZW1hOiB7XHJcbiAgICAgIHBvc2l0aW9uOiBWZWN0b3IyLlZlY3RvcjJJT1xyXG4gICAgfVxyXG4gIH0gKTtcclxuICBwdWJsaWMgcmVhZG9ubHkgc2VsZWN0aW9uUHJvcGVydHk6IFRQcm9wZXJ0eTxWZXJ0ZXggfCBDaXJjdWl0RWxlbWVudCB8IG51bGw+O1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHBvc2l0aW9uOiBWZWN0b3IyLCBzZWxlY3Rpb25Qcm9wZXJ0eTogVFByb3BlcnR5PENpcmN1aXRFbGVtZW50IHwgVmVydGV4IHwgbnVsbD4sIHByb3ZpZGVkT3B0aW9ucz86IFZlcnRleE9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxWZXJ0ZXhPcHRpb25zLCBTZWxmT3B0aW9ucywgUGhldGlvT2JqZWN0T3B0aW9ucz4oKSgge1xyXG4gICAgICBkcmFnZ2FibGU6IHRydWUsIC8vIHdoZXRoZXIgdGhlIHZlcnRleCBjYW4gYmUgZHJhZ2dlZCwgZmFsc2UgZm9yIEJsYWNrIEJveCBlbGVtZW50c1xyXG4gICAgICBhdHRhY2hhYmxlOiB0cnVlLCAvLyBCbGFjayBib3ggaW50ZXJpb3IgZWxlbWVudHMgY2Fubm90IGJlIGNvbm5lY3RlZCB3aGlsZSB0aGUgYm94IGlzIGNsb3NlZFxyXG4gICAgICBpbnRlcmFjdGl2ZTogdHJ1ZSwgLy8gQmxhY2sgYm94IGludGVyZmFjZSB2ZXJ0aWNlcyBjYW4gYmUgaW50ZXJhY3RpdmUgKHRhcCB0byBzZWxlY3QpIHdpdGhvdXQgYmVpbmcgZHJhZ2dhYmxlXHJcbiAgICAgIGJsYWNrQm94SW50ZXJmYWNlOiBmYWxzZSwgLy8gQmxhY2sgYm94IGludGVyZmFjZSB2ZXJ0aWNlcyBjYW5ub3QgYmUgZHJhZ2dlZCBvciBkZWxldGVkLCBidXQgY2FuIGJlIGNvbm5lY3RlZCB0b1xyXG4gICAgICBpbnNpZGVUcnVlQmxhY2tCb3g6IGZhbHNlLCAvLyBCZWhhdmlvciBkaWZmZXJzIGluIGV4cGxvcmUgdnMgdGVzdCBtb2RlXHJcbiAgICAgIHRhbmRlbTogVGFuZGVtLk9QVElPTkFMLCAvLyBUZW1wb3JhcnkgdmVydGljZXMgKGZvciBpY29ucykgc2hvdWxkIG5vdCBiZSBpbnN0cnVtZW50ZWQgc2luY2UgdGhleVxyXG4gICAgICBwaGV0aW9EeW5hbWljRWxlbWVudDogdHJ1ZVxyXG4gICAgICAvLyBhcmUgbW9yZSBvZiBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWwgcmF0aGVyIHRoYW4gYSBmZWF0dXJlXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggb3B0aW9ucyApO1xyXG5cclxuICAgIHRoaXMuaW5kZXggPSBjb3VudGVyKys7XHJcblxyXG4gICAgdGhpcy5zZWxlY3Rpb25Qcm9wZXJ0eSA9IHNlbGVjdGlvblByb3BlcnR5O1xyXG5cclxuICAgIHRoaXMudmVydGV4VGFuZGVtID0gb3B0aW9ucy50YW5kZW07XHJcblxyXG4gICAgdGhpcy5wb3NpdGlvblByb3BlcnR5ID0gbmV3IFZlY3RvcjJQcm9wZXJ0eSggcG9zaXRpb24sIHtcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbSAmJiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdwb3NpdGlvblByb3BlcnR5JyApLFxyXG4gICAgICB2YWx1ZUNvbXBhcmlzb25TdHJhdGVneTogJ2VxdWFsc0Z1bmN0aW9uJyxcclxuICAgICAgaXNWYWxpZFZhbHVlOiAoIHBvc2l0aW9uOiBWZWN0b3IyICkgPT4gcG9zaXRpb24uaXNGaW5pdGUoKSxcclxuICAgICAgcGhldGlvUmVhZE9ubHk6IHRydWUsXHJcbiAgICAgIHBoZXRpb0hpZ2hGcmVxdWVuY3k6IHRydWUsXHJcbiAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy51bnNuYXBwZWRQb3NpdGlvblByb3BlcnR5ID0gbmV3IFZlY3RvcjJQcm9wZXJ0eSggcG9zaXRpb24sIHtcclxuICAgICAgaXNWYWxpZFZhbHVlOiAoIHBvc2l0aW9uOiBWZWN0b3IyICkgPT4gcG9zaXRpb24uaXNGaW5pdGUoKVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMudm9sdGFnZVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0gJiYgb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAndm9sdGFnZVByb3BlcnR5JyApLFxyXG4gICAgICB1bml0czogJ1YnLFxyXG4gICAgICBwaGV0aW9SZWFkT25seTogdHJ1ZSxcclxuICAgICAgcGhldGlvSGlnaEZyZXF1ZW5jeTogdHJ1ZSxcclxuICAgICAgcGhldGlvRmVhdHVyZWQ6IHRydWVcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmlzRHJhZ2dhYmxlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBvcHRpb25zLmRyYWdnYWJsZSwge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtICYmIG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2lzRHJhZ2dhYmxlUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5pbnRlcmFjdGl2ZVByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggb3B0aW9ucy5pbnRlcmFjdGl2ZSApO1xyXG4gICAgdGhpcy5hdHRhY2hhYmxlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBvcHRpb25zLmF0dGFjaGFibGUgKTtcclxuICAgIHRoaXMuYmxhY2tCb3hJbnRlcmZhY2VQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIG9wdGlvbnMuYmxhY2tCb3hJbnRlcmZhY2UgKTtcclxuICAgIHRoaXMuaW5zaWRlVHJ1ZUJsYWNrQm94UHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBvcHRpb25zLmluc2lkZVRydWVCbGFja0JveCApO1xyXG4gICAgdGhpcy5yZWxheWVyRW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XHJcbiAgICB0aGlzLnZlcnRleFNlbGVjdGVkUHJvcGVydHlMaXN0ZW5lciA9IG51bGw7XHJcbiAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlO1xyXG4gICAgdGhpcy5vdXRlcldpcmVTdHViID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5pc0N1dHRhYmxlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0cnVlLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCAnaXNDdXR0YWJsZVByb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9GZWF0dXJlZDogdHJ1ZVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubGFiZWxTdHJpbmdQcm9wZXJ0eSA9IG5ldyBTdHJpbmdQcm9wZXJ0eSggJycsIGNvbWJpbmVPcHRpb25zPFByb3BlcnR5T3B0aW9uczxzdHJpbmc+Pigge1xyXG4gICAgICB0YW5kZW06IG9wdGlvbnMudGFuZGVtLmNyZWF0ZVRhbmRlbSggJ2xhYmVsU3RyaW5nUHJvcGVydHknICksXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdTaG93cyBhIGN1c3RvbSB0ZXh0IGxhYmVsIG5leHQgdG8gdGhlIFZlcnRleCcsXHJcbiAgICAgIHBoZXRpb0ZlYXR1cmVkOiB0cnVlXHJcbiAgICB9ICkgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxlZCB3aGVuIHZlcnRpY2VzIGFyZSBjdXQuXHJcbiAgICovXHJcbiAgcHVibGljIHNldFBvc2l0aW9uKCBwb3NpdGlvbjogVmVjdG9yMiApOiB2b2lkIHtcclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5zZXQoIHBvc2l0aW9uICk7XHJcbiAgICB0aGlzLnVuc25hcHBlZFBvc2l0aW9uUHJvcGVydHkuc2V0KCBwb3NpdGlvbiApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGlzcG9zZSBvZiB0aGlzIGFuZCBQaEVULWlPIGluc3RydW1lbnRlZCBjaGlsZHJlbiwgc28gdGhleSB3aWxsIGJlIHVucmVnaXN0ZXJlZC5cclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGlmICggdGhpcy5pc1NlbGVjdGVkKCkgKSB7XHJcbiAgICAgIHRoaXMuc2VsZWN0aW9uUHJvcGVydHkudmFsdWUgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICB0aGlzLnZvbHRhZ2VQcm9wZXJ0eS5kaXNwb3NlKCk7XHJcbiAgICB0aGlzLmlzRHJhZ2dhYmxlUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgdGhpcy5pc0N1dHRhYmxlUHJvcGVydHkuZGlzcG9zZSgpO1xyXG4gICAgdGhpcy5sYWJlbFN0cmluZ1Byb3BlcnR5LmRpc3Bvc2UoKTtcclxuXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNTZWxlY3RlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLnNlbGVjdGlvblByb3BlcnR5LnZhbHVlID09PSB0aGlzO1xyXG4gIH1cclxufVxyXG5cclxudHlwZSBWZXJ0ZXhTdGF0ZSA9IHtcclxuICBwb3NpdGlvbjogVmVjdG9yMjtcclxufTtcclxuXHJcbmNpcmN1aXRDb25zdHJ1Y3Rpb25LaXRDb21tb24ucmVnaXN0ZXIoICdWZXJ0ZXgnLCBWZXJ0ZXggKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHFDQUFxQztBQUNqRSxPQUFPQyxPQUFPLE1BQU0sNkJBQTZCO0FBRWpELE9B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