// Copyright 2013-2020, University of Colorado Boulder

/**
 * Model for a draggable, rectangular "mass" object containing its mass, position, width, height, velocity etc.
 *
 * @author Vasily Shakhov (Mlearner)
 * @author Siddhartha Chinthapally (Actual Concepts)
 */

import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import Vector2Property from '../../../../dot/js/Vector2Property.js';
import fluidPressureAndFlow from '../../fluidPressureAndFlow.js';

// constants
const frictionCoefficient = 0.98;
class MassModel {
  /**
   * @param {ChamberPoolModel} chamberPoolModel - of the simulation
   * @param {number} mass - of object in grams
   * @param {number} x - coordinate of the mass in meters
   * @param {number} y - coordinate of the mass in meters
   * @param {number} width - of the mass in meters
   * @param {number} height - of the mass in meters
   */
  constructor(chamberPoolModel, mass, x, y, width, height) {
    this.chamberPoolModel = chamberPoolModel;
    this.mass = mass;

    // all coordinates in meters
    this.width = width; // @public
    this.height = height; // @public

    // @public
    // The position is the center of the block.
    this.positionProperty = new Vector2Property(new Vector2(x, y));
    this.isDraggingProperty = new Property(false);
    this.isFalling = false; // @private
    this.velocity = 0; // @private

    this.isDraggingProperty.link(isDragging => {
      // If the user dropped the mass, then let it fall.
      if (!isDragging) {
        if (this.isInTargetDroppedArea()) {
          chamberPoolModel.stack.push(this);
        } else if (this.cannotFall()) {
          this.reset();
        } else {
          this.isFalling = true;
        }
      } else {
        // The user grabbed the mass.  If it was in the stack, remove it.
        if (chamberPoolModel.stack.includes(this)) {
          chamberPoolModel.stack.remove(this);
        }
      }
    });
  }

  // @public
  step(dt) {
    let acceleration;

    // move the masses only when the velocity is greater than than this, see #60 for under-pressure repo
    const epsilonVelocity = 0.05;
    if (this.chamberPoolModel.stack.includes(this)) {
      //use newtonâ€™s laws to equalize pressure/force at interface
      const m = this.chamberPoolModel.stackMassProperty.value;
      const rho = this.chamberPoolModel.underPressureModel.fluidDensityProperty.value;
      const g = this.chamberPoolModel.underPressureModel.gravityProperty.value;

      //difference between water levels in left and right opening
      const h = this.chamberPoolModel.leftDisplacementProperty.value + this.chamberPoolModel.leftDisplacementProperty.value / this.chamberPoolModel.lengthRatio;
      const gravityForce = -m * g;
      const pressureForce = rho * h * g;
      const force = gravityForce + pressureForce;
      acceleration = force / m;
      this.velocity = (this.velocity + acceleration * dt) * frictionCoefficient;
      if (Math.abs(this.velocity) > epsilonVelocity) {
        this.positionProperty.value.y += this.velocity * dt;
        this.positionProperty.notifyListenersStatic();
      }
    } else if (this.isFalling && !this.isDraggingProperty.value) {
      acceleration = -this.chamberPoolModel.underPressureModel.gravityProperty.value;
      this.velocity = this.velocity + acceleration * dt;
      if (Math.abs(this.velocity) > epsilonVelocity) {
        this.positionProperty.value.y += this.velocity * dt;

        // If it landed, then stop the block.
        if (this.positionProperty.value.y < this.chamberPoolModel.maxY + this.height / 2) {
          this.positionProperty.value.y = this.chamberPoolModel.maxY + this.height / 2;
          this.isFalling = false;
          this.velocity = 0;
        }
        this.positionProperty.notifyListenersStatic();
      }
    }
  }

  // @public -- checks if the mass intersects with the target drop area.
  isInTargetDroppedArea() {
    const waterLine = this.chamberPoolModel.poolDimensions.leftOpening.y2 + this.chamberPoolModel.leftWaterHeight - this.chamberPoolModel.leftDisplacementProperty.value;
    const bottomLine = waterLine + this.chamberPoolModel.stack.reduce((a, b) => a + b.height, 0);
    const massBounds = new Bounds2(this.positionProperty.value.x - this.width / 2, this.positionProperty.value.y - this.height / 2, this.positionProperty.value.x + this.width, this.positionProperty.value.y + this.height);
    const dropAreaBounds = new Bounds2(this.chamberPoolModel.poolDimensions.leftOpening.x1, bottomLine, this.chamberPoolModel.poolDimensions.leftOpening.x2, bottomLine + this.height);
    return massBounds.intersectsBounds(dropAreaBounds);
  }

  // @private - If the user drops the mass underground or above a pool opening, it will teleport back to its initial position.
  cannotFall() {
    return this.positionProperty.value.y < this.chamberPoolModel.maxY - this.height / 2 || this.isMassOverOpening();
  }

  /**
   * Restore the initial conditions
   * @public
   */
  reset() {
    this.positionProperty.reset();
    this.isDraggingProperty.reset();
  }

  // @private - checks if the mass is over the left or the right opening
  isMassOverOpening() {
    const left = this.positionProperty.value.x;
    const right = this.positionProperty.value.x + this.width / 2;
    const dimensions = this.chamberPoolModel.poolDimensions;
    return dimensions.leftOpening.x1 < left && left < dimensions.leftOpening.x2 || dimensions.leftOpening.x1 < right && right < dimensions.leftOpening.x2 || dimensions.rightOpening.x1 < left && left < dimensions.rightOpening.x2 || dimensions.rightOpening.x1 < right && right < dimensions.rightOpening.x2;
  }
}
fluidPressureAndFlow.register('MassModel', MassModel);
export default MassModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkJvdW5kczIiLCJWZWN0b3IyIiwiVmVjdG9yMlByb3BlcnR5IiwiZmx1aWRQcmVzc3VyZUFuZEZsb3ciLCJmcmljdGlvbkNvZWZmaWNpZW50IiwiTWFzc01vZGVsIiwiY29uc3RydWN0b3IiLCJjaGFtYmVyUG9vbE1vZGVsIiwibWFzcyIsIngiLCJ5Iiwid2lkdGgiLCJoZWlnaHQiLCJwb3NpdGlvblByb3BlcnR5IiwiaXNEcmFnZ2luZ1Byb3BlcnR5IiwiaXNGYWxsaW5nIiwidmVsb2NpdHkiLCJsaW5rIiwiaXNEcmFnZ2luZyIsImlzSW5UYXJnZXREcm9wcGVkQXJlYSIsInN0YWNrIiwicHVzaCIsImNhbm5vdEZhbGwiLCJyZXNldCIsImluY2x1ZGVzIiwicmVtb3ZlIiwic3RlcCIsImR0IiwiYWNjZWxlcmF0aW9uIiwiZXBzaWxvblZlbG9jaXR5IiwibSIsInN0YWNrTWFzc1Byb3BlcnR5IiwidmFsdWUiLCJyaG8iLCJ1bmRlclByZXNzdXJlTW9kZWwiLCJmbHVpZERlbnNpdHlQcm9wZXJ0eSIsImciLCJncmF2aXR5UHJvcGVydHkiLCJoIiwibGVmdERpc3BsYWNlbWVudFByb3BlcnR5IiwibGVuZ3RoUmF0aW8iLCJncmF2aXR5Rm9yY2UiLCJwcmVzc3VyZUZvcmNlIiwiZm9yY2UiLCJNYXRoIiwiYWJzIiwibm90aWZ5TGlzdGVuZXJzU3RhdGljIiwibWF4WSIsIndhdGVyTGluZSIsInBvb2xEaW1lbnNpb25zIiwibGVmdE9wZW5pbmciLCJ5MiIsImxlZnRXYXRlckhlaWdodCIsImJvdHRvbUxpbmUiLCJyZWR1Y2UiLCJhIiwiYiIsIm1hc3NCb3VuZHMiLCJkcm9wQXJlYUJvdW5kcyIsIngxIiwieDIiLCJpbnRlcnNlY3RzQm91bmRzIiwiaXNNYXNzT3Zlck9wZW5pbmciLCJsZWZ0IiwicmlnaHQiLCJkaW1lbnNpb25zIiwicmlnaHRPcGVuaW5nIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJNYXNzTW9kZWwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyMCwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTW9kZWwgZm9yIGEgZHJhZ2dhYmxlLCByZWN0YW5ndWxhciBcIm1hc3NcIiBvYmplY3QgY29udGFpbmluZyBpdHMgbWFzcywgcG9zaXRpb24sIHdpZHRoLCBoZWlnaHQsIHZlbG9jaXR5IGV0Yy5cclxuICpcclxuICogQGF1dGhvciBWYXNpbHkgU2hha2hvdiAoTWxlYXJuZXIpXHJcbiAqIEBhdXRob3IgU2lkZGhhcnRoYSBDaGludGhhcGFsbHkgKEFjdHVhbCBDb25jZXB0cylcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMlByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgZmx1aWRQcmVzc3VyZUFuZEZsb3cgZnJvbSAnLi4vLi4vZmx1aWRQcmVzc3VyZUFuZEZsb3cuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IGZyaWN0aW9uQ29lZmZpY2llbnQgPSAwLjk4O1xyXG5cclxuY2xhc3MgTWFzc01vZGVsIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtDaGFtYmVyUG9vbE1vZGVsfSBjaGFtYmVyUG9vbE1vZGVsIC0gb2YgdGhlIHNpbXVsYXRpb25cclxuICAgKiBAcGFyYW0ge251bWJlcn0gbWFzcyAtIG9mIG9iamVjdCBpbiBncmFtc1xyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gY29vcmRpbmF0ZSBvZiB0aGUgbWFzcyBpbiBtZXRlcnNcclxuICAgKiBAcGFyYW0ge251bWJlcn0geSAtIGNvb3JkaW5hdGUgb2YgdGhlIG1hc3MgaW4gbWV0ZXJzXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gb2YgdGhlIG1hc3MgaW4gbWV0ZXJzXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIG9mIHRoZSBtYXNzIGluIG1ldGVyc1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBjaGFtYmVyUG9vbE1vZGVsLCBtYXNzLCB4LCB5LCB3aWR0aCwgaGVpZ2h0ICkge1xyXG5cclxuICAgIHRoaXMuY2hhbWJlclBvb2xNb2RlbCA9IGNoYW1iZXJQb29sTW9kZWw7XHJcbiAgICB0aGlzLm1hc3MgPSBtYXNzO1xyXG5cclxuICAgIC8vIGFsbCBjb29yZGluYXRlcyBpbiBtZXRlcnNcclxuICAgIHRoaXMud2lkdGggPSB3aWR0aDsgLy8gQHB1YmxpY1xyXG4gICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7IC8vIEBwdWJsaWNcclxuXHJcbiAgICAvLyBAcHVibGljXHJcbiAgICAvLyBUaGUgcG9zaXRpb24gaXMgdGhlIGNlbnRlciBvZiB0aGUgYmxvY2suXHJcbiAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkgPSBuZXcgVmVjdG9yMlByb3BlcnR5KCBuZXcgVmVjdG9yMiggeCwgeSApICk7XHJcblxyXG4gICAgdGhpcy5pc0RyYWdnaW5nUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIGZhbHNlICk7XHJcblxyXG4gICAgdGhpcy5pc0ZhbGxpbmcgPSBmYWxzZTsgLy8gQHByaXZhdGVcclxuICAgIHRoaXMudmVsb2NpdHkgPSAwOyAvLyBAcHJpdmF0ZVxyXG5cclxuICAgIHRoaXMuaXNEcmFnZ2luZ1Byb3BlcnR5LmxpbmsoIGlzRHJhZ2dpbmcgPT4ge1xyXG5cclxuICAgICAgICAvLyBJZiB0aGUgdXNlciBkcm9wcGVkIHRoZSBtYXNzLCB0aGVuIGxldCBpdCBmYWxsLlxyXG4gICAgICAgIGlmICggIWlzRHJhZ2dpbmcgKSB7XHJcbiAgICAgICAgICBpZiAoIHRoaXMuaXNJblRhcmdldERyb3BwZWRBcmVhKCkgKSB7XHJcbiAgICAgICAgICAgIGNoYW1iZXJQb29sTW9kZWwuc3RhY2sucHVzaCggdGhpcyApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZSBpZiAoIHRoaXMuY2Fubm90RmFsbCgpICkge1xyXG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5pc0ZhbGxpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIC8vIFRoZSB1c2VyIGdyYWJiZWQgdGhlIG1hc3MuICBJZiBpdCB3YXMgaW4gdGhlIHN0YWNrLCByZW1vdmUgaXQuXHJcbiAgICAgICAgICBpZiAoIGNoYW1iZXJQb29sTW9kZWwuc3RhY2suaW5jbHVkZXMoIHRoaXMgKSApIHtcclxuICAgICAgICAgICAgY2hhbWJlclBvb2xNb2RlbC5zdGFjay5yZW1vdmUoIHRoaXMgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyBAcHVibGljXHJcbiAgc3RlcCggZHQgKSB7XHJcbiAgICBsZXQgYWNjZWxlcmF0aW9uO1xyXG5cclxuICAgIC8vIG1vdmUgdGhlIG1hc3NlcyBvbmx5IHdoZW4gdGhlIHZlbG9jaXR5IGlzIGdyZWF0ZXIgdGhhbiB0aGFuIHRoaXMsIHNlZSAjNjAgZm9yIHVuZGVyLXByZXNzdXJlIHJlcG9cclxuICAgIGNvbnN0IGVwc2lsb25WZWxvY2l0eSA9IDAuMDU7XHJcblxyXG4gICAgaWYgKCB0aGlzLmNoYW1iZXJQb29sTW9kZWwuc3RhY2suaW5jbHVkZXMoIHRoaXMgKSApIHtcclxuXHJcbiAgICAgIC8vdXNlIG5ld3RvbuKAmXMgbGF3cyB0byBlcXVhbGl6ZSBwcmVzc3VyZS9mb3JjZSBhdCBpbnRlcmZhY2VcclxuICAgICAgY29uc3QgbSA9IHRoaXMuY2hhbWJlclBvb2xNb2RlbC5zdGFja01hc3NQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgY29uc3QgcmhvID0gdGhpcy5jaGFtYmVyUG9vbE1vZGVsLnVuZGVyUHJlc3N1cmVNb2RlbC5mbHVpZERlbnNpdHlQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgY29uc3QgZyA9IHRoaXMuY2hhbWJlclBvb2xNb2RlbC51bmRlclByZXNzdXJlTW9kZWwuZ3Jhdml0eVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgLy9kaWZmZXJlbmNlIGJldHdlZW4gd2F0ZXIgbGV2ZWxzIGluIGxlZnQgYW5kIHJpZ2h0IG9wZW5pbmdcclxuICAgICAgY29uc3QgaCA9IHRoaXMuY2hhbWJlclBvb2xNb2RlbC5sZWZ0RGlzcGxhY2VtZW50UHJvcGVydHkudmFsdWUgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGFtYmVyUG9vbE1vZGVsLmxlZnREaXNwbGFjZW1lbnRQcm9wZXJ0eS52YWx1ZSAvIHRoaXMuY2hhbWJlclBvb2xNb2RlbC5sZW5ndGhSYXRpbztcclxuICAgICAgY29uc3QgZ3Jhdml0eUZvcmNlID0gLW0gKiBnO1xyXG4gICAgICBjb25zdCBwcmVzc3VyZUZvcmNlID0gcmhvICogaCAqIGc7XHJcbiAgICAgIGNvbnN0IGZvcmNlID0gZ3Jhdml0eUZvcmNlICsgcHJlc3N1cmVGb3JjZTtcclxuICAgICAgYWNjZWxlcmF0aW9uID0gZm9yY2UgLyBtO1xyXG4gICAgICB0aGlzLnZlbG9jaXR5ID0gKCB0aGlzLnZlbG9jaXR5ICsgYWNjZWxlcmF0aW9uICogZHQgKSAqIGZyaWN0aW9uQ29lZmZpY2llbnQ7XHJcbiAgICAgIGlmICggTWF0aC5hYnMoIHRoaXMudmVsb2NpdHkgKSA+IGVwc2lsb25WZWxvY2l0eSApIHtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSArPSB0aGlzLnZlbG9jaXR5ICogZHQ7XHJcbiAgICAgICAgdGhpcy5wb3NpdGlvblByb3BlcnR5Lm5vdGlmeUxpc3RlbmVyc1N0YXRpYygpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGhpcy5pc0ZhbGxpbmcgJiYgIXRoaXMuaXNEcmFnZ2luZ1Byb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICBhY2NlbGVyYXRpb24gPSAtdGhpcy5jaGFtYmVyUG9vbE1vZGVsLnVuZGVyUHJlc3N1cmVNb2RlbC5ncmF2aXR5UHJvcGVydHkudmFsdWU7XHJcbiAgICAgIHRoaXMudmVsb2NpdHkgPSB0aGlzLnZlbG9jaXR5ICsgYWNjZWxlcmF0aW9uICogZHQ7XHJcbiAgICAgIGlmICggTWF0aC5hYnMoIHRoaXMudmVsb2NpdHkgKSA+IGVwc2lsb25WZWxvY2l0eSApIHtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSArPSB0aGlzLnZlbG9jaXR5ICogZHQ7XHJcblxyXG4gICAgICAgIC8vIElmIGl0IGxhbmRlZCwgdGhlbiBzdG9wIHRoZSBibG9jay5cclxuICAgICAgICBpZiAoIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55IDwgdGhpcy5jaGFtYmVyUG9vbE1vZGVsLm1heFkgKyB0aGlzLmhlaWdodCAvIDIgKSB7XHJcbiAgICAgICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSA9IHRoaXMuY2hhbWJlclBvb2xNb2RlbC5tYXhZICsgdGhpcy5oZWlnaHQgLyAyO1xyXG4gICAgICAgICAgdGhpcy5pc0ZhbGxpbmcgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMudmVsb2NpdHkgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkubm90aWZ5TGlzdGVuZXJzU3RhdGljKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEBwdWJsaWMgLS0gY2hlY2tzIGlmIHRoZSBtYXNzIGludGVyc2VjdHMgd2l0aCB0aGUgdGFyZ2V0IGRyb3AgYXJlYS5cclxuICBpc0luVGFyZ2V0RHJvcHBlZEFyZWEoKSB7XHJcbiAgICBjb25zdCB3YXRlckxpbmUgPSB0aGlzLmNoYW1iZXJQb29sTW9kZWwucG9vbERpbWVuc2lvbnMubGVmdE9wZW5pbmcueTIgKyB0aGlzLmNoYW1iZXJQb29sTW9kZWwubGVmdFdhdGVySGVpZ2h0IC1cclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbWJlclBvb2xNb2RlbC5sZWZ0RGlzcGxhY2VtZW50UHJvcGVydHkudmFsdWU7XHJcbiAgICBjb25zdCBib3R0b21MaW5lID0gd2F0ZXJMaW5lICsgdGhpcy5jaGFtYmVyUG9vbE1vZGVsLnN0YWNrLnJlZHVjZSggKCBhLCBiICkgPT4gYSArIGIuaGVpZ2h0LCAwICk7XHJcbiAgICBjb25zdCBtYXNzQm91bmRzID0gbmV3IEJvdW5kczIoXHJcbiAgICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54IC0gdGhpcy53aWR0aCAvIDIsXHJcbiAgICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55IC0gdGhpcy5oZWlnaHQgLyAyLFxyXG4gICAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueCArIHRoaXMud2lkdGgsXHJcbiAgICAgIHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS55ICsgdGhpcy5oZWlnaHRcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZHJvcEFyZWFCb3VuZHMgPSBuZXcgQm91bmRzMihcclxuICAgICAgdGhpcy5jaGFtYmVyUG9vbE1vZGVsLnBvb2xEaW1lbnNpb25zLmxlZnRPcGVuaW5nLngxLFxyXG4gICAgICBib3R0b21MaW5lLFxyXG4gICAgICB0aGlzLmNoYW1iZXJQb29sTW9kZWwucG9vbERpbWVuc2lvbnMubGVmdE9wZW5pbmcueDIsXHJcbiAgICAgICggYm90dG9tTGluZSArIHRoaXMuaGVpZ2h0IClcclxuICAgICk7XHJcbiAgICByZXR1cm4gbWFzc0JvdW5kcy5pbnRlcnNlY3RzQm91bmRzKCBkcm9wQXJlYUJvdW5kcyApO1xyXG4gIH1cclxuXHJcbiAgLy8gQHByaXZhdGUgLSBJZiB0aGUgdXNlciBkcm9wcyB0aGUgbWFzcyB1bmRlcmdyb3VuZCBvciBhYm92ZSBhIHBvb2wgb3BlbmluZywgaXQgd2lsbCB0ZWxlcG9ydCBiYWNrIHRvIGl0cyBpbml0aWFsIHBvc2l0aW9uLlxyXG4gIGNhbm5vdEZhbGwoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wb3NpdGlvblByb3BlcnR5LnZhbHVlLnkgPCB0aGlzLmNoYW1iZXJQb29sTW9kZWwubWF4WSAtIHRoaXMuaGVpZ2h0IC8gMiB8fCB0aGlzLmlzTWFzc092ZXJPcGVuaW5nKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0b3JlIHRoZSBpbml0aWFsIGNvbmRpdGlvbnNcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVzZXQoKSB7XHJcbiAgICB0aGlzLnBvc2l0aW9uUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuaXNEcmFnZ2luZ1Byb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvLyBAcHJpdmF0ZSAtIGNoZWNrcyBpZiB0aGUgbWFzcyBpcyBvdmVyIHRoZSBsZWZ0IG9yIHRoZSByaWdodCBvcGVuaW5nXHJcbiAgaXNNYXNzT3Zlck9wZW5pbmcoKSB7XHJcbiAgICBjb25zdCBsZWZ0ID0gdGhpcy5wb3NpdGlvblByb3BlcnR5LnZhbHVlLng7XHJcbiAgICBjb25zdCByaWdodCA9IHRoaXMucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54ICsgdGhpcy53aWR0aCAvIDI7XHJcbiAgICBjb25zdCBkaW1lbnNpb25zID0gdGhpcy5jaGFtYmVyUG9vbE1vZGVsLnBvb2xEaW1lbnNpb25zO1xyXG4gICAgcmV0dXJuICggZGltZW5zaW9ucy5sZWZ0T3BlbmluZy54MSA8IGxlZnQgJiYgbGVmdCA8IGRpbWVuc2lvbnMubGVmdE9wZW5pbmcueDIgKSB8fFxyXG4gICAgICAgICAgICggZGltZW5zaW9ucy5sZWZ0T3BlbmluZy54MSA8IHJpZ2h0ICYmIHJpZ2h0IDwgZGltZW5zaW9ucy5sZWZ0T3BlbmluZy54MiApIHx8XHJcbiAgICAgICAgICAgKCBkaW1lbnNpb25zLnJpZ2h0T3BlbmluZy54MSA8IGxlZnQgJiYgbGVmdCA8IGRpbWVuc2lvbnMucmlnaHRPcGVuaW5nLngyICkgfHxcclxuICAgICAgICAgICAoIGRpbWVuc2lvbnMucmlnaHRPcGVuaW5nLngxIDwgcmlnaHQgJiYgcmlnaHQgPCBkaW1lbnNpb25zLnJpZ2h0T3BlbmluZy54MiApO1xyXG4gIH1cclxufVxyXG5cclxuZmx1aWRQcmVzc3VyZUFuZEZsb3cucmVnaXN0ZXIoICdNYXNzTW9kZWwnLCBNYXNzTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgTWFzc01vZGVsOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFFBQVEsTUFBTSxpQ0FBaUM7QUFDdEQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLGVBQWUsTUFBTSx1Q0FBdUM7QUFDbkUsT0FBT0Msb0JBQW9CLE1BQU0sK0JBQStCOztBQUVoRTtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLElBQUk7QUFFaEMsTUFBTUMsU0FBUyxDQUFDO0VBRWQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFQyxXQUFXQSxDQUFFQyxnQkFBZ0IsRUFBRUMsSUFBSSxFQUFFQyxDQUFDLEVBQUVDLENBQUMsRUFBRUMsS0FBSyxFQUFFQyxNQUFNLEVBQUc7SUFFekQsSUFBSSxDQUFDTCxnQkFBZ0IsR0FBR0EsZ0JBQWdCO0lBQ3hDLElBQUksQ0FBQ0MsSUFBSSxHQUFHQSxJQUFJOztJQUVoQjtJQUNBLElBQUksQ0FBQ0csS0FBSyxHQUFHQSxLQUFLLENBQUMsQ0FBQztJQUNwQixJQUFJLENBQUNDLE1BQU0sR0FBR0EsTUFBTSxDQUFDLENBQUM7O0lBRXRCO0lBQ0E7SUFDQSxJQUFJLENBQUNDLGdCQUFnQixHQUFHLElB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