// Copyright 2014-2022, University of Colorado Boulder

/**
 * View for the handles on the pipe segment.
 * Handles on the left/right pipe segment are used for dragging the pipe up/down.
 *
 * @author Siddhartha Chinthapally (Actual Concepts).
 */

import Utils from '../../../../dot/js/Utils.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { Node, SimpleDragHandler } from '../../../../scenery/js/imports.js';
import fluidPressureAndFlow from '../../fluidPressureAndFlow.js';

// constants
const CONTROL_HANDLE_OFFSET = 2;
const PIPE_INITIAL_HEIGHT = 2.1; //in meters
const PIPE_INITIAL_SCALE = 0.36;
class PipeMainDragHandle extends Node {
  /**
   * @param {PipeHandlesNode} pipeHandlesNode
   * @param {string} dragHandlePosition indicates whether it is left or right. Can take values 'left' or 'right'
   * @param {ModelViewTransform2} modelViewTransform to convert between model and view co-ordinate frames
   */
  constructor(pipeHandlesNode, dragHandlePosition, modelViewTransform) {
    super();
    const pipeNode = pipeHandlesNode.pipeNode;
    const flowModel = pipeHandlesNode.flowModel;
    const pipe = flowModel.pipe;
    const leftTopControlPointIndex = 1;
    const leftBottomControlPointIndex = 1;
    const rightTopControlPointIndex = pipe.top.length - 2;
    const rightBottomControlPointIndex = pipe.bottom.length - 2;
    let initialMainHandleY;
    let dragStartY;

    // left and right side of pipe main handles dragging
    pipeHandlesNode.pipeMainDragHandles[dragHandlePosition].addInputListener(new SimpleDragHandler({
      start: event => {
        dragStartY = pipeHandlesNode.pipeMainDragHandles[dragHandlePosition].globalToParentPoint(event.pointer.point).y;
        initialMainHandleY = dragHandlePosition === 'left' ? pipeNode.leftPipeNode.centerY : pipeNode.rightPipeNode.centerY;
      },
      drag: event => {
        const currentDragPoint = pipeHandlesNode.pipeMainDragHandles[dragHandlePosition].globalToParentPoint(event.pointer.point);
        const offSetY = currentDragPoint.y - dragStartY;
        const pt = modelViewTransform.viewToModelPosition(currentDragPoint);
        pt.y = modelViewTransform.viewToModelY(initialMainHandleY + offSetY);

        // limit the pipe drag between [ -3, -1 ]
        pt.y = Utils.clamp(pt.y, -3, -1);
        let yUp;
        let yLow;
        let x;
        if (dragHandlePosition === 'left') {
          // Left handle
          // calculate top and bottom control point positions
          yUp = pt.y + pipe.leftPipeScaleProperty.value / PIPE_INITIAL_SCALE * PIPE_INITIAL_HEIGHT / 2;
          yLow = pt.y - pipe.leftPipeScaleProperty.value / PIPE_INITIAL_SCALE * PIPE_INITIAL_HEIGHT / 2;

          // set the left pipe top and bottom control point
          x = pipe.top[leftTopControlPointIndex].positionProperty.value.x;
          pipe.top[leftTopControlPointIndex].positionProperty.value = new Vector2(x, yUp);
          pipe.bottom[leftBottomControlPointIndex].positionProperty.value = new Vector2(x, yLow);
          pipe.leftPipeYPositionProperty.value = modelViewTransform.modelToViewY(pipe.top[leftTopControlPointIndex].positionProperty.value.y) - pipeNode.leftPipeYOffset * pipe.leftPipeScaleProperty.value;

          // set the left pipe  top/bottom control point handle positions
          pipe.leftPipeTopHandleYProperty.value = pipeNode.leftPipeNode.top + CONTROL_HANDLE_OFFSET;
          pipe.leftPipeBottomHandleYProperty.value = pipeNode.leftPipeNode.bottom - CONTROL_HANDLE_OFFSET;
          flowModel.pipe.leftPipeMainHandleYPositionProperty.value = pipeNode.leftPipeNode.centerY;
        } else {
          // Right handle
          // calculate  top and bottom control point positions
          yUp = pt.y + pipe.rightPipeScaleProperty.value / PIPE_INITIAL_SCALE * PIPE_INITIAL_HEIGHT / 2;
          yLow = pt.y - pipe.rightPipeScaleProperty.value / PIPE_INITIAL_SCALE * PIPE_INITIAL_HEIGHT / 2;

          // set the right pipe top and bottom control points positions
          x = pipe.top[rightTopControlPointIndex].positionProperty.value.x;
          pipe.top[rightTopControlPointIndex].positionProperty.value = new Vector2(x, yUp);
          pipe.bottom[rightBottomControlPointIndex].positionProperty.value = new Vector2(x, yLow);
          pipe.rightPipeYPositionProperty.value = modelViewTransform.modelToViewY(pipe.top[rightTopControlPointIndex].positionProperty.value.y) - pipeNode.rightPipeYOffset * pipe.rightPipeScaleProperty.value;

          // set the right pipe top/bottom control point handle positions
          pipe.rightPipeTopHandleYProperty.value = pipeNode.rightPipeNode.top + CONTROL_HANDLE_OFFSET;
          pipe.rightPipeBottomHandleYProperty.value = pipeNode.rightPipeNode.bottom - CONTROL_HANDLE_OFFSET;
          flowModel.pipe.rightPipeMainHandleYPositionProperty.value = pipeNode.rightPipeNode.centerY;
        }

        // reposition the particles when the sim is paused and the handle is dragged
        if (!flowModel.isPlayingProperty.value) {
          pipeNode.particlesLayer.step();
        }

        // When a control point is dragged, update the pipe flow line shape and the node shape
        pipe.dirty = true;
        pipeNode.updatePipeFlowLineShape();
        flowModel.fluxMeter.updateEmitter.emit();

        // update the velocity sensors
        flowModel.speedometers.forEach(speedometer => {
          speedometer.updateEmitter.emit();
        });

        // update the barometers
        flowModel.barometers.forEach(barometer => {
          barometer.updateEmitter.emit();
        });
        pipeHandlesNode.gridInjectorNode.updateGridInjector();
      }
    }));
  }
}
fluidPressureAndFlow.register('PipeMainDragHandle', PipeMainDragHandle);
export default PipeMainDragHandle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlZlY3RvcjIiLCJOb2RlIiwiU2ltcGxlRHJhZ0hhbmRsZXIiLCJmbHVpZFByZXNzdXJlQW5kRmxvdyIsIkNPTlRST0xfSEFORExFX09GRlNFVCIsIlBJUEVfSU5JVElBTF9IRUlHSFQiLCJQSVBFX0lOSVRJQUxfU0NBTEUiLCJQaXBlTWFpbkRyYWdIYW5kbGUiLCJjb25zdHJ1Y3RvciIsInBpcGVIYW5kbGVzTm9kZSIsImRyYWdIYW5kbGVQb3NpdGlvbiIsIm1vZGVsVmlld1RyYW5zZm9ybSIsInBpcGVOb2RlIiwiZmxvd01vZGVsIiwicGlwZSIsImxlZnRUb3BDb250cm9sUG9pbnRJbmRleCIsImxlZnRCb3R0b21Db250cm9sUG9pbnRJbmRleCIsInJpZ2h0VG9wQ29udHJvbFBvaW50SW5kZXgiLCJ0b3AiLCJsZW5ndGgiLCJyaWdodEJvdHRvbUNvbnRyb2xQb2ludEluZGV4IiwiYm90dG9tIiwiaW5pdGlhbE1haW5IYW5kbGVZIiwiZHJhZ1N0YXJ0WSIsInBpcGVNYWluRHJhZ0hhbmRsZXMiLCJhZGRJbnB1dExpc3RlbmVyIiwic3RhcnQiLCJldmVudCIsImdsb2JhbFRvUGFyZW50UG9pbnQiLCJwb2ludGVyIiwicG9pbnQiLCJ5IiwibGVmdFBpcGVOb2RlIiwiY2VudGVyWSIsInJpZ2h0UGlwZU5vZGUiLCJkcmFnIiwiY3VycmVudERyYWdQb2ludCIsIm9mZlNldFkiLCJwdCIsInZpZXdUb01vZGVsUG9zaXRpb24iLCJ2aWV3VG9Nb2RlbFkiLCJjbGFtcCIsInlVcCIsInlMb3ciLCJ4IiwibGVmdFBpcGVTY2FsZVByb3BlcnR5IiwidmFsdWUiLCJwb3NpdGlvblByb3BlcnR5IiwibGVmdFBpcGVZUG9zaXRpb25Qcm9wZXJ0eSIsIm1vZGVsVG9WaWV3WSIsImxlZnRQaXBlWU9mZnNldCIsImxlZnRQaXBlVG9wSGFuZGxlWVByb3BlcnR5IiwibGVmdFBpcGVCb3R0b21IYW5kbGVZUHJvcGVydHkiLCJsZWZ0UGlwZU1haW5IYW5kbGVZUG9zaXRpb25Qcm9wZXJ0eSIsInJpZ2h0UGlwZVNjYWxlUHJvcGVydHkiLCJyaWdodFBpcGVZUG9zaXRpb25Qcm9wZXJ0eSIsInJpZ2h0UGlwZVlPZmZzZXQiLCJyaWdodFBpcGVUb3BIYW5kbGVZUHJvcGVydHkiLCJyaWdodFBpcGVCb3R0b21IYW5kbGVZUHJvcGVydHkiLCJyaWdodFBpcGVNYWluSGFuZGxlWVBvc2l0aW9uUHJvcGVydHkiLCJpc1BsYXlpbmdQcm9wZXJ0eSIsInBhcnRpY2xlc0xheWVyIiwic3RlcCIsImRpcnR5IiwidXBkYXRlUGlwZUZsb3dMaW5lU2hhcGUiLCJmbHV4TWV0ZXIiLCJ1cGRhdGVFbWl0dGVyIiwiZW1pdCIsInNwZWVkb21ldGVycyIsImZvckVhY2giLCJzcGVlZG9tZXRlciIsImJhcm9tZXRlcnMiLCJiYXJvbWV0ZXIiLCJncmlkSW5qZWN0b3JOb2RlIiwidXBkYXRlR3JpZEluamVjdG9yIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJQaXBlTWFpbkRyYWdIYW5kbGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlldyBmb3IgdGhlIGhhbmRsZXMgb24gdGhlIHBpcGUgc2VnbWVudC5cclxuICogSGFuZGxlcyBvbiB0aGUgbGVmdC9yaWdodCBwaXBlIHNlZ21lbnQgYXJlIHVzZWQgZm9yIGRyYWdnaW5nIHRoZSBwaXBlIHVwL2Rvd24uXHJcbiAqXHJcbiAqIEBhdXRob3IgU2lkZGhhcnRoYSBDaGludGhhcGFsbHkgKEFjdHVhbCBDb25jZXB0cykuXHJcbiAqL1xyXG5cclxuaW1wb3J0IFV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9VdGlscy5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgU2ltcGxlRHJhZ0hhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgZmx1aWRQcmVzc3VyZUFuZEZsb3cgZnJvbSAnLi4vLi4vZmx1aWRQcmVzc3VyZUFuZEZsb3cuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IENPTlRST0xfSEFORExFX09GRlNFVCA9IDI7XHJcbmNvbnN0IFBJUEVfSU5JVElBTF9IRUlHSFQgPSAyLjE7IC8vaW4gbWV0ZXJzXHJcbmNvbnN0IFBJUEVfSU5JVElBTF9TQ0FMRSA9IDAuMzY7XHJcblxyXG5jbGFzcyBQaXBlTWFpbkRyYWdIYW5kbGUgZXh0ZW5kcyBOb2RlIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtQaXBlSGFuZGxlc05vZGV9IHBpcGVIYW5kbGVzTm9kZVxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkcmFnSGFuZGxlUG9zaXRpb24gaW5kaWNhdGVzIHdoZXRoZXIgaXQgaXMgbGVmdCBvciByaWdodC4gQ2FuIHRha2UgdmFsdWVzICdsZWZ0JyBvciAncmlnaHQnXHJcbiAgICogQHBhcmFtIHtNb2RlbFZpZXdUcmFuc2Zvcm0yfSBtb2RlbFZpZXdUcmFuc2Zvcm0gdG8gY29udmVydCBiZXR3ZWVuIG1vZGVsIGFuZCB2aWV3IGNvLW9yZGluYXRlIGZyYW1lc1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBwaXBlSGFuZGxlc05vZGUsIGRyYWdIYW5kbGVQb3NpdGlvbiwgbW9kZWxWaWV3VHJhbnNmb3JtICkge1xyXG5cclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgY29uc3QgcGlwZU5vZGUgPSBwaXBlSGFuZGxlc05vZGUucGlwZU5vZGU7XHJcbiAgICBjb25zdCBmbG93TW9kZWwgPSBwaXBlSGFuZGxlc05vZGUuZmxvd01vZGVsO1xyXG4gICAgY29uc3QgcGlwZSA9IGZsb3dNb2RlbC5waXBlO1xyXG5cclxuICAgIGNvbnN0IGxlZnRUb3BDb250cm9sUG9pbnRJbmRleCA9IDE7XHJcbiAgICBjb25zdCBsZWZ0Qm90dG9tQ29udHJvbFBvaW50SW5kZXggPSAxO1xyXG4gICAgY29uc3QgcmlnaHRUb3BDb250cm9sUG9pbnRJbmRleCA9IHBpcGUudG9wLmxlbmd0aCAtIDI7XHJcbiAgICBjb25zdCByaWdodEJvdHRvbUNvbnRyb2xQb2ludEluZGV4ID0gcGlwZS5ib3R0b20ubGVuZ3RoIC0gMjtcclxuXHJcbiAgICBsZXQgaW5pdGlhbE1haW5IYW5kbGVZO1xyXG4gICAgbGV0IGRyYWdTdGFydFk7XHJcblxyXG4gICAgLy8gbGVmdCBhbmQgcmlnaHQgc2lkZSBvZiBwaXBlIG1haW4gaGFuZGxlcyBkcmFnZ2luZ1xyXG4gICAgcGlwZUhhbmRsZXNOb2RlLnBpcGVNYWluRHJhZ0hhbmRsZXNbIGRyYWdIYW5kbGVQb3NpdGlvbiBdLmFkZElucHV0TGlzdGVuZXIoIG5ldyBTaW1wbGVEcmFnSGFuZGxlcigge1xyXG5cclxuICAgICAgc3RhcnQ6IGV2ZW50ID0+IHtcclxuICAgICAgICBkcmFnU3RhcnRZID0gcGlwZUhhbmRsZXNOb2RlLnBpcGVNYWluRHJhZ0hhbmRsZXNbIGRyYWdIYW5kbGVQb3NpdGlvbiBdLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKS55O1xyXG4gICAgICAgIGluaXRpYWxNYWluSGFuZGxlWSA9IGRyYWdIYW5kbGVQb3NpdGlvbiA9PT0gJ2xlZnQnID8gcGlwZU5vZGUubGVmdFBpcGVOb2RlLmNlbnRlclkgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVOb2RlLnJpZ2h0UGlwZU5vZGUuY2VudGVyWTtcclxuICAgICAgfSxcclxuICAgICAgZHJhZzogZXZlbnQgPT4ge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnREcmFnUG9pbnQgPSBwaXBlSGFuZGxlc05vZGUucGlwZU1haW5EcmFnSGFuZGxlc1sgZHJhZ0hhbmRsZVBvc2l0aW9uIF0uZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApO1xyXG4gICAgICAgIGNvbnN0IG9mZlNldFkgPSBjdXJyZW50RHJhZ1BvaW50LnkgLSBkcmFnU3RhcnRZO1xyXG4gICAgICAgIGNvbnN0IHB0ID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIGN1cnJlbnREcmFnUG9pbnQgKTtcclxuICAgICAgICBwdC55ID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsWSggaW5pdGlhbE1haW5IYW5kbGVZICsgb2ZmU2V0WSApO1xyXG5cclxuICAgICAgICAvLyBsaW1pdCB0aGUgcGlwZSBkcmFnIGJldHdlZW4gWyAtMywgLTEgXVxyXG4gICAgICAgIHB0LnkgPSBVdGlscy5jbGFtcCggcHQueSwgLTMsIC0xICk7XHJcblxyXG4gICAgICAgIGxldCB5VXA7XHJcbiAgICAgICAgbGV0IHlMb3c7XHJcbiAgICAgICAgbGV0IHg7XHJcbiAgICAgICAgaWYgKCBkcmFnSGFuZGxlUG9zaXRpb24gPT09ICdsZWZ0JyApIHtcclxuICAgICAgICAgIC8vIExlZnQgaGFuZGxlXHJcbiAgICAgICAgICAvLyBjYWxjdWxhdGUgdG9wIGFuZCBib3R0b20gY29udHJvbCBwb2ludCBwb3NpdGlvbnNcclxuICAgICAgICAgIHlVcCA9IHB0LnkgKyBwaXBlLmxlZnRQaXBlU2NhbGVQcm9wZXJ0eS52YWx1ZSAvIFBJUEVfSU5JVElBTF9TQ0FMRSAqIFBJUEVfSU5JVElBTF9IRUlHSFQgLyAyO1xyXG4gICAgICAgICAgeUxvdyA9IHB0LnkgLSBwaXBlLmxlZnRQaXBlU2NhbGVQcm9wZXJ0eS52YWx1ZSAvIFBJUEVfSU5JVElBTF9TQ0FMRSAqIFBJUEVfSU5JVElBTF9IRUlHSFQgLyAyO1xyXG5cclxuICAgICAgICAgIC8vIHNldCB0aGUgbGVmdCBwaXBlIHRvcCBhbmQgYm90dG9tIGNvbnRyb2wgcG9pbnRcclxuICAgICAgICAgIHggPSBwaXBlLnRvcFsgbGVmdFRvcENvbnRyb2xQb2ludEluZGV4IF0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54O1xyXG4gICAgICAgICAgcGlwZS50b3BbIGxlZnRUb3BDb250cm9sUG9pbnRJbmRleCBdLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBuZXcgVmVjdG9yMiggeCwgeVVwICk7XHJcbiAgICAgICAgICBwaXBlLmJvdHRvbVsgbGVmdEJvdHRvbUNvbnRyb2xQb2ludEluZGV4IF0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IG5ldyBWZWN0b3IyKCB4LCB5TG93ICk7XHJcblxyXG4gICAgICAgICAgcGlwZS5sZWZ0UGlwZVlQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WSggcGlwZS50b3BbIGxlZnRUb3BDb250cm9sUG9pbnRJbmRleCBdLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSApIC1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpcGVOb2RlLmxlZnRQaXBlWU9mZnNldCAqIHBpcGUubGVmdFBpcGVTY2FsZVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgICAgIC8vIHNldCB0aGUgbGVmdCBwaXBlICB0b3AvYm90dG9tIGNvbnRyb2wgcG9pbnQgaGFuZGxlIHBvc2l0aW9uc1xyXG4gICAgICAgICAgcGlwZS5sZWZ0UGlwZVRvcEhhbmRsZVlQcm9wZXJ0eS52YWx1ZSA9IHBpcGVOb2RlLmxlZnRQaXBlTm9kZS50b3AgKyBDT05UUk9MX0hBTkRMRV9PRkZTRVQ7XHJcbiAgICAgICAgICBwaXBlLmxlZnRQaXBlQm90dG9tSGFuZGxlWVByb3BlcnR5LnZhbHVlID0gcGlwZU5vZGUubGVmdFBpcGVOb2RlLmJvdHRvbSAtIENPTlRST0xfSEFORExFX09GRlNFVDtcclxuICAgICAgICAgIGZsb3dNb2RlbC5waXBlLmxlZnRQaXBlTWFpbkhhbmRsZVlQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gcGlwZU5vZGUubGVmdFBpcGVOb2RlLmNlbnRlclk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgLy8gUmlnaHQgaGFuZGxlXHJcbiAgICAgICAgICAvLyBjYWxjdWxhdGUgIHRvcCBhbmQgYm90dG9tIGNvbnRyb2wgcG9pbnQgcG9zaXRpb25zXHJcbiAgICAgICAgICB5VXAgPSBwdC55ICsgKCBwaXBlLnJpZ2h0UGlwZVNjYWxlUHJvcGVydHkudmFsdWUgLyBQSVBFX0lOSVRJQUxfU0NBTEUgKSAqIFBJUEVfSU5JVElBTF9IRUlHSFQgLyAyO1xyXG4gICAgICAgICAgeUxvdyA9IHB0LnkgLSAoIHBpcGUucmlnaHRQaXBlU2NhbGVQcm9wZXJ0eS52YWx1ZSAvIFBJUEVfSU5JVElBTF9TQ0FMRSApICogUElQRV9JTklUSUFMX0hFSUdIVCAvIDI7XHJcblxyXG4gICAgICAgICAgLy8gc2V0IHRoZSByaWdodCBwaXBlIHRvcCBhbmQgYm90dG9tIGNvbnRyb2wgcG9pbnRzIHBvc2l0aW9uc1xyXG4gICAgICAgICAgeCA9IHBpcGUudG9wWyByaWdodFRvcENvbnRyb2xQb2ludEluZGV4IF0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS54O1xyXG4gICAgICAgICAgcGlwZS50b3BbIHJpZ2h0VG9wQ29udHJvbFBvaW50SW5kZXggXS5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIHgsIHlVcCApO1xyXG4gICAgICAgICAgcGlwZS5ib3R0b21bIHJpZ2h0Qm90dG9tQ29udHJvbFBvaW50SW5kZXggXS5wb3NpdGlvblByb3BlcnR5LnZhbHVlID0gbmV3IFZlY3RvcjIoIHgsIHlMb3cgKTtcclxuICAgICAgICAgIHBpcGUucmlnaHRQaXBlWVBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdZKCBwaXBlLnRvcFsgcmlnaHRUb3BDb250cm9sUG9pbnRJbmRleCBdLnBvc2l0aW9uUHJvcGVydHkudmFsdWUueSApIC1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXBlTm9kZS5yaWdodFBpcGVZT2Zmc2V0ICogcGlwZS5yaWdodFBpcGVTY2FsZVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgICAgICAgIC8vIHNldCB0aGUgcmlnaHQgcGlwZSB0b3AvYm90dG9tIGNvbnRyb2wgcG9pbnQgaGFuZGxlIHBvc2l0aW9uc1xyXG4gICAgICAgICAgcGlwZS5yaWdodFBpcGVUb3BIYW5kbGVZUHJvcGVydHkudmFsdWUgPSBwaXBlTm9kZS5yaWdodFBpcGVOb2RlLnRvcCArIENPTlRST0xfSEFORExFX09GRlNFVDtcclxuICAgICAgICAgIHBpcGUucmlnaHRQaXBlQm90dG9tSGFuZGxlWVByb3BlcnR5LnZhbHVlID0gcGlwZU5vZGUucmlnaHRQaXBlTm9kZS5ib3R0b20gLSBDT05UUk9MX0hBTkRMRV9PRkZTRVQ7XHJcblxyXG4gICAgICAgICAgZmxvd01vZGVsLnBpcGUucmlnaHRQaXBlTWFpbkhhbmRsZVlQb3NpdGlvblByb3BlcnR5LnZhbHVlID0gcGlwZU5vZGUucmlnaHRQaXBlTm9kZS5jZW50ZXJZO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcmVwb3NpdGlvbiB0aGUgcGFydGljbGVzIHdoZW4gdGhlIHNpbSBpcyBwYXVzZWQgYW5kIHRoZSBoYW5kbGUgaXMgZHJhZ2dlZFxyXG4gICAgICAgIGlmICggIWZsb3dNb2RlbC5pc1BsYXlpbmdQcm9wZXJ0eS52YWx1ZSApIHtcclxuICAgICAgICAgIHBpcGVOb2RlLnBhcnRpY2xlc0xheWVyLnN0ZXAoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFdoZW4gYSBjb250cm9sIHBvaW50IGlzIGRyYWdnZWQsIHVwZGF0ZSB0aGUgcGlwZSBmbG93IGxpbmUgc2hhcGUgYW5kIHRoZSBub2RlIHNoYXBlXHJcbiAgICAgICAgcGlwZS5kaXJ0eSA9IHRydWU7XHJcbiAgICAgICAgcGlwZU5vZGUudXBkYXRlUGlwZUZsb3dMaW5lU2hhcGUoKTtcclxuICAgICAgICBmbG93TW9kZWwuZmx1eE1ldGVyLnVwZGF0ZUVtaXR0ZXIuZW1pdCgpO1xyXG5cclxuICAgICAgICAvLyB1cGRhdGUgdGhlIHZlbG9jaXR5IHNlbnNvcnNcclxuICAgICAgICBmbG93TW9kZWwuc3BlZWRvbWV0ZXJzLmZvckVhY2goIHNwZWVkb21ldGVyID0+IHtcclxuICAgICAgICAgIHNwZWVkb21ldGVyLnVwZGF0ZUVtaXR0ZXIuZW1pdCgpO1xyXG4gICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgLy8gdXBkYXRlIHRoZSBiYXJvbWV0ZXJzXHJcbiAgICAgICAgZmxvd01vZGVsLmJhcm9tZXRlcnMuZm9yRWFjaCggYmFyb21ldGVyID0+IHtcclxuICAgICAgICAgIGJhcm9tZXRlci51cGRhdGVFbWl0dGVyLmVtaXQoKTtcclxuICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgIHBpcGVIYW5kbGVzTm9kZS5ncmlkSW5qZWN0b3JOb2RlLnVwZGF0ZUdyaWRJbmplY3RvcigpO1xyXG4gICAgICB9XHJcbiAgICB9ICkgKTtcclxuICB9XHJcbn1cclxuXHJcbmZsdWlkUHJlc3N1cmVBbmRGbG93LnJlZ2lzdGVyKCAnUGlwZU1haW5EcmFnSGFuZGxlJywgUGlwZU1haW5EcmFnSGFuZGxlICk7XHJcbmV4cG9ydCBkZWZhdWx0IFBpcGVNYWluRHJhZ0hhbmRsZTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsU0FBU0MsSUFBSSxFQUFFQyxpQkFBaUIsUUFBUSxtQ0FBbUM7QUFDM0UsT0FBT0Msb0JBQW9CLE1BQU0sK0JBQStCOztBQUVoRTtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLENBQUM7QUFDL0IsTUFBTUMsbUJBQW1CLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFDakMsTUFBTUMsa0JBQWtCLEdBQUcsSUFBSTtBQUUvQixNQUFNQyxrQkFBa0IsU0FBU04sSUFBSSxDQUFDO0VBRXBDO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7RUFDRU8sV0FBV0EsQ0FBRUMsZUFB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