// Copyright 2018-2023, University of Colorado Boulder

const fs = require('fs');
const puppeteer = require('puppeteer');
const puppeteerQUnit = require('./puppeteerQUnit');
const _ = require('../../../sherpa/lib/lodash-4.17.4');
const child_process = require('child_process');
(async () => {
  const groups = Number(process.argv[2]);
  const groupIndex = Number(process.argv[3]);
  const say = _.includes(process.argv, '--say');
  const browser = await puppeteer.launch();
  const readList = filename => fs.readFileSync(`../perennial/data/${filename}`, 'utf8').split('\n').filter(name => name.length > 0);
  const activeRepos = readList('active-repos');

  // Omit phet-io-wrappers because it yields a "Calling `done` after test has completed" error.
  const index = activeRepos.indexOf('phet-io-wrappers');
  activeRepos.splice(index, 1);
  const getUnitTestFile = repo => `../${repo}/${repo}-tests.html`;
  const getUnitTestURL = repo => {
    let suffix = '';
    if (repo === 'phet-io') {
      suffix = '&brand=phet-io';
    }

    // TODO: support arbitrary prefix for localhost (https://github.com/phetsims/aqua/issues/81)
    return `http://localhost/${repo}/${repo}-tests.html?ea${suffix}`;
  };

  // Find repos that have qunit tests by searching for them
  const unitTests = activeRepos.filter(repo => {
    return fs.existsSync(getUnitTestFile(repo)) && repo !== 'scenery' &&
    // Takes too long
    repo !== 'scenery-phet'; // Takes too long
  }).map(getUnitTestURL);
  const allTests = [];
  const pairs = [];

  // Run all unit tests
  unitTests.forEach(test => allTests.push({
    name: test,
    type: 'Unit Test',
    run: () => puppeteerQUnit(browser, test)
  }));
  const tests = _.partition(allTests, test => allTests.indexOf(test) % groups === groupIndex)[0];
  for (let i = 0; i < tests.length; i++) {
    const test = tests[i];
    const result = await test.run();
    pairs.push({
      test: test,
      result: result
    });
  }
  // const passedPairs = pairs.filter( pair => pair.result.ok );
  const failedPairs = pairs.filter(pair => !pair.result.ok);

  // console.log( `passed (${passedPairs.length})\n${passedPairs.map( pair => pair.test.type + ': ' + pair.test.name ).join( '\n' )}\n` );
  if (failedPairs.length > 0) {
    console.log(`failed (${failedPairs.length})\n${failedPairs.map(pair => `${pair.test.type}: ${pair.test.name}\n${JSON.stringify(pair.result)}`).join('\n')}\n`);
    say && child_process.execSync('say Unit test failed');
  } else {
    console.log(`completed ${pairs.length} unit tests, all passed`);
  }
  await browser.close();
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwdXBwZXRlZXIiLCJwdXBwZXRlZXJRVW5pdCIsIl8iLCJjaGlsZF9wcm9jZXNzIiwiZ3JvdXBzIiwiTnVtYmVyIiwicHJvY2VzcyIsImFyZ3YiLCJncm91cEluZGV4Iiwic2F5IiwiaW5jbHVkZXMiLCJicm93c2VyIiwibGF1bmNoIiwicmVhZExpc3QiLCJmaWxlbmFtZSIsInJlYWRGaWxlU3luYyIsInNwbGl0IiwiZmlsdGVyIiwibmFtZSIsImxlbmd0aCIsImFjdGl2ZVJlcG9zIiwiaW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwiZ2V0VW5pdFRlc3RGaWxlIiwicmVwbyIsImdldFVuaXRUZXN0VVJMIiwic3VmZml4IiwidW5pdFRlc3RzIiwiZXhpc3RzU3luYyIsIm1hcCIsImFsbFRlc3RzIiwicGFpcnMiLCJmb3JFYWNoIiwidGVzdCIsInB1c2giLCJ0eXBlIiwicnVuIiwidGVzdHMiLCJwYXJ0aXRpb24iLCJpIiwicmVzdWx0IiwiZmFpbGVkUGFpcnMiLCJwYWlyIiwib2siLCJjb25zb2xlIiwibG9nIiwiSlNPTiIsInN0cmluZ2lmeSIsImpvaW4iLCJleGVjU3luYyIsImNsb3NlIl0sInNvdXJjZXMiOlsidW5pdFRlc3RCYXRjaC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoICdmcycgKTtcclxuY29uc3QgcHVwcGV0ZWVyID0gcmVxdWlyZSggJ3B1cHBldGVlcicgKTtcclxuY29uc3QgcHVwcGV0ZWVyUVVuaXQgPSByZXF1aXJlKCAnLi9wdXBwZXRlZXJRVW5pdCcgKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoICcuLi8uLi8uLi9zaGVycGEvbGliL2xvZGFzaC00LjE3LjQnICk7XHJcbmNvbnN0IGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKCAnY2hpbGRfcHJvY2VzcycgKTtcclxuXHJcbiggYXN5bmMgKCkgPT4ge1xyXG5cclxuICBjb25zdCBncm91cHMgPSBOdW1iZXIoIHByb2Nlc3MuYXJndlsgMiBdICk7XHJcbiAgY29uc3QgZ3JvdXBJbmRleCA9IE51bWJlciggcHJvY2Vzcy5hcmd2WyAzIF0gKTtcclxuICBjb25zdCBzYXkgPSBfLmluY2x1ZGVzKCBwcm9jZXNzLmFyZ3YsICctLXNheScgKTtcclxuXHJcbiAgY29uc3QgYnJvd3NlciA9IGF3YWl0IHB1cHBldGVlci5sYXVuY2goKTtcclxuICBjb25zdCByZWFkTGlzdCA9IGZpbGVuYW1lID0+IGZzLnJlYWRGaWxlU3luYyggYC4uL3BlcmVubmlhbC9kYXRhLyR7ZmlsZW5hbWV9YCwgJ3V0ZjgnICkuc3BsaXQoICdcXG4nICkuZmlsdGVyKCBuYW1lID0+IG5hbWUubGVuZ3RoID4gMCApO1xyXG5cclxuICBjb25zdCBhY3RpdmVSZXBvcyA9IHJlYWRMaXN0KCAnYWN0aXZlLXJlcG9zJyApO1xyXG5cclxuICAvLyBPbWl0IHBoZXQtaW8td3JhcHBlcnMgYmVjYXVzZSBpdCB5aWVsZHMgYSBcIkNhbGxpbmcgYGRvbmVgIGFmdGVyIHRlc3QgaGFzIGNvbXBsZXRlZFwiIGVycm9yLlxyXG4gIGNvbnN0IGluZGV4ID0gYWN0aXZlUmVwb3MuaW5kZXhPZiggJ3BoZXQtaW8td3JhcHBlcnMnICk7XHJcbiAgYWN0aXZlUmVwb3Muc3BsaWNlKCBpbmRleCwgMSApO1xyXG5cclxuICBjb25zdCBnZXRVbml0VGVzdEZpbGUgPSByZXBvID0+IGAuLi8ke3JlcG99LyR7cmVwb30tdGVzdHMuaHRtbGA7XHJcbiAgY29uc3QgZ2V0VW5pdFRlc3RVUkwgPSByZXBvID0+IHtcclxuICAgIGxldCBzdWZmaXggPSAnJztcclxuICAgIGlmICggcmVwbyA9PT0gJ3BoZXQtaW8nICkge1xyXG4gICAgICBzdWZmaXggPSAnJmJyYW5kPXBoZXQtaW8nO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRPRE86IHN1cHBvcnQgYXJiaXRyYXJ5IHByZWZpeCBmb3IgbG9jYWxob3N0IChodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvYXF1YS9pc3N1ZXMvODEpXHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3QvJHtyZXBvfS8ke3JlcG99LXRlc3RzLmh0bWw/ZWEke3N1ZmZpeH1gO1xyXG4gIH07XHJcblxyXG4gIC8vIEZpbmQgcmVwb3MgdGhhdCBoYXZlIHF1bml0IHRlc3RzIGJ5IHNlYXJjaGluZyBmb3IgdGhlbVxyXG4gIGNvbnN0IHVuaXRUZXN0cyA9IGFjdGl2ZVJlcG9zLmZpbHRlciggcmVwbyA9PiB7XHJcbiAgICByZXR1cm4gZnMuZXhpc3RzU3luYyggZ2V0VW5pdFRlc3RGaWxlKCByZXBvICkgKSAmJlxyXG4gICAgICAgICAgIHJlcG8gIT09ICdzY2VuZXJ5JyAmJiAvLyBUYWtlcyB0b28gbG9uZ1xyXG4gICAgICAgICAgIHJlcG8gIT09ICdzY2VuZXJ5LXBoZXQnOyAvLyBUYWtlcyB0b28gbG9uZ1xyXG4gIH0gKS5tYXAoIGdldFVuaXRUZXN0VVJMICk7XHJcblxyXG4gIGNvbnN0IGFsbFRlc3RzID0gW107XHJcbiAgY29uc3QgcGFpcnMgPSBbXTtcclxuXHJcbiAgLy8gUnVuIGFsbCB1bml0IHRlc3RzXHJcbiAgdW5pdFRlc3RzLmZvckVhY2goIHRlc3QgPT4gYWxsVGVzdHMucHVzaCgge1xyXG4gICAgbmFtZTogdGVzdCxcclxuICAgIHR5cGU6ICdVbml0IFRlc3QnLFxyXG4gICAgcnVuOiAoKSA9PiBwdXBwZXRlZXJRVW5pdCggYnJvd3NlciwgdGVzdCApXHJcbiAgfSApICk7XHJcblxyXG4gIGNvbnN0IHRlc3RzID0gXy5wYXJ0aXRpb24oIGFsbFRlc3RzLCB0ZXN0ID0+IGFsbFRlc3RzLmluZGV4T2YoIHRlc3QgKSAlIGdyb3VwcyA9PT0gZ3JvdXBJbmRleCApWyAwIF07XHJcbiAgZm9yICggbGV0IGkgPSAwOyBpIDwgdGVzdHMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICBjb25zdCB0ZXN0ID0gdGVzdHNbIGkgXTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRlc3QucnVuKCk7XHJcbiAgICBwYWlycy5wdXNoKCB7IHRlc3Q6IHRlc3QsIHJlc3VsdDogcmVzdWx0IH0gKTtcclxuICB9XHJcbiAgLy8gY29uc3QgcGFzc2VkUGFpcnMgPSBwYWlycy5maWx0ZXIoIHBhaXIgPT4gcGFpci5yZXN1bHQub2sgKTtcclxuICBjb25zdCBmYWlsZWRQYWlycyA9IHBhaXJzLmZpbHRlciggcGFpciA9PiAhcGFpci5yZXN1bHQub2sgKTtcclxuXHJcbiAgLy8gY29uc29sZS5sb2coIGBwYXNzZWQgKCR7cGFzc2VkUGFpcnMubGVuZ3RofSlcXG4ke3Bhc3NlZFBhaXJzLm1hcCggcGFpciA9PiBwYWlyLnRlc3QudHlwZSArICc6ICcgKyBwYWlyLnRlc3QubmFtZSApLmpvaW4oICdcXG4nICl9XFxuYCApO1xyXG4gIGlmICggZmFpbGVkUGFpcnMubGVuZ3RoID4gMCApIHtcclxuICAgIGNvbnNvbGUubG9nKCBgZmFpbGVkICgke2ZhaWxlZFBhaXJzLmxlbmd0aH0pXFxuJHtmYWlsZWRQYWlycy5tYXAoIHBhaXIgPT4gYCR7cGFpci50ZXN0LnR5cGV9OiAke3BhaXIudGVzdC5uYW1lfVxcbiR7SlNPTi5zdHJpbmdpZnkoIHBhaXIucmVzdWx0ICl9YCApLmpvaW4oICdcXG4nICl9XFxuYCApO1xyXG4gICAgc2F5ICYmIGNoaWxkX3Byb2Nlc3MuZXhlY1N5bmMoICdzYXkgVW5pdCB0ZXN0IGZhaWxlZCcgKTtcclxuICB9XHJcbiAgZWxzZSB7XHJcbiAgICBjb25zb2xlLmxvZyggYGNvbXBsZXRlZCAke3BhaXJzLmxlbmd0aH0gdW5pdCB0ZXN0cywgYWxsIHBhc3NlZGAgKTtcclxuICB9XHJcblxyXG4gIGF3YWl0IGJyb3dzZXIuY2xvc2UoKTtcclxufSApKCk7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBR0EsTUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUUsSUFBSyxDQUFDO0FBQzFCLE1BQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFFLFdBQVks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