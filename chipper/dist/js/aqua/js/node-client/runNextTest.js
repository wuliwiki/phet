// Copyright 2023, University of Colorado Boulder

/**
 * Runs the next browser CT test
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const getNextTestInfo = require('./getNextTestInfo');
const runTest = require('./runTest');
const sendTestResult = require('./sendTestResult');
const winston = require('winston');

/**
 * Runs the next browser CT test
 * @public
 *
 * @param {Object} [options]
 * @returns {Promise}
 */
module.exports = async function (options) {
  const testInfo = await getNextTestInfo(options);
  winston.info('testInfo', JSON.stringify(testInfo));
  const attemptCount = 3;
  let attemptsLeft = attemptCount;
  let lastFailure;
  while (attemptsLeft-- > 0) {
    try {
      await runTest(testInfo, options);
      winston.debug('runTest completed');
      return;
    } catch (e) {
      lastFailure = e;
    }
  }
  winston.info('FAILED TO RUN TEST');
  winston.info(await sendTestResult(`Tried to run ${attemptCount} times, never completed, failure: ${lastFailure}`, testInfo, false, options));
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXROZXh0VGVzdEluZm8iLCJyZXF1aXJlIiwicnVuVGVzdCIsInNlbmRUZXN0UmVzdWx0Iiwid2luc3RvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJvcHRpb25zIiwidGVzdEluZm8iLCJpbmZvIiwiSlNPTiIsInN0cmluZ2lmeSIsImF0dGVtcHRDb3VudCIsImF0dGVtcHRzTGVmdCIsImxhc3RGYWlsdXJlIiwiZGVidWciLCJlIl0sInNvdXJjZXMiOlsicnVuTmV4dFRlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFJ1bnMgdGhlIG5leHQgYnJvd3NlciBDVCB0ZXN0XHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5jb25zdCBnZXROZXh0VGVzdEluZm8gPSByZXF1aXJlKCAnLi9nZXROZXh0VGVzdEluZm8nICk7XHJcbmNvbnN0IHJ1blRlc3QgPSByZXF1aXJlKCAnLi9ydW5UZXN0JyApO1xyXG5jb25zdCBzZW5kVGVzdFJlc3VsdCA9IHJlcXVpcmUoICcuL3NlbmRUZXN0UmVzdWx0JyApO1xyXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSggJ3dpbnN0b24nICk7XHJcblxyXG4vKipcclxuICogUnVucyB0aGUgbmV4dCBicm93c2VyIENUIHRlc3RcclxuICogQHB1YmxpY1xyXG4gKlxyXG4gKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiggb3B0aW9ucyApIHtcclxuXHJcbiAgY29uc3QgdGVzdEluZm8gPSBhd2FpdCBnZXROZXh0VGVzdEluZm8oIG9wdGlvbnMgKTtcclxuICB3aW5zdG9uLmluZm8oICd0ZXN0SW5mbycsIEpTT04uc3RyaW5naWZ5KCB0ZXN0SW5mbyApICk7XHJcblxyXG4gIGNvbnN0IGF0dGVtcHRDb3VudCA9IDM7XHJcbiAgbGV0IGF0dGVtcHRzTGVmdCA9IGF0dGVtcHRDb3VudDtcclxuXHJcbiAgbGV0IGxhc3RGYWlsdXJlO1xyXG5cclxuICB3aGlsZSAoIGF0dGVtcHRzTGVmdC0tID4gMCApIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHJ1blRlc3QoIHRlc3RJbmZvLCBvcHRpb25zICk7XHJcbiAgICAgIHdpbnN0b24uZGVidWcoICdydW5UZXN0IGNvbXBsZXRlZCcgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY2F0Y2goIGUgKSB7XHJcbiAgICAgIGxhc3RGYWlsdXJlID0gZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHdpbnN0b24uaW5mbyggJ0ZBSUxFRCBUTyBSVU4gVEVTVCcgKTtcclxuICB3aW5zdG9uLmluZm8oIGF3YWl0IHNlbmRUZXN0UmVzdWx0KCBgVHJpZWQgdG8gcnVuICR7YXR0ZW1wdENvdW50fSB0aW1lcywgbmV2ZXIgY29tcGxldGVkLCBmYWlsdXJlOiAke2xhc3RGYWlsdXJlfWAsIHRlc3RJbmZvLCBmYWxzZSwgb3B0aW9ucyApICk7XHJcbn07XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxlQUFlLEdBQUdDLE9BQU8sQ0FBRSxtQkFBb0IsQ0FBQztBQUN0RCxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBRSxXQUFZLENBQUM7QUFDdEMsTUFBTUUsY0FBYyxHQUFHRixPQUFPLENBQUUsa0JBQW1CLENBQUM7QUFDcEQsTUFBTUcsT0FBTyxHQUFHSCxPQUFPLENBQUUsU0FBVSxDQUFDOztBQUVwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBSSxNQUFNLENBQUNDLE9BQU8sR0FBRyxnQkFBZ0JDLE9BQU8sRUFBRztFQUV6QyxNQUFNQyxRQUFRLEdBQUcsTUFBTVIsZUFBZSxDQUFFTyxPQUFRLENBQUM7RUFDakRILE9BQU8sQ0FBQ0ssSUFBSSxDQUFFLFVBQVUsRUFBRUMsSUFBSSxDQUFDQyxTQUFTLENBQUVILFFBQVMsQ0FBRSxDQUFDO0VBRXRELE1BQU1JLFlBQVksR0FBRyxDQUFDO0VBQ3RCLElBQUlDLFlBQVksR0FBR0QsWUFBWTtFQUUvQixJQUFJRSxXQUFXO0VBRWYsT0FBUUQsWUFBWSxFQUFFLEdBQUcsQ0FBQyxFQUFHO0lBQzNCLElBQUk7TUFDRixNQUFNWCxPQUFPLENBQUVNLFFBQVEsRUFBRUQsT0FBUSxDQUFDO01BQ2xDSCxPQUFPLENBQUNXLEtBQUssQ0FBRSxtQkFBb0IsQ0FBQztNQUNwQztJQUNGLENBQUMsQ0FDRCxPQUFPQyxDQUFDLEVBQUc7TUFDVEYsV0FBVyxHQUFHRSxDQUFDO0lBQ2pCO0VBQ0Y7RUFFQVosT0FBTyxDQUFDSyxJQUFJLENBQUUsb0JBQXFCLENBQUM7RUFDcENMLE9BQU8sQ0FBQ0ssSUFBSSxDQUFFLE1BQU1OLGNBQWMsQ0FBRyxnQkFBZVMsWUFBYSxxQ0FBb0NFLFdBQVksRUFBQyxFQUFFTixRQUFRLEVBQUUsS0FBSyxFQUFFRCxPQUFRLENBQUUsQ0FBQztBQUNsSixDQUFDIn0=