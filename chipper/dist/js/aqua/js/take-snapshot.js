// Copyright 2017-2022, University of Colorado Boulder

/**
 * Runs a snapshot for a specific sim (url) with a given seed. It will send a number of events, and will record
 * visual frames the desired number of times (with SHAs) and can send post-messages to communicate the events.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const options = QueryStringMachine.getAll({
  id: {
    type: 'number',
    defaultValue: 0
  },
  url: {
    type: 'string',
    defaultValue: '../../molecule-shapes/molecule-shapes_en.html'
  },
  simSeed: {
    type: 'number',
    defaultValue: 4 // Ideal constant taken from https://xkcd.com/221/, DO NOT CHANGE, it's random!
  },

  simWidth: {
    type: 'number',
    defaultValue: 1024 / 4
  },
  simHeight: {
    type: 'number',
    defaultValue: 768 / 4
  },
  // Note: always assumed to be something?
  simQueryParameters: {
    type: 'string',
    defaultValue: 'brand=phet&ea'
  },
  numFrames: {
    type: 'number',
    defaultValue: 100
  },
  compareDescription: {
    type: 'boolean',
    defaultValue: true
  }
});
const iframe = document.createElement('iframe');
iframe.setAttribute('frameborder', '0');
iframe.setAttribute('seamless', '1');
iframe.setAttribute('width', options.simWidth);
iframe.setAttribute('height', options.simHeight);
document.body.appendChild(iframe);
const queryParameters = `preserveDrawingBuffer&audio=disabled&preventFullScreen&randomSeed=${options.simSeed}&playbackMode=true&postMessageOnLoad&postMessageOnError&postMessageOnReady`;
iframe.src = `${options.url}?${options.simQueryParameters}&${queryParameters}`;
let isMouseDown = false;
let mouseLastMoved = false;
let mouseX = 0;
let mouseY = 0;
let random = null;
function sendStep(dt) {
  iframe.contentWindow.phet.joist.sim.stepSimulation(dt);
}
function sendMouseToggleEvent() {
  const input = iframe.contentWindow.phet.joist.display._input;
  const domEvent = iframe.contentWindow.document.createEvent('MouseEvent');

  // technically deprecated, but DOM4 event constructors not out yet. people on #whatwg said to use it
  domEvent.initMouseEvent(isMouseDown ? 'mouseup' : 'mousedown', true, true, iframe.contentWindow, 1,
  // click count
  mouseX, mouseY, mouseX, mouseY, false, false, false, false, 0,
  // button
  null);
  input.validatePointers();
  if (isMouseDown) {
    input.mouseUp(new iframe.contentWindow.phet.dot.Vector2(mouseX, mouseY), domEvent);
    isMouseDown = false;
  } else {
    input.mouseDown(null, new iframe.contentWindow.phet.dot.Vector2(mouseX, mouseY), domEvent);
    isMouseDown = true;
  }
  mouseLastMoved = false;
}
function sendMouseMoveEvent() {
  const input = iframe.contentWindow.phet.joist.display._input;
  mouseX = Math.floor(random.nextDouble() * iframe.contentWindow.phet.joist.display.width);
  mouseY = Math.floor(random.nextDouble() * iframe.contentWindow.phet.joist.display.height);

  // our move event
  const domEvent = iframe.contentWindow.document.createEvent('MouseEvent'); // not 'MouseEvents' according to DOM Level 3 spec

  // technically deprecated, but DOM4 event constructors not out yet. people on #whatwg said to use it
  domEvent.initMouseEvent('mousemove', true, true, iframe.contentWindow, 0,
  // click count
  mouseX, mouseY, mouseX, mouseY, false, false, false, false, 0,
  // button
  null);
  input.validatePointers();
  input.mouseMove(new iframe.contentWindow.phet.dot.Vector2(mouseX, mouseY), domEvent);
  mouseLastMoved = true;
}
function sendFuzz(averageEventQuantity) {
  let chance;

  // run a variable number of events, with a certain chance of bailing out (so no events are possible)
  // models a geometric distribution of events
  // See https://github.com/phetsims/joist/issues/343 for notes on the distribution.
  while ((chance = random.nextDouble()) < 1 - 1 / (averageEventQuantity + 1)) {
    if (chance < (mouseLastMoved ? 0.7 : 0.4)) {
      sendMouseToggleEvent();
    } else {
      sendMouseMoveEvent();
    }
  }
}
function getScreenshot(callback) {
  iframe.contentWindow.phet.joist.display.foreignObjectRasterization(url => {
    callback(url);
  });
}
function hash(str) {
  return new Hashes.MD5().hex(str);
}
let count = 0;
let frameHashes = '';
let loaded = false;
let received = true;
function handleFrame() {
  setTimeout(handleFrame, 0);
  if (loaded && received && count < options.numFrames) {
    count++;
    received = false;
    for (let i = 0; i < 10; i++) {
      sendFuzz(100);
      sendStep(random.nextDouble() * 0.5 + 0.016);
    }
    getScreenshot(screenshotURL => {
      const hashedScreenshotURL = hash(screenshotURL);
      console.log(count, hashedScreenshotURL);
      let concatHash = hashedScreenshotURL;
      const pdomData = {
        html: null,
        hash: null
      };
      const descriptionAlertData = {
        utterances: null,
        hash: null
      };
      const voicingResponseData = {
        utterances: null,
        hash: null
      };
      if (options.compareDescription && iframe.contentWindow.phet.joist.display.isAccessible()) {
        const pdomRoot = iframe.contentWindow.phet.joist.display.pdomRootElement;
        const pdomHTML = pdomRoot.outerHTML;
        pdomData.html = pdomHTML;
        const hashedPDOMHTML = hash(pdomHTML);
        pdomData.hash = hashedPDOMHTML;
        concatHash += hashedPDOMHTML;
        const descriptionUtteranceQueue = iframe.contentWindow.phet.joist.display.descriptionUtteranceQueue.queue;
        const utteranceTexts = descriptionUtteranceQueue.map(utteranceWrapper => utteranceWrapper.utterance.toString());
        descriptionAlertData.utterances = utteranceTexts;
        const utterancesHash = hash(utteranceTexts + '');
        descriptionAlertData.hash = utterancesHash;
        concatHash += utterancesHash;
        if (iframe.contentWindow.phet.scenery.voicingUtteranceQueue) {
          const voicingUtteranceQueue = iframe.contentWindow.phet.scenery.voicingUtteranceQueue.queue;
          const voicingUtteranceTexts = voicingUtteranceQueue.map(voicingUtteranceWrapper => voicingUtteranceWrapper.utterance.toString());
          voicingResponseData.utterances = voicingUtteranceTexts;
          const voicingUtterancesHash = hash(voicingUtteranceTexts + '');
          voicingResponseData.hash = voicingUtterancesHash;
          concatHash += voicingUtterancesHash;
        }
      }
      window.parent !== window && window.parent.postMessage(JSON.stringify({
        id: options.id,
        type: 'frameEmitted',
        number: count - 1,
        screenshot: {
          url: screenshotURL,
          hash: hashedScreenshotURL
        },
        pdom: pdomData,
        descriptionAlert: descriptionAlertData,
        voicing: voicingResponseData
      }), '*');
      received = true;
      frameHashes += concatHash;
      if (count === options.numFrames) {
        const fullHash = hash(frameHashes);
        window.parent !== window && window.parent.postMessage(JSON.stringify({
          id: options.id,
          type: 'snapshot',
          hash: fullHash,
          url: window.location.href
        }), '*');
        console.log(fullHash);
      }
    });
  }
}
handleFrame();

// Because of course direct calls to this go through this window object instead.
window.addEventListener('error', a => {
  let message = '';
  let stack = '';
  if (a && a.message) {
    message = a.message;
  }
  if (a && a.error && a.error.stack) {
    stack = a.error.stack;
  }
  window.parent !== window && window.parent.postMessage(JSON.stringify({
    id: options.id,
    type: 'error',
    message: message,
    stack: stack
  }), '*');
});

// handling messages from sims
window.addEventListener('message', evt => {
  if (typeof evt.data !== 'string') {
    return;
  }
  const data = JSON.parse(evt.data);

  // Sent by Joist due to the postMessage* query parameters
  if (data.type === 'ready') {
    console.log('ready');

    // Don't allow popups
    iframe.contentWindow.open = function () {
      return {
        focus: function () {},
        blur: function () {}
      };
    };
    // FileSaver don't allow popup
    iframe.contentWindow.saveAs = function () {};

    // We need to create an object with the iframe's Object.prototype as its prototype to pass our assertion checks
    const options = iframe.contentWindow.Object.create(iframe.contentWindow.Object.prototype, {
      seed: {
        value: 2.3,
        enumerable: true
      }
    });
    console.log(options);
    random = new iframe.contentWindow.phet.dot.Random(options);
    iframe.contentWindow.phet.joist.launchSimulation();
    iframe.contentWindow.phet.joist.display.interactive = false;
  } else if (data.type === 'load') {
    console.log('loaded');
    sendStep(0.016);
    loaded = true;
  } else if (data.type === 'error') {
    evt.data.id = options.id;
    window.parent && window.parent.postMessage(evt.data);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcHRpb25zIiwiUXVlcnlTdHJpbmdNYWNoaW5lIiwiZ2V0QWxsIiwiaWQiLCJ0eXBlIiwiZGVmYXVsdFZhbHVlIiwidXJsIiwic2ltU2VlZCIsInNpbVdpZHRoIiwic2ltSGVpZ2h0Iiwic2ltUXVlcnlQYXJhbWV0ZXJzIiwibnVtRnJhbWVzIiwiY29tcGFyZURlc2NyaXB0aW9uIiwiaWZyYW1lIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic2V0QXR0cmlidXRlIiwiYm9keSIsImFwcGVuZENoaWxkIiwicXVlcnlQYXJhbWV0ZXJzIiwic3JjIiwiaXNNb3VzZURvd24iLCJtb3VzZUxhc3RNb3ZlZCIsIm1vdXNlWCIsIm1vdXNlWSIsInJhbmRvbSIsInNlbmRTdGVwIiwiZHQiLCJjb250ZW50V2luZG93IiwicGhldCIsImpvaXN0Iiwic2ltIiwic3RlcFNpbXVsYXRpb24iLCJzZW5kTW91c2VUb2dnbGVFdmVudCIsImlucHV0IiwiZGlzcGxheSIsIl9pbnB1dCIsImRvbUV2ZW50IiwiY3JlYXRlRXZlbnQiLCJpbml0TW91c2VFdmVudCIsInZhbGlkYXRlUG9pbnRlcnMiLCJtb3VzZVVwIiwiZG90IiwiVmVjdG9yMiIsIm1vdXNlRG93biIsInNlbmRNb3VzZU1vdmVFdmVudCIsIk1hdGgiLCJmbG9vciIsIm5leHREb3VibGUiLCJ3aWR0aCIsImhlaWdodCIsIm1vdXNlTW92ZSIsInNlbmRGdXp6IiwiYXZlcmFnZUV2ZW50UXVhbnRpdHkiLCJjaGFuY2UiLCJnZXRTY3JlZW5zaG90IiwiY2FsbGJhY2siLCJmb3JlaWduT2JqZWN0UmFzdGVyaXphdGlvbiIsImhhc2giLCJzdHIiLCJIYXNoZXMiLCJNRDUiLCJoZXgiLCJjb3VudCIsImZyYW1lSGFzaGVzIiwibG9hZGVkIiwicmVjZWl2ZWQiLCJoYW5kbGVGcmFtZSIsInNldFRpbWVvdXQiLCJpIiwic2NyZWVuc2hvdFVSTCIsImhhc2hlZFNjcmVlbnNob3RVUkwiLCJjb25zb2xlIiwibG9nIiwiY29uY2F0SGFzaCIsInBkb21EYXRhIiwiaHRtbCIsImRlc2NyaXB0aW9uQWxlcnREYXRhIiwidXR0ZXJhbmNlcyIsInZvaWNpbmdSZXNwb25zZURhdGEiLCJpc0FjY2Vzc2libGUiLCJwZG9tUm9vdCIsInBkb21Sb290RWxlbWVudCIsInBkb21IVE1MIiwib3V0ZXJIVE1MIiwiaGFzaGVkUERPTUhUTUwiLCJkZXNjcmlwdGlvblV0dGVyYW5jZVF1ZXVlIiwicXVldWUiLCJ1dHRlcmFuY2VUZXh0cyIsIm1hcCIsInV0dGVyYW5jZVdyYXBwZXIiLCJ1dHRlcmFuY2UiLCJ0b1N0cmluZyIsInV0dGVyYW5jZXNIYXNoIiwic2NlbmVyeSIsInZvaWNpbmdVdHRlcmFuY2VRdWV1ZSIsInZvaWNpbmdVdHRlcmFuY2VUZXh0cyIsInZvaWNpbmdVdHRlcmFuY2VXcmFwcGVyIiwidm9pY2luZ1V0dGVyYW5jZXNIYXNoIiwid2luZG93IiwicGFyZW50IiwicG9zdE1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwibnVtYmVyIiwic2NyZWVuc2hvdCIsInBkb20iLCJkZXNjcmlwdGlvbkFsZXJ0Iiwidm9pY2luZyIsImZ1bGxIYXNoIiwibG9jYXRpb24iLCJocmVmIiwiYWRkRXZlbnRMaXN0ZW5lciIsImEiLCJtZXNzYWdlIiwic3RhY2siLCJlcnJvciIsImV2dCIsImRhdGEiLCJwYXJzZSIsIm9wZW4iLCJmb2N1cyIsImJsdXIiLCJzYXZlQXMiLCJPYmplY3QiLCJjcmVhdGUiLCJwcm90b3R5cGUiLCJzZWVkIiwidmFsdWUiLCJlbnVtZXJhYmxlIiwiUmFuZG9tIiwibGF1bmNoU2ltdWxhdGlvbiIsImludGVyYWN0aXZlIl0sInNvdXJjZXMiOlsidGFrZS1zbmFwc2hvdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBSdW5zIGEgc25hcHNob3QgZm9yIGEgc3BlY2lmaWMgc2ltICh1cmwpIHdpdGggYSBnaXZlbiBzZWVkLiBJdCB3aWxsIHNlbmQgYSBudW1iZXIgb2YgZXZlbnRzLCBhbmQgd2lsbCByZWNvcmRcclxuICogdmlzdWFsIGZyYW1lcyB0aGUgZGVzaXJlZCBudW1iZXIgb2YgdGltZXMgKHdpdGggU0hBcykgYW5kIGNhbiBzZW5kIHBvc3QtbWVzc2FnZXMgdG8gY29tbXVuaWNhdGUgdGhlIGV2ZW50cy5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcblxyXG5jb25zdCBvcHRpb25zID0gUXVlcnlTdHJpbmdNYWNoaW5lLmdldEFsbCgge1xyXG4gIGlkOiB7XHJcbiAgICB0eXBlOiAnbnVtYmVyJyxcclxuICAgIGRlZmF1bHRWYWx1ZTogMFxyXG4gIH0sXHJcbiAgdXJsOiB7XHJcbiAgICB0eXBlOiAnc3RyaW5nJyxcclxuICAgIGRlZmF1bHRWYWx1ZTogJy4uLy4uL21vbGVjdWxlLXNoYXBlcy9tb2xlY3VsZS1zaGFwZXNfZW4uaHRtbCdcclxuICB9LFxyXG4gIHNpbVNlZWQ6IHtcclxuICAgIHR5cGU6ICdudW1iZXInLFxyXG4gICAgZGVmYXVsdFZhbHVlOiA0IC8vIElkZWFsIGNvbnN0YW50IHRha2VuIGZyb20gaHR0cHM6Ly94a2NkLmNvbS8yMjEvLCBETyBOT1QgQ0hBTkdFLCBpdCdzIHJhbmRvbSFcclxuICB9LFxyXG4gIHNpbVdpZHRoOiB7XHJcbiAgICB0eXBlOiAnbnVtYmVyJyxcclxuICAgIGRlZmF1bHRWYWx1ZTogMTAyNCAvIDRcclxuICB9LFxyXG4gIHNpbUhlaWdodDoge1xyXG4gICAgdHlwZTogJ251bWJlcicsXHJcbiAgICBkZWZhdWx0VmFsdWU6IDc2OCAvIDRcclxuICB9LFxyXG4gIC8vIE5vdGU6IGFsd2F5cyBhc3N1bWVkIHRvIGJlIHNvbWV0aGluZz9cclxuICBzaW1RdWVyeVBhcmFtZXRlcnM6IHtcclxuICAgIHR5cGU6ICdzdHJpbmcnLFxyXG4gICAgZGVmYXVsdFZhbHVlOiAnYnJhbmQ9cGhldCZlYSdcclxuICB9LFxyXG4gIG51bUZyYW1lczoge1xyXG4gICAgdHlwZTogJ251bWJlcicsXHJcbiAgICBkZWZhdWx0VmFsdWU6IDEwMFxyXG4gIH0sXHJcbiAgY29tcGFyZURlc2NyaXB0aW9uOiB7XHJcbiAgICB0eXBlOiAnYm9vbGVhbicsXHJcbiAgICBkZWZhdWx0VmFsdWU6IHRydWVcclxuICB9XHJcbn0gKTtcclxuXHJcbmNvbnN0IGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdpZnJhbWUnICk7XHJcbmlmcmFtZS5zZXRBdHRyaWJ1dGUoICdmcmFtZWJvcmRlcicsICcwJyApO1xyXG5pZnJhbWUuc2V0QXR0cmlidXRlKCAnc2VhbWxlc3MnLCAnMScgKTtcclxuaWZyYW1lLnNldEF0dHJpYnV0ZSggJ3dpZHRoJywgb3B0aW9ucy5zaW1XaWR0aCApO1xyXG5pZnJhbWUuc2V0QXR0cmlidXRlKCAnaGVpZ2h0Jywgb3B0aW9ucy5zaW1IZWlnaHQgKTtcclxuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCggaWZyYW1lICk7XHJcblxyXG5jb25zdCBxdWVyeVBhcmFtZXRlcnMgPSBgcHJlc2VydmVEcmF3aW5nQnVmZmVyJmF1ZGlvPWRpc2FibGVkJnByZXZlbnRGdWxsU2NyZWVuJnJhbmRvbVNlZWQ9JHtvcHRpb25zLnNpbVNlZWR9JnBsYXliYWNrTW9kZT10cnVlJnBvc3RNZXNzYWdlT25Mb2FkJnBvc3RNZXNzYWdlT25FcnJvciZwb3N0TWVzc2FnZU9uUmVhZHlgO1xyXG5pZnJhbWUuc3JjID0gYCR7b3B0aW9ucy51cmx9PyR7b3B0aW9ucy5zaW1RdWVyeVBhcmFtZXRlcnN9JiR7cXVlcnlQYXJhbWV0ZXJzfWA7XHJcblxyXG5sZXQgaXNNb3VzZURvd24gPSBmYWxzZTtcclxubGV0IG1vdXNlTGFzdE1vdmVkID0gZmFsc2U7XHJcbmxldCBtb3VzZVggPSAwO1xyXG5sZXQgbW91c2VZID0gMDtcclxubGV0IHJhbmRvbSA9IG51bGw7XHJcblxyXG5mdW5jdGlvbiBzZW5kU3RlcCggZHQgKSB7XHJcbiAgaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5zaW0uc3RlcFNpbXVsYXRpb24oIGR0ICk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNlbmRNb3VzZVRvZ2dsZUV2ZW50KCkge1xyXG4gIGNvbnN0IGlucHV0ID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5kaXNwbGF5Ll9pbnB1dDtcclxuICBjb25zdCBkb21FdmVudCA9IGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50LmNyZWF0ZUV2ZW50KCAnTW91c2VFdmVudCcgKTtcclxuXHJcbiAgLy8gdGVjaG5pY2FsbHkgZGVwcmVjYXRlZCwgYnV0IERPTTQgZXZlbnQgY29uc3RydWN0b3JzIG5vdCBvdXQgeWV0LiBwZW9wbGUgb24gI3doYXR3ZyBzYWlkIHRvIHVzZSBpdFxyXG4gIGRvbUV2ZW50LmluaXRNb3VzZUV2ZW50KCBpc01vdXNlRG93biA/ICdtb3VzZXVwJyA6ICdtb3VzZWRvd24nLCB0cnVlLCB0cnVlLCBpZnJhbWUuY29udGVudFdpbmRvdywgMSwgLy8gY2xpY2sgY291bnRcclxuICAgIG1vdXNlWCwgbW91c2VZLCBtb3VzZVgsIG1vdXNlWSxcclxuICAgIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLFxyXG4gICAgMCwgLy8gYnV0dG9uXHJcbiAgICBudWxsICk7XHJcblxyXG4gIGlucHV0LnZhbGlkYXRlUG9pbnRlcnMoKTtcclxuXHJcbiAgaWYgKCBpc01vdXNlRG93biApIHtcclxuICAgIGlucHV0Lm1vdXNlVXAoIG5ldyBpZnJhbWUuY29udGVudFdpbmRvdy5waGV0LmRvdC5WZWN0b3IyKCBtb3VzZVgsIG1vdXNlWSApLCBkb21FdmVudCApO1xyXG4gICAgaXNNb3VzZURvd24gPSBmYWxzZTtcclxuICB9XHJcbiAgZWxzZSB7XHJcbiAgICBpbnB1dC5tb3VzZURvd24oIG51bGwsIG5ldyBpZnJhbWUuY29udGVudFdpbmRvdy5waGV0LmRvdC5WZWN0b3IyKCBtb3VzZVgsIG1vdXNlWSApLCBkb21FdmVudCApO1xyXG4gICAgaXNNb3VzZURvd24gPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgbW91c2VMYXN0TW92ZWQgPSBmYWxzZTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2VuZE1vdXNlTW92ZUV2ZW50KCkge1xyXG4gIGNvbnN0IGlucHV0ID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5kaXNwbGF5Ll9pbnB1dDtcclxuICBtb3VzZVggPSBNYXRoLmZsb29yKCByYW5kb20ubmV4dERvdWJsZSgpICogaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5kaXNwbGF5LndpZHRoICk7XHJcbiAgbW91c2VZID0gTWF0aC5mbG9vciggcmFuZG9tLm5leHREb3VibGUoKSAqIGlmcmFtZS5jb250ZW50V2luZG93LnBoZXQuam9pc3QuZGlzcGxheS5oZWlnaHQgKTtcclxuXHJcbiAgLy8gb3VyIG1vdmUgZXZlbnRcclxuICBjb25zdCBkb21FdmVudCA9IGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50LmNyZWF0ZUV2ZW50KCAnTW91c2VFdmVudCcgKTsgLy8gbm90ICdNb3VzZUV2ZW50cycgYWNjb3JkaW5nIHRvIERPTSBMZXZlbCAzIHNwZWNcclxuXHJcbiAgLy8gdGVjaG5pY2FsbHkgZGVwcmVjYXRlZCwgYnV0IERPTTQgZXZlbnQgY29uc3RydWN0b3JzIG5vdCBvdXQgeWV0LiBwZW9wbGUgb24gI3doYXR3ZyBzYWlkIHRvIHVzZSBpdFxyXG4gIGRvbUV2ZW50LmluaXRNb3VzZUV2ZW50KCAnbW91c2Vtb3ZlJywgdHJ1ZSwgdHJ1ZSwgaWZyYW1lLmNvbnRlbnRXaW5kb3csIDAsIC8vIGNsaWNrIGNvdW50XHJcbiAgICBtb3VzZVgsIG1vdXNlWSwgbW91c2VYLCBtb3VzZVksXHJcbiAgICBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSxcclxuICAgIDAsIC8vIGJ1dHRvblxyXG4gICAgbnVsbCApO1xyXG5cclxuICBpbnB1dC52YWxpZGF0ZVBvaW50ZXJzKCk7XHJcbiAgaW5wdXQubW91c2VNb3ZlKCBuZXcgaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5kb3QuVmVjdG9yMiggbW91c2VYLCBtb3VzZVkgKSwgZG9tRXZlbnQgKTtcclxuXHJcbiAgbW91c2VMYXN0TW92ZWQgPSB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZW5kRnV6eiggYXZlcmFnZUV2ZW50UXVhbnRpdHkgKSB7XHJcbiAgbGV0IGNoYW5jZTtcclxuXHJcbiAgLy8gcnVuIGEgdmFyaWFibGUgbnVtYmVyIG9mIGV2ZW50cywgd2l0aCBhIGNlcnRhaW4gY2hhbmNlIG9mIGJhaWxpbmcgb3V0IChzbyBubyBldmVudHMgYXJlIHBvc3NpYmxlKVxyXG4gIC8vIG1vZGVscyBhIGdlb21ldHJpYyBkaXN0cmlidXRpb24gb2YgZXZlbnRzXHJcbiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9qb2lzdC9pc3N1ZXMvMzQzIGZvciBub3RlcyBvbiB0aGUgZGlzdHJpYnV0aW9uLlxyXG4gIHdoaWxlICggKCBjaGFuY2UgPSByYW5kb20ubmV4dERvdWJsZSgpICkgPCAxIC0gMSAvICggYXZlcmFnZUV2ZW50UXVhbnRpdHkgKyAxICkgKSB7XHJcbiAgICBpZiAoIGNoYW5jZSA8ICggbW91c2VMYXN0TW92ZWQgPyAwLjcgOiAwLjQgKSApIHtcclxuICAgICAgc2VuZE1vdXNlVG9nZ2xlRXZlbnQoKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBzZW5kTW91c2VNb3ZlRXZlbnQoKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFNjcmVlbnNob3QoIGNhbGxiYWNrICkge1xyXG4gIGlmcmFtZS5jb250ZW50V2luZG93LnBoZXQuam9pc3QuZGlzcGxheS5mb3JlaWduT2JqZWN0UmFzdGVyaXphdGlvbiggdXJsID0+IHtcclxuICAgIGNhbGxiYWNrKCB1cmwgKTtcclxuICB9ICk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhc2goIHN0ciApIHtcclxuICByZXR1cm4gbmV3IEhhc2hlcy5NRDUoKS5oZXgoIHN0ciApO1xyXG59XHJcblxyXG5sZXQgY291bnQgPSAwO1xyXG5sZXQgZnJhbWVIYXNoZXMgPSAnJztcclxubGV0IGxvYWRlZCA9IGZhbHNlO1xyXG5sZXQgcmVjZWl2ZWQgPSB0cnVlO1xyXG5cclxuZnVuY3Rpb24gaGFuZGxlRnJhbWUoKSB7XHJcbiAgc2V0VGltZW91dCggaGFuZGxlRnJhbWUsIDAgKTtcclxuXHJcbiAgaWYgKCBsb2FkZWQgJiYgcmVjZWl2ZWQgJiYgY291bnQgPCBvcHRpb25zLm51bUZyYW1lcyApIHtcclxuICAgIGNvdW50Kys7XHJcbiAgICByZWNlaXZlZCA9IGZhbHNlO1xyXG5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IDEwOyBpKysgKSB7XHJcbiAgICAgIHNlbmRGdXp6KCAxMDAgKTtcclxuICAgICAgc2VuZFN0ZXAoIHJhbmRvbS5uZXh0RG91YmxlKCkgKiAwLjUgKyAwLjAxNiApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNjcmVlbnNob3QoIHNjcmVlbnNob3RVUkwgPT4ge1xyXG4gICAgICBjb25zdCBoYXNoZWRTY3JlZW5zaG90VVJMID0gaGFzaCggc2NyZWVuc2hvdFVSTCApO1xyXG4gICAgICBjb25zb2xlLmxvZyggY291bnQsIGhhc2hlZFNjcmVlbnNob3RVUkwgKTtcclxuXHJcbiAgICAgIGxldCBjb25jYXRIYXNoID0gaGFzaGVkU2NyZWVuc2hvdFVSTDtcclxuXHJcbiAgICAgIGNvbnN0IHBkb21EYXRhID0ge1xyXG4gICAgICAgIGh0bWw6IG51bGwsXHJcbiAgICAgICAgaGFzaDogbnVsbFxyXG4gICAgICB9O1xyXG4gICAgICBjb25zdCBkZXNjcmlwdGlvbkFsZXJ0RGF0YSA9IHtcclxuICAgICAgICB1dHRlcmFuY2VzOiBudWxsLFxyXG4gICAgICAgIGhhc2g6IG51bGxcclxuICAgICAgfTtcclxuICAgICAgY29uc3Qgdm9pY2luZ1Jlc3BvbnNlRGF0YSA9IHtcclxuICAgICAgICB1dHRlcmFuY2VzOiBudWxsLFxyXG4gICAgICAgIGhhc2g6IG51bGxcclxuICAgICAgfTtcclxuICAgICAgaWYgKCBvcHRpb25zLmNvbXBhcmVEZXNjcmlwdGlvbiAmJiBpZnJhbWUuY29udGVudFdpbmRvdy5waGV0LmpvaXN0LmRpc3BsYXkuaXNBY2Nlc3NpYmxlKCkgKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IHBkb21Sb290ID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5kaXNwbGF5LnBkb21Sb290RWxlbWVudDtcclxuICAgICAgICBjb25zdCBwZG9tSFRNTCA9IHBkb21Sb290Lm91dGVySFRNTDtcclxuICAgICAgICBwZG9tRGF0YS5odG1sID0gcGRvbUhUTUw7XHJcbiAgICAgICAgY29uc3QgaGFzaGVkUERPTUhUTUwgPSBoYXNoKCBwZG9tSFRNTCApO1xyXG4gICAgICAgIHBkb21EYXRhLmhhc2ggPSBoYXNoZWRQRE9NSFRNTDtcclxuICAgICAgICBjb25jYXRIYXNoICs9IGhhc2hlZFBET01IVE1MO1xyXG5cclxuICAgICAgICBjb25zdCBkZXNjcmlwdGlvblV0dGVyYW5jZVF1ZXVlID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5kaXNwbGF5LmRlc2NyaXB0aW9uVXR0ZXJhbmNlUXVldWUucXVldWU7XHJcbiAgICAgICAgY29uc3QgdXR0ZXJhbmNlVGV4dHMgPSBkZXNjcmlwdGlvblV0dGVyYW5jZVF1ZXVlLm1hcCggdXR0ZXJhbmNlV3JhcHBlciA9PiB1dHRlcmFuY2VXcmFwcGVyLnV0dGVyYW5jZS50b1N0cmluZygpICk7XHJcbiAgICAgICAgZGVzY3JpcHRpb25BbGVydERhdGEudXR0ZXJhbmNlcyA9IHV0dGVyYW5jZVRleHRzO1xyXG4gICAgICAgIGNvbnN0IHV0dGVyYW5jZXNIYXNoID0gaGFzaCggdXR0ZXJhbmNlVGV4dHMgKyAnJyApO1xyXG4gICAgICAgIGRlc2NyaXB0aW9uQWxlcnREYXRhLmhhc2ggPSB1dHRlcmFuY2VzSGFzaDtcclxuICAgICAgICBjb25jYXRIYXNoICs9IHV0dGVyYW5jZXNIYXNoO1xyXG5cclxuICAgICAgICBpZiAoIGlmcmFtZS5jb250ZW50V2luZG93LnBoZXQuc2NlbmVyeS52b2ljaW5nVXR0ZXJhbmNlUXVldWUgKSB7XHJcbiAgICAgICAgICBjb25zdCB2b2ljaW5nVXR0ZXJhbmNlUXVldWUgPSBpZnJhbWUuY29udGVudFdpbmRvdy5waGV0LnNjZW5lcnkudm9pY2luZ1V0dGVyYW5jZVF1ZXVlLnF1ZXVlO1xyXG4gICAgICAgICAgY29uc3Qgdm9pY2luZ1V0dGVyYW5jZVRleHRzID0gdm9pY2luZ1V0dGVyYW5jZVF1ZXVlLm1hcCggdm9pY2luZ1V0dGVyYW5jZVdyYXBwZXIgPT4gdm9pY2luZ1V0dGVyYW5jZVdyYXBwZXIudXR0ZXJhbmNlLnRvU3RyaW5nKCkgKTtcclxuICAgICAgICAgIHZvaWNpbmdSZXNwb25zZURhdGEudXR0ZXJhbmNlcyA9IHZvaWNpbmdVdHRlcmFuY2VUZXh0cztcclxuICAgICAgICAgIGNvbnN0IHZvaWNpbmdVdHRlcmFuY2VzSGFzaCA9IGhhc2goIHZvaWNpbmdVdHRlcmFuY2VUZXh0cyArICcnICk7XHJcbiAgICAgICAgICB2b2ljaW5nUmVzcG9uc2VEYXRhLmhhc2ggPSB2b2ljaW5nVXR0ZXJhbmNlc0hhc2g7XHJcbiAgICAgICAgICBjb25jYXRIYXNoICs9IHZvaWNpbmdVdHRlcmFuY2VzSGFzaDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcblxyXG4gICAgICAoIHdpbmRvdy5wYXJlbnQgIT09IHdpbmRvdyApICYmIHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2UoIEpTT04uc3RyaW5naWZ5KCB7XHJcbiAgICAgICAgaWQ6IG9wdGlvbnMuaWQsXHJcbiAgICAgICAgdHlwZTogJ2ZyYW1lRW1pdHRlZCcsXHJcbiAgICAgICAgbnVtYmVyOiBjb3VudCAtIDEsXHJcbiAgICAgICAgc2NyZWVuc2hvdDoge1xyXG4gICAgICAgICAgdXJsOiBzY3JlZW5zaG90VVJMLFxyXG4gICAgICAgICAgaGFzaDogaGFzaGVkU2NyZWVuc2hvdFVSTFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcGRvbTogcGRvbURhdGEsXHJcbiAgICAgICAgZGVzY3JpcHRpb25BbGVydDogZGVzY3JpcHRpb25BbGVydERhdGEsXHJcbiAgICAgICAgdm9pY2luZzogdm9pY2luZ1Jlc3BvbnNlRGF0YVxyXG4gICAgICB9ICksICcqJyApO1xyXG5cclxuICAgICAgcmVjZWl2ZWQgPSB0cnVlO1xyXG4gICAgICBmcmFtZUhhc2hlcyArPSBjb25jYXRIYXNoO1xyXG4gICAgICBpZiAoIGNvdW50ID09PSBvcHRpb25zLm51bUZyYW1lcyApIHtcclxuICAgICAgICBjb25zdCBmdWxsSGFzaCA9IGhhc2goIGZyYW1lSGFzaGVzICk7XHJcblxyXG4gICAgICAgICggd2luZG93LnBhcmVudCAhPT0gd2luZG93ICkgJiYgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSggSlNPTi5zdHJpbmdpZnkoIHtcclxuICAgICAgICAgIGlkOiBvcHRpb25zLmlkLFxyXG4gICAgICAgICAgdHlwZTogJ3NuYXBzaG90JyxcclxuICAgICAgICAgIGhhc2g6IGZ1bGxIYXNoLFxyXG4gICAgICAgICAgdXJsOiB3aW5kb3cubG9jYXRpb24uaHJlZlxyXG4gICAgICAgIH0gKSwgJyonICk7XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKCBmdWxsSGFzaCApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5oYW5kbGVGcmFtZSgpO1xyXG5cclxuLy8gQmVjYXVzZSBvZiBjb3Vyc2UgZGlyZWN0IGNhbGxzIHRvIHRoaXMgZ28gdGhyb3VnaCB0aGlzIHdpbmRvdyBvYmplY3QgaW5zdGVhZC5cclxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdlcnJvcicsIGEgPT4ge1xyXG4gIGxldCBtZXNzYWdlID0gJyc7XHJcbiAgbGV0IHN0YWNrID0gJyc7XHJcbiAgaWYgKCBhICYmIGEubWVzc2FnZSApIHtcclxuICAgIG1lc3NhZ2UgPSBhLm1lc3NhZ2U7XHJcbiAgfVxyXG4gIGlmICggYSAmJiBhLmVycm9yICYmIGEuZXJyb3Iuc3RhY2sgKSB7XHJcbiAgICBzdGFjayA9IGEuZXJyb3Iuc3RhY2s7XHJcbiAgfVxyXG4gICggd2luZG93LnBhcmVudCAhPT0gd2luZG93ICkgJiYgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSggSlNPTi5zdHJpbmdpZnkoIHtcclxuICAgIGlkOiBvcHRpb25zLmlkLFxyXG4gICAgdHlwZTogJ2Vycm9yJyxcclxuICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXHJcbiAgICBzdGFjazogc3RhY2tcclxuICB9ICksICcqJyApO1xyXG59ICk7XHJcblxyXG4vLyBoYW5kbGluZyBtZXNzYWdlcyBmcm9tIHNpbXNcclxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdtZXNzYWdlJywgZXZ0ID0+IHtcclxuICBpZiAoIHR5cGVvZiBldnQuZGF0YSAhPT0gJ3N0cmluZycgKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZSggZXZ0LmRhdGEgKTtcclxuXHJcbiAgLy8gU2VudCBieSBKb2lzdCBkdWUgdG8gdGhlIHBvc3RNZXNzYWdlKiBxdWVyeSBwYXJhbWV0ZXJzXHJcbiAgaWYgKCBkYXRhLnR5cGUgPT09ICdyZWFkeScgKSB7XHJcbiAgICBjb25zb2xlLmxvZyggJ3JlYWR5JyApO1xyXG5cclxuICAgIC8vIERvbid0IGFsbG93IHBvcHVwc1xyXG4gICAgaWZyYW1lLmNvbnRlbnRXaW5kb3cub3BlbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGZvY3VzOiBmdW5jdGlvbigpIHt9LFxyXG4gICAgICAgIGJsdXI6IGZ1bmN0aW9uKCkge31cclxuICAgICAgfTtcclxuICAgIH07XHJcbiAgICAvLyBGaWxlU2F2ZXIgZG9uJ3QgYWxsb3cgcG9wdXBcclxuICAgIGlmcmFtZS5jb250ZW50V2luZG93LnNhdmVBcyA9IGZ1bmN0aW9uKCkge307XHJcblxyXG4gICAgLy8gV2UgbmVlZCB0byBjcmVhdGUgYW4gb2JqZWN0IHdpdGggdGhlIGlmcmFtZSdzIE9iamVjdC5wcm90b3R5cGUgYXMgaXRzIHByb3RvdHlwZSB0byBwYXNzIG91ciBhc3NlcnRpb24gY2hlY2tzXHJcbiAgICBjb25zdCBvcHRpb25zID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cuT2JqZWN0LmNyZWF0ZSggaWZyYW1lLmNvbnRlbnRXaW5kb3cuT2JqZWN0LnByb3RvdHlwZSwge1xyXG4gICAgICBzZWVkOiB7XHJcbiAgICAgICAgdmFsdWU6IDIuMyxcclxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlXHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICAgIGNvbnNvbGUubG9nKCBvcHRpb25zICk7XHJcbiAgICByYW5kb20gPSBuZXcgaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5kb3QuUmFuZG9tKCBvcHRpb25zICk7XHJcblxyXG4gICAgaWZyYW1lLmNvbnRlbnRXaW5kb3cucGhldC5qb2lzdC5sYXVuY2hTaW11bGF0aW9uKCk7XHJcbiAgICBpZnJhbWUuY29udGVudFdpbmRvdy5waGV0LmpvaXN0LmRpc3BsYXkuaW50ZXJhY3RpdmUgPSBmYWxzZTtcclxuICB9XHJcbiAgZWxzZSBpZiAoIGRhdGEudHlwZSA9PT0gJ2xvYWQnICkge1xyXG4gICAgY29uc29sZS5sb2coICdsb2FkZWQnICk7XHJcbiAgICBzZW5kU3RlcCggMC4wMTYgKTtcclxuICAgIGxvYWRlZCA9IHRydWU7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCBkYXRhLnR5cGUgPT09ICdlcnJvcicgKSB7XHJcbiAgICBldnQuZGF0YS5pZCA9IG9wdGlvbnMuaWQ7XHJcbiAgICB3aW5kb3cucGFyZW50ICYmIHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2UoIGV2dC5kYXRhICk7XHJcbiAgfVxyXG59ICk7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztB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