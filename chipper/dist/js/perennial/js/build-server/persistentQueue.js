// Copyright 2023, University of Colorado Boulder

const fs = require('fs');
const _ = require('lodash');
const getQueue = () => {
  try {
    const queue = JSON.parse(fs.readFileSync('.build-server-queue').toString());
    if (!Array.isArray(queue)) {
      console.error('Queue is not an array, found this instead', JSON.stringify(queue));
      console.error('Returning a blank queue');
      return [];
    } else {
      return queue;
    }
  } catch (e) {
    console.error('Queue not retrievable, returning blank queue', e);
    return [];
  }
};
const saveQueue = queue => {
  fs.writeFileSync('.build-server-queue', JSON.stringify(queue));
};
const formatTask = task => ({
  api: task.api,
  repos: task.repos,
  simName: task.simName,
  version: task.version,
  locales: task.locales,
  servers: task.servers,
  brands: task.brands,
  email: task.email,
  userId: task.userId,
  branch: task.branch
});
const addTask = task => {
  const queue = getQueue();
  queue.push(formatTask(task));
  saveQueue(queue);
};
const removeTask = task => {
  const queue = getQueue();
  const taskIndex = queue.findIndex(t => _.isEqual(t, formatTask(task)));
  queue.splice(taskIndex, 1);
  saveQueue(queue);
};
module.exports = {
  addTask: addTask,
  removeTask: removeTask,
  getQueue: getQueue
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJfIiwiZ2V0UXVldWUiLCJxdWV1ZSIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsInRvU3RyaW5nIiwiQXJyYXkiLCJpc0FycmF5IiwiY29uc29sZSIsImVycm9yIiwic3RyaW5naWZ5IiwiZSIsInNhdmVRdWV1ZSIsIndyaXRlRmlsZVN5bmMiLCJmb3JtYXRUYXNrIiwidGFzayIsImFwaSIsInJlcG9zIiwic2ltTmFtZSIsInZlcnNpb24iLCJsb2NhbGVzIiwic2VydmVycyIsImJyYW5kcyIsImVtYWlsIiwidXNlcklkIiwiYnJhbmNoIiwiYWRkVGFzayIsInB1c2giLCJyZW1vdmVUYXNrIiwidGFza0luZGV4IiwiZmluZEluZGV4IiwidCIsImlzRXF1YWwiLCJzcGxpY2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsicGVyc2lzdGVudFF1ZXVlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSggJ2ZzJyApO1xyXG5jb25zdCBfID0gcmVxdWlyZSggJ2xvZGFzaCcgKTtcclxuXHJcbmNvbnN0IGdldFF1ZXVlID0gKCkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBxdWV1ZSA9IEpTT04ucGFyc2UoIGZzLnJlYWRGaWxlU3luYyggJy5idWlsZC1zZXJ2ZXItcXVldWUnICkudG9TdHJpbmcoKSApO1xyXG4gICAgaWYgKCAhQXJyYXkuaXNBcnJheSggcXVldWUgKSApIHtcclxuICAgICAgY29uc29sZS5lcnJvciggJ1F1ZXVlIGlzIG5vdCBhbiBhcnJheSwgZm91bmQgdGhpcyBpbnN0ZWFkJywgSlNPTi5zdHJpbmdpZnkoIHF1ZXVlICkgKTtcclxuICAgICAgY29uc29sZS5lcnJvciggJ1JldHVybmluZyBhIGJsYW5rIHF1ZXVlJyApO1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgcmV0dXJuIHF1ZXVlO1xyXG4gICAgfVxyXG4gIH1cclxuICBjYXRjaCggZSApIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoICdRdWV1ZSBub3QgcmV0cmlldmFibGUsIHJldHVybmluZyBibGFuayBxdWV1ZScsIGUgKTtcclxuICAgIHJldHVybiBbXTtcclxuICB9XHJcbn07XHJcblxyXG5jb25zdCBzYXZlUXVldWUgPSBxdWV1ZSA9PiB7XHJcbiAgZnMud3JpdGVGaWxlU3luYyggJy5idWlsZC1zZXJ2ZXItcXVldWUnLCBKU09OLnN0cmluZ2lmeSggcXVldWUgKSApO1xyXG59O1xyXG5cclxuY29uc3QgZm9ybWF0VGFzayA9IHRhc2sgPT4gKCB7XHJcbiAgYXBpOiB0YXNrLmFwaSxcclxuICByZXBvczogdGFzay5yZXBvcyxcclxuICBzaW1OYW1lOiB0YXNrLnNpbU5hbWUsXHJcbiAgdmVyc2lvbjogdGFzay52ZXJzaW9uLFxyXG4gIGxvY2FsZXM6IHRhc2subG9jYWxlcyxcclxuICBzZXJ2ZXJzOiB0YXNrLnNlcnZlcnMsXHJcbiAgYnJhbmRzOiB0YXNrLmJyYW5kcyxcclxuICBlbWFpbDogdGFzay5lbWFpbCxcclxuICB1c2VySWQ6IHRhc2sudXNlcklkLFxyXG4gIGJyYW5jaDogdGFzay5icmFuY2hcclxufSApO1xyXG5cclxuY29uc3QgYWRkVGFzayA9IHRhc2sgPT4ge1xyXG4gIGNvbnN0IHF1ZXVlID0gZ2V0UXVldWUoKTtcclxuICBxdWV1ZS5wdXNoKCBmb3JtYXRUYXNrKCB0YXNrICkgKTtcclxuICBzYXZlUXVldWUoIHF1ZXVlICk7XHJcbn07XHJcblxyXG5jb25zdCByZW1vdmVUYXNrID0gdGFzayA9PiB7XHJcbiAgY29uc3QgcXVldWUgPSBnZXRRdWV1ZSgpO1xyXG4gIGNvbnN0IHRhc2tJbmRleCA9IHF1ZXVlLmZpbmRJbmRleCggdCA9PiBfLmlzRXF1YWwoIHQsIGZvcm1hdFRhc2soIHRhc2sgKSApICk7XHJcbiAgcXVldWUuc3BsaWNlKCB0YXNrSW5kZXgsIDEgKTtcclxuICBzYXZlUXVldWUoIHF1ZXVlICk7XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBhZGRUYXNrOiBhZGRUYXNrLFxyXG4gIHJlbW92ZVRhc2s6IHJlbW92ZVRhc2ssXHJcbiAgZ2V0UXVldWU6IGdldFF1ZXVlXHJcbn07Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBRSxJQUFLLENBQUM7QUFDMUIsTUFBTUMsQ0FBQyxHQUFHRCxPQUFPLENBQUUsUUFBUyxDQUFDO0FBRTdCLE1BQU1FLFFBQVEsR0FBR0EsQ0FBQSxLQUFNO0VBQ3JCLElBQUk7SUFDRixNQUFNQyxLQUFLLEdBQUdDLElBQUksQ0FBQ0MsS0FBSyxDQUFFTixFQUFFLENBQUNPLFlBQVksQ0FBRSxxQkFBc0IsQ0FBQyxDQUFDQyxRQUFRLENBQUMsQ0FBRSxDQUFDO0lBQy9FLElBQUssQ0FBQ0MsS0FBSyxDQUFDQyxPQUFPLENBQUVOLEtBQU0sQ0FBQyxFQUFHO01BQzdCTyxPQUFPLENBQUNDLEtBQUssQ0FBRSwyQ0FBMkMsRUFBRVAsSUFBSSxDQUFDUSxTQUFTLENBQUVULEtBQU0sQ0FBRSxDQUFDO01BQ3JGTyxPQUFPLENBQUNDLEtBQUssQ0FBRSx5QkFBMEIsQ0FBQztNQUMxQyxPQUFPLEVBQUU7SUFDWCxDQUFDLE1BQ0k7TUFDSCxPQUFPUixLQUFLO0lBQ2Q7RUFDRixDQUFDLENBQ0QsT0FBT1UsQ0FBQyxFQUFHO0lBQ1RILE9BQU8sQ0FBQ0MsS0FBSyxDQUFFLDhDQUE4QyxFQUFFRSxDQUFFLENBQUM7SUFDbEUsT0FBTyxFQUFFO0VBQ1g7QUFDRixDQUFDO0FBRUQsTUFBTUMsU0FBUyxHQUFHWCxLQUFLLElBQUk7RUFDekJKLEVBQUUsQ0FBQ2dCLGFBQWEsQ0FBRSxxQkFBcUIsRUFBRVgsSUFBSSxDQUFDUSxTQUFTLENBQUVULEtBQU0sQ0FBRSxDQUFDO0FBQ3BFLENBQUM7QUFFRCxNQUFNYSxVQUFVLEdBQUdDLElBQUksS0FBTTtFQUMzQkMsR0FBRyxFQUFFRCxJQUFJLENBQUNDLEdBQUc7RUFDYkMsS0FBSyxFQUFFRixJQUFJLENBQUNFLEtBQUs7RUFDakJDLE9BQU8sRUFBRUgsSUFBSSxDQUFDRyxPQUFPO0VBQ3JCQyxPQUFPLEVBQUVKLElBQUksQ0FBQ0ksT0FBTztFQUNyQkMsT0FBTyxFQUFFTCxJQUFJLENBQUNLLE9BQU87RUFDckJDLE9BQU8sRUFBRU4sSUFBSSxDQUFDTSxPQUFPO0VBQ3JCQyxNQUFNLEVBQUVQLElBQUksQ0FBQ08sTUFBTTtFQUNuQkMsS0FBSyxFQUFFUixJQUFJLENBQUNRLEtBQUs7RUFDakJDLE1BQU0sRUFBRVQsSUFBSSxDQUFDUyxNQUFNO0VBQ25CQyxNQUFNLEVBQUVWLElBQUksQ0FBQ1U7QUFDZixDQUFDLENBQUU7QUFFSCxNQUFNQyxPQUFPLEdBQUdYLElBQUksSUFBSTtFQUN0QixNQUFNZCxLQUFLLEdBQUdELFFBQVEsQ0FBQyxDQUFDO0VBQ3hCQyxLQUFLLENBQUMwQixJQUFJLENBQUViLFVBQVUsQ0FBRUMsSUFBSyxDQUFFLENBQUM7RUFDaENILFNBQVMsQ0FBRVgsS0FBTSxDQUFDO0FBQ3BCLENBQUM7QUFFRCxNQUFNMkIsVUFBVSxHQUFHYixJQUFJLElBQUk7RUFDekIsTUFBTWQsS0FBSyxHQUFHRCxRQUFRLENBQUMsQ0FBQztFQUN4QixNQUFNNkIsU0FBUyxHQUFHNUIsS0FBSyxDQUFDNkIsU0FBUyxDQUFFQyxDQUFDLElBQUloQyxDQUFDLENBQUNpQyxPQUFPLENBQUVELENBQUMsRUFBRWpCLFVBQVUsQ0FBRUMsSUFBSyxDQUFFLENBQUUsQ0FBQztFQUM1RWQsS0FBSyxDQUFDZ0MsTUFBTSxDQUFFSixTQUFTLEVBQUUsQ0FBRSxDQUFDO0VBQzVCakIsU0FBUyxDQUFFWCxLQUFNLENBQUM7QUFDcEIsQ0FBQztBQUVEaUMsTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDZlQsT0FBTyxFQUFFQSxPQUFPO0VBQ2hCRSxVQUFVLEVBQUVBLFVBQVU7RUFDdEI1QixRQUFRLEVBQUVBO0FBQ1osQ0FBQyJ9