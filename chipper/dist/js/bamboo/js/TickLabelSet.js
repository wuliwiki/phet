// Copyright 2020-2023, University of Colorado Boulder

/**
 * Shows a set of tick labels within or next to a chart.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import Bounds2 from '../../dot/js/Bounds2.js';
import Utils from '../../dot/js/Utils.js';
import Orientation from '../../phet-core/js/Orientation.js';
import { Path, Text } from '../../scenery/js/imports.js';
import bamboo from './bamboo.js';
import TickMarkSet from './TickMarkSet.js';
import optionize from '../../phet-core/js/optionize.js';
class TickLabelSet extends Path {
  // cache labels for quick reuse

  /**
   * @param chartTransform
   * @param axisOrientation - the progression of the ticks.  For instance HORIZONTAL has ticks at x=0,1,2, etc.
   * @param spacing - in model coordinates
   * @param [providedOptions]
   */
  constructor(chartTransform, axisOrientation, spacing, providedOptions) {
    const options = optionize()({
      // SelfOptions
      value: 0,
      // appear on the axis by default
      edge: null,
      origin: 0,
      skipCoordinates: [],
      extent: TickMarkSet.DEFAULT_EXTENT,
      clippingType: 'strict',
      createLabel: value => new Text(Utils.toFixed(value, 1), {
        fontSize: 12
      }),
      positionLabel: (label, tickBounds, axisOrientation) => {
        if (axisOrientation === Orientation.HORIZONTAL) {
          // ticks flow horizontally, so tick labels should be below
          label.centerTop = tickBounds.centerBottom.plusXY(0, 1);
        } else {
          label.rightCenter = tickBounds.leftCenter.plusXY(-1, 0);
        }
        return label;
      }
    }, providedOptions);
    if (options.edge) {
      assert && assert(options.value === 0, 'value and edge are mutually exclusive');
    }
    super(null, options);
    this.chartTransform = chartTransform;
    this.axisOrientation = axisOrientation;
    this.spacing = spacing;
    this.origin = options.origin;
    this.skipCoordinates = options.skipCoordinates;
    this.extent = options.extent;
    this.value = options.value;
    this.clippingType = options.clippingType;
    this.edge = options.edge;
    this.createLabel = options.createLabel;
    this.positionLabel = options.positionLabel;
    this.labelMap = new Map();

    // Initialize
    this.update();

    // Update when the transform changes.
    const changedListener = () => this.update();
    chartTransform.changedEmitter.addListener(changedListener);
    this.disposeTickLabelSet = () => chartTransform.changedEmitter.removeListener(changedListener);
  }
  setSpacing(spacing) {
    if (this.spacing !== spacing) {
      this.spacing = spacing;
      this.update();
    }
  }

  // Updates the labels when range or spacing has changed.
  update() {
    const children = [];
    const used = new Set();
    this.chartTransform.forEachSpacing(this.axisOrientation, this.spacing, this.origin, this.clippingType, (modelCoordinate, viewCoordinate) => {
      if (!this.skipCoordinates.includes(modelCoordinate)) {
        const tickBounds = new Bounds2(0, 0, 0, 0);
        if (this.axisOrientation === Orientation.HORIZONTAL) {
          const viewY = this.edge === 'min' ? this.chartTransform.viewHeight : this.edge === 'max' ? 0 : this.chartTransform.modelToView(this.axisOrientation.opposite, this.value);
          tickBounds.setMinMax(viewCoordinate, viewY - this.extent / 2, viewCoordinate, viewY + this.extent / 2);
        } else {
          const viewX = this.edge === 'min' ? 0 : this.edge === 'max' ? this.chartTransform.viewWidth : this.chartTransform.modelToView(this.axisOrientation.opposite, this.value);
          tickBounds.setMinMax(viewX - this.extent / 2, viewCoordinate, viewX + this.extent / 2, viewCoordinate);
        }
        const label = this.labelMap.has(modelCoordinate) ? this.labelMap.get(modelCoordinate) : this.createLabel ? this.createLabel(modelCoordinate) : null;
        this.labelMap.set(modelCoordinate, label);
        label && this.positionLabel(label, tickBounds, this.axisOrientation);
        label && children.push(label);
        used.add(modelCoordinate);
      }
    });

    // empty cache of unused values
    const toRemove = [];
    for (const key of this.labelMap.keys()) {
      if (!used.has(key)) {
        toRemove.push(key);
      }
    }
    toRemove.forEach(t => {
      this.labelMap.delete(t);
    });
    this.children = children;
  }

  /**
   * Clears the cache and updates the label set. Use this if you need to have new labels for values that are in
   * the cache. For example, if your createLabel function had logic to switch between numeric (e.g. 2) and
   * symbolic labels (e.g. '2L').
   */
  invalidateTickLabelSet() {
    this.labelMap.clear();
    this.update();
  }
  setCreateLabel(createLabel) {
    this.createLabel = createLabel;
    this.invalidateTickLabelSet();
  }
  dispose() {
    this.disposeTickLabelSet();
    super.dispose();
  }
}
bamboo.register('TickLabelSet', TickLabelSet);
export default TickLabelSet;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb3VuZHMyIiwiVXRpbHMiLCJPcmllbnRhdGlvbiIsIlBhdGgiLCJUZXh0IiwiYmFtYm9vIiwiVGlja01hcmtTZXQiLCJvcHRpb25pemUiLCJUaWNrTGFiZWxTZXQiLCJjb25zdHJ1Y3RvciIsImNoYXJ0VHJhbnNmb3JtIiwiYXhpc09yaWVudGF0aW9uIiwic3BhY2luZyIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJ2YWx1ZSIsImVkZ2UiLCJvcmlnaW4iLCJza2lwQ29vcmRpbmF0ZXMiLCJleHRlbnQiLCJERUZBVUxUX0VYVEVOVCIsImNsaXBwaW5nVHlwZSIsImNyZWF0ZUxhYmVsIiwidG9GaXhlZCIsImZvbnRTaXplIiwicG9zaXRpb25MYWJlbCIsImxhYmVsIiwidGlja0JvdW5kcyIsIkhPUklaT05UQUwiLCJjZW50ZXJUb3AiLCJjZW50ZXJCb3R0b20iLCJwbHVzWFkiLCJyaWdodENlbnRlciIsImxlZnRDZW50ZXIiLCJhc3NlcnQiLCJsYWJlbE1hcCIsIk1hcCIsInVwZGF0ZSIsImNoYW5nZWRMaXN0ZW5lciIsImNoYW5nZWRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJkaXNwb3NlVGlja0xhYmVsU2V0IiwicmVtb3ZlTGlzdGVuZXIiLCJzZXRTcGFjaW5nIiwiY2hpbGRyZW4iLCJ1c2VkIiwiU2V0IiwiZm9yRWFjaFNwYWNpbmciLCJtb2RlbENvb3JkaW5hdGUiLCJ2aWV3Q29vcmRpbmF0ZSIsImluY2x1ZGVzIiwidmlld1kiLCJ2aWV3SGVpZ2h0IiwibW9kZWxUb1ZpZXciLCJvcHBvc2l0ZSIsInNldE1pbk1heCIsInZpZXdYIiwidmlld1dpZHRoIiwiaGFzIiwiZ2V0Iiwic2V0IiwicHVzaCIsImFkZCIsInRvUmVtb3ZlIiwia2V5Iiwia2V5cyIsImZvckVhY2giLCJ0IiwiZGVsZXRlIiwiaW52YWxpZGF0ZVRpY2tMYWJlbFNldCIsImNsZWFyIiwic2V0Q3JlYXRlTGFiZWwiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJUaWNrTGFiZWxTZXQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogU2hvd3MgYSBzZXQgb2YgdGljayBsYWJlbHMgd2l0aGluIG9yIG5leHQgdG8gYSBjaGFydC5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgQm91bmRzMiBmcm9tICcuLi8uLi9kb3QvanMvQm91bmRzMi5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgT3JpZW50YXRpb24gZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL09yaWVudGF0aW9uLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgUGF0aCwgUGF0aE9wdGlvbnMsIFRleHQgfSBmcm9tICcuLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYmFtYm9vIGZyb20gJy4vYmFtYm9vLmpzJztcclxuaW1wb3J0IENsaXBwaW5nVHlwZSBmcm9tICcuL0NsaXBwaW5nVHlwZS5qcyc7XHJcbmltcG9ydCBUaWNrTWFya1NldCBmcm9tICcuL1RpY2tNYXJrU2V0LmpzJztcclxuaW1wb3J0IENoYXJ0VHJhbnNmb3JtIGZyb20gJy4vQ2hhcnRUcmFuc2Zvcm0uanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgU3RyaWN0T21pdCBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvU3RyaWN0T21pdC5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICB2YWx1ZT86IG51bWJlcjtcclxuICBlZGdlPzogbnVsbCB8ICdtaW4nIHwgJ21heCc7IC8vICdtaW4nIG9yICdtYXgnIHB1dCB0aGUgdGlja3Mgb24gdGhhdCBlZGdlIG9mIHRoZSBjaGFydCAodGFrZXMgcHJlY2VkZW5jZSBvdmVyIHZhbHVlKVxyXG4gIG9yaWdpbj86IG51bWJlcjtcclxuICBza2lwQ29vcmRpbmF0ZXM/OiBudW1iZXJbXTsgLy8gc2tpcCB0aWNrcyBhdCB0aGVzZSBjb29yZGluYXRlcywgbW9zdCBvZnRlbiB1c2VmdWwgdG8gc2tpcCB6ZXJvIHdoZXJlIGF4ZXMgaW50ZXJzZWN0XHJcblxyXG4gIC8vIGFjdCBhcyBpZiB0aGVyZSBpcyBhIGNvcnJlc3BvbmRpbmcgdGljayB3aXRoIHRoaXMgZXh0ZW50LCBmb3IgcG9zaXRpb25pbmcgdGhlIGxhYmVsIHJlbGF0aXZlbHlcclxuICBleHRlbnQ/OiBudW1iZXI7XHJcblxyXG4gIC8vIGRldGVybWluZXMgd2hldGhlciB0aGUgcm91bmRpbmcgaXMgbGVuaWVudCwgc2VlIENoYXJ0VHJhbnNmb3JtXHJcbiAgY2xpcHBpbmdUeXBlPzogQ2xpcHBpbmdUeXBlO1xyXG5cclxuICAvLyBvciByZXR1cm4gbnVsbCBpZiBubyBsYWJlbCBmb3IgdGhhdCB2YWx1ZVxyXG4gIGNyZWF0ZUxhYmVsPzogKCB2YWx1ZTogbnVtYmVyICkgPT4gTm9kZSB8IG51bGw7XHJcbiAgcG9zaXRpb25MYWJlbD86ICggbGFiZWw6IE5vZGUsIHRpY2tCb3VuZHM6IEJvdW5kczIsIGF4aXNPcmllbnRhdGlvbjogT3JpZW50YXRpb24gKSA9PiBOb2RlO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgVGlja0xhYmVsU2V0T3B0aW9ucyA9IFNlbGZPcHRpb25zICYgU3RyaWN0T21pdDxQYXRoT3B0aW9ucywgJ2NoaWxkcmVuJz47XHJcblxyXG5jbGFzcyBUaWNrTGFiZWxTZXQgZXh0ZW5kcyBQYXRoIHtcclxuXHJcbiAgcHJpdmF0ZSBjaGFydFRyYW5zZm9ybTogQ2hhcnRUcmFuc2Zvcm07XHJcbiAgcHJpdmF0ZSByZWFkb25seSBheGlzT3JpZW50YXRpb246IE9yaWVudGF0aW9uO1xyXG4gIHByaXZhdGUgc3BhY2luZzogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgb3JpZ2luOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBza2lwQ29vcmRpbmF0ZXM6IG51bWJlcltdO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZXh0ZW50OiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB2YWx1ZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY2xpcHBpbmdUeXBlOiBDbGlwcGluZ1R5cGU7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBlZGdlOiBudWxsIHwgJ21pbicgfCAnbWF4JztcclxuICBwcml2YXRlIGNyZWF0ZUxhYmVsO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgcG9zaXRpb25MYWJlbDtcclxuICBwcml2YXRlIGxhYmVsTWFwOiBNYXA8bnVtYmVyLCBOb2RlIHwgbnVsbD47IC8vIGNhY2hlIGxhYmVscyBmb3IgcXVpY2sgcmV1c2VcclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VUaWNrTGFiZWxTZXQ6ICgpID0+IHZvaWQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBjaGFydFRyYW5zZm9ybVxyXG4gICAqIEBwYXJhbSBheGlzT3JpZW50YXRpb24gLSB0aGUgcHJvZ3Jlc3Npb24gb2YgdGhlIHRpY2tzLiAgRm9yIGluc3RhbmNlIEhPUklaT05UQUwgaGFzIHRpY2tzIGF0IHg9MCwxLDIsIGV0Yy5cclxuICAgKiBAcGFyYW0gc3BhY2luZyAtIGluIG1vZGVsIGNvb3JkaW5hdGVzXHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBjaGFydFRyYW5zZm9ybTogQ2hhcnRUcmFuc2Zvcm0sIGF4aXNPcmllbnRhdGlvbjogT3JpZW50YXRpb24sIHNwYWNpbmc6IG51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IFRpY2tMYWJlbFNldE9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxUaWNrTGFiZWxTZXRPcHRpb25zLCBTZWxmT3B0aW9ucywgUGF0aE9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIHZhbHVlOiAwLCAvLyBhcHBlYXIgb24gdGhlIGF4aXMgYnkgZGVmYXVsdFxyXG4gICAgICBlZGdlOiBudWxsLFxyXG4gICAgICBvcmlnaW46IDAsXHJcbiAgICAgIHNraXBDb29yZGluYXRlczogW10sXHJcbiAgICAgIGV4dGVudDogVGlja01hcmtTZXQuREVGQVVMVF9FWFRFTlQsXHJcbiAgICAgIGNsaXBwaW5nVHlwZTogJ3N0cmljdCcsXHJcbiAgICAgIGNyZWF0ZUxhYmVsOiAoIHZhbHVlOiBudW1iZXIgKSA9PiBuZXcgVGV4dCggVXRpbHMudG9GaXhlZCggdmFsdWUsIDEgKSwgeyBmb250U2l6ZTogMTIgfSApLFxyXG4gICAgICBwb3NpdGlvbkxhYmVsOiAoIGxhYmVsOiBOb2RlLCB0aWNrQm91bmRzOiBCb3VuZHMyLCBheGlzT3JpZW50YXRpb246IE9yaWVudGF0aW9uICkgPT4ge1xyXG4gICAgICAgIGlmICggYXhpc09yaWVudGF0aW9uID09PSBPcmllbnRhdGlvbi5IT1JJWk9OVEFMICkge1xyXG5cclxuICAgICAgICAgIC8vIHRpY2tzIGZsb3cgaG9yaXpvbnRhbGx5LCBzbyB0aWNrIGxhYmVscyBzaG91bGQgYmUgYmVsb3dcclxuICAgICAgICAgIGxhYmVsLmNlbnRlclRvcCA9IHRpY2tCb3VuZHMuY2VudGVyQm90dG9tLnBsdXNYWSggMCwgMSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGxhYmVsLnJpZ2h0Q2VudGVyID0gdGlja0JvdW5kcy5sZWZ0Q2VudGVyLnBsdXNYWSggLTEsIDAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGxhYmVsO1xyXG4gICAgICB9XHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBpZiAoIG9wdGlvbnMuZWRnZSApIHtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy52YWx1ZSA9PT0gMCwgJ3ZhbHVlIGFuZCBlZGdlIGFyZSBtdXR1YWxseSBleGNsdXNpdmUnICk7XHJcbiAgICB9XHJcblxyXG4gICAgc3VwZXIoIG51bGwsIG9wdGlvbnMgKTtcclxuXHJcbiAgICB0aGlzLmNoYXJ0VHJhbnNmb3JtID0gY2hhcnRUcmFuc2Zvcm07XHJcbiAgICB0aGlzLmF4aXNPcmllbnRhdGlvbiA9IGF4aXNPcmllbnRhdGlvbjtcclxuICAgIHRoaXMuc3BhY2luZyA9IHNwYWNpbmc7XHJcbiAgICB0aGlzLm9yaWdpbiA9IG9wdGlvbnMub3JpZ2luO1xyXG4gICAgdGhpcy5za2lwQ29vcmRpbmF0ZXMgPSBvcHRpb25zLnNraXBDb29yZGluYXRlcztcclxuICAgIHRoaXMuZXh0ZW50ID0gb3B0aW9ucy5leHRlbnQ7XHJcbiAgICB0aGlzLnZhbHVlID0gb3B0aW9ucy52YWx1ZTtcclxuICAgIHRoaXMuY2xpcHBpbmdUeXBlID0gb3B0aW9ucy5jbGlwcGluZ1R5cGU7XHJcbiAgICB0aGlzLmVkZ2UgPSBvcHRpb25zLmVkZ2U7XHJcbiAgICB0aGlzLmNyZWF0ZUxhYmVsID0gb3B0aW9ucy5jcmVhdGVMYWJlbDtcclxuICAgIHRoaXMucG9zaXRpb25MYWJlbCA9IG9wdGlvbnMucG9zaXRpb25MYWJlbDtcclxuXHJcbiAgICB0aGlzLmxhYmVsTWFwID0gbmV3IE1hcCgpO1xyXG5cclxuICAgIC8vIEluaXRpYWxpemVcclxuICAgIHRoaXMudXBkYXRlKCk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHdoZW4gdGhlIHRyYW5zZm9ybSBjaGFuZ2VzLlxyXG4gICAgY29uc3QgY2hhbmdlZExpc3RlbmVyID0gKCkgPT4gdGhpcy51cGRhdGUoKTtcclxuICAgIGNoYXJ0VHJhbnNmb3JtLmNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCBjaGFuZ2VkTGlzdGVuZXIgKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VUaWNrTGFiZWxTZXQgPSAoKSA9PiBjaGFydFRyYW5zZm9ybS5jaGFuZ2VkRW1pdHRlci5yZW1vdmVMaXN0ZW5lciggY2hhbmdlZExpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0U3BhY2luZyggc3BhY2luZzogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLnNwYWNpbmcgIT09IHNwYWNpbmcgKSB7XHJcbiAgICAgIHRoaXMuc3BhY2luZyA9IHNwYWNpbmc7XHJcbiAgICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBVcGRhdGVzIHRoZSBsYWJlbHMgd2hlbiByYW5nZSBvciBzcGFjaW5nIGhhcyBjaGFuZ2VkLlxyXG4gIHByaXZhdGUgdXBkYXRlKCk6IHZvaWQge1xyXG4gICAgY29uc3QgY2hpbGRyZW46IE5vZGVbXSA9IFtdO1xyXG4gICAgY29uc3QgdXNlZCA9IG5ldyBTZXQoKTtcclxuXHJcbiAgICB0aGlzLmNoYXJ0VHJhbnNmb3JtLmZvckVhY2hTcGFjaW5nKCB0aGlzLmF4aXNPcmllbnRhdGlvbiwgdGhpcy5zcGFjaW5nLCB0aGlzLm9yaWdpbiwgdGhpcy5jbGlwcGluZ1R5cGUsICggbW9kZWxDb29yZGluYXRlLCB2aWV3Q29vcmRpbmF0ZSApID0+IHtcclxuICAgICAgaWYgKCAhdGhpcy5za2lwQ29vcmRpbmF0ZXMuaW5jbHVkZXMoIG1vZGVsQ29vcmRpbmF0ZSApICkge1xyXG4gICAgICAgIGNvbnN0IHRpY2tCb3VuZHMgPSBuZXcgQm91bmRzMiggMCwgMCwgMCwgMCApO1xyXG4gICAgICAgIGlmICggdGhpcy5heGlzT3JpZW50YXRpb24gPT09IE9yaWVudGF0aW9uLkhPUklaT05UQUwgKSB7XHJcbiAgICAgICAgICBjb25zdCB2aWV3WSA9IHRoaXMuZWRnZSA9PT0gJ21pbicgPyB0aGlzLmNoYXJ0VHJhbnNmb3JtLnZpZXdIZWlnaHQgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVkZ2UgPT09ICdtYXgnID8gMCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRUcmFuc2Zvcm0ubW9kZWxUb1ZpZXcoIHRoaXMuYXhpc09yaWVudGF0aW9uLm9wcG9zaXRlLCB0aGlzLnZhbHVlICk7XHJcbiAgICAgICAgICB0aWNrQm91bmRzLnNldE1pbk1heCggdmlld0Nvb3JkaW5hdGUsIHZpZXdZIC0gdGhpcy5leHRlbnQgLyAyLCB2aWV3Q29vcmRpbmF0ZSwgdmlld1kgKyB0aGlzLmV4dGVudCAvIDIgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBjb25zdCB2aWV3WCA9IHRoaXMuZWRnZSA9PT0gJ21pbicgPyAwIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGdlID09PSAnbWF4JyA/IHRoaXMuY2hhcnRUcmFuc2Zvcm0udmlld1dpZHRoIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydFRyYW5zZm9ybS5tb2RlbFRvVmlldyggdGhpcy5heGlzT3JpZW50YXRpb24ub3Bwb3NpdGUsIHRoaXMudmFsdWUgKTtcclxuICAgICAgICAgIHRpY2tCb3VuZHMuc2V0TWluTWF4KCB2aWV3WCAtIHRoaXMuZXh0ZW50IC8gMiwgdmlld0Nvb3JkaW5hdGUsIHZpZXdYICsgdGhpcy5leHRlbnQgLyAyLCB2aWV3Q29vcmRpbmF0ZSApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbGFiZWwgPSB0aGlzLmxhYmVsTWFwLmhhcyggbW9kZWxDb29yZGluYXRlICkgPyB0aGlzLmxhYmVsTWFwLmdldCggbW9kZWxDb29yZGluYXRlICkhIDpcclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlTGFiZWwgPyB0aGlzLmNyZWF0ZUxhYmVsKCBtb2RlbENvb3JkaW5hdGUgKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICBudWxsO1xyXG4gICAgICAgIHRoaXMubGFiZWxNYXAuc2V0KCBtb2RlbENvb3JkaW5hdGUsIGxhYmVsICk7XHJcbiAgICAgICAgbGFiZWwgJiYgdGhpcy5wb3NpdGlvbkxhYmVsKCBsYWJlbCwgdGlja0JvdW5kcywgdGhpcy5heGlzT3JpZW50YXRpb24gKTtcclxuICAgICAgICBsYWJlbCAmJiBjaGlsZHJlbi5wdXNoKCBsYWJlbCApO1xyXG4gICAgICAgIHVzZWQuYWRkKCBtb2RlbENvb3JkaW5hdGUgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGVtcHR5IGNhY2hlIG9mIHVudXNlZCB2YWx1ZXNcclxuICAgIGNvbnN0IHRvUmVtb3ZlID0gW107XHJcbiAgICBmb3IgKCBjb25zdCBrZXkgb2YgdGhpcy5sYWJlbE1hcC5rZXlzKCkgKSB7XHJcbiAgICAgIGlmICggIXVzZWQuaGFzKCBrZXkgKSApIHtcclxuICAgICAgICB0b1JlbW92ZS5wdXNoKCBrZXkgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdG9SZW1vdmUuZm9yRWFjaCggdCA9PiB7XHJcbiAgICAgIHRoaXMubGFiZWxNYXAuZGVsZXRlKCB0ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXJzIHRoZSBjYWNoZSBhbmQgdXBkYXRlcyB0aGUgbGFiZWwgc2V0LiBVc2UgdGhpcyBpZiB5b3UgbmVlZCB0byBoYXZlIG5ldyBsYWJlbHMgZm9yIHZhbHVlcyB0aGF0IGFyZSBpblxyXG4gICAqIHRoZSBjYWNoZS4gRm9yIGV4YW1wbGUsIGlmIHlvdXIgY3JlYXRlTGFiZWwgZnVuY3Rpb24gaGFkIGxvZ2ljIHRvIHN3aXRjaCBiZXR3ZWVuIG51bWVyaWMgKGUuZy4gMikgYW5kXHJcbiAgICogc3ltYm9saWMgbGFiZWxzIChlLmcuICcyTCcpLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW52YWxpZGF0ZVRpY2tMYWJlbFNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMubGFiZWxNYXAuY2xlYXIoKTtcclxuICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0Q3JlYXRlTGFiZWwoIGNyZWF0ZUxhYmVsOiAoIHZhbHVlOiBudW1iZXIgKSA9PiBOb2RlIHwgbnVsbCApOiB2b2lkIHtcclxuICAgIHRoaXMuY3JlYXRlTGFiZWwgPSBjcmVhdGVMYWJlbDtcclxuICAgIHRoaXMuaW52YWxpZGF0ZVRpY2tMYWJlbFNldCgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3Bvc2VUaWNrTGFiZWxTZXQoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmJhbWJvby5yZWdpc3RlciggJ1RpY2tMYWJlbFNldCcsIFRpY2tMYWJlbFNldCApO1xyXG5leHBvcnQgZGVmYXVsdCBUaWNrTGFiZWxTZXQ7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLE9BQU8sTUFBTSx5QkFBeUI7QUFDN0MsT0FBT0MsS0FBSyxNQUFNLHVCQUF1QjtBQUN6QyxPQUFPQyxXQUFXLE1BQU0sbUNBQW1DO0FBQzNELFNBQWVDLElBQUksRUFBZUMsSUFBSSxRQUFRLDZCQUE2QjtBQUMzRSxPQUFPQyxNQUFNLE1BQU0sYUFBYTtBQUVoQyxPQUFPQyxXQUFXLE1BQU0sa0JBQWtCO0FBRTFDLE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUF1QnZELE1BQU1DLFlBQVksU0FBU0wsSUFBSSxDQUFDO0VBYWM7O0VBRzVDO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTTSxXQUFXQSxDQUFFQyxjQUE4QixFQUFFQyxlQUE0QixFQUFFQyxPQUFlLEVBQzdFQyxlQUFxQyxFQUFHO0lBRTFELE1BQU1DLE9BQU8sR0FBR1AsU0FBUyxDQUFnRCxDQUFDLENBQUU7TUFFMUU7TUFDQVEsS0FBSyxFQUFFLENBQUM7TUFBRTtNQUNWQyxJQUFJLEVBQUUs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