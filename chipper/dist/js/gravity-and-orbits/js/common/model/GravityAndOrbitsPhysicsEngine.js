// Copyright 2014-2022, University of Colorado Boulder

/**
 * This is the model for Gravity and Orbits; there is one GravityAndOrbitsPhysicsEngine per each GravityAndOrbitsScene, and it
 * uses ModelState to update the physics.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Aaron Davis (PhET Interactive Simulations)
 */

import Emitter from '../../../../axon/js/Emitter.js';
import TimeSpeed from '../../../../scenery-phet/js/TimeSpeed.js';
import gravityAndOrbits from '../../gravityAndOrbits.js';
import ModelState from './ModelState.js';
/**
 * Return the smaller of two Body instances, for determining which survives a collision.
 * @param other
 * @param body
 * @returns the smaller body
 */
const getSmaller = (other, body) => other.massProperty.get() < body.massProperty.get() ? other : body;

/**
 * For use inside a map call, factored out here for performance
 */
const getBodyState = body => body.toBodyState();
class GravityAndOrbitsPhysicsEngine {
  /**
   * @param clock
   * @param gravityEnabledProperty flag to indicate whether gravity is on or off.
   * @param adjustMoonOrbit - in the "Model" screen, there is an additional force from the Earth on the Moon to keep it in orbit
   *                                  - This is necessary because the moon orbital radius is higher (so it is visible)
   */
  constructor(clock, gravityEnabledProperty, adjustMoonOrbit) {
    this.gravityEnabledProperty = gravityEnabledProperty;
    this.adjustMoonOrbit = adjustMoonOrbit;
    this.clock = clock;

    // {Body[]} - contains the sun, moon, earth, satellite
    this.bodies = [];
    this.clock.addEventTimer(dt => {
      // NOTE: replacing step with stepModel fixes https://github.com/phetsims/gravity-and-orbits/issues/253
      // but introduces performance issues
      const elapsedTime = this.stepModel();
      this.clock.setSimulationTime(this.clock.getSimulationTime() + elapsedTime);
    });

    // Have to update force vectors when gravity gets toggled on and off, otherwise displayed value won't update
    this.gravityEnabledProperty.link(this.updateForceVectors.bind(this));
    this.stepCompleteEmitter = new Emitter();
  }

  /**
   * Standardize the time step so that the play speed has no impact on the model. For a large time step, we break
   * apart the change in time into a series of time steps.  This ensures that this.step and the next model state is
   * calculated with consistent changes in time.
   *
   * @returns elapsed time
   */
  stepModel() {
    this.bodies.forEach(body => body.storePreviousPosition());

    // standardized time step - based on the slowest time step for the given orbital mode
    const smallestTimeStep = this.clock.baseDTValue * 0.13125;

    // get the number of times we will need to step the model based on the dt passed in
    const numberOfSteps = this.clock.timeSpeedProperty.value === TimeSpeed.SLOW ? 1 : this.clock.timeSpeedProperty.value === TimeSpeed.NORMAL ? 4 : 7; // TimeSpeed.FAST
    // step the model by the smallest standard time step for the orbital mode
    for (let i = 0; i < numberOfSteps; i++) {
      this.step(smallestTimeStep);

      // Signify that the model completed an entire step so that any batch operations may be invoked
      for (let i = 0; i < this.bodies.length; i++) {
        this.bodies[i].modelStepped();
      }
    }
    this.stepCompleteEmitter.emit();
    return smallestTimeStep * numberOfSteps;
  }

  /**
   * Moves the model forward in time.  This function creates temporary state objects and calculates state values
   * based on the current state of the entire model. Afterwards, it applies the updated values to the body objects.
   * Finally, it checks for collisions between bodies.
   */
  step(dt) {
    // Compute the next state for each body based on the current state of all bodies in the system.
    const bodyStates = this.bodies.map(getBodyState);
    const newState = new ModelState(bodyStates, this.clock, this.adjustMoonOrbit).getNextState(dt, this.gravityEnabledProperty);

    // Set each body to its computed next state.
    // assumes that ModelState.getBodyState returns states in the same order as the container (ArrayList) used for
    // bodies. A possible future improvement would be
    // to switch to use ModelState.getState(Body), which would be safer.
    for (let i = 0; i < this.bodies.length; i++) {
      this.bodies[i].updateBodyStateFromModel(newState.getBodyState(i));
    }
    // when two uncollided bodies collide, destroy the smaller
    for (let j = 0; j < this.bodies.length; j++) {
      const body = this.bodies[j];
      for (let k = 0; k < this.bodies.length; k++) {
        const other = this.bodies[k];
        if (other !== body && !other.isCollidedProperty.value && !body.isCollidedProperty.value) {
          if (other.collidesWidth(body)) {
            getSmaller(other, body).isCollidedProperty.set(true);
          }
        }
      }
    }
  }
  resetAll() {
    this.resetBodies();
    this.clock.resetSimulationTime();
    this.updateForceVectors();
  }

  /**
   * Adds a body and updates the body's force vectors
   */
  addBody(body) {
    this.bodies.push(body);

    // update the force vectors when the position or mass changes
    body.userModifiedPositionEmitter.addListener(() => this.updateForceVectors());
    body.massProperty.link(() => this.updateForceVectors());
    this.updateForceVectors();
  }

  /**
   * Since we haven't (yet?) rewritten the gravity forces to auto-update when dependencies change, we update when
   * necessary:
   * (1) when a new body is added or
   * (2) when reset is pressed
   * This update is done by running the physics engine for dt=0.0 then applying the computed forces to the bodies.
   * Without this block of code, the force vectors would be zero on sim startup until the clock is started.
   */
  updateForceVectors() {
    this.step(0);
  }

  /**
   * Returns a defensive copy of the bodies.
   */
  getBodies() {
    return this.bodies.slice(0); // operate on a copy, firing could result in the listeners changing
  }

  resetBodies() {
    this.bodies.forEach(body => body.resetAll());
    this.updateForceVectors(); // has to be done separately since physics is computed as a batch
  }

  /**
   * Get the body associated with the name.
   */
  getBody(type) {
    for (let i = 0; i < this.bodies.length; i++) {
      const body = this.bodies[i];
      if (body.type === type) {
        return body;
      }
    }
    return null;
  }
}
gravityAndOrbits.register('GravityAndOrbitsPhysicsEngine', GravityAndOrbitsPhysicsEngine);
export default GravityAndOrbitsPhysicsEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFbWl0dGVyIiwiVGltZVNwZWVkIiwiZ3Jhdml0eUFuZE9yYml0cyIsIk1vZGVsU3RhdGUiLCJnZXRTbWFsbGVyIiwib3RoZXIiLCJib2R5IiwibWFzc1Byb3BlcnR5IiwiZ2V0IiwiZ2V0Qm9keVN0YXRlIiwidG9Cb2R5U3RhdGUiLCJHcmF2aXR5QW5kT3JiaXRzUGh5c2ljc0VuZ2luZSIsImNvbnN0cnVjdG9yIiwiY2xvY2siLCJncmF2aXR5RW5hYmxlZFByb3BlcnR5IiwiYWRqdXN0TW9vbk9yYml0IiwiYm9kaWVzIiwiYWRkRXZlbnRUaW1lciIsImR0IiwiZWxhcHNlZFRpbWUiLCJzdGVwTW9kZWwiLCJzZXRTaW11bGF0aW9uVGltZSIsImdldFNpbXVsYXRpb25UaW1lIiwibGluayIsInVwZGF0ZUZvcmNlVmVjdG9ycyIsImJpbmQiLCJzdGVwQ29tcGxldGVFbWl0dGVyIiwiZm9yRWFjaCIsInN0b3JlUHJldmlvdXNQb3NpdGlvbiIsInNtYWxsZXN0VGltZVN0ZXAiLCJiYXNlRFRWYWx1ZSIsIm51bWJlck9mU3RlcHMiLCJ0aW1lU3BlZWRQcm9wZXJ0eSIsInZhbHVlIiwiU0xPVyIsIk5PUk1BTCIsImkiLCJzdGVwIiwibGVuZ3RoIiwibW9kZWxTdGVwcGVkIiwiZW1pdCIsImJvZHlTdGF0ZXMiLCJtYXAiLCJuZXdTdGF0ZSIsImdldE5leHRTdGF0ZSIsInVwZGF0ZUJvZHlTdGF0ZUZyb21Nb2RlbCIsImoiLCJrIiwiaXNDb2xsaWRlZFByb3BlcnR5IiwiY29sbGlkZXNXaWR0aCIsInNldCIsInJlc2V0QWxsIiwicmVzZXRCb2RpZXMiLCJyZXNldFNpbXVsYXRpb25UaW1lIiwiYWRkQm9keSIsInB1c2giLCJ1c2VyTW9kaWZpZWRQb3NpdGlvbkVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsImdldEJvZGllcyIsInNsaWNlIiwiZ2V0Qm9keSIsInR5cGUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkdyYXZpdHlBbmRPcmJpdHNQaHlzaWNzRW5naW5lLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRoaXMgaXMgdGhlIG1vZGVsIGZvciBHcmF2aXR5IGFuZCBPcmJpdHM7IHRoZXJlIGlzIG9uZSBHcmF2aXR5QW5kT3JiaXRzUGh5c2ljc0VuZ2luZSBwZXIgZWFjaCBHcmF2aXR5QW5kT3JiaXRzU2NlbmUsIGFuZCBpdFxyXG4gKiB1c2VzIE1vZGVsU3RhdGUgdG8gdXBkYXRlIHRoZSBwaHlzaWNzLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEFhcm9uIERhdmlzIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW1pdHRlci5qcyc7XHJcbmltcG9ydCBUaW1lU3BlZWQgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1RpbWVTcGVlZC5qcyc7XHJcbmltcG9ydCBncmF2aXR5QW5kT3JiaXRzIGZyb20gJy4uLy4uL2dyYXZpdHlBbmRPcmJpdHMuanMnO1xyXG5pbXBvcnQgTW9kZWxTdGF0ZSBmcm9tICcuL01vZGVsU3RhdGUuanMnO1xyXG5pbXBvcnQgQm9keSBmcm9tICcuL0JvZHkuanMnO1xyXG5pbXBvcnQgR3Jhdml0eUFuZE9yYml0c0Nsb2NrIGZyb20gJy4vR3Jhdml0eUFuZE9yYml0c0Nsb2NrLmpzJztcclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQm9keVR5cGVFbnVtIGZyb20gJy4vQm9keVR5cGVFbnVtLmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5cclxuLyoqXHJcbiAqIFJldHVybiB0aGUgc21hbGxlciBvZiB0d28gQm9keSBpbnN0YW5jZXMsIGZvciBkZXRlcm1pbmluZyB3aGljaCBzdXJ2aXZlcyBhIGNvbGxpc2lvbi5cclxuICogQHBhcmFtIG90aGVyXHJcbiAqIEBwYXJhbSBib2R5XHJcbiAqIEByZXR1cm5zIHRoZSBzbWFsbGVyIGJvZHlcclxuICovXHJcbmNvbnN0IGdldFNtYWxsZXIgPSAoIG90aGVyOiBCb2R5LCBib2R5OiBCb2R5ICk6IEJvZHkgPT4gb3RoZXIubWFzc1Byb3BlcnR5LmdldCgpIDwgYm9keS5tYXNzUHJvcGVydHkuZ2V0KCkgPyBvdGhlciA6IGJvZHk7XHJcblxyXG4vKipcclxuICogRm9yIHVzZSBpbnNpZGUgYSBtYXAgY2FsbCwgZmFjdG9yZWQgb3V0IGhlcmUgZm9yIHBlcmZvcm1hbmNlXHJcbiAqL1xyXG5jb25zdCBnZXRCb2R5U3RhdGUgPSAoIGJvZHk6IEJvZHkgKSA9PiBib2R5LnRvQm9keVN0YXRlKCk7XHJcblxyXG5jbGFzcyBHcmF2aXR5QW5kT3JiaXRzUGh5c2ljc0VuZ2luZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBncmF2aXR5RW5hYmxlZFByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGFkanVzdE1vb25PcmJpdDogYm9vbGVhbjtcclxuICBwdWJsaWMgcmVhZG9ubHkgY2xvY2s6IEdyYXZpdHlBbmRPcmJpdHNDbG9jaztcclxuICBwdWJsaWMgcmVhZG9ubHkgYm9kaWVzOiBCb2R5W107XHJcbiAgcHJpdmF0ZSByZWFkb25seSBzdGVwQ29tcGxldGVFbWl0dGVyOiBURW1pdHRlcjtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGNsb2NrXHJcbiAgICogQHBhcmFtIGdyYXZpdHlFbmFibGVkUHJvcGVydHkgZmxhZyB0byBpbmRpY2F0ZSB3aGV0aGVyIGdyYXZpdHkgaXMgb24gb3Igb2ZmLlxyXG4gICAqIEBwYXJhbSBhZGp1c3RNb29uT3JiaXQgLSBpbiB0aGUgXCJNb2RlbFwiIHNjcmVlbiwgdGhlcmUgaXMgYW4gYWRkaXRpb25hbCBmb3JjZSBmcm9tIHRoZSBFYXJ0aCBvbiB0aGUgTW9vbiB0byBrZWVwIGl0IGluIG9yYml0XHJcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLSBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIHRoZSBtb29uIG9yYml0YWwgcmFkaXVzIGlzIGhpZ2hlciAoc28gaXQgaXMgdmlzaWJsZSlcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGNsb2NrOiBHcmF2aXR5QW5kT3JiaXRzQ2xvY2ssIGdyYXZpdHlFbmFibGVkUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+LCBhZGp1c3RNb29uT3JiaXQ6IGJvb2xlYW4gKSB7XHJcblxyXG4gICAgdGhpcy5ncmF2aXR5RW5hYmxlZFByb3BlcnR5ID0gZ3Jhdml0eUVuYWJsZWRQcm9wZXJ0eTtcclxuICAgIHRoaXMuYWRqdXN0TW9vbk9yYml0ID0gYWRqdXN0TW9vbk9yYml0O1xyXG5cclxuICAgIHRoaXMuY2xvY2sgPSBjbG9jaztcclxuXHJcbiAgICAvLyB7Qm9keVtdfSAtIGNvbnRhaW5zIHRoZSBzdW4sIG1vb24sIGVhcnRoLCBzYXRlbGxpdGVcclxuICAgIHRoaXMuYm9kaWVzID0gW107XHJcblxyXG4gICAgdGhpcy5jbG9jay5hZGRFdmVudFRpbWVyKCAoIGR0OiBudW1iZXIgKSA9PiB7XHJcblxyXG4gICAgICAvLyBOT1RFOiByZXBsYWNpbmcgc3RlcCB3aXRoIHN0ZXBNb2RlbCBmaXhlcyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvZ3Jhdml0eS1hbmQtb3JiaXRzL2lzc3Vlcy8yNTNcclxuICAgICAgLy8gYnV0IGludHJvZHVjZXMgcGVyZm9ybWFuY2UgaXNzdWVzXHJcbiAgICAgIGNvbnN0IGVsYXBzZWRUaW1lID0gdGhpcy5zdGVwTW9kZWwoKTtcclxuICAgICAgdGhpcy5jbG9jay5zZXRTaW11bGF0aW9uVGltZSggdGhpcy5jbG9jay5nZXRTaW11bGF0aW9uVGltZSgpICsgZWxhcHNlZFRpbWUgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBIYXZlIHRvIHVwZGF0ZSBmb3JjZSB2ZWN0b3JzIHdoZW4gZ3Jhdml0eSBnZXRzIHRvZ2dsZWQgb24gYW5kIG9mZiwgb3RoZXJ3aXNlIGRpc3BsYXllZCB2YWx1ZSB3b24ndCB1cGRhdGVcclxuICAgIHRoaXMuZ3Jhdml0eUVuYWJsZWRQcm9wZXJ0eS5saW5rKCB0aGlzLnVwZGF0ZUZvcmNlVmVjdG9ycy5iaW5kKCB0aGlzICkgKTtcclxuXHJcbiAgICB0aGlzLnN0ZXBDb21wbGV0ZUVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RhbmRhcmRpemUgdGhlIHRpbWUgc3RlcCBzbyB0aGF0IHRoZSBwbGF5IHNwZWVkIGhhcyBubyBpbXBhY3Qgb24gdGhlIG1vZGVsLiBGb3IgYSBsYXJnZSB0aW1lIHN0ZXAsIHdlIGJyZWFrXHJcbiAgICogYXBhcnQgdGhlIGNoYW5nZSBpbiB0aW1lIGludG8gYSBzZXJpZXMgb2YgdGltZSBzdGVwcy4gIFRoaXMgZW5zdXJlcyB0aGF0IHRoaXMuc3RlcCBhbmQgdGhlIG5leHQgbW9kZWwgc3RhdGUgaXNcclxuICAgKiBjYWxjdWxhdGVkIHdpdGggY29uc2lzdGVudCBjaGFuZ2VzIGluIHRpbWUuXHJcbiAgICpcclxuICAgKiBAcmV0dXJucyBlbGFwc2VkIHRpbWVcclxuICAgKi9cclxuICBwcml2YXRlIHN0ZXBNb2RlbCgpOiBudW1iZXIge1xyXG5cclxuICAgIHRoaXMuYm9kaWVzLmZvckVhY2goIGJvZHkgPT4gYm9keS5zdG9yZVByZXZpb3VzUG9zaXRpb24oKSApO1xyXG5cclxuICAgIC8vIHN0YW5kYXJkaXplZCB0aW1lIHN0ZXAgLSBiYXNlZCBvbiB0aGUgc2xvd2VzdCB0aW1lIHN0ZXAgZm9yIHRoZSBnaXZlbiBvcmJpdGFsIG1vZGVcclxuICAgIGNvbnN0IHNtYWxsZXN0VGltZVN0ZXAgPSB0aGlzLmNsb2NrLmJhc2VEVFZhbHVlICogMC4xMzEyNTtcclxuXHJcbiAgICAvLyBnZXQgdGhlIG51bWJlciBvZiB0aW1lcyB3ZSB3aWxsIG5lZWQgdG8gc3RlcCB0aGUgbW9kZWwgYmFzZWQgb24gdGhlIGR0IHBhc3NlZCBpblxyXG4gICAgY29uc3QgbnVtYmVyT2ZTdGVwcyA9IHRoaXMuY2xvY2sudGltZVNwZWVkUHJvcGVydHkudmFsdWUgPT09IFRpbWVTcGVlZC5TTE9XID8gMSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9jay50aW1lU3BlZWRQcm9wZXJ0eS52YWx1ZSA9PT0gVGltZVNwZWVkLk5PUk1BTCA/IDQgOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIDc7IC8vIFRpbWVTcGVlZC5GQVNUXHJcbiAgICAvLyBzdGVwIHRoZSBtb2RlbCBieSB0aGUgc21hbGxlc3Qgc3RhbmRhcmQgdGltZSBzdGVwIGZvciB0aGUgb3JiaXRhbCBtb2RlXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBudW1iZXJPZlN0ZXBzOyBpKysgKSB7XHJcbiAgICAgIHRoaXMuc3RlcCggc21hbGxlc3RUaW1lU3RlcCApO1xyXG5cclxuICAgICAgLy8gU2lnbmlmeSB0aGF0IHRoZSBtb2RlbCBjb21wbGV0ZWQgYW4gZW50aXJlIHN0ZXAgc28gdGhhdCBhbnkgYmF0Y2ggb3BlcmF0aW9ucyBtYXkgYmUgaW52b2tlZFxyXG4gICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmJvZGllcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICB0aGlzLmJvZGllc1sgaSBdLm1vZGVsU3RlcHBlZCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdGVwQ29tcGxldGVFbWl0dGVyLmVtaXQoKTtcclxuXHJcbiAgICByZXR1cm4gc21hbGxlc3RUaW1lU3RlcCAqIG51bWJlck9mU3RlcHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNb3ZlcyB0aGUgbW9kZWwgZm9yd2FyZCBpbiB0aW1lLiAgVGhpcyBmdW5jdGlvbiBjcmVhdGVzIHRlbXBvcmFyeSBzdGF0ZSBvYmplY3RzIGFuZCBjYWxjdWxhdGVzIHN0YXRlIHZhbHVlc1xyXG4gICAqIGJhc2VkIG9uIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBlbnRpcmUgbW9kZWwuIEFmdGVyd2FyZHMsIGl0IGFwcGxpZXMgdGhlIHVwZGF0ZWQgdmFsdWVzIHRvIHRoZSBib2R5IG9iamVjdHMuXHJcbiAgICogRmluYWxseSwgaXQgY2hlY2tzIGZvciBjb2xsaXNpb25zIGJldHdlZW4gYm9kaWVzLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RlcCggZHQ6IG51bWJlciApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBDb21wdXRlIHRoZSBuZXh0IHN0YXRlIGZvciBlYWNoIGJvZHkgYmFzZWQgb24gdGhlIGN1cnJlbnQgc3RhdGUgb2YgYWxsIGJvZGllcyBpbiB0aGUgc3lzdGVtLlxyXG4gICAgY29uc3QgYm9keVN0YXRlcyA9IHRoaXMuYm9kaWVzLm1hcCggZ2V0Qm9keVN0YXRlICk7XHJcbiAgICBjb25zdCBuZXdTdGF0ZSA9IG5ldyBNb2RlbFN0YXRlKCBib2R5U3RhdGVzLCB0aGlzLmNsb2NrLCB0aGlzLmFkanVzdE1vb25PcmJpdCApLmdldE5leHRTdGF0ZSggZHQsIHRoaXMuZ3Jhdml0eUVuYWJsZWRQcm9wZXJ0eSApO1xyXG5cclxuICAgIC8vIFNldCBlYWNoIGJvZHkgdG8gaXRzIGNvbXB1dGVkIG5leHQgc3RhdGUuXHJcbiAgICAvLyBhc3N1bWVzIHRoYXQgTW9kZWxTdGF0ZS5nZXRCb2R5U3RhdGUgcmV0dXJucyBzdGF0ZXMgaW4gdGhlIHNhbWUgb3JkZXIgYXMgdGhlIGNvbnRhaW5lciAoQXJyYXlMaXN0KSB1c2VkIGZvclxyXG4gICAgLy8gYm9kaWVzLiBBIHBvc3NpYmxlIGZ1dHVyZSBpbXByb3ZlbWVudCB3b3VsZCBiZVxyXG4gICAgLy8gdG8gc3dpdGNoIHRvIHVzZSBNb2RlbFN0YXRlLmdldFN0YXRlKEJvZHkpLCB3aGljaCB3b3VsZCBiZSBzYWZlci5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuYm9kaWVzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICB0aGlzLmJvZGllc1sgaSBdLnVwZGF0ZUJvZHlTdGF0ZUZyb21Nb2RlbCggbmV3U3RhdGUuZ2V0Qm9keVN0YXRlKCBpICkgKTtcclxuICAgIH1cclxuICAgIC8vIHdoZW4gdHdvIHVuY29sbGlkZWQgYm9kaWVzIGNvbGxpZGUsIGRlc3Ryb3kgdGhlIHNtYWxsZXJcclxuICAgIGZvciAoIGxldCBqID0gMDsgaiA8IHRoaXMuYm9kaWVzLmxlbmd0aDsgaisrICkge1xyXG4gICAgICBjb25zdCBib2R5ID0gdGhpcy5ib2RpZXNbIGogXTtcclxuICAgICAgZm9yICggbGV0IGsgPSAwOyBrIDwgdGhpcy5ib2RpZXMubGVuZ3RoOyBrKysgKSB7XHJcbiAgICAgICAgY29uc3Qgb3RoZXIgPSB0aGlzLmJvZGllc1sgayBdO1xyXG4gICAgICAgIGlmICggb3RoZXIgIT09IGJvZHkgJiYgIW90aGVyLmlzQ29sbGlkZWRQcm9wZXJ0eS52YWx1ZSAmJiAhYm9keS5pc0NvbGxpZGVkUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgICAgICBpZiAoIG90aGVyLmNvbGxpZGVzV2lkdGgoIGJvZHkgKSApIHtcclxuICAgICAgICAgICAgZ2V0U21hbGxlciggb3RoZXIsIGJvZHkgKS5pc0NvbGxpZGVkUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXRBbGwoKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlc2V0Qm9kaWVzKCk7XHJcbiAgICB0aGlzLmNsb2NrLnJlc2V0U2ltdWxhdGlvblRpbWUoKTtcclxuICAgIHRoaXMudXBkYXRlRm9yY2VWZWN0b3JzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIGEgYm9keSBhbmQgdXBkYXRlcyB0aGUgYm9keSdzIGZvcmNlIHZlY3RvcnNcclxuICAgKi9cclxuICBwdWJsaWMgYWRkQm9keSggYm9keTogQm9keSApOiB2b2lkIHtcclxuICAgIHRoaXMuYm9kaWVzLnB1c2goIGJvZHkgKTtcclxuXHJcbiAgICAvLyB1cGRhdGUgdGhlIGZvcmNlIHZlY3RvcnMgd2hlbiB0aGUgcG9zaXRpb24gb3IgbWFzcyBjaGFuZ2VzXHJcbiAgICBib2R5LnVzZXJNb2RpZmllZFBvc2l0aW9uRW1pdHRlci5hZGRMaXN0ZW5lciggKCkgPT4gdGhpcy51cGRhdGVGb3JjZVZlY3RvcnMoKSApO1xyXG4gICAgYm9keS5tYXNzUHJvcGVydHkubGluayggKCkgPT4gdGhpcy51cGRhdGVGb3JjZVZlY3RvcnMoKSApO1xyXG4gICAgdGhpcy51cGRhdGVGb3JjZVZlY3RvcnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNpbmNlIHdlIGhhdmVuJ3QgKHlldD8pIHJld3JpdHRlbiB0aGUgZ3Jhdml0eSBmb3JjZXMgdG8gYXV0by11cGRhdGUgd2hlbiBkZXBlbmRlbmNpZXMgY2hhbmdlLCB3ZSB1cGRhdGUgd2hlblxyXG4gICAqIG5lY2Vzc2FyeTpcclxuICAgKiAoMSkgd2hlbiBhIG5ldyBib2R5IGlzIGFkZGVkIG9yXHJcbiAgICogKDIpIHdoZW4gcmVzZXQgaXMgcHJlc3NlZFxyXG4gICAqIFRoaXMgdXBkYXRlIGlzIGRvbmUgYnkgcnVubmluZyB0aGUgcGh5c2ljcyBlbmdpbmUgZm9yIGR0PTAuMCB0aGVuIGFwcGx5aW5nIHRoZSBjb21wdXRlZCBmb3JjZXMgdG8gdGhlIGJvZGllcy5cclxuICAgKiBXaXRob3V0IHRoaXMgYmxvY2sgb2YgY29kZSwgdGhlIGZvcmNlIHZlY3RvcnMgd291bGQgYmUgemVybyBvbiBzaW0gc3RhcnR1cCB1bnRpbCB0aGUgY2xvY2sgaXMgc3RhcnRlZC5cclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlRm9yY2VWZWN0b3JzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zdGVwKCAwICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGEgZGVmZW5zaXZlIGNvcHkgb2YgdGhlIGJvZGllcy5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Qm9kaWVzKCk6IEJvZHlbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5ib2RpZXMuc2xpY2UoIDAgKTsgLy8gb3BlcmF0ZSBvbiBhIGNvcHksIGZpcmluZyBjb3VsZCByZXN1bHQgaW4gdGhlIGxpc3RlbmVycyBjaGFuZ2luZ1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0Qm9kaWVzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5ib2RpZXMuZm9yRWFjaCggYm9keSA9PiBib2R5LnJlc2V0QWxsKCkgKTtcclxuICAgIHRoaXMudXBkYXRlRm9yY2VWZWN0b3JzKCk7IC8vIGhhcyB0byBiZSBkb25lIHNlcGFyYXRlbHkgc2luY2UgcGh5c2ljcyBpcyBjb21wdXRlZCBhcyBhIGJhdGNoXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgdGhlIGJvZHkgYXNzb2NpYXRlZCB3aXRoIHRoZSBuYW1lLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Qm9keSggdHlwZTogQm9keVR5cGVFbnVtICk6IEJvZHkgfCBudWxsIHtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuYm9kaWVzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICBjb25zdCBib2R5ID0gdGhpcy5ib2RpZXNbIGkgXTtcclxuXHJcbiAgICAgIGlmICggYm9keS50eXBlID09PSB0eXBlICkge1xyXG4gICAgICAgIHJldHVybiBib2R5O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmdyYXZpdHlBbmRPcmJpdHMucmVnaXN0ZXIoICdHcmF2aXR5QW5kT3JiaXRzUGh5c2ljc0VuZ2luZScsIEdyYXZpdHlBbmRPcmJpdHNQaHlzaWNzRW5naW5lICk7XHJcbmV4cG9ydCBkZWZhdWx0IEdyYXZpdHlBbmRPcmJp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