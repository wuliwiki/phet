// Copyright 2020-2022, University of Colorado Boulder

/**
 * Model for common properties/behaviours used by all scenes/screens in the sim. This class is incomplete and meant to
 * be subclassed. It is assumed that all instances of this class are present for the lifetime of the simulation.
 *
 * @author Saurabh Totey
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import EnumerationDeprecatedProperty from '../../../../axon/js/EnumerationDeprecatedProperty.js';
import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import merge from '../../../../phet-core/js/merge.js';
import numberLineDistance from '../../numberLineDistance.js';
import NLDConstants from '../NLDConstants.js';
import DistanceRepresentation from './DistanceRepresentation.js';
class AbstractNLDBaseModel {
  /**
   * This constructor initializes common values and properties for the model.
   * Parameters require two point controllers because every screen/scene in this sim has two point controllers.
   *
   * @param {SpatializedNumberLine} numberLine
   * @param {PointController} pointControllerOne
   * @param {PointController} pointControllerTwo
   * @param {Tandem} tandem
   * @param {Object} [options]
   */
  constructor(numberLine, pointControllerOne, pointControllerTwo, tandem, options) {
    // @private
    this.options = merge({
      positionInBoxOffset: new Vector2(0, 0)
    }, options);

    // @public {Property.<Boolean>}
    this.distanceLabelsVisibleProperty = new BooleanProperty(true);

    // @public {Property.<Boolean>}
    this.distanceDescriptionVisibleProperty = new BooleanProperty(true);

    // @public {Property.<DistanceRepresentation>}
    this.distanceRepresentationProperty = new EnumerationDeprecatedProperty(DistanceRepresentation, DistanceRepresentation.ABSOLUTE);

    // @public {Property.<Boolean>} - whether the x_1 and x_2 or y_1 and y_2 nodes are swapped
    // An 'isSwapped' approach was taken rather than reordering the point controllers in some array because it is
    // often useful to know which point controller is which and to be able to consistently access the same point controller
    // regardless of whether it is the primary point controller or not.
    this.isPrimaryControllerSwappedProperty = new BooleanProperty(false);

    // @public {SpatializedNumberLine}
    this.numberLine = numberLine;

    // @public {PointController} - the point controllers in the sim
    // this.pointControllerOne is the 'primary' point controller unless this.isPrimaryNodeSwappedProperty in which case
    // this.pointControllerTwo is the 'primary' point controller.
    // The ordering of point controllers is necessary for all sorts of behaviours in this sim (e.g. directed distance,
    // distance statements, etc.).
    this.pointControllerOne = pointControllerOne;
    this.pointControllerTwo = pointControllerTwo;

    // @public (read-only) {Property.<number|null>} a Property that stores the number line point values of the point controllers
    // in the order that the point controllers were given to this model. If a point controller doesn't have a number
    // line point, then null is recorded in the array instead. The stored array is always of length 2:
    // index 0 corresponds to the value of the number line point of this.pointControllerOne and index 1 corresponds to
    // the value of the number line point of this.pointControllerTwo.
    this.pointValuesProperty = new Property([null, null], {
      valueType: Array,
      isValidValue: array => Array.isArray(array) && array.length === 2 && _.every(array, element => element === null || typeof element === 'number')
    });

    // Listen to the numberLine and its points to make updates to pointsValueProperty when necessary. Ideally, we would
    // listen to the residentPoints of this.numberLine so I wouldn't duplicate code per controller, but it is necessary
    // to know which point controller each number line point belongs to, and points can be added to the number line
    // before they are associated with a point controller.
    this.pointControllerOne.numberLinePoints.addItemAddedListener(numberLinePoint => {
      const updatePointValuesProperty = value => {
        this.pointValuesProperty.value = [value, this.pointValuesProperty.value[1]];
      };
      numberLinePoint.valueProperty.link(updatePointValuesProperty);
      const itemRemovedListener = removedNumberLinePoint => {
        if (removedNumberLinePoint === numberLinePoint) {
          numberLinePoint.valueProperty.unlink(updatePointValuesProperty);
          updatePointValuesProperty(null);
          this.pointControllerOne.numberLinePoints.removeItemRemovedListener(itemRemovedListener);
        }
      };
      this.pointControllerOne.numberLinePoints.addItemRemovedListener(itemRemovedListener);
    });
    this.pointControllerTwo.numberLinePoints.addItemAddedListener(numberLinePoint => {
      const updatePointValuesProperty = value => {
        this.pointValuesProperty.value = [this.pointValuesProperty.value[0], value];
      };
      numberLinePoint.valueProperty.link(updatePointValuesProperty);
      const itemRemovedListener = removedNumberLinePoint => {
        if (removedNumberLinePoint === numberLinePoint) {
          numberLinePoint.valueProperty.unlink(updatePointValuesProperty);
          updatePointValuesProperty(null);
          this.pointControllerTwo.numberLinePoints.removeItemRemovedListener(itemRemovedListener);
        }
      };
      this.pointControllerTwo.numberLinePoints.addItemRemovedListener(itemRemovedListener);
    });

    // @public {Property.<Bounds2>} the bounds of the toolbox that point controllers return to The box bounds change
    // with number line orientation in the generic screen.
    this.pointControllerBoxProperty = new Property(NLDConstants.BOTTOM_BOX_BOUNDS, {
      valueType: Bounds2
    });
    this.pointControllers.forEach(pointController => {
      this.putPointControllerInBox(pointController);

      // Set up the listeners that will place the point controllers back in their default positions when released over
      // the active point controller box.
      pointController.isDraggingProperty.lazyLink(dragging => {
        // If the point controller is released and it's not controlling a point on the number line, put it away.
        if (!dragging && !pointController.isControllingNumberLinePoint()) {
          this.putPointControllerInBox(pointController, true);
        }
      });
    });

    // Manage point controllers on orientation change.
    this.numberLine.orientationProperty.lazyLink(() => {
      this.pointControllers.filter(pointController => pointController.isControllingNumberLinePoint()).forEach(pointController => {
        // There should only be one controlled point.
        assert && assert(pointController.numberLinePoints.length === 1);
        pointController.setPositionRelativeToPoint(pointController.numberLinePoints.get(0));
      });
    });

    // If point controllers were in the box and the box bounds changed, move the points.
    this.pointControllerBoxProperty.lazyLink((newBoxBounds, oldBoxBounds) => {
      this.pointControllers.forEach(pointController => {
        // If the point controller is animating, stop it and put it in the box.
        if (pointController.inProgressAnimationProperty.value) {
          pointController.stopAnimation();
          this.putPointControllerInBox(pointController);
        }

        // If the point controller was sitting in the previous box, move it to the new one.
        else if (oldBoxBounds.containsPoint(pointController.positionProperty.value) && !pointController.isDraggingProperty.value && !pointController.isControllingNumberLinePoint()) {
          this.putPointControllerInBox(pointController);
        }
      });
    });
  }

  /**
   * Place the provided point controller into the currently active box.
   * Generally done on init, reset, and when the user "puts it away".
   *
   * @param {PointController} pointController
   * @param {boolean} [animate] - controls whether to animate the return to the box or do it instantly
   * @private
   */
  putPointControllerInBox(pointController, animate = false) {
    const index = this.pointControllers.indexOf(pointController);
    const numberOfPositions = this.pointControllers.length;

    // error checking
    assert && assert(index >= 0, 'point controller not found on list');
    assert && assert(!pointController.isControllingNumberLinePoint(), 'point controller should not be put away while controlling a point');
    let destination;

    // decide which box and at which position the point controller should be placed
    if (this.pointControllerBoxProperty.value === NLDConstants.BOTTOM_BOX_BOUNDS) {
      // put point in box at bottom of screen
      const spacing = NLDConstants.BOTTOM_BOX_BOUNDS.width / numberOfPositions;
      destination = new Vector2(NLDConstants.BOTTOM_BOX_BOUNDS.minX + spacing / 2 + spacing * index, NLDConstants.BOTTOM_BOX_BOUNDS.centerY).plus(this.options.positionInBoxOffset);
    } else if (this.pointControllerBoxProperty.value === NLDConstants.SIDE_BOX_BOUNDS) {
      // put point in box at side of screen
      const spacing = NLDConstants.SIDE_BOX_BOUNDS.height / numberOfPositions;
      destination = new Vector2(NLDConstants.SIDE_BOX_BOUNDS.centerX, NLDConstants.SIDE_BOX_BOUNDS.minY + spacing / 2 + spacing * index).plus(this.options.positionInBoxOffset);
    } else {
      assert && assert(false, 'cannot put point controller away if box is not the bottom box or side box');
    }
    pointController.goToPosition(destination, animate);
  }

  /**
   * Get both point controllers as a list.
   * Always returns this.pointControllerOne as the first element of the list, which means that this method
   * doesn't order the point controllers by which one is the primary one.
   *
   * @returns {PointController[]}
   * @public
   */
  getPointControllers() {
    return [this.pointControllerOne, this.pointControllerTwo];
  }
  get pointControllers() {
    return this.getPointControllers();
  }

  /**
   * Return whether both point controllers are controlling number line points that live on the number line
   * @public
   */
  areBothPointControllersControllingOnNumberLine() {
    return this.pointValuesProperty.value.filter(pointValue => pointValue !== null).length === 2;
  }

  /**
   * Resets the model
   * @public
   */
  reset() {
    this.pointControllers.forEach(pointController => {
      pointController.reset();
      this.putPointControllerInBox(pointController);
    });
    this.distanceLabelsVisibleProperty.reset();
    this.distanceDescriptionVisibleProperty.reset();
    this.distanceRepresentationProperty.reset();
    this.isPrimaryControllerSwappedProperty.reset();
    this.numberLine.reset();
    this.pointControllerBoxProperty.reset();
  }
}
numberLineDistance.register('AbstractNLDBaseModel', AbstractNLDBaseModel);
export default AbstractNLDBaseModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJFbnVtZXJhdGlvbkRlcHJlY2F0ZWRQcm9wZXJ0eSIsIlByb3BlcnR5IiwiQm91bmRzMiIsIlZlY3RvcjIiLCJtZXJnZSIsIm51bWJlckxpbmVEaXN0YW5jZSIsIk5MRENvbnN0YW50cyIsIkRpc3RhbmNlUmVwcmVzZW50YXRpb24iLCJBYnN0cmFjdE5MREJhc2VNb2RlbCIsImNvbnN0cnVjdG9yIiwibnVtYmVyTGluZSIsInBvaW50Q29udHJvbGxlck9uZSIsInBvaW50Q29udHJvbGxlclR3byIsInRhbmRlbSIsIm9wdGlvbnMiLCJwb3NpdGlvbkluQm94T2Zmc2V0IiwiZGlzdGFuY2VMYWJlbHNWaXNpYmxlUHJvcGVydHkiLCJkaXN0YW5jZURlc2NyaXB0aW9uVmlzaWJsZVByb3BlcnR5IiwiZGlzdGFuY2VSZXByZXNlbnRhdGlvblByb3BlcnR5IiwiQUJTT0xVVEUiLCJpc1ByaW1hcnlDb250cm9sbGVyU3dhcHBlZFByb3BlcnR5IiwicG9pbnRWYWx1ZXNQcm9wZXJ0eSIsInZhbHVlVHlwZSIsIkFycmF5IiwiaXNWYWxpZFZhbHVlIiwiYXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiXyIsImV2ZXJ5IiwiZWxlbWVudCIsIm51bWJlckxpbmVQb2ludHMiLCJhZGRJdGVtQWRkZWRMaXN0ZW5lciIsIm51bWJlckxpbmVQb2ludCIsInVwZGF0ZVBvaW50VmFsdWVzUHJvcGVydHkiLCJ2YWx1ZSIsInZhbHVlUHJvcGVydHkiLCJsaW5rIiwiaXRlbVJlbW92ZWRMaXN0ZW5lciIsInJlbW92ZWROdW1iZXJMaW5lUG9pbnQiLCJ1bmxpbmsiLCJyZW1vdmVJdGVtUmVtb3ZlZExpc3RlbmVyIiwiYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciIsInBvaW50Q29udHJvbGxlckJveFByb3BlcnR5IiwiQk9UVE9NX0JPWF9CT1VORFMiLCJwb2ludENvbnRyb2xsZXJzIiwiZm9yRWFjaCIsInBvaW50Q29udHJvbGxlciIsInB1dFBvaW50Q29udHJvbGxlckluQm94IiwiaXNEcmFnZ2luZ1Byb3BlcnR5IiwibGF6eUxpbmsiLCJkcmFnZ2luZyIsImlzQ29udHJvbGxpbmdOdW1iZXJMaW5lUG9pbnQiLCJvcmllbnRhdGlvblByb3BlcnR5IiwiZmlsdGVyIiwiYXNzZXJ0Iiwic2V0UG9zaXRpb25SZWxhdGl2ZVRvUG9pbnQiLCJnZXQiLCJuZXdCb3hCb3VuZHMiLCJvbGRCb3hCb3VuZHMiLCJpblByb2dyZXNzQW5pbWF0aW9uUHJvcGVydHkiLCJzdG9wQW5pbWF0aW9uIiwiY29udGFpbnNQb2ludCIsInBvc2l0aW9uUHJvcGVydHkiLCJhbmltYXRlIiwiaW5kZXgiLCJpbmRleE9mIiwibnVtYmVyT2ZQb3NpdGlvbnMiLCJkZXN0aW5hdGlvbiIsInNwYWNpbmciLCJ3aWR0aCIsIm1pblgiLCJjZW50ZXJZIiwicGx1cyIsIlNJREVfQk9YX0JPVU5EUyIsImhlaWdodCIsImNlbnRlclgiLCJtaW5ZIiwiZ29Ub1Bvc2l0aW9uIiwiZ2V0UG9pbnRDb250cm9sbGVycyIsImFyZUJvdGhQb2ludENvbnRyb2xsZXJzQ29udHJvbGxpbmdPbk51bWJlckxpbmUiLCJwb2ludFZhbHVlIiwicmVzZXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkFic3RyYWN0TkxEQmFzZU1vZGVsLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1vZGVsIGZvciBjb21tb24gcHJvcGVydGllcy9iZWhhdmlvdXJzIHVzZWQgYnkgYWxsIHNjZW5lcy9zY3JlZW5zIGluIHRoZSBzaW0uIFRoaXMgY2xhc3MgaXMgaW5jb21wbGV0ZSBhbmQgbWVhbnQgdG9cclxuICogYmUgc3ViY2xhc3NlZC4gSXQgaXMgYXNzdW1lZCB0aGF0IGFsbCBpbnN0YW5jZXMgb2YgdGhpcyBjbGFzcyBhcmUgcHJlc2VudCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW11bGF0aW9uLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhdXJhYmggVG90ZXlcclxuICovXHJcblxyXG5pbXBvcnQgQm9vbGVhblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvQm9vbGVhblByb3BlcnR5LmpzJztcclxuaW1wb3J0IEVudW1lcmF0aW9uRGVwcmVjYXRlZFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW51bWVyYXRpb25EZXByZWNhdGVkUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IG51bWJlckxpbmVEaXN0YW5jZSBmcm9tICcuLi8uLi9udW1iZXJMaW5lRGlzdGFuY2UuanMnO1xyXG5pbXBvcnQgTkxEQ29uc3RhbnRzIGZyb20gJy4uL05MRENvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBEaXN0YW5jZVJlcHJlc2VudGF0aW9uIGZyb20gJy4vRGlzdGFuY2VSZXByZXNlbnRhdGlvbi5qcyc7XHJcblxyXG5jbGFzcyBBYnN0cmFjdE5MREJhc2VNb2RlbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoaXMgY29uc3RydWN0b3IgaW5pdGlhbGl6ZXMgY29tbW9uIHZhbHVlcyBhbmQgcHJvcGVydGllcyBmb3IgdGhlIG1vZGVsLlxyXG4gICAqIFBhcmFtZXRlcnMgcmVxdWlyZSB0d28gcG9pbnQgY29udHJvbGxlcnMgYmVjYXVzZSBldmVyeSBzY3JlZW4vc2NlbmUgaW4gdGhpcyBzaW0gaGFzIHR3byBwb2ludCBjb250cm9sbGVycy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U3BhdGlhbGl6ZWROdW1iZXJMaW5lfSBudW1iZXJMaW5lXHJcbiAgICogQHBhcmFtIHtQb2ludENvbnRyb2xsZXJ9IHBvaW50Q29udHJvbGxlck9uZVxyXG4gICAqIEBwYXJhbSB7UG9pbnRDb250cm9sbGVyfSBwb2ludENvbnRyb2xsZXJUd29cclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBudW1iZXJMaW5lLCBwb2ludENvbnRyb2xsZXJPbmUsIHBvaW50Q29udHJvbGxlclR3bywgdGFuZGVtLCBvcHRpb25zICkge1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLm9wdGlvbnMgPSBtZXJnZSgge1xyXG4gICAgICBwb3NpdGlvbkluQm94T2Zmc2V0OiBuZXcgVmVjdG9yMiggMCwgMCApXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7UHJvcGVydHkuPEJvb2xlYW4+fVxyXG4gICAgdGhpcy5kaXN0YW5jZUxhYmVsc1Zpc2libGVQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIHRydWUgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtQcm9wZXJ0eS48Qm9vbGVhbj59XHJcbiAgICB0aGlzLmRpc3RhbmNlRGVzY3JpcHRpb25WaXNpYmxlUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCB0cnVlICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7UHJvcGVydHkuPERpc3RhbmNlUmVwcmVzZW50YXRpb24+fVxyXG4gICAgdGhpcy5kaXN0YW5jZVJlcHJlc2VudGF0aW9uUHJvcGVydHkgPSBuZXcgRW51bWVyYXRpb25EZXByZWNhdGVkUHJvcGVydHkoIERpc3RhbmNlUmVwcmVzZW50YXRpb24sIERpc3RhbmNlUmVwcmVzZW50YXRpb24uQUJTT0xVVEUgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtQcm9wZXJ0eS48Qm9vbGVhbj59IC0gd2hldGhlciB0aGUgeF8xIGFuZCB4XzIgb3IgeV8xIGFuZCB5XzIgbm9kZXMgYXJlIHN3YXBwZWRcclxuICAgIC8vIEFuICdpc1N3YXBwZWQnIGFwcHJvYWNoIHdhcyB0YWtlbiByYXRoZXIgdGhhbiByZW9yZGVyaW5nIHRoZSBwb2ludCBjb250cm9sbGVycyBpbiBzb21lIGFycmF5IGJlY2F1c2UgaXQgaXNcclxuICAgIC8vIG9mdGVuIHVzZWZ1bCB0byBrbm93IHdoaWNoIHBvaW50IGNvbnRyb2xsZXIgaXMgd2hpY2ggYW5kIHRvIGJlIGFibGUgdG8gY29uc2lzdGVudGx5IGFjY2VzcyB0aGUgc2FtZSBwb2ludCBjb250cm9sbGVyXHJcbiAgICAvLyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgaXQgaXMgdGhlIHByaW1hcnkgcG9pbnQgY29udHJvbGxlciBvciBub3QuXHJcbiAgICB0aGlzLmlzUHJpbWFyeUNvbnRyb2xsZXJTd2FwcGVkUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBmYWxzZSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge1NwYXRpYWxpemVkTnVtYmVyTGluZX1cclxuICAgIHRoaXMubnVtYmVyTGluZSA9IG51bWJlckxpbmU7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7UG9pbnRDb250cm9sbGVyfSAtIHRoZSBwb2ludCBjb250cm9sbGVycyBpbiB0aGUgc2ltXHJcbiAgICAvLyB0aGlzLnBvaW50Q29udHJvbGxlck9uZSBpcyB0aGUgJ3ByaW1hcnknIHBvaW50IGNvbnRyb2xsZXIgdW5sZXNzIHRoaXMuaXNQcmltYXJ5Tm9kZVN3YXBwZWRQcm9wZXJ0eSBpbiB3aGljaCBjYXNlXHJcbiAgICAvLyB0aGlzLnBvaW50Q29udHJvbGxlclR3byBpcyB0aGUgJ3ByaW1hcnknIHBvaW50IGNvbnRyb2xsZXIuXHJcbiAgICAvLyBUaGUgb3JkZXJpbmcgb2YgcG9pbnQgY29udHJvbGxlcnMgaXMgbmVjZXNzYXJ5IGZvciBhbGwgc29ydHMgb2YgYmVoYXZpb3VycyBpbiB0aGlzIHNpbSAoZS5nLiBkaXJlY3RlZCBkaXN0YW5jZSxcclxuICAgIC8vIGRpc3RhbmNlIHN0YXRlbWVudHMsIGV0Yy4pLlxyXG4gICAgdGhpcy5wb2ludENvbnRyb2xsZXJPbmUgPSBwb2ludENvbnRyb2xsZXJPbmU7XHJcbiAgICB0aGlzLnBvaW50Q29udHJvbGxlclR3byA9IHBvaW50Q29udHJvbGxlclR3bztcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtQcm9wZXJ0eS48bnVtYmVyfG51bGw+fSBhIFByb3BlcnR5IHRoYXQgc3RvcmVzIHRoZSBudW1iZXIgbGluZSBwb2ludCB2YWx1ZXMgb2YgdGhlIHBvaW50IGNvbnRyb2xsZXJzXHJcbiAgICAvLyBpbiB0aGUgb3JkZXIgdGhhdCB0aGUgcG9pbnQgY29udHJvbGxlcnMgd2VyZSBnaXZlbiB0byB0aGlzIG1vZGVsLiBJZiBhIHBvaW50IGNvbnRyb2xsZXIgZG9lc24ndCBoYXZlIGEgbnVtYmVyXHJcbiAgICAvLyBsaW5lIHBvaW50LCB0aGVuIG51bGwgaXMgcmVjb3JkZWQgaW4gdGhlIGFycmF5IGluc3RlYWQuIFRoZSBzdG9yZWQgYXJyYXkgaXMgYWx3YXlzIG9mIGxlbmd0aCAyOlxyXG4gICAgLy8gaW5kZXggMCBjb3JyZXNwb25kcyB0byB0aGUgdmFsdWUgb2YgdGhlIG51bWJlciBsaW5lIHBvaW50IG9mIHRoaXMucG9pbnRDb250cm9sbGVyT25lIGFuZCBpbmRleCAxIGNvcnJlc3BvbmRzIHRvXHJcbiAgICAvLyB0aGUgdmFsdWUgb2YgdGhlIG51bWJlciBsaW5lIHBvaW50IG9mIHRoaXMucG9pbnRDb250cm9sbGVyVHdvLlxyXG4gICAgdGhpcy5wb2ludFZhbHVlc1Byb3BlcnR5ID0gbmV3IFByb3BlcnR5KCBbIG51bGwsIG51bGwgXSwge1xyXG4gICAgICB2YWx1ZVR5cGU6IEFycmF5LFxyXG4gICAgICBpc1ZhbGlkVmFsdWU6IGFycmF5ID0+XHJcbiAgICAgICAgQXJyYXkuaXNBcnJheSggYXJyYXkgKSAmJiBhcnJheS5sZW5ndGggPT09IDIgJiYgXy5ldmVyeSggYXJyYXksXHJcbiAgICAgICAgICBlbGVtZW50ID0+IGVsZW1lbnQgPT09IG51bGwgfHwgdHlwZW9mIGVsZW1lbnQgPT09ICdudW1iZXInXHJcbiAgICAgICAgKVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIExpc3RlbiB0byB0aGUgbnVtYmVyTGluZSBhbmQgaXRzIHBvaW50cyB0byBtYWtlIHVwZGF0ZXMgdG8gcG9pbnRzVmFsdWVQcm9wZXJ0eSB3aGVuIG5lY2Vzc2FyeS4gSWRlYWxseSwgd2Ugd291bGRcclxuICAgIC8vIGxpc3RlbiB0byB0aGUgcmVzaWRlbnRQb2ludHMgb2YgdGhpcy5udW1iZXJMaW5lIHNvIEkgd291bGRuJ3QgZHVwbGljYXRlIGNvZGUgcGVyIGNvbnRyb2xsZXIsIGJ1dCBpdCBpcyBuZWNlc3NhcnlcclxuICAgIC8vIHRvIGtub3cgd2hpY2ggcG9pbnQgY29udHJvbGxlciBlYWNoIG51bWJlciBsaW5lIHBvaW50IGJlbG9uZ3MgdG8sIGFuZCBwb2ludHMgY2FuIGJlIGFkZGVkIHRvIHRoZSBudW1iZXIgbGluZVxyXG4gICAgLy8gYmVmb3JlIHRoZXkgYXJlIGFzc29jaWF0ZWQgd2l0aCBhIHBvaW50IGNvbnRyb2xsZXIuXHJcbiAgICB0aGlzLnBvaW50Q29udHJvbGxlck9uZS5udW1iZXJMaW5lUG9pbnRzLmFkZEl0ZW1BZGRlZExpc3RlbmVyKCBudW1iZXJMaW5lUG9pbnQgPT4ge1xyXG4gICAgICBjb25zdCB1cGRhdGVQb2ludFZhbHVlc1Byb3BlcnR5ID0gdmFsdWUgPT4ge1xyXG4gICAgICAgIHRoaXMucG9pbnRWYWx1ZXNQcm9wZXJ0eS52YWx1ZSA9IFsgdmFsdWUsIHRoaXMucG9pbnRWYWx1ZXNQcm9wZXJ0eS52YWx1ZVsgMSBdIF07XHJcbiAgICAgIH07XHJcbiAgICAgIG51bWJlckxpbmVQb2ludC52YWx1ZVByb3BlcnR5LmxpbmsoIHVwZGF0ZVBvaW50VmFsdWVzUHJvcGVydHkgKTtcclxuICAgICAgY29uc3QgaXRlbVJlbW92ZWRMaXN0ZW5lciA9IHJlbW92ZWROdW1iZXJMaW5lUG9pbnQgPT4ge1xyXG4gICAgICAgIGlmICggcmVtb3ZlZE51bWJlckxpbmVQb2ludCA9PT0gbnVtYmVyTGluZVBvaW50ICkge1xyXG4gICAgICAgICAgbnVtYmVyTGluZVBvaW50LnZhbHVlUHJvcGVydHkudW5saW5rKCB1cGRhdGVQb2ludFZhbHVlc1Byb3BlcnR5ICk7XHJcbiAgICAgICAgICB1cGRhdGVQb2ludFZhbHVlc1Byb3BlcnR5KCBudWxsICk7XHJcbiAgICAgICAgICB0aGlzLnBvaW50Q29udHJvbGxlck9uZS5udW1iZXJMaW5lUG9pbnRzLnJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIoIGl0ZW1SZW1vdmVkTGlzdGVuZXIgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMucG9pbnRDb250cm9sbGVyT25lLm51bWJlckxpbmVQb2ludHMuYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciggaXRlbVJlbW92ZWRMaXN0ZW5lciApO1xyXG4gICAgfSApO1xyXG4gICAgdGhpcy5wb2ludENvbnRyb2xsZXJUd28ubnVtYmVyTGluZVBvaW50cy5hZGRJdGVtQWRkZWRMaXN0ZW5lciggbnVtYmVyTGluZVBvaW50ID0+IHtcclxuICAgICAgY29uc3QgdXBkYXRlUG9pbnRWYWx1ZXNQcm9wZXJ0eSA9IHZhbHVlID0+IHtcclxuICAgICAgICB0aGlzLnBvaW50VmFsdWVzUHJvcGVydHkudmFsdWUgPSBbIHRoaXMucG9pbnRWYWx1ZXNQcm9wZXJ0eS52YWx1ZVsgMCBdLCB2YWx1ZSBdO1xyXG4gICAgICB9O1xyXG4gICAgICBudW1iZXJMaW5lUG9pbnQudmFsdWVQcm9wZXJ0eS5saW5rKCB1cGRhdGVQb2ludFZhbHVlc1Byb3BlcnR5ICk7XHJcbiAgICAgIGNvbnN0IGl0ZW1SZW1vdmVkTGlzdGVuZXIgPSByZW1vdmVkTnVtYmVyTGluZVBvaW50ID0+IHtcclxuICAgICAgICBpZiAoIHJlbW92ZWROdW1iZXJMaW5lUG9pbnQgPT09IG51bWJlckxpbmVQb2ludCApIHtcclxuICAgICAgICAgIG51bWJlckxpbmVQb2ludC52YWx1ZVByb3BlcnR5LnVubGluayggdXBkYXRlUG9pbnRWYWx1ZXNQcm9wZXJ0eSApO1xyXG4gICAgICAgICAgdXBkYXRlUG9pbnRWYWx1ZXNQcm9wZXJ0eSggbnVsbCApO1xyXG4gICAgICAgICAgdGhpcy5wb2ludENvbnRyb2xsZXJUd28ubnVtYmVyTGluZVBvaW50cy5yZW1vdmVJdGVtUmVtb3ZlZExpc3RlbmVyKCBpdGVtUmVtb3ZlZExpc3RlbmVyICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLnBvaW50Q29udHJvbGxlclR3by5udW1iZXJMaW5lUG9pbnRzLmFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIoIGl0ZW1SZW1vdmVkTGlzdGVuZXIgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtQcm9wZXJ0eS48Qm91bmRzMj59IHRoZSBib3VuZHMgb2YgdGhlIHRvb2xib3ggdGhhdCBwb2ludCBjb250cm9sbGVycyByZXR1cm4gdG8gVGhlIGJveCBib3VuZHMgY2hhbmdlXHJcbiAgICAvLyB3aXRoIG51bWJlciBsaW5lIG9yaWVudGF0aW9uIGluIHRoZSBnZW5lcmljIHNjcmVlbi5cclxuICAgIHRoaXMucG9pbnRDb250cm9sbGVyQm94UHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIE5MRENvbnN0YW50cy5CT1RUT01fQk9YX0JPVU5EUywgeyB2YWx1ZVR5cGU6IEJvdW5kczIgfSApO1xyXG5cclxuICAgIHRoaXMucG9pbnRDb250cm9sbGVycy5mb3JFYWNoKCBwb2ludENvbnRyb2xsZXIgPT4ge1xyXG5cclxuICAgICAgdGhpcy5wdXRQb2ludENvbnRyb2xsZXJJbkJveCggcG9pbnRDb250cm9sbGVyICk7XHJcblxyXG4gICAgICAvLyBTZXQgdXAgdGhlIGxpc3RlbmVycyB0aGF0IHdpbGwgcGxhY2UgdGhlIHBvaW50IGNvbnRyb2xsZXJzIGJhY2sgaW4gdGhlaXIgZGVmYXVsdCBwb3NpdGlvbnMgd2hlbiByZWxlYXNlZCBvdmVyXHJcbiAgICAgIC8vIHRoZSBhY3RpdmUgcG9pbnQgY29udHJvbGxlciBib3guXHJcbiAgICAgIHBvaW50Q29udHJvbGxlci5pc0RyYWdnaW5nUHJvcGVydHkubGF6eUxpbmsoIGRyYWdnaW5nID0+IHtcclxuXHJcbiAgICAgICAgLy8gSWYgdGhlIHBvaW50IGNvbnRyb2xsZXIgaXMgcmVsZWFzZWQgYW5kIGl0J3Mgbm90IGNvbnRyb2xsaW5nIGEgcG9pbnQgb24gdGhlIG51bWJlciBsaW5lLCBwdXQgaXQgYXdheS5cclxuICAgICAgICBpZiAoICFkcmFnZ2luZyAmJiAhcG9pbnRDb250cm9sbGVyLmlzQ29udHJvbGxpbmdOdW1iZXJMaW5lUG9pbnQoKSApIHtcclxuICAgICAgICAgIHRoaXMucHV0UG9pbnRDb250cm9sbGVySW5Cb3goIHBvaW50Q29udHJvbGxlciwgdHJ1ZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG5cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBNYW5hZ2UgcG9pbnQgY29udHJvbGxlcnMgb24gb3JpZW50YXRpb24gY2hhbmdlLlxyXG4gICAgdGhpcy5udW1iZXJMaW5lLm9yaWVudGF0aW9uUHJvcGVydHkubGF6eUxpbmsoICgpID0+IHtcclxuICAgICAgdGhpcy5wb2ludENvbnRyb2xsZXJzXHJcbiAgICAgICAgLmZpbHRlciggcG9pbnRDb250cm9sbGVyID0+IHBvaW50Q29udHJvbGxlci5pc0NvbnRyb2xsaW5nTnVtYmVyTGluZVBvaW50KCkgKVxyXG4gICAgICAgIC5mb3JFYWNoKCBwb2ludENvbnRyb2xsZXIgPT4ge1xyXG4gICAgICAgICAgLy8gVGhlcmUgc2hvdWxkIG9ubHkgYmUgb25lIGNvbnRyb2xsZWQgcG9pbnQuXHJcbiAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBwb2ludENvbnRyb2xsZXIubnVtYmVyTGluZVBvaW50cy5sZW5ndGggPT09IDEgKTtcclxuICAgICAgICAgIHBvaW50Q29udHJvbGxlci5zZXRQb3NpdGlvblJlbGF0aXZlVG9Qb2ludCggcG9pbnRDb250cm9sbGVyLm51bWJlckxpbmVQb2ludHMuZ2V0KCAwICkgKTtcclxuICAgICAgICB9ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gSWYgcG9pbnQgY29udHJvbGxlcnMgd2VyZSBpbiB0aGUgYm94IGFuZCB0aGUgYm94IGJvdW5kcyBjaGFuZ2VkLCBtb3ZlIHRoZSBwb2ludHMuXHJcbiAgICB0aGlzLnBvaW50Q29udHJvbGxlckJveFByb3BlcnR5LmxhenlMaW5rKCAoIG5ld0JveEJvdW5kcywgb2xkQm94Qm91bmRzICkgPT4ge1xyXG4gICAgICB0aGlzLnBvaW50Q29udHJvbGxlcnMuZm9yRWFjaCggcG9pbnRDb250cm9sbGVyID0+IHtcclxuXHJcbiAgICAgICAgLy8gSWYgdGhlIHBvaW50IGNvbnRyb2xsZXIgaXMgYW5pbWF0aW5nLCBzdG9wIGl0IGFuZCBwdXQgaXQgaW4gdGhlIGJveC5cclxuICAgICAgICBpZiAoIHBvaW50Q29udHJvbGxlci5pblByb2dyZXNzQW5pbWF0aW9uUHJvcGVydHkudmFsdWUgKSB7XHJcbiAgICAgICAgICBwb2ludENvbnRyb2xsZXIuc3RvcEFuaW1hdGlvbigpO1xyXG4gICAgICAgICAgdGhpcy5wdXRQb2ludENvbnRyb2xsZXJJbkJveCggcG9pbnRDb250cm9sbGVyICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBJZiB0aGUgcG9pbnQgY29udHJvbGxlciB3YXMgc2l0dGluZyBpbiB0aGUgcHJldmlvdXMgYm94LCBtb3ZlIGl0IHRvIHRoZSBuZXcgb25lLlxyXG4gICAgICAgIGVsc2UgaWYgKCBvbGRCb3hCb3VuZHMuY29udGFpbnNQb2ludCggcG9pbnRDb250cm9sbGVyLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgKSAmJlxyXG4gICAgICAgICAgICAgICAgICAhcG9pbnRDb250cm9sbGVyLmlzRHJhZ2dpbmdQcm9wZXJ0eS52YWx1ZSAmJiAhcG9pbnRDb250cm9sbGVyLmlzQ29udHJvbGxpbmdOdW1iZXJMaW5lUG9pbnQoKSApIHtcclxuICAgICAgICAgIHRoaXMucHV0UG9pbnRDb250cm9sbGVySW5Cb3goIHBvaW50Q29udHJvbGxlciApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGxhY2UgdGhlIHByb3ZpZGVkIHBvaW50IGNvbnRyb2xsZXIgaW50byB0aGUgY3VycmVudGx5IGFjdGl2ZSBib3guXHJcbiAgICogR2VuZXJhbGx5IGRvbmUgb24gaW5pdCwgcmVzZXQsIGFuZCB3aGVuIHRoZSB1c2VyIFwicHV0cyBpdCBhd2F5XCIuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1BvaW50Q29udHJvbGxlcn0gcG9pbnRDb250cm9sbGVyXHJcbiAgICogQHBhcmFtIHtib29sZWFufSBbYW5pbWF0ZV0gLSBjb250cm9scyB3aGV0aGVyIHRvIGFuaW1hdGUgdGhlIHJldHVybiB0byB0aGUgYm94IG9yIGRvIGl0IGluc3RhbnRseVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgcHV0UG9pbnRDb250cm9sbGVySW5Cb3goIHBvaW50Q29udHJvbGxlciwgYW5pbWF0ZSA9IGZhbHNlICkge1xyXG5cclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5wb2ludENvbnRyb2xsZXJzLmluZGV4T2YoIHBvaW50Q29udHJvbGxlciApO1xyXG4gICAgY29uc3QgbnVtYmVyT2ZQb3NpdGlvbnMgPSB0aGlzLnBvaW50Q29udHJvbGxlcnMubGVuZ3RoO1xyXG5cclxuICAgIC8vIGVycm9yIGNoZWNraW5nXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBpbmRleCA+PSAwLCAncG9pbnQgY29udHJvbGxlciBub3QgZm91bmQgb24gbGlzdCcgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoXHJcbiAgICAgICFwb2ludENvbnRyb2xsZXIuaXNDb250cm9sbGluZ051bWJlckxpbmVQb2ludCgpLFxyXG4gICAgICAncG9pbnQgY29udHJvbGxlciBzaG91bGQgbm90IGJlIHB1dCBhd2F5IHdoaWxlIGNvbnRyb2xsaW5nIGEgcG9pbnQnXHJcbiAgICApO1xyXG5cclxuICAgIGxldCBkZXN0aW5hdGlvbjtcclxuXHJcbiAgICAvLyBkZWNpZGUgd2hpY2ggYm94IGFuZCBhdCB3aGljaCBwb3NpdGlvbiB0aGUgcG9pbnQgY29udHJvbGxlciBzaG91bGQgYmUgcGxhY2VkXHJcbiAgICBpZiAoIHRoaXMucG9pbnRDb250cm9sbGVyQm94UHJvcGVydHkudmFsdWUgPT09IE5MRENvbnN0YW50cy5CT1RUT01fQk9YX0JPVU5EUyApIHtcclxuXHJcbiAgICAgIC8vIHB1dCBwb2ludCBpbiBib3ggYXQgYm90dG9tIG9mIHNjcmVlblxyXG4gICAgICBjb25zdCBzcGFjaW5nID0gTkxEQ29uc3RhbnRzLkJPVFRPTV9CT1hfQk9VTkRTLndpZHRoIC8gbnVtYmVyT2ZQb3NpdGlvbnM7XHJcbiAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFZlY3RvcjIoXHJcbiAgICAgICAgTkxEQ29uc3RhbnRzLkJPVFRPTV9CT1hfQk9VTkRTLm1pblggKyBzcGFjaW5nIC8gMiArIHNwYWNpbmcgKiBpbmRleCxcclxuICAgICAgICBOTERDb25zdGFudHMuQk9UVE9NX0JPWF9CT1VORFMuY2VudGVyWVxyXG4gICAgICApLnBsdXMoIHRoaXMub3B0aW9ucy5wb3NpdGlvbkluQm94T2Zmc2V0ICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGhpcy5wb2ludENvbnRyb2xsZXJCb3hQcm9wZXJ0eS52YWx1ZSA9PT0gTkxEQ29uc3RhbnRzLlNJREVfQk9YX0JPVU5EUyApIHtcclxuXHJcbiAgICAgIC8vIHB1dCBwb2ludCBpbiBib3ggYXQgc2lkZSBvZiBzY3JlZW5cclxuICAgICAgY29uc3Qgc3BhY2luZyA9IE5MRENvbnN0YW50cy5TSURFX0JPWF9CT1VORFMuaGVpZ2h0IC8gbnVtYmVyT2ZQb3NpdGlvbnM7XHJcbiAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFZlY3RvcjIoXHJcbiAgICAgICAgTkxEQ29uc3RhbnRzLlNJREVfQk9YX0JPVU5EUy5jZW50ZXJYLFxyXG4gICAgICAgIE5MRENvbnN0YW50cy5TSURFX0JPWF9CT1VORFMubWluWSArIHNwYWNpbmcgLyAyICsgc3BhY2luZyAqIGluZGV4XHJcbiAgICAgICkucGx1cyggdGhpcy5vcHRpb25zLnBvc2l0aW9uSW5Cb3hPZmZzZXQgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBmYWxzZSwgJ2Nhbm5vdCBwdXQgcG9pbnQgY29udHJvbGxlciBhd2F5IGlmIGJveCBpcyBub3QgdGhlIGJvdHRvbSBib3ggb3Igc2lkZSBib3gnICk7XHJcbiAgICB9XHJcblxyXG4gICAgcG9pbnRDb250cm9sbGVyLmdvVG9Qb3NpdGlvbiggZGVzdGluYXRpb24sIGFuaW1hdGUgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBib3RoIHBvaW50IGNvbnRyb2xsZXJzIGFzIGEgbGlzdC5cclxuICAgKiBBbHdheXMgcmV0dXJucyB0aGlzLnBvaW50Q29udHJvbGxlck9uZSBhcyB0aGUgZmlyc3QgZWxlbWVudCBvZiB0aGUgbGlzdCwgd2hpY2ggbWVhbnMgdGhhdCB0aGlzIG1ldGhvZFxyXG4gICAqIGRvZXNuJ3Qgb3JkZXIgdGhlIHBvaW50IGNvbnRyb2xsZXJzIGJ5IHdoaWNoIG9uZSBpcyB0aGUgcHJpbWFyeSBvbmUuXHJcbiAgICpcclxuICAgKiBAcmV0dXJucyB7UG9pbnRDb250cm9sbGVyW119XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGdldFBvaW50Q29udHJvbGxlcnMoKSB7XHJcbiAgICByZXR1cm4gWyB0aGlzLnBvaW50Q29udHJvbGxlck9uZSwgdGhpcy5wb2ludENvbnRyb2xsZXJUd28gXTtcclxuICB9XHJcblxyXG4gIGdldCBwb2ludENvbnRyb2xsZXJzKCkgeyByZXR1cm4gdGhpcy5nZXRQb2ludENvbnRyb2xsZXJzKCk7IH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJuIHdoZXRoZXIgYm90aCBwb2ludCBjb250cm9sbGVycyBhcmUgY29udHJvbGxpbmcgbnVtYmVyIGxpbmUgcG9pbnRzIHRoYXQgbGl2ZSBvbiB0aGUgbnVtYmVyIGxpbmVcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgYXJlQm90aFBvaW50Q29udHJvbGxlcnNDb250cm9sbGluZ09uTnVtYmVyTGluZSgpIHtcclxuICAgIHJldHVybiB0aGlzLnBvaW50VmFsdWVzUHJvcGVydHkudmFsdWUuZmlsdGVyKCBwb2ludFZhbHVlID0+IHBvaW50VmFsdWUgIT09IG51bGwgKS5sZW5ndGggPT09IDI7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNldHMgdGhlIG1vZGVsXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5wb2ludENvbnRyb2xsZXJzLmZvckVhY2goIHBvaW50Q29udHJvbGxlciA9PiB7XHJcbiAgICAgIHBvaW50Q29udHJvbGxlci5yZXNldCgpO1xyXG4gICAgICB0aGlzLnB1dFBvaW50Q29udHJvbGxlckluQm94KCBwb2ludENvbnRyb2xsZXIgKTtcclxuICAgIH0gKTtcclxuICAgIHRoaXMuZGlzdGFuY2VMYWJlbHNWaXNpYmxlUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuZGlzdGFuY2VEZXNjcmlwdGlvblZpc2libGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5kaXN0YW5jZVJlcHJlc2VudGF0aW9uUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMuaXNQcmltYXJ5Q29udHJvbGxlclN3YXBwZWRQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5udW1iZXJMaW5lLnJlc2V0KCk7XHJcbiAgICB0aGlzLnBvaW50Q29udHJvbGxlckJveFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxubnVtYmVyTGluZURpc3RhbmNlLnJlZ2lzdGVyKCAnQWJzdHJhY3ROTERCYXNlTW9kZWwnLCBBYnN0cmFjdE5MREJhc2VNb2RlbCApO1xyXG5leHBvcnQgZGVmYXVsdCBBYnN0cmFjdE5MREJhc2VNb2RlbDtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyw2QkFBNkIsTUFBTSxzREFBc0Q7QUFDaEcsT0FBT0MsUUFBUSxNQUFNLGlDQUFpQztBQUN0RCxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsS0FBSyxNQUFNLG1DQUFtQztBQUNyRCxPQUFPQyxrQkFBa0IsTUFBTSw2QkFBNkI7QUFDNUQsT0FBT0MsWUFBWSxNQUFNLG9CQUFvQjtBQUM3QyxPQUFPQyxzQkFBc0IsTUFBTSw2QkFBNkI7QUFFaEUsTUFBTUMsb0JBQW9CLENBQUM7RUFFekI7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRUMsV0FBV0EsQ0FBRUMsVUFBVSxFQUFFQyxrQkFBa0IsRUFBRUMsa0JBQWtCLEVBQUVDLE1BQU0sRUFBRUMsT0FBTyxFQUFHO0lBRWpGO0lBQ0EsSUFBSSxDQUFDQSxPQUFPLEdBQUdWLEtBQUssQ0FBRTtNQUNwQlcsbUJBQW1CLEVBQUUsSUFBSVosT0FBTyxDQUFFLENBQUMsRUFBRSxDQUFFO0lBQ3pDLENBQUMsRUFBRVcsT0FBUSxDQUFDOztJQUVaO0lBQ0EsSUFBSSxDQUFDRSw2QkFBNkIsR0FBRyxJQUFJakIsZUFBZSxDQUFFLElBQUssQ0FBQzs7SUFFaEU7SUFDQSxJQUFJLENBQUNrQixrQ0FBa0MsR0FBRyxJQUFJbEIsZUFBZSxDQUFFLElBQUssQ0FBQzs7SUFFckU7SUFDQSxJQUFJLENBQUNtQiw4QkFBOEIsR0FBRyxJQUFJbEIsNkJBQTZCLENBQUVPLHNCQUFzQixFQUFFQSxzQkFBc0IsQ0FB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