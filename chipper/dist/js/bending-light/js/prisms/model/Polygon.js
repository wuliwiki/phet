// Copyright 2015-2022, University of Colorado Boulder

/**
 * Shape that comprises a prism. Immutable here but composed with a Property.<Polygon> in Prism for mutability.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Chandrashekar Bemagoni (Actual Concepts)
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import { Arc, Line, Shape } from '../../../../kite/js/imports.js';
import bendingLight from '../../bendingLight.js';
import PrismIntersection from './PrismIntersection.js';
class Polygon {
  /**
   * @param referencePointIndex - index of reference point
   * @param points - array of corner points
   * @param radius - radius is 0 for polygon or radius for diverging lens
   */
  constructor(referencePointIndex, points, radius) {
    this.points = points;

    // Index for the point used as the "reference" point, which is used as the drag handle corner for rotation
    this.referencePointIndex = referencePointIndex;
    this.radius = radius;

    // (read-only), Centroid of the shape
    this.centroid = this.getCentroid(this.points);

    // Creates a shape
    this.shape = new Shape(); // (read-only)
    this.center = null; // (read-only)

    // radius is 0 for polygon
    if (this.radius === 0) {
      this.shape.moveToPoint(this.points[0]);
      for (let i = 1; i < this.points.length; i++) {
        this.shape.lineToPoint(this.points[i]);
      }
      this.shape.close();
    } else {
      // radius is nonzero for diverging lens
      this.center = this.points[0].plus(this.points[3]).multiplyScalar(0.5);
      const startAngle = Math.atan2(this.center.y - this.points[3].y, this.center.x - this.points[3].x);
      this.shape.ellipticalArcPoint(this.center, this.radius, this.radius, 0, startAngle, startAngle + Math.PI, true).lineToPoint(this.points[2]).lineToPoint(this.points[1]).lineToPoint(this.points[0]);
    }
  }

  /**
   * Get the specified corner point
   * @param i - index of point
   */
  getPoint(i) {
    return this.points[i];
  }

  /**
   * Create a new Polygon translated by the specified amount
   * @param deltaX - distance in x direction to be translated
   * @param deltaY - distance in y direction to be translated
   */
  getTranslatedInstance(deltaX, deltaY) {
    const newPoints = [];
    for (let j = 0; j < this.points.length; j++) {
      // get the new points after translating
      newPoints.push(this.points[j].plusXY(deltaX, deltaY));
    }

    // create a new polygon with translated points
    return new Polygon(this.referencePointIndex, newPoints, this.radius);
  }

  /**
   * Gets a rotated copy of this polygon
   * @param angle - angle to be rotated
   * @param rotationPoint - point around which polygon to be rotated
   */
  getRotatedInstance(angle, rotationPoint) {
    const newPoints = [];
    for (let k = 0; k < this.points.length; k++) {
      const vectorAboutCentroid = this.points[k].subtract(rotationPoint);
      const rotated = vectorAboutCentroid.rotate(angle);

      // get the new points after rotating
      newPoints.push(rotated.add(rotationPoint));
    }

    // create a new polygon with rotated points
    return new Polygon(this.referencePointIndex, newPoints, this.radius);
  }

  /**
   * Determines whether shape contains given point or not
   */
  containsPoint(point) {
    return this.shape.containsPoint(point);
  }

  /**
   * Just use the 0th point for the reference point for rotation drag handles
   */
  getReferencePoint() {
    return this.getPoint(this.referencePointIndex);
  }

  /**
   * Computes the centroid of the corner points (e.g. the center of "mass" assuming the corner points have equal
   * "mass")
   */
  getRotationCenter() {
    return this.centroid;
  }

  /**
   * Centroid of the polygon
   * @param p - array of corner points
   */
  getCentroid(p) {
    let cx = 0;
    let cy = 0;
    for (let i = 0; i < p.length; i++) {
      const j = (i + 1) % p.length;
      const n = p[i].x * p[j].y - p[j].x * p[i].y;
      cx += (p[i].x + p[j].x) * n;
      cy += (p[i].y + p[j].y) * n;
    }
    const a = this.getArea(p);
    const f = 1 / (a * 6);
    cx *= f;
    cy *= f;
    return new Vector2(cx, cy);
  }

  /**
   * Computes the area of a polygon using the algorithm described at http://www.mathopenref.com/coordpolygonarea2.html
   * Used to compute the centroid for a lens so it can be rotated about its center.
   * @param p - array of corner points
   */
  getArea(p) {
    let a = 0;
    for (let i = 0; i < p.length; i++) {
      const j = (i + 1) % p.length;
      a += p[i].x * p[j].y;
      a -= p[j].x * p[i].y;
    }
    a *= 0.5;
    return a;
  }

  /**
   * Compute the intersections of the specified ray with this polygon's edges
   * @param ray - model of the ray
   */
  getIntersections(ray) {
    let arc = null;
    if (this.radius !== 0 && this.center) {
      const startAngle = Math.atan2(this.center.y - this.points[3].y, this.center.x - this.points[3].x);
      arc = new Arc(this.center, this.radius, startAngle, startAngle + Math.PI, true);
    }
    return PrismIntersection.getIntersections(this.getEdges(), arc, this.center, ray);
  }

  /**
   * List all bounding edges in the polygon
   */
  getEdges() {
    const lineSegments = [];
    for (let i = 0; i < this.points.length - 1; i++) {
      lineSegments.push(new Line(this.points[i], this.points[i + 1]));
    }
    if (this.radius === 0) {
      lineSegments.push(new Line(this.points[this.points.length - 1], this.points[0]));
    }
    return lineSegments;
  }
}
bendingLight.register('Polygon', Polygon);
export default Polygon;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwiQXJjIiwiTGluZSIsIlNoYXBlIiwiYmVuZGluZ0xpZ2h0IiwiUHJpc21JbnRlcnNlY3Rpb24iLCJQb2x5Z29uIiwiY29uc3RydWN0b3IiLCJyZWZlcmVuY2VQb2ludEluZGV4IiwicG9pbnRzIiwicmFkaXVzIiwiY2VudHJvaWQiLCJnZXRDZW50cm9pZCIsInNoYXBlIiwiY2VudGVyIiwibW92ZVRvUG9pbnQiLCJpIiwibGVuZ3RoIiwibGluZVRvUG9pbnQiLCJjbG9zZSIsInBsdXMiLCJtdWx0aXBseVNjYWxhciIsInN0YXJ0QW5nbGUiLCJNYXRoIiwiYXRhbjIiLCJ5IiwieCIsImVsbGlwdGljYWxBcmNQb2ludCIsIlBJIiwiZ2V0UG9pbnQiLCJnZXRUcmFuc2xhdGVkSW5zdGFuY2UiLCJkZWx0YVgiLCJkZWx0YVkiLCJuZXdQb2ludHMiLCJqIiwicHVzaCIsInBsdXNYWSIsImdldFJvdGF0ZWRJbnN0YW5jZSIsImFuZ2xlIiwicm90YXRpb25Qb2ludCIsImsiLCJ2ZWN0b3JBYm91dENlbnRyb2lkIiwic3VidHJhY3QiLCJyb3RhdGVkIiwicm90YXRlIiwiYWRkIiwiY29udGFpbnNQb2ludCIsInBvaW50IiwiZ2V0UmVmZXJlbmNlUG9pbnQiLCJnZXRSb3RhdGlvbkNlbnRlciIsInAiLCJjeCIsImN5IiwibiIsImEiLCJnZXRBcmVhIiwiZiIsImdldEludGVyc2VjdGlvbnMiLCJyYXkiLCJhcmMiLCJnZXRFZGdlcyIsImxpbmVTZWdtZW50cyIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUG9seWdvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTaGFwZSB0aGF0IGNvbXByaXNlcyBhIHByaXNtLiBJbW11dGFibGUgaGVyZSBidXQgY29tcG9zZWQgd2l0aCBhIFByb3BlcnR5LjxQb2x5Z29uPiBpbiBQcmlzbSBmb3IgbXV0YWJpbGl0eS5cclxuICpcclxuICogQGF1dGhvciBTYW0gUmVpZCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBDaGFuZHJhc2hla2FyIEJlbWFnb25pIChBY3R1YWwgQ29uY2VwdHMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBBcmMsIExpbmUsIFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGJlbmRpbmdMaWdodCBmcm9tICcuLi8uLi9iZW5kaW5nTGlnaHQuanMnO1xyXG5pbXBvcnQgUHJpc21JbnRlcnNlY3Rpb24gZnJvbSAnLi9QcmlzbUludGVyc2VjdGlvbi5qcyc7XHJcbmltcG9ydCBDb2xvcmVkUmF5IGZyb20gJy4vQ29sb3JlZFJheS5qcyc7XHJcbmltcG9ydCBJbnRlcnNlY3Rpb24gZnJvbSAnLi9JbnRlcnNlY3Rpb24uanMnO1xyXG5cclxuY2xhc3MgUG9seWdvbiB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBwb2ludHM6IFZlY3RvcjJbXTtcclxuICBwcml2YXRlIHJlYWRvbmx5IHJlZmVyZW5jZVBvaW50SW5kZXg6IG51bWJlcjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHJhZGl1czogbnVtYmVyO1xyXG4gIHB1YmxpYyByZWFkb25seSBjZW50cm9pZDogVmVjdG9yMjtcclxuICBwdWJsaWMgcmVhZG9ubHkgc2hhcGU6IFNoYXBlO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY2VudGVyOiBWZWN0b3IyIHwgbnVsbDtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHJlZmVyZW5jZVBvaW50SW5kZXggLSBpbmRleCBvZiByZWZlcmVuY2UgcG9pbnRcclxuICAgKiBAcGFyYW0gcG9pbnRzIC0gYXJyYXkgb2YgY29ybmVyIHBvaW50c1xyXG4gICAqIEBwYXJhbSByYWRpdXMgLSByYWRpdXMgaXMgMCBmb3IgcG9seWdvbiBvciByYWRpdXMgZm9yIGRpdmVyZ2luZyBsZW5zXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCByZWZlcmVuY2VQb2ludEluZGV4OiBudW1iZXIsIHBvaW50czogVmVjdG9yMltdLCByYWRpdXM6IG51bWJlciApIHtcclxuXHJcbiAgICB0aGlzLnBvaW50cyA9IHBvaW50cztcclxuXHJcbiAgICAvLyBJbmRleCBmb3IgdGhlIHBvaW50IHVzZWQgYXMgdGhlIFwicmVmZXJlbmNlXCIgcG9pbnQsIHdoaWNoIGlzIHVzZWQgYXMgdGhlIGRyYWcgaGFuZGxlIGNvcm5lciBmb3Igcm90YXRpb25cclxuICAgIHRoaXMucmVmZXJlbmNlUG9pbnRJbmRleCA9IHJlZmVyZW5jZVBvaW50SW5kZXg7XHJcbiAgICB0aGlzLnJhZGl1cyA9IHJhZGl1cztcclxuXHJcbiAgICAvLyAocmVhZC1vbmx5KSwgQ2VudHJvaWQgb2YgdGhlIHNoYXBlXHJcbiAgICB0aGlzLmNlbnRyb2lkID0gdGhpcy5nZXRDZW50cm9pZCggdGhpcy5wb2ludHMgKTtcclxuXHJcbiAgICAvLyBDcmVhdGVzIGEgc2hhcGVcclxuICAgIHRoaXMuc2hhcGUgPSBuZXcgU2hhcGUoKTsgLy8gKHJlYWQtb25seSlcclxuICAgIHRoaXMuY2VudGVyID0gbnVsbDsgLy8gKHJlYWQtb25seSlcclxuXHJcbiAgICAvLyByYWRpdXMgaXMgMCBmb3IgcG9seWdvblxyXG4gICAgaWYgKCB0aGlzLnJhZGl1cyA9PT0gMCApIHtcclxuICAgICAgdGhpcy5zaGFwZS5tb3ZlVG9Qb2ludCggdGhpcy5wb2ludHNbIDAgXSApO1xyXG4gICAgICBmb3IgKCBsZXQgaSA9IDE7IGkgPCB0aGlzLnBvaW50cy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICB0aGlzLnNoYXBlLmxpbmVUb1BvaW50KCB0aGlzLnBvaW50c1sgaSBdICk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zaGFwZS5jbG9zZSgpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcblxyXG4gICAgICAvLyByYWRpdXMgaXMgbm9uemVybyBmb3IgZGl2ZXJnaW5nIGxlbnNcclxuICAgICAgdGhpcy5jZW50ZXIgPSB0aGlzLnBvaW50c1sgMCBdLnBsdXMoIHRoaXMucG9pbnRzWyAzIF0gKS5tdWx0aXBseVNjYWxhciggMC41ICk7XHJcbiAgICAgIGNvbnN0IHN0YXJ0QW5nbGUgPSBNYXRoLmF0YW4yKCB0aGlzLmNlbnRlci55IC0gdGhpcy5wb2ludHNbIDMgXS55LCB0aGlzLmNlbnRlci54IC0gdGhpcy5wb2ludHNbIDMgXS54ICk7XHJcbiAgICAgIHRoaXMuc2hhcGUuZWxsaXB0aWNhbEFyY1BvaW50KCB0aGlzLmNlbnRlciwgdGhpcy5yYWRpdXMsIHRoaXMucmFkaXVzLCAwLCBzdGFydEFuZ2xlLCBzdGFydEFuZ2xlICsgTWF0aC5QSSwgdHJ1ZSApXHJcbiAgICAgICAgLmxpbmVUb1BvaW50KCB0aGlzLnBvaW50c1sgMiBdIClcclxuICAgICAgICAubGluZVRvUG9pbnQoIHRoaXMucG9pbnRzWyAxIF0gKVxyXG4gICAgICAgIC5saW5lVG9Qb2ludCggdGhpcy5wb2ludHNbIDAgXSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBzcGVjaWZpZWQgY29ybmVyIHBvaW50XHJcbiAgICogQHBhcmFtIGkgLSBpbmRleCBvZiBwb2ludFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UG9pbnQoIGk6IG51bWJlciApOiBWZWN0b3IyIHtcclxuICAgIHJldHVybiB0aGlzLnBvaW50c1sgaSBdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIGEgbmV3IFBvbHlnb24gdHJhbnNsYXRlZCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudFxyXG4gICAqIEBwYXJhbSBkZWx0YVggLSBkaXN0YW5jZSBpbiB4IGRpcmVjdGlvbiB0byBiZSB0cmFuc2xhdGVkXHJcbiAgICogQHBhcmFtIGRlbHRhWSAtIGRpc3RhbmNlIGluIHkgZGlyZWN0aW9uIHRvIGJlIHRyYW5zbGF0ZWRcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0VHJhbnNsYXRlZEluc3RhbmNlKCBkZWx0YVg6IG51bWJlciwgZGVsdGFZOiBudW1iZXIgKTogUG9seWdvbiB7XHJcblxyXG4gICAgY29uc3QgbmV3UG9pbnRzID0gW107XHJcbiAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLnBvaW50cy5sZW5ndGg7IGorKyApIHtcclxuXHJcbiAgICAgIC8vIGdldCB0aGUgbmV3IHBvaW50cyBhZnRlciB0cmFuc2xhdGluZ1xyXG4gICAgICBuZXdQb2ludHMucHVzaCggdGhpcy5wb2ludHNbIGogXS5wbHVzWFkoIGRlbHRhWCwgZGVsdGFZICkgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjcmVhdGUgYSBuZXcgcG9seWdvbiB3aXRoIHRyYW5zbGF0ZWQgcG9pbnRzXHJcbiAgICByZXR1cm4gbmV3IFBvbHlnb24oIHRoaXMucmVmZXJlbmNlUG9pbnRJbmRleCwgbmV3UG9pbnRzLCB0aGlzLnJhZGl1cyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0cyBhIHJvdGF0ZWQgY29weSBvZiB0aGlzIHBvbHlnb25cclxuICAgKiBAcGFyYW0gYW5nbGUgLSBhbmdsZSB0byBiZSByb3RhdGVkXHJcbiAgICogQHBhcmFtIHJvdGF0aW9uUG9pbnQgLSBwb2ludCBhcm91bmQgd2hpY2ggcG9seWdvbiB0byBiZSByb3RhdGVkXHJcbiAgICovXHJcbiAgcHVibGljIGdldFJvdGF0ZWRJbnN0YW5jZSggYW5nbGU6IG51bWJlciwgcm90YXRpb25Qb2ludDogVmVjdG9yMiApOiBQb2x5Z29uIHtcclxuICAgIGNvbnN0IG5ld1BvaW50cyA9IFtdO1xyXG4gICAgZm9yICggbGV0IGsgPSAwOyBrIDwgdGhpcy5wb2ludHMubGVuZ3RoOyBrKysgKSB7XHJcbiAgICAgIGNvbnN0IHZlY3RvckFib3V0Q2VudHJvaWQgPSB0aGlzLnBvaW50c1sgayBdLnN1YnRyYWN0KCByb3RhdGlvblBvaW50ICk7XHJcbiAgICAgIGNvbnN0IHJvdGF0ZWQgPSB2ZWN0b3JBYm91dENlbnRyb2lkLnJvdGF0ZSggYW5nbGUgKTtcclxuXHJcbiAgICAgIC8vIGdldCB0aGUgbmV3IHBvaW50cyBhZnRlciByb3RhdGluZ1xyXG4gICAgICBuZXdQb2ludHMucHVzaCggcm90YXRlZC5hZGQoIHJvdGF0aW9uUG9pbnQgKSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNyZWF0ZSBhIG5ldyBwb2x5Z29uIHdpdGggcm90YXRlZCBwb2ludHNcclxuICAgIHJldHVybiBuZXcgUG9seWdvbiggdGhpcy5yZWZlcmVuY2VQb2ludEluZGV4LCBuZXdQb2ludHMsIHRoaXMucmFkaXVzICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgc2hhcGUgY29udGFpbnMgZ2l2ZW4gcG9pbnQgb3Igbm90XHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRhaW5zUG9pbnQoIHBvaW50OiBWZWN0b3IyICk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc2hhcGUuY29udGFpbnNQb2ludCggcG9pbnQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEp1c3QgdXNlIHRoZSAwdGggcG9pbnQgZm9yIHRoZSByZWZlcmVuY2UgcG9pbnQgZm9yIHJvdGF0aW9uIGRyYWcgaGFuZGxlc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRSZWZlcmVuY2VQb2ludCgpOiBWZWN0b3IyIHtcclxuICAgIHJldHVybiB0aGlzLmdldFBvaW50KCB0aGlzLnJlZmVyZW5jZVBvaW50SW5kZXggKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXB1dGVzIHRoZSBjZW50cm9pZCBvZiB0aGUgY29ybmVyIHBvaW50cyAoZS5nLiB0aGUgY2VudGVyIG9mIFwibWFzc1wiIGFzc3VtaW5nIHRoZSBjb3JuZXIgcG9pbnRzIGhhdmUgZXF1YWxcclxuICAgKiBcIm1hc3NcIilcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Um90YXRpb25DZW50ZXIoKTogVmVjdG9yMiB7XHJcbiAgICByZXR1cm4gdGhpcy5jZW50cm9pZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENlbnRyb2lkIG9mIHRoZSBwb2x5Z29uXHJcbiAgICogQHBhcmFtIHAgLSBhcnJheSBvZiBjb3JuZXIgcG9pbnRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDZW50cm9pZCggcDogVmVjdG9yMltdICk6IFZlY3RvcjIge1xyXG4gICAgbGV0IGN4ID0gMDtcclxuICAgIGxldCBjeSA9IDA7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBwLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICBjb25zdCBqID0gKCBpICsgMSApICUgcC5sZW5ndGg7XHJcbiAgICAgIGNvbnN0IG4gPSAoICggcFsgaSBdLnggKiBwWyBqIF0ueSApIC0gKCBwWyBqIF0ueCAqIHBbIGkgXS55ICkgKTtcclxuICAgICAgY3ggKz0gKCBwWyBpIF0ueCArIHBbIGogXS54ICkgKiBuO1xyXG4gICAgICBjeSArPSAoIHBbIGkgXS55ICsgcFsgaiBdLnkgKSAqIG47XHJcbiAgICB9XHJcbiAgICBjb25zdCBhID0gdGhpcy5nZXRBcmVhKCBwICk7XHJcbiAgICBjb25zdCBmID0gMSAvICggYSAqIDYgKTtcclxuICAgIGN4ICo9IGY7XHJcbiAgICBjeSAqPSBmO1xyXG4gICAgcmV0dXJuIG5ldyBWZWN0b3IyKCBjeCwgY3kgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXB1dGVzIHRoZSBhcmVhIG9mIGEgcG9seWdvbiB1c2luZyB0aGUgYWxnb3JpdGhtIGRlc2NyaWJlZCBhdCBodHRwOi8vd3d3Lm1hdGhvcGVucmVmLmNvbS9jb29yZHBvbHlnb25hcmVhMi5odG1sXHJcbiAgICogVXNlZCB0byBjb21wdXRlIHRoZSBjZW50cm9pZCBmb3IgYSBsZW5zIHNvIGl0IGNhbiBiZSByb3RhdGVkIGFib3V0IGl0cyBjZW50ZXIuXHJcbiAgICogQHBhcmFtIHAgLSBhcnJheSBvZiBjb3JuZXIgcG9pbnRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRBcmVhKCBwOiBWZWN0b3IyW10gKTogbnVtYmVyIHtcclxuICAgIGxldCBhID0gMDtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHAubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IGogPSAoIGkgKyAxICkgJSBwLmxlbmd0aDtcclxuICAgICAgYSArPSAoIHBbIGkgXS54ICogcFsgaiBdLnkgKTtcclxuICAgICAgYSAtPSAoIHBbIGogXS54ICogcFsgaSBdLnkgKTtcclxuICAgIH1cclxuICAgIGEgKj0gMC41O1xyXG4gICAgcmV0dXJuIGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb21wdXRlIHRoZSBpbnRlcnNlY3Rpb25zIG9mIHRoZSBzcGVjaWZpZWQgcmF5IHdpdGggdGhpcyBwb2x5Z29uJ3MgZWRnZXNcclxuICAgKiBAcGFyYW0gcmF5IC0gbW9kZWwgb2YgdGhlIHJheVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRJbnRlcnNlY3Rpb25zKCByYXk6IENvbG9yZWRSYXkgKTogSW50ZXJzZWN0aW9uW10ge1xyXG4gICAgbGV0IGFyYyA9IG51bGw7XHJcbiAgICBpZiAoIHRoaXMucmFkaXVzICE9PSAwICYmIHRoaXMuY2VudGVyICkge1xyXG4gICAgICBjb25zdCBzdGFydEFuZ2xlID0gTWF0aC5hdGFuMiggdGhpcy5jZW50ZXIueSAtIHRoaXMucG9pbnRzWyAzIF0ueSwgdGhpcy5jZW50ZXIueCAtIHRoaXMucG9pbnRzWyAzIF0ueCApO1xyXG4gICAgICBhcmMgPSBuZXcgQXJjKCB0aGlzLmNlbnRlciwgdGhpcy5yYWRpdXMsIHN0YXJ0QW5nbGUsIHN0YXJ0QW5nbGUgKyBNYXRoLlBJLCB0cnVlICk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gUHJpc21JbnRlcnNlY3Rpb24uZ2V0SW50ZXJzZWN0aW9ucyggdGhpcy5nZXRFZGdlcygpLCBhcmMsIHRoaXMuY2VudGVyISwgcmF5ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMaXN0IGFsbCBib3VuZGluZyBlZGdlcyBpbiB0aGUgcG9seWdvblxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RWRnZXMoKTogTGluZVtdIHtcclxuICAgIGNvbnN0IGxpbmVTZWdtZW50cyA9IFtdO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy5wb2ludHMubGVuZ3RoIC0gMTsgaSsrICkge1xyXG4gICAgICBsaW5lU2VnbWVudHMucHVzaCggbmV3IExpbmUoIHRoaXMucG9pbnRzWyBpIF0sIHRoaXMucG9pbnRzWyBpICsgMSBdICkgKTtcclxuICAgIH1cclxuICAgIGlmICggdGhpcy5yYWRpdXMgPT09IDAgKSB7XHJcbiAgICAgIGxpbmVTZWdtZW50cy5wdXNoKCBuZXcgTGluZSggdGhpcy5wb2ludHNbIHRoaXMucG9pbnRzLmxlbmd0aCAtIDEgXSwgdGhpcy5wb2ludHNbIDAgXSApICk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbGluZVNlZ21lbnRzO1xyXG4gIH1cclxufVxyXG5cclxuYmVuZGluZ0xpZ2h0LnJlZ2lzdGVyKCAnUG9seWdvbicsIFBvbHlnb24gKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFBvbHlnb247Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxTQUFTQyxHQUFHLEVBQUVDLElBQUksRUFBRUMsS0FBSyxRQUFRLGdDQUFnQztBQUNqRSxPQUFPQyxZQUFZLE1BQU0sdUJBQXVCO0FBQ2hELE9BQU9DLGlCQUFpQixNQUFNLHdCQUF3QjtBQUl0RCxNQUFNQyxPQUFPLENBQUM7RUFRWjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ1NDLFdBQVdBLENBQUVDLG1CQUEyQixFQUFFQyxNQUFpQixFQUFFQyxNQUFjLEVBQUc7SUFFbkYsSUFBSSxDQUFDRCxNQUFNLEdBQUdBLE1BQU07O0lBRXBCO0lBQ0EsSUFBSSxDQUFDRCxt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