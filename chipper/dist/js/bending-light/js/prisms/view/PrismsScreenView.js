// Copyright 2015-2023, University of Colorado Boulder

/**
 * View for the "Prisms" Screen.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Chandrashekar Bemagoni (Actual Concepts)
 */

import Property from '../../../../axon/js/Property.js';
import merge from '../../../../phet-core/js/merge.js';
import ResetAllButton from '../../../../scenery-phet/js/buttons/ResetAllButton.js';
import ProtractorNode from '../../../../scenery-phet/js/ProtractorNode.js';
import { DragListener, Node, Rectangle, VBox } from '../../../../scenery/js/imports.js';
import Panel from '../../../../sun/js/Panel.js';
import bendingLight from '../../bendingLight.js';
import BendingLightStrings from '../../BendingLightStrings.js';
import BendingLightScreenView from '../../common/view/BendingLightScreenView.js';
import FloatingLayout from '../../common/view/FloatingLayout.js';
import MediumControlPanel from '../../common/view/MediumControlPanel.js';
import TranslationDragHandle from '../../common/view/TranslationDragHandle.js';
import WavelengthControl from '../../common/view/WavelengthControl.js';
import IntersectionNode from './IntersectionNode.js';
import LaserTypeRadioButtonGroup from './LaserTypeRadioButtonGroup.js';
import PrismToolboxNode from './PrismToolboxNode.js';
import WhiteLightCanvasNode from './WhiteLightCanvasNode.js';
import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import ColorModeEnum from '../../common/model/ColorModeEnum.js';
import LightType from '../model/LightType.js';

// constants
const INSET = 10;
const environmentStringProperty = BendingLightStrings.environmentStringProperty;
class PrismsScreenView extends BendingLightScreenView {
  // @ts-expect-error assigned in the supercall which calls addLightNodes

  /**
   * @param prismsModel - model of prisms screen
   * @param [providedOptions]
   */
  constructor(prismsModel, providedOptions) {
    super(prismsModel,
    // laserHasKnob
    true, merge({
      // center the play area horizontally in the space between the left side of the screen and the control panels on
      // the right, and move the laser to the left.
      horizontalPlayAreaOffset: 240,
      // Center the play area vertically above the south control panel
      verticalPlayAreaOffset: -43,
      // if the prism is dropped behind a control panel, bump it to the left.
      occlusionHandler: node => {
        const controlPanels = [laserControlPanel, laserTypeRadioButtonGroup, environmentMediumControlPanel];
        controlPanels.forEach(controlPanel => {
          if (controlPanel.globalBounds.containsPoint(node.globalBounds.center)) {
            // @ts-expect-error
            node.translateViewXY(node.globalToParentBounds(controlPanel.globalBounds).minX - node.centerX, 0);
          }
        });
      }
    }, providedOptions));
    this.prismLayer = new Node({
      layerSplit: true
    });
    this.prismsModel = prismsModel;

    // Node for the environment that spans the screen (only for monochromatic light, the white light background
    // is rendered as opaque in the white light node for blending purposes)
    const environmentMediumNodeForMonochromaticLight = new Rectangle(0, 0, 0, 0);
    prismsModel.environmentMediumProperty.link(environmentMedium => {
      // This medium node only shows the color for monochromatic light
      const indexOfRefractionForRed = environmentMedium.substance.dispersionFunction.getIndexOfRefractionForRed();
      const color = prismsModel.mediumColorFactory.getColorAgainstWhite(indexOfRefractionForRed);
      environmentMediumNodeForMonochromaticLight.fill = color;
    });

    // Put it behind everything else
    this.insertChild(0, environmentMediumNodeForMonochromaticLight);
    const indexOfRefractionDecimals = 2;

    // Add control panels for setting the index of refraction for each medium
    const environmentMediumControlPanel = new MediumControlPanel(this, prismsModel.mediumColorFactory, prismsModel.environmentMediumProperty, environmentStringProperty, false, prismsModel.wavelengthProperty, indexOfRefractionDecimals, {
      yMargin: 6,
      comboBoxListPosition: 'below'
    });
    environmentMediumControlPanel.setTranslation(this.layoutBounds.right - 2 * INSET - environmentMediumControlPanel.width, this.layoutBounds.top + 15);
    this.afterLightLayer2.addChild(environmentMediumControlPanel);
    const sliderEnabledProperty = new BooleanProperty(false);
    const radioButtonAdapterProperty = new EnumerationProperty(LightType.SINGLE_COLOR);
    radioButtonAdapterProperty.link(radioButtonAdapterValue => {
      prismsModel.laser.colorModeProperty.value = radioButtonAdapterValue === LightType.WHITE ? ColorModeEnum.WHITE : ColorModeEnum.SINGLE_COLOR;
      prismsModel.manyRaysProperty.value = radioButtonAdapterValue === LightType.SINGLE_COLOR_5X ? 5 : 1;
      sliderEnabledProperty.value = radioButtonAdapterValue !== LightType.WHITE;
    });
    const laserTypeRadioButtonGroup = new LaserTypeRadioButtonGroup(radioButtonAdapterProperty);
    this.afterLightLayer2.addChild(laserTypeRadioButtonGroup);
    const laserControlPanel = new Panel(new VBox({
      spacing: 10,
      children: [new WavelengthControl(prismsModel.wavelengthProperty, sliderEnabledProperty, 146)]
    }), {
      cornerRadius: 5,
      xMargin: 10,
      yMargin: 6,
      fill: '#EEEEEE',
      stroke: '#696969',
      lineWidth: 1.5
    });
    this.afterLightLayer2.addChild(laserControlPanel);
    this.incidentWaveLayer.setVisible(false);

    // Optionally show the normal lines at each intersection
    prismsModel.intersections.addItemAddedListener(addedIntersection => {
      if (prismsModel.showNormalsProperty.value) {
        const node = new IntersectionNode(this.modelViewTransform, addedIntersection, prismsModel.intersectionStrokeProperty);
        this.addChild(node);
        prismsModel.intersections.addItemRemovedListener(removedIntersection => {
          if (removedIntersection === addedIntersection) {
            // dispose will remove the child from the view
            node.dispose();
          }
        });
      }
    });

    // Add prisms toolbox Node
    const prismToolboxNode = new PrismToolboxNode(this.modelViewTransform, prismsModel, this.prismLayer, this.visibleBoundsProperty, this.occlusionHandler, {
      left: this.layoutBounds.minX + 12
    });

    // Add the reset all button
    const resetAllButton = new ResetAllButton({
      listener: () => {
        prismsModel.reset();
        this.reset();
        environmentMediumControlPanel.reset();
        prismToolboxNode.objectMediumControlPanel.reset();
        radioButtonAdapterProperty.reset();
      },
      radius: 19
    });
    this.afterLightLayer2.addChild(resetAllButton);
    this.afterLightLayer.addChild(prismToolboxNode);

    // Add the protractor node
    const protractorNode = new ProtractorNode({
      visibleProperty: prismsModel.showProtractorProperty,
      rotatable: true,
      scale: 0.46
    });
    const protractorPositionProperty = new Property(this.modelViewTransform.modelToViewXY(2E-5, 0));
    const protractorNodeListener = new DragListener({
      useParentOffset: true,
      positionProperty: protractorPositionProperty,
      targetNode: protractorNode,
      dragBoundsProperty: this.visibleBoundsProperty,
      end: () => {
        // If the protractor is hidden behind any of the controls in the top right, move it to the left
        const bounds = environmentMediumControlPanel.globalBounds.union(laserTypeRadioButtonGroup.globalBounds).union(laserControlPanel.globalBounds);
        while (bounds.intersectsBounds(protractorNode.globalBounds)) {
          protractorPositionProperty.value = protractorPositionProperty.value.plusXY(-10, 0);
        }
      }
    });
    protractorNode.addInputListener(protractorNodeListener);
    protractorPositionProperty.link(protractorPosition => {
      protractorNode.center = protractorPosition;
    });
    this.afterLightLayer.addChild(protractorNode);
    this.afterLightLayer.addChild(this.prismLayer);
    FloatingLayout.floatRight(this, [environmentMediumControlPanel, laserControlPanel, resetAllButton, laserTypeRadioButtonGroup]);
    FloatingLayout.floatBottom(this, [prismToolboxNode, resetAllButton]);
    FloatingLayout.floatTop(this, [environmentMediumControlPanel]);
    this.visibleBoundsProperty.link(visibleBounds => {
      laserTypeRadioButtonGroup.top = environmentMediumControlPanel.bottom + 15;
      laserControlPanel.top = laserTypeRadioButtonGroup.bottom + 15;
    });
    this.visibleBoundsProperty.link(visibleBounds => {
      this.whiteLightNode && this.whiteLightNode.setCanvasBounds(visibleBounds);
      environmentMediumNodeForMonochromaticLight.setRect(visibleBounds.x, visibleBounds.y, visibleBounds.width, visibleBounds.height);
    });
    this.resetPrismsView = () => {
      protractorPositionProperty.reset();
      protractorNode.reset();
    };

    // Add a thin gray line to separate the navigation bar when the environmentMediumNode is black
    const navigationBarSeparator = new Rectangle(0, 0, 100, 100, {
      fill: '#999999',
      pickable: false
    });
    this.visibleBoundsProperty.link(visibleBounds => {
      const rectHeight = 2;
      navigationBarSeparator.setRect(visibleBounds.x, visibleBounds.y + visibleBounds.height - rectHeight, visibleBounds.width, rectHeight);
    });
    prismsModel.laser.colorModeProperty.link(color => {
      navigationBarSeparator.visible = color === ColorModeEnum.WHITE;
      prismsModel.mediumColorFactory.lightTypeProperty.value = color;
    });
    this.addChild(navigationBarSeparator);
  }
  reset() {
    this.prismLayer.removeAllChildren();
    this.resetPrismsView();
  }
  step() {
    super.step();
    this.updateWhiteLightNode();
  }
  updateWhiteLightNode() {
    if (this.prismsModel.laser.colorModeProperty.value === ColorModeEnum.WHITE && this.prismsModel.dirty) {
      this.whiteLightNode && this.whiteLightNode.step();
      this.prismsModel.dirty = false;
    }
  }

  /**
   * Add the screen-specific light nodes
   * @param bendingLightModel - passed because this is called during construction (before this.model
   * is set in the subtype)
   */
  addLightNodes(bendingLightModel) {
    const stageWidth = this.layoutBounds.width;
    const stageHeight = this.layoutBounds.height;
    this.whiteLightNode = new WhiteLightCanvasNode(this.modelViewTransform, stageWidth, stageHeight, bendingLightModel.rays, bendingLightModel.environmentMediumProperty, bendingLightModel.mediumColorFactory);
    this.whiteLightNode.setExcludeInvisible(true);

    // Since the light canvas is opaque, it must be placed behind the control panels.
    this.addChild(this.whiteLightNode);

    // switch between light render for white vs nonwhite light
    bendingLightModel.laser.colorModeProperty.link(color => {
      this.whiteLightNode && this.whiteLightNode.setVisible(color === ColorModeEnum.WHITE);
    });
  }
  addLaserHandles(showRotationDragHandlesProperty, showTranslationDragHandlesProperty, clockwiseArrowNotAtMax, ccwArrowNotAtMax, laserImageWidth) {
    const bendingLightModel = this.bendingLightModel;
    super.addLaserHandles(showRotationDragHandlesProperty, showTranslationDragHandlesProperty, clockwiseArrowNotAtMax, ccwArrowNotAtMax, laserImageWidth);

    // add translation indicators that show if/when the laser can be moved by dragging
    const arrowLength = 83;
    const horizontalTranslationDragHandle = new TranslationDragHandle(this.modelViewTransform, bendingLightModel.laser, arrowLength, 0, showTranslationDragHandlesProperty, laserImageWidth);
    this.addChild(horizontalTranslationDragHandle);
    const verticalTranslationDragHandle = new TranslationDragHandle(this.modelViewTransform, bendingLightModel.laser, 0, arrowLength, showTranslationDragHandlesProperty, laserImageWidth);
    this.addChild(verticalTranslationDragHandle);
  }
}
bendingLight.register('PrismsScreenView', PrismsScreenView);
export default PrismsScreenView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIm1lcmdlIiwiUmVzZXRBbGxCdXR0b24iLCJQcm90cmFjdG9yTm9kZSIsIkRyYWdMaXN0ZW5lciIsIk5vZGUiLCJSZWN0YW5nbGUiLCJWQm94IiwiUGFuZWwiLCJiZW5kaW5nTGlnaHQiLCJCZW5kaW5nTGlnaHRTdHJpbmdzIiwiQmVuZGluZ0xpZ2h0U2NyZWVuVmlldyIsIkZsb2F0aW5nTGF5b3V0IiwiTWVkaXVtQ29udHJvbFBhbmVsIiwiVHJhbnNsYXRpb25EcmFnSGFuZGxlIiwiV2F2ZWxlbmd0aENvbnRyb2wiLCJJbnRlcnNlY3Rpb25Ob2RlIiwiTGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cCIsIlByaXNtVG9vbGJveE5vZGUiLCJXaGl0ZUxpZ2h0Q2FudmFzTm9kZSIsIkJvb2xlYW5Qcm9wZXJ0eSIsIkVudW1lcmF0aW9uUHJvcGVydHkiLCJDb2xvck1vZGVFbnVtIiwiTGlnaHRUeXBlIiwiSU5TRVQiLCJlbnZpcm9ubWVudFN0cmluZ1Byb3BlcnR5IiwiUHJpc21zU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwicHJpc21zTW9kZWwiLCJwcm92aWRlZE9wdGlvbnMiLCJob3Jpem9udGFsUGxheUFyZWFPZmZzZXQiLCJ2ZXJ0aWNhbFBsYXlBcmVhT2Zmc2V0Iiwib2NjbHVzaW9uSGFuZGxlciIsIm5vZGUiLCJjb250cm9sUGFuZWxzIiwibGFzZXJDb250cm9sUGFuZWwiLCJsYXNlclR5cGVSYWRpb0J1dHRvbkdyb3VwIiwiZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwiLCJmb3JFYWNoIiwiY29udHJvbFBhbmVsIiwiZ2xvYmFsQm91bmRzIiwiY29udGFpbnNQb2ludCIsImNlbnRlciIsInRyYW5zbGF0ZVZpZXdYWSIsImdsb2JhbFRvUGFyZW50Qm91bmRzIiwibWluWCIsImNlbnRlclgiLCJwcmlzbUxheWVyIiwibGF5ZXJTcGxpdCIsImVudmlyb25tZW50TWVkaXVtTm9kZUZvck1vbm9jaHJvbWF0aWNMaWdodCIsImVudmlyb25tZW50TWVkaXVtUHJvcGVydHkiLCJsaW5rIiwiZW52aXJvbm1lbnRNZWRpdW0iLCJpbmRleE9mUmVmcmFjdGlvbkZvclJlZCIsInN1YnN0YW5jZSIsImRpc3BlcnNpb25GdW5jdGlvbiIsImdldEluZGV4T2ZSZWZyYWN0aW9uRm9yUmVkIiwiY29sb3IiLCJtZWRpdW1Db2xvckZhY3RvcnkiLCJnZXRDb2xvckFnYWluc3RXaGl0ZSIsImZpbGwiLCJpbnNlcnRDaGlsZCIsImluZGV4T2ZSZWZyYWN0aW9uRGVjaW1hbHMiLCJ3YXZlbGVuZ3RoUHJvcGVydHkiLCJ5TWFyZ2luIiwiY29tYm9Cb3hMaXN0UG9zaXRpb24iLCJzZXRUcmFuc2xhdGlvbiIsImxheW91dEJvdW5kcyIsInJpZ2h0Iiwid2lkdGgiLCJ0b3AiLCJhZnRlckxpZ2h0TGF5ZXIyIiwiYWRkQ2hpbGQiLCJzbGlkZXJFbmFibGVkUHJvcGVydHkiLCJyYWRpb0J1dHRvbkFkYXB0ZXJQcm9wZXJ0eSIsIlNJTkdMRV9DT0xPUiIsInJhZGlvQnV0dG9uQWRhcHRlclZhbHVlIiwibGFzZXIiLCJjb2xvck1vZGVQcm9wZXJ0eSIsInZhbHVlIiwiV0hJVEUiLCJtYW55UmF5c1Byb3BlcnR5IiwiU0lOR0xFX0NPTE9SXzVYIiwic3BhY2luZyIsImNoaWxkcmVuIiwiY29ybmVyUmFkaXVzIiwieE1hcmdpbiIsInN0cm9rZSIsImxpbmVXaWR0aCIsImluY2lkZW50V2F2ZUxheWVyIiwic2V0VmlzaWJsZSIsImludGVyc2VjdGlvbnMiLCJhZGRJdGVtQWRkZWRMaXN0ZW5lciIsImFkZGVkSW50ZXJzZWN0aW9uIiwic2hvd05vcm1hbHNQcm9wZXJ0eSIsIm1vZGVsVmlld1RyYW5zZm9ybSIsImludGVyc2VjdGlvblN0cm9rZVByb3BlcnR5IiwiYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciIsInJlbW92ZWRJbnRlcnNlY3Rpb24iLCJkaXNwb3NlIiwicHJpc21Ub29sYm94Tm9kZSIsInZpc2libGVCb3VuZHNQcm9wZXJ0eSIsImxlZnQiLCJyZXNldEFsbEJ1dHRvbiIsImxpc3RlbmVyIiwicmVzZXQiLCJvYmplY3RNZWRpdW1Db250cm9sUGFuZWwiLCJyYWRpdXMiLCJhZnRlckxpZ2h0TGF5ZXIiLCJwcm90cmFjdG9yTm9kZSIsInZpc2libGVQcm9wZXJ0eSIsInNob3dQcm90cmFjdG9yUHJvcGVydHkiLCJyb3RhdGFibGUiLCJzY2FsZSIsInByb3RyYWN0b3JQb3NpdGlvblByb3BlcnR5IiwibW9kZWxUb1ZpZXdYWSIsInByb3RyYWN0b3JOb2RlTGlzdGVuZXIiLCJ1c2VQYXJlbnRPZmZzZXQiLCJwb3NpdGlvblByb3BlcnR5IiwidGFyZ2V0Tm9kZSIsImRyYWdCb3VuZHNQcm9wZXJ0eSIsImVuZCIsImJvdW5kcyIsInVuaW9uIiwiaW50ZXJzZWN0c0JvdW5kcyIsInBsdXNYWSIsImFkZElucHV0TGlzdGVuZXIiLCJwcm90cmFjdG9yUG9zaXRpb24iLCJmbG9hdFJpZ2h0IiwiZmxvYXRCb3R0b20iLCJmbG9hdFRvcCIsInZpc2libGVCb3VuZHMiLCJib3R0b20iLCJ3aGl0ZUxpZ2h0Tm9kZSIsInNldENhbnZhc0JvdW5kcyIsInNldFJlY3QiLCJ4IiwieSIsImhlaWdodCIsInJlc2V0UHJpc21zVmlldyIsIm5hdmlnYXRpb25CYXJTZXBhcmF0b3IiLCJwaWNrYWJsZSIsInJlY3RIZWlnaHQiLCJ2aXNpYmxlIiwibGlnaHRUeXBlUHJvcGVydHkiLCJyZW1vdmVBbGxDaGlsZHJlbiIsInN0ZXAiLCJ1cGRhdGVXaGl0ZUxpZ2h0Tm9kZSIsImRpcnR5IiwiYWRkTGlnaHROb2RlcyIsImJlbmRpbmdMaWdodE1vZGVsIiwic3RhZ2VXaWR0aCIsInN0YWdlSGVpZ2h0IiwicmF5cyIsInNldEV4Y2x1ZGVJbnZpc2libGUiLCJhZGRMYXNlckhhbmRsZXMiLCJzaG93Um90YXRpb25EcmFnSGFuZGxlc1Byb3BlcnR5Iiwic2hvd1RyYW5zbGF0aW9uRHJhZ0hhbmRsZXNQcm9wZXJ0eSIsImNsb2Nrd2lzZUFycm93Tm90QXRNYXgiLCJjY3dBcnJvd05vdEF0TWF4IiwibGFzZXJJbWFnZVdpZHRoIiwiYXJyb3dMZW5ndGgiLCJob3Jpem9udGFsVHJhbnNsYXRpb25EcmFnSGFuZGxlIiwidmVydGljYWxUcmFuc2xhdGlvbkRyYWdIYW5kbGUiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlByaXNtc1NjcmVlblZpZXcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTUtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlldyBmb3IgdGhlIFwiUHJpc21zXCIgU2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIENoYW5kcmFzaGVrYXIgQmVtYWdvbmkgKEFjdHVhbCBDb25jZXB0cylcclxuICovXHJcblxyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IFJlc2V0QWxsQnV0dG9uIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9idXR0b25zL1Jlc2V0QWxsQnV0dG9uLmpzJztcclxuaW1wb3J0IFByb3RyYWN0b3JOb2RlIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9Qcm90cmFjdG9yTm9kZS5qcyc7XHJcbmltcG9ydCB7IERyYWdMaXN0ZW5lciwgTm9kZSwgUmVjdGFuZ2xlLCBWQm94IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IFBhbmVsIGZyb20gJy4uLy4uLy4uLy4uL3N1bi9qcy9QYW5lbC5qcyc7XHJcbmltcG9ydCBiZW5kaW5nTGlnaHQgZnJvbSAnLi4vLi4vYmVuZGluZ0xpZ2h0LmpzJztcclxuaW1wb3J0IEJlbmRpbmdMaWdodFN0cmluZ3MgZnJvbSAnLi4vLi4vQmVuZGluZ0xpZ2h0U3RyaW5ncy5qcyc7XHJcbmltcG9ydCBCZW5kaW5nTGlnaHRTY3JlZW5WaWV3LCB7IEJlbmRpbmdMaWdodFNjcmVlblZpZXdPcHRpb25zIH0gZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvQmVuZGluZ0xpZ2h0U2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCBGbG9hdGluZ0xheW91dCBmcm9tICcuLi8uLi9jb21tb24vdmlldy9GbG9hdGluZ0xheW91dC5qcyc7XHJcbmltcG9ydCBNZWRpdW1Db250cm9sUGFuZWwgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvTWVkaXVtQ29udHJvbFBhbmVsLmpzJztcclxuaW1wb3J0IFRyYW5zbGF0aW9uRHJhZ0hhbmRsZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9UcmFuc2xhdGlvbkRyYWdIYW5kbGUuanMnO1xyXG5pbXBvcnQgV2F2ZWxlbmd0aENvbnRyb2wgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvV2F2ZWxlbmd0aENvbnRyb2wuanMnO1xyXG5pbXBvcnQgSW50ZXJzZWN0aW9uIGZyb20gJy4uL21vZGVsL0ludGVyc2VjdGlvbi5qcyc7XHJcbmltcG9ydCBQcmlzbXNNb2RlbCBmcm9tICcuLi9tb2RlbC9QcmlzbXNNb2RlbC5qcyc7XHJcbmltcG9ydCBJbnRlcnNlY3Rpb25Ob2RlIGZyb20gJy4vSW50ZXJzZWN0aW9uTm9kZS5qcyc7XHJcbmltcG9ydCBMYXNlclR5cGVSYWRpb0J1dHRvbkdyb3VwIGZyb20gJy4vTGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cC5qcyc7XHJcbmltcG9ydCBQcmlzbVRvb2xib3hOb2RlIGZyb20gJy4vUHJpc21Ub29sYm94Tm9kZS5qcyc7XHJcbmltcG9ydCBXaGl0ZUxpZ2h0Q2FudmFzTm9kZSBmcm9tICcuL1doaXRlTGlnaHRDYW52YXNOb2RlLmpzJztcclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IEVudW1lcmF0aW9uUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9FbnVtZXJhdGlvblByb3BlcnR5LmpzJztcclxuaW1wb3J0IENvbG9yTW9kZUVudW0gZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0NvbG9yTW9kZUVudW0uanMnO1xyXG5pbXBvcnQgTGlnaHRUeXBlIGZyb20gJy4uL21vZGVsL0xpZ2h0VHlwZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudHNcclxuY29uc3QgSU5TRVQgPSAxMDtcclxuXHJcbmNvbnN0IGVudmlyb25tZW50U3RyaW5nUHJvcGVydHkgPSBCZW5kaW5nTGlnaHRTdHJpbmdzLmVudmlyb25tZW50U3RyaW5nUHJvcGVydHk7XHJcblxyXG50eXBlIFByaXNtc1NjcmVlblZpZXdPcHRpb25zID0gQmVuZGluZ0xpZ2h0U2NyZWVuVmlld09wdGlvbnM7XHJcblxyXG5jbGFzcyBQcmlzbXNTY3JlZW5WaWV3IGV4dGVuZHMgQmVuZGluZ0xpZ2h0U2NyZWVuVmlldyB7XHJcbiAgcHJpdmF0ZSBwcmlzbUxheWVyOiBOb2RlO1xyXG4gIHByaXZhdGUgcHJpc21zTW9kZWw6IFByaXNtc01vZGVsO1xyXG4gIHByaXZhdGUgcmVzZXRQcmlzbXNWaWV3OiAoKSA9PiB2b2lkO1xyXG5cclxuICAvLyBAdHMtZXhwZWN0LWVycm9yIGFzc2lnbmVkIGluIHRoZSBzdXBlcmNhbGwgd2hpY2ggY2FsbHMgYWRkTGlnaHROb2Rlc1xyXG4gIHByaXZhdGUgd2hpdGVMaWdodE5vZGU6IFdoaXRlTGlnaHRDYW52YXNOb2RlO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gcHJpc21zTW9kZWwgLSBtb2RlbCBvZiBwcmlzbXMgc2NyZWVuXHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBwcmlzbXNNb2RlbDogUHJpc21zTW9kZWwsIHByb3ZpZGVkT3B0aW9ucz86IFByaXNtc1NjcmVlblZpZXdPcHRpb25zICkge1xyXG5cclxuICAgIHN1cGVyKFxyXG4gICAgICBwcmlzbXNNb2RlbCxcclxuXHJcbiAgICAgIC8vIGxhc2VySGFzS25vYlxyXG4gICAgICB0cnVlLFxyXG5cclxuICAgICAgbWVyZ2UoIHtcclxuXHJcbiAgICAgICAgLy8gY2VudGVyIHRoZSBwbGF5IGFyZWEgaG9yaXpvbnRhbGx5IGluIHRoZSBzcGFjZSBiZXR3ZWVuIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIHNjcmVlbiBhbmQgdGhlIGNvbnRyb2wgcGFuZWxzIG9uXHJcbiAgICAgICAgLy8gdGhlIHJpZ2h0LCBhbmQgbW92ZSB0aGUgbGFzZXIgdG8gdGhlIGxlZnQuXHJcbiAgICAgICAgaG9yaXpvbnRhbFBsYXlBcmVhT2Zmc2V0OiAyNDAsXHJcblxyXG4gICAgICAgIC8vIENlbnRlciB0aGUgcGxheSBhcmVhIHZlcnRpY2FsbHkgYWJvdmUgdGhlIHNvdXRoIGNvbnRyb2wgcGFuZWxcclxuICAgICAgICB2ZXJ0aWNhbFBsYXlBcmVhT2Zmc2V0OiAtNDMsXHJcblxyXG4gICAgICAgIC8vIGlmIHRoZSBwcmlzbSBpcyBkcm9wcGVkIGJlaGluZCBhIGNvbnRyb2wgcGFuZWwsIGJ1bXAgaXQgdG8gdGhlIGxlZnQuXHJcbiAgICAgICAgb2NjbHVzaW9uSGFuZGxlcjogKCBub2RlOiBOb2RlICkgPT4ge1xyXG5cclxuICAgICAgICAgIGNvbnN0IGNvbnRyb2xQYW5lbHMgPSBbXHJcbiAgICAgICAgICAgIGxhc2VyQ29udHJvbFBhbmVsLFxyXG4gICAgICAgICAgICBsYXNlclR5cGVSYWRpb0J1dHRvbkdyb3VwLFxyXG4gICAgICAgICAgICBlbnZpcm9ubWVudE1lZGl1bUNvbnRyb2xQYW5lbFxyXG4gICAgICAgICAgXTtcclxuICAgICAgICAgIGNvbnRyb2xQYW5lbHMuZm9yRWFjaCggY29udHJvbFBhbmVsID0+IHtcclxuICAgICAgICAgICAgaWYgKCBjb250cm9sUGFuZWwuZ2xvYmFsQm91bmRzLmNvbnRhaW5zUG9pbnQoIG5vZGUuZ2xvYmFsQm91bmRzLmNlbnRlciApICkge1xyXG5cclxuICAgICAgICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yXHJcbiAgICAgICAgICAgICAgbm9kZS50cmFuc2xhdGVWaWV3WFkoIG5vZGUuZ2xvYmFsVG9QYXJlbnRCb3VuZHMoIGNvbnRyb2xQYW5lbC5nbG9iYWxCb3VuZHMgKS5taW5YIC0gbm9kZS5jZW50ZXJYLCAwICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApXHJcbiAgICApO1xyXG5cclxuICAgIHRoaXMucHJpc21MYXllciA9IG5ldyBOb2RlKCB7IGxheWVyU3BsaXQ6IHRydWUgfSApO1xyXG4gICAgdGhpcy5wcmlzbXNNb2RlbCA9IHByaXNtc01vZGVsO1xyXG5cclxuICAgIC8vIE5vZGUgZm9yIHRoZSBlbnZpcm9ubWVudCB0aGF0IHNwYW5zIHRoZSBzY3JlZW4gKG9ubHkgZm9yIG1vbm9jaHJvbWF0aWMgbGlnaHQsIHRoZSB3aGl0ZSBsaWdodCBiYWNrZ3JvdW5kXHJcbiAgICAvLyBpcyByZW5kZXJlZCBhcyBvcGFxdWUgaW4gdGhlIHdoaXRlIGxpZ2h0IG5vZGUgZm9yIGJsZW5kaW5nIHB1cnBvc2VzKVxyXG4gICAgY29uc3QgZW52aXJvbm1lbnRNZWRpdW1Ob2RlRm9yTW9ub2Nocm9tYXRpY0xpZ2h0ID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMCwgMCApO1xyXG4gICAgcHJpc21zTW9kZWwuZW52aXJvbm1lbnRNZWRpdW1Qcm9wZXJ0eS5saW5rKCBlbnZpcm9ubWVudE1lZGl1bSA9PiB7XHJcblxyXG4gICAgICAvLyBUaGlzIG1lZGl1bSBub2RlIG9ubHkgc2hvd3MgdGhlIGNvbG9yIGZvciBtb25vY2hyb21hdGljIGxpZ2h0XHJcbiAgICAgIGNvbnN0IGluZGV4T2ZSZWZyYWN0aW9uRm9yUmVkID0gZW52aXJvbm1lbnRNZWRpdW0uc3Vic3RhbmNlLmRpc3BlcnNpb25GdW5jdGlvbi5nZXRJbmRleE9mUmVmcmFjdGlvbkZvclJlZCgpO1xyXG4gICAgICBjb25zdCBjb2xvciA9IHByaXNtc01vZGVsLm1lZGl1bUNvbG9yRmFjdG9yeS5nZXRDb2xvckFnYWluc3RXaGl0ZSggaW5kZXhPZlJlZnJhY3Rpb25Gb3JSZWQgKTtcclxuXHJcbiAgICAgIGVudmlyb25tZW50TWVkaXVtTm9kZUZvck1vbm9jaHJvbWF0aWNMaWdodC5maWxsID0gY29sb3I7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gUHV0IGl0IGJlaGluZCBldmVyeXRoaW5nIGVsc2VcclxuICAgIHRoaXMuaW5zZXJ0Q2hpbGQoIDAsIGVudmlyb25tZW50TWVkaXVtTm9kZUZvck1vbm9jaHJvbWF0aWNMaWdodCApO1xyXG5cclxuICAgIGNvbnN0IGluZGV4T2ZSZWZyYWN0aW9uRGVjaW1hbHMgPSAyO1xyXG5cclxuICAgIC8vIEFkZCBjb250cm9sIHBhbmVscyBmb3Igc2V0dGluZyB0aGUgaW5kZXggb2YgcmVmcmFjdGlvbiBmb3IgZWFjaCBtZWRpdW1cclxuICAgIGNvbnN0IGVudmlyb25tZW50TWVkaXVtQ29udHJvbFBhbmVsID0gbmV3IE1lZGl1bUNvbnRyb2xQYW5lbCggdGhpcywgcHJpc21zTW9kZWwubWVkaXVtQ29sb3JGYWN0b3J5LCBwcmlzbXNNb2RlbC5lbnZpcm9ubWVudE1lZGl1bVByb3BlcnR5LFxyXG4gICAgICBlbnZpcm9ubWVudFN0cmluZ1Byb3BlcnR5LCBmYWxzZSwgcHJpc21zTW9kZWwud2F2ZWxlbmd0aFByb3BlcnR5LFxyXG4gICAgICBpbmRleE9mUmVmcmFjdGlvbkRlY2ltYWxzLCB7XHJcbiAgICAgICAgeU1hcmdpbjogNixcclxuICAgICAgICBjb21ib0JveExpc3RQb3NpdGlvbjogJ2JlbG93J1xyXG4gICAgICB9ICk7XHJcbiAgICBlbnZpcm9ubWVudE1lZGl1bUNvbnRyb2xQYW5lbC5zZXRUcmFuc2xhdGlvbihcclxuICAgICAgdGhpcy5sYXlvdXRCb3VuZHMucmlnaHQgLSAyICogSU5TRVQgLSBlbnZpcm9ubWVudE1lZGl1bUNvbnRyb2xQYW5lbC53aWR0aCwgdGhpcy5sYXlvdXRCb3VuZHMudG9wICsgMTUgKTtcclxuICAgIHRoaXMuYWZ0ZXJMaWdodExheWVyMi5hZGRDaGlsZCggZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwgKTtcclxuXHJcbiAgICBjb25zdCBzbGlkZXJFbmFibGVkUHJvcGVydHkgPSBuZXcgQm9vbGVhblByb3BlcnR5KCBmYWxzZSApO1xyXG5cclxuICAgIGNvbnN0IHJhZGlvQnV0dG9uQWRhcHRlclByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIExpZ2h0VHlwZS5TSU5HTEVfQ09MT1IgKTtcclxuICAgIHJhZGlvQnV0dG9uQWRhcHRlclByb3BlcnR5LmxpbmsoIHJhZGlvQnV0dG9uQWRhcHRlclZhbHVlID0+IHtcclxuICAgICAgcHJpc21zTW9kZWwubGFzZXIuY29sb3JNb2RlUHJvcGVydHkudmFsdWUgPSByYWRpb0J1dHRvbkFkYXB0ZXJWYWx1ZSA9PT0gTGlnaHRUeXBlLldISVRFID8gQ29sb3JNb2RlRW51bS5XSElURSA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29sb3JNb2RlRW51bS5TSU5HTEVfQ09MT1I7XHJcbiAgICAgIHByaXNtc01vZGVsLm1hbnlSYXlzUHJvcGVydHkudmFsdWUgPSByYWRpb0J1dHRvbkFkYXB0ZXJWYWx1ZSA9PT0gTGlnaHRUeXBlLlNJTkdMRV9DT0xPUl81WCA/IDUgOiAxO1xyXG4gICAgICBzbGlkZXJFbmFibGVkUHJvcGVydHkudmFsdWUgPSByYWRpb0J1dHRvbkFkYXB0ZXJWYWx1ZSAhPT0gTGlnaHRUeXBlLldISVRFO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGNvbnN0IGxhc2VyVHlwZVJhZGlvQnV0dG9uR3JvdXAgPSBuZXcgTGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cCggcmFkaW9CdXR0b25BZGFwdGVyUHJvcGVydHkgKTtcclxuICAgIHRoaXMuYWZ0ZXJMaWdodExheWVyMi5hZGRDaGlsZCggbGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cCApO1xyXG5cclxuICAgIGNvbnN0IGxhc2VyQ29udHJvbFBhbmVsID0gbmV3IFBhbmVsKCBuZXcgVkJveCgge1xyXG4gICAgICBzcGFjaW5nOiAxMCxcclxuICAgICAgY2hpbGRyZW46IFtcclxuICAgICAgICBuZXcgV2F2ZWxlbmd0aENvbnRyb2woIHByaXNtc01vZGVsLndhdmVsZW5ndGhQcm9wZXJ0eSwgc2xpZGVyRW5hYmxlZFByb3BlcnR5LCAxNDYgKSBdXHJcbiAgICB9ICksIHtcclxuICAgICAgY29ybmVyUmFkaXVzOiA1LFxyXG4gICAgICB4TWFyZ2luOiAxMCxcclxuICAgICAgeU1hcmdpbjogNixcclxuICAgICAgZmlsbDogJyNFRUVFRUUnLFxyXG4gICAgICBzdHJva2U6ICcjNjk2OTY5JyxcclxuICAgICAgbGluZVdpZHRoOiAxLjVcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFmdGVyTGlnaHRMYXllcjIuYWRkQ2hpbGQoIGxhc2VyQ29udHJvbFBhbmVsICk7XHJcbiAgICB0aGlzLmluY2lkZW50V2F2ZUxheWVyLnNldFZpc2libGUoIGZhbHNlICk7XHJcblxyXG4gICAgLy8gT3B0aW9uYWxseSBzaG93IHRoZSBub3JtYWwgbGluZXMgYXQgZWFjaCBpbnRlcnNlY3Rpb25cclxuICAgIHByaXNtc01vZGVsLmludGVyc2VjdGlvbnMuYWRkSXRlbUFkZGVkTGlzdGVuZXIoICggYWRkZWRJbnRlcnNlY3Rpb246IEludGVyc2VjdGlvbiApID0+IHtcclxuICAgICAgaWYgKCBwcmlzbXNNb2RlbC5zaG93Tm9ybWFsc1Byb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSBuZXcgSW50ZXJzZWN0aW9uTm9kZShcclxuICAgICAgICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLFxyXG4gICAgICAgICAgYWRkZWRJbnRlcnNlY3Rpb24sXHJcbiAgICAgICAgICBwcmlzbXNNb2RlbC5pbnRlcnNlY3Rpb25TdHJva2VQcm9wZXJ0eVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgdGhpcy5hZGRDaGlsZCggbm9kZSApO1xyXG5cclxuICAgICAgICBwcmlzbXNNb2RlbC5pbnRlcnNlY3Rpb25zLmFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIoICggcmVtb3ZlZEludGVyc2VjdGlvbjogSW50ZXJzZWN0aW9uICkgPT4ge1xyXG4gICAgICAgICAgaWYgKCByZW1vdmVkSW50ZXJzZWN0aW9uID09PSBhZGRlZEludGVyc2VjdGlvbiApIHtcclxuXHJcbiAgICAgICAgICAgIC8vIGRpc3Bvc2Ugd2lsbCByZW1vdmUgdGhlIGNoaWxkIGZyb20gdGhlIHZpZXdcclxuICAgICAgICAgICAgbm9kZS5kaXNwb3NlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQWRkIHByaXNtcyB0b29sYm94IE5vZGVcclxuICAgIGNvbnN0IHByaXNtVG9vbGJveE5vZGUgPSBuZXcgUHJpc21Ub29sYm94Tm9kZShcclxuICAgICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0sXHJcbiAgICAgIHByaXNtc01vZGVsLFxyXG4gICAgICB0aGlzLnByaXNtTGF5ZXIsXHJcbiAgICAgIHRoaXMudmlzaWJsZUJvdW5kc1Byb3BlcnR5LFxyXG4gICAgICB0aGlzLm9jY2x1c2lvbkhhbmRsZXIsIHtcclxuICAgICAgICBsZWZ0OiB0aGlzLmxheW91dEJvdW5kcy5taW5YICsgMTJcclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBBZGQgdGhlIHJlc2V0IGFsbCBidXR0b25cclxuICAgIGNvbnN0IHJlc2V0QWxsQnV0dG9uID0gbmV3IFJlc2V0QWxsQnV0dG9uKCB7XHJcbiAgICAgIGxpc3RlbmVyOiAoKSA9PiB7XHJcbiAgICAgICAgcHJpc21zTW9kZWwucmVzZXQoKTtcclxuICAgICAgICB0aGlzLnJlc2V0KCk7XHJcbiAgICAgICAgZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwucmVzZXQoKTtcclxuICAgICAgICBwcmlzbVRvb2xib3hOb2RlLm9iamVjdE1lZGl1bUNvbnRyb2xQYW5lbC5yZXNldCgpO1xyXG4gICAgICAgIHJhZGlvQnV0dG9uQWRhcHRlclByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJhZGl1czogMTlcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFmdGVyTGlnaHRMYXllcjIuYWRkQ2hpbGQoIHJlc2V0QWxsQnV0dG9uICk7XHJcbiAgICB0aGlzLmFmdGVyTGlnaHRMYXllci5hZGRDaGlsZCggcHJpc21Ub29sYm94Tm9kZSApO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgcHJvdHJhY3RvciBub2RlXHJcbiAgICBjb25zdCBwcm90cmFjdG9yTm9kZSA9IG5ldyBQcm90cmFjdG9yTm9kZSgge1xyXG4gICAgICB2aXNpYmxlUHJvcGVydHk6IHByaXNtc01vZGVsLnNob3dQcm90cmFjdG9yUHJvcGVydHksXHJcbiAgICAgIHJvdGF0YWJsZTogdHJ1ZSxcclxuICAgICAgc2NhbGU6IDAuNDZcclxuICAgIH0gKTtcclxuICAgIGNvbnN0IHByb3RyYWN0b3JQb3NpdGlvblByb3BlcnR5ID0gbmV3IFByb3BlcnR5KCB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1hZKCAyRS01LCAwICkgKTtcclxuXHJcbiAgICBjb25zdCBwcm90cmFjdG9yTm9kZUxpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcigge1xyXG4gICAgICB1c2VQYXJlbnRPZmZzZXQ6IHRydWUsXHJcbiAgICAgIHBvc2l0aW9uUHJvcGVydHk6IHByb3RyYWN0b3JQb3NpdGlvblByb3BlcnR5LFxyXG4gICAgICB0YXJnZXROb2RlOiBwcm90cmFjdG9yTm9kZSxcclxuICAgICAgZHJhZ0JvdW5kc1Byb3BlcnR5OiB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eSxcclxuICAgICAgZW5kOiAoKSA9PiB7XHJcblxyXG4gICAgICAgIC8vIElmIHRoZSBwcm90cmFjdG9yIGlzIGhpZGRlbiBiZWhpbmQgYW55IG9mIHRoZSBjb250cm9scyBpbiB0aGUgdG9wIHJpZ2h0LCBtb3ZlIGl0IHRvIHRoZSBsZWZ0XHJcbiAgICAgICAgY29uc3QgYm91bmRzID0gZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwuZ2xvYmFsQm91bmRzXHJcbiAgICAgICAgICAudW5pb24oIGxhc2VyVHlwZVJhZGlvQnV0dG9uR3JvdXAuZ2xvYmFsQm91bmRzIClcclxuICAgICAgICAgIC51bmlvbiggbGFzZXJDb250cm9sUGFuZWwuZ2xvYmFsQm91bmRzICk7XHJcbiAgICAgICAgd2hpbGUgKCBib3VuZHMuaW50ZXJzZWN0c0JvdW5kcyggcHJvdHJhY3Rvck5vZGUuZ2xvYmFsQm91bmRzICkgKSB7XHJcbiAgICAgICAgICBwcm90cmFjdG9yUG9zaXRpb25Qcm9wZXJ0eS52YWx1ZSA9IHByb3RyYWN0b3JQb3NpdGlvblByb3BlcnR5LnZhbHVlLnBsdXNYWSggLTEwLCAwICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgICBwcm90cmFjdG9yTm9kZS5hZGRJbnB1dExpc3RlbmVyKCBwcm90cmFjdG9yTm9kZUxpc3RlbmVyICk7XHJcblxyXG4gICAgcHJvdHJhY3RvclBvc2l0aW9uUHJvcGVydHkubGluayggcHJvdHJhY3RvclBvc2l0aW9uID0+IHtcclxuICAgICAgcHJvdHJhY3Rvck5vZGUuY2VudGVyID0gcHJvdHJhY3RvclBvc2l0aW9uO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuYWZ0ZXJMaWdodExheWVyLmFkZENoaWxkKCBwcm90cmFjdG9yTm9kZSApO1xyXG4gICAgdGhpcy5hZnRlckxpZ2h0TGF5ZXIuYWRkQ2hpbGQoIHRoaXMucHJpc21MYXllciApO1xyXG5cclxuICAgIEZsb2F0aW5nTGF5b3V0LmZsb2F0UmlnaHQoIHRoaXMsIFtcclxuICAgICAgZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwsXHJcbiAgICAgIGxhc2VyQ29udHJvbFBhbmVsLFxyXG4gICAgICByZXNldEFsbEJ1dHRvbixcclxuICAgICAgbGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cFxyXG4gICAgXSApO1xyXG4gICAgRmxvYXRpbmdMYXlvdXQuZmxvYXRCb3R0b20oIHRoaXMsIFsgcHJpc21Ub29sYm94Tm9kZSwgcmVzZXRBbGxCdXR0b24gXSApO1xyXG4gICAgRmxvYXRpbmdMYXlvdXQuZmxvYXRUb3AoIHRoaXMsIFsgZW52aXJvbm1lbnRNZWRpdW1Db250cm9sUGFuZWwgXSApO1xyXG5cclxuICAgIHRoaXMudmlzaWJsZUJvdW5kc1Byb3BlcnR5LmxpbmsoICggdmlzaWJsZUJvdW5kczogQm91bmRzMiApID0+IHtcclxuICAgICAgbGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cC50b3AgPSBlbnZpcm9ubWVudE1lZGl1bUNvbnRyb2xQYW5lbC5ib3R0b20gKyAxNTtcclxuICAgICAgbGFzZXJDb250cm9sUGFuZWwudG9wID0gbGFzZXJUeXBlUmFkaW9CdXR0b25Hcm91cC5ib3R0b20gKyAxNTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLnZpc2libGVCb3VuZHNQcm9wZXJ0eS5saW5rKCAoIHZpc2libGVCb3VuZHM6IEJvdW5kczIgKSA9PiB7XHJcbiAgICAgIHRoaXMud2hpdGVMaWdodE5vZGUgJiYgdGhpcy53aGl0ZUxpZ2h0Tm9kZS5zZXRDYW52YXNCb3VuZHMoIHZpc2libGVCb3VuZHMgKTtcclxuICAgICAgZW52aXJvbm1lbnRNZWRpdW1Ob2RlRm9yTW9ub2Nocm9tYXRpY0xpZ2h0LnNldFJlY3QoIHZpc2libGVCb3VuZHMueCwgdmlzaWJsZUJvdW5kcy55LCB2aXNpYmxlQm91bmRzLndpZHRoLCB2aXNpYmxlQm91bmRzLmhlaWdodCApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMucmVzZXRQcmlzbXNWaWV3ID0gKCkgPT4ge1xyXG4gICAgICBwcm90cmFjdG9yUG9zaXRpb25Qcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgICBwcm90cmFjdG9yTm9kZS5yZXNldCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBBZGQgYSB0aGluIGdyYXkgbGluZSB0byBzZXBhcmF0ZSB0aGUgbmF2aWdhdGlvbiBiYXIgd2hlbiB0aGUgZW52aXJvbm1lbnRNZWRpdW1Ob2RlIGlzIGJsYWNrXHJcbiAgICBjb25zdCBuYXZpZ2F0aW9uQmFyU2VwYXJhdG9yID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMTAwLCAxMDAsIHsgZmlsbDogJyM5OTk5OTknLCBwaWNrYWJsZTogZmFsc2UgfSApO1xyXG4gICAgdGhpcy52aXNpYmxlQm91bmRzUHJvcGVydHkubGluayggKCB2aXNpYmxlQm91bmRzOiBCb3VuZHMyICkgPT4ge1xyXG4gICAgICBjb25zdCByZWN0SGVpZ2h0ID0gMjtcclxuICAgICAgbmF2aWdhdGlvbkJhclNlcGFyYXRvci5zZXRSZWN0KCB2aXNpYmxlQm91bmRzLngsIHZpc2libGVCb3VuZHMueSArIHZpc2libGVCb3VuZHMuaGVpZ2h0IC0gcmVjdEhlaWdodCwgdmlzaWJsZUJvdW5kcy53aWR0aCwgcmVjdEhlaWdodCApO1xyXG4gICAgfSApO1xyXG4gICAgcHJpc21zTW9kZWwubGFzZXIuY29sb3JNb2RlUHJvcGVydHkubGluayggY29sb3IgPT4ge1xyXG4gICAgICBuYXZpZ2F0aW9uQmFyU2VwYXJhdG9yLnZpc2libGUgPSBjb2xvciA9PT0gQ29sb3JNb2RlRW51bS5XSElURTtcclxuICAgICAgcHJpc21zTW9kZWwubWVkaXVtQ29sb3JGYWN0b3J5LmxpZ2h0VHlwZVByb3BlcnR5LnZhbHVlID0gY29sb3I7XHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBuYXZpZ2F0aW9uQmFyU2VwYXJhdG9yICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnByaXNtTGF5ZXIucmVtb3ZlQWxsQ2hpbGRyZW4oKTtcclxuICAgIHRoaXMucmVzZXRQcmlzbXNWaWV3KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgc3RlcCgpOiB2b2lkIHtcclxuICAgIHN1cGVyLnN0ZXAoKTtcclxuICAgIHRoaXMudXBkYXRlV2hpdGVMaWdodE5vZGUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlV2hpdGVMaWdodE5vZGUoKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMucHJpc21zTW9kZWwubGFzZXIuY29sb3JNb2RlUHJvcGVydHkudmFsdWUgPT09IENvbG9yTW9kZUVudW0uV0hJVEUgJiYgdGhpcy5wcmlzbXNNb2RlbC5kaXJ0eSApIHtcclxuICAgICAgdGhpcy53aGl0ZUxpZ2h0Tm9kZSAmJiB0aGlzLndoaXRlTGlnaHROb2RlLnN0ZXAoKTtcclxuICAgICAgdGhpcy5wcmlzbXNNb2RlbC5kaXJ0eSA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIHRoZSBzY3JlZW4tc3BlY2lmaWMgbGlnaHQgbm9kZXNcclxuICAgKiBAcGFyYW0gYmVuZGluZ0xpZ2h0TW9kZWwgLSBwYXNzZWQgYmVjYXVzZSB0aGlzIGlzIGNhbGxlZCBkdXJpbmcgY29uc3RydWN0aW9uIChiZWZvcmUgdGhpcy5tb2RlbFxyXG4gICAqIGlzIHNldCBpbiB0aGUgc3VidHlwZSlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWRkTGlnaHROb2RlcyggYmVuZGluZ0xpZ2h0TW9kZWw6IFByaXNtc01vZGVsICk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHN0YWdlV2lkdGggPSB0aGlzLmxheW91dEJvdW5kcy53aWR0aDtcclxuICAgIGNvbnN0IHN0YWdlSGVpZ2h0ID0gdGhpcy5sYXlvdXRCb3VuZHMuaGVpZ2h0O1xyXG5cclxuICAgIHRoaXMud2hpdGVMaWdodE5vZGUgPSBuZXcgV2hpdGVMaWdodENhbnZhc05vZGUoXHJcbiAgICAgIHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLFxyXG4gICAgICBzdGFnZVdpZHRoLFxyXG4gICAgICBzdGFnZUhlaWdodCxcclxuICAgICAgYmVuZGluZ0xpZ2h0TW9kZWwucmF5cyxcclxuICAgICAgYmVuZGluZ0xpZ2h0TW9kZWwuZW52aXJvbm1lbnRNZWRpdW1Qcm9wZXJ0eSxcclxuICAgICAgYmVuZGluZ0xpZ2h0TW9kZWwubWVkaXVtQ29sb3JGYWN0b3J5XHJcbiAgICApO1xyXG4gICAgdGhpcy53aGl0ZUxpZ2h0Tm9kZS5zZXRFeGNsdWRlSW52aXNpYmxlKCB0cnVlICk7XHJcblxyXG4gICAgLy8gU2luY2UgdGhlIGxpZ2h0IGNhbnZhcyBpcyBvcGFxdWUsIGl0IG11c3QgYmUgcGxhY2VkIGJlaGluZCB0aGUgY29udHJvbCBwYW5lbHMuXHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLndoaXRlTGlnaHROb2RlICk7XHJcblxyXG4gICAgLy8gc3dpdGNoIGJldHdlZW4gbGlnaHQgcmVuZGVyIGZvciB3aGl0ZSB2cyBub253aGl0ZSBsaWdodFxyXG4gICAgYmVuZGluZ0xpZ2h0TW9kZWwubGFzZXIuY29sb3JNb2RlUHJvcGVydHkubGluayggY29sb3IgPT4ge1xyXG4gICAgICB0aGlzLndoaXRlTGlnaHROb2RlICYmIHRoaXMud2hpdGVMaWdodE5vZGUuc2V0VmlzaWJsZSggY29sb3IgPT09IENvbG9yTW9kZUVudW0uV0hJVEUgKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBvdmVycmlkZSBhZGRMYXNlckhhbmRsZXMoIHNob3dSb3RhdGlvbkRyYWdIYW5kbGVzUHJvcGVydHk6IFByb3BlcnR5PGJvb2xlYW4+LCBzaG93VHJhbnNsYXRpb25EcmFnSGFuZGxlc1Byb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9ja3dpc2VBcnJvd05vdEF0TWF4OiAoIG46IG51bWJlciApID0+IGJvb2xlYW4sIGNjd0Fycm93Tm90QXRNYXg6ICggbjogbnVtYmVyICkgPT4gYm9vbGVhbiwgbGFzZXJJbWFnZVdpZHRoOiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBjb25zdCBiZW5kaW5nTGlnaHRNb2RlbCA9IHRoaXMuYmVuZGluZ0xpZ2h0TW9kZWw7XHJcbiAgICBzdXBlci5hZGRMYXNlckhhbmRsZXMoXHJcbiAgICAgIHNob3dSb3RhdGlvbkRyYWdIYW5kbGVzUHJvcGVydHksXHJcbiAgICAgIHNob3dUcmFuc2xhdGlvbkRyYWdIYW5kbGVzUHJvcGVydHksXHJcbiAgICAgIGNsb2Nrd2lzZUFycm93Tm90QXRNYXgsXHJcbiAgICAgIGNjd0Fycm93Tm90QXRNYXgsXHJcbiAgICAgIGxhc2VySW1hZ2VXaWR0aFxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBhZGQgdHJhbnNsYXRpb24gaW5kaWNhdG9ycyB0aGF0IHNob3cgaWYvd2hlbiB0aGUgbGFzZXIgY2FuIGJlIG1vdmVkIGJ5IGRyYWdnaW5nXHJcbiAgICBjb25zdCBhcnJvd0xlbmd0aCA9IDgzO1xyXG5cclxuICAgIGNvbnN0IGhvcml6b250YWxUcmFuc2xhdGlvbkRyYWdIYW5kbGUgPSBuZXcgVHJhbnNsYXRpb25EcmFnSGFuZGxlKFxyXG4gICAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSxcclxuICAgICAgYmVuZGluZ0xpZ2h0TW9kZWwubGFzZXIsXHJcbiAgICAgIGFycm93TGVuZ3RoLFxyXG4gICAgICAwLFxyXG4gICAgICBzaG93VHJhbnNsYXRpb25EcmFnSGFuZGxlc1Byb3BlcnR5LFxyXG4gICAgICBsYXNlckltYWdlV2lkdGhcclxuICAgICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBob3Jpem9udGFsVHJhbnNsYXRpb25EcmFnSGFuZGxlICk7XHJcblxyXG4gICAgY29uc3QgdmVydGljYWxUcmFuc2xhdGlvbkRyYWdIYW5kbGUgPSBuZXcgVHJhbnNsYXRpb25EcmFnSGFuZGxlKFxyXG4gICAgICB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybSxcclxuICAgICAgYmVuZGluZ0xpZ2h0TW9kZWwubGFzZXIsXHJcbiAgICAgIDAsXHJcbiAgICAgIGFycm93TGVuZ3RoLFxyXG4gICAgICBzaG93VHJhbnNsYXRpb25EcmFnSGFuZGxlc1Byb3BlcnR5LFxyXG4gICAgICBsYXNlckltYWdlV2lkdGhcclxuICAgICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB2ZXJ0aWNhbFRyYW5zbGF0aW9uRHJhZ0hhbmRsZSApO1xyXG4gIH1cclxufVxyXG5cclxuYmVuZGluZ0xpZ2h0LnJlZ2lzdGVyKCAnUHJpc21zU2NyZWVuVmlldycsIFByaXNtc1NjcmVlblZpZXcgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IFByaXNtc1NjcmVlblZpZXc7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsT0FBT0EsUUFBUSxNQUFNLGlDQUFpQztBQUN0RCxPQUFPQyxLQUFLLE1BQU0sbUNBQW1DO0FBQ3JELE9BQU9DLGNBQWMsTUFBTSx1REFBdUQ7QUFDbEYsT0FBT0MsY0FBYyxNQUFNLCtDQUErQztBQUMxRSxTQUFTQyxZQUFZLEVBQUVDLElBQUksRUFBRUMsU0FBUyxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQ3ZGLE9BQU9DLEtBQUssTUFBTSw2QkFBNkI7QUFDL0MsT0FBT0MsWUFBWSxNQUFNLHVCQUF1QjtBQUNoRCxPQUFPQyxtQkFBbUIsTUFBTSw4QkFBOEI7QUFDOUQsT0FBT0Msc0JBQXNCLE1BQXlDLDZDQUE2QztBQUNuSCxPQUFPQyxjQUFjLE1BQU0scUNBQXFDO0FBQ2hFLE9BQU9DLGtCQUFrQixNQUFNLHlDQUF5QztBQUN4RSxPQUFPQyxxQkFBcUIsTUFBTSw0Q0FBNEM7QUFDOUUsT0FBT0MsaUJBQWlCLE1BQU0sd0NBQXdDO0FBR3RFLE9BQU9DLGdCQUFnQixNQUFNLHVCQUF1QjtBQUNwRCxPQUFPQyx5QkFBeUIsTUFBTSxnQ0FBZ0M7QUFDdEUsT0FBT0MsZ0JBQWdCLE1BQU0sdUJBQXVCO0FB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