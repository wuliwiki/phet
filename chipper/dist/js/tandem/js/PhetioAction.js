// Copyright 2022-2023, University of Colorado Boulder

/**
 * An instrumented class that wraps a function that does "work" that needs to be interoperable with PhET-iO.
 * PhetioAction supports the following features:
 *
 * 1. Data stream support: The function will be wrapped in an `executed` event and added to the data stream, nesting
 * subsequent events the action's "work" cascades to as child events.
 * 2. Interopererability: PhetioActionIO supports the `execute` method so that PhetioAction instances can be executed
 * from the PhET-iO wrapper.
 * 3. It also has an emitter if you want to listen to when the action is done doing its work, https://github.com/phetsims/phet-io/issues/1543
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import tandemNamespace from './tandemNamespace.js';
import IOType from './types/IOType.js';
import optionize from '../../phet-core/js/optionize.js';
import Tandem from './Tandem.js';
import VoidIO from './types/VoidIO.js';
import PhetioDataHandler from './PhetioDataHandler.js';
import Emitter from '../../axon/js/Emitter.js';
import PhetioObject from './PhetioObject.js';
const EMPTY_ARRAY = [];

// By default, PhetioActions are not stateful
const PHET_IO_STATE_DEFAULT = false;

// undefined and never are not allowed as parameters to PhetioAction

class PhetioAction extends PhetioDataHandler {
  // Keep track of it this instance is currently executing its action, see execute() for implementation. This needs to
  // be a stack because reentrant PhetioAction execute calls are supported.
  // Disposal can potentially occur from the action that is being executed. If this is the case, we still want to emit
  // the executedEmitter upon completion of the action, so defer disposal of the executedEmitter (and
  // disposePhetioAction in general), until the execute() function is complete. This doesn't need to be a stack because
  // we do not allow reentrant PhetioActions (guarded with an assertion in execute()).
  // Called upon disposal of PhetioAction, but if dispose() is called while the action is executing, defer calling this
  // function until the execute() function is complete.
  // To listen to when the action has completed.
  static PhetioActionIO = parameterTypes => {
    const key = parameterTypes.map(getTypeName).join(',');
    if (!cache.has(key)) {
      cache.set(key, new IOType(`PhetioActionIO<${parameterTypes.map(getTypeName).join(', ')}>`, {
        valueType: PhetioAction,
        documentation: 'Executes when an event occurs',
        events: ['executed'],
        parameterTypes: parameterTypes,
        metadataDefaults: {
          phetioState: PHET_IO_STATE_DEFAULT
        },
        methods: {
          execute: {
            returnType: VoidIO,
            parameterTypes: parameterTypes,
            implementation: function (...values) {
              const errors = this.getValidationErrors(...values);
              if (errors.length > 0) {
                throw new Error(`Validation errors: ${errors.join(', ')}`);
              } else {
                this.execute(...values);
              }
            },
            documentation: 'Executes the function the PhetioAction is wrapping.',
            invocableForReadOnlyElements: false
          }
        }
      }));
    }
    return cache.get(key);
  };

  /**
   * @param action - the function that is called when this PhetioAction occurs
   * @param providedOptions
   */
  constructor(action, providedOptions) {
    const options = optionize()({
      // We need to define this here in addition to PhetioDataHandler to pass to executedEmitter
      parameters: EMPTY_ARRAY,
      // PhetioDataHandler
      phetioOuterType: PhetioAction.PhetioActionIO,
      // PhetioObject
      tandem: Tandem.OPTIONAL,
      phetioState: PHET_IO_STATE_DEFAULT,
      phetioReadOnly: PhetioObject.DEFAULT_OPTIONS.phetioReadOnly,
      phetioHighFrequency: PhetioObject.DEFAULT_OPTIONS.phetioHighFrequency,
      phetioEventType: PhetioObject.DEFAULT_OPTIONS.phetioEventType,
      phetioDocumentation: 'A class that wraps a function, adding API to execute that function and data stream capture.'
    }, providedOptions);
    super(options);
    this.action = action;
    this.isExecutingCount = 0;
    this.disposeOnExecuteCompletion = false;
    this.executedEmitter = new Emitter({
      parameters: options.parameters,
      tandem: options.tandem.createTandem('executedEmitter'),
      hasListenerOrderDependencies: options.hasListenerOrderDependencies,
      phetioState: options.phetioState,
      phetioReadOnly: options.phetioReadOnly,
      phetioHighFrequency: options.phetioHighFrequency,
      phetioEventType: options.phetioEventType,
      phetioDocumentation: 'Emitter that emits when this actions work is complete'
    });
    this.disposePhetioAction = () => {
      this.executedEmitter.dispose();
    };
  }

  /**
   * Invokes the action.
   * @params - expected parameters are based on options.parameters, see constructor
   */
  execute(...args) {
    assert && assert(!this.isDisposed, 'should not be called if disposed');

    // We delay the disposal of composed entities to handle reentrant cases of disposing ourself.
    assert && assert(!this.executedEmitter.isDisposed, 'self should not be disposed');
    this.isExecutingCount++;
    assert && super.validateArguments(...args);

    // Although this is not the idiomatic pattern (since it is guarded in the phetioStartEvent), this function is
    // called so many times that it is worth the optimization for PhET brand.
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioStartEvent('executed', {
      data: this.getPhetioData(...args)
    });
    this.action.apply(null, args);
    this.executedEmitter.emit(...args);
    Tandem.PHET_IO_ENABLED && this.isPhetioInstrumented() && this.phetioEndEvent();
    this.isExecutingCount--;
    if (this.disposeOnExecuteCompletion && this.isExecutingCount === 0) {
      this.disposePhetioAction();
      this.disposeOnExecuteCompletion = false;
    }
  }

  /**
   * Note: Be careful about adding disposal logic directly to this function, it is likely preferred to add it to
   * disposePhetioAction instead, see disposeOnExecuteCompletion for details.
   */
  dispose() {
    if (this.isExecutingCount > 0) {
      // Defer disposing components until executing is completed, see disposeOnExecuteCompletion.
      this.disposeOnExecuteCompletion = true;
    } else {
      this.disposePhetioAction();
    }

    // Always dispose the object itself, or PhetioObject will assert out.
    super.dispose();
  }
}
const getTypeName = ioType => ioType.typeName;

// cache each parameterized IOType so that it is only created once.
const cache = new Map();
tandemNamespace.register('PhetioAction', PhetioAction);
export default PhetioAction;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0YW5kZW1OYW1lc3BhY2UiLCJJT1R5cGUiLCJvcHRpb25pemUiLCJUYW5kZW0iLCJWb2lkSU8iLCJQaGV0aW9EYXRhSGFuZGxlciIsIkVtaXR0ZXIiLCJQaGV0aW9PYmplY3QiLCJFTVBUWV9BUlJBWSIsIlBIRVRfSU9fU1RBVEVfREVGQVVMVCIsIlBoZXRpb0FjdGlvbiIsIlBoZXRpb0FjdGlvbklPIiwicGFyYW1ldGVyVHlwZXMiLCJrZXkiLCJtYXAiLCJnZXRUeXBlTmFtZSIsImpvaW4iLCJjYWNoZSIsImhhcyIsInNldCIsInZhbHVlVHlwZSIsImRvY3VtZW50YXRpb24iLCJldmVudHMiLCJtZXRhZGF0YURlZmF1bHRzIiwicGhldGlvU3RhdGUiLCJtZXRob2RzIiwiZXhlY3V0ZSIsInJldHVyblR5cGUiLCJpbXBsZW1lbnRhdGlvbiIsInZhbHVlcyIsImVycm9ycyIsImdldFZhbGlkYXRpb25FcnJvcnMiLCJsZW5ndGgiLCJFcnJvciIsImludm9jYWJsZUZvclJlYWRPbmx5RWxlbWVudHMiLCJnZXQiLCJjb25zdHJ1Y3RvciIsImFjdGlvbiIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJwYXJhbWV0ZXJzIiwicGhldGlvT3V0ZXJUeXBlIiwidGFuZGVtIiwiT1BUSU9OQUwiLCJwaGV0aW9SZWFkT25seSIsIkRFRkFVTFRfT1BUSU9OUyIsInBoZXRpb0hpZ2hGcmVxdWVuY3kiLCJwaGV0aW9FdmVudFR5cGUiLCJwaGV0aW9Eb2N1bWVudGF0aW9uIiwiaXNFeGVjdXRpbmdDb3VudCIsImRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uIiwiZXhlY3V0ZWRFbWl0dGVyIiwiY3JlYXRlVGFuZGVtIiwiaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llcyIsImRpc3Bvc2VQaGV0aW9BY3Rpb24iLCJkaXNwb3NlIiwiYXJncyIsImFzc2VydCIsImlzRGlzcG9zZWQiLCJ2YWxpZGF0ZUFyZ3VtZW50cyIsIlBIRVRfSU9fRU5BQkxFRCIsImlzUGhldGlvSW5zdHJ1bWVudGVkIiwicGhldGlvU3RhcnRFdmVudCIsImRhdGEiLCJnZXRQaGV0aW9EYXRhIiwiYXBwbHkiLCJlbWl0IiwicGhldGlvRW5kRXZlbnQiLCJpb1R5cGUiLCJ0eXBlTmFtZSIsIk1hcCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUGhldGlvQWN0aW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEFuIGluc3RydW1lbnRlZCBjbGFzcyB0aGF0IHdyYXBzIGEgZnVuY3Rpb24gdGhhdCBkb2VzIFwid29ya1wiIHRoYXQgbmVlZHMgdG8gYmUgaW50ZXJvcGVyYWJsZSB3aXRoIFBoRVQtaU8uXHJcbiAqIFBoZXRpb0FjdGlvbiBzdXBwb3J0cyB0aGUgZm9sbG93aW5nIGZlYXR1cmVzOlxyXG4gKlxyXG4gKiAxLiBEYXRhIHN0cmVhbSBzdXBwb3J0OiBUaGUgZnVuY3Rpb24gd2lsbCBiZSB3cmFwcGVkIGluIGFuIGBleGVjdXRlZGAgZXZlbnQgYW5kIGFkZGVkIHRvIHRoZSBkYXRhIHN0cmVhbSwgbmVzdGluZ1xyXG4gKiBzdWJzZXF1ZW50IGV2ZW50cyB0aGUgYWN0aW9uJ3MgXCJ3b3JrXCIgY2FzY2FkZXMgdG8gYXMgY2hpbGQgZXZlbnRzLlxyXG4gKiAyLiBJbnRlcm9wZXJlcmFiaWxpdHk6IFBoZXRpb0FjdGlvbklPIHN1cHBvcnRzIHRoZSBgZXhlY3V0ZWAgbWV0aG9kIHNvIHRoYXQgUGhldGlvQWN0aW9uIGluc3RhbmNlcyBjYW4gYmUgZXhlY3V0ZWRcclxuICogZnJvbSB0aGUgUGhFVC1pTyB3cmFwcGVyLlxyXG4gKiAzLiBJdCBhbHNvIGhhcyBhbiBlbWl0dGVyIGlmIHlvdSB3YW50IHRvIGxpc3RlbiB0byB3aGVuIHRoZSBhY3Rpb24gaXMgZG9uZSBkb2luZyBpdHMgd29yaywgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3BoZXQtaW8vaXNzdWVzLzE1NDNcclxuICpcclxuICogQGF1dGhvciBNaWNoYWVsIEthdXptYW5uIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCB0YW5kZW1OYW1lc3BhY2UgZnJvbSAnLi90YW5kZW1OYW1lc3BhY2UuanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4vdHlwZXMvSU9UeXBlLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi9UYW5kZW0uanMnO1xyXG5pbXBvcnQgVm9pZElPIGZyb20gJy4vdHlwZXMvVm9pZElPLmpzJztcclxuaW1wb3J0IFBoZXRpb0RhdGFIYW5kbGVyLCB7IFBhcmFtZXRlciwgUGhldGlvRGF0YUhhbmRsZXJPcHRpb25zIH0gZnJvbSAnLi9QaGV0aW9EYXRhSGFuZGxlci5qcyc7XHJcbmltcG9ydCBJbnRlbnRpb25hbEFueSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvSW50ZW50aW9uYWxBbnkuanMnO1xyXG5pbXBvcnQgRW1pdHRlciBmcm9tICcuLi8uLi9heG9uL2pzL0VtaXR0ZXIuanMnO1xyXG5pbXBvcnQgUGhldGlvT2JqZWN0IGZyb20gJy4vUGhldGlvT2JqZWN0LmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5cclxuXHJcbmNvbnN0IEVNUFRZX0FSUkFZOiBQYXJhbWV0ZXJbXSA9IFtdO1xyXG5cclxuLy8gQnkgZGVmYXVsdCwgUGhldGlvQWN0aW9ucyBhcmUgbm90IHN0YXRlZnVsXHJcbmNvbnN0IFBIRVRfSU9fU1RBVEVfREVGQVVMVCA9IGZhbHNlO1xyXG5cclxuLy8gdW5kZWZpbmVkIGFuZCBuZXZlciBhcmUgbm90IGFsbG93ZWQgYXMgcGFyYW1ldGVycyB0byBQaGV0aW9BY3Rpb25cclxudHlwZSBBY3Rpb25QYXJhbWV0ZXIgPSBFeGNsdWRlPEludGVudGlvbmFsQW55LCB1bmRlZmluZWQgfCBuZXZlcj47XHJcblxyXG5leHBvcnQgdHlwZSBBY3Rpb25PcHRpb25zID0gU3RyaWN0T21pdDxQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnMsICdwaGV0aW9PdXRlclR5cGUnPjtcclxuXHJcbmNsYXNzIFBoZXRpb0FjdGlvbjxUIGV4dGVuZHMgQWN0aW9uUGFyYW1ldGVyW10gPSBbXT4gZXh0ZW5kcyBQaGV0aW9EYXRhSGFuZGxlcjxUPiB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgYWN0aW9uOiAoIC4uLmFyZ3M6IFQgKSA9PiB2b2lkO1xyXG5cclxuICAvLyBLZWVwIHRyYWNrIG9mIGl0IHRoaXMgaW5zdGFuY2UgaXMgY3VycmVudGx5IGV4ZWN1dGluZyBpdHMgYWN0aW9uLCBzZWUgZXhlY3V0ZSgpIGZvciBpbXBsZW1lbnRhdGlvbi4gVGhpcyBuZWVkcyB0b1xyXG4gIC8vIGJlIGEgc3RhY2sgYmVjYXVzZSByZWVudHJhbnQgUGhldGlvQWN0aW9uIGV4ZWN1dGUgY2FsbHMgYXJlIHN1cHBvcnRlZC5cclxuICBwcml2YXRlIGlzRXhlY3V0aW5nQ291bnQ6IG51bWJlcjtcclxuXHJcbiAgLy8gRGlzcG9zYWwgY2FuIHBvdGVudGlhbGx5IG9jY3VyIGZyb20gdGhlIGFjdGlvbiB0aGF0IGlzIGJlaW5nIGV4ZWN1dGVkLiBJZiB0aGlzIGlzIHRoZSBjYXNlLCB3ZSBzdGlsbCB3YW50IHRvIGVtaXRcclxuICAvLyB0aGUgZXhlY3V0ZWRFbWl0dGVyIHVwb24gY29tcGxldGlvbiBvZiB0aGUgYWN0aW9uLCBzbyBkZWZlciBkaXNwb3NhbCBvZiB0aGUgZXhlY3V0ZWRFbWl0dGVyIChhbmRcclxuICAvLyBkaXNwb3NlUGhldGlvQWN0aW9uIGluIGdlbmVyYWwpLCB1bnRpbCB0aGUgZXhlY3V0ZSgpIGZ1bmN0aW9uIGlzIGNvbXBsZXRlLiBUaGlzIGRvZXNuJ3QgbmVlZCB0byBiZSBhIHN0YWNrIGJlY2F1c2VcclxuICAvLyB3ZSBkbyBub3QgYWxsb3cgcmVlbnRyYW50IFBoZXRpb0FjdGlvbnMgKGd1YXJkZWQgd2l0aCBhbiBhc3NlcnRpb24gaW4gZXhlY3V0ZSgpKS5cclxuICBwcml2YXRlIGRpc3Bvc2VPbkV4ZWN1dGVDb21wbGV0aW9uOiBib29sZWFuO1xyXG5cclxuICAvLyBDYWxsZWQgdXBvbiBkaXNwb3NhbCBvZiBQaGV0aW9BY3Rpb24sIGJ1dCBpZiBkaXNwb3NlKCkgaXMgY2FsbGVkIHdoaWxlIHRoZSBhY3Rpb24gaXMgZXhlY3V0aW5nLCBkZWZlciBjYWxsaW5nIHRoaXNcclxuICAvLyBmdW5jdGlvbiB1bnRpbCB0aGUgZXhlY3V0ZSgpIGZ1bmN0aW9uIGlzIGNvbXBsZXRlLlxyXG4gIHByaXZhdGUgZGlzcG9zZVBoZXRpb0FjdGlvbjogKCkgPT4gdm9pZDtcclxuXHJcbiAgLy8gVG8gbGlzdGVuIHRvIHdoZW4gdGhlIGFjdGlvbiBoYXMgY29tcGxldGVkLlxyXG4gIHB1YmxpYyByZWFkb25seSBleGVjdXRlZEVtaXR0ZXI6IEVtaXR0ZXI8VD47XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUGhldGlvQWN0aW9uSU8gPSAoIHBhcmFtZXRlclR5cGVzOiBJT1R5cGVbXSApOiBJT1R5cGUgPT4ge1xyXG4gICAgY29uc3Qga2V5ID0gcGFyYW1ldGVyVHlwZXMubWFwKCBnZXRUeXBlTmFtZSApLmpvaW4oICcsJyApO1xyXG4gICAgaWYgKCAhY2FjaGUuaGFzKCBrZXkgKSApIHtcclxuICAgICAgY2FjaGUuc2V0KCBrZXksIG5ldyBJT1R5cGUoIGBQaGV0aW9BY3Rpb25JTzwke3BhcmFtZXRlclR5cGVzLm1hcCggZ2V0VHlwZU5hbWUgKS5qb2luKCAnLCAnICl9PmAsIHtcclxuICAgICAgICB2YWx1ZVR5cGU6IFBoZXRpb0FjdGlvbixcclxuICAgICAgICBkb2N1bWVudGF0aW9uOiAnRXhlY3V0ZXMgd2hlbiBhbiBldmVudCBvY2N1cnMnLFxyXG4gICAgICAgIGV2ZW50czogWyAnZXhlY3V0ZWQnIF0sXHJcbiAgICAgICAgcGFyYW1ldGVyVHlwZXM6IHBhcmFtZXRlclR5cGVzLFxyXG4gICAgICAgIG1ldGFkYXRhRGVmYXVsdHM6IHtcclxuICAgICAgICAgIHBoZXRpb1N0YXRlOiBQSEVUX0lPX1NUQVRFX0RFRkFVTFRcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ldGhvZHM6IHtcclxuICAgICAgICAgIGV4ZWN1dGU6IHtcclxuICAgICAgICAgICAgcmV0dXJuVHlwZTogVm9pZElPLFxyXG4gICAgICAgICAgICBwYXJhbWV0ZXJUeXBlczogcGFyYW1ldGVyVHlwZXMsXHJcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogUGhldGlvQWN0aW9uPHVua25vd25bXT4sIC4uLnZhbHVlczogdW5rbm93bltdICkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGVycm9ycyA9IHRoaXMuZ2V0VmFsaWRhdGlvbkVycm9ycyggLi4udmFsdWVzICk7XHJcblxyXG4gICAgICAgICAgICAgIGlmICggZXJyb3JzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIGBWYWxpZGF0aW9uIGVycm9yczogJHtlcnJvcnMuam9pbiggJywgJyApfWAgKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGUoIC4uLnZhbHVlcyApO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZG9jdW1lbnRhdGlvbjogJ0V4ZWN1dGVzIHRoZSBmdW5jdGlvbiB0aGUgUGhldGlvQWN0aW9uIGlzIHdyYXBwaW5nLicsXHJcbiAgICAgICAgICAgIGludm9jYWJsZUZvclJlYWRPbmx5RWxlbWVudHM6IGZhbHNlXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9ICkgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjYWNoZS5nZXQoIGtleSApITtcclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gYWN0aW9uIC0gdGhlIGZ1bmN0aW9uIHRoYXQgaXMgY2FsbGVkIHdoZW4gdGhpcyBQaGV0aW9BY3Rpb24gb2NjdXJzXHJcbiAgICogQHBhcmFtIHByb3ZpZGVkT3B0aW9uc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggYWN0aW9uOiAoIC4uLmFyZ3M6IFQgKSA9PiB2b2lkLCBwcm92aWRlZE9wdGlvbnM/OiBBY3Rpb25PcHRpb25zICkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxBY3Rpb25PcHRpb25zLCBFbXB0eVNlbGZPcHRpb25zLCBQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFdlIG5lZWQgdG8gZGVmaW5lIHRoaXMgaGVyZSBpbiBhZGRpdGlvbiB0byBQaGV0aW9EYXRhSGFuZGxlciB0byBwYXNzIHRvIGV4ZWN1dGVkRW1pdHRlclxyXG4gICAgICBwYXJhbWV0ZXJzOiBFTVBUWV9BUlJBWSxcclxuXHJcbiAgICAgIC8vIFBoZXRpb0RhdGFIYW5kbGVyXHJcbiAgICAgIHBoZXRpb091dGVyVHlwZTogUGhldGlvQWN0aW9uLlBoZXRpb0FjdGlvbklPLFxyXG5cclxuICAgICAgLy8gUGhldGlvT2JqZWN0XHJcbiAgICAgIHRhbmRlbTogVGFuZGVtLk9QVElPTkFMLFxyXG4gICAgICBwaGV0aW9TdGF0ZTogUEhFVF9JT19TVEFURV9ERUZBVUxULFxyXG4gICAgICBwaGV0aW9SZWFkT25seTogUGhldGlvT2JqZWN0LkRFRkFVTFRfT1BUSU9OUy5waGV0aW9SZWFkT25seSxcclxuICAgICAgcGhldGlvSGlnaEZyZXF1ZW5jeTogUGhldGlvT2JqZWN0LkRFRkFVTFRfT1BUSU9OUy5waGV0aW9IaWdoRnJlcXVlbmN5LFxyXG4gICAgICBwaGV0aW9FdmVudFR5cGU6IFBoZXRpb09iamVjdC5ERUZBVUxUX09QVElPTlMucGhldGlvRXZlbnRUeXBlLFxyXG4gICAgICBwaGV0aW9Eb2N1bWVudGF0aW9uOiAnQSBjbGFzcyB0aGF0IHdyYXBzIGEgZnVuY3Rpb24sIGFkZGluZyBBUEkgdG8gZXhlY3V0ZSB0aGF0IGZ1bmN0aW9uIGFuZCBkYXRhIHN0cmVhbSBjYXB0dXJlLidcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5hY3Rpb24gPSBhY3Rpb247XHJcblxyXG4gICAgdGhpcy5pc0V4ZWN1dGluZ0NvdW50ID0gMDtcclxuICAgIHRoaXMuZGlzcG9zZU9uRXhlY3V0ZUNvbXBsZXRpb24gPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLmV4ZWN1dGVkRW1pdHRlciA9IG5ldyBFbWl0dGVyPFQ+KCB7XHJcbiAgICAgIHBhcmFtZXRlcnM6IG9wdGlvbnMucGFyYW1ldGVycyxcclxuICAgICAgdGFuZGVtOiBvcHRpb25zLnRhbmRlbS5jcmVhdGVUYW5kZW0oICdleGVjdXRlZEVtaXR0ZXInICksXHJcbiAgICAgIGhhc0xpc3RlbmVyT3JkZXJEZXBlbmRlbmNpZXM6IG9wdGlvbnMuaGFzTGlzdGVuZXJPcmRlckRlcGVuZGVuY2llcyxcclxuICAgICAgcGhldGlvU3RhdGU6IG9wdGlvbnMucGhldGlvU3RhdGUsXHJcbiAgICAgIHBoZXRpb1JlYWRPbmx5OiBvcHRpb25zLnBoZXRpb1JlYWRPbmx5LFxyXG4gICAgICBwaGV0aW9IaWdoRnJlcXVlbmN5OiBvcHRpb25zLnBoZXRpb0hpZ2hGcmVxdWVuY3ksXHJcbiAgICAgIHBoZXRpb0V2ZW50VHlwZTogb3B0aW9ucy5waGV0aW9FdmVudFR5cGUsXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICdFbWl0dGVyIHRoYXQgZW1pdHMgd2hlbiB0aGlzIGFjdGlvbnMgd29yayBpcyBjb21wbGV0ZSdcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VQaGV0aW9BY3Rpb24gPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMuZXhlY3V0ZWRFbWl0dGVyLmRpc3Bvc2UoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbnZva2VzIHRoZSBhY3Rpb24uXHJcbiAgICogQHBhcmFtcyAtIGV4cGVjdGVkIHBhcmFtZXRlcnMgYXJlIGJhc2VkIG9uIG9wdGlvbnMucGFyYW1ldGVycywgc2VlIGNvbnN0cnVjdG9yXHJcbiAgICovXHJcbiAgcHVibGljIGV4ZWN1dGUoIC4uLmFyZ3M6IFQgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhdGhpcy5pc0Rpc3Bvc2VkLCAnc2hvdWxkIG5vdCBiZSBjYWxsZWQgaWYgZGlzcG9zZWQnICk7XHJcblxyXG4gICAgLy8gV2UgZGVsYXkgdGhlIGRpc3Bvc2FsIG9mIGNvbXBvc2VkIGVudGl0aWVzIHRvIGhhbmRsZSByZWVudHJhbnQgY2FzZXMgb2YgZGlzcG9zaW5nIG91cnNlbGYuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhdGhpcy5leGVjdXRlZEVtaXR0ZXIuaXNEaXNwb3NlZCwgJ3NlbGYgc2hvdWxkIG5vdCBiZSBkaXNwb3NlZCcgKTtcclxuXHJcbiAgICB0aGlzLmlzRXhlY3V0aW5nQ291bnQrKztcclxuXHJcbiAgICBhc3NlcnQgJiYgc3VwZXIudmFsaWRhdGVBcmd1bWVudHMoIC4uLmFyZ3MgKTtcclxuXHJcbiAgICAvLyBBbHRob3VnaCB0aGlzIGlzIG5vdCB0aGUgaWRpb21hdGljIHBhdHRlcm4gKHNpbmNlIGl0IGlzIGd1YXJkZWQgaW4gdGhlIHBoZXRpb1N0YXJ0RXZlbnQpLCB0aGlzIGZ1bmN0aW9uIGlzXHJcbiAgICAvLyBjYWxsZWQgc28gbWFueSB0aW1lcyB0aGF0IGl0IGlzIHdvcnRoIHRoZSBvcHRpbWl6YXRpb24gZm9yIFBoRVQgYnJhbmQuXHJcbiAgICBUYW5kZW0uUEhFVF9JT19FTkFCTEVEICYmIHRoaXMuaXNQaGV0aW9JbnN0cnVtZW50ZWQoKSAmJiB0aGlzLnBoZXRpb1N0YXJ0RXZlbnQoICdleGVjdXRlZCcsIHtcclxuICAgICAgZGF0YTogdGhpcy5nZXRQaGV0aW9EYXRhKCAuLi5hcmdzIClcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLmFjdGlvbi5hcHBseSggbnVsbCwgYXJncyApO1xyXG4gICAgdGhpcy5leGVjdXRlZEVtaXR0ZXIuZW1pdCggLi4uYXJncyApO1xyXG5cclxuICAgIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQgJiYgdGhpcy5pc1BoZXRpb0luc3RydW1lbnRlZCgpICYmIHRoaXMucGhldGlvRW5kRXZlbnQoKTtcclxuXHJcbiAgICB0aGlzLmlzRXhlY3V0aW5nQ291bnQtLTtcclxuXHJcbiAgICBpZiAoIHRoaXMuZGlzcG9zZU9uRXhlY3V0ZUNvbXBsZXRpb24gJiYgdGhpcy5pc0V4ZWN1dGluZ0NvdW50ID09PSAwICkge1xyXG4gICAgICB0aGlzLmRpc3Bvc2VQaGV0aW9BY3Rpb24oKTtcclxuICAgICAgdGhpcy5kaXNwb3NlT25FeGVjdXRlQ29tcGxldGlvbiA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTm90ZTogQmUgY2FyZWZ1bCBhYm91dCBhZGRpbmcgZGlzcG9zYWwgbG9naWMgZGlyZWN0bHkgdG8gdGhpcyBmdW5jdGlvbiwgaXQgaXMgbGlrZWx5IHByZWZlcnJlZCB0byBhZGQgaXQgdG9cclxuICAgKiBkaXNwb3NlUGhldGlvQWN0aW9uIGluc3RlYWQsIHNlZSBkaXNwb3NlT25FeGVjdXRlQ29tcGxldGlvbiBmb3IgZGV0YWlscy5cclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGlmICggdGhpcy5pc0V4ZWN1dGluZ0NvdW50ID4gMCApIHtcclxuXHJcbiAgICAgIC8vIERlZmVyIGRpc3Bvc2luZyBjb21wb25lbnRzIHVudGlsIGV4ZWN1dGluZyBpcyBjb21wbGV0ZWQsIHNlZSBkaXNwb3NlT25FeGVjdXRlQ29tcGxldGlvbi5cclxuICAgICAgdGhpcy5kaXNwb3NlT25FeGVjdXRlQ29tcGxldGlvbiA9IHRydWU7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgdGhpcy5kaXNwb3NlUGhldGlvQWN0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWx3YXlzIGRpc3Bvc2UgdGhlIG9iamVjdCBpdHNlbGYsIG9yIFBoZXRpb09iamVjdCB3aWxsIGFzc2VydCBvdXQuXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBnZXRUeXBlTmFtZSA9ICggaW9UeXBlOiBJT1R5cGUgKSA9PiBpb1R5cGUudHlwZU5hbWU7XHJcblxyXG4vLyBjYWNoZSBlYWNoIHBhcmFtZXRlcml6ZWQgSU9UeXBlIHNvIHRoYXQgaXQgaXMgb25seSBjcmVhdGVkIG9uY2UuXHJcbmNvbnN0IGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIElPVHlwZT4oKTtcclxuXHJcbnRhbmRlbU5hbWVzcGFjZS5yZWdpc3RlciggJ1BoZXRpb0FjdGlvbicsIFBoZXRpb0FjdGlvbiApO1xyXG5leHBvcnQgZGVmYXVsdCBQaGV0aW9BY3Rpb247Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHNCQUFzQjtBQUNsRCxPQUFPQyxNQUFNLE1BQU0sbUJBQW1CO0FBQ3RDLE9BQU9DLFNBQVMsTUFBNEIsaUNBQWlDO0FBQzdFLE9BQU9DLE1BQU0sTUFBTSxhQUFhO0FBQ2hDLE9BQU9DLE1BQU0sTUFBTSxtQkFBbUI7QUFDdEMsT0FBT0MsaUJBQWlCLE1BQStDLHdCQUF3QjtBQUUvRixPQUFPQyxPQUFPLE1BQU0sMEJBQTBCO0FBQzlDLE9BQU9DLFlBQVksTUFBTSxtQkFBbUI7QUFJNUMsTUFBTUMsV0FBd0IsR0FBRyxFQUFFOztBQUVuQztBQUNBLE1BQU1DLHFCQUFxQixHQUFHLEtBQUs7O0FBRW5DOztBQUtBLE1BQU1DLFlBQVksU0FB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