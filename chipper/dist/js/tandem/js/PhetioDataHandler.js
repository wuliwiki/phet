// Copyright 2022-2023, University of Colorado Boulder

/**
 * Helper type that supports a `parameters` member.
 * This is mostly useful for PhET-iO instrumented sub-class to use that takes a variable number of parameters in their
 * IOType. With this function you gain parameter validation, PhET-iO documentation, and data stream support.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import assertMutuallyExclusiveOptions from '../../phet-core/js/assertMutuallyExclusiveOptions.js';
import optionize from '../../phet-core/js/optionize.js';
import PhetioObject from './PhetioObject.js';
import Tandem from './Tandem.js';
import axon from '../../axon/js/axon.js';
import validate from '../../axon/js/validate.js';
import Validation from '../../axon/js/Validation.js';
const VALIDATE_OPTIONS_FALSE = {
  validateValidator: false
};
// Simulations have thousands of Emitters, so we re-use objects where possible.
const EMPTY_ARRAY = [];
assert && Object.freeze(EMPTY_ARRAY);

// allowed keys to options.parameters
const PARAMETER_KEYS = ['name',
// required for phet-io instrumented Actions
'phetioType',
// required for phet-io instrumented Actions
'phetioDocumentation',
// optional, additional documentation for this specific parameter

// specify this to keep the parameter private to the PhET-iO API. To support emitting and executing over
// the PhET-iO API, phetioPrivate parameters must not ever be before a public one. For example
// `emit1( public1, private1, public2)` is not allowed. Instead it must be ordered like `emit( public1, public2, private1 )`
'phetioPrivate'].concat(Validation.VALIDATOR_KEYS);

// helper closures
const paramToPhetioType = param => param.phetioType;
const paramToName = param => param.name;

// Use each subtype should provide its own phetioOuterType. That coupled with parameter IOTypes will result in the
// phetioType. Don't pass this in!
class PhetioDataHandler extends PhetioObject {
  constructor(providedOptions) {
    const options = optionize()({
      // see PARAMETER_KEYS for a list of legal keys, their types, and documentation
      parameters: EMPTY_ARRAY,
      hasListenerOrderDependencies: false,
      // phet-io - see PhetioObject.js for doc
      tandem: Tandem.OPTIONAL,
      phetioPlayback: PhetioObject.DEFAULT_OPTIONS.phetioPlayback,
      phetioEventMetadata: PhetioObject.DEFAULT_OPTIONS.phetioEventMetadata,
      phetioDocumentation: ''
    }, providedOptions);
    assert && PhetioDataHandler.validateParameters(options.parameters, options.tandem.supplied);
    assert && assert(options.phetioType === undefined, 'PhetioDataHandler sets its own phetioType. Instead provide parameter phetioTypes through `options.parameters` with a phetioOuterType');

    // list of parameters, see options.parameters. Filter out phetioPrivate parameters, all `phetioPrivate`
    // parameters will not have a `phetioType`, see `validateParameters`.
    const phetioPublicParameters = options.parameters.filter(paramToPhetioType);
    options.phetioType = options.phetioOuterType(phetioPublicParameters.map(paramToPhetioType));

    // phetioPlayback events need to know the order the arguments occur in order to call EmitterIO.emit()
    // Indicate whether the event is for playback, but leave this "sparse"--only indicate when this happens to be true
    if (options.phetioPlayback) {
      options.phetioEventMetadata = options.phetioEventMetadata || {}; // phetioEventMetadata defaults to null

      assert && assert(!options.phetioEventMetadata.hasOwnProperty('dataKeys'), 'dataKeys should be supplied by PhetioDataHandler, not elsewhere');
      options.phetioEventMetadata.dataKeys = options.parameters.map(paramToName);
    }
    options.phetioDocumentation = PhetioDataHandler.getPhetioDocumentation(options.phetioDocumentation, phetioPublicParameters);
    super(options);

    // Note: one test indicates stripping this out via assert && in builds may save around 300kb heap
    this.parameters = options.parameters;
  }

  /**
   * @param parameters
   * @param tandemSupplied - proxy for whether the PhetioObject is instrumented.  We cannot call
   *                                 - PhetioObject.isPhetioInstrumented() until after the supercall, so we use this beforehand.
   */
  static validateParameters(parameters, tandemSupplied) {
    // validate the parameters object
    validate(parameters, {
      valueType: Array
    });

    // PhetioDataHandler only supports phetioPrivate parameters at the end of the emit call, so once we hit the first phetioPrivate
    // parameter, then assert that the rest of them afterwards are as well.
    let reachedPhetioPrivate = false;

    // we must iterate from the first parameter to the last parameter to support phetioPrivate
    for (let i = 0; i < parameters.length; i++) {
      const parameter = parameters[i]; // metadata about a single parameter

      assert && assert(Object.getPrototypeOf(parameter) === Object.prototype, 'Extra prototype on parameter object is a code smell');
      reachedPhetioPrivate = reachedPhetioPrivate || parameter.phetioPrivate;
      assert && reachedPhetioPrivate && assert(parameter.phetioPrivate, 'after first phetioPrivate parameter, all subsequent parameters must be phetioPrivate');
      assert && tandemSupplied && Tandem.VALIDATION && assert(parameter.phetioType || parameter.phetioPrivate, 'instrumented Emitters must include phetioType for each parameter or be marked as `phetioPrivate`.');
      assert && parameter.phetioType && assert(parameter.name, '`name` is a required parameter for phet-io instrumented parameters.');
      assert && assertMutuallyExclusiveOptions(parameter, ['phetioPrivate'], ['name', 'phetioType', 'phetioDocumentation']);
      assert && assert(_.intersection(Object.keys(parameter), Validation.VALIDATOR_KEYS).length > 0, `validator must be specified for parameter ${i}`);
      for (const key in parameter) {
        assert && assert(PARAMETER_KEYS.includes(key), `unrecognized parameter key: ${key}`);
      }

      // Changing after construction indicates a logic error.
      assert && Object.freeze(parameters[i]);

      // validate the options passed in to validate each PhetioDataHandler argument
      Validation.validateValidator(parameter);
    }

    // Changing after construction indicates a logic error.
    assert && Object.freeze(parameters);
  }

  /**
   * Validate that provided args match the expected schema given via options.parameters.
   */
  validateArguments(...args) {
    assert && assert(args.length === this.parameters.length, `Emitted unexpected number of args. Expected: ${this.parameters.length} and received ${args.length}`);
    for (let i = 0; i < this.parameters.length; i++) {
      const parameter = this.parameters[i];
      assert && validate(args[i], parameter, VALIDATE_OPTIONS_FALSE);

      // valueType overrides the phetioType validator so we don't use that one if there is a valueType
      if (parameter.phetioType && !parameter.valueType) {
        assert && validate(args[i], parameter.phetioType.validator, VALIDATE_OPTIONS_FALSE);
      }
    }
  }

  /**
   * Validate that provided args match the expected schema given via options.parameters.
   */
  getValidationErrors(...args) {
    assert && assert(args.length === this.parameters.length, `Emitted unexpected number of args. Expected: ${this.parameters.length} and received ${args.length}`);
    const errors = [];
    for (let i = 0; i < this.parameters.length; i++) {
      const parameter = this.parameters[i];
      let error = Validation.getValidationError(args[i], parameter, VALIDATE_OPTIONS_FALSE);
      error !== null && errors.push(error);

      // valueType overrides the phetioType validator so we don't use that one if there is a valueType
      if (parameter.phetioType && !parameter.valueType) {
        error = Validation.getValidationError(args[i], parameter.phetioType.validator, VALIDATE_OPTIONS_FALSE);
        error !== null && errors.push(error);
      }
    }
    return errors;
  }

  /**
   * Gets the data that will be emitted to the PhET-iO data stream, for an instrumented simulation.
   * @returns the data, keys dependent on parameter metadata
   */
  getPhetioData(...args) {
    assert && assert(Tandem.PHET_IO_ENABLED, 'should only get phet-io data in phet-io brand');

    // null if there are no arguments. dataStream.js omits null values for data
    let data = null;
    if (this.parameters.length > 0) {
      // Enumerate named argsObject for the data stream.
      data = {};
      for (let i = 0; i < this.parameters.length; i++) {
        const element = this.parameters[i];
        if (!element.phetioPrivate) {
          assert && assert(element.name, 'name required');
          data[element.name] = element.phetioType.toStateObject(args[i]);
        }
      }
    }
    return data;
  }

  /**
   * Get the phetioDocumentation compiled from all the parameters
   */
  static getPhetioDocumentation(currentPhetioDocumentation, parameters) {
    const paramToDocString = param => {
      const docText = param.phetioDocumentation ? ` - ${param.phetioDocumentation}` : '';
      return `<li>${param.name}: ${param.phetioType.typeName}${docText}</li>`;
    };
    return currentPhetioDocumentation + (parameters.length === 0 ? '<br>No parameters.' : `${'<br>The parameters are:<br/>' + '<ol>'}${parameters.map(paramToDocString).join('<br/>')}</ol>`);
  }
}
axon.register('PhetioDataHandler', PhetioDataHandler);
export default PhetioDataHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhc3NlcnRNdXR1YWxseUV4Y2x1c2l2ZU9wdGlvbnMiLCJvcHRpb25pemUiLCJQaGV0aW9PYmplY3QiLCJUYW5kZW0iLCJheG9uIiwidmFsaWRhdGUiLCJWYWxpZGF0aW9uIiwiVkFMSURBVEVfT1BUSU9OU19GQUxTRSIsInZhbGlkYXRlVmFsaWRhdG9yIiwiRU1QVFlfQVJSQVkiLCJhc3NlcnQiLCJPYmplY3QiLCJmcmVlemUiLCJQQVJBTUVURVJfS0VZUyIsImNvbmNhdCIsIlZBTElEQVRPUl9LRVlTIiwicGFyYW1Ub1BoZXRpb1R5cGUiLCJwYXJhbSIsInBoZXRpb1R5cGUiLCJwYXJhbVRvTmFtZSIsIm5hbWUiLCJQaGV0aW9EYXRhSGFuZGxlciIsImNvbnN0cnVjdG9yIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInBhcmFtZXRlcnMiLCJoYXNMaXN0ZW5lck9yZGVyRGVwZW5kZW5jaWVzIiwidGFuZGVtIiwiT1BUSU9OQUwiLCJwaGV0aW9QbGF5YmFjayIsIkRFRkFVTFRfT1BUSU9OUyIsInBoZXRpb0V2ZW50TWV0YWRhdGEiLCJwaGV0aW9Eb2N1bWVudGF0aW9uIiwidmFsaWRhdGVQYXJhbWV0ZXJzIiwic3VwcGxpZWQiLCJ1bmRlZmluZWQiLCJwaGV0aW9QdWJsaWNQYXJhbWV0ZXJzIiwiZmlsdGVyIiwicGhldGlvT3V0ZXJUeXBlIiwibWFwIiwiaGFzT3duUHJvcGVydHkiLCJkYXRhS2V5cyIsImdldFBoZXRpb0RvY3VtZW50YXRpb24iLCJ0YW5kZW1TdXBwbGllZCIsInZhbHVlVHlwZSIsIkFycmF5IiwicmVhY2hlZFBoZXRpb1ByaXZhdGUiLCJpIiwibGVuZ3RoIiwicGFyYW1ldGVyIiwiZ2V0UHJvdG90eXBlT2YiLCJwcm90b3R5cGUiLCJwaGV0aW9Qcml2YXRlIiwiVkFMSURBVElPTiIsIl8iLCJpbnRlcnNlY3Rpb24iLCJrZXlzIiwia2V5IiwiaW5jbHVkZXMiLCJ2YWxpZGF0ZUFyZ3VtZW50cyIsImFyZ3MiLCJ2YWxpZGF0b3IiLCJnZXRWYWxpZGF0aW9uRXJyb3JzIiwiZXJyb3JzIiwiZXJyb3IiLCJnZXRWYWxpZGF0aW9uRXJyb3IiLCJwdXNoIiwiZ2V0UGhldGlvRGF0YSIsIlBIRVRfSU9fRU5BQkxFRCIsImRhdGEiLCJlbGVtZW50IiwidG9TdGF0ZU9iamVjdCIsImN1cnJlbnRQaGV0aW9Eb2N1bWVudGF0aW9uIiwicGFyYW1Ub0RvY1N0cmluZyIsImRvY1RleHQiLCJ0eXBlTmFtZSIsImpvaW4iLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlBoZXRpb0RhdGFIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEhlbHBlciB0eXBlIHRoYXQgc3VwcG9ydHMgYSBgcGFyYW1ldGVyc2AgbWVtYmVyLlxyXG4gKiBUaGlzIGlzIG1vc3RseSB1c2VmdWwgZm9yIFBoRVQtaU8gaW5zdHJ1bWVudGVkIHN1Yi1jbGFzcyB0byB1c2UgdGhhdCB0YWtlcyBhIHZhcmlhYmxlIG51bWJlciBvZiBwYXJhbWV0ZXJzIGluIHRoZWlyXHJcbiAqIElPVHlwZS4gV2l0aCB0aGlzIGZ1bmN0aW9uIHlvdSBnYWluIHBhcmFtZXRlciB2YWxpZGF0aW9uLCBQaEVULWlPIGRvY3VtZW50YXRpb24sIGFuZCBkYXRhIHN0cmVhbSBzdXBwb3J0LlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IGFzc2VydE11dHVhbGx5RXhjbHVzaXZlT3B0aW9ucyBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvYXNzZXJ0TXV0dWFsbHlFeGNsdXNpdmVPcHRpb25zLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFBoZXRpb09iamVjdCwgeyBQaGV0aW9PYmplY3RPcHRpb25zIH0gZnJvbSAnLi9QaGV0aW9PYmplY3QuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4vVGFuZGVtLmpzJztcclxuaW1wb3J0IElPVHlwZSBmcm9tICcuL3R5cGVzL0lPVHlwZS5qcyc7XHJcbmltcG9ydCBheG9uIGZyb20gJy4uLy4uL2F4b24vanMvYXhvbi5qcyc7XHJcbmltcG9ydCB2YWxpZGF0ZSBmcm9tICcuLi8uLi9heG9uL2pzL3ZhbGlkYXRlLmpzJztcclxuaW1wb3J0IFZhbGlkYXRpb24sIHsgVmFsaWRhdG9yIH0gZnJvbSAnLi4vLi4vYXhvbi9qcy9WYWxpZGF0aW9uLmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgSW50ZW50aW9uYWxBbnkgZnJvbSAnLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL0ludGVudGlvbmFsQW55LmpzJztcclxuXHJcbmNvbnN0IFZBTElEQVRFX09QVElPTlNfRkFMU0UgPSB7IHZhbGlkYXRlVmFsaWRhdG9yOiBmYWxzZSB9O1xyXG5cclxuZXhwb3J0IHR5cGUgUGFyYW1ldGVyID0ge1xyXG4gIG5hbWU/OiBzdHJpbmc7XHJcbiAgcGhldGlvRG9jdW1lbnRhdGlvbj86IHN0cmluZztcclxuICBwaGV0aW9Qcml2YXRlPzogYm9vbGVhbjtcclxufSAmIFZhbGlkYXRvcjtcclxuXHJcbi8vIFNpbXVsYXRpb25zIGhhdmUgdGhvdXNhbmRzIG9mIEVtaXR0ZXJzLCBzbyB3ZSByZS11c2Ugb2JqZWN0cyB3aGVyZSBwb3NzaWJsZS5cclxuY29uc3QgRU1QVFlfQVJSQVk6IFBhcmFtZXRlcltdID0gW107XHJcbmFzc2VydCAmJiBPYmplY3QuZnJlZXplKCBFTVBUWV9BUlJBWSApO1xyXG5cclxuLy8gYWxsb3dlZCBrZXlzIHRvIG9wdGlvbnMucGFyYW1ldGVyc1xyXG5jb25zdCBQQVJBTUVURVJfS0VZUyA9IFtcclxuICAnbmFtZScsIC8vIHJlcXVpcmVkIGZvciBwaGV0LWlvIGluc3RydW1lbnRlZCBBY3Rpb25zXHJcbiAgJ3BoZXRpb1R5cGUnLCAvLyByZXF1aXJlZCBmb3IgcGhldC1pbyBpbnN0cnVtZW50ZWQgQWN0aW9uc1xyXG4gICdwaGV0aW9Eb2N1bWVudGF0aW9uJywgLy8gb3B0aW9uYWwsIGFkZGl0aW9uYWwgZG9jdW1lbnRhdGlvbiBmb3IgdGhpcyBzcGVjaWZpYyBwYXJhbWV0ZXJcclxuXHJcbiAgLy8gc3BlY2lmeSB0aGlzIHRvIGtlZXAgdGhlIHBhcmFtZXRlciBwcml2YXRlIHRvIHRoZSBQaEVULWlPIEFQSS4gVG8gc3VwcG9ydCBlbWl0dGluZyBhbmQgZXhlY3V0aW5nIG92ZXJcclxuICAvLyB0aGUgUGhFVC1pTyBBUEksIHBoZXRpb1ByaXZhdGUgcGFyYW1ldGVycyBtdXN0IG5vdCBldmVyIGJlIGJlZm9yZSBhIHB1YmxpYyBvbmUuIEZvciBleGFtcGxlXHJcbiAgLy8gYGVtaXQxKCBwdWJsaWMxLCBwcml2YXRlMSwgcHVibGljMilgIGlzIG5vdCBhbGxvd2VkLiBJbnN0ZWFkIGl0IG11c3QgYmUgb3JkZXJlZCBsaWtlIGBlbWl0KCBwdWJsaWMxLCBwdWJsaWMyLCBwcml2YXRlMSApYFxyXG4gICdwaGV0aW9Qcml2YXRlJ1xyXG5cclxuXS5jb25jYXQoIFZhbGlkYXRpb24uVkFMSURBVE9SX0tFWVMgKTtcclxuXHJcbi8vIGhlbHBlciBjbG9zdXJlc1xyXG5jb25zdCBwYXJhbVRvUGhldGlvVHlwZSA9ICggcGFyYW06IFBhcmFtZXRlciApID0+IHBhcmFtLnBoZXRpb1R5cGUhO1xyXG5jb25zdCBwYXJhbVRvTmFtZSA9ICggcGFyYW06IFBhcmFtZXRlciApID0+IHBhcmFtLm5hbWUhO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICBwYXJhbWV0ZXJzPzogUGFyYW1ldGVyW107XHJcbiAgcGhldGlvT3V0ZXJUeXBlOiAoIHQ6IElPVHlwZVtdICkgPT4gSU9UeXBlO1xyXG4gIGhhc0xpc3RlbmVyT3JkZXJEZXBlbmRlbmNpZXM/OiBib29sZWFuO1xyXG59O1xyXG5cclxuLy8gVXNlIGVhY2ggc3VidHlwZSBzaG91bGQgcHJvdmlkZSBpdHMgb3duIHBoZXRpb091dGVyVHlwZS4gVGhhdCBjb3VwbGVkIHdpdGggcGFyYW1ldGVyIElPVHlwZXMgd2lsbCByZXN1bHQgaW4gdGhlXHJcbi8vIHBoZXRpb1R5cGUuIERvbid0IHBhc3MgdGhpcyBpbiFcclxuZXhwb3J0IHR5cGUgUGhldGlvRGF0YUhhbmRsZXJPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBTdHJpY3RPbWl0PFBoZXRpb09iamVjdE9wdGlvbnMsICdwaGV0aW9UeXBlJz47XHJcblxyXG5jbGFzcyBQaGV0aW9EYXRhSGFuZGxlcjxUIGV4dGVuZHMgSW50ZW50aW9uYWxBbnlbXSA9IFtdPiBleHRlbmRzIFBoZXRpb09iamVjdCB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgcGFyYW1ldGVyczogUGFyYW1ldGVyW107XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdmlkZWRPcHRpb25zPzogUGhldGlvRGF0YUhhbmRsZXJPcHRpb25zICkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxQaGV0aW9EYXRhSGFuZGxlck9wdGlvbnMsIFNlbGZPcHRpb25zLCBQaGV0aW9PYmplY3RPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBzZWUgUEFSQU1FVEVSX0tFWVMgZm9yIGEgbGlzdCBvZiBsZWdhbCBrZXlzLCB0aGVpciB0eXBlcywgYW5kIGRvY3VtZW50YXRpb25cclxuICAgICAgcGFyYW1ldGVyczogRU1QVFlfQVJSQVksXHJcblxyXG4gICAgICBoYXNMaXN0ZW5lck9yZGVyRGVwZW5kZW5jaWVzOiBmYWxzZSxcclxuXHJcbiAgICAgIC8vIHBoZXQtaW8gLSBzZWUgUGhldGlvT2JqZWN0LmpzIGZvciBkb2NcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uT1BUSU9OQUwsXHJcbiAgICAgIHBoZXRpb1BsYXliYWNrOiBQaGV0aW9PYmplY3QuREVGQVVMVF9PUFRJT05TLnBoZXRpb1BsYXliYWNrLFxyXG4gICAgICBwaGV0aW9FdmVudE1ldGFkYXRhOiBQaGV0aW9PYmplY3QuREVGQVVMVF9PUFRJT05TLnBoZXRpb0V2ZW50TWV0YWRhdGEsXHJcbiAgICAgIHBoZXRpb0RvY3VtZW50YXRpb246ICcnXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgUGhldGlvRGF0YUhhbmRsZXIudmFsaWRhdGVQYXJhbWV0ZXJzKCBvcHRpb25zLnBhcmFtZXRlcnMsIG9wdGlvbnMudGFuZGVtLnN1cHBsaWVkICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBvcHRpb25zLnBoZXRpb1R5cGUgPT09IHVuZGVmaW5lZCxcclxuICAgICAgJ1BoZXRpb0RhdGFIYW5kbGVyIHNldHMgaXRzIG93biBwaGV0aW9UeXBlLiBJbnN0ZWFkIHByb3ZpZGUgcGFyYW1ldGVyIHBoZXRpb1R5cGVzIHRocm91Z2ggYG9wdGlvbnMucGFyYW1ldGVyc2Agd2l0aCBhIHBoZXRpb091dGVyVHlwZScgKTtcclxuXHJcbiAgICAvLyBsaXN0IG9mIHBhcmFtZXRlcnMsIHNlZSBvcHRpb25zLnBhcmFtZXRlcnMuIEZpbHRlciBvdXQgcGhldGlvUHJpdmF0ZSBwYXJhbWV0ZXJzLCBhbGwgYHBoZXRpb1ByaXZhdGVgXHJcbiAgICAvLyBwYXJhbWV0ZXJzIHdpbGwgbm90IGhhdmUgYSBgcGhldGlvVHlwZWAsIHNlZSBgdmFsaWRhdGVQYXJhbWV0ZXJzYC5cclxuICAgIGNvbnN0IHBoZXRpb1B1YmxpY1BhcmFtZXRlcnMgPSBvcHRpb25zLnBhcmFtZXRlcnMuZmlsdGVyKCBwYXJhbVRvUGhldGlvVHlwZSApO1xyXG5cclxuICAgIG9wdGlvbnMucGhldGlvVHlwZSA9IG9wdGlvbnMucGhldGlvT3V0ZXJUeXBlKCBwaGV0aW9QdWJsaWNQYXJhbWV0ZXJzLm1hcCggcGFyYW1Ub1BoZXRpb1R5cGUgKSApO1xyXG5cclxuICAgIC8vIHBoZXRpb1BsYXliYWNrIGV2ZW50cyBuZWVkIHRvIGtub3cgdGhlIG9yZGVyIHRoZSBhcmd1bWVudHMgb2NjdXIgaW4gb3JkZXIgdG8gY2FsbCBFbWl0dGVySU8uZW1pdCgpXHJcbiAgICAvLyBJbmRpY2F0ZSB3aGV0aGVyIHRoZSBldmVudCBpcyBmb3IgcGxheWJhY2ssIGJ1dCBsZWF2ZSB0aGlzIFwic3BhcnNlXCItLW9ubHkgaW5kaWNhdGUgd2hlbiB0aGlzIGhhcHBlbnMgdG8gYmUgdHJ1ZVxyXG4gICAgaWYgKCBvcHRpb25zLnBoZXRpb1BsYXliYWNrICkge1xyXG4gICAgICBvcHRpb25zLnBoZXRpb0V2ZW50TWV0YWRhdGEgPSBvcHRpb25zLnBoZXRpb0V2ZW50TWV0YWRhdGEgfHwge307IC8vIHBoZXRpb0V2ZW50TWV0YWRhdGEgZGVmYXVsdHMgdG8gbnVsbFxyXG5cclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIW9wdGlvbnMucGhldGlvRXZlbnRNZXRhZGF0YS5oYXNPd25Qcm9wZXJ0eSggJ2RhdGFLZXlzJyApLFxyXG4gICAgICAgICdkYXRhS2V5cyBzaG91bGQgYmUgc3VwcGxpZWQgYnkgUGhldGlvRGF0YUhhbmRsZXIsIG5vdCBlbHNld2hlcmUnICk7XHJcblxyXG4gICAgICBvcHRpb25zLnBoZXRpb0V2ZW50TWV0YWRhdGEuZGF0YUtleXMgPSBvcHRpb25zLnBhcmFtZXRlcnMubWFwKCBwYXJhbVRvTmFtZSApO1xyXG4gICAgfVxyXG4gICAgb3B0aW9ucy5waGV0aW9Eb2N1bWVudGF0aW9uID0gUGhldGlvRGF0YUhhbmRsZXIuZ2V0UGhldGlvRG9jdW1lbnRhdGlvbiggb3B0aW9ucy5waGV0aW9Eb2N1bWVudGF0aW9uLCBwaGV0aW9QdWJsaWNQYXJhbWV0ZXJzICk7XHJcblxyXG4gICAgc3VwZXIoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBOb3RlOiBvbmUgdGVzdCBpbmRpY2F0ZXMgc3RyaXBwaW5nIHRoaXMgb3V0IHZpYSBhc3NlcnQgJiYgaW4gYnVpbGRzIG1heSBzYXZlIGFyb3VuZCAzMDBrYiBoZWFwXHJcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBvcHRpb25zLnBhcmFtZXRlcnM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gcGFyYW1ldGVyc1xyXG4gICAqIEBwYXJhbSB0YW5kZW1TdXBwbGllZCAtIHByb3h5IGZvciB3aGV0aGVyIHRoZSBQaGV0aW9PYmplY3QgaXMgaW5zdHJ1bWVudGVkLiAgV2UgY2Fubm90IGNhbGxcclxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0gUGhldGlvT2JqZWN0LmlzUGhldGlvSW5zdHJ1bWVudGVkKCkgdW50aWwgYWZ0ZXIgdGhlIHN1cGVyY2FsbCwgc28gd2UgdXNlIHRoaXMgYmVmb3JlaGFuZC5cclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyB2YWxpZGF0ZVBhcmFtZXRlcnMoIHBhcmFtZXRlcnM6IFBhcmFtZXRlcltdLCB0YW5kZW1TdXBwbGllZDogYm9vbGVhbiApOiB2b2lkIHtcclxuXHJcbiAgICAvLyB2YWxpZGF0ZSB0aGUgcGFyYW1ldGVycyBvYmplY3RcclxuICAgIHZhbGlkYXRlKCBwYXJhbWV0ZXJzLCB7IHZhbHVlVHlwZTogQXJyYXkgfSApO1xyXG5cclxuICAgIC8vIFBoZXRpb0RhdGFIYW5kbGVyIG9ubHkgc3VwcG9ydHMgcGhldGlvUHJpdmF0ZSBwYXJhbWV0ZXJzIGF0IHRoZSBlbmQgb2YgdGhlIGVtaXQgY2FsbCwgc28gb25jZSB3ZSBoaXQgdGhlIGZpcnN0IHBoZXRpb1ByaXZhdGVcclxuICAgIC8vIHBhcmFtZXRlciwgdGhlbiBhc3NlcnQgdGhhdCB0aGUgcmVzdCBvZiB0aGVtIGFmdGVyd2FyZHMgYXJlIGFzIHdlbGwuXHJcbiAgICBsZXQgcmVhY2hlZFBoZXRpb1ByaXZhdGUgPSBmYWxzZTtcclxuXHJcbiAgICAvLyB3ZSBtdXN0IGl0ZXJhdGUgZnJvbSB0aGUgZmlyc3QgcGFyYW1ldGVyIHRvIHRoZSBsYXN0IHBhcmFtZXRlciB0byBzdXBwb3J0IHBoZXRpb1ByaXZhdGVcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHBhcmFtZXRlcnMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IHBhcmFtZXRlciA9IHBhcmFtZXRlcnNbIGkgXTsgLy8gbWV0YWRhdGEgYWJvdXQgYSBzaW5nbGUgcGFyYW1ldGVyXHJcblxyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoIHBhcmFtZXRlciApID09PSBPYmplY3QucHJvdG90eXBlLFxyXG4gICAgICAgICdFeHRyYSBwcm90b3R5cGUgb24gcGFyYW1ldGVyIG9iamVjdCBpcyBhIGNvZGUgc21lbGwnICk7XHJcblxyXG4gICAgICByZWFjaGVkUGhldGlvUHJpdmF0ZSA9IHJlYWNoZWRQaGV0aW9Qcml2YXRlIHx8IHBhcmFtZXRlci5waGV0aW9Qcml2YXRlITtcclxuICAgICAgYXNzZXJ0ICYmIHJlYWNoZWRQaGV0aW9Qcml2YXRlICYmIGFzc2VydCggcGFyYW1ldGVyLnBoZXRpb1ByaXZhdGUsXHJcbiAgICAgICAgJ2FmdGVyIGZpcnN0IHBoZXRpb1ByaXZhdGUgcGFyYW1ldGVyLCBhbGwgc3Vic2VxdWVudCBwYXJhbWV0ZXJzIG11c3QgYmUgcGhldGlvUHJpdmF0ZScgKTtcclxuXHJcbiAgICAgIGFzc2VydCAmJiB0YW5kZW1TdXBwbGllZCAmJiBUYW5kZW0uVkFMSURBVElPTiAmJiBhc3NlcnQoIHBhcmFtZXRlci5waGV0aW9UeXBlIHx8IHBhcmFtZXRlci5waGV0aW9Qcml2YXRlLFxyXG4gICAgICAgICdpbnN0cnVtZW50ZWQgRW1pdHRlcnMgbXVzdCBpbmNsdWRlIHBoZXRpb1R5cGUgZm9yIGVhY2ggcGFyYW1ldGVyIG9yIGJlIG1hcmtlZCBhcyBgcGhldGlvUHJpdmF0ZWAuJyApO1xyXG4gICAgICBhc3NlcnQgJiYgcGFyYW1ldGVyLnBoZXRpb1R5cGUgJiYgYXNzZXJ0KCBwYXJhbWV0ZXIubmFtZSxcclxuICAgICAgICAnYG5hbWVgIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyIGZvciBwaGV0LWlvIGluc3RydW1lbnRlZCBwYXJhbWV0ZXJzLicgKTtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydE11dHVhbGx5RXhjbHVzaXZlT3B0aW9ucyggcGFyYW1ldGVyLCBbICdwaGV0aW9Qcml2YXRlJyBdLCBbXHJcbiAgICAgICAgJ25hbWUnLCAncGhldGlvVHlwZScsICdwaGV0aW9Eb2N1bWVudGF0aW9uJ1xyXG4gICAgICBdICk7XHJcblxyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBfLmludGVyc2VjdGlvbiggT2JqZWN0LmtleXMoIHBhcmFtZXRlciApLCBWYWxpZGF0aW9uLlZBTElEQVRPUl9LRVlTICkubGVuZ3RoID4gMCxcclxuICAgICAgICBgdmFsaWRhdG9yIG11c3QgYmUgc3BlY2lmaWVkIGZvciBwYXJhbWV0ZXIgJHtpfWAgKTtcclxuXHJcbiAgICAgIGZvciAoIGNvbnN0IGtleSBpbiBwYXJhbWV0ZXIgKSB7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggUEFSQU1FVEVSX0tFWVMuaW5jbHVkZXMoIGtleSApLCBgdW5yZWNvZ25pemVkIHBhcmFtZXRlciBrZXk6ICR7a2V5fWAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQ2hhbmdpbmcgYWZ0ZXIgY29uc3RydWN0aW9uIGluZGljYXRlcyBhIGxvZ2ljIGVycm9yLlxyXG4gICAgICBhc3NlcnQgJiYgT2JqZWN0LmZyZWV6ZSggcGFyYW1ldGVyc1sgaSBdICk7XHJcblxyXG4gICAgICAvLyB2YWxpZGF0ZSB0aGUgb3B0aW9ucyBwYXNzZWQgaW4gdG8gdmFsaWRhdGUgZWFjaCBQaGV0aW9EYXRhSGFuZGxlciBhcmd1bWVudFxyXG4gICAgICBWYWxpZGF0aW9uLnZhbGlkYXRlVmFsaWRhdG9yKCBwYXJhbWV0ZXIgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGFuZ2luZyBhZnRlciBjb25zdHJ1Y3Rpb24gaW5kaWNhdGVzIGEgbG9naWMgZXJyb3IuXHJcbiAgICBhc3NlcnQgJiYgT2JqZWN0LmZyZWV6ZSggcGFyYW1ldGVycyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVmFsaWRhdGUgdGhhdCBwcm92aWRlZCBhcmdzIG1hdGNoIHRoZSBleHBlY3RlZCBzY2hlbWEgZ2l2ZW4gdmlhIG9wdGlvbnMucGFyYW1ldGVycy5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgdmFsaWRhdGVBcmd1bWVudHMoIC4uLmFyZ3M6IFQgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBhcmdzLmxlbmd0aCA9PT0gdGhpcy5wYXJhbWV0ZXJzLmxlbmd0aCxcclxuICAgICAgYEVtaXR0ZWQgdW5leHBlY3RlZCBudW1iZXIgb2YgYXJncy4gRXhwZWN0ZWQ6ICR7dGhpcy5wYXJhbWV0ZXJzLmxlbmd0aH0gYW5kIHJlY2VpdmVkICR7YXJncy5sZW5ndGh9YFxyXG4gICAgKTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucGFyYW1ldGVycy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgY29uc3QgcGFyYW1ldGVyID0gdGhpcy5wYXJhbWV0ZXJzWyBpIF07XHJcbiAgICAgIGFzc2VydCAmJiB2YWxpZGF0ZSggYXJnc1sgaSBdLCBwYXJhbWV0ZXIsIFZBTElEQVRFX09QVElPTlNfRkFMU0UgKTtcclxuXHJcbiAgICAgIC8vIHZhbHVlVHlwZSBvdmVycmlkZXMgdGhlIHBoZXRpb1R5cGUgdmFsaWRhdG9yIHNvIHdlIGRvbid0IHVzZSB0aGF0IG9uZSBpZiB0aGVyZSBpcyBhIHZhbHVlVHlwZVxyXG4gICAgICBpZiAoIHBhcmFtZXRlci5waGV0aW9UeXBlICYmICFwYXJhbWV0ZXIudmFsdWVUeXBlICkge1xyXG4gICAgICAgIGFzc2VydCAmJiB2YWxpZGF0ZSggYXJnc1sgaSBdLCBwYXJhbWV0ZXIucGhldGlvVHlwZS52YWxpZGF0b3IsIFZBTElEQVRFX09QVElPTlNfRkFMU0UgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVmFsaWRhdGUgdGhhdCBwcm92aWRlZCBhcmdzIG1hdGNoIHRoZSBleHBlY3RlZCBzY2hlbWEgZ2l2ZW4gdmlhIG9wdGlvbnMucGFyYW1ldGVycy5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0VmFsaWRhdGlvbkVycm9ycyggLi4uYXJnczogVCApOiBBcnJheTxzdHJpbmc+IHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGFyZ3MubGVuZ3RoID09PSB0aGlzLnBhcmFtZXRlcnMubGVuZ3RoLFxyXG4gICAgICBgRW1pdHRlZCB1bmV4cGVjdGVkIG51bWJlciBvZiBhcmdzLiBFeHBlY3RlZDogJHt0aGlzLnBhcmFtZXRlcnMubGVuZ3RofSBhbmQgcmVjZWl2ZWQgJHthcmdzLmxlbmd0aH1gXHJcbiAgICApO1xyXG4gICAgY29uc3QgZXJyb3JzID0gW107XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnBhcmFtZXRlcnMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IHBhcmFtZXRlciA9IHRoaXMucGFyYW1ldGVyc1sgaSBdO1xyXG4gICAgICBsZXQgZXJyb3IgPSBWYWxpZGF0aW9uLmdldFZhbGlkYXRpb25FcnJvciggYXJnc1sgaSBdLCBwYXJhbWV0ZXIsIFZBTElEQVRFX09QVElPTlNfRkFMU0UgKTtcclxuICAgICAgZXJyb3IgIT09IG51bGwgJiYgZXJyb3JzLnB1c2goIGVycm9yICk7XHJcblxyXG4gICAgICAvLyB2YWx1ZVR5cGUgb3ZlcnJpZGVzIHRoZSBwaGV0aW9UeXBlIHZhbGlkYXRvciBzbyB3ZSBkb24ndCB1c2UgdGhhdCBvbmUgaWYgdGhlcmUgaXMgYSB2YWx1ZVR5cGVcclxuICAgICAgaWYgKCBwYXJhbWV0ZXIucGhldGlvVHlwZSAmJiAhcGFyYW1ldGVyLnZhbHVlVHlwZSApIHtcclxuICAgICAgICBlcnJvciA9IFZhbGlkYXRpb24uZ2V0VmFsaWRhdGlvbkVycm9yKCBhcmdzWyBpIF0sIHBhcmFtZXRlci5waGV0aW9UeXBlLnZhbGlkYXRvciwgVkFMSURBVEVfT1BUSU9OU19GQUxTRSApO1xyXG4gICAgICAgIGVycm9yICE9PSBudWxsICYmIGVycm9ycy5wdXNoKCBlcnJvciApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXJyb3JzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0cyB0aGUgZGF0YSB0aGF0IHdpbGwgYmUgZW1pdHRlZCB0byB0aGUgUGhFVC1pTyBkYXRhIHN0cmVhbSwgZm9yIGFuIGluc3RydW1lbnRlZCBzaW11bGF0aW9uLlxyXG4gICAqIEByZXR1cm5zIHRoZSBkYXRhLCBrZXlzIGRlcGVuZGVudCBvbiBwYXJhbWV0ZXIgbWV0YWRhdGFcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UGhldGlvRGF0YSggLi4uYXJnczogVCApOiBudWxsIHwgUmVjb3JkPHN0cmluZywgdW5rbm93bj4ge1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIFRhbmRlbS5QSEVUX0lPX0VOQUJMRUQsICdzaG91bGQgb25seSBnZXQgcGhldC1pbyBkYXRhIGluIHBoZXQtaW8gYnJhbmQnICk7XHJcblxyXG4gICAgLy8gbnVsbCBpZiB0aGVyZSBhcmUgbm8gYXJndW1lbnRzLiBkYXRhU3RyZWFtLmpzIG9taXRzIG51bGwgdmFsdWVzIGZvciBkYXRhXHJcbiAgICBsZXQgZGF0YTogUmVjb3JkPHN0cmluZywgb2JqZWN0PiB8IG51bGwgPSBudWxsO1xyXG4gICAgaWYgKCB0aGlzLnBhcmFtZXRlcnMubGVuZ3RoID4gMCApIHtcclxuXHJcbiAgICAgIC8vIEVudW1lcmF0ZSBuYW1lZCBhcmdzT2JqZWN0IGZvciB0aGUgZGF0YSBzdHJlYW0uXHJcbiAgICAgIGRhdGEgPSB7fTtcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy5wYXJhbWV0ZXJzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLnBhcmFtZXRlcnNbIGkgXTtcclxuICAgICAgICBpZiAoICFlbGVtZW50LnBoZXRpb1ByaXZhdGUgKSB7XHJcbiAgICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBlbGVtZW50Lm5hbWUsICduYW1lIHJlcXVpcmVkJyApO1xyXG4gICAgICAgICAgZGF0YVsgZWxlbWVudC5uYW1lISBdID0gZWxlbWVudC5waGV0aW9UeXBlIS50b1N0YXRlT2JqZWN0KCBhcmdzWyBpIF0gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBwaGV0aW9Eb2N1bWVudGF0aW9uIGNvbXBpbGVkIGZyb20gYWxsIHRoZSBwYXJhbWV0ZXJzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0UGhldGlvRG9jdW1lbnRhdGlvbiggY3VycmVudFBoZXRpb0RvY3VtZW50YXRpb246IHN0cmluZywgcGFyYW1ldGVyczogUGFyYW1ldGVyW10gKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHBhcmFtVG9Eb2NTdHJpbmcgPSAoIHBhcmFtOiBQYXJhbWV0ZXIgKSA9PiB7XHJcblxyXG4gICAgICBjb25zdCBkb2NUZXh0ID0gcGFyYW0ucGhldGlvRG9jdW1lbnRhdGlvbiA/IGAgLSAke3BhcmFtLnBoZXRpb0RvY3VtZW50YXRpb259YCA6ICcnO1xyXG5cclxuICAgICAgcmV0dXJuIGA8bGk+JHtwYXJhbS5uYW1lfTogJHtwYXJhbS5waGV0aW9UeXBlIS50eXBlTmFtZX0ke2RvY1RleHR9PC9saT5gO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gY3VycmVudFBoZXRpb0RvY3VtZW50YXRpb24gKyAoIHBhcmFtZXRlcnMubGVuZ3RoID09PSAwID8gJzxicj5ObyBwYXJhbWV0ZXJzLicgOiBgJHsnPGJyPlRoZSBwYXJhbWV0ZXJzIGFyZTo8YnIvPicgK1xyXG4gICAgICAgICAgICc8b2w+J30ke3BhcmFtZXRlcnMubWFwKCBwYXJhbVRvRG9jU3RyaW5nICkuam9pbiggJzxici8+JyApfTwvb2w+YCApO1xyXG4gIH1cclxufVxyXG5cclxuYXhvbi5yZWdpc3RlciggJ1BoZXRpb0RhdGFIYW5kbGVyJywgUGhldGlvRGF0YUhhbmRsZXIgKTtcclxuZXhwb3J0IGRlZmF1bHQgUGhldGlvRGF0YUhhbmRsZXI7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLDhCQUE4QixNQUFNLHNEQUFzRDtBQUNqRyxPQUFPQyxTQUFTLE1BQU0saUNBQWlDO0FBQ3ZELE9BQU9DLFlBQVksTUFBK0IsbUJBQW1CO0FBQ3JFLE9BQU9DLE1BQU0sTUFBTSxhQUFhO0FBRWhDLE9BQU9DLElBQUksTUFBTSx1QkFBdUI7QUFDeEMsT0FBT0MsUUFBUSxNQUFNLDJCQUEyQjtBQUNoRCxPQUFPQyxVQUFVLE1BQXFCLDZCQUE2QjtBQUluRSxNQUFNQyxzQkFBc0IsR0FBRztFQUFFQyxpQkFBaUIsRUFBRTtBQUFNLENBQUM7QUFRM0Q7QUFDQSxNQUFNQyxXQUF3QixHQUFHLEVBQUU7QUFDbkNDLE1BQU0sSUFBSUMsTUFBTSxDQUFDQyxNQUFNLENBQUVILFdBQVksQ0FBQzs7QUFFdEM7QUFDQSxNQUFNSSxjQUFjLEdBQUcsQ0FDckIsTUFBTTtBQUFFO0FBQ1IsWUFBWTtBQUFFO0FBQ2QscUJBQXFCO0FBQUU7O0FBRXZCO0FBQ0E7QUFDQTtBQUNBLGVBQWUsQ0FFaEIsQ0FBQ0MsTUFBTSxDQUFFUixVQUFVLENBQUNTLGNBQWUsQ0FBQzs7QUFFckM7QUFDQSxNQUFNQyxpQkFBaUIsR0FBS0MsS0FBZ0IsSUFBTUEsS0FBSyxDQUFDQyxVQUFXO0FBQ25FLE1BQU1DLFdBQVcsR0FBS0YsS0FBZ0IsSUFBTUEsS0FBSyxDQUFDRyxJQUFLOztBQVF2RDtBQUNBO0FBR0EsTUFBTUMsaUJBQWlCLFNBQTBDbkIsWUFBWSxDQUFDO0VBSXJFb0IsV0FBV0EsQ0FBRUMsZUFBMEMsRUFBRztJQUMvRCxNQUFNQyxPQUFPLEdBQUd2QixTQUFTLENBQTZELENBQUMsQ0FBRTtNQUV2RjtNQUNBd0IsVUFBVSxFQUFFaEIsV0FBVztNQUV2QmlCLDRCQUE0QixFQUFFLEtBQUs7TUFFbkM7TUFDQUMsTUFBTSxFQUFFeEIsTUFBTSxDQUFDeUIsUUFBUTtNQUN2QkMsY0FBYyxFQUFFM0IsWUFBWSxDQUFDNEIsZUFBZSxDQUFDRCxjQUFjO01BQzNERSxtQkFBbUIsRUFBRTdCLFlBQVksQ0FBQzRCLGVBQWUsQ0FBQ0MsbUJBQW1CO01BQ3JFQyxtQkFBbUIsRUFBRTtJQUN2QixDQUFDLEVBQUVULGVBQWdCLENBQUM7SUFFcEJiLE1BQU0sSUFBSVcsaUJBQWlCLENBQUNZLGtCQUFrQixDQUFFVCxPQUFPLENBQUNDLFVBQVUsRUFBRUQsT0FBTyxDQUFDRyxNQUFNLENBQUNPLFFBQVMsQ0FBQztJQUM3RnhCLE1BQU0sSUFBSUEsTUFBTSxDQUFFYyxPQUFPLENBQUNOLFVBQVUsS0FBS2lCLFNBQVMsRUFDaEQsc0lBQXVJLENBQUM7O0lBRTFJO0lBQ0E7SUFDQSxNQUFNQyxzQkFBc0IsR0FBR1osT0FBTyxDQUFDQyxVQUFVLENBQUNZLE1BQU0sQ0FBRXJCLGlCQUFrQixDQUFDO0lBRTdFUSxPQUFPLENBQUNOLFVBQVUsR0FBR00sT0FBTyxDQUFDYyxlQUFlLENBQUVGLHNCQUFzQixDQUFDRyxHQUFHLENBQUV2QixpQkFBa0IsQ0FBRSxDQUFDOztJQUUvRjtJQUNBO0lBQ0EsSUFBS1EsT0FBTyxDQUFDSyxjQUFjLEVBQUc7TUFDNUJMLE9BQU8sQ0FBQ08sbUJBQW1CLEdBQUdQLE9BQU8sQ0FBQ08sbUJBQW1CLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs7TUFFakVyQixNQUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDYyxPQUFPLENBQUNPLG1CQUFtQixDQUFDUyxjQUFjLENBQUUsVUFBVyxDQUFDLEVBQ3pFLGlFQUFrRSxDQUFDO01BRXJFaEIsT0FBTyxDQUFDTyxtQkFBbUIsQ0FBQ1UsUUFBUSxHQUFHakIsT0FBTyxDQUFDQyxVQUFVLENBQUNjLEdBQUcsQ0FBRXBCLFdBQVksQ0FBQztJQUM5RTtJQUNBSyxPQUFPLENBQUNRLG1CQUFtQixHQUFHWCxpQkFBaUIsQ0FBQ3FCLHNCQUFzQixDQUFFbEIsT0FBTyxDQUFDUSxtQkFBbUIsRUFBRUksc0JBQXVCLENBQUM7SUFFN0gsS0FBSyxDQUFFWixPQUFRLENBQUM7O0lBRWhCO0lBQ0EsSUFBSSxDQUFDQyxVQUFVLEdBQUdELE9BQU8sQ0FBQ0MsVUFBVTtFQUN0Qzs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsT0FBZVEsa0JBQWtCQSxDQUFFUixVQUF1QixFQUFFa0IsY0FBdUIsRUFBUztJQUUxRjtJQUNBdEMsUUFBUSxDQUFFb0IsVUFBVSxFQUFFO01BQUVtQixTQUFTLEVBQUVDO0lBQU0sQ0FBRSxDQUFDOztJQUU1QztJQUNBO0lBQ0EsSUFBSUMsb0JBQW9CLEdBQUcsS0FBSzs7SUFFaEM7SUFDQSxLQUFNLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR3RCLFVBQVUsQ0FBQ3VCLE1BQU0sRUFBRUQsQ0FBQyxFQUFFLEVBQUc7TUFDNUMsTUFBTUUsU0FBUyxHQUFHeEIsVUFBVSxDQUFFc0IsQ0FBQyxDQUFFLENBQUMsQ0FBQzs7TUFFbkNyQyxNQUFNLElBQUlBLE1BQU0sQ0FBRUMsTUFBTSxDQUFDdUMsY0FBYyxDQUFFRCxTQUFVLENBQUMsS0FBS3RDLE1BQU0sQ0FBQ3dDLFNBQVMsRUFDdkUscURBQXNELENBQUM7TUFFekRMLG9CQUFvQixHQUFHQSxvQkFBb0IsSUFBSUcsU0FBUyxDQUFDRyxhQUFjO01BQ3ZFMUMsTUFBTSxJQUFJb0Msb0JBQW9CLElBQUlwQyxNQUFNLENBQUV1QyxTQUFTLENBQUNHLGFBQWEsRUFDL0Qsc0ZBQXVGLENBQUM7TUFFMUYxQyxNQUFNLElBQUlpQyxjQUFjLElBQUl4QyxNQUFNLENBQUNrRCxVQUFVLElBQUkzQyxNQUFNLENBQUV1QyxTQUFTLENBQUMvQixVQUFVLElBQUkrQixTQUFTLENBQUNHLGFBQWEsRUFDdEcsbUdBQW9HLENBQUM7TUFDdkcxQyxNQUFNLElBQUl1QyxTQUFTLENBQUMvQixVQUFVLElBQUlSLE1BQU0sQ0FBRXVDLFNBQVMsQ0FBQzdCLElBQUksRUFDdEQscUVBQXNFLENBQUM7TUFDekVWLE1BQU0sSUFBSVYsOEJBQThCLENBQUVpRCxTQUFTLEVBQUUsQ0FBRSxlQUFlLENBQUUsRUFBRSxDQUN4RSxNQUFNLEVBQUUsWUFBWSxFQUFFLHFCQUFxQixDQUMzQyxDQUFDO01BRUh2QyxNQUFNLElBQUlBLE1BQU0sQ0FBRTRDLENBQUMsQ0FBQ0MsWUFBWSxDQUFFNUMsTUFBTSxDQUFDNkMsSUFBSSxDQUFFUCxTQUFVLENBQUMsRUFBRTNDLFVBQVUsQ0FBQ1MsY0FBZSxDQUFDLENBQUNpQyxNQUFNLEdBQUcsQ0FBQyxFQUMvRiw2Q0FBNENELENBQUUsRUFBRSxDQUFDO01BRXBELEtBQU0sTUFBTVUsR0FBRyxJQUFJUixTQUFTLEVBQUc7UUFDN0J2QyxNQUFNLElBQUlBLE1BQU0sQ0FBRUcsY0FBYyxDQUFDNkMsUUFBUSxDQUFFRCxHQUFJLENBQUMsRUFBRywrQkFBOEJBLEdBQUksRUFBRSxDQUFDO01BQzFGOztNQUVBO01BQ0EvQyxNQUFNLElBQUlDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFFYSxVQUFVLENBQUVzQixDQUFDLENBQUcsQ0FBQzs7TUFFMUM7TUFDQXpDLFVBQVUsQ0FBQ0UsaUJBQWlCLENBQUV5QyxTQUFVLENBQUM7SUFDM0M7O0lBRUE7SUFDQXZDLE1BQU0sSUFBSUMsTUFBTSxDQUFDQyxNQUFNLENBQUVhLFVBQVcsQ0FBQztFQUN2Qzs7RUFFQTtBQUNGO0FBQ0E7RUFDWWtDLGlCQUFpQkEsQ0FBRSxHQUFHQyxJQUFPLEVBQVM7SUFDOUNsRCxNQUFNLElBQUlBLE1BQU0sQ0FBRWtELElBQUksQ0FBQ1osTUFBTSxLQUFLLElBQUksQ0FBQ3ZCLFVBQVUsQ0FBQ3VCLE1BQU0sRUFDckQsZ0RBQStDLElBQUksQ0FBQ3ZCLFVBQVUsQ0FBQ3VCLE1BQU8saUJBQWdCWSxJQUFJLENBQUNaLE1BQU8sRUFDckcsQ0FBQztJQUNELEtBQU0sSUFBSUQsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHLElBQUksQ0FBQ3RCLFVBQVUsQ0FBQ3VCLE1BQU0sRUFBRUQsQ0FBQyxFQUFFLEVBQUc7TUFDakQsTUFBTUUsU0FBUyxHQUFHLElBQUksQ0FBQ3hCLFVBQVUsQ0FBRXNCLENBQUMsQ0FBRTtNQUN0Q3JDLE1BQU0sSUFBSUwsUUFBUSxDQUFFdUQsSUFBSSxDQUFFYixDQUFDLENBQUUsRUFBRUUsU0FBUyxFQUFFMUMsc0JBQXVCLENBQUM7O01BRWxFO01BQ0EsSUFBSzBDLFNBQVMsQ0FBQy9CLFVBQVUsSUFBSSxDQUFDK0IsU0FBUyxDQUFDTCxTQUFTLEVBQUc7UUFDbERsQyxNQUFNLElBQUlMLFFBQVEsQ0FBRXVELElBQUksQ0FBRWIsQ0FBQyxDQUFFLEVBQUVFLFNBQVMsQ0FBQy9CLFVBQVUsQ0FBQzJDLFNBQVMsRUFBRXRELHNCQUF1QixDQUFDO01BQ3pGO0lBQ0Y7RUFDRjs7RUFFQTtBQUNGO0FBQ0E7RUFDWXVELG1CQUFtQkEsQ0FBRSxHQUFHRixJQUFPLEVBQWtCO0lBQ3pEbEQsTUFBTSxJQUFJQSxNQUFNLENBQUVrRCxJQUFJLENBQUNaLE1BQU0sS0FBSyxJQUFJLENBQUN2QixVQUFVLENBQUN1QixNQUFNLEVBQ3JELGdEQUErQyxJQUFJLENBQUN2QixVQUFVLENBQUN1QixNQUFPLGlCQUFnQlksSUFBSSxDQUFDWixNQUFPLEVBQ3JHLENBQUM7SUFDRCxNQUFNZSxNQUFNLEdBQUcsRUFBRTtJQUNqQixLQUFNLElBQUloQixDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUcsSUFBSSxDQUFDdEIsVUFBVSxDQUFDdUIsTUFBTSxFQUFFRCxDQUFDLEVBQUUsRUFBRztNQUNqRCxNQUFNRSxTQUFTLEdBQUcsSUFBSSxDQUFDeEIsVUFBVSxDQUFFc0IsQ0FBQyxDQUFFO01BQ3RDLElBQUlpQixLQUFLLEdBQUcxRCxVQUFVLENBQUMyRCxrQkFBa0IsQ0FBRUwsSUFBSSxDQUFFYixDQUFDLENBQUUsRUFBRUUsU0FBUyxFQUFFMUMsc0JBQXVCLENBQUM7TUFDekZ5RCxLQUFLLEtBQUssSUFBSSxJQUFJRCxNQUFNLENBQUNHLElBQUksQ0FBRUYsS0FBTSxDQUFDOztNQUV0QztNQUNBLElBQUtmLFNBQVMsQ0FBQy9CLFVBQVUsSUFBSSxDQUFDK0IsU0FBUyxDQUFDTCxTQUFTLEVBQUc7UUFDbERvQixLQUFLLEdBQUcxRCxVQUFVLENBQUMyRCxrQkFBa0IsQ0FBRUwsSUFBSSxDQUFFYixDQUFDLENBQUUsRUFBRUUsU0FBUyxDQUFDL0IsVUFBVSxDQUFDMkMsU0FBUyxFQUFFdEQsc0JBQXVCLENBQUM7UUFDMUd5RCxLQUFLLEtBQUssSUFBSSxJQUFJRCxNQUFNLENBQUNHLElBQUksQ0FBRUYsS0FBTSxDQUFDO01BQ3hDO0lBQ0Y7SUFDQSxPQUFPRCxNQUFNO0VBQ2Y7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7RUFDU0ksYUFBYUEsQ0FBRSxHQUFHUCxJQUFPLEVBQW1DO0lBRWpFbEQsTUFBTSxJQUFJQSxNQUFNLENBQUVQLE1BQU0sQ0FBQ2lFLGVBQWUsRUFBRSwrQ0FBZ0QsQ0FBQzs7SUFFM0Y7SUFDQSxJQUFJQyxJQUFtQyxHQUFHLElBQUk7SUFDOUMsSUFBSyxJQUFJLENBQUM1QyxVQUFVLENBQUN1QixNQUFNLEdBQUcsQ0FBQyxFQUFHO01BRWhDO01BQ0FxQixJQUFJLEdBQUcsQ0FBQyxDQUFDO01BQ1QsS0FBTSxJQUFJdEIsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHLElBQUksQ0FBQ3RCLFVBQVUsQ0FBQ3VCLE1BQU0sRUFBRUQsQ0FBQyxFQUFFLEVBQUc7UUFDakQsTUFBTXVCLE9BQU8sR0FBRyxJQUFJLENBQUM3QyxVQUFVLENBQUVzQixDQUFDLENBQUU7UUFDcEMsSUFBSyxDQUFDdUIsT0FBTyxDQUFDbEIsYUFBYSxFQUFHO1VBQzVCMUMsTUFBTSxJQUFJQSxNQUFNLENBQUU0RCxPQUFPLENBQUNsRCxJQUFJLEVBQUUsZUFBZ0IsQ0FBQztVQUNqRGlELElBQUksQ0FBRUMsT0FBTyxDQUFDbEQsSUFBSSxDQUFHLEdBQUdrRCxPQUFPLENBQUNwRCxVQUFVLENBQUVxRCxhQUFhLENBQUVYLElBQUksQ0FBRWIsQ0FBQyxDQUFHLENBQUM7UUFDeEU7TUFDRjtJQUNGO0lBQ0EsT0FBT3NCLElBQUk7RUFDYjs7RUFFQTtBQUNGO0FBQ0E7RUFDRSxPQUFlM0Isc0JBQXNCQSxDQUFFOEIsMEJBQWtDLEVBQUUvQyxVQUF1QixFQUFXO0lBQzNHLE1BQU1nRCxnQkFBZ0IsR0FBS3hELEtBQWdCLElBQU07TUFFL0MsTUFBTXlELE9BQU8sR0FBR3pELEtBQUssQ0FBQ2UsbUJBQW1CLEdBQUksTUFBS2YsS0FBSyxDQUFDZSxtQkFBb0IsRUFBQyxHQUFHLEVBQUU7TUFFbEYsT0FBUSxPQUFNZixLQUFLLENBQUNHLElBQUssS0FBSUgsS0FBSyxDQUFDQyxVQUFVLENBQUV5RCxRQUFTLEdBQUVELE9BQVEsT0FBTTtJQUMxRSxDQUFDO0lBRUQsT0FBT0YsMEJBQTBCLElBQUsvQyxVQUFVLENBQUN1QixNQUFNLEtBQUssQ0FBQyxHQUFHLG9CQUFvQixHQUFJLEdBQUUsOEJBQThCLEdBQ2pILE1BQU8sR0FBRXZCLFVBQVUsQ0FBQ2MsR0FBRyxDQUFFa0MsZ0JBQWlCLENBQUMsQ0FBQ0csSUFBSSxDQUFFLE9BQVEsQ0FBRSxPQUFNLENBQUU7RUFDN0U7QUFDRjtBQUVBeEUsSUFBSSxDQUFDeUUsUUFBUSxDQUFFLG1CQUFtQixFQUFFeEQsaUJBQWtCLENBQUM7QUFDdkQsZUFBZUEsaUJBQWlCIn0=