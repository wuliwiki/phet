// Copyright 2020-2022, University of Colorado Boulder

/**
 * Parametric IO Type that adds support for serializing an element as multiple types, as a composite. Serialization occurs
 * via a first-come-first-serialize basis, where the first parameterType will be the
 *
 * Sample usage:
 *
 * window.numberOrStringProperty = new Property( 'I am currently a string', {
      tandem: Tandem.GENERAL_MODEL.createTandem( 'numberOrStringProperty' ),
      phetioValueType: OrIO( [ StringIO, NumberIO ] )
    } );
 *
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import Validation from '../../../axon/js/Validation.js';
import tandemNamespace from '../tandemNamespace.js';
import IOType from './IOType.js';
import StateSchema from './StateSchema.js';

// cache each parameterized IOType so that it is only created once
const cache = new Map();

/**
 * Parametric type constructor function, do not use `new`
 * @param parameterTypes - a list of IO Type to combine into a single composite
 */
const OrIO = parameterTypes => {
  assert && assert(Array.isArray(parameterTypes), 'OrIO needs to be an array');
  assert && assert(parameterTypes.length > 0, 'OrIO needs parameterTypes');
  const typeNames = parameterTypes.map(parameterType => parameterType.typeName);
  const key = typeNames.join(',');
  if (!cache.has(key)) {
    const isValidValue = instance => {
      for (let i = 0; i < parameterTypes.length; i++) {
        const parameterType = parameterTypes[i];
        if (Validation.isValueValid(instance, parameterType.validator)) {
          return true;
        }
      }
      return false;
    };
    cache.set(key, new IOType(`OrIO<${typeNames.join(', ')}>`, {
      documentation: 'An IOType adding support for a composite type that can be any of its parameters.',
      parameterTypes: parameterTypes,
      isValidValue: isValidValue,
      toStateObject: instance => {
        for (let i = 0; i < parameterTypes.length; i++) {
          const parameterType = parameterTypes[i];
          if (Validation.isValueValid(instance, parameterType.validator)) {
            return {
              index: i,
              state: parameterType.toStateObject(instance)
            };
          }
        }
        throw new Error('somehow the instance was not valid, we should not get here. Why was isValidValue not used before this step?');
      },
      fromStateObject: stateObject => {
        assert && assert(stateObject.hasOwnProperty('index'), 'index required for deserialization');
        assert && assert(stateObject.hasOwnProperty('state'), 'state required for deserialization');
        return parameterTypes[stateObject.index].fromStateObject(stateObject.state);
      },
      stateSchema: StateSchema.asValue(`${typeNames.join('|')}`, {
        isValidValue: stateObject => {
          // Check based on the parameter that serialized the state
          if (typeof stateObject.index === 'number') {
            return parameterTypes[stateObject.index].isStateObjectValid(stateObject.state);
          }
          return false;
        }
      })
    }));
  }
  return cache.get(key);
};
tandemNamespace.register('OrIO', OrIO);
export default OrIO;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWYWxpZGF0aW9uIiwidGFuZGVtTmFtZXNwYWNlIiwiSU9UeXBlIiwiU3RhdGVTY2hlbWEiLCJjYWNoZSIsIk1hcCIsIk9ySU8iLCJwYXJhbWV0ZXJUeXBlcyIsImFzc2VydCIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsInR5cGVOYW1lcyIsIm1hcCIsInBhcmFtZXRlclR5cGUiLCJ0eXBlTmFtZSIsImtleSIsImpvaW4iLCJoYXMiLCJpc1ZhbGlkVmFsdWUiLCJpbnN0YW5jZSIsImkiLCJpc1ZhbHVlVmFsaWQiLCJ2YWxpZGF0b3IiLCJzZXQiLCJkb2N1bWVudGF0aW9uIiwidG9TdGF0ZU9iamVjdCIsImluZGV4Iiwic3RhdGUiLCJFcnJvciIsImZyb21TdGF0ZU9iamVjdCIsInN0YXRlT2JqZWN0IiwiaGFzT3duUHJvcGVydHkiLCJzdGF0ZVNjaGVtYSIsImFzVmFsdWUiLCJpc1N0YXRlT2JqZWN0VmFsaWQiLCJnZXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIk9ySU8udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjAtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogUGFyYW1ldHJpYyBJTyBUeXBlIHRoYXQgYWRkcyBzdXBwb3J0IGZvciBzZXJpYWxpemluZyBhbiBlbGVtZW50IGFzIG11bHRpcGxlIHR5cGVzLCBhcyBhIGNvbXBvc2l0ZS4gU2VyaWFsaXphdGlvbiBvY2N1cnNcclxuICogdmlhIGEgZmlyc3QtY29tZS1maXJzdC1zZXJpYWxpemUgYmFzaXMsIHdoZXJlIHRoZSBmaXJzdCBwYXJhbWV0ZXJUeXBlIHdpbGwgYmUgdGhlXHJcbiAqXHJcbiAqIFNhbXBsZSB1c2FnZTpcclxuICpcclxuICogd2luZG93Lm51bWJlck9yU3RyaW5nUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoICdJIGFtIGN1cnJlbnRseSBhIHN0cmluZycsIHtcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uR0VORVJBTF9NT0RFTC5jcmVhdGVUYW5kZW0oICdudW1iZXJPclN0cmluZ1Byb3BlcnR5JyApLFxyXG4gICAgICBwaGV0aW9WYWx1ZVR5cGU6IE9ySU8oIFsgU3RyaW5nSU8sIE51bWJlcklPIF0gKVxyXG4gICAgfSApO1xyXG4gKlxyXG4gKiBAYXV0aG9yIE1pY2hhZWwgS2F1em1hbm4gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFZhbGlkYXRpb24gZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9WYWxpZGF0aW9uLmpzJztcclxuaW1wb3J0IEludGVudGlvbmFsQW55IGZyb20gJy4uLy4uLy4uL3BoZXQtY29yZS9qcy90eXBlcy9JbnRlbnRpb25hbEFueS5qcyc7XHJcbmltcG9ydCB0YW5kZW1OYW1lc3BhY2UgZnJvbSAnLi4vdGFuZGVtTmFtZXNwYWNlLmpzJztcclxuaW1wb3J0IElPVHlwZSBmcm9tICcuL0lPVHlwZS5qcyc7XHJcbmltcG9ydCBTdGF0ZVNjaGVtYSBmcm9tICcuL1N0YXRlU2NoZW1hLmpzJztcclxuXHJcbi8vIGNhY2hlIGVhY2ggcGFyYW1ldGVyaXplZCBJT1R5cGUgc28gdGhhdCBpdCBpcyBvbmx5IGNyZWF0ZWQgb25jZVxyXG5jb25zdCBjYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBJT1R5cGU+KCk7XHJcblxyXG4vKipcclxuICogUGFyYW1ldHJpYyB0eXBlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBkbyBub3QgdXNlIGBuZXdgXHJcbiAqIEBwYXJhbSBwYXJhbWV0ZXJUeXBlcyAtIGEgbGlzdCBvZiBJTyBUeXBlIHRvIGNvbWJpbmUgaW50byBhIHNpbmdsZSBjb21wb3NpdGVcclxuICovXHJcbmNvbnN0IE9ySU8gPSAoIHBhcmFtZXRlclR5cGVzOiBJT1R5cGVbXSApOiBJT1R5cGUgPT4ge1xyXG4gIGFzc2VydCAmJiBhc3NlcnQoIEFycmF5LmlzQXJyYXkoIHBhcmFtZXRlclR5cGVzICksICdPcklPIG5lZWRzIHRvIGJlIGFuIGFycmF5JyApO1xyXG4gIGFzc2VydCAmJiBhc3NlcnQoIHBhcmFtZXRlclR5cGVzLmxlbmd0aCA+IDAsICdPcklPIG5lZWRzIHBhcmFtZXRlclR5cGVzJyApO1xyXG4gIGNvbnN0IHR5cGVOYW1lcyA9IHBhcmFtZXRlclR5cGVzLm1hcCggcGFyYW1ldGVyVHlwZSA9PiBwYXJhbWV0ZXJUeXBlLnR5cGVOYW1lICk7XHJcbiAgY29uc3Qga2V5ID0gdHlwZU5hbWVzLmpvaW4oICcsJyApO1xyXG5cclxuICBpZiAoICFjYWNoZS5oYXMoIGtleSApICkge1xyXG4gICAgY29uc3QgaXNWYWxpZFZhbHVlID0gKCBpbnN0YW5jZTogSW50ZW50aW9uYWxBbnkgKSA9PiB7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHBhcmFtZXRlclR5cGVzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIGNvbnN0IHBhcmFtZXRlclR5cGUgPSBwYXJhbWV0ZXJUeXBlc1sgaSBdO1xyXG4gICAgICAgIGlmICggVmFsaWRhdGlvbi5pc1ZhbHVlVmFsaWQoIGluc3RhbmNlLCBwYXJhbWV0ZXJUeXBlLnZhbGlkYXRvciApICkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICBjYWNoZS5zZXQoIGtleSwgbmV3IElPVHlwZSggYE9ySU88JHt0eXBlTmFtZXMuam9pbiggJywgJyApfT5gLCB7XHJcbiAgICAgIGRvY3VtZW50YXRpb246ICdBbiBJT1R5cGUgYWRkaW5nIHN1cHBvcnQgZm9yIGEgY29tcG9zaXRlIHR5cGUgdGhhdCBjYW4gYmUgYW55IG9mIGl0cyBwYXJhbWV0ZXJzLicsXHJcbiAgICAgIHBhcmFtZXRlclR5cGVzOiBwYXJhbWV0ZXJUeXBlcyxcclxuICAgICAgaXNWYWxpZFZhbHVlOiBpc1ZhbGlkVmFsdWUsXHJcblxyXG4gICAgICB0b1N0YXRlT2JqZWN0OiBpbnN0YW5jZSA9PiB7XHJcbiAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgcGFyYW1ldGVyVHlwZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJUeXBlID0gcGFyYW1ldGVyVHlwZXNbIGkgXTtcclxuICAgICAgICAgIGlmICggVmFsaWRhdGlvbi5pc1ZhbHVlVmFsaWQoIGluc3RhbmNlLCBwYXJhbWV0ZXJUeXBlLnZhbGlkYXRvciApICkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgIGluZGV4OiBpLFxyXG4gICAgICAgICAgICAgIHN0YXRlOiBwYXJhbWV0ZXJUeXBlLnRvU3RhdGVPYmplY3QoIGluc3RhbmNlIClcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCAnc29tZWhvdyB0aGUgaW5zdGFuY2Ugd2FzIG5vdCB2YWxpZCwgd2Ugc2hvdWxkIG5vdCBnZXQgaGVyZS4gV2h5IHdhcyBpc1ZhbGlkVmFsdWUgbm90IHVzZWQgYmVmb3JlIHRoaXMgc3RlcD8nICk7XHJcbiAgICAgIH0sXHJcblxyXG4gICAgICBmcm9tU3RhdGVPYmplY3Q6ICggc3RhdGVPYmplY3Q6IEludGVudGlvbmFsQW55ICkgPT4ge1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHN0YXRlT2JqZWN0Lmhhc093blByb3BlcnR5KCAnaW5kZXgnICksICdpbmRleCByZXF1aXJlZCBmb3IgZGVzZXJpYWxpemF0aW9uJyApO1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHN0YXRlT2JqZWN0Lmhhc093blByb3BlcnR5KCAnc3RhdGUnICksICdzdGF0ZSByZXF1aXJlZCBmb3IgZGVzZXJpYWxpemF0aW9uJyApO1xyXG4gICAgICAgIHJldHVybiBwYXJhbWV0ZXJUeXBlc1sgc3RhdGVPYmplY3QuaW5kZXggXS5mcm9tU3RhdGVPYmplY3QoIHN0YXRlT2JqZWN0LnN0YXRlICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHN0YXRlU2NoZW1hOiBTdGF0ZVNjaGVtYS5hc1ZhbHVlKCBgJHt0eXBlTmFtZXMuam9pbiggJ3wnICl9YCwge1xyXG4gICAgICAgIGlzVmFsaWRWYWx1ZTogc3RhdGVPYmplY3QgPT4ge1xyXG5cclxuICAgICAgICAgIC8vIENoZWNrIGJhc2VkIG9uIHRoZSBwYXJhbWV0ZXIgdGhhdCBzZXJpYWxpemVkIHRoZSBzdGF0ZVxyXG4gICAgICAgICAgaWYgKCB0eXBlb2Ygc3RhdGVPYmplY3QuaW5kZXggPT09ICdudW1iZXInICkge1xyXG4gICAgICAgICAgICByZXR1cm4gcGFyYW1ldGVyVHlwZXNbIHN0YXRlT2JqZWN0LmluZGV4IF0uaXNTdGF0ZU9iamVjdFZhbGlkKCBzdGF0ZU9iamVjdC5zdGF0ZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApXHJcbiAgICB9ICkgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBjYWNoZS5nZXQoIGtleSApITtcclxufTtcclxuXHJcbnRhbmRlbU5hbWVzcGFjZS5yZWdpc3RlciggJ09ySU8nLCBPcklPICk7XHJcbmV4cG9ydCBkZWZhdWx0IE9ySU87Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxVQUFVLE1BQU0sZ0NBQWdDO0FBRXZELE9BQU9DLGVBQWUsTUFBTSx1QkFBdUI7QUFDbkQsT0FBT0MsTUFBTSxNQUFNLGFBQWE7QUFDaEMsT0FBT0MsV0FBVyxNQUFNLGtCQUFrQjs7QUFFMUM7QUFDQSxNQUFNQyxLQUFLLEdBQUcsSUFBSUMsR0FBRyxDQUFpQixDQUFDOztBQUV2QztBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLElBQUksR0FBS0MsY0FBd0IsSUFBYztFQUNuREMsTUFBTSxJQUFJQSxNQUFNLENBQUVDLEtBQUssQ0FBQ0MsT0FBTyxDQUFFSCxjQUFlLENBQUMsRUFBRSwyQkFBNEIsQ0FBQztFQUNoRkMsTUFBTSxJQUFJQSxNQUFNLENBQUVELGNBQWMsQ0FBQ0ksTUFBTSxHQUFHLENBQUMsRUFBRSwyQkFBNEIsQ0FBQztFQUMxRSxNQUFNQyxTQUFTLEdBQUdMLGNBQWMsQ0FBQ00sR0FBRyxDQUFFQyxhQUFhLElBQUlBLGFBQWEsQ0FBQ0MsUUFBUyxDQUFDO0VBQy9FLE1BQU1DLEdBQUcsR0FBR0osU0FBUyxDQUFDSyxJQUFJLENBQUUsR0FBSSxDQUFDO0VBRWpDLElBQUssQ0FBQ2IsS0FBSyxDQUFDYyxHQUFHLENBQUVGLEdBQUksQ0FBQyxFQUFHO0lBQ3ZCLE1BQU1HLFlBQVksR0FBS0MsUUFBd0IsSUFBTTtNQUNuRCxLQUFNLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR2QsY0FBYyxDQUFDSSxNQUFNLEVBQUVVLENBQUMsRUFBRSxFQUFHO1FBQ2hELE1BQU1QLGFBQWEsR0FBR1AsY0FBYyxDQUFFYyxDQUFDLENBQUU7UUFDekMsSUFBS3JCLFVBQVUsQ0FBQ3NCLFlBQVksQ0FBRUYsUUFBUSxFQUFFTixhQUFhLENBQUNTLFNBQVUsQ0FBQyxFQUFHO1VBQ2xFLE9BQU8sSUFBSTtRQUNiO01BQ0Y7TUFDQSxPQUFPLEtBQUs7SUFDZCxDQUFDO0lBQ0RuQixLQUFLLENBQUNvQixHQUFHLENBQUVSLEdBQUcsRUFBRSxJQUFJZCxNQUFNLENBQUcsUUFBT1UsU0FBUyxDQUFDSyxJQUFJLENBQUUsSUFBSyxDQUFFLEdBQUUsRUFBRTtNQUM3RFEsYUFBYSxFQUFFLGtGQUFrRjtNQUNqR2xCLGNBQWMsRUFBRUEsY0FBYztNQUM5QlksWUFBWSxFQUFFQSxZQUFZO01BRTFCTyxhQUFhLEVBQUVOLFFBQVEsSUFBSTtRQUN6QixLQUFNLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR2QsY0FBYyxDQUFDSSxNQUFNLEVBQUVVLENBQUMsRUFBRSxFQUFHO1VBQ2hELE1BQU1QLGFBQWEsR0FBR1AsY0FBYyxDQUFFYyxDQUFDLENBQUU7VUFDekMsSUFBS3JCLFVBQVUsQ0FBQ3NCLFlBQVksQ0FBRUYsUUFBUSxFQUFFTixhQUFhLENBQUNTLFNBQVUsQ0FBQyxFQUFHO1lBQ2xFLE9BQU87Y0FDTEksS0FBSyxFQUFFTixDQUFDO2NBQ1JPLEtBQUssRUFBRWQsYUFBYSxDQUFDWSxhQUFhLENBQUVOLFFBQVM7WUFDL0MsQ0FBQztVQUNIO1FBQ0Y7UUFDQSxNQUFNLElBQUlTLEtBQUssQ0FBRSw2R0FBOEcsQ0FBQztNQUNsSSxDQUFDO01BRURDLGVBQWUsRUFBSUMsV0FBMkIsSUFBTTtRQUNsRHZCLE1BQU0sSUFBSUEsTUFBTSxDQUFFdUIsV0FBVyxDQUFDQyxjQUFjLENBQUUsT0FBUSxDQUFDLEVBQUUsb0NBQXFDLENBQUM7UUFDL0Z4QixNQUFNLElBQUlBLE1BQU0sQ0FBRXVCLFdBQVcsQ0FBQ0MsY0FBYyxDQUFFLE9BQVEsQ0FBQyxFQUFFLG9DQUFxQyxDQUFDO1FBQy9GLE9BQU96QixjQUFjLENBQUV3QixXQUFXLENBQUNKLEtBQUssQ0FBRSxDQUFDRyxlQUFlLENBQUVDLFdBQVcsQ0FBQ0gsS0FBTSxDQUFDO01BQ2pGLENBQUM7TUFDREssV0FBVyxFQUFFOUIsV0FBVyxDQUFDK0IsT0FBTyxDQUFHLEdBQUV0QixTQUFTLENBQUNLLElBQUksQ0FBRSxHQUFJLENBQUUsRUFBQyxFQUFFO1FBQzVERSxZQUFZLEVBQUVZLFdBQVcsSUFBSTtVQUUzQjtVQUNBLElBQUssT0FBT0EsV0FBVyxDQUFDSixLQUFLLEtBQUssUUFBUSxFQUFHO1lBQzNDLE9BQU9wQixjQUFjLENBQUV3QixXQUFXLENBQUNKLEtBQUssQ0FBRSxDQUFDUSxrQkFBa0IsQ0FBRUosV0FBVyxDQUFDSCxLQUFNLENBQUM7VUFDcEY7VUFDQSxPQUFPLEtBQUs7UUFDZDtNQUNGLENBQUU7SUFDSixDQUFFLENBQUUsQ0FBQztFQUNQO0VBRUEsT0FBT3hCLEtBQUssQ0FBQ2dDLEdBQUcsQ0FBRXBCLEdBQUksQ0FBQztBQUN6QixDQUFDO0FBRURmLGVBQWUsQ0FBQ29DLFFBQVEsQ0FBRSxNQUFNLEVBQUUvQixJQUFLLENBQUM7QUFDeEMsZUFBZUEsSUFBSSJ9