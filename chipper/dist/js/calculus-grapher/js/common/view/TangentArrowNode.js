// Copyright 2022-2023, University of Colorado Boulder

/**
 * TangentArrowNode is a double-headed arrow that represents the tangent of the original curve at a point.
 * It updates its angle and position, based on the tangentScrubber model.
 *
 *  @author Martin Veillette
 */

import optionize from '../../../../phet-core/js/optionize.js';
import calculusGrapher from '../../calculusGrapher.js';
import ArrowNode from '../../../../scenery-phet/js/ArrowNode.js';
import Multilink from '../../../../axon/js/Multilink.js';
export default class TangentArrowNode extends ArrowNode {
  constructor(tangentScrubber, chartTransform, providedOptions) {
    const options = optionize()({
      // SelfOptions
      arrowLength: 100,
      // ArrowNodeOptions
      fill: tangentScrubber.colorProperty,
      headWidth: 10,
      headHeight: 10,
      tailWidth: 2,
      fractionalHeadHeight: 0.5,
      stroke: null,
      doubleHead: true,
      pickable: false // optimization, see https://github.com/phetsims/calculus-grapher/issues/210
    }, providedOptions);

    // Initial arrow is horizontal: the middle of the arrow is located at 0,0
    super(-options.arrowLength / 2, 0, options.arrowLength / 2, 0, options);

    // Initial angle of the arrow in view coordinates
    let oldTheta = Math.atan(this.tipY / this.tipX);

    // Updates the position and orientation of the arrow if this Node is visible.
    // The double-headed arrow pivots around its center.
    const updateArrow = () => {
      if (this.visible) {
        const x = tangentScrubber.originalCurvePointProperty.value.x;
        const y = tangentScrubber.originalCurvePointProperty.value.y;
        const modelSlope = tangentScrubber.derivativeCurvePointProperty.value.y;

        // View position for the center of the tangent arrow
        const point = chartTransform.modelToViewXY(x, y);

        // We must convert the slope into viewCoordinates
        // Slope is dY/dX: (sign of viewSlope will have its sign flipped but that is expected)
        const viewSlope = modelSlope * chartTransform.modelToViewDeltaY(1) / chartTransform.modelToViewDeltaX(1);
        const thetaView = Math.atan(viewSlope);

        // Moves this point
        this.translation = point;

        // We rotate this node around in view coordinates, so model angles must be reversed
        // Fortunately thetaView already takes into account the fact that we are using an inverted y-axis
        this.rotateAround(point, thetaView - oldTheta);

        // Updates the value of old theta
        oldTheta = thetaView;
      }
    };

    // Update when this Node becomes visible.
    this.visibleProperty.link(visible => {
      visible && updateArrow();
    });
    chartTransform.changedEmitter.addListener(() => updateArrow());
    Multilink.multilink([tangentScrubber.xProperty, tangentScrubber.originalCurvePointProperty, tangentScrubber.derivativeCurvePointProperty], () => updateArrow());
    this.addLinkedElement(tangentScrubber, {
      tandem: options.tandem.createTandem(tangentScrubber.tandem.name)
    });
  }
}
calculusGrapher.register('TangentArrowNode', TangentArrowNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcHRpb25pemUiLCJjYWxjdWx1c0dyYXBoZXIiLCJBcnJvd05vZGUiLCJNdWx0aWxpbmsiLCJUYW5nZW50QXJyb3dOb2RlIiwiY29uc3RydWN0b3IiLCJ0YW5nZW50U2NydWJiZXIiLCJjaGFydFRyYW5zZm9ybSIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJhcnJvd0xlbmd0aCIsImZpbGwiLCJjb2xvclByb3BlcnR5IiwiaGVhZFdpZHRoIiwiaGVhZEhlaWdodCIsInRhaWxXaWR0aCIsImZyYWN0aW9uYWxIZWFkSGVpZ2h0Iiwic3Ryb2tlIiwiZG91YmxlSGVhZCIsInBpY2thYmxlIiwib2xkVGhldGEiLCJNYXRoIiwiYXRhbiIsInRpcFkiLCJ0aXBYIiwidXBkYXRlQXJyb3ciLCJ2aXNpYmxlIiwieCIsIm9yaWdpbmFsQ3VydmVQb2ludFByb3BlcnR5IiwidmFsdWUiLCJ5IiwibW9kZWxTbG9wZSIsImRlcml2YXRpdmVDdXJ2ZVBvaW50UHJvcGVydHkiLCJwb2ludCIsIm1vZGVsVG9WaWV3WFkiLCJ2aWV3U2xvcGUiLCJtb2RlbFRvVmlld0RlbHRhWSIsIm1vZGVsVG9WaWV3RGVsdGFYIiwidGhldGFWaWV3IiwidHJhbnNsYXRpb24iLCJyb3RhdGVBcm91bmQiLCJ2aXNpYmxlUHJvcGVydHkiLCJsaW5rIiwiY2hhbmdlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsIm11bHRpbGluayIsInhQcm9wZXJ0eSIsImFkZExpbmtlZEVsZW1lbnQiLCJ0YW5kZW0iLCJjcmVhdGVUYW5kZW0iLCJuYW1lIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJUYW5nZW50QXJyb3dOb2RlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIyLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFRhbmdlbnRBcnJvd05vZGUgaXMgYSBkb3VibGUtaGVhZGVkIGFycm93IHRoYXQgcmVwcmVzZW50cyB0aGUgdGFuZ2VudCBvZiB0aGUgb3JpZ2luYWwgY3VydmUgYXQgYSBwb2ludC5cclxuICogSXQgdXBkYXRlcyBpdHMgYW5nbGUgYW5kIHBvc2l0aW9uLCBiYXNlZCBvbiB0aGUgdGFuZ2VudFNjcnViYmVyIG1vZGVsLlxyXG4gKlxyXG4gKiAgQGF1dGhvciBNYXJ0aW4gVmVpbGxldHRlXHJcbiAqL1xyXG5cclxuaW1wb3J0IENoYXJ0VHJhbnNmb3JtIGZyb20gJy4uLy4uLy4uLy4uL2JhbWJvby9qcy9DaGFydFRyYW5zZm9ybS5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBjYWxjdWx1c0dyYXBoZXIgZnJvbSAnLi4vLi4vY2FsY3VsdXNHcmFwaGVyLmpzJztcclxuaW1wb3J0IEFycm93Tm9kZSwgeyBBcnJvd05vZGVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL0Fycm93Tm9kZS5qcyc7XHJcbmltcG9ydCBUYW5nZW50U2NydWJiZXIgZnJvbSAnLi4vbW9kZWwvVGFuZ2VudFNjcnViYmVyLmpzJztcclxuaW1wb3J0IFBpY2tSZXF1aXJlZCBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvdHlwZXMvUGlja1JlcXVpcmVkLmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICAvLyBMZW5ndGggZnJvbSB0aXAgdG8gdGlwLCBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgYXJyb3dMZW5ndGg/OiBudW1iZXI7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBUYW5nZW50QXJyb3dOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgUGlja1JlcXVpcmVkPEFycm93Tm9kZU9wdGlvbnMsICd0YW5kZW0nIHwgJ3Zpc2libGVQcm9wZXJ0eSc+O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGFuZ2VudEFycm93Tm9kZSBleHRlbmRzIEFycm93Tm9kZSB7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggdGFuZ2VudFNjcnViYmVyOiBUYW5nZW50U2NydWJiZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICBjaGFydFRyYW5zZm9ybTogQ2hhcnRUcmFuc2Zvcm0sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM6IFRhbmdlbnRBcnJvd05vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8VGFuZ2VudEFycm93Tm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBBcnJvd05vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBhcnJvd0xlbmd0aDogMTAwLFxyXG5cclxuICAgICAgLy8gQXJyb3dOb2RlT3B0aW9uc1xyXG4gICAgICBmaWxsOiB0YW5nZW50U2NydWJiZXIuY29sb3JQcm9wZXJ0eSxcclxuICAgICAgaGVhZFdpZHRoOiAxMCxcclxuICAgICAgaGVhZEhlaWdodDogMTAsXHJcbiAgICAgIHRhaWxXaWR0aDogMixcclxuICAgICAgZnJhY3Rpb25hbEhlYWRIZWlnaHQ6IDAuNSxcclxuICAgICAgc3Ryb2tlOiBudWxsLFxyXG4gICAgICBkb3VibGVIZWFkOiB0cnVlLFxyXG4gICAgICBwaWNrYWJsZTogZmFsc2UgLy8gb3B0aW1pemF0aW9uLCBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL2NhbGN1bHVzLWdyYXBoZXIvaXNzdWVzLzIxMFxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgLy8gSW5pdGlhbCBhcnJvdyBpcyBob3Jpem9udGFsOiB0aGUgbWlkZGxlIG9mIHRoZSBhcnJvdyBpcyBsb2NhdGVkIGF0IDAsMFxyXG4gICAgc3VwZXIoIC1vcHRpb25zLmFycm93TGVuZ3RoIC8gMiwgMCwgb3B0aW9ucy5hcnJvd0xlbmd0aCAvIDIsIDAsIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBJbml0aWFsIGFuZ2xlIG9mIHRoZSBhcnJvdyBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAgICBsZXQgb2xkVGhldGEgPSBNYXRoLmF0YW4oIHRoaXMudGlwWSAvIHRoaXMudGlwWCApO1xyXG5cclxuICAgIC8vIFVwZGF0ZXMgdGhlIHBvc2l0aW9uIGFuZCBvcmllbnRhdGlvbiBvZiB0aGUgYXJyb3cgaWYgdGhpcyBOb2RlIGlzIHZpc2libGUuXHJcbiAgICAvLyBUaGUgZG91YmxlLWhlYWRlZCBhcnJvdyBwaXZvdHMgYXJvdW5kIGl0cyBjZW50ZXIuXHJcbiAgICBjb25zdCB1cGRhdGVBcnJvdyA9ICgpID0+IHtcclxuICAgICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcbiAgICAgICAgY29uc3QgeCA9IHRhbmdlbnRTY3J1YmJlci5vcmlnaW5hbEN1cnZlUG9pbnRQcm9wZXJ0eS52YWx1ZS54O1xyXG4gICAgICAgIGNvbnN0IHkgPSB0YW5nZW50U2NydWJiZXIub3JpZ2luYWxDdXJ2ZVBvaW50UHJvcGVydHkudmFsdWUueTtcclxuICAgICAgICBjb25zdCBtb2RlbFNsb3BlID0gdGFuZ2VudFNjcnViYmVyLmRlcml2YXRpdmVDdXJ2ZVBvaW50UHJvcGVydHkudmFsdWUueTtcclxuXHJcbiAgICAgICAgLy8gVmlldyBwb3NpdGlvbiBmb3IgdGhlIGNlbnRlciBvZiB0aGUgdGFuZ2VudCBhcnJvd1xyXG4gICAgICAgIGNvbnN0IHBvaW50ID0gY2hhcnRUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdYWSggeCwgeSApO1xyXG5cclxuICAgICAgICAvLyBXZSBtdXN0IGNvbnZlcnQgdGhlIHNsb3BlIGludG8gdmlld0Nvb3JkaW5hdGVzXHJcbiAgICAgICAgLy8gU2xvcGUgaXMgZFkvZFg6IChzaWduIG9mIHZpZXdTbG9wZSB3aWxsIGhhdmUgaXRzIHNpZ24gZmxpcHBlZCBidXQgdGhhdCBpcyBleHBlY3RlZClcclxuICAgICAgICBjb25zdCB2aWV3U2xvcGUgPSBtb2RlbFNsb3BlICogY2hhcnRUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVkoIDEgKSAvXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhcnRUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdEZWx0YVgoIDEgKTtcclxuICAgICAgICBjb25zdCB0aGV0YVZpZXcgPSBNYXRoLmF0YW4oIHZpZXdTbG9wZSApO1xyXG5cclxuICAgICAgICAvLyBNb3ZlcyB0aGlzIHBvaW50XHJcbiAgICAgICAgdGhpcy50cmFuc2xhdGlvbiA9IHBvaW50O1xyXG5cclxuICAgICAgICAvLyBXZSByb3RhdGUgdGhpcyBub2RlIGFyb3VuZCBpbiB2aWV3IGNvb3JkaW5hdGVzLCBzbyBtb2RlbCBhbmdsZXMgbXVzdCBiZSByZXZlcnNlZFxyXG4gICAgICAgIC8vIEZvcnR1bmF0ZWx5IHRoZXRhVmlldyBhbHJlYWR5IHRha2VzIGludG8gYWNjb3VudCB0aGUgZmFjdCB0aGF0IHdlIGFyZSB1c2luZyBhbiBpbnZlcnRlZCB5LWF4aXNcclxuICAgICAgICB0aGlzLnJvdGF0ZUFyb3VuZCggcG9pbnQsIHRoZXRhVmlldyAtIG9sZFRoZXRhICk7XHJcblxyXG4gICAgICAgIC8vIFVwZGF0ZXMgdGhlIHZhbHVlIG9mIG9sZCB0aGV0YVxyXG4gICAgICAgIG9sZFRoZXRhID0gdGhldGFWaWV3O1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFVwZGF0ZSB3aGVuIHRoaXMgTm9kZSBiZWNvbWVzIHZpc2libGUuXHJcbiAgICB0aGlzLnZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHtcclxuICAgICAgdmlzaWJsZSAmJiB1cGRhdGVBcnJvdygpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGNoYXJ0VHJhbnNmb3JtLmNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB1cGRhdGVBcnJvdygpICk7XHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKFxyXG4gICAgICBbIHRhbmdlbnRTY3J1YmJlci54UHJvcGVydHksIHRhbmdlbnRTY3J1YmJlci5vcmlnaW5hbEN1cnZlUG9pbnRQcm9wZXJ0eSwgdGFuZ2VudFNjcnViYmVyLmRlcml2YXRpdmVDdXJ2ZVBvaW50UHJvcGVydHkgXSxcclxuICAgICAgKCkgPT4gdXBkYXRlQXJyb3coKSApO1xyXG5cclxuICAgIHRoaXMuYWRkTGlua2VkRWxlbWVudCggdGFuZ2VudFNjcnViYmVyLCB7XHJcbiAgICAgIHRhbmRlbTogb3B0aW9ucy50YW5kZW0uY3JlYXRlVGFuZGVtKCB0YW5nZW50U2NydWJiZXIudGFuZGVtLm5hbWUgKVxyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxuY2FsY3VsdXNHcmFwaGVyLnJlZ2lzdGVyKCAnVGFuZ2VudEFycm93Tm9kZScsIFRhbmdlbnRBcnJvd05vZGUgKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsT0FBT0EsU0FBUyxNQUFNLHVDQUF1QztBQUM3RCxPQUFPQyxlQUFlLE1BQU0sMEJBQTBCO0FBQ3RELE9BQU9DLFNBQVMsTUFBNEIsMENBQTBDO0FBR3RGLE9BQU9DLFNBQVMsTUFBTSxrQ0FBa0M7QUFVeEQsZUFBZSxNQUFNQyxnQkFBZ0IsU0FBU0YsU0FBUyxDQUFDO0VBRS9DRyxXQUFXQSxDQUFFQyxlQUFnQyxFQUNoQ0MsY0FBOEIsRUFDOUJDLGVBQXdDLEVBQUc7SUFFN0QsTUFBTUMsT0FBTyxHQUFHVCxTQUFTLENBQXlELENBQUMsQ0FBRTtNQUVuRjtNQUNBVSxXQUFXLEVBQUUsR0FBRztNQUVoQjtNQUNBQyxJQUFJLEVBQUVMLGVBQWUsQ0FBQ00sYUFBYTtNQUNuQ0MsU0FBUyxFQUFFLEVBQUU7TUFDYkMsVUFBVSxFQUFFLEVBQUU7TUFDZEMsU0FBUyxFQUFFLENBQUM7TUFDWkMsb0JBQW9CLEVBQUUsR0FBRztNQUN6QkMsTUFBTSxFQUFFLElBQUk7TUFDWkMsVUFBVSxFQUFFLElBQUk7TUFDaEJDLFFBQVEsRUFBRSxLQUFLLENBQUM7SUFDbEIsQ0FBQyxFQUFFWCxlQUFnQixDQUFDOztJQUVwQjtJQUNBLEtBQUssQ0FBRSxDQUFDQyxPQUFPLENBQUNDLFdBQVcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFRCxPQUFPLENBQUNDLFdBQVcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFRCxPQUFRLENBQUM7O0lBRXpFO0lBQ0EsSUFBSVcsUUFBUSxHQUFHQyxJQUFJLENBQUNDLElBQUksQ0FBRSxJQUFJLENBQUNDLElBQUksR0FBRyxJQUFJLENBQUNDLElBQUssQ0FBQzs7SUFFakQ7SUFDQTtJQUNBLE1BQU1DLFdBQVcsR0FBR0EsQ0FBQSxLQUFNO01BQ3hCLElBQUssSUFBSSxDQUFDQyxPQUFPLEVBQUc7UUFDbEIsTUFBTUMsQ0FBQyxHQUFHckIsZUFBZSxDQUFDc0IsMEJBQTBCLENBQUNDLEtBQUssQ0FBQ0YsQ0FBQztRQUM1RCxNQUFNRyxDQUFDLEdBQUd4QixlQUFlLENBQUNzQiwwQkFBMEIsQ0FBQ0MsS0FBSyxDQUFDQyxDQUFDO1FBQzVELE1BQU1DLFVBQVUsR0FBR3pCLGVBQWUsQ0FBQzBCLDRCQUE0QixDQUFDSCxLQUFLLENBQUNDLENBQUM7O1FBRXZFO1FBQ0EsTUFBTUcsS0FBSyxHQUFHMUIsY0FBYyxDQUFDMkIsYUFBYSxDQUFFUCxDQUFDLEVBQUVHLENBQUUsQ0FBQzs7UUFFbEQ7UUFDQTtRQUNBLE1BQU1LLFNBQVMsR0FBR0osVUFBVSxHQUFHeEIsY0FBYyxDQUFDNkIsaUJBQWlCLENBQUUsQ0FBRSxDQUFDLEdBQ2xEN0IsY0FBYyxDQUFDOEIsaUJBQWlCLENBQUUsQ0FBRSxDQUFDO1FBQ3ZELE1BQU1DLFNBQVMsR0FBR2pCLElBQUksQ0FBQ0MsSUFBSSxDQUFFYSxTQUFVLENBQUM7O1FBRXhDO1FBQ0EsSUFBSSxDQUFDSSxXQUFXLEdBQUdOLEtBQUs7O1FBRXhCO1FBQ0E7UUFDQSxJQUFJLENBQUNPLFlBQVksQ0FBRVAsS0FBSyxFQUFFSyxTQUFTLEdBQUdsQixRQUFTLENBQUM7O1FBRWhEO1FBQ0FBLFFBQVEsR0FBR2tCLFNBQVM7TUFDdEI7SUFDRixDQUFDOztJQUVEO0lBQ0EsSUFBSSxDQUFDRyxlQUFlLENBQUNDLElBQUksQ0FBRWhCLE9BQU8sSUFBSTtNQUNwQ0EsT0FBTyxJQUFJRCxXQUFXLENBQUMsQ0FBQztJQUMxQixDQUFFLENBQUM7SUFFSGxCLGNBQWMsQ0FBQ29DLGNBQWMsQ0FBQ0MsV0FBVyxDQUFFLE1BQU1uQixXQUFXLENBQUMsQ0FBRSxDQUFDO0lBQ2hFdEIsU0FBUyxDQUFDMEMsU0FBUyxDQUNqQixDQUFFdkMsZUFBZSxDQUFDd0MsU0FBUyxFQUFFeEMsZUFBZSxDQUFDc0IsMEJBQTBCLEVBQUV0QixlQUFlLENBQUMwQiw0QkFBNEIsQ0FBRSxFQUN2SCxNQUFNUCxXQUFXLENBQUMsQ0FBRSxDQUFDO0lBRXZCLElBQUksQ0FBQ3NCLGdCQUFnQixDQUFFekMsZUFBZSxFQUFFO01BQ3RDMEMsTUFBTSxFQUFFdkMsT0FBTyxDQUFDdUMsTUFBTSxDQUFDQyxZQUFZLENBQUUzQyxlQUFlLENBQUMwQyxNQUFNLENBQUNFLElBQUs7SUFDbkUsQ0FBRSxDQUFDO0VBQ0w7QUFDRjtBQUVBakQsZUFBZSxDQUFDa0QsUUFBUSxDQUFFLGtCQUFrQixFQUFFL0MsZ0JBQWlCLENBQUMifQ==