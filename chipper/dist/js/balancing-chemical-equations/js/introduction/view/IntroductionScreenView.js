// Copyright 2014-2023, University of Colorado Boulder

/**
 * Scene graph for the 'Introduction' screen.
 *
 * @author Vasily Shakhov (MLearner)
 */

import Dimension2 from '../../../../dot/js/Dimension2.js';
import ScreenView from '../../../../joist/js/ScreenView.js';
import ResetAllButton from '../../../../scenery-phet/js/buttons/ResetAllButton.js';
import FaceNode from '../../../../scenery-phet/js/FaceNode.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { HBox, Node, Text } from '../../../../scenery/js/imports.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import BCEConstants from '../../common/BCEConstants.js';
import BalancedRepresentation from '../../common/model/BalancedRepresentation.js';
import BalanceScalesNode from '../../common/view/BalanceScalesNode.js';
import BarChartsNode from '../../common/view/BarChartsNode.js';
import BoxesNode from '../../common/view/BoxesNode.js';
import EquationNode from '../../common/view/EquationNode.js';
import HorizontalAligner from '../../common/view/HorizontalAligner.js';
import EquationChoiceNode from './EquationChoiceNode.js';
import IntroductionViewProperties from './IntroductionViewProperties.js';
import ToolsComboBox from './ToolsComboBox.js';
import BalancingChemicalEquationsStrings from '../../BalancingChemicalEquationsStrings.js';
// constants
const BOX_SIZE = new Dimension2(285, 145);
const BOX_X_SPACING = 110; // horizontal spacing between boxes

export default class IntroductionScreenView extends ScreenView {
  constructor(model, tandem) {
    super({
      layoutBounds: BCEConstants.LAYOUT_BOUNDS,
      tandem: tandem
    });

    // view-specific Properties
    const viewProperties = new IntroductionViewProperties();

    // aligner for equation
    const aligner = new HorizontalAligner(this.layoutBounds.width, BOX_SIZE.width, BOX_X_SPACING);

    // boxes that show molecules corresponding to the equation coefficients
    const boxesNode = new BoxesNode(model.equationProperty, model.coefficientsRange, aligner, BOX_SIZE, BCEConstants.BOX_COLOR, viewProperties.reactantsBoxExpandedProperty, viewProperties.productsBoxExpandedProperty, {
      top: 180
    });
    this.addChild(boxesNode);

    // 'Tools' combo box, at upper-right
    const comboBoxParent = new Node();
    const toolsComboBox = new ToolsComboBox(viewProperties.balancedRepresentationProperty, comboBoxParent);
    const toolsControl = new HBox({
      spacing: 10,
      children: [new Text(BalancingChemicalEquationsStrings.toolsStringProperty, {
        font: new PhetFont(22),
        fontWeight: 'bold',
        maxWidth: 100
      }), toolsComboBox]
    });
    this.addChild(toolsControl);
    toolsControl.boundsProperty.link(bounds => {
      toolsControl.right = this.layoutBounds.right - 45;
      toolsControl.top = this.layoutBounds.top + 15;
    });

    // smiley face, top center, shown when equation is balanced
    const faceNode = new FaceNode(70, {
      centerX: this.layoutBounds.centerX,
      top: 15
    });
    this.addChild(faceNode);
    const updateFace = () => {
      faceNode.visible = model.equationProperty.value.balancedProperty.value;
    };
    model.equationProperty.link((newEquation, oldEquation) => {
      if (oldEquation) {
        oldEquation.balancedProperty.unlink(updateFace);
      }
      newEquation.balancedProperty.link(updateFace);
    });

    // interactive equation
    this.addChild(new EquationNode(model.equationProperty, model.coefficientsRange, aligner, {
      top: boxesNode.bottom + 20
    }));

    // control for choosing an equation
    const equationChoiceNode = new EquationChoiceNode(this.layoutBounds.width, model.equationProperty, model.choices, {
      bottom: this.layoutBounds.bottom - 10
    });
    this.addChild(equationChoiceNode);

    // Reset All button
    this.addChild(new ResetAllButton({
      listener: () => {
        model.reset();
        viewProperties.reset();
      },
      right: this.layoutBounds.right - 20,
      centerY: equationChoiceNode.centerY,
      scale: 0.8
    }));

    // Show the selected 'balanced' representation, create nodes on demand.
    const balancedParent = new Node(); // to maintain rendering order for combo box
    this.addChild(balancedParent);
    let barChartsNode;
    let balanceScalesNode;
    viewProperties.balancedRepresentationProperty.link(balancedRepresentation => {
      // bar chart
      if (!barChartsNode && balancedRepresentation === BalancedRepresentation.BAR_CHARTS) {
        barChartsNode = new BarChartsNode(model.equationProperty, aligner, {
          bottom: boxesNode.top - 10
        });
        balancedParent.addChild(barChartsNode);
      }
      if (barChartsNode) {
        barChartsNode.visible = balancedRepresentation === BalancedRepresentation.BAR_CHARTS;
      }

      // balance scales
      if (!balanceScalesNode && balancedRepresentation === BalancedRepresentation.BALANCE_SCALES) {
        balanceScalesNode = new BalanceScalesNode(model.equationProperty, aligner, {
          bottom: boxesNode.top - 10,
          dualFulcrumSpacing: 325
        }); // use special spacing for 2 fulcrums, see issue #91
        balancedParent.addChild(balanceScalesNode);
      }
      if (balanceScalesNode) {
        balanceScalesNode.visible = balancedRepresentation === BalancedRepresentation.BALANCE_SCALES;
      }
    });

    // add this last, so that combo box list is on top of everything else
    this.addChild(comboBoxParent);

    // show the answer when running in dev mode, bottom center
    if (phet.chipper.queryParameters.showAnswers) {
      const answerNode = new Text('', {
        font: new PhetFont(12),
        bottom: equationChoiceNode.top - 5
      });
      this.addChild(answerNode);
      model.equationProperty.link(equation => {
        answerNode.string = equation.getCoefficientsString();
        answerNode.centerX = this.layoutBounds.centerX;
      });
    }
  }
}
balancingChemicalEquations.register('IntroductionScreenView', IntroductionScreenView);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEaW1lbnNpb24yIiwiU2NyZWVuVmlldyIsIlJlc2V0QWxsQnV0dG9uIiwiRmFjZU5vZGUiLCJQaGV0Rm9udCIsIkhCb3giLCJOb2RlIiwiVGV4dCIsImJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIiwiQkNFQ29uc3RhbnRzIiwiQmFsYW5jZWRSZXByZXNlbnRhdGlvbiIsIkJhbGFuY2VTY2FsZXNOb2RlIiwiQmFyQ2hhcnRzTm9kZSIsIkJveGVzTm9kZSIsIkVxdWF0aW9uTm9kZSIsIkhvcml6b250YWxBbGlnbmVyIiwiRXF1YXRpb25DaG9pY2VOb2RlIiwiSW50cm9kdWN0aW9uVmlld1Byb3BlcnRpZXMiLCJUb29sc0NvbWJvQm94IiwiQmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnNTdHJpbmdzIiwiQk9YX1NJWkUiLCJCT1hfWF9TUEFDSU5HIiwiSW50cm9kdWN0aW9uU2NyZWVuVmlldyIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJ0YW5kZW0iLCJsYXlvdXRCb3VuZHMiLCJMQVlPVVRfQk9VTkRTIiwidmlld1Byb3BlcnRpZXMiLCJhbGlnbmVyIiwid2lkdGgiLCJib3hlc05vZGUiLCJlcXVhdGlvblByb3BlcnR5IiwiY29lZmZpY2llbnRzUmFuZ2UiLCJCT1hfQ09MT1IiLCJyZWFjdGFudHNCb3hFeHBhbmRlZFByb3BlcnR5IiwicHJvZHVjdHNCb3hFeHBhbmRlZFByb3BlcnR5IiwidG9wIiwiYWRkQ2hpbGQiLCJjb21ib0JveFBhcmVudCIsInRvb2xzQ29tYm9Cb3giLCJiYWxhbmNlZFJlcHJlc2VudGF0aW9uUHJvcGVydHkiLCJ0b29sc0NvbnRyb2wiLCJzcGFjaW5nIiwiY2hpbGRyZW4iLCJ0b29sc1N0cmluZ1Byb3BlcnR5IiwiZm9udCIsImZvbnRXZWlnaHQiLCJtYXhXaWR0aCIsImJvdW5kc1Byb3BlcnR5IiwibGluayIsImJvdW5kcyIsInJpZ2h0IiwiZmFjZU5vZGUiLCJjZW50ZXJYIiwidXBkYXRlRmFjZSIsInZpc2libGUiLCJ2YWx1ZSIsImJhbGFuY2VkUHJvcGVydHkiLCJuZXdFcXVhdGlvbiIsIm9sZEVxdWF0aW9uIiwidW5saW5rIiwiYm90dG9tIiwiZXF1YXRpb25DaG9pY2VOb2RlIiwiY2hvaWNlcyIsImxpc3RlbmVyIiwicmVzZXQiLCJjZW50ZXJZIiwic2NhbGUiLCJiYWxhbmNlZFBhcmVudCIsImJhckNoYXJ0c05vZGUiLCJiYWxhbmNlU2NhbGVzTm9kZSIsImJhbGFuY2VkUmVwcmVzZW50YXRpb24iLCJCQVJfQ0hBUlRTIiwiQkFMQU5DRV9TQ0FMRVMiLCJkdWFsRnVsY3J1bVNwYWNpbmciLCJwaGV0IiwiY2hpcHBlciIsInF1ZXJ5UGFyYW1ldGVycyIsInNob3dBbnN3ZXJzIiwiYW5zd2VyTm9kZSIsImVxdWF0aW9uIiwic3RyaW5nIiwiZ2V0Q29lZmZpY2llbnRzU3RyaW5nIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJJbnRyb2R1Y3Rpb25TY3JlZW5WaWV3LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE0LTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNjZW5lIGdyYXBoIGZvciB0aGUgJ0ludHJvZHVjdGlvbicgc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFZhc2lseSBTaGFraG92IChNTGVhcm5lcilcclxuICovXHJcblxyXG5pbXBvcnQgRGltZW5zaW9uMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvRGltZW5zaW9uMi5qcyc7XHJcbmltcG9ydCBTY3JlZW5WaWV3IGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1NjcmVlblZpZXcuanMnO1xyXG5pbXBvcnQgUmVzZXRBbGxCdXR0b24gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1dHRvbnMvUmVzZXRBbGxCdXR0b24uanMnO1xyXG5pbXBvcnQgRmFjZU5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL0ZhY2VOb2RlLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IEhCb3gsIE5vZGUsIFRleHQgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMgZnJvbSAnLi4vLi4vYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMuanMnO1xyXG5pbXBvcnQgQkNFQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9CQ0VDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgQmFsYW5jZWRSZXByZXNlbnRhdGlvbiBmcm9tICcuLi8uLi9jb21tb24vbW9kZWwvQmFsYW5jZWRSZXByZXNlbnRhdGlvbi5qcyc7XHJcbmltcG9ydCBCYWxhbmNlU2NhbGVzTm9kZSBmcm9tICcuLi8uLi9jb21tb24vdmlldy9CYWxhbmNlU2NhbGVzTm9kZS5qcyc7XHJcbmltcG9ydCBCYXJDaGFydHNOb2RlIGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L0JhckNoYXJ0c05vZGUuanMnO1xyXG5pbXBvcnQgQm94ZXNOb2RlIGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L0JveGVzTm9kZS5qcyc7XHJcbmltcG9ydCBFcXVhdGlvbk5vZGUgZnJvbSAnLi4vLi4vY29tbW9uL3ZpZXcvRXF1YXRpb25Ob2RlLmpzJztcclxuaW1wb3J0IEhvcml6b250YWxBbGlnbmVyIGZyb20gJy4uLy4uL2NvbW1vbi92aWV3L0hvcml6b250YWxBbGlnbmVyLmpzJztcclxuaW1wb3J0IEVxdWF0aW9uQ2hvaWNlTm9kZSBmcm9tICcuL0VxdWF0aW9uQ2hvaWNlTm9kZS5qcyc7XHJcbmltcG9ydCBJbnRyb2R1Y3Rpb25WaWV3UHJvcGVydGllcyBmcm9tICcuL0ludHJvZHVjdGlvblZpZXdQcm9wZXJ0aWVzLmpzJztcclxuaW1wb3J0IFRvb2xzQ29tYm9Cb3ggZnJvbSAnLi9Ub29sc0NvbWJvQm94LmpzJztcclxuaW1wb3J0IEJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zU3RyaW5ncyBmcm9tICcuLi8uLi9CYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9uc1N0cmluZ3MuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgSW50cm9kdWN0aW9uTW9kZWwgZnJvbSAnLi4vbW9kZWwvSW50cm9kdWN0aW9uTW9kZWwuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEJPWF9TSVpFID0gbmV3IERpbWVuc2lvbjIoIDI4NSwgMTQ1ICk7XHJcbmNvbnN0IEJPWF9YX1NQQUNJTkcgPSAxMTA7IC8vIGhvcml6b250YWwgc3BhY2luZyBiZXR3ZWVuIGJveGVzXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnRyb2R1Y3Rpb25TY3JlZW5WaWV3IGV4dGVuZHMgU2NyZWVuVmlldyB7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggbW9kZWw6IEludHJvZHVjdGlvbk1vZGVsLCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICBsYXlvdXRCb3VuZHM6IEJDRUNvbnN0YW50cy5MQVlPVVRfQk9VTkRTLFxyXG4gICAgICB0YW5kZW06IHRhbmRlbVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHZpZXctc3BlY2lmaWMgUHJvcGVydGllc1xyXG4gICAgY29uc3Qgdmlld1Byb3BlcnRpZXMgPSBuZXcgSW50cm9kdWN0aW9uVmlld1Byb3BlcnRpZXMoKTtcclxuXHJcbiAgICAvLyBhbGlnbmVyIGZvciBlcXVhdGlvblxyXG4gICAgY29uc3QgYWxpZ25lciA9IG5ldyBIb3Jpem9udGFsQWxpZ25lciggdGhpcy5sYXlvdXRCb3VuZHMud2lkdGgsIEJPWF9TSVpFLndpZHRoLCBCT1hfWF9TUEFDSU5HICk7XHJcblxyXG4gICAgLy8gYm94ZXMgdGhhdCBzaG93IG1vbGVjdWxlcyBjb3JyZXNwb25kaW5nIHRvIHRoZSBlcXVhdGlvbiBjb2VmZmljaWVudHNcclxuICAgIGNvbnN0IGJveGVzTm9kZSA9IG5ldyBCb3hlc05vZGUoIG1vZGVsLmVxdWF0aW9uUHJvcGVydHksIG1vZGVsLmNvZWZmaWNpZW50c1JhbmdlLCBhbGlnbmVyLFxyXG4gICAgICBCT1hfU0laRSwgQkNFQ29uc3RhbnRzLkJPWF9DT0xPUiwgdmlld1Byb3BlcnRpZXMucmVhY3RhbnRzQm94RXhwYW5kZWRQcm9wZXJ0eSwgdmlld1Byb3BlcnRpZXMucHJvZHVjdHNCb3hFeHBhbmRlZFByb3BlcnR5LFxyXG4gICAgICB7IHRvcDogMTgwIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGJveGVzTm9kZSApO1xyXG5cclxuICAgIC8vICdUb29scycgY29tYm8gYm94LCBhdCB1cHBlci1yaWdodFxyXG4gICAgY29uc3QgY29tYm9Cb3hQYXJlbnQgPSBuZXcgTm9kZSgpO1xyXG4gICAgY29uc3QgdG9vbHNDb21ib0JveCA9IG5ldyBUb29sc0NvbWJvQm94KCB2aWV3UHJvcGVydGllcy5iYWxhbmNlZFJlcHJlc2VudGF0aW9uUHJvcGVydHksIGNvbWJvQm94UGFyZW50ICk7XHJcbiAgICBjb25zdCB0b29sc0NvbnRyb2wgPSBuZXcgSEJveCgge1xyXG4gICAgICBzcGFjaW5nOiAxMCxcclxuICAgICAgY2hpbGRyZW46IFtcclxuICAgICAgICBuZXcgVGV4dCggQmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnNTdHJpbmdzLnRvb2xzU3RyaW5nUHJvcGVydHksIHtcclxuICAgICAgICAgIGZvbnQ6IG5ldyBQaGV0Rm9udCggMjIgKSxcclxuICAgICAgICAgIGZvbnRXZWlnaHQ6ICdib2xkJyxcclxuICAgICAgICAgIG1heFdpZHRoOiAxMDBcclxuICAgICAgICB9ICksXHJcbiAgICAgICAgdG9vbHNDb21ib0JveFxyXG4gICAgICBdXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0b29sc0NvbnRyb2wgKTtcclxuXHJcbiAgICB0b29sc0NvbnRyb2wuYm91bmRzUHJvcGVydHkubGluayggYm91bmRzID0+IHtcclxuICAgICAgdG9vbHNDb250cm9sLnJpZ2h0ID0gdGhpcy5sYXlvdXRCb3VuZHMucmlnaHQgLSA0NTtcclxuICAgICAgdG9vbHNDb250cm9sLnRvcCA9IHRoaXMubGF5b3V0Qm91bmRzLnRvcCArIDE1O1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIHNtaWxleSBmYWNlLCB0b3AgY2VudGVyLCBzaG93biB3aGVuIGVxdWF0aW9uIGlzIGJhbGFuY2VkXHJcbiAgICBjb25zdCBmYWNlTm9kZSA9IG5ldyBGYWNlTm9kZSggNzAsIHsgY2VudGVyWDogdGhpcy5sYXlvdXRCb3VuZHMuY2VudGVyWCwgdG9wOiAxNSB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCBmYWNlTm9kZSApO1xyXG4gICAgY29uc3QgdXBkYXRlRmFjZSA9ICgpID0+IHtcclxuICAgICAgZmFjZU5vZGUudmlzaWJsZSA9IG1vZGVsLmVxdWF0aW9uUHJvcGVydHkudmFsdWUuYmFsYW5jZWRQcm9wZXJ0eS52YWx1ZTtcclxuICAgIH07XHJcbiAgICBtb2RlbC5lcXVhdGlvblByb3BlcnR5LmxpbmsoICggbmV3RXF1YXRpb24sIG9sZEVxdWF0aW9uICkgPT4ge1xyXG4gICAgICBpZiAoIG9sZEVxdWF0aW9uICkgeyBvbGRFcXVhdGlvbi5iYWxhbmNlZFByb3BlcnR5LnVubGluayggdXBkYXRlRmFjZSApOyB9XHJcbiAgICAgIG5ld0VxdWF0aW9uLmJhbGFuY2VkUHJvcGVydHkubGluayggdXBkYXRlRmFjZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGludGVyYWN0aXZlIGVxdWF0aW9uXHJcbiAgICB0aGlzLmFkZENoaWxkKCBuZXcgRXF1YXRpb25Ob2RlKCBtb2RlbC5lcXVhdGlvblByb3BlcnR5LCBtb2RlbC5jb2VmZmljaWVudHNSYW5nZSwgYWxpZ25lciwge1xyXG4gICAgICB0b3A6IGJveGVzTm9kZS5ib3R0b20gKyAyMFxyXG4gICAgfSApICk7XHJcblxyXG4gICAgLy8gY29udHJvbCBmb3IgY2hvb3NpbmcgYW4gZXF1YXRpb25cclxuICAgIGNvbnN0IGVxdWF0aW9uQ2hvaWNlTm9kZSA9IG5ldyBFcXVhdGlvbkNob2ljZU5vZGUoIHRoaXMubGF5b3V0Qm91bmRzLndpZHRoLCBtb2RlbC5lcXVhdGlvblByb3BlcnR5LCBtb2RlbC5jaG9pY2VzLCB7XHJcbiAgICAgIGJvdHRvbTogdGhpcy5sYXlvdXRCb3VuZHMuYm90dG9tIC0gMTBcclxuICAgIH0gKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGVxdWF0aW9uQ2hvaWNlTm9kZSApO1xyXG5cclxuICAgIC8vIFJlc2V0IEFsbCBidXR0b25cclxuICAgIHRoaXMuYWRkQ2hpbGQoIG5ldyBSZXNldEFsbEJ1dHRvbigge1xyXG4gICAgICBsaXN0ZW5lcjogKCkgPT4ge1xyXG4gICAgICAgIG1vZGVsLnJlc2V0KCk7XHJcbiAgICAgICAgdmlld1Byb3BlcnRpZXMucmVzZXQoKTtcclxuICAgICAgfSxcclxuICAgICAgcmlnaHQ6IHRoaXMubGF5b3V0Qm91bmRzLnJpZ2h0IC0gMjAsXHJcbiAgICAgIGNlbnRlclk6IGVxdWF0aW9uQ2hvaWNlTm9kZS5jZW50ZXJZLFxyXG4gICAgICBzY2FsZTogMC44XHJcbiAgICB9ICkgKTtcclxuXHJcbiAgICAvLyBTaG93IHRoZSBzZWxlY3RlZCAnYmFsYW5jZWQnIHJlcHJlc2VudGF0aW9uLCBjcmVhdGUgbm9kZXMgb24gZGVtYW5kLlxyXG4gICAgY29uc3QgYmFsYW5jZWRQYXJlbnQgPSBuZXcgTm9kZSgpOyAvLyB0byBtYWludGFpbiByZW5kZXJpbmcgb3JkZXIgZm9yIGNvbWJvIGJveFxyXG4gICAgdGhpcy5hZGRDaGlsZCggYmFsYW5jZWRQYXJlbnQgKTtcclxuICAgIGxldCBiYXJDaGFydHNOb2RlOiBCYXJDaGFydHNOb2RlO1xyXG4gICAgbGV0IGJhbGFuY2VTY2FsZXNOb2RlOiBCYWxhbmNlU2NhbGVzTm9kZTtcclxuICAgIHZpZXdQcm9wZXJ0aWVzLmJhbGFuY2VkUmVwcmVzZW50YXRpb25Qcm9wZXJ0eS5saW5rKCBiYWxhbmNlZFJlcHJlc2VudGF0aW9uID0+IHtcclxuXHJcbiAgICAgIC8vIGJhciBjaGFydFxyXG4gICAgICBpZiAoICFiYXJDaGFydHNOb2RlICYmIGJhbGFuY2VkUmVwcmVzZW50YXRpb24gPT09IEJhbGFuY2VkUmVwcmVzZW50YXRpb24uQkFSX0NIQVJUUyApIHtcclxuICAgICAgICBiYXJDaGFydHNOb2RlID0gbmV3IEJhckNoYXJ0c05vZGUoIG1vZGVsLmVxdWF0aW9uUHJvcGVydHksIGFsaWduZXIsIHtcclxuICAgICAgICAgIGJvdHRvbTogYm94ZXNOb2RlLnRvcCAtIDEwXHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIGJhbGFuY2VkUGFyZW50LmFkZENoaWxkKCBiYXJDaGFydHNOb2RlICk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCBiYXJDaGFydHNOb2RlICkge1xyXG4gICAgICAgIGJhckNoYXJ0c05vZGUudmlzaWJsZSA9ICggYmFsYW5jZWRSZXByZXNlbnRhdGlvbiA9PT0gQmFsYW5jZWRSZXByZXNlbnRhdGlvbi5CQVJfQ0hBUlRTICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGJhbGFuY2Ugc2NhbGVzXHJcbiAgICAgIGlmICggIWJhbGFuY2VTY2FsZXNOb2RlICYmIGJhbGFuY2VkUmVwcmVzZW50YXRpb24gPT09IEJhbGFuY2VkUmVwcmVzZW50YXRpb24uQkFMQU5DRV9TQ0FMRVMgKSB7XHJcbiAgICAgICAgYmFsYW5jZVNjYWxlc05vZGUgPSBuZXcgQmFsYW5jZVNjYWxlc05vZGUoIG1vZGVsLmVxdWF0aW9uUHJvcGVydHksIGFsaWduZXIsXHJcbiAgICAgICAgICB7IGJvdHRvbTogYm94ZXNOb2RlLnRvcCAtIDEwLCBkdWFsRnVsY3J1bVNwYWNpbmc6IDMyNSB9ICk7ICAvLyB1c2Ugc3BlY2lhbCBzcGFjaW5nIGZvciAyIGZ1bGNydW1zLCBzZWUgaXNzdWUgIzkxXHJcbiAgICAgICAgYmFsYW5jZWRQYXJlbnQuYWRkQ2hpbGQoIGJhbGFuY2VTY2FsZXNOb2RlICk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCBiYWxhbmNlU2NhbGVzTm9kZSApIHtcclxuICAgICAgICBiYWxhbmNlU2NhbGVzTm9kZS52aXNpYmxlID0gKCBiYWxhbmNlZFJlcHJlc2VudGF0aW9uID09PSBCYWxhbmNlZFJlcHJlc2VudGF0aW9uLkJBTEFOQ0VfU0NBTEVTICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBhZGQgdGhpcyBsYXN0LCBzbyB0aGF0IGNvbWJvIGJveCBsaXN0IGlzIG9uIHRvcCBvZiBldmVyeXRoaW5nIGVsc2VcclxuICAgIHRoaXMuYWRkQ2hpbGQoIGNvbWJvQm94UGFyZW50ICk7XHJcblxyXG4gICAgLy8gc2hvdyB0aGUgYW5zd2VyIHdoZW4gcnVubmluZyBpbiBkZXYgbW9kZSwgYm90dG9tIGNlbnRlclxyXG4gICAgaWYgKCBwaGV0LmNoaXBwZXIucXVlcnlQYXJhbWV0ZXJzLnNob3dBbnN3ZXJzICkge1xyXG4gICAgICBjb25zdCBhbnN3ZXJOb2RlID0gbmV3IFRleHQoICcnLCB7IGZvbnQ6IG5ldyBQaGV0Rm9udCggMTIgKSwgYm90dG9tOiBlcXVhdGlvbkNob2ljZU5vZGUudG9wIC0gNSB9ICk7XHJcbiAgICAgIHRoaXMuYWRkQ2hpbGQoIGFuc3dlck5vZGUgKTtcclxuICAgICAgbW9kZWwuZXF1YXRpb25Qcm9wZXJ0eS5saW5rKCBlcXVhdGlvbiA9PiB7XHJcbiAgICAgICAgYW5zd2VyTm9kZS5zdHJpbmcgPSBlcXVhdGlvbi5nZXRDb2VmZmljaWVudHNTdHJpbmcoKTtcclxuICAgICAgICBhbnN3ZXJOb2RlLmNlbnRlclggPSB0aGlzLmxheW91dEJvdW5kcy5jZW50ZXJYO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5iYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucy5yZWdpc3RlciggJ0ludHJvZHVjdGlvblNjcmVlblZpZXcnLCBJbnRyb2R1Y3Rpb25TY3JlZW5W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