// Copyright 2014-2023, University of Colorado Boulder

/**
 * Scene graph for the 'Balancing game' screen.
 *
 * @author Vasily Shakhov (MLearner)
 */

import ScreenView from '../../../../joist/js/ScreenView.js';
import { Node } from '../../../../scenery/js/imports.js';
import GameAudioPlayer from '../../../../vegas/js/GameAudioPlayer.js';
import LevelCompletedNode from '../../../../vegas/js/LevelCompletedNode.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import BCEConstants from '../../common/BCEConstants.js';
import BCEQueryParameters from '../../common/BCEQueryParameters.js';
import GameState from '../model/GameState.js';
import BCERewardNode from './BCERewardNode.js';
import GamePlayNode from './GamePlayNode.js';
import GameViewProperties from './GameViewProperties.js';
import LevelSelectionNode from './LevelSelectionNode.js';
export default class GameScreenView extends ScreenView {
  // parent for all game-related nodes

  // game-play interface, created on demand

  // created on demand

  constructor(model, tandem) {
    super({
      layoutBounds: BCEConstants.LAYOUT_BOUNDS,
      tandem: tandem
    });
    this.model = model;
    this.viewProperties = new GameViewProperties();
    this.audioPlayer = new GameAudioPlayer();
    this.rootNode = new Node();
    this.addChild(this.rootNode);
    this.levelSelectionNode = new LevelSelectionNode(this.model, this.viewProperties, this.layoutBounds, this.initStartGame.bind(this), tandem.createTandem('levelSelectionNode'));
    this.levelSelectionNode.visible = model.stateProperty.value === GameState.LEVEL_SELECTION;
    this.rootNode.addChild(this.levelSelectionNode);
    this.gamePlayNode = null;
    this.rewardNode = null;

    // Call an initializer to set up the game for the state.
    model.stateProperty.link(state => {
      if (state === GameState.LEVEL_SELECTION) {
        this.initLevelSelection();
      } else if (state === GameState.LEVEL_COMPLETED) {
        this.initLevelCompleted();
      }
    });
  }

  // No dispose needed, instances of this type persist for lifetime of the sim.

  step(dt) {
    if (this.rewardNode) {
      this.rewardNode.step(dt);
    }
    super.step(dt);
  }
  initLevelSelection() {
    if (this.gamePlayNode) {
      this.gamePlayNode.visible = false;
    }
    this.levelSelectionNode.visible = true;
  }

  /**
   * Performs initialization to start a game for a specified level.
   */
  initStartGame(level) {
    this.model.levelProperty.value = level;
    if (!this.gamePlayNode) {
      this.gamePlayNode = new GamePlayNode(this.model, this.viewProperties, this.audioPlayer, this.layoutBounds, this.visibleBoundsProperty);
      this.rootNode.addChild(this.gamePlayNode);
    }
    this.viewProperties.reactantsBoxExpandedProperty.reset();
    this.viewProperties.productsBoxExpandedProperty.reset();
    this.levelSelectionNode.visible = false;
    this.gamePlayNode.visible = true;
    this.model.startGame();
  }
  initLevelCompleted() {
    const level = this.model.levelProperty.value;
    this.levelSelectionNode.visible = false;
    if (this.gamePlayNode) {
      this.gamePlayNode.visible = false;
    }

    // game reward, shown for perfect score (or with 'reward' query parameter)
    if (this.model.isPerfectScore() || BCEQueryParameters.showReward) {
      this.rewardNode = new BCERewardNode(level);
      this.rootNode.addChild(this.rewardNode);
    }

    // bestTime on level, must be null to not show in popup
    const bestTimeOnThisLevel = this.model.bestTimeProperties[level].value === 0 ? null : this.model.bestTimeProperties[level].value;

    // Node displaying notification that the level has been completed
    const numberOfEquations = this.model.getNumberOfEquations(level);
    const levelCompletedNode = new LevelCompletedNode(level + 1, this.model.pointsProperty.value, this.model.getPerfectScore(level), numberOfEquations, this.viewProperties.timerEnabledProperty.value, this.model.timer.elapsedTimeProperty.value, bestTimeOnThisLevel, this.model.isNewBestTime,
    // function called when 'Continue' button is pressed
    () => {
      // remove the reward, if we have one
      if (this.rewardNode) {
        this.rootNode.removeChild(this.rewardNode);
        this.rewardNode.dispose();
        this.rewardNode = null;
      }
      // remove the level-completed notification
      this.rootNode.removeChild(levelCompletedNode);
      // go back to the level-selection screen
      this.model.stateProperty.value = GameState.LEVEL_SELECTION;
    }, {
      // LevelCompletedNode options
      starDiameter: Math.min(60, 300 / numberOfEquations),
      centerX: this.layoutBounds.centerX,
      centerY: this.layoutBounds.centerY,
      levelVisible: false,
      maxWidth: 0.85 * this.layoutBounds.width // constrain width for i18n
    });

    this.rootNode.addChild(levelCompletedNode);

    // Play the appropriate audio feedback.
    if (this.model.isPerfectScore()) {
      this.audioPlayer.gameOverPerfectScore();
    } else {
      this.audioPlayer.gameOverImperfectScore();
    }
  }
}
balancingChemicalEquations.register('GameScreenView', GameScreenView);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY3JlZW5WaWV3IiwiTm9kZSIsIkdhbWVBdWRpb1BsYXllciIsIkxldmVsQ29tcGxldGVkTm9kZSIsImJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIiwiQkNFQ29uc3RhbnRzIiwiQkNFUXVlcnlQYXJhbWV0ZXJzIiwiR2FtZVN0YXRlIiwiQkNFUmV3YXJkTm9kZSIsIkdhbWVQbGF5Tm9kZSIsIkdhbWVWaWV3UHJvcGVydGllcyIsIkxldmVsU2VsZWN0aW9uTm9kZSIsIkdhbWVTY3JlZW5WaWV3IiwiY29uc3RydWN0b3IiLCJtb2RlbCIsInRhbmRlbSIsImxheW91dEJvdW5kcyIsIkxBWU9VVF9CT1VORFMiLCJ2aWV3UHJvcGVydGllcyIsImF1ZGlvUGxheWVyIiwicm9vdE5vZGUiLCJhZGRDaGlsZCIsImxldmVsU2VsZWN0aW9uTm9kZSIsImluaXRTdGFydEdhbWUiLCJiaW5kIiwiY3JlYXRlVGFuZGVtIiwidmlzaWJsZSIsInN0YXRlUHJvcGVydHkiLCJ2YWx1ZSIsIkxFVkVMX1NFTEVDVElPTiIsImdhbWVQbGF5Tm9kZSIsInJld2FyZE5vZGUiLCJsaW5rIiwic3RhdGUiLCJpbml0TGV2ZWxTZWxlY3Rpb24iLCJMRVZFTF9DT01QTEVURUQiLCJpbml0TGV2ZWxDb21wbGV0ZWQiLCJzdGVwIiwiZHQiLCJsZXZlbCIsImxldmVsUHJvcGVydHkiLCJ2aXNpYmxlQm91bmRzUHJvcGVydHkiLCJyZWFjdGFudHNCb3hFeHBhbmRlZFByb3BlcnR5IiwicmVzZXQiLCJwcm9kdWN0c0JveEV4cGFuZGVkUHJvcGVydHkiLCJzdGFydEdhbWUiLCJpc1BlcmZlY3RTY29yZSIsInNob3dSZXdhcmQiLCJiZXN0VGltZU9uVGhpc0xldmVsIiwiYmVzdFRpbWVQcm9wZXJ0aWVzIiwibnVtYmVyT2ZFcXVhdGlvbnMiLCJnZXROdW1iZXJPZkVxdWF0aW9ucyIsImxldmVsQ29tcGxldGVkTm9kZSIsInBvaW50c1Byb3BlcnR5IiwiZ2V0UGVyZmVjdFNjb3JlIiwidGltZXJFbmFibGVkUHJvcGVydHkiLCJ0aW1lciIsImVsYXBzZWRUaW1lUHJvcGVydHkiLCJpc05ld0Jlc3RUaW1lIiwicmVtb3ZlQ2hpbGQiLCJkaXNwb3NlIiwic3RhckRpYW1ldGVyIiwiTWF0aCIsIm1pbiIsImNlbnRlclgiLCJjZW50ZXJZIiwibGV2ZWxWaXNpYmxlIiwibWF4V2lkdGgiLCJ3aWR0aCIsImdhbWVPdmVyUGVyZmVjdFNjb3JlIiwiZ2FtZU92ZXJJbXBlcmZlY3RTY29yZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiR2FtZVNjcmVlblZpZXcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogU2NlbmUgZ3JhcGggZm9yIHRoZSAnQmFsYW5jaW5nIGdhbWUnIHNjcmVlbi5cclxuICpcclxuICogQGF1dGhvciBWYXNpbHkgU2hha2hvdiAoTUxlYXJuZXIpXHJcbiAqL1xyXG5cclxuaW1wb3J0IFNjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvU2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCB7IE5vZGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgR2FtZUF1ZGlvUGxheWVyIGZyb20gJy4uLy4uLy4uLy4uL3ZlZ2FzL2pzL0dhbWVBdWRpb1BsYXllci5qcyc7XHJcbmltcG9ydCBMZXZlbENvbXBsZXRlZE5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vdmVnYXMvanMvTGV2ZWxDb21wbGV0ZWROb2RlLmpzJztcclxuaW1wb3J0IGJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIGZyb20gJy4uLy4uL2JhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zLmpzJztcclxuaW1wb3J0IEJDRUNvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vQkNFQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IEJDRVF1ZXJ5UGFyYW1ldGVycyBmcm9tICcuLi8uLi9jb21tb24vQkNFUXVlcnlQYXJhbWV0ZXJzLmpzJztcclxuaW1wb3J0IEdhbWVNb2RlbCBmcm9tICcuLi9tb2RlbC9HYW1lTW9kZWwuanMnO1xyXG5pbXBvcnQgR2FtZVN0YXRlIGZyb20gJy4uL21vZGVsL0dhbWVTdGF0ZS5qcyc7XHJcbmltcG9ydCBCQ0VSZXdhcmROb2RlIGZyb20gJy4vQkNFUmV3YXJkTm9kZS5qcyc7XHJcbmltcG9ydCBHYW1lUGxheU5vZGUgZnJvbSAnLi9HYW1lUGxheU5vZGUuanMnO1xyXG5pbXBvcnQgR2FtZVZpZXdQcm9wZXJ0aWVzIGZyb20gJy4vR2FtZVZpZXdQcm9wZXJ0aWVzLmpzJztcclxuaW1wb3J0IExldmVsU2VsZWN0aW9uTm9kZSBmcm9tICcuL0xldmVsU2VsZWN0aW9uTm9kZS5qcyc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHYW1lU2NyZWVuVmlldyBleHRlbmRzIFNjcmVlblZpZXcge1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgbW9kZWw6IEdhbWVNb2RlbDtcclxuICBwdWJsaWMgcmVhZG9ubHkgdmlld1Byb3BlcnRpZXM6IEdhbWVWaWV3UHJvcGVydGllcztcclxuICBwdWJsaWMgcmVhZG9ubHkgYXVkaW9QbGF5ZXI6IEdhbWVBdWRpb1BsYXllcjtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSByb290Tm9kZTogTm9kZTsgLy8gcGFyZW50IGZvciBhbGwgZ2FtZS1yZWxhdGVkIG5vZGVzXHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgbGV2ZWxTZWxlY3Rpb25Ob2RlOiBOb2RlO1xyXG4gIHByaXZhdGUgZ2FtZVBsYXlOb2RlOiBOb2RlIHwgbnVsbDsgLy8gZ2FtZS1wbGF5IGludGVyZmFjZSwgY3JlYXRlZCBvbiBkZW1hbmRcclxuXHJcbiAgcHJpdmF0ZSByZXdhcmROb2RlOiBCQ0VSZXdhcmROb2RlIHwgbnVsbDsgLy8gY3JlYXRlZCBvbiBkZW1hbmRcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBtb2RlbDogR2FtZU1vZGVsLCB0YW5kZW06IFRhbmRlbSApIHtcclxuXHJcbiAgICBzdXBlcigge1xyXG4gICAgICBsYXlvdXRCb3VuZHM6IEJDRUNvbnN0YW50cy5MQVlPVVRfQk9VTkRTLFxyXG4gICAgICB0YW5kZW06IHRhbmRlbVxyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuICAgIHRoaXMudmlld1Byb3BlcnRpZXMgPSBuZXcgR2FtZVZpZXdQcm9wZXJ0aWVzKCk7XHJcbiAgICB0aGlzLmF1ZGlvUGxheWVyID0gbmV3IEdhbWVBdWRpb1BsYXllcigpO1xyXG5cclxuICAgIHRoaXMucm9vdE5vZGUgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5yb290Tm9kZSApO1xyXG5cclxuICAgIHRoaXMubGV2ZWxTZWxlY3Rpb25Ob2RlID0gbmV3IExldmVsU2VsZWN0aW9uTm9kZSggdGhpcy5tb2RlbCwgdGhpcy52aWV3UHJvcGVydGllcywgdGhpcy5sYXlvdXRCb3VuZHMsXHJcbiAgICAgIHRoaXMuaW5pdFN0YXJ0R2FtZS5iaW5kKCB0aGlzICksIHRhbmRlbS5jcmVhdGVUYW5kZW0oICdsZXZlbFNlbGVjdGlvbk5vZGUnICkgKTtcclxuICAgIHRoaXMubGV2ZWxTZWxlY3Rpb25Ob2RlLnZpc2libGUgPSAoIG1vZGVsLnN0YXRlUHJvcGVydHkudmFsdWUgPT09IEdhbWVTdGF0ZS5MRVZFTF9TRUxFQ1RJT04gKTtcclxuICAgIHRoaXMucm9vdE5vZGUuYWRkQ2hpbGQoIHRoaXMubGV2ZWxTZWxlY3Rpb25Ob2RlICk7XHJcblxyXG4gICAgdGhpcy5nYW1lUGxheU5vZGUgPSBudWxsO1xyXG4gICAgdGhpcy5yZXdhcmROb2RlID0gbnVsbDtcclxuXHJcbiAgICAvLyBDYWxsIGFuIGluaXRpYWxpemVyIHRvIHNldCB1cCB0aGUgZ2FtZSBmb3IgdGhlIHN0YXRlLlxyXG4gICAgbW9kZWwuc3RhdGVQcm9wZXJ0eS5saW5rKCBzdGF0ZSA9PiB7XHJcbiAgICAgIGlmICggc3RhdGUgPT09IEdhbWVTdGF0ZS5MRVZFTF9TRUxFQ1RJT04gKSB7XHJcbiAgICAgICAgdGhpcy5pbml0TGV2ZWxTZWxlY3Rpb24oKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIGlmICggc3RhdGUgPT09IEdhbWVTdGF0ZS5MRVZFTF9DT01QTEVURUQgKSB7XHJcbiAgICAgICAgdGhpcy5pbml0TGV2ZWxDb21wbGV0ZWQoKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLy8gTm8gZGlzcG9zZSBuZWVkZWQsIGluc3RhbmNlcyBvZiB0aGlzIHR5cGUgcGVyc2lzdCBmb3IgbGlmZXRpbWUgb2YgdGhlIHNpbS5cclxuXHJcbiAgcHVibGljIG92ZXJyaWRlIHN0ZXAoIGR0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMucmV3YXJkTm9kZSApIHtcclxuICAgICAgdGhpcy5yZXdhcmROb2RlLnN0ZXAoIGR0ICk7XHJcbiAgICB9XHJcbiAgICBzdXBlci5zdGVwKCBkdCApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0TGV2ZWxTZWxlY3Rpb24oKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMuZ2FtZVBsYXlOb2RlICkgeyB0aGlzLmdhbWVQbGF5Tm9kZS52aXNpYmxlID0gZmFsc2U7IH1cclxuICAgIHRoaXMubGV2ZWxTZWxlY3Rpb25Ob2RlLnZpc2libGUgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGVyZm9ybXMgaW5pdGlhbGl6YXRpb24gdG8gc3RhcnQgYSBnYW1lIGZvciBhIHNwZWNpZmllZCBsZXZlbC5cclxuICAgKi9cclxuICBwcml2YXRlIGluaXRTdGFydEdhbWUoIGxldmVsOiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICB0aGlzLm1vZGVsLmxldmVsUHJvcGVydHkudmFsdWUgPSBsZXZlbDtcclxuICAgIGlmICggIXRoaXMuZ2FtZVBsYXlOb2RlICkge1xyXG4gICAgICB0aGlzLmdhbWVQbGF5Tm9kZSA9IG5ldyBHYW1lUGxheU5vZGUoIHRoaXMubW9kZWwsIHRoaXMudmlld1Byb3BlcnRpZXMsIHRoaXMuYXVkaW9QbGF5ZXIsXHJcbiAgICAgICAgdGhpcy5sYXlvdXRCb3VuZHMsIHRoaXMudmlzaWJsZUJvdW5kc1Byb3BlcnR5ICk7XHJcbiAgICAgIHRoaXMucm9vdE5vZGUuYWRkQ2hpbGQoIHRoaXMuZ2FtZVBsYXlOb2RlICk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnZpZXdQcm9wZXJ0aWVzLnJlYWN0YW50c0JveEV4cGFuZGVkUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMudmlld1Byb3BlcnRpZXMucHJvZHVjdHNCb3hFeHBhbmRlZFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmxldmVsU2VsZWN0aW9uTm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICB0aGlzLmdhbWVQbGF5Tm9kZS52aXNpYmxlID0gdHJ1ZTtcclxuICAgIHRoaXMubW9kZWwuc3RhcnRHYW1lKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRMZXZlbENvbXBsZXRlZCgpOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBsZXZlbCA9IHRoaXMubW9kZWwubGV2ZWxQcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICB0aGlzLmxldmVsU2VsZWN0aW9uTm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICBpZiAoIHRoaXMuZ2FtZVBsYXlOb2RlICkge1xyXG4gICAgICB0aGlzLmdhbWVQbGF5Tm9kZS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZ2FtZSByZXdhcmQsIHNob3duIGZvciBwZXJmZWN0IHNjb3JlIChvciB3aXRoICdyZXdhcmQnIHF1ZXJ5IHBhcmFtZXRlcilcclxuICAgIGlmICggdGhpcy5tb2RlbC5pc1BlcmZlY3RTY29yZSgpIHx8IEJDRVF1ZXJ5UGFyYW1ldGVycy5zaG93UmV3YXJkICkge1xyXG4gICAgICB0aGlzLnJld2FyZE5vZGUgPSBuZXcgQkNFUmV3YXJkTm9kZSggbGV2ZWwgKTtcclxuICAgICAgdGhpcy5yb290Tm9kZS5hZGRDaGlsZCggdGhpcy5yZXdhcmROb2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYmVzdFRpbWUgb24gbGV2ZWwsIG11c3QgYmUgbnVsbCB0byBub3Qgc2hvdyBpbiBwb3B1cFxyXG4gICAgY29uc3QgYmVzdFRpbWVPblRoaXNMZXZlbCA9IHRoaXMubW9kZWwuYmVzdFRpbWVQcm9wZXJ0aWVzWyBsZXZlbCBdLnZhbHVlID09PSAwID8gbnVsbCA6IHRoaXMubW9kZWwuYmVzdFRpbWVQcm9wZXJ0aWVzWyBsZXZlbCBdLnZhbHVlO1xyXG5cclxuICAgIC8vIE5vZGUgZGlzcGxheWluZyBub3RpZmljYXRpb24gdGhhdCB0aGUgbGV2ZWwgaGFzIGJlZW4gY29tcGxldGVkXHJcbiAgICBjb25zdCBudW1iZXJPZkVxdWF0aW9ucyA9IHRoaXMubW9kZWwuZ2V0TnVtYmVyT2ZFcXVhdGlvbnMoIGxldmVsICk7XHJcbiAgICBjb25zdCBsZXZlbENvbXBsZXRlZE5vZGUgPSBuZXcgTGV2ZWxDb21wbGV0ZWROb2RlKCBsZXZlbCArIDEsIHRoaXMubW9kZWwucG9pbnRzUHJvcGVydHkudmFsdWUsIHRoaXMubW9kZWwuZ2V0UGVyZmVjdFNjb3JlKCBsZXZlbCApLFxyXG4gICAgICBudW1iZXJPZkVxdWF0aW9ucywgdGhpcy52aWV3UHJvcGVydGllcy50aW1lckVuYWJsZWRQcm9wZXJ0eS52YWx1ZSxcclxuICAgICAgdGhpcy5tb2RlbC50aW1lci5lbGFwc2VkVGltZVByb3BlcnR5LnZhbHVlLCBiZXN0VGltZU9uVGhpc0xldmVsLCB0aGlzLm1vZGVsLmlzTmV3QmVzdFRpbWUsXHJcblxyXG4gICAgICAvLyBmdW5jdGlvbiBjYWxsZWQgd2hlbiAnQ29udGludWUnIGJ1dHRvbiBpcyBwcmVzc2VkXHJcbiAgICAgICgpID0+IHtcclxuICAgICAgICAvLyByZW1vdmUgdGhlIHJld2FyZCwgaWYgd2UgaGF2ZSBvbmVcclxuICAgICAgICBpZiAoIHRoaXMucmV3YXJkTm9kZSApIHtcclxuICAgICAgICAgIHRoaXMucm9vdE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMucmV3YXJkTm9kZSApO1xyXG4gICAgICAgICAgdGhpcy5yZXdhcmROb2RlLmRpc3Bvc2UoKTtcclxuICAgICAgICAgIHRoaXMucmV3YXJkTm9kZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHJlbW92ZSB0aGUgbGV2ZWwtY29tcGxldGVkIG5vdGlmaWNhdGlvblxyXG4gICAgICAgIHRoaXMucm9vdE5vZGUucmVtb3ZlQ2hpbGQoIGxldmVsQ29tcGxldGVkTm9kZSApO1xyXG4gICAgICAgIC8vIGdvIGJhY2sgdG8gdGhlIGxldmVsLXNlbGVjdGlvbiBzY3JlZW5cclxuICAgICAgICB0aGlzLm1vZGVsLnN0YXRlUHJvcGVydHkudmFsdWUgPSBHYW1lU3RhdGUuTEVWRUxfU0VMRUNUSU9OO1xyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgLy8gTGV2ZWxDb21wbGV0ZWROb2RlIG9wdGlvbnNcclxuICAgICAgICBzdGFyRGlhbWV0ZXI6IE1hdGgubWluKCA2MCwgMzAwIC8gbnVtYmVyT2ZFcXVhdGlvbnMgKSxcclxuICAgICAgICBjZW50ZXJYOiB0aGlzLmxheW91dEJvdW5kcy5jZW50ZXJYLFxyXG4gICAgICAgIGNlbnRlclk6IHRoaXMubGF5b3V0Qm91bmRzLmNlbnRlclksXHJcbiAgICAgICAgbGV2ZWxWaXNpYmxlOiBmYWxzZSxcclxuICAgICAgICBtYXhXaWR0aDogMC44NSAqIHRoaXMubGF5b3V0Qm91bmRzLndpZHRoIC8vIGNvbnN0cmFpbiB3aWR0aCBmb3IgaTE4blxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gICAgdGhpcy5yb290Tm9kZS5hZGRDaGlsZCggbGV2ZWxDb21wbGV0ZWROb2RlICk7XHJcblxyXG4gICAgLy8gUGxheSB0aGUgYXBwcm9wcmlhdGUgYXVkaW8gZmVlZGJhY2suXHJcbiAgICBpZiAoIHRoaXMubW9kZWwuaXNQZXJmZWN0U2NvcmUoKSApIHtcclxuICAgICAgdGhpcy5hdWRpb1BsYXllci5nYW1lT3ZlclBlcmZlY3RTY29yZSgpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHRoaXMuYXVkaW9QbGF5ZXIuZ2FtZU92ZXJJbXBlcmZlY3RTY29yZSgpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMucmVnaXN0ZXIoICdHYW1lU2NyZWVuVmlldycsIEdhbWVTY3JlZW5WaWV3ICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFVBQVUsTUFBTSxvQ0FBb0M7QUFDM0QsU0FBU0MsSUFBSSxRQUFRLG1DQUFtQztBQUV4RCxPQUFPQyxlQUFlLE1BQU0seUNBQXlDO0FBQ3JFLE9BQU9DLGtCQUFrQixNQUFNLDRDQUE0QztBQUMzRSxPQUFPQywwQkFBMEIsTUFBTSxxQ0FBcUM7QUFDNUUsT0FBT0MsWUFBWSxNQUFNLDhCQUE4QjtBQUN2RCxPQUFPQyxrQkFBa0IsTUFBTSxvQ0FBb0M7QUFFbkUsT0FBT0MsU0FBUyxNQUFNLHVCQUF1QjtBQUM3QyxPQUFPQyxhQUFhLE1BQU0sb0JBQW9CO0FBQzlDLE9BQU9DLFlBQVksTUFBTSxtQkFBbUI7QUFDNUMsT0FBT0Msa0JBQWtCLE1BQU0seUJBQXlCO0FBQ3hELE9BQU9DLGtCQUFrQixNQUFNLHlCQUF5QjtBQUV4RCxlQUFlLE1BQU1DLGNBQWMsU0FBU1osVUFBVSxDQUFDO0VBTXBCOztFQUdFOztFQUVPOztFQUVuQ2EsV0FBV0EsQ0FBRUMsS0FBZ0IsRUFBRUMsTUFBYyxFQUFHO0lBRXJELEtBQUssQ0FBRTtNQUNMQyxZQUFZLEVBQUVYLFlBQVksQ0FBQ1ksYUFBYTtNQUN4Q0YsTUFBTSxFQUFFQTtJQUNWLENBQUUsQ0FBQztJQUVILElBQUksQ0FBQ0QsS0FBSyxHQUFHQSxLQUFLO0lB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