// Copyright 2014-2023, University of Colorado Boulder

/**
 * Visual representation of an equation as a set of balance scales, one for each atom type.
 * The left side of each scale is the reactants, the right side is the products.
 *
 * This implementation is very brute force, just about everything is recreated each time
 * a coefficient is changed in the equations.  But we have a small number of coefficients,
 * and nothing else is happening in the sim.  So we're trading efficiency for simplicity of
 * implementation.
 *
 * @author Vasily Shakhov (mlearner.com)
 */

import NumberProperty from '../../../../axon/js/NumberProperty.js';
import { Node } from '../../../../scenery/js/imports.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import BalanceScaleNode from './BalanceScaleNode.js';
import optionize from '../../../../phet-core/js/optionize.js';
export default class BalanceScalesNode extends Node {
  // maps Element to count for that Element

  /**
   * @param equationProperty the equation that the scales are representing
   * @param aligner provides layout information to ensure horizontal alignment with other user-interface elements
   * @param [providedOptions]
   */
  constructor(equationProperty, aligner, providedOptions) {
    const options = optionize()({
      // SelfOptions
      fulcrumSpacing: 237,
      dualFulcrumSpacing: 237,
      // NodeOptions
      bottom: 0
    }, providedOptions);
    super();
    this.equationProperty = equationProperty;
    this.aligner = aligner;
    this.constantBottom = options.bottom;
    this.fulcrumSpacing = options.fulcrumSpacing;
    this.dualFulcrumSpacing = options.dualFulcrumSpacing;
    this.reactantCountProperties = new Map();
    this.productCountProperties = new Map();

    // Wire coefficients observer to current equation.
    const coefficientsObserver = this.updateCounts.bind(this);
    equationProperty.link((newEquation, oldEquation) => {
      this.updateNode();
      if (oldEquation) {
        oldEquation.removeCoefficientsObserver(coefficientsObserver);
      }
      newEquation.addCoefficientsObserver(coefficientsObserver);
    });
    this.mutate(options);

    // Update this Node when it becomes visible.
    this.visibleProperty.link(visible => visible && this.updateNode());
  }

  // No dispose needed, instances of this type persist for lifetime of the sim.

  /**
   * Updates this node's entire geometry and layout.
   */
  updateNode() {
    if (this.visible) {
      // dispose of children before calling removeAllChildren
      this.getChildren().forEach(child => {
        if (child.dispose) {
          child.dispose();
        }
      });

      // remove all nodes and clear the maps
      this.removeAllChildren();
      this.reactantCountProperties.clear();
      this.productCountProperties.clear();
      const atomCounts = this.equationProperty.value.getAtomCounts();
      const fulcrumSpacing = atomCounts.length === 2 ? this.dualFulcrumSpacing : this.fulcrumSpacing;
      let x = 0;
      for (let i = 0; i < atomCounts.length; i++) {
        const atomCount = atomCounts[i];

        // populate the maps
        const leftCountProperty = new NumberProperty(atomCount.reactantsCount, {
          numberType: 'Integer'
        });
        const rightCountProperty = new NumberProperty(atomCount.productsCount, {
          numberType: 'Integer'
        });
        this.reactantCountProperties.set(atomCount.element, leftCountProperty);
        this.productCountProperties.set(atomCount.element, rightCountProperty);

        // add a scale node
        const scaleNode = new BalanceScaleNode(atomCount.element, leftCountProperty, rightCountProperty, this.equationProperty.value.balancedProperty, {
          x: x
        });
        this.addChild(scaleNode);
        x += fulcrumSpacing;
      }
      this.centerX = this.aligner.getScreenCenterX();
      this.bottom = this.constantBottom;
      this.updateCounts();
    }
  }

  /**
   * Updates the atom counts for each scale.
   */
  updateCounts() {
    if (this.visible) {
      const atomCounts = this.equationProperty.value.getAtomCounts();
      for (let i = 0; i < atomCounts.length; i++) {
        const atomCount = atomCounts[i];
        const reactantCountProperty = this.reactantCountProperties.get(atomCount.element);
        assert && assert(reactantCountProperty);
        reactantCountProperty.value = atomCount.reactantsCount;
        const productCountProperty = this.productCountProperties.get(atomCount.element);
        assert && assert(productCountProperty);
        productCountProperty.value = atomCount.productsCount;
      }
    }
  }
}
balancingChemicalEquations.register('BalanceScalesNode', BalanceScalesNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOdW1iZXJQcm9wZXJ0eSIsIk5vZGUiLCJiYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucyIsIkJhbGFuY2VTY2FsZU5vZGUiLCJvcHRpb25pemUiLCJCYWxhbmNlU2NhbGVzTm9kZSIsImNvbnN0cnVjdG9yIiwiZXF1YXRpb25Qcm9wZXJ0eSIsImFsaWduZXIiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZnVsY3J1bVNwYWNpbmciLCJkdWFsRnVsY3J1bVNwYWNpbmciLCJib3R0b20iLCJjb25zdGFudEJvdHRvbSIsInJlYWN0YW50Q291bnRQcm9wZXJ0aWVzIiwiTWFwIiwicHJvZHVjdENvdW50UHJvcGVydGllcyIsImNvZWZmaWNpZW50c09ic2VydmVyIiwidXBkYXRlQ291bnRzIiwiYmluZCIsImxpbmsiLCJuZXdFcXVhdGlvbiIsIm9sZEVxdWF0aW9uIiwidXBkYXRlTm9kZSIsInJlbW92ZUNvZWZmaWNpZW50c09ic2VydmVyIiwiYWRkQ29lZmZpY2llbnRzT2JzZXJ2ZXIiLCJtdXRhdGUiLCJ2aXNpYmxlUHJvcGVydHkiLCJ2aXNpYmxlIiwiZ2V0Q2hpbGRyZW4iLCJmb3JFYWNoIiwiY2hpbGQiLCJkaXNwb3NlIiwicmVtb3ZlQWxsQ2hpbGRyZW4iLCJjbGVhciIsImF0b21Db3VudHMiLCJ2YWx1ZSIsImdldEF0b21Db3VudHMiLCJsZW5ndGgiLCJ4IiwiaSIsImF0b21Db3VudCIsImxlZnRDb3VudFByb3BlcnR5IiwicmVhY3RhbnRzQ291bnQiLCJudW1iZXJUeXBlIiwicmlnaHRDb3VudFByb3BlcnR5IiwicHJvZHVjdHNDb3VudCIsInNldCIsImVsZW1lbnQiLCJzY2FsZU5vZGUiLCJiYWxhbmNlZFByb3BlcnR5IiwiYWRkQ2hpbGQiLCJjZW50ZXJYIiwiZ2V0U2NyZWVuQ2VudGVyWCIsInJlYWN0YW50Q291bnRQcm9wZXJ0eSIsImdldCIsImFzc2VydCIsInByb2R1Y3RDb3VudFByb3BlcnR5IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJCYWxhbmNlU2NhbGVzTm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBWaXN1YWwgcmVwcmVzZW50YXRpb24gb2YgYW4gZXF1YXRpb24gYXMgYSBzZXQgb2YgYmFsYW5jZSBzY2FsZXMsIG9uZSBmb3IgZWFjaCBhdG9tIHR5cGUuXHJcbiAqIFRoZSBsZWZ0IHNpZGUgb2YgZWFjaCBzY2FsZSBpcyB0aGUgcmVhY3RhbnRzLCB0aGUgcmlnaHQgc2lkZSBpcyB0aGUgcHJvZHVjdHMuXHJcbiAqXHJcbiAqIFRoaXMgaW1wbGVtZW50YXRpb24gaXMgdmVyeSBicnV0ZSBmb3JjZSwganVzdCBhYm91dCBldmVyeXRoaW5nIGlzIHJlY3JlYXRlZCBlYWNoIHRpbWVcclxuICogYSBjb2VmZmljaWVudCBpcyBjaGFuZ2VkIGluIHRoZSBlcXVhdGlvbnMuICBCdXQgd2UgaGF2ZSBhIHNtYWxsIG51bWJlciBvZiBjb2VmZmljaWVudHMsXHJcbiAqIGFuZCBub3RoaW5nIGVsc2UgaXMgaGFwcGVuaW5nIGluIHRoZSBzaW0uICBTbyB3ZSdyZSB0cmFkaW5nIGVmZmljaWVuY3kgZm9yIHNpbXBsaWNpdHkgb2ZcclxuICogaW1wbGVtZW50YXRpb24uXHJcbiAqXHJcbiAqIEBhdXRob3IgVmFzaWx5IFNoYWtob3YgKG1sZWFybmVyLmNvbSlcclxuICovXHJcblxyXG5pbXBvcnQgRWxlbWVudCBmcm9tICcuLi8uLi8uLi8uLi9uaXRyb2dseWNlcmluL2pzL0VsZW1lbnQuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgTm9kZSwgTm9kZU9wdGlvbnMsIE5vZGVUcmFuc2xhdGlvbk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMgZnJvbSAnLi4vLi4vYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMuanMnO1xyXG5pbXBvcnQgRXF1YXRpb24gZnJvbSAnLi4vbW9kZWwvRXF1YXRpb24uanMnO1xyXG5pbXBvcnQgQmFsYW5jZVNjYWxlTm9kZSBmcm9tICcuL0JhbGFuY2VTY2FsZU5vZGUuanMnO1xyXG5pbXBvcnQgSG9yaXpvbnRhbEFsaWduZXIgZnJvbSAnLi9Ib3Jpem9udGFsQWxpZ25lci5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuXHJcbnR5cGUgU2VsZk9wdGlvbnMgPSB7XHJcbiAgZnVsY3J1bVNwYWNpbmc/OiBudW1iZXI7IC8vIGhvcml6b250YWwgc3BhY2luZyBiZXR3ZWVuIHRoZSB0aXBzIG9mIHRoZSBmdWxjcnVtc1xyXG4gIGR1YWxGdWxjcnVtU3BhY2luZz86IG51bWJlcjsgLy8gaG9yaXpvbnRhbCBzcGFjaW5nIHdoZW4gd2UgaGF2ZSAyIHNjYWxlcywgc2VlIGlzc3VlICM5MVxyXG59O1xyXG5cclxudHlwZSBCYWxhbmNlU2NhbGVzTm9kZU9wdGlvbnMgPSBTZWxmT3B0aW9ucyAmIE5vZGVUcmFuc2xhdGlvbk9wdGlvbnM7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBCYWxhbmNlU2NhbGVzTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGVxdWF0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEVxdWF0aW9uPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGFsaWduZXI6IEhvcml6b250YWxBbGlnbmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY29uc3RhbnRCb3R0b206IG51bWJlcjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGZ1bGNydW1TcGFjaW5nOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkdWFsRnVsY3J1bVNwYWNpbmc6IG51bWJlcjtcclxuXHJcbiAgLy8gbWFwcyBFbGVtZW50IHRvIGNvdW50IGZvciB0aGF0IEVsZW1lbnRcclxuICBwcml2YXRlIHJlYWRvbmx5IHJlYWN0YW50Q291bnRQcm9wZXJ0aWVzOiBNYXA8RWxlbWVudCwgUHJvcGVydHk8bnVtYmVyPj47XHJcbiAgcHJpdmF0ZSByZWFkb25seSBwcm9kdWN0Q291bnRQcm9wZXJ0aWVzOiBNYXA8RWxlbWVudCwgUHJvcGVydHk8bnVtYmVyPj47XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBlcXVhdGlvblByb3BlcnR5IHRoZSBlcXVhdGlvbiB0aGF0IHRoZSBzY2FsZXMgYXJlIHJlcHJlc2VudGluZ1xyXG4gICAqIEBwYXJhbSBhbGlnbmVyIHByb3ZpZGVzIGxheW91dCBpbmZvcm1hdGlvbiB0byBlbnN1cmUgaG9yaXpvbnRhbCBhbGlnbm1lbnQgd2l0aCBvdGhlciB1c2VyLWludGVyZmFjZSBlbGVtZW50c1xyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggZXF1YXRpb25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8RXF1YXRpb24+LCBhbGlnbmVyOiBIb3Jpem9udGFsQWxpZ25lcixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IEJhbGFuY2VTY2FsZXNOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEJhbGFuY2VTY2FsZXNOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIE5vZGVPcHRpb25zPigpKCB7XHJcblxyXG4gICAgICAvLyBTZWxmT3B0aW9uc1xyXG4gICAgICBmdWxjcnVtU3BhY2luZzogMjM3LFxyXG4gICAgICBkdWFsRnVsY3J1bVNwYWNpbmc6IDIzNyxcclxuXHJcbiAgICAgIC8vIE5vZGVPcHRpb25zXHJcbiAgICAgIGJvdHRvbTogMFxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLmVxdWF0aW9uUHJvcGVydHkgPSBlcXVhdGlvblByb3BlcnR5O1xyXG4gICAgdGhpcy5hbGlnbmVyID0gYWxpZ25lcjtcclxuXHJcbiAgICB0aGlzLmNvbnN0YW50Qm90dG9tID0gb3B0aW9ucy5ib3R0b207XHJcbiAgICB0aGlzLmZ1bGNydW1TcGFjaW5nID0gb3B0aW9ucy5mdWxjcnVtU3BhY2luZztcclxuICAgIHRoaXMuZHVhbEZ1bGNydW1TcGFjaW5nID0gb3B0aW9ucy5kdWFsRnVsY3J1bVNwYWNpbmc7XHJcblxyXG4gICAgdGhpcy5yZWFjdGFudENvdW50UHJvcGVydGllcyA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMucHJvZHVjdENvdW50UHJvcGVydGllcyA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICAvLyBXaXJlIGNvZWZmaWNpZW50cyBvYnNlcnZlciB0byBjdXJyZW50IGVxdWF0aW9uLlxyXG4gICAgY29uc3QgY29lZmZpY2llbnRzT2JzZXJ2ZXIgPSB0aGlzLnVwZGF0ZUNvdW50cy5iaW5kKCB0aGlzICk7XHJcbiAgICBlcXVhdGlvblByb3BlcnR5LmxpbmsoICggbmV3RXF1YXRpb24sIG9sZEVxdWF0aW9uICkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZU5vZGUoKTtcclxuICAgICAgaWYgKCBvbGRFcXVhdGlvbiApIHtcclxuICAgICAgICBvbGRFcXVhdGlvbi5yZW1vdmVDb2VmZmljaWVudHNPYnNlcnZlciggY29lZmZpY2llbnRzT2JzZXJ2ZXIgKTtcclxuICAgICAgfVxyXG4gICAgICBuZXdFcXVhdGlvbi5hZGRDb2VmZmljaWVudHNPYnNlcnZlciggY29lZmZpY2llbnRzT2JzZXJ2ZXIgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGlzIE5vZGUgd2hlbiBpdCBiZWNvbWVzIHZpc2libGUuXHJcbiAgICB0aGlzLnZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHZpc2libGUgJiYgdGhpcy51cGRhdGVOb2RlKCkgKTtcclxuICB9XHJcblxyXG4gIC8vIE5vIGRpc3Bvc2UgbmVlZGVkLCBpbnN0YW5jZXMgb2YgdGhpcyB0eXBlIHBlcnNpc3QgZm9yIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgdGhpcyBub2RlJ3MgZW50aXJlIGdlb21ldHJ5IGFuZCBsYXlvdXQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVOb2RlKCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcblxyXG4gICAgICAvLyBkaXNwb3NlIG9mIGNoaWxkcmVuIGJlZm9yZSBjYWxsaW5nIHJlbW92ZUFsbENoaWxkcmVuXHJcbiAgICAgIHRoaXMuZ2V0Q2hpbGRyZW4oKS5mb3JFYWNoKCBjaGlsZCA9PiB7XHJcbiAgICAgICAgaWYgKCBjaGlsZC5kaXNwb3NlICkge1xyXG4gICAgICAgICAgY2hpbGQuZGlzcG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG5cclxuICAgICAgLy8gcmVtb3ZlIGFsbCBub2RlcyBhbmQgY2xlYXIgdGhlIG1hcHNcclxuICAgICAgdGhpcy5yZW1vdmVBbGxDaGlsZHJlbigpO1xyXG4gICAgICB0aGlzLnJlYWN0YW50Q291bnRQcm9wZXJ0aWVzLmNsZWFyKCk7XHJcbiAgICAgIHRoaXMucHJvZHVjdENvdW50UHJvcGVydGllcy5jbGVhcigpO1xyXG5cclxuICAgICAgY29uc3QgYXRvbUNvdW50cyA9IHRoaXMuZXF1YXRpb25Qcm9wZXJ0eS52YWx1ZS5nZXRBdG9tQ291bnRzKCk7XHJcbiAgICAgIGNvbnN0IGZ1bGNydW1TcGFjaW5nID0gKCBhdG9tQ291bnRzLmxlbmd0aCA9PT0gMiApID8gdGhpcy5kdWFsRnVsY3J1bVNwYWNpbmcgOiB0aGlzLmZ1bGNydW1TcGFjaW5nO1xyXG4gICAgICBsZXQgeCA9IDA7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGF0b21Db3VudHMubGVuZ3RoOyBpKysgKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IGF0b21Db3VudCA9IGF0b21Db3VudHNbIGkgXTtcclxuXHJcbiAgICAgICAgLy8gcG9wdWxhdGUgdGhlIG1hcHNcclxuICAgICAgICBjb25zdCBsZWZ0Q291bnRQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggYXRvbUNvdW50LnJlYWN0YW50c0NvdW50LCB7IG51bWJlclR5cGU6ICdJbnRlZ2VyJyB9ICk7XHJcbiAgICAgICAgY29uc3QgcmlnaHRDb3VudFByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBhdG9tQ291bnQucHJvZHVjdHNDb3VudCwgeyBudW1iZXJUeXBlOiAnSW50ZWdlcicgfSApO1xyXG4gICAgICAgIHRoaXMucmVhY3RhbnRDb3VudFByb3BlcnRpZXMuc2V0KCBhdG9tQ291bnQuZWxlbWVudCwgbGVmdENvdW50UHJvcGVydHkgKTtcclxuICAgICAgICB0aGlzLnByb2R1Y3RDb3VudFByb3BlcnRpZXMuc2V0KCBhdG9tQ291bnQuZWxlbWVudCwgcmlnaHRDb3VudFByb3BlcnR5ICk7XHJcblxyXG4gICAgICAgIC8vIGFkZCBhIHNjYWxlIG5vZGVcclxuICAgICAgICBjb25zdCBzY2FsZU5vZGUgPSBuZXcgQmFsYW5jZVNjYWxlTm9kZSggYXRvbUNvdW50LmVsZW1lbnQsIGxlZnRDb3VudFByb3BlcnR5LCByaWdodENvdW50UHJvcGVydHksIHRoaXMuZXF1YXRpb25Qcm9wZXJ0eS52YWx1ZS5iYWxhbmNlZFByb3BlcnR5LCB7IHg6IHggfSApO1xyXG4gICAgICAgIHRoaXMuYWRkQ2hpbGQoIHNjYWxlTm9kZSApO1xyXG5cclxuICAgICAgICB4ICs9IGZ1bGNydW1TcGFjaW5nO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmNlbnRlclggPSB0aGlzLmFsaWduZXIuZ2V0U2NyZWVuQ2VudGVyWCgpO1xyXG4gICAgICB0aGlzLmJvdHRvbSA9IHRoaXMuY29uc3RhbnRCb3R0b207XHJcbiAgICAgIHRoaXMudXBkYXRlQ291bnRzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoZSBhdG9tIGNvdW50cyBmb3IgZWFjaCBzY2FsZS5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZUNvdW50cygpOiB2b2lkIHtcclxuICAgIGlmICggdGhpcy52aXNpYmxlICkge1xyXG4gICAgICBjb25zdCBhdG9tQ291bnRzID0gdGhpcy5lcXVhdGlvblByb3BlcnR5LnZhbHVlLmdldEF0b21Db3VudHMoKTtcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgYXRvbUNvdW50cy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBjb25zdCBhdG9tQ291bnQgPSBhdG9tQ291bnRzWyBpIF07XHJcblxyXG4gICAgICAgIGNvbnN0IHJlYWN0YW50Q291bnRQcm9wZXJ0eSA9IHRoaXMucmVhY3RhbnRDb3VudFByb3BlcnRpZXMuZ2V0KCBhdG9tQ291bnQuZWxlbWVudCApITtcclxuICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCByZWFjdGFudENvdW50UHJvcGVydHkgKTtcclxuICAgICAgICByZWFjdGFudENvdW50UHJvcGVydHkudmFsdWUgPSBhdG9tQ291bnQucmVhY3RhbnRzQ291bnQ7XHJcblxyXG4gICAgICAgIGNvbnN0IHByb2R1Y3RDb3VudFByb3BlcnR5ID0gdGhpcy5wcm9kdWN0Q291bnRQcm9wZXJ0aWVzLmdldCggYXRvbUNvdW50LmVsZW1lbnQgKSE7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggcHJvZHVjdENvdW50UHJvcGVydHkgKTtcclxuICAgICAgICBwcm9kdWN0Q291bnRQcm9wZXJ0eS52YWx1ZSA9IGF0b21Db3VudC5wcm9kdWN0c0NvdW50O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5iYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucy5yZWdpc3RlciggJ0JhbGFuY2VTY2FsZXNOb2RlJywgQmFsYW5jZVNjYWxlc05vZGUgKTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsT0FBT0EsY0FBYyxNQUFNLHVDQUF1QztBQUVsRSxTQUFTQyxJQUFJLFFBQTZDLG1DQUFtQztBQUM3RixPQUFPQywwQkFBMEIsTUFBTSxxQ0FBcUM7QUFFNUUsT0FBT0MsZ0JBQWdCLE1BQU0sdUJBQXVCO0FBR3BELE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFTN0QsZUFBZSxNQUFNQyxpQkFBaUIsU0FBU0osSUFBSSxDQUFDO0VBUWxEOztFQUlBO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7RUFDU0ssV0FBV0EsQ0FBRUMsZ0JBQTZDLEVBQUVDLE9BQTBCLEVBQ3pFQyxlQUEwQyxFQUFHO0lBRS9ELE1BQU1DLE9BQU8sR0FBR04sU0FBUyxDQUFxRCxDQUFDLENBQUU7TUFFL0U7TUFDQU8sY0FBYyxFQUFFLEdBQUc7TUFDbkJDLGtCQUFrQixFQUFFLEdBQUc7TUFFdkI7TUFDQUMsTUFBTSxFQUFFO0lBQ1YsQ0FBQyxFQUFFSixlQUFnQixDQUFDO0lBRXBCLEtBQUssQ0FBQyxDQUFDO0lBRVAsSUFBSSxDQUFDRixnQkFBZ0IsR0FBR0EsZ0JBQWdCO0lBQ3hDLElBQUksQ0FBQ0MsT0FBTyxHQUFHQSxPQUFPO0lBRXRCLElBQUksQ0FBQ00sY0FBYyxHQUFHSixPQUFPLENBQUNHLE1BQU07SUFDcEMsSUFBSSxDQUFDRixjQUFjLEdBQUdELE9BQU8sQ0FBQ0MsY0FBYztJQUM1QyxJQUFJLENBQUNDLGtCQUFrQixHQUFHRixPQUFPLENBQUNFLGtCQUFrQjtJQUVw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