// Copyright 2014-2023, University of Colorado Boulder

/**
 * A box that shows the number of molecules indicated by the equation's user coefficients.
 *
 * @author Vasily Shakhov (mlearner.com)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import optionize from '../../../../phet-core/js/optionize.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Node, Rectangle, Text } from '../../../../scenery/js/imports.js';
import AccordionBox from '../../../../sun/js/AccordionBox.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import BCEConstants from '../BCEConstants.js';
const EXPAND_COLLAPSE_BUTTON_SIDE_LENGTH = 15;
export default class BoxNode extends AccordionBox {
  // molecule nodes for each term

  /**
   * @param equationProperty
   * @param getTerms - gets the EquationTerms that this box will display
   * @param getXOffsets - gets the x-offsets for each EquationTerm
   * @param coefficientRange - range of the coefficients
   * @param titleStringProperty
   * @param [providedOptions]
   */
  constructor(equationProperty, getTerms, getXOffsets, coefficientRange, titleStringProperty, providedOptions) {
    const options = optionize()({
      // SelfOptions
      boxWidth: 100,
      boxHeight: 100,
      // AccordionBoxOptions
      titleAlignX: 'center',
      resize: false,
      fill: 'white',
      stroke: 'black',
      lineWidth: 1,
      cornerRadius: 0,
      buttonAlign: 'right',
      buttonXMargin: 5,
      buttonYMargin: 5,
      showTitleWhenExpanded: false,
      titleBarExpandCollapse: false,
      titleXMargin: 0,
      titleXSpacing: 0,
      contentXMargin: 0,
      contentYMargin: 0,
      contentXSpacing: 0,
      contentYSpacing: 0,
      contentAlign: 'left',
      expandCollapseButtonOptions: {
        sideLength: EXPAND_COLLAPSE_BUTTON_SIDE_LENGTH,
        touchAreaXDilation: 20,
        touchAreaYDilation: 20,
        mouseAreaXDilation: 10,
        mouseAreaYDilation: 10
      }
    }, providedOptions);
    options.titleNode = new Text(titleStringProperty, {
      font: new PhetFont({
        size: 18,
        weight: 'bold'
      }),
      maxWidth: 0.75 * options.boxWidth
    });

    // Content will be placed to the left of expand/collapse button, so contentWidth is only part of boxWidth.
    // See https://github.com/phetsims/balancing-chemical-equations/issues/125
    assert && assert(!options.showTitleWhenExpanded && options.titleAlignX === 'center', 'computation of contentWidth is dependent on specific option values');
    const contentWidth = options.boxWidth - EXPAND_COLLAPSE_BUTTON_SIDE_LENGTH - options.buttonXMargin;

    // constant-sized rectangle
    const contentNode = new Rectangle(0, 0, contentWidth, options.boxHeight, {
      // With ?dev query parameter, put a red stroke around the content, for debugging layout of #125
      stroke: phet.chipper.queryParameters.dev ? 'red' : null
    });

    // parent for all molecule nodes
    const moleculesParent = new Node();
    contentNode.addChild(moleculesParent);
    super(contentNode, options);
    this.boxHeight = options.boxHeight;
    this.coefficientRange = coefficientRange;
    this.termNodesMap = new Map();
    this.moleculesParent = moleculesParent;

    // update visible molecules to match the coefficients
    const coefficientsObserver = () => {
      this.updateCounts(getTerms(equationProperty.value), getXOffsets(equationProperty.value));
    };
    equationProperty.link((newEquation, oldEquation) => {
      // updates the node for molecules of the current equation
      this.updateNode(getTerms(newEquation), getXOffsets(newEquation));

      // wire up coefficients observer to current equation
      if (oldEquation) {
        oldEquation.removeCoefficientsObserver(coefficientsObserver);
      }
      newEquation.addCoefficientsObserver(coefficientsObserver);
    });
  }

  // No dispose needed, instances of this type persist for lifetime of the sim.

  /**
   * Creates molecules in the boxes for one set of terms (reactants or products).
   * To improve performance:
   * - Molecules are created as needed.
   * - Molecules are never removed; they remain as children for the lifetime of this node.
   * - The visibility of molecules is adjusted to show the correct number of molecules.
   */
  updateNode(terms, xOffsets) {
    // Remove all molecule nodes and clear the map.
    this.moleculesParent.removeAllChildren();
    this.termNodesMap.clear();
    this.updateCounts(terms, xOffsets);
  }

  /**
   * Updates visibility of molecules to match the current coefficients.
   */
  updateCounts(terms, xOffsets) {
    const Y_MARGIN = 0;
    const rowHeight = (this.boxHeight - 2 * Y_MARGIN) / this.coefficientRange.max;
    for (let i = 0; i < terms.length; i++) {
      const term = terms[i];
      const moleculeNodes = this.termNodesMap.get(term.molecule) || [];
      const userCoefficient = terms[i].userCoefficientProperty.value;
      let y = this.boxHeight - Y_MARGIN - rowHeight / 2;
      for (let j = 0; j < Math.max(userCoefficient, moleculeNodes.length); j++) {
        if (j < moleculeNodes.length) {
          // set visibility of a molecule that already exists
          moleculeNodes[j].visible = j < userCoefficient;
        } else {
          // add a molecule node
          const moleculeNode = term.molecule.createNode({
            atomNodeOptions: BCEConstants.ATOM_NODE_OPTIONS
          });
          moleculeNode.scale(BCEConstants.MOLECULE_SCALE_FACTOR);
          this.moleculesParent.addChild(moleculeNode);
          moleculeNode.center = new Vector2(xOffsets[i] - this.x, y);
          moleculeNodes.push(moleculeNode);
        }
        y -= rowHeight;
      }
      this.termNodesMap.set(term.molecule, moleculeNodes);
    }
  }
}
balancingChemicalEquations.register('BoxNode', BoxNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwib3B0aW9uaXplIiwiUGhldEZvbnQiLCJOb2RlIiwiUmVjdGFuZ2xlIiwiVGV4dCIsIkFjY29yZGlvbkJveCIsImJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIiwiQkNFQ29uc3RhbnRzIiwiRVhQQU5EX0NPTExBUFNFX0JVVFRPTl9TSURFX0xFTkdUSCIsIkJveE5vZGUiLCJjb25zdHJ1Y3RvciIsImVxdWF0aW9uUHJvcGVydHkiLCJnZXRUZXJtcyIsImdldFhPZmZzZXRzIiwiY29lZmZpY2llbnRSYW5nZSIsInRpdGxlU3RyaW5nUHJvcGVydHkiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiYm94V2lkdGgiLCJib3hIZWlnaHQiLCJ0aXRsZUFsaWduWCIsInJlc2l6ZSIsImZpbGwiLCJzdHJva2UiLCJsaW5lV2lkdGgiLCJjb3JuZXJSYWRpdXMiLCJidXR0b25BbGlnbiIsImJ1dHRvblhNYXJnaW4iLCJidXR0b25ZTWFyZ2luIiwic2hvd1RpdGxlV2hlbkV4cGFuZGVkIiwidGl0bGVCYXJFeHBhbmRDb2xsYXBzZSIsInRpdGxlWE1hcmdpbiIsInRpdGxlWFNwYWNpbmciLCJjb250ZW50WE1hcmdpbiIsImNvbnRlbnRZTWFyZ2luIiwiY29udGVudFhTcGFjaW5nIiwiY29udGVudFlTcGFjaW5nIiwiY29udGVudEFsaWduIiwiZXhwYW5kQ29sbGFwc2VCdXR0b25PcHRpb25zIiwic2lkZUxlbmd0aCIsInRvdWNoQXJlYVhEaWxhdGlvbiIsInRvdWNoQXJlYVlEaWxhdGlvbiIsIm1vdXNlQXJlYVhEaWxhdGlvbiIsIm1vdXNlQXJlYVlEaWxhdGlvbiIsInRpdGxlTm9kZSIsImZvbnQiLCJzaXplIiwid2VpZ2h0IiwibWF4V2lkdGgiLCJhc3NlcnQiLCJjb250ZW50V2lkdGgiLCJjb250ZW50Tm9kZSIsInBoZXQiLCJjaGlwcGVyIiwicXVlcnlQYXJhbWV0ZXJzIiwiZGV2IiwibW9sZWN1bGVzUGFyZW50IiwiYWRkQ2hpbGQiLCJ0ZXJtTm9kZXNNYXAiLCJNYXAiLCJjb2VmZmljaWVudHNPYnNlcnZlciIsInVwZGF0ZUNvdW50cyIsInZhbHVlIiwibGluayIsIm5ld0VxdWF0aW9uIiwib2xkRXF1YXRpb24iLCJ1cGRhdGVOb2RlIiwicmVtb3ZlQ29lZmZpY2llbnRzT2JzZXJ2ZXIiLCJhZGRDb2VmZmljaWVudHNPYnNlcnZlciIsInRlcm1zIiwieE9mZnNldHMiLCJyZW1vdmVBbGxDaGlsZHJlbiIsImNsZWFyIiwiWV9NQVJHSU4iLCJyb3dIZWlnaHQiLCJtYXgiLCJpIiwibGVuZ3RoIiwidGVybSIsIm1vbGVjdWxlTm9kZXMiLCJnZXQiLCJtb2xlY3VsZSIsInVzZXJDb2VmZmljaWVudCIsInVzZXJDb2VmZmljaWVudFByb3BlcnR5IiwieSIsImoiLCJNYXRoIiwidmlzaWJsZSIsIm1vbGVjdWxlTm9kZSIsImNyZWF0ZU5vZGUiLCJhdG9tTm9kZU9wdGlvbnMiLCJBVE9NX05PREVfT1BUSU9OUyIsInNjYWxlIiwiTU9MRUNVTEVfU0NBTEVfRkFDVE9SIiwiY2VudGVyIiwieCIsInB1c2giLCJzZXQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJveE5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBib3ggdGhhdCBzaG93cyB0aGUgbnVtYmVyIG9mIG1vbGVjdWxlcyBpbmRpY2F0ZWQgYnkgdGhlIGVxdWF0aW9uJ3MgdXNlciBjb2VmZmljaWVudHMuXHJcbiAqXHJcbiAqIEBhdXRob3IgVmFzaWx5IFNoYWtob3YgKG1sZWFybmVyLmNvbSlcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcbmltcG9ydCBQaWNrT3B0aW9uYWwgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1BpY2tPcHRpb25hbC5qcyc7XHJcbmltcG9ydCBQaGV0Rm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldEZvbnQuanMnO1xyXG5pbXBvcnQgTW9sZWN1bGVOb2RlIGZyb20gJy4uLy4uLy4uLy4uL25pdHJvZ2x5Y2VyaW4vanMvbm9kZXMvTW9sZWN1bGVOb2RlLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgTm9kZVRyYW5zbGF0aW9uT3B0aW9ucywgUmVjdGFuZ2xlLCBUZXh0IH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IEFjY29yZGlvbkJveCwgeyBBY2NvcmRpb25Cb3hPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc3VuL2pzL0FjY29yZGlvbkJveC5qcyc7XHJcbmltcG9ydCBiYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucyBmcm9tICcuLi8uLi9iYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucy5qcyc7XHJcbmltcG9ydCBCQ0VDb25zdGFudHMgZnJvbSAnLi4vQkNFQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IEVxdWF0aW9uIGZyb20gJy4uL21vZGVsL0VxdWF0aW9uLmpzJztcclxuaW1wb3J0IEVxdWF0aW9uVGVybSBmcm9tICcuLi9tb2RlbC9FcXVhdGlvblRlcm0uanMnO1xyXG5pbXBvcnQgTW9sZWN1bGUgZnJvbSAnLi4vbW9kZWwvTW9sZWN1bGUuanMnO1xyXG5cclxuY29uc3QgRVhQQU5EX0NPTExBUFNFX0JVVFRPTl9TSURFX0xFTkdUSCA9IDE1O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICBib3hXaWR0aD86IG51bWJlcjtcclxuICBib3hIZWlnaHQ/OiBudW1iZXI7XHJcbn07XHJcblxyXG50eXBlIEJveE5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBOb2RlVHJhbnNsYXRpb25PcHRpb25zICZcclxuICBQaWNrT3B0aW9uYWw8QWNjb3JkaW9uQm94T3B0aW9ucywgJ2V4cGFuZGVkUHJvcGVydHknIHwgJ2ZpbGwnPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJveE5vZGUgZXh0ZW5kcyBBY2NvcmRpb25Cb3gge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGJveEhlaWdodDogbnVtYmVyO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY29lZmZpY2llbnRSYW5nZTogUmFuZ2U7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgdGVybU5vZGVzTWFwOiBNYXA8TW9sZWN1bGUsIE1vbGVjdWxlTm9kZVtdPjsgLy8gbW9sZWN1bGUgbm9kZXMgZm9yIGVhY2ggdGVybVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgbW9sZWN1bGVzUGFyZW50OiBOb2RlO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gZXF1YXRpb25Qcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBnZXRUZXJtcyAtIGdldHMgdGhlIEVxdWF0aW9uVGVybXMgdGhhdCB0aGlzIGJveCB3aWxsIGRpc3BsYXlcclxuICAgKiBAcGFyYW0gZ2V0WE9mZnNldHMgLSBnZXRzIHRoZSB4LW9mZnNldHMgZm9yIGVhY2ggRXF1YXRpb25UZXJtXHJcbiAgICogQHBhcmFtIGNvZWZmaWNpZW50UmFuZ2UgLSByYW5nZSBvZiB0aGUgY29lZmZpY2llbnRzXHJcbiAgICogQHBhcmFtIHRpdGxlU3RyaW5nUHJvcGVydHlcclxuICAgKiBAcGFyYW0gW3Byb3ZpZGVkT3B0aW9uc11cclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGVxdWF0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEVxdWF0aW9uPixcclxuICAgICAgICAgICAgICAgICAgICAgIGdldFRlcm1zOiAoIGVxdWF0aW9uOiBFcXVhdGlvbiApID0+IEVxdWF0aW9uVGVybVtdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgZ2V0WE9mZnNldHM6ICggZXF1YXRpb246IEVxdWF0aW9uICkgPT4gbnVtYmVyW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICBjb2VmZmljaWVudFJhbmdlOiBSYW5nZSxcclxuICAgICAgICAgICAgICAgICAgICAgIHRpdGxlU3RyaW5nUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PHN0cmluZz4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZE9wdGlvbnM/OiBCb3hOb2RlT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPEJveE5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgQWNjb3JkaW9uQm94T3B0aW9ucz4oKSgge1xyXG5cclxuICAgICAgLy8gU2VsZk9wdGlvbnNcclxuICAgICAgYm94V2lkdGg6IDEwMCxcclxuICAgICAgYm94SGVpZ2h0OiAxMDAsXHJcblxyXG4gICAgICAvLyBBY2NvcmRpb25Cb3hPcHRpb25zXHJcbiAgICAgIHRpdGxlQWxpZ25YOiAnY2VudGVyJyxcclxuICAgICAgcmVzaXplOiBmYWxzZSxcclxuICAgICAgZmlsbDogJ3doaXRlJyxcclxuICAgICAgc3Ryb2tlOiAnYmxhY2snLFxyXG4gICAgICBsaW5lV2lkdGg6IDEsXHJcbiAgICAgIGNvcm5lclJhZGl1czogMCxcclxuICAgICAgYnV0dG9uQWxpZ246ICdyaWdodCcsXHJcbiAgICAgIGJ1dHRvblhNYXJnaW46IDUsXHJcbiAgICAgIGJ1dHRvbllNYXJnaW46IDUsXHJcbiAgICAgIHNob3dUaXRsZVdoZW5FeHBhbmRlZDogZmFsc2UsXHJcbiAgICAgIHRpdGxlQmFyRXhwYW5kQ29sbGFwc2U6IGZhbHNlLFxyXG4gICAgICB0aXRsZVhNYXJnaW46IDAsXHJcbiAgICAgIHRpdGxlWFNwYWNpbmc6IDAsXHJcbiAgICAgIGNvbnRlbnRYTWFyZ2luOiAwLFxyXG4gICAgICBjb250ZW50WU1hcmdpbjogMCxcclxuICAgICAgY29udGVudFhTcGFjaW5nOiAwLFxyXG4gICAgICBjb250ZW50WVNwYWNpbmc6IDAsXHJcbiAgICAgIGNvbnRlbnRBbGlnbjogJ2xlZnQnLFxyXG4gICAgICBleHBhbmRDb2xsYXBzZUJ1dHRvbk9wdGlvbnM6IHtcclxuICAgICAgICBzaWRlTGVuZ3RoOiBFWFBBTkRfQ09MTEFQU0VfQlVUVE9OX1NJREVfTEVOR1RILFxyXG4gICAgICAgIHRvdWNoQXJlYVhEaWxhdGlvbjogMjAsXHJcbiAgICAgICAgdG91Y2hBcmVhWURpbGF0aW9uOiAyMCxcclxuICAgICAgICBtb3VzZUFyZWFYRGlsYXRpb246IDEwLFxyXG4gICAgICAgIG1vdXNlQXJlYVlEaWxhdGlvbjogMTBcclxuICAgICAgfVxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgb3B0aW9ucy50aXRsZU5vZGUgPSBuZXcgVGV4dCggdGl0bGVTdHJpbmdQcm9wZXJ0eSwge1xyXG4gICAgICBmb250OiBuZXcgUGhldEZvbnQoIHsgc2l6ZTogMTgsIHdlaWdodDogJ2JvbGQnIH0gKSxcclxuICAgICAgbWF4V2lkdGg6IDAuNzUgKiBvcHRpb25zLmJveFdpZHRoXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQ29udGVudCB3aWxsIGJlIHBsYWNlZCB0byB0aGUgbGVmdCBvZiBleHBhbmQvY29sbGFwc2UgYnV0dG9uLCBzbyBjb250ZW50V2lkdGggaXMgb25seSBwYXJ0IG9mIGJveFdpZHRoLlxyXG4gICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9iYWxhbmNpbmctY2hlbWljYWwtZXF1YXRpb25zL2lzc3Vlcy8xMjVcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoICFvcHRpb25zLnNob3dUaXRsZVdoZW5FeHBhbmRlZCAmJiBvcHRpb25zLnRpdGxlQWxpZ25YID09PSAnY2VudGVyJyxcclxuICAgICAgJ2NvbXB1dGF0aW9uIG9mIGNvbnRlbnRXaWR0aCBpcyBkZXBlbmRlbnQgb24gc3BlY2lmaWMgb3B0aW9uIHZhbHVlcycgKTtcclxuICAgIGNvbnN0IGNvbnRlbnRXaWR0aCA9IG9wdGlvbnMuYm94V2lkdGggLSBFWFBBTkRfQ09MTEFQU0VfQlVUVE9OX1NJREVfTEVOR1RIIC0gb3B0aW9ucy5idXR0b25YTWFyZ2luO1xyXG5cclxuICAgIC8vIGNvbnN0YW50LXNpemVkIHJlY3RhbmdsZVxyXG4gICAgY29uc3QgY29udGVudE5vZGUgPSBuZXcgUmVjdGFuZ2xlKCAwLCAwLCBjb250ZW50V2lkdGgsIG9wdGlvbnMuYm94SGVpZ2h0LCB7XHJcblxyXG4gICAgICAvLyBXaXRoID9kZXYgcXVlcnkgcGFyYW1ldGVyLCBwdXQgYSByZWQgc3Ryb2tlIGFyb3VuZCB0aGUgY29udGVudCwgZm9yIGRlYnVnZ2luZyBsYXlvdXQgb2YgIzEyNVxyXG4gICAgICBzdHJva2U6IHBoZXQuY2hpcHBlci5xdWVyeVBhcmFtZXRlcnMuZGV2ID8gJ3JlZCcgOiBudWxsXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gcGFyZW50IGZvciBhbGwgbW9sZWN1bGUgbm9kZXNcclxuICAgIGNvbnN0IG1vbGVjdWxlc1BhcmVudCA9IG5ldyBOb2RlKCk7XHJcbiAgICBjb250ZW50Tm9kZS5hZGRDaGlsZCggbW9sZWN1bGVzUGFyZW50ICk7XHJcblxyXG4gICAgc3VwZXIoIGNvbnRlbnROb2RlLCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5ib3hIZWlnaHQgPSBvcHRpb25zLmJveEhlaWdodDtcclxuICAgIHRoaXMuY29lZmZpY2llbnRSYW5nZSA9IGNvZWZmaWNpZW50UmFuZ2U7XHJcbiAgICB0aGlzLnRlcm1Ob2Rlc01hcCA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMubW9sZWN1bGVzUGFyZW50ID0gbW9sZWN1bGVzUGFyZW50O1xyXG5cclxuICAgIC8vIHVwZGF0ZSB2aXNpYmxlIG1vbGVjdWxlcyB0byBtYXRjaCB0aGUgY29lZmZpY2llbnRzXHJcbiAgICBjb25zdCBjb2VmZmljaWVudHNPYnNlcnZlciA9ICgpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVDb3VudHMoIGdldFRlcm1zKCBlcXVhdGlvblByb3BlcnR5LnZhbHVlICksIGdldFhPZmZzZXRzKCBlcXVhdGlvblByb3BlcnR5LnZhbHVlICkgKTtcclxuICAgIH07XHJcblxyXG4gICAgZXF1YXRpb25Qcm9wZXJ0eS5saW5rKCAoIG5ld0VxdWF0aW9uLCBvbGRFcXVhdGlvbiApID0+IHtcclxuXHJcbiAgICAgIC8vIHVwZGF0ZXMgdGhlIG5vZGUgZm9yIG1vbGVjdWxlcyBvZiB0aGUgY3VycmVudCBlcXVhdGlvblxyXG4gICAgICB0aGlzLnVwZGF0ZU5vZGUoIGdldFRlcm1zKCBuZXdFcXVhdGlvbiApLCBnZXRYT2Zmc2V0cyggbmV3RXF1YXRpb24gKSApO1xyXG5cclxuICAgICAgLy8gd2lyZSB1cCBjb2VmZmljaWVudHMgb2JzZXJ2ZXIgdG8gY3VycmVudCBlcXVhdGlvblxyXG4gICAgICBpZiAoIG9sZEVxdWF0aW9uICkge1xyXG4gICAgICAgIG9sZEVxdWF0aW9uLnJlbW92ZUNvZWZmaWNpZW50c09ic2VydmVyKCBjb2VmZmljaWVudHNPYnNlcnZlciApO1xyXG4gICAgICB9XHJcbiAgICAgIG5ld0VxdWF0aW9uLmFkZENvZWZmaWNpZW50c09ic2VydmVyKCBjb2VmZmljaWVudHNPYnNlcnZlciApO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLy8gTm8gZGlzcG9zZSBuZWVkZWQsIGluc3RhbmNlcyBvZiB0aGlzIHR5cGUgcGVyc2lzdCBmb3IgbGlmZXRpbWUgb2YgdGhlIHNpbS5cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyBtb2xlY3VsZXMgaW4gdGhlIGJveGVzIGZvciBvbmUgc2V0IG9mIHRlcm1zIChyZWFjdGFudHMgb3IgcHJvZHVjdHMpLlxyXG4gICAqIFRvIGltcHJvdmUgcGVyZm9ybWFuY2U6XHJcbiAgICogLSBNb2xlY3VsZXMgYXJlIGNyZWF0ZWQgYXMgbmVlZGVkLlxyXG4gICAqIC0gTW9sZWN1bGVzIGFyZSBuZXZlciByZW1vdmVkOyB0aGV5IHJlbWFpbiBhcyBjaGlsZHJlbiBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoaXMgbm9kZS5cclxuICAgKiAtIFRoZSB2aXNpYmlsaXR5IG9mIG1vbGVjdWxlcyBpcyBhZGp1c3RlZCB0byBzaG93IHRoZSBjb3JyZWN0IG51bWJlciBvZiBtb2xlY3VsZXMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVOb2RlKCB0ZXJtczogRXF1YXRpb25UZXJtW10sIHhPZmZzZXRzOiBudW1iZXJbXSApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBSZW1vdmUgYWxsIG1vbGVjdWxlIG5vZGVzIGFuZCBjbGVhciB0aGUgbWFwLlxyXG4gICAgdGhpcy5tb2xlY3VsZXNQYXJlbnQucmVtb3ZlQWxsQ2hpbGRyZW4oKTtcclxuICAgIHRoaXMudGVybU5vZGVzTWFwLmNsZWFyKCk7XHJcblxyXG4gICAgdGhpcy51cGRhdGVDb3VudHMoIHRlcm1zLCB4T2Zmc2V0cyApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyB2aXNpYmlsaXR5IG9mIG1vbGVjdWxlcyB0byBtYXRjaCB0aGUgY3VycmVudCBjb2VmZmljaWVudHMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVDb3VudHMoIHRlcm1zOiBFcXVhdGlvblRlcm1bXSwgeE9mZnNldHM6IG51bWJlcltdICk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IFlfTUFSR0lOID0gMDtcclxuICAgIGNvbnN0IHJvd0hlaWdodCA9ICggdGhpcy5ib3hIZWlnaHQgLSAoIDIgKiBZX01BUkdJTiApICkgLyB0aGlzLmNvZWZmaWNpZW50UmFuZ2UubWF4O1xyXG5cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRlcm1zLmxlbmd0aDsgaSsrICkge1xyXG5cclxuICAgICAgY29uc3QgdGVybSA9IHRlcm1zWyBpIF07XHJcbiAgICAgIGNvbnN0IG1vbGVjdWxlTm9kZXMgPSB0aGlzLnRlcm1Ob2Rlc01hcC5nZXQoIHRlcm0ubW9sZWN1bGUgKSB8fCBbXTtcclxuXHJcbiAgICAgIGNvbnN0IHVzZXJDb2VmZmljaWVudCA9IHRlcm1zWyBpIF0udXNlckNvZWZmaWNpZW50UHJvcGVydHkudmFsdWU7XHJcbiAgICAgIGxldCB5ID0gdGhpcy5ib3hIZWlnaHQgLSBZX01BUkdJTiAtICggcm93SGVpZ2h0IC8gMiApO1xyXG5cclxuICAgICAgZm9yICggbGV0IGogPSAwOyBqIDwgTWF0aC5tYXgoIHVzZXJDb2VmZmljaWVudCwgbW9sZWN1bGVOb2Rlcy5sZW5ndGggKTsgaisrICkge1xyXG4gICAgICAgIGlmICggaiA8IG1vbGVjdWxlTm9kZXMubGVuZ3RoICkge1xyXG5cclxuICAgICAgICAgIC8vIHNldCB2aXNpYmlsaXR5IG9mIGEgbW9sZWN1bGUgdGhhdCBhbHJlYWR5IGV4aXN0c1xyXG4gICAgICAgICAgbW9sZWN1bGVOb2Rlc1sgaiBdLnZpc2libGUgPSAoIGogPCB1c2VyQ29lZmZpY2llbnQgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgICAgLy8gYWRkIGEgbW9sZWN1bGUgbm9kZVxyXG4gICAgICAgICAgY29uc3QgbW9sZWN1bGVOb2RlID0gdGVybS5tb2xlY3VsZS5jcmVhdGVOb2RlKCB7XHJcbiAgICAgICAgICAgIGF0b21Ob2RlT3B0aW9uczogQkNFQ29uc3RhbnRzLkFUT01fTk9ERV9PUFRJT05TXHJcbiAgICAgICAgICB9ICk7XHJcbiAgICAgICAgICBtb2xlY3VsZU5vZGUuc2NhbGUoIEJDRUNvbnN0YW50cy5NT0xFQ1VMRV9TQ0FMRV9GQUNUT1IgKTtcclxuICAgICAgICAgIHRoaXMubW9sZWN1bGVzUGFyZW50LmFkZENoaWxkKCBtb2xlY3VsZU5vZGUgKTtcclxuICAgICAgICAgIG1vbGVjdWxlTm9kZS5jZW50ZXIgPSBuZXcgVmVjdG9yMiggeE9mZnNldHNbIGkgXSAtIHRoaXMueCwgeSApO1xyXG4gICAgICAgICAgbW9sZWN1bGVOb2Rlcy5wdXNoKCBtb2xlY3VsZU5vZGUgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgeSAtPSByb3dIZWlnaHQ7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMudGVybU5vZGVzTWFwLnNldCggdGVybS5tb2xlY3VsZSwgbW9sZWN1bGVOb2RlcyApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMucmVnaXN0ZXIoICdCb3hOb2RlJywgQm94Tm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUlBLE9BQU9BLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsU0FBUyxNQUFNLHVDQUF1QztBQUU3RCxPQUFPQyxRQUFRLE1BQU0seUNBQXlDO0FBRTlELFNBQVNDLElBQUksRUFBMEJDLFNBQVMsRUFBRUMsSUFBSSxRQUFRLG1DQUFtQztBQUNqRyxPQUFPQyxZQUFZLE1BQStCLG9DQUFvQztBQUN0RixPQUFPQywwQkFBMEIsTUFBTSxxQ0FBcUM7QUFDNUUsT0FBT0MsWUFBWSxNQUFNLG9CQUFvQjtBQUs3QyxNQUFNQyxrQ0FBa0MsR0FBRyxFQUFFO0FBVTdDLGVBQWUsTUFBTUMsT0FBTyxTQUFTSixZQUFZLENBQUM7RUFLYzs7RUFHOUQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNTSyxXQUFXQSxDQUFFQyxnQkFBNkMsRUFDN0NDLFFBQWtELEVBQ2xEQyxXQUErQyxFQUMvQ0MsZ0JBQXVCLEVBQ3ZCQyxtQkFBOEMsRUFDOUNDLGVBQWdDLEVBQUc7SUFFckQsTUFBTUMsT0FBTyxHQUFHakIsU0FBUyxDQUFtRCxDQUFDLENBQUU7TUFFN0U7TUFDQWtCLFFBQVEsRUFBRSxHQUFHO01BQ2JDLFNBQVMsRUFBRSxHQUFHO01BRWQ7TUFDQUMs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