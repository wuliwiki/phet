// Copyright 2014-2023, University of Colorado Boulder

/**
 * Visual representation of an equation as a pair of bar charts, for left and right side of equation.
 * An indicator between the charts (equals or not equals) indicates whether they are balanced.
 *
 * This implementation is very brute force, just about everything is recreated each time
 * a coefficient is changed in the equations.  But we have a small number of coefficients,
 * and nothing else is happening in the sim.  So we're trading efficiency for simplicity of
 * implementation.
 *
 * @author Vasily Shakhov (mlearner.com)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import { Node } from '../../../../scenery/js/imports.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import BarNode from './BarNode.js';
import EqualityOperatorNode from './EqualityOperatorNode.js';
import optionize from '../../../../phet-core/js/optionize.js';
export default class BarChartsNode extends Node {
  // maps Element to count for that Element

  /**
   * @param equationProperty - the equation that the scales are representing
   * @param aligner - provides layout information to ensure horizontal alignment with other user-interface elements
   * @param [providedOptions]
   */
  constructor(equationProperty, aligner, providedOptions) {
    const options = optionize()({}, providedOptions);
    super();
    this.equationProperty = equationProperty;
    this.aligner = aligner;
    this.reactantCountProperties = new Map();
    this.productCountProperties = new Map();
    this.reactantBarsParent = new Node();
    this.productBarsParent = new Node();
    const equalityOperatorNode = new EqualityOperatorNode(equationProperty, {
      center: new Vector2(aligner.getScreenCenterX(), -40)
    });
    options.children = [this.reactantBarsParent, this.productBarsParent, equalityOperatorNode];

    // Wire coefficients observer to current equation.
    const coefficientsObserver = this.updateCounts.bind(this);
    equationProperty.link((newEquation, oldEquation) => {
      this.updateNode();
      if (oldEquation) {
        oldEquation.removeCoefficientsObserver(coefficientsObserver);
      }
      newEquation.addCoefficientsObserver(coefficientsObserver);
    });
    this.mutate(options);

    // Update this Node when it becomes visible.
    this.visibleProperty.link(visible => visible && this.updateNode());
  }

  // No dispose needed, instances of this type persist for lifetime of the sim.

  /**
   * Updates this node's entire geometry and layout
   */
  updateNode() {
    if (this.visible) {
      const atomCounts = this.equationProperty.value.getAtomCounts();

      // reactant bars
      this.updateBars(this.reactantCountProperties, this.reactantBarsParent, atomCounts, atomCount => atomCount.reactantsCount, this.aligner.getReactantsBoxCenterX());

      // product bars
      this.updateBars(this.productCountProperties, this.productBarsParent, atomCounts, atomCount => atomCount.productsCount, this.aligner.getProductsBoxCenterX());
      this.updateCounts();
    }
  }

  /**
   * Updates one set of bars (reactants or products).
   * @param countProperties - map of Element to count for that Element
   * @param parentNode
   * @param atomCounts - counts of each atom in the equation
   * @param getCount - gets the reactants or products count
   * @param centerX - centerX of the chart
   */
  updateBars(countProperties, parentNode, atomCounts, getCount, centerX) {
    if (this.visible) {
      // Dispose and remove previous bars
      parentNode.getChildren().forEach(child => child.dispose());
      parentNode.removeAllChildren();

      // Clear the map.
      countProperties.clear();
      let barCenterX = 0;
      for (let i = 0; i < atomCounts.length; i++) {
        const atomCount = atomCounts[i];

        // populate the map
        const countProperty = new NumberProperty(getCount(atomCount), {
          numberType: 'Integer'
        });
        countProperties.set(atomCount.element, countProperty);

        // add a bar node
        const barNode = new BarNode(atomCount.element, countProperty, {
          centerX: barCenterX,
          bottom: 0
        });
        parentNode.addChild(barNode);
        barCenterX = barNode.centerX + 100;
      }
      parentNode.centerX = centerX;
    }
  }

  /**
   * Updates the atom counts for each bar.
   */
  updateCounts() {
    if (this.visible) {
      const atomCounts = this.equationProperty.value.getAtomCounts();
      for (let i = 0; i < atomCounts.length; i++) {
        const atomCount = atomCounts[i];
        const reactantCountProperty = this.reactantCountProperties.get(atomCount.element);
        assert && assert(reactantCountProperty);
        reactantCountProperty.value = atomCount.reactantsCount;
        const productCountProperty = this.productCountProperties.get(atomCount.element);
        assert && assert(productCountProperty);
        productCountProperty.value = atomCount.productsCount;
      }
    }
  }
}
balancingChemicalEquations.register('BarChartsNode', BarChartsNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOdW1iZXJQcm9wZXJ0eSIsIlZlY3RvcjIiLCJOb2RlIiwiYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMiLCJCYXJOb2RlIiwiRXF1YWxpdHlPcGVyYXRvck5vZGUiLCJvcHRpb25pemUiLCJCYXJDaGFydHNOb2RlIiwiY29uc3RydWN0b3IiLCJlcXVhdGlvblByb3BlcnR5IiwiYWxpZ25lciIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJyZWFjdGFudENvdW50UHJvcGVydGllcyIsIk1hcCIsInByb2R1Y3RDb3VudFByb3BlcnRpZXMiLCJyZWFjdGFudEJhcnNQYXJlbnQiLCJwcm9kdWN0QmFyc1BhcmVudCIsImVxdWFsaXR5T3BlcmF0b3JOb2RlIiwiY2VudGVyIiwiZ2V0U2NyZWVuQ2VudGVyWCIsImNoaWxkcmVuIiwiY29lZmZpY2llbnRzT2JzZXJ2ZXIiLCJ1cGRhdGVDb3VudHMiLCJiaW5kIiwibGluayIsIm5ld0VxdWF0aW9uIiwib2xkRXF1YXRpb24iLCJ1cGRhdGVOb2RlIiwicmVtb3ZlQ29lZmZpY2llbnRzT2JzZXJ2ZXIiLCJhZGRDb2VmZmljaWVudHNPYnNlcnZlciIsIm11dGF0ZSIsInZpc2libGVQcm9wZXJ0eSIsInZpc2libGUiLCJhdG9tQ291bnRzIiwidmFsdWUiLCJnZXRBdG9tQ291bnRzIiwidXBkYXRlQmFycyIsImF0b21Db3VudCIsInJlYWN0YW50c0NvdW50IiwiZ2V0UmVhY3RhbnRzQm94Q2VudGVyWCIsInByb2R1Y3RzQ291bnQiLCJnZXRQcm9kdWN0c0JveENlbnRlclgiLCJjb3VudFByb3BlcnRpZXMiLCJwYXJlbnROb2RlIiwiZ2V0Q291bnQiLCJjZW50ZXJYIiwiZ2V0Q2hpbGRyZW4iLCJmb3JFYWNoIiwiY2hpbGQiLCJkaXNwb3NlIiwicmVtb3ZlQWxsQ2hpbGRyZW4iLCJjbGVhciIsImJhckNlbnRlclgiLCJpIiwibGVuZ3RoIiwiY291bnRQcm9wZXJ0eSIsIm51bWJlclR5cGUiLCJzZXQiLCJlbGVtZW50IiwiYmFyTm9kZSIsImJvdHRvbSIsImFkZENoaWxkIiwicmVhY3RhbnRDb3VudFByb3BlcnR5IiwiZ2V0IiwiYXNzZXJ0IiwicHJvZHVjdENvdW50UHJvcGVydHkiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJhckNoYXJ0c05vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIGFuIGVxdWF0aW9uIGFzIGEgcGFpciBvZiBiYXIgY2hhcnRzLCBmb3IgbGVmdCBhbmQgcmlnaHQgc2lkZSBvZiBlcXVhdGlvbi5cclxuICogQW4gaW5kaWNhdG9yIGJldHdlZW4gdGhlIGNoYXJ0cyAoZXF1YWxzIG9yIG5vdCBlcXVhbHMpIGluZGljYXRlcyB3aGV0aGVyIHRoZXkgYXJlIGJhbGFuY2VkLlxyXG4gKlxyXG4gKiBUaGlzIGltcGxlbWVudGF0aW9uIGlzIHZlcnkgYnJ1dGUgZm9yY2UsIGp1c3QgYWJvdXQgZXZlcnl0aGluZyBpcyByZWNyZWF0ZWQgZWFjaCB0aW1lXHJcbiAqIGEgY29lZmZpY2llbnQgaXMgY2hhbmdlZCBpbiB0aGUgZXF1YXRpb25zLiAgQnV0IHdlIGhhdmUgYSBzbWFsbCBudW1iZXIgb2YgY29lZmZpY2llbnRzLFxyXG4gKiBhbmQgbm90aGluZyBlbHNlIGlzIGhhcHBlbmluZyBpbiB0aGUgc2ltLiAgU28gd2UncmUgdHJhZGluZyBlZmZpY2llbmN5IGZvciBzaW1wbGljaXR5IG9mXHJcbiAqIGltcGxlbWVudGF0aW9uLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFZhc2lseSBTaGFraG92IChtbGVhcm5lci5jb20pXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IEVsZW1lbnQgZnJvbSAnLi4vLi4vLi4vLi4vbml0cm9nbHljZXJpbi9qcy9FbGVtZW50LmpzJztcclxuaW1wb3J0IE51bWJlclByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTnVtYmVyUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBOb2RlT3B0aW9ucywgTm9kZVRyYW5zbGF0aW9uT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBiYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucyBmcm9tICcuLi8uLi9iYWxhbmNpbmdDaGVtaWNhbEVxdWF0aW9ucy5qcyc7XHJcbmltcG9ydCBFcXVhdGlvbiBmcm9tICcuLi9tb2RlbC9FcXVhdGlvbi5qcyc7XHJcbmltcG9ydCBCYXJOb2RlIGZyb20gJy4vQmFyTm9kZS5qcyc7XHJcbmltcG9ydCBFcXVhbGl0eU9wZXJhdG9yTm9kZSBmcm9tICcuL0VxdWFsaXR5T3BlcmF0b3JOb2RlLmpzJztcclxuaW1wb3J0IEhvcml6b250YWxBbGlnbmVyIGZyb20gJy4vSG9yaXpvbnRhbEFsaWduZXIuanMnO1xyXG5pbXBvcnQgQXRvbUNvdW50IGZyb20gJy4uL21vZGVsL0F0b21Db3VudC5qcyc7XHJcbmltcG9ydCBvcHRpb25pemUsIHsgRW1wdHlTZWxmT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IEVtcHR5U2VsZk9wdGlvbnM7XHJcblxyXG50eXBlIEJhckNoYXJ0c05vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBOb2RlVHJhbnNsYXRpb25PcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQmFyQ2hhcnRzTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGVxdWF0aW9uUHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PEVxdWF0aW9uPjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGFsaWduZXI6IEhvcml6b250YWxBbGlnbmVyO1xyXG5cclxuICAvLyBtYXBzIEVsZW1lbnQgdG8gY291bnQgZm9yIHRoYXQgRWxlbWVudFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVhY3RhbnRDb3VudFByb3BlcnRpZXM6IE1hcDxFbGVtZW50LCBQcm9wZXJ0eTxudW1iZXI+PjtcclxuICBwcml2YXRlIHJlYWRvbmx5IHByb2R1Y3RDb3VudFByb3BlcnRpZXM6IE1hcDxFbGVtZW50LCBQcm9wZXJ0eTxudW1iZXI+PjtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSByZWFjdGFudEJhcnNQYXJlbnQ6IE5vZGU7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBwcm9kdWN0QmFyc1BhcmVudDogTm9kZTtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGVxdWF0aW9uUHJvcGVydHkgLSB0aGUgZXF1YXRpb24gdGhhdCB0aGUgc2NhbGVzIGFyZSByZXByZXNlbnRpbmdcclxuICAgKiBAcGFyYW0gYWxpZ25lciAtIHByb3ZpZGVzIGxheW91dCBpbmZvcm1hdGlvbiB0byBlbnN1cmUgaG9yaXpvbnRhbCBhbGlnbm1lbnQgd2l0aCBvdGhlciB1c2VyLWludGVyZmFjZSBlbGVtZW50c1xyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggZXF1YXRpb25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8RXF1YXRpb24+LCBhbGlnbmVyOiBIb3Jpem9udGFsQWxpZ25lcixcclxuICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkT3B0aW9ucz86IEJhckNoYXJ0c05vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8QmFyQ2hhcnRzTm9kZU9wdGlvbnMsIFNlbGZPcHRpb25zLCBOb2RlT3B0aW9ucz4oKSgge30sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5lcXVhdGlvblByb3BlcnR5ID0gZXF1YXRpb25Qcm9wZXJ0eTtcclxuICAgIHRoaXMuYWxpZ25lciA9IGFsaWduZXI7XHJcblxyXG4gICAgdGhpcy5yZWFjdGFudENvdW50UHJvcGVydGllcyA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMucHJvZHVjdENvdW50UHJvcGVydGllcyA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICB0aGlzLnJlYWN0YW50QmFyc1BhcmVudCA9IG5ldyBOb2RlKCk7XHJcbiAgICB0aGlzLnByb2R1Y3RCYXJzUGFyZW50ID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICBjb25zdCBlcXVhbGl0eU9wZXJhdG9yTm9kZSA9IG5ldyBFcXVhbGl0eU9wZXJhdG9yTm9kZSggZXF1YXRpb25Qcm9wZXJ0eSwge1xyXG4gICAgICBjZW50ZXI6IG5ldyBWZWN0b3IyKCBhbGlnbmVyLmdldFNjcmVlbkNlbnRlclgoKSwgLTQwIClcclxuICAgIH0gKTtcclxuXHJcbiAgICBvcHRpb25zLmNoaWxkcmVuID0gWyB0aGlzLnJlYWN0YW50QmFyc1BhcmVudCwgdGhpcy5wcm9kdWN0QmFyc1BhcmVudCwgZXF1YWxpdHlPcGVyYXRvck5vZGUgXTtcclxuXHJcbiAgICAvLyBXaXJlIGNvZWZmaWNpZW50cyBvYnNlcnZlciB0byBjdXJyZW50IGVxdWF0aW9uLlxyXG4gICAgY29uc3QgY29lZmZpY2llbnRzT2JzZXJ2ZXIgPSB0aGlzLnVwZGF0ZUNvdW50cy5iaW5kKCB0aGlzICk7XHJcbiAgICBlcXVhdGlvblByb3BlcnR5LmxpbmsoICggbmV3RXF1YXRpb24sIG9sZEVxdWF0aW9uICkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZU5vZGUoKTtcclxuICAgICAgaWYgKCBvbGRFcXVhdGlvbiApIHsgb2xkRXF1YXRpb24ucmVtb3ZlQ29lZmZpY2llbnRzT2JzZXJ2ZXIoIGNvZWZmaWNpZW50c09ic2VydmVyICk7IH1cclxuICAgICAgbmV3RXF1YXRpb24uYWRkQ29lZmZpY2llbnRzT2JzZXJ2ZXIoIGNvZWZmaWNpZW50c09ic2VydmVyICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5tdXRhdGUoIG9wdGlvbnMgKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgdGhpcyBOb2RlIHdoZW4gaXQgYmVjb21lcyB2aXNpYmxlLlxyXG4gICAgdGhpcy52aXNpYmxlUHJvcGVydHkubGluayggdmlzaWJsZSA9PiB2aXNpYmxlICYmIHRoaXMudXBkYXRlTm9kZSgpICk7XHJcbiAgfVxyXG5cclxuICAvLyBObyBkaXNwb3NlIG5lZWRlZCwgaW5zdGFuY2VzIG9mIHRoaXMgdHlwZSBwZXJzaXN0IGZvciBsaWZldGltZSBvZiB0aGUgc2ltLlxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoaXMgbm9kZSdzIGVudGlyZSBnZW9tZXRyeSBhbmQgbGF5b3V0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVOb2RlKCk6IHZvaWQge1xyXG4gICAgaWYgKCB0aGlzLnZpc2libGUgKSB7XHJcbiAgICAgIGNvbnN0IGF0b21Db3VudHMgPSB0aGlzLmVxdWF0aW9uUHJvcGVydHkudmFsdWUuZ2V0QXRvbUNvdW50cygpO1xyXG5cclxuICAgICAgLy8gcmVhY3RhbnQgYmFyc1xyXG4gICAgICB0aGlzLnVwZGF0ZUJhcnMoXHJcbiAgICAgICAgdGhpcy5yZWFjdGFudENvdW50UHJvcGVydGllcyxcclxuICAgICAgICB0aGlzLnJlYWN0YW50QmFyc1BhcmVudCxcclxuICAgICAgICBhdG9tQ291bnRzLFxyXG4gICAgICAgIGF0b21Db3VudCA9PiBhdG9tQ291bnQucmVhY3RhbnRzQ291bnQsXHJcbiAgICAgICAgdGhpcy5hbGlnbmVyLmdldFJlYWN0YW50c0JveENlbnRlclgoKVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gcHJvZHVjdCBiYXJzXHJcbiAgICAgIHRoaXMudXBkYXRlQmFycyhcclxuICAgICAgICB0aGlzLnByb2R1Y3RDb3VudFByb3BlcnRpZXMsXHJcbiAgICAgICAgdGhpcy5wcm9kdWN0QmFyc1BhcmVudCxcclxuICAgICAgICBhdG9tQ291bnRzLFxyXG4gICAgICAgIGF0b21Db3VudCA9PiBhdG9tQ291bnQucHJvZHVjdHNDb3VudCxcclxuICAgICAgICB0aGlzLmFsaWduZXIuZ2V0UHJvZHVjdHNCb3hDZW50ZXJYKClcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHRoaXMudXBkYXRlQ291bnRzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIG9uZSBzZXQgb2YgYmFycyAocmVhY3RhbnRzIG9yIHByb2R1Y3RzKS5cclxuICAgKiBAcGFyYW0gY291bnRQcm9wZXJ0aWVzIC0gbWFwIG9mIEVsZW1lbnQgdG8gY291bnQgZm9yIHRoYXQgRWxlbWVudFxyXG4gICAqIEBwYXJhbSBwYXJlbnROb2RlXHJcbiAgICogQHBhcmFtIGF0b21Db3VudHMgLSBjb3VudHMgb2YgZWFjaCBhdG9tIGluIHRoZSBlcXVhdGlvblxyXG4gICAqIEBwYXJhbSBnZXRDb3VudCAtIGdldHMgdGhlIHJlYWN0YW50cyBvciBwcm9kdWN0cyBjb3VudFxyXG4gICAqIEBwYXJhbSBjZW50ZXJYIC0gY2VudGVyWCBvZiB0aGUgY2hhcnRcclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlQmFycyggY291bnRQcm9wZXJ0aWVzOiBNYXA8RWxlbWVudCwgUHJvcGVydHk8bnVtYmVyPj4sIHBhcmVudE5vZGU6IE5vZGUsIGF0b21Db3VudHM6IEF0b21Db3VudFtdLFxyXG4gICAgICAgICAgICAgICAgICAgICBnZXRDb3VudDogKCBhdG9tQ291bnQ6IEF0b21Db3VudCApID0+IG51bWJlciwgY2VudGVyWDogbnVtYmVyICk6IHZvaWQge1xyXG5cclxuICAgIGlmICggdGhpcy52aXNpYmxlICkge1xyXG5cclxuICAgICAgLy8gRGlzcG9zZSBhbmQgcmVtb3ZlIHByZXZpb3VzIGJhcnNcclxuICAgICAgcGFyZW50Tm9kZS5nZXRDaGlsZHJlbigpLmZvckVhY2goIGNoaWxkID0+IGNoaWxkLmRpc3Bvc2UoKSApO1xyXG4gICAgICBwYXJlbnROb2RlLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgICAvLyBDbGVhciB0aGUgbWFwLlxyXG4gICAgICBjb3VudFByb3BlcnRpZXMuY2xlYXIoKTtcclxuXHJcbiAgICAgIGxldCBiYXJDZW50ZXJYID0gMDtcclxuICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgYXRvbUNvdW50cy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBjb25zdCBhdG9tQ291bnQgPSBhdG9tQ291bnRzWyBpIF07XHJcblxyXG4gICAgICAgIC8vIHBvcHVsYXRlIHRoZSBtYXBcclxuICAgICAgICBjb25zdCBjb3VudFByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBnZXRDb3VudCggYXRvbUNvdW50ICksIHsgbnVtYmVyVHlwZTogJ0ludGVnZXInIH0gKTtcclxuICAgICAgICBjb3VudFByb3BlcnRpZXMuc2V0KCBhdG9tQ291bnQuZWxlbWVudCwgY291bnRQcm9wZXJ0eSApO1xyXG5cclxuICAgICAgICAvLyBhZGQgYSBiYXIgbm9kZVxyXG4gICAgICAgIGNvbnN0IGJhck5vZGUgPSBuZXcgQmFyTm9kZSggYXRvbUNvdW50LmVsZW1lbnQsIGNvdW50UHJvcGVydHksIHtcclxuICAgICAgICAgIGNlbnRlclg6IGJhckNlbnRlclgsXHJcbiAgICAgICAgICBib3R0b206IDBcclxuICAgICAgICB9ICk7XHJcbiAgICAgICAgcGFyZW50Tm9kZS5hZGRDaGlsZCggYmFyTm9kZSApO1xyXG4gICAgICAgIGJhckNlbnRlclggPSBiYXJOb2RlLmNlbnRlclggKyAxMDA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHBhcmVudE5vZGUuY2VudGVyWCA9IGNlbnRlclg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoZSBhdG9tIGNvdW50cyBmb3IgZWFjaCBiYXIuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVDb3VudHMoKTogdm9pZCB7XHJcbiAgICBpZiAoIHRoaXMudmlzaWJsZSApIHtcclxuICAgICAgY29uc3QgYXRvbUNvdW50cyA9IHRoaXMuZXF1YXRpb25Qcm9wZXJ0eS52YWx1ZS5nZXRBdG9tQ291bnRzKCk7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGF0b21Db3VudHMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgICAgY29uc3QgYXRvbUNvdW50ID0gYXRvbUNvdW50c1sgaSBdO1xyXG5cclxuICAgICAgICBjb25zdCByZWFjdGFudENvdW50UHJvcGVydHkgPSB0aGlzLnJlYWN0YW50Q291bnRQcm9wZXJ0aWVzLmdldCggYXRvbUNvdW50LmVsZW1lbnQgKSE7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggcmVhY3RhbnRDb3VudFByb3BlcnR5ICk7XHJcbiAgICAgICAgcmVhY3RhbnRDb3VudFByb3BlcnR5LnZhbHVlID0gYXRvbUNvdW50LnJlYWN0YW50c0NvdW50O1xyXG5cclxuICAgICAgICBjb25zdCBwcm9kdWN0Q291bnRQcm9wZXJ0eSA9IHRoaXMucHJvZHVjdENvdW50UHJvcGVydGllcy5nZXQoIGF0b21Db3VudC5lbGVtZW50ICkhO1xyXG4gICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHByb2R1Y3RDb3VudFByb3BlcnR5ICk7XHJcbiAgICAgICAgcHJvZHVjdENvdW50UHJvcGVydHkudmFsdWUgPSBhdG9tQ291bnQucHJvZHVjdHNDb3VudDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMucmVnaXN0ZXIoICdCYXJDaGFydHNOb2RlJywg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