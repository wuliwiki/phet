// Copyright 2014-2023, University of Colorado Boulder

/**
 * Displays a chemical equation.
 * Reactants are on the left-hand size, products are on the right-hand side.
 *
 * @author Vasily Shakhov (mlearner.com)
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import PlusNode from '../../../../scenery-phet/js/PlusNode.js';
import { Node } from '../../../../scenery/js/imports.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import RightArrowNode from './RightArrowNode.js';
import TermNode from './TermNode.js';
import optionize from '../../../../phet-core/js/optionize.js';
export default class EquationNode extends Node {
  // the set of TermNodes in the equation

  // the parent for all terms and the "+" operators

  /**
   * @param equationProperty
   * @param coefficientRange - range of the coefficients
   * @param aligner - provides layout information to ensure horizontal alignment with other user-interface elements
   * @param [providedOptions]
   */
  constructor(equationProperty, coefficientRange, aligner, providedOptions) {
    const options = optionize()({
      // SelfOptions
      fontSize: 32
    }, providedOptions);
    super();
    this.equationProperty = equationProperty;
    this.coefficientRange = coefficientRange;
    this.aligner = aligner;
    this.fontSize = options.fontSize;

    // arrow node, at a fixed position
    this.arrowNode = new RightArrowNode(equationProperty, {
      centerX: this.aligner.getScreenCenterX()
    });
    this.addChild(this.arrowNode);
    this.terms = [];
    this.termsParent = new Node();
    this.addChild(this.termsParent);

    // if the equation changes...
    equationProperty.link((newEquation, oldEquation) => this.updateNode());
    this.mutate(options);
  }

  // No dispose needed, instances of this type persist for lifetime of the sim.

  /**
   * Rebuilds the left and right sides of the equation.
   */
  updateNode() {
    // dispose of existing instances of TermNode
    this.terms.forEach(termNode => termNode.dispose());
    this.terms.length = 0;
    this.termsParent.removeAllChildren();
    const equation = this.equationProperty.value;
    this.updateSideOfEquation(equation.reactants, this.aligner.getReactantXOffsets(equation), this.aligner.getReactantsBoxLeft(), this.aligner.getReactantsBoxRight());
    this.updateSideOfEquation(equation.products, this.aligner.getProductXOffsets(equation), this.aligner.getProductsBoxLeft(), this.aligner.getScreenRight());
  }

  /**
   * Rebuilds one side of the equation.
   * @param terms
   * @param xOffsets
   * @param minX - minimal possible x for equation
   * @param maxX - maximum possible x for equation
   */
  updateSideOfEquation(terms, xOffsets, minX, maxX) {
    assert && assert(terms.length > 0);
    let plusNode;
    let termNode = null;
    const minSeparation = 15;
    const tempNodes = []; // contains all nodes for position adjustment if needed

    for (let i = 0; i < terms.length; i++) {
      // term
      termNode = new TermNode(this.coefficientRange, terms[i], {
        fontSize: this.fontSize
      });
      this.terms.push(termNode);
      this.termsParent.addChild(termNode);
      termNode.center = new Vector2(xOffsets[i], 0);

      // if node over previous plusNode move node to the right
      if (i > 0) {
        if (termNode.bounds.minX - minSeparation < tempNodes[tempNodes.length - 1].bounds.maxX) {
          termNode.x += tempNodes[tempNodes.length - 1].bounds.maxX - (termNode.bounds.minX - minSeparation);
        }
      }
      tempNodes.push(termNode);
      if (terms.length > 1 && i < terms.length - 1) {
        plusNode = new PlusNode();
        this.termsParent.addChild(plusNode);
        plusNode.centerX = xOffsets[i] + (xOffsets[i + 1] - xOffsets[i]) / 2; // centered between 2 offsets;
        plusNode.centerY = termNode.centerY;
        tempNodes.push(plusNode);

        // if previous node over plusNode move node to the left
        if (termNode.bounds.maxX + minSeparation > plusNode.bounds.minX) {
          termNode.x = termNode.x - (termNode.bounds.maxX + minSeparation - plusNode.bounds.minX);
        }
      }
    }

    // check if equation fits minX (eg, C2H5OH + 3O2 -> 2CO2 + 3H2O)
    if (tempNodes[0].bounds.minX < minX) {
      // adjust all terms to the right
      let rightBound = minX; // current right bound of passed terms, if term.minX<rightBound move term to the right
      tempNodes.forEach(term => {
        term.x += Math.max(0, rightBound - term.bounds.minX);
        rightBound = term.bounds.maxX + minSeparation;
      });
    }

    // check if equation fits maxX (eg, CH3OH -> CO + 2H2)
    if (tempNodes[tempNodes.length - 1].bounds.maxX > maxX) {
      // adjust all terms to the left
      let leftBound = maxX; // current left bound of passed terms, if term.maxX > leftBound, move term to the left
      for (let i = tempNodes.length - 1; i > -1; i--) {
        const term = tempNodes[i];
        term.x -= Math.max(0, term.bounds.maxX - leftBound);
        leftBound = term.bounds.minX - minSeparation;
      }
    }
    assert && assert(termNode);
    this.arrowNode.centerY = termNode.centerY;
  }

  /**
   * Enables or disables the highlighting feature.
   * When enabled, the arrow between the left and right sides of the equation will light up when the equation is balanced.
   * This is enabled by default, but we want to disable in the Game until the user presses the "Check" button.
   */
  setBalancedHighlightEnabled(enabled) {
    this.arrowNode.setHighlightEnabled(enabled);
  }

  /**
   * Sets whether coefficients are editable, by showing/hiding the arrows on the NumberPicker associated with each term.
   */
  setCoefficientsEditable(editable) {
    for (let i = 0; i < this.terms.length; i++) {
      this.terms[i].setCoefficientEditable(editable);
    }
  }
}
balancingChemicalEquations.register('EquationNode', EquationNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwiUGx1c05vZGUiLCJOb2RlIiwiYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMiLCJSaWdodEFycm93Tm9kZSIsIlRlcm1Ob2RlIiwib3B0aW9uaXplIiwiRXF1YXRpb25Ob2RlIiwiY29uc3RydWN0b3IiLCJlcXVhdGlvblByb3BlcnR5IiwiY29lZmZpY2llbnRSYW5nZSIsImFsaWduZXIiLCJwcm92aWRlZE9wdGlvbnMiLCJvcHRpb25zIiwiZm9udFNpemUiLCJhcnJvd05vZGUiLCJjZW50ZXJYIiwiZ2V0U2NyZWVuQ2VudGVyWCIsImFkZENoaWxkIiwidGVybXMiLCJ0ZXJtc1BhcmVudCIsImxpbmsiLCJuZXdFcXVhdGlvbiIsIm9sZEVxdWF0aW9uIiwidXBkYXRlTm9kZSIsIm11dGF0ZSIsImZvckVhY2giLCJ0ZXJtTm9kZSIsImRpc3Bvc2UiLCJsZW5ndGgiLCJyZW1vdmVBbGxDaGlsZHJlbiIsImVxdWF0aW9uIiwidmFsdWUiLCJ1cGRhdGVTaWRlT2ZFcXVhdGlvbiIsInJlYWN0YW50cyIsImdldFJlYWN0YW50WE9mZnNldHMiLCJnZXRSZWFjdGFudHNCb3hMZWZ0IiwiZ2V0UmVhY3RhbnRzQm94UmlnaHQiLCJwcm9kdWN0cyIsImdldFByb2R1Y3RYT2Zmc2V0cyIsImdldFByb2R1Y3RzQm94TGVmdCIsImdldFNjcmVlblJpZ2h0IiwieE9mZnNldHMiLCJtaW5YIiwibWF4WCIsImFzc2VydCIsInBsdXNOb2RlIiwibWluU2VwYXJhdGlvbiIsInRlbXBOb2RlcyIsImkiLCJwdXNoIiwiY2VudGVyIiwiYm91bmRzIiwieCIsImNlbnRlclkiLCJyaWdodEJvdW5kIiwidGVybSIsIk1hdGgiLCJtYXgiLCJsZWZ0Qm91bmQiLCJzZXRCYWxhbmNlZEhpZ2hsaWdodEVuYWJsZWQiLCJlbmFibGVkIiwic2V0SGlnaGxpZ2h0RW5hYmxlZCIsInNldENvZWZmaWNpZW50c0VkaXRhYmxlIiwiZWRpdGFibGUiLCJzZXRDb2VmZmljaWVudEVkaXRhYmxlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFcXVhdGlvbk5vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGlzcGxheXMgYSBjaGVtaWNhbCBlcXVhdGlvbi5cclxuICogUmVhY3RhbnRzIGFyZSBvbiB0aGUgbGVmdC1oYW5kIHNpemUsIHByb2R1Y3RzIGFyZSBvbiB0aGUgcmlnaHQtaGFuZCBzaWRlLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFZhc2lseSBTaGFraG92IChtbGVhcm5lci5jb20pXHJcbiAqL1xyXG5cclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWZWN0b3IyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9WZWN0b3IyLmpzJztcclxuaW1wb3J0IFBsdXNOb2RlIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QbHVzTm9kZS5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIE5vZGVPcHRpb25zLCBOb2RlVHJhbnNsYXRpb25PcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIGZyb20gJy4uLy4uL2JhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zLmpzJztcclxuaW1wb3J0IFJpZ2h0QXJyb3dOb2RlIGZyb20gJy4vUmlnaHRBcnJvd05vZGUuanMnO1xyXG5pbXBvcnQgVGVybU5vZGUgZnJvbSAnLi9UZXJtTm9kZS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IEhvcml6b250YWxBbGlnbmVyIGZyb20gJy4vSG9yaXpvbnRhbEFsaWduZXIuanMnO1xyXG5pbXBvcnQgRXF1YXRpb24gZnJvbSAnLi4vbW9kZWwvRXF1YXRpb24uanMnO1xyXG5pbXBvcnQgb3B0aW9uaXplIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9vcHRpb25pemUuanMnO1xyXG5pbXBvcnQgRXF1YXRpb25UZXJtIGZyb20gJy4uL21vZGVsL0VxdWF0aW9uVGVybS5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG4gIGZvbnRTaXplPzogbnVtYmVyO1xyXG59O1xyXG5cclxudHlwZSBFcXVhdGlvbk5vZGVPcHRpb25zID0gU2VsZk9wdGlvbnMgJiBOb2RlVHJhbnNsYXRpb25PcHRpb25zO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXF1YXRpb25Ob2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZXF1YXRpb25Qcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8RXF1YXRpb24+O1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY29lZmZpY2llbnRSYW5nZTogUmFuZ2U7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBhbGlnbmVyOiBIb3Jpem9udGFsQWxpZ25lcjtcclxuICBwcml2YXRlIHJlYWRvbmx5IGZvbnRTaXplOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBhcnJvd05vZGU6IFJpZ2h0QXJyb3dOb2RlO1xyXG5cclxuICAvLyB0aGUgc2V0IG9mIFRlcm1Ob2RlcyBpbiB0aGUgZXF1YXRpb25cclxuICBwcml2YXRlIHJlYWRvbmx5IHRlcm1zOiBUZXJtTm9kZVtdO1xyXG5cclxuICAvLyB0aGUgcGFyZW50IGZvciBhbGwgdGVybXMgYW5kIHRoZSBcIitcIiBvcGVyYXRvcnNcclxuICBwcml2YXRlIHJlYWRvbmx5IHRlcm1zUGFyZW50OiBOb2RlO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gZXF1YXRpb25Qcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBjb2VmZmljaWVudFJhbmdlIC0gcmFuZ2Ugb2YgdGhlIGNvZWZmaWNpZW50c1xyXG4gICAqIEBwYXJhbSBhbGlnbmVyIC0gcHJvdmlkZXMgbGF5b3V0IGluZm9ybWF0aW9uIHRvIGVuc3VyZSBob3Jpem9udGFsIGFsaWdubWVudCB3aXRoIG90aGVyIHVzZXItaW50ZXJmYWNlIGVsZW1lbnRzXHJcbiAgICogQHBhcmFtIFtwcm92aWRlZE9wdGlvbnNdXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCBlcXVhdGlvblByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxFcXVhdGlvbj4sIGNvZWZmaWNpZW50UmFuZ2U6IFJhbmdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgYWxpZ25lcjogSG9yaXpvbnRhbEFsaWduZXIsIHByb3ZpZGVkT3B0aW9ucz86IEVxdWF0aW9uTm9kZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxFcXVhdGlvbk5vZGVPcHRpb25zLCBTZWxmT3B0aW9ucywgTm9kZU9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIGZvbnRTaXplOiAzMlxyXG4gICAgfSwgcHJvdmlkZWRPcHRpb25zICk7XHJcblxyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLmVxdWF0aW9uUHJvcGVydHkgPSBlcXVhdGlvblByb3BlcnR5O1xyXG4gICAgdGhpcy5jb2VmZmljaWVudFJhbmdlID0gY29lZmZpY2llbnRSYW5nZTtcclxuICAgIHRoaXMuYWxpZ25lciA9IGFsaWduZXI7XHJcbiAgICB0aGlzLmZvbnRTaXplID0gb3B0aW9ucy5mb250U2l6ZTtcclxuXHJcbiAgICAvLyBhcnJvdyBub2RlLCBhdCBhIGZpeGVkIHBvc2l0aW9uXHJcbiAgICB0aGlzLmFycm93Tm9kZSA9IG5ldyBSaWdodEFycm93Tm9kZSggZXF1YXRpb25Qcm9wZXJ0eSwge1xyXG4gICAgICBjZW50ZXJYOiB0aGlzLmFsaWduZXIuZ2V0U2NyZWVuQ2VudGVyWCgpXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLmFycm93Tm9kZSApO1xyXG5cclxuICAgIHRoaXMudGVybXMgPSBbXTtcclxuICAgIHRoaXMudGVybXNQYXJlbnQgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy50ZXJtc1BhcmVudCApO1xyXG5cclxuICAgIC8vIGlmIHRoZSBlcXVhdGlvbiBjaGFuZ2VzLi4uXHJcbiAgICBlcXVhdGlvblByb3BlcnR5LmxpbmsoICggbmV3RXF1YXRpb24sIG9sZEVxdWF0aW9uICkgPT4gdGhpcy51cGRhdGVOb2RlKCkgKTtcclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG4gIH1cclxuXHJcbiAgLy8gTm8gZGlzcG9zZSBuZWVkZWQsIGluc3RhbmNlcyBvZiB0aGlzIHR5cGUgcGVyc2lzdCBmb3IgbGlmZXRpbWUgb2YgdGhlIHNpbS5cclxuXHJcbiAgLyoqXHJcbiAgICogUmVidWlsZHMgdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGVzIG9mIHRoZSBlcXVhdGlvbi5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZU5vZGUoKTogdm9pZCB7XHJcblxyXG4gICAgLy8gZGlzcG9zZSBvZiBleGlzdGluZyBpbnN0YW5jZXMgb2YgVGVybU5vZGVcclxuICAgIHRoaXMudGVybXMuZm9yRWFjaCggdGVybU5vZGUgPT4gdGVybU5vZGUuZGlzcG9zZSgpICk7XHJcbiAgICB0aGlzLnRlcm1zLmxlbmd0aCA9IDA7XHJcbiAgICB0aGlzLnRlcm1zUGFyZW50LnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcblxyXG4gICAgY29uc3QgZXF1YXRpb24gPSB0aGlzLmVxdWF0aW9uUHJvcGVydHkudmFsdWU7XHJcbiAgICB0aGlzLnVwZGF0ZVNpZGVPZkVxdWF0aW9uKCBlcXVhdGlvbi5yZWFjdGFudHMsIHRoaXMuYWxpZ25lci5nZXRSZWFjdGFudFhPZmZzZXRzKCBlcXVhdGlvbiApLFxyXG4gICAgICB0aGlzLmFsaWduZXIuZ2V0UmVhY3RhbnRzQm94TGVmdCgpLCB0aGlzLmFsaWduZXIuZ2V0UmVhY3RhbnRzQm94UmlnaHQoKSApO1xyXG4gICAgdGhpcy51cGRhdGVTaWRlT2ZFcXVhdGlvbiggZXF1YXRpb24ucHJvZHVjdHMsIHRoaXMuYWxpZ25lci5nZXRQcm9kdWN0WE9mZnNldHMoIGVxdWF0aW9uICksXHJcbiAgICAgIHRoaXMuYWxpZ25lci5nZXRQcm9kdWN0c0JveExlZnQoKSwgdGhpcy5hbGlnbmVyLmdldFNjcmVlblJpZ2h0KCkgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlYnVpbGRzIG9uZSBzaWRlIG9mIHRoZSBlcXVhdGlvbi5cclxuICAgKiBAcGFyYW0gdGVybXNcclxuICAgKiBAcGFyYW0geE9mZnNldHNcclxuICAgKiBAcGFyYW0gbWluWCAtIG1pbmltYWwgcG9zc2libGUgeCBmb3IgZXF1YXRpb25cclxuICAgKiBAcGFyYW0gbWF4WCAtIG1heGltdW0gcG9zc2libGUgeCBmb3IgZXF1YXRpb25cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZVNpZGVPZkVxdWF0aW9uKCB0ZXJtczogRXF1YXRpb25UZXJtW10sIHhPZmZzZXRzOiBudW1iZXJbXSwgbWluWDogbnVtYmVyLCBtYXhYOiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0ZXJtcy5sZW5ndGggPiAwICk7XHJcblxyXG4gICAgbGV0IHBsdXNOb2RlO1xyXG4gICAgbGV0IHRlcm1Ob2RlOiBUZXJtTm9kZSB8IG51bGwgPSBudWxsO1xyXG4gICAgY29uc3QgbWluU2VwYXJhdGlvbiA9IDE1O1xyXG4gICAgY29uc3QgdGVtcE5vZGVzID0gW107IC8vIGNvbnRhaW5zIGFsbCBub2RlcyBmb3IgcG9zaXRpb24gYWRqdXN0bWVudCBpZiBuZWVkZWRcclxuXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0ZXJtcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgLy8gdGVybVxyXG4gICAgICB0ZXJtTm9kZSA9IG5ldyBUZXJtTm9kZSggdGhpcy5jb2VmZmljaWVudFJhbmdlLCB0ZXJtc1sgaSBdLCB7IGZvbnRTaXplOiB0aGlzLmZvbnRTaXplIH0gKTtcclxuICAgICAgdGhpcy50ZXJtcy5wdXNoKCB0ZXJtTm9kZSApO1xyXG4gICAgICB0aGlzLnRlcm1zUGFyZW50LmFkZENoaWxkKCB0ZXJtTm9kZSApO1xyXG4gICAgICB0ZXJtTm9kZS5jZW50ZXIgPSBuZXcgVmVjdG9yMiggeE9mZnNldHNbIGkgXSwgMCApO1xyXG5cclxuICAgICAgLy8gaWYgbm9kZSBvdmVyIHByZXZpb3VzIHBsdXNOb2RlIG1vdmUgbm9kZSB0byB0aGUgcmlnaHRcclxuICAgICAgaWYgKCBpID4gMCApIHtcclxuICAgICAgICBpZiAoIHRlcm1Ob2RlLmJvdW5kcy5taW5YIC0gbWluU2VwYXJhdGlvbiA8IHRlbXBOb2Rlc1sgdGVtcE5vZGVzLmxlbmd0aCAtIDEgXS5ib3VuZHMubWF4WCApIHtcclxuICAgICAgICAgIHRlcm1Ob2RlLnggKz0gdGVtcE5vZGVzWyB0ZW1wTm9kZXMubGVuZ3RoIC0gMSBdLmJvdW5kcy5tYXhYIC0gKCB0ZXJtTm9kZS5ib3VuZHMubWluWCAtIG1pblNlcGFyYXRpb24gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgdGVtcE5vZGVzLnB1c2goIHRlcm1Ob2RlICk7XHJcblxyXG4gICAgICBpZiAoIHRlcm1zLmxlbmd0aCA+IDEgJiYgaSA8IHRlcm1zLmxlbmd0aCAtIDEgKSB7XHJcbiAgICAgICAgcGx1c05vZGUgPSBuZXcgUGx1c05vZGUoKTtcclxuICAgICAgICB0aGlzLnRlcm1zUGFyZW50LmFkZENoaWxkKCBwbHVzTm9kZSApO1xyXG4gICAgICAgIHBsdXNOb2RlLmNlbnRlclggPSB4T2Zmc2V0c1sgaSBdICsgKCAoIHhPZmZzZXRzWyBpICsgMSBdIC0geE9mZnNldHNbIGkgXSApIC8gMiApOyAvLyBjZW50ZXJlZCBiZXR3ZWVuIDIgb2Zmc2V0cztcclxuICAgICAgICBwbHVzTm9kZS5jZW50ZXJZID0gdGVybU5vZGUuY2VudGVyWTtcclxuICAgICAgICB0ZW1wTm9kZXMucHVzaCggcGx1c05vZGUgKTtcclxuXHJcbiAgICAgICAgLy8gaWYgcHJldmlvdXMgbm9kZSBvdmVyIHBsdXNOb2RlIG1vdmUgbm9kZSB0byB0aGUgbGVmdFxyXG4gICAgICAgIGlmICggdGVybU5vZGUuYm91bmRzLm1heFggKyBtaW5TZXBhcmF0aW9uID4gcGx1c05vZGUuYm91bmRzLm1pblggKSB7XHJcbiAgICAgICAgICB0ZXJtTm9kZS54ID0gdGVybU5vZGUueCAtICggdGVybU5vZGUuYm91bmRzLm1heFggKyBtaW5TZXBhcmF0aW9uIC0gcGx1c05vZGUuYm91bmRzLm1pblggKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBjaGVjayBpZiBlcXVhdGlvbiBmaXRzIG1pblggKGVnLCBDMkg1T0ggKyAzTzIgLT4gMkNPMiArIDNIMk8pXHJcbiAgICBpZiAoIHRlbXBOb2Rlc1sgMCBdLmJvdW5kcy5taW5YIDwgbWluWCApIHsgLy8gYWRqdXN0IGFsbCB0ZXJtcyB0byB0aGUgcmlnaHRcclxuICAgICAgbGV0IHJpZ2h0Qm91bmQgPSBtaW5YOyAvLyBjdXJyZW50IHJpZ2h0IGJvdW5kIG9mIHBhc3NlZCB0ZXJtcywgaWYgdGVybS5taW5YPHJpZ2h0Qm91bmQgbW92ZSB0ZXJtIHRvIHRoZSByaWdodFxyXG4gICAgICB0ZW1wTm9kZXMuZm9yRWFjaCggdGVybSA9PiB7XHJcbiAgICAgICAgdGVybS54ICs9IE1hdGgubWF4KCAwLCByaWdodEJvdW5kIC0gdGVybS5ib3VuZHMubWluWCApO1xyXG4gICAgICAgIHJpZ2h0Qm91bmQgPSB0ZXJtLmJvdW5kcy5tYXhYICsgbWluU2VwYXJhdGlvbjtcclxuICAgICAgfSApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNoZWNrIGlmIGVxdWF0aW9uIGZpdHMgbWF4WCAoZWcsIENIM09IIC0+IENPICsgMkgyKVxyXG4gICAgaWYgKCB0ZW1wTm9kZXNbIHRlbXBOb2Rlcy5sZW5ndGggLSAxIF0uYm91bmRzLm1heFggPiBtYXhYICkgeyAvLyBhZGp1c3QgYWxsIHRlcm1zIHRvIHRoZSBsZWZ0XHJcbiAgICAgIGxldCBsZWZ0Qm91bmQgPSBtYXhYOyAvLyBjdXJyZW50IGxlZnQgYm91bmQgb2YgcGFzc2VkIHRlcm1zLCBpZiB0ZXJtLm1heFggPiBsZWZ0Qm91bmQsIG1vdmUgdGVybSB0byB0aGUgbGVmdFxyXG4gICAgICBmb3IgKCBsZXQgaSA9IHRlbXBOb2Rlcy5sZW5ndGggLSAxOyBpID4gLTE7IGktLSApIHtcclxuICAgICAgICBjb25zdCB0ZXJtID0gdGVtcE5vZGVzWyBpIF07XHJcbiAgICAgICAgdGVybS54IC09IE1hdGgubWF4KCAwLCB0ZXJtLmJvdW5kcy5tYXhYIC0gbGVmdEJvdW5kICk7XHJcbiAgICAgICAgbGVmdEJvdW5kID0gdGVybS5ib3VuZHMubWluWCAtIG1pblNlcGFyYXRpb247XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0ZXJtTm9kZSApO1xyXG4gICAgdGhpcy5hcnJvd05vZGUuY2VudGVyWSA9IHRlcm1Ob2RlIS5jZW50ZXJZO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRW5hYmxlcyBvciBkaXNhYmxlcyB0aGUgaGlnaGxpZ2h0aW5nIGZlYXR1cmUuXHJcbiAgICogV2hlbiBlbmFibGVkLCB0aGUgYXJyb3cgYmV0d2VlbiB0aGUgbGVmdCBhbmQgcmlnaHQgc2lkZXMgb2YgdGhlIGVxdWF0aW9uIHdpbGwgbGlnaHQgdXAgd2hlbiB0aGUgZXF1YXRpb24gaXMgYmFsYW5jZWQuXHJcbiAgICogVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQsIGJ1dCB3ZSB3YW50IHRvIGRpc2FibGUgaW4gdGhlIEdhbWUgdW50aWwgdGhlIHVzZXIgcHJlc3NlcyB0aGUgXCJDaGVja1wiIGJ1dHRvbi5cclxuICAgKi9cclxuICBwdWJsaWMgc2V0QmFsYW5jZWRIaWdobGlnaHRFbmFibGVkKCBlbmFibGVkOiBib29sZWFuICk6IHZvaWQge1xyXG4gICAgdGhpcy5hcnJvd05vZGUuc2V0SGlnaGxpZ2h0RW5hYmxlZCggZW5hYmxlZCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0cyB3aGV0aGVyIGNvZWZmaWNpZW50cyBhcmUgZWRpdGFibGUsIGJ5IHNob3dpbmcvaGlkaW5nIHRoZSBhcnJvd3Mgb24gdGhlIE51bWJlclBpY2tlciBhc3NvY2lhdGVkIHdpdGggZWFjaCB0ZXJtLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRDb2VmZmljaWVudHNFZGl0YWJsZSggZWRpdGFibGU6IGJvb2xlYW4gKTogdm9pZCB7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnRlcm1zLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICB0aGlzLnRlcm1zWyBpIF0uc2V0Q29lZmZpY2llbnRFZGl0YWJsZSggZWRpdGFibGUgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zLnJlZ2lzdGVyKCAnRXF1YXRpb25Ob2RlJywgRXF1YXRpb25Ob2RlICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0EsT0FBT0EsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxRQUFRLE1BQU0seUNBQXlDO0FBQzlELFNBQVNDLElBQUksUUFBNkMsbUNBQW1DO0FBQzdGLE9BQU9DLDBCQUEwQixNQUFNLHFDQUFxQztBQUM1RSxPQUFPQyxjQUFjLE1BQU0scUJBQXFCO0FBQ2hELE9BQU9DLFFBQVEsTUFBTSxlQUFlO0FBSXBDLE9BQU9DLFNBQVMsTUFBTSx1Q0FBdUM7QUFTN0QsZUFBZSxNQUFNQyxZQUFZLFNBQVNMLElBQUksQ0FBQztFQVE3Qzs7RUFHQTs7RUFHQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDU00sV0FBV0EsQ0FBRUMsZ0JBQTZDLEVBQUVDLGdCQUF1QixFQUN0RUMsT0FBMEIsRUFBRUMsZUFBcUMsRUFBRztJQUV0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