// Copyright 2014-2023, University of Colorado Boulder

/**
 * Equation is the base class for all chemical equations.
 * A chemical equation has 2 sets of terms, reactants and products.
 * During the chemical reaction represented by the equation, reactants are transformed into products.
 * <p/>
 * An equation is "balanced" when each term's user coefficient is an integer multiple N of
 * the balanced coefficient, N is the same for all terms in the equation, and N >= 1.
 * An equation is "balanced and simplified" when it is balanced and N=1.
 *
 * @author Vasily Shakhov (mlearner.com)
 * @author Chris Malley (PixelZoom, Inc.)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import balancingChemicalEquations from '../../balancingChemicalEquations.js';
import AtomCount from './AtomCount.js';
export default class Equation {
  // terms on the left side of the equation

  // terms on the right side of the equation

  // whether the equation is balanced

  // a sum of all coefficients, so we know when the sum is non-zero

  // true = balanced with the lowest possible coefficients

  /**
   * @param reactants terms on the left side of the equation
   * @param products terms on the right side of the equation
   */
  constructor(reactants, products) {
    this.reactants = reactants;
    this.products = products;
    this.balancedProperty = new BooleanProperty(false);
    this.coefficientsSumProperty = new NumberProperty(0, {
      numberType: 'Integer'
    });
    this.balancedAndSimplified = false;
    this.addCoefficientsObserver(this.updateBalanced.bind(this));

    // keep a sum of all coefficients, so we know when the sum is non-zero
    this.addCoefficientsObserver(() => {
      let coefficientsSum = 0;
      const addCoefficients = equationTerm => {
        coefficientsSum += equationTerm.userCoefficientProperty.value;
      };
      this.reactants.forEach(reactant => addCoefficients(reactant));
      this.products.forEach(product => addCoefficients(product));
      this.coefficientsSumProperty.value = coefficientsSum;
    });
  }
  reset() {
    this.balancedProperty.reset();
    this.coefficientsSumProperty.reset();
    this.reactants.forEach(reactant => reactant.reset());
    this.products.forEach(product => product.reset());
  }

  /**
   * An equation is balanced if all of its terms have a coefficient that is the same integer multiple of the term's
   * balanced coefficient. If the integer multiple is 1, then the term is "balanced and simplified" - balanced with
   * the lowest possible coefficients.
   */
  updateBalanced() {
    // Get integer multiplier from the first reactant term.
    const multiplier = this.reactants[0].userCoefficientProperty.value / this.reactants[0].balancedCoefficient;
    let balanced = multiplier > 0;

    // Check each term to see if the actual coefficient is the same integer multiple of the balanced coefficient.
    this.reactants.forEach(reactant => {
      balanced = balanced && reactant.userCoefficientProperty.value === multiplier * reactant.balancedCoefficient;
    });
    this.products.forEach(product => {
      balanced = balanced && product.userCoefficientProperty.value === multiplier * product.balancedCoefficient;
    });
    this.balancedAndSimplified = balanced && multiplier === 1; // set the more specific value first
    this.balancedProperty.value = balanced;
  }

  /**
   * Convenience method for adding an observer to all coefficients.
   */
  addCoefficientsObserver(observer) {
    this.reactants.forEach(reactant => reactant.userCoefficientProperty.lazyLink(observer));
    this.products.forEach(product => product.userCoefficientProperty.lazyLink(observer));
    observer();
  }

  /**
   * Convenience method for removing an observer from all coefficients.
   */
  removeCoefficientsObserver(observer) {
    this.reactants.forEach(reactant => reactant.userCoefficientProperty.unlink(observer));
    this.products.forEach(product => product.userCoefficientProperty.unlink(observer));
  }

  /**
   * Returns a count of each type of atom, based on the user coefficients.
   */
  getAtomCounts() {
    return AtomCount.countAtoms(this);
  }

  /**
   * Does this equation contain at least one "big" molecule? This affects degree of difficulty in the Game.
   */
  hasBigMolecule() {
    return !!_.find(this.reactants, reactant => reactant.molecule.isBig()) || !!_.find(this.products, product => product.molecule.isBig());
  }

  /**
   * Balances the equation by copying the balanced coefficient value to
   * the user coefficient value for each term in the equation.
   */
  balance() {
    this.reactants.forEach(term => {
      term.userCoefficientProperty.value = term.balancedCoefficient;
    });
    this.products.forEach(term => {
      term.userCoefficientProperty.value = term.balancedCoefficient;
    });
  }

  /**
   * Gets a string that shows just the coefficients of the equations.
   * This is used to show game answers when running in 'dev' mode.
   */
  getCoefficientsString() {
    let string = '';
    for (let i = 0; i < this.reactants.length; i++) {
      string += this.reactants[i].balancedCoefficient;
      string += i < this.reactants.length - 1 ? ' + ' : ' ';
    }
    string += '\u2192 '; // right arrow
    for (let i = 0; i < this.products.length; i++) {
      string += this.products[i].balancedCoefficient;
      string += i < this.products.length - 1 ? ' + ' : '';
    }
    return string;
  }

  /**
   * String value of an equation, shows balanced coefficients, for debugging. Do not rely on this format!
   */
  toString() {
    let string = '';

    // reactants
    for (let i = 0; i < this.reactants.length; i++) {
      string += this.reactants[i].balancedCoefficient;
      string += ' ';
      string += this.reactants[i].molecule.symbol;
      if (i < this.reactants.length - 1) {
        string += ' + ';
      }
    }

    // right arrow
    string += ' \u2192 ';

    // products
    for (let i = 0; i < this.products.length; i++) {
      string += this.products[i].balancedCoefficient;
      string += ' ';
      string += this.products[i].molecule.symbol;
      if (i < this.products.length - 1) {
        string += ' + ';
      }
    }

    // strip out HTML tags to improve readability
    string = string.replace(/<sub>/g, '');
    string = string.replace(/<\/sub>/g, '');
    return string;
  }
}
balancingChemicalEquations.register('Equation', Equation);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsImJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIiwiQXRvbUNvdW50IiwiRXF1YXRpb24iLCJjb25zdHJ1Y3RvciIsInJlYWN0YW50cyIsInByb2R1Y3RzIiwiYmFsYW5jZWRQcm9wZXJ0eSIsImNvZWZmaWNpZW50c1N1bVByb3BlcnR5IiwibnVtYmVyVHlwZSIsImJhbGFuY2VkQW5kU2ltcGxpZmllZCIsImFkZENvZWZmaWNpZW50c09ic2VydmVyIiwidXBkYXRlQmFsYW5jZWQiLCJiaW5kIiwiY29lZmZpY2llbnRzU3VtIiwiYWRkQ29lZmZpY2llbnRzIiwiZXF1YXRpb25UZXJtIiwidXNlckNvZWZmaWNpZW50UHJvcGVydHkiLCJ2YWx1ZSIsImZvckVhY2giLCJyZWFjdGFudCIsInByb2R1Y3QiLCJyZXNldCIsIm11bHRpcGxpZXIiLCJiYWxhbmNlZENvZWZmaWNpZW50IiwiYmFsYW5jZWQiLCJvYnNlcnZlciIsImxhenlMaW5rIiwicmVtb3ZlQ29lZmZpY2llbnRzT2JzZXJ2ZXIiLCJ1bmxpbmsiLCJnZXRBdG9tQ291bnRzIiwiY291bnRBdG9tcyIsImhhc0JpZ01vbGVjdWxlIiwiXyIsImZpbmQiLCJtb2xlY3VsZSIsImlzQmlnIiwiYmFsYW5jZSIsInRlcm0iLCJnZXRDb2VmZmljaWVudHNTdHJpbmciLCJzdHJpbmciLCJpIiwibGVuZ3RoIiwidG9TdHJpbmciLCJzeW1ib2wiLCJyZXBsYWNlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFcXVhdGlvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBFcXVhdGlvbiBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgYWxsIGNoZW1pY2FsIGVxdWF0aW9ucy5cclxuICogQSBjaGVtaWNhbCBlcXVhdGlvbiBoYXMgMiBzZXRzIG9mIHRlcm1zLCByZWFjdGFudHMgYW5kIHByb2R1Y3RzLlxyXG4gKiBEdXJpbmcgdGhlIGNoZW1pY2FsIHJlYWN0aW9uIHJlcHJlc2VudGVkIGJ5IHRoZSBlcXVhdGlvbiwgcmVhY3RhbnRzIGFyZSB0cmFuc2Zvcm1lZCBpbnRvIHByb2R1Y3RzLlxyXG4gKiA8cC8+XHJcbiAqIEFuIGVxdWF0aW9uIGlzIFwiYmFsYW5jZWRcIiB3aGVuIGVhY2ggdGVybSdzIHVzZXIgY29lZmZpY2llbnQgaXMgYW4gaW50ZWdlciBtdWx0aXBsZSBOIG9mXHJcbiAqIHRoZSBiYWxhbmNlZCBjb2VmZmljaWVudCwgTiBpcyB0aGUgc2FtZSBmb3IgYWxsIHRlcm1zIGluIHRoZSBlcXVhdGlvbiwgYW5kIE4gPj0gMS5cclxuICogQW4gZXF1YXRpb24gaXMgXCJiYWxhbmNlZCBhbmQgc2ltcGxpZmllZFwiIHdoZW4gaXQgaXMgYmFsYW5jZWQgYW5kIE49MS5cclxuICpcclxuICogQGF1dGhvciBWYXNpbHkgU2hha2hvdiAobWxlYXJuZXIuY29tKVxyXG4gKiBAYXV0aG9yIENocmlzIE1hbGxleSAoUGl4ZWxab29tLCBJbmMuKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IGJhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zIGZyb20gJy4uLy4uL2JhbGFuY2luZ0NoZW1pY2FsRXF1YXRpb25zLmpzJztcclxuaW1wb3J0IEF0b21Db3VudCBmcm9tICcuL0F0b21Db3VudC5qcyc7XHJcbmltcG9ydCBFcXVhdGlvblRlcm0gZnJvbSAnLi9FcXVhdGlvblRlcm0uanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXF1YXRpb24ge1xyXG5cclxuICAvLyB0ZXJtcyBvbiB0aGUgbGVmdCBzaWRlIG9mIHRoZSBlcXVhdGlvblxyXG4gIHB1YmxpYyByZWFkb25seSByZWFjdGFudHM6IEVxdWF0aW9uVGVybVtdO1xyXG5cclxuICAvLyB0ZXJtcyBvbiB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgZXF1YXRpb25cclxuICBwdWJsaWMgcmVhZG9ubHkgcHJvZHVjdHM6IEVxdWF0aW9uVGVybVtdO1xyXG5cclxuICAvLyB3aGV0aGVyIHRoZSBlcXVhdGlvbiBpcyBiYWxhbmNlZFxyXG4gIHB1YmxpYyByZWFkb25seSBiYWxhbmNlZFByb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPjtcclxuXHJcbiAgLy8gYSBzdW0gb2YgYWxsIGNvZWZmaWNpZW50cywgc28gd2Uga25vdyB3aGVuIHRoZSBzdW0gaXMgbm9uLXplcm9cclxuICBwdWJsaWMgcmVhZG9ubHkgY29lZmZpY2llbnRzU3VtUHJvcGVydHk6IFByb3BlcnR5PG51bWJlcj47XHJcblxyXG4gIC8vIHRydWUgPSBiYWxhbmNlZCB3aXRoIHRoZSBsb3dlc3QgcG9zc2libGUgY29lZmZpY2llbnRzXHJcbiAgcHVibGljIGJhbGFuY2VkQW5kU2ltcGxpZmllZDogYm9vbGVhbjtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHJlYWN0YW50cyB0ZXJtcyBvbiB0aGUgbGVmdCBzaWRlIG9mIHRoZSBlcXVhdGlvblxyXG4gICAqIEBwYXJhbSBwcm9kdWN0cyB0ZXJtcyBvbiB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgZXF1YXRpb25cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoIHJlYWN0YW50czogRXF1YXRpb25UZXJtW10sIHByb2R1Y3RzOiBFcXVhdGlvblRlcm1bXSApIHtcclxuXHJcbiAgICB0aGlzLnJlYWN0YW50cyA9IHJlYWN0YW50cztcclxuICAgIHRoaXMucHJvZHVjdHMgPSBwcm9kdWN0cztcclxuICAgIHRoaXMuYmFsYW5jZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcbiAgICB0aGlzLmNvZWZmaWNpZW50c1N1bVByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCAwLCB7IG51bWJlclR5cGU6ICdJbnRlZ2VyJyB9ICk7XHJcbiAgICB0aGlzLmJhbGFuY2VkQW5kU2ltcGxpZmllZCA9IGZhbHNlO1xyXG5cclxuICAgIHRoaXMuYWRkQ29lZmZpY2llbnRzT2JzZXJ2ZXIoIHRoaXMudXBkYXRlQmFsYW5jZWQuYmluZCggdGhpcyApICk7XHJcblxyXG4gICAgLy8ga2VlcCBhIHN1bSBvZiBhbGwgY29lZmZpY2llbnRzLCBzbyB3ZSBrbm93IHdoZW4gdGhlIHN1bSBpcyBub24temVyb1xyXG4gICAgdGhpcy5hZGRDb2VmZmljaWVudHNPYnNlcnZlciggKCkgPT4ge1xyXG4gICAgICBsZXQgY29lZmZpY2llbnRzU3VtID0gMDtcclxuICAgICAgY29uc3QgYWRkQ29lZmZpY2llbnRzID0gKCBlcXVhdGlvblRlcm06IEVxdWF0aW9uVGVybSApID0+IHtcclxuICAgICAgICBjb2VmZmljaWVudHNTdW0gKz0gZXF1YXRpb25UZXJtLnVzZXJDb2VmZmljaWVudFByb3BlcnR5LnZhbHVlO1xyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLnJlYWN0YW50cy5mb3JFYWNoKCByZWFjdGFudCA9PiBhZGRDb2VmZmljaWVudHMoIHJlYWN0YW50ICkgKTtcclxuICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKCBwcm9kdWN0ID0+IGFkZENvZWZmaWNpZW50cyggcHJvZHVjdCApICk7XHJcbiAgICAgIHRoaXMuY29lZmZpY2llbnRzU3VtUHJvcGVydHkudmFsdWUgPSBjb2VmZmljaWVudHNTdW07XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXQoKTogdm9pZCB7XHJcblxyXG4gICAgdGhpcy5iYWxhbmNlZFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLmNvZWZmaWNpZW50c1N1bVByb3BlcnR5LnJlc2V0KCk7XHJcblxyXG4gICAgdGhpcy5yZWFjdGFudHMuZm9yRWFjaCggcmVhY3RhbnQgPT4gcmVhY3RhbnQucmVzZXQoKSApO1xyXG4gICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKCBwcm9kdWN0ID0+IHByb2R1Y3QucmVzZXQoKSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQW4gZXF1YXRpb24gaXMgYmFsYW5jZWQgaWYgYWxsIG9mIGl0cyB0ZXJtcyBoYXZlIGEgY29lZmZpY2llbnQgdGhhdCBpcyB0aGUgc2FtZSBpbnRlZ2VyIG11bHRpcGxlIG9mIHRoZSB0ZXJtJ3NcclxuICAgKiBiYWxhbmNlZCBjb2VmZmljaWVudC4gSWYgdGhlIGludGVnZXIgbXVsdGlwbGUgaXMgMSwgdGhlbiB0aGUgdGVybSBpcyBcImJhbGFuY2VkIGFuZCBzaW1wbGlmaWVkXCIgLSBiYWxhbmNlZCB3aXRoXHJcbiAgICogdGhlIGxvd2VzdCBwb3NzaWJsZSBjb2VmZmljaWVudHMuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVCYWxhbmNlZCgpOiB2b2lkIHtcclxuXHJcbiAgICAvLyBHZXQgaW50ZWdlciBtdWx0aXBsaWVyIGZyb20gdGhlIGZpcnN0IHJlYWN0YW50IHRlcm0uXHJcbiAgICBjb25zdCBtdWx0aXBsaWVyID0gdGhpcy5yZWFjdGFudHNbIDAgXS51c2VyQ29lZmZpY2llbnRQcm9wZXJ0eS52YWx1ZSAvIHRoaXMucmVhY3RhbnRzWyAwIF0uYmFsYW5jZWRDb2VmZmljaWVudDtcclxuICAgIGxldCBiYWxhbmNlZCA9ICggbXVsdGlwbGllciA+IDAgKTtcclxuXHJcbiAgICAvLyBDaGVjayBlYWNoIHRlcm0gdG8gc2VlIGlmIHRoZSBhY3R1YWwgY29lZmZpY2llbnQgaXMgdGhlIHNhbWUgaW50ZWdlciBtdWx0aXBsZSBvZiB0aGUgYmFsYW5jZWQgY29lZmZpY2llbnQuXHJcbiAgICB0aGlzLnJlYWN0YW50cy5mb3JFYWNoKCByZWFjdGFudCA9PiB7XHJcbiAgICAgIGJhbGFuY2VkID0gYmFsYW5jZWQgJiYgKCByZWFjdGFudC51c2VyQ29lZmZpY2llbnRQcm9wZXJ0eS52YWx1ZSA9PT0gbXVsdGlwbGllciAqIHJlYWN0YW50LmJhbGFuY2VkQ29lZmZpY2llbnQgKTtcclxuICAgIH0gKTtcclxuICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaCggcHJvZHVjdCA9PiB7XHJcbiAgICAgIGJhbGFuY2VkID0gYmFsYW5jZWQgJiYgKCBwcm9kdWN0LnVzZXJDb2VmZmljaWVudFByb3BlcnR5LnZhbHVlID09PSBtdWx0aXBsaWVyICogcHJvZHVjdC5iYWxhbmNlZENvZWZmaWNpZW50ICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5iYWxhbmNlZEFuZFNpbXBsaWZpZWQgPSBiYWxhbmNlZCAmJiAoIG11bHRpcGxpZXIgPT09IDEgKTsgLy8gc2V0IHRoZSBtb3JlIHNwZWNpZmljIHZhbHVlIGZpcnN0XHJcbiAgICB0aGlzLmJhbGFuY2VkUHJvcGVydHkudmFsdWUgPSBiYWxhbmNlZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgYWRkaW5nIGFuIG9ic2VydmVyIHRvIGFsbCBjb2VmZmljaWVudHMuXHJcbiAgICovXHJcbiAgcHVibGljIGFkZENvZWZmaWNpZW50c09ic2VydmVyKCBvYnNlcnZlcjogKCkgPT4gdm9pZCApOiB2b2lkIHtcclxuICAgIHRoaXMucmVhY3RhbnRzLmZvckVhY2goIHJlYWN0YW50ID0+IHJlYWN0YW50LnVzZXJDb2VmZmljaWVudFByb3BlcnR5LmxhenlMaW5rKCBvYnNlcnZlciApICk7XHJcbiAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2goIHByb2R1Y3QgPT4gcHJvZHVjdC51c2VyQ29lZmZpY2llbnRQcm9wZXJ0eS5sYXp5TGluayggb2JzZXJ2ZXIgKSApO1xyXG4gICAgb2JzZXJ2ZXIoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgcmVtb3ZpbmcgYW4gb2JzZXJ2ZXIgZnJvbSBhbGwgY29lZmZpY2llbnRzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVDb2VmZmljaWVudHNPYnNlcnZlciggb2JzZXJ2ZXI6ICgpID0+IHZvaWQgKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlYWN0YW50cy5mb3JFYWNoKCByZWFjdGFudCA9PiByZWFjdGFudC51c2VyQ29lZmZpY2llbnRQcm9wZXJ0eS51bmxpbmsoIG9ic2VydmVyICkgKTtcclxuICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaCggcHJvZHVjdCA9PiBwcm9kdWN0LnVzZXJDb2VmZmljaWVudFByb3BlcnR5LnVubGluayggb2JzZXJ2ZXIgKSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIGNvdW50IG9mIGVhY2ggdHlwZSBvZiBhdG9tLCBiYXNlZCBvbiB0aGUgdXNlciBjb2VmZmljaWVudHMuXHJcbiAgICovXHJcbiAgcHVibGljIGdldEF0b21Db3VudHMoKTogQXRvbUNvdW50W10ge1xyXG4gICAgcmV0dXJuIEF0b21Db3VudC5jb3VudEF0b21zKCB0aGlzICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEb2VzIHRoaXMgZXF1YXRpb24gY29udGFpbiBhdCBsZWFzdCBvbmUgXCJiaWdcIiBtb2xlY3VsZT8gVGhpcyBhZmZlY3RzIGRlZ3JlZSBvZiBkaWZmaWN1bHR5IGluIHRoZSBHYW1lLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBoYXNCaWdNb2xlY3VsZSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIV8uZmluZCggdGhpcy5yZWFjdGFudHMsIHJlYWN0YW50ID0+IHJlYWN0YW50Lm1vbGVjdWxlLmlzQmlnKCkgKSB8fFxyXG4gICAgICAgICAgICEhXy5maW5kKCB0aGlzLnByb2R1Y3RzLCBwcm9kdWN0ID0+IHByb2R1Y3QubW9sZWN1bGUuaXNCaWcoKSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQmFsYW5jZXMgdGhlIGVxdWF0aW9uIGJ5IGNvcHlpbmcgdGhlIGJhbGFuY2VkIGNvZWZmaWNpZW50IHZhbHVlIHRvXHJcbiAgICogdGhlIHVzZXIgY29lZmZpY2llbnQgdmFsdWUgZm9yIGVhY2ggdGVybSBpbiB0aGUgZXF1YXRpb24uXHJcbiAgICovXHJcbiAgcHVibGljIGJhbGFuY2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlYWN0YW50cy5mb3JFYWNoKCB0ZXJtID0+IHtcclxuICAgICAgdGVybS51c2VyQ29lZmZpY2llbnRQcm9wZXJ0eS52YWx1ZSA9IHRlcm0uYmFsYW5jZWRDb2VmZmljaWVudDtcclxuICAgIH0gKTtcclxuICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaCggdGVybSA9PiB7XHJcbiAgICAgIHRlcm0udXNlckNvZWZmaWNpZW50UHJvcGVydHkudmFsdWUgPSB0ZXJtLmJhbGFuY2VkQ29lZmZpY2llbnQ7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIGEgc3RyaW5nIHRoYXQgc2hvd3MganVzdCB0aGUgY29lZmZpY2llbnRzIG9mIHRoZSBlcXVhdGlvbnMuXHJcbiAgICogVGhpcyBpcyB1c2VkIHRvIHNob3cgZ2FtZSBhbnN3ZXJzIHdoZW4gcnVubmluZyBpbiAnZGV2JyBtb2RlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRDb2VmZmljaWVudHNTdHJpbmcoKTogc3RyaW5nIHtcclxuICAgIGxldCBzdHJpbmcgPSAnJztcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucmVhY3RhbnRzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICBzdHJpbmcgKz0gdGhpcy5yZWFjdGFudHNbIGkgXS5iYWxhbmNlZENvZWZmaWNpZW50O1xyXG4gICAgICBzdHJpbmcgKz0gKCBpIDwgdGhpcy5yZWFjdGFudHMubGVuZ3RoIC0gMSApID8gJyArICcgOiAnICc7XHJcbiAgICB9XHJcbiAgICBzdHJpbmcgKz0gJ1xcdTIxOTIgJzsgLy8gcmlnaHQgYXJyb3dcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucHJvZHVjdHMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHN0cmluZyArPSB0aGlzLnByb2R1Y3RzWyBpIF0uYmFsYW5jZWRDb2VmZmljaWVudDtcclxuICAgICAgc3RyaW5nICs9ICggaSA8IHRoaXMucHJvZHVjdHMubGVuZ3RoIC0gMSApID8gJyArICcgOiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBzdHJpbmc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdHJpbmcgdmFsdWUgb2YgYW4gZXF1YXRpb24sIHNob3dzIGJhbGFuY2VkIGNvZWZmaWNpZW50cywgZm9yIGRlYnVnZ2luZy4gRG8gbm90IHJlbHkgb24gdGhpcyBmb3JtYXQhXHJcbiAgICovXHJcbiAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XHJcbiAgICBsZXQgc3RyaW5nID0gJyc7XHJcblxyXG4gICAgLy8gcmVhY3RhbnRzXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnJlYWN0YW50cy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgc3RyaW5nICs9IHRoaXMucmVhY3RhbnRzWyBpIF0uYmFsYW5jZWRDb2VmZmljaWVudDtcclxuICAgICAgc3RyaW5nICs9ICcgJztcclxuICAgICAgc3RyaW5nICs9IHRoaXMucmVhY3RhbnRzWyBpIF0ubW9sZWN1bGUuc3ltYm9sO1xyXG4gICAgICBpZiAoIGkgPCB0aGlzLnJlYWN0YW50cy5sZW5ndGggLSAxICkge1xyXG4gICAgICAgIHN0cmluZyArPSAnICsgJztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHJpZ2h0IGFycm93XHJcbiAgICBzdHJpbmcgKz0gJyBcXHUyMTkyICc7XHJcblxyXG4gICAgLy8gcHJvZHVjdHNcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucHJvZHVjdHMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHN0cmluZyArPSB0aGlzLnByb2R1Y3RzWyBpIF0uYmFsYW5jZWRDb2VmZmljaWVudDtcclxuICAgICAgc3RyaW5nICs9ICcgJztcclxuICAgICAgc3RyaW5nICs9IHRoaXMucHJvZHVjdHNbIGkgXS5tb2xlY3VsZS5zeW1ib2w7XHJcbiAgICAgIGlmICggaSA8IHRoaXMucHJvZHVjdHMubGVuZ3RoIC0gMSApIHtcclxuICAgICAgICBzdHJpbmcgKz0gJyArICc7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzdHJpcCBvdXQgSFRNTCB0YWdzIHRvIGltcHJvdmUgcmVhZGFiaWxpdHlcclxuICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKCAvPHN1Yj4vZywgJycgKTtcclxuICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKCAvPFxcL3N1Yj4vZywgJycgKTtcclxuXHJcbiAgICByZXR1cm4gc3RyaW5nO1xyXG4gIH1cclxufVxyXG5cclxuYmFsYW5jaW5nQ2hlbWljYWxFcXVhdGlvbnMucmVnaXN0ZXIoICdFcXVhdGlvbicsIEVxdWF0aW9uICk7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3QztBQUNwRSxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBRWxFLE9BQU9DLDBCQUEwQixNQUFNLHFDQUFxQztBQUM1RSxPQUFPQyxTQUFTLE1BQU0sZ0JBQWdCO0FBR3RDLGVBQWUsTUFBTUMsUUFBUSxDQUFDO0VBRTVCOztFQUdBOztFQUdBOztFQUdBOztFQUdBOztFQUdBO0FBQ0Y7QUFDQTtBQUNBO0VBQ1lDLFdBQVdBLENBQUVDLFNBQXlCLEVBQUVDLFFBQXdCLEVBQUc7SUFFM0UsSUFBSSxDQUFDRCxTQUFTLEdBQUdBLFNBQVM7SUFDMUIsSUFBSSxDQUFDQyxRQUFRLEdBQUdBLFFBQVE7SUFDeEIsSUFBSSxDQUFDQyxnQkFBZ0IsR0FBRyxJQUFJUixlQUFlLENBQUUsS0FBTSxDQUFDO0lBQ3BELElBQUksQ0FBQ1MsdUJB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