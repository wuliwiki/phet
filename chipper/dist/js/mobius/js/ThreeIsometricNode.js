// Copyright 2019-2023, University of Colorado Boulder

/**
 * Shows three.js content with isometric scaling that takes up the entire viewport in a high-performance way.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Property from '../../axon/js/Property.js';
import Bounds2 from '../../dot/js/Bounds2.js';
import Matrix3 from '../../dot/js/Matrix3.js';
import optionize from '../../phet-core/js/optionize.js';
import { DOM, Node, Rectangle } from '../../scenery/js/imports.js';
import MobiusQueryParameters from './MobiusQueryParameters.js';
import ThreeStage from './ThreeStage.js';
import mobius from './mobius.js';
export default class ThreeIsometricNode extends Node {
  // our target for drags that don't hit other UI components

  constructor(layoutBounds, providedOptions) {
    const options = optionize()({
      parentMatrixProperty: new Property(Matrix3.IDENTITY),
      fov: 50,
      // positioned or transformed pixels, or full scenery-transformed?
      // can use https://threejs.org/docs/#api/en/cameras/PerspectiveCamera.setViewOffset to handle sub-pixel stuff?

      // Use method-based interaction to control positioning. Or set up the scenery default if listeners are needed.

      // FOV auto-control on layout?

      getPhetioMouseHit: null // (point:Vector2)=>PhetioObject, for studio autoselect
    }, providedOptions);
    super();
    this.layoutBounds = layoutBounds;
    this._getPhetioMouseHit = options.getPhetioMouseHit;
    this.stage = new ThreeStage(options);
    this.stage.threeCamera.fov = options.fov;
    this.stage.threeCamera.aspect = this.layoutBounds.width / this.layoutBounds.height;
    this.parentMatrixProperty = options.parentMatrixProperty;
    this.backgroundEventTarget = new Rectangle({});
    this.addChild(this.backgroundEventTarget);

    // Handle fallback for when we don't have WebGL, see https://github.com/phetsims/density/issues/105
    if (this.stage.threeRenderer) {
      // add the Canvas in with a DOM node that prevents Scenery from applying transformations on it
      this.domNode = new DOM(this.stage.threeRenderer.domElement, {
        preventTransform: true,
        // Scenery override for transformation
        pickable: false
      });

      // don't do bounds detection, it's too expensive. We're not pickable anyways
      this.domNode.invalidateDOM = () => this.domNode.invalidateSelf(new Bounds2(0, 0, 0, 0));
      this.domNode.invalidateDOM();

      // support Scenery/Joist 0.2 screenshot (takes extra work to output)
      this.domNode.renderToCanvasSelf = (wrapper, matrix) => {
        const context = wrapper.context;

        // Guaranteed to be affine, 1:1 aspect ratio and axis-aligned
        const scale = matrix.timesMatrix(this.getUniqueTrail().getMatrix().inverted()).m00();
        const canvas = this.stage.renderToCanvas(MobiusQueryParameters.mobiusCanvasSupersampling, scale);
        context.save();
        context.setTransform(1, 0, 0, -1, 0, canvas.height); // no need to take pixel scaling into account

        context.drawImage(canvas, 0, 0);
        context.restore();
      };
      this.addChild(this.domNode);
    }

    // Ideally should be called whenever the parent/screenView matrix is changed, or any camera
    // change (including zoom or fov).
    this.viewOffsetListener = () => {
      const screenWidth = this.stage.width;
      const screenHeight = this.stage.height;
      if (screenWidth && screenHeight) {
        this.stage.adjustViewOffset(this.parentToGlobalBounds(new Bounds2(0, 0, this.layoutBounds.width, this.layoutBounds.height)));
      }
    };
    this.parentMatrixProperty.lazyLink(this.viewOffsetListener);
    this.mutate(options);
  }

  // for studio autoselect
  getPhetioMouseHit(point) {
    if (this._getPhetioMouseHit && this.isPhetioMouseHittable(point)) {
      return this._getPhetioMouseHit(point);
    } else {
      return super.getPhetioMouseHit(point);
    }
  }

  /**
   * Projects a 3d point in the global coordinate frame to one within the 2d global coordinate frame.
   */
  projectPoint(point) {
    return this.stage.projectPoint(point);
  }

  /**
   * Given a screen point, returns a 3D ray representing the camera's position and direction that point would be in the
   * 3D scene.
   */
  getRayFromScreenPoint(globalScreenPoint) {
    return this.stage.getRayFromScreenPoint(globalScreenPoint);
  }
  layout(width, height) {
    // We need to lay out things for window dimensions so we don't overly resize, see
    // https://github.com/phetsims/density/issues/50. For this we'll actually take up the full window, and adjust things
    // using adjustViewOffset to handle both the isometric scaling AND pan/zoom. This is necessary so that the navbar
    // doesn't throw off layout. This may come with a bit of performance cost, since we do typically have some of the
    // canvas hidden by the navigation bar, but the lack of resizes on any pan/zoom presumably makes up for it in
    // usability.

    if (_.hasIn(window, 'phet.joist.sim')) {
      const simDimensions = phet.joist.sim.dimensionProperty.value; // eslint-disable-line bad-phet-library-text
      width = simDimensions.width;
      height = simDimensions.height;
    }
    this.stage.setDimensions(width, height);
    this.backgroundEventTarget.setRectBounds(this.globalToLocalBounds(new Bounds2(0, 0, width, height)));

    // field of view (FOV) computation for the isometric view scaling we use
    const sx = width / this.layoutBounds.width;
    const sy = height / this.layoutBounds.height;
    if (sx !== 0 && sy !== 0) {
      this.stage.activeScale = sy > sx ? sx : sy;
      this.viewOffsetListener();
      if (this.stage.threeRenderer) {
        this.domNode.invalidateDOM();
      }
    }
  }

  /**
   * Renders the simulation to a specific rendering target
   *
   * @param target - undefined for the default target
   */
  render(target) {
    this.stage.render(target);
  }

  /**
   * Releases references.
   */
  dispose() {
    this.parentMatrixProperty.unlink(this.viewOffsetListener);
    super.dispose();
    this.stage.dispose();
  }
}
mobius.register('ThreeIsometricNode', ThreeIsometricNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkJvdW5kczIiLCJNYXRyaXgzIiwib3B0aW9uaXplIiwiRE9NIiwiTm9kZSIsIlJlY3RhbmdsZSIsIk1vYml1c1F1ZXJ5UGFyYW1ldGVycyIsIlRocmVlU3RhZ2UiLCJtb2JpdXMiLCJUaHJlZUlzb21ldHJpY05vZGUiLCJjb25zdHJ1Y3RvciIsImxheW91dEJvdW5kcyIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJwYXJlbnRNYXRyaXhQcm9wZXJ0eSIsIklERU5USVRZIiwiZm92IiwiZ2V0UGhldGlvTW91c2VIaXQiLCJfZ2V0UGhldGlvTW91c2VIaXQiLCJzdGFnZSIsInRocmVlQ2FtZXJhIiwiYXNwZWN0Iiwid2lkdGgiLCJoZWlnaHQiLCJiYWNrZ3JvdW5kRXZlbnRUYXJnZXQiLCJhZGRDaGlsZCIsInRocmVlUmVuZGVyZXIiLCJkb21Ob2RlIiwiZG9tRWxlbWVudCIsInByZXZlbnRUcmFuc2Zvcm0iLCJwaWNrYWJsZSIsImludmFsaWRhdGVET00iLCJpbnZhbGlkYXRlU2VsZiIsInJlbmRlclRvQ2FudmFzU2VsZiIsIndyYXBwZXIiLCJtYXRyaXgiLCJjb250ZXh0Iiwic2NhbGUiLCJ0aW1lc01hdHJpeCIsImdldFVuaXF1ZVRyYWlsIiwiZ2V0TWF0cml4IiwiaW52ZXJ0ZWQiLCJtMDAiLCJjYW52YXMiLCJyZW5kZXJUb0NhbnZhcyIsIm1vYml1c0NhbnZhc1N1cGVyc2FtcGxpbmciLCJzYXZlIiwic2V0VHJhbnNmb3JtIiwiZHJhd0ltYWdlIiwicmVzdG9yZSIsInZpZXdPZmZzZXRMaXN0ZW5lciIsInNjcmVlbldpZHRoIiwic2NyZWVuSGVpZ2h0IiwiYWRqdXN0Vmlld09mZnNldCIsInBhcmVudFRvR2xvYmFsQm91bmRzIiwibGF6eUxpbmsiLCJtdXRhdGUiLCJwb2ludCIsImlzUGhldGlvTW91c2VIaXR0YWJsZSIsInByb2plY3RQb2ludCIsImdldFJheUZyb21TY3JlZW5Qb2ludCIsImdsb2JhbFNjcmVlblBvaW50IiwibGF5b3V0IiwiXyIsImhhc0luIiwid2luZG93Iiwic2ltRGltZW5zaW9ucyIsInBoZXQiLCJqb2lzdCIsInNpbSIsImRpbWVuc2lvblByb3BlcnR5IiwidmFsdWUiLCJzZXREaW1lbnNpb25zIiwic2V0UmVjdEJvdW5kcyIsImdsb2JhbFRvTG9jYWxCb3VuZHMiLCJzeCIsInN5IiwiYWN0aXZlU2NhbGUiLCJyZW5kZXIiLCJ0YXJnZXQiLCJkaXNwb3NlIiwidW5saW5rIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJUaHJlZUlzb21ldHJpY05vZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogU2hvd3MgdGhyZWUuanMgY29udGVudCB3aXRoIGlzb21ldHJpYyBzY2FsaW5nIHRoYXQgdGFrZXMgdXAgdGhlIGVudGlyZSB2aWV3cG9ydCBpbiBhIGhpZ2gtcGVyZm9ybWFuY2Ugd2F5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IFByb3BlcnR5IGZyb20gJy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgQm91bmRzMiBmcm9tICcuLi8uLi9kb3QvanMvQm91bmRzMi5qcyc7XHJcbmltcG9ydCBNYXRyaXgzIGZyb20gJy4uLy4uL2RvdC9qcy9NYXRyaXgzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IHsgRE9NLCBOb2RlLCBOb2RlT3B0aW9ucywgUmVjdGFuZ2xlIH0gZnJvbSAnLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IE1vYml1c1F1ZXJ5UGFyYW1ldGVycyBmcm9tICcuL01vYml1c1F1ZXJ5UGFyYW1ldGVycy5qcyc7XHJcbmltcG9ydCBUaHJlZVN0YWdlLCB7IFRocmVlU3RhZ2VPcHRpb25zIH0gZnJvbSAnLi9UaHJlZVN0YWdlLmpzJztcclxuaW1wb3J0IG1vYml1cyBmcm9tICcuL21vYml1cy5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMyBmcm9tICcuLi8uLi9kb3QvanMvVmVjdG9yMy5qcyc7XHJcbmltcG9ydCBSYXkzIGZyb20gJy4uLy4uL2RvdC9qcy9SYXkzLmpzJztcclxuaW1wb3J0IFBoZXRpb09iamVjdCBmcm9tICcuLi8uLi90YW5kZW0vanMvUGhldGlvT2JqZWN0LmpzJztcclxuXHJcbnR5cGUgTW91c2VIaXRMaXN0ZW5lciA9ICggcG9pbnQ6IFZlY3RvcjIgKSA9PiBQaGV0aW9PYmplY3QgfCBudWxsO1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICBwYXJlbnRNYXRyaXhQcm9wZXJ0eT86IFRSZWFkT25seVByb3BlcnR5PE1hdHJpeDM+O1xyXG4gIGZvdj86IG51bWJlcjtcclxuICBnZXRQaGV0aW9Nb3VzZUhpdD86IE1vdXNlSGl0TGlzdGVuZXIgfCBudWxsO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgVGhyZWVJc29tZXRyaWNOb2RlT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgVGhyZWVTdGFnZU9wdGlvbnMgJiBOb2RlT3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRocmVlSXNvbWV0cmljTm9kZSBleHRlbmRzIE5vZGUge1xyXG5cclxuICBwcml2YXRlIGxheW91dEJvdW5kczogQm91bmRzMjtcclxuICBwcml2YXRlIF9nZXRQaGV0aW9Nb3VzZUhpdDogTW91c2VIaXRMaXN0ZW5lciB8IG51bGw7XHJcbiAgcHVibGljIHJlYWRvbmx5IHN0YWdlOiBUaHJlZVN0YWdlO1xyXG4gIHByaXZhdGUgcGFyZW50TWF0cml4UHJvcGVydHk6IFRSZWFkT25seVByb3BlcnR5PE1hdHJpeDM+O1xyXG5cclxuICAvLyBvdXIgdGFyZ2V0IGZvciBkcmFncyB0aGF0IGRvbid0IGhpdCBvdGhlciBVSSBjb21wb25lbnRzXHJcbiAgcHVibGljIHJlYWRvbmx5IGJhY2tncm91bmRFdmVudFRhcmdldDogUmVjdGFuZ2xlO1xyXG5cclxuICBwcml2YXRlIGRvbU5vZGUhOiBET007XHJcbiAgcHJpdmF0ZSB2aWV3T2Zmc2V0TGlzdGVuZXI6ICgpID0+IHZvaWQ7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggbGF5b3V0Qm91bmRzOiBCb3VuZHMyLCBwcm92aWRlZE9wdGlvbnM/OiBUaHJlZUlzb21ldHJpY05vZGVPcHRpb25zICkge1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRpb25pemU8VGhyZWVJc29tZXRyaWNOb2RlT3B0aW9ucywgU2VsZk9wdGlvbnMsIFRocmVlU3RhZ2VPcHRpb25zICYgTm9kZU9wdGlvbnM+KCkoIHtcclxuICAgICAgcGFyZW50TWF0cml4UHJvcGVydHk6IG5ldyBQcm9wZXJ0eSggTWF0cml4My5JREVOVElUWSApLFxyXG5cclxuICAgICAgZm92OiA1MCxcclxuICAgICAgLy8gcG9zaXRpb25lZCBvciB0cmFuc2Zvcm1lZCBwaXhlbHMsIG9yIGZ1bGwgc2NlbmVyeS10cmFuc2Zvcm1lZD9cclxuICAgICAgLy8gY2FuIHVzZSBodHRwczovL3RocmVlanMub3JnL2RvY3MvI2FwaS9lbi9jYW1lcmFzL1BlcnNwZWN0aXZlQ2FtZXJhLnNldFZpZXdPZmZzZXQgdG8gaGFuZGxlIHN1Yi1waXhlbCBzdHVmZj9cclxuXHJcbiAgICAgIC8vIFVzZSBtZXRob2QtYmFzZWQgaW50ZXJhY3Rpb24gdG8gY29udHJvbCBwb3NpdGlvbmluZy4gT3Igc2V0IHVwIHRoZSBzY2VuZXJ5IGRlZmF1bHQgaWYgbGlzdGVuZXJzIGFyZSBuZWVkZWQuXHJcblxyXG4gICAgICAvLyBGT1YgYXV0by1jb250cm9sIG9uIGxheW91dD9cclxuXHJcbiAgICAgIGdldFBoZXRpb01vdXNlSGl0OiBudWxsIC8vIChwb2ludDpWZWN0b3IyKT0+UGhldGlvT2JqZWN0LCBmb3Igc3R1ZGlvIGF1dG9zZWxlY3RcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5sYXlvdXRCb3VuZHMgPSBsYXlvdXRCb3VuZHM7XHJcbiAgICB0aGlzLl9nZXRQaGV0aW9Nb3VzZUhpdCA9IG9wdGlvbnMuZ2V0UGhldGlvTW91c2VIaXQ7XHJcblxyXG4gICAgdGhpcy5zdGFnZSA9IG5ldyBUaHJlZVN0YWdlKCBvcHRpb25zICk7XHJcblxyXG4gICAgdGhpcy5zdGFnZS50aHJlZUNhbWVyYS5mb3YgPSBvcHRpb25zLmZvdjtcclxuICAgIHRoaXMuc3RhZ2UudGhyZWVDYW1lcmEuYXNwZWN0ID0gdGhpcy5sYXlvdXRCb3VuZHMud2lkdGggLyB0aGlzLmxheW91dEJvdW5kcy5oZWlnaHQ7XHJcblxyXG4gICAgdGhpcy5wYXJlbnRNYXRyaXhQcm9wZXJ0eSA9IG9wdGlvbnMucGFyZW50TWF0cml4UHJvcGVydHk7XHJcblxyXG4gICAgdGhpcy5iYWNrZ3JvdW5kRXZlbnRUYXJnZXQgPSBuZXcgUmVjdGFuZ2xlKCB7fSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5iYWNrZ3JvdW5kRXZlbnRUYXJnZXQgKTtcclxuXHJcbiAgICAvLyBIYW5kbGUgZmFsbGJhY2sgZm9yIHdoZW4gd2UgZG9uJ3QgaGF2ZSBXZWJHTCwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9kZW5zaXR5L2lzc3Vlcy8xMDVcclxuICAgIGlmICggdGhpcy5zdGFnZS50aHJlZVJlbmRlcmVyICkge1xyXG4gICAgICAvLyBhZGQgdGhlIENhbnZhcyBpbiB3aXRoIGEgRE9NIG5vZGUgdGhhdCBwcmV2ZW50cyBTY2VuZXJ5IGZyb20gYXBwbHlpbmcgdHJhbnNmb3JtYXRpb25zIG9uIGl0XHJcbiAgICAgIHRoaXMuZG9tTm9kZSA9IG5ldyBET00oIHRoaXMuc3RhZ2UudGhyZWVSZW5kZXJlci5kb21FbGVtZW50LCB7XHJcbiAgICAgICAgcHJldmVudFRyYW5zZm9ybTogdHJ1ZSwgLy8gU2NlbmVyeSBvdmVycmlkZSBmb3IgdHJhbnNmb3JtYXRpb25cclxuICAgICAgICBwaWNrYWJsZTogZmFsc2VcclxuICAgICAgfSApO1xyXG5cclxuICAgICAgLy8gZG9uJ3QgZG8gYm91bmRzIGRldGVjdGlvbiwgaXQncyB0b28gZXhwZW5zaXZlLiBXZSdyZSBub3QgcGlja2FibGUgYW55d2F5c1xyXG4gICAgICB0aGlzLmRvbU5vZGUuaW52YWxpZGF0ZURPTSA9ICgpID0+IHRoaXMuZG9tTm9kZS5pbnZhbGlkYXRlU2VsZiggbmV3IEJvdW5kczIoIDAsIDAsIDAsIDAgKSApO1xyXG4gICAgICB0aGlzLmRvbU5vZGUuaW52YWxpZGF0ZURPTSgpO1xyXG5cclxuICAgICAgLy8gc3VwcG9ydCBTY2VuZXJ5L0pvaXN0IDAuMiBzY3JlZW5zaG90ICh0YWtlcyBleHRyYSB3b3JrIHRvIG91dHB1dClcclxuICAgICAgdGhpcy5kb21Ob2RlLnJlbmRlclRvQ2FudmFzU2VsZiA9ICggd3JhcHBlciwgbWF0cml4ICkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB3cmFwcGVyLmNvbnRleHQ7XHJcblxyXG4gICAgICAgIC8vIEd1YXJhbnRlZWQgdG8gYmUgYWZmaW5lLCAxOjEgYXNwZWN0IHJhdGlvIGFuZCBheGlzLWFsaWduZWRcclxuICAgICAgICBjb25zdCBzY2FsZSA9IG1hdHJpeC50aW1lc01hdHJpeCggdGhpcy5nZXRVbmlxdWVUcmFpbCgpLmdldE1hdHJpeCgpLmludmVydGVkKCkgKS5tMDAoKTtcclxuICAgICAgICBjb25zdCBjYW52YXMgPSB0aGlzLnN0YWdlLnJlbmRlclRvQ2FudmFzKCBNb2JpdXNRdWVyeVBhcmFtZXRlcnMubW9iaXVzQ2FudmFzU3VwZXJzYW1wbGluZywgc2NhbGUgKTtcclxuXHJcbiAgICAgICAgY29udGV4dC5zYXZlKCk7XHJcblxyXG4gICAgICAgIGNvbnRleHQuc2V0VHJhbnNmb3JtKCAxLCAwLCAwLCAtMSwgMCwgY2FudmFzLmhlaWdodCApOyAvLyBubyBuZWVkIHRvIHRha2UgcGl4ZWwgc2NhbGluZyBpbnRvIGFjY291bnRcclxuXHJcbiAgICAgICAgY29udGV4dC5kcmF3SW1hZ2UoIGNhbnZhcywgMCwgMCApO1xyXG4gICAgICAgIGNvbnRleHQucmVzdG9yZSgpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5hZGRDaGlsZCggdGhpcy5kb21Ob2RlICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSWRlYWxseSBzaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBwYXJlbnQvc2NyZWVuVmlldyBtYXRyaXggaXMgY2hhbmdlZCwgb3IgYW55IGNhbWVyYVxyXG4gICAgLy8gY2hhbmdlIChpbmNsdWRpbmcgem9vbSBvciBmb3YpLlxyXG4gICAgdGhpcy52aWV3T2Zmc2V0TGlzdGVuZXIgPSAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHNjcmVlbldpZHRoID0gdGhpcy5zdGFnZS53aWR0aDtcclxuICAgICAgY29uc3Qgc2NyZWVuSGVpZ2h0ID0gdGhpcy5zdGFnZS5oZWlnaHQ7XHJcblxyXG4gICAgICBpZiAoIHNjcmVlbldpZHRoICYmIHNjcmVlbkhlaWdodCApIHtcclxuICAgICAgICB0aGlzLnN0YWdlLmFkanVzdFZpZXdPZmZzZXQoIHRoaXMucGFyZW50VG9HbG9iYWxCb3VuZHMoIG5ldyBCb3VuZHMyKCAwLCAwLCB0aGlzLmxheW91dEJvdW5kcy53aWR0aCwgdGhpcy5sYXlvdXRCb3VuZHMuaGVpZ2h0ICkgKSApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgdGhpcy5wYXJlbnRNYXRyaXhQcm9wZXJ0eS5sYXp5TGluayggdGhpcy52aWV3T2Zmc2V0TGlzdGVuZXIgKTtcclxuXHJcbiAgICB0aGlzLm11dGF0ZSggb3B0aW9ucyApO1xyXG4gIH1cclxuXHJcbiAgLy8gZm9yIHN0dWRpbyBhdXRvc2VsZWN0XHJcbiAgcHVibGljIG92ZXJyaWRlIGdldFBoZXRpb01vdXNlSGl0KCBwb2ludDogVmVjdG9yMiApOiBQaGV0aW9PYmplY3QgfCBudWxsIHtcclxuICAgIGlmICggdGhpcy5fZ2V0UGhldGlvTW91c2VIaXQgJiYgdGhpcy5pc1BoZXRpb01vdXNlSGl0dGFibGUoIHBvaW50ICkgKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLl9nZXRQaGV0aW9Nb3VzZUhpdCggcG9pbnQgKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICByZXR1cm4gc3VwZXIuZ2V0UGhldGlvTW91c2VIaXQoIHBvaW50ICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQcm9qZWN0cyBhIDNkIHBvaW50IGluIHRoZSBnbG9iYWwgY29vcmRpbmF0ZSBmcmFtZSB0byBvbmUgd2l0aGluIHRoZSAyZCBnbG9iYWwgY29vcmRpbmF0ZSBmcmFtZS5cclxuICAgKi9cclxuICBwdWJsaWMgcHJvamVjdFBvaW50KCBwb2ludDogVmVjdG9yMyApOiBWZWN0b3IyIHtcclxuICAgIHJldHVybiB0aGlzLnN0YWdlLnByb2plY3RQb2ludCggcG9pbnQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdpdmVuIGEgc2NyZWVuIHBvaW50LCByZXR1cm5zIGEgM0QgcmF5IHJlcHJlc2VudGluZyB0aGUgY2FtZXJhJ3MgcG9zaXRpb24gYW5kIGRpcmVjdGlvbiB0aGF0IHBvaW50IHdvdWxkIGJlIGluIHRoZVxyXG4gICAqIDNEIHNjZW5lLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRSYXlGcm9tU2NyZWVuUG9pbnQoIGdsb2JhbFNjcmVlblBvaW50OiBWZWN0b3IyICk6IFJheTMge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhZ2UuZ2V0UmF5RnJvbVNjcmVlblBvaW50KCBnbG9iYWxTY3JlZW5Qb2ludCApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGxheW91dCggd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIgKTogdm9pZCB7XHJcbiAgICAvLyBXZSBuZWVkIHRvIGxheSBvdXQgdGhpbmdzIGZvciB3aW5kb3cgZGltZW5zaW9ucyBzbyB3ZSBkb24ndCBvdmVybHkgcmVzaXplLCBzZWVcclxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9kZW5zaXR5L2lzc3Vlcy81MC4gRm9yIHRoaXMgd2UnbGwgYWN0dWFsbHkgdGFrZSB1cCB0aGUgZnVsbCB3aW5kb3csIGFuZCBhZGp1c3QgdGhpbmdzXHJcbiAgICAvLyB1c2luZyBhZGp1c3RWaWV3T2Zmc2V0IHRvIGhhbmRsZSBib3RoIHRoZSBpc29tZXRyaWMgc2NhbGluZyBBTkQgcGFuL3pvb20uIFRoaXMgaXMgbmVjZXNzYXJ5IHNvIHRoYXQgdGhlIG5hdmJhclxyXG4gICAgLy8gZG9lc24ndCB0aHJvdyBvZmYgbGF5b3V0LiBUaGlzIG1heSBjb21lIHdpdGggYSBiaXQgb2YgcGVyZm9ybWFuY2UgY29zdCwgc2luY2Ugd2UgZG8gdHlwaWNhbGx5IGhhdmUgc29tZSBvZiB0aGVcclxuICAgIC8vIGNhbnZhcyBoaWRkZW4gYnkgdGhlIG5hdmlnYXRpb24gYmFyLCBidXQgdGhlIGxhY2sgb2YgcmVzaXplcyBvbiBhbnkgcGFuL3pvb20gcHJlc3VtYWJseSBtYWtlcyB1cCBmb3IgaXQgaW5cclxuICAgIC8vIHVzYWJpbGl0eS5cclxuXHJcbiAgICBpZiAoIF8uaGFzSW4oIHdpbmRvdywgJ3BoZXQuam9pc3Quc2ltJyApICkge1xyXG4gICAgICBjb25zdCBzaW1EaW1lbnNpb25zID0gcGhldC5qb2lzdC5zaW0uZGltZW5zaW9uUHJvcGVydHkudmFsdWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgYmFkLXBoZXQtbGlicmFyeS10ZXh0XHJcbiAgICAgIHdpZHRoID0gc2ltRGltZW5zaW9ucy53aWR0aDtcclxuICAgICAgaGVpZ2h0ID0gc2ltRGltZW5zaW9ucy5oZWlnaHQ7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdGFnZS5zZXREaW1lbnNpb25zKCB3aWR0aCwgaGVpZ2h0ICk7XHJcblxyXG4gICAgdGhpcy5iYWNrZ3JvdW5kRXZlbnRUYXJnZXQuc2V0UmVjdEJvdW5kcyggdGhpcy5nbG9iYWxUb0xvY2FsQm91bmRzKCBuZXcgQm91bmRzMiggMCwgMCwgd2lkdGgsIGhlaWdodCApICkgKTtcclxuXHJcbiAgICAvLyBmaWVsZCBvZiB2aWV3IChGT1YpIGNvbXB1dGF0aW9uIGZvciB0aGUgaXNvbWV0cmljIHZpZXcgc2NhbGluZyB3ZSB1c2VcclxuICAgIGNvbnN0IHN4ID0gd2lkdGggLyB0aGlzLmxheW91dEJvdW5kcy53aWR0aDtcclxuICAgIGNvbnN0IHN5ID0gaGVpZ2h0IC8gdGhpcy5sYXlvdXRCb3VuZHMuaGVpZ2h0O1xyXG4gICAgaWYgKCBzeCAhPT0gMCAmJiBzeSAhPT0gMCApIHtcclxuXHJcbiAgICAgIHRoaXMuc3RhZ2UuYWN0aXZlU2NhbGUgPSBzeSA+IHN4ID8gc3ggOiBzeTtcclxuXHJcbiAgICAgIHRoaXMudmlld09mZnNldExpc3RlbmVyKCk7XHJcblxyXG4gICAgICBpZiAoIHRoaXMuc3RhZ2UudGhyZWVSZW5kZXJlciApIHtcclxuICAgICAgICB0aGlzLmRvbU5vZGUuaW52YWxpZGF0ZURPTSgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW5kZXJzIHRoZSBzaW11bGF0aW9uIHRvIGEgc3BlY2lmaWMgcmVuZGVyaW5nIHRhcmdldFxyXG4gICAqXHJcbiAgICogQHBhcmFtIHRhcmdldCAtIHVuZGVmaW5lZCBmb3IgdGhlIGRlZmF1bHQgdGFyZ2V0XHJcbiAgICovXHJcbiAgcHVibGljIHJlbmRlciggdGFyZ2V0OiBUSFJFRS5XZWJHTFJlbmRlclRhcmdldCB8IHVuZGVmaW5lZCApOiB2b2lkIHtcclxuICAgIHRoaXMuc3RhZ2UucmVuZGVyKCB0YXJnZXQgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbGVhc2VzIHJlZmVyZW5jZXMuXHJcbiAgICovXHJcbiAgcHVibGljIG92ZXJyaWRlIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLnBhcmVudE1hdHJpeFByb3BlcnR5LnVubGluayggdGhpcy52aWV3T2Zmc2V0TGlzdGVuZXIgKTtcclxuXHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcblxyXG4gICAgdGhpcy5zdGFnZS5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5tb2JpdXMucmVnaXN0ZXIoICdUaHJlZUlzb21ldHJpY05vZGUnLCBUaHJlZUlzb21ldHJpY05vZGUgKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFFBQVEsTUFBTSwyQkFBMkI7QUFDaEQsT0FBT0MsT0FBTyxNQUFNLHlCQUF5QjtBQUM3QyxPQUFPQyxPQUFPLE1BQU0seUJBQXlCO0FBQzdDLE9BQU9DLFNBQVMsTUFBTSxpQ0FBaUM7QUFDdkQsU0FBU0MsR0FBRyxFQUFFQyxJQUFJLEVBQWVDLFNBQVMsUUFBUSw2QkFBNkI7QUFDL0UsT0FBT0MscUJBQXFCLE1BQU0sNEJBQTRCO0FBQzlELE9BQU9DLFVBQVUsTUFBNkIsaUJBQWlCO0FBQy9ELE9BQU9DLE1BQU0sTUFBTSxhQUFhO0FBaUJoQyxlQUFlLE1BQU1DLGtCQUFrQixTQUFTTCxJQUFJLENBQUM7RUFPbkQ7O0VBTU9NLFdBQVdBLENBQUVDLFlBQXFCLEVBQUVDLGVBQTJDLEVBQUc7SUFFdkYsTUFBTUMsT0FBTyxHQUFHWCxTQUFTLENBQTBFLENBQUMsQ0FBRTtNQUNwR1ksb0JBQW9CLEVBQUUsSUFBSWYsUUFBUSxDQUFFRSxPQUFPLENBQUNjLFFBQVMsQ0FBQztNQUV0REMsR0FBRyxFQUFFLEVBQUU7TUFDUDtNQUNBOztNQUVBOztNQUVBOztNQUVBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUM7SUFDMUIsQ0FBQyxFQUFFTCxlQUFnQixDQUFDO0lBRXBCLEtBQUssQ0FBQyxDQUFDO0lB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