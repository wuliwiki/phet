// Copyright 2019-2023, University of Colorado Boulder

/**
 * Model class for Number Play. It is used for both the 'Ten' and 'Twenty' screens.
 *
 * @author Chris Klusendorf (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import numberPlay from '../../numberPlay.js';
import CountingArea from '../../../../number-suite-common/js/common/model/CountingArea.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import GroupAndLinkType from '../../../../number-suite-common/js/common/model/GroupAndLinkType.js';
import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import CountingObjectType from '../../../../counting-common/js/common/model/CountingObjectType.js';
import Range from '../../../../dot/js/Range.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Emitter from '../../../../axon/js/Emitter.js';
import numberPlayPreferences from './numberPlayPreferences.js';
import NumberSuiteCommonConstants from '../../../../number-suite-common/js/common/NumberSuiteCommonConstants.js';
import Multilink from '../../../../axon/js/Multilink.js';
import localeProperty from '../../../../joist/js/i18n/localeProperty.js';
class NumberPlayModel {
  // the current "counted to" number, which is the central aspect of this whole sim

  // the model for managing the countingArea in the OnesAccordionBox

  // the model for managing the countingArea in the ObjectsAccordionBox

  // the type of objects in the objectsCountingArea. primarily used in the view.

  // whether the objectsCountingArea is ungrouped, grouped, or linked. set by the view controls and used to link/unlink
  // onesCountingArea and objectsCountingArea, and grouped/ungroup objects in the objectsCountingArea
  // emits when the objectsCountingArea becomes linked or unlinked to the onesCountingArea
  // true when the sim is being reset. this is used so that countingAreas don't return things to their creatorNodes the normal
  // way (with animations), but instead with a different reset case (no animations).
  // whether counting objects should be grouped or ungrouped
  constructor(highestCount, speechDataProperty, tandem) {
    this.sumRange = new Range(0, highestCount);
    this.isResettingProperty = new BooleanProperty(false);
    this.countingObjectTypeProperty = new EnumerationProperty(CountingObjectType.DOG);
    this.objectsGroupAndLinkTypeProperty = new EnumerationProperty(GroupAndLinkType.UNGROUPED);
    this.linkStatusChangedEmitter = new Emitter({
      parameters: [{
        valueType: 'boolean'
      }]
    });
    this.groupingEnabledProperty = new DerivedProperty([this.objectsGroupAndLinkTypeProperty], groupAndLinkType => {
      return groupAndLinkType === GroupAndLinkType.GROUPED || groupAndLinkType === GroupAndLinkType.GROUPED_AND_LINKED;
    });
    this.onesCountingArea = new CountingArea(highestCount, new BooleanProperty(true));
    this.objectsCountingArea = new CountingArea(highestCount, this.groupingEnabledProperty);
    let onesLeading = false;
    let objectsLeading = false;
    this.currentNumberProperty = new NumberProperty(0);

    // Update the speechDataProperty when the currentNumber, isPrimaryLocale, primaryLocale, secondaryLocale changes.
    // Link to localeProperty is needed here but not passed through to numberToWord because numberToWord uses built-in
    // StringProperty's to get the primaryLocale string values. Note: it is assumed that the StringProperty's have the
    // correct value for a given locale when the localeProperty causes this Multilink to fire. This assumption is based
    // on an order dependency that those StringProperty's will update before this multilink fires.
    Multilink.multilink([this.currentNumberProperty, numberPlayPreferences.isPrimaryLocaleProperty, numberPlayPreferences.secondLocaleStringsProperty, localeProperty], (currentNumber, isPrimaryLocale, secondLocaleStrings) => {
      speechDataProperty.value = NumberSuiteCommonConstants.numberToWord(secondLocaleStrings, currentNumber, isPrimaryLocale);
    });

    // Update the currentNumberProperty and objectsCountingArea when the onesCountingArea sum changes.
    this.onesCountingArea.sumProperty.lazyLink((sum, oldSum) => {
      if (!objectsLeading) {
        assert && assert(!onesLeading, 'onesLeading already true, reentrant detected');
        onesLeading = true;
        this.currentNumberProperty.value = sum;
        this.matchCountingAreaToNewValue(sum, oldSum, this.objectsCountingArea);
        onesLeading = false;
      }
    });

    // Update the currentNumberProperty and onesCountingArea when the objectsCountingArea sum changes.
    this.objectsCountingArea.sumProperty.lazyLink((sum, oldSum) => {
      if (!onesLeading) {
        assert && assert(!objectsLeading, 'objectsLeading already true, reentrant detected');
        objectsLeading = true;
        this.currentNumberProperty.value = sum;
        this.matchCountingAreaToNewValue(sum, oldSum, this.onesCountingArea);
        objectsLeading = false;
      }
    });
  }
  matchCountingAreaToNewValue(newValue, oldValue, countingArea) {
    const difference = newValue - oldValue;
    if (difference > 0) {
      assert && assert(difference === 1, 'A countingArea should not need to create more than one counting object' + 'at a time to match the opposite countingArea: ' + difference);
      countingArea.createCountingObjectFromCreatorNode();
    } else {
      countingArea.returnCountingObjectToCreatorNode(Math.abs(difference));
    }
  }

  /**
   * Resets the model.
   */
  reset() {
    this.isResettingProperty.value = true;
    numberPlayPreferences.isPrimaryLocaleProperty.reset();
    this.countingObjectTypeProperty.reset();
    this.objectsGroupAndLinkTypeProperty.reset();
    this.onesCountingArea.reset();
    this.objectsCountingArea.reset();
    this.isResettingProperty.value = false;
  }
  dispose() {
    assert && assert(false, 'dispose is not supported, exists for the lifetime of the sim');
  }
}
numberPlay.register('NumberPlayModel', NumberPlayModel);
export default NumberPlayModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJudW1iZXJQbGF5IiwiQ291bnRpbmdBcmVhIiwiRW51bWVyYXRpb25Qcm9wZXJ0eSIsIkdyb3VwQW5kTGlua1R5cGUiLCJEZXJpdmVkUHJvcGVydHkiLCJDb3VudGluZ09iamVjdFR5cGUiLCJSYW5nZSIsIk51bWJlclByb3BlcnR5IiwiRW1pdHRlciIsIm51bWJlclBsYXlQcmVmZXJlbmNlcyIsIk51bWJlclN1aXRlQ29tbW9uQ29uc3RhbnRzIiwiTXVsdGlsaW5rIiwibG9jYWxlUHJvcGVydHkiLCJOdW1iZXJQbGF5TW9kZWwiLCJjb25zdHJ1Y3RvciIsImhpZ2hlc3RDb3VudCIsInNwZWVjaERhdGFQcm9wZXJ0eSIsInRhbmRlbSIsInN1bVJhbmdlIiwiaXNSZXNldHRpbmdQcm9wZXJ0eSIsImNvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5IiwiRE9HIiwib2JqZWN0c0dyb3VwQW5kTGlua1R5cGVQcm9wZXJ0eSIsIlVOR1JPVVBFRCIsImxpbmtTdGF0dXNDaGFuZ2VkRW1pdHRlciIsInBhcmFtZXRlcnMiLCJ2YWx1ZVR5cGUiLCJncm91cGluZ0VuYWJsZWRQcm9wZXJ0eSIsImdyb3VwQW5kTGlua1R5cGUiLCJHUk9VUEVEIiwiR1JPVVBFRF9BTkRfTElOS0VEIiwib25lc0NvdW50aW5nQXJlYSIsIm9iamVjdHNDb3VudGluZ0FyZWEiLCJvbmVzTGVhZGluZyIsIm9iamVjdHNMZWFkaW5nIiwiY3VycmVudE51bWJlclByb3BlcnR5IiwibXVsdGlsaW5rIiwiaXNQcmltYXJ5TG9jYWxlUHJvcGVydHkiLCJzZWNvbmRMb2NhbGVTdHJpbmdzUHJvcGVydHkiLCJjdXJyZW50TnVtYmVyIiwiaXNQcmltYXJ5TG9jYWxlIiwic2Vjb25kTG9jYWxlU3RyaW5ncyIsInZhbHVlIiwibnVtYmVyVG9Xb3JkIiwic3VtUHJvcGVydHkiLCJsYXp5TGluayIsInN1bSIsIm9sZFN1bSIsImFzc2VydCIsIm1hdGNoQ291bnRpbmdBcmVhVG9OZXdWYWx1ZSIsIm5ld1ZhbHVlIiwib2xkVmFsdWUiLCJjb3VudGluZ0FyZWEiLCJkaWZmZXJlbmNlIiwiY3JlYXRlQ291bnRpbmdPYmplY3RGcm9tQ3JlYXRvck5vZGUiLCJyZXR1cm5Db3VudGluZ09iamVjdFRvQ3JlYXRvck5vZGUiLCJNYXRoIiwiYWJzIiwicmVzZXQiLCJkaXNwb3NlIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJOdW1iZXJQbGF5TW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTW9kZWwgY2xhc3MgZm9yIE51bWJlciBQbGF5LiBJdCBpcyB1c2VkIGZvciBib3RoIHRoZSAnVGVuJyBhbmQgJ1R3ZW50eScgc2NyZWVucy5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBLbHVzZW5kb3JmIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbnVtYmVyUGxheSBmcm9tICcuLi8uLi9udW1iZXJQbGF5LmpzJztcclxuaW1wb3J0IENvdW50aW5nQXJlYSBmcm9tICcuLi8uLi8uLi8uLi9udW1iZXItc3VpdGUtY29tbW9uL2pzL2NvbW1vbi9tb2RlbC9Db3VudGluZ0FyZWEuanMnO1xyXG5pbXBvcnQgVGFuZGVtIGZyb20gJy4uLy4uLy4uLy4uL3RhbmRlbS9qcy9UYW5kZW0uanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VudW1lcmF0aW9uUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgR3JvdXBBbmRMaW5rVHlwZSBmcm9tICcuLi8uLi8uLi8uLi9udW1iZXItc3VpdGUtY29tbW9uL2pzL2NvbW1vbi9tb2RlbC9Hcm91cEFuZExpbmtUeXBlLmpzJztcclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IENvdW50aW5nT2JqZWN0VHlwZSBmcm9tICcuLi8uLi8uLi8uLi9jb3VudGluZy1jb21tb24vanMvY29tbW9uL21vZGVsL0NvdW50aW5nT2JqZWN0VHlwZS5qcyc7XHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgVE1vZGVsIGZyb20gJy4uLy4uLy4uLy4uL2pvaXN0L2pzL1RNb2RlbC5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFRFbWl0dGVyIGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVEVtaXR0ZXIuanMnO1xyXG5pbXBvcnQgRW1pdHRlciBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0VtaXR0ZXIuanMnO1xyXG5pbXBvcnQgbnVtYmVyUGxheVByZWZlcmVuY2VzIGZyb20gJy4vbnVtYmVyUGxheVByZWZlcmVuY2VzLmpzJztcclxuaW1wb3J0IE51bWJlclN1aXRlQ29tbW9uQ29uc3RhbnRzIGZyb20gJy4uLy4uLy4uLy4uL251bWJlci1zdWl0ZS1jb21tb24vanMvY29tbW9uL051bWJlclN1aXRlQ29tbW9uQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBsb2NhbGVQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9qb2lzdC9qcy9pMThuL2xvY2FsZVByb3BlcnR5LmpzJztcclxuXHJcbmNsYXNzIE51bWJlclBsYXlNb2RlbCBpbXBsZW1lbnRzIFRNb2RlbCB7XHJcblxyXG4gIHB1YmxpYyByZWFkb25seSBzdW1SYW5nZTogUmFuZ2U7XHJcblxyXG4gIC8vIHRoZSBjdXJyZW50IFwiY291bnRlZCB0b1wiIG51bWJlciwgd2hpY2ggaXMgdGhlIGNlbnRyYWwgYXNwZWN0IG9mIHRoaXMgd2hvbGUgc2ltXHJcbiAgcHVibGljIHJlYWRvbmx5IGN1cnJlbnROdW1iZXJQcm9wZXJ0eTogUHJvcGVydHk8bnVtYmVyPjtcclxuXHJcbiAgLy8gdGhlIG1vZGVsIGZvciBtYW5hZ2luZyB0aGUgY291bnRpbmdBcmVhIGluIHRoZSBPbmVzQWNjb3JkaW9uQm94XHJcbiAgcHVibGljIHJlYWRvbmx5IG9uZXNDb3VudGluZ0FyZWE6IENvdW50aW5nQXJlYTtcclxuXHJcbiAgLy8gdGhlIG1vZGVsIGZvciBtYW5hZ2luZyB0aGUgY291bnRpbmdBcmVhIGluIHRoZSBPYmplY3RzQWNjb3JkaW9uQm94XHJcbiAgcHVibGljIHJlYWRvbmx5IG9iamVjdHNDb3VudGluZ0FyZWE6IENvdW50aW5nQXJlYTtcclxuXHJcbiAgLy8gdGhlIHR5cGUgb2Ygb2JqZWN0cyBpbiB0aGUgb2JqZWN0c0NvdW50aW5nQXJlYS4gcHJpbWFyaWx5IHVzZWQgaW4gdGhlIHZpZXcuXHJcbiAgcHVibGljIHJlYWRvbmx5IGNvdW50aW5nT2JqZWN0VHlwZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PENvdW50aW5nT2JqZWN0VHlwZT47XHJcblxyXG4gIC8vIHdoZXRoZXIgdGhlIG9iamVjdHNDb3VudGluZ0FyZWEgaXMgdW5ncm91cGVkLCBncm91cGVkLCBvciBsaW5rZWQuIHNldCBieSB0aGUgdmlldyBjb250cm9scyBhbmQgdXNlZCB0byBsaW5rL3VubGlua1xyXG4gIC8vIG9uZXNDb3VudGluZ0FyZWEgYW5kIG9iamVjdHNDb3VudGluZ0FyZWEsIGFuZCBncm91cGVkL3VuZ3JvdXAgb2JqZWN0cyBpbiB0aGUgb2JqZWN0c0NvdW50aW5nQXJlYVxyXG4gIHB1YmxpYyByZWFkb25seSBvYmplY3RzR3JvdXBBbmRMaW5rVHlwZVByb3BlcnR5OiBFbnVtZXJhdGlvblByb3BlcnR5PEdyb3VwQW5kTGlua1R5cGU+O1xyXG5cclxuICAvLyBlbWl0cyB3aGVuIHRoZSBvYmplY3RzQ291bnRpbmdBcmVhIGJlY29tZXMgbGlua2VkIG9yIHVubGlua2VkIHRvIHRoZSBvbmVzQ291bnRpbmdBcmVhXHJcbiAgcHVibGljIHJlYWRvbmx5IGxpbmtTdGF0dXNDaGFuZ2VkRW1pdHRlcjogVEVtaXR0ZXI8WyBib29sZWFuIF0+O1xyXG5cclxuICAvLyB0cnVlIHdoZW4gdGhlIHNpbSBpcyBiZWluZyByZXNldC4gdGhpcyBpcyB1c2VkIHNvIHRoYXQgY291bnRpbmdBcmVhcyBkb24ndCByZXR1cm4gdGhpbmdzIHRvIHRoZWlyIGNyZWF0b3JOb2RlcyB0aGUgbm9ybWFsXHJcbiAgLy8gd2F5ICh3aXRoIGFuaW1hdGlvbnMpLCBidXQgaW5zdGVhZCB3aXRoIGEgZGlmZmVyZW50IHJlc2V0IGNhc2UgKG5vIGFuaW1hdGlvbnMpLlxyXG4gIHByaXZhdGUgcmVhZG9ubHkgaXNSZXNldHRpbmdQcm9wZXJ0eTogVFByb3BlcnR5PGJvb2xlYW4+O1xyXG5cclxuICAvLyB3aGV0aGVyIGNvdW50aW5nIG9iamVjdHMgc2hvdWxkIGJlIGdyb3VwZWQgb3IgdW5ncm91cGVkXHJcbiAgcHJpdmF0ZSByZWFkb25seSBncm91cGluZ0VuYWJsZWRQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8Ym9vbGVhbj47XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvciggaGlnaGVzdENvdW50OiBudW1iZXIsIHNwZWVjaERhdGFQcm9wZXJ0eTogVFByb3BlcnR5PHN0cmluZz4sIHRhbmRlbTogVGFuZGVtICkge1xyXG5cclxuICAgIHRoaXMuc3VtUmFuZ2UgPSBuZXcgUmFuZ2UoIDAsIGhpZ2hlc3RDb3VudCApO1xyXG5cclxuICAgIHRoaXMuaXNSZXNldHRpbmdQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIGZhbHNlICk7XHJcblxyXG4gICAgdGhpcy5jb3VudGluZ09iamVjdFR5cGVQcm9wZXJ0eSA9IG5ldyBFbnVtZXJhdGlvblByb3BlcnR5KCBDb3VudGluZ09iamVjdFR5cGUuRE9HICk7XHJcblxyXG4gICAgdGhpcy5vYmplY3RzR3JvdXBBbmRMaW5rVHlwZVByb3BlcnR5ID0gbmV3IEVudW1lcmF0aW9uUHJvcGVydHkoIEdyb3VwQW5kTGlua1R5cGUuVU5HUk9VUEVEICk7XHJcblxyXG4gICAgdGhpcy5saW5rU3RhdHVzQ2hhbmdlZEVtaXR0ZXIgPSBuZXcgRW1pdHRlciggeyBwYXJhbWV0ZXJzOiBbIHsgdmFsdWVUeXBlOiAnYm9vbGVhbicgfSBdIH0gKTtcclxuXHJcbiAgICB0aGlzLmdyb3VwaW5nRW5hYmxlZFByb3BlcnR5ID0gbmV3IERlcml2ZWRQcm9wZXJ0eSggWyB0aGlzLm9iamVjdHNHcm91cEFuZExpbmtUeXBlUHJvcGVydHkgXSwgZ3JvdXBBbmRMaW5rVHlwZSA9PiB7XHJcbiAgICAgIHJldHVybiAoIGdyb3VwQW5kTGlua1R5cGUgPT09IEdyb3VwQW5kTGlua1R5cGUuR1JPVVBFRCB8fCBncm91cEFuZExpbmtUeXBlID09PSBHcm91cEFuZExpbmtUeXBlLkdST1VQRURfQU5EX0xJTktFRCApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMub25lc0NvdW50aW5nQXJlYSA9IG5ldyBDb3VudGluZ0FyZWEoIGhpZ2hlc3RDb3VudCwgbmV3IEJvb2xlYW5Qcm9wZXJ0eSggdHJ1ZSApICk7XHJcblxyXG4gICAgdGhpcy5vYmplY3RzQ291bnRpbmdBcmVhID0gbmV3IENvdW50aW5nQXJlYSggaGlnaGVzdENvdW50LCB0aGlzLmdyb3VwaW5nRW5hYmxlZFByb3BlcnR5ICk7XHJcblxyXG4gICAgbGV0IG9uZXNMZWFkaW5nID0gZmFsc2U7XHJcbiAgICBsZXQgb2JqZWN0c0xlYWRpbmcgPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLmN1cnJlbnROdW1iZXJQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggMCApO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgc3BlZWNoRGF0YVByb3BlcnR5IHdoZW4gdGhlIGN1cnJlbnROdW1iZXIsIGlzUHJpbWFyeUxvY2FsZSwgcHJpbWFyeUxvY2FsZSwgc2Vjb25kYXJ5TG9jYWxlIGNoYW5nZXMuXHJcbiAgICAvLyBMaW5rIHRvIGxvY2FsZVByb3BlcnR5IGlzIG5lZWRlZCBoZXJlIGJ1dCBub3QgcGFzc2VkIHRocm91Z2ggdG8gbnVtYmVyVG9Xb3JkIGJlY2F1c2UgbnVtYmVyVG9Xb3JkIHVzZXMgYnVpbHQtaW5cclxuICAgIC8vIFN0cmluZ1Byb3BlcnR5J3MgdG8gZ2V0IHRoZSBwcmltYXJ5TG9jYWxlIHN0cmluZyB2YWx1ZXMuIE5vdGU6IGl0IGlzIGFzc3VtZWQgdGhhdCB0aGUgU3RyaW5nUHJvcGVydHkncyBoYXZlIHRoZVxyXG4gICAgLy8gY29ycmVjdCB2YWx1ZSBmb3IgYSBnaXZlbiBsb2NhbGUgd2hlbiB0aGUgbG9jYWxlUHJvcGVydHkgY2F1c2VzIHRoaXMgTXVsdGlsaW5rIHRvIGZpcmUuIFRoaXMgYXNzdW1wdGlvbiBpcyBiYXNlZFxyXG4gICAgLy8gb24gYW4gb3JkZXIgZGVwZW5kZW5jeSB0aGF0IHRob3NlIFN0cmluZ1Byb3BlcnR5J3Mgd2lsbCB1cGRhdGUgYmVmb3JlIHRoaXMgbXVsdGlsaW5rIGZpcmVzLlxyXG4gICAgTXVsdGlsaW5rLm11bHRpbGluayggW1xyXG4gICAgICB0aGlzLmN1cnJlbnROdW1iZXJQcm9wZXJ0eSxcclxuICAgICAgbnVtYmVyUGxheVByZWZlcmVuY2VzLmlzUHJpbWFyeUxvY2FsZVByb3BlcnR5LFxyXG4gICAgICBudW1iZXJQbGF5UHJlZmVyZW5jZXMuc2Vjb25kTG9jYWxlU3RyaW5nc1Byb3BlcnR5LFxyXG4gICAgICBsb2NhbGVQcm9wZXJ0eVxyXG4gICAgXSwgKCBjdXJyZW50TnVtYmVyLCBpc1ByaW1hcnlMb2NhbGUsIHNlY29uZExvY2FsZVN0cmluZ3MgKSA9PiB7XHJcbiAgICAgIHNwZWVjaERhdGFQcm9wZXJ0eS52YWx1ZSA9IE51bWJlclN1aXRlQ29tbW9uQ29uc3RhbnRzLm51bWJlclRvV29yZCggc2Vjb25kTG9jYWxlU3RyaW5ncywgY3VycmVudE51bWJlciwgaXNQcmltYXJ5TG9jYWxlICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBjdXJyZW50TnVtYmVyUHJvcGVydHkgYW5kIG9iamVjdHNDb3VudGluZ0FyZWEgd2hlbiB0aGUgb25lc0NvdW50aW5nQXJlYSBzdW0gY2hhbmdlcy5cclxuICAgIHRoaXMub25lc0NvdW50aW5nQXJlYS5zdW1Qcm9wZXJ0eS5sYXp5TGluayggKCBzdW0sIG9sZFN1bSApID0+IHtcclxuICAgICAgaWYgKCAhb2JqZWN0c0xlYWRpbmcgKSB7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIW9uZXNMZWFkaW5nLCAnb25lc0xlYWRpbmcgYWxyZWFkeSB0cnVlLCByZWVudHJhbnQgZGV0ZWN0ZWQnICk7XHJcbiAgICAgICAgb25lc0xlYWRpbmcgPSB0cnVlO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnROdW1iZXJQcm9wZXJ0eS52YWx1ZSA9IHN1bTtcclxuICAgICAgICB0aGlzLm1hdGNoQ291bnRpbmdBcmVhVG9OZXdWYWx1ZSggc3VtLCBvbGRTdW0sIHRoaXMub2JqZWN0c0NvdW50aW5nQXJlYSApO1xyXG5cclxuICAgICAgICBvbmVzTGVhZGluZyA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBjdXJyZW50TnVtYmVyUHJvcGVydHkgYW5kIG9uZXNDb3VudGluZ0FyZWEgd2hlbiB0aGUgb2JqZWN0c0NvdW50aW5nQXJlYSBzdW0gY2hhbmdlcy5cclxuICAgIHRoaXMub2JqZWN0c0NvdW50aW5nQXJlYS5zdW1Qcm9wZXJ0eS5sYXp5TGluayggKCBzdW0sIG9sZFN1bSApID0+IHtcclxuICAgICAgaWYgKCAhb25lc0xlYWRpbmcgKSB7XHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggIW9iamVjdHNMZWFkaW5nLCAnb2JqZWN0c0xlYWRpbmcgYWxyZWFkeSB0cnVlLCByZWVudHJhbnQgZGV0ZWN0ZWQnICk7XHJcbiAgICAgICAgb2JqZWN0c0xlYWRpbmcgPSB0cnVlO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnROdW1iZXJQcm9wZXJ0eS52YWx1ZSA9IHN1bTtcclxuICAgICAgICB0aGlzLm1hdGNoQ291bnRpbmdBcmVhVG9OZXdWYWx1ZSggc3VtLCBvbGRTdW0sIHRoaXMub25lc0NvdW50aW5nQXJlYSApO1xyXG5cclxuICAgICAgICBvYmplY3RzTGVhZGluZyA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG1hdGNoQ291bnRpbmdBcmVhVG9OZXdWYWx1ZSggbmV3VmFsdWU6IG51bWJlciwgb2xkVmFsdWU6IG51bWJlciwgY291bnRpbmdBcmVhOiBDb3VudGluZ0FyZWEgKTogdm9pZCB7XHJcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gbmV3VmFsdWUgLSBvbGRWYWx1ZTtcclxuXHJcbiAgICBpZiAoIGRpZmZlcmVuY2UgPiAwICkge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBkaWZmZXJlbmNlID09PSAxLCAnQSBjb3VudGluZ0FyZWEgc2hvdWxkIG5vdCBuZWVkIHRvIGNyZWF0ZSBtb3JlIHRoYW4gb25lIGNvdW50aW5nIG9iamVjdCcgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXQgYSB0aW1lIHRvIG1hdGNoIHRoZSBvcHBvc2l0ZSBjb3VudGluZ0FyZWE6ICcgKyBkaWZmZXJlbmNlICk7XHJcbiAgICAgIGNvdW50aW5nQXJlYS5jcmVhdGVDb3VudGluZ09iamVjdEZyb21DcmVhdG9yTm9kZSgpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvdW50aW5nQXJlYS5yZXR1cm5Db3VudGluZ09iamVjdFRvQ3JlYXRvck5vZGUoIE1hdGguYWJzKCBkaWZmZXJlbmNlICkgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc2V0cyB0aGUgbW9kZWwuXHJcbiAgICovXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pc1Jlc2V0dGluZ1Byb3BlcnR5LnZhbHVlID0gdHJ1ZTtcclxuICAgIG51bWJlclBsYXlQcmVmZXJlbmNlcy5pc1ByaW1hcnlMb2NhbGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5jb3VudGluZ09iamVjdFR5cGVQcm9wZXJ0eS5yZXNldCgpO1xyXG4gICAgdGhpcy5vYmplY3RzR3JvdXBBbmRMaW5rVHlwZVByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLm9uZXNDb3VudGluZ0FyZWEucmVzZXQoKTtcclxuICAgIHRoaXMub2JqZWN0c0NvdW50aW5nQXJlYS5yZXNldCgpO1xyXG4gICAgdGhpcy5pc1Jlc2V0dGluZ1Byb3BlcnR5LnZhbHVlID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnZGlzcG9zZSBpcyBub3Qgc3VwcG9ydGVkLCBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltJyApO1xyXG4gIH1cclxufVxyXG5cclxubnVtYmVyUGxheS5yZWdpc3RlciggJ051bWJlclBsYXlNb2RlbCcsIE51bWJlclBsYXlNb2RlbCApO1xyXG5leHBvcnQgZGVmYXVsdCBOdW1iZXJQbGF5TW9kZWw7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsVUFBVSxNQUFNLHFCQUFxQjtBQUM1QyxPQUFPQyxZQUFZLE1BQU0saUVBQWlFO0FBRTFGLE9BQU9DLG1CQUFtQixNQUFNLDRDQUE0QztBQUM1RSxPQUFPQyxnQkFBZ0IsTUFBTSxxRUFBcUU7QUFDbEcsT0FBT0MsZUFBZSxNQUFNLHdDQUF3QztBQUVwRSxPQUFPQyxrQkFBa0IsTUFBTSxtRUFBbUU7QUFDbEcsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxjQUFjLE1BQU0sdUNBQXVDO0FBS2xFLE9BQU9DLE9BQU8sTUFBTSxnQ0FBZ0M7QUFDcEQsT0FBT0MscUJBQXFCLE1BQU0sNEJBQTRCO0FBQzlELE9BQU9DLDBCQUEwQixNQUFNLHlFQUF5RTtBQUNoSCxPQUFPQyxTQUFTLE1BQU0sa0NBQWtDO0FBQ3hELE9BQU9DLGNBQWMsTUFBTSw2Q0FBNkM7QUFFeEUsTUFBTUMsZUFBZSxDQUFtQjtFQUl0Qzs7RUFHQTs7RUFHQTs7RUFHQTs7RUFHQTtFQUNBO0VBR0E7RUFHQTtFQUNBO0VBR0E7RUFHVUMsV0FBV0EsQ0FBRUMsWUFBb0IsRUFBRUMsa0JBQXFDLEVBQUVDLE1BQWMsRUFBRztJQUVuRyxJQUFJLENBQUNDLFFBQVEsR0FBRyxJQUFJWixLQUFLLENBQUUsQ0FBQyxFQUFFUyxZQUFhLENBQUM7SUFFNUMsSUFBSSxDQUFDSSxtQkFBbUIsR0FBRyxJQUFJcEIsZUFBZSxDQUFFLEtBQU0sQ0FBQztJQUV2RCxJQUFJLENBQUNxQiwwQkFBMEIsR0FBRyxJQUFJbEIsbUJBQW1CLENBQUVHLGtCQUFrQixDQUFDZ0IsR0FBSSxDQUFDO0lBRW5GLElBQUksQ0FBQ0MsK0JBQStCLEdBQUcsSUFBSXBCLG1CQUFtQixDQUFFQyxnQkFBZ0IsQ0FBQ29CLFNBQVUsQ0FBQztJQUU1RixJQUFJLENBQUNDLHdCQUF3QixHQUFHLElBQUloQixPQUFPLENBQUU7TUFBRWlCLFVBQVUsRUFBRSxDQUFFO1FBQUVDLFNBQVMsRUFBRTtNQUFVLENBQUM7SUFBRyxDQUFFLENBQUM7SUFFM0YsSUFBSSxDQUFDQyx1QkFBdUIsR0FBRyxJQUFJdkIsZUFBZSxDQUFFLENBQUUsSUFBSSxDQUFDa0IsK0JBQStCLENBQUUsRUFBRU0sZ0JBQWdCLElBQUk7TUFDaEgsT0FBU0EsZ0JBQWdCLEtBQUt6QixnQkFBZ0IsQ0FBQzBCLE9BQU8sSUFBSUQsZ0JBQWdCLEtBQUt6QixnQkFBZ0IsQ0FBQzJCLGtCQUFrQjtJQUNwSCxDQUFFLENBQUM7SUFFSCxJQUFJLENBQUNDLGdCQUFnQixHQUFHLElBQUk5QixZQUFZLENBQUVjLFlBQVksRUFBRSxJQUFJaEIsZUFBZSxDQUFFLElBQUssQ0FBRSxDQUFDO0lBRXJGLElBQUksQ0FBQ2lDLG1CQUFtQixHQUFHLElBQUkvQixZQUFZLENBQUVjLFlBQVksRUFBRSxJQUFJLENBQUNZLHVCQUF3QixDQUFDO0lBRXpGLElBQUlNLFdBQVcsR0FBRyxLQUFLO0lBQ3ZCLElBQUlDLGNBQWMsR0FBRyxLQUFLO0lBRTFCLElBQUksQ0FBQ0MscUJBQXFCLEdBQUcsSUFBSTVCLGNBQWMsQ0FBRSxDQUFFLENBQUM7O0lBRXBEO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQUksU0FBUyxDQUFDeUIsU0FBUyxDQUFFLENBQ25CLElBQUksQ0FBQ0QscUJBQXFCLEVBQzFCMUIscUJBQXFCLENBQUM0Qix1QkFBdUIsRUFDN0M1QixxQkFBcUIsQ0FBQzZCLDJCQUEyQixFQUNqRDFCLGNBQWMsQ0FDZixFQUFFLENBQUUyQixhQUFhLEVBQUVDLGVBQWUsRUFBRUMsbUJBQW1CLEtBQU07TUFDNUR6QixrQkFBa0IsQ0FBQzBCLEtBQUssR0FBR2hDLDBCQUEwQixDQUFDaUMsWUFBWSxDQUFFRixtQkFBbUIsRUFBRUYsYUFBYSxFQUFFQyxlQUFnQixDQUFDO0lBQzNILENBQUUsQ0FBQzs7SUFFSDtJQUNBLElBQUksQ0FBQ1QsZ0JBQWdCLENBQUNhLFdBQVcsQ0FBQ0MsUUFBUSxDQUFFLENBQUVDLEdBQUcsRUFBRUMsTUFBTSxLQUFNO01BQzdELElBQUssQ0FBQ2IsY0FBYyxFQUFHO1FBQ3JCYyxNQUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDZixXQUFXLEVBQUUsOENBQStDLENBQUM7UUFDaEZBLFdBQVcsR0FBRyxJQUFJO1FBRWxCLElBQUksQ0FBQ0UscUJBQXFCLENBQUNPLEtBQUssR0FBR0ksR0FBRztRQUN0QyxJQUFJLENBQUNHLDJCQUEyQixDQUFFSCxHQUFHLEVBQUVDLE1BQU0sRUFBRSxJQUFJLENBQUNmLG1CQUFvQixDQUFDO1FBRXpFQyxXQUFXLEdBQUcsS0FBSztNQUNyQjtJQUNGLENBQUUsQ0FBQzs7SUFFSDtJQUNBLElBQUksQ0FBQ0QsbUJBQW1CLENBQUNZLFdBQVcsQ0FBQ0MsUUFBUSxDQUFFLENBQUVDLEdBQUcsRUFBRUMsTUFBTSxLQUFNO01BQ2hFLElBQUssQ0FBQ2QsV0FBVyxFQUFHO1FBQ2xCZSxNQUFNLElBQUlBLE1BQU0sQ0FBRSxDQUFDZCxjQUFjLEVBQUUsaURBQWtELENBQUM7UUFDdEZBLGNBQWMsR0FBRyxJQUFJO1FBRXJCLElBQUksQ0FBQ0MscUJBQXFCLENBQUNPLEtBQUssR0FBR0ksR0FBRztRQUN0QyxJQUFJLENBQUNHLDJCQUEyQixDQUFFSCxHQUFHLEVBQUVDLE1BQU0sRUFBRSxJQUFJLENBQUNoQixnQkFBaUIsQ0FBQztRQUV0RUcsY0FBYyxHQUFHLEtBQUs7TUFDeEI7SUFDRixDQUFFLENBQUM7RUFDTDtFQUVRZSwyQkFBMkJBLENBQUVDLFFBQWdCLEVBQUVDLFFBQWdCLEVBQUVDLFlBQTBCLEVBQVM7SUFDMUcsTUFBTUMsVUFBVSxHQUFHSCxRQUFRLEdBQUdDLFFBQVE7SUFFdEMsSUFBS0UsVUFBVSxHQUFHLENBQUMsRUFBRztNQUNwQkwsTUFBTSxJQUFJQSxNQUFNLENBQUVLLFVBQVUsS0FBSyxDQUFDLEVBQUUsd0VBQXdFLEdBQ3hFLGdEQUFnRCxHQUFHQSxVQUFXLENBQUM7TUFDbkdELFlBQVksQ0FBQ0UsbUNBQW1DLENBQUMsQ0FBQztJQUNwRCxDQUFDLE1BQ0k7TUFDSEYsWUFBWSxDQUFDRyxpQ0FBaUMsQ0FBRUMsSUFBSSxDQUFDQyxHQUFHLENBQUVKLFVBQVcsQ0FBRSxDQUFDO0lBQzFFO0VBQ0Y7O0VBRUE7QUFDRjtBQUNBO0VBQ1NLLEtBQUtBLENBQUEsRUFBUztJQUNuQixJQUFJLENBQUN2QyxtQkFBbUIsQ0FBQ3VCLEtBQUssR0FBRyxJQUFJO0lBQ3JDakMscUJBQXFCLENBQUM0Qix1QkFBdUIsQ0FBQ3FCLEtBQUssQ0FBQyxDQUFDO0lBQ3JELElBQUksQ0FBQ3RDLDBCQUEwQixDQUFDc0MsS0FBSyxDQUFDLENBQUM7SUFDdkMsSUFBSSxDQUFDcEMsK0JBQStCLENBQUNvQyxLQUFLLENBQUMsQ0FBQztJQUM1QyxJQUFJLENBQUMzQixnQkFBZ0IsQ0FBQzJCLEtBQUssQ0FBQyxDQUFDO0lBQzdCLElBQUksQ0FBQzFCLG1CQUFtQixDQUFDMEIsS0FBSyxDQUFDLENBQUM7SUFDaEMsSUFBSSxDQUFDdkMsbUJBQW1CLENBQUN1QixLQUFLLEdBQUcsS0FBSztFQUN4QztFQUVPaUIsT0FBT0EsQ0FBQSxFQUFTO0lBQ3JCWCxNQUFNLElBQUlBLE1BQU0sQ0FBRSxLQUFLLEVBQUUsOERBQStELENBQUM7RUFDM0Y7QUFDRjtBQUVBaEQsVUFBVSxDQUFDNEQsUUFBUSxDQUFFLGlCQUFpQixFQUFFL0MsZUFBZ0IsQ0FBQztBQUN6RCxlQUFlQSxlQUFlIn0=