// Copyright 2022, University of Colorado Boulder

/**
 * A node that presents a readout of the number of protons and neutrons.
 *
 * @author Luisa Vargas
 */

import Panel from '../../../../sun/js/Panel.js';
import buildANucleus from '../../buildANucleus.js';
import BANColors from '../BANColors.js';
import { HBox, Rectangle, Text } from '../../../../scenery/js/imports.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import ParticleNode from '../../../../shred/js/view/ParticleNode.js';
import BuildANucleusStrings from '../../BuildANucleusStrings.js';
import NumberDisplay from '../../../../scenery-phet/js/NumberDisplay.js';
import ParticleType from './ParticleType.js';
import BANConstants from '../BANConstants.js';
import Animation from '../../../../twixt/js/Animation.js';
import Easing from '../../../../twixt/js/Easing.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';

// types

// constants, empirically determined
const LABEL_FONT = new PhetFont(BANConstants.BUTTONS_AND_LEGEND_FONT_SIZE);
const MAX_TITLE_WIDTH = 90;
const MIN_VERTICAL_SPACING = 25;
const NUCLEON_PARTICLE_RADIUS = BANConstants.PARTICLE_RADIUS * 0.7;
class NucleonCountPanel extends Panel {
  constructor(protonCountProperty, protonCountRange, neutronCountProperty, neutronCountRange) {
    const options = {
      // options for the panel
      fill: BANColors.panelBackgroundColorProperty,
      xMargin: 10,
      stroke: BANConstants.PANEL_STROKE,
      cornerRadius: BANConstants.PANEL_CORNER_RADIUS
    };
    const panelContents = new Rectangle(0, 0, 140, 40); // empirically determined

    // function to create the nucleon labels and add them to panelContents
    const nucleonLabel = (nucleonString, nucleonType, nucleonCountProperty, nucleonCountRange) => {
      const nucleonTitle = new Text(nucleonString, {
        font: LABEL_FONT,
        maxWidth: MAX_TITLE_WIDTH
      });
      const nucleonParticleNode = new ParticleNode(nucleonType.name.toLowerCase(), NUCLEON_PARTICLE_RADIUS);
      const nucleonContents = new HBox({
        spacing: 5,
        children: [nucleonParticleNode, nucleonTitle]
      });
      nucleonTitle.left = nucleonParticleNode.right + nucleonParticleNode.width / 2;
      nucleonTitle.top = nucleonContents.top;
      nucleonParticleNode.centerY = nucleonTitle.centerY;
      panelContents.addChild(nucleonContents);

      // shows the new value of nucleonCountProperty
      const newNucleonNumberDisplay = new NumberDisplay(nucleonCountProperty, nucleonCountRange, {
        align: 'right',
        textOptions: {
          font: LABEL_FONT
        },
        backgroundFill: null,
        backgroundStroke: null
      });
      newNucleonNumberDisplay.right = panelContents.right;
      panelContents.addChild(newNucleonNumberDisplay);
      const oldNucleonCountProperty = new NumberProperty(nucleonCountProperty.value);

      // shows the old value of nucleonCountProperty
      const oldNucleonNumberDisplay = new NumberDisplay(oldNucleonCountProperty, nucleonCountRange, {
        align: 'right',
        textOptions: {
          font: LABEL_FONT
        },
        backgroundFill: null,
        backgroundStroke: null
      });
      oldNucleonNumberDisplay.right = panelContents.right;
      panelContents.addChild(oldNucleonNumberDisplay);

      // start removing oldNucleonCountDisplay by making it more opaque
      const startRemovingNucleonCountDisplay = new Animation({
        to: 0.33,
        property: oldNucleonNumberDisplay.opacityProperty,
        duration: 0.1,
        // seconds
        easing: Easing.LINEAR
      });

      // 'replace' the oldNucleonNumberDisplay with the newNucleonNumberDisplay
      const addNucleonCountDisplay = new Animation({
        targets: [{
          to: 1,
          property: newNucleonNumberDisplay.opacityProperty
        }, {
          to: 0,
          property: oldNucleonNumberDisplay.opacityProperty
        }],
        duration: 0.1,
        easing: Easing.LINEAR
      });

      // start showing the newNucleonNumberDisplay when the oldNucleonNumberDisplay has started becoming opaque
      startRemovingNucleonCountDisplay.then(addNucleonCountDisplay);
      nucleonCountProperty.link(() => {
        startRemovingNucleonCountDisplay.start();

        // at the end of both animations, reset the values and opacities of oldNucleonNumberDisplay and newNucleonNumberDisplay
        addNucleonCountDisplay.finishEmitter.addListener(() => {
          oldNucleonCountProperty.value = nucleonCountProperty.value;
          oldNucleonNumberDisplay.opacity = 1;
          newNucleonNumberDisplay.opacity = 0;
        });
      });
      return {
        particleNode: nucleonParticleNode,
        numberDisplays: [oldNucleonNumberDisplay, newNucleonNumberDisplay],
        contents: nucleonContents
      };
    };

    // create the nucleon labels
    const protonLabel = nucleonLabel(BuildANucleusStrings.protonsColon, ParticleType.PROTON, protonCountProperty, protonCountRange);
    const neutronLabel = nucleonLabel(BuildANucleusStrings.neutronsColon, ParticleType.NEUTRON, neutronCountProperty, neutronCountRange);

    // position the protonLabel at the top and the neutronLabel at the bottom, and align their respective numberDisplay's
    protonLabel.contents.top = 0;
    protonLabel.numberDisplays.forEach(numberDisplay => {
      numberDisplay.centerY = protonLabel.contents.centerY;
    });
    neutronLabel.contents.bottom = protonLabel.particleNode.bottom + Math.max(neutronLabel.particleNode.height, MIN_VERTICAL_SPACING);
    neutronLabel.numberDisplays.forEach(numberDisplay => {
      numberDisplay.centerY = neutronLabel.contents.centerY;
    });
    super(panelContents, options);
  }
}
buildANucleus.register('NucleonCountPanel', NucleonCountPanel);
export default NucleonCountPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQYW5lbCIsImJ1aWxkQU51Y2xldXMiLCJCQU5Db2xvcnMiLCJIQm94IiwiUmVjdGFuZ2xlIiwiVGV4dCIsIlBoZXRGb250IiwiUGFydGljbGVOb2RlIiwiQnVpbGRBTnVjbGV1c1N0cmluZ3MiLCJOdW1iZXJEaXNwbGF5IiwiUGFydGljbGVUeXBlIiwiQkFOQ29uc3RhbnRzIiwiQW5pbWF0aW9uIiwiRWFzaW5nIiwiTnVtYmVyUHJvcGVydHkiLCJMQUJFTF9GT05UIiwiQlVUVE9OU19BTkRfTEVHRU5EX0ZPTlRfU0laRSIsIk1BWF9USVRMRV9XSURUSCIsIk1JTl9WRVJUSUNBTF9TUEFDSU5HIiwiTlVDTEVPTl9QQVJUSUNMRV9SQURJVVMiLCJQQVJUSUNMRV9SQURJVVMiLCJOdWNsZW9uQ291bnRQYW5lbCIsImNvbnN0cnVjdG9yIiwicHJvdG9uQ291bnRQcm9wZXJ0eSIsInByb3RvbkNvdW50UmFuZ2UiLCJuZXV0cm9uQ291bnRQcm9wZXJ0eSIsIm5ldXRyb25Db3VudFJhbmdlIiwib3B0aW9ucyIsImZpbGwiLCJwYW5lbEJhY2tncm91bmRDb2xvclByb3BlcnR5IiwieE1hcmdpbiIsInN0cm9rZSIsIlBBTkVMX1NUUk9LRSIsImNvcm5lclJhZGl1cyIsIlBBTkVMX0NPUk5FUl9SQURJVVMiLCJwYW5lbENvbnRlbnRzIiwibnVjbGVvbkxhYmVsIiwibnVjbGVvblN0cmluZyIsIm51Y2xlb25UeXBlIiwibnVjbGVvbkNvdW50UHJvcGVydHkiLCJudWNsZW9uQ291bnRSYW5nZSIsIm51Y2xlb25UaXRsZSIsImZvbnQiLCJtYXhXaWR0aCIsIm51Y2xlb25QYXJ0aWNsZU5vZGUiLCJuYW1lIiwidG9Mb3dlckNhc2UiLCJudWNsZW9uQ29udGVudHMiLCJzcGFjaW5nIiwiY2hpbGRyZW4iLCJsZWZ0IiwicmlnaHQiLCJ3aWR0aCIsInRvcCIsImNlbnRlclkiLCJhZGRDaGlsZCIsIm5ld051Y2xlb25OdW1iZXJEaXNwbGF5IiwiYWxpZ24iLCJ0ZXh0T3B0aW9ucyIsImJhY2tncm91bmRGaWxsIiwiYmFja2dyb3VuZFN0cm9rZSIsIm9sZE51Y2xlb25Db3VudFByb3BlcnR5IiwidmFsdWUiLCJvbGROdWNsZW9uTnVtYmVyRGlzcGxheSIsInN0YXJ0UmVtb3ZpbmdOdWNsZW9uQ291bnREaXNwbGF5IiwidG8iLCJwcm9wZXJ0eSIsIm9wYWNpdHlQcm9wZXJ0eSIsImR1cmF0aW9uIiwiZWFzaW5nIiwiTElORUFSIiwiYWRkTnVjbGVvbkNvdW50RGlzcGxheSIsInRhcmdldHMiLCJ0aGVuIiwibGluayIsInN0YXJ0IiwiZmluaXNoRW1pdHRlciIsImFkZExpc3RlbmVyIiwib3BhY2l0eSIsInBhcnRpY2xlTm9kZSIsIm51bWJlckRpc3BsYXlzIiwiY29udGVudHMiLCJwcm90b25MYWJlbCIsInByb3RvbnNDb2xvbiIsIlBST1RPTiIsIm5ldXRyb25MYWJlbCIsIm5ldXRyb25zQ29sb24iLCJORVVUUk9OIiwiZm9yRWFjaCIsIm51bWJlckRpc3BsYXkiLCJib3R0b20iLCJNYXRoIiwibWF4IiwiaGVpZ2h0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJOdWNsZW9uQ291bnRQYW5lbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBub2RlIHRoYXQgcHJlc2VudHMgYSByZWFkb3V0IG9mIHRoZSBudW1iZXIgb2YgcHJvdG9ucyBhbmQgbmV1dHJvbnMuXHJcbiAqXHJcbiAqIEBhdXRob3IgTHVpc2EgVmFyZ2FzXHJcbiAqL1xyXG5cclxuaW1wb3J0IFBhbmVsIGZyb20gJy4uLy4uLy4uLy4uL3N1bi9qcy9QYW5lbC5qcyc7XHJcbmltcG9ydCBidWlsZEFOdWNsZXVzIGZyb20gJy4uLy4uL2J1aWxkQU51Y2xldXMuanMnO1xyXG5pbXBvcnQgQkFOQ29sb3JzIGZyb20gJy4uL0JBTkNvbG9ycy5qcyc7XHJcbmltcG9ydCB7IEhCb3gsIFJlY3RhbmdsZSwgVGV4dCB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBQaGV0Rm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvUGhldEZvbnQuanMnO1xyXG5pbXBvcnQgUGFydGljbGVOb2RlIGZyb20gJy4uLy4uLy4uLy4uL3NocmVkL2pzL3ZpZXcvUGFydGljbGVOb2RlLmpzJztcclxuaW1wb3J0IEJ1aWxkQU51Y2xldXNTdHJpbmdzIGZyb20gJy4uLy4uL0J1aWxkQU51Y2xldXNTdHJpbmdzLmpzJztcclxuaW1wb3J0IE51bWJlckRpc3BsYXkgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL051bWJlckRpc3BsYXkuanMnO1xyXG5pbXBvcnQgUGFydGljbGVUeXBlIGZyb20gJy4vUGFydGljbGVUeXBlLmpzJztcclxuaW1wb3J0IEJBTkNvbnN0YW50cyBmcm9tICcuLi9CQU5Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgVFJlYWRPbmx5UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9UUmVhZE9ubHlQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgQW5pbWF0aW9uIGZyb20gJy4uLy4uLy4uLy4uL3R3aXh0L2pzL0FuaW1hdGlvbi5qcyc7XHJcbmltcG9ydCBFYXNpbmcgZnJvbSAnLi4vLi4vLi4vLi4vdHdpeHQvanMvRWFzaW5nLmpzJztcclxuaW1wb3J0IE51bWJlclByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvTnVtYmVyUHJvcGVydHkuanMnO1xyXG5cclxuLy8gdHlwZXNcclxudHlwZSBOdWNsZW9uTGFiZWwgPSB7XHJcbiAgcGFydGljbGVOb2RlOiBQYXJ0aWNsZU5vZGU7XHJcbiAgbnVtYmVyRGlzcGxheXM6IE51bWJlckRpc3BsYXlbXTtcclxuICBjb250ZW50czogSEJveDtcclxufTtcclxuXHJcbi8vIGNvbnN0YW50cywgZW1waXJpY2FsbHkgZGV0ZXJtaW5lZFxyXG5jb25zdCBMQUJFTF9GT05UID0gbmV3IFBoZXRGb250KCBCQU5Db25zdGFudHMuQlVUVE9OU19BTkRfTEVHRU5EX0ZPTlRfU0laRSApO1xyXG5jb25zdCBNQVhfVElUTEVfV0lEVEggPSA5MDtcclxuY29uc3QgTUlOX1ZFUlRJQ0FMX1NQQUNJTkcgPSAyNTtcclxuY29uc3QgTlVDTEVPTl9QQVJUSUNMRV9SQURJVVMgPSBCQU5Db25zdGFudHMuUEFSVElDTEVfUkFESVVTICogMC43O1xyXG5cclxuY2xhc3MgTnVjbGVvbkNvdW50UGFuZWwgZXh0ZW5kcyBQYW5lbCB7XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggcHJvdG9uQ291bnRQcm9wZXJ0eTogVFJlYWRPbmx5UHJvcGVydHk8bnVtYmVyPiwgcHJvdG9uQ291bnRSYW5nZTogUmFuZ2UsXHJcbiAgICAgICAgICAgICAgIG5ldXRyb25Db3VudFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxudW1iZXI+LCBuZXV0cm9uQ291bnRSYW5nZTogUmFuZ2UgKSB7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuXHJcbiAgICAgIC8vIG9wdGlvbnMgZm9yIHRoZSBwYW5lbFxyXG4gICAgICBmaWxsOiBCQU5Db2xvcnMucGFuZWxCYWNrZ3JvdW5kQ29sb3JQcm9wZXJ0eSxcclxuICAgICAgeE1hcmdpbjogMTAsXHJcbiAgICAgIHN0cm9rZTogQkFOQ29uc3RhbnRzLlBBTkVMX1NUUk9LRSxcclxuICAgICAgY29ybmVyUmFkaXVzOiBCQU5Db25zdGFudHMuUEFORUxfQ09STkVSX1JBRElVU1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBwYW5lbENvbnRlbnRzID0gbmV3IFJlY3RhbmdsZSggMCwgMCwgMTQwLCA0MCApOyAvLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkXHJcblxyXG4gICAgLy8gZnVuY3Rpb24gdG8gY3JlYXRlIHRoZSBudWNsZW9uIGxhYmVscyBhbmQgYWRkIHRoZW0gdG8gcGFuZWxDb250ZW50c1xyXG4gICAgY29uc3QgbnVjbGVvbkxhYmVsID0gKCBudWNsZW9uU3RyaW5nOiBzdHJpbmcsIG51Y2xlb25UeXBlOiBQYXJ0aWNsZVR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG51Y2xlb25Db3VudFByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxudW1iZXI+LCBudWNsZW9uQ291bnRSYW5nZTogUmFuZ2UgKTogTnVjbGVvbkxhYmVsID0+IHtcclxuXHJcbiAgICAgIGNvbnN0IG51Y2xlb25UaXRsZSA9IG5ldyBUZXh0KCBudWNsZW9uU3RyaW5nLCB7IGZvbnQ6IExBQkVMX0ZPTlQsIG1heFdpZHRoOiBNQVhfVElUTEVfV0lEVEggfSApO1xyXG4gICAgICBjb25zdCBudWNsZW9uUGFydGljbGVOb2RlID0gbmV3IFBhcnRpY2xlTm9kZSggbnVjbGVvblR5cGUubmFtZS50b0xvd2VyQ2FzZSgpLCBOVUNMRU9OX1BBUlRJQ0xFX1JBRElVUyApO1xyXG4gICAgICBjb25zdCBudWNsZW9uQ29udGVudHMgPSBuZXcgSEJveCggeyBzcGFjaW5nOiA1LCBjaGlsZHJlbjogWyBudWNsZW9uUGFydGljbGVOb2RlLCBudWNsZW9uVGl0bGUgXSB9ICk7XHJcbiAgICAgIG51Y2xlb25UaXRsZS5sZWZ0ID0gbnVjbGVvblBhcnRpY2xlTm9kZS5yaWdodCArIG51Y2xlb25QYXJ0aWNsZU5vZGUud2lkdGggLyAyO1xyXG4gICAgICBudWNsZW9uVGl0bGUudG9wID0gbnVjbGVvbkNvbnRlbnRzLnRvcDtcclxuICAgICAgbnVjbGVvblBhcnRpY2xlTm9kZS5jZW50ZXJZID0gbnVjbGVvblRpdGxlLmNlbnRlclk7XHJcbiAgICAgIHBhbmVsQ29udGVudHMuYWRkQ2hpbGQoIG51Y2xlb25Db250ZW50cyApO1xyXG5cclxuICAgICAgLy8gc2hvd3MgdGhlIG5ldyB2YWx1ZSBvZiBudWNsZW9uQ291bnRQcm9wZXJ0eVxyXG4gICAgICBjb25zdCBuZXdOdWNsZW9uTnVtYmVyRGlzcGxheSA9IG5ldyBOdW1iZXJEaXNwbGF5KCBudWNsZW9uQ291bnRQcm9wZXJ0eSwgbnVjbGVvbkNvdW50UmFuZ2UsIHtcclxuICAgICAgICBhbGlnbjogJ3JpZ2h0JyxcclxuICAgICAgICB0ZXh0T3B0aW9uczoge1xyXG4gICAgICAgICAgZm9udDogTEFCRUxfRk9OVFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYmFja2dyb3VuZEZpbGw6IG51bGwsXHJcbiAgICAgICAgYmFja2dyb3VuZFN0cm9rZTogbnVsbFxyXG4gICAgICB9ICk7XHJcbiAgICAgIG5ld051Y2xlb25OdW1iZXJEaXNwbGF5LnJpZ2h0ID0gcGFuZWxDb250ZW50cy5yaWdodDtcclxuICAgICAgcGFuZWxDb250ZW50cy5hZGRDaGlsZCggbmV3TnVjbGVvbk51bWJlckRpc3BsYXkgKTtcclxuXHJcbiAgICAgIGNvbnN0IG9sZE51Y2xlb25Db3VudFByb3BlcnR5ID0gbmV3IE51bWJlclByb3BlcnR5KCBudWNsZW9uQ291bnRQcm9wZXJ0eS52YWx1ZSApO1xyXG5cclxuICAgICAgLy8gc2hvd3MgdGhlIG9sZCB2YWx1ZSBvZiBudWNsZW9uQ291bnRQcm9wZXJ0eVxyXG4gICAgICBjb25zdCBvbGROdWNsZW9uTnVtYmVyRGlzcGxheSA9IG5ldyBOdW1iZXJEaXNwbGF5KCBvbGROdWNsZW9uQ291bnRQcm9wZXJ0eSwgbnVjbGVvbkNvdW50UmFuZ2UsIHtcclxuICAgICAgICBhbGlnbjogJ3JpZ2h0JyxcclxuICAgICAgICB0ZXh0T3B0aW9uczoge1xyXG4gICAgICAgICAgZm9udDogTEFCRUxfRk9OVFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYmFja2dyb3VuZEZpbGw6IG51bGwsXHJcbiAgICAgICAgYmFja2dyb3VuZFN0cm9rZTogbnVsbFxyXG4gICAgICB9ICk7XHJcbiAgICAgIG9sZE51Y2xlb25OdW1iZXJEaXNwbGF5LnJpZ2h0ID0gcGFuZWxDb250ZW50cy5yaWdodDtcclxuICAgICAgcGFuZWxDb250ZW50cy5hZGRDaGlsZCggb2xkTnVjbGVvbk51bWJlckRpc3BsYXkgKTtcclxuXHJcbiAgICAgIC8vIHN0YXJ0IHJlbW92aW5nIG9sZE51Y2xlb25Db3VudERpc3BsYXkgYnkgbWFraW5nIGl0IG1vcmUgb3BhcXVlXHJcbiAgICAgIGNvbnN0IHN0YXJ0UmVtb3ZpbmdOdWNsZW9uQ291bnREaXNwbGF5ID0gbmV3IEFuaW1hdGlvbigge1xyXG4gICAgICAgIHRvOiAwLjMzLFxyXG4gICAgICAgIHByb3BlcnR5OiBvbGROdWNsZW9uTnVtYmVyRGlzcGxheS5vcGFjaXR5UHJvcGVydHksXHJcbiAgICAgICAgZHVyYXRpb246IDAuMSwgLy8gc2Vjb25kc1xyXG4gICAgICAgIGVhc2luZzogRWFzaW5nLkxJTkVBUlxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyAncmVwbGFjZScgdGhlIG9sZE51Y2xlb25OdW1iZXJEaXNwbGF5IHdpdGggdGhlIG5ld051Y2xlb25OdW1iZXJEaXNwbGF5XHJcbiAgICAgIGNvbnN0IGFkZE51Y2xlb25Db3VudERpc3BsYXkgPSBuZXcgQW5pbWF0aW9uKCB7XHJcbiAgICAgICAgdGFyZ2V0czogWyB7XHJcbiAgICAgICAgICB0bzogMSxcclxuICAgICAgICAgIHByb3BlcnR5OiBuZXdOdWNsZW9uTnVtYmVyRGlzcGxheS5vcGFjaXR5UHJvcGVydHlcclxuICAgICAgICB9LCB7XHJcbiAgICAgICAgICB0bzogMCxcclxuICAgICAgICAgIHByb3BlcnR5OiBvbGROdWNsZW9uTnVtYmVyRGlzcGxheS5vcGFjaXR5UHJvcGVydHlcclxuICAgICAgICB9XHJcbiAgICAgICAgXSxcclxuICAgICAgICBkdXJhdGlvbjogMC4xLFxyXG4gICAgICAgIGVhc2luZzogRWFzaW5nLkxJTkVBUlxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyBzdGFydCBzaG93aW5nIHRoZSBuZXdOdWNsZW9uTnVtYmVyRGlzcGxheSB3aGVuIHRoZSBvbGROdWNsZW9uTnVtYmVyRGlzcGxheSBoYXMgc3RhcnRlZCBiZWNvbWluZyBvcGFxdWVcclxuICAgICAgc3RhcnRSZW1vdmluZ051Y2xlb25Db3VudERpc3BsYXkudGhlbiggYWRkTnVjbGVvbkNvdW50RGlzcGxheSApO1xyXG5cclxuICAgICAgbnVjbGVvbkNvdW50UHJvcGVydHkubGluayggKCkgPT4ge1xyXG4gICAgICAgIHN0YXJ0UmVtb3ZpbmdOdWNsZW9uQ291bnREaXNwbGF5LnN0YXJ0KCk7XHJcblxyXG4gICAgICAgIC8vIGF0IHRoZSBlbmQgb2YgYm90aCBhbmltYXRpb25zLCByZXNldCB0aGUgdmFsdWVzIGFuZCBvcGFjaXRpZXMgb2Ygb2xkTnVjbGVvbk51bWJlckRpc3BsYXkgYW5kIG5ld051Y2xlb25OdW1iZXJEaXNwbGF5XHJcbiAgICAgICAgYWRkTnVjbGVvbkNvdW50RGlzcGxheS5maW5pc2hFbWl0dGVyLmFkZExpc3RlbmVyKCAoKSA9PiB7XHJcbiAgICAgICAgICBvbGROdWNsZW9uQ291bnRQcm9wZXJ0eS52YWx1ZSA9IG51Y2xlb25Db3VudFByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgICAgb2xkTnVjbGVvbk51bWJlckRpc3BsYXkub3BhY2l0eSA9IDE7XHJcbiAgICAgICAgICBuZXdOdWNsZW9uTnVtYmVyRGlzcGxheS5vcGFjaXR5ID0gMDtcclxuICAgICAgICB9ICk7XHJcblxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBhcnRpY2xlTm9kZTogbnVjbGVvblBhcnRpY2xlTm9kZSxcclxuICAgICAgICBudW1iZXJEaXNwbGF5czogWyBvbGROdWNsZW9uTnVtYmVyRGlzcGxheSwgbmV3TnVjbGVvbk51bWJlckRpc3BsYXkgXSxcclxuICAgICAgICBjb250ZW50czogbnVjbGVvbkNvbnRlbnRzXHJcbiAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGNyZWF0ZSB0aGUgbnVjbGVvbiBsYWJlbHNcclxuICAgIGNvbnN0IHByb3RvbkxhYmVsID0gbnVjbGVvbkxhYmVsKCBCdWlsZEFOdWNsZXVzU3RyaW5ncy5wcm90b25zQ29sb24sIFBhcnRpY2xlVHlwZS5QUk9UT04sIHByb3RvbkNvdW50UHJvcGVydHksXHJcbiAgICAgIHByb3RvbkNvdW50UmFuZ2UgKTtcclxuICAgIGNvbnN0IG5ldXRyb25MYWJlbCA9IG51Y2xlb25MYWJlbCggQnVpbGRBTnVjbGV1c1N0cmluZ3MubmV1dHJvbnNDb2xvbiwgUGFydGljbGVUeXBlLk5FVVRST04sIG5ldXRyb25Db3VudFByb3BlcnR5LFxyXG4gICAgICBuZXV0cm9uQ291bnRSYW5nZSApO1xyXG5cclxuICAgIC8vIHBvc2l0aW9uIHRoZSBwcm90b25MYWJlbCBhdCB0aGUgdG9wIGFuZCB0aGUgbmV1dHJvbkxhYmVsIGF0IHRoZSBib3R0b20sIGFuZCBhbGlnbiB0aGVpciByZXNwZWN0aXZlIG51bWJlckRpc3BsYXknc1xyXG4gICAgcHJvdG9uTGFiZWwuY29udGVudHMudG9wID0gMDtcclxuICAgIHByb3RvbkxhYmVsLm51bWJlckRpc3BsYXlzLmZvckVhY2goIG51bWJlckRpc3BsYXkgPT4ge1xyXG4gICAgICBudW1iZXJEaXNwbGF5LmNlbnRlclkgPSBwcm90b25MYWJlbC5jb250ZW50cy5jZW50ZXJZO1xyXG4gICAgfSApO1xyXG4gICAgbmV1dHJvbkxhYmVsLmNvbnRlbnRzLmJvdHRvbSA9IHByb3RvbkxhYmVsLnBhcnRpY2xlTm9kZS5ib3R0b20gKyBNYXRoLm1heCggbmV1dHJvbkxhYmVsLnBhcnRpY2xlTm9kZS5oZWlnaHQsIE1JTl9WRVJUSUNBTF9TUEFDSU5HICk7XHJcbiAgICBuZXV0cm9uTGFiZWwubnVtYmVyRGlzcGxheXMuZm9yRWFjaCggbnVtYmVyRGlzcGxheSA9PiB7XHJcbiAgICAgIG51bWJlckRpc3BsYXkuY2VudGVyWSA9IG5ldXRyb25MYWJlbC5jb250ZW50cy5jZW50ZXJZO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHN1cGVyKCBwYW5lbENvbnRlbnRzLCBvcHRpb25zICk7XHJcbiAgfVxyXG59XHJcblxyXG5idWlsZEFOdWNsZXVzLnJlZ2lzdGVyKCAnTnVjbGVvbkNvdW50UGFuZWwnLCBOdWNsZW9uQ291bnRQYW5lbCApO1xyXG5leHBvcnQgZGVmYXVsdCBOdWNsZW9uQ291bnRQYW5lbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxhQUFhLE1BQU0sd0JBQXdCO0FBQ2xELE9BQU9DLFNBQVMsTUFBTSxpQkFBaUI7QUFDdkMsU0FBU0MsSUFBSSxFQUFFQyxTQUFTLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDekUsT0FBT0MsUUFBUSxNQUFNLHlDQUF5QztBQUM5RCxPQUFPQyxZQUFZLE1BQU0sMkNBQTJDO0FBQ3BFLE9BQU9DLG9CQUFvQixNQUFNLCtCQUErQjtBQUNoRSxPQUFPQyxhQUFhLE1BQU0sOENBQThDO0FBQ3hFLE9BQU9DLFlBQVksTUFBTSxtQkFBbUI7QUFDNUMsT0FBT0MsWUFBWSxNQUFNLG9CQUFvQjtBQUc3QyxPQUFPQyxTQUFTLE1BQU0sbUNBQW1DO0FBQ3pELE9BQU9DLE1BQU0sTUFBTSxnQ0FBZ0M7QUFDbkQsT0FBT0MsY0FBYyxNQUFNLHVDQUF1Qzs7QUFFbEU7O0FBT0E7QUFDQSxNQUFNQyxVQUFVLEdBQUcsSUFBSVQsUUFBUSxDQUFFSyxZQUFZLENBQUNLLDRCQUE2QixDQUFDO0FBQzVFLE1BQU1DLGVBQWUsR0FBRyxFQUFFO0FBQzFCLE1BQU1DLG9CQUFvQixHQUFHLEVBQUU7QUFDL0IsTUFBTUMsdUJBQXVCLEdBQUdSLFlBQVksQ0FBQ1MsZUFBZSxHQUFHLEdBQUc7QUFFbEUsTUFBTUMsaUJBQWlCLFNBQVNyQixLQUFLLENBQUM7RUFFN0JzQixXQUFXQSxDQUFFQyxtQkFBOEMsRUFBRUMsZ0JBQXVCLEVBQzlFQyxvQkFBK0MsRUFBRUMsaUJBQXdCLEVBQUc7SUFFdkYsTUFBTUMsT0FBTyxHQUFHO01BRWQ7TUFDQUMsSUFBSSxFQUFFMUIsU0FBUyxDQUFDMkIsNEJBQTRCO01B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