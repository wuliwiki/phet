// Copyright 2013-2022, University of Colorado Boulder

/**
 * LU decomposition, based on Jama (http://math.nist.gov/javanumerics/jama/).  Please note the arbitrary-precision
 * copy LUDecompositionDecimal which should be maintained with this file.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import dot from './dot.js';
import Matrix from './Matrix.js';
const ArrayType = window.Float64Array || Array;
class LUDecomposition {
  constructor(matrix) {
    let i;
    let j;
    let k;
    this.matrix = matrix;

    // TODO: size!
    this.LU = matrix.getArrayCopy();
    const LU = this.LU;
    this.m = matrix.getRowDimension();
    const m = this.m;
    this.n = matrix.getColumnDimension();
    const n = this.n;
    this.piv = new Uint32Array(m);
    for (i = 0; i < m; i++) {
      this.piv[i] = i;
    }
    this.pivsign = 1;
    const LUcolj = new ArrayType(m);

    // Outer loop.

    for (j = 0; j < n; j++) {
      // Make a copy of the j-th column to localize references.
      for (i = 0; i < m; i++) {
        LUcolj[i] = LU[matrix.index(i, j)];
      }

      // Apply previous transformations.

      for (i = 0; i < m; i++) {
        // Most of the time is spent in the following dot product.
        const kmax = Math.min(i, j);
        let s = 0.0;
        for (k = 0; k < kmax; k++) {
          const ik = matrix.index(i, k);
          s += LU[ik] * LUcolj[k];
        }
        LUcolj[i] -= s;
        LU[matrix.index(i, j)] = LUcolj[i];
      }

      // Find pivot and exchange if necessary.

      let p = j;
      for (i = j + 1; i < m; i++) {
        if (Math.abs(LUcolj[i]) > Math.abs(LUcolj[p])) {
          p = i;
        }
      }
      if (p !== j) {
        for (k = 0; k < n; k++) {
          const pk = matrix.index(p, k);
          const jk = matrix.index(j, k);
          const t = LU[pk];
          LU[pk] = LU[jk];
          LU[jk] = t;
        }
        k = this.piv[p];
        this.piv[p] = this.piv[j];
        this.piv[j] = k;
        this.pivsign = -this.pivsign;
      }

      // Compute multipliers.

      if (j < m && LU[this.matrix.index(j, j)] !== 0.0) {
        for (i = j + 1; i < m; i++) {
          LU[matrix.index(i, j)] /= LU[matrix.index(j, j)];
        }
      }
    }
  }

  /**
   * @public
   *
   * @returns {boolean}
   */
  isNonsingular() {
    for (let j = 0; j < this.n; j++) {
      const index = this.matrix.index(j, j);
      if (this.LU[index] === 0) {
        return false;
      }
    }
    return true;
  }

  /**
   * @public
   *
   * @returns {Matrix}
   */
  getL() {
    const result = new Matrix(this.m, this.n);
    for (let i = 0; i < this.m; i++) {
      for (let j = 0; j < this.n; j++) {
        if (i > j) {
          result.entries[result.index(i, j)] = this.LU[this.matrix.index(i, j)];
        } else if (i === j) {
          result.entries[result.index(i, j)] = 1.0;
        } else {
          result.entries[result.index(i, j)] = 0.0;
        }
      }
    }
    return result;
  }

  /**
   * @public
   *
   * @returns {Matrix}
   */
  getU() {
    const result = new Matrix(this.n, this.n);
    for (let i = 0; i < this.n; i++) {
      for (let j = 0; j < this.n; j++) {
        if (i <= j) {
          result.entries[result.index(i, j)] = this.LU[this.matrix.index(i, j)];
        } else {
          result.entries[result.index(i, j)] = 0.0;
        }
      }
    }
    return result;
  }

  /**
   * @public
   *
   * @returns {Uint32Array}
   */
  getPivot() {
    const p = new Uint32Array(this.m);
    for (let i = 0; i < this.m; i++) {
      p[i] = this.piv[i];
    }
    return p;
  }

  /**
   * @public
   *
   * @returns {Float64Array}
   */
  getDoublePivot() {
    const vals = new ArrayType(this.m);
    for (let i = 0; i < this.m; i++) {
      vals[i] = this.piv[i];
    }
    return vals;
  }

  /**
   * @public
   *
   * @returns {number}
   */
  det() {
    if (this.m !== this.n) {
      throw new Error('Matrix must be square.');
    }
    let d = this.pivsign;
    for (let j = 0; j < this.n; j++) {
      d *= this.LU[this.matrix.index(j, j)];
    }
    return d;
  }

  /**
   * @public
   *
   * @param {Matrix} matrix
   * @returns {Matrix}
   */
  solve(matrix) {
    let i;
    let j;
    let k;
    if (matrix.getRowDimension() !== this.m) {
      throw new Error('Matrix row dimensions must agree.');
    }
    if (!this.isNonsingular()) {
      throw new Error('Matrix is singular.');
    }

    // Copy right hand side with pivoting
    const nx = matrix.getColumnDimension();
    const Xmat = matrix.getArrayRowMatrix(this.piv, 0, nx - 1);

    // Solve L*Y = B(piv,:)
    for (k = 0; k < this.n; k++) {
      for (i = k + 1; i < this.n; i++) {
        for (j = 0; j < nx; j++) {
          Xmat.entries[Xmat.index(i, j)] -= Xmat.entries[Xmat.index(k, j)] * this.LU[this.matrix.index(i, k)];
        }
      }
    }

    // Solve U*X = Y;
    for (k = this.n - 1; k >= 0; k--) {
      for (j = 0; j < nx; j++) {
        Xmat.entries[Xmat.index(k, j)] /= this.LU[this.matrix.index(k, k)];
      }
      for (i = 0; i < k; i++) {
        for (j = 0; j < nx; j++) {
          Xmat.entries[Xmat.index(i, j)] -= Xmat.entries[Xmat.index(k, j)] * this.LU[this.matrix.index(i, k)];
        }
      }
    }
    return Xmat;
  }
}
dot.register('LUDecomposition', LUDecomposition);
export default LUDecomposition;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkb3QiLCJNYXRyaXgiLCJBcnJheVR5cGUiLCJ3aW5kb3ciLCJGbG9hdDY0QXJyYXkiLCJBcnJheSIsIkxVRGVjb21wb3NpdGlvbiIsImNvbnN0cnVjdG9yIiwibWF0cml4IiwiaSIsImoiLCJrIiwiTFUiLCJnZXRBcnJheUNvcHkiLCJtIiwiZ2V0Um93RGltZW5zaW9uIiwibiIsImdldENvbHVtbkRpbWVuc2lvbiIsInBpdiIsIlVpbnQzMkFycmF5IiwicGl2c2lnbiIsIkxVY29saiIsImluZGV4Iiwia21heCIsIk1hdGgiLCJtaW4iLCJzIiwiaWsiLCJwIiwiYWJzIiwicGsiLCJqayIsInQiLCJpc05vbnNpbmd1bGFyIiwiZ2V0TCIsInJlc3VsdCIsImVudHJpZXMiLCJnZXRVIiwiZ2V0UGl2b3QiLCJnZXREb3VibGVQaXZvdCIsInZhbHMiLCJkZXQiLCJFcnJvciIsImQiLCJzb2x2ZSIsIm54IiwiWG1hdCIsImdldEFycmF5Um93TWF0cml4IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJMVURlY29tcG9zaXRpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTMtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogTFUgZGVjb21wb3NpdGlvbiwgYmFzZWQgb24gSmFtYSAoaHR0cDovL21hdGgubmlzdC5nb3YvamF2YW51bWVyaWNzL2phbWEvKS4gIFBsZWFzZSBub3RlIHRoZSBhcmJpdHJhcnktcHJlY2lzaW9uXHJcbiAqIGNvcHkgTFVEZWNvbXBvc2l0aW9uRGVjaW1hbCB3aGljaCBzaG91bGQgYmUgbWFpbnRhaW5lZCB3aXRoIHRoaXMgZmlsZS5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBkb3QgZnJvbSAnLi9kb3QuanMnO1xyXG5pbXBvcnQgTWF0cml4IGZyb20gJy4vTWF0cml4LmpzJztcclxuXHJcbmNvbnN0IEFycmF5VHlwZSA9IHdpbmRvdy5GbG9hdDY0QXJyYXkgfHwgQXJyYXk7XHJcblxyXG5jbGFzcyBMVURlY29tcG9zaXRpb24ge1xyXG4gIGNvbnN0cnVjdG9yKCBtYXRyaXggKSB7XHJcbiAgICBsZXQgaTtcclxuICAgIGxldCBqO1xyXG4gICAgbGV0IGs7XHJcblxyXG4gICAgdGhpcy5tYXRyaXggPSBtYXRyaXg7XHJcblxyXG4gICAgLy8gVE9ETzogc2l6ZSFcclxuICAgIHRoaXMuTFUgPSBtYXRyaXguZ2V0QXJyYXlDb3B5KCk7XHJcbiAgICBjb25zdCBMVSA9IHRoaXMuTFU7XHJcbiAgICB0aGlzLm0gPSBtYXRyaXguZ2V0Um93RGltZW5zaW9uKCk7XHJcbiAgICBjb25zdCBtID0gdGhpcy5tO1xyXG4gICAgdGhpcy5uID0gbWF0cml4LmdldENvbHVtbkRpbWVuc2lvbigpO1xyXG4gICAgY29uc3QgbiA9IHRoaXMubjtcclxuICAgIHRoaXMucGl2ID0gbmV3IFVpbnQzMkFycmF5KCBtICk7XHJcbiAgICBmb3IgKCBpID0gMDsgaSA8IG07IGkrKyApIHtcclxuICAgICAgdGhpcy5waXZbIGkgXSA9IGk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnBpdnNpZ24gPSAxO1xyXG4gICAgY29uc3QgTFVjb2xqID0gbmV3IEFycmF5VHlwZSggbSApO1xyXG5cclxuICAgIC8vIE91dGVyIGxvb3AuXHJcblxyXG4gICAgZm9yICggaiA9IDA7IGogPCBuOyBqKysgKSB7XHJcblxyXG4gICAgICAvLyBNYWtlIGEgY29weSBvZiB0aGUgai10aCBjb2x1bW4gdG8gbG9jYWxpemUgcmVmZXJlbmNlcy5cclxuICAgICAgZm9yICggaSA9IDA7IGkgPCBtOyBpKysgKSB7XHJcbiAgICAgICAgTFVjb2xqWyBpIF0gPSBMVVsgbWF0cml4LmluZGV4KCBpLCBqICkgXTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQXBwbHkgcHJldmlvdXMgdHJhbnNmb3JtYXRpb25zLlxyXG5cclxuICAgICAgZm9yICggaSA9IDA7IGkgPCBtOyBpKysgKSB7XHJcbiAgICAgICAgLy8gTW9zdCBvZiB0aGUgdGltZSBpcyBzcGVudCBpbiB0aGUgZm9sbG93aW5nIGRvdCBwcm9kdWN0LlxyXG4gICAgICAgIGNvbnN0IGttYXggPSBNYXRoLm1pbiggaSwgaiApO1xyXG4gICAgICAgIGxldCBzID0gMC4wO1xyXG4gICAgICAgIGZvciAoIGsgPSAwOyBrIDwga21heDsgaysrICkge1xyXG4gICAgICAgICAgY29uc3QgaWsgPSBtYXRyaXguaW5kZXgoIGksIGsgKTtcclxuICAgICAgICAgIHMgKz0gTFVbIGlrIF0gKiBMVWNvbGpbIGsgXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIExVY29salsgaSBdIC09IHM7XHJcbiAgICAgICAgTFVbIG1hdHJpeC5pbmRleCggaSwgaiApIF0gPSBMVWNvbGpbIGkgXTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gRmluZCBwaXZvdCBhbmQgZXhjaGFuZ2UgaWYgbmVjZXNzYXJ5LlxyXG5cclxuICAgICAgbGV0IHAgPSBqO1xyXG4gICAgICBmb3IgKCBpID0gaiArIDE7IGkgPCBtOyBpKysgKSB7XHJcbiAgICAgICAgaWYgKCBNYXRoLmFicyggTFVjb2xqWyBpIF0gKSA+IE1hdGguYWJzKCBMVWNvbGpbIHAgXSApICkge1xyXG4gICAgICAgICAgcCA9IGk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmICggcCAhPT0gaiApIHtcclxuICAgICAgICBmb3IgKCBrID0gMDsgayA8IG47IGsrKyApIHtcclxuICAgICAgICAgIGNvbnN0IHBrID0gbWF0cml4LmluZGV4KCBwLCBrICk7XHJcbiAgICAgICAgICBjb25zdCBqayA9IG1hdHJpeC5pbmRleCggaiwgayApO1xyXG4gICAgICAgICAgY29uc3QgdCA9IExVWyBwayBdO1xyXG4gICAgICAgICAgTFVbIHBrIF0gPSBMVVsgamsgXTtcclxuICAgICAgICAgIExVWyBqayBdID0gdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgayA9IHRoaXMucGl2WyBwIF07XHJcbiAgICAgICAgdGhpcy5waXZbIHAgXSA9IHRoaXMucGl2WyBqIF07XHJcbiAgICAgICAgdGhpcy5waXZbIGogXSA9IGs7XHJcbiAgICAgICAgdGhpcy5waXZzaWduID0gLXRoaXMucGl2c2lnbjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQ29tcHV0ZSBtdWx0aXBsaWVycy5cclxuXHJcbiAgICAgIGlmICggaiA8IG0gJiYgTFVbIHRoaXMubWF0cml4LmluZGV4KCBqLCBqICkgXSAhPT0gMC4wICkge1xyXG4gICAgICAgIGZvciAoIGkgPSBqICsgMTsgaSA8IG07IGkrKyApIHtcclxuICAgICAgICAgIExVWyBtYXRyaXguaW5kZXgoIGksIGogKSBdIC89IExVWyBtYXRyaXguaW5kZXgoIGosIGogKSBdO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHJldHVybnMge2Jvb2xlYW59XHJcbiAgICovXHJcbiAgaXNOb25zaW5ndWxhcigpIHtcclxuICAgIGZvciAoIGxldCBqID0gMDsgaiA8IHRoaXMubjsgaisrICkge1xyXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMubWF0cml4LmluZGV4KCBqLCBqICk7XHJcbiAgICAgIGlmICggdGhpcy5MVVsgaW5kZXggXSA9PT0gMCApIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHJldHVybnMge01hdHJpeH1cclxuICAgKi9cclxuICBnZXRMKCkge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IE1hdHJpeCggdGhpcy5tLCB0aGlzLm4gKTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMubTsgaSsrICkge1xyXG4gICAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLm47IGorKyApIHtcclxuICAgICAgICBpZiAoIGkgPiBqICkge1xyXG4gICAgICAgICAgcmVzdWx0LmVudHJpZXNbIHJlc3VsdC5pbmRleCggaSwgaiApIF0gPSB0aGlzLkxVWyB0aGlzLm1hdHJpeC5pbmRleCggaSwgaiApIF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCBpID09PSBqICkge1xyXG4gICAgICAgICAgcmVzdWx0LmVudHJpZXNbIHJlc3VsdC5pbmRleCggaSwgaiApIF0gPSAxLjA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgcmVzdWx0LmVudHJpZXNbIHJlc3VsdC5pbmRleCggaSwgaiApIF0gPSAwLjA7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHJldHVybnMge01hdHJpeH1cclxuICAgKi9cclxuICBnZXRVKCkge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gbmV3IE1hdHJpeCggdGhpcy5uLCB0aGlzLm4gKTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMubjsgaSsrICkge1xyXG4gICAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLm47IGorKyApIHtcclxuICAgICAgICBpZiAoIGkgPD0gaiApIHtcclxuICAgICAgICAgIHJlc3VsdC5lbnRyaWVzWyByZXN1bHQuaW5kZXgoIGksIGogKSBdID0gdGhpcy5MVVsgdGhpcy5tYXRyaXguaW5kZXgoIGksIGogKSBdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIHJlc3VsdC5lbnRyaWVzWyByZXN1bHQuaW5kZXgoIGksIGogKSBdID0gMC4wO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHtVaW50MzJBcnJheX1cclxuICAgKi9cclxuICBnZXRQaXZvdCgpIHtcclxuICAgIGNvbnN0IHAgPSBuZXcgVWludDMyQXJyYXkoIHRoaXMubSApO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy5tOyBpKysgKSB7XHJcbiAgICAgIHBbIGkgXSA9IHRoaXMucGl2WyBpIF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHtGbG9hdDY0QXJyYXl9XHJcbiAgICovXHJcbiAgZ2V0RG91YmxlUGl2b3QoKSB7XHJcbiAgICBjb25zdCB2YWxzID0gbmV3IEFycmF5VHlwZSggdGhpcy5tICk7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLm07IGkrKyApIHtcclxuICAgICAgdmFsc1sgaSBdID0gdGhpcy5waXZbIGkgXTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWxzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHJldHVybnMge251bWJlcn1cclxuICAgKi9cclxuICBkZXQoKSB7XHJcbiAgICBpZiAoIHRoaXMubSAhPT0gdGhpcy5uICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdNYXRyaXggbXVzdCBiZSBzcXVhcmUuJyApO1xyXG4gICAgfVxyXG4gICAgbGV0IGQgPSB0aGlzLnBpdnNpZ247XHJcbiAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLm47IGorKyApIHtcclxuICAgICAgZCAqPSB0aGlzLkxVWyB0aGlzLm1hdHJpeC5pbmRleCggaiwgaiApIF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7TWF0cml4fSBtYXRyaXhcclxuICAgKiBAcmV0dXJucyB7TWF0cml4fVxyXG4gICAqL1xyXG4gIHNvbHZlKCBtYXRyaXggKSB7XHJcbiAgICBsZXQgaTtcclxuICAgIGxldCBqO1xyXG4gICAgbGV0IGs7XHJcbiAgICBpZiAoIG1hdHJpeC5nZXRSb3dEaW1lbnNpb24oKSAhPT0gdGhpcy5tICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdNYXRyaXggcm93IGRpbWVuc2lvbnMgbXVzdCBhZ3JlZS4nICk7XHJcbiAgICB9XHJcbiAgICBpZiAoICF0aGlzLmlzTm9uc2luZ3VsYXIoKSApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCAnTWF0cml4IGlzIHNpbmd1bGFyLicgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDb3B5IHJpZ2h0IGhhbmQgc2lkZSB3aXRoIHBpdm90aW5nXHJcbiAgICBjb25zdCBueCA9IG1hdHJpeC5nZXRDb2x1bW5EaW1lbnNpb24oKTtcclxuICAgIGNvbnN0IFhtYXQgPSBtYXRyaXguZ2V0QXJyYXlSb3dNYXRyaXgoIHRoaXMucGl2LCAwLCBueCAtIDEgKTtcclxuXHJcbiAgICAvLyBTb2x2ZSBMKlkgPSBCKHBpdiw6KVxyXG4gICAgZm9yICggayA9IDA7IGsgPCB0aGlzLm47IGsrKyApIHtcclxuICAgICAgZm9yICggaSA9IGsgKyAxOyBpIDwgdGhpcy5uOyBpKysgKSB7XHJcbiAgICAgICAgZm9yICggaiA9IDA7IGogPCBueDsgaisrICkge1xyXG4gICAgICAgICAgWG1hdC5lbnRyaWVzWyBYbWF0LmluZGV4KCBpLCBqICkgXSAtPSBYbWF0LmVudHJpZXNbIFhtYXQuaW5kZXgoIGssIGogKSBdICogdGhpcy5MVVsgdGhpcy5tYXRyaXguaW5kZXgoIGksIGsgKSBdO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFNvbHZlIFUqWCA9IFk7XHJcbiAgICBmb3IgKCBrID0gdGhpcy5uIC0gMTsgayA+PSAwOyBrLS0gKSB7XHJcbiAgICAgIGZvciAoIGogPSAwOyBqIDwgbng7IGorKyApIHtcclxuICAgICAgICBYbWF0LmVudHJpZXNbIFhtYXQuaW5kZXgoIGssIGogKSBdIC89IHRoaXMuTFVbIHRoaXMubWF0cml4LmluZGV4KCBrLCBrICkgXTtcclxuICAgICAgfVxyXG4gICAgICBmb3IgKCBpID0gMDsgaSA8IGs7IGkrKyApIHtcclxuICAgICAgICBmb3IgKCBqID0gMDsgaiA8IG54OyBqKysgKSB7XHJcbiAgICAgICAgICBYbWF0LmVudHJpZXNbIFhtYXQuaW5kZXgoIGksIGogKSBdIC09IFhtYXQuZW50cmllc1sgWG1hdC5pbmRleCggaywgaiApIF0gKiB0aGlzLkxVWyB0aGlzLm1hdHJpeC5pbmRleCggaSwgayApIF07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gWG1hdDtcclxuICB9XHJcbn1cclxuXHJcbmRvdC5yZWdpc3RlciggJ0xVRGVjb21wb3NpdGlvbicsIExVRGVjb21wb3NpdGlvbiApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgTFVEZWNvbXBvc2l0aW9uOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLEdBQUcsTUFBTSxVQUFVO0FBQzFCLE9BQU9DLE1BQU0sTUFBTSxhQUFhO0FBRWhDLE1BQU1DLFNBQVMsR0FBR0MsTUFBTSxDQUFDQyxZQUFZLElBQUlDLEtBQUs7QUFFOUMsTUFBTUMsZUFBZSxDQUFDO0VBQ3BCQyxXQUFXQSxDQUFFQyxNQUFNLEVBQUc7SUFDcEIsSUFBSUMsQ0FBQztJQUNMLElBQUlDLENBQUM7SUFDTCxJQUFJQyxDQUFDO0lBRUwsSUFBSSxDQUFDSCxNQUFNLEdBQUdBLE1BQU07O0lBRXBCO0lBQ0EsSUFBSSxDQUFDSSxFQUFFLEdBQUdKLE1BQU0sQ0FBQ0ssWUFBWSxDQUFDLENBQUM7SUFDL0IsTUFBTUQsRUFBRSxH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