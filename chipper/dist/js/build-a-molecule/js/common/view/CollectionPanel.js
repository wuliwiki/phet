// Copyright 2020-2023, University of Colorado Boulder

/**
 * A panel that shows collection areas for different collections, and allows switching between those collections
 *
 * @author Denzell Barnett (PhET Interactive Simulations)
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import ScreenView from '../../../../joist/js/ScreenView.js';
import { Shape } from '../../../../kite/js/imports.js';
import merge from '../../../../phet-core/js/merge.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import NextPreviousNavigationNode from '../../../../scenery-phet/js/NextPreviousNavigationNode.js';
import PhetFont from '../../../../scenery-phet/js/PhetFont.js';
import { Node, Text, VBox } from '../../../../scenery/js/imports.js';
import Panel from '../../../../sun/js/Panel.js';
import buildAMolecule from '../../buildAMolecule.js';
import BuildAMoleculeStrings from '../../BuildAMoleculeStrings.js';
import BAMConstants from '../BAMConstants.js';
import CollectionAreaNode from './CollectionAreaNode.js';
class CollectionPanel extends Panel {
  /**
   * @param {BAMModel} bamModel
   * @param {boolean} isSingleCollectionMode
   * @param {Array.<function>} collectionAttachmentCallbacks
   * @param {function} toModelBounds
   * @param {function} showDialogCallback
   * @param {function} updateRefillButton
   * @param {Object} [options]
   */
  constructor(bamModel, isSingleCollectionMode, collectionAttachmentCallbacks, toModelBounds, showDialogCallback, updateRefillButton, options) {
    options = merge({
      cornerRadius: BAMConstants.CORNER_RADIUS
    }, options);
    const layoutNode = new VBox({
      spacing: 10
    });
    super(layoutNode, options);

    // @private {VBox}
    this.layoutNode = layoutNode;

    // @private {Node}
    this.collectionAreaHolder = new Node();

    // @private {Object.<kitCollectionId:number, Node}
    this.collectionAreaMap = {};

    // @private {Array.<function>}
    this.collectionAttachmentCallbacks = collectionAttachmentCallbacks;

    // Create header text for panel
    const yourMoleculesText = new Text(BuildAMoleculeStrings.yourMolecules, {
      font: new PhetFont({
        size: 22
      }),
      maxWidth: BAMConstants.TEXT_MAX_WIDTH - 10
    });
    this.layoutNode.addChild(yourMoleculesText);

    // "Collection X" with arrows
    const currentCollectionText = new Text('', {
      font: new PhetFont({
        size: 16,
        weight: 'bold'
      }),
      maxWidth: BAMConstants.TEXT_MAX_WIDTH - 10
    });

    // Manages changing the label of the current collection
    bamModel.currentCollectionProperty.link(() => {
      currentCollectionText.string = StringUtils.fillIn(BuildAMoleculeStrings.collectionPattern, {
        number: bamModel.currentIndex + 1
      });
    });

    // Used to cycle through collections when a collection has bee completed.
    const collectionSwitcher = new NextPreviousNavigationNode(currentCollectionText, {
      arrowColor: BAMConstants.KIT_ARROW_BACKGROUND_ENABLED,
      arrowStrokeColor: BAMConstants.KIT_ARROW_BORDER_ENABLED,
      arrowWidth: 14,
      arrowHeight: 18,
      next() {
        bamModel.switchToNextCollection();
      },
      previous() {
        bamModel.switchToPreviousCollection();
      },
      createTouchAreaShape(shape) {
        // square touch area
        return Shape.bounds(shape.bounds.dilated(7));
      }
    });

    // Update the arrows that indicate the next/previous collection
    const updateSwitcher = () => {
      collectionSwitcher.hasNextProperty.value = bamModel.hasNextCollection();
      collectionSwitcher.hasPreviousProperty.value = bamModel.hasPreviousCollection();
    };
    bamModel.currentCollectionProperty.link(updateSwitcher);
    bamModel.addedCollectionEmitter.addListener(updateSwitcher);
    bamModel.removedCollectionEmitter.addListener(updateSwitcher);
    this.layoutNode.addChild(collectionSwitcher);

    // Add all of the collection boxes
    this.layoutNode.addChild(this.collectionAreaHolder);

    // anonymous function here, so we don't create a bunch of fields
    const createCollectionNode = collection => {
      this.collectionAreaMap[collection.id] = new CollectionAreaNode(collection, isSingleCollectionMode, toModelBounds, showDialogCallback, updateRefillButton);
    };

    // Create nodes for all current collections
    bamModel.collections.forEach(collection => {
      createCollectionNode(collection);
    });

    // If a new collection is added, create one for it
    bamModel.addedCollectionEmitter.addListener(collection => {
      createCollectionNode(collection);
    });

    // Use the current collection
    this.useCollection(bamModel.currentCollectionProperty.value);

    // As the current collection changes, use that new collection
    bamModel.currentCollectionProperty.link(newCollection => {
      this.useCollection(newCollection);
    });
  }

  /**
   * Swap to use the specified collection for this panel
   * @param {KitCollection} collection
   *
   * @private
   */
  useCollection(collection) {
    // swap out the inner collection area
    this.collectionAreaHolder.removeAllChildren();
    const collectionAreaNode = this.collectionAreaMap[collection.id];
    this.collectionAreaHolder.addChild(collectionAreaNode);

    // if we are hooked up, update the box positions. otherwise, listen to the canvas for when it is
    if (this.hasScreenViewAsAncestor()) {
      collectionAreaNode.updateCollectionBoxPositions();
    } else {
      // we need to listen for this because the update needs to use canvas' global/local/view coordinate transformations
      this.collectionAttachmentCallbacks.push(() => {
        collectionAreaNode.updateCollectionBoxPositions();
      });
    }
  }

  /**
   * Walk up the scene graph, looking to see if we are a (grand)child of a canvas
   *
   * @private
   * @returns {boolean} If an ancestor is a BuildAMoleculeCanvas
   */
  hasScreenViewAsAncestor() {
    let node = this; // eslint-disable-line consistent-this
    while (node.getParent() !== null) {
      node = node.getParent();
      if (node instanceof ScreenView) {
        return true;
      }
    }
    return false;
  }
}
buildAMolecule.register('CollectionPanel', CollectionPanel);
export default CollectionPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTY3JlZW5WaWV3IiwiU2hhcGUiLCJtZXJnZSIsIlN0cmluZ1V0aWxzIiwiTmV4dFByZXZpb3VzTmF2aWdhdGlvbk5vZGUiLCJQaGV0Rm9udCIsIk5vZGUiLCJUZXh0IiwiVkJveCIsIlBhbmVsIiwiYnVpbGRBTW9sZWN1bGUiLCJCdWlsZEFNb2xlY3VsZVN0cmluZ3MiLCJCQU1Db25zdGFudHMiLCJDb2xsZWN0aW9uQXJlYU5vZGUiLCJDb2xsZWN0aW9uUGFuZWwiLCJjb25zdHJ1Y3RvciIsImJhbU1vZGVsIiwiaXNTaW5nbGVDb2xsZWN0aW9uTW9kZSIsImNvbGxlY3Rpb25BdHRhY2htZW50Q2FsbGJhY2tzIiwidG9Nb2RlbEJvdW5kcyIsInNob3dEaWFsb2dDYWxsYmFjayIsInVwZGF0ZVJlZmlsbEJ1dHRvbiIsIm9wdGlvbnMiLCJjb3JuZXJSYWRpdXMiLCJDT1JORVJfUkFESVVTIiwibGF5b3V0Tm9kZSIsInNwYWNpbmciLCJjb2xsZWN0aW9uQXJlYUhvbGRlciIsImNvbGxlY3Rpb25BcmVhTWFwIiwieW91ck1vbGVjdWxlc1RleHQiLCJ5b3VyTW9sZWN1bGVzIiwiZm9udCIsInNpemUiLCJtYXhXaWR0aCIsIlRFWFRfTUFYX1dJRFRIIiwiYWRkQ2hpbGQiLCJjdXJyZW50Q29sbGVjdGlvblRleHQiLCJ3ZWlnaHQiLCJjdXJyZW50Q29sbGVjdGlvblByb3BlcnR5IiwibGluayIsInN0cmluZyIsImZpbGxJbiIsImNvbGxlY3Rpb25QYXR0ZXJuIiwibnVtYmVyIiwiY3VycmVudEluZGV4IiwiY29sbGVjdGlvblN3aXRjaGVyIiwiYXJyb3dDb2xvciIsIktJVF9BUlJPV19CQUNLR1JPVU5EX0VOQUJMRUQiLCJhcnJvd1N0cm9rZUNvbG9yIiwiS0lUX0FSUk9XX0JPUkRFUl9FTkFCTEVEIiwiYXJyb3dXaWR0aCIsImFycm93SGVpZ2h0IiwibmV4dCIsInN3aXRjaFRvTmV4dENvbGxlY3Rpb24iLCJwcmV2aW91cyIsInN3aXRjaFRvUHJldmlvdXNDb2xsZWN0aW9uIiwiY3JlYXRlVG91Y2hBcmVhU2hhcGUiLCJzaGFwZSIsImJvdW5kcyIsImRpbGF0ZWQiLCJ1cGRhdGVTd2l0Y2hlciIsImhhc05leHRQcm9wZXJ0eSIsInZhbHVlIiwiaGFzTmV4dENvbGxlY3Rpb24iLCJoYXNQcmV2aW91c1Byb3BlcnR5IiwiaGFzUHJldmlvdXNDb2xsZWN0aW9uIiwiYWRkZWRDb2xsZWN0aW9uRW1pdHRlciIsImFkZExpc3RlbmVyIiwicmVtb3ZlZENvbGxlY3Rpb25FbWl0dGVyIiwiY3JlYXRlQ29sbGVjdGlvbk5vZGUiLCJjb2xsZWN0aW9uIiwiaWQiLCJjb2xsZWN0aW9ucyIsImZvckVhY2giLCJ1c2VDb2xsZWN0aW9uIiwibmV3Q29sbGVjdGlvbiIsInJlbW92ZUFsbENoaWxkcmVuIiwiY29sbGVjdGlvbkFyZWFOb2RlIiwiaGFzU2NyZWVuVmlld0FzQW5jZXN0b3IiLCJ1cGRhdGVDb2xsZWN0aW9uQm94UG9zaXRpb25zIiwicHVzaCIsIm5vZGUiLCJnZXRQYXJlbnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkNvbGxlY3Rpb25QYW5lbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBBIHBhbmVsIHRoYXQgc2hvd3MgY29sbGVjdGlvbiBhcmVhcyBmb3IgZGlmZmVyZW50IGNvbGxlY3Rpb25zLCBhbmQgYWxsb3dzIHN3aXRjaGluZyBiZXR3ZWVuIHRob3NlIGNvbGxlY3Rpb25zXHJcbiAqXHJcbiAqIEBhdXRob3IgRGVuemVsbCBCYXJuZXR0IChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuaW1wb3J0IFNjcmVlblZpZXcgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvU2NyZWVuVmlldy5qcyc7XHJcbmltcG9ydCB7IFNoYXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4va2l0ZS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCBTdHJpbmdVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9waGV0Y29tbW9uL2pzL3V0aWwvU3RyaW5nVXRpbHMuanMnO1xyXG5pbXBvcnQgTmV4dFByZXZpb3VzTmF2aWdhdGlvbk5vZGUgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL05leHRQcmV2aW91c05hdmlnYXRpb25Ob2RlLmpzJztcclxuaW1wb3J0IFBoZXRGb250IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9QaGV0Rm9udC5qcyc7XHJcbmltcG9ydCB7IE5vZGUsIFRleHQsIFZCb3ggfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgUGFuZWwgZnJvbSAnLi4vLi4vLi4vLi4vc3VuL2pzL1BhbmVsLmpzJztcclxuaW1wb3J0IGJ1aWxkQU1vbGVjdWxlIGZyb20gJy4uLy4uL2J1aWxkQU1vbGVjdWxlLmpzJztcclxuaW1wb3J0IEJ1aWxkQU1vbGVjdWxlU3RyaW5ncyBmcm9tICcuLi8uLi9CdWlsZEFNb2xlY3VsZVN0cmluZ3MuanMnO1xyXG5pbXBvcnQgQkFNQ29uc3RhbnRzIGZyb20gJy4uL0JBTUNvbnN0YW50cy5qcyc7XHJcbmltcG9ydCBDb2xsZWN0aW9uQXJlYU5vZGUgZnJvbSAnLi9Db2xsZWN0aW9uQXJlYU5vZGUuanMnO1xyXG5cclxuY2xhc3MgQ29sbGVjdGlvblBhbmVsIGV4dGVuZHMgUGFuZWwge1xyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7QkFNTW9kZWx9IGJhbU1vZGVsXHJcbiAgICogQHBhcmFtIHtib29sZWFufSBpc1NpbmdsZUNvbGxlY3Rpb25Nb2RlXHJcbiAgICogQHBhcmFtIHtBcnJheS48ZnVuY3Rpb24+fSBjb2xsZWN0aW9uQXR0YWNobWVudENhbGxiYWNrc1xyXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IHRvTW9kZWxCb3VuZHNcclxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBzaG93RGlhbG9nQ2FsbGJhY2tcclxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSB1cGRhdGVSZWZpbGxCdXR0b25cclxuICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIGJhbU1vZGVsLCBpc1NpbmdsZUNvbGxlY3Rpb25Nb2RlLCBjb2xsZWN0aW9uQXR0YWNobWVudENhbGxiYWNrcywgdG9Nb2RlbEJvdW5kcyxcclxuICAgICAgICAgICAgICAgc2hvd0RpYWxvZ0NhbGxiYWNrLCB1cGRhdGVSZWZpbGxCdXR0b24sIG9wdGlvbnMgKSB7XHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuICAgICAgY29ybmVyUmFkaXVzOiBCQU1Db25zdGFudHMuQ09STkVSX1JBRElVU1xyXG4gICAgfSwgb3B0aW9ucyApO1xyXG4gICAgY29uc3QgbGF5b3V0Tm9kZSA9IG5ldyBWQm94KCB7IHNwYWNpbmc6IDEwIH0gKTtcclxuICAgIHN1cGVyKCBsYXlvdXROb2RlLCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge1ZCb3h9XHJcbiAgICB0aGlzLmxheW91dE5vZGUgPSBsYXlvdXROb2RlO1xyXG5cclxuICAgIC8vIEBwcml2YXRlIHtOb2RlfVxyXG4gICAgdGhpcy5jb2xsZWN0aW9uQXJlYUhvbGRlciA9IG5ldyBOb2RlKCk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge09iamVjdC48a2l0Q29sbGVjdGlvbklkOm51bWJlciwgTm9kZX1cclxuICAgIHRoaXMuY29sbGVjdGlvbkFyZWFNYXAgPSB7fTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7QXJyYXkuPGZ1bmN0aW9uPn1cclxuICAgIHRoaXMuY29sbGVjdGlvbkF0dGFjaG1lbnRDYWxsYmFja3MgPSBjb2xsZWN0aW9uQXR0YWNobWVudENhbGxiYWNrcztcclxuXHJcbiAgICAvLyBDcmVhdGUgaGVhZGVyIHRleHQgZm9yIHBhbmVsXHJcbiAgICBjb25zdCB5b3VyTW9sZWN1bGVzVGV4dCA9IG5ldyBUZXh0KCBCdWlsZEFNb2xlY3VsZVN0cmluZ3MueW91ck1vbGVjdWxlcywge1xyXG4gICAgICBmb250OiBuZXcgUGhldEZvbnQoIHtcclxuICAgICAgICBzaXplOiAyMlxyXG4gICAgICB9ICksXHJcbiAgICAgIG1heFdpZHRoOiBCQU1Db25zdGFudHMuVEVYVF9NQVhfV0lEVEggLSAxMFxyXG4gICAgfSApO1xyXG4gICAgdGhpcy5sYXlvdXROb2RlLmFkZENoaWxkKCB5b3VyTW9sZWN1bGVzVGV4dCApO1xyXG5cclxuICAgIC8vIFwiQ29sbGVjdGlvbiBYXCIgd2l0aCBhcnJvd3NcclxuICAgIGNvbnN0IGN1cnJlbnRDb2xsZWN0aW9uVGV4dCA9IG5ldyBUZXh0KCAnJywge1xyXG4gICAgICBmb250OiBuZXcgUGhldEZvbnQoIHtcclxuICAgICAgICBzaXplOiAxNixcclxuICAgICAgICB3ZWlnaHQ6ICdib2xkJ1xyXG4gICAgICB9ICksXHJcbiAgICAgIG1heFdpZHRoOiBCQU1Db25zdGFudHMuVEVYVF9NQVhfV0lEVEggLSAxMFxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE1hbmFnZXMgY2hhbmdpbmcgdGhlIGxhYmVsIG9mIHRoZSBjdXJyZW50IGNvbGxlY3Rpb25cclxuICAgIGJhbU1vZGVsLmN1cnJlbnRDb2xsZWN0aW9uUHJvcGVydHkubGluayggKCkgPT4ge1xyXG4gICAgICBjdXJyZW50Q29sbGVjdGlvblRleHQuc3RyaW5nID0gU3RyaW5nVXRpbHMuZmlsbEluKCBCdWlsZEFNb2xlY3VsZVN0cmluZ3MuY29sbGVjdGlvblBhdHRlcm4sIHtcclxuICAgICAgICBudW1iZXI6IGJhbU1vZGVsLmN1cnJlbnRJbmRleCArIDFcclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFVzZWQgdG8gY3ljbGUgdGhyb3VnaCBjb2xsZWN0aW9ucyB3aGVuIGEgY29sbGVjdGlvbiBoYXMgYmVlIGNvbXBsZXRlZC5cclxuICAgIGNvbnN0IGNvbGxlY3Rpb25Td2l0Y2hlciA9IG5ldyBOZXh0UHJldmlvdXNOYXZpZ2F0aW9uTm9kZSggY3VycmVudENvbGxlY3Rpb25UZXh0LCB7XHJcbiAgICAgIGFycm93Q29sb3I6IEJBTUNvbnN0YW50cy5LSVRfQVJST1dfQkFDS0dST1VORF9FTkFCTEVELFxyXG4gICAgICBhcnJvd1N0cm9rZUNvbG9yOiBCQU1Db25zdGFudHMuS0lUX0FSUk9XX0JPUkRFUl9FTkFCTEVELFxyXG4gICAgICBhcnJvd1dpZHRoOiAxNCxcclxuICAgICAgYXJyb3dIZWlnaHQ6IDE4LFxyXG4gICAgICBuZXh0KCkge1xyXG4gICAgICAgIGJhbU1vZGVsLnN3aXRjaFRvTmV4dENvbGxlY3Rpb24oKTtcclxuICAgICAgfSxcclxuICAgICAgcHJldmlvdXMoKSB7XHJcbiAgICAgICAgYmFtTW9kZWwuc3dpdGNoVG9QcmV2aW91c0NvbGxlY3Rpb24oKTtcclxuICAgICAgfSxcclxuICAgICAgY3JlYXRlVG91Y2hBcmVhU2hhcGUoIHNoYXBlICkge1xyXG4gICAgICAgIC8vIHNxdWFyZSB0b3VjaCBhcmVhXHJcbiAgICAgICAgcmV0dXJuIFNoYXBlLmJvdW5kcyggc2hhcGUuYm91bmRzLmRpbGF0ZWQoIDcgKSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSBhcnJvd3MgdGhhdCBpbmRpY2F0ZSB0aGUgbmV4dC9wcmV2aW91cyBjb2xsZWN0aW9uXHJcbiAgICBjb25zdCB1cGRhdGVTd2l0Y2hlciA9ICgpID0+IHtcclxuICAgICAgY29sbGVjdGlvblN3aXRjaGVyLmhhc05leHRQcm9wZXJ0eS52YWx1ZSA9IGJhbU1vZGVsLmhhc05leHRDb2xsZWN0aW9uKCk7XHJcbiAgICAgIGNvbGxlY3Rpb25Td2l0Y2hlci5oYXNQcmV2aW91c1Byb3BlcnR5LnZhbHVlID0gYmFtTW9kZWwuaGFzUHJldmlvdXNDb2xsZWN0aW9uKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGJhbU1vZGVsLmN1cnJlbnRDb2xsZWN0aW9uUHJvcGVydHkubGluayggdXBkYXRlU3dpdGNoZXIgKTtcclxuICAgIGJhbU1vZGVsLmFkZGVkQ29sbGVjdGlvbkVtaXR0ZXIuYWRkTGlzdGVuZXIoIHVwZGF0ZVN3aXRjaGVyICk7XHJcbiAgICBiYW1Nb2RlbC5yZW1vdmVkQ29sbGVjdGlvbkVtaXR0ZXIuYWRkTGlzdGVuZXIoIHVwZGF0ZVN3aXRjaGVyICk7XHJcbiAgICB0aGlzLmxheW91dE5vZGUuYWRkQ2hpbGQoIGNvbGxlY3Rpb25Td2l0Y2hlciApO1xyXG5cclxuICAgIC8vIEFkZCBhbGwgb2YgdGhlIGNvbGxlY3Rpb24gYm94ZXNcclxuICAgIHRoaXMubGF5b3V0Tm9kZS5hZGRDaGlsZCggdGhpcy5jb2xsZWN0aW9uQXJlYUhvbGRlciApO1xyXG5cclxuICAgIC8vIGFub255bW91cyBmdW5jdGlvbiBoZXJlLCBzbyB3ZSBkb24ndCBjcmVhdGUgYSBidW5jaCBvZiBmaWVsZHNcclxuICAgIGNvbnN0IGNyZWF0ZUNvbGxlY3Rpb25Ob2RlID0gY29sbGVjdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMuY29sbGVjdGlvbkFyZWFNYXBbIGNvbGxlY3Rpb24uaWQgXSA9IG5ldyBDb2xsZWN0aW9uQXJlYU5vZGUoXHJcbiAgICAgICAgY29sbGVjdGlvbiwgaXNTaW5nbGVDb2xsZWN0aW9uTW9kZSwgdG9Nb2RlbEJvdW5kcywgc2hvd0RpYWxvZ0NhbGxiYWNrLCB1cGRhdGVSZWZpbGxCdXR0b25cclxuICAgICAgKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gQ3JlYXRlIG5vZGVzIGZvciBhbGwgY3VycmVudCBjb2xsZWN0aW9uc1xyXG4gICAgYmFtTW9kZWwuY29sbGVjdGlvbnMuZm9yRWFjaCggY29sbGVjdGlvbiA9PiB7XHJcbiAgICAgIGNyZWF0ZUNvbGxlY3Rpb25Ob2RlKCBjb2xsZWN0aW9uICk7XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gSWYgYSBuZXcgY29sbGVjdGlvbiBpcyBhZGRlZCwgY3JlYXRlIG9uZSBmb3IgaXRcclxuICAgIGJhbU1vZGVsLmFkZGVkQ29sbGVjdGlvbkVtaXR0ZXIuYWRkTGlzdGVuZXIoIGNvbGxlY3Rpb24gPT4ge1xyXG4gICAgICBjcmVhdGVDb2xsZWN0aW9uTm9kZSggY29sbGVjdGlvbiApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFVzZSB0aGUgY3VycmVudCBjb2xsZWN0aW9uXHJcbiAgICB0aGlzLnVzZUNvbGxlY3Rpb24oIGJhbU1vZGVsLmN1cnJlbnRDb2xsZWN0aW9uUHJvcGVydHkudmFsdWUgKTtcclxuXHJcbiAgICAvLyBBcyB0aGUgY3VycmVudCBjb2xsZWN0aW9uIGNoYW5nZXMsIHVzZSB0aGF0IG5ldyBjb2xsZWN0aW9uXHJcbiAgICBiYW1Nb2RlbC5jdXJyZW50Q29sbGVjdGlvblByb3BlcnR5LmxpbmsoIG5ld0NvbGxlY3Rpb24gPT4ge1xyXG4gICAgICB0aGlzLnVzZUNvbGxlY3Rpb24oIG5ld0NvbGxlY3Rpb24gKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBTd2FwIHRvIHVzZSB0aGUgc3BlY2lmaWVkIGNvbGxlY3Rpb24gZm9yIHRoaXMgcGFuZWxcclxuICAgKiBAcGFyYW0ge0tpdENvbGxlY3Rpb259IGNvbGxlY3Rpb25cclxuICAgKlxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgdXNlQ29sbGVjdGlvbiggY29sbGVjdGlvbiApIHtcclxuXHJcbiAgICAvLyBzd2FwIG91dCB0aGUgaW5uZXIgY29sbGVjdGlvbiBhcmVhXHJcbiAgICB0aGlzLmNvbGxlY3Rpb25BcmVhSG9sZGVyLnJlbW92ZUFsbENoaWxkcmVuKCk7XHJcbiAgICBjb25zdCBjb2xsZWN0aW9uQXJlYU5vZGUgPSB0aGlzLmNvbGxlY3Rpb25BcmVhTWFwWyBjb2xsZWN0aW9uLmlkIF07XHJcbiAgICB0aGlzLmNvbGxlY3Rpb25BcmVhSG9sZGVyLmFkZENoaWxkKCBjb2xsZWN0aW9uQXJlYU5vZGUgKTtcclxuXHJcbiAgICAvLyBpZiB3ZSBhcmUgaG9va2VkIHVwLCB1cGRhdGUgdGhlIGJveCBwb3NpdGlvbnMuIG90aGVyd2lzZSwgbGlzdGVuIHRvIHRoZSBjYW52YXMgZm9yIHdoZW4gaXQgaXNcclxuICAgIGlmICggdGhpcy5oYXNTY3JlZW5WaWV3QXNBbmNlc3RvcigpICkge1xyXG4gICAgICBjb2xsZWN0aW9uQXJlYU5vZGUudXBkYXRlQ29sbGVjdGlvbkJveFBvc2l0aW9ucygpO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIC8vIHdlIG5lZWQgdG8gbGlzdGVuIGZvciB0aGlzIGJlY2F1c2UgdGhlIHVwZGF0ZSBuZWVkcyB0byB1c2UgY2FudmFzJyBnbG9iYWwvbG9jYWwvdmlldyBjb29yZGluYXRlIHRyYW5zZm9ybWF0aW9uc1xyXG4gICAgICB0aGlzLmNvbGxlY3Rpb25BdHRhY2htZW50Q2FsbGJhY2tzLnB1c2goICgpID0+IHtcclxuICAgICAgICBjb2xsZWN0aW9uQXJlYU5vZGUudXBkYXRlQ29sbGVjdGlvbkJveFBvc2l0aW9ucygpO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBXYWxrIHVwIHRoZSBzY2VuZSBncmFwaCwgbG9va2luZyB0byBzZWUgaWYgd2UgYXJlIGEgKGdyYW5kKWNoaWxkIG9mIGEgY2FudmFzXHJcbiAgICpcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBJZiBhbiBhbmNlc3RvciBpcyBhIEJ1aWxkQU1vbGVjdWxlQ2FudmFzXHJcbiAgICovXHJcbiAgaGFzU2NyZWVuVmlld0FzQW5jZXN0b3IoKSB7XHJcbiAgICBsZXQgbm9kZSA9IHRoaXM7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY29uc2lzdGVudC10aGlzXHJcbiAgICB3aGlsZSAoIG5vZGUuZ2V0UGFyZW50KCkgIT09IG51bGwgKSB7XHJcbiAgICAgIG5vZGUgPSBub2RlLmdldFBhcmVudCgpO1xyXG4gICAgICBpZiAoIG5vZGUgaW5zdGFuY2VvZiBTY3JlZW5WaWV3ICkge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcblxyXG5idWlsZEFNb2xlY3VsZS5yZWdpc3RlciggJ0NvbGxlY3Rpb25QYW5lbCcsIENvbGxlY3Rpb25QYW5lbCApO1xyXG5leHBvcnQgZGVmYXVsdCBDb2xsZWN0aW9uUGFuZWw7XHJcbiJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFVBQVUsTUFBTSxvQ0FBb0M7QUFDM0QsU0FBU0MsS0FBSyxRQUFRLGdDQUFnQztBQUN0RCxPQUFPQyxLQUFLLE1BQU0sbUNBQW1DO0FBQ3JELE9BQU9DLFdBQVcsTUFBTSwrQ0FBK0M7QUFDdkUsT0FBT0MsMEJBQTBCLE1BQU0sMkRBQTJEO0FBQ2xHLE9BQU9DLFFBQVEsTUFBTSx5Q0FBeUM7QUFDOUQsU0FBU0MsSUFBSSxFQUFFQyxJQUFJLEVBQUVDLElBQUksUUFBUSxtQ0FBbUM7QUFDcEUsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxjQUFjLE1BQU0seUJBQXlCO0FBQ3BELE9BQU9DLHFCQUFxQixNQUFNLGdDQUFnQztBQUNsRSxPQUFPQyxZQUFZLE1BQU0sb0JBQW9CO0FBQzdDLE9BQU9DLGtCQUFrQixNQUFNLHlCQUF5QjtBQUV4RCxNQUFNQyxlQUFlLFNBQVNMLEtBQUssQ0FBQztFQUNsQztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7RUFDRU0sV0FBV0EsQ0FBRUMsUUFBUSxFQUFFQyxzQkFBc0IsRUFBRUMsNkJBQTZCLEVBQUVDLGFBQWEsRUFDOUVDLGtCQUFrQixFQUFFQyxrQkFBa0IsRUFBRUMsT0FBTyxFQUFHO0lBQzdEQSxPQUFPLEdBQUdwQixLQUFLLENBQUU7TUFD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