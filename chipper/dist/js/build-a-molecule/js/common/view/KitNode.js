// Copyright 2020-2022, University of Colorado Boulder

/**
 * Shows a kit (series of buckets full of different types of atoms)
 *
 * @author Denzell Barnett (PhET Interactive Simulations)
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import { Shape } from '../../../../kite/js/imports.js';
import BucketFront from '../../../../scenery-phet/js/bucket/BucketFront.js';
import BucketHole from '../../../../scenery-phet/js/bucket/BucketHole.js';
import { DragListener, Node } from '../../../../scenery/js/imports.js';
import buildAMolecule from '../../buildAMolecule.js';
import BAMConstants from '../BAMConstants.js';
import AtomNode from './AtomNode.js';
class KitNode extends Node {
  /**
   * @param {Kit} kit
   * @param {MoleculeCollectingScreenView} moleculeCollectingScreenView
   */
  constructor(kit, moleculeCollectingScreenView) {
    super();

    // @public {Kit}
    this.kit = kit;

    // Maps for KitNode elements.
    const atomNodeMap = {}; // atom.id => AtomNode

    // Layers used for buckets
    const topLayer = new Node();
    const bottomLayer = new Node();

    // @private {Node}
    this.bottomLayer = bottomLayer;

    // @private {Node} Contains all the atoms within the buckets
    this.atomLayer = new Node();

    // Add our layers
    this.addChild(bottomLayer);
    this.addChild(this.atomLayer);
    this.addChild(topLayer);

    // Create a bucket based on a the kit's model bucket. This includes a front and back for the bucket contained in
    // different layout.
    kit.buckets.forEach(bucket => {
      const bucketFront = new BucketFront(bucket, BAMConstants.MODEL_VIEW_TRANSFORM);
      const bucketHole = new BucketHole(bucket, BAMConstants.MODEL_VIEW_TRANSFORM);
      // NOTE: we will use the Bucket's hole with an expanded touch area to trigger the "grab by touching the bucket" behavior
      bucketHole.touchArea = bucketHole.mouseArea = new Shape().moveTo(bucketHole.left - bucketHole.x, bucketHole.centerY - bucketHole.y).lineTo(bucketHole.left - bucketHole.x + 17, bucketHole.centerY + 60 - bucketHole.y).lineTo(bucketHole.right - bucketHole.x - 17, bucketHole.centerY + 60 - bucketHole.y).lineTo(bucketHole.right - bucketHole.x, bucketHole.centerY - bucketHole.y).lineTo(bucketHole.right - bucketHole.x - 35, bucketHole.centerY - 10 - bucketHole.y).lineTo(bucketHole.left - bucketHole.x + 35, bucketHole.centerY - 10 - bucketHole.y).close();

      // we will be updating the bucket's cursor depending on whether it has atoms
      const bucketHoleCursorUpdate = () => {
        bucketHole.cursor = bucket.getParticleList().length ? 'pointer' : 'default';
      };
      kit.addedMoleculeEmitter.addListener(bucketHoleCursorUpdate);
      kit.removedMoleculeEmitter.addListener(bucketHoleCursorUpdate);
      bucketHoleCursorUpdate();

      // Used for grabbing atoms in bucket. Will be triggered by grabbing the atoms themselves and the bucket the atoms
      // are contained in.
      const atomNodeDragCallback = (event, atom) => {
        // Adjust position of atom
        const viewPoint = moleculeCollectingScreenView.globalToLocalPoint(event.pointer.point);
        atom.positionProperty.value = BAMConstants.MODEL_VIEW_TRANSFORM.viewToModelPosition(viewPoint);

        // Add new atom to the play area.
        const currentKit = moleculeCollectingScreenView.bamModel.currentCollectionProperty.value.currentKitProperty.value;
        currentKit.atomsInPlayArea.push(atom);

        // Handle removing particles from bucket
        if (bucket.containsParticle(atom)) {
          // Remove the atom from the bucket's model and trigger its removal from the atomLayer in the view.
          bucket.particleList.remove(atom);

          // Get reference to atomNode and call the dragListener
          const atomNode = moleculeCollectingScreenView.kitPlayAreaNode.atomNodeMap[atom.id];
          if (atomNode) {
            atomNode.dragListener.press(event, atomNode);
          }
        }
      };

      // but don't pick the elliptical paths in the hole (that would be expensive to compute so often)
      bucketHole.children.forEach(() => {
        // our hook to start dragging an atom (if available in the bucket)
        bucketHole.addInputListener({
          down: event => {
            this.interruptSubtreeInput();

            // coordinate transforms to get our atom
            const viewPoint = this.globalToLocalPoint(event.pointer.point);
            const modelPoint = BAMConstants.MODEL_VIEW_TRANSFORM.viewToModelPosition(viewPoint);
            let atom = this.closestAtom(modelPoint, Number.POSITIVE_INFINITY, bucket.element); // filter by the element

            // if it's not in our bucket, ignore it (could skip weird cases where an atom outside of the bucket is
            // technically closer)
            if (!bucket.particleList.includes(atom)) {
              if (bucket.particleList.length) {
                atom = bucket.particleList[0];
              } else {
                return;
              }
            }
            atomNodeDragCallback(event, atom);
          }
        });
      });
      topLayer.addChild(bucketFront);
      bottomLayer.addChild(bucketHole);

      // Listener for removing a particle from the bucket's observable array.
      const particleRemovedListener = atom => {
        // Remove atom view elements from bucket node and delete the reference from atom node map
        if (atomNodeMap[atom.id]) {
          this.atomLayer.removeChild(atomNodeMap[atom.id]);
          atomNodeMap[atom.id].dispose();
          delete atomNodeMap[atom.id];
        }

        // Remove the atom from the bucket particles
        if (bucket.containsParticle(atom)) {
          bucket.removeParticle(atom, false);
        }
      };

      // Listener for adding a particle from the bucket's observable array.
      const particleAddedListener = atom => {
        // AtomNode created based on atoms in bucket
        const atomNode = new AtomNode(atom);

        // Keep track of the atomNode by mapping to its atom's ID then add to atom layer
        atomNodeMap[atom.id] = atomNode;

        // Add the particle to the bucket atom layer and the bucket's particles.
        this.atomLayer.addChild(atomNode);
        bucket.placeAtom(atom, false);

        // Add a drag listener that will move the model element when the user
        // drags this atom.
        atomNode.addInputListener(DragListener.createForwardingListener(event => {
          atomNodeDragCallback(event, atom);
        }, {
          allowTouchSnag: false
        }));
      };

      // Initial filling of the buckets and setting the bucket's filled state.
      bucket.getParticleList().forEach(particleAddedListener);
      bucket.fullState = bucket.getParticleList();
      bucket.setToFullState();

      // Add listeners to bucket particles observable array
      bucket.particleList.addItemAddedListener(particleAddedListener);
      bucket.particleList.addItemRemovedListener(particleRemovedListener);
    });
    assert && assert(kit.molecules.length === 0);
  }

  /**
   * Distance needs to be within threshold, and if an element is provided, the element must match
   * @param {Vector2} modelPoint
   * @param {number} threshold
   * @param {Element} element
   *
   * @private
   * @returns {Atom2|*}
   */
  closestAtom(modelPoint, threshold, element) {
    assert && assert(threshold);
    const thresholdSquared = threshold * threshold;
    const atoms = this.kit.atoms;
    const numAtoms = atoms.length;
    let best = null;
    let bestDistanceSquared = thresholdSquared; // limit ourselves at the threshold, and add this to the best distance so we only need one check in the loop

    const x = modelPoint.x;
    const y = modelPoint.y;

    // ignore stacking order for this operation
    for (let i = 0; i < numAtoms; i++) {
      const atom = atoms[i];
      const position = atom.positionProperty.get(); // no ES5 setters so we have the fastest possible code in this inner loop (called during hit testing)

      const dx = x - position.x;
      const dy = y - position.y;

      // not really distance, persay, since it can go negative
      const distanceSquared = dx * dx + dy * dy - atom.covalentRadius * atom.covalentRadius;
      if (distanceSquared > bestDistanceSquared || element && atom.element !== element) {
        continue;
      }
      bestDistanceSquared = distanceSquared;
      best = atom;
    }
    return best;
  }
}
buildAMolecule.register('KitNode', KitNode);
export default KitNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaGFwZSIsIkJ1Y2tldEZyb250IiwiQnVja2V0SG9sZSIsIkRyYWdMaXN0ZW5lciIsIk5vZGUiLCJidWlsZEFNb2xlY3VsZSIsIkJBTUNvbnN0YW50cyIsIkF0b21Ob2RlIiwiS2l0Tm9kZSIsImNvbnN0cnVjdG9yIiwia2l0IiwibW9sZWN1bGVDb2xsZWN0aW5nU2NyZWVuVmlldyIsImF0b21Ob2RlTWFwIiwidG9wTGF5ZXIiLCJib3R0b21MYXllciIsImF0b21MYXllciIsImFkZENoaWxkIiwiYnVja2V0cyIsImZvckVhY2giLCJidWNrZXQiLCJidWNrZXRGcm9udCIsIk1PREVMX1ZJRVdfVFJBTlNGT1JNIiwiYnVja2V0SG9sZSIsInRvdWNoQXJlYSIsIm1vdXNlQXJlYSIsIm1vdmVUbyIsImxlZnQiLCJ4IiwiY2VudGVyWSIsInkiLCJsaW5lVG8iLCJyaWdodCIsImNsb3NlIiwiYnVja2V0SG9sZUN1cnNvclVwZGF0ZSIsImN1cnNvciIsImdldFBhcnRpY2xlTGlzdCIsImxlbmd0aCIsImFkZGVkTW9sZWN1bGVFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJyZW1vdmVkTW9sZWN1bGVFbWl0dGVyIiwiYXRvbU5vZGVEcmFnQ2FsbGJhY2siLCJldmVudCIsImF0b20iLCJ2aWV3UG9pbnQiLCJnbG9iYWxUb0xvY2FsUG9pbnQiLCJwb2ludGVyIiwicG9pbnQiLCJwb3NpdGlvblByb3BlcnR5IiwidmFsdWUiLCJ2aWV3VG9Nb2RlbFBvc2l0aW9uIiwiY3VycmVudEtpdCIsImJhbU1vZGVsIiwiY3VycmVudENvbGxlY3Rpb25Qcm9wZXJ0eSIsImN1cnJlbnRLaXRQcm9wZXJ0eSIsImF0b21zSW5QbGF5QXJlYSIsInB1c2giLCJjb250YWluc1BhcnRpY2xlIiwicGFydGljbGVMaXN0IiwicmVtb3ZlIiwiYXRvbU5vZGUiLCJraXRQbGF5QXJlYU5vZGUiLCJpZCIsImRyYWdMaXN0ZW5lciIsInByZXNzIiwiY2hpbGRyZW4iLCJhZGRJbnB1dExpc3RlbmVyIiwiZG93biIsImludGVycnVwdFN1YnRyZWVJbnB1dCIsIm1vZGVsUG9pbnQiLCJjbG9zZXN0QXRvbSIsIk51bWJlciIsIlBPU0lUSVZFX0lORklOSVRZIiwiZWxlbWVudCIsImluY2x1ZGVzIiwicGFydGljbGVSZW1vdmVkTGlzdGVuZXIiLCJyZW1vdmVDaGlsZCIsImRpc3Bvc2UiLCJyZW1vdmVQYXJ0aWNsZSIsInBhcnRpY2xlQWRkZWRMaXN0ZW5lciIsInBsYWNlQXRvbSIsImNyZWF0ZUZvcndhcmRpbmdMaXN0ZW5lciIsImFsbG93VG91Y2hTbmFnIiwiZnVsbFN0YXRlIiwic2V0VG9GdWxsU3RhdGUiLCJhZGRJdGVtQWRkZWRMaXN0ZW5lciIsImFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJhc3NlcnQiLCJtb2xlY3VsZXMiLCJ0aHJlc2hvbGQiLCJ0aHJlc2hvbGRTcXVhcmVkIiwiYXRvbXMiLCJudW1BdG9tcyIsImJlc3QiLCJiZXN0RGlzdGFuY2VTcXVhcmVkIiwiaSIsInBvc2l0aW9uIiwiZ2V0IiwiZHgiLCJkeSIsImRpc3RhbmNlU3F1YXJlZCIsImNvdmFsZW50UmFkaXVzIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJLaXROb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNob3dzIGEga2l0IChzZXJpZXMgb2YgYnVja2V0cyBmdWxsIG9mIGRpZmZlcmVudCB0eXBlcyBvZiBhdG9tcylcclxuICpcclxuICogQGF1dGhvciBEZW56ZWxsIEJhcm5ldHQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgeyBTaGFwZSB9IGZyb20gJy4uLy4uLy4uLy4uL2tpdGUvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBCdWNrZXRGcm9udCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvYnVja2V0L0J1Y2tldEZyb250LmpzJztcclxuaW1wb3J0IEJ1Y2tldEhvbGUgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL2J1Y2tldC9CdWNrZXRIb2xlLmpzJztcclxuaW1wb3J0IHsgRHJhZ0xpc3RlbmVyLCBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGJ1aWxkQU1vbGVjdWxlIGZyb20gJy4uLy4uL2J1aWxkQU1vbGVjdWxlLmpzJztcclxuaW1wb3J0IEJBTUNvbnN0YW50cyBmcm9tICcuLi9CQU1Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgQXRvbU5vZGUgZnJvbSAnLi9BdG9tTm9kZS5qcyc7XHJcblxyXG5jbGFzcyBLaXROb2RlIGV4dGVuZHMgTm9kZSB7XHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtLaXR9IGtpdFxyXG4gICAqIEBwYXJhbSB7TW9sZWN1bGVDb2xsZWN0aW5nU2NyZWVuVmlld30gbW9sZWN1bGVDb2xsZWN0aW5nU2NyZWVuVmlld1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBraXQsIG1vbGVjdWxlQ29sbGVjdGluZ1NjcmVlblZpZXcgKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIC8vIEBwdWJsaWMge0tpdH1cclxuICAgIHRoaXMua2l0ID0ga2l0O1xyXG5cclxuICAgIC8vIE1hcHMgZm9yIEtpdE5vZGUgZWxlbWVudHMuXHJcbiAgICBjb25zdCBhdG9tTm9kZU1hcCA9IHt9OyAvLyBhdG9tLmlkID0+IEF0b21Ob2RlXHJcblxyXG4gICAgLy8gTGF5ZXJzIHVzZWQgZm9yIGJ1Y2tldHNcclxuICAgIGNvbnN0IHRvcExheWVyID0gbmV3IE5vZGUoKTtcclxuICAgIGNvbnN0IGJvdHRvbUxheWVyID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Tm9kZX1cclxuICAgIHRoaXMuYm90dG9tTGF5ZXIgPSBib3R0b21MYXllcjtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Tm9kZX0gQ29udGFpbnMgYWxsIHRoZSBhdG9tcyB3aXRoaW4gdGhlIGJ1Y2tldHNcclxuICAgIHRoaXMuYXRvbUxheWVyID0gbmV3IE5vZGUoKTtcclxuXHJcbiAgICAvLyBBZGQgb3VyIGxheWVyc1xyXG4gICAgdGhpcy5hZGRDaGlsZCggYm90dG9tTGF5ZXIgKTtcclxuICAgIHRoaXMuYWRkQ2hpbGQoIHRoaXMuYXRvbUxheWVyICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0b3BMYXllciApO1xyXG5cclxuICAgIC8vIENyZWF0ZSBhIGJ1Y2tldCBiYXNlZCBvbiBhIHRoZSBraXQncyBtb2RlbCBidWNrZXQuIFRoaXMgaW5jbHVkZXMgYSBmcm9udCBhbmQgYmFjayBmb3IgdGhlIGJ1Y2tldCBjb250YWluZWQgaW5cclxuICAgIC8vIGRpZmZlcmVudCBsYXlvdXQuXHJcbiAgICBraXQuYnVja2V0cy5mb3JFYWNoKCBidWNrZXQgPT4ge1xyXG4gICAgICBjb25zdCBidWNrZXRGcm9udCA9IG5ldyBCdWNrZXRGcm9udCggYnVja2V0LCBCQU1Db25zdGFudHMuTU9ERUxfVklFV19UUkFOU0ZPUk0gKTtcclxuICAgICAgY29uc3QgYnVja2V0SG9sZSA9IG5ldyBCdWNrZXRIb2xlKCBidWNrZXQsIEJBTUNvbnN0YW50cy5NT0RFTF9WSUVXX1RSQU5TRk9STSApO1xyXG4gICAgICAvLyBOT1RFOiB3ZSB3aWxsIHVzZSB0aGUgQnVja2V0J3MgaG9sZSB3aXRoIGFuIGV4cGFuZGVkIHRvdWNoIGFyZWEgdG8gdHJpZ2dlciB0aGUgXCJncmFiIGJ5IHRvdWNoaW5nIHRoZSBidWNrZXRcIiBiZWhhdmlvclxyXG4gICAgICBidWNrZXRIb2xlLnRvdWNoQXJlYSA9IGJ1Y2tldEhvbGUubW91c2VBcmVhID0gbmV3IFNoYXBlKClcclxuICAgICAgICAubW92ZVRvKCBidWNrZXRIb2xlLmxlZnQgLSBidWNrZXRIb2xlLngsIGJ1Y2tldEhvbGUuY2VudGVyWSAtIGJ1Y2tldEhvbGUueSApXHJcbiAgICAgICAgLmxpbmVUbyggYnVja2V0SG9sZS5sZWZ0IC0gYnVja2V0SG9sZS54ICsgMTcsIGJ1Y2tldEhvbGUuY2VudGVyWSArIDYwIC0gYnVja2V0SG9sZS55IClcclxuICAgICAgICAubGluZVRvKCBidWNrZXRIb2xlLnJpZ2h0IC0gYnVja2V0SG9sZS54IC0gMTcsIGJ1Y2tldEhvbGUuY2VudGVyWSArIDYwIC0gYnVja2V0SG9sZS55IClcclxuICAgICAgICAubGluZVRvKCBidWNrZXRIb2xlLnJpZ2h0IC0gYnVja2V0SG9sZS54LCBidWNrZXRIb2xlLmNlbnRlclkgLSBidWNrZXRIb2xlLnkgKVxyXG4gICAgICAgIC5saW5lVG8oIGJ1Y2tldEhvbGUucmlnaHQgLSBidWNrZXRIb2xlLnggLSAzNSwgYnVja2V0SG9sZS5jZW50ZXJZIC0gMTAgLSBidWNrZXRIb2xlLnkgKVxyXG4gICAgICAgIC5saW5lVG8oIGJ1Y2tldEhvbGUubGVmdCAtIGJ1Y2tldEhvbGUueCArIDM1LCBidWNrZXRIb2xlLmNlbnRlclkgLSAxMCAtIGJ1Y2tldEhvbGUueSApXHJcbiAgICAgICAgLmNsb3NlKCk7XHJcblxyXG4gICAgICAvLyB3ZSB3aWxsIGJlIHVwZGF0aW5nIHRoZSBidWNrZXQncyBjdXJzb3IgZGVwZW5kaW5nIG9uIHdoZXRoZXIgaXQgaGFzIGF0b21zXHJcbiAgICAgIGNvbnN0IGJ1Y2tldEhvbGVDdXJzb3JVcGRhdGUgPSAoKSA9PiB7XHJcbiAgICAgICAgYnVja2V0SG9sZS5jdXJzb3IgPSBidWNrZXQuZ2V0UGFydGljbGVMaXN0KCkubGVuZ3RoID8gJ3BvaW50ZXInIDogJ2RlZmF1bHQnO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAga2l0LmFkZGVkTW9sZWN1bGVFbWl0dGVyLmFkZExpc3RlbmVyKCBidWNrZXRIb2xlQ3Vyc29yVXBkYXRlICk7XHJcbiAgICAgIGtpdC5yZW1vdmVkTW9sZWN1bGVFbWl0dGVyLmFkZExpc3RlbmVyKCBidWNrZXRIb2xlQ3Vyc29yVXBkYXRlICk7XHJcbiAgICAgIGJ1Y2tldEhvbGVDdXJzb3JVcGRhdGUoKTtcclxuXHJcblxyXG4gICAgICAvLyBVc2VkIGZvciBncmFiYmluZyBhdG9tcyBpbiBidWNrZXQuIFdpbGwgYmUgdHJpZ2dlcmVkIGJ5IGdyYWJiaW5nIHRoZSBhdG9tcyB0aGVtc2VsdmVzIGFuZCB0aGUgYnVja2V0IHRoZSBhdG9tc1xyXG4gICAgICAvLyBhcmUgY29udGFpbmVkIGluLlxyXG4gICAgICBjb25zdCBhdG9tTm9kZURyYWdDYWxsYmFjayA9ICggZXZlbnQsIGF0b20gKSA9PiB7XHJcblxyXG4gICAgICAgIC8vIEFkanVzdCBwb3NpdGlvbiBvZiBhdG9tXHJcbiAgICAgICAgY29uc3Qgdmlld1BvaW50ID0gbW9sZWN1bGVDb2xsZWN0aW5nU2NyZWVuVmlldy5nbG9iYWxUb0xvY2FsUG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKTtcclxuICAgICAgICBhdG9tLnBvc2l0aW9uUHJvcGVydHkudmFsdWUgPSBCQU1Db25zdGFudHMuTU9ERUxfVklFV19UUkFOU0ZPUk0udmlld1RvTW9kZWxQb3NpdGlvbiggdmlld1BvaW50ICk7XHJcblxyXG4gICAgICAgIC8vIEFkZCBuZXcgYXRvbSB0byB0aGUgcGxheSBhcmVhLlxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRLaXQgPSBtb2xlY3VsZUNvbGxlY3RpbmdTY3JlZW5WaWV3LmJhbU1vZGVsLmN1cnJlbnRDb2xsZWN0aW9uUHJvcGVydHkudmFsdWUuY3VycmVudEtpdFByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgIGN1cnJlbnRLaXQuYXRvbXNJblBsYXlBcmVhLnB1c2goIGF0b20gKTtcclxuXHJcbiAgICAgICAgLy8gSGFuZGxlIHJlbW92aW5nIHBhcnRpY2xlcyBmcm9tIGJ1Y2tldFxyXG4gICAgICAgIGlmICggYnVja2V0LmNvbnRhaW5zUGFydGljbGUoIGF0b20gKSApIHtcclxuXHJcbiAgICAgICAgICAvLyBSZW1vdmUgdGhlIGF0b20gZnJvbSB0aGUgYnVja2V0J3MgbW9kZWwgYW5kIHRyaWdnZXIgaXRzIHJlbW92YWwgZnJvbSB0aGUgYXRvbUxheWVyIGluIHRoZSB2aWV3LlxyXG4gICAgICAgICAgYnVja2V0LnBhcnRpY2xlTGlzdC5yZW1vdmUoIGF0b20gKTtcclxuXHJcbiAgICAgICAgICAvLyBHZXQgcmVmZXJlbmNlIHRvIGF0b21Ob2RlIGFuZCBjYWxsIHRoZSBkcmFnTGlzdGVuZXJcclxuICAgICAgICAgIGNvbnN0IGF0b21Ob2RlID0gbW9sZWN1bGVDb2xsZWN0aW5nU2NyZWVuVmlldy5raXRQbGF5QXJlYU5vZGUuYXRvbU5vZGVNYXBbIGF0b20uaWQgXTtcclxuXHJcbiAgICAgICAgICBpZiAoIGF0b21Ob2RlICkge1xyXG4gICAgICAgICAgICBhdG9tTm9kZS5kcmFnTGlzdGVuZXIucHJlc3MoIGV2ZW50LCBhdG9tTm9kZSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIGJ1dCBkb24ndCBwaWNrIHRoZSBlbGxpcHRpY2FsIHBhdGhzIGluIHRoZSBob2xlICh0aGF0IHdvdWxkIGJlIGV4cGVuc2l2ZSB0byBjb21wdXRlIHNvIG9mdGVuKVxyXG4gICAgICBidWNrZXRIb2xlLmNoaWxkcmVuLmZvckVhY2goICgpID0+IHtcclxuXHJcbiAgICAgICAgLy8gb3VyIGhvb2sgdG8gc3RhcnQgZHJhZ2dpbmcgYW4gYXRvbSAoaWYgYXZhaWxhYmxlIGluIHRoZSBidWNrZXQpXHJcbiAgICAgICAgYnVja2V0SG9sZS5hZGRJbnB1dExpc3RlbmVyKCB7XHJcbiAgICAgICAgICBkb3duOiBldmVudCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaW50ZXJydXB0U3VidHJlZUlucHV0KCk7XHJcblxyXG4gICAgICAgICAgICAvLyBjb29yZGluYXRlIHRyYW5zZm9ybXMgdG8gZ2V0IG91ciBhdG9tXHJcbiAgICAgICAgICAgIGNvbnN0IHZpZXdQb2ludCA9IHRoaXMuZ2xvYmFsVG9Mb2NhbFBvaW50KCBldmVudC5wb2ludGVyLnBvaW50ICk7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsUG9pbnQgPSBCQU1Db25zdGFudHMuTU9ERUxfVklFV19UUkFOU0ZPUk0udmlld1RvTW9kZWxQb3NpdGlvbiggdmlld1BvaW50ICk7XHJcbiAgICAgICAgICAgIGxldCBhdG9tID0gdGhpcy5jbG9zZXN0QXRvbSggbW9kZWxQb2ludCwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLCBidWNrZXQuZWxlbWVudCApOyAvLyBmaWx0ZXIgYnkgdGhlIGVsZW1lbnRcclxuXHJcbiAgICAgICAgICAgIC8vIGlmIGl0J3Mgbm90IGluIG91ciBidWNrZXQsIGlnbm9yZSBpdCAoY291bGQgc2tpcCB3ZWlyZCBjYXNlcyB3aGVyZSBhbiBhdG9tIG91dHNpZGUgb2YgdGhlIGJ1Y2tldCBpc1xyXG4gICAgICAgICAgICAvLyB0ZWNobmljYWxseSBjbG9zZXIpXHJcbiAgICAgICAgICAgIGlmICggIWJ1Y2tldC5wYXJ0aWNsZUxpc3QuaW5jbHVkZXMoIGF0b20gKSApIHtcclxuICAgICAgICAgICAgICBpZiAoIGJ1Y2tldC5wYXJ0aWNsZUxpc3QubGVuZ3RoICkge1xyXG4gICAgICAgICAgICAgICAgYXRvbSA9IGJ1Y2tldC5wYXJ0aWNsZUxpc3RbIDAgXTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGF0b21Ob2RlRHJhZ0NhbGxiYWNrKCBldmVudCwgYXRvbSApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gKTtcclxuXHJcbiAgICAgIH0gKTtcclxuICAgICAgdG9wTGF5ZXIuYWRkQ2hpbGQoIGJ1Y2tldEZyb250ICk7XHJcbiAgICAgIGJvdHRvbUxheWVyLmFkZENoaWxkKCBidWNrZXRIb2xlICk7XHJcblxyXG4gICAgICAvLyBMaXN0ZW5lciBmb3IgcmVtb3ZpbmcgYSBwYXJ0aWNsZSBmcm9tIHRoZSBidWNrZXQncyBvYnNlcnZhYmxlIGFycmF5LlxyXG4gICAgICBjb25zdCBwYXJ0aWNsZVJlbW92ZWRMaXN0ZW5lciA9IGF0b20gPT4ge1xyXG5cclxuICAgICAgICAvLyBSZW1vdmUgYXRvbSB2aWV3IGVsZW1lbnRzIGZyb20gYnVja2V0IG5vZGUgYW5kIGRlbGV0ZSB0aGUgcmVmZXJlbmNlIGZyb20gYXRvbSBub2RlIG1hcFxyXG4gICAgICAgIGlmICggYXRvbU5vZGVNYXBbIGF0b20uaWQgXSApIHtcclxuICAgICAgICAgIHRoaXMuYXRvbUxheWVyLnJlbW92ZUNoaWxkKCBhdG9tTm9kZU1hcFsgYXRvbS5pZCBdICk7XHJcbiAgICAgICAgICBhdG9tTm9kZU1hcFsgYXRvbS5pZCBdLmRpc3Bvc2UoKTtcclxuICAgICAgICAgIGRlbGV0ZSBhdG9tTm9kZU1hcFsgYXRvbS5pZCBdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBhdG9tIGZyb20gdGhlIGJ1Y2tldCBwYXJ0aWNsZXNcclxuICAgICAgICBpZiAoIGJ1Y2tldC5jb250YWluc1BhcnRpY2xlKCBhdG9tICkgKSB7XHJcbiAgICAgICAgICBidWNrZXQucmVtb3ZlUGFydGljbGUoIGF0b20sIGZhbHNlICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy8gTGlzdGVuZXIgZm9yIGFkZGluZyBhIHBhcnRpY2xlIGZyb20gdGhlIGJ1Y2tldCdzIG9ic2VydmFibGUgYXJyYXkuXHJcbiAgICAgIGNvbnN0IHBhcnRpY2xlQWRkZWRMaXN0ZW5lciA9IGF0b20gPT4ge1xyXG5cclxuICAgICAgICAvLyBBdG9tTm9kZSBjcmVhdGVkIGJhc2VkIG9uIGF0b21zIGluIGJ1Y2tldFxyXG4gICAgICAgIGNvbnN0IGF0b21Ob2RlID0gbmV3IEF0b21Ob2RlKCBhdG9tICk7XHJcblxyXG4gICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIGF0b21Ob2RlIGJ5IG1hcHBpbmcgdG8gaXRzIGF0b20ncyBJRCB0aGVuIGFkZCB0byBhdG9tIGxheWVyXHJcbiAgICAgICAgYXRvbU5vZGVNYXBbIGF0b20uaWQgXSA9IGF0b21Ob2RlO1xyXG5cclxuICAgICAgICAvLyBBZGQgdGhlIHBhcnRpY2xlIHRvIHRoZSBidWNrZXQgYXRvbSBsYXllciBhbmQgdGhlIGJ1Y2tldCdzIHBhcnRpY2xlcy5cclxuICAgICAgICB0aGlzLmF0b21MYXllci5hZGRDaGlsZCggYXRvbU5vZGUgKTtcclxuICAgICAgICBidWNrZXQucGxhY2VBdG9tKCBhdG9tLCBmYWxzZSApO1xyXG5cclxuICAgICAgICAvLyBBZGQgYSBkcmFnIGxpc3RlbmVyIHRoYXQgd2lsbCBtb3ZlIHRoZSBtb2RlbCBlbGVtZW50IHdoZW4gdGhlIHVzZXJcclxuICAgICAgICAvLyBkcmFncyB0aGlzIGF0b20uXHJcbiAgICAgICAgYXRvbU5vZGUuYWRkSW5wdXRMaXN0ZW5lciggRHJhZ0xpc3RlbmVyLmNyZWF0ZUZvcndhcmRpbmdMaXN0ZW5lciggZXZlbnQgPT4ge1xyXG4gICAgICAgICAgYXRvbU5vZGVEcmFnQ2FsbGJhY2soIGV2ZW50LCBhdG9tICk7XHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgYWxsb3dUb3VjaFNuYWc6IGZhbHNlXHJcbiAgICAgICAgfSApICk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvLyBJbml0aWFsIGZpbGxpbmcgb2YgdGhlIGJ1Y2tldHMgYW5kIHNldHRpbmcgdGhlIGJ1Y2tldCdzIGZpbGxlZCBzdGF0ZS5cclxuICAgICAgYnVja2V0LmdldFBhcnRpY2xlTGlzdCgpLmZvckVhY2goIHBhcnRpY2xlQWRkZWRMaXN0ZW5lciApO1xyXG4gICAgICBidWNrZXQuZnVsbFN0YXRlID0gYnVja2V0LmdldFBhcnRpY2xlTGlzdCgpO1xyXG4gICAgICBidWNrZXQuc2V0VG9GdWxsU3RhdGUoKTtcclxuXHJcbiAgICAgIC8vIEFkZCBsaXN0ZW5lcnMgdG8gYnVja2V0IHBhcnRpY2xlcyBvYnNlcnZhYmxlIGFycmF5XHJcbiAgICAgIGJ1Y2tldC5wYXJ0aWNsZUxpc3QuYWRkSXRlbUFkZGVkTGlzdGVuZXIoIHBhcnRpY2xlQWRkZWRMaXN0ZW5lciApO1xyXG4gICAgICBidWNrZXQucGFydGljbGVMaXN0LmFkZEl0ZW1SZW1vdmVkTGlzdGVuZXIoIHBhcnRpY2xlUmVtb3ZlZExpc3RlbmVyICk7XHJcbiAgICB9ICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBraXQubW9sZWN1bGVzLmxlbmd0aCA9PT0gMCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGlzdGFuY2UgbmVlZHMgdG8gYmUgd2l0aGluIHRocmVzaG9sZCwgYW5kIGlmIGFuIGVsZW1lbnQgaXMgcHJvdmlkZWQsIHRoZSBlbGVtZW50IG11c3QgbWF0Y2hcclxuICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG1vZGVsUG9pbnRcclxuICAgKiBAcGFyYW0ge251bWJlcn0gdGhyZXNob2xkXHJcbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50XHJcbiAgICpcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqIEByZXR1cm5zIHtBdG9tMnwqfVxyXG4gICAqL1xyXG4gIGNsb3Nlc3RBdG9tKCBtb2RlbFBvaW50LCB0aHJlc2hvbGQsIGVsZW1lbnQgKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aHJlc2hvbGQgKTtcclxuXHJcbiAgICBjb25zdCB0aHJlc2hvbGRTcXVhcmVkID0gdGhyZXNob2xkICogdGhyZXNob2xkO1xyXG5cclxuICAgIGNvbnN0IGF0b21zID0gdGhpcy5raXQuYXRvbXM7XHJcbiAgICBjb25zdCBudW1BdG9tcyA9IGF0b21zLmxlbmd0aDtcclxuXHJcbiAgICBsZXQgYmVzdCA9IG51bGw7XHJcbiAgICBsZXQgYmVzdERpc3RhbmNlU3F1YXJlZCA9IHRocmVzaG9sZFNxdWFyZWQ7IC8vIGxpbWl0IG91cnNlbHZlcyBhdCB0aGUgdGhyZXNob2xkLCBhbmQgYWRkIHRoaXMgdG8gdGhlIGJlc3QgZGlzdGFuY2Ugc28gd2Ugb25seSBuZWVkIG9uZSBjaGVjayBpbiB0aGUgbG9vcFxyXG5cclxuICAgIGNvbnN0IHggPSBtb2RlbFBvaW50Lng7XHJcbiAgICBjb25zdCB5ID0gbW9kZWxQb2ludC55O1xyXG5cclxuICAgIC8vIGlnbm9yZSBzdGFja2luZyBvcmRlciBmb3IgdGhpcyBvcGVyYXRpb25cclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IG51bUF0b21zOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IGF0b20gPSBhdG9tc1sgaSBdO1xyXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IGF0b20ucG9zaXRpb25Qcm9wZXJ0eS5nZXQoKTsgLy8gbm8gRVM1IHNldHRlcnMgc28gd2UgaGF2ZSB0aGUgZmFzdGVzdCBwb3NzaWJsZSBjb2RlIGluIHRoaXMgaW5uZXIgbG9vcCAoY2FsbGVkIGR1cmluZyBoaXQgdGVzdGluZylcclxuXHJcbiAgICAgIGNvbnN0IGR4ID0geCAtIHBvc2l0aW9uLng7XHJcbiAgICAgIGNvbnN0IGR5ID0geSAtIHBvc2l0aW9uLnk7XHJcblxyXG4gICAgICAvLyBub3QgcmVhbGx5IGRpc3RhbmNlLCBwZXJzYXksIHNpbmNlIGl0IGNhbiBnbyBuZWdhdGl2ZVxyXG4gICAgICBjb25zdCBkaXN0YW5jZVNxdWFyZWQgPSBkeCAqIGR4ICsgZHkgKiBkeSAtIGF0b20uY292YWxlbnRSYWRpdXMgKiBhdG9tLmNvdmFsZW50UmFkaXVzO1xyXG5cclxuICAgICAgaWYgKCBkaXN0YW5jZVNxdWFyZWQgPiBiZXN0RGlzdGFuY2VTcXVhcmVkIHx8ICggZWxlbWVudCAmJiBhdG9tLmVsZW1lbnQgIT09IGVsZW1lbnQgKSApIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgYmVzdERpc3RhbmNlU3F1YXJlZCA9IGRpc3RhbmNlU3F1YXJlZDtcclxuICAgICAgYmVzdCA9IGF0b207XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGJlc3Q7XHJcbiAgfVxyXG59XHJcblxyXG5idWlsZEFNb2xlY3VsZS5yZWdpc3RlciggJ0tpdE5vZGUnLCBLaXROb2RlICk7XHJcbmV4cG9ydCBkZWZhdWx0IEtpdE5vZGU7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsU0FBU0EsS0FBSyxRQUFRLGdDQUFnQztBQUN0RCxPQUFPQyxXQUFXLE1BQU0sbURBQW1EO0FBQzNFLE9BQU9DLFVBQVUsTUFBTSxrREFBa0Q7QUFDekUsU0FBU0MsWUFBWSxFQUFFQyxJQUFJLFFBQVEsbUNBQW1DO0FBQ3RFLE9BQU9DLGNBQWMsTUFBTSx5QkFBeUI7QUFDcEQsT0FBT0MsWUFBWSxNQUFNLG9CQUFvQjtBQUM3QyxPQUFPQyxRQUFRLE1BQU0sZUFBZTtBQUVwQyxNQUFNQyxPQUFPLFNBQVNKLElBQUksQ0FBQztFQUN6QjtBQUNGO0FBQ0E7QUFDQTtFQUNFSyxXQUFXQSxDQUFFQyxHQUFHLEVBQUVDLDRCQUE0QixFQUFHO0lBQy9DLEtBQUssQ0FBQyxDQUFDOztJQUVQO0lBQ0EsSUFBSSxDQUFDRCxHQUFHLEdBQUdBLEdBQUc7O0lBRWQ7SUFDQSxNQUFNRSxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7SUFFeEI7SUFDQSxNQUFNQyxRQUFRLEdBQUcsSUFBSVQsSUFBSSxDQUFDLENBQUM7SUFDM0IsTUFBTVUsV0FBVyxHQUFHLElBQUlWLElBQUksQ0FBQyxDQUFDOztJQUU5QjtJQUNBLElBQUksQ0FBQ1UsV0FBVyxHQUFHQSxXQUFXOztJQUU5QjtJQUNBLElBQUksQ0FBQ0MsU0FBUyxHQUFHLElBQUlYLElBQUksQ0FBQyxDQUFDOztJQUUzQjtJQUNBLElBQUksQ0FBQ1ksUUFBUSxDQUFFRixXQUFZLENBQUM7SUFDNUIsSUFBSSxDQUFDRSxRQUFRLENBQUUsSUFBSSxDQUFDRCxTQUFVLENBQUM7SUFDL0IsSUFBSSxDQUFDQyxRQUFRLENBQUVILFFBQVMsQ0FBQzs7SUFFekI7SUFDQTtJQUNBSCxHQUFHLENBQUNPLE9BQU8sQ0FBQ0MsT0FBTyxDQUFFQyxNQUFNLElBQUk7TUFDN0IsTUFBTUMsV0FBVyxHQUFHLElBQUluQixXQUFXLENBQUVrQixNQUFNLEVBQUViLFlBQVksQ0FBQ2Usb0JBQXFCLENBQUM7TUFDaEYsTUFBTUMsVUFBVSxHQUFHLElBQUlwQixVQUFVLENBQUVpQixNQUFNLEVBQUViLFlBQVksQ0FBQ2Usb0JBQXFCLENBQUM7TUFDOUU7TUFDQUMsVUFBVSxDQUFDQyxTQUFTLEdBQUdELFVBQVUsQ0FBQ0UsU0FBUyxHQUFHLElBQUl4QixLQUFLLENBQUMsQ0FBQyxDQUN0RHlCLE1BQU0sQ0FBRUgsVUFBVSxDQUFDSSxJQUFJLEdBQUdKLFVBQVUsQ0FBQ0ssQ0FBQyxFQUFFTCxVQUFVLENBQUNNLE9BQU8sR0FBR04sVUFBVSxDQUFDTyxDQUFFLENBQUMsQ0FDM0VDLE1BQU0sQ0FBRVIsVUFBVSxDQUFDSSxJQUFJLEdBQUdKLFVBQVUsQ0FBQ0ssQ0FBQyxHQUFHLEVBQUUsRUFBRUwsVUFBVSxDQUFDTSxPQUFPLEdBQUcsRUFBRSxHQUFHTixVQUFVLENBQUNPLENBQUUsQ0FBQyxDQUNyRkMsTUFBTSxDQUFFUixVQUFVLENBQUNTLEtBQUssR0FBR1QsVUFBVSxDQUFDSyxDQUFDLEdBQUcsRUFBRSxFQUFFTCxVQUFVLENBQUNNLE9BQU8sR0FBRyxFQUFFLEdBQUdOLFVBQVUsQ0FBQ08sQ0FBRSxDQUFDLENBQ3RGQyxNQUFNLENBQUVSLFVBQVUsQ0FBQ1MsS0FBSyxHQUFHVCxVQUFVLENBQUNLLENBQUMsRUFBRUwsVUFBVSxDQUFDTSxPQUFPLEdBQUdOLFVBQVUsQ0FBQ08sQ0FBRSxDQUFDLENBQzVFQyxNQUFNLENBQUVSLFVBQVUsQ0FBQ1MsS0FBSyxHQUFHVCxVQUFVLENBQUNLLENBQUMsR0FBRyxFQUFFLEVBQUVMLFVBQVUsQ0FBQ00sT0FBTyxHQUFHLEVBQUUsR0FBR04sVUFBVSxDQUFDTyxDQUFFLENBQUMsQ0FDdEZDLE1BQU0sQ0FBRVIsVUFBVSxDQUFDSSxJQUFJLEdBQUdKLFVBQVUsQ0FBQ0ssQ0FBQyxHQUFHLEVBQUUsRUFBRUwsVUFBVSxDQUFDTSxPQUFPLEdBQUcsRUFBRSxHQUFHTixVQUFVLENBQUNPLENBQUUsQ0FBQyxDQUNyRkcsS0FBSyxDQUFDLENBQUM7O01BRVY7TUFDQSxNQUFNQyxzQkFBc0IsR0FBR0EsQ0FBQSxLQUFNO1FBQ25DWCxVQUFVLENBQUNZLE1BQU0sR0FBR2YsTUFBTSxDQUFDZ0IsZUFBZSxDQUFDLENBQUMsQ0FBQ0MsTUFBTSxHQUFHLFNBQVMsR0FBRyxTQUFTO01BQzdFLENBQUM7TUFFRDFCLEdBQUcsQ0FBQzJCLG9CQUFvQixDQUFDQyxXQUFXLENBQUVMLHNCQUF1QixDQUFDO01BQzlEdkIsR0FBRyxDQUFDNkIsc0JBQXNCLENBQUNELFdBQVcsQ0FBRUwsc0JBQXVCLENBQUM7TUFDaEVBLHNCQUFzQixDQUFDLENBQUM7O01BR3hCO01BQ0E7TUFDQSxNQUFNTyxvQkFBb0IsR0FBR0EsQ0FBRUMsS0FBSyxFQUFFQyxJQUFJLEtBQU07UUFFOUM7UUFDQSxNQUFNQyxTQUFTLEdBQUdoQyw0QkFBNEIsQ0FBQ2lDLGtCQUFrQixDQUFFSCxLQUFLLENBQUNJLE9BQU8sQ0FBQ0MsS0FBTSxDQUFDO1FBQ3hGSixJQUFJLENBQUNLLGdCQUFnQixDQUFDQyxLQUFLLEdBQUcxQyxZQUFZLENBQUNlLG9CQUFvQixDQUFDNEIsbUJBQW1CLENBQUVOLFNBQVUsQ0FBQzs7UUFFaEc7UUFDQSxNQUFNTyxVQUFVLEdBQUd2Qyw0QkFBNEIsQ0FBQ3dDLFFBQVEsQ0FBQ0MseUJBQXlCLENBQUNKLEtBQUssQ0FBQ0ssa0JBQWtCLENBQUNMLEtBQUs7UUFDakhFLFVBQVUsQ0FBQ0ksZUFBZSxDQUFDQyxJQUFJLENBQUViLElBQUssQ0FBQzs7UUFFdkM7UUFDQSxJQUFLdkIsTUFBTSxDQUFDcUMsZ0JBQWdCLENBQUVkLElBQUssQ0FBQyxFQUFHO1VBRXJDO1VBQ0F2QixNQUFNLENBQUNzQyxZQUFZLENBQUNDLE1BQU0sQ0FBRWhCLElBQUssQ0FBQzs7VUFFbEM7VUFDQSxNQUFNaUIsUUFBUSxHQUFHaEQsNEJBQTRCLENBQUNpRCxlQUFlLENBQUNoRCxXQUFXLENBQUU4QixJQUFJLENBQUNtQixFQUFFLENBQUU7VUFFcEYsSUFBS0YsUUFBUSxFQUFHO1lBQ2RBLFFBQVEsQ0FBQ0csWUFBWSxDQUFDQyxLQUFLLENBQUV0QixLQUFLLEVBQUVrQixRQUFTLENBQUM7VUFDaEQ7UUFDRjtNQUNGLENBQUM7O01BRUQ7TUFDQXJDLFVBQVUsQ0FBQzBDLFFBQVEsQ0FBQzlDLE9BQU8sQ0FBRSxNQUFNO1FBRWpDO1FBQ0FJLFVBQVUsQ0FBQzJDLGdCQUFnQixDQUFFO1VBQzNCQyxJQUFJLEVBQUV6QixLQUFLLElBQUk7WUFDYixJQUFJLENBQUMwQixxQkFBcUIsQ0FBQyxDQUFDOztZQUU1QjtZQUNBLE1BQU14QixTQUFTLEdBQUcsSUFBSSxDQUFDQyxrQkFBa0IsQ0FBRUgsS0FBSyxDQUFDSSxPQUFPLENBQUNDLEtBQU0sQ0FBQztZQUNoRSxNQUFNc0IsVUFBVSxHQUFHOUQsWUFBWSxDQUFDZSxvQkFBb0IsQ0FBQzRCLG1CQUFtQixDQUFFTixTQUFVLENBQUM7WUFDckYsSUFBSUQsSUFBSSxHQUFHLElBQUksQ0FBQzJCLFdBQVcsQ0FBRUQsVUFBVSxFQUFFRSxNQUFNLENBQUNDLGlCQUFpQixFQUFFcEQsTUFBTSxDQUFDcUQsT0FBUSxDQUFDLENBQUMsQ0FBQzs7WUFFckY7WUFDQTtZQUNBLElBQUssQ0FBQ3JELE1BQU0sQ0FBQ3NDLFlBQVksQ0FBQ2dCLFFBQVEsQ0FBRS9CLElBQUssQ0FBQyxFQUFHO2NBQzNDLElBQUt2QixNQUFNLENBQUNzQyxZQUFZLENBQUNyQixNQUFNLEVBQUc7Z0JBQ2hDTSxJQUFJLEdBQUd2QixNQUFNLENBQUNzQyxZQUFZLENBQUUsQ0FBQyxDQUFFO2NBQ2pDLENBQUMsTUFDSTtnQkFDSDtjQUNGO1lBQ0Y7WUFDQWpCLG9CQUFvQixDQUFFQyxLQUFLLEVBQUVDLElBQUssQ0FBQztVQUNyQztRQUNGLENBQUUsQ0FBQztNQUVMLENBQUUsQ0FBQztNQUNIN0IsUUFBUSxDQUFDRyxRQUFRLENBQUVJLFdBQVksQ0FBQztNQUNoQ04sV0FBVyxDQUFDRSxRQUFRLENBQUVNLFVBQVcsQ0FBQzs7TUFFbEM7TUFDQSxNQUFNb0QsdUJBQXVCLEdBQUdoQyxJQUFJLElBQUk7UUFFdEM7UUFDQSxJQUFLOUIsV0FBVyxDQUFFOEIsSUFBSSxDQUFDbUIsRUFBRSxDQUFFLEVBQUc7VUFDNUIsSUFBSSxDQUFDOUMsU0FBUyxDQUFDNEQsV0FBVyxDQUFFL0QsV0FBVyxDQUFFOEIsSUFBSSxDQUFDbUIsRUFBRSxDQUFHLENBQUM7VUFDcERqRCxXQUFXLENBQUU4QixJQUFJLENBQUNtQixFQUFFLENBQUUsQ0FBQ2UsT0FBTyxDQUFDLENBQUM7VUFDaEMsT0FBT2hFLFdBQVcsQ0FBRThCLElBQUksQ0FBQ21CLEVBQUUsQ0FBRTtRQUMvQjs7UUFFQTtRQUNBLElBQUsxQyxNQUFNLENBQUNxQyxnQkFBZ0IsQ0FBRWQsSUFBSyxDQUFDLEVBQUc7VUFDckN2QixNQUFNLENBQUMwRCxjQUFjLENBQUVuQyxJQUFJLEVBQUUsS0FBTSxDQUFDO1FBQ3RDO01BQ0YsQ0FBQzs7TUFFRDtNQUNBLE1BQU1vQyxxQkFBcUIsR0FBR3BDLElBQUksSUFBSTtRQUVwQztRQUNBLE1BQU1pQixRQUFRLEdBQUcsSUFBSXBELFFBQVEsQ0FBRW1DLElBQUssQ0FBQzs7UUFFckM7UUFDQTlCLFdBQVcsQ0FBRThCLElBQUksQ0FBQ21CLEVBQUUsQ0FBRSxHQUFHRixRQUFROztRQUVqQztRQUNBLElBQUksQ0FBQzVDLFNBQVMsQ0FBQ0MsUUFBUSxDQUFFMkMsUUFBUyxDQUFDO1FBQ25DeEMsTUFBTSxDQUFDNEQsU0FBUyxDQUFFckMsSUFBSSxFQUFFLEtBQU0sQ0FBQzs7UUFFL0I7UUFDQTtRQUNBaUIsUUFBUSxDQUFDTSxnQkFBZ0IsQ0FBRTlELFlBQVksQ0FBQzZFLHdCQUF3QixDQUFFdkMsS0FBSyxJQUFJO1VBQ3pFRCxvQkFBb0IsQ0FBRUMsS0FBSyxFQUFFQyxJQUFLLENBQUM7UUFDckMsQ0FBQyxFQUFFO1VBQ0R1QyxjQUFjLEVBQUU7UUFDbEIsQ0FBRSxDQUFFLENBQUM7TUFDUCxDQUFDOztNQUVEO01BQ0E5RCxNQUFNLENBQUNnQixlQUFlLENBQUMsQ0FBQyxDQUFDakIsT0FBTyxDQUFFNEQscUJBQXNCLENBQUM7TUFDekQzRCxNQUFNLENBQUMrRCxTQUFTLEdBQUcvRCxNQUFNLENBQUNnQixlQUFlLENBQUMsQ0FBQztNQUMzQ2hCLE1BQU0sQ0FBQ2dFLGNBQWMsQ0FBQyxDQUFDOztNQUV2QjtNQUNBaEUsTUFBTSxDQUFDc0MsWUFBWSxDQUFDMkIsb0JBQW9CLENBQUVOLHFCQUFzQixDQUFDO01BQ2pFM0QsTUFBTSxDQUFDc0MsWUFBWSxDQUFDNEIsc0JBQXNCLENBQUVYLHVCQUF3QixDQUFDO0lBQ3ZFLENBQUUsQ0FBQztJQUNIWSxNQUFNLElBQUlBLE1BQU0sQ0FBRTVFLEdBQUcsQ0FBQzZFLFNBQVMsQ0FBQ25ELE1BQU0sS0FBSyxDQUFFLENBQUM7RUFDaEQ7O0VBRUE7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VpQyxXQUFXQSxDQUFFRCxVQUFVLEVBQUVvQixTQUFTLEVBQUVoQixPQUFPLEVBQUc7SUFDNUNjLE1BQU0sSUFBSUEsTUFBTSxDQUFFRSxTQUFVLENBQUM7SUFFN0IsTUFBTUMsZ0JBQWdCLEdBQUdELFNBQVMsR0FBR0EsU0FBUztJQUU5QyxNQUFNRSxLQUFLLEdBQUcsSUFBSSxDQUFDaEYsR0FBRyxDQUFDZ0YsS0FBSztJQUM1QixNQUFNQyxRQUFRLEdBQUdELEtBQUssQ0FBQ3RELE1BQU07SUFFN0IsSUFBSXdELElBQUksR0FBRyxJQUFJO0lBQ2YsSUFBSUMsbUJBQW1CLEdBQUdKLGdCQUFnQixDQUFDLENBQUM7O0lBRTVDLE1BQU05RCxDQUFDLEdBQUd5QyxVQUFVLENBQUN6QyxDQUFDO0lBQ3RCLE1BQU1FLENBQUMsR0FBR3VDLFVBQVUsQ0FBQ3ZDLENBQUM7O0lBRXRCO0lBQ0EsS0FBTSxJQUFJaUUsQ0FBQyxHQUFHLENBQUMsRUFBRUEsQ0FBQyxHQUFHSCxRQUFRLEVBQUVHLENBQUMsRUFBRSxFQUFHO01BQ25DLE1BQU1wRCxJQUFJLEdBQUdnRCxLQUFLLENBQUVJLENBQUMsQ0FBRTtNQUN2QixNQUFNQyxRQUFRLEdBQUdyRCxJQUFJLENBQUNLLGdCQUFnQixDQUFDaUQsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztNQUU5QyxNQUFNQyxFQUFFLEdBQUd0RSxDQUFDLEdBQUdvRSxRQUFRLENBQUNwRSxDQUFDO01BQ3pCLE1BQU11RSxFQUFFLEdBQUdyRSxDQUFDLEdBQUdrRSxRQUFRLENBQUNsRSxDQUFDOztNQUV6QjtNQUNBLE1BQU1zRSxlQUFlLEdBQUdGLEVBQUUsR0FBR0EsRUFBRSxHQUFHQyxFQUFFLEdBQUdBLEVBQUUsR0FBR3hELElBQUksQ0FBQzBELGNBQWMsR0FBRzFELElBQUksQ0FBQzBELGNBQWM7TUFFckYsSUFBS0QsZUFBZSxHQUFHTixtQkFBbUIsSUFBTXJCLE9BQU8sSUFBSTlCLElBQUksQ0FBQzhCLE9BQU8sS0FBS0EsT0FBUyxFQUFHO1FBQ3RGO01BQ0Y7TUFFQXFCLG1CQUFtQixHQUFHTSxlQUFlO01BQ3JDUCxJQUFJLEdBQUdsRCxJQUFJO0lBQ2I7SUFFQSxPQUFPa0QsSUFBSTtFQUNiO0FBQ0Y7QUFFQXZGLGNBQWMsQ0FBQ2dHLFFBQVEsQ0FBRSxTQUFTLEVBQUU3RixPQUFRLENBQUM7QUFDN0MsZUFBZUEsT0FBTyJ9