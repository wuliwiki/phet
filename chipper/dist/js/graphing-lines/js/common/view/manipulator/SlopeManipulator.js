// Copyright 2013-2023, University of Colorado Boulder

/**
 * Manipulator for changing a line's slope.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Utils from '../../../../../dot/js/Utils.js';
import Vector2 from '../../../../../dot/js/Vector2.js';
import { DragListener } from '../../../../../scenery/js/imports.js';
import graphingLines from '../../../graphingLines.js';
import GLColors from '../../GLColors.js';
import Line from '../../model/Line.js';
import Manipulator from './Manipulator.js';
export default class SlopeManipulator extends Manipulator {
  constructor(radius, lineProperty, riseRangeProperty, runRangeProperty, modelViewTransform) {
    super(radius, GLColors.SLOPE, {
      haloAlpha: GLColors.HALO_ALPHA.slope
    });

    // move the manipulator to match the line's slope
    const lineObserver = line => {
      this.translation = modelViewTransform.modelToViewPosition(new Vector2(line.x2, line.y2));
    };
    lineProperty.link(lineObserver); // unlink in dispose

    this.addInputListener(new SlopeDragListener(this, lineProperty, riseRangeProperty, runRangeProperty, modelViewTransform));
    this.disposeSlopeManipulator = () => {
      lineProperty.unlink(lineObserver);
    };
  }
  dispose() {
    this.disposeSlopeManipulator();
    super.dispose();
  }
}

/**
 * Drag listener for slope manipulator.
 */
class SlopeDragListener extends DragListener {
  constructor(targetNode, lineProperty, riseRangeProperty, runRangeProperty, modelViewTransform) {
    let startOffset; // where the drag started, relative to the slope manipulator, in parent view coordinates

    super({
      allowTouchSnag: true,
      // note where the drag started
      start: event => {
        const line = lineProperty.value;
        const position = modelViewTransform.modelToViewXY(line.x2, line.y2);
        startOffset = targetNode.globalToParentPoint(event.pointer.point).minus(position);
      },
      drag: event => {
        const parentPoint = targetNode.globalToParentPoint(event.pointer.point).minus(startOffset);
        const position = modelViewTransform.viewToModelPosition(parentPoint);
        // constrain to dynamic range, snap to grid
        const line = lineProperty.value;
        const run = Utils.roundSymmetric(Utils.clamp(position.x - line.x1, runRangeProperty.value.min, runRangeProperty.value.max));
        const rise = Utils.roundSymmetric(Utils.clamp(position.y - line.y1, riseRangeProperty.value.min, riseRangeProperty.value.max));
        // don't allow slope=0/0, undefined line
        if (rise !== 0 || run !== 0) {
          lineProperty.value = Line.createPointSlope(line.x1, line.y1, rise, run, line.color);
        }
      }
    });
  }
}
graphingLines.register('SlopeManipulator', SlopeManipulator);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVdGlscyIsIlZlY3RvcjIiLCJEcmFnTGlzdGVuZXIiLCJncmFwaGluZ0xpbmVzIiwiR0xDb2xvcnMiLCJMaW5lIiwiTWFuaXB1bGF0b3IiLCJTbG9wZU1hbmlwdWxhdG9yIiwiY29uc3RydWN0b3IiLCJyYWRpdXMiLCJsaW5lUHJvcGVydHkiLCJyaXNlUmFuZ2VQcm9wZXJ0eSIsInJ1blJhbmdlUHJvcGVydHkiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJTTE9QRSIsImhhbG9BbHBoYSIsIkhBTE9fQUxQSEEiLCJzbG9wZSIsImxpbmVPYnNlcnZlciIsImxpbmUiLCJ0cmFuc2xhdGlvbiIsIm1vZGVsVG9WaWV3UG9zaXRpb24iLCJ4MiIsInkyIiwibGluayIsImFkZElucHV0TGlzdGVuZXIiLCJTbG9wZURyYWdMaXN0ZW5lciIsImRpc3Bvc2VTbG9wZU1hbmlwdWxhdG9yIiwidW5saW5rIiwiZGlzcG9zZSIsInRhcmdldE5vZGUiLCJzdGFydE9mZnNldCIsImFsbG93VG91Y2hTbmFnIiwic3RhcnQiLCJldmVudCIsInZhbHVlIiwicG9zaXRpb24iLCJtb2RlbFRvVmlld1hZIiwiZ2xvYmFsVG9QYXJlbnRQb2ludCIsInBvaW50ZXIiLCJwb2ludCIsIm1pbnVzIiwiZHJhZyIsInBhcmVudFBvaW50Iiwidmlld1RvTW9kZWxQb3NpdGlvbiIsInJ1biIsInJvdW5kU3ltbWV0cmljIiwiY2xhbXAiLCJ4IiwieDEiLCJtaW4iLCJtYXgiLCJyaXNlIiwieSIsInkxIiwiY3JlYXRlUG9pbnRTbG9wZSIsImNvbG9yIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJTbG9wZU1hbmlwdWxhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIE1hbmlwdWxhdG9yIGZvciBjaGFuZ2luZyBhIGxpbmUncyBzbG9wZS5cclxuICpcclxuICogQGF1dGhvciBDaHJpcyBNYWxsZXkgKFBpeGVsWm9vbSwgSW5jLilcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBUUmVhZE9ubHlQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi8uLi9heG9uL2pzL1RSZWFkT25seVByb3BlcnR5LmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi8uLi8uLi8uLi9kb3QvanMvVXRpbHMuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBNb2RlbFZpZXdUcmFuc2Zvcm0yIGZyb20gJy4uLy4uLy4uLy4uLy4uL3BoZXRjb21tb24vanMvdmlldy9Nb2RlbFZpZXdUcmFuc2Zvcm0yLmpzJztcclxuaW1wb3J0IHsgRHJhZ0xpc3RlbmVyLCBOb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IGdyYXBoaW5nTGluZXMgZnJvbSAnLi4vLi4vLi4vZ3JhcGhpbmdMaW5lcy5qcyc7XHJcbmltcG9ydCBHTENvbG9ycyBmcm9tICcuLi8uLi9HTENvbG9ycy5qcyc7XHJcbmltcG9ydCBMaW5lIGZyb20gJy4uLy4uL21vZGVsL0xpbmUuanMnO1xyXG5pbXBvcnQgTWFuaXB1bGF0b3IgZnJvbSAnLi9NYW5pcHVsYXRvci5qcyc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTbG9wZU1hbmlwdWxhdG9yIGV4dGVuZHMgTWFuaXB1bGF0b3Ige1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2VTbG9wZU1hbmlwdWxhdG9yOiAoKSA9PiB2b2lkO1xyXG5cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIHJhZGl1czogbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgbGluZVByb3BlcnR5OiBQcm9wZXJ0eTxMaW5lPixcclxuICAgICAgICAgICAgICAgICAgICAgIHJpc2VSYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBydW5SYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIgKSB7XHJcblxyXG4gICAgc3VwZXIoIHJhZGl1cywgR0xDb2xvcnMuU0xPUEUsIHsgaGFsb0FscGhhOiBHTENvbG9ycy5IQUxPX0FMUEhBLnNsb3BlIH0gKTtcclxuXHJcbiAgICAvLyBtb3ZlIHRoZSBtYW5pcHVsYXRvciB0byBtYXRjaCB0aGUgbGluZSdzIHNsb3BlXHJcbiAgICBjb25zdCBsaW5lT2JzZXJ2ZXIgPSAoIGxpbmU6IExpbmUgKSA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb24gPSBtb2RlbFZpZXdUcmFuc2Zvcm0ubW9kZWxUb1ZpZXdQb3NpdGlvbiggbmV3IFZlY3RvcjIoIGxpbmUueDIsIGxpbmUueTIgKSApO1xyXG4gICAgfTtcclxuICAgIGxpbmVQcm9wZXJ0eS5saW5rKCBsaW5lT2JzZXJ2ZXIgKTsgLy8gdW5saW5rIGluIGRpc3Bvc2VcclxuXHJcbiAgICB0aGlzLmFkZElucHV0TGlzdGVuZXIoIG5ldyBTbG9wZURyYWdMaXN0ZW5lciggdGhpcywgbGluZVByb3BlcnR5LCByaXNlUmFuZ2VQcm9wZXJ0eSwgcnVuUmFuZ2VQcm9wZXJ0eSwgbW9kZWxWaWV3VHJhbnNmb3JtICkgKTtcclxuXHJcbiAgICB0aGlzLmRpc3Bvc2VTbG9wZU1hbmlwdWxhdG9yID0gKCkgPT4ge1xyXG4gICAgICBsaW5lUHJvcGVydHkudW5saW5rKCBsaW5lT2JzZXJ2ZXIgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZVNsb3BlTWFuaXB1bGF0b3IoKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEcmFnIGxpc3RlbmVyIGZvciBzbG9wZSBtYW5pcHVsYXRvci5cclxuICovXHJcbmNsYXNzIFNsb3BlRHJhZ0xpc3RlbmVyIGV4dGVuZHMgRHJhZ0xpc3RlbmVyIHtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCB0YXJnZXROb2RlOiBOb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgbGluZVByb3BlcnR5OiBQcm9wZXJ0eTxMaW5lPixcclxuICAgICAgICAgICAgICAgICAgICAgIHJpc2VSYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBydW5SYW5nZVByb3BlcnR5OiBUUmVhZE9ubHlQcm9wZXJ0eTxSYW5nZT4sXHJcbiAgICAgICAgICAgICAgICAgICAgICBtb2RlbFZpZXdUcmFuc2Zvcm06IE1vZGVsVmlld1RyYW5zZm9ybTIgKSB7XHJcblxyXG4gICAgbGV0IHN0YXJ0T2Zmc2V0OiBWZWN0b3IyOyAvLyB3aGVyZSB0aGUgZHJhZyBzdGFydGVkLCByZWxhdGl2ZSB0byB0aGUgc2xvcGUgbWFuaXB1bGF0b3IsIGluIHBhcmVudCB2aWV3IGNvb3JkaW5hdGVzXHJcblxyXG4gICAgc3VwZXIoIHtcclxuXHJcbiAgICAgIGFsbG93VG91Y2hTbmFnOiB0cnVlLFxyXG5cclxuICAgICAgLy8gbm90ZSB3aGVyZSB0aGUgZHJhZyBzdGFydGVkXHJcbiAgICAgIHN0YXJ0OiBldmVudCA9PiB7XHJcbiAgICAgICAgY29uc3QgbGluZSA9IGxpbmVQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IG1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1hZKCBsaW5lLngyLCBsaW5lLnkyICk7XHJcbiAgICAgICAgc3RhcnRPZmZzZXQgPSB0YXJnZXROb2RlLmdsb2JhbFRvUGFyZW50UG9pbnQoIGV2ZW50LnBvaW50ZXIucG9pbnQgKS5taW51cyggcG9zaXRpb24gKTtcclxuICAgICAgfSxcclxuXHJcbiAgICAgIGRyYWc6IGV2ZW50ID0+IHtcclxuICAgICAgICBjb25zdCBwYXJlbnRQb2ludCA9IHRhcmdldE5vZGUuZ2xvYmFsVG9QYXJlbnRQb2ludCggZXZlbnQucG9pbnRlci5wb2ludCApLm1pbnVzKCBzdGFydE9mZnNldCApO1xyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbW9kZWxWaWV3VHJhbnNmb3JtLnZpZXdUb01vZGVsUG9zaXRpb24oIHBhcmVudFBvaW50ICk7XHJcbiAgICAgICAgLy8gY29uc3RyYWluIHRvIGR5bmFtaWMgcmFuZ2UsIHNuYXAgdG8gZ3JpZFxyXG4gICAgICAgIGNvbnN0IGxpbmUgPSBsaW5lUHJvcGVydHkudmFsdWU7XHJcbiAgICAgICAgY29uc3QgcnVuID0gVXRpbHMucm91bmRTeW1tZXRyaWMoIFV0aWxzLmNsYW1wKCBwb3NpdGlvbi54IC0gbGluZS54MSwgcnVuUmFuZ2VQcm9wZXJ0eS52YWx1ZS5taW4sIHJ1blJhbmdlUHJvcGVydHkudmFsdWUubWF4ICkgKTtcclxuICAgICAgICBjb25zdCByaXNlID0gVXRpbHMucm91bmRTeW1tZXRyaWMoIFV0aWxzLmNsYW1wKCBwb3NpdGlvbi55IC0gbGluZS55MSwgcmlzZVJhbmdlUHJvcGVydHkudmFsdWUubWluLCByaXNlUmFuZ2VQcm9wZXJ0eS52YWx1ZS5tYXggKSApO1xyXG4gICAgICAgIC8vIGRvbid0IGFsbG93IHNsb3BlPTAvMCwgdW5kZWZpbmVkIGxpbmVcclxuICAgICAgICBpZiAoIHJpc2UgIT09IDAgfHwgcnVuICE9PSAwICkge1xyXG4gICAgICAgICAgbGluZVByb3BlcnR5LnZhbHVlID0gTGluZS5jcmVhdGVQb2ludFNsb3BlKCBsaW5lLngxLCBsaW5lLnkxLCByaXNlLCBydW4sIGxpbmUuY29sb3IgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICB9XHJcbn1cclxuXHJcbmdyYXBoaW5nTGluZXMucmVnaXN0ZXIoICdTbG9wZU1hbmlwdWxhdG9yJywgU2xvcGVNYW5pcHVsYXRvciApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFLQSxPQUFPQSxLQUFLLE1BQU0sZ0NBQWdDO0FBQ2xELE9BQU9DLE9BQU8sTUFBTSxrQ0FBa0M7QUFFdEQsU0FBU0MsWUFBWSxRQUFjLHNDQUFzQztBQUN6RSxPQUFPQyxhQUFhLE1BQU0sMkJBQTJCO0FBQ3JELE9BQU9DLFFBQVEsTUFBTSxtQkFBbUI7QUFDeEMsT0FBT0MsSUFBSSxNQUFNLHFCQUFxQjtBQUN0QyxPQUFPQyxXQUFXLE1BQU0sa0JBQWtCO0FBRTFDLGVBQWUsTUFBTUMsZ0JBQWdCLFNBQVNELFdBQVcsQ0FBQztFQUlqREUsV0FBV0EsQ0FBRUMsTUFBYyxFQUNkQyxZQUE0QixFQUM1QkMsaUJBQTJDLEVBQzNDQyxnQkFBMEMsRUFDMUNDLGtCQUF1QyxFQUFHO0lBRTVELEtBQUssQ0FBRUosTUFBTSxFQUFFTCxRQUFRLENBQUNVLEtBQUssRUFBRTtNQUFFQyxTQUFTLEVBQUVYLFFBQVEsQ0FBQ1ksVUFBVSxDQUFDQztJQUFNLENBQUUsQ0FBQzs7SUFFekU7SUFDQSxNQUFNQyxZQUFZLEdBQUtDLElBQVUsSUFBTTtNQUNyQyxJQUFJLENBQUNDLFdBQVcsR0FBR1Asa0JBQWtCLENBQUNRLG1CQUFtQixDQUFFLElBQUlwQixPQUFPLENBQUVrQixJQUFJLENBQUNHLEVBQUUsRUFBRUgsSUFBSSxDQUFDSSxFQUFHLENBQUUsQ0FBQztJQUM5RixDQUFDO0lBQ0RiLFlBQVksQ0FBQ2MsSUFBSSxDQUFFTixZQUFhLENBQUMsQ0FBQyxDQUFDOztJQUVuQyxJQUFJLENBQUNPLGdCQUFnQixDQUFFLElBQUlDLGlCQUFpQixDQUFFLElBQUksRUFBRWhCLFlBQVksRUFBRUMsaUJBQWlCLEVBQUVDLGdC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