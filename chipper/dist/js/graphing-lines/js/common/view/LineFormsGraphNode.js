// Copyright 2013-2023, University of Colorado Boulder

/**
 * LineFormsGraphNode is the base class graphs in the 'Slope', 'Slope-Intercept' and 'Point-Slope' screens.
 *
 * Displays the following:
 * - one interactive line
 * - slope tool for interactive line
 * - zero or more 'saved' lines
 * - zero or more 'standard' lines
 *
 * Note: All properties of this type should be considered private.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 */

import Multilink from '../../../../axon/js/Multilink.js';
import Property from '../../../../axon/js/Property.js';
import { Node } from '../../../../scenery/js/imports.js';
import graphingLines from '../../graphingLines.js';
import GraphNode from './GraphNode.js';
import LineNode from './LineNode.js';
import SlopeToolNode from './SlopeToolNode.js';
export default class LineFormsGraphNode extends GraphNode {
  // Nodes for each category of line (interactive, standard, saved) to maintain rendering order

  constructor(model, viewProperties, createDynamicLabel) {
    super(model.graph, model.modelViewTransform);
    this.model = model;
    this.viewProperties = viewProperties;
    this.createDynamicLabel = createDynamicLabel;
    this.interactiveLineNode = new LineNode(model.interactiveLineProperty, model.graph, model.modelViewTransform, {
      createDynamicLabel: createDynamicLabel
    });
    this.standardLinesParentNode = new Node();
    this.savedLinesParentNode = new Node();
    this.slopeToolNode = new SlopeToolNode(model.interactiveLineProperty, model.modelViewTransform);

    // Rendering order. The order of lines should match the order of LineFormsModel.graph.lines.
    this.addChild(this.savedLinesParentNode);
    this.addChild(this.standardLinesParentNode);
    this.addChild(this.interactiveLineNode);
    this.addChild(this.slopeToolNode);

    // Add/remove standard lines
    // remove*Listener not needed because LineFormsGraphNode exists for the lifetime of the sim.
    model.standardLines.addItemAddedListener(this.standardLineAdded.bind(this));
    model.standardLines.addItemRemovedListener(this.standardLineRemoved.bind(this));

    // Add/remove saved lines
    // remove*Listener not needed because LineFormsGraphNode exists for the lifetime of the sim.
    model.savedLines.addItemAddedListener(this.savedLineAdded.bind(this));
    model.savedLines.addItemRemovedListener(this.savedLineRemoved.bind(this));

    // Visibility of lines
    // unmultilink is unnecessary since LineFormsGraphNode exists for the lifetime of the sim.
    Multilink.multilink([viewProperties.linesVisibleProperty, viewProperties.slopeToolVisibleProperty], this.updateLinesVisibility.bind(this));

    // Visibility of the grid
    // unlink is unnecessary since LineFormsGraphNode exists for the lifetime of the sim.
    viewProperties.gridVisibleProperty.link(visible => {
      this.setGridVisible(visible);
    });

    // Visibility of the equation on the interactive line
    // unlink is unnecessary since LineFormsGraphNode exists for the lifetime of the sim.
    this.viewProperties.interactiveEquationVisibleProperty.link(visible => {
      if (this.interactiveLineNode) {
        this.interactiveLineNode.setEquationVisible(visible);
      }
    });
  }

  // Updates the visibility of lines and associated decorations.
  updateLinesVisibility() {
    const linesVisible = this.viewProperties.linesVisibleProperty.value;

    // interactive line
    this.interactiveLineNode.visible = linesVisible;

    // saved & standard lines
    this.savedLinesParentNode.visible = linesVisible;
    this.standardLinesParentNode.visible = linesVisible;

    // slope tool
    this.slopeToolNode.visible = this.viewProperties.slopeToolVisibleProperty.value && linesVisible;
  }

  // Called when a standard line is added to the model.
  standardLineAdded(line) {
    const lineNode = new LineNode(new Property(line), this.model.graph, this.model.modelViewTransform, {
      createDynamicLabel: this.createDynamicLabel
    });
    this.standardLinesParentNode.addChild(lineNode);
  }

  // Called when a standard line is removed from the model.
  standardLineRemoved(line) {
    this.removeLineNode(line, this.standardLinesParentNode);
  }

  // Called when a saved line is added to the model.
  savedLineAdded(line) {
    const lineNode = new LineNode(new Property(line), this.model.graph, this.model.modelViewTransform, {
      createDynamicLabel: this.createDynamicLabel
    });
    this.savedLinesParentNode.addChild(lineNode);
  }

  // Called when a saved line is removed from the model.
  savedLineRemoved(line) {
    this.removeLineNode(line, this.savedLinesParentNode);
  }

  // Removes the LineNode that corresponds to the specified Line.
  removeLineNode(line, parentNode) {
    let removed = false;
    for (let i = 0; i < parentNode.getChildrenCount() && !removed; i++) {
      const node = parentNode.getChildAt(i);
      assert && assert(node instanceof LineNode); // eslint-disable-line no-simple-type-checking-assertions
      if (line === node.lineProperty.value) {
        parentNode.removeChild(node);
        node.dispose();
        removed = true;
      }
    }
    assert && assert(removed, `no Node found for line ${line.toString()}`);
  }
}
graphingLines.register('LineFormsGraphNode', LineFormsGraphNode);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJQcm9wZXJ0eSIsIk5vZGUiLCJncmFwaGluZ0xpbmVzIiwiR3JhcGhOb2RlIiwiTGluZU5vZGUiLCJTbG9wZVRvb2xOb2RlIiwiTGluZUZvcm1zR3JhcGhOb2RlIiwiY29uc3RydWN0b3IiLCJtb2RlbCIsInZpZXdQcm9wZXJ0aWVzIiwiY3JlYXRlRHluYW1pY0xhYmVsIiwiZ3JhcGgiLCJtb2RlbFZpZXdUcmFuc2Zvcm0iLCJpbnRlcmFjdGl2ZUxpbmVOb2RlIiwiaW50ZXJhY3RpdmVMaW5lUHJvcGVydHkiLCJzdGFuZGFyZExpbmVzUGFyZW50Tm9kZSIsInNhdmVkTGluZXNQYXJlbnROb2RlIiwic2xvcGVUb29sTm9kZSIsImFkZENoaWxkIiwic3RhbmRhcmRMaW5lcyIsImFkZEl0ZW1BZGRlZExpc3RlbmVyIiwic3RhbmRhcmRMaW5lQWRkZWQiLCJiaW5kIiwiYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciIsInN0YW5kYXJkTGluZVJlbW92ZWQiLCJzYXZlZExpbmVzIiwic2F2ZWRMaW5lQWRkZWQiLCJzYXZlZExpbmVSZW1vdmVkIiwibXVsdGlsaW5rIiwibGluZXNWaXNpYmxlUHJvcGVydHkiLCJzbG9wZVRvb2xWaXNpYmxlUHJvcGVydHkiLCJ1cGRhdGVMaW5lc1Zpc2liaWxpdHkiLCJncmlkVmlzaWJsZVByb3BlcnR5IiwibGluayIsInZpc2libGUiLCJzZXRHcmlkVmlzaWJsZSIsImludGVyYWN0aXZlRXF1YXRpb25WaXNpYmxlUHJvcGVydHkiLCJzZXRFcXVhdGlvblZpc2libGUiLCJsaW5lc1Zpc2libGUiLCJ2YWx1ZSIsImxpbmUiLCJsaW5lTm9kZSIsInJlbW92ZUxpbmVOb2RlIiwicGFyZW50Tm9kZSIsInJlbW92ZWQiLCJpIiwiZ2V0Q2hpbGRyZW5Db3VudCIsIm5vZGUiLCJnZXRDaGlsZEF0IiwiYXNzZXJ0IiwibGluZVByb3BlcnR5IiwicmVtb3ZlQ2hpbGQiLCJkaXNwb3NlIiwidG9TdHJpbmciLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkxpbmVGb3Jtc0dyYXBoTm9kZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxMy0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBMaW5lRm9ybXNHcmFwaE5vZGUgaXMgdGhlIGJhc2UgY2xhc3MgZ3JhcGhzIGluIHRoZSAnU2xvcGUnLCAnU2xvcGUtSW50ZXJjZXB0JyBhbmQgJ1BvaW50LVNsb3BlJyBzY3JlZW5zLlxyXG4gKlxyXG4gKiBEaXNwbGF5cyB0aGUgZm9sbG93aW5nOlxyXG4gKiAtIG9uZSBpbnRlcmFjdGl2ZSBsaW5lXHJcbiAqIC0gc2xvcGUgdG9vbCBmb3IgaW50ZXJhY3RpdmUgbGluZVxyXG4gKiAtIHplcm8gb3IgbW9yZSAnc2F2ZWQnIGxpbmVzXHJcbiAqIC0gemVybyBvciBtb3JlICdzdGFuZGFyZCcgbGluZXNcclxuICpcclxuICogTm90ZTogQWxsIHByb3BlcnRpZXMgb2YgdGhpcyB0eXBlIHNob3VsZCBiZSBjb25zaWRlcmVkIHByaXZhdGUuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqL1xyXG5cclxuaW1wb3J0IE11bHRpbGluayBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL011bHRpbGluay5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IHsgTm9kZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBncmFwaGluZ0xpbmVzIGZyb20gJy4uLy4uL2dyYXBoaW5nTGluZXMuanMnO1xyXG5pbXBvcnQgTGluZUZvcm1zTW9kZWwgZnJvbSAnLi4vbW9kZWwvTGluZUZvcm1zTW9kZWwuanMnO1xyXG5pbXBvcnQgR3JhcGhOb2RlIGZyb20gJy4vR3JhcGhOb2RlLmpzJztcclxuaW1wb3J0IExpbmVOb2RlLCB7IENyZWF0ZUR5bmFtaWNMYWJlbEZ1bmN0aW9uIH0gZnJvbSAnLi9MaW5lTm9kZS5qcyc7XHJcbmltcG9ydCBTbG9wZVRvb2xOb2RlIGZyb20gJy4vU2xvcGVUb29sTm9kZS5qcyc7XHJcbmltcG9ydCBMaW5lRm9ybXNWaWV3UHJvcGVydGllcyBmcm9tICcuL0xpbmVGb3Jtc1ZpZXdQcm9wZXJ0aWVzLmpzJztcclxuaW1wb3J0IExpbmUgZnJvbSAnLi4vbW9kZWwvTGluZS5qcyc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMaW5lRm9ybXNHcmFwaE5vZGUgZXh0ZW5kcyBHcmFwaE5vZGUge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBMaW5lRm9ybXNNb2RlbDtcclxuICBwcml2YXRlIHJlYWRvbmx5IHZpZXdQcm9wZXJ0aWVzOiBMaW5lRm9ybXNWaWV3UHJvcGVydGllcztcclxuICBwcml2YXRlIHJlYWRvbmx5IGNyZWF0ZUR5bmFtaWNMYWJlbDogQ3JlYXRlRHluYW1pY0xhYmVsRnVuY3Rpb247XHJcblxyXG4gIC8vIE5vZGVzIGZvciBlYWNoIGNhdGVnb3J5IG9mIGxpbmUgKGludGVyYWN0aXZlLCBzdGFuZGFyZCwgc2F2ZWQpIHRvIG1haW50YWluIHJlbmRlcmluZyBvcmRlclxyXG4gIHByaXZhdGUgcmVhZG9ubHkgaW50ZXJhY3RpdmVMaW5lTm9kZTogTGluZU5vZGU7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFuZGFyZExpbmVzUGFyZW50Tm9kZTogTm9kZTtcclxuICBwcml2YXRlIHJlYWRvbmx5IHNhdmVkTGluZXNQYXJlbnROb2RlOiBOb2RlO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHNsb3BlVG9vbE5vZGU6IFNsb3BlVG9vbE5vZGU7XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvciggbW9kZWw6IExpbmVGb3Jtc01vZGVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgdmlld1Byb3BlcnRpZXM6IExpbmVGb3Jtc1ZpZXdQcm9wZXJ0aWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlRHluYW1pY0xhYmVsOiBDcmVhdGVEeW5hbWljTGFiZWxGdW5jdGlvbiApIHtcclxuXHJcbiAgICBzdXBlciggbW9kZWwuZ3JhcGgsIG1vZGVsLm1vZGVsVmlld1RyYW5zZm9ybSApO1xyXG5cclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuICAgIHRoaXMudmlld1Byb3BlcnRpZXMgPSB2aWV3UHJvcGVydGllcztcclxuICAgIHRoaXMuY3JlYXRlRHluYW1pY0xhYmVsID0gY3JlYXRlRHluYW1pY0xhYmVsO1xyXG5cclxuICAgIHRoaXMuaW50ZXJhY3RpdmVMaW5lTm9kZSA9IG5ldyBMaW5lTm9kZSggbW9kZWwuaW50ZXJhY3RpdmVMaW5lUHJvcGVydHksIG1vZGVsLmdyYXBoLCBtb2RlbC5tb2RlbFZpZXdUcmFuc2Zvcm0sIHtcclxuICAgICAgY3JlYXRlRHluYW1pY0xhYmVsOiBjcmVhdGVEeW5hbWljTGFiZWxcclxuICAgIH0gKTtcclxuICAgIHRoaXMuc3RhbmRhcmRMaW5lc1BhcmVudE5vZGUgPSBuZXcgTm9kZSgpO1xyXG4gICAgdGhpcy5zYXZlZExpbmVzUGFyZW50Tm9kZSA9IG5ldyBOb2RlKCk7XHJcblxyXG4gICAgdGhpcy5zbG9wZVRvb2xOb2RlID0gbmV3IFNsb3BlVG9vbE5vZGUoIG1vZGVsLmludGVyYWN0aXZlTGluZVByb3BlcnR5LCBtb2RlbC5tb2RlbFZpZXdUcmFuc2Zvcm0gKTtcclxuXHJcbiAgICAvLyBSZW5kZXJpbmcgb3JkZXIuIFRoZSBvcmRlciBvZiBsaW5lcyBzaG91bGQgbWF0Y2ggdGhlIG9yZGVyIG9mIExpbmVGb3Jtc01vZGVsLmdyYXBoLmxpbmVzLlxyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5zYXZlZExpbmVzUGFyZW50Tm9kZSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5zdGFuZGFyZExpbmVzUGFyZW50Tm9kZSApO1xyXG4gICAgdGhpcy5hZGRDaGlsZCggdGhpcy5pbnRlcmFjdGl2ZUxpbmVOb2RlICk7XHJcbiAgICB0aGlzLmFkZENoaWxkKCB0aGlzLnNsb3BlVG9vbE5vZGUgKTtcclxuXHJcbiAgICAvLyBBZGQvcmVtb3ZlIHN0YW5kYXJkIGxpbmVzXHJcbiAgICAvLyByZW1vdmUqTGlzdGVuZXIgbm90IG5lZWRlZCBiZWNhdXNlIExpbmVGb3Jtc0dyYXBoTm9kZSBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltLlxyXG4gICAgbW9kZWwuc3RhbmRhcmRMaW5lcy5hZGRJdGVtQWRkZWRMaXN0ZW5lciggdGhpcy5zdGFuZGFyZExpbmVBZGRlZC5iaW5kKCB0aGlzICkgKTtcclxuICAgIG1vZGVsLnN0YW5kYXJkTGluZXMuYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciggdGhpcy5zdGFuZGFyZExpbmVSZW1vdmVkLmJpbmQoIHRoaXMgKSApO1xyXG5cclxuICAgIC8vIEFkZC9yZW1vdmUgc2F2ZWQgbGluZXNcclxuICAgIC8vIHJlbW92ZSpMaXN0ZW5lciBub3QgbmVlZGVkIGJlY2F1c2UgTGluZUZvcm1zR3JhcGhOb2RlIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICBtb2RlbC5zYXZlZExpbmVzLmFkZEl0ZW1BZGRlZExpc3RlbmVyKCB0aGlzLnNhdmVkTGluZUFkZGVkLmJpbmQoIHRoaXMgKSApO1xyXG4gICAgbW9kZWwuc2F2ZWRMaW5lcy5hZGRJdGVtUmVtb3ZlZExpc3RlbmVyKCB0aGlzLnNhdmVkTGluZVJlbW92ZWQuYmluZCggdGhpcyApICk7XHJcblxyXG4gICAgLy8gVmlzaWJpbGl0eSBvZiBsaW5lc1xyXG4gICAgLy8gdW5tdWx0aWxpbmsgaXMgdW5uZWNlc3Nhcnkgc2luY2UgTGluZUZvcm1zR3JhcGhOb2RlIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbIHZpZXdQcm9wZXJ0aWVzLmxpbmVzVmlzaWJsZVByb3BlcnR5LCB2aWV3UHJvcGVydGllcy5zbG9wZVRvb2xWaXNpYmxlUHJvcGVydHkgXSxcclxuICAgICAgdGhpcy51cGRhdGVMaW5lc1Zpc2liaWxpdHkuYmluZCggdGhpcyApICk7XHJcblxyXG4gICAgLy8gVmlzaWJpbGl0eSBvZiB0aGUgZ3JpZFxyXG4gICAgLy8gdW5saW5rIGlzIHVubmVjZXNzYXJ5IHNpbmNlIExpbmVGb3Jtc0dyYXBoTm9kZSBleGlzdHMgZm9yIHRoZSBsaWZldGltZSBvZiB0aGUgc2ltLlxyXG4gICAgdmlld1Byb3BlcnRpZXMuZ3JpZFZpc2libGVQcm9wZXJ0eS5saW5rKCB2aXNpYmxlID0+IHtcclxuICAgICAgdGhpcy5zZXRHcmlkVmlzaWJsZSggdmlzaWJsZSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFZpc2liaWxpdHkgb2YgdGhlIGVxdWF0aW9uIG9uIHRoZSBpbnRlcmFjdGl2ZSBsaW5lXHJcbiAgICAvLyB1bmxpbmsgaXMgdW5uZWNlc3Nhcnkgc2luY2UgTGluZUZvcm1zR3JhcGhOb2RlIGV4aXN0cyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzaW0uXHJcbiAgICB0aGlzLnZpZXdQcm9wZXJ0aWVzLmludGVyYWN0aXZlRXF1YXRpb25WaXNpYmxlUHJvcGVydHkubGluayggdmlzaWJsZSA9PiB7XHJcbiAgICAgIGlmICggdGhpcy5pbnRlcmFjdGl2ZUxpbmVOb2RlICkge1xyXG4gICAgICAgIHRoaXMuaW50ZXJhY3RpdmVMaW5lTm9kZS5zZXRFcXVhdGlvblZpc2libGUoIHZpc2libGUgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLy8gVXBkYXRlcyB0aGUgdmlzaWJpbGl0eSBvZiBsaW5lcyBhbmQgYXNzb2NpYXRlZCBkZWNvcmF0aW9ucy5cclxuICBwcml2YXRlIHVwZGF0ZUxpbmVzVmlzaWJpbGl0eSgpOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBsaW5lc1Zpc2libGUgPSB0aGlzLnZpZXdQcm9wZXJ0aWVzLmxpbmVzVmlzaWJsZVByb3BlcnR5LnZhbHVlO1xyXG5cclxuICAgIC8vIGludGVyYWN0aXZlIGxpbmVcclxuICAgIHRoaXMuaW50ZXJhY3RpdmVMaW5lTm9kZS52aXNpYmxlID0gbGluZXNWaXNpYmxlO1xyXG5cclxuICAgIC8vIHNhdmVkICYgc3RhbmRhcmQgbGluZXNcclxuICAgIHRoaXMuc2F2ZWRMaW5lc1BhcmVudE5vZGUudmlzaWJsZSA9IGxpbmVzVmlzaWJsZTtcclxuICAgIHRoaXMuc3RhbmRhcmRMaW5lc1BhcmVudE5vZGUudmlzaWJsZSA9IGxpbmVzVmlzaWJsZTtcclxuXHJcbiAgICAvLyBzbG9wZSB0b29sXHJcbiAgICB0aGlzLnNsb3BlVG9vbE5vZGUudmlzaWJsZSA9ICggdGhpcy52aWV3UHJvcGVydGllcy5zbG9wZVRvb2xWaXNpYmxlUHJvcGVydHkudmFsdWUgJiYgbGluZXNWaXNpYmxlICk7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxsZWQgd2hlbiBhIHN0YW5kYXJkIGxpbmUgaXMgYWRkZWQgdG8gdGhlIG1vZGVsLlxyXG4gIHByaXZhdGUgc3RhbmRhcmRMaW5lQWRkZWQoIGxpbmU6IExpbmUgKTogdm9pZCB7XHJcbiAgICBjb25zdCBsaW5lTm9kZSA9IG5ldyBMaW5lTm9kZSggbmV3IFByb3BlcnR5KCBsaW5lICksIHRoaXMubW9kZWwuZ3JhcGgsIHRoaXMubW9kZWwubW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgIGNyZWF0ZUR5bmFtaWNMYWJlbDogdGhpcy5jcmVhdGVEeW5hbWljTGFiZWxcclxuICAgIH0gKTtcclxuICAgIHRoaXMuc3RhbmRhcmRMaW5lc1BhcmVudE5vZGUuYWRkQ2hpbGQoIGxpbmVOb2RlICk7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxsZWQgd2hlbiBhIHN0YW5kYXJkIGxpbmUgaXMgcmVtb3ZlZCBmcm9tIHRoZSBtb2RlbC5cclxuICBwcml2YXRlIHN0YW5kYXJkTGluZVJlbW92ZWQoIGxpbmU6IExpbmUgKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlbW92ZUxpbmVOb2RlKCBsaW5lLCB0aGlzLnN0YW5kYXJkTGluZXNQYXJlbnROb2RlICk7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxsZWQgd2hlbiBhIHNhdmVkIGxpbmUgaXMgYWRkZWQgdG8gdGhlIG1vZGVsLlxyXG4gIHByaXZhdGUgc2F2ZWRMaW5lQWRkZWQoIGxpbmU6IExpbmUgKTogdm9pZCB7XHJcbiAgICBjb25zdCBsaW5lTm9kZSA9IG5ldyBMaW5lTm9kZSggbmV3IFByb3BlcnR5KCBsaW5lICksIHRoaXMubW9kZWwuZ3JhcGgsIHRoaXMubW9kZWwubW9kZWxWaWV3VHJhbnNmb3JtLCB7XHJcbiAgICAgIGNyZWF0ZUR5bmFtaWNMYWJlbDogdGhpcy5jcmVhdGVEeW5hbWljTGFiZWxcclxuICAgIH0gKTtcclxuICAgIHRoaXMuc2F2ZWRMaW5lc1BhcmVudE5vZGUuYWRkQ2hpbGQoIGxpbmVOb2RlICk7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxsZWQgd2hlbiBhIHNhdmVkIGxpbmUgaXMgcmVtb3ZlZCBmcm9tIHRoZSBtb2RlbC5cclxuICBwcml2YXRlIHNhdmVkTGluZVJlbW92ZWQoIGxpbmU6IExpbmUgKTogdm9pZCB7XHJcbiAgICB0aGlzLnJlbW92ZUxpbmVOb2RlKCBsaW5lLCB0aGlzLnNhdmVkTGluZXNQYXJlbnROb2RlICk7XHJcbiAgfVxyXG5cclxuICAvLyBSZW1vdmVzIHRoZSBMaW5lTm9kZSB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBzcGVjaWZpZWQgTGluZS5cclxuICBwcml2YXRlIHJlbW92ZUxpbmVOb2RlKCBsaW5lOiBMaW5lLCBwYXJlbnROb2RlOiBOb2RlICk6IHZvaWQge1xyXG4gICAgbGV0IHJlbW92ZWQgPSBmYWxzZTtcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHBhcmVudE5vZGUuZ2V0Q2hpbGRyZW5Db3VudCgpICYmICFyZW1vdmVkOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IG5vZGUgPSBwYXJlbnROb2RlLmdldENoaWxkQXQoIGkgKSBhcyBMaW5lTm9kZTtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggbm9kZSBpbnN0YW5jZW9mIExpbmVOb2RlICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2ltcGxlLXR5cGUtY2hlY2tpbmctYXNzZXJ0aW9uc1xyXG4gICAgICBpZiAoIGxpbmUgPT09IG5vZGUubGluZVByb3BlcnR5LnZhbHVlICkge1xyXG4gICAgICAgIHBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIG5vZGUgKTtcclxuICAgICAgICBub2RlLmRpc3Bvc2UoKTtcclxuICAgICAgICByZW1vdmVkID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggcmVtb3ZlZCwgYG5vIE5vZGUgZm91bmQgZm9yIGxpbmUgJHtsaW5lLnRvU3RyaW5nKCl9YCApO1xyXG4gIH1cclxufVxyXG5cclxuZ3JhcGhpbmdMaW5lcy5yZWdpc3RlciggJ0xpbmVGb3Jtc0dyYXBoTm9kZScsIExpbmVGb3Jtc0dyYXBoTm9kZSApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsU0FBUyxNQUFNLGtDQUFrQztBQUN4RCxPQUFPQyxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELFNBQVNDLElBQUksUUFBUSxtQ0FBbUM7QUFDeEQsT0FBT0MsYUFBYSxNQUFNLHdCQUF3QjtBQUVsRCxPQUFPQyxTQUFTLE1BQU0sZ0JBQWdCO0FBQ3RDLE9BQU9DLFFBQVEsTUFBc0MsZUFBZTtBQUNwRSxPQUFPQyxhQUFhLE1BQU0sb0JBQW9CO0FBSTlDLGVBQWUsTUFBTUMsa0JBQWtCLFNBQVNILFNBQVMsQ0FBQztFQU14RDs7RUFPVUksV0FBV0EsQ0FBRUMsS0FBcUIsRUFDckJDLGNBQXVDLEVBQ3ZDQyxrQkFBOEMsRUFBRztJQUV0RSxLQUFLLENBQUVGLEtBQUssQ0FBQ0csS0FBSyxFQUFFSCxLQUFLLENBQUNJLGtCQUFtQixDQUFDO0lBRTlDLElBQUksQ0FBQ0osS0FBSyxHQUFHQSxLQUFLO0lBQ2xCLElBQUksQ0FBQ0MsY0FBYyxHQUFHQSxjQUFjO0lBQ3BDLElBQUksQ0FBQ0Msa0JBQWtCLEdBQUdBLGtCQUFrQjtJQUU1QyxJQUFJLENBQUNHLG1CQUFtQixHQUFHLElBQUlULFFBQVEsQ0FBRUksS0FBSyxDQUFDTSx1QkFBdUIsRUFBRU4sS0FBSyxDQUFDRyxLQUFLLEVBQUVILEtBQUssQ0FBQ0ksa0JBQWtCLEVBQUU7TUFDN0dGLGtCQUFrQixFQUFFQTtJQUN0QixDQUFFLENBQUM7SUFDSCxJQUFJLENBQUNLLHVCQUF1QixHQUFHLElBQUlkLElBQUksQ0FBQyxDQUFDO0lBQ3pDLElBQUksQ0FBQ2Usb0JBQW9CLEdBQUcsSUFBSWYsSUFBSSxDQUFDLENBQUM7SUFFdEMsSUFBSSxDQUFDZ0IsYUFBYSxHQUFHLElBQUlaLGFBQWEsQ0FBRUcsS0FBSyxDQUFDTSx1QkFBdUIsRUFBRU4sS0FBSyxDQUFDSSxrQkFBbUIsQ0FBQzs7SUFFakc7SUFDQSxJQUFJLENBQUNNLFFBQVEsQ0FBRSxJQUFJLENBQUNGLG9CQUFxQixDQUFDO0lBQzFDLElBQUksQ0FBQ0UsUUFBUSxDQUFFLElBQUksQ0FBQ0gsdUJBQXdCLENBQUM7SUFDN0MsSUFBSSxDQUFDRyxRQUFRLENBQUUsSUFBSSxDQUFDTCxtQkFBb0IsQ0FBQztJQUN6QyxJQUFJLENBQUNLLFFBQVEsQ0FBRSxJQUFJLENBQUNELGFBQWMsQ0FBQzs7SUFFbkM7SUFDQTtJQUNBVCxLQUFLLENBQUNXLGFBQWEsQ0FBQ0Msb0JBQW9CLENBQUUsSUFBSSxDQUFDQyxpQkFBaUIsQ0FBQ0MsSUFBSSxDQUFFLElBQUssQ0FBRSxDQUFDO0lBQy9FZCxLQUFLLENBQUNXLGFBQWEsQ0FBQ0ksc0JBQXNCLENBQUUsSUFBSSxDQUFDQyxtQkFBbUIsQ0FBQ0YsSUFBSSxDQUFFLElBQUssQ0FBRSxDQUFDOztJQUVuRjtJQUNBO0lBQ0FkLEtBQUssQ0FBQ2lCLFVBQVUsQ0FBQ0wsb0JBQW9CLENBQUUsSUFBSSxDQUFDTSxjQUFjLENBQUNKLElBQUksQ0FBRSxJQUFLLENBQUUsQ0FBQztJQUN6RWQsS0FBSyxDQUFDaUIsVUFBVSxDQUFDRixzQkFBc0IsQ0FBRSxJQUFJLENBQUNJLGdCQUFnQixDQUFDTCxJQUFJLENBQUUsSUFBSyxDQUFFLENBQUM7O0lBRTdFO0lBQ0E7SUFDQXZCLFNBQVMsQ0FBQzZCLFNBQVMsQ0FBRSxDQUFFbkIsY0FBYyxDQUFDb0Isb0JBQW9CLEVBQUVwQixjQUFjLENBQUNxQix3QkFBd0IsQ0FBRSxFQUNuRyxJQUFJLENBQUNDLHFCQUFxQixDQUFDVCxJQUFJLENBQUUsSUFBSyxDQUFFLENBQUM7O0lBRTNDO0lBQ0E7SUFDQWIsY0FBYyxDQUFDdUIsbUJBQW1CLENBQUNDLElBQUksQ0FBRUMsT0FBTyxJQUFJO01BQ2xELElBQUksQ0FBQ0MsY0FBYyxDQUFFRCxPQUFRLENBQUM7SUFDaEMsQ0FBRSxDQUFDOztJQUVIO0lBQ0E7SUFDQSxJQUFJLENBQUN6QixjQUFjLENBQUMyQixrQ0FBa0MsQ0FBQ0gsSUFBSSxDQUFFQyxPQUFPLElBQUk7TUFDdEUsSUFBSyxJQUFJLENBQUNyQixtQkFBbUIsRUFBRztRQUM5QixJQUFJLENBQUNBLG1CQUFtQixDQUFDd0Isa0JBQWtCLENBQUVILE9BQVEsQ0FBQztNQUN4RDtJQUNGLENBQUUsQ0FBQztFQUNMOztFQUVBO0VBQ1FILHFCQUFxQkEsQ0FBQSxFQUFTO0lBRXBDLE1BQU1PLFlBQVksR0FBRyxJQUFJLENBQUM3QixjQUFjLENBQUNvQixvQkFBb0IsQ0FBQ1UsS0FBSzs7SUFFbkU7SUFDQSxJQUFJLENBQUMxQixtQkFBbUIsQ0FBQ3FCLE9BQU8sR0FBR0ksWUFBWTs7SUFFL0M7SUFDQSxJQUFJLENBQUN0QixvQkFBb0IsQ0FBQ2tCLE9BQU8sR0FBR0ksWUFBWTtJQUNoRCxJQUFJLENBQUN2Qix1QkFBdUIsQ0FBQ21CLE9BQU8sR0FBR0ksWUFBWTs7SUFFbkQ7SUFDQSxJQUFJLENBQUNyQixhQUFhLENBQUNpQixPQUFPLEdBQUssSUFBSSxDQUFDekIsY0FBYyxDQUFDcUIsd0JBQXdCLENBQUNTLEtBQUssSUFBSUQsWUFBYztFQUNyRzs7RUFFQTtFQUNRakIsaUJBQWlCQSxDQUFFbUIsSUFBVSxFQUFTO0lBQzVDLE1BQU1DLFFBQVEsR0FBRyxJQUFJckMsUUFBUSxDQUFFLElBQUlKLFFBQVEsQ0FBRXdDLElBQUssQ0FBQyxFQUFFLElBQUksQ0FBQ2hDLEtBQUssQ0FBQ0csS0FBSyxFQUFFLElBQUksQ0FBQ0gsS0FBSyxDQUFDSSxrQkFBa0IsRUFBRTtNQUNwR0Ysa0JBQWtCLEVBQUUsSUFBSSxDQUFDQTtJQUMzQixDQUFFLENBQUM7SUFDSCxJQUFJLENBQUNLLHVCQUF1QixDQUFDRyxRQUFRLENBQUV1QixRQUFTLENBQUM7RUFDbkQ7O0VBRUE7RUFDUWpCLG1CQUFtQkEsQ0FBRWdCLElBQVUsRUFBUztJQUM5QyxJQUFJLENBQUNFLGNBQWMsQ0FBRUYsSUFBSSxFQUFFLElBQUksQ0FBQ3pCLHVCQUF3QixDQUFDO0VBQzNEOztFQUVBO0VBQ1FXLGNBQWNBLENBQUVjLElBQVUsRUFBUztJQUN6QyxNQUFNQyxRQUFRLEdBQUcsSUFBSXJDLFFBQVEsQ0FBRSxJQUFJSixRQUFRLENBQUV3QyxJQUFLLENBQUMsRUFBRSxJQUFJLENBQUNoQyxLQUFLLENBQUNHLEtBQUssRUFBRSxJQUFJLENBQUNILEtBQUssQ0FBQ0ksa0JBQWtCLEVBQUU7TUFDcEdGLGtCQUFrQixFQUFFLElBQUksQ0FBQ0E7SUFDM0IsQ0FBRSxDQUFDO0lBQ0gsSUFBSSxDQUFDTSxvQkFBb0IsQ0FBQ0UsUUFBUSxDQUFFdUIsUUFBUyxDQUFDO0VBQ2hEOztFQUVBO0VBQ1FkLGdCQUFnQkEsQ0FBRWEsSUFBVSxFQUFTO0lBQzNDLElBQUksQ0FBQ0UsY0FBYyxDQUFFRixJQUFJLEVBQUUsSUFBSSxDQUFDeEIsb0JBQXFCLENBQUM7RUFDeEQ7O0VBRUE7RUFDUTBCLGNBQWNBLENBQUVGLElBQVUsRUFBRUcsVUFBZ0IsRUFBUztJQUMzRCxJQUFJQyxPQUFPLEdBQUcsS0FBSztJQUNuQixLQUFNLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBR0YsVUFBVSxDQUFDRyxnQkFBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQ0YsT0FBTyxFQUFFQyxDQUFDLEVBQUUsRUFBRztNQUNwRSxNQUFNRSxJQUFJLEdBQUdKLFVBQVUsQ0FBQ0ssVUFBVSxDQUFFSCxDQUFFLENBQWE7TUFDbkRJLE1BQU0sSUFBSUEsTUFBTSxDQUFFRixJQUFJLFlBQVkzQyxRQUFTLENBQUMsQ0FBQyxDQUFDO01BQzlDLElBQUtvQyxJQUFJLEtBQUtPLElBQUksQ0FBQ0csWUFBWSxDQUFDWCxLQUFLLEVBQUc7UUFDdENJLFVBQVUsQ0FBQ1EsV0FBVyxDQUFFSixJQUFLLENBQUM7UUFDOUJBLElBQUksQ0FBQ0ssT0FBTyxDQUFDLENBQUM7UUFDZFIsT0FBTyxHQUFHLElBQUk7TUFDaEI7SUFDRjtJQUNBSyxNQUFNLElBQUlBLE1BQU0sQ0FBRUwsT0FBTyxFQUFHLDBCQUF5QkosSUFBSSxDQUFDYSxRQUFRLENBQUMsQ0FBRSxFQUFFLENBQUM7RUFDMUU7QUFDRjtBQUVBbkQsYUFBYSxDQUFDb0QsUUFBUSxDQUFFLG9CQUFvQixFQUFFaEQsa0JBQW1CLENBQUMifQ==