// Copyright 2013-2022, University of Colorado Boulder

/**
 * Scenery display object (scene graph node) for minusCharge. All electron nodes use a single image node, and are added
 * to the scene graph using Scenery's DAG feature.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Vasily Shakhov (Mlearner)
 */

import DotRectangle from '../../../../dot/js/Rectangle.js'; // eslint-disable-line default-import-match-filename
import Vector2 from '../../../../dot/js/Vector2.js';
import ElectronChargeNode from '../../../../scenery-phet/js/ElectronChargeNode.js';
import { Circle, Image, Node, Rectangle } from '../../../../scenery/js/imports.js';
import johnTravoltage from '../../johnTravoltage.js';

// constants
// Scale up before rasterization so it won't be too pixelated/fuzzy
const scale = 2;

// single node for all electrons, making use of scenery's DAG feature
const minusChargeNode = new ElectronChargeNode({
  scale: scale,
  top: 0,
  left: 0
});
const node = new Node();
minusChargeNode.toImage(im => {
  //Scale back down so the image will be the desired size
  node.children = [new Image(im, {
    scale: 1.0 / scale
  })];
}, 0, 0, minusChargeNode.width, minusChargeNode.height);

//Bounds for the leg and arm regions sampled by clicking on the JohnTravoltageView coordinates
const legBounds = new DotRectangle(368.70275791624107, 332.0122574055158, 600, 600);
let armBounds = new DotRectangle(427.41602634467614, 210.03732162458834, 70, 42);
const topLeft = new Vector2(427.83601359003404, 154.03488108720273);
const bottomRight = new Vector2(558.1263873159684, 294.67542468856175);
armBounds = new DotRectangle(topLeft.x, topLeft.y, bottomRight.x - topLeft.x, bottomRight.y - topLeft.y);

//Precompute and reuse to avoid allocations
const a = new Vector2(0, 0);
const b = new Vector2(0, 0);
let dr = new Vector2(0, 0);
const debugPosition = false;
class ElectronNode extends Node {
  /**
   * @param {Electron} electron
   * @param {Leg} leg
   * @param {Arm} arm
   */
  constructor(electron, leg, arm) {
    super({
      pickable: false
    });
    this.addChild(node);
    node.centerX = 0;
    node.centerY = 0;
    if (debugPosition) {
      const circle = new Circle(2, {
        fill: 'yellow'
      });
      circle.centerX = 0;
      circle.centerY = 0;
      this.addChild(circle);
      this.addChild(new Rectangle(node.bounds, {
        lineWidth: 1,
        stroke: 'red'
      }));
    }

    // For debugging, show the electron id
    // this.addChild( new Text( '' + electron.id, {fill: 'white'} ) );

    const legText = 'leg';
    const bodyText = 'body';
    const armText = 'arm';

    //Electrons fire a position changed every step whether their position changed or not, so that it will still be drawn in the proper place if the leg angle changed.
    const updatePosition = position => {
      electron.history.push(legBounds.containsPoint(position) ? legText : armBounds.containsPoint(position) ? armText : bodyText);
      if (electron.history.length > 10) {
        electron.history.shift();
      }
      let inLegCount = 0;
      let inBodyCount = 0;
      let inArmCount = 0;
      let deltaAngle;
      let c;
      for (let i = 0; i < electron.history.length; i++) {
        const element = electron.history[i];
        if (element === legText) {
          inLegCount++;
        } else if (element === armText) {
          inArmCount++;
        } else {
          inBodyCount++;
        }
      }

      //Simplest case, it wasn't in any appendage
      if (inBodyCount === electron.history.length) {
        this.setTranslation(position.x, position.y);
      } else if (inLegCount >= inArmCount) {
        // Interpolate for smoothness at intersection between leg/body
        const legPoint = leg.position;
        dr.setXY(position.x - legPoint.x, position.y - legPoint.y);

        //The leg's rotated angle
        deltaAngle = leg.deltaAngle();
        dr = dr.rotated(deltaAngle).plus(legPoint);

        //No need to blend, it was in the leg the whole time
        if (inLegCount === electron.history.length) {
          this.setTranslation(dr.x, dr.y);
        } else {
          a.setXY(dr.x, dr.y);
          b.setXY(position.x, position.y);
          c = a.blend(b, inBodyCount / electron.history.length);
          this.setTranslation(c.x, c.y);
        }
      }

      //This assumes that no electron will blend arm/leg positions, which is a fair assumption since it is difficult to get from the leg to the arm in only 10 history steps
      else {
        const armPoint = arm.position;
        dr.setXY(position.x - armPoint.x, position.y - armPoint.y);

        //The leg's rotated angle
        deltaAngle = arm.angleProperty.get();
        dr = dr.rotated(deltaAngle).plus(armPoint);

        //No need to blend, it was in the leg the whole time
        if (inArmCount === electron.history.length) {
          this.setTranslation(dr.x, dr.y);
        } else {
          a.setXY(dr.x, dr.y);
          b.setXY(position.x, position.y);
          c = a.blend(b, inBodyCount / electron.history.length);
          this.setTranslation(c.x, c.y);
        }
      }
    };
    electron.positionProperty.link(updatePosition);
    const updatePositionBound = () => {
      updatePosition(electron.positionProperty.get());
    };
    electron.historyChangedEmitter.addListener(updatePositionBound);
    const disposeListener = () => {
      this.dispose();
    };
    electron.disposeEmitter.addListener(disposeListener);
    this.disposeElectronNode = () => {
      electron.positionProperty.unlink(updatePosition);
      electron.historyChangedEmitter.removeListener(updatePositionBound);
      electron.disposeEmitter.removeListener(disposeListener);
    };
  }

  /**
   * Make eligible for garbage collection.
   * @public
   */
  dispose() {
    this.disposeElectronNode();
    super.dispose();
  }
}
johnTravoltage.register('ElectronNode', ElectronNode);
export default ElectronNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEb3RSZWN0YW5nbGUiLCJWZWN0b3IyIiwiRWxlY3Ryb25DaGFyZ2VOb2RlIiwiQ2lyY2xlIiwiSW1hZ2UiLCJOb2RlIiwiUmVjdGFuZ2xlIiwiam9oblRyYXZvbHRhZ2UiLCJzY2FsZSIsIm1pbnVzQ2hhcmdlTm9kZSIsInRvcCIsImxlZnQiLCJub2RlIiwidG9JbWFnZSIsImltIiwiY2hpbGRyZW4iLCJ3aWR0aCIsImhlaWdodCIsImxlZ0JvdW5kcyIsImFybUJvdW5kcyIsInRvcExlZnQiLCJib3R0b21SaWdodCIsIngiLCJ5IiwiYSIsImIiLCJkciIsImRlYnVnUG9zaXRpb24iLCJFbGVjdHJvbk5vZGUiLCJjb25zdHJ1Y3RvciIsImVsZWN0cm9uIiwibGVnIiwiYXJtIiwicGlja2FibGUiLCJhZGRDaGlsZCIsImNlbnRlclgiLCJjZW50ZXJZIiwiY2lyY2xlIiwiZmlsbCIsImJvdW5kcyIsImxpbmVXaWR0aCIsInN0cm9rZSIsImxlZ1RleHQiLCJib2R5VGV4dCIsImFybVRleHQiLCJ1cGRhdGVQb3NpdGlvbiIsInBvc2l0aW9uIiwiaGlzdG9yeSIsInB1c2giLCJjb250YWluc1BvaW50IiwibGVuZ3RoIiwic2hpZnQiLCJpbkxlZ0NvdW50IiwiaW5Cb2R5Q291bnQiLCJpbkFybUNvdW50IiwiZGVsdGFBbmdsZSIsImMiLCJpIiwiZWxlbWVudCIsInNldFRyYW5zbGF0aW9uIiwibGVnUG9pbnQiLCJzZXRYWSIsInJvdGF0ZWQiLCJwbHVzIiwiYmxlbmQiLCJhcm1Qb2ludCIsImFuZ2xlUHJvcGVydHkiLCJnZXQiLCJwb3NpdGlvblByb3BlcnR5IiwibGluayIsInVwZGF0ZVBvc2l0aW9uQm91bmQiLCJoaXN0b3J5Q2hhbmdlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsImRpc3Bvc2VMaXN0ZW5lciIsImRpc3Bvc2UiLCJkaXNwb3NlRW1pdHRlciIsImRpc3Bvc2VFbGVjdHJvbk5vZGUiLCJ1bmxpbmsiLCJyZW1vdmVMaXN0ZW5lciIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRWxlY3Ryb25Ob2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDEzLTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNjZW5lcnkgZGlzcGxheSBvYmplY3QgKHNjZW5lIGdyYXBoIG5vZGUpIGZvciBtaW51c0NoYXJnZS4gQWxsIGVsZWN0cm9uIG5vZGVzIHVzZSBhIHNpbmdsZSBpbWFnZSBub2RlLCBhbmQgYXJlIGFkZGVkXHJcbiAqIHRvIHRoZSBzY2VuZSBncmFwaCB1c2luZyBTY2VuZXJ5J3MgREFHIGZlYXR1cmUuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgVmFzaWx5IFNoYWtob3YgKE1sZWFybmVyKVxyXG4gKi9cclxuXHJcbmltcG9ydCBEb3RSZWN0YW5nbGUgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JlY3RhbmdsZS5qcyc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZGVmYXVsdC1pbXBvcnQtbWF0Y2gtZmlsZW5hbWVcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgRWxlY3Ryb25DaGFyZ2VOb2RlIGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnktcGhldC9qcy9FbGVjdHJvbkNoYXJnZU5vZGUuanMnO1xyXG5pbXBvcnQgeyBDaXJjbGUsIEltYWdlLCBOb2RlLCBSZWN0YW5nbGUgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgam9oblRyYXZvbHRhZ2UgZnJvbSAnLi4vLi4vam9oblRyYXZvbHRhZ2UuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbi8vIFNjYWxlIHVwIGJlZm9yZSByYXN0ZXJpemF0aW9uIHNvIGl0IHdvbid0IGJlIHRvbyBwaXhlbGF0ZWQvZnV6enlcclxuY29uc3Qgc2NhbGUgPSAyO1xyXG5cclxuLy8gc2luZ2xlIG5vZGUgZm9yIGFsbCBlbGVjdHJvbnMsIG1ha2luZyB1c2Ugb2Ygc2NlbmVyeSdzIERBRyBmZWF0dXJlXHJcbmNvbnN0IG1pbnVzQ2hhcmdlTm9kZSA9IG5ldyBFbGVjdHJvbkNoYXJnZU5vZGUoIHsgc2NhbGU6IHNjYWxlLCB0b3A6IDAsIGxlZnQ6IDAgfSApO1xyXG5cclxuY29uc3Qgbm9kZSA9IG5ldyBOb2RlKCk7XHJcbm1pbnVzQ2hhcmdlTm9kZS50b0ltYWdlKCBpbSA9PiB7XHJcblxyXG4gIC8vU2NhbGUgYmFjayBkb3duIHNvIHRoZSBpbWFnZSB3aWxsIGJlIHRoZSBkZXNpcmVkIHNpemVcclxuICBub2RlLmNoaWxkcmVuID0gWyBuZXcgSW1hZ2UoIGltLCB7IHNjYWxlOiAxLjAgLyBzY2FsZSB9ICkgXTtcclxufSwgMCwgMCwgbWludXNDaGFyZ2VOb2RlLndpZHRoLCBtaW51c0NoYXJnZU5vZGUuaGVpZ2h0ICk7XHJcblxyXG4vL0JvdW5kcyBmb3IgdGhlIGxlZyBhbmQgYXJtIHJlZ2lvbnMgc2FtcGxlZCBieSBjbGlja2luZyBvbiB0aGUgSm9oblRyYXZvbHRhZ2VWaWV3IGNvb3JkaW5hdGVzXHJcbmNvbnN0IGxlZ0JvdW5kcyA9IG5ldyBEb3RSZWN0YW5nbGUoIDM2OC43MDI3NTc5MTYyNDEwNywgMzMyLjAxMjI1NzQwNTUxNTgsIDYwMCwgNjAwICk7XHJcbmxldCBhcm1Cb3VuZHMgPSBuZXcgRG90UmVjdGFuZ2xlKCA0MjcuNDE2MDI2MzQ0Njc2MTQsIDIxMC4wMzczMjE2MjQ1ODgzNCwgNzAsIDQyICk7XHJcblxyXG5jb25zdCB0b3BMZWZ0ID0gbmV3IFZlY3RvcjIoIDQyNy44MzYwMTM1OTAwMzQwNCwgMTU0LjAzNDg4MTA4NzIwMjczICk7XHJcbmNvbnN0IGJvdHRvbVJpZ2h0ID0gbmV3IFZlY3RvcjIoIDU1OC4xMjYzODczMTU5Njg0LCAyOTQuNjc1NDI0Njg4NTYxNzUgKTtcclxuYXJtQm91bmRzID0gbmV3IERvdFJlY3RhbmdsZSggdG9wTGVmdC54LCB0b3BMZWZ0LnksIGJvdHRvbVJpZ2h0LnggLSB0b3BMZWZ0LngsIGJvdHRvbVJpZ2h0LnkgLSB0b3BMZWZ0LnkgKTtcclxuXHJcbi8vUHJlY29tcHV0ZSBhbmQgcmV1c2UgdG8gYXZvaWQgYWxsb2NhdGlvbnNcclxuY29uc3QgYSA9IG5ldyBWZWN0b3IyKCAwLCAwICk7XHJcbmNvbnN0IGIgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG5sZXQgZHIgPSBuZXcgVmVjdG9yMiggMCwgMCApO1xyXG5cclxuY29uc3QgZGVidWdQb3NpdGlvbiA9IGZhbHNlO1xyXG5cclxuY2xhc3MgRWxlY3Ryb25Ob2RlIGV4dGVuZHMgTm9kZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7RWxlY3Ryb259IGVsZWN0cm9uXHJcbiAgICogQHBhcmFtIHtMZWd9IGxlZ1xyXG4gICAqIEBwYXJhbSB7QXJtfSBhcm1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggZWxlY3Ryb24sIGxlZywgYXJtICkge1xyXG4gICAgc3VwZXIoIHtcclxuICAgICAgcGlja2FibGU6IGZhbHNlXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5hZGRDaGlsZCggbm9kZSApO1xyXG4gICAgbm9kZS5jZW50ZXJYID0gMDtcclxuICAgIG5vZGUuY2VudGVyWSA9IDA7XHJcbiAgICBpZiAoIGRlYnVnUG9zaXRpb24gKSB7XHJcbiAgICAgIGNvbnN0IGNpcmNsZSA9IG5ldyBDaXJjbGUoIDIsIHsgZmlsbDogJ3llbGxvdycgfSApO1xyXG4gICAgICBjaXJjbGUuY2VudGVyWCA9IDA7XHJcbiAgICAgIGNpcmNsZS5jZW50ZXJZID0gMDtcclxuICAgICAgdGhpcy5hZGRDaGlsZCggY2lyY2xlICk7XHJcblxyXG4gICAgICB0aGlzLmFkZENoaWxkKCBuZXcgUmVjdGFuZ2xlKCBub2RlLmJvdW5kcywgeyBsaW5lV2lkdGg6IDEsIHN0cm9rZTogJ3JlZCcgfSApICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9yIGRlYnVnZ2luZywgc2hvdyB0aGUgZWxlY3Ryb24gaWRcclxuICAgIC8vIHRoaXMuYWRkQ2hpbGQoIG5ldyBUZXh0KCAnJyArIGVsZWN0cm9uLmlkLCB7ZmlsbDogJ3doaXRlJ30gKSApO1xyXG5cclxuICAgIGNvbnN0IGxlZ1RleHQgPSAnbGVnJztcclxuICAgIGNvbnN0IGJvZHlUZXh0ID0gJ2JvZHknO1xyXG4gICAgY29uc3QgYXJtVGV4dCA9ICdhcm0nO1xyXG5cclxuICAgIC8vRWxlY3Ryb25zIGZpcmUgYSBwb3NpdGlvbiBjaGFuZ2VkIGV2ZXJ5IHN0ZXAgd2hldGhlciB0aGVpciBwb3NpdGlvbiBjaGFuZ2VkIG9yIG5vdCwgc28gdGhhdCBpdCB3aWxsIHN0aWxsIGJlIGRyYXduIGluIHRoZSBwcm9wZXIgcGxhY2UgaWYgdGhlIGxlZyBhbmdsZSBjaGFuZ2VkLlxyXG4gICAgY29uc3QgdXBkYXRlUG9zaXRpb24gPSBwb3NpdGlvbiA9PiB7XHJcblxyXG4gICAgICBlbGVjdHJvbi5oaXN0b3J5LnB1c2goIGxlZ0JvdW5kcy5jb250YWluc1BvaW50KCBwb3NpdGlvbiApID8gbGVnVGV4dCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJtQm91bmRzLmNvbnRhaW5zUG9pbnQoIHBvc2l0aW9uICkgPyBhcm1UZXh0IDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5VGV4dCApO1xyXG4gICAgICBpZiAoIGVsZWN0cm9uLmhpc3RvcnkubGVuZ3RoID4gMTAgKSB7XHJcbiAgICAgICAgZWxlY3Ryb24uaGlzdG9yeS5zaGlmdCgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgaW5MZWdDb3VudCA9IDA7XHJcbiAgICAgIGxldCBpbkJvZHlDb3VudCA9IDA7XHJcbiAgICAgIGxldCBpbkFybUNvdW50ID0gMDtcclxuICAgICAgbGV0IGRlbHRhQW5nbGU7XHJcbiAgICAgIGxldCBjO1xyXG4gICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBlbGVjdHJvbi5oaXN0b3J5Lmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVjdHJvbi5oaXN0b3J5WyBpIF07XHJcbiAgICAgICAgaWYgKCBlbGVtZW50ID09PSBsZWdUZXh0ICkge1xyXG4gICAgICAgICAgaW5MZWdDb3VudCsrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICggZWxlbWVudCA9PT0gYXJtVGV4dCApIHtcclxuICAgICAgICAgIGluQXJtQ291bnQrKztcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBpbkJvZHlDb3VudCsrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy9TaW1wbGVzdCBjYXNlLCBpdCB3YXNuJ3QgaW4gYW55IGFwcGVuZGFnZVxyXG4gICAgICBpZiAoIGluQm9keUNvdW50ID09PSBlbGVjdHJvbi5oaXN0b3J5Lmxlbmd0aCApIHtcclxuICAgICAgICB0aGlzLnNldFRyYW5zbGF0aW9uKCBwb3NpdGlvbi54LCBwb3NpdGlvbi55ICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGVsc2UgaWYgKCBpbkxlZ0NvdW50ID49IGluQXJtQ291bnQgKSB7XHJcblxyXG4gICAgICAgIC8vIEludGVycG9sYXRlIGZvciBzbW9vdGhuZXNzIGF0IGludGVyc2VjdGlvbiBiZXR3ZWVuIGxlZy9ib2R5XHJcbiAgICAgICAgY29uc3QgbGVnUG9pbnQgPSBsZWcucG9zaXRpb247XHJcblxyXG4gICAgICAgIGRyLnNldFhZKCBwb3NpdGlvbi54IC0gbGVnUG9pbnQueCwgcG9zaXRpb24ueSAtIGxlZ1BvaW50LnkgKTtcclxuXHJcbiAgICAgICAgLy9UaGUgbGVnJ3Mgcm90YXRlZCBhbmdsZVxyXG4gICAgICAgIGRlbHRhQW5nbGUgPSBsZWcuZGVsdGFBbmdsZSgpO1xyXG4gICAgICAgIGRyID0gZHIucm90YXRlZCggZGVsdGFBbmdsZSApLnBsdXMoIGxlZ1BvaW50ICk7XHJcblxyXG4gICAgICAgIC8vTm8gbmVlZCB0byBibGVuZCwgaXQgd2FzIGluIHRoZSBsZWcgdGhlIHdob2xlIHRpbWVcclxuICAgICAgICBpZiAoIGluTGVnQ291bnQgPT09IGVsZWN0cm9uLmhpc3RvcnkubGVuZ3RoICkge1xyXG4gICAgICAgICAgdGhpcy5zZXRUcmFuc2xhdGlvbiggZHIueCwgZHIueSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGEuc2V0WFkoIGRyLngsIGRyLnkgKTtcclxuICAgICAgICAgIGIuc2V0WFkoIHBvc2l0aW9uLngsIHBvc2l0aW9uLnkgKTtcclxuICAgICAgICAgIGMgPSBhLmJsZW5kKCBiLCBpbkJvZHlDb3VudCAvIGVsZWN0cm9uLmhpc3RvcnkubGVuZ3RoICk7XHJcbiAgICAgICAgICB0aGlzLnNldFRyYW5zbGF0aW9uKCBjLngsIGMueSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy9UaGlzIGFzc3VtZXMgdGhhdCBubyBlbGVjdHJvbiB3aWxsIGJsZW5kIGFybS9sZWcgcG9zaXRpb25zLCB3aGljaCBpcyBhIGZhaXIgYXNzdW1wdGlvbiBzaW5jZSBpdCBpcyBkaWZmaWN1bHQgdG8gZ2V0IGZyb20gdGhlIGxlZyB0byB0aGUgYXJtIGluIG9ubHkgMTAgaGlzdG9yeSBzdGVwc1xyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgY29uc3QgYXJtUG9pbnQgPSBhcm0ucG9zaXRpb247XHJcblxyXG4gICAgICAgIGRyLnNldFhZKCBwb3NpdGlvbi54IC0gYXJtUG9pbnQueCwgcG9zaXRpb24ueSAtIGFybVBvaW50LnkgKTtcclxuXHJcbiAgICAgICAgLy9UaGUgbGVnJ3Mgcm90YXRlZCBhbmdsZVxyXG4gICAgICAgIGRlbHRhQW5nbGUgPSBhcm0uYW5nbGVQcm9wZXJ0eS5nZXQoKTtcclxuICAgICAgICBkciA9IGRyLnJvdGF0ZWQoIGRlbHRhQW5nbGUgKS5wbHVzKCBhcm1Qb2ludCApO1xyXG5cclxuICAgICAgICAvL05vIG5lZWQgdG8gYmxlbmQsIGl0IHdhcyBpbiB0aGUgbGVnIHRoZSB3aG9sZSB0aW1lXHJcbiAgICAgICAgaWYgKCBpbkFybUNvdW50ID09PSBlbGVjdHJvbi5oaXN0b3J5Lmxlbmd0aCApIHtcclxuICAgICAgICAgIHRoaXMuc2V0VHJhbnNsYXRpb24oIGRyLngsIGRyLnkgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBhLnNldFhZKCBkci54LCBkci55ICk7XHJcbiAgICAgICAgICBiLnNldFhZKCBwb3NpdGlvbi54LCBwb3NpdGlvbi55ICk7XHJcbiAgICAgICAgICBjID0gYS5ibGVuZCggYiwgaW5Cb2R5Q291bnQgLyBlbGVjdHJvbi5oaXN0b3J5Lmxlbmd0aCApO1xyXG4gICAgICAgICAgdGhpcy5zZXRUcmFuc2xhdGlvbiggYy54LCBjLnkgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICB9O1xyXG4gICAgZWxlY3Ryb24ucG9zaXRpb25Qcm9wZXJ0eS5saW5rKCB1cGRhdGVQb3NpdGlvbiApO1xyXG5cclxuICAgIGNvbnN0IHVwZGF0ZVBvc2l0aW9uQm91bmQgPSAoKSA9PiB7XHJcbiAgICAgIHVwZGF0ZVBvc2l0aW9uKCBlbGVjdHJvbi5wb3NpdGlvblByb3BlcnR5LmdldCgpICk7XHJcbiAgICB9O1xyXG4gICAgZWxlY3Ryb24uaGlzdG9yeUNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB1cGRhdGVQb3NpdGlvbkJvdW5kICk7XHJcblxyXG4gICAgY29uc3QgZGlzcG9zZUxpc3RlbmVyID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgIH07XHJcbiAgICBlbGVjdHJvbi5kaXNwb3NlRW1pdHRlci5hZGRMaXN0ZW5lciggZGlzcG9zZUxpc3RlbmVyICk7XHJcblxyXG4gICAgdGhpcy5kaXNwb3NlRWxlY3Ryb25Ob2RlID0gKCkgPT4ge1xyXG4gICAgICBlbGVjdHJvbi5wb3NpdGlvblByb3BlcnR5LnVubGluayggdXBkYXRlUG9zaXRpb24gKTtcclxuICAgICAgZWxlY3Ryb24uaGlzdG9yeUNoYW5nZWRFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCB1cGRhdGVQb3NpdGlvbkJvdW5kICk7XHJcbiAgICAgIGVsZWN0cm9uLmRpc3Bvc2VFbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCBkaXNwb3NlTGlzdGVuZXIgKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogTWFrZSBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBkaXNwb3NlKCkge1xyXG4gICAgdGhpcy5kaXNwb3NlRWxlY3Ryb25Ob2RlKCk7XHJcbiAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5qb2huVHJhdm9sdGFnZS5yZWdpc3RlciggJ0VsZWN0cm9uTm9kZScsIEVsZWN0cm9uTm9kZSApO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgRWxlY3Ryb25Ob2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsWUFBWSxNQUFNLGlDQUFpQyxDQUFDLENBQUM7QUFDNUQsT0FBT0MsT0FBTyxNQUFNLCtCQUErQjtBQUNuRCxPQUFPQyxrQkFBa0IsTUFBTSxtREFBbUQ7QUFDbEYsU0FBU0MsTUFBTSxFQUFFQyxLQUFLLEVBQUVDLElBQUksRUFBRUMsU0FBUyxRQUFRLG1DQUFtQztBQUNsRixPQUFPQyxjQUFjLE1BQU0seUJBQXlCOztBQUVwRDtBQUNBO0FBQ0EsTUFBTUMsS0FBSyxHQUFHLENBQUM7O0FBRWY7QUFDQSxNQUFNQyxlQUFlLEdBQUcsSUFBSVAsa0JBQWtCLENBQUU7RUFBRU0sS0FBSyxFQUFFQSxLQUFLO0VBQUVFLEdBQUcsRUFBRSxDQUFDO0VBQUVDLElBQUksRUFBRTtBQUFFLENBQUUsQ0FBQztBQUVuRixNQUFNQyxJQUFJLEdBQUcsSUFBSVAsSUFBSSxDQUFD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