// Copyright 2016-2022, University of Colorado Boulder
// Copyright 2016, OCAD University

/**
 * Scenery display object (scene graph node) for the electron layer.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Vasily Shakhov (Mlearner)
 * @author Justin Obara
 */

import Range from '../../../../dot/js/Range.js';
import StringUtils from '../../../../phetcommon/js/util/StringUtils.js';
import { Node, Voicing } from '../../../../scenery/js/imports.js';
import Utterance from '../../../../utterance-queue/js/Utterance.js';
import johnTravoltage from '../../johnTravoltage.js';
import JohnTravoltageStrings from '../../JohnTravoltageStrings.js';
import ElectronNode from './ElectronNode.js';
const electronsTotalDescriptionPatternString = JohnTravoltageStrings.a11y.electrons.totalDescriptionPattern;
const electronsTotalAfterDischargePatternString = JohnTravoltageStrings.a11y.electrons.totalAfterDischargePattern;
const QUALITATIVE_DESCRIPTION_MAP = new Map();
QUALITATIVE_DESCRIPTION_MAP.set(new Range(0, 0), 'No');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(1, 4), 'A couple');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(5, 9), 'A few');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(10, 30), 'Several');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(31, 53), 'A bunch of');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(54, 76), 'A large amount of');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(77, 99), 'A huge amount of');
QUALITATIVE_DESCRIPTION_MAP.set(new Range(100, Number.POSITIVE_INFINITY), 'Max amount of');
class ElectronLayerNode extends Voicing(Node) {
  /**
   * @param {JohnTravoltageModel} model
   * @param {AppendageNode} armNode
   * @param {number} maxElectrons
   * @param {Tandem} tandem
   */
  constructor(model, armNode, maxElectrons, tandem) {
    super({
      // many charges are usually added at once, wait until alerts stabilize before
      // announcing the change in charge - this critical information is intended to be
      // assertive
      voicingUtterance: new Utterance({
        alertStableDelay: 500,
        alertMaximumDelay: 800
      })
    });

    // Add larger delay time is used so that the assistive technology can finish speaking updates
    // from the aria-valuetext of the AppendageNode. Note that if the delay is too long, there is too much silence
    // between the change in charges and the alert.
    const electronUtterance = new Utterance({
      alertStableDelay: 1000
    });
    let priorCharge = 0;

    // pdom - when electrons enter or leave the body, announce this change with a status update to assistive technology
    const setElectronStatus = () => {
      let alertString;
      const currentCharge = model.electronGroup.count;
      if (currentCharge >= priorCharge) {
        alertString = StringUtils.fillIn(electronsTotalDescriptionPatternString, {
          value: currentCharge
        });
        this.voicingContextResponse = StringUtils.fillIn('{{qualitativeDescription}} electrons on body', {
          qualitativeDescription: this.getQualitativeChargeDescription(currentCharge)
        });
        this.voicingSpeakContextResponse();
      } else {
        let regionText = '';
        if (armNode.regionAtDischarge && armNode.regionAtDischarge.text) {
          regionText = armNode.regionAtDischarge.text.toLowerCase();
        }
        alertString = StringUtils.fillIn(electronsTotalAfterDischargePatternString, {
          oldValue: priorCharge,
          newValue: currentCharge,
          region: regionText
        });
        this.voicingContextResponse = StringUtils.fillIn('{{qualitativeDescription}} electrons discharged with {{region}}.', {
          qualitativeDescription: this.getQualitativeChargeDescription(priorCharge - currentCharge),
          region: regionText
        });
        this.voicingSpeakContextResponse();
      }
      electronUtterance.alert = alertString;
      this.alertDescriptionUtterance(electronUtterance);

      // for haptic feedback, experimental
      model.utteranceAddedEmitter.emit(alertString);
      priorCharge = currentCharge;
    };

    // if new electron added to model - create and add new node to leg
    const electronAddedListener = added => {
      // and the visual representation of the electron
      this.addChild(new ElectronNode(added, model.leg, model.arm));

      // pdom - announce the state of charges with a status update
      setElectronStatus();
    };

    // The electron's view is removed when the electron is disposed, see ElectronNode.js
    model.electronGroup.elementCreatedEmitter.addListener(electronAddedListener);
    model.electronGroup.forEach(electronAddedListener);

    // update status whenever an electron discharge has ended - disposal is not necessary
    model.dischargeEndedEmitter.addListener(setElectronStatus);

    // when the model is reset, update prior charge - disposal not necessary
    model.resetEmitter.addListener(() => {
      priorCharge = 0;
    });
  }

  /**
   * Get a qualitative description of the charge value. Will return something like
   * "A few" or "A large amount of", see QUALITATIVE_DESCRIPTION_MAP above.
   * @public
   *
   * @param {number} charge
   * @returns {string}
   */
  getQualitativeChargeDescription(charge) {
    let qualitativeDescription;
    QUALITATIVE_DESCRIPTION_MAP.forEach((value, key) => {
      if (key.contains(charge)) {
        qualitativeDescription = value;
      }
    });
    assert && assert(qualitativeDescription, 'no description found for charge');
    return qualitativeDescription;
  }
}
johnTravoltage.register('ElectronLayerNode', ElectronLayerNode);
export default ElectronLayerNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSYW5nZSIsIlN0cmluZ1V0aWxzIiwiTm9kZSIsIlZvaWNpbmciLCJVdHRlcmFuY2UiLCJqb2huVHJhdm9sdGFnZSIsIkpvaG5UcmF2b2x0YWdlU3RyaW5ncyIsIkVsZWN0cm9uTm9kZSIsImVsZWN0cm9uc1RvdGFsRGVzY3JpcHRpb25QYXR0ZXJuU3RyaW5nIiwiYTExeSIsImVsZWN0cm9ucyIsInRvdGFsRGVzY3JpcHRpb25QYXR0ZXJuIiwiZWxlY3Ryb25zVG90YWxBZnRlckRpc2NoYXJnZVBhdHRlcm5TdHJpbmciLCJ0b3RhbEFmdGVyRGlzY2hhcmdlUGF0dGVybiIsIlFVQUxJVEFUSVZFX0RFU0NSSVBUSU9OX01BUCIsIk1hcCIsInNldCIsIk51bWJlciIsIlBPU0lUSVZFX0lORklOSVRZIiwiRWxlY3Ryb25MYXllck5vZGUiLCJjb25zdHJ1Y3RvciIsIm1vZGVsIiwiYXJtTm9kZSIsIm1heEVsZWN0cm9ucyIsInRhbmRlbSIsInZvaWNpbmdVdHRlcmFuY2UiLCJhbGVydFN0YWJsZURlbGF5IiwiYWxlcnRNYXhpbXVtRGVsYXkiLCJlbGVjdHJvblV0dGVyYW5jZSIsInByaW9yQ2hhcmdlIiwic2V0RWxlY3Ryb25TdGF0dXMiLCJhbGVydFN0cmluZyIsImN1cnJlbnRDaGFyZ2UiLCJlbGVjdHJvbkdyb3VwIiwiY291bnQiLCJmaWxsSW4iLCJ2YWx1ZSIsInZvaWNpbmdDb250ZXh0UmVzcG9uc2UiLCJxdWFsaXRhdGl2ZURlc2NyaXB0aW9uIiwiZ2V0UXVhbGl0YXRpdmVDaGFyZ2VEZXNjcmlwdGlvbiIsInZvaWNpbmdTcGVha0NvbnRleHRSZXNwb25zZSIsInJlZ2lvblRleHQiLCJyZWdpb25BdERpc2NoYXJnZSIsInRleHQiLCJ0b0xvd2VyQ2FzZSIsIm9sZFZhbHVlIiwibmV3VmFsdWUiLCJyZWdpb24iLCJhbGVydCIsImFsZXJ0RGVzY3JpcHRpb25VdHRlcmFuY2UiLCJ1dHRlcmFuY2VBZGRlZEVtaXR0ZXIiLCJlbWl0IiwiZWxlY3Ryb25BZGRlZExpc3RlbmVyIiwiYWRkZWQiLCJhZGRDaGlsZCIsImxlZyIsImFybSIsImVsZW1lbnRDcmVhdGVkRW1pdHRlciIsImFkZExpc3RlbmVyIiwiZm9yRWFjaCIsImRpc2NoYXJnZUVuZGVkRW1pdHRlciIsInJlc2V0RW1pdHRlciIsImNoYXJnZSIsImtleSIsImNvbnRhaW5zIiwiYXNzZXJ0IiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJFbGVjdHJvbkxheWVyTm9kZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNi0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuLy8gQ29weXJpZ2h0IDIwMTYsIE9DQUQgVW5pdmVyc2l0eVxyXG5cclxuLyoqXHJcbiAqIFNjZW5lcnkgZGlzcGxheSBvYmplY3QgKHNjZW5lIGdyYXBoIG5vZGUpIGZvciB0aGUgZWxlY3Ryb24gbGF5ZXIuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgVmFzaWx5IFNoYWtob3YgKE1sZWFybmVyKVxyXG4gKiBAYXV0aG9yIEp1c3RpbiBPYmFyYVxyXG4gKi9cclxuXHJcbmltcG9ydCBSYW5nZSBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvUmFuZ2UuanMnO1xyXG5pbXBvcnQgU3RyaW5nVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vcGhldGNvbW1vbi9qcy91dGlsL1N0cmluZ1V0aWxzLmpzJztcclxuaW1wb3J0IHsgTm9kZSwgVm9pY2luZyB9IGZyb20gJy4uLy4uLy4uLy4uL3NjZW5lcnkvanMvaW1wb3J0cy5qcyc7XHJcbmltcG9ydCBVdHRlcmFuY2UgZnJvbSAnLi4vLi4vLi4vLi4vdXR0ZXJhbmNlLXF1ZXVlL2pzL1V0dGVyYW5jZS5qcyc7XHJcbmltcG9ydCBqb2huVHJhdm9sdGFnZSBmcm9tICcuLi8uLi9qb2huVHJhdm9sdGFnZS5qcyc7XHJcbmltcG9ydCBKb2huVHJhdm9sdGFnZVN0cmluZ3MgZnJvbSAnLi4vLi4vSm9oblRyYXZvbHRhZ2VTdHJpbmdzLmpzJztcclxuaW1wb3J0IEVsZWN0cm9uTm9kZSBmcm9tICcuL0VsZWN0cm9uTm9kZS5qcyc7XHJcblxyXG5jb25zdCBlbGVjdHJvbnNUb3RhbERlc2NyaXB0aW9uUGF0dGVyblN0cmluZyA9IEpvaG5UcmF2b2x0YWdlU3RyaW5ncy5hMTF5LmVsZWN0cm9ucy50b3RhbERlc2NyaXB0aW9uUGF0dGVybjtcclxuY29uc3QgZWxlY3Ryb25zVG90YWxBZnRlckRpc2NoYXJnZVBhdHRlcm5TdHJpbmcgPSBKb2huVHJhdm9sdGFnZVN0cmluZ3MuYTExeS5lbGVjdHJvbnMudG90YWxBZnRlckRpc2NoYXJnZVBhdHRlcm47XHJcblxyXG5jb25zdCBRVUFMSVRBVElWRV9ERVNDUklQVElPTl9NQVAgPSBuZXcgTWFwKCk7XHJcblFVQUxJVEFUSVZFX0RFU0NSSVBUSU9OX01BUC5zZXQoIG5ldyBSYW5nZSggMCwgMCApLCAnTm8nICk7XHJcblFVQUxJVEFUSVZFX0RFU0NSSVBUSU9OX01BUC5zZXQoIG5ldyBSYW5nZSggMSwgNCApLCAnQSBjb3VwbGUnICk7XHJcblFVQUxJVEFUSVZFX0RFU0NSSVBUSU9OX01BUC5zZXQoIG5ldyBSYW5nZSggNSwgOSApLCAnQSBmZXcnICk7XHJcblFVQUxJVEFUSVZFX0RFU0NSSVBUSU9OX01BUC5zZXQoIG5ldyBSYW5nZSggMTAsIDMwICksICdTZXZlcmFsJyApO1xyXG5RVUFMSVRBVElWRV9ERVNDUklQVElPTl9NQVAuc2V0KCBuZXcgUmFuZ2UoIDMxLCA1MyApLCAnQSBidW5jaCBvZicgKTtcclxuUVVBTElUQVRJVkVfREVTQ1JJUFRJT05fTUFQLnNldCggbmV3IFJhbmdlKCA1NCwgNzYgKSwgJ0EgbGFyZ2UgYW1vdW50IG9mJyApO1xyXG5RVUFMSVRBVElWRV9ERVNDUklQVElPTl9NQVAuc2V0KCBuZXcgUmFuZ2UoIDc3LCA5OSApLCAnQSBodWdlIGFtb3VudCBvZicgKTtcclxuUVVBTElUQVRJVkVfREVTQ1JJUFRJT05fTUFQLnNldCggbmV3IFJhbmdlKCAxMDAsIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSApLCAnTWF4IGFtb3VudCBvZicgKTtcclxuXHJcbmNsYXNzIEVsZWN0cm9uTGF5ZXJOb2RlIGV4dGVuZHMgVm9pY2luZyggTm9kZSApIHtcclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIHtKb2huVHJhdm9sdGFnZU1vZGVsfSBtb2RlbFxyXG4gICAqIEBwYXJhbSB7QXBwZW5kYWdlTm9kZX0gYXJtTm9kZVxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhFbGVjdHJvbnNcclxuICAgKiBAcGFyYW0ge1RhbmRlbX0gdGFuZGVtXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsLCBhcm1Ob2RlLCBtYXhFbGVjdHJvbnMsIHRhbmRlbSApIHtcclxuXHJcbiAgICBzdXBlcigge1xyXG5cclxuICAgICAgLy8gbWFueSBjaGFyZ2VzIGFyZSB1c3VhbGx5IGFkZGVkIGF0IG9uY2UsIHdhaXQgdW50aWwgYWxlcnRzIHN0YWJpbGl6ZSBiZWZvcmVcclxuICAgICAgLy8gYW5ub3VuY2luZyB0aGUgY2hhbmdlIGluIGNoYXJnZSAtIHRoaXMgY3JpdGljYWwgaW5mb3JtYXRpb24gaXMgaW50ZW5kZWQgdG8gYmVcclxuICAgICAgLy8gYXNzZXJ0aXZlXHJcbiAgICAgIHZvaWNpbmdVdHRlcmFuY2U6IG5ldyBVdHRlcmFuY2UoIHtcclxuICAgICAgICBhbGVydFN0YWJsZURlbGF5OiA1MDAsXHJcbiAgICAgICAgYWxlcnRNYXhpbXVtRGVsYXk6IDgwMFxyXG4gICAgICB9IClcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBBZGQgbGFyZ2VyIGRlbGF5IHRpbWUgaXMgdXNlZCBzbyB0aGF0IHRoZSBhc3Npc3RpdmUgdGVjaG5vbG9neSBjYW4gZmluaXNoIHNwZWFraW5nIHVwZGF0ZXNcclxuICAgIC8vIGZyb20gdGhlIGFyaWEtdmFsdWV0ZXh0IG9mIHRoZSBBcHBlbmRhZ2VOb2RlLiBOb3RlIHRoYXQgaWYgdGhlIGRlbGF5IGlzIHRvbyBsb25nLCB0aGVyZSBpcyB0b28gbXVjaCBzaWxlbmNlXHJcbiAgICAvLyBiZXR3ZWVuIHRoZSBjaGFuZ2UgaW4gY2hhcmdlcyBhbmQgdGhlIGFsZXJ0LlxyXG4gICAgY29uc3QgZWxlY3Ryb25VdHRlcmFuY2UgPSBuZXcgVXR0ZXJhbmNlKCB7XHJcbiAgICAgIGFsZXJ0U3RhYmxlRGVsYXk6IDEwMDBcclxuICAgIH0gKTtcclxuXHJcbiAgICBsZXQgcHJpb3JDaGFyZ2UgPSAwO1xyXG5cclxuICAgIC8vIHBkb20gLSB3aGVuIGVsZWN0cm9ucyBlbnRlciBvciBsZWF2ZSB0aGUgYm9keSwgYW5ub3VuY2UgdGhpcyBjaGFuZ2Ugd2l0aCBhIHN0YXR1cyB1cGRhdGUgdG8gYXNzaXN0aXZlIHRlY2hub2xvZ3lcclxuICAgIGNvbnN0IHNldEVsZWN0cm9uU3RhdHVzID0gKCkgPT4ge1xyXG4gICAgICBsZXQgYWxlcnRTdHJpbmc7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRDaGFyZ2UgPSBtb2RlbC5lbGVjdHJvbkdyb3VwLmNvdW50O1xyXG5cclxuICAgICAgaWYgKCBjdXJyZW50Q2hhcmdlID49IHByaW9yQ2hhcmdlICkge1xyXG4gICAgICAgIGFsZXJ0U3RyaW5nID0gU3RyaW5nVXRpbHMuZmlsbEluKCBlbGVjdHJvbnNUb3RhbERlc2NyaXB0aW9uUGF0dGVyblN0cmluZywgeyB2YWx1ZTogY3VycmVudENoYXJnZSB9ICk7XHJcblxyXG4gICAgICAgIHRoaXMudm9pY2luZ0NvbnRleHRSZXNwb25zZSA9IFN0cmluZ1V0aWxzLmZpbGxJbiggJ3t7cXVhbGl0YXRpdmVEZXNjcmlwdGlvbn19IGVsZWN0cm9ucyBvbiBib2R5Jywge1xyXG4gICAgICAgICAgcXVhbGl0YXRpdmVEZXNjcmlwdGlvbjogdGhpcy5nZXRRdWFsaXRhdGl2ZUNoYXJnZURlc2NyaXB0aW9uKCBjdXJyZW50Q2hhcmdlIClcclxuICAgICAgICB9ICk7XHJcbiAgICAgICAgdGhpcy52b2ljaW5nU3BlYWtDb250ZXh0UmVzcG9uc2UoKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuXHJcbiAgICAgICAgbGV0IHJlZ2lvblRleHQgPSAnJztcclxuICAgICAgICBpZiAoIGFybU5vZGUucmVnaW9uQXREaXNjaGFyZ2UgJiYgYXJtTm9kZS5yZWdpb25BdERpc2NoYXJnZS50ZXh0ICkge1xyXG4gICAgICAgICAgcmVnaW9uVGV4dCA9IGFybU5vZGUucmVnaW9uQXREaXNjaGFyZ2UudGV4dC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYWxlcnRTdHJpbmcgPSBTdHJpbmdVdGlscy5maWxsSW4oIGVsZWN0cm9uc1RvdGFsQWZ0ZXJEaXNjaGFyZ2VQYXR0ZXJuU3RyaW5nLCB7XHJcbiAgICAgICAgICBvbGRWYWx1ZTogcHJpb3JDaGFyZ2UsXHJcbiAgICAgICAgICBuZXdWYWx1ZTogY3VycmVudENoYXJnZSxcclxuICAgICAgICAgIHJlZ2lvbjogcmVnaW9uVGV4dFxyXG4gICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgdGhpcy52b2ljaW5nQ29udGV4dFJlc3BvbnNlID0gU3RyaW5nVXRpbHMuZmlsbEluKCAne3txdWFsaXRhdGl2ZURlc2NyaXB0aW9ufX0gZWxlY3Ryb25zIGRpc2NoYXJnZWQgd2l0aCB7e3JlZ2lvbn19LicsIHtcclxuICAgICAgICAgIHF1YWxpdGF0aXZlRGVzY3JpcHRpb246IHRoaXMuZ2V0UXVhbGl0YXRpdmVDaGFyZ2VEZXNjcmlwdGlvbiggcHJpb3JDaGFyZ2UgLSBjdXJyZW50Q2hhcmdlICksXHJcbiAgICAgICAgICByZWdpb246IHJlZ2lvblRleHRcclxuICAgICAgICB9ICk7XHJcbiAgICAgICAgdGhpcy52b2ljaW5nU3BlYWtDb250ZXh0UmVzcG9uc2UoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZWxlY3Ryb25VdHRlcmFuY2UuYWxlcnQgPSBhbGVydFN0cmluZztcclxuICAgICAgdGhpcy5hbGVydERlc2NyaXB0aW9uVXR0ZXJhbmNlKCBlbGVjdHJvblV0dGVyYW5jZSApO1xyXG5cclxuICAgICAgLy8gZm9yIGhhcHRpYyBmZWVkYmFjaywgZXhwZXJpbWVudGFsXHJcbiAgICAgIG1vZGVsLnV0dGVyYW5jZUFkZGVkRW1pdHRlci5lbWl0KCBhbGVydFN0cmluZyApO1xyXG5cclxuICAgICAgcHJpb3JDaGFyZ2UgPSBjdXJyZW50Q2hhcmdlO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBpZiBuZXcgZWxlY3Ryb24gYWRkZWQgdG8gbW9kZWwgLSBjcmVhdGUgYW5kIGFkZCBuZXcgbm9kZSB0byBsZWdcclxuICAgIGNvbnN0IGVsZWN0cm9uQWRkZWRMaXN0ZW5lciA9IGFkZGVkID0+IHtcclxuXHJcbiAgICAgIC8vIGFuZCB0aGUgdmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlbGVjdHJvblxyXG4gICAgICB0aGlzLmFkZENoaWxkKCBuZXcgRWxlY3Ryb25Ob2RlKCBhZGRlZCwgbW9kZWwubGVnLCBtb2RlbC5hcm0gKSApO1xyXG5cclxuICAgICAgLy8gcGRvbSAtIGFubm91bmNlIHRoZSBzdGF0ZSBvZiBjaGFyZ2VzIHdpdGggYSBzdGF0dXMgdXBkYXRlXHJcbiAgICAgIHNldEVsZWN0cm9uU3RhdHVzKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFRoZSBlbGVjdHJvbidzIHZpZXcgaXMgcmVtb3ZlZCB3aGVuIHRoZSBlbGVjdHJvbiBpcyBkaXNwb3NlZCwgc2VlIEVsZWN0cm9uTm9kZS5qc1xyXG4gICAgbW9kZWwuZWxlY3Ryb25Hcm91cC5lbGVtZW50Q3JlYXRlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIGVsZWN0cm9uQWRkZWRMaXN0ZW5lciApO1xyXG4gICAgbW9kZWwuZWxlY3Ryb25Hcm91cC5mb3JFYWNoKCBlbGVjdHJvbkFkZGVkTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyB1cGRhdGUgc3RhdHVzIHdoZW5ldmVyIGFuIGVsZWN0cm9uIGRpc2NoYXJnZSBoYXMgZW5kZWQgLSBkaXNwb3NhbCBpcyBub3QgbmVjZXNzYXJ5XHJcbiAgICBtb2RlbC5kaXNjaGFyZ2VFbmRlZEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHNldEVsZWN0cm9uU3RhdHVzICk7XHJcblxyXG4gICAgLy8gd2hlbiB0aGUgbW9kZWwgaXMgcmVzZXQsIHVwZGF0ZSBwcmlvciBjaGFyZ2UgLSBkaXNwb3NhbCBub3QgbmVjZXNzYXJ5XHJcbiAgICBtb2RlbC5yZXNldEVtaXR0ZXIuYWRkTGlzdGVuZXIoICgpID0+IHtcclxuICAgICAgcHJpb3JDaGFyZ2UgPSAwO1xyXG4gICAgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGEgcXVhbGl0YXRpdmUgZGVzY3JpcHRpb24gb2YgdGhlIGNoYXJnZSB2YWx1ZS4gV2lsbCByZXR1cm4gc29tZXRoaW5nIGxpa2VcclxuICAgKiBcIkEgZmV3XCIgb3IgXCJBIGxhcmdlIGFtb3VudCBvZlwiLCBzZWUgUVVBTElUQVRJVkVfREVTQ1JJUFRJT05fTUFQIGFib3ZlLlxyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBjaGFyZ2VcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxyXG4gICAqL1xyXG4gIGdldFF1YWxpdGF0aXZlQ2hhcmdlRGVzY3JpcHRpb24oIGNoYXJnZSApIHtcclxuICAgIGxldCBxdWFsaXRhdGl2ZURlc2NyaXB0aW9uO1xyXG4gICAgUVVBTElUQVRJVkVfREVTQ1JJUFRJT05fTUFQLmZvckVhY2goICggdmFsdWUsIGtleSApID0+IHtcclxuICAgICAgaWYgKCBrZXkuY29udGFpbnMoIGNoYXJnZSApICkge1xyXG4gICAgICAgIHF1YWxpdGF0aXZlRGVzY3JpcHRpb24gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHF1YWxpdGF0aXZlRGVzY3JpcHRpb24sICdubyBkZXNjcmlwdGlvbiBmb3VuZCBmb3IgY2hhcmdlJyApO1xyXG4gICAgcmV0dXJuIHF1YWxpdGF0aXZlRGVzY3JpcHRpb247XHJcbiAgfVxyXG59XHJcblxyXG5qb2huVHJhdm9sdGFnZS5yZWdpc3RlciggJ0VsZWN0cm9uTGF5ZXJOb2RlJywgRWxlY3Ryb25MYXllck5vZGUgKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IEVsZWN0cm9uTGF5ZXJOb2RlOyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxLQUFLLE1BQU0sNkJBQTZCO0FBQy9DLE9BQU9DLFdBQVcsTUFBTSwrQ0FBK0M7QUFDdkUsU0FBU0MsSUFBSSxFQUFFQyxPQUFPLFFBQVEsbUNBQW1DO0FBQ2pFLE9BQU9DLFNBQVMsTUFBTSw2Q0FBNkM7QUFDbkUsT0FBT0MsY0FBYyxNQUFNLHlCQUF5QjtBQUNwRCxPQUFPQyxxQkFBcUIsTUFBTSxnQ0FBZ0M7QUFDbEUsT0FBT0MsWUFBWSxNQUFNLG1CQUFtQjtBQUU1QyxNQUFNQyxzQ0FBc0MsR0FBR0YscUJBQXFCLENBQUNHLElBQUksQ0FBQ0MsU0FBUyxDQUFDQyx1QkFBdUI7QUFDM0csTUFBTUMseUNBQXlDLEdBQUdOLHFCQUFxQixDQUFDRyxJQUFJLENBQUNDLFNBQVMsQ0FBQ0csMEJBQTBCO0FBRWpILE1BQU1DLDJCQUEyQixHQUFHLElBQUlDLEdBQUcsQ0FBQyxDQUFDO0FBQzdDRCwyQkFBMkIsQ0FBQ0UsR0FBRyxDQUFFLElBQUloQixLQUFLLENBQUUsQ0FBQyxFQUFFLENBQUUsQ0FBQyxFQUFFLElBQUssQ0FBQztBQUMxRGMsMkJBQTJCLENBQUNFLEdBQUcsQ0FBRSxJQUFJaEIsS0FBSyxDQUFFLENBQUMsRUFBRSxDQUFFLENBQUMsRUFBRSxVQUFXLENBQUM7QUFDaEVjLDJCQUEyQixDQUFDRSxHQUFHLENBQUUsSUFBSWhCLEtBQUssQ0FBRSxDQUFDLEVBQUUsQ0FBRSxDQUFDLEVBQUUsT0FBUSxDQUFDO0FBQzdEYywyQkFBMkIsQ0FBQ0UsR0FBRyxDQUFFLElBQUloQixLQUFLLENBQUUsRUFBRSxFQUFFLEVBQUcsQ0FBQyxFQUFFLFNBQVUs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