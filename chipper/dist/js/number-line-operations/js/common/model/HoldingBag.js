// Copyright 2020-2021, University of Colorado Boulder

/**
 * HoldingBag is the area in the model where items that have value can be held.  Vague, I admit, but that's what it is.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import Vector2 from '../../../../dot/js/Vector2.js';
import merge from '../../../../phet-core/js/merge.js';
import numberLineOperations from '../../numberLineOperations.js';

// constants
const RADIUS = 125;

// stock item acceptance tests
const ACCEPT_EVERYTHING = () => true;
const ACCEPT_ONLY_POSITIVE_VALUES = valueItem => valueItem.value > 0;
const ACCEPT_ONLY_NEGATIVE_VALUES = valueItem => valueItem.value < 0;
class HoldingBag {
  /**
   * @param {Vector2} position - position in model space of the center of the circular storage area
   * @param {Object} [options]
   */
  constructor(position, options) {
    options = merge({
      // @function - a predicate that defines what sort of items this can hold
      itemAcceptanceTest: ACCEPT_EVERYTHING,
      // @number - the maximum number of items that this bag can hold
      capacity: 4
    }, options);

    // options validation
    assert && assert(options.capacity >= 4 && options.capacity <= 5, `unsupported capacity: ${options.capacity}`);

    // @public (read-only)
    this.position = position;

    // @public (read-only)
    this.radius = RADIUS;

    // @public (read-only) {ValueItem[]} - value items that are currently in this bag, use methods to access
    this.containedItemList = [];

    // @private
    this.itemAcceptanceTest = options.itemAcceptanceTest;
    this.capacity = options.capacity;

    // @private {Vector2[]} - positions where items can be placed within the bag
    this.possibleItemPositions = [];
    if (this.capacity === 4) {
      // Several of the factors in the position calculation were empirically determined based on the artwork of the
      // items and the bag and can be adjust if needed when things change.
      _.times(this.capacity, index => {
        const xPosition = this.position.x;
        const yPosition = this.position.y - this.radius * 0.3 + index * this.radius * 0.33;
        this.possibleItemPositions.push(new Vector2(xPosition, yPosition));
      });
    } else if (this.capacity === 5) {
      // Several of the factors in the position calculation were empirically determined based on the size of the items
      // that go with this capacity and the artwork for the bag.  These can be adjust if needed when things change.
      _.times(this.capacity, index => {
        let xPosition;
        let yPosition;
        if (index === 0) {
          xPosition = this.position.x;
          yPosition = this.position.y - this.radius * 0.35;
        } else {
          xPosition = this.position.x + (index % 2 ? -1 : 1) * this.radius * 0.35;
          yPosition = this.position.y + Math.sign(index - 2.5) * this.radius * 0.25 + this.radius * 0.25;
        }
        this.possibleItemPositions.push(new Vector2(xPosition, yPosition));
      });
    }
  }

  /**
   * Test if this bag accepts this type of item.
   * @param {ValueItem }item
   * @public
   */
  acceptsItem(item) {
    return this.itemAcceptanceTest(item);
  }

  /**
   * Add the provide item to this bag.
   * @param {ValueItem} item
   * @public
   */
  addItem(item) {
    assert && assert(this.itemAcceptanceTest(item), 'this bag does not accept this type of item');
    assert && assert(this.containedItemList.indexOf(item) === -1, 'item is already in bag');
    assert && assert(this.containedItemList.length < this.capacity, 'there is insufficient space in bag for this item');
    this.containedItemList.push(item);
    item.inBagProperty.set(true);
    this.moveNewItemIntoPosition(item);
  }

  /**
   * Remove an item from this bag.
   * @param {ValueItem} item
   * @public
   */
  removeItem(item) {
    assert && assert(this.containedItemList.indexOf(item) !== -1, 'item is not in bag');
    this.containedItemList = _.without(this.containedItemList, item);
    item.inBagProperty.set(false);

    // The design team decided to consolidate the items in the bag when there are 4, but not to do so when there are 5.
    // This was made for purely aesthetic purposes, and can be changed or made configurable if desired.
    if (this.capacity === 4) {
      this.consolidateItems();
    }
  }

  /**
   * @param {ValueItem} item
   * @returns {boolean}
   * @public
   */
  containsItem(item) {
    return this.containedItemList.indexOf(item) !== -1;
  }

  /**
   * @returns {number} - total value of the items currently in this bag
   * @public
   */
  getTotalValue() {
    return this.containedItemList.reduce((total, item) => total + item.value, 0);
  }

  /**
   * Test whether a value item is within the "capture range" of this bag.
   * @param {ValueItem} item
   * @returns {boolean}
   * @public
   */
  isWithinCaptureRange(item) {
    return item.positionProperty.value.distance(this.position) <= this.radius;
  }

  /**
   * Move a newly added item into the correct position.  This assumes that the item has already been added to the list
   * of contained items and just needs to be moved into place.
   * @param newItem
   * @private
   */
  moveNewItemIntoPosition(newItem) {
    const itemIndex = this.containedItemList.indexOf(newItem);
    assert && assert(itemIndex >= 0, 'item is not contained (must be added before calling this method)');
    assert && assert(this.containedItemList.length <= this.capacity, 'too many items in bag');
    if (this.capacity === 4) {
      newItem.animateTo(this.possibleItemPositions[itemIndex]);
    } else if (this.capacity === 5) {
      // Find the first unoccupied position.
      const firstUnoccupiedPosition = this.possibleItemPositions.find(position => {
        return this.containedItemList.find(item => item.positionProperty.value.equals(position)) === undefined;
      });
      newItem.animateTo(firstUnoccupiedPosition);
    }
  }

  /**
   * Adjust the positions of the items in this bag such that the unoccupied positions are all at the end of the position
   * list.
   * @private
   */
  consolidateItems() {
    this.containedItemList.forEach((item, index) => {
      const position = this.possibleItemPositions[index];
      if (!item.positionProperty.value.equals(this.possibleItemPositions[index])) {
        item.animateTo(position);
      }
    });
  }
}
HoldingBag.ACCEPT_ONLY_POSITIVE_VALUES = ACCEPT_ONLY_POSITIVE_VALUES;
HoldingBag.ACCEPT_ONLY_NEGATIVE_VALUES = ACCEPT_ONLY_NEGATIVE_VALUES;
numberLineOperations.register('HoldingBag', HoldingBag);
export default HoldingBag;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWZWN0b3IyIiwibWVyZ2UiLCJudW1iZXJMaW5lT3BlcmF0aW9ucyIsIlJBRElVUyIsIkFDQ0VQVF9FVkVSWVRISU5HIiwiQUNDRVBUX09OTFlfUE9TSVRJVkVfVkFMVUVTIiwidmFsdWVJdGVtIiwidmFsdWUiLCJBQ0NFUFRfT05MWV9ORUdBVElWRV9WQUxVRVMiLCJIb2xkaW5nQmFnIiwiY29uc3RydWN0b3IiLCJwb3NpdGlvbiIsIm9wdGlvbnMiLCJpdGVtQWNjZXB0YW5jZVRlc3QiLCJjYXBhY2l0eSIsImFzc2VydCIsInJhZGl1cyIsImNvbnRhaW5lZEl0ZW1MaXN0IiwicG9zc2libGVJdGVtUG9zaXRpb25zIiwiXyIsInRpbWVzIiwiaW5kZXgiLCJ4UG9zaXRpb24iLCJ4IiwieVBvc2l0aW9uIiwieSIsInB1c2giLCJNYXRoIiwic2lnbiIsImFjY2VwdHNJdGVtIiwiaXRlbSIsImFkZEl0ZW0iLCJpbmRleE9mIiwibGVuZ3RoIiwiaW5CYWdQcm9wZXJ0eSIsInNldCIsIm1vdmVOZXdJdGVtSW50b1Bvc2l0aW9uIiwicmVtb3ZlSXRlbSIsIndpdGhvdXQiLCJjb25zb2xpZGF0ZUl0ZW1zIiwiY29udGFpbnNJdGVtIiwiZ2V0VG90YWxWYWx1ZSIsInJlZHVjZSIsInRvdGFsIiwiaXNXaXRoaW5DYXB0dXJlUmFuZ2UiLCJwb3NpdGlvblByb3BlcnR5IiwiZGlzdGFuY2UiLCJuZXdJdGVtIiwiaXRlbUluZGV4IiwiYW5pbWF0ZVRvIiwiZmlyc3RVbm9jY3VwaWVkUG9zaXRpb24iLCJmaW5kIiwiZXF1YWxzIiwidW5kZWZpbmVkIiwiZm9yRWFjaCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiSG9sZGluZ0JhZy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIxLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcblxyXG4vKipcclxuICogSG9sZGluZ0JhZyBpcyB0aGUgYXJlYSBpbiB0aGUgbW9kZWwgd2hlcmUgaXRlbXMgdGhhdCBoYXZlIHZhbHVlIGNhbiBiZSBoZWxkLiAgVmFndWUsIEkgYWRtaXQsIGJ1dCB0aGF0J3Mgd2hhdCBpdCBpcy5cclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jbyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBtZXJnZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvbWVyZ2UuanMnO1xyXG5pbXBvcnQgbnVtYmVyTGluZU9wZXJhdGlvbnMgZnJvbSAnLi4vLi4vbnVtYmVyTGluZU9wZXJhdGlvbnMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IFJBRElVUyA9IDEyNTtcclxuXHJcbi8vIHN0b2NrIGl0ZW0gYWNjZXB0YW5jZSB0ZXN0c1xyXG5jb25zdCBBQ0NFUFRfRVZFUllUSElORyA9ICgpID0+IHRydWU7XHJcbmNvbnN0IEFDQ0VQVF9PTkxZX1BPU0lUSVZFX1ZBTFVFUyA9IHZhbHVlSXRlbSA9PiB2YWx1ZUl0ZW0udmFsdWUgPiAwO1xyXG5jb25zdCBBQ0NFUFRfT05MWV9ORUdBVElWRV9WQUxVRVMgPSB2YWx1ZUl0ZW0gPT4gdmFsdWVJdGVtLnZhbHVlIDwgMDtcclxuXHJcbmNsYXNzIEhvbGRpbmdCYWcge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHBvc2l0aW9uIC0gcG9zaXRpb24gaW4gbW9kZWwgc3BhY2Ugb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY3VsYXIgc3RvcmFnZSBhcmVhXHJcbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBwb3NpdGlvbiwgb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuXHJcbiAgICAgIC8vIEBmdW5jdGlvbiAtIGEgcHJlZGljYXRlIHRoYXQgZGVmaW5lcyB3aGF0IHNvcnQgb2YgaXRlbXMgdGhpcyBjYW4gaG9sZFxyXG4gICAgICBpdGVtQWNjZXB0YW5jZVRlc3Q6IEFDQ0VQVF9FVkVSWVRISU5HLFxyXG5cclxuICAgICAgLy8gQG51bWJlciAtIHRoZSBtYXhpbXVtIG51bWJlciBvZiBpdGVtcyB0aGF0IHRoaXMgYmFnIGNhbiBob2xkXHJcbiAgICAgIGNhcGFjaXR5OiA0XHJcblxyXG4gICAgfSwgb3B0aW9ucyApO1xyXG5cclxuICAgIC8vIG9wdGlvbnMgdmFsaWRhdGlvblxyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggb3B0aW9ucy5jYXBhY2l0eSA+PSA0ICYmIG9wdGlvbnMuY2FwYWNpdHkgPD0gNSwgYHVuc3VwcG9ydGVkIGNhcGFjaXR5OiAke29wdGlvbnMuY2FwYWNpdHl9YCApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSlcclxuICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpXHJcbiAgICB0aGlzLnJhZGl1cyA9IFJBRElVUztcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtWYWx1ZUl0ZW1bXX0gLSB2YWx1ZSBpdGVtcyB0aGF0IGFyZSBjdXJyZW50bHkgaW4gdGhpcyBiYWcsIHVzZSBtZXRob2RzIHRvIGFjY2Vzc1xyXG4gICAgdGhpcy5jb250YWluZWRJdGVtTGlzdCA9IFtdO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLml0ZW1BY2NlcHRhbmNlVGVzdCA9IG9wdGlvbnMuaXRlbUFjY2VwdGFuY2VUZXN0O1xyXG4gICAgdGhpcy5jYXBhY2l0eSA9IG9wdGlvbnMuY2FwYWNpdHk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge1ZlY3RvcjJbXX0gLSBwb3NpdGlvbnMgd2hlcmUgaXRlbXMgY2FuIGJlIHBsYWNlZCB3aXRoaW4gdGhlIGJhZ1xyXG4gICAgdGhpcy5wb3NzaWJsZUl0ZW1Qb3NpdGlvbnMgPSBbXTtcclxuICAgIGlmICggdGhpcy5jYXBhY2l0eSA9PT0gNCApIHtcclxuXHJcbiAgICAgIC8vIFNldmVyYWwgb2YgdGhlIGZhY3RvcnMgaW4gdGhlIHBvc2l0aW9uIGNhbGN1bGF0aW9uIHdlcmUgZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCBiYXNlZCBvbiB0aGUgYXJ0d29yayBvZiB0aGVcclxuICAgICAgLy8gaXRlbXMgYW5kIHRoZSBiYWcgYW5kIGNhbiBiZSBhZGp1c3QgaWYgbmVlZGVkIHdoZW4gdGhpbmdzIGNoYW5nZS5cclxuICAgICAgXy50aW1lcyggdGhpcy5jYXBhY2l0eSwgaW5kZXggPT4ge1xyXG4gICAgICAgIGNvbnN0IHhQb3NpdGlvbiA9IHRoaXMucG9zaXRpb24ueDtcclxuICAgICAgICBjb25zdCB5UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLnkgLSAoIHRoaXMucmFkaXVzICogMC4zICkgKyBpbmRleCAqIHRoaXMucmFkaXVzICogMC4zMztcclxuICAgICAgICB0aGlzLnBvc3NpYmxlSXRlbVBvc2l0aW9ucy5wdXNoKCBuZXcgVmVjdG9yMiggeFBvc2l0aW9uLCB5UG9zaXRpb24gKSApO1xyXG4gICAgICB9ICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGhpcy5jYXBhY2l0eSA9PT0gNSApIHtcclxuXHJcbiAgICAgIC8vIFNldmVyYWwgb2YgdGhlIGZhY3RvcnMgaW4gdGhlIHBvc2l0aW9uIGNhbGN1bGF0aW9uIHdlcmUgZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCBiYXNlZCBvbiB0aGUgc2l6ZSBvZiB0aGUgaXRlbXNcclxuICAgICAgLy8gdGhhdCBnbyB3aXRoIHRoaXMgY2FwYWNpdHkgYW5kIHRoZSBhcnR3b3JrIGZvciB0aGUgYmFnLiAgVGhlc2UgY2FuIGJlIGFkanVzdCBpZiBuZWVkZWQgd2hlbiB0aGluZ3MgY2hhbmdlLlxyXG4gICAgICBfLnRpbWVzKCB0aGlzLmNhcGFjaXR5LCBpbmRleCA9PiB7XHJcbiAgICAgICAgbGV0IHhQb3NpdGlvbjtcclxuICAgICAgICBsZXQgeVBvc2l0aW9uO1xyXG4gICAgICAgIGlmICggaW5kZXggPT09IDAgKSB7XHJcbiAgICAgICAgICB4UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLng7XHJcbiAgICAgICAgICB5UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLnkgLSAoIHRoaXMucmFkaXVzICogMC4zNSApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIHhQb3NpdGlvbiA9IHRoaXMucG9zaXRpb24ueCArICggaW5kZXggJSAyID8gLTEgOiAxICkgKiB0aGlzLnJhZGl1cyAqIDAuMzU7XHJcbiAgICAgICAgICB5UG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLnkgKyBNYXRoLnNpZ24oIGluZGV4IC0gMi41ICkgKiB0aGlzLnJhZGl1cyAqIDAuMjUgKyB0aGlzLnJhZGl1cyAqIDAuMjU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucG9zc2libGVJdGVtUG9zaXRpb25zLnB1c2goIG5ldyBWZWN0b3IyKCB4UG9zaXRpb24sIHlQb3NpdGlvbiApICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRlc3QgaWYgdGhpcyBiYWcgYWNjZXB0cyB0aGlzIHR5cGUgb2YgaXRlbS5cclxuICAgKiBAcGFyYW0ge1ZhbHVlSXRlbSB9aXRlbVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBhY2NlcHRzSXRlbSggaXRlbSApIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1BY2NlcHRhbmNlVGVzdCggaXRlbSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIHRoZSBwcm92aWRlIGl0ZW0gdG8gdGhpcyBiYWcuXHJcbiAgICogQHBhcmFtIHtWYWx1ZUl0ZW19IGl0ZW1cclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgYWRkSXRlbSggaXRlbSApIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMuaXRlbUFjY2VwdGFuY2VUZXN0KCBpdGVtICksICd0aGlzIGJhZyBkb2VzIG5vdCBhY2NlcHQgdGhpcyB0eXBlIG9mIGl0ZW0nICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LmluZGV4T2YoIGl0ZW0gKSA9PT0gLTEsICdpdGVtIGlzIGFscmVhZHkgaW4gYmFnJyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5jb250YWluZWRJdGVtTGlzdC5sZW5ndGggPCB0aGlzLmNhcGFjaXR5LCAndGhlcmUgaXMgaW5zdWZmaWNpZW50IHNwYWNlIGluIGJhZyBmb3IgdGhpcyBpdGVtJyApO1xyXG4gICAgdGhpcy5jb250YWluZWRJdGVtTGlzdC5wdXNoKCBpdGVtICk7XHJcbiAgICBpdGVtLmluQmFnUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICB0aGlzLm1vdmVOZXdJdGVtSW50b1Bvc2l0aW9uKCBpdGVtICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmUgYW4gaXRlbSBmcm9tIHRoaXMgYmFnLlxyXG4gICAqIEBwYXJhbSB7VmFsdWVJdGVtfSBpdGVtXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHJlbW92ZUl0ZW0oIGl0ZW0gKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LmluZGV4T2YoIGl0ZW0gKSAhPT0gLTEsICdpdGVtIGlzIG5vdCBpbiBiYWcnICk7XHJcbiAgICB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0ID0gXy53aXRob3V0KCB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LCBpdGVtICk7XHJcbiAgICBpdGVtLmluQmFnUHJvcGVydHkuc2V0KCBmYWxzZSApO1xyXG5cclxuICAgIC8vIFRoZSBkZXNpZ24gdGVhbSBkZWNpZGVkIHRvIGNvbnNvbGlkYXRlIHRoZSBpdGVtcyBpbiB0aGUgYmFnIHdoZW4gdGhlcmUgYXJlIDQsIGJ1dCBub3QgdG8gZG8gc28gd2hlbiB0aGVyZSBhcmUgNS5cclxuICAgIC8vIFRoaXMgd2FzIG1hZGUgZm9yIHB1cmVseSBhZXN0aGV0aWMgcHVycG9zZXMsIGFuZCBjYW4gYmUgY2hhbmdlZCBvciBtYWRlIGNvbmZpZ3VyYWJsZSBpZiBkZXNpcmVkLlxyXG4gICAgaWYgKCB0aGlzLmNhcGFjaXR5ID09PSA0ICkge1xyXG4gICAgICB0aGlzLmNvbnNvbGlkYXRlSXRlbXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7VmFsdWVJdGVtfSBpdGVtXHJcbiAgICogQHJldHVybnMge2Jvb2xlYW59XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGNvbnRhaW5zSXRlbSggaXRlbSApIHtcclxuICAgIHJldHVybiB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LmluZGV4T2YoIGl0ZW0gKSAhPT0gLTE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcmV0dXJucyB7bnVtYmVyfSAtIHRvdGFsIHZhbHVlIG9mIHRoZSBpdGVtcyBjdXJyZW50bHkgaW4gdGhpcyBiYWdcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZ2V0VG90YWxWYWx1ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LnJlZHVjZSggKCB0b3RhbCwgaXRlbSApID0+IHRvdGFsICsgaXRlbS52YWx1ZSwgMCApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGVzdCB3aGV0aGVyIGEgdmFsdWUgaXRlbSBpcyB3aXRoaW4gdGhlIFwiY2FwdHVyZSByYW5nZVwiIG9mIHRoaXMgYmFnLlxyXG4gICAqIEBwYXJhbSB7VmFsdWVJdGVtfSBpdGVtXHJcbiAgICogQHJldHVybnMge2Jvb2xlYW59XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIGlzV2l0aGluQ2FwdHVyZVJhbmdlKCBpdGVtICkge1xyXG4gICAgcmV0dXJuIGl0ZW0ucG9zaXRpb25Qcm9wZXJ0eS52YWx1ZS5kaXN0YW5jZSggdGhpcy5wb3NpdGlvbiApIDw9IHRoaXMucmFkaXVzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTW92ZSBhIG5ld2x5IGFkZGVkIGl0ZW0gaW50byB0aGUgY29ycmVjdCBwb3NpdGlvbi4gIFRoaXMgYXNzdW1lcyB0aGF0IHRoZSBpdGVtIGhhcyBhbHJlYWR5IGJlZW4gYWRkZWQgdG8gdGhlIGxpc3RcclxuICAgKiBvZiBjb250YWluZWQgaXRlbXMgYW5kIGp1c3QgbmVlZHMgdG8gYmUgbW92ZWQgaW50byBwbGFjZS5cclxuICAgKiBAcGFyYW0gbmV3SXRlbVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgbW92ZU5ld0l0ZW1JbnRvUG9zaXRpb24oIG5ld0l0ZW0gKSB7XHJcblxyXG4gICAgY29uc3QgaXRlbUluZGV4ID0gdGhpcy5jb250YWluZWRJdGVtTGlzdC5pbmRleE9mKCBuZXdJdGVtICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBpdGVtSW5kZXggPj0gMCwgJ2l0ZW0gaXMgbm90IGNvbnRhaW5lZCAobXVzdCBiZSBhZGRlZCBiZWZvcmUgY2FsbGluZyB0aGlzIG1ldGhvZCknICk7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0Lmxlbmd0aCA8PSB0aGlzLmNhcGFjaXR5LCAndG9vIG1hbnkgaXRlbXMgaW4gYmFnJyApO1xyXG4gICAgaWYgKCB0aGlzLmNhcGFjaXR5ID09PSA0ICkge1xyXG4gICAgICBuZXdJdGVtLmFuaW1hdGVUbyggdGhpcy5wb3NzaWJsZUl0ZW1Qb3NpdGlvbnNbIGl0ZW1JbmRleCBdICk7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICggdGhpcy5jYXBhY2l0eSA9PT0gNSApIHtcclxuXHJcbiAgICAgIC8vIEZpbmQgdGhlIGZpcnN0IHVub2NjdXBpZWQgcG9zaXRpb24uXHJcbiAgICAgIGNvbnN0IGZpcnN0VW5vY2N1cGllZFBvc2l0aW9uID0gdGhpcy5wb3NzaWJsZUl0ZW1Qb3NpdGlvbnMuZmluZCggcG9zaXRpb24gPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lZEl0ZW1MaXN0LmZpbmQoIGl0ZW0gPT4gaXRlbS5wb3NpdGlvblByb3BlcnR5LnZhbHVlLmVxdWFscyggcG9zaXRpb24gKSApID09PSB1bmRlZmluZWQ7XHJcbiAgICAgIH0gKTtcclxuICAgICAgbmV3SXRlbS5hbmltYXRlVG8oIGZpcnN0VW5vY2N1cGllZFBvc2l0aW9uICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGp1c3QgdGhlIHBvc2l0aW9ucyBvZiB0aGUgaXRlbXMgaW4gdGhpcyBiYWcgc3VjaCB0aGF0IHRoZSB1bm9jY3VwaWVkIHBvc2l0aW9ucyBhcmUgYWxsIGF0IHRoZSBlbmQgb2YgdGhlIHBvc2l0aW9uXHJcbiAgICogbGlzdC5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGNvbnNvbGlkYXRlSXRlbXMoKSB7XHJcblxyXG4gICAgdGhpcy5jb250YWluZWRJdGVtTGlzdC5mb3JFYWNoKCAoIGl0ZW0sIGluZGV4ICkgPT4ge1xyXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMucG9zc2libGVJdGVtUG9zaXRpb25zWyBpbmRleCBdO1xyXG4gICAgICBpZiAoICFpdGVtLnBvc2l0aW9uUHJvcGVydHkudmFsdWUuZXF1YWxzKCB0aGlzLnBvc3NpYmxlSXRlbVBvc2l0aW9uc1sgaW5kZXggXSApICkge1xyXG4gICAgICAgIGl0ZW0uYW5pbWF0ZVRvKCBwb3NpdGlvbiApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5Ib2xkaW5nQmFnLkFDQ0VQVF9PTkxZX1BPU0lUSVZFX1ZBTFVFUyA9IEFDQ0VQVF9PTkxZX1BPU0lUSVZFX1ZBTFVFUztcclxuSG9sZGluZ0JhZy5BQ0NFUFRfT05MWV9ORUdBVElWRV9WQUxVRVMgPSBBQ0NFUFRfT05MWV9ORUdBVElWRV9WQUxVRVM7XHJcblxyXG5udW1iZXJMaW5lT3BlcmF0aW9ucy5yZWdpc3RlciggJ0hvbGRpbmdCYWcnLCBIb2xkaW5nQmFnICk7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