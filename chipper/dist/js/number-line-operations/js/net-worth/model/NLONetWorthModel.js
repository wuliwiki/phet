// Copyright 2020-2021, University of Colorado Boulder

/**
 * NLONetWorthModel is the primary model for the "Net Worth" screen.
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Dimension2 from '../../../../dot/js/Dimension2.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import HoldingBag from '../../common/model/HoldingBag.js';
import HoldingBox from '../../common/model/HoldingBox.js';
import Operation from '../../common/model/Operation.js';
import OperationTrackingNumberLine from '../../common/model/OperationTrackingNumberLine.js';
import ValueItem from '../../common/model/ValueItem.js';
import NLOConstants from '../../common/NLOConstants.js';
import numberLineOperations from '../../numberLineOperations.js';

// constants
const HOLDING_BOX_SIZE = new Dimension2(122, 300); // empirically determined to fit the items that will go in it

class NLONetWorthModel {
  /**
   * @param {Tandem} tandem
   */
  constructor(tandem) {
    // @public (read-write) - total net worth, which is total assets minus total liabilities
    this.netWorthProperty = new NumberProperty(0);

    // @public (read-write)
    this.netWorthAccordionBoxExpandedProperty = new BooleanProperty(true, {
      tandem: tandem.createTandem('netWorthAccordionBoxExpandedProperty')
    });

    // @public (read-only) - the number line upon which the net worth and the various operation will be portrayed
    this.numberLine = new OperationTrackingNumberLine(NLOConstants.LAYOUT_BOUNDS.center.minusXY(0, 110), {
      initialDisplayedRange: NLOConstants.NET_WORTH_RANGE,
      tickMarksInitiallyVisible: true,
      preventOverlap: false,
      automaticallyDeactivateOperations: true,
      // width of the number line in model space, number empirically determined to match design
      widthInModelSpace: NLOConstants.NUMBER_LINE_WIDTH
    });

    // convenience variable (note that there is only one operation shown on this number line)
    const operation = this.numberLine.operations[0];

    // @public (read-only) - list of balance sheet items (i.e. assets and debts) that the user can manipulate
    this.balanceSheetItems = [new ValueItem(-400), new ValueItem(-300), new ValueItem(-200), new ValueItem(-100), new ValueItem(100), new ValueItem(200), new ValueItem(300), new ValueItem(400)];

    // Add the storage areas for the balance sheet items - this is where they reside when not in use.
    const balanceItemBoxesTop = 310;
    this.debtsBox = new HoldingBox(new Vector2(105, balanceItemBoxesTop), HOLDING_BOX_SIZE, this.balanceSheetItems.filter(item => item.value < 0).sort((a, b) => b.value - a.value));
    this.assetsBox = new HoldingBox(new Vector2(800, balanceItemBoxesTop), HOLDING_BOX_SIZE, this.balanceSheetItems.filter(item => item.value > 0).sort());
    this.storageBoxes = [this.assetsBox, this.debtsBox];

    // Add the asset and debt bags.
    const balanceItemBagsCenterY = 475;
    this.debtsBag = new HoldingBag(new Vector2(380, balanceItemBagsCenterY), {
      itemAcceptanceTest: HoldingBag.ACCEPT_ONLY_NEGATIVE_VALUES
    });
    this.assetsBag = new HoldingBag(new Vector2(645, balanceItemBagsCenterY), {
      itemAcceptanceTest: HoldingBag.ACCEPT_ONLY_POSITIVE_VALUES
    });
    this.bags = [this.debtsBag, this.assetsBag];

    // Monitor the isDragging state of each balance sheet item and, when it transitions to false, either add it to a
    // bag or return it to a storage box based on where it was dropped.  No unlink is necessary.
    this.balanceSheetItems.forEach(balanceSheetItem => {
      balanceSheetItem.isDraggingProperty.lazyLink(isDragging => {
        if (isDragging) {
          // If the item was in one of the bags, remove it.
          this.bags.forEach(bag => {
            if (bag.containsItem(balanceSheetItem)) {
              bag.removeItem(balanceSheetItem);

              // Update the operation on the number line to reflect this latest transaction.  Cycle the inactive state
              // to trigger the animation in the view.
              operation.isActiveProperty.set(false);
              this.numberLine.startingValueProperty.set(this.netWorthProperty.value);
              operation.operationTypeProperty.set(Operation.SUBTRACTION);
              operation.amountProperty.set(balanceSheetItem.value);
              operation.isActiveProperty.set(true);
            }
          });
        } else {
          // The item was released by the user.  Add it to a bag or return it to the appropriate storage area.
          let addedToBag = false;
          this.bags.forEach(bag => {
            if (bag.acceptsItem(balanceSheetItem) && bag.isWithinCaptureRange(balanceSheetItem)) {
              bag.addItem(balanceSheetItem);
              addedToBag = true;

              // Update the starting value.
              this.numberLine.startingValueProperty.set(this.netWorthProperty.value);

              // Update the operation.  The "active" state is cycled in order to trigger animation in the view.
              operation.isActiveProperty.set(false);
              operation.operationTypeProperty.set(Operation.ADDITION);
              operation.amountProperty.set(balanceSheetItem.value);
              operation.isActiveProperty.set(true);
            }
          });
          if (!addedToBag) {
            this.returnItemToStorage(balanceSheetItem);
          }
        }
        this.netWorthProperty.set(this.assetsBag.getTotalValue() + this.debtsBag.getTotalValue());
      });
    });
  }

  /**
   * Resets the model.
   * @public
   */
  reset() {
    // Reset initial state of all balance sheet items.
    this.balanceSheetItems.forEach(balanceSheetItem => {
      // See if this item is in a bag and remove it if so.
      let itemRemovedFromBag = false;
      this.bags.forEach(bag => {
        if (bag.containsItem(balanceSheetItem)) {
          bag.removeItem(balanceSheetItem);
          itemRemovedFromBag = true;
        }
      });

      // If it was removed from a bag, add it back to its storage box.
      if (itemRemovedFromBag) {
        this.returnItemToStorage(balanceSheetItem);
      }
    });
    this.netWorthAccordionBoxExpandedProperty.reset();
    this.numberLine.reset();
    this.netWorthProperty.reset();
  }

  /**
   * @param {ValueItem} item
   * @private
   */
  returnItemToStorage(item) {
    this.storageBoxes.forEach(storageBox => {
      if (storageBox.holdsItem(item)) {
        storageBox.returnItem(item, true);
      }
    });
  }

  /**
   * @public
   */
  step() {
    this.numberLine.step();
  }
}
numberLineOperations.register('NLONetWorthModel', NLONetWorthModel);
export default NLONetWorthModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsIkRpbWVuc2lvbjIiLCJWZWN0b3IyIiwiSG9sZGluZ0JhZyIsIkhvbGRpbmdCb3giLCJPcGVyYXRpb24iLCJPcGVyYXRpb25UcmFja2luZ051bWJlckxpbmUiLCJWYWx1ZUl0ZW0iLCJOTE9Db25zdGFudHMiLCJudW1iZXJMaW5lT3BlcmF0aW9ucyIsIkhPTERJTkdfQk9YX1NJWkUiLCJOTE9OZXRXb3J0aE1vZGVsIiwiY29uc3RydWN0b3IiLCJ0YW5kZW0iLCJuZXRXb3J0aFByb3BlcnR5IiwibmV0V29ydGhBY2NvcmRpb25Cb3hFeHBhbmRlZFByb3BlcnR5IiwiY3JlYXRlVGFuZGVtIiwibnVtYmVyTGluZSIsIkxBWU9VVF9CT1VORFMiLCJjZW50ZXIiLCJtaW51c1hZIiwiaW5pdGlhbERpc3BsYXllZFJhbmdlIiwiTkVUX1dPUlRIX1JBTkdFIiwidGlja01hcmtzSW5pdGlhbGx5VmlzaWJsZSIsInByZXZlbnRPdmVybGFwIiwiYXV0b21hdGljYWxseURlYWN0aXZhdGVPcGVyYXRpb25zIiwid2lkdGhJbk1vZGVsU3BhY2UiLCJOVU1CRVJfTElORV9XSURUSCIsIm9wZXJhdGlvbiIsIm9wZXJhdGlvbnMiLCJiYWxhbmNlU2hlZXRJdGVtcyIsImJhbGFuY2VJdGVtQm94ZXNUb3AiLCJkZWJ0c0JveCIsImZpbHRlciIsIml0ZW0iLCJ2YWx1ZSIsInNvcnQiLCJhIiwiYiIsImFzc2V0c0JveCIsInN0b3JhZ2VCb3hlcyIsImJhbGFuY2VJdGVtQmFnc0NlbnRlclkiLCJkZWJ0c0JhZyIsIml0ZW1BY2NlcHRhbmNlVGVzdCIsIkFDQ0VQVF9PTkxZX05FR0FUSVZFX1ZBTFVFUyIsImFzc2V0c0JhZyIsIkFDQ0VQVF9PTkxZX1BPU0lUSVZFX1ZBTFVFUyIsImJhZ3MiLCJmb3JFYWNoIiwiYmFsYW5jZVNoZWV0SXRlbSIsImlzRHJhZ2dpbmdQcm9wZXJ0eSIsImxhenlMaW5rIiwiaXNEcmFnZ2luZyIsImJhZyIsImNvbnRhaW5zSXRlbSIsInJlbW92ZUl0ZW0iLCJpc0FjdGl2ZVByb3BlcnR5Iiwic2V0Iiwic3RhcnRpbmdWYWx1ZVByb3BlcnR5Iiwib3BlcmF0aW9uVHlwZVByb3BlcnR5IiwiU1VCVFJBQ1RJT04iLCJhbW91bnRQcm9wZXJ0eSIsImFkZGVkVG9CYWciLCJhY2NlcHRzSXRlbSIsImlzV2l0aGluQ2FwdHVyZVJhbmdlIiwiYWRkSXRlbSIsIkFERElUSU9OIiwicmV0dXJuSXRlbVRvU3RvcmFnZSIsImdldFRvdGFsVmFsdWUiLCJyZXNldCIsIml0ZW1SZW1vdmVkRnJvbUJhZyIsInN0b3JhZ2VCb3giLCJob2xkc0l0ZW0iLCJyZXR1cm5JdGVtIiwic3RlcCIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiTkxPTmV0V29ydGhNb2RlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMC0yMDIxLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBOTE9OZXRXb3J0aE1vZGVsIGlzIHRoZSBwcmltYXJ5IG1vZGVsIGZvciB0aGUgXCJOZXQgV29ydGhcIiBzY3JlZW4uXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9obiBCbGFuY28gKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEJvb2xlYW5Qcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Jvb2xlYW5Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBOdW1iZXJQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL051bWJlclByb3BlcnR5LmpzJztcclxuaW1wb3J0IERpbWVuc2lvbjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0RpbWVuc2lvbjIuanMnO1xyXG5pbXBvcnQgVmVjdG9yMiBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvVmVjdG9yMi5qcyc7XHJcbmltcG9ydCBIb2xkaW5nQmFnIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9Ib2xkaW5nQmFnLmpzJztcclxuaW1wb3J0IEhvbGRpbmdCb3ggZnJvbSAnLi4vLi4vY29tbW9uL21vZGVsL0hvbGRpbmdCb3guanMnO1xyXG5pbXBvcnQgT3BlcmF0aW9uIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9PcGVyYXRpb24uanMnO1xyXG5pbXBvcnQgT3BlcmF0aW9uVHJhY2tpbmdOdW1iZXJMaW5lIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9PcGVyYXRpb25UcmFja2luZ051bWJlckxpbmUuanMnO1xyXG5pbXBvcnQgVmFsdWVJdGVtIGZyb20gJy4uLy4uL2NvbW1vbi9tb2RlbC9WYWx1ZUl0ZW0uanMnO1xyXG5pbXBvcnQgTkxPQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9OTE9Db25zdGFudHMuanMnO1xyXG5pbXBvcnQgbnVtYmVyTGluZU9wZXJhdGlvbnMgZnJvbSAnLi4vLi4vbnVtYmVyTGluZU9wZXJhdGlvbnMuanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IEhPTERJTkdfQk9YX1NJWkUgPSBuZXcgRGltZW5zaW9uMiggMTIyLCAzMDAgKTsgLy8gZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCB0byBmaXQgdGhlIGl0ZW1zIHRoYXQgd2lsbCBnbyBpbiBpdFxyXG5cclxuY2xhc3MgTkxPTmV0V29ydGhNb2RlbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7VGFuZGVtfSB0YW5kZW1cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvciggdGFuZGVtICkge1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtd3JpdGUpIC0gdG90YWwgbmV0IHdvcnRoLCB3aGljaCBpcyB0b3RhbCBhc3NldHMgbWludXMgdG90YWwgbGlhYmlsaXRpZXNcclxuICAgIHRoaXMubmV0V29ydGhQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggMCApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtd3JpdGUpXHJcbiAgICB0aGlzLm5ldFdvcnRoQWNjb3JkaW9uQm94RXhwYW5kZWRQcm9wZXJ0eSA9IG5ldyBCb29sZWFuUHJvcGVydHkoIHRydWUsIHtcclxuICAgICAgdGFuZGVtOiB0YW5kZW0uY3JlYXRlVGFuZGVtKCAnbmV0V29ydGhBY2NvcmRpb25Cb3hFeHBhbmRlZFByb3BlcnR5JyApXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSAtIHRoZSBudW1iZXIgbGluZSB1cG9uIHdoaWNoIHRoZSBuZXQgd29ydGggYW5kIHRoZSB2YXJpb3VzIG9wZXJhdGlvbiB3aWxsIGJlIHBvcnRyYXllZFxyXG4gICAgdGhpcy5udW1iZXJMaW5lID0gbmV3IE9wZXJhdGlvblRyYWNraW5nTnVtYmVyTGluZShcclxuICAgICAgTkxPQ29uc3RhbnRzLkxBWU9VVF9CT1VORFMuY2VudGVyLm1pbnVzWFkoIDAsIDExMCApLFxyXG4gICAgICB7XHJcbiAgICAgICAgaW5pdGlhbERpc3BsYXllZFJhbmdlOiBOTE9Db25zdGFudHMuTkVUX1dPUlRIX1JBTkdFLFxyXG4gICAgICAgIHRpY2tNYXJrc0luaXRpYWxseVZpc2libGU6IHRydWUsXHJcbiAgICAgICAgcHJldmVudE92ZXJsYXA6IGZhbHNlLFxyXG4gICAgICAgIGF1dG9tYXRpY2FsbHlEZWFjdGl2YXRlT3BlcmF0aW9uczogdHJ1ZSxcclxuXHJcbiAgICAgICAgLy8gd2lkdGggb2YgdGhlIG51bWJlciBsaW5lIGluIG1vZGVsIHNwYWNlLCBudW1iZXIgZW1waXJpY2FsbHkgZGV0ZXJtaW5lZCB0byBtYXRjaCBkZXNpZ25cclxuICAgICAgICB3aWR0aEluTW9kZWxTcGFjZTogTkxPQ29uc3RhbnRzLk5VTUJFUl9MSU5FX1dJRFRIXHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgLy8gY29udmVuaWVuY2UgdmFyaWFibGUgKG5vdGUgdGhhdCB0aGVyZSBpcyBvbmx5IG9uZSBvcGVyYXRpb24gc2hvd24gb24gdGhpcyBudW1iZXIgbGluZSlcclxuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMubnVtYmVyTGluZS5vcGVyYXRpb25zWyAwIF07XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSAtIGxpc3Qgb2YgYmFsYW5jZSBzaGVldCBpdGVtcyAoaS5lLiBhc3NldHMgYW5kIGRlYnRzKSB0aGF0IHRoZSB1c2VyIGNhbiBtYW5pcHVsYXRlXHJcbiAgICB0aGlzLmJhbGFuY2VTaGVldEl0ZW1zID0gW1xyXG4gICAgICBuZXcgVmFsdWVJdGVtKCAtNDAwICksXHJcbiAgICAgIG5ldyBWYWx1ZUl0ZW0oIC0zMDAgKSxcclxuICAgICAgbmV3IFZhbHVlSXRlbSggLTIwMCApLFxyXG4gICAgICBuZXcgVmFsdWVJdGVtKCAtMTAwICksXHJcbiAgICAgIG5ldyBWYWx1ZUl0ZW0oIDEwMCApLFxyXG4gICAgICBuZXcgVmFsdWVJdGVtKCAyMDAgKSxcclxuICAgICAgbmV3IFZhbHVlSXRlbSggMzAwICksXHJcbiAgICAgIG5ldyBWYWx1ZUl0ZW0oIDQwMCApXHJcbiAgICBdO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgc3RvcmFnZSBhcmVhcyBmb3IgdGhlIGJhbGFuY2Ugc2hlZXQgaXRlbXMgLSB0aGlzIGlzIHdoZXJlIHRoZXkgcmVzaWRlIHdoZW4gbm90IGluIHVzZS5cclxuICAgIGNvbnN0IGJhbGFuY2VJdGVtQm94ZXNUb3AgPSAzMTA7XHJcbiAgICB0aGlzLmRlYnRzQm94ID0gbmV3IEhvbGRpbmdCb3goXHJcbiAgICAgIG5ldyBWZWN0b3IyKCAxMDUsIGJhbGFuY2VJdGVtQm94ZXNUb3AgKSxcclxuICAgICAgSE9MRElOR19CT1hfU0laRSxcclxuICAgICAgdGhpcy5iYWxhbmNlU2hlZXRJdGVtcy5maWx0ZXIoIGl0ZW0gPT4gaXRlbS52YWx1ZSA8IDAgKS5zb3J0KCAoIGEsIGIgKSA9PiBiLnZhbHVlIC0gYS52YWx1ZSApXHJcbiAgICApO1xyXG4gICAgdGhpcy5hc3NldHNCb3ggPSBuZXcgSG9sZGluZ0JveChcclxuICAgICAgbmV3IFZlY3RvcjIoIDgwMCwgYmFsYW5jZUl0ZW1Cb3hlc1RvcCApLFxyXG4gICAgICBIT0xESU5HX0JPWF9TSVpFLFxyXG4gICAgICB0aGlzLmJhbGFuY2VTaGVldEl0ZW1zLmZpbHRlciggaXRlbSA9PiBpdGVtLnZhbHVlID4gMCApLnNvcnQoKVxyXG4gICAgKTtcclxuICAgIHRoaXMuc3RvcmFnZUJveGVzID0gWyB0aGlzLmFzc2V0c0JveCwgdGhpcy5kZWJ0c0JveCBdO1xyXG5cclxuICAgIC8vIEFkZCB0aGUgYXNzZXQgYW5kIGRlYnQgYmFncy5cclxuICAgIGNvbnN0IGJhbGFuY2VJdGVtQmFnc0NlbnRlclkgPSA0NzU7XHJcbiAgICB0aGlzLmRlYnRzQmFnID0gbmV3IEhvbGRpbmdCYWcoIG5ldyBWZWN0b3IyKCAzODAsIGJhbGFuY2VJdGVtQmFnc0NlbnRlclkgKSwge1xyXG4gICAgICBpdGVtQWNjZXB0YW5jZVRlc3Q6IEhvbGRpbmdCYWcuQUNDRVBUX09OTFlfTkVHQVRJVkVfVkFMVUVTXHJcbiAgICB9ICk7XHJcbiAgICB0aGlzLmFzc2V0c0JhZyA9IG5ldyBIb2xkaW5nQmFnKCBuZXcgVmVjdG9yMiggNjQ1LCBiYWxhbmNlSXRlbUJhZ3NDZW50ZXJZICksIHtcclxuICAgICAgaXRlbUFjY2VwdGFuY2VUZXN0OiBIb2xkaW5nQmFnLkFDQ0VQVF9PTkxZX1BPU0lUSVZFX1ZBTFVFU1xyXG4gICAgfSApO1xyXG4gICAgdGhpcy5iYWdzID0gWyB0aGlzLmRlYnRzQmFnLCB0aGlzLmFzc2V0c0JhZyBdO1xyXG5cclxuICAgIC8vIE1vbml0b3IgdGhlIGlzRHJhZ2dpbmcgc3RhdGUgb2YgZWFjaCBiYWxhbmNlIHNoZWV0IGl0ZW0gYW5kLCB3aGVuIGl0IHRyYW5zaXRpb25zIHRvIGZhbHNlLCBlaXRoZXIgYWRkIGl0IHRvIGFcclxuICAgIC8vIGJhZyBvciByZXR1cm4gaXQgdG8gYSBzdG9yYWdlIGJveCBiYXNlZCBvbiB3aGVyZSBpdCB3YXMgZHJvcHBlZC4gIE5vIHVubGluayBpcyBuZWNlc3NhcnkuXHJcbiAgICB0aGlzLmJhbGFuY2VTaGVldEl0ZW1zLmZvckVhY2goIGJhbGFuY2VTaGVldEl0ZW0gPT4ge1xyXG4gICAgICBiYWxhbmNlU2hlZXRJdGVtLmlzRHJhZ2dpbmdQcm9wZXJ0eS5sYXp5TGluayggaXNEcmFnZ2luZyA9PiB7XHJcbiAgICAgICAgaWYgKCBpc0RyYWdnaW5nICkge1xyXG5cclxuICAgICAgICAgIC8vIElmIHRoZSBpdGVtIHdhcyBpbiBvbmUgb2YgdGhlIGJhZ3MsIHJlbW92ZSBpdC5cclxuICAgICAgICAgIHRoaXMuYmFncy5mb3JFYWNoKCBiYWcgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIGJhZy5jb250YWluc0l0ZW0oIGJhbGFuY2VTaGVldEl0ZW0gKSApIHtcclxuICAgICAgICAgICAgICBiYWcucmVtb3ZlSXRlbSggYmFsYW5jZVNoZWV0SXRlbSApO1xyXG5cclxuICAgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG9wZXJhdGlvbiBvbiB0aGUgbnVtYmVyIGxpbmUgdG8gcmVmbGVjdCB0aGlzIGxhdGVzdCB0cmFuc2FjdGlvbi4gIEN5Y2xlIHRoZSBpbmFjdGl2ZSBzdGF0ZVxyXG4gICAgICAgICAgICAgIC8vIHRvIHRyaWdnZXIgdGhlIGFuaW1hdGlvbiBpbiB0aGUgdmlldy5cclxuICAgICAgICAgICAgICBvcGVyYXRpb24uaXNBY3RpdmVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgICAgICAgICAgdGhpcy5udW1iZXJMaW5lLnN0YXJ0aW5nVmFsdWVQcm9wZXJ0eS5zZXQoIHRoaXMubmV0V29ydGhQcm9wZXJ0eS52YWx1ZSApO1xyXG4gICAgICAgICAgICAgIG9wZXJhdGlvbi5vcGVyYXRpb25UeXBlUHJvcGVydHkuc2V0KCBPcGVyYXRpb24uU1VCVFJBQ1RJT04gKTtcclxuICAgICAgICAgICAgICBvcGVyYXRpb24uYW1vdW50UHJvcGVydHkuc2V0KCBiYWxhbmNlU2hlZXRJdGVtLnZhbHVlICk7XHJcbiAgICAgICAgICAgICAgb3BlcmF0aW9uLmlzQWN0aXZlUHJvcGVydHkuc2V0KCB0cnVlICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcblxyXG4gICAgICAgICAgLy8gVGhlIGl0ZW0gd2FzIHJlbGVhc2VkIGJ5IHRoZSB1c2VyLiAgQWRkIGl0IHRvIGEgYmFnIG9yIHJldHVybiBpdCB0byB0aGUgYXBwcm9wcmlhdGUgc3RvcmFnZSBhcmVhLlxyXG4gICAgICAgICAgbGV0IGFkZGVkVG9CYWcgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMuYmFncy5mb3JFYWNoKCBiYWcgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIGJhZy5hY2NlcHRzSXRlbSggYmFsYW5jZVNoZWV0SXRlbSApICYmIGJhZy5pc1dpdGhpbkNhcHR1cmVSYW5nZSggYmFsYW5jZVNoZWV0SXRlbSApICkge1xyXG4gICAgICAgICAgICAgIGJhZy5hZGRJdGVtKCBiYWxhbmNlU2hlZXRJdGVtICk7XHJcbiAgICAgICAgICAgICAgYWRkZWRUb0JhZyA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgc3RhcnRpbmcgdmFsdWUuXHJcbiAgICAgICAgICAgICAgdGhpcy5udW1iZXJMaW5lLnN0YXJ0aW5nVmFsdWVQcm9wZXJ0eS5zZXQoIHRoaXMubmV0V29ydGhQcm9wZXJ0eS52YWx1ZSApO1xyXG5cclxuICAgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG9wZXJhdGlvbi4gIFRoZSBcImFjdGl2ZVwiIHN0YXRlIGlzIGN5Y2xlZCBpbiBvcmRlciB0byB0cmlnZ2VyIGFuaW1hdGlvbiBpbiB0aGUgdmlldy5cclxuICAgICAgICAgICAgICBvcGVyYXRpb24uaXNBY3RpdmVQcm9wZXJ0eS5zZXQoIGZhbHNlICk7XHJcbiAgICAgICAgICAgICAgb3BlcmF0aW9uLm9wZXJhdGlvblR5cGVQcm9wZXJ0eS5zZXQoIE9wZXJhdGlvbi5BRERJVElPTiApO1xyXG4gICAgICAgICAgICAgIG9wZXJhdGlvbi5hbW91bnRQcm9wZXJ0eS5zZXQoIGJhbGFuY2VTaGVldEl0ZW0udmFsdWUgKTtcclxuICAgICAgICAgICAgICBvcGVyYXRpb24uaXNBY3RpdmVQcm9wZXJ0eS5zZXQoIHRydWUgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSApO1xyXG4gICAgICAgICAgaWYgKCAhYWRkZWRUb0JhZyApIHtcclxuICAgICAgICAgICAgdGhpcy5yZXR1cm5JdGVtVG9TdG9yYWdlKCBiYWxhbmNlU2hlZXRJdGVtICk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubmV0V29ydGhQcm9wZXJ0eS5zZXQoIHRoaXMuYXNzZXRzQmFnLmdldFRvdGFsVmFsdWUoKSArIHRoaXMuZGVidHNCYWcuZ2V0VG90YWxWYWx1ZSgpICk7XHJcbiAgICAgIH0gKTtcclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc2V0cyB0aGUgbW9kZWwuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHJlc2V0KCkge1xyXG5cclxuICAgIC8vIFJlc2V0IGluaXRpYWwgc3RhdGUgb2YgYWxsIGJhbGFuY2Ugc2hlZXQgaXRlbXMuXHJcbiAgICB0aGlzLmJhbGFuY2VTaGVldEl0ZW1zLmZvckVhY2goIGJhbGFuY2VTaGVldEl0ZW0gPT4ge1xyXG5cclxuICAgICAgLy8gU2VlIGlmIHRoaXMgaXRlbSBpcyBpbiBhIGJhZyBhbmQgcmVtb3ZlIGl0IGlmIHNvLlxyXG4gICAgICBsZXQgaXRlbVJlbW92ZWRGcm9tQmFnID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuYmFncy5mb3JFYWNoKCBiYWcgPT4ge1xyXG4gICAgICAgIGlmICggYmFnLmNvbnRhaW5zSXRlbSggYmFsYW5jZVNoZWV0SXRlbSApICkge1xyXG4gICAgICAgICAgYmFnLnJlbW92ZUl0ZW0oIGJhbGFuY2VTaGVldEl0ZW0gKTtcclxuICAgICAgICAgIGl0ZW1SZW1vdmVkRnJvbUJhZyA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9ICk7XHJcblxyXG4gICAgICAvLyBJZiBpdCB3YXMgcmVtb3ZlZCBmcm9tIGEgYmFnLCBhZGQgaXQgYmFjayB0byBpdHMgc3RvcmFnZSBib3guXHJcbiAgICAgIGlmICggaXRlbVJlbW92ZWRGcm9tQmFnICkge1xyXG4gICAgICAgIHRoaXMucmV0dXJuSXRlbVRvU3RvcmFnZSggYmFsYW5jZVNoZWV0SXRlbSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5uZXRXb3J0aEFjY29yZGlvbkJveEV4cGFuZGVkUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMubnVtYmVyTGluZS5yZXNldCgpO1xyXG4gICAgdGhpcy5uZXRXb3J0aFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge1ZhbHVlSXRlbX0gaXRlbVxyXG4gICAqIEBwcml2YXRlXHJcbiAgICovXHJcbiAgcmV0dXJuSXRlbVRvU3RvcmFnZSggaXRlbSApIHtcclxuICAgIHRoaXMuc3RvcmFnZUJveGVzLmZvckVhY2goIHN0b3JhZ2VCb3ggPT4ge1xyXG4gICAgICBpZiAoIHN0b3JhZ2VCb3guaG9sZHNJdGVtKCBpdGVtICkgKSB7XHJcbiAgICAgICAgc3RvcmFnZUJveC5yZXR1cm5JdGVtKCBpdGVtLCB0cnVlICk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICBzdGVwKCkge1xyXG4gICAgdGhpcy5udW1iZXJMaW5lLnN0ZXAoKTtcclxuICB9XHJcbn1cclxuXHJcbm51bWJlckxpbmVPcGVyYXRpb25zLnJlZ2lzdGVyKCAnTkxPTmV0V29ydGhNb2RlbCcsIE5MT05ldFdvcnRoTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgTkxPTmV0V29ydGhNb2RlbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsZUFBZSxNQUFNLHdDQUF3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