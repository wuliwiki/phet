// Copyright 2017, University of Colorado Boulder

/**
 * Deploys an rc version after incrementing the test version number.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const SimVersion = require('../common/SimVersion');
const booleanPrompt = require('../common/booleanPrompt');
const build = require('../common/build');
const buildLocal = require('../common/buildLocal');
const buildServerRequest = require('../common/buildServerRequest');
const checkoutMaster = require('../common/checkoutMaster');
const checkoutTarget = require('../common/checkoutTarget');
const devDirectoryExists = require('../common/devDirectoryExists');
const getDependencies = require('../common/getDependencies');
const getRepoVersion = require('../common/getRepoVersion');
const gitCheckout = require('../common/gitCheckout');
const gitIsClean = require('../common/gitIsClean');
const gitPush = require('../common/gitPush');
const hasRemoteBranch = require('../common/hasRemoteBranch');
const loadJSON = require('../common/loadJSON');
const npmUpdate = require('../common/npmUpdate');
const setRepoVersion = require('../common/setRepoVersion');
const updateDependenciesJSON = require('../common/updateDependenciesJSON');
const vpnCheck = require('../common/vpnCheck');
const createRelease = require('./createRelease');
const grunt = require('grunt');
const _ = require('lodash'); // eslint-disable-line no-unused-vars

/**
 * Deploys an rc version after incrementing the test version number.
 * @public
 *
 * @param {string} repo
 * @param {string} branch
 * @param {Array.<string>} brands
 * @param {boolean} noninteractive
 * @param {string} [message] - Optional message to append to the version-increment commit.
 * @returns {Promise.<SimVersion>}
 */
module.exports = async function (repo, branch, brands, noninteractive, message) {
  SimVersion.ensureReleaseBranch(branch);
  if (!(await vpnCheck())) {
    grunt.fail.fatal('VPN or being on campus is required for this build. Ensure VPN is enabled, or that you have access to phet-server2.int.colorado.edu');
  }
  const isClean = await gitIsClean(repo);
  if (!isClean) {
    throw new Error(`Unclean status in ${repo}, cannot create release branch`);
  }
  if (!(await hasRemoteBranch(repo, branch))) {
    if (noninteractive || !(await booleanPrompt(`Release branch ${branch} does not exist. Create it?`, false))) {
      throw new Error('Aborted rc deployment due to non-existing branch');
    }
    await createRelease(repo, branch, brands);
  }

  // PhET-iO simulations require validation for RCs. Error out if "phet.phet-io.validation=false" is in package.json.
  await gitCheckout(repo, branch);
  if (brands.includes('phet-io')) {
    const packageObject = await loadJSON(`../${repo}/package.json`);
    if (packageObject.phet['phet-io'] && packageObject.phet['phet-io'].hasOwnProperty('validation') && !packageObject.phet['phet-io'].validation) {
      throw new Error('PhET-iO simulations require validation for RCs');
    }
  }
  await checkoutTarget(repo, branch, true); // include npm update

  try {
    const previousVersion = await getRepoVersion(repo);
    if (previousVersion.testType !== 'rc' && previousVersion.testType !== null) {
      throw new Error(`Aborted rc deployment since the version number cannot be incremented safely (testType:${previousVersion.testType})`);
    }
    const version = new SimVersion(previousVersion.major, previousVersion.minor, previousVersion.maintenance + (previousVersion.testType === null ? 1 : 0), {
      testType: 'rc',
      testNumber: previousVersion.testNumber ? previousVersion.testNumber + 1 : 1
    });
    const versionString = version.toString();
    const simPath = buildLocal.devDeployPath + repo;
    const versionPath = `${simPath}/${versionString}`;
    const versionPathExists = await devDirectoryExists(versionPath);
    if (versionPathExists) {
      throw new Error(`Directory ${versionPath} already exists.  If you intend to replace the content then remove the directory manually from ${buildLocal.devDeployServer}.`);
    }
    if (!(await booleanPrompt(`Deploy ${versionString} to ${buildLocal.devDeployServer}`, noninteractive))) {
      throw new Error('Aborted rc deployment');
    }
    await setRepoVersion(repo, version, message);
    await gitPush(repo, branch);

    // Make sure our correct npm dependencies are set
    await npmUpdate(repo);
    await npmUpdate('chipper');
    await npmUpdate('perennial-alias');

    // No special options required here, as we send the main request to the build server
    grunt.log.writeln(await build(repo, {
      brands: brands
    }));
    if (!(await booleanPrompt(`Please test the built version of ${repo}.\nIs it ready to deploy`, noninteractive))) {
      // Abort version update
      await setRepoVersion(repo, previousVersion, message);
      await gitPush(repo, branch);

      // Abort checkout
      await checkoutMaster(repo, true);
      throw new Error('Aborted rc deployment (aborted version change too).');
    }

    // Move over dependencies.json and commit/push
    await updateDependenciesJSON(repo, brands, versionString, branch);

    // Send the build request
    await buildServerRequest(repo, version, branch, await getDependencies(repo), {
      locales: ['en'],
      brands: brands,
      servers: ['dev']
    });

    // Move back to master
    await checkoutMaster(repo, true);
    const versionURL = `https://phet-dev.colorado.edu/html/${repo}/${versionString}`;
    if (brands.includes('phet')) {
      grunt.log.writeln(`Deployed: ${versionURL}/phet/${repo}_all_phet.html`);
    }
    if (brands.includes('phet-io')) {
      grunt.log.writeln(`Deployed: ${versionURL}/phet-io/`);
    }
    grunt.log.writeln('Please wait for the build-server to complete the deployment, and then test!');
    return version;
  } catch (e) {
    grunt.log.warn('Detected failure during deploy, reverting to master');
    await checkoutMaster(repo, true);
    throw e;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaW1WZXJzaW9uIiwicmVxdWlyZSIsImJvb2xlYW5Qcm9tcHQiLCJidWlsZCIsImJ1aWxkTG9jYWwiLCJidWlsZFNlcnZlclJlcXVlc3QiLCJjaGVja291dE1hc3RlciIsImNoZWNrb3V0VGFyZ2V0IiwiZGV2RGlyZWN0b3J5RXhpc3RzIiwiZ2V0RGVwZW5kZW5jaWVzIiwiZ2V0UmVwb1ZlcnNpb24iLCJnaXRDaGVja291dCIsImdpdElzQ2xlYW4iLCJnaXRQdXNoIiwiaGFzUmVtb3RlQnJhbmNoIiwibG9hZEpTT04iLCJucG1VcGRhdGUiLCJzZXRSZXBvVmVyc2lvbiIsInVwZGF0ZURlcGVuZGVuY2llc0pTT04iLCJ2cG5DaGVjayIsImNyZWF0ZVJlbGVhc2UiLCJncnVudCIsIl8iLCJtb2R1bGUiLCJleHBvcnRzIiwicmVwbyIsImJyYW5jaCIsImJyYW5kcyIsIm5vbmludGVyYWN0aXZlIiwibWVzc2FnZSIsImVuc3VyZVJlbGVhc2VCcmFuY2giLCJmYWlsIiwiZmF0YWwiLCJpc0NsZWFuIiwiRXJyb3IiLCJpbmNsdWRlcyIsInBhY2thZ2VPYmplY3QiLCJwaGV0IiwiaGFzT3duUHJvcGVydHkiLCJ2YWxpZGF0aW9uIiwicHJldmlvdXNWZXJzaW9uIiwidGVzdFR5cGUiLCJ2ZXJzaW9uIiwibWFqb3IiLCJtaW5vciIsIm1haW50ZW5hbmNlIiwidGVzdE51bWJlciIsInZlcnNpb25TdHJpbmciLCJ0b1N0cmluZyIsInNpbVBhdGgiLCJkZXZEZXBsb3lQYXRoIiwidmVyc2lvblBhdGgiLCJ2ZXJzaW9uUGF0aEV4aXN0cyIsImRldkRlcGxveVNlcnZlciIsImxvZyIsIndyaXRlbG4iLCJsb2NhbGVzIiwic2VydmVycyIsInZlcnNpb25VUkwiLCJlIiwid2FybiJdLCJzb3VyY2VzIjpbInJjLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE3LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBEZXBsb3lzIGFuIHJjIHZlcnNpb24gYWZ0ZXIgaW5jcmVtZW50aW5nIHRoZSB0ZXN0IHZlcnNpb24gbnVtYmVyLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuY29uc3QgU2ltVmVyc2lvbiA9IHJlcXVpcmUoICcuLi9jb21tb24vU2ltVmVyc2lvbicgKTtcclxuY29uc3QgYm9vbGVhblByb21wdCA9IHJlcXVpcmUoICcuLi9jb21tb24vYm9vbGVhblByb21wdCcgKTtcclxuY29uc3QgYnVpbGQgPSByZXF1aXJlKCAnLi4vY29tbW9uL2J1aWxkJyApO1xyXG5jb25zdCBidWlsZExvY2FsID0gcmVxdWlyZSggJy4uL2NvbW1vbi9idWlsZExvY2FsJyApO1xyXG5jb25zdCBidWlsZFNlcnZlclJlcXVlc3QgPSByZXF1aXJlKCAnLi4vY29tbW9uL2J1aWxkU2VydmVyUmVxdWVzdCcgKTtcclxuY29uc3QgY2hlY2tvdXRNYXN0ZXIgPSByZXF1aXJlKCAnLi4vY29tbW9uL2NoZWNrb3V0TWFzdGVyJyApO1xyXG5jb25zdCBjaGVja291dFRhcmdldCA9IHJlcXVpcmUoICcuLi9jb21tb24vY2hlY2tvdXRUYXJnZXQnICk7XHJcbmNvbnN0IGRldkRpcmVjdG9yeUV4aXN0cyA9IHJlcXVpcmUoICcuLi9jb21tb24vZGV2RGlyZWN0b3J5RXhpc3RzJyApO1xyXG5jb25zdCBnZXREZXBlbmRlbmNpZXMgPSByZXF1aXJlKCAnLi4vY29tbW9uL2dldERlcGVuZGVuY2llcycgKTtcclxuY29uc3QgZ2V0UmVwb1ZlcnNpb24gPSByZXF1aXJlKCAnLi4vY29tbW9uL2dldFJlcG9WZXJzaW9uJyApO1xyXG5jb25zdCBnaXRDaGVja291dCA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2l0Q2hlY2tvdXQnICk7XHJcbmNvbnN0IGdpdElzQ2xlYW4gPSByZXF1aXJlKCAnLi4vY29tbW9uL2dpdElzQ2xlYW4nICk7XHJcbmNvbnN0IGdpdFB1c2ggPSByZXF1aXJlKCAnLi4vY29tbW9uL2dpdFB1c2gnICk7XHJcbmNvbnN0IGhhc1JlbW90ZUJyYW5jaCA9IHJlcXVpcmUoICcuLi9jb21tb24vaGFzUmVtb3RlQnJhbmNoJyApO1xyXG5jb25zdCBsb2FkSlNPTiA9IHJlcXVpcmUoICcuLi9jb21tb24vbG9hZEpTT04nICk7XHJcbmNvbnN0IG5wbVVwZGF0ZSA9IHJlcXVpcmUoICcuLi9jb21tb24vbnBtVXBkYXRlJyApO1xyXG5jb25zdCBzZXRSZXBvVmVyc2lvbiA9IHJlcXVpcmUoICcuLi9jb21tb24vc2V0UmVwb1ZlcnNpb24nICk7XHJcbmNvbnN0IHVwZGF0ZURlcGVuZGVuY2llc0pTT04gPSByZXF1aXJlKCAnLi4vY29tbW9uL3VwZGF0ZURlcGVuZGVuY2llc0pTT04nICk7XHJcbmNvbnN0IHZwbkNoZWNrID0gcmVxdWlyZSggJy4uL2NvbW1vbi92cG5DaGVjaycgKTtcclxuY29uc3QgY3JlYXRlUmVsZWFzZSA9IHJlcXVpcmUoICcuL2NyZWF0ZVJlbGVhc2UnICk7XHJcbmNvbnN0IGdydW50ID0gcmVxdWlyZSggJ2dydW50JyApO1xyXG5jb25zdCBfID0gcmVxdWlyZSggJ2xvZGFzaCcgKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFyc1xyXG5cclxuLyoqXHJcbiAqIERlcGxveXMgYW4gcmMgdmVyc2lvbiBhZnRlciBpbmNyZW1lbnRpbmcgdGhlIHRlc3QgdmVyc2lvbiBudW1iZXIuXHJcbiAqIEBwdWJsaWNcclxuICpcclxuICogQHBhcmFtIHtzdHJpbmd9IHJlcG9cclxuICogQHBhcmFtIHtzdHJpbmd9IGJyYW5jaFxyXG4gKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBicmFuZHNcclxuICogQHBhcmFtIHtib29sZWFufSBub25pbnRlcmFjdGl2ZVxyXG4gKiBAcGFyYW0ge3N0cmluZ30gW21lc3NhZ2VdIC0gT3B0aW9uYWwgbWVzc2FnZSB0byBhcHBlbmQgdG8gdGhlIHZlcnNpb24taW5jcmVtZW50IGNvbW1pdC5cclxuICogQHJldHVybnMge1Byb21pc2UuPFNpbVZlcnNpb24+fVxyXG4gKi9cclxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyBmdW5jdGlvbiggcmVwbywgYnJhbmNoLCBicmFuZHMsIG5vbmludGVyYWN0aXZlLCBtZXNzYWdlICkge1xyXG4gIFNpbVZlcnNpb24uZW5zdXJlUmVsZWFzZUJyYW5jaCggYnJhbmNoICk7XHJcblxyXG4gIGlmICggISggYXdhaXQgdnBuQ2hlY2soKSApICkge1xyXG4gICAgZ3J1bnQuZmFpbC5mYXRhbCggJ1ZQTiBvciBiZWluZyBvbiBjYW1wdXMgaXMgcmVxdWlyZWQgZm9yIHRoaXMgYnVpbGQuIEVuc3VyZSBWUE4gaXMgZW5hYmxlZCwgb3IgdGhhdCB5b3UgaGF2ZSBhY2Nlc3MgdG8gcGhldC1zZXJ2ZXIyLmludC5jb2xvcmFkby5lZHUnICk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBpc0NsZWFuID0gYXdhaXQgZ2l0SXNDbGVhbiggcmVwbyApO1xyXG4gIGlmICggIWlzQ2xlYW4gKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoIGBVbmNsZWFuIHN0YXR1cyBpbiAke3JlcG99LCBjYW5ub3QgY3JlYXRlIHJlbGVhc2UgYnJhbmNoYCApO1xyXG4gIH1cclxuXHJcbiAgaWYgKCAhKCBhd2FpdCBoYXNSZW1vdGVCcmFuY2goIHJlcG8sIGJyYW5jaCApICkgKSB7XHJcbiAgICBpZiAoIG5vbmludGVyYWN0aXZlIHx8ICFhd2FpdCBib29sZWFuUHJvbXB0KCBgUmVsZWFzZSBicmFuY2ggJHticmFuY2h9IGRvZXMgbm90IGV4aXN0LiBDcmVhdGUgaXQ/YCwgZmFsc2UgKSApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCAnQWJvcnRlZCByYyBkZXBsb3ltZW50IGR1ZSB0byBub24tZXhpc3RpbmcgYnJhbmNoJyApO1xyXG4gICAgfVxyXG5cclxuICAgIGF3YWl0IGNyZWF0ZVJlbGVhc2UoIHJlcG8sIGJyYW5jaCwgYnJhbmRzICk7XHJcbiAgfVxyXG5cclxuICAvLyBQaEVULWlPIHNpbXVsYXRpb25zIHJlcXVpcmUgdmFsaWRhdGlvbiBmb3IgUkNzLiBFcnJvciBvdXQgaWYgXCJwaGV0LnBoZXQtaW8udmFsaWRhdGlvbj1mYWxzZVwiIGlzIGluIHBhY2thZ2UuanNvbi5cclxuICBhd2FpdCBnaXRDaGVja291dCggcmVwbywgYnJhbmNoICk7XHJcbiAgaWYgKCBicmFuZHMuaW5jbHVkZXMoICdwaGV0LWlvJyApICkge1xyXG4gICAgY29uc3QgcGFja2FnZU9iamVjdCA9IGF3YWl0IGxvYWRKU09OKCBgLi4vJHtyZXBvfS9wYWNrYWdlLmpzb25gICk7XHJcbiAgICBpZiAoIHBhY2thZ2VPYmplY3QucGhldFsgJ3BoZXQtaW8nIF0gJiYgcGFja2FnZU9iamVjdC5waGV0WyAncGhldC1pbycgXS5oYXNPd25Qcm9wZXJ0eSggJ3ZhbGlkYXRpb24nICkgJiZcclxuICAgICAgICAgIXBhY2thZ2VPYmplY3QucGhldFsgJ3BoZXQtaW8nIF0udmFsaWRhdGlvbiApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCAnUGhFVC1pTyBzaW11bGF0aW9ucyByZXF1aXJlIHZhbGlkYXRpb24gZm9yIFJDcycgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGF3YWl0IGNoZWNrb3V0VGFyZ2V0KCByZXBvLCBicmFuY2gsIHRydWUgKTsgLy8gaW5jbHVkZSBucG0gdXBkYXRlXHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBwcmV2aW91c1ZlcnNpb24gPSBhd2FpdCBnZXRSZXBvVmVyc2lvbiggcmVwbyApO1xyXG5cclxuICAgIGlmICggcHJldmlvdXNWZXJzaW9uLnRlc3RUeXBlICE9PSAncmMnICYmIHByZXZpb3VzVmVyc2lvbi50ZXN0VHlwZSAhPT0gbnVsbCApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCBgQWJvcnRlZCByYyBkZXBsb3ltZW50IHNpbmNlIHRoZSB2ZXJzaW9uIG51bWJlciBjYW5ub3QgYmUgaW5jcmVtZW50ZWQgc2FmZWx5ICh0ZXN0VHlwZToke3ByZXZpb3VzVmVyc2lvbi50ZXN0VHlwZX0pYCApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHZlcnNpb24gPSBuZXcgU2ltVmVyc2lvbiggcHJldmlvdXNWZXJzaW9uLm1ham9yLCBwcmV2aW91c1ZlcnNpb24ubWlub3IsIHByZXZpb3VzVmVyc2lvbi5tYWludGVuYW5jZSArICggcHJldmlvdXNWZXJzaW9uLnRlc3RUeXBlID09PSBudWxsID8gMSA6IDAgKSwge1xyXG4gICAgICB0ZXN0VHlwZTogJ3JjJyxcclxuICAgICAgdGVzdE51bWJlcjogcHJldmlvdXNWZXJzaW9uLnRlc3ROdW1iZXIgPyBwcmV2aW91c1ZlcnNpb24udGVzdE51bWJlciArIDEgOiAxXHJcbiAgICB9ICk7XHJcblxyXG4gICAgY29uc3QgdmVyc2lvblN0cmluZyA9IHZlcnNpb24udG9TdHJpbmcoKTtcclxuICAgIGNvbnN0IHNpbVBhdGggPSBidWlsZExvY2FsLmRldkRlcGxveVBhdGggKyByZXBvO1xyXG4gICAgY29uc3QgdmVyc2lvblBhdGggPSBgJHtzaW1QYXRofS8ke3ZlcnNpb25TdHJpbmd9YDtcclxuXHJcbiAgICBjb25zdCB2ZXJzaW9uUGF0aEV4aXN0cyA9IGF3YWl0IGRldkRpcmVjdG9yeUV4aXN0cyggdmVyc2lvblBhdGggKTtcclxuXHJcbiAgICBpZiAoIHZlcnNpb25QYXRoRXhpc3RzICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoIGBEaXJlY3RvcnkgJHt2ZXJzaW9uUGF0aH0gYWxyZWFkeSBleGlzdHMuICBJZiB5b3UgaW50ZW5kIHRvIHJlcGxhY2UgdGhlIGNvbnRlbnQgdGhlbiByZW1vdmUgdGhlIGRpcmVjdG9yeSBtYW51YWxseSBmcm9tICR7YnVpbGRMb2NhbC5kZXZEZXBsb3lTZXJ2ZXJ9LmAgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoICFhd2FpdCBib29sZWFuUHJvbXB0KCBgRGVwbG95ICR7dmVyc2lvblN0cmluZ30gdG8gJHtidWlsZExvY2FsLmRldkRlcGxveVNlcnZlcn1gLCBub25pbnRlcmFjdGl2ZSApICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoICdBYm9ydGVkIHJjIGRlcGxveW1lbnQnICk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgc2V0UmVwb1ZlcnNpb24oIHJlcG8sIHZlcnNpb24sIG1lc3NhZ2UgKTtcclxuICAgIGF3YWl0IGdpdFB1c2goIHJlcG8sIGJyYW5jaCApO1xyXG5cclxuICAgIC8vIE1ha2Ugc3VyZSBvdXIgY29ycmVjdCBucG0gZGVwZW5kZW5jaWVzIGFyZSBzZXRcclxuICAgIGF3YWl0IG5wbVVwZGF0ZSggcmVwbyApO1xyXG4gICAgYXdhaXQgbnBtVXBkYXRlKCAnY2hpcHBlcicgKTtcclxuICAgIGF3YWl0IG5wbVVwZGF0ZSggJ3BlcmVubmlhbC1hbGlhcycgKTtcclxuXHJcbiAgICAvLyBObyBzcGVjaWFsIG9wdGlvbnMgcmVxdWlyZWQgaGVyZSwgYXMgd2Ugc2VuZCB0aGUgbWFpbiByZXF1ZXN0IHRvIHRoZSBidWlsZCBzZXJ2ZXJcclxuICAgIGdydW50LmxvZy53cml0ZWxuKCBhd2FpdCBidWlsZCggcmVwbywge1xyXG4gICAgICBicmFuZHM6IGJyYW5kc1xyXG4gICAgfSApICk7XHJcblxyXG4gICAgaWYgKCAhYXdhaXQgYm9vbGVhblByb21wdCggYFBsZWFzZSB0ZXN0IHRoZSBidWlsdCB2ZXJzaW9uIG9mICR7cmVwb30uXFxuSXMgaXQgcmVhZHkgdG8gZGVwbG95YCwgbm9uaW50ZXJhY3RpdmUgKSApIHtcclxuICAgICAgLy8gQWJvcnQgdmVyc2lvbiB1cGRhdGVcclxuICAgICAgYXdhaXQgc2V0UmVwb1ZlcnNpb24oIHJlcG8sIHByZXZpb3VzVmVyc2lvbiwgbWVzc2FnZSApO1xyXG4gICAgICBhd2FpdCBnaXRQdXNoKCByZXBvLCBicmFuY2ggKTtcclxuXHJcbiAgICAgIC8vIEFib3J0IGNoZWNrb3V0XHJcbiAgICAgIGF3YWl0IGNoZWNrb3V0TWFzdGVyKCByZXBvLCB0cnVlICk7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvciggJ0Fib3J0ZWQgcmMgZGVwbG95bWVudCAoYWJvcnRlZCB2ZXJzaW9uIGNoYW5nZSB0b28pLicgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBNb3ZlIG92ZXIgZGVwZW5kZW5jaWVzLmpzb24gYW5kIGNvbW1pdC9wdXNoXHJcbiAgICBhd2FpdCB1cGRhdGVEZXBlbmRlbmNpZXNKU09OKCByZXBvLCBicmFuZHMsIHZlcnNpb25TdHJpbmcsIGJyYW5jaCApO1xyXG5cclxuICAgIC8vIFNlbmQgdGhlIGJ1aWxkIHJlcXVlc3RcclxuICAgIGF3YWl0IGJ1aWxkU2VydmVyUmVxdWVzdCggcmVwbywgdmVyc2lvbiwgYnJhbmNoLCBhd2FpdCBnZXREZXBlbmRlbmNpZXMoIHJlcG8gKSwge1xyXG4gICAgICBsb2NhbGVzOiBbICdlbicgXSxcclxuICAgICAgYnJhbmRzOiBicmFuZHMsXHJcbiAgICAgIHNlcnZlcnM6IFsgJ2RldicgXVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIE1vdmUgYmFjayB0byBtYXN0ZXJcclxuICAgIGF3YWl0IGNoZWNrb3V0TWFzdGVyKCByZXBvLCB0cnVlICk7XHJcblxyXG4gICAgY29uc3QgdmVyc2lvblVSTCA9IGBodHRwczovL3BoZXQtZGV2LmNvbG9yYWRvLmVkdS9odG1sLyR7cmVwb30vJHt2ZXJzaW9uU3RyaW5nfWA7XHJcblxyXG4gICAgaWYgKCBicmFuZHMuaW5jbHVkZXMoICdwaGV0JyApICkge1xyXG4gICAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQvJHtyZXBvfV9hbGxfcGhldC5odG1sYCApO1xyXG4gICAgfVxyXG4gICAgaWYgKCBicmFuZHMuaW5jbHVkZXMoICdwaGV0LWlvJyApICkge1xyXG4gICAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQtaW8vYCApO1xyXG4gICAgfVxyXG5cclxuICAgIGdydW50LmxvZy53cml0ZWxuKCAnUGxlYXNlIHdhaXQgZm9yIHRoZSBidWlsZC1zZXJ2ZXIgdG8gY29tcGxldGUgdGhlIGRlcGxveW1lbnQsIGFuZCB0aGVuIHRlc3QhJyApO1xyXG5cclxuICAgIHJldHVybiB2ZXJzaW9uO1xyXG4gIH1cclxuICBjYXRjaCggZSApIHtcclxuICAgIGdydW50LmxvZy53YXJuKCAnRGV0ZWN0ZWQgZmFpbHVyZSBkdXJpbmcgZGVwbG95LCByZXZlcnRpbmcgdG8gbWFzdGVyJyApO1xyXG4gICAgYXdhaXQgY2hlY2tvdXRNYXN0ZXIoIHJlcG8sIHRydWUgKTtcclxuICAgIHRocm93IGU7XHJcbiAgfVxyXG59O1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUUsc0JBQXVCLENBQUM7QUFDcEQsTUFBTUMsYUFBYSxHQUFHRCxPQUFPLENBQUUseUJBQTBCLENBQUM7QUFDMUQsTUFBTUUsS0FBSyxHQUFHRixPQUFPLENBQUUsaUJBQWtCLENBQUM7QUFDMUMsTUFBTUcsVUFBVSxHQUFHSCxPQUFPLENBQUUsc0JBQXVCLENBQUM7QUFDcEQsTUFBTUksa0JBQWtCLEdBQUdKLE9BQU8sQ0FBRSw4QkFBK0IsQ0FBQztBQUNwRSxNQUFNSyxjQUFjLEdBQUdMLE9BQU8sQ0FBRSwwQkFBMkIsQ0FBQztBQUM1RCxNQUFNTSxjQUFjLEdBQUdOLE9BQU8sQ0FBRSwwQkFBMkIsQ0FBQztBQUM1RCxNQUFNTyxrQkFBa0IsR0FBR1AsT0FBTyxDQUFFLDhCQUErQixDQUFDO0FBQ3BFLE1BQU1RLGVBQWUsR0FBR1IsT0FBTyxDQUFFLDJCQUE0QixDQUFDO0FBQzlELE1BQU1TLGNBQWMsR0FBR1QsT0FBTyxDQUFFLDBCQUEyQixDQUFDO0FBQzVELE1BQU1VLFdBQVcsR0FBR1YsT0FBTyxDQUFFLHVCQUF3QixDQUFDO0FBQ3RELE1BQU1XLFVBQVUsR0FBR1gsT0FBTyxDQUFFLHNCQUF1QixDQUFDO0FBQ3BELE1BQU1ZLE9BQU8sR0FBR1osT0FBTyxDQUFFLG1CQUFvQixDQUFD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