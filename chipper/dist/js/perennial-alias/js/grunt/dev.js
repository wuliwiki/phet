// Copyright 2017-2019, University of Colorado Boulder

/**
 * Deploys a dev version after incrementing the test version number.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const SimVersion = require('../common/SimVersion');
const booleanPrompt = require('../common/booleanPrompt');
const build = require('../common/build');
const buildLocal = require('../common/buildLocal');
const devDirectoryExists = require('../common/devDirectoryExists');
const devScp = require('../common/devScp');
const devSsh = require('../common/devSsh');
const getBranch = require('../common/getBranch');
const getRemoteBranchSHAs = require('../common/getRemoteBranchSHAs');
const getRepoVersion = require('../common/getRepoVersion');
const gitIsClean = require('../common/gitIsClean');
const getDependencyRepos = require('../common/getDependencyRepos');
const gitPush = require('../common/gitPush');
const gitRevParse = require('../common/gitRevParse');
const lintAllRunnable = require('../common/lintAllRunnable');
const npmUpdate = require('../common/npmUpdate');
const setRepoVersion = require('../common/setRepoVersion');
const updateDependenciesJSON = require('../common/updateDependenciesJSON');
const updateHTMLVersion = require('../common/updateHTMLVersion');
const vpnCheck = require('../common/vpnCheck');
const writePhetioHtaccess = require('../common/writePhetioHtaccess');
const assert = require('assert');
const grunt = require('grunt');
const _ = require('lodash'); // eslint-disable-line no-unused-vars

/**
 * Deploys a dev version after incrementing the test version number.
 * @public
 *
 * @param {string} repo
 * @param {Array.<string>} brands
 * @param {boolean} noninteractive
 * @param {string} branch - 'master' for normal dev deploys, otherwise is the name of a one-off branch
 * @param {string} [message] - Optional message to append to the version-increment commit.
 * @returns {Promise}
 */
module.exports = async function (repo, brands, noninteractive, branch, message) {
  const isOneOff = branch !== 'master';
  const testType = isOneOff ? branch : 'dev';
  if (isOneOff) {
    assert(!branch.includes('-'), 'One-off versions should be from branches that do not include hyphens');
  }
  if (!(await vpnCheck())) {
    grunt.fail.fatal('VPN or being on campus is required for this build. Ensure VPN is enabled, or that you have access to phet-server2.int.colorado.edu');
  }
  const currentBranch = await getBranch(repo);
  if (currentBranch !== branch) {
    grunt.fail.fatal(`${testType} deployment should be on the branch ${branch}, not: ${currentBranch ? currentBranch : '(detached head)'}`);
  }
  const previousVersion = await getRepoVersion(repo);
  if (previousVersion.testType !== testType) {
    if (isOneOff) {
      grunt.fail.fatal(`The current version identifier is not a one-off version (should be something like ${previousVersion.major}.${previousVersion.minor}.${previousVersion.maintenance}-${testType}.${previousVersion.testNumber === null ? '0' : previousVersion.testNumber}), aborting.`);
    } else {
      grunt.fail.fatal('The current version identifier is not a dev version, aborting.');
    }
  }
  const dependencies = await getDependencyRepos(repo);
  for (let i = 0; i < dependencies.length; i++) {
    const dependency = dependencies[i];
    const isClean = await gitIsClean(dependency);
    if (!isClean) {
      throw new Error(`Unclean status in ${dependency}, cannot deploy`);
    }
  }
  const currentSHA = await gitRevParse(repo, 'HEAD');
  const latestSHA = (await getRemoteBranchSHAs(repo))[branch];
  if (currentSHA !== latestSHA) {
    // See https://github.com/phetsims/chipper/issues/699
    grunt.fail.fatal(`Out of date with remote, please push or pull repo. Current SHA: ${currentSHA}, latest SHA: ${latestSHA}`);
  }

  // Ensure we don't try to request an unsupported brand
  const supportedBrands = grunt.file.readJSON(`../${repo}/package.json`).phet.supportedBrands || [];
  brands.forEach(brand => assert(supportedBrands.includes(brand), `Brand ${brand} not included in ${repo}'s supported brands: ${supportedBrands.join(',')}`));

  // Ensure that the repository and its dependencies pass lint before continuing.
  // See https://github.com/phetsims/perennial/issues/76
  await lintAllRunnable(repo);

  // Bump the version
  const version = new SimVersion(previousVersion.major, previousVersion.minor, previousVersion.maintenance, {
    testType: testType,
    testNumber: previousVersion.testNumber + 1
  });
  const versionString = version.toString();
  const simPath = buildLocal.devDeployPath + repo;
  const versionPath = `${simPath}/${versionString}`;
  const simPathExists = await devDirectoryExists(simPath);
  const versionPathExists = await devDirectoryExists(versionPath);
  if (versionPathExists) {
    grunt.fail.fatal(`Directory ${versionPath} already exists.  If you intend to replace the content then remove the directory manually from ${buildLocal.devDeployServer}.`);
  }
  if (!(await booleanPrompt(`Deploy ${versionString} to ${buildLocal.devDeployServer}`, noninteractive))) {
    grunt.fail.fatal(`Aborted ${testType} deploy`);
  }

  // Make sure our correct npm dependencies are set
  await npmUpdate(repo);
  await npmUpdate('chipper');
  await npmUpdate('perennial-alias');
  await setRepoVersion(repo, version, message);
  await updateHTMLVersion(repo);
  await gitPush(repo, branch);
  grunt.log.writeln(await build(repo, {
    brands: brands,
    allHTML: true,
    debugHTML: true
  }));

  // Create (and fix permissions for) the main simulation directory, if it didn't already exist
  if (!simPathExists) {
    await devSsh(`mkdir -p "${simPath}" && echo "IndexOrderDefault Descending Date\n" > "${simPath}/.htaccess"`);
  }

  // Create the version-specific directory
  await devSsh(`mkdir -p "${versionPath}"`);

  // Copy the build contents into the version-specific directory
  for (const brand of brands) {
    await devScp(`../${repo}/build/${brand}`, `${versionPath}/`);
  }

  // If there is a protected directory and we are copying to the dev server, include the .htaccess file
  // This is for PhET-iO simulations, to protected the password protected wrappers, see
  // https://github.com/phetsims/phet-io/issues/641
  if (brands.includes('phet-io') && buildLocal.devDeployServer === 'bayes.colorado.edu') {
    const htaccessLocation = `../${repo}/build/phet-io`;
    await writePhetioHtaccess(htaccessLocation, null, versionPath);
  }

  // Move over dependencies.json and commit/push
  await updateDependenciesJSON(repo, brands, versionString, branch);
  const versionURL = `https://phet-dev.colorado.edu/html/${repo}/${versionString}`;
  if (brands.includes('phet')) {
    grunt.log.writeln(`Deployed: ${versionURL}/phet/${repo}_all_phet.html`);
  }
  if (brands.includes('phet-io')) {
    grunt.log.writeln(`Deployed: ${versionURL}/phet-io/`);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTaW1WZXJzaW9uIiwicmVxdWlyZSIsImJvb2xlYW5Qcm9tcHQiLCJidWlsZCIsImJ1aWxkTG9jYWwiLCJkZXZEaXJlY3RvcnlFeGlzdHMiLCJkZXZTY3AiLCJkZXZTc2giLCJnZXRCcmFuY2giLCJnZXRSZW1vdGVCcmFuY2hTSEFzIiwiZ2V0UmVwb1ZlcnNpb24iLCJnaXRJc0NsZWFuIiwiZ2V0RGVwZW5kZW5jeVJlcG9zIiwiZ2l0UHVzaCIsImdpdFJldlBhcnNlIiwibGludEFsbFJ1bm5hYmxlIiwibnBtVXBkYXRlIiwic2V0UmVwb1ZlcnNpb24iLCJ1cGRhdGVEZXBlbmRlbmNpZXNKU09OIiwidXBkYXRlSFRNTFZlcnNpb24iLCJ2cG5DaGVjayIsIndyaXRlUGhldGlvSHRhY2Nlc3MiLCJhc3NlcnQiLCJncnVudCIsIl8iLCJtb2R1bGUiLCJleHBvcnRzIiwicmVwbyIsImJyYW5kcyIsIm5vbmludGVyYWN0aXZlIiwiYnJhbmNoIiwibWVzc2FnZSIsImlzT25lT2ZmIiwidGVzdFR5cGUiLCJpbmNsdWRlcyIsImZhaWwiLCJmYXRhbCIsImN1cnJlbnRCcmFuY2giLCJwcmV2aW91c1ZlcnNpb24iLCJtYWpvciIsIm1pbm9yIiwibWFpbnRlbmFuY2UiLCJ0ZXN0TnVtYmVyIiwiZGVwZW5kZW5jaWVzIiwiaSIsImxlbmd0aCIsImRlcGVuZGVuY3kiLCJpc0NsZWFuIiwiRXJyb3IiLCJjdXJyZW50U0hBIiwibGF0ZXN0U0hBIiwic3VwcG9ydGVkQnJhbmRzIiwiZmlsZSIsInJlYWRKU09OIiwicGhldCIsImZvckVhY2giLCJicmFuZCIsImpvaW4iLCJ2ZXJzaW9uIiwidmVyc2lvblN0cmluZyIsInRvU3RyaW5nIiwic2ltUGF0aCIsImRldkRlcGxveVBhdGgiLCJ2ZXJzaW9uUGF0aCIsInNpbVBhdGhFeGlzdHMiLCJ2ZXJzaW9uUGF0aEV4aXN0cyIsImRldkRlcGxveVNlcnZlciIsImxvZyIsIndyaXRlbG4iLCJhbGxIVE1MIiwiZGVidWdIVE1MIiwiaHRhY2Nlc3NMb2NhdGlvbiIsInZlcnNpb25VUkwiXSwic291cmNlcyI6WyJkZXYuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTctMjAxOSwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogRGVwbG95cyBhIGRldiB2ZXJzaW9uIGFmdGVyIGluY3JlbWVudGluZyB0aGUgdGVzdCB2ZXJzaW9uIG51bWJlci5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmNvbnN0IFNpbVZlcnNpb24gPSByZXF1aXJlKCAnLi4vY29tbW9uL1NpbVZlcnNpb24nICk7XHJcbmNvbnN0IGJvb2xlYW5Qcm9tcHQgPSByZXF1aXJlKCAnLi4vY29tbW9uL2Jvb2xlYW5Qcm9tcHQnICk7XHJcbmNvbnN0IGJ1aWxkID0gcmVxdWlyZSggJy4uL2NvbW1vbi9idWlsZCcgKTtcclxuY29uc3QgYnVpbGRMb2NhbCA9IHJlcXVpcmUoICcuLi9jb21tb24vYnVpbGRMb2NhbCcgKTtcclxuY29uc3QgZGV2RGlyZWN0b3J5RXhpc3RzID0gcmVxdWlyZSggJy4uL2NvbW1vbi9kZXZEaXJlY3RvcnlFeGlzdHMnICk7XHJcbmNvbnN0IGRldlNjcCA9IHJlcXVpcmUoICcuLi9jb21tb24vZGV2U2NwJyApO1xyXG5jb25zdCBkZXZTc2ggPSByZXF1aXJlKCAnLi4vY29tbW9uL2RldlNzaCcgKTtcclxuY29uc3QgZ2V0QnJhbmNoID0gcmVxdWlyZSggJy4uL2NvbW1vbi9nZXRCcmFuY2gnICk7XHJcbmNvbnN0IGdldFJlbW90ZUJyYW5jaFNIQXMgPSByZXF1aXJlKCAnLi4vY29tbW9uL2dldFJlbW90ZUJyYW5jaFNIQXMnICk7XHJcbmNvbnN0IGdldFJlcG9WZXJzaW9uID0gcmVxdWlyZSggJy4uL2NvbW1vbi9nZXRSZXBvVmVyc2lvbicgKTtcclxuY29uc3QgZ2l0SXNDbGVhbiA9IHJlcXVpcmUoICcuLi9jb21tb24vZ2l0SXNDbGVhbicgKTtcclxuY29uc3QgZ2V0RGVwZW5kZW5jeVJlcG9zID0gcmVxdWlyZSggJy4uL2NvbW1vbi9nZXREZXBlbmRlbmN5UmVwb3MnICk7XHJcbmNvbnN0IGdpdFB1c2ggPSByZXF1aXJlKCAnLi4vY29tbW9uL2dpdFB1c2gnICk7XHJcbmNvbnN0IGdpdFJldlBhcnNlID0gcmVxdWlyZSggJy4uL2NvbW1vbi9naXRSZXZQYXJzZScgKTtcclxuY29uc3QgbGludEFsbFJ1bm5hYmxlID0gcmVxdWlyZSggJy4uL2NvbW1vbi9saW50QWxsUnVubmFibGUnICk7XHJcbmNvbnN0IG5wbVVwZGF0ZSA9IHJlcXVpcmUoICcuLi9jb21tb24vbnBtVXBkYXRlJyApO1xyXG5jb25zdCBzZXRSZXBvVmVyc2lvbiA9IHJlcXVpcmUoICcuLi9jb21tb24vc2V0UmVwb1ZlcnNpb24nICk7XHJcbmNvbnN0IHVwZGF0ZURlcGVuZGVuY2llc0pTT04gPSByZXF1aXJlKCAnLi4vY29tbW9uL3VwZGF0ZURlcGVuZGVuY2llc0pTT04nICk7XHJcbmNvbnN0IHVwZGF0ZUhUTUxWZXJzaW9uID0gcmVxdWlyZSggJy4uL2NvbW1vbi91cGRhdGVIVE1MVmVyc2lvbicgKTtcclxuY29uc3QgdnBuQ2hlY2sgPSByZXF1aXJlKCAnLi4vY29tbW9uL3ZwbkNoZWNrJyApO1xyXG5jb25zdCB3cml0ZVBoZXRpb0h0YWNjZXNzID0gcmVxdWlyZSggJy4uL2NvbW1vbi93cml0ZVBoZXRpb0h0YWNjZXNzJyApO1xyXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKCAnYXNzZXJ0JyApO1xyXG5jb25zdCBncnVudCA9IHJlcXVpcmUoICdncnVudCcgKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoICdsb2Rhc2gnICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnNcclxuXHJcbi8qKlxyXG4gKiBEZXBsb3lzIGEgZGV2IHZlcnNpb24gYWZ0ZXIgaW5jcmVtZW50aW5nIHRoZSB0ZXN0IHZlcnNpb24gbnVtYmVyLlxyXG4gKiBAcHVibGljXHJcbiAqXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSByZXBvXHJcbiAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGJyYW5kc1xyXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG5vbmludGVyYWN0aXZlXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBicmFuY2ggLSAnbWFzdGVyJyBmb3Igbm9ybWFsIGRldiBkZXBsb3lzLCBvdGhlcndpc2UgaXMgdGhlIG5hbWUgb2YgYSBvbmUtb2ZmIGJyYW5jaFxyXG4gKiBAcGFyYW0ge3N0cmluZ30gW21lc3NhZ2VdIC0gT3B0aW9uYWwgbWVzc2FnZSB0byBhcHBlbmQgdG8gdGhlIHZlcnNpb24taW5jcmVtZW50IGNvbW1pdC5cclxuICogQHJldHVybnMge1Byb21pc2V9XHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uKCByZXBvLCBicmFuZHMsIG5vbmludGVyYWN0aXZlLCBicmFuY2gsIG1lc3NhZ2UgKSB7XHJcbiAgY29uc3QgaXNPbmVPZmYgPSBicmFuY2ggIT09ICdtYXN0ZXInO1xyXG4gIGNvbnN0IHRlc3RUeXBlID0gaXNPbmVPZmYgPyBicmFuY2ggOiAnZGV2JztcclxuICBpZiAoIGlzT25lT2ZmICkge1xyXG4gICAgYXNzZXJ0KCAhYnJhbmNoLmluY2x1ZGVzKCAnLScgKSwgJ09uZS1vZmYgdmVyc2lvbnMgc2hvdWxkIGJlIGZyb20gYnJhbmNoZXMgdGhhdCBkbyBub3QgaW5jbHVkZSBoeXBoZW5zJyApO1xyXG4gIH1cclxuXHJcbiAgaWYgKCAhKCBhd2FpdCB2cG5DaGVjaygpICkgKSB7XHJcbiAgICBncnVudC5mYWlsLmZhdGFsKCAnVlBOIG9yIGJlaW5nIG9uIGNhbXB1cyBpcyByZXF1aXJlZCBmb3IgdGhpcyBidWlsZC4gRW5zdXJlIFZQTiBpcyBlbmFibGVkLCBvciB0aGF0IHlvdSBoYXZlIGFjY2VzcyB0byBwaGV0LXNlcnZlcjIuaW50LmNvbG9yYWRvLmVkdScgKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGN1cnJlbnRCcmFuY2ggPSBhd2FpdCBnZXRCcmFuY2goIHJlcG8gKTtcclxuICBpZiAoIGN1cnJlbnRCcmFuY2ggIT09IGJyYW5jaCApIHtcclxuICAgIGdydW50LmZhaWwuZmF0YWwoIGAke3Rlc3RUeXBlfSBkZXBsb3ltZW50IHNob3VsZCBiZSBvbiB0aGUgYnJhbmNoICR7YnJhbmNofSwgbm90OiAke2N1cnJlbnRCcmFuY2ggPyBjdXJyZW50QnJhbmNoIDogJyhkZXRhY2hlZCBoZWFkKSd9YCApO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcHJldmlvdXNWZXJzaW9uID0gYXdhaXQgZ2V0UmVwb1ZlcnNpb24oIHJlcG8gKTtcclxuXHJcbiAgaWYgKCBwcmV2aW91c1ZlcnNpb24udGVzdFR5cGUgIT09IHRlc3RUeXBlICkge1xyXG4gICAgaWYgKCBpc09uZU9mZiApIHtcclxuICAgICAgZ3J1bnQuZmFpbC5mYXRhbCggYFRoZSBjdXJyZW50IHZlcnNpb24gaWRlbnRpZmllciBpcyBub3QgYSBvbmUtb2ZmIHZlcnNpb24gKHNob3VsZCBiZSBzb21ldGhpbmcgbGlrZSAke3ByZXZpb3VzVmVyc2lvbi5tYWpvcn0uJHtwcmV2aW91c1ZlcnNpb24ubWlub3J9LiR7cHJldmlvdXNWZXJzaW9uLm1haW50ZW5hbmNlfS0ke3Rlc3RUeXBlfS4ke3ByZXZpb3VzVmVyc2lvbi50ZXN0TnVtYmVyID09PSBudWxsID8gJzAnIDogcHJldmlvdXNWZXJzaW9uLnRlc3ROdW1iZXJ9KSwgYWJvcnRpbmcuYCApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGdydW50LmZhaWwuZmF0YWwoICdUaGUgY3VycmVudCB2ZXJzaW9uIGlkZW50aWZpZXIgaXMgbm90IGEgZGV2IHZlcnNpb24sIGFib3J0aW5nLicgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IGRlcGVuZGVuY2llcyA9IGF3YWl0IGdldERlcGVuZGVuY3lSZXBvcyggcmVwbyApO1xyXG4gIGZvciAoIGxldCBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKyApIHtcclxuICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBkZXBlbmRlbmNpZXNbIGkgXTtcclxuICAgIGNvbnN0IGlzQ2xlYW4gPSBhd2FpdCBnaXRJc0NsZWFuKCBkZXBlbmRlbmN5ICk7XHJcbiAgICBpZiAoICFpc0NsZWFuICkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoIGBVbmNsZWFuIHN0YXR1cyBpbiAke2RlcGVuZGVuY3l9LCBjYW5ub3QgZGVwbG95YCApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgY3VycmVudFNIQSA9IGF3YWl0IGdpdFJldlBhcnNlKCByZXBvLCAnSEVBRCcgKTtcclxuICBjb25zdCBsYXRlc3RTSEEgPSAoIGF3YWl0IGdldFJlbW90ZUJyYW5jaFNIQXMoIHJlcG8gKSApWyBicmFuY2ggXTtcclxuICBpZiAoIGN1cnJlbnRTSEEgIT09IGxhdGVzdFNIQSApIHtcclxuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvY2hpcHBlci9pc3N1ZXMvNjk5XHJcbiAgICBncnVudC5mYWlsLmZhdGFsKCBgT3V0IG9mIGRhdGUgd2l0aCByZW1vdGUsIHBsZWFzZSBwdXNoIG9yIHB1bGwgcmVwby4gQ3VycmVudCBTSEE6ICR7Y3VycmVudFNIQX0sIGxhdGVzdCBTSEE6ICR7bGF0ZXN0U0hBfWAgKTtcclxuICB9XHJcblxyXG4gIC8vIEVuc3VyZSB3ZSBkb24ndCB0cnkgdG8gcmVxdWVzdCBhbiB1bnN1cHBvcnRlZCBicmFuZFxyXG4gIGNvbnN0IHN1cHBvcnRlZEJyYW5kcyA9IGdydW50LmZpbGUucmVhZEpTT04oIGAuLi8ke3JlcG99L3BhY2thZ2UuanNvbmAgKS5waGV0LnN1cHBvcnRlZEJyYW5kcyB8fCBbXTtcclxuICBicmFuZHMuZm9yRWFjaCggYnJhbmQgPT4gYXNzZXJ0KCBzdXBwb3J0ZWRCcmFuZHMuaW5jbHVkZXMoIGJyYW5kICksIGBCcmFuZCAke2JyYW5kfSBub3QgaW5jbHVkZWQgaW4gJHtyZXBvfSdzIHN1cHBvcnRlZCBicmFuZHM6ICR7c3VwcG9ydGVkQnJhbmRzLmpvaW4oICcsJyApfWAgKSApO1xyXG5cclxuICAvLyBFbnN1cmUgdGhhdCB0aGUgcmVwb3NpdG9yeSBhbmQgaXRzIGRlcGVuZGVuY2llcyBwYXNzIGxpbnQgYmVmb3JlIGNvbnRpbnVpbmcuXHJcbiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9wZXJlbm5pYWwvaXNzdWVzLzc2XHJcbiAgYXdhaXQgbGludEFsbFJ1bm5hYmxlKCByZXBvICk7XHJcblxyXG4gIC8vIEJ1bXAgdGhlIHZlcnNpb25cclxuICBjb25zdCB2ZXJzaW9uID0gbmV3IFNpbVZlcnNpb24oIHByZXZpb3VzVmVyc2lvbi5tYWpvciwgcHJldmlvdXNWZXJzaW9uLm1pbm9yLCBwcmV2aW91c1ZlcnNpb24ubWFpbnRlbmFuY2UsIHtcclxuICAgIHRlc3RUeXBlOiB0ZXN0VHlwZSxcclxuICAgIHRlc3ROdW1iZXI6IHByZXZpb3VzVmVyc2lvbi50ZXN0TnVtYmVyICsgMVxyXG4gIH0gKTtcclxuXHJcbiAgY29uc3QgdmVyc2lvblN0cmluZyA9IHZlcnNpb24udG9TdHJpbmcoKTtcclxuICBjb25zdCBzaW1QYXRoID0gYnVpbGRMb2NhbC5kZXZEZXBsb3lQYXRoICsgcmVwbztcclxuICBjb25zdCB2ZXJzaW9uUGF0aCA9IGAke3NpbVBhdGh9LyR7dmVyc2lvblN0cmluZ31gO1xyXG5cclxuICBjb25zdCBzaW1QYXRoRXhpc3RzID0gYXdhaXQgZGV2RGlyZWN0b3J5RXhpc3RzKCBzaW1QYXRoICk7XHJcbiAgY29uc3QgdmVyc2lvblBhdGhFeGlzdHMgPSBhd2FpdCBkZXZEaXJlY3RvcnlFeGlzdHMoIHZlcnNpb25QYXRoICk7XHJcblxyXG4gIGlmICggdmVyc2lvblBhdGhFeGlzdHMgKSB7XHJcbiAgICBncnVudC5mYWlsLmZhdGFsKCBgRGlyZWN0b3J5ICR7dmVyc2lvblBhdGh9IGFscmVhZHkgZXhpc3RzLiAgSWYgeW91IGludGVuZCB0byByZXBsYWNlIHRoZSBjb250ZW50IHRoZW4gcmVtb3ZlIHRoZSBkaXJlY3RvcnkgbWFudWFsbHkgZnJvbSAke2J1aWxkTG9jYWwuZGV2RGVwbG95U2VydmVyfS5gICk7XHJcbiAgfVxyXG5cclxuICBpZiAoICFhd2FpdCBib29sZWFuUHJvbXB0KCBgRGVwbG95ICR7dmVyc2lvblN0cmluZ30gdG8gJHtidWlsZExvY2FsLmRldkRlcGxveVNlcnZlcn1gLCBub25pbnRlcmFjdGl2ZSApICkge1xyXG4gICAgZ3J1bnQuZmFpbC5mYXRhbCggYEFib3J0ZWQgJHt0ZXN0VHlwZX0gZGVwbG95YCApO1xyXG4gIH1cclxuXHJcbiAgLy8gTWFrZSBzdXJlIG91ciBjb3JyZWN0IG5wbSBkZXBlbmRlbmNpZXMgYXJlIHNldFxyXG4gIGF3YWl0IG5wbVVwZGF0ZSggcmVwbyApO1xyXG4gIGF3YWl0IG5wbVVwZGF0ZSggJ2NoaXBwZXInICk7XHJcbiAgYXdhaXQgbnBtVXBkYXRlKCAncGVyZW5uaWFsLWFsaWFzJyApO1xyXG5cclxuICBhd2FpdCBzZXRSZXBvVmVyc2lvbiggcmVwbywgdmVyc2lvbiwgbWVzc2FnZSApO1xyXG4gIGF3YWl0IHVwZGF0ZUhUTUxWZXJzaW9uKCByZXBvICk7XHJcbiAgYXdhaXQgZ2l0UHVzaCggcmVwbywgYnJhbmNoICk7XHJcblxyXG4gIGdydW50LmxvZy53cml0ZWxuKCBhd2FpdCBidWlsZCggcmVwbywge1xyXG4gICAgYnJhbmRzOiBicmFuZHMsXHJcbiAgICBhbGxIVE1MOiB0cnVlLFxyXG4gICAgZGVidWdIVE1MOiB0cnVlXHJcbiAgfSApICk7XHJcblxyXG4gIC8vIENyZWF0ZSAoYW5kIGZpeCBwZXJtaXNzaW9ucyBmb3IpIHRoZSBtYWluIHNpbXVsYXRpb24gZGlyZWN0b3J5LCBpZiBpdCBkaWRuJ3QgYWxyZWFkeSBleGlzdFxyXG4gIGlmICggIXNpbVBhdGhFeGlzdHMgKSB7XHJcbiAgICBhd2FpdCBkZXZTc2goIGBta2RpciAtcCBcIiR7c2ltUGF0aH1cIiAmJiBlY2hvIFwiSW5kZXhPcmRlckRlZmF1bHQgRGVzY2VuZGluZyBEYXRlXFxuXCIgPiBcIiR7c2ltUGF0aH0vLmh0YWNjZXNzXCJgICk7XHJcbiAgfVxyXG5cclxuICAvLyBDcmVhdGUgdGhlIHZlcnNpb24tc3BlY2lmaWMgZGlyZWN0b3J5XHJcbiAgYXdhaXQgZGV2U3NoKCBgbWtkaXIgLXAgXCIke3ZlcnNpb25QYXRofVwiYCApO1xyXG5cclxuICAvLyBDb3B5IHRoZSBidWlsZCBjb250ZW50cyBpbnRvIHRoZSB2ZXJzaW9uLXNwZWNpZmljIGRpcmVjdG9yeVxyXG4gIGZvciAoIGNvbnN0IGJyYW5kIG9mIGJyYW5kcyApIHtcclxuICAgIGF3YWl0IGRldlNjcCggYC4uLyR7cmVwb30vYnVpbGQvJHticmFuZH1gLCBgJHt2ZXJzaW9uUGF0aH0vYCApO1xyXG4gIH1cclxuXHJcbiAgLy8gSWYgdGhlcmUgaXMgYSBwcm90ZWN0ZWQgZGlyZWN0b3J5IGFuZCB3ZSBhcmUgY29weWluZyB0byB0aGUgZGV2IHNlcnZlciwgaW5jbHVkZSB0aGUgLmh0YWNjZXNzIGZpbGVcclxuICAvLyBUaGlzIGlzIGZvciBQaEVULWlPIHNpbXVsYXRpb25zLCB0byBwcm90ZWN0ZWQgdGhlIHBhc3N3b3JkIHByb3RlY3RlZCB3cmFwcGVycywgc2VlXHJcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3BoZXQtaW8vaXNzdWVzLzY0MVxyXG4gIGlmICggYnJhbmRzLmluY2x1ZGVzKCAncGhldC1pbycgKSAmJiBidWlsZExvY2FsLmRldkRlcGxveVNlcnZlciA9PT0gJ2JheWVzLmNvbG9yYWRvLmVkdScgKSB7XHJcbiAgICBjb25zdCBodGFjY2Vzc0xvY2F0aW9uID0gYC4uLyR7cmVwb30vYnVpbGQvcGhldC1pb2A7XHJcbiAgICBhd2FpdCB3cml0ZVBoZXRpb0h0YWNjZXNzKCBodGFjY2Vzc0xvY2F0aW9uLCBudWxsLCB2ZXJzaW9uUGF0aCApO1xyXG4gIH1cclxuXHJcbiAgLy8gTW92ZSBvdmVyIGRlcGVuZGVuY2llcy5qc29uIGFuZCBjb21taXQvcHVzaFxyXG4gIGF3YWl0IHVwZGF0ZURlcGVuZGVuY2llc0pTT04oIHJlcG8sIGJyYW5kcywgdmVyc2lvblN0cmluZywgYnJhbmNoICk7XHJcblxyXG4gIGNvbnN0IHZlcnNpb25VUkwgPSBgaHR0cHM6Ly9waGV0LWRldi5jb2xvcmFkby5lZHUvaHRtbC8ke3JlcG99LyR7dmVyc2lvblN0cmluZ31gO1xyXG5cclxuICBpZiAoIGJyYW5kcy5pbmNsdWRlcyggJ3BoZXQnICkgKSB7XHJcbiAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQvJHtyZXBvfV9hbGxfcGhldC5odG1sYCApO1xyXG4gIH1cclxuICBpZiAoIGJyYW5kcy5pbmNsdWRlcyggJ3BoZXQtaW8nICkgKSB7XHJcbiAgICBncnVudC5sb2cud3JpdGVsbiggYERlcGxveWVkOiAke3ZlcnNpb25VUkx9L3BoZXQtaW8vYCApO1xyXG4gIH1cclxufTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLFVBQVUsR0FBR0MsT0FBTyxDQUFFLHNCQUF1QixDQUFDO0FBQ3BELE1BQU1DLGFBQWEsR0FBR0QsT0FBTyxDQUFFLHlCQUEwQixDQUFDO0FBQzFELE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFFLGlCQUFrQixDQUFDO0FBQzFDLE1BQU1HLFVBQVUsR0FBR0gsT0FBTyxDQUFFLHNCQUF1QixDQUFDO0FBQ3BELE1BQU1JLGtCQUFrQixHQUFHSixPQUFPLENBQUUsOEJBQStCLENBQUM7QUFDcEUsTUFBTUssTUFBTSxHQUFHTCxPQUFPLENBQUUsa0JBQW1CLENBQUM7QUFDNUMsTUFBTU0sTUFBTSxHQUFHTixPQUFPLENBQUUsa0JBQW1CLENBQUM7QUFDNUMsTUFBTU8sU0FBUyxHQUFHUCxPQUFPLENBQUUscUJBQXNCLENBQUM7QUFDbEQsTUFBTVEsbUJBQW1CLEdBQUdSLE9BQU8sQ0FBRSwrQkFBZ0MsQ0FBQztBQUN0RSxN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