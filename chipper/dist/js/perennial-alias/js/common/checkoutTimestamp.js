// Copyright 2018, University of Colorado Boulder

/**
 * Checks out a snapshot of a repo (and its dependencies) for a given timestamp/branch.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

const checkoutDependencies = require('./checkoutDependencies');
const getDependencies = require('./getDependencies');
const gitCheckout = require('./gitCheckout');
const gitFromTimestamp = require('./gitFromTimestamp');
const winston = require('winston');

/**
 * Checks out a snapshot of a repo (and its dependencies) for a given timestamp/branch.
 * @public
 *
 * @param {string} repo - The repository name
 * @param {string} timestamp
 * @param {boolean} includeNpmUpdate
 * @returns {Promise.<Array.<string>>} - Resolves with checkedOutRepos
 */
module.exports = async function (repo, timestamp, includeNpmUpdate) {
  winston.info(`checking out timestamp for ${repo} at ${timestamp}`);
  await gitCheckout(repo, await gitFromTimestamp(repo, 'master', timestamp));
  const dependencies = await getDependencies(repo);
  const dependencyNames = Object.keys(dependencies).filter(key => key !== 'comment' && key !== repo);
  const timestampDependencies = {};
  for (const dependency of dependencyNames) {
    timestampDependencies[dependency] = {
      sha: await gitFromTimestamp(dependency, 'master', timestamp)
    };
  }
  return checkoutDependencies(repo, timestampDependencies, includeNpmUpdate);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjaGVja291dERlcGVuZGVuY2llcyIsInJlcXVpcmUiLCJnZXREZXBlbmRlbmNpZXMiLCJnaXRDaGVja291dCIsImdpdEZyb21UaW1lc3RhbXAiLCJ3aW5zdG9uIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlcG8iLCJ0aW1lc3RhbXAiLCJpbmNsdWRlTnBtVXBkYXRlIiwiaW5mbyIsImRlcGVuZGVuY2llcyIsImRlcGVuZGVuY3lOYW1lcyIsIk9iamVjdCIsImtleXMiLCJmaWx0ZXIiLCJrZXkiLCJ0aW1lc3RhbXBEZXBlbmRlbmNpZXMiLCJkZXBlbmRlbmN5Iiwic2hhIl0sInNvdXJjZXMiOlsiY2hlY2tvdXRUaW1lc3RhbXAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIENoZWNrcyBvdXQgYSBzbmFwc2hvdCBvZiBhIHJlcG8gKGFuZCBpdHMgZGVwZW5kZW5jaWVzKSBmb3IgYSBnaXZlbiB0aW1lc3RhbXAvYnJhbmNoLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEpvbmF0aGFuIE9sc29uIDxqb25hdGhhbi5vbHNvbkBjb2xvcmFkby5lZHU+XHJcbiAqL1xyXG5cclxuY29uc3QgY2hlY2tvdXREZXBlbmRlbmNpZXMgPSByZXF1aXJlKCAnLi9jaGVja291dERlcGVuZGVuY2llcycgKTtcclxuY29uc3QgZ2V0RGVwZW5kZW5jaWVzID0gcmVxdWlyZSggJy4vZ2V0RGVwZW5kZW5jaWVzJyApO1xyXG5jb25zdCBnaXRDaGVja291dCA9IHJlcXVpcmUoICcuL2dpdENoZWNrb3V0JyApO1xyXG5jb25zdCBnaXRGcm9tVGltZXN0YW1wID0gcmVxdWlyZSggJy4vZ2l0RnJvbVRpbWVzdGFtcCcgKTtcclxuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoICd3aW5zdG9uJyApO1xyXG5cclxuLyoqXHJcbiAqIENoZWNrcyBvdXQgYSBzbmFwc2hvdCBvZiBhIHJlcG8gKGFuZCBpdHMgZGVwZW5kZW5jaWVzKSBmb3IgYSBnaXZlbiB0aW1lc3RhbXAvYnJhbmNoLlxyXG4gKiBAcHVibGljXHJcbiAqXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSByZXBvIC0gVGhlIHJlcG9zaXRvcnkgbmFtZVxyXG4gKiBAcGFyYW0ge3N0cmluZ30gdGltZXN0YW1wXHJcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaW5jbHVkZU5wbVVwZGF0ZVxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZS48QXJyYXkuPHN0cmluZz4+fSAtIFJlc29sdmVzIHdpdGggY2hlY2tlZE91dFJlcG9zXHJcbiAqL1xyXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIGZ1bmN0aW9uKCByZXBvLCB0aW1lc3RhbXAsIGluY2x1ZGVOcG1VcGRhdGUgKSB7XHJcbiAgd2luc3Rvbi5pbmZvKCBgY2hlY2tpbmcgb3V0IHRpbWVzdGFtcCBmb3IgJHtyZXBvfSBhdCAke3RpbWVzdGFtcH1gICk7XHJcblxyXG4gIGF3YWl0IGdpdENoZWNrb3V0KCByZXBvLCBhd2FpdCBnaXRGcm9tVGltZXN0YW1wKCByZXBvLCAnbWFzdGVyJywgdGltZXN0YW1wICkgKTtcclxuICBjb25zdCBkZXBlbmRlbmNpZXMgPSBhd2FpdCBnZXREZXBlbmRlbmNpZXMoIHJlcG8gKTtcclxuICBjb25zdCBkZXBlbmRlbmN5TmFtZXMgPSBPYmplY3Qua2V5cyggZGVwZW5kZW5jaWVzICkuZmlsdGVyKCBrZXkgPT4ga2V5ICE9PSAnY29tbWVudCcgJiYga2V5ICE9PSByZXBvICk7XHJcbiAgY29uc3QgdGltZXN0YW1wRGVwZW5kZW5jaWVzID0ge307XHJcbiAgZm9yICggY29uc3QgZGVwZW5kZW5jeSBvZiBkZXBlbmRlbmN5TmFtZXMgKSB7XHJcbiAgICB0aW1lc3RhbXBEZXBlbmRlbmNpZXNbIGRlcGVuZGVuY3kgXSA9IHtcclxuICAgICAgc2hhOiBhd2FpdCBnaXRGcm9tVGltZXN0YW1wKCBkZXBlbmRlbmN5LCAnbWFzdGVyJywgdGltZXN0YW1wIClcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICByZXR1cm4gY2hlY2tvdXREZXBlbmRlbmNpZXMoIHJlcG8sIHRpbWVzdGFtcERlcGVuZGVuY2llcywgaW5jbHVkZU5wbVVwZGF0ZSApO1xyXG59O1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUEsb0JBQW9CLEdBQUdDLE9BQU8sQ0FBRSx3QkFBeUIsQ0FBQztBQUNoRSxNQUFNQyxlQUFlLEdBQUdELE9BQU8sQ0FBRSxtQkFBb0IsQ0FBQztBQUN0RCxNQUFNRSxXQUFXLEdBQUdGLE9BQU8sQ0FBRSxlQUFnQixDQUFDO0FBQzlDLE1BQU1HLGdCQUFnQixHQUFHSCxPQUFPLENBQUUsb0JBQXFCLENBQUM7QUFDeEQsTUFBTUksT0FBTyxHQUFHSixPQUFPLENBQUUsU0FBVSxDQUFDOztBQUVwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQUssTUFBTSxDQUFDQyxPQUFPLEdBQUcsZ0JBQWdCQyxJQUFJLEVBQUVDLFNBQVMsRUFBRUMsZ0JBQWdCLEVBQUc7RUFDbkVMLE9BQU8sQ0FBQ00sSUFBSSxDQUFHLDhCQUE2QkgsSUFBSyxPQUFNQyxTQUFVLEVBQUUsQ0FBQztFQUVwRSxNQUFNTixXQUFXLENBQUVLLElBQUksRUFBRSxNQUFNSixnQkFBZ0IsQ0FBRUksSUFBSSxFQUFFLFFBQVEsRUFBRUMsU0FBVSxDQUFFLENBQUM7RUFDOUUsTUFBTUcsWUFBWSxHQUFHLE1BQU1WLGVBQWUsQ0FBRU0sSUFBSyxDQUFDO0VBQ2xELE1BQU1LLGVBQWUsR0FBR0MsTUFBTSxDQUFDQyxJQUFJLENBQUVILFlBQWEsQ0FBQyxDQUFDSSxNQUFNLENBQUVDLEdBQUcsSUFBSUEsR0FBRyxLQUFLLFNBQVMsSUFBSUEsR0FBRyxLQUFLVCxJQUFLLENBQUM7RUFDdEcsTUFBTVUscUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0VBQ2hDLEtBQU0sTUFBTUMsVUFBVSxJQUFJTixlQUFlLEVBQUc7SUFDMUNLLHFCQUFxQixDQUFFQyxVQUFVLENBQUUsR0FBRztNQUNwQ0MsR0FBRyxFQUFFLE1BQU1oQixnQkFBZ0IsQ0FBRWUsVUFBVSxFQUFFLFFBQVEsRUFBRVYsU0FBVTtJQUMvRCxDQUFDO0VBQ0g7RUFFQSxPQUFPVCxvQkFBb0IsQ0FBRVEsSUFBSSxFQUFFVSxxQkFBcUIsRUFBRVIsZ0JBQWlCLENBQUM7QUFDOUUsQ0FBQyJ9