// Copyright 2014-2022, University of Colorado Boulder

/**
 * The clock for this simulation, which provide support for normal operation, play and pause, stepping backwards in
 * time, and playback of previously recorded data.  Because the neuron simulation depicts action potentials far more
 * slowly than they occur in real live, this class adapts the real clock time to a slower rate when clocking the model.
 *
 * Note: The whole approach of using explicit clocks and clock adapters is a holdover from PhET's Java days, and is
 * present in this sim because the sim was ported from a Java version.  Use of this technique is not recommended for
 * new HTML5/JavaScript simulations.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Sharfudeen Ashraf (for Ghent University)
 * @author John Blanco
 */

import DerivedProperty from '../../../../axon/js/DerivedProperty.js';
import EnumerationProperty from '../../../../axon/js/EnumerationProperty.js';
import Property from '../../../../axon/js/Property.js';
import TimeSpeed from '../../../../scenery-phet/js/TimeSpeed.js';
import neuron from '../../neuron.js';

// the following constants could easily be turned into options if there was a need to reuse and thus generalize
// this class.
const TIME_ADJUSTMENT_FACTOR = 7.32E-4; // in seconds, applied to the incoming dt values to scale it up or down
const NOMINAL_TICK_TIME = 1 / 60 * TIME_ADJUSTMENT_FACTOR; // used for single stepping, based on assumed frame rate of 60 fps
const TICKS_PER_SINGLE_STEP = 4;

// Max time that the simulation model can handle in a single tick.  This was determined through testing the
// simulation and is intended to prevent odd looking graphs and incorrect behavior, see
// https://github.com/phetsims/neuron/issues/114 and https://github.com/phetsims/neuron/issues/109.
const MAX_SIM_TICK_TIME = NOMINAL_TICK_TIME * 10; // empirically determined through testing of the simulation

class NeuronClockModelAdapter {
  /**
   * Creates a NeuronClockModelAdapter.
   * @param {NeuronModel} model - model whose simulation timing is controlled by this adapter.  Note that the Adapter is
   * generic and doesn't have any dependency on the model it controls.
   */
  constructor(model) {
    this.model = model;
    this.playingProperty = new Property(true); // linked to playPause button

    // @public {EnumerationDeprecatedProperty.<TimeSpeed>}
    this.timeSpeedProperty = new EnumerationProperty(TimeSpeed.NORMAL);

    // @public {DerivedProperty.<number>} - factor controlling simulation clock speed
    this.speedProperty = new DerivedProperty([this.timeSpeedProperty], timeSpeed => {
      const speed = timeSpeed === TimeSpeed.FAST ? 2 : timeSpeed === TimeSpeed.NORMAL ? 1 : timeSpeed === TimeSpeed.SLOW ? 0.5 : null;
      assert && assert(speed !== null, `no speed found for TimeSpeed ${timeSpeed}`);
      return speed;
    });
    this.stepCallbacks = [];
    this.resetCallBacks = [];
    this.residualTime = 0;
  }

  // @public
  step(dt) {
    // If the step is large, it probably means that the screen was hidden for a while, so just ignore it.
    if (dt > 0.5) {
      return;
    }
    if (this.playingProperty.get()) {
      // 'tick' the simulation, adjusting for dt values that are higher than the sim model can handle
      let simTickTime = dt * TIME_ADJUSTMENT_FACTOR * this.speedProperty.get();
      let numTicks = 1;
      if (simTickTime > MAX_SIM_TICK_TIME) {
        // this is a larger tick than the sim model can handle, so break it into multiple ticks
        numTicks = Math.floor(simTickTime / MAX_SIM_TICK_TIME);
        this.residualTime += simTickTime % MAX_SIM_TICK_TIME;
        simTickTime = MAX_SIM_TICK_TIME;
      }
      if (this.residualTime >= simTickTime) {
        numTicks++;
        this.residualTime = this.residualTime - simTickTime;
      }
      for (let i = 0; i < numTicks; i++) {
        this.tick(simTickTime);
      }
    }
  }

  // @public
  reset() {
    this.playingProperty.reset();
    this.timeSpeedProperty.reset();
    this.lastSimulationTime = 0.0;
    this.simulationTime = 0.0;

    //fire reset event callback
    for (let i = 0; i < this.resetCallBacks.length; i++) {
      this.resetCallBacks[i]();
    }
    this.model.reset();
  }

  /**
   * Registers a callback that will be notified when the step simulation occurs
   * Neuron Clock uses specialized real time step simulation
   * @param  {function} - callback that has a {dt} parameter
   * @public
   */
  registerStepCallback(callback) {
    this.stepCallbacks.push(callback);
  }

  /**
   * Registers a callback that will be notified when the clock is reset
   * @public
   */
  registerResetCallback(callback) {
    this.resetCallBacks.push(callback);
  }

  /**
   * Perform one 'tick' of the clock, which fires all callbacks with the provided simulation time
   * @private
   */
  tick(simulationTimeChange) {
    // fire step event callback
    for (let i = 0; i < this.stepCallbacks.length; i++) {
      this.stepCallbacks[i](simulationTimeChange);
    }
  }

  /**
   * advance the clock by a fixed amount used when stepping manually
   * @public
   */
  stepClockWhilePaused() {
    _.times(TICKS_PER_SINGLE_STEP, () => {
      this.tick(NOMINAL_TICK_TIME);
    });
  }

  /**
   * Move the clock backwards by the tickOnceTimeChange.
   * @public
   */
  stepClockBackWhilePaused() {
    _.times(TICKS_PER_SINGLE_STEP, () => {
      this.tick(-NOMINAL_TICK_TIME);
    });
  }
}
neuron.register('NeuronClockModelAdapter', NeuronClockModelAdapter);
export default NeuronClockModelAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEZXJpdmVkUHJvcGVydHkiLCJFbnVtZXJhdGlvblByb3BlcnR5IiwiUHJvcGVydHkiLCJUaW1lU3BlZWQiLCJuZXVyb24iLCJUSU1FX0FESlVTVE1FTlRfRkFDVE9SIiwiTk9NSU5BTF9USUNLX1RJTUUiLCJUSUNLU19QRVJfU0lOR0xFX1NURVAiLCJNQVhfU0lNX1RJQ0tfVElNRSIsIk5ldXJvbkNsb2NrTW9kZWxBZGFwdGVyIiwiY29uc3RydWN0b3IiLCJtb2RlbCIsInBsYXlpbmdQcm9wZXJ0eSIsInRpbWVTcGVlZFByb3BlcnR5IiwiTk9STUFMIiwic3BlZWRQcm9wZXJ0eSIsInRpbWVTcGVlZCIsInNwZWVkIiwiRkFTVCIsIlNMT1ciLCJhc3NlcnQiLCJzdGVwQ2FsbGJhY2tzIiwicmVzZXRDYWxsQmFja3MiLCJyZXNpZHVhbFRpbWUiLCJzdGVwIiwiZHQiLCJnZXQiLCJzaW1UaWNrVGltZSIsIm51bVRpY2tzIiwiTWF0aCIsImZsb29yIiwiaSIsInRpY2siLCJyZXNldCIsImxhc3RTaW11bGF0aW9uVGltZSIsInNpbXVsYXRpb25UaW1lIiwibGVuZ3RoIiwicmVnaXN0ZXJTdGVwQ2FsbGJhY2siLCJjYWxsYmFjayIsInB1c2giLCJyZWdpc3RlclJlc2V0Q2FsbGJhY2siLCJzaW11bGF0aW9uVGltZUNoYW5nZSIsInN0ZXBDbG9ja1doaWxlUGF1c2VkIiwiXyIsInRpbWVzIiwic3RlcENsb2NrQmFja1doaWxlUGF1c2VkIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJOZXVyb25DbG9ja01vZGVsQWRhcHRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNC0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBUaGUgY2xvY2sgZm9yIHRoaXMgc2ltdWxhdGlvbiwgd2hpY2ggcHJvdmlkZSBzdXBwb3J0IGZvciBub3JtYWwgb3BlcmF0aW9uLCBwbGF5IGFuZCBwYXVzZSwgc3RlcHBpbmcgYmFja3dhcmRzIGluXHJcbiAqIHRpbWUsIGFuZCBwbGF5YmFjayBvZiBwcmV2aW91c2x5IHJlY29yZGVkIGRhdGEuICBCZWNhdXNlIHRoZSBuZXVyb24gc2ltdWxhdGlvbiBkZXBpY3RzIGFjdGlvbiBwb3RlbnRpYWxzIGZhciBtb3JlXHJcbiAqIHNsb3dseSB0aGFuIHRoZXkgb2NjdXIgaW4gcmVhbCBsaXZlLCB0aGlzIGNsYXNzIGFkYXB0cyB0aGUgcmVhbCBjbG9jayB0aW1lIHRvIGEgc2xvd2VyIHJhdGUgd2hlbiBjbG9ja2luZyB0aGUgbW9kZWwuXHJcbiAqXHJcbiAqIE5vdGU6IFRoZSB3aG9sZSBhcHByb2FjaCBvZiB1c2luZyBleHBsaWNpdCBjbG9ja3MgYW5kIGNsb2NrIGFkYXB0ZXJzIGlzIGEgaG9sZG92ZXIgZnJvbSBQaEVUJ3MgSmF2YSBkYXlzLCBhbmQgaXNcclxuICogcHJlc2VudCBpbiB0aGlzIHNpbSBiZWNhdXNlIHRoZSBzaW0gd2FzIHBvcnRlZCBmcm9tIGEgSmF2YSB2ZXJzaW9uLiAgVXNlIG9mIHRoaXMgdGVjaG5pcXVlIGlzIG5vdCByZWNvbW1lbmRlZCBmb3JcclxuICogbmV3IEhUTUw1L0phdmFTY3JpcHQgc2ltdWxhdGlvbnMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqIEBhdXRob3IgU2hhcmZ1ZGVlbiBBc2hyYWYgKGZvciBHaGVudCBVbml2ZXJzaXR5KVxyXG4gKiBAYXV0aG9yIEpvaG4gQmxhbmNvXHJcbiAqL1xyXG5cclxuaW1wb3J0IERlcml2ZWRQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL0Rlcml2ZWRQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBFbnVtZXJhdGlvblByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvRW51bWVyYXRpb25Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFRpbWVTcGVlZCBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5LXBoZXQvanMvVGltZVNwZWVkLmpzJztcclxuaW1wb3J0IG5ldXJvbiBmcm9tICcuLi8uLi9uZXVyb24uanMnO1xyXG5cclxuLy8gdGhlIGZvbGxvd2luZyBjb25zdGFudHMgY291bGQgZWFzaWx5IGJlIHR1cm5lZCBpbnRvIG9wdGlvbnMgaWYgdGhlcmUgd2FzIGEgbmVlZCB0byByZXVzZSBhbmQgdGh1cyBnZW5lcmFsaXplXHJcbi8vIHRoaXMgY2xhc3MuXHJcbmNvbnN0IFRJTUVfQURKVVNUTUVOVF9GQUNUT1IgPSA3LjMyRS00OyAvLyBpbiBzZWNvbmRzLCBhcHBsaWVkIHRvIHRoZSBpbmNvbWluZyBkdCB2YWx1ZXMgdG8gc2NhbGUgaXQgdXAgb3IgZG93blxyXG5jb25zdCBOT01JTkFMX1RJQ0tfVElNRSA9ICggMSAvIDYwICkgKiBUSU1FX0FESlVTVE1FTlRfRkFDVE9SOyAvLyB1c2VkIGZvciBzaW5nbGUgc3RlcHBpbmcsIGJhc2VkIG9uIGFzc3VtZWQgZnJhbWUgcmF0ZSBvZiA2MCBmcHNcclxuY29uc3QgVElDS1NfUEVSX1NJTkdMRV9TVEVQID0gNDtcclxuXHJcbi8vIE1heCB0aW1lIHRoYXQgdGhlIHNpbXVsYXRpb24gbW9kZWwgY2FuIGhhbmRsZSBpbiBhIHNpbmdsZSB0aWNrLiAgVGhpcyB3YXMgZGV0ZXJtaW5lZCB0aHJvdWdoIHRlc3RpbmcgdGhlXHJcbi8vIHNpbXVsYXRpb24gYW5kIGlzIGludGVuZGVkIHRvIHByZXZlbnQgb2RkIGxvb2tpbmcgZ3JhcGhzIGFuZCBpbmNvcnJlY3QgYmVoYXZpb3IsIHNlZVxyXG4vLyBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvbmV1cm9uL2lzc3Vlcy8xMTQgYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9uZXVyb24vaXNzdWVzLzEwOS5cclxuY29uc3QgTUFYX1NJTV9USUNLX1RJTUUgPSBOT01JTkFMX1RJQ0tfVElNRSAqIDEwOyAvLyBlbXBpcmljYWxseSBkZXRlcm1pbmVkIHRocm91Z2ggdGVzdGluZyBvZiB0aGUgc2ltdWxhdGlvblxyXG5cclxuY2xhc3MgTmV1cm9uQ2xvY2tNb2RlbEFkYXB0ZXIge1xyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGVzIGEgTmV1cm9uQ2xvY2tNb2RlbEFkYXB0ZXIuXHJcbiAgICogQHBhcmFtIHtOZXVyb25Nb2RlbH0gbW9kZWwgLSBtb2RlbCB3aG9zZSBzaW11bGF0aW9uIHRpbWluZyBpcyBjb250cm9sbGVkIGJ5IHRoaXMgYWRhcHRlci4gIE5vdGUgdGhhdCB0aGUgQWRhcHRlciBpc1xyXG4gICAqIGdlbmVyaWMgYW5kIGRvZXNuJ3QgaGF2ZSBhbnkgZGVwZW5kZW5jeSBvbiB0aGUgbW9kZWwgaXQgY29udHJvbHMuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoIG1vZGVsICkge1xyXG5cclxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuXHJcbiAgICB0aGlzLnBsYXlpbmdQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggdHJ1ZSApOyAvLyBsaW5rZWQgdG8gcGxheVBhdXNlIGJ1dHRvblxyXG5cclxuICAgIC8vIEBwdWJsaWMge0VudW1lcmF0aW9uRGVwcmVjYXRlZFByb3BlcnR5LjxUaW1lU3BlZWQ+fVxyXG4gICAgdGhpcy50aW1lU3BlZWRQcm9wZXJ0eSA9IG5ldyBFbnVtZXJhdGlvblByb3BlcnR5KCBUaW1lU3BlZWQuTk9STUFMICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyB7RGVyaXZlZFByb3BlcnR5LjxudW1iZXI+fSAtIGZhY3RvciBjb250cm9sbGluZyBzaW11bGF0aW9uIGNsb2NrIHNwZWVkXHJcbiAgICB0aGlzLnNwZWVkUHJvcGVydHkgPSBuZXcgRGVyaXZlZFByb3BlcnR5KCBbIHRoaXMudGltZVNwZWVkUHJvcGVydHkgXSwgdGltZVNwZWVkID0+IHtcclxuICAgICAgY29uc3Qgc3BlZWQgPSB0aW1lU3BlZWQgPT09IFRpbWVTcGVlZC5GQVNUID8gMiA6XHJcbiAgICAgICAgICAgICAgICAgICAgdGltZVNwZWVkID09PSBUaW1lU3BlZWQuTk9STUFMID8gMSA6XHJcbiAgICAgICAgICAgICAgICAgICAgdGltZVNwZWVkID09PSBUaW1lU3BlZWQuU0xPVyA/IDAuNSA6XHJcbiAgICAgICAgICAgICAgICAgICAgbnVsbDtcclxuICAgICAgYXNzZXJ0ICYmIGFzc2VydCggc3BlZWQgIT09IG51bGwsIGBubyBzcGVlZCBmb3VuZCBmb3IgVGltZVNwZWVkICR7dGltZVNwZWVkfWAgKTtcclxuICAgICAgcmV0dXJuIHNwZWVkO1xyXG4gICAgfSApO1xyXG5cclxuICAgIHRoaXMuc3RlcENhbGxiYWNrcyA9IFtdO1xyXG4gICAgdGhpcy5yZXNldENhbGxCYWNrcyA9IFtdO1xyXG4gICAgdGhpcy5yZXNpZHVhbFRpbWUgPSAwO1xyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIHN0ZXAoIGR0ICkge1xyXG5cclxuICAgIC8vIElmIHRoZSBzdGVwIGlzIGxhcmdlLCBpdCBwcm9iYWJseSBtZWFucyB0aGF0IHRoZSBzY3JlZW4gd2FzIGhpZGRlbiBmb3IgYSB3aGlsZSwgc28ganVzdCBpZ25vcmUgaXQuXHJcbiAgICBpZiAoIGR0ID4gMC41ICkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCB0aGlzLnBsYXlpbmdQcm9wZXJ0eS5nZXQoKSApIHtcclxuXHJcbiAgICAgIC8vICd0aWNrJyB0aGUgc2ltdWxhdGlvbiwgYWRqdXN0aW5nIGZvciBkdCB2YWx1ZXMgdGhhdCBhcmUgaGlnaGVyIHRoYW4gdGhlIHNpbSBtb2RlbCBjYW4gaGFuZGxlXHJcbiAgICAgIGxldCBzaW1UaWNrVGltZSA9IGR0ICogVElNRV9BREpVU1RNRU5UX0ZBQ1RPUiAqIHRoaXMuc3BlZWRQcm9wZXJ0eS5nZXQoKTtcclxuICAgICAgbGV0IG51bVRpY2tzID0gMTtcclxuICAgICAgaWYgKCBzaW1UaWNrVGltZSA+IE1BWF9TSU1fVElDS19USU1FICkge1xyXG5cclxuICAgICAgICAvLyB0aGlzIGlzIGEgbGFyZ2VyIHRpY2sgdGhhbiB0aGUgc2ltIG1vZGVsIGNhbiBoYW5kbGUsIHNvIGJyZWFrIGl0IGludG8gbXVsdGlwbGUgdGlja3NcclxuICAgICAgICBudW1UaWNrcyA9IE1hdGguZmxvb3IoIHNpbVRpY2tUaW1lIC8gTUFYX1NJTV9USUNLX1RJTUUgKTtcclxuICAgICAgICB0aGlzLnJlc2lkdWFsVGltZSArPSBzaW1UaWNrVGltZSAlIE1BWF9TSU1fVElDS19USU1FO1xyXG4gICAgICAgIHNpbVRpY2tUaW1lID0gTUFYX1NJTV9USUNLX1RJTUU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCB0aGlzLnJlc2lkdWFsVGltZSA+PSBzaW1UaWNrVGltZSApIHtcclxuICAgICAgICBudW1UaWNrcysrO1xyXG4gICAgICAgIHRoaXMucmVzaWR1YWxUaW1lID0gdGhpcy5yZXNpZHVhbFRpbWUgLSBzaW1UaWNrVGltZTtcclxuICAgICAgfVxyXG4gICAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBudW1UaWNrczsgaSsrICkge1xyXG4gICAgICAgIHRoaXMudGljayggc2ltVGlja1RpbWUgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gQHB1YmxpY1xyXG4gIHJlc2V0KCkge1xyXG4gICAgdGhpcy5wbGF5aW5nUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMudGltZVNwZWVkUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMubGFzdFNpbXVsYXRpb25UaW1lID0gMC4wO1xyXG4gICAgdGhpcy5zaW11bGF0aW9uVGltZSA9IDAuMDtcclxuXHJcbiAgICAvL2ZpcmUgcmVzZXQgZXZlbnQgY2FsbGJhY2tcclxuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMucmVzZXRDYWxsQmFja3MubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHRoaXMucmVzZXRDYWxsQmFja3NbIGkgXSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5tb2RlbC5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXJzIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIG5vdGlmaWVkIHdoZW4gdGhlIHN0ZXAgc2ltdWxhdGlvbiBvY2N1cnNcclxuICAgKiBOZXVyb24gQ2xvY2sgdXNlcyBzcGVjaWFsaXplZCByZWFsIHRpbWUgc3RlcCBzaW11bGF0aW9uXHJcbiAgICogQHBhcmFtICB7ZnVuY3Rpb259IC0gY2FsbGJhY2sgdGhhdCBoYXMgYSB7ZHR9IHBhcmFtZXRlclxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZWdpc3RlclN0ZXBDYWxsYmFjayggY2FsbGJhY2sgKSB7XHJcbiAgICB0aGlzLnN0ZXBDYWxsYmFja3MucHVzaCggY2FsbGJhY2sgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlZ2lzdGVycyBhIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBub3RpZmllZCB3aGVuIHRoZSBjbG9jayBpcyByZXNldFxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZWdpc3RlclJlc2V0Q2FsbGJhY2soIGNhbGxiYWNrICkge1xyXG4gICAgdGhpcy5yZXNldENhbGxCYWNrcy5wdXNoKCBjYWxsYmFjayApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGVyZm9ybSBvbmUgJ3RpY2snIG9mIHRoZSBjbG9jaywgd2hpY2ggZmlyZXMgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBwcm92aWRlZCBzaW11bGF0aW9uIHRpbWVcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIHRpY2soIHNpbXVsYXRpb25UaW1lQ2hhbmdlICkge1xyXG4gICAgLy8gZmlyZSBzdGVwIGV2ZW50IGNhbGxiYWNrXHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnN0ZXBDYWxsYmFja3MubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIHRoaXMuc3RlcENhbGxiYWNrc1sgaSBdKCBzaW11bGF0aW9uVGltZUNoYW5nZSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogYWR2YW5jZSB0aGUgY2xvY2sgYnkgYSBmaXhlZCBhbW91bnQgdXNlZCB3aGVuIHN0ZXBwaW5nIG1hbnVhbGx5XHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXBDbG9ja1doaWxlUGF1c2VkKCkge1xyXG4gICAgXy50aW1lcyggVElDS1NfUEVSX1NJTkdMRV9TVEVQLCAoKSA9PiB7IHRoaXMudGljayggTk9NSU5BTF9USUNLX1RJTUUgKTsgfSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTW92ZSB0aGUgY2xvY2sgYmFja3dhcmRzIGJ5IHRoZSB0aWNrT25jZVRpbWVDaGFuZ2UuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqL1xyXG4gIHN0ZXBDbG9ja0JhY2tXaGlsZVBhdXNlZCgpIHtcclxuICAgIF8udGltZXMoIFRJQ0tTX1BFUl9TSU5HTEVfU1RFUCwgKCkgPT4geyB0aGlzLnRpY2soIC1OT01JTkFMX1RJQ0tfVElNRSApOyB9ICk7XHJcbiAgfVxyXG59XHJcblxyXG5uZXVyb24ucmVnaXN0ZXIoICdOZXVyb25DbG9ja01vZGVsQWRhcHRlcicsIE5ldXJvbkNsb2NrTW9kZWxBZGFwdGVyICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBOZXVyb25DbG9ja01vZGVsQWRhcHRlcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsbUJBQW1CLE1BQU0sNENBQTRDO0FBQzVFLE9BQU9DLFFBQVEsTUFBTSxpQ0FBaUM7QUFDdEQsT0FBT0MsU0FBUyxNQUFNLDBDQUEwQztBQUNoRSxPQUFPQyxNQUFNLE1BQU0saUJBQWlCOztBQUVwQztBQUNBO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFDeEMsTUFBTUMsaUJBQWlCLEdBQUssQ0FBQyxHQUFHLEVB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