// Copyright 2020-2023, University of Colorado Boulder

/**
 * IO Type for Nodes that can save their own index (if phetioState: true).  Can be used to customize z-order
 * or layout order.
 *
 * This IOType supports PhET-iO state, but only when every child within a Node's children array is an IndexedNodeIO
 * and is stateful (`phetioState: true`). This applyState algorithm uses Node "swaps" instead of index-based inserts
 * to ensure that by the end of state setting, all Nodes are in the correct order.
 * see https://github.com/phetsims/scenery/issues/1252#issuecomment-888014859 for more information.
 *
 * Invisible nodes are skipped in order to ensure that "move forward" moves past the next visible item and "move backward"
 * moves before the prior visible item. If we did not skip invisible nodes, then a user could press "move forward" and
 * be confused that the visible order does not change (even though the index changes).
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import FunctionIO from '../../../tandem/js/types/FunctionIO.js';
import IOType from '../../../tandem/js/types/IOType.js';
import NullableIO from '../../../tandem/js/types/NullableIO.js';
import NumberIO from '../../../tandem/js/types/NumberIO.js';
import VoidIO from '../../../tandem/js/types/VoidIO.js';
import { Node, scenery } from '../imports.js';
// In order to support unlinking from listening to the index property, keep an indexed map to callback functions
const map = {};

// The next index at which a callback will appear in the map. This always increments and we do reuse old indices
let index = 0;

// Move this node one index forward in each of its parents, jumping over invisible nodes. If the Node is already at the front, this is a no-op.
function moveForward(node) {
  node._parents.forEach(parent => moveChild(parent, node, +1));
}

// Move this node one index backward in each of its parents, jumping over invisible nodes.  If the Node is already at the back, this is a no-op.
function moveBackward(node) {
  node._parents.forEach(parent => moveChild(parent, node, -1));
}

/**
 * Moves the specified child by +1/-1 indices, without going past the beginning or end.
 */
function moveChild(parent, child, delta) {
  const index = parent.indexOfChild(child);
  let targetIndex = index + delta;

  // skip invisible children
  while (targetIndex > 0 && targetIndex < parent.children.length && !parent.children[targetIndex].visible) {
    targetIndex += delta;
  }
  if (targetIndex >= 0 && targetIndex < parent.children.length) {
    parent.moveChildToIndex(child, targetIndex);
  }
  parent.onIndexedNodeIOChildMoved && parent.onIndexedNodeIOChildMoved(child);
}
const IndexedNodeIO = new IOType('IndexedNodeIO', {
  valueType: Node,
  documentation: 'Node that can be moved forward/back by index, which specifies z-order and/or layout order',
  supertype: Node.NodeIO,
  toStateObject: node => {
    const stateObject = {
      index: null
    };
    if (node.parents[0]) {
      assert && assert(node.parents.length === 1, 'IndexedNodeIO only supports nodes with a single parent');
      stateObject.index = node.parents[0].indexOfChild(node);
    }
    return stateObject;
  },
  applyState: (node, stateObject) => {
    const nodeParent = node.parents[0];
    if (nodeParent && stateObject.index) {
      assert && assert(node.parents.length === 1, 'IndexedNodeIO only supports nodes with a single parent');

      // Swap the child at the destination index with current position of this Node, that way the operation is atomic.
      // This implementation assumes that all children are instrumented IndexedNodeIO instances and can have state set
      // on them to "fix them" after this operation. Without this implementation, using Node.moveChildToIndex could blow
      // away another IndexedNode state set. See https://github.com/phetsims/ph-scale/issues/227
      const children = nodeParent.children;
      const currentIndex = nodeParent.indexOfChild(node);
      children[currentIndex] = children[stateObject.index];
      children[stateObject.index] = node;
      nodeParent.setChildren(children);
    }
  },
  stateSchema: {
    index: NullableIO(NumberIO)
  },
  methods: {
    linkIndex: {
      returnType: NumberIO,
      parameterTypes: [FunctionIO(VoidIO, [NumberIO])],
      documentation: 'Following the PropertyIO.link pattern, subscribe for notifications when the index in the parent ' + 'changes, and receive a callback with the current value.  The return value is a numeric ID for use ' + 'with clearLinkIndex.',
      implementation: function (listener) {
        // The callback which signifies the current index
        const callback = () => {
          assert && assert(this.parents.length === 1, 'IndexedNodeIO only supports nodes with a single parent');
          const index = this.parents[0].indexOfChild(this);
          listener(index);
        };
        assert && assert(this.parents.length === 1, 'IndexedNodeIO only supports nodes with a single parent');
        this.parents[0].childrenChangedEmitter.addListener(callback);
        callback();
        const myIndex = index;
        map[myIndex] = callback;
        index++;
        return myIndex;
      }
    },
    clearLinkIndex: {
      returnType: VoidIO,
      parameterTypes: [NumberIO],
      documentation: 'Unlink a listener that has been added using linkIndex, by its numerical ID (like setTimeout/clearTimeout)',
      implementation: function (index) {
        const method = map[index];
        assert && assert(this.parents.length === 1, 'IndexedNodeIO only supports nodes with a single parent');
        this.parents[0].childrenChangedEmitter.removeListener(method);
        delete map[index];
      }
    },
    moveForward: {
      returnType: VoidIO,
      parameterTypes: [],
      implementation: function () {
        return moveForward(this);
      },
      documentation: 'Move this Node one index forward in each of its parents, skipping invisible Nodes. If the Node is already at the front, this is a no-op.'
    },
    moveBackward: {
      returnType: VoidIO,
      parameterTypes: [],
      implementation: function () {
        return moveBackward(this);
      },
      documentation: 'Move this Node one index backward in each of its parents, skipping invisible Nodes. If the Node is already at the back, this is a no-op.'
    }
  }
});
scenery.register('IndexedNodeIO', IndexedNodeIO);
export default IndexedNodeIO;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJGdW5jdGlvbklPIiwiSU9UeXBlIiwiTnVsbGFibGVJTyIsIk51bWJlcklPIiwiVm9pZElPIiwiTm9kZSIsInNjZW5lcnkiLCJtYXAiLCJpbmRleCIsIm1vdmVGb3J3YXJkIiwibm9kZSIsIl9wYXJlbnRzIiwiZm9yRWFjaCIsInBhcmVudCIsIm1vdmVDaGlsZCIsIm1vdmVCYWNrd2FyZCIsImNoaWxkIiwiZGVsdGEiLCJpbmRleE9mQ2hpbGQiLCJ0YXJnZXRJbmRleCIsImNoaWxkcmVuIiwibGVuZ3RoIiwidmlzaWJsZSIsIm1vdmVDaGlsZFRvSW5kZXgiLCJvbkluZGV4ZWROb2RlSU9DaGlsZE1vdmVkIiwiSW5kZXhlZE5vZGVJTyIsInZhbHVlVHlwZSIsImRvY3VtZW50YXRpb24iLCJzdXBlcnR5cGUiLCJOb2RlSU8iLCJ0b1N0YXRlT2JqZWN0Iiwic3RhdGVPYmplY3QiLCJwYXJlbnRzIiwiYXNzZXJ0IiwiYXBwbHlTdGF0ZSIsIm5vZGVQYXJlbnQiLCJjdXJyZW50SW5kZXgiLCJzZXRDaGlsZHJlbiIsInN0YXRlU2NoZW1hIiwibWV0aG9kcyIsImxpbmtJbmRleCIsInJldHVyblR5cGUiLCJwYXJhbWV0ZXJUeXBlcyIsImltcGxlbWVudGF0aW9uIiwibGlzdGVuZXIiLCJjYWxsYmFjayIsImNoaWxkcmVuQ2hhbmdlZEVtaXR0ZXIiLCJhZGRMaXN0ZW5lciIsIm15SW5kZXgiLCJjbGVhckxpbmtJbmRleCIsIm1ldGhvZCIsInJlbW92ZUxpc3RlbmVyIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJJbmRleGVkTm9kZUlPLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDIwLTIwMjMsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIElPIFR5cGUgZm9yIE5vZGVzIHRoYXQgY2FuIHNhdmUgdGhlaXIgb3duIGluZGV4IChpZiBwaGV0aW9TdGF0ZTogdHJ1ZSkuICBDYW4gYmUgdXNlZCB0byBjdXN0b21pemUgei1vcmRlclxyXG4gKiBvciBsYXlvdXQgb3JkZXIuXHJcbiAqXHJcbiAqIFRoaXMgSU9UeXBlIHN1cHBvcnRzIFBoRVQtaU8gc3RhdGUsIGJ1dCBvbmx5IHdoZW4gZXZlcnkgY2hpbGQgd2l0aGluIGEgTm9kZSdzIGNoaWxkcmVuIGFycmF5IGlzIGFuIEluZGV4ZWROb2RlSU9cclxuICogYW5kIGlzIHN0YXRlZnVsIChgcGhldGlvU3RhdGU6IHRydWVgKS4gVGhpcyBhcHBseVN0YXRlIGFsZ29yaXRobSB1c2VzIE5vZGUgXCJzd2Fwc1wiIGluc3RlYWQgb2YgaW5kZXgtYmFzZWQgaW5zZXJ0c1xyXG4gKiB0byBlbnN1cmUgdGhhdCBieSB0aGUgZW5kIG9mIHN0YXRlIHNldHRpbmcsIGFsbCBOb2RlcyBhcmUgaW4gdGhlIGNvcnJlY3Qgb3JkZXIuXHJcbiAqIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvc2NlbmVyeS9pc3N1ZXMvMTI1MiNpc3N1ZWNvbW1lbnQtODg4MDE0ODU5IGZvciBtb3JlIGluZm9ybWF0aW9uLlxyXG4gKlxyXG4gKiBJbnZpc2libGUgbm9kZXMgYXJlIHNraXBwZWQgaW4gb3JkZXIgdG8gZW5zdXJlIHRoYXQgXCJtb3ZlIGZvcndhcmRcIiBtb3ZlcyBwYXN0IHRoZSBuZXh0IHZpc2libGUgaXRlbSBhbmQgXCJtb3ZlIGJhY2t3YXJkXCJcclxuICogbW92ZXMgYmVmb3JlIHRoZSBwcmlvciB2aXNpYmxlIGl0ZW0uIElmIHdlIGRpZCBub3Qgc2tpcCBpbnZpc2libGUgbm9kZXMsIHRoZW4gYSB1c2VyIGNvdWxkIHByZXNzIFwibW92ZSBmb3J3YXJkXCIgYW5kXHJcbiAqIGJlIGNvbmZ1c2VkIHRoYXQgdGhlIHZpc2libGUgb3JkZXIgZG9lcyBub3QgY2hhbmdlIChldmVuIHRob3VnaCB0aGUgaW5kZXggY2hhbmdlcykuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuaW1wb3J0IEZ1bmN0aW9uSU8gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL3R5cGVzL0Z1bmN0aW9uSU8uanMnO1xyXG5pbXBvcnQgSU9UeXBlIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9JT1R5cGUuanMnO1xyXG5pbXBvcnQgTnVsbGFibGVJTyBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVsbGFibGVJTy5qcyc7XHJcbmltcG9ydCBOdW1iZXJJTyBmcm9tICcuLi8uLi8uLi90YW5kZW0vanMvdHlwZXMvTnVtYmVySU8uanMnO1xyXG5pbXBvcnQgVm9pZElPIGZyb20gJy4uLy4uLy4uL3RhbmRlbS9qcy90eXBlcy9Wb2lkSU8uanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBzY2VuZXJ5IH0gZnJvbSAnLi4vaW1wb3J0cy5qcyc7XHJcblxyXG5leHBvcnQgdHlwZSBJbmRleGVkTm9kZUlPUGFyZW50ID0ge1xyXG4gIG9uSW5kZXhlZE5vZGVJT0NoaWxkTW92ZWQ6ICggbm9kZTogTm9kZSApID0+IHZvaWQ7XHJcbn07XHJcbnR5cGUgSW5kZXhlZE5vZGVJT09ic2VydmVyID0gUGFydGlhbDxJbmRleGVkTm9kZUlPUGFyZW50PiAmIE5vZGU7XHJcblxyXG4vLyBJbiBvcmRlciB0byBzdXBwb3J0IHVubGlua2luZyBmcm9tIGxpc3RlbmluZyB0byB0aGUgaW5kZXggcHJvcGVydHksIGtlZXAgYW4gaW5kZXhlZCBtYXAgdG8gY2FsbGJhY2sgZnVuY3Rpb25zXHJcbmNvbnN0IG1hcDogUmVjb3JkPG51bWJlciwgKCkgPT4gdm9pZD4gPSB7fTtcclxuXHJcbi8vIFRoZSBuZXh0IGluZGV4IGF0IHdoaWNoIGEgY2FsbGJhY2sgd2lsbCBhcHBlYXIgaW4gdGhlIG1hcC4gVGhpcyBhbHdheXMgaW5jcmVtZW50cyBhbmQgd2UgZG8gcmV1c2Ugb2xkIGluZGljZXNcclxubGV0IGluZGV4ID0gMDtcclxuXHJcbi8vIE1vdmUgdGhpcyBub2RlIG9uZSBpbmRleCBmb3J3YXJkIGluIGVhY2ggb2YgaXRzIHBhcmVudHMsIGp1bXBpbmcgb3ZlciBpbnZpc2libGUgbm9kZXMuIElmIHRoZSBOb2RlIGlzIGFscmVhZHkgYXQgdGhlIGZyb250LCB0aGlzIGlzIGEgbm8tb3AuXHJcbmZ1bmN0aW9uIG1vdmVGb3J3YXJkKCBub2RlOiBOb2RlICk6IHZvaWQge1xyXG4gIG5vZGUuX3BhcmVudHMuZm9yRWFjaCggcGFyZW50ID0+IG1vdmVDaGlsZCggcGFyZW50IGFzIEluZGV4ZWROb2RlSU9PYnNlcnZlciwgbm9kZSwgKzEgKSApO1xyXG59XHJcblxyXG4vLyBNb3ZlIHRoaXMgbm9kZSBvbmUgaW5kZXggYmFja3dhcmQgaW4gZWFjaCBvZiBpdHMgcGFyZW50cywganVtcGluZyBvdmVyIGludmlzaWJsZSBub2Rlcy4gIElmIHRoZSBOb2RlIGlzIGFscmVhZHkgYXQgdGhlIGJhY2ssIHRoaXMgaXMgYSBuby1vcC5cclxuZnVuY3Rpb24gbW92ZUJhY2t3YXJkKCBub2RlOiBOb2RlICk6IHZvaWQge1xyXG4gIG5vZGUuX3BhcmVudHMuZm9yRWFjaCggcGFyZW50ID0+IG1vdmVDaGlsZCggcGFyZW50IGFzIEluZGV4ZWROb2RlSU9PYnNlcnZlciwgbm9kZSwgLTEgKSApO1xyXG59XHJcblxyXG4vKipcclxuICogTW92ZXMgdGhlIHNwZWNpZmllZCBjaGlsZCBieSArMS8tMSBpbmRpY2VzLCB3aXRob3V0IGdvaW5nIHBhc3QgdGhlIGJlZ2lubmluZyBvciBlbmQuXHJcbiAqL1xyXG5mdW5jdGlvbiBtb3ZlQ2hpbGQoIHBhcmVudDogSW5kZXhlZE5vZGVJT09ic2VydmVyLCBjaGlsZDogTm9kZSwgZGVsdGE6IG51bWJlciApOiB2b2lkIHtcclxuICBjb25zdCBpbmRleCA9IHBhcmVudC5pbmRleE9mQ2hpbGQoIGNoaWxkICk7XHJcblxyXG4gIGxldCB0YXJnZXRJbmRleCA9IGluZGV4ICsgZGVsdGE7XHJcblxyXG4gIC8vIHNraXAgaW52aXNpYmxlIGNoaWxkcmVuXHJcbiAgd2hpbGUgKCB0YXJnZXRJbmRleCA+IDAgJiYgdGFyZ2V0SW5kZXggPCBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoICYmICFwYXJlbnQuY2hpbGRyZW5bIHRhcmdldEluZGV4IF0udmlzaWJsZSApIHtcclxuICAgIHRhcmdldEluZGV4ICs9IGRlbHRhO1xyXG4gIH1cclxuXHJcbiAgaWYgKCB0YXJnZXRJbmRleCA+PSAwICYmIHRhcmdldEluZGV4IDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aCApIHtcclxuICAgIHBhcmVudC5tb3ZlQ2hpbGRUb0luZGV4KCBjaGlsZCwgdGFyZ2V0SW5kZXggKTtcclxuICB9XHJcblxyXG4gIHBhcmVudC5vbkluZGV4ZWROb2RlSU9DaGlsZE1vdmVkICYmIHBhcmVudC5vbkluZGV4ZWROb2RlSU9DaGlsZE1vdmVkKCBjaGlsZCApO1xyXG59XHJcblxyXG5jb25zdCBJbmRleGVkTm9kZUlPID0gbmV3IElPVHlwZSggJ0luZGV4ZWROb2RlSU8nLCB7XHJcbiAgdmFsdWVUeXBlOiBOb2RlLFxyXG4gIGRvY3VtZW50YXRpb246ICdOb2RlIHRoYXQgY2FuIGJlIG1vdmVkIGZvcndhcmQvYmFjayBieSBpbmRleCwgd2hpY2ggc3BlY2lmaWVzIHotb3JkZXIgYW5kL29yIGxheW91dCBvcmRlcicsXHJcbiAgc3VwZXJ0eXBlOiBOb2RlLk5vZGVJTyxcclxuICB0b1N0YXRlT2JqZWN0OiBub2RlID0+IHtcclxuICAgIGNvbnN0IHN0YXRlT2JqZWN0OiB7IGluZGV4OiBudW1iZXIgfCBudWxsIH0gPSB7IGluZGV4OiBudWxsIH07XHJcbiAgICBpZiAoIG5vZGUucGFyZW50c1sgMCBdICkge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBub2RlLnBhcmVudHMubGVuZ3RoID09PSAxLCAnSW5kZXhlZE5vZGVJTyBvbmx5IHN1cHBvcnRzIG5vZGVzIHdpdGggYSBzaW5nbGUgcGFyZW50JyApO1xyXG4gICAgICBzdGF0ZU9iamVjdC5pbmRleCA9IG5vZGUucGFyZW50c1sgMCBdLmluZGV4T2ZDaGlsZCggbm9kZSApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0YXRlT2JqZWN0O1xyXG4gIH0sXHJcbiAgYXBwbHlTdGF0ZTogKCBub2RlLCBzdGF0ZU9iamVjdCApID0+IHtcclxuICAgIGNvbnN0IG5vZGVQYXJlbnQgPSBub2RlLnBhcmVudHNbIDAgXTtcclxuXHJcbiAgICBpZiAoIG5vZGVQYXJlbnQgJiYgc3RhdGVPYmplY3QuaW5kZXggKSB7XHJcbiAgICAgIGFzc2VydCAmJiBhc3NlcnQoIG5vZGUucGFyZW50cy5sZW5ndGggPT09IDEsICdJbmRleGVkTm9kZUlPIG9ubHkgc3VwcG9ydHMgbm9kZXMgd2l0aCBhIHNpbmdsZSBwYXJlbnQnICk7XHJcblxyXG4gICAgICAvLyBTd2FwIHRoZSBjaGlsZCBhdCB0aGUgZGVzdGluYXRpb24gaW5kZXggd2l0aCBjdXJyZW50IHBvc2l0aW9uIG9mIHRoaXMgTm9kZSwgdGhhdCB3YXkgdGhlIG9wZXJhdGlvbiBpcyBhdG9taWMuXHJcbiAgICAgIC8vIFRoaXMgaW1wbGVtZW50YXRpb24gYXNzdW1lcyB0aGF0IGFsbCBjaGlsZHJlbiBhcmUgaW5zdHJ1bWVudGVkIEluZGV4ZWROb2RlSU8gaW5zdGFuY2VzIGFuZCBjYW4gaGF2ZSBzdGF0ZSBzZXRcclxuICAgICAgLy8gb24gdGhlbSB0byBcImZpeCB0aGVtXCIgYWZ0ZXIgdGhpcyBvcGVyYXRpb24uIFdpdGhvdXQgdGhpcyBpbXBsZW1lbnRhdGlvbiwgdXNpbmcgTm9kZS5tb3ZlQ2hpbGRUb0luZGV4IGNvdWxkIGJsb3dcclxuICAgICAgLy8gYXdheSBhbm90aGVyIEluZGV4ZWROb2RlIHN0YXRlIHNldC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9waC1zY2FsZS9pc3N1ZXMvMjI3XHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gbm9kZVBhcmVudC5jaGlsZHJlbjtcclxuICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gbm9kZVBhcmVudC5pbmRleE9mQ2hpbGQoIG5vZGUgKTtcclxuICAgICAgY2hpbGRyZW5bIGN1cnJlbnRJbmRleCBdID0gY2hpbGRyZW5bIHN0YXRlT2JqZWN0LmluZGV4IF07XHJcbiAgICAgIGNoaWxkcmVuWyBzdGF0ZU9iamVjdC5pbmRleCBdID0gbm9kZTtcclxuICAgICAgbm9kZVBhcmVudC5zZXRDaGlsZHJlbiggY2hpbGRyZW4gKTtcclxuICAgIH1cclxuICB9LFxyXG4gIHN0YXRlU2NoZW1hOiB7XHJcbiAgICBpbmRleDogTnVsbGFibGVJTyggTnVtYmVySU8gKVxyXG4gIH0sXHJcbiAgbWV0aG9kczoge1xyXG4gICAgbGlua0luZGV4OiB7XHJcbiAgICAgIHJldHVyblR5cGU6IE51bWJlcklPLFxyXG4gICAgICBwYXJhbWV0ZXJUeXBlczogWyBGdW5jdGlvbklPKCBWb2lkSU8sIFsgTnVtYmVySU8gXSApIF0sXHJcbiAgICAgIGRvY3VtZW50YXRpb246ICdGb2xsb3dpbmcgdGhlIFByb3BlcnR5SU8ubGluayBwYXR0ZXJuLCBzdWJzY3JpYmUgZm9yIG5vdGlmaWNhdGlvbnMgd2hlbiB0aGUgaW5kZXggaW4gdGhlIHBhcmVudCAnICtcclxuICAgICAgICAgICAgICAgICAgICAgJ2NoYW5nZXMsIGFuZCByZWNlaXZlIGEgY2FsbGJhY2sgd2l0aCB0aGUgY3VycmVudCB2YWx1ZS4gIFRoZSByZXR1cm4gdmFsdWUgaXMgYSBudW1lcmljIElEIGZvciB1c2UgJyArXHJcbiAgICAgICAgICAgICAgICAgICAgICd3aXRoIGNsZWFyTGlua0luZGV4LicsXHJcbiAgICAgIGltcGxlbWVudGF0aW9uOiBmdW5jdGlvbiggdGhpczogTm9kZSwgbGlzdGVuZXIgKSB7XHJcblxyXG4gICAgICAgIC8vIFRoZSBjYWxsYmFjayB3aGljaCBzaWduaWZpZXMgdGhlIGN1cnJlbnQgaW5kZXhcclxuICAgICAgICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHtcclxuICAgICAgICAgIGFzc2VydCAmJiBhc3NlcnQoIHRoaXMucGFyZW50cy5sZW5ndGggPT09IDEsICdJbmRleGVkTm9kZUlPIG9ubHkgc3VwcG9ydHMgbm9kZXMgd2l0aCBhIHNpbmdsZSBwYXJlbnQnICk7XHJcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMucGFyZW50c1sgMCBdLmluZGV4T2ZDaGlsZCggdGhpcyApO1xyXG4gICAgICAgICAgbGlzdGVuZXIoIGluZGV4ICk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgYXNzZXJ0ICYmIGFzc2VydCggdGhpcy5wYXJlbnRzLmxlbmd0aCA9PT0gMSwgJ0luZGV4ZWROb2RlSU8gb25seSBzdXBwb3J0cyBub2RlcyB3aXRoIGEgc2luZ2xlIHBhcmVudCcgKTtcclxuICAgICAgICB0aGlzLnBhcmVudHNbIDAgXS5jaGlsZHJlbkNoYW5nZWRFbWl0dGVyLmFkZExpc3RlbmVyKCBjYWxsYmFjayApO1xyXG4gICAgICAgIGNhbGxiYWNrKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG15SW5kZXggPSBpbmRleDtcclxuICAgICAgICBtYXBbIG15SW5kZXggXSA9IGNhbGxiYWNrO1xyXG4gICAgICAgIGluZGV4Kys7XHJcbiAgICAgICAgcmV0dXJuIG15SW5kZXg7XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBjbGVhckxpbmtJbmRleDoge1xyXG4gICAgICByZXR1cm5UeXBlOiBWb2lkSU8sXHJcbiAgICAgIHBhcmFtZXRlclR5cGVzOiBbIE51bWJlcklPIF0sXHJcbiAgICAgIGRvY3VtZW50YXRpb246ICdVbmxpbmsgYSBsaXN0ZW5lciB0aGF0IGhhcyBiZWVuIGFkZGVkIHVzaW5nIGxpbmtJbmRleCwgYnkgaXRzIG51bWVyaWNhbCBJRCAobGlrZSBzZXRUaW1lb3V0L2NsZWFyVGltZW91dCknLFxyXG4gICAgICBpbXBsZW1lbnRhdGlvbjogZnVuY3Rpb24oIHRoaXM6IE5vZGUsIGluZGV4ICkge1xyXG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IG1hcFsgaW5kZXggXTtcclxuICAgICAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0aGlzLnBhcmVudHMubGVuZ3RoID09PSAxLCAnSW5kZXhlZE5vZGVJTyBvbmx5IHN1cHBvcnRzIG5vZGVzIHdpdGggYSBzaW5nbGUgcGFyZW50JyApO1xyXG4gICAgICAgIHRoaXMucGFyZW50c1sgMCBdLmNoaWxkcmVuQ2hhbmdlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIG1ldGhvZCApO1xyXG4gICAgICAgIGRlbGV0ZSBtYXBbIGluZGV4IF07XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBtb3ZlRm9yd2FyZDoge1xyXG4gICAgICByZXR1cm5UeXBlOiBWb2lkSU8sXHJcbiAgICAgIHBhcmFtZXRlclR5cGVzOiBbXSxcclxuICAgICAgaW1wbGVtZW50YXRpb246IGZ1bmN0aW9uKCB0aGlzOiBOb2RlICkge1xyXG4gICAgICAgIHJldHVybiBtb3ZlRm9yd2FyZCggdGhpcyApO1xyXG4gICAgICB9LFxyXG4gICAgICBkb2N1bWVudGF0aW9uOiAnTW92ZSB0aGlzIE5vZGUgb25lIGluZGV4IGZvcndhcmQgaW4gZWFjaCBvZiBpdHMgcGFyZW50cywgc2tpcHBpbmcgaW52aXNpYmxlIE5vZGVzLiBJZiB0aGUgTm9kZSBpcyBhbHJlYWR5IGF0IHRoZSBmcm9udCwgdGhpcyBpcyBhIG5vLW9wLidcclxuICAgIH0sXHJcblxyXG4gICAgbW92ZUJhY2t3YXJkOiB7XHJcbiAgICAgIHJldHVyblR5cGU6IFZvaWRJTyxcclxuICAgICAgcGFyYW1ldGVyVHlwZXM6IFtdLFxyXG4gICAgICBpbXBsZW1lbnRhdGlvbjogZnVuY3Rpb24oIHRoaXM6IE5vZGUgKSB7XHJcbiAgICAgICAgcmV0dXJuIG1vdmVCYWNrd2FyZCggdGhpcyApO1xyXG4gICAgICB9LFxyXG4gICAgICBkb2N1bWVudGF0aW9uOiAnTW92ZSB0aGlzIE5vZGUgb25lIGluZGV4IGJhY2t3YXJkIGluIGVhY2ggb2YgaXRzIHBhcmVudHMsIHNraXBwaW5nIGludmlzaWJsZSBOb2Rlcy4gSWYgdGhlIE5vZGUgaXMgYWxyZWFkeSBhdCB0aGUgYmFjaywgdGhpcyBpcyBhIG5vLW9wLidcclxuICAgIH1cclxuICB9XHJcbn0gKTtcclxuXHJcbnNjZW5lcnkucmVnaXN0ZXIoICdJbmRleGVkTm9kZUlPJywgSW5kZXhlZE5vZGVJTyApO1xyXG5leHBvcnQgZGVmYXVsdCBJbmRleGVkTm9kZUlPOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLFVBQVUsTUFBTSx3Q0FBd0M7QUFDL0QsT0FBT0MsTUFBTSxNQUFNLG9DQUFvQztBQUN2RCxPQUFPQyxVQUFVLE1BQU0sd0NBQXdDO0FBQy9ELE9BQU9DLFFBQVEsTUFBTSxzQ0FBc0M7QUFDM0QsT0FBT0MsTUFBTSxNQUFNLG9DQUFvQztBQUN2RCxTQUFTQyxJQUFJLEVBQUVDLE9BQU8sUUFBUSxlQUFlO0FBTzdDO0FBQ0EsTUFBTUMsR0FBK0IsR0FBRyxDQUFDLENBQUM7O0FBRTFDO0FBQ0EsSUFBSUMsS0FBSyxHQUFHLENBQUM7O0FBRWI7QUFDQSxTQUFTQyxXQUFXQSxDQUFFQyxJQUFVLEVBQVM7RUFDdkNBLElBQUksQ0FBQ0MsUUFBUSxDQUFDQyxPQUFPLENBQUVDLE1BQU0sSUFBSUMsU0FBUyxDQUFFRCxNQUFNLEVBQTJCSCxJQUFJLEVBQUUsQ0FBQyxDQUFFLENBQUUsQ0FBQztBQUMzRjs7QUFFQTtBQUNBLFNBQVNLLFlBQVlBLENBQUVMLElBQVUsRUFBUztFQUN4Q0EsSUFBSSxDQUFDQyxRQUFRLENBQUNDLE9BQU8sQ0FBRUMsTUFBTSxJQUFJQyxTQUFTLENBQUVELE1BQU0sRUFBMkJILElBQUksRUFBRSxDQUFDLENBQUUsQ0FBRSxDQUFDO0FBQzNGOztBQUVBO0FBQ0E7QUFDQTtBQUNBLFNBQVNJLFNBQVNBLENBQUVELE1BQTZCLEVBQUVHLEtBQVcsRUFBRUMsS0FBYSxFQUFTO0VBQ3BGLE1BQU1ULEtBQUssR0FBR0ssTUFBTSxDQUFDSyxZQUFZLENBQUVGLEtBQU0sQ0FBQztFQUUxQyxJQUFJRyxXQUFXLEdBQUdYLEtBQUssR0FBR1MsS0FBSzs7RUFFL0I7RUFDQSxPQUFRRSxXQUFXLEdBQUcsQ0FBQyxJQUFJQSxXQUFXLEdBQUdOLE1BQU0sQ0FBQ08sUUFBUSxDQUFDQyxNQUFNLElBQUksQ0FBQ1IsTUFBTSxDQUFDTyxRQUFRLENBQUVELFdBQVcsQ0FBRSxDQUFDRyxPQUFPLEVBQUc7SUFDM0dILFdBQVcsSUFBSUYsS0FBSztFQUN0QjtFQUVBLElBQUtFLFdBQVcsSUFBSSxDQUFDLElBQUlBLFdBQVcsR0FBR04sTUFBTSxDQUFDTyxRQUFRLENBQUNDLE1BQU0sRUFBRztJQUM5RFIsTUFBTSxDQUFDVSxnQkFBZ0IsQ0FBRVAsS0FBSyxFQUFFRyxXQUFZLENBQUM7RUFDL0M7RUFFQU4sTUFBTSxDQUFDVyx5QkFBeUIsSUFBSVgsTUFBTSxDQUFDVyx5QkFBeUIsQ0FBRVIsS0FBTSxDQUFDO0FBQy9FO0FBRUEsTUFBTVMsYUFBYSxHQUFHLElBQUl4QixNQUFNLENBQUUsZUFBZSxFQUFFO0VBQ2pEeUIsU0FBUyxFQUFFckIsSUFBSTtFQUNmc0IsYUFBYSxFQUFFLDJGQUEyRjtFQUMxR0MsU0FBUyxFQUFFdkIsSUFBSSxDQUFDd0IsTUFBTTtFQUN0QkMsYUFBYSxFQUFFcEIsSUFBSSxJQUFJO0lBQ3JCLE1BQU1xQixXQUFxQyxHQUFHO01BQUV2QixLQUFLLEVBQUU7SUFBSyxDQUFDO0lBQzdELElBQUtFLElBQUksQ0FBQ3NCLE9BQU8sQ0FBRSxDQUFDLENBQUUsRUFBRztNQUN2QkMsTUFBTSxJQUFJQSxNQUFNLENBQUV2QixJQUFJLENBQUNzQixPQUFPLENBQUNYLE1BQU0sS0FBSyxDQUFDLEVBQUUsd0RBQXlELENBQUM7TUFDdkdVLFdBQVcsQ0FBQ3ZCLEtBQUssR0FBR0UsSUFBSSxDQUFDc0IsT0FBTyxDQUFFLENBQUMsQ0FBRSxDQUFDZCxZQUFZLENBQUVSLElBQUssQ0FBQztJQUM1RDtJQUNBLE9BQU9xQixXQUFXO0VBQ3BCLENBQUM7RUFDREcsVUFBVSxFQUFFQSxDQUFFeEIsSUFBSSxFQUFFcUIsV0FBVyxLQUFNO0lBQ25DLE1BQU1JLFVBQVUsR0FBR3pCLElBQUksQ0FBQ3NCLE9BQU8sQ0FBRSxDQUFDLENBQUU7SUFFcEMsSUFBS0csVUFBVSxJQUFJSixXQUFXLENBQUN2QixLQUFLLEVBQUc7TUFDckN5QixNQUFNLElBQUlBLE1BQU0sQ0FBRXZCLElBQUksQ0FBQ3NCLE9BQU8sQ0FBQ1gsTUFBTSxLQUFLLENBQUMsRUFBRSx3REFBeUQsQ0FBQzs7TUFFdkc7TUFDQTtNQUNBO01BQ0E7TUFDQSxNQUFNRCxRQUFRLEdBQUdlLFVBQVUsQ0FBQ2YsUUFBUTtNQUNwQyxNQUFNZ0IsWUFBWSxHQUFHRCxVQUFVLENBQUNqQixZQUFZLENBQUVSLElBQUssQ0FBQztNQUNwRFUsUUFBUSxDQUFFZ0IsWUFBWSxDQUFFLEdBQUdoQixRQUFRLENBQUVXLFdBQVcsQ0FBQ3ZCLEtBQUssQ0FBRTtNQUN4RFksUUFBUSxDQUFFVyxXQUFXLENBQUN2QixLQUFLLENBQUUsR0FBR0UsSUFBSTtNQUNwQ3lCLFVBQVUsQ0FBQ0UsV0FBVyxDQUFFakIsUUFBUyxDQUFDO0lBQ3BDO0VBQ0YsQ0FBQztFQUNEa0IsV0FBVyxFQUFFO0lBQ1g5QixLQUFLLEVBQUVOLFVBQVUsQ0FBRUMsUUFBUztFQUM5QixDQUFDO0VBQ0RvQyxPQUFPLEVBQUU7SUFDUEMsU0FBUyxFQUFFO01BQ1RDLFVBQVUsRUFBRXRDLFFBQVE7TUFDcEJ1QyxjQUFjLEVBQUUsQ0FBRTFDLFVBQVUsQ0FBRUksTUFBTSxFQUFFLENBQUVELFFBQVEsQ0FBRyxDQUFDLENBQUU7TUFDdER3QixhQUFhLEVBQUUsa0dBQWtHLEdBQ2xHLG9HQUFvRyxHQUNwRyxzQkFBc0I7TUFDckNnQixjQUFjLEVBQUUsU0FBQUEsQ0FBc0JDLFFBQVEsRUFBRztRQUUvQztRQUNBLE1BQU1DLFFBQVEsR0FBR0EsQ0FBQSxLQUFNO1VBQ3JCWixNQUFNLElBQUlBLE1BQU0sQ0FBRSxJQUFJLENBQUNELE9BQU8sQ0FBQ1gsTUFBTSxLQUFLLENBQUMsRUFBRSx3REFBeUQsQ0FBQztVQUN2RyxNQUFNYixLQUFLLEdBQUcsSUFBSSxDQUFDd0IsT0FBTyxDQUFFLENBQUMsQ0FBRSxDQUFDZCxZQUFZLENBQUUsSUFBSyxDQUFDO1VBQ3BEMEIsUUFBUSxDQUFFcEMsS0FBTSxDQUFDO1FBQ25CLENBQUM7UUFFRHlCLE1BQU0sSUFBSUEsTUFBTSxDQUFFLElBQUksQ0FBQ0QsT0FBTyxDQUFDWCxNQUFNLEtBQUssQ0FBQyxFQUFFLHdEQUF5RCxDQUFDO1FBQ3ZHLElBQUksQ0FBQ1csT0FBTyxDQUFFLENBQUMsQ0FBRSxDQUFDYyxzQkFBc0IsQ0FBQ0MsV0FBVyxDQUFFRixRQUFTLENBQUM7UUFDaEVBLFFBQVEsQ0FBQyxDQUFDO1FBRVYsTUFBTUcsT0FBTyxHQUFHeEMsS0FBSztRQUNyQkQsR0FBRyxDQUFFeUMsT0FBTyxDQUFFLEdBQUdILFFBQVE7UUFDekJyQyxLQUFLLEVBQUU7UUFDUCxPQUFPd0MsT0FBTztNQUNoQjtJQUNGLENBQUM7SUFDREMsY0FBYyxFQUFFO01BQ2RSLFVBQVUsRUFBRXJDLE1BQU07TUFDbEJzQyxjQUFjLEVBQUUsQ0FBRXZDLFFBQVEsQ0FBRTtNQUM1QndCLGFBQWEsRUFBRSwyR0FBMkc7TUFDMUhnQixjQUFjLEVBQUUsU0FBQUEsQ0FBc0JuQyxLQUFLLEVBQUc7UUFDNUMsTUFBTTBDLE1BQU0sR0FBRzNDLEdBQUcsQ0FBRUMsS0FBSyxDQUFFO1FBQzNCeUIsTUFBTSxJQUFJQSxNQUFNLENBQUUsSUFBSSxDQUFDRCxPQUFPLENBQUNYLE1BQU0sS0FBSyxDQUFDLEVBQUUsd0RBQXlELENBQUM7UUFDdkcsSUFBSSxDQUFDVyxPQUFPLENBQUUsQ0FBQyxDQUFFLENBQUNjLHNCQUFzQixDQUFDSyxjQUFjLENBQUVELE1BQU8sQ0FBQztRQUNqRSxPQUFPM0MsR0FBRyxDQUFFQyxLQUFLLENBQUU7TUFDckI7SUFDRixDQUFDO0lBQ0RDLFdBQVcsRUFBRTtNQUNYZ0MsVUFBVSxFQUFFckMsTUFBTTtNQUNsQnNDLGNBQWMsRUFBRSxFQUFFO01BQ2xCQyxjQUFjLEVBQUUsU0FBQUEsQ0FBQSxFQUF1QjtRQUNyQyxPQUFPbEMsV0FBVyxDQUFFLElBQUssQ0FBQztNQUM1QixDQUFDO01BQ0RrQixhQUFhLEVBQUU7SUFDakIsQ0FBQztJQUVEWixZQUFZLEVBQUU7TUFDWjBCLFVBQVUsRUFBRXJDLE1BQU07TUFDbEJzQyxjQUFjLEVBQUUsRUFBRTtNQUNsQkMsY0FBYyxFQUFFLFNBQUFBLENBQUEsRUFBdUI7UUFDckMsT0FBTzVCLFlBQVksQ0FBRSxJQUFLLENBQUM7TUFDN0IsQ0FBQztNQUNEWSxhQUFhLEVBQUU7SUFDakI7RUFDRjtBQUNGLENBQUUsQ0FBQztBQUVIckIsT0FBTyxDQUFDOEMsUUFBUSxDQUFFLGVBQWUsRUFBRTNCLGFBQWMsQ0FBQztBQUNsRCxlQUFlQSxhQUFhIn0=