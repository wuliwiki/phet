// Copyright 2021-2023, University of Colorado Boulder

/**
 * ProfileColorProperty is a ColorProperty that changes its value based on the value of colorProfileProperty.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */
import arrayRemove from '../../../phet-core/js/arrayRemove.js';
import Tandem from '../../../tandem/js/Tandem.js';
import { Color, colorProfileProperty, ColorProperty, scenery, SceneryConstants } from '../imports.js';
import optionize from '../../../phet-core/js/optionize.js';

// constant
const NAME_SEPARATOR = '.';

// static instances are tracked for iframe communication with the HTML color editor
const instances = [];
export default class ProfileColorProperty extends ColorProperty {
  // values are mutated by the HTML color wrapper.
  // (scenery-internal)

  // Treat as private

  // Typically use this suffix, but see TANDEM_NAME_SUFFIXES for other possibilities.
  static TANDEM_NAME_SUFFIX = 'ColorProperty';

  // See https://github.com/phetsims/scenery/issues/1512
  static TANDEM_NAME_SUFFIXES = [ProfileColorProperty.TANDEM_NAME_SUFFIX, 'FillProperty', 'StrokeProperty'];

  /**
   * @param namespace - namespace that this color belongs to
   * @param colorName - name of the color, unique within namespace
   * @param colorProfileMap - object literal that maps keys (profile names) to ColorDef (that should be immutable)
   * @param [providedOptions]
   */
  constructor(namespace, colorName, colorProfileMap, providedOptions) {
    const options = optionize()({
      tandem: Tandem.OPTIONAL,
      // So that notifications won't occur when we change from different objects representing the same color.
      // We should never be mutating the Color objects used for ProfileColorProperty.
      valueComparisonStrategy: 'equalsFunction'
    }, providedOptions);
    const tandem = options.tandem;

    // All values are eagerly coerced to Color instances for efficiency (so it only has to be done once) and simplicity
    // (so the types are uniform)
    colorProfileMap = _.mapValues(colorProfileMap, color => {
      // Force Color values to be immutable.
      return Color.toColor(color).setImmutable();
    });
    assert && assert(colorProfileMap.hasOwnProperty(SceneryConstants.DEFAULT_COLOR_PROFILE), 'default color profile must be provided');
    assert && assert(!!colorProfileMap[SceneryConstants.DEFAULT_COLOR_PROFILE], 'default color profile must be truthy');

    // Fallback to default if a color was not supplied.
    super(Color.toColor(colorProfileMap[colorProfileProperty.value] || colorProfileMap[SceneryConstants.DEFAULT_COLOR_PROFILE]), options);

    // See https://github.com/phetsims/scenery/issues/1512
    assert && assert(!this.isPhetioInstrumented() || _.find(ProfileColorProperty.TANDEM_NAME_SUFFIXES, suffix => tandem.name.endsWith(suffix)) || tandem.name === 'colorProperty' || tandem.name === 'fillProperty' || tandem.name === 'strokeProperty', `invalid tandem.name: ${tandem.phetioID}`);
    this.colorProfileMap = colorProfileMap;

    // When the color profile name changes, select the corresponding color.
    colorProfileProperty.link(colorProfileName => {
      // fallback to default if a color not supplied
      this.value = Color.toColor(this.colorProfileMap[colorProfileName] || this.colorProfileMap[SceneryConstants.DEFAULT_COLOR_PROFILE]);
    });
    this.name = `${namespace.name}${NAME_SEPARATOR}${colorName}`;

    // On initialization and when the color changes, send a message to the parent frame identifying the color value.
    // The HTML color editor wrapper listens for these messages and displays the color values.
    this.link(color => {
      if (window.parent !== window) {
        window.parent.postMessage(JSON.stringify({
          type: 'reportColor',
          name: this.name,
          value: color.toHexString(),
          alpha: color.getAlpha()
        }), '*');
      }
    });

    // assert that names are unique
    if (assert) {
      const matches = instances.filter(e => e.name === this.name);
      assert && assert(matches.length === 0, 'cannot use the same name for two different ProfileColorProperty instances: ' + name);
    }

    // Register with the static list for the HTML color editor
    instances.push(this);
  }
  dispose() {
    arrayRemove(instances, this);
    super.dispose();
  }
}

// Listen for messages from the HTML color editor wrapper with new color values.
window.addEventListener('message', event => {
  let data;
  try {
    data = JSON.parse(event.data);
  } catch (e) {
    // We don't do anything with the caught value. If this happens, it is not JSON. This can happen with the
    // LoL wrappers, see https://github.com/phetsims/joist/issues/484.
  }
  if (data && data.type === 'setColor') {
    for (let i = 0; i < instances.length; i++) {
      const instanceProperty = instances[i];
      if (instanceProperty.name === data.name) {
        instanceProperty.colorProfileMap[colorProfileProperty.value] = new Color(data.value).withAlpha(data.alpha);
        instanceProperty.value = Color.toColor(instanceProperty.colorProfileMap[colorProfileProperty.value]);
      }
    }
  }
});
scenery.register('ProfileColorProperty', ProfileColorProperty);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhcnJheVJlbW92ZSIsIlRhbmRlbSIsIkNvbG9yIiwiY29sb3JQcm9maWxlUHJvcGVydHkiLCJDb2xvclByb3BlcnR5Iiwic2NlbmVyeSIsIlNjZW5lcnlDb25zdGFudHMiLCJvcHRpb25pemUiLCJOQU1FX1NFUEFSQVRPUiIsImluc3RhbmNlcyIsIlByb2ZpbGVDb2xvclByb3BlcnR5IiwiVEFOREVNX05BTUVfU1VGRklYIiwiVEFOREVNX05BTUVfU1VGRklYRVMiLCJjb25zdHJ1Y3RvciIsIm5hbWVzcGFjZSIsImNvbG9yTmFtZSIsImNvbG9yUHJvZmlsZU1hcCIsInByb3ZpZGVkT3B0aW9ucyIsIm9wdGlvbnMiLCJ0YW5kZW0iLCJPUFRJT05BTCIsInZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5IiwiXyIsIm1hcFZhbHVlcyIsImNvbG9yIiwidG9Db2xvciIsInNldEltbXV0YWJsZSIsImFzc2VydCIsImhhc093blByb3BlcnR5IiwiREVGQVVMVF9DT0xPUl9QUk9GSUxFIiwidmFsdWUiLCJpc1BoZXRpb0luc3RydW1lbnRlZCIsImZpbmQiLCJzdWZmaXgiLCJuYW1lIiwiZW5kc1dpdGgiLCJwaGV0aW9JRCIsImxpbmsiLCJjb2xvclByb2ZpbGVOYW1lIiwid2luZG93IiwicGFyZW50IiwicG9zdE1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwidHlwZSIsInRvSGV4U3RyaW5nIiwiYWxwaGEiLCJnZXRBbHBoYSIsIm1hdGNoZXMiLCJmaWx0ZXIiLCJlIiwibGVuZ3RoIiwicHVzaCIsImRpc3Bvc2UiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJkYXRhIiwicGFyc2UiLCJpIiwiaW5zdGFuY2VQcm9wZXJ0eSIsIndpdGhBbHBoYSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUHJvZmlsZUNvbG9yUHJvcGVydHkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEtMjAyMywgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogUHJvZmlsZUNvbG9yUHJvcGVydHkgaXMgYSBDb2xvclByb3BlcnR5IHRoYXQgY2hhbmdlcyBpdHMgdmFsdWUgYmFzZWQgb24gdGhlIHZhbHVlIG9mIGNvbG9yUHJvZmlsZVByb3BlcnR5LlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuaW1wb3J0IGFycmF5UmVtb3ZlIGZyb20gJy4uLy4uLy4uL3BoZXQtY29yZS9qcy9hcnJheVJlbW92ZS5qcyc7XHJcbmltcG9ydCBOYW1lc3BhY2UgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL05hbWVzcGFjZS5qcyc7XHJcbmltcG9ydCBUYW5kZW0gZnJvbSAnLi4vLi4vLi4vdGFuZGVtL2pzL1RhbmRlbS5qcyc7XHJcbmltcG9ydCB7IFByb3BlcnR5T3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uL2F4b24vanMvUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgeyBDb2xvciwgY29sb3JQcm9maWxlUHJvcGVydHksIENvbG9yUHJvcGVydHksIHNjZW5lcnksIFNjZW5lcnlDb25zdGFudHMgfSBmcm9tICcuLi9pbXBvcnRzLmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSwgeyBFbXB0eVNlbGZPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL29wdGlvbml6ZS5qcyc7XHJcblxyXG4vLyBjb25zdGFudFxyXG5jb25zdCBOQU1FX1NFUEFSQVRPUiA9ICcuJztcclxuXHJcbi8vIHN0YXRpYyBpbnN0YW5jZXMgYXJlIHRyYWNrZWQgZm9yIGlmcmFtZSBjb21tdW5pY2F0aW9uIHdpdGggdGhlIEhUTUwgY29sb3IgZWRpdG9yXHJcbmNvbnN0IGluc3RhbmNlczogUHJvZmlsZUNvbG9yUHJvcGVydHlbXSA9IFtdO1xyXG5cclxudHlwZSBDb2xvclByb2ZpbGVNYXAgPSBSZWNvcmQ8c3RyaW5nLCBDb2xvciB8IHN0cmluZz47XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQcm9maWxlQ29sb3JQcm9wZXJ0eSBleHRlbmRzIENvbG9yUHJvcGVydHkge1xyXG5cclxuICAvLyB2YWx1ZXMgYXJlIG11dGF0ZWQgYnkgdGhlIEhUTUwgY29sb3Igd3JhcHBlci5cclxuICAvLyAoc2NlbmVyeS1pbnRlcm5hbClcclxuICBwdWJsaWMgcmVhZG9ubHkgY29sb3JQcm9maWxlTWFwOiBDb2xvclByb2ZpbGVNYXA7XHJcblxyXG4gIC8vIFRyZWF0IGFzIHByaXZhdGVcclxuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xyXG5cclxuICAvLyBUeXBpY2FsbHkgdXNlIHRoaXMgc3VmZml4LCBidXQgc2VlIFRBTkRFTV9OQU1FX1NVRkZJWEVTIGZvciBvdGhlciBwb3NzaWJpbGl0aWVzLlxyXG4gIHB1YmxpYyBzdGF0aWMgb3ZlcnJpZGUgcmVhZG9ubHkgVEFOREVNX05BTUVfU1VGRklYID0gJ0NvbG9yUHJvcGVydHknO1xyXG5cclxuICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3BoZXRzaW1zL3NjZW5lcnkvaXNzdWVzLzE1MTJcclxuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFRBTkRFTV9OQU1FX1NVRkZJWEVTID0gWyBQcm9maWxlQ29sb3JQcm9wZXJ0eS5UQU5ERU1fTkFNRV9TVUZGSVgsICdGaWxsUHJvcGVydHknLCAnU3Ryb2tlUHJvcGVydHknIF07XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBuYW1lc3BhY2UgLSBuYW1lc3BhY2UgdGhhdCB0aGlzIGNvbG9yIGJlbG9uZ3MgdG9cclxuICAgKiBAcGFyYW0gY29sb3JOYW1lIC0gbmFtZSBvZiB0aGUgY29sb3IsIHVuaXF1ZSB3aXRoaW4gbmFtZXNwYWNlXHJcbiAgICogQHBhcmFtIGNvbG9yUHJvZmlsZU1hcCAtIG9iamVjdCBsaXRlcmFsIHRoYXQgbWFwcyBrZXlzIChwcm9maWxlIG5hbWVzKSB0byBDb2xvckRlZiAodGhhdCBzaG91bGQgYmUgaW1tdXRhYmxlKVxyXG4gICAqIEBwYXJhbSBbcHJvdmlkZWRPcHRpb25zXVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggbmFtZXNwYWNlOiBOYW1lc3BhY2UsIGNvbG9yTmFtZTogc3RyaW5nLCBjb2xvclByb2ZpbGVNYXA6IENvbG9yUHJvZmlsZU1hcCwgcHJvdmlkZWRPcHRpb25zPzogUHJvcGVydHlPcHRpb25zPENvbG9yPiApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFByb3BlcnR5T3B0aW9uczxDb2xvcj4sIEVtcHR5U2VsZk9wdGlvbnMsIFByb3BlcnR5T3B0aW9uczxDb2xvcj4+KCkoIHtcclxuICAgICAgdGFuZGVtOiBUYW5kZW0uT1BUSU9OQUwsXHJcblxyXG4gICAgICAvLyBTbyB0aGF0IG5vdGlmaWNhdGlvbnMgd29uJ3Qgb2NjdXIgd2hlbiB3ZSBjaGFuZ2UgZnJvbSBkaWZmZXJlbnQgb2JqZWN0cyByZXByZXNlbnRpbmcgdGhlIHNhbWUgY29sb3IuXHJcbiAgICAgIC8vIFdlIHNob3VsZCBuZXZlciBiZSBtdXRhdGluZyB0aGUgQ29sb3Igb2JqZWN0cyB1c2VkIGZvciBQcm9maWxlQ29sb3JQcm9wZXJ0eS5cclxuICAgICAgdmFsdWVDb21wYXJpc29uU3RyYXRlZ3k6ICdlcXVhbHNGdW5jdGlvbidcclxuICAgIH0sIHByb3ZpZGVkT3B0aW9ucyApO1xyXG5cclxuICAgIGNvbnN0IHRhbmRlbSA9IG9wdGlvbnMudGFuZGVtO1xyXG5cclxuICAgIC8vIEFsbCB2YWx1ZXMgYXJlIGVhZ2VybHkgY29lcmNlZCB0byBDb2xvciBpbnN0YW5jZXMgZm9yIGVmZmljaWVuY3kgKHNvIGl0IG9ubHkgaGFzIHRvIGJlIGRvbmUgb25jZSkgYW5kIHNpbXBsaWNpdHlcclxuICAgIC8vIChzbyB0aGUgdHlwZXMgYXJlIHVuaWZvcm0pXHJcbiAgICBjb2xvclByb2ZpbGVNYXAgPSBfLm1hcFZhbHVlcyggY29sb3JQcm9maWxlTWFwLCBjb2xvciA9PiB7XHJcbiAgICAgIC8vIEZvcmNlIENvbG9yIHZhbHVlcyB0byBiZSBpbW11dGFibGUuXHJcbiAgICAgIHJldHVybiBDb2xvci50b0NvbG9yKCBjb2xvciApLnNldEltbXV0YWJsZSgpO1xyXG4gICAgfSApO1xyXG5cclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGNvbG9yUHJvZmlsZU1hcC5oYXNPd25Qcm9wZXJ0eSggU2NlbmVyeUNvbnN0YW50cy5ERUZBVUxUX0NPTE9SX1BST0ZJTEUgKSwgJ2RlZmF1bHQgY29sb3IgcHJvZmlsZSBtdXN0IGJlIHByb3ZpZGVkJyApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggISFjb2xvclByb2ZpbGVNYXBbIFNjZW5lcnlDb25zdGFudHMuREVGQVVMVF9DT0xPUl9QUk9GSUxFIF0sICdkZWZhdWx0IGNvbG9yIHByb2ZpbGUgbXVzdCBiZSB0cnV0aHknICk7XHJcblxyXG4gICAgLy8gRmFsbGJhY2sgdG8gZGVmYXVsdCBpZiBhIGNvbG9yIHdhcyBub3Qgc3VwcGxpZWQuXHJcbiAgICBzdXBlciggQ29sb3IudG9Db2xvciggY29sb3JQcm9maWxlTWFwWyBjb2xvclByb2ZpbGVQcm9wZXJ0eS52YWx1ZSBdIHx8IGNvbG9yUHJvZmlsZU1hcFsgU2NlbmVyeUNvbnN0YW50cy5ERUZBVUxUX0NPTE9SX1BST0ZJTEUgXSApLCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9zY2VuZXJ5L2lzc3Vlcy8xNTEyXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCAhdGhpcy5pc1BoZXRpb0luc3RydW1lbnRlZCgpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICBfLmZpbmQoIFByb2ZpbGVDb2xvclByb3BlcnR5LlRBTkRFTV9OQU1FX1NVRkZJWEVTLCBzdWZmaXggPT4gdGFuZGVtLm5hbWUuZW5kc1dpdGgoIHN1ZmZpeCApICkgfHxcclxuICAgICAgICAgICAgICAgICAgICAgIHRhbmRlbS5uYW1lID09PSAnY29sb3JQcm9wZXJ0eScgfHwgdGFuZGVtLm5hbWUgPT09ICdmaWxsUHJvcGVydHknIHx8IHRhbmRlbS5uYW1lID09PSAnc3Ryb2tlUHJvcGVydHknLFxyXG4gICAgICBgaW52YWxpZCB0YW5kZW0ubmFtZTogJHt0YW5kZW0ucGhldGlvSUR9YCApO1xyXG5cclxuICAgIHRoaXMuY29sb3JQcm9maWxlTWFwID0gY29sb3JQcm9maWxlTWFwO1xyXG5cclxuICAgIC8vIFdoZW4gdGhlIGNvbG9yIHByb2ZpbGUgbmFtZSBjaGFuZ2VzLCBzZWxlY3QgdGhlIGNvcnJlc3BvbmRpbmcgY29sb3IuXHJcbiAgICBjb2xvclByb2ZpbGVQcm9wZXJ0eS5saW5rKCBjb2xvclByb2ZpbGVOYW1lID0+IHtcclxuXHJcbiAgICAgIC8vIGZhbGxiYWNrIHRvIGRlZmF1bHQgaWYgYSBjb2xvciBub3Qgc3VwcGxpZWRcclxuICAgICAgdGhpcy52YWx1ZSA9IENvbG9yLnRvQ29sb3IoIHRoaXMuY29sb3JQcm9maWxlTWFwWyBjb2xvclByb2ZpbGVOYW1lIF0gfHwgdGhpcy5jb2xvclByb2ZpbGVNYXBbIFNjZW5lcnlDb25zdGFudHMuREVGQVVMVF9DT0xPUl9QUk9GSUxFIF0gKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICB0aGlzLm5hbWUgPSBgJHtuYW1lc3BhY2UubmFtZX0ke05BTUVfU0VQQVJBVE9SfSR7Y29sb3JOYW1lfWA7XHJcblxyXG4gICAgLy8gT24gaW5pdGlhbGl6YXRpb24gYW5kIHdoZW4gdGhlIGNvbG9yIGNoYW5nZXMsIHNlbmQgYSBtZXNzYWdlIHRvIHRoZSBwYXJlbnQgZnJhbWUgaWRlbnRpZnlpbmcgdGhlIGNvbG9yIHZhbHVlLlxyXG4gICAgLy8gVGhlIEhUTUwgY29sb3IgZWRpdG9yIHdyYXBwZXIgbGlzdGVucyBmb3IgdGhlc2UgbWVzc2FnZXMgYW5kIGRpc3BsYXlzIHRoZSBjb2xvciB2YWx1ZXMuXHJcbiAgICB0aGlzLmxpbmsoIGNvbG9yID0+IHtcclxuICAgICAgaWYgKCB3aW5kb3cucGFyZW50ICE9PSB3aW5kb3cgKSB7XHJcbiAgICAgICAgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSggSlNPTi5zdHJpbmdpZnkoIHtcclxuICAgICAgICAgIHR5cGU6ICdyZXBvcnRDb2xvcicsXHJcbiAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXHJcbiAgICAgICAgICB2YWx1ZTogY29sb3IudG9IZXhTdHJpbmcoKSxcclxuICAgICAgICAgIGFscGhhOiBjb2xvci5nZXRBbHBoYSgpXHJcbiAgICAgICAgfSApLCAnKicgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIGFzc2VydCB0aGF0IG5hbWVzIGFyZSB1bmlxdWVcclxuICAgIGlmICggYXNzZXJ0ICkge1xyXG4gICAgICBjb25zdCBtYXRjaGVzID0gaW5zdGFuY2VzLmZpbHRlciggZSA9PiBlLm5hbWUgPT09IHRoaXMubmFtZSApO1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBtYXRjaGVzLmxlbmd0aCA9PT0gMCwgJ2Nhbm5vdCB1c2UgdGhlIHNhbWUgbmFtZSBmb3IgdHdvIGRpZmZlcmVudCBQcm9maWxlQ29sb3JQcm9wZXJ0eSBpbnN0YW5jZXM6ICcgKyBuYW1lICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVnaXN0ZXIgd2l0aCB0aGUgc3RhdGljIGxpc3QgZm9yIHRoZSBIVE1MIGNvbG9yIGVkaXRvclxyXG4gICAgaW5zdGFuY2VzLnB1c2goIHRoaXMgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgYXJyYXlSZW1vdmUoIGluc3RhbmNlcywgdGhpcyApO1xyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuLy8gTGlzdGVuIGZvciBtZXNzYWdlcyBmcm9tIHRoZSBIVE1MIGNvbG9yIGVkaXRvciB3cmFwcGVyIHdpdGggbmV3IGNvbG9yIHZhbHVlcy5cclxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdtZXNzYWdlJywgZXZlbnQgPT4ge1xyXG4gIGxldCBkYXRhO1xyXG4gIHRyeSB7XHJcbiAgICBkYXRhID0gSlNPTi5wYXJzZSggZXZlbnQuZGF0YSApO1xyXG4gIH1cclxuICBjYXRjaCggZSApIHtcclxuICAgIC8vIFdlIGRvbid0IGRvIGFueXRoaW5nIHdpdGggdGhlIGNhdWdodCB2YWx1ZS4gSWYgdGhpcyBoYXBwZW5zLCBpdCBpcyBub3QgSlNPTi4gVGhpcyBjYW4gaGFwcGVuIHdpdGggdGhlXHJcbiAgICAvLyBMb0wgd3JhcHBlcnMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcGhldHNpbXMvam9pc3QvaXNzdWVzLzQ4NC5cclxuICB9XHJcblxyXG4gIGlmICggZGF0YSAmJiBkYXRhLnR5cGUgPT09ICdzZXRDb2xvcicgKSB7XHJcbiAgICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBpbnN0YW5jZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGNvbnN0IGluc3RhbmNlUHJvcGVydHkgPSBpbnN0YW5jZXNbIGkgXTtcclxuICAgICAgaWYgKCBpbnN0YW5jZVByb3BlcnR5Lm5hbWUgPT09IGRhdGEubmFtZSApIHtcclxuICAgICAgICBpbnN0YW5jZVByb3BlcnR5LmNvbG9yUHJvZmlsZU1hcFsgY29sb3JQcm9maWxlUHJvcGVydHkudmFsdWUgXSA9IG5ldyBDb2xvciggZGF0YS52YWx1ZSApLndpdGhBbHBoYSggZGF0YS5hbHBoYSApO1xyXG4gICAgICAgIGluc3RhbmNlUHJvcGVydHkudmFsdWUgPSBDb2xvci50b0NvbG9yKCBpbnN0YW5jZVByb3BlcnR5LmNvbG9yUHJvZmlsZU1hcFsgY29sb3JQcm9maWxlUHJvcGVydHkudmFsdWUgXSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59ICk7XHJcblxyXG5zY2VuZXJ5LnJlZ2lzdGVyKCAnUHJvZmlsZUNvbG9yUHJvcGVydHknLCBQcm9maWxlQ29sb3JQcm9wZXJ0eSApO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPQSxXQUFXLE1BQU0sc0NBQXNDO0FBRTlE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