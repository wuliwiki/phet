// Copyright 2022, University of Colorado Boulder

/**
 * A Property that will synchronously contain all Trails between two nodes (in a root-leaf direction).
 * Listens from the child to the parent (since we tend to branch much less that way).
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import TinyProperty from '../../../axon/js/TinyProperty.js';
import { scenery, Trail } from '../imports.js';
export default class TrailsBetweenProperty extends TinyProperty {
  listenedNodeSet = new Set();
  constructor(rootNode, leafNode) {
    super([]);
    this.rootNode = rootNode;
    this.leafNode = leafNode;
    this._trailUpdateListener = this.update.bind(this);
    this.update();
  }
  update() {
    // Trails accumulated in our recursion that will be our Property's value
    const trails = [];

    // Nodes that were touched in the scan (we should listen to changes to ANY of these to see if there is a connection
    // or disconnection. This could potentially cause our Property to change
    const nodeSet = new Set();

    // Modified in-place during the search
    const trail = new Trail(this.leafNode);
    const rootNode = this.rootNode;
    (function recurse() {
      const root = trail.rootNode();
      nodeSet.add(root);
      if (root === rootNode) {
        // Create a permanent copy that won't be mutated
        trails.push(trail.copy());
      }
      root.parents.forEach(parent => {
        trail.addAncestor(parent);
        recurse();
        trail.removeAncestor();
      });
    })();

    // Add in new needed listeners
    nodeSet.forEach(node => {
      if (!this.listenedNodeSet.has(node)) {
        this.addNodeListener(node);
      }
    });

    // Remove listeners not needed anymore
    this.listenedNodeSet.forEach(node => {
      if (!nodeSet.has(node)) {
        this.removeNodeListener(node);
      }
    });

    // Guard in a way that deepEquality on the Property wouldn't (because of the Array wrapper)
    const currentTrails = this.value;
    let trailsEqual = currentTrails.length === trails.length;
    if (trailsEqual) {
      for (let i = 0; i < trails.length; i++) {
        if (!currentTrails[i].equals(trails[i])) {
          trailsEqual = false;
          break;
        }
      }
    }
    if (!trailsEqual) {
      this.value = trails;
    }
  }
  addNodeListener(node) {
    this.listenedNodeSet.add(node);
    node.parentAddedEmitter.addListener(this._trailUpdateListener);
    node.parentRemovedEmitter.addListener(this._trailUpdateListener);
  }
  removeNodeListener(node) {
    this.listenedNodeSet.delete(node);
    node.parentAddedEmitter.removeListener(this._trailUpdateListener);
    node.parentRemovedEmitter.removeListener(this._trailUpdateListener);
  }
  dispose() {
    this.listenedNodeSet.forEach(node => this.removeNodeListener(node));
    super.dispose();
  }
}
scenery.register('TrailsBetweenProperty', TrailsBetweenProperty);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUaW55UHJvcGVydHkiLCJzY2VuZXJ5IiwiVHJhaWwiLCJUcmFpbHNCZXR3ZWVuUHJvcGVydHkiLCJsaXN0ZW5lZE5vZGVTZXQiLCJTZXQiLCJjb25zdHJ1Y3RvciIsInJvb3ROb2RlIiwibGVhZk5vZGUiLCJfdHJhaWxVcGRhdGVMaXN0ZW5lciIsInVwZGF0ZSIsImJpbmQiLCJ0cmFpbHMiLCJub2RlU2V0IiwidHJhaWwiLCJyZWN1cnNlIiwicm9vdCIsImFkZCIsInB1c2giLCJjb3B5IiwicGFyZW50cyIsImZvckVhY2giLCJwYXJlbnQiLCJhZGRBbmNlc3RvciIsInJlbW92ZUFuY2VzdG9yIiwibm9kZSIsImhhcyIsImFkZE5vZGVMaXN0ZW5lciIsInJlbW92ZU5vZGVMaXN0ZW5lciIsImN1cnJlbnRUcmFpbHMiLCJ2YWx1ZSIsInRyYWlsc0VxdWFsIiwibGVuZ3RoIiwiaSIsImVxdWFscyIsInBhcmVudEFkZGVkRW1pdHRlciIsImFkZExpc3RlbmVyIiwicGFyZW50UmVtb3ZlZEVtaXR0ZXIiLCJkZWxldGUiLCJyZW1vdmVMaXN0ZW5lciIsImRpc3Bvc2UiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlRyYWlsc0JldHdlZW5Qcm9wZXJ0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSBQcm9wZXJ0eSB0aGF0IHdpbGwgc3luY2hyb25vdXNseSBjb250YWluIGFsbCBUcmFpbHMgYmV0d2VlbiB0d28gbm9kZXMgKGluIGEgcm9vdC1sZWFmIGRpcmVjdGlvbikuXHJcbiAqIExpc3RlbnMgZnJvbSB0aGUgY2hpbGQgdG8gdGhlIHBhcmVudCAoc2luY2Ugd2UgdGVuZCB0byBicmFuY2ggbXVjaCBsZXNzIHRoYXQgd2F5KS5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBUaW55UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UaW55UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgeyBOb2RlLCBzY2VuZXJ5LCBUcmFpbCB9IGZyb20gJy4uL2ltcG9ydHMuanMnO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVHJhaWxzQmV0d2VlblByb3BlcnR5IGV4dGVuZHMgVGlueVByb3BlcnR5PFRyYWlsW10+IHtcclxuXHJcbiAgcHVibGljIHJlYWRvbmx5IHJvb3ROb2RlOiBOb2RlO1xyXG4gIHB1YmxpYyByZWFkb25seSBsZWFmTm9kZTogTm9kZTtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGlzdGVuZWROb2RlU2V0OiBTZXQ8Tm9kZT4gPSBuZXcgU2V0PE5vZGU+KCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfdHJhaWxVcGRhdGVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCByb290Tm9kZTogTm9kZSwgbGVhZk5vZGU6IE5vZGUgKSB7XHJcbiAgICBzdXBlciggW10gKTtcclxuXHJcbiAgICB0aGlzLnJvb3ROb2RlID0gcm9vdE5vZGU7XHJcbiAgICB0aGlzLmxlYWZOb2RlID0gbGVhZk5vZGU7XHJcblxyXG4gICAgdGhpcy5fdHJhaWxVcGRhdGVMaXN0ZW5lciA9IHRoaXMudXBkYXRlLmJpbmQoIHRoaXMgKTtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGUoKTogdm9pZCB7XHJcbiAgICAvLyBUcmFpbHMgYWNjdW11bGF0ZWQgaW4gb3VyIHJlY3Vyc2lvbiB0aGF0IHdpbGwgYmUgb3VyIFByb3BlcnR5J3MgdmFsdWVcclxuICAgIGNvbnN0IHRyYWlsczogVHJhaWxbXSA9IFtdO1xyXG5cclxuICAgIC8vIE5vZGVzIHRoYXQgd2VyZSB0b3VjaGVkIGluIHRoZSBzY2FuICh3ZSBzaG91bGQgbGlzdGVuIHRvIGNoYW5nZXMgdG8gQU5ZIG9mIHRoZXNlIHRvIHNlZSBpZiB0aGVyZSBpcyBhIGNvbm5lY3Rpb25cclxuICAgIC8vIG9yIGRpc2Nvbm5lY3Rpb24uIFRoaXMgY291bGQgcG90ZW50aWFsbHkgY2F1c2Ugb3VyIFByb3BlcnR5IHRvIGNoYW5nZVxyXG4gICAgY29uc3Qgbm9kZVNldCA9IG5ldyBTZXQ8Tm9kZT4oKTtcclxuXHJcbiAgICAvLyBNb2RpZmllZCBpbi1wbGFjZSBkdXJpbmcgdGhlIHNlYXJjaFxyXG4gICAgY29uc3QgdHJhaWwgPSBuZXcgVHJhaWwoIHRoaXMubGVhZk5vZGUgKTtcclxuXHJcbiAgICBjb25zdCByb290Tm9kZSA9IHRoaXMucm9vdE5vZGU7XHJcbiAgICAoIGZ1bmN0aW9uIHJlY3Vyc2UoKSB7XHJcbiAgICAgIGNvbnN0IHJvb3QgPSB0cmFpbC5yb290Tm9kZSgpO1xyXG5cclxuICAgICAgbm9kZVNldC5hZGQoIHJvb3QgKTtcclxuXHJcbiAgICAgIGlmICggcm9vdCA9PT0gcm9vdE5vZGUgKSB7XHJcbiAgICAgICAgLy8gQ3JlYXRlIGEgcGVybWFuZW50IGNvcHkgdGhhdCB3b24ndCBiZSBtdXRhdGVkXHJcbiAgICAgICAgdHJhaWxzLnB1c2goIHRyYWlsLmNvcHkoKSApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByb290LnBhcmVudHMuZm9yRWFjaCggcGFyZW50ID0+IHtcclxuICAgICAgICB0cmFpbC5hZGRBbmNlc3RvciggcGFyZW50ICk7XHJcbiAgICAgICAgcmVjdXJzZSgpO1xyXG4gICAgICAgIHRyYWlsLnJlbW92ZUFuY2VzdG9yKCk7XHJcbiAgICAgIH0gKTtcclxuICAgIH0gKSgpO1xyXG5cclxuICAgIC8vIEFkZCBpbiBuZXcgbmVlZGVkIGxpc3RlbmVyc1xyXG4gICAgbm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHtcclxuICAgICAgaWYgKCAhdGhpcy5saXN0ZW5lZE5vZGVTZXQuaGFzKCBub2RlICkgKSB7XHJcbiAgICAgICAgdGhpcy5hZGROb2RlTGlzdGVuZXIoIG5vZGUgKTtcclxuICAgICAgfVxyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIFJlbW92ZSBsaXN0ZW5lcnMgbm90IG5lZWRlZCBhbnltb3JlXHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5mb3JFYWNoKCBub2RlID0+IHtcclxuICAgICAgaWYgKCAhbm9kZVNldC5oYXMoIG5vZGUgKSApIHtcclxuICAgICAgICB0aGlzLnJlbW92ZU5vZGVMaXN0ZW5lciggbm9kZSApO1xyXG4gICAgICB9XHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gR3VhcmQgaW4gYSB3YXkgdGhhdCBkZWVwRXF1YWxpdHkgb24gdGhlIFByb3BlcnR5IHdvdWxkbid0IChiZWNhdXNlIG9mIHRoZSBBcnJheSB3cmFwcGVyKVxyXG4gICAgY29uc3QgY3VycmVudFRyYWlscyA9IHRoaXMudmFsdWU7XHJcbiAgICBsZXQgdHJhaWxzRXF1YWwgPSBjdXJyZW50VHJhaWxzLmxlbmd0aCA9PT0gdHJhaWxzLmxlbmd0aDtcclxuICAgIGlmICggdHJhaWxzRXF1YWwgKSB7XHJcbiAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHRyYWlscy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICBpZiAoICFjdXJyZW50VHJhaWxzWyBpIF0uZXF1YWxzKCB0cmFpbHNbIGkgXSApICkge1xyXG4gICAgICAgICAgdHJhaWxzRXF1YWwgPSBmYWxzZTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICggIXRyYWlsc0VxdWFsICkge1xyXG4gICAgICB0aGlzLnZhbHVlID0gdHJhaWxzO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhZGROb2RlTGlzdGVuZXIoIG5vZGU6IE5vZGUgKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVkTm9kZVNldC5hZGQoIG5vZGUgKTtcclxuICAgIG5vZGUucGFyZW50QWRkZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLl90cmFpbFVwZGF0ZUxpc3RlbmVyICk7XHJcbiAgICBub2RlLnBhcmVudFJlbW92ZWRFbWl0dGVyLmFkZExpc3RlbmVyKCB0aGlzLl90cmFpbFVwZGF0ZUxpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZU5vZGVMaXN0ZW5lciggbm9kZTogTm9kZSApOiB2b2lkIHtcclxuICAgIHRoaXMubGlzdGVuZWROb2RlU2V0LmRlbGV0ZSggbm9kZSApO1xyXG4gICAgbm9kZS5wYXJlbnRBZGRlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICAgIG5vZGUucGFyZW50UmVtb3ZlZEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX3RyYWlsVXBkYXRlTGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5saXN0ZW5lZE5vZGVTZXQuZm9yRWFjaCggbm9kZSA9PiB0aGlzLnJlbW92ZU5vZGVMaXN0ZW5lciggbm9kZSApICk7XHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ1RyYWlsc0JldHdlZW5Qcm9wZXJ0eScsIFRyYWlsc0JldHdlZW5Qcm9wZXJ0eSApO1xyXG4iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxZQUFZLE1BQU0sa0NBQWtDO0FBQzNELFNBQWVDLE9BQU8sRUFBRUMsS0FBSyxRQUFRLGVBQWU7QUFFcEQsZUFBZSxNQUFNQyxxQkFBcUIsU0FBU0gsWUFBWSxDQUFVO0VBSXZESSxlQUFlLEdBQWMsSUFBSUMsR0FBRyxDQUFPLENBQUM7RUFHckRDLFdBQVdBLENBQUVDLFFBQWMsRUFBRUMsUUFBYyxFQUFHO0lBQ25ELEtBQUssQ0FBRSxFQUFHLENBQUM7SUFFWCxJQUFJLENBQUNELFFBQVEsR0FBR0EsUUFBUTtJQUN4QixJ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