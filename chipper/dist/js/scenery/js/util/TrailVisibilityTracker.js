// Copyright 2021, University of Colorado Boulder

/**
 * Broadcasts when any Node or its ancestors in a Trail change visibility, effectively
 * observing changes to Trail.isVisible().
 *
 * @author Jesse Greenberg
 */

import TinyProperty from '../../../axon/js/TinyProperty.js';
import merge from '../../../phet-core/js/merge.js';
import { scenery } from '../imports.js';
class TrailVisibilityTracker {
  /**
   * @param {Trail} trail - the Trail to track visibility
   * @param {Object } [options]
   */
  constructor(trail, options) {
    options = merge({
      // {boolan} - whether listeners are called against a defensive copy
      isStatic: false
    }, options);

    // @private {boolean}
    this.isStatic = options.isStatic;

    // @private {Trail}
    this.trail = trail;

    // @private {function[]}
    this._listeners = [];

    // @public {TinyProperty.<boolean>} - True if all Nodes in the Trail are visible.
    this.trailVisibleProperty = new TinyProperty(this.trail.isVisible());

    // Hook up listeners to each Node in the trail, so we are notified of changes. Will be removed on disposal.
    this._nodeVisibilityListeners = [];
    for (let j = 0; j < this.trail.length; j++) {
      const nodeVisibilityListener = () => {
        this.trailVisibleProperty.set(trail.isVisible());
      };
      this._nodeVisibilityListeners.push(nodeVisibilityListener);
      trail.nodes[j].visibleProperty.link(nodeVisibilityListener);
    }
    this.boundTrailVisibilityChangedListener = this.onVisibilityChange.bind(this);
    this.trailVisibleProperty.link(this.boundTrailVisibilityChangedListener);
  }

  /**
   * Adds a listener function that will be synchronously called whenever the visibility this Trail changes.
   * @public
   *
   * @param {Function} listener - Listener will be called with no arguments.
   */
  addListener(listener) {
    assert && assert(typeof listener === 'function');
    this._listeners.push(listener);
  }

  /**
   * Removes a listener that was previously added with addListener().
   * @public
   *
   * @param {Function} listener
   */
  removeListener(listener) {
    assert && assert(typeof listener === 'function');
    const index = _.indexOf(this._listeners, listener);
    assert && assert(index >= 0, 'TrailVisibilityTracker listener not found');
    this._listeners.splice(index, 1);
  }

  /**
   * @public
   */
  dispose() {
    for (let j = 0; j < this.trail.length; j++) {
      const visibilityListener = this._nodeVisibilityListeners[j];
      if (this.trail.nodes[j].visibleProperty.hasListener(visibilityListener)) {
        this.trail.nodes[j].visibleProperty.removeListener(visibilityListener);
      }
    }
    this.trailVisibleProperty.unlink(this.boundTrailVisibilityChangedListener);
  }

  /**
   * When visibility of the Trail is changed, notify listeners.
   * @private
   */
  onVisibilityChange() {
    this.notifyListeners();
  }

  /**
   * Notify listeners to a change in visibility.
   * @private
   */
  notifyListeners() {
    let listeners = this._listeners;
    if (!this._isStatic) {
      listeners = listeners.slice();
    }
    const length = listeners.length;
    for (let i = 0; i < length; i++) {
      listeners[i]();
    }
  }
}
scenery.register('TrailVisibilityTracker', TrailVisibilityTracker);
export default TrailVisibilityTracker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJUaW55UHJvcGVydHkiLCJtZXJnZSIsInNjZW5lcnkiLCJUcmFpbFZpc2liaWxpdHlUcmFja2VyIiwiY29uc3RydWN0b3IiLCJ0cmFpbCIsIm9wdGlvbnMiLCJpc1N0YXRpYyIsIl9saXN0ZW5lcnMiLCJ0cmFpbFZpc2libGVQcm9wZXJ0eSIsImlzVmlzaWJsZSIsIl9ub2RlVmlzaWJpbGl0eUxpc3RlbmVycyIsImoiLCJsZW5ndGgiLCJub2RlVmlzaWJpbGl0eUxpc3RlbmVyIiwic2V0IiwicHVzaCIsIm5vZGVzIiwidmlzaWJsZVByb3BlcnR5IiwibGluayIsImJvdW5kVHJhaWxWaXNpYmlsaXR5Q2hhbmdlZExpc3RlbmVyIiwib25WaXNpYmlsaXR5Q2hhbmdlIiwiYmluZCIsImFkZExpc3RlbmVyIiwibGlzdGVuZXIiLCJhc3NlcnQiLCJyZW1vdmVMaXN0ZW5lciIsImluZGV4IiwiXyIsImluZGV4T2YiLCJzcGxpY2UiLCJkaXNwb3NlIiwidmlzaWJpbGl0eUxpc3RlbmVyIiwiaGFzTGlzdGVuZXIiLCJ1bmxpbmsiLCJub3RpZnlMaXN0ZW5lcnMiLCJsaXN0ZW5lcnMiLCJfaXNTdGF0aWMiLCJzbGljZSIsImkiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIlRyYWlsVmlzaWJpbGl0eVRyYWNrZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIEJyb2FkY2FzdHMgd2hlbiBhbnkgTm9kZSBvciBpdHMgYW5jZXN0b3JzIGluIGEgVHJhaWwgY2hhbmdlIHZpc2liaWxpdHksIGVmZmVjdGl2ZWx5XHJcbiAqIG9ic2VydmluZyBjaGFuZ2VzIHRvIFRyYWlsLmlzVmlzaWJsZSgpLlxyXG4gKlxyXG4gKiBAYXV0aG9yIEplc3NlIEdyZWVuYmVyZ1xyXG4gKi9cclxuXHJcbmltcG9ydCBUaW55UHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vYXhvbi9qcy9UaW55UHJvcGVydHkuanMnO1xyXG5pbXBvcnQgbWVyZ2UgZnJvbSAnLi4vLi4vLi4vcGhldC1jb3JlL2pzL21lcmdlLmpzJztcclxuaW1wb3J0IHsgc2NlbmVyeSB9IGZyb20gJy4uL2ltcG9ydHMuanMnO1xyXG5cclxuY2xhc3MgVHJhaWxWaXNpYmlsaXR5VHJhY2tlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSB7VHJhaWx9IHRyYWlsIC0gdGhlIFRyYWlsIHRvIHRyYWNrIHZpc2liaWxpdHlcclxuICAgKiBAcGFyYW0ge09iamVjdCB9IFtvcHRpb25zXVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCB0cmFpbCwgb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuXHJcbiAgICAgIC8vIHtib29sYW59IC0gd2hldGhlciBsaXN0ZW5lcnMgYXJlIGNhbGxlZCBhZ2FpbnN0IGEgZGVmZW5zaXZlIGNvcHlcclxuICAgICAgaXNTdGF0aWM6IGZhbHNlXHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge2Jvb2xlYW59XHJcbiAgICB0aGlzLmlzU3RhdGljID0gb3B0aW9ucy5pc1N0YXRpYztcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7VHJhaWx9XHJcbiAgICB0aGlzLnRyYWlsID0gdHJhaWw7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge2Z1bmN0aW9uW119XHJcbiAgICB0aGlzLl9saXN0ZW5lcnMgPSBbXTtcclxuXHJcbiAgICAvLyBAcHVibGljIHtUaW55UHJvcGVydHkuPGJvb2xlYW4+fSAtIFRydWUgaWYgYWxsIE5vZGVzIGluIHRoZSBUcmFpbCBhcmUgdmlzaWJsZS5cclxuICAgIHRoaXMudHJhaWxWaXNpYmxlUHJvcGVydHkgPSBuZXcgVGlueVByb3BlcnR5KCB0aGlzLnRyYWlsLmlzVmlzaWJsZSgpICk7XHJcblxyXG4gICAgLy8gSG9vayB1cCBsaXN0ZW5lcnMgdG8gZWFjaCBOb2RlIGluIHRoZSB0cmFpbCwgc28gd2UgYXJlIG5vdGlmaWVkIG9mIGNoYW5nZXMuIFdpbGwgYmUgcmVtb3ZlZCBvbiBkaXNwb3NhbC5cclxuICAgIHRoaXMuX25vZGVWaXNpYmlsaXR5TGlzdGVuZXJzID0gW107XHJcbiAgICBmb3IgKCBsZXQgaiA9IDA7IGogPCB0aGlzLnRyYWlsLmxlbmd0aDsgaisrICkge1xyXG4gICAgICBjb25zdCBub2RlVmlzaWJpbGl0eUxpc3RlbmVyID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMudHJhaWxWaXNpYmxlUHJvcGVydHkuc2V0KCB0cmFpbC5pc1Zpc2libGUoKSApO1xyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLl9ub2RlVmlzaWJpbGl0eUxpc3RlbmVycy5wdXNoKCBub2RlVmlzaWJpbGl0eUxpc3RlbmVyICk7XHJcbiAgICAgIHRyYWlsLm5vZGVzWyBqIF0udmlzaWJsZVByb3BlcnR5LmxpbmsoIG5vZGVWaXNpYmlsaXR5TGlzdGVuZXIgKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmJvdW5kVHJhaWxWaXNpYmlsaXR5Q2hhbmdlZExpc3RlbmVyID0gdGhpcy5vblZpc2liaWxpdHlDaGFuZ2UuYmluZCggdGhpcyApO1xyXG4gICAgdGhpcy50cmFpbFZpc2libGVQcm9wZXJ0eS5saW5rKCB0aGlzLmJvdW5kVHJhaWxWaXNpYmlsaXR5Q2hhbmdlZExpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIGEgbGlzdGVuZXIgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHN5bmNocm9ub3VzbHkgY2FsbGVkIHdoZW5ldmVyIHRoZSB2aXNpYmlsaXR5IHRoaXMgVHJhaWwgY2hhbmdlcy5cclxuICAgKiBAcHVibGljXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIExpc3RlbmVyIHdpbGwgYmUgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzLlxyXG4gICAqL1xyXG4gIGFkZExpc3RlbmVyKCBsaXN0ZW5lciApIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIHR5cGVvZiBsaXN0ZW5lciA9PT0gJ2Z1bmN0aW9uJyApO1xyXG4gICAgdGhpcy5fbGlzdGVuZXJzLnB1c2goIGxpc3RlbmVyICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmVzIGEgbGlzdGVuZXIgdGhhdCB3YXMgcHJldmlvdXNseSBhZGRlZCB3aXRoIGFkZExpc3RlbmVyKCkuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXJcclxuICAgKi9cclxuICByZW1vdmVMaXN0ZW5lciggbGlzdGVuZXIgKSB7XHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCB0eXBlb2YgbGlzdGVuZXIgPT09ICdmdW5jdGlvbicgKTtcclxuXHJcbiAgICBjb25zdCBpbmRleCA9IF8uaW5kZXhPZiggdGhpcy5fbGlzdGVuZXJzLCBsaXN0ZW5lciApO1xyXG4gICAgYXNzZXJ0ICYmIGFzc2VydCggaW5kZXggPj0gMCwgJ1RyYWlsVmlzaWJpbGl0eVRyYWNrZXIgbGlzdGVuZXIgbm90IGZvdW5kJyApO1xyXG5cclxuICAgIHRoaXMuX2xpc3RlbmVycy5zcGxpY2UoIGluZGV4LCAxICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIGZvciAoIGxldCBqID0gMDsgaiA8IHRoaXMudHJhaWwubGVuZ3RoOyBqKysgKSB7XHJcbiAgICAgIGNvbnN0IHZpc2liaWxpdHlMaXN0ZW5lciA9IHRoaXMuX25vZGVWaXNpYmlsaXR5TGlzdGVuZXJzWyBqIF07XHJcblxyXG4gICAgICBpZiAoIHRoaXMudHJhaWwubm9kZXNbIGogXS52aXNpYmxlUHJvcGVydHkuaGFzTGlzdGVuZXIoIHZpc2liaWxpdHlMaXN0ZW5lciApICkge1xyXG4gICAgICAgIHRoaXMudHJhaWwubm9kZXNbIGogXS52aXNpYmxlUHJvcGVydHkucmVtb3ZlTGlzdGVuZXIoIHZpc2liaWxpdHlMaXN0ZW5lciApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy50cmFpbFZpc2libGVQcm9wZXJ0eS51bmxpbmsoIHRoaXMuYm91bmRUcmFpbFZpc2liaWxpdHlDaGFuZ2VkTGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFdoZW4gdmlzaWJpbGl0eSBvZiB0aGUgVHJhaWwgaXMgY2hhbmdlZCwgbm90aWZ5IGxpc3RlbmVycy5cclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIG9uVmlzaWJpbGl0eUNoYW5nZSgpIHtcclxuICAgIHRoaXMubm90aWZ5TGlzdGVuZXJzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBOb3RpZnkgbGlzdGVuZXJzIHRvIGEgY2hhbmdlIGluIHZpc2liaWxpdHkuXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBub3RpZnlMaXN0ZW5lcnMoKSB7XHJcbiAgICBsZXQgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzO1xyXG5cclxuICAgIGlmICggIXRoaXMuX2lzU3RhdGljICkge1xyXG4gICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuc2xpY2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoO1xyXG4gICAgZm9yICggbGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKysgKSB7XHJcbiAgICAgIGxpc3RlbmVyc1sgaSBdKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5zY2VuZXJ5LnJlZ2lzdGVyKCAnVHJhaWxWaXNpYmlsaXR5VHJhY2tlcicsIFRyYWlsVmlzaWJpbGl0eVRyYWNrZXIgKTtcclxuZXhwb3J0IGRlZmF1bHQgVHJhaWxWaXNpYmlsaXR5VHJhY2tlcjsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxZQUFZLE1BQU0sa0NBQWtDO0FBQzNELE9BQU9DLEtBQUssTUFBTSxnQ0FBZ0M7QUFDbEQsU0FB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