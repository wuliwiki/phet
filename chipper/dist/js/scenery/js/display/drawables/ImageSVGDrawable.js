// Copyright 2016-2022, University of Colorado Boulder

/**
 * SVG drawable for Image nodes.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Poolable from '../../../../phet-core/js/Poolable.js';
import { ImageStatefulDrawable, scenery, svgns, SVGSelfDrawable, xlinkns } from '../../imports.js';

// TODO: change this based on memory and performance characteristics of the platform
const keepSVGImageElements = true; // whether we should pool SVG elements for the SVG rendering states, or whether we should free them when possible for memory

class ImageSVGDrawable extends ImageStatefulDrawable(SVGSelfDrawable) {
  /**
   * @public
   * @override
   *
   * @param {number} renderer
   * @param {Instance} instance
   */
  initialize(renderer, instance) {
    super.initialize(renderer, instance, false, keepSVGImageElements); // usesPaint: false

    sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} initialized for ${instance.toString()}`);

    // @protected {SVGImageElement} - Sole SVG element for this drawable, implementing API for SVGSelfDrawable
    this.svgElement = this.svgElement || document.createElementNS(svgns, 'image');
    this.svgElement.setAttribute('x', '0');
    this.svgElement.setAttribute('y', '0');

    // @private {boolean} - Whether we have an opacity attribute specified on the DOM element.
    this.hasOpacity = false;

    // @private {boolean}
    this.usingMipmap = false;

    // @private {number} - will always be invalidated
    this.mipmapLevel = -1;

    // @private {function} - if mipmaps are enabled, this listener will be added to when our relative transform changes
    this._mipmapTransformListener = this._mipmapTransformListener || this.onMipmapTransform.bind(this);
    this._mipmapListener = this._mipmapListener || this.onMipmap.bind(this);
    this.node.mipmapEmitter.addListener(this._mipmapListener);
    this.updateMipmapStatus(instance.node._mipmap);
  }

  /**
   * Updates the SVG elements so that they will appear like the current node's representation.
   * @protected
   *
   * Implements the interface for SVGSelfDrawable (and is called from the SVGSelfDrawable's update).
   */
  updateSVGSelf() {
    const image = this.svgElement;
    if (this.dirtyImage) {
      sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Updating dirty image`);
      if (this.node._image) {
        // like <image xlink:href='https://phet.colorado.edu/images/phet-logo-yellow.png' x='0' y='0' height='127px' width='242px'/>
        this.updateURL(image, true);
      } else {
        image.setAttribute('width', '0');
        image.setAttribute('height', '0');
        image.setAttributeNS(xlinkns, 'xlink:href', '//:0'); // see http://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src
      }
    } else if (this.dirtyMipmap && this.node._image) {
      sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Updating dirty mipmap`);
      this.updateURL(image, false);
    }
    if (this.dirtyImageOpacity) {
      if (this.node._imageOpacity === 1) {
        if (this.hasOpacity) {
          this.hasOpacity = false;
          image.removeAttribute('opacity');
        }
      } else {
        this.hasOpacity = true;
        image.setAttribute('opacity', this.node._imageOpacity);
      }
    }
  }

  /**
   * @private
   *
   * @param {SVGImageElement} image
   * @param {boolean} forced
   */
  updateURL(image, forced) {
    // determine our mipmap level, if any is used
    let level = -1; // signals a default of "we are not using mipmapping"
    if (this.node._mipmap) {
      level = this.node.getMipmapLevel(this.instance.relativeTransform.matrix);
      sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Mipmap level: ${level}`);
    }

    // bail out if we would use the currently-used mipmap level (or none) and there was no image change
    if (!forced && level === this.mipmapLevel) {
      return;
    }

    // if we are switching to having no mipmap
    if (this.mipmapLevel >= 0 && level === -1) {
      image.removeAttribute('transform');
    }
    this.mipmapLevel = level;
    if (this.node._mipmap && this.node.hasMipmaps()) {
      sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Setting image URL to mipmap level ${level}`);
      const url = this.node.getMipmapURL(level);
      const canvas = this.node.getMipmapCanvas(level);
      image.setAttribute('width', `${canvas.width}px`);
      image.setAttribute('height', `${canvas.height}px`);
      // Since SVG doesn't support parsing scientific notation (e.g. 7e5), we need to output fixed decimal-point strings.
      // Since this needs to be done quickly, and we don't particularly care about slight rounding differences (it's
      // being used for display purposes only, and is never shown to the user), we use the built-in JS toFixed instead of
      // Dot's version of toFixed. See https://github.com/phetsims/kite/issues/50
      image.setAttribute('transform', `scale(${Math.pow(2, level).toFixed(20)})`); // eslint-disable-line bad-sim-text
      image.setAttributeNS(xlinkns, 'xlink:href', url);
    } else {
      sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Setting image URL`);
      image.setAttribute('width', `${this.node.getImageWidth()}px`);
      image.setAttribute('height', `${this.node.getImageHeight()}px`);
      image.setAttributeNS(xlinkns, 'xlink:href', this.node.getImageURL());
    }
  }

  /**
   * @private
   *
   * @param {boolean} usingMipmap
   */
  updateMipmapStatus(usingMipmap) {
    if (this.usingMipmap !== usingMipmap) {
      this.usingMipmap = usingMipmap;
      if (usingMipmap) {
        sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Adding mipmap compute/listener needs`);
        this.instance.relativeTransform.addListener(this._mipmapTransformListener); // when our relative tranform changes, notify us in the pre-repaint phase
        this.instance.relativeTransform.addPrecompute(); // trigger precomputation of the relative transform, since we will always need it when it is updated
      } else {
        sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Removing mipmap compute/listener needs`);
        this.instance.relativeTransform.removeListener(this._mipmapTransformListener);
        this.instance.relativeTransform.removePrecompute();
      }

      // sanity check
      this.markDirtyMipmap();
    }
  }

  /**
   * @private
   */
  onMipmap() {
    // sanity check
    this.markDirtyMipmap();

    // update our mipmap usage status
    this.updateMipmapStatus(this.node._mipmap);
  }

  /**
   * @private
   */
  onMipmapTransform() {
    sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} Transform dirties mipmap`);
    this.markDirtyMipmap();
  }

  /**
   * Disposes the drawable.
   * @public
   * @override
   */
  dispose() {
    sceneryLog && sceneryLog.ImageSVGDrawable && sceneryLog.ImageSVGDrawable(`${this.id} disposing`);

    // clean up mipmap listeners and compute needs
    this.updateMipmapStatus(false);
    this.node.mipmapEmitter.removeListener(this._mipmapListener);
    super.dispose();
  }
}
scenery.register('ImageSVGDrawable', ImageSVGDrawable);
Poolable.mixInto(ImageSVGDrawable);
export default ImageSVGDrawable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQb29sYWJsZSIsIkltYWdlU3RhdGVmdWxEcmF3YWJsZSIsInNjZW5lcnkiLCJzdmducyIsIlNWR1NlbGZEcmF3YWJsZSIsInhsaW5rbnMiLCJrZWVwU1ZHSW1hZ2VFbGVtZW50cyIsIkltYWdlU1ZHRHJhd2FibGUiLCJpbml0aWFsaXplIiwicmVuZGVyZXIiLCJpbnN0YW5jZSIsInNjZW5lcnlMb2ciLCJpZCIsInRvU3RyaW5nIiwic3ZnRWxlbWVudCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudE5TIiwic2V0QXR0cmlidXRlIiwiaGFzT3BhY2l0eSIsInVzaW5nTWlwbWFwIiwibWlwbWFwTGV2ZWwiLCJfbWlwbWFwVHJhbnNmb3JtTGlzdGVuZXIiLCJvbk1pcG1hcFRyYW5zZm9ybSIsImJpbmQiLCJfbWlwbWFwTGlzdGVuZXIiLCJvbk1pcG1hcCIsIm5vZGUiLCJtaXBtYXBFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJ1cGRhdGVNaXBtYXBTdGF0dXMiLCJfbWlwbWFwIiwidXBkYXRlU1ZHU2VsZiIsImltYWdlIiwiZGlydHlJbWFnZSIsIl9pbWFnZSIsInVwZGF0ZVVSTCIsInNldEF0dHJpYnV0ZU5TIiwiZGlydHlNaXBtYXAiLCJkaXJ0eUltYWdlT3BhY2l0eSIsIl9pbWFnZU9wYWNpdHkiLCJyZW1vdmVBdHRyaWJ1dGUiLCJmb3JjZWQiLCJsZXZlbCIsImdldE1pcG1hcExldmVsIiwicmVsYXRpdmVUcmFuc2Zvcm0iLCJtYXRyaXgiLCJoYXNNaXBtYXBzIiwidXJsIiwiZ2V0TWlwbWFwVVJMIiwiY2FudmFzIiwiZ2V0TWlwbWFwQ2FudmFzIiwid2lkdGgiLCJoZWlnaHQiLCJNYXRoIiwicG93IiwidG9GaXhlZCIsImdldEltYWdlV2lkdGgiLCJnZXRJbWFnZUhlaWdodCIsImdldEltYWdlVVJMIiwiYWRkUHJlY29tcHV0ZSIsInJlbW92ZUxpc3RlbmVyIiwicmVtb3ZlUHJlY29tcHV0ZSIsIm1hcmtEaXJ0eU1pcG1hcCIsImRpc3Bvc2UiLCJyZWdpc3RlciIsIm1peEludG8iXSwic291cmNlcyI6WyJJbWFnZVNWR0RyYXdhYmxlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE2LTIwMjIsIFVuaXZlcnNpdHkgb2YgQ29sb3JhZG8gQm91bGRlclxyXG5cclxuLyoqXHJcbiAqIFNWRyBkcmF3YWJsZSBmb3IgSW1hZ2Ugbm9kZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cclxuICovXHJcblxyXG5pbXBvcnQgUG9vbGFibGUgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL1Bvb2xhYmxlLmpzJztcclxuaW1wb3J0IHsgSW1hZ2VTdGF0ZWZ1bERyYXdhYmxlLCBzY2VuZXJ5LCBzdmducywgU1ZHU2VsZkRyYXdhYmxlLCB4bGlua25zIH0gZnJvbSAnLi4vLi4vaW1wb3J0cy5qcyc7XHJcblxyXG4vLyBUT0RPOiBjaGFuZ2UgdGhpcyBiYXNlZCBvbiBtZW1vcnkgYW5kIHBlcmZvcm1hbmNlIGNoYXJhY3RlcmlzdGljcyBvZiB0aGUgcGxhdGZvcm1cclxuY29uc3Qga2VlcFNWR0ltYWdlRWxlbWVudHMgPSB0cnVlOyAvLyB3aGV0aGVyIHdlIHNob3VsZCBwb29sIFNWRyBlbGVtZW50cyBmb3IgdGhlIFNWRyByZW5kZXJpbmcgc3RhdGVzLCBvciB3aGV0aGVyIHdlIHNob3VsZCBmcmVlIHRoZW0gd2hlbiBwb3NzaWJsZSBmb3IgbWVtb3J5XHJcblxyXG5jbGFzcyBJbWFnZVNWR0RyYXdhYmxlIGV4dGVuZHMgSW1hZ2VTdGF0ZWZ1bERyYXdhYmxlKCBTVkdTZWxmRHJhd2FibGUgKSB7XHJcbiAgLyoqXHJcbiAgICogQHB1YmxpY1xyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IHJlbmRlcmVyXHJcbiAgICogQHBhcmFtIHtJbnN0YW5jZX0gaW5zdGFuY2VcclxuICAgKi9cclxuICBpbml0aWFsaXplKCByZW5kZXJlciwgaW5zdGFuY2UgKSB7XHJcbiAgICBzdXBlci5pbml0aWFsaXplKCByZW5kZXJlciwgaW5zdGFuY2UsIGZhbHNlLCBrZWVwU1ZHSW1hZ2VFbGVtZW50cyApOyAvLyB1c2VzUGFpbnQ6IGZhbHNlXHJcblxyXG4gICAgc2NlbmVyeUxvZyAmJiBzY2VuZXJ5TG9nLkltYWdlU1ZHRHJhd2FibGUgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlKCBgJHt0aGlzLmlkfSBpbml0aWFsaXplZCBmb3IgJHtpbnN0YW5jZS50b1N0cmluZygpfWAgKTtcclxuXHJcbiAgICAvLyBAcHJvdGVjdGVkIHtTVkdJbWFnZUVsZW1lbnR9IC0gU29sZSBTVkcgZWxlbWVudCBmb3IgdGhpcyBkcmF3YWJsZSwgaW1wbGVtZW50aW5nIEFQSSBmb3IgU1ZHU2VsZkRyYXdhYmxlXHJcbiAgICB0aGlzLnN2Z0VsZW1lbnQgPSB0aGlzLnN2Z0VsZW1lbnQgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKCBzdmducywgJ2ltYWdlJyApO1xyXG4gICAgdGhpcy5zdmdFbGVtZW50LnNldEF0dHJpYnV0ZSggJ3gnLCAnMCcgKTtcclxuICAgIHRoaXMuc3ZnRWxlbWVudC5zZXRBdHRyaWJ1dGUoICd5JywgJzAnICk7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge2Jvb2xlYW59IC0gV2hldGhlciB3ZSBoYXZlIGFuIG9wYWNpdHkgYXR0cmlidXRlIHNwZWNpZmllZCBvbiB0aGUgRE9NIGVsZW1lbnQuXHJcbiAgICB0aGlzLmhhc09wYWNpdHkgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7Ym9vbGVhbn1cclxuICAgIHRoaXMudXNpbmdNaXBtYXAgPSBmYWxzZTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSB7bnVtYmVyfSAtIHdpbGwgYWx3YXlzIGJlIGludmFsaWRhdGVkXHJcbiAgICB0aGlzLm1pcG1hcExldmVsID0gLTE7XHJcblxyXG4gICAgLy8gQHByaXZhdGUge2Z1bmN0aW9ufSAtIGlmIG1pcG1hcHMgYXJlIGVuYWJsZWQsIHRoaXMgbGlzdGVuZXIgd2lsbCBiZSBhZGRlZCB0byB3aGVuIG91ciByZWxhdGl2ZSB0cmFuc2Zvcm0gY2hhbmdlc1xyXG4gICAgdGhpcy5fbWlwbWFwVHJhbnNmb3JtTGlzdGVuZXIgPSB0aGlzLl9taXBtYXBUcmFuc2Zvcm1MaXN0ZW5lciB8fCB0aGlzLm9uTWlwbWFwVHJhbnNmb3JtLmJpbmQoIHRoaXMgKTtcclxuICAgIHRoaXMuX21pcG1hcExpc3RlbmVyID0gdGhpcy5fbWlwbWFwTGlzdGVuZXIgfHwgdGhpcy5vbk1pcG1hcC5iaW5kKCB0aGlzICk7XHJcblxyXG4gICAgdGhpcy5ub2RlLm1pcG1hcEVtaXR0ZXIuYWRkTGlzdGVuZXIoIHRoaXMuX21pcG1hcExpc3RlbmVyICk7XHJcbiAgICB0aGlzLnVwZGF0ZU1pcG1hcFN0YXR1cyggaW5zdGFuY2Uubm9kZS5fbWlwbWFwICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoZSBTVkcgZWxlbWVudHMgc28gdGhhdCB0aGV5IHdpbGwgYXBwZWFyIGxpa2UgdGhlIGN1cnJlbnQgbm9kZSdzIHJlcHJlc2VudGF0aW9uLlxyXG4gICAqIEBwcm90ZWN0ZWRcclxuICAgKlxyXG4gICAqIEltcGxlbWVudHMgdGhlIGludGVyZmFjZSBmb3IgU1ZHU2VsZkRyYXdhYmxlIChhbmQgaXMgY2FsbGVkIGZyb20gdGhlIFNWR1NlbGZEcmF3YWJsZSdzIHVwZGF0ZSkuXHJcbiAgICovXHJcbiAgdXBkYXRlU1ZHU2VsZigpIHtcclxuICAgIGNvbnN0IGltYWdlID0gdGhpcy5zdmdFbGVtZW50O1xyXG5cclxuICAgIGlmICggdGhpcy5kaXJ0eUltYWdlICkge1xyXG4gICAgICBzY2VuZXJ5TG9nICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSAmJiBzY2VuZXJ5TG9nLkltYWdlU1ZHRHJhd2FibGUoIGAke3RoaXMuaWR9IFVwZGF0aW5nIGRpcnR5IGltYWdlYCApO1xyXG4gICAgICBpZiAoIHRoaXMubm9kZS5faW1hZ2UgKSB7XHJcbiAgICAgICAgLy8gbGlrZSA8aW1hZ2UgeGxpbms6aHJlZj0naHR0cHM6Ly9waGV0LmNvbG9yYWRvLmVkdS9pbWFnZXMvcGhldC1sb2dvLXllbGxvdy5wbmcnIHg9JzAnIHk9JzAnIGhlaWdodD0nMTI3cHgnIHdpZHRoPScyNDJweCcvPlxyXG4gICAgICAgIHRoaXMudXBkYXRlVVJMKCBpbWFnZSwgdHJ1ZSApO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIGltYWdlLnNldEF0dHJpYnV0ZSggJ3dpZHRoJywgJzAnICk7XHJcbiAgICAgICAgaW1hZ2Uuc2V0QXR0cmlidXRlKCAnaGVpZ2h0JywgJzAnICk7XHJcbiAgICAgICAgaW1hZ2Uuc2V0QXR0cmlidXRlTlMoIHhsaW5rbnMsICd4bGluazpocmVmJywgJy8vOjAnICk7IC8vIHNlZSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzU3NzU0Njkvd2hhdHMtdGhlLXZhbGlkLXdheS10by1pbmNsdWRlLWFuLWltYWdlLXdpdGgtbm8tc3JjXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCB0aGlzLmRpcnR5TWlwbWFwICYmIHRoaXMubm9kZS5faW1hZ2UgKSB7XHJcbiAgICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gVXBkYXRpbmcgZGlydHkgbWlwbWFwYCApO1xyXG4gICAgICB0aGlzLnVwZGF0ZVVSTCggaW1hZ2UsIGZhbHNlICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCB0aGlzLmRpcnR5SW1hZ2VPcGFjaXR5ICkge1xyXG4gICAgICBpZiAoIHRoaXMubm9kZS5faW1hZ2VPcGFjaXR5ID09PSAxICkge1xyXG4gICAgICAgIGlmICggdGhpcy5oYXNPcGFjaXR5ICkge1xyXG4gICAgICAgICAgdGhpcy5oYXNPcGFjaXR5ID0gZmFsc2U7XHJcbiAgICAgICAgICBpbWFnZS5yZW1vdmVBdHRyaWJ1dGUoICdvcGFjaXR5JyApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICB0aGlzLmhhc09wYWNpdHkgPSB0cnVlO1xyXG4gICAgICAgIGltYWdlLnNldEF0dHJpYnV0ZSggJ29wYWNpdHknLCB0aGlzLm5vZGUuX2ltYWdlT3BhY2l0eSApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtTVkdJbWFnZUVsZW1lbnR9IGltYWdlXHJcbiAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZWRcclxuICAgKi9cclxuICB1cGRhdGVVUkwoIGltYWdlLCBmb3JjZWQgKSB7XHJcbiAgICAvLyBkZXRlcm1pbmUgb3VyIG1pcG1hcCBsZXZlbCwgaWYgYW55IGlzIHVzZWRcclxuICAgIGxldCBsZXZlbCA9IC0xOyAvLyBzaWduYWxzIGEgZGVmYXVsdCBvZiBcIndlIGFyZSBub3QgdXNpbmcgbWlwbWFwcGluZ1wiXHJcbiAgICBpZiAoIHRoaXMubm9kZS5fbWlwbWFwICkge1xyXG4gICAgICBsZXZlbCA9IHRoaXMubm9kZS5nZXRNaXBtYXBMZXZlbCggdGhpcy5pbnN0YW5jZS5yZWxhdGl2ZVRyYW5zZm9ybS5tYXRyaXggKTtcclxuICAgICAgc2NlbmVyeUxvZyAmJiBzY2VuZXJ5TG9nLkltYWdlU1ZHRHJhd2FibGUgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlKCBgJHt0aGlzLmlkfSBNaXBtYXAgbGV2ZWw6ICR7bGV2ZWx9YCApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGJhaWwgb3V0IGlmIHdlIHdvdWxkIHVzZSB0aGUgY3VycmVudGx5LXVzZWQgbWlwbWFwIGxldmVsIChvciBub25lKSBhbmQgdGhlcmUgd2FzIG5vIGltYWdlIGNoYW5nZVxyXG4gICAgaWYgKCAhZm9yY2VkICYmIGxldmVsID09PSB0aGlzLm1pcG1hcExldmVsICkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gaWYgd2UgYXJlIHN3aXRjaGluZyB0byBoYXZpbmcgbm8gbWlwbWFwXHJcbiAgICBpZiAoIHRoaXMubWlwbWFwTGV2ZWwgPj0gMCAmJiBsZXZlbCA9PT0gLTEgKSB7XHJcbiAgICAgIGltYWdlLnJlbW92ZUF0dHJpYnV0ZSggJ3RyYW5zZm9ybScgKTtcclxuICAgIH1cclxuICAgIHRoaXMubWlwbWFwTGV2ZWwgPSBsZXZlbDtcclxuXHJcbiAgICBpZiAoIHRoaXMubm9kZS5fbWlwbWFwICYmIHRoaXMubm9kZS5oYXNNaXBtYXBzKCkgKSB7XHJcbiAgICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gU2V0dGluZyBpbWFnZSBVUkwgdG8gbWlwbWFwIGxldmVsICR7bGV2ZWx9YCApO1xyXG4gICAgICBjb25zdCB1cmwgPSB0aGlzLm5vZGUuZ2V0TWlwbWFwVVJMKCBsZXZlbCApO1xyXG4gICAgICBjb25zdCBjYW52YXMgPSB0aGlzLm5vZGUuZ2V0TWlwbWFwQ2FudmFzKCBsZXZlbCApO1xyXG4gICAgICBpbWFnZS5zZXRBdHRyaWJ1dGUoICd3aWR0aCcsIGAke2NhbnZhcy53aWR0aH1weGAgKTtcclxuICAgICAgaW1hZ2Uuc2V0QXR0cmlidXRlKCAnaGVpZ2h0JywgYCR7Y2FudmFzLmhlaWdodH1weGAgKTtcclxuICAgICAgLy8gU2luY2UgU1ZHIGRvZXNuJ3Qgc3VwcG9ydCBwYXJzaW5nIHNjaWVudGlmaWMgbm90YXRpb24gKGUuZy4gN2U1KSwgd2UgbmVlZCB0byBvdXRwdXQgZml4ZWQgZGVjaW1hbC1wb2ludCBzdHJpbmdzLlxyXG4gICAgICAvLyBTaW5jZSB0aGlzIG5lZWRzIHRvIGJlIGRvbmUgcXVpY2tseSwgYW5kIHdlIGRvbid0IHBhcnRpY3VsYXJseSBjYXJlIGFib3V0IHNsaWdodCByb3VuZGluZyBkaWZmZXJlbmNlcyAoaXQnc1xyXG4gICAgICAvLyBiZWluZyB1c2VkIGZvciBkaXNwbGF5IHB1cnBvc2VzIG9ubHksIGFuZCBpcyBuZXZlciBzaG93biB0byB0aGUgdXNlciksIHdlIHVzZSB0aGUgYnVpbHQtaW4gSlMgdG9GaXhlZCBpbnN0ZWFkIG9mXHJcbiAgICAgIC8vIERvdCdzIHZlcnNpb24gb2YgdG9GaXhlZC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9waGV0c2ltcy9raXRlL2lzc3Vlcy81MFxyXG4gICAgICBpbWFnZS5zZXRBdHRyaWJ1dGUoICd0cmFuc2Zvcm0nLCBgc2NhbGUoJHtNYXRoLnBvdyggMiwgbGV2ZWwgKS50b0ZpeGVkKCAyMCApfSlgICk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgYmFkLXNpbS10ZXh0XHJcbiAgICAgIGltYWdlLnNldEF0dHJpYnV0ZU5TKCB4bGlua25zLCAneGxpbms6aHJlZicsIHVybCApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gU2V0dGluZyBpbWFnZSBVUkxgICk7XHJcbiAgICAgIGltYWdlLnNldEF0dHJpYnV0ZSggJ3dpZHRoJywgYCR7dGhpcy5ub2RlLmdldEltYWdlV2lkdGgoKX1weGAgKTtcclxuICAgICAgaW1hZ2Uuc2V0QXR0cmlidXRlKCAnaGVpZ2h0JywgYCR7dGhpcy5ub2RlLmdldEltYWdlSGVpZ2h0KCl9cHhgICk7XHJcbiAgICAgIGltYWdlLnNldEF0dHJpYnV0ZU5TKCB4bGlua25zLCAneGxpbms6aHJlZicsIHRoaXMubm9kZS5nZXRJbWFnZVVSTCgpICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtib29sZWFufSB1c2luZ01pcG1hcFxyXG4gICAqL1xyXG4gIHVwZGF0ZU1pcG1hcFN0YXR1cyggdXNpbmdNaXBtYXAgKSB7XHJcbiAgICBpZiAoIHRoaXMudXNpbmdNaXBtYXAgIT09IHVzaW5nTWlwbWFwICkge1xyXG4gICAgICB0aGlzLnVzaW5nTWlwbWFwID0gdXNpbmdNaXBtYXA7XHJcblxyXG4gICAgICBpZiAoIHVzaW5nTWlwbWFwICkge1xyXG4gICAgICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gQWRkaW5nIG1pcG1hcCBjb21wdXRlL2xpc3RlbmVyIG5lZWRzYCApO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UucmVsYXRpdmVUcmFuc2Zvcm0uYWRkTGlzdGVuZXIoIHRoaXMuX21pcG1hcFRyYW5zZm9ybUxpc3RlbmVyICk7IC8vIHdoZW4gb3VyIHJlbGF0aXZlIHRyYW5mb3JtIGNoYW5nZXMsIG5vdGlmeSB1cyBpbiB0aGUgcHJlLXJlcGFpbnQgcGhhc2VcclxuICAgICAgICB0aGlzLmluc3RhbmNlLnJlbGF0aXZlVHJhbnNmb3JtLmFkZFByZWNvbXB1dGUoKTsgLy8gdHJpZ2dlciBwcmVjb21wdXRhdGlvbiBvZiB0aGUgcmVsYXRpdmUgdHJhbnNmb3JtLCBzaW5jZSB3ZSB3aWxsIGFsd2F5cyBuZWVkIGl0IHdoZW4gaXQgaXMgdXBkYXRlZFxyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gUmVtb3ZpbmcgbWlwbWFwIGNvbXB1dGUvbGlzdGVuZXIgbmVlZHNgICk7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5yZWxhdGl2ZVRyYW5zZm9ybS5yZW1vdmVMaXN0ZW5lciggdGhpcy5fbWlwbWFwVHJhbnNmb3JtTGlzdGVuZXIgKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLnJlbGF0aXZlVHJhbnNmb3JtLnJlbW92ZVByZWNvbXB1dGUoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gc2FuaXR5IGNoZWNrXHJcbiAgICAgIHRoaXMubWFya0RpcnR5TWlwbWFwKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIG9uTWlwbWFwKCkge1xyXG4gICAgLy8gc2FuaXR5IGNoZWNrXHJcbiAgICB0aGlzLm1hcmtEaXJ0eU1pcG1hcCgpO1xyXG5cclxuICAgIC8vIHVwZGF0ZSBvdXIgbWlwbWFwIHVzYWdlIHN0YXR1c1xyXG4gICAgdGhpcy51cGRhdGVNaXBtYXBTdGF0dXMoIHRoaXMubm9kZS5fbWlwbWFwICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIG9uTWlwbWFwVHJhbnNmb3JtKCkge1xyXG4gICAgc2NlbmVyeUxvZyAmJiBzY2VuZXJ5TG9nLkltYWdlU1ZHRHJhd2FibGUgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlKCBgJHt0aGlzLmlkfSBUcmFuc2Zvcm0gZGlydGllcyBtaXBtYXBgICk7XHJcblxyXG4gICAgdGhpcy5tYXJrRGlydHlNaXBtYXAoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERpc3Bvc2VzIHRoZSBkcmF3YWJsZS5cclxuICAgKiBAcHVibGljXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIHNjZW5lcnlMb2cgJiYgc2NlbmVyeUxvZy5JbWFnZVNWR0RyYXdhYmxlICYmIHNjZW5lcnlMb2cuSW1hZ2VTVkdEcmF3YWJsZSggYCR7dGhpcy5pZH0gZGlzcG9zaW5nYCApO1xyXG5cclxuICAgIC8vIGNsZWFuIHVwIG1pcG1hcCBsaXN0ZW5lcnMgYW5kIGNvbXB1dGUgbmVlZHNcclxuICAgIHRoaXMudXBkYXRlTWlwbWFwU3RhdHVzKCBmYWxzZSApO1xyXG4gICAgdGhpcy5ub2RlLm1pcG1hcEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIHRoaXMuX21pcG1hcExpc3RlbmVyICk7XHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ0ltYWdlU1ZHRHJhd2FibGUnLCBJbWFnZVNWR0RyYXdhYmxlICk7XHJcblxyXG5Qb29sYWJsZS5taXhJbnRvKCBJbWFnZVNWR0RyYXdhYmxlICk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBJbWFnZVNWR0RyYXdhYmxlOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxPQUFPQSxRQUFRLE1BQU0sc0NBQXNDO0FBQzNELFNBQVNDLHFCQUFxQixFQUFFQyxPQUFPLEVBQUVDLEtBQUssRUFBRUMsZUFBZSxFQUFFQyxPQUFPLFFBQVEsa0JBQWtCOztBQUVsRztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLElBQUksQ0FBQyxDQUFDOztBQUVuQyxNQUFNQyxnQkFBZ0IsU0FBU04scUJBQXFCLENBQUVHLGVBQWdCLENBQUMsQ0FBQztFQUN0RTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNFSSxVQUFVQSxDQUFFQyxRQUFRLEVBQUVDLFFBQVEsRUFBRztJQUMvQixLQUFLLENBQUNGLFVBQVUsQ0FBRUMsUUFBUSxFQUFFQyxRQUFRLEVBQUUsS0FBSyxFQUFFSixvQkFBcUIsQ0FBQyxDQUFDLENBQUM7O0lBRXJFSyxVQUFVLElBQUlBLFVBQVUsQ0FBQ0osZ0JBQWdCLElBQUlJLFVBQVUsQ0FBQ0osZ0JBQWdCLENBQUcsR0FBRSxJQUFJLENBQUNLLEVBQUcsb0JBQW1CRixRQUFRLENBQUNHLFFBQVEsQ0FBQyxDQUFFLEVBQUUsQ0FBQzs7SUFFL0g7SUFDQSxJQUFJLENBQUNDLFVBQVUsR0FBRyxJQUFJLENBQUNBLFVBQVUsSUFBSUMsUUFBUSxDQUFDQyxlQUFlLENBQUViLEtBQUssRUFBRSxPQUFRLENBQUM7SUFDL0UsSUFBSSxDQUFDVyxVQUFVLENB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