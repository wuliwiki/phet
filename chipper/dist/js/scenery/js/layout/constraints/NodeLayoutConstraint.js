// Copyright 2022-2023, University of Colorado Boulder

/**
 * Supertype for LayoutConstraints that are based on an actual Node where the layout takes place. Generally used with
 * layout containers that are subtypes of LayoutNode.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */

import Property from '../../../../axon/js/Property.js';
import TinyProperty from '../../../../axon/js/TinyProperty.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import { LayoutConstraint, scenery } from '../../imports.js';
import optionize from '../../../../phet-core/js/optionize.js';
import Vector2 from '../../../../dot/js/Vector2.js';
// Position changes smaller than this will be ignored
const CHANGE_POSITION_THRESHOLD = 1e-9;

// Type export designed for use with clients

export default class NodeLayoutConstraint extends LayoutConstraint {
  _excludeInvisible = true;

  // Reports out the used layout bounds (may be larger than actual bounds, since it will include margins, etc.)
  // Layout nodes can use this to adjust their localBounds. FlowBox/GridBox uses this for their localBounds.
  // (scenery-internal)
  // (scenery-internal)
  /**
   * Recommended for ancestorNode to be the layout container, and that the layout container extends LayoutNode.
   * (scenery-internal)
   */
  constructor(ancestorNode, providedOptions) {
    // The omitted options are set to proper defaults below
    const options = optionize()({
      // As options, so we could hook into a Node's preferred/minimum sizes if desired
      preferredWidthProperty: new TinyProperty(null),
      preferredHeightProperty: new TinyProperty(null),
      minimumWidthProperty: new TinyProperty(null),
      minimumHeightProperty: new TinyProperty(null),
      layoutOriginProperty: new TinyProperty(Vector2.ZERO)
    }, providedOptions);
    super(ancestorNode);
    this.layoutBoundsProperty = new Property(Bounds2.NOTHING, {
      valueComparisonStrategy: 'equalsFunction'
    });
    this.preferredWidthProperty = options.preferredWidthProperty;
    this.preferredHeightProperty = options.preferredHeightProperty;
    this.minimumWidthProperty = options.minimumWidthProperty;
    this.minimumHeightProperty = options.minimumHeightProperty;
    this.layoutOriginProperty = options.layoutOriginProperty;
    this.preferredWidthProperty.lazyLink(this._updateLayoutListener);
    this.preferredHeightProperty.lazyLink(this._updateLayoutListener);
    this.layoutOriginProperty.lazyLink(this._updateLayoutListener);
  }

  /**
   * Filters out cells to only those that will be involved in layout
   */
  filterLayoutCells(cells) {
    // We'll check to make sure cells are disposed in a common place, so it's not duplicated
    assert && assert(_.every(cells, cell => !cell.node.isDisposed), 'A cell\'s node should not be disposed when layout happens');
    return cells.filter(cell => {
      return cell.isConnected() && cell.proxy.bounds.isValid() && (!this.excludeInvisible || cell.node.visible);
    });
  }
  get excludeInvisible() {
    return this._excludeInvisible;
  }
  set excludeInvisible(value) {
    if (this._excludeInvisible !== value) {
      this._excludeInvisible = value;
      this.updateLayoutAutomatically();
    }
  }

  /**
   * Sets preferred size of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyPreferredSize(orientation, proxy, preferredSize) {
    proxy[orientation.preferredSize] = preferredSize;
  }

  /**
   * Sets position of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyMinSide(orientation, proxy, minSide) {
    if (Math.abs(proxy[orientation.minSide] - minSide) > CHANGE_POSITION_THRESHOLD) {
      proxy[orientation.minSide] = minSide;
    }
  }

  /**
   * Sets origin-based position of content in a central location (so we could hook in animation in the future)
   * (scenery-internal)
   */
  setProxyOrigin(orientation, proxy, origin) {
    if (Math.abs(proxy[orientation.coordinate] - origin) > CHANGE_POSITION_THRESHOLD) {
      proxy[orientation.coordinate] = origin;
    }
  }

  /**
   * Releases references
   */
  dispose() {
    // In case they're from external sources (since these constraints can be used without a dedicated Node that is also
    // being disposed.
    this.preferredWidthProperty.unlink(this._updateLayoutListener);
    this.preferredHeightProperty.unlink(this._updateLayoutListener);
    this.layoutOriginProperty.unlink(this._updateLayoutListener);
    super.dispose();
  }
}
scenery.register('NodeLayoutConstraint', NodeLayoutConstraint);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIlRpbnlQcm9wZXJ0eSIsIkJvdW5kczIiLCJMYXlvdXRDb25zdHJhaW50Iiwic2NlbmVyeSIsIm9wdGlvbml6ZSIsIlZlY3RvcjIiLCJDSEFOR0VfUE9TSVRJT05fVEhSRVNIT0xEIiwiTm9kZUxheW91dENvbnN0cmFpbnQiLCJfZXhjbHVkZUludmlzaWJsZSIsImNvbnN0cnVjdG9yIiwiYW5jZXN0b3JOb2RlIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInByZWZlcnJlZFdpZHRoUHJvcGVydHkiLCJwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eSIsIm1pbmltdW1XaWR0aFByb3BlcnR5IiwibWluaW11bUhlaWdodFByb3BlcnR5IiwibGF5b3V0T3JpZ2luUHJvcGVydHkiLCJaRVJPIiwibGF5b3V0Qm91bmRzUHJvcGVydHkiLCJOT1RISU5HIiwidmFsdWVDb21wYXJpc29uU3RyYXRlZ3kiLCJsYXp5TGluayIsIl91cGRhdGVMYXlvdXRMaXN0ZW5lciIsImZpbHRlckxheW91dENlbGxzIiwiY2VsbHMiLCJhc3NlcnQiLCJfIiwiZXZlcnkiLCJjZWxsIiwibm9kZSIsImlzRGlzcG9zZWQiLCJmaWx0ZXIiLCJpc0Nvbm5lY3RlZCIsInByb3h5IiwiYm91bmRzIiwiaXNWYWxpZCIsImV4Y2x1ZGVJbnZpc2libGUiLCJ2aXNpYmxlIiwidmFsdWUiLCJ1cGRhdGVMYXlvdXRBdXRvbWF0aWNhbGx5Iiwic2V0UHJveHlQcmVmZXJyZWRTaXplIiwib3JpZW50YXRpb24iLCJwcmVmZXJyZWRTaXplIiwic2V0UHJveHlNaW5TaWRlIiwibWluU2lkZSIsIk1hdGgiLCJhYnMiLCJzZXRQcm94eU9yaWdpbiIsIm9yaWdpbiIsImNvb3JkaW5hdGUiLCJkaXNwb3NlIiwidW5saW5rIiwicmVnaXN0ZXIiXSwic291cmNlcyI6WyJOb2RlTGF5b3V0Q29uc3RyYWludC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAyMi0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBTdXBlcnR5cGUgZm9yIExheW91dENvbnN0cmFpbnRzIHRoYXQgYXJlIGJhc2VkIG9uIGFuIGFjdHVhbCBOb2RlIHdoZXJlIHRoZSBsYXlvdXQgdGFrZXMgcGxhY2UuIEdlbmVyYWxseSB1c2VkIHdpdGhcclxuICogbGF5b3V0IGNvbnRhaW5lcnMgdGhhdCBhcmUgc3VidHlwZXMgb2YgTGF5b3V0Tm9kZS5cclxuICpcclxuICogQGF1dGhvciBKb25hdGhhbiBPbHNvbiA8am9uYXRoYW4ub2xzb25AY29sb3JhZG8uZWR1PlxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IFN0cmljdE9taXQgZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL3R5cGVzL1N0cmljdE9taXQuanMnO1xyXG5pbXBvcnQgVGlueVByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVGlueVByb3BlcnR5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgeyBMYXlvdXRDb25zdHJhaW50LCBMYXlvdXRQcm94eSwgTWFyZ2luTGF5b3V0Q2VsbCwgTm9kZSwgc2NlbmVyeSB9IGZyb20gJy4uLy4uL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgVFByb3BlcnR5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvVFByb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgT3JpZW50YXRpb24gZnJvbSAnLi4vLi4vLi4vLi4vcGhldC1jb3JlL2pzL09yaWVudGF0aW9uLmpzJztcclxuXHJcbi8vIFBvc2l0aW9uIGNoYW5nZXMgc21hbGxlciB0aGFuIHRoaXMgd2lsbCBiZSBpZ25vcmVkXHJcbmNvbnN0IENIQU5HRV9QT1NJVElPTl9USFJFU0hPTEQgPSAxZS05O1xyXG5cclxudHlwZSBTZWxmT3B0aW9ucyA9IHtcclxuICAvLyBXaGV0aGVyIGludmlzaWJsZSBOb2RlcyBhcmUgZXhjbHVkZWQgZnJvbSB0aGUgbGF5b3V0LlxyXG4gIGV4Y2x1ZGVJbnZpc2libGU/OiBib29sZWFuO1xyXG5cclxuICAvLyBJZiBhdmFpbGFibGUsIHRoZSBsb2NhbCB2ZXJzaW9ucyBvZiB0aGVzZSBQcm9wZXJ0aWVzIGZvciB0aGUgbGF5b3V0IGNvbnRhaW5lciBzaG91bGQgYmUgcGFzc2VkIGluLiBXZSBkbyB0aGVcclxuICAvLyBsYXlvdXQgaW4gdGhlIGxvY2FsIGNvb3JkaW5hdGUgZnJhbWUgb2YgZS5nLiBHcmlkQm94L0Zsb3dCb3guIEl0J3MgbmFtZWQgdGhpcyB3YXkganVzdCBmb3IgZWFzZS1vZi11c2Ugd2l0aGluXHJcbiAgLy8gdGhpcyBjb2RlLlxyXG4gIHByZWZlcnJlZFdpZHRoUHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgcHJlZmVycmVkSGVpZ2h0UHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgbWluaW11bVdpZHRoUHJvcGVydHk/OiBUUHJvcGVydHk8bnVtYmVyIHwgbnVsbD47XHJcbiAgbWluaW11bUhlaWdodFByb3BlcnR5PzogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG5cclxuICAvLyBJZiBwcm92aWRlZCwgd2lsbCBwb3NpdGlvbiBjb250ZW50IGF0IGFuIG9mZnNldCBmcm9tIHRoZSBub3JtYWwgb3JpZ2luXHJcbiAgbGF5b3V0T3JpZ2luUHJvcGVydHk/OiBUUHJvcGVydHk8VmVjdG9yMj47XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMgPSBTZWxmT3B0aW9ucztcclxuXHJcbi8vIFR5cGUgZXhwb3J0IGRlc2lnbmVkIGZvciB1c2Ugd2l0aCBjbGllbnRzXHJcbmV4cG9ydCB0eXBlIE5vZGVMYXlvdXRBdmFpbGFibGVDb25zdHJhaW50T3B0aW9ucyA9IFBpY2s8Tm9kZUxheW91dENvbnN0cmFpbnRPcHRpb25zLCAnZXhjbHVkZUludmlzaWJsZScgfCAnbGF5b3V0T3JpZ2luUHJvcGVydHknPjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE5vZGVMYXlvdXRDb25zdHJhaW50IGV4dGVuZHMgTGF5b3V0Q29uc3RyYWludCB7XHJcblxyXG4gIHByaXZhdGUgX2V4Y2x1ZGVJbnZpc2libGUgPSB0cnVlO1xyXG5cclxuICAvLyBSZXBvcnRzIG91dCB0aGUgdXNlZCBsYXlvdXQgYm91bmRzIChtYXkgYmUgbGFyZ2VyIHRoYW4gYWN0dWFsIGJvdW5kcywgc2luY2UgaXQgd2lsbCBpbmNsdWRlIG1hcmdpbnMsIGV0Yy4pXHJcbiAgLy8gTGF5b3V0IG5vZGVzIGNhbiB1c2UgdGhpcyB0byBhZGp1c3QgdGhlaXIgbG9jYWxCb3VuZHMuIEZsb3dCb3gvR3JpZEJveCB1c2VzIHRoaXMgZm9yIHRoZWlyIGxvY2FsQm91bmRzLlxyXG4gIC8vIChzY2VuZXJ5LWludGVybmFsKVxyXG4gIHB1YmxpYyByZWFkb25seSBsYXlvdXRCb3VuZHNQcm9wZXJ0eTogVFByb3BlcnR5PEJvdW5kczI+O1xyXG5cclxuICAvLyAoc2NlbmVyeS1pbnRlcm5hbClcclxuICBwdWJsaWMgcmVhZG9ubHkgcHJlZmVycmVkV2lkdGhQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBtaW5pbXVtV2lkdGhQcm9wZXJ0eTogVFByb3BlcnR5PG51bWJlciB8IG51bGw+O1xyXG4gIHB1YmxpYyByZWFkb25seSBtaW5pbXVtSGVpZ2h0UHJvcGVydHk6IFRQcm9wZXJ0eTxudW1iZXIgfCBudWxsPjtcclxuICBwdWJsaWMgcmVhZG9ubHkgbGF5b3V0T3JpZ2luUHJvcGVydHk6IFRQcm9wZXJ0eTxWZWN0b3IyPjtcclxuXHJcbiAgLyoqXHJcbiAgICogUmVjb21tZW5kZWQgZm9yIGFuY2VzdG9yTm9kZSB0byBiZSB0aGUgbGF5b3V0IGNvbnRhaW5lciwgYW5kIHRoYXQgdGhlIGxheW91dCBjb250YWluZXIgZXh0ZW5kcyBMYXlvdXROb2RlLlxyXG4gICAqIChzY2VuZXJ5LWludGVybmFsKVxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciggYW5jZXN0b3JOb2RlOiBOb2RlLCBwcm92aWRlZE9wdGlvbnM/OiBOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMgKSB7XHJcblxyXG4gICAgLy8gVGhlIG9taXR0ZWQgb3B0aW9ucyBhcmUgc2V0IHRvIHByb3BlciBkZWZhdWx0cyBiZWxvd1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IG9wdGlvbml6ZTxOb2RlTGF5b3V0Q29uc3RyYWludE9wdGlvbnMsIFN0cmljdE9taXQ8U2VsZk9wdGlvbnMsICdleGNsdWRlSW52aXNpYmxlJz4+KCkoIHtcclxuICAgICAgLy8gQXMgb3B0aW9ucywgc28gd2UgY291bGQgaG9vayBpbnRvIGEgTm9kZSdzIHByZWZlcnJlZC9taW5pbXVtIHNpemVzIGlmIGRlc2lyZWRcclxuICAgICAgcHJlZmVycmVkV2lkdGhQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBwcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBtaW5pbXVtV2lkdGhQcm9wZXJ0eTogbmV3IFRpbnlQcm9wZXJ0eTxudW1iZXIgfCBudWxsPiggbnVsbCApLFxyXG4gICAgICBtaW5pbXVtSGVpZ2h0UHJvcGVydHk6IG5ldyBUaW55UHJvcGVydHk8bnVtYmVyIHwgbnVsbD4oIG51bGwgKSxcclxuICAgICAgbGF5b3V0T3JpZ2luUHJvcGVydHk6IG5ldyBUaW55UHJvcGVydHk8VmVjdG9yMj4oIFZlY3RvcjIuWkVSTyApXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBzdXBlciggYW5jZXN0b3JOb2RlICk7XHJcblxyXG4gICAgdGhpcy5sYXlvdXRCb3VuZHNQcm9wZXJ0eSA9IG5ldyBQcm9wZXJ0eSggQm91bmRzMi5OT1RISU5HLCB7XHJcbiAgICAgIHZhbHVlQ29tcGFyaXNvblN0cmF0ZWd5OiAnZXF1YWxzRnVuY3Rpb24nXHJcbiAgICB9ICk7XHJcblxyXG4gICAgdGhpcy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5ID0gb3B0aW9ucy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5O1xyXG4gICAgdGhpcy5wcmVmZXJyZWRIZWlnaHRQcm9wZXJ0eSA9IG9wdGlvbnMucHJlZmVycmVkSGVpZ2h0UHJvcGVydHk7XHJcbiAgICB0aGlzLm1pbmltdW1XaWR0aFByb3BlcnR5ID0gb3B0aW9ucy5taW5pbXVtV2lkdGhQcm9wZXJ0eTtcclxuICAgIHRoaXMubWluaW11bUhlaWdodFByb3BlcnR5ID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0UHJvcGVydHk7XHJcbiAgICB0aGlzLmxheW91dE9yaWdpblByb3BlcnR5ID0gb3B0aW9ucy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eTtcclxuXHJcbiAgICB0aGlzLnByZWZlcnJlZFdpZHRoUHJvcGVydHkubGF6eUxpbmsoIHRoaXMuX3VwZGF0ZUxheW91dExpc3RlbmVyICk7XHJcbiAgICB0aGlzLnByZWZlcnJlZEhlaWdodFByb3BlcnR5LmxhenlMaW5rKCB0aGlzLl91cGRhdGVMYXlvdXRMaXN0ZW5lciApO1xyXG4gICAgdGhpcy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eS5sYXp5TGluayggdGhpcy5fdXBkYXRlTGF5b3V0TGlzdGVuZXIgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZpbHRlcnMgb3V0IGNlbGxzIHRvIG9ubHkgdGhvc2UgdGhhdCB3aWxsIGJlIGludm9sdmVkIGluIGxheW91dFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmaWx0ZXJMYXlvdXRDZWxsczxDZWxsIGV4dGVuZHMgTWFyZ2luTGF5b3V0Q2VsbD4oIGNlbGxzOiBDZWxsW10gKTogQ2VsbFtdIHtcclxuICAgIC8vIFdlJ2xsIGNoZWNrIHRvIG1ha2Ugc3VyZSBjZWxscyBhcmUgZGlzcG9zZWQgaW4gYSBjb21tb24gcGxhY2UsIHNvIGl0J3Mgbm90IGR1cGxpY2F0ZWRcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIF8uZXZlcnkoIGNlbGxzLCBjZWxsID0+ICFjZWxsLm5vZGUuaXNEaXNwb3NlZCApLCAnQSBjZWxsXFwncyBub2RlIHNob3VsZCBub3QgYmUgZGlzcG9zZWQgd2hlbiBsYXlvdXQgaGFwcGVucycgKTtcclxuXHJcbiAgICByZXR1cm4gY2VsbHMuZmlsdGVyKCBjZWxsID0+IHtcclxuICAgICAgcmV0dXJuIGNlbGwuaXNDb25uZWN0ZWQoKSAmJiBjZWxsLnByb3h5LmJvdW5kcy5pc1ZhbGlkKCkgJiYgKCAhdGhpcy5leGNsdWRlSW52aXNpYmxlIHx8IGNlbGwubm9kZS52aXNpYmxlICk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGV4Y2x1ZGVJbnZpc2libGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXhjbHVkZUludmlzaWJsZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZXQgZXhjbHVkZUludmlzaWJsZSggdmFsdWU6IGJvb2xlYW4gKSB7XHJcbiAgICBpZiAoIHRoaXMuX2V4Y2x1ZGVJbnZpc2libGUgIT09IHZhbHVlICkge1xyXG4gICAgICB0aGlzLl9leGNsdWRlSW52aXNpYmxlID0gdmFsdWU7XHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZUxheW91dEF1dG9tYXRpY2FsbHkoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgcHJlZmVycmVkIHNpemUgb2YgY29udGVudCBpbiBhIGNlbnRyYWwgbG9jYXRpb24gKHNvIHdlIGNvdWxkIGhvb2sgaW4gYW5pbWF0aW9uIGluIHRoZSBmdXR1cmUpXHJcbiAgICogKHNjZW5lcnktaW50ZXJuYWwpXHJcbiAgICovXHJcbiAgcHVibGljIHNldFByb3h5UHJlZmVycmVkU2l6ZSggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIHByZWZlcnJlZFNpemU6IG51bWJlciB8IG51bGwgKTogdm9pZCB7XHJcbiAgICBwcm94eVsgb3JpZW50YXRpb24ucHJlZmVycmVkU2l6ZSBdID0gcHJlZmVycmVkU2l6ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgcG9zaXRpb24gb2YgY29udGVudCBpbiBhIGNlbnRyYWwgbG9jYXRpb24gKHNvIHdlIGNvdWxkIGhvb2sgaW4gYW5pbWF0aW9uIGluIHRoZSBmdXR1cmUpXHJcbiAgICogKHNjZW5lcnktaW50ZXJuYWwpXHJcbiAgICovXHJcbiAgcHVibGljIHNldFByb3h5TWluU2lkZSggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIG1pblNpZGU6IG51bWJlciApOiB2b2lkIHtcclxuICAgIGlmICggTWF0aC5hYnMoIHByb3h5WyBvcmllbnRhdGlvbi5taW5TaWRlIF0gLSBtaW5TaWRlICkgPiBDSEFOR0VfUE9TSVRJT05fVEhSRVNIT0xEICkge1xyXG4gICAgICBwcm94eVsgb3JpZW50YXRpb24ubWluU2lkZSBdID0gbWluU2lkZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgb3JpZ2luLWJhc2VkIHBvc2l0aW9uIG9mIGNvbnRlbnQgaW4gYSBjZW50cmFsIGxvY2F0aW9uIChzbyB3ZSBjb3VsZCBob29rIGluIGFuaW1hdGlvbiBpbiB0aGUgZnV0dXJlKVxyXG4gICAqIChzY2VuZXJ5LWludGVybmFsKVxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRQcm94eU9yaWdpbiggb3JpZW50YXRpb246IE9yaWVudGF0aW9uLCBwcm94eTogTGF5b3V0UHJveHksIG9yaWdpbjogbnVtYmVyICk6IHZvaWQge1xyXG4gICAgaWYgKCBNYXRoLmFicyggcHJveHlbIG9yaWVudGF0aW9uLmNvb3JkaW5hdGUgXSAtIG9yaWdpbiApID4gQ0hBTkdFX1BPU0lUSU9OX1RIUkVTSE9MRCApIHtcclxuICAgICAgcHJveHlbIG9yaWVudGF0aW9uLmNvb3JkaW5hdGUgXSA9IG9yaWdpbjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbGVhc2VzIHJlZmVyZW5jZXNcclxuICAgKi9cclxuICBwdWJsaWMgb3ZlcnJpZGUgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIC8vIEluIGNhc2UgdGhleSdyZSBmcm9tIGV4dGVybmFsIHNvdXJjZXMgKHNpbmNlIHRoZXNlIGNvbnN0cmFpbnRzIGNhbiBiZSB1c2VkIHdpdGhvdXQgYSBkZWRpY2F0ZWQgTm9kZSB0aGF0IGlzIGFsc29cclxuICAgIC8vIGJlaW5nIGRpc3Bvc2VkLlxyXG4gICAgdGhpcy5wcmVmZXJyZWRXaWR0aFByb3BlcnR5LnVubGluayggdGhpcy5fdXBkYXRlTGF5b3V0TGlzdGVuZXIgKTtcclxuICAgIHRoaXMucHJlZmVycmVkSGVpZ2h0UHJvcGVydHkudW5saW5rKCB0aGlzLl91cGRhdGVMYXlvdXRMaXN0ZW5lciApO1xyXG4gICAgdGhpcy5sYXlvdXRPcmlnaW5Qcm9wZXJ0eS51bmxpbmsoIHRoaXMuX3VwZGF0ZUxheW91dExpc3RlbmVyICk7XHJcblxyXG4gICAgc3VwZXIuZGlzcG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuc2NlbmVyeS5yZWdpc3RlciggJ05vZGVMYXlvdXRDb25zdHJhaW50JywgTm9kZUxheW91dENvbnN0cmFpbnQgKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsUUFB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