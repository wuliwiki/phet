// Copyright 2018-2023, University of Colorado Boulder

/**
 * BorderAlertsDescriber is "sub-describer" used in MovementAlerter to manage its border alerts. Border alerts will
 * be alerted either once when object movement intersects with the bounds. With the addition of an option, the
 * border alert will be repeated for as long as the moving object is dragged against that bound, see repeatBorderAlerts.
 * @author Michael Kauzmann (PhET Interactive Simulations)
 */

import Property from '../../../../axon/js/Property.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import merge from '../../../../phet-core/js/merge.js';
import { KeyboardUtils } from '../../../../scenery/js/imports.js';
import ResponsePacket from '../../../../utterance-queue/js/ResponsePacket.js';
import Utterance from '../../../../utterance-queue/js/Utterance.js';
import sceneryPhet from '../../sceneryPhet.js';
import SceneryPhetStrings from '../../SceneryPhetStrings.js';
import DirectionEnum from './DirectionEnum.js';

// constants
const leftBorderAlertString = SceneryPhetStrings.a11y.movementAlerter.leftBorderAlert;
const rightBorderAlertString = SceneryPhetStrings.a11y.movementAlerter.rightBorderAlert;
const topBorderAlertString = SceneryPhetStrings.a11y.movementAlerter.topBorderAlert;
const bottomBorderAlertString = SceneryPhetStrings.a11y.movementAlerter.bottomBorderAlert;
const DEFAULT_TOP_BORDER_ALERT = topBorderAlertString;

/**
 * Responsible for alerting when the temperature increases
 * @param {Object} [options]
 * @constructor
 */
class BorderAlertsDescriber {
  constructor(options) {
    options = merge({
      // {Property<Bounds2>} - The bounds that makes the border we alert when against
      boundsProperty: new Property(new Bounds2(Number.NEGATIVE_INFINITY, Number.NEGATIVE_INFINITY, Number.POSITIVE_INFINITY, Number.POSITIVE_INFINITY)),
      // {TAlertable} At left edge, right edge, top, and bottom with values to alert if you reach that bound.
      // Pass in null if you don't want that border alerted. By default, if these are non-Utterances, they will be wrapped
      // in utterances, and for voicing classified as "object responses", if passing in a custom utterance, it is up to
      // the client to divide into voicing response categories.
      leftAlert: leftBorderAlertString,
      rightAlert: rightBorderAlertString,
      topAlert: DEFAULT_TOP_BORDER_ALERT,
      bottomAlert: bottomBorderAlertString,
      // Applied to any Utterances created from the Alert options above. Utterances are only created to wrap the above
      // options if an Utterance is not already provided
      utteranceOptions: {}
    }, options);

    // @public (Utterance) - these keys should stay the same as keys from DirectionEnum,
    this[DirectionEnum.LEFT] = null;
    this[DirectionEnum.RIGHT] = null;
    this[DirectionEnum.UP] = null;
    this[DirectionEnum.DOWN] = null;
    this.setDirectionUtterance(options.leftAlert, DirectionEnum.LEFT, options.utteranceOptions);
    this.setDirectionUtterance(options.rightAlert, DirectionEnum.RIGHT, options.utteranceOptions);
    this.setDirectionUtterance(options.topAlert, DirectionEnum.UP, options.utteranceOptions);
    this.setDirectionUtterance(options.bottomAlert, DirectionEnum.DOWN, options.utteranceOptions);

    // @private
    this.boundsProperty = options.boundsProperty; // The drag border
  }

  /**
   * Wrap the direction property in an Utterance if not already one. Null is supported.
   * @private
   * @param {TAlertable} alert
   * @param {DirectionEnum} direction
   * @param {Object} [utteranceOptions] - if creating an Utterance, options to pass to it
   */
  setDirectionUtterance(alert, direction, utteranceOptions) {
    // Nothing to set if null;
    if (alert !== null) {
      if (alert instanceof Utterance) {
        this[direction] = alert;
      } else {
        assert && utteranceOptions && assert(!utteranceOptions.alert, ' setDirectionUtterance sets its own alert');
        this[direction] = new Utterance(merge({
          alert: new ResponsePacket({
            objectResponse: alert
          }) // each alert is an object response
        }, utteranceOptions));
      }
    }
  }

  /**
   * Based on a position and the border bounds, if the position is touching the bounds, then alert that we are at border.
   * By passing in an optional key, you can prioritize that direction if you are at the corner.
   * @private
   *
   * @param {Vector2} position
   * @param {string} [key] - prefer this direction key if provided
   * @returns{TAlertable} - null if there is nothing to alert
   */
  getAlertAtBorder(position, key) {
    let alertDirection;
    const bordersTouching = [];

    // at left now, but wasn't last position
    if (position.x === this.boundsProperty.value.left) {
      bordersTouching.push(DirectionEnum.LEFT);
    }

    // at right now, but wasn't last position
    if (position.x === this.boundsProperty.value.right) {
      bordersTouching.push(DirectionEnum.RIGHT);
    }

    // at top now, but wasn't last position
    if (position.y === this.boundsProperty.value.top) {
      bordersTouching.push(DirectionEnum.UP);
    }

    // at bottom now, but wasn't last position
    if (position.y === this.boundsProperty.value.bottom) {
      bordersTouching.push(DirectionEnum.DOWN);
    }

    // corner case
    if (bordersTouching.length > 1) {
      key = key || '';
      const possibleDirection = DirectionEnum.keyToDirection(key);

      // if the key matches a border direction, use that instead of another wall that we may also be touching
      if (possibleDirection && bordersTouching.indexOf(possibleDirection) >= 0) {
        alertDirection = possibleDirection;
      }
    }
    // normal single border case
    else if (bordersTouching.length === 1) {
      alertDirection = bordersTouching[0];
    }

    // Then we are potentially going to alert
    if (alertDirection) {
      assert && assert(DirectionEnum.isRelativeDirection(alertDirection), `unsupported direction: ${alertDirection}`);
      const utterance = this[alertDirection];

      // Null means unsupported direction, no alert to be had here.
      if (utterance) {
        return utterance;
      }
    }
    return null;
  }

  /**
   * @public
   * @param {Vector2} position
   * @param {KeyboardEvent} [domEvent] - we don't get this from a mouse drag listener
   * @returns{TAlertable} - null if there is nothing to alert
   */
  getAlertOnEndDrag(position, domEvent) {
    let key;
    if (domEvent) {
      key = KeyboardUtils.getEventCode(domEvent);
    }
    return this.getAlertAtBorder(position, key);
  }

  /**
   * @public
   */
  reset() {
    this[DirectionEnum.LEFT] && this[DirectionEnum.LEFT].reset();
    this[DirectionEnum.RIGHT] && this[DirectionEnum.RIGHT].reset();
    this[DirectionEnum.UP] && this[DirectionEnum.UP].reset();
    this[DirectionEnum.DOWN] && this[DirectionEnum.DOWN].reset();
  }

  /**
   * Default top alert for the border alerts
   * @public
   *
   * @returns {string}
   */
  static getDefaultTopAlert() {
    return DEFAULT_TOP_BORDER_ALERT;
  }
}
sceneryPhet.register('BorderAlertsDescriber', BorderAlertsDescriber);
export default BorderAlertsDescriber;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9wZXJ0eSIsIkJvdW5kczIiLCJtZXJnZSIsIktleWJvYXJkVXRpbHMiLCJSZXNwb25zZVBhY2tldCIsIlV0dGVyYW5jZSIsInNjZW5lcnlQaGV0IiwiU2NlbmVyeVBoZXRTdHJpbmdzIiwiRGlyZWN0aW9uRW51bSIsImxlZnRCb3JkZXJBbGVydFN0cmluZyIsImExMXkiLCJtb3ZlbWVudEFsZXJ0ZXIiLCJsZWZ0Qm9yZGVyQWxlcnQiLCJyaWdodEJvcmRlckFsZXJ0U3RyaW5nIiwicmlnaHRCb3JkZXJBbGVydCIsInRvcEJvcmRlckFsZXJ0U3RyaW5nIiwidG9wQm9yZGVyQWxlcnQiLCJib3R0b21Cb3JkZXJBbGVydFN0cmluZyIsImJvdHRvbUJvcmRlckFsZXJ0IiwiREVGQVVMVF9UT1BfQk9SREVSX0FMRVJUIiwiQm9yZGVyQWxlcnRzRGVzY3JpYmVyIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiYm91bmRzUHJvcGVydHkiLCJOdW1iZXIiLCJORUdBVElWRV9JTkZJTklUWSIsIlBPU0lUSVZFX0lORklOSVRZIiwibGVmdEFsZXJ0IiwicmlnaHRBbGVydCIsInRvcEFsZXJ0IiwiYm90dG9tQWxlcnQiLCJ1dHRlcmFuY2VPcHRpb25zIiwiTEVGVCIsIlJJR0hUIiwiVVAiLCJET1dOIiwic2V0RGlyZWN0aW9uVXR0ZXJhbmNlIiwiYWxlcnQiLCJkaXJlY3Rpb24iLCJhc3NlcnQiLCJvYmplY3RSZXNwb25zZSIsImdldEFsZXJ0QXRCb3JkZXIiLCJwb3NpdGlvbiIsImtleSIsImFsZXJ0RGlyZWN0aW9uIiwiYm9yZGVyc1RvdWNoaW5nIiwieCIsInZhbHVlIiwibGVmdCIsInB1c2giLCJyaWdodCIsInkiLCJ0b3AiLCJib3R0b20iLCJsZW5ndGgiLCJwb3NzaWJsZURpcmVjdGlvbiIsImtleVRvRGlyZWN0aW9uIiwiaW5kZXhPZiIsImlzUmVsYXRpdmVEaXJlY3Rpb24iLCJ1dHRlcmFuY2UiLCJnZXRBbGVydE9uRW5kRHJhZyIsImRvbUV2ZW50IiwiZ2V0RXZlbnRDb2RlIiwicmVzZXQiLCJnZXREZWZhdWx0VG9wQWxlcnQiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkJvcmRlckFsZXJ0c0Rlc2NyaWJlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBCb3JkZXJBbGVydHNEZXNjcmliZXIgaXMgXCJzdWItZGVzY3JpYmVyXCIgdXNlZCBpbiBNb3ZlbWVudEFsZXJ0ZXIgdG8gbWFuYWdlIGl0cyBib3JkZXIgYWxlcnRzLiBCb3JkZXIgYWxlcnRzIHdpbGxcclxuICogYmUgYWxlcnRlZCBlaXRoZXIgb25jZSB3aGVuIG9iamVjdCBtb3ZlbWVudCBpbnRlcnNlY3RzIHdpdGggdGhlIGJvdW5kcy4gV2l0aCB0aGUgYWRkaXRpb24gb2YgYW4gb3B0aW9uLCB0aGVcclxuICogYm9yZGVyIGFsZXJ0IHdpbGwgYmUgcmVwZWF0ZWQgZm9yIGFzIGxvbmcgYXMgdGhlIG1vdmluZyBvYmplY3QgaXMgZHJhZ2dlZCBhZ2FpbnN0IHRoYXQgYm91bmQsIHNlZSByZXBlYXRCb3JkZXJBbGVydHMuXHJcbiAqIEBhdXRob3IgTWljaGFlbCBLYXV6bWFubiAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Qcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBCb3VuZHMyIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9Cb3VuZHMyLmpzJztcclxuaW1wb3J0IG1lcmdlIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9tZXJnZS5qcyc7XHJcbmltcG9ydCB7IEtleWJvYXJkVXRpbHMgfSBmcm9tICcuLi8uLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgUmVzcG9uc2VQYWNrZXQgZnJvbSAnLi4vLi4vLi4vLi4vdXR0ZXJhbmNlLXF1ZXVlL2pzL1Jlc3BvbnNlUGFja2V0LmpzJztcclxuaW1wb3J0IFV0dGVyYW5jZSBmcm9tICcuLi8uLi8uLi8uLi91dHRlcmFuY2UtcXVldWUvanMvVXR0ZXJhbmNlLmpzJztcclxuaW1wb3J0IHNjZW5lcnlQaGV0IGZyb20gJy4uLy4uL3NjZW5lcnlQaGV0LmpzJztcclxuaW1wb3J0IFNjZW5lcnlQaGV0U3RyaW5ncyBmcm9tICcuLi8uLi9TY2VuZXJ5UGhldFN0cmluZ3MuanMnO1xyXG5pbXBvcnQgRGlyZWN0aW9uRW51bSBmcm9tICcuL0RpcmVjdGlvbkVudW0uanMnO1xyXG5cclxuLy8gY29uc3RhbnRzXHJcbmNvbnN0IGxlZnRCb3JkZXJBbGVydFN0cmluZyA9IFNjZW5lcnlQaGV0U3RyaW5ncy5hMTF5Lm1vdmVtZW50QWxlcnRlci5sZWZ0Qm9yZGVyQWxlcnQ7XHJcbmNvbnN0IHJpZ2h0Qm9yZGVyQWxlcnRTdHJpbmcgPSBTY2VuZXJ5UGhldFN0cmluZ3MuYTExeS5tb3ZlbWVudEFsZXJ0ZXIucmlnaHRCb3JkZXJBbGVydDtcclxuY29uc3QgdG9wQm9yZGVyQWxlcnRTdHJpbmcgPSBTY2VuZXJ5UGhldFN0cmluZ3MuYTExeS5tb3ZlbWVudEFsZXJ0ZXIudG9wQm9yZGVyQWxlcnQ7XHJcbmNvbnN0IGJvdHRvbUJvcmRlckFsZXJ0U3RyaW5nID0gU2NlbmVyeVBoZXRTdHJpbmdzLmExMXkubW92ZW1lbnRBbGVydGVyLmJvdHRvbUJvcmRlckFsZXJ0O1xyXG5cclxuY29uc3QgREVGQVVMVF9UT1BfQk9SREVSX0FMRVJUID0gdG9wQm9yZGVyQWxlcnRTdHJpbmc7XHJcblxyXG4vKipcclxuICogUmVzcG9uc2libGUgZm9yIGFsZXJ0aW5nIHdoZW4gdGhlIHRlbXBlcmF0dXJlIGluY3JlYXNlc1xyXG4gKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdXHJcbiAqIEBjb25zdHJ1Y3RvclxyXG4gKi9cclxuY2xhc3MgQm9yZGVyQWxlcnRzRGVzY3JpYmVyIHtcclxuICBjb25zdHJ1Y3Rvciggb3B0aW9ucyApIHtcclxuXHJcbiAgICBvcHRpb25zID0gbWVyZ2UoIHtcclxuXHJcbiAgICAgIC8vIHtQcm9wZXJ0eTxCb3VuZHMyPn0gLSBUaGUgYm91bmRzIHRoYXQgbWFrZXMgdGhlIGJvcmRlciB3ZSBhbGVydCB3aGVuIGFnYWluc3RcclxuICAgICAgYm91bmRzUHJvcGVydHk6IG5ldyBQcm9wZXJ0eSggbmV3IEJvdW5kczIoIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSApICksXHJcblxyXG4gICAgICAvLyB7VEFsZXJ0YWJsZX0gQXQgbGVmdCBlZGdlLCByaWdodCBlZGdlLCB0b3AsIGFuZCBib3R0b20gd2l0aCB2YWx1ZXMgdG8gYWxlcnQgaWYgeW91IHJlYWNoIHRoYXQgYm91bmQuXHJcbiAgICAgIC8vIFBhc3MgaW4gbnVsbCBpZiB5b3UgZG9uJ3Qgd2FudCB0aGF0IGJvcmRlciBhbGVydGVkLiBCeSBkZWZhdWx0LCBpZiB0aGVzZSBhcmUgbm9uLVV0dGVyYW5jZXMsIHRoZXkgd2lsbCBiZSB3cmFwcGVkXHJcbiAgICAgIC8vIGluIHV0dGVyYW5jZXMsIGFuZCBmb3Igdm9pY2luZyBjbGFzc2lmaWVkIGFzIFwib2JqZWN0IHJlc3BvbnNlc1wiLCBpZiBwYXNzaW5nIGluIGEgY3VzdG9tIHV0dGVyYW5jZSwgaXQgaXMgdXAgdG9cclxuICAgICAgLy8gdGhlIGNsaWVudCB0byBkaXZpZGUgaW50byB2b2ljaW5nIHJlc3BvbnNlIGNhdGVnb3JpZXMuXHJcbiAgICAgIGxlZnRBbGVydDogbGVmdEJvcmRlckFsZXJ0U3RyaW5nLFxyXG4gICAgICByaWdodEFsZXJ0OiByaWdodEJvcmRlckFsZXJ0U3RyaW5nLFxyXG4gICAgICB0b3BBbGVydDogREVGQVVMVF9UT1BfQk9SREVSX0FMRVJULFxyXG4gICAgICBib3R0b21BbGVydDogYm90dG9tQm9yZGVyQWxlcnRTdHJpbmcsXHJcblxyXG4gICAgICAvLyBBcHBsaWVkIHRvIGFueSBVdHRlcmFuY2VzIGNyZWF0ZWQgZnJvbSB0aGUgQWxlcnQgb3B0aW9ucyBhYm92ZS4gVXR0ZXJhbmNlcyBhcmUgb25seSBjcmVhdGVkIHRvIHdyYXAgdGhlIGFib3ZlXHJcbiAgICAgIC8vIG9wdGlvbnMgaWYgYW4gVXR0ZXJhbmNlIGlzIG5vdCBhbHJlYWR5IHByb3ZpZGVkXHJcbiAgICAgIHV0dGVyYW5jZU9wdGlvbnM6IHt9XHJcbiAgICB9LCBvcHRpb25zICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAoVXR0ZXJhbmNlKSAtIHRoZXNlIGtleXMgc2hvdWxkIHN0YXkgdGhlIHNhbWUgYXMga2V5cyBmcm9tIERpcmVjdGlvbkVudW0sXHJcbiAgICB0aGlzWyBEaXJlY3Rpb25FbnVtLkxFRlQgXSA9IG51bGw7XHJcbiAgICB0aGlzWyBEaXJlY3Rpb25FbnVtLlJJR0hUIF0gPSBudWxsO1xyXG4gICAgdGhpc1sgRGlyZWN0aW9uRW51bS5VUCBdID0gbnVsbDtcclxuICAgIHRoaXNbIERpcmVjdGlvbkVudW0uRE9XTiBdID0gbnVsbDtcclxuXHJcbiAgICB0aGlzLnNldERpcmVjdGlvblV0dGVyYW5jZSggb3B0aW9ucy5sZWZ0QWxlcnQsIERpcmVjdGlvbkVudW0uTEVGVCwgb3B0aW9ucy51dHRlcmFuY2VPcHRpb25zICk7XHJcbiAgICB0aGlzLnNldERpcmVjdGlvblV0dGVyYW5jZSggb3B0aW9ucy5yaWdodEFsZXJ0LCBEaXJlY3Rpb25FbnVtLlJJR0hULCBvcHRpb25zLnV0dGVyYW5jZU9wdGlvbnMgKTtcclxuICAgIHRoaXMuc2V0RGlyZWN0aW9uVXR0ZXJhbmNlKCBvcHRpb25zLnRvcEFsZXJ0LCBEaXJlY3Rpb25FbnVtLlVQLCBvcHRpb25zLnV0dGVyYW5jZU9wdGlvbnMgKTtcclxuICAgIHRoaXMuc2V0RGlyZWN0aW9uVXR0ZXJhbmNlKCBvcHRpb25zLmJvdHRvbUFsZXJ0LCBEaXJlY3Rpb25FbnVtLkRPV04sIG9wdGlvbnMudXR0ZXJhbmNlT3B0aW9ucyApO1xyXG5cclxuICAgIC8vIEBwcml2YXRlXHJcbiAgICB0aGlzLmJvdW5kc1Byb3BlcnR5ID0gb3B0aW9ucy5ib3VuZHNQcm9wZXJ0eTsgLy8gVGhlIGRyYWcgYm9yZGVyXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBXcmFwIHRoZSBkaXJlY3Rpb24gcHJvcGVydHkgaW4gYW4gVXR0ZXJhbmNlIGlmIG5vdCBhbHJlYWR5IG9uZS4gTnVsbCBpcyBzdXBwb3J0ZWQuXHJcbiAgICogQHByaXZhdGVcclxuICAgKiBAcGFyYW0ge1RBbGVydGFibGV9IGFsZXJ0XHJcbiAgICogQHBhcmFtIHtEaXJlY3Rpb25FbnVtfSBkaXJlY3Rpb25cclxuICAgKiBAcGFyYW0ge09iamVjdH0gW3V0dGVyYW5jZU9wdGlvbnNdIC0gaWYgY3JlYXRpbmcgYW4gVXR0ZXJhbmNlLCBvcHRpb25zIHRvIHBhc3MgdG8gaXRcclxuICAgKi9cclxuICBzZXREaXJlY3Rpb25VdHRlcmFuY2UoIGFsZXJ0LCBkaXJlY3Rpb24sIHV0dGVyYW5jZU9wdGlvbnMgKSB7XHJcblxyXG4gICAgLy8gTm90aGluZyB0byBzZXQgaWYgbnVsbDtcclxuICAgIGlmICggYWxlcnQgIT09IG51bGwgKSB7XHJcbiAgICAgIGlmICggYWxlcnQgaW5zdGFuY2VvZiBVdHRlcmFuY2UgKSB7XHJcbiAgICAgICAgdGhpc1sgZGlyZWN0aW9uIF0gPSBhbGVydDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBhc3NlcnQgJiYgdXR0ZXJhbmNlT3B0aW9ucyAmJiBhc3NlcnQoICF1dHRlcmFuY2VPcHRpb25zLmFsZXJ0LCAnIHNldERpcmVjdGlvblV0dGVyYW5jZSBzZXRzIGl0cyBvd24gYWxlcnQnICk7XHJcbiAgICAgICAgdGhpc1sgZGlyZWN0aW9uIF0gPSBuZXcgVXR0ZXJhbmNlKCBtZXJnZSgge1xyXG4gICAgICAgICAgICBhbGVydDogbmV3IFJlc3BvbnNlUGFja2V0KCB7IG9iamVjdFJlc3BvbnNlOiBhbGVydCB9ICkgLy8gZWFjaCBhbGVydCBpcyBhbiBvYmplY3QgcmVzcG9uc2VcclxuICAgICAgICAgIH0sIHV0dGVyYW5jZU9wdGlvbnMgKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJhc2VkIG9uIGEgcG9zaXRpb24gYW5kIHRoZSBib3JkZXIgYm91bmRzLCBpZiB0aGUgcG9zaXRpb24gaXMgdG91Y2hpbmcgdGhlIGJvdW5kcywgdGhlbiBhbGVydCB0aGF0IHdlIGFyZSBhdCBib3JkZXIuXHJcbiAgICogQnkgcGFzc2luZyBpbiBhbiBvcHRpb25hbCBrZXksIHlvdSBjYW4gcHJpb3JpdGl6ZSB0aGF0IGRpcmVjdGlvbiBpZiB5b3UgYXJlIGF0IHRoZSBjb3JuZXIuXHJcbiAgICogQHByaXZhdGVcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7VmVjdG9yMn0gcG9zaXRpb25cclxuICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gLSBwcmVmZXIgdGhpcyBkaXJlY3Rpb24ga2V5IGlmIHByb3ZpZGVkXHJcbiAgICogQHJldHVybnN7VEFsZXJ0YWJsZX0gLSBudWxsIGlmIHRoZXJlIGlzIG5vdGhpbmcgdG8gYWxlcnRcclxuICAgKi9cclxuICBnZXRBbGVydEF0Qm9yZGVyKCBwb3NpdGlvbiwga2V5ICkge1xyXG4gICAgbGV0IGFsZXJ0RGlyZWN0aW9uO1xyXG5cclxuICAgIGNvbnN0IGJvcmRlcnNUb3VjaGluZyA9IFtdO1xyXG5cclxuICAgIC8vIGF0IGxlZnQgbm93LCBidXQgd2Fzbid0IGxhc3QgcG9zaXRpb25cclxuICAgIGlmICggcG9zaXRpb24ueCA9PT0gdGhpcy5ib3VuZHNQcm9wZXJ0eS52YWx1ZS5sZWZ0ICkge1xyXG4gICAgICBib3JkZXJzVG91Y2hpbmcucHVzaCggRGlyZWN0aW9uRW51bS5MRUZUICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYXQgcmlnaHQgbm93LCBidXQgd2Fzbid0IGxhc3QgcG9zaXRpb25cclxuICAgIGlmICggcG9zaXRpb24ueCA9PT0gdGhpcy5ib3VuZHNQcm9wZXJ0eS52YWx1ZS5yaWdodCApIHtcclxuICAgICAgYm9yZGVyc1RvdWNoaW5nLnB1c2goIERpcmVjdGlvbkVudW0uUklHSFQgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBhdCB0b3Agbm93LCBidXQgd2Fzbid0IGxhc3QgcG9zaXRpb25cclxuICAgIGlmICggcG9zaXRpb24ueSA9PT0gdGhpcy5ib3VuZHNQcm9wZXJ0eS52YWx1ZS50b3AgKSB7XHJcbiAgICAgIGJvcmRlcnNUb3VjaGluZy5wdXNoKCBEaXJlY3Rpb25FbnVtLlVQICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYXQgYm90dG9tIG5vdywgYnV0IHdhc24ndCBsYXN0IHBvc2l0aW9uXHJcbiAgICBpZiAoIHBvc2l0aW9uLnkgPT09IHRoaXMuYm91bmRzUHJvcGVydHkudmFsdWUuYm90dG9tICkge1xyXG4gICAgICBib3JkZXJzVG91Y2hpbmcucHVzaCggRGlyZWN0aW9uRW51bS5ET1dOICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29ybmVyIGNhc2VcclxuICAgIGlmICggYm9yZGVyc1RvdWNoaW5nLmxlbmd0aCA+IDEgKSB7XHJcbiAgICAgIGtleSA9IGtleSB8fCAnJztcclxuICAgICAgY29uc3QgcG9zc2libGVEaXJlY3Rpb24gPSBEaXJlY3Rpb25FbnVtLmtleVRvRGlyZWN0aW9uKCBrZXkgKTtcclxuXHJcbiAgICAgIC8vIGlmIHRoZSBrZXkgbWF0Y2hlcyBhIGJvcmRlciBkaXJlY3Rpb24sIHVzZSB0aGF0IGluc3RlYWQgb2YgYW5vdGhlciB3YWxsIHRoYXQgd2UgbWF5IGFsc28gYmUgdG91Y2hpbmdcclxuICAgICAgaWYgKCBwb3NzaWJsZURpcmVjdGlvbiAmJiBib3JkZXJzVG91Y2hpbmcuaW5kZXhPZiggcG9zc2libGVEaXJlY3Rpb24gKSA+PSAwICkge1xyXG4gICAgICAgIGFsZXJ0RGlyZWN0aW9uID0gcG9zc2libGVEaXJlY3Rpb247XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIG5vcm1hbCBzaW5nbGUgYm9yZGVyIGNhc2VcclxuICAgIGVsc2UgaWYgKCBib3JkZXJzVG91Y2hpbmcubGVuZ3RoID09PSAxICkge1xyXG4gICAgICBhbGVydERpcmVjdGlvbiA9IGJvcmRlcnNUb3VjaGluZ1sgMCBdO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRoZW4gd2UgYXJlIHBvdGVudGlhbGx5IGdvaW5nIHRvIGFsZXJ0XHJcbiAgICBpZiAoIGFsZXJ0RGlyZWN0aW9uICkge1xyXG4gICAgICBhc3NlcnQgJiYgYXNzZXJ0KCBEaXJlY3Rpb25FbnVtLmlzUmVsYXRpdmVEaXJlY3Rpb24oIGFsZXJ0RGlyZWN0aW9uICksIGB1bnN1cHBvcnRlZCBkaXJlY3Rpb246ICR7YWxlcnREaXJlY3Rpb259YCApO1xyXG4gICAgICBjb25zdCB1dHRlcmFuY2UgPSB0aGlzWyBhbGVydERpcmVjdGlvbiBdO1xyXG5cclxuICAgICAgLy8gTnVsbCBtZWFucyB1bnN1cHBvcnRlZCBkaXJlY3Rpb24sIG5vIGFsZXJ0IHRvIGJlIGhhZCBoZXJlLlxyXG4gICAgICBpZiAoIHV0dGVyYW5jZSApIHtcclxuICAgICAgICByZXR1cm4gdXR0ZXJhbmNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwdWJsaWNcclxuICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHBvc2l0aW9uXHJcbiAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBbZG9tRXZlbnRdIC0gd2UgZG9uJ3QgZ2V0IHRoaXMgZnJvbSBhIG1vdXNlIGRyYWcgbGlzdGVuZXJcclxuICAgKiBAcmV0dXJuc3tUQWxlcnRhYmxlfSAtIG51bGwgaWYgdGhlcmUgaXMgbm90aGluZyB0byBhbGVydFxyXG4gICAqL1xyXG4gIGdldEFsZXJ0T25FbmREcmFnKCBwb3NpdGlvbiwgZG9tRXZlbnQgKSB7XHJcbiAgICBsZXQga2V5O1xyXG4gICAgaWYgKCBkb21FdmVudCApIHtcclxuICAgICAga2V5ID0gS2V5Ym9hcmRVdGlscy5nZXRFdmVudENvZGUoIGRvbUV2ZW50ICk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZXRBbGVydEF0Qm9yZGVyKCBwb3NpdGlvbiwga2V5ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgcmVzZXQoKSB7XHJcbiAgICB0aGlzWyBEaXJlY3Rpb25FbnVtLkxFRlQgXSAmJiB0aGlzWyBEaXJlY3Rpb25FbnVtLkxFRlQgXS5yZXNldCgpO1xyXG4gICAgdGhpc1sgRGlyZWN0aW9uRW51bS5SSUdIVCBdICYmIHRoaXNbIERpcmVjdGlvbkVudW0uUklHSFQgXS5yZXNldCgpO1xyXG4gICAgdGhpc1sgRGlyZWN0aW9uRW51bS5VUCBdICYmIHRoaXNbIERpcmVjdGlvbkVudW0uVVAgXS5yZXNldCgpO1xyXG4gICAgdGhpc1sgRGlyZWN0aW9uRW51bS5ET1dOIF0gJiYgdGhpc1sgRGlyZWN0aW9uRW51bS5ET1dOIF0ucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERlZmF1bHQgdG9wIGFsZXJ0IGZvciB0aGUgYm9yZGVyIGFsZXJ0c1xyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XHJcbiAgICovXHJcbiAgc3RhdGljIGdldERlZmF1bHRUb3BBbGVydCgpIHtcclxuICAgIHJldHVybiBERUZBVUxUX1RPUF9CT1JERVJfQUxFUlQ7XHJcbiAgfVxyXG59XHJcblxyXG5zY2VuZXJ5UGhldC5yZWdpc3RlciggJ0JvcmRlckFsZXJ0c0Rlc2NyaWJlcicsIEJvcmRlckFsZXJ0c0Rlc2NyaWJlciApO1xyXG5leHBvcnQgZGVmYXVsdCBCb3JkZXJBbGVydHNEZXNjcmliZXI7Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EsUUFBUSxNQUFNLGlDQUFpQztB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