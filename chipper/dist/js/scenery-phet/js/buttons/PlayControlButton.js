// Copyright 2014-2022, University of Colorado Boulder

/**
 * A round toggle button that displays some custom icon when playing and a triangular "Play" icon when not playing.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

import optionize from '../../../phet-core/js/optionize.js';
import { Circle, globalKeyStateTracker, KeyboardUtils, Path } from '../../../scenery/js/imports.js';
import BooleanRoundToggleButton from '../../../sun/js/buttons/BooleanRoundToggleButton.js';
import pauseSoundPlayer from '../../../tambo/js/shared-sound-players/pauseSoundPlayer.js';
import playSoundPlayer from '../../../tambo/js/shared-sound-players/playSoundPlayer.js';
import PlayIconShape from '../PlayIconShape.js';
import sceneryPhet from '../sceneryPhet.js';
import SceneryPhetConstants from '../SceneryPhetConstants.js';
import SceneryPhetStrings from '../SceneryPhetStrings.js';
export default class PlayControlButton extends BooleanRoundToggleButton {
  /**
   * @param isPlayingProperty
   * @param endPlayingIcon - icon for the button when pressing it will stop play
   * @param providedOptions
   */
  constructor(isPlayingProperty, endPlayingIcon, providedOptions) {
    const options = optionize()({
      // SelfOptions
      radius: SceneryPhetConstants.PLAY_CONTROL_BUTTON_RADIUS,
      scaleFactorWhenNotPlaying: 1,
      includeGlobalHotkey: false,
      startPlayingLabel: SceneryPhetStrings.a11y.playControlButton.playStringProperty,
      endPlayingLabel: null,
      valueOffSoundPlayer: pauseSoundPlayer,
      valueOnSoundPlayer: playSoundPlayer,
      // It's dimensions are calculated dynamically based on radius below to make sure the play and pause buttons are
      // in sync.
      xMargin: 0,
      yMargin: 0
    }, providedOptions);
    assert && assert(options.scaleFactorWhenNotPlaying > 0, 'button scale factor must be greater than 0');

    // play and pause icons are sized relative to the radius
    const playWidth = options.radius * 0.8;
    const playHeight = options.radius;
    const playPath = new Path(new PlayIconShape(playWidth, playHeight), {
      fill: 'black',
      centerX: options.radius * 0.05,
      // move to right slightly since we don't want it exactly centered
      centerY: 0
    });

    // put the play and stop symbols inside circles so they have the same bounds,
    // otherwise BooleanToggleNode will re-adjust their positions relative to each other
    const playCircle = new Circle(options.radius, {
      children: [playPath]
    });
    endPlayingIcon.centerX = 0;
    endPlayingIcon.centerY = 0;
    const endPlayingCircle = new Circle(options.radius, {
      children: [endPlayingIcon]
    });
    super(isPlayingProperty, endPlayingCircle, playCircle, options);
    const isPlayingListener = (isPlaying, oldValue) => {
      // pdom - accessible name for the button
      this.innerContent = isPlaying ? options.endPlayingLabel : options.startPlayingLabel;

      // so we don't scale down the button immediately if isPlayingProperty is initially false
      const runningScale = oldValue === null ? 1 : 1 / options.scaleFactorWhenNotPlaying;
      this.scale(isPlaying ? runningScale : options.scaleFactorWhenNotPlaying);
    };
    isPlayingProperty.link(isPlayingListener);

    // a listener that toggles the isPlayingProperty with hotkey Alt+K, regardless of where focus is in the document
    let globalKeyboardListener;
    if (options.includeGlobalHotkey) {
      globalKeyboardListener = event => {
        // Only enabled if the sim supports interactive descriptions, and this Node is in the PDOM.
        if (phet.chipper.queryParameters.supportsInteractiveDescription && this.pdomDisplayed && this.buttonModel.enabledProperty.get() && globalKeyStateTracker.altKeyDown && KeyboardUtils.isKeyEvent(event, KeyboardUtils.KEY_K)) {
          isPlayingProperty.set(!isPlayingProperty.get());
          const soundPlayer = isPlayingProperty.get() ? options.valueOnSoundPlayer : options.valueOffSoundPlayer;
          if (soundPlayer) {
            soundPlayer.play();
          }
        }
      };
      globalKeyStateTracker.keyupEmitter.addListener(globalKeyboardListener);
    } else {
      globalKeyboardListener = null;
    }
    this.disposePlayStopButton = () => {
      if (isPlayingProperty.hasListener(isPlayingListener)) {
        isPlayingProperty.unlink(isPlayingListener);
      }
      if (globalKeyboardListener && globalKeyStateTracker.keyupEmitter.hasListener(globalKeyboardListener)) {
        globalKeyStateTracker.keyupEmitter.removeListener(globalKeyboardListener);
      }
    };
  }
  dispose() {
    this.disposePlayStopButton();
    super.dispose();
  }
}
sceneryPhet.register('PlayControlButton', PlayControlButton);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcHRpb25pemUiLCJDaXJjbGUiLCJnbG9iYWxLZXlTdGF0ZVRyYWNrZXIiLCJLZXlib2FyZFV0aWxzIiwiUGF0aCIsIkJvb2xlYW5Sb3VuZFRvZ2dsZUJ1dHRvbiIsInBhdXNlU291bmRQbGF5ZXIiLCJwbGF5U291bmRQbGF5ZXIiLCJQbGF5SWNvblNoYXBlIiwic2NlbmVyeVBoZXQiLCJTY2VuZXJ5UGhldENvbnN0YW50cyIsIlNjZW5lcnlQaGV0U3RyaW5ncyIsIlBsYXlDb250cm9sQnV0dG9uIiwiY29uc3RydWN0b3IiLCJpc1BsYXlpbmdQcm9wZXJ0eSIsImVuZFBsYXlpbmdJY29uIiwicHJvdmlkZWRPcHRpb25zIiwib3B0aW9ucyIsInJhZGl1cyIsIlBMQVlfQ09OVFJPTF9CVVRUT05fUkFESVVTIiwic2NhbGVGYWN0b3JXaGVuTm90UGxheWluZyIsImluY2x1ZGVHbG9iYWxIb3RrZXkiLCJzdGFydFBsYXlpbmdMYWJlbCIsImExMXkiLCJwbGF5Q29udHJvbEJ1dHRvbiIsInBsYXlTdHJpbmdQcm9wZXJ0eSIsImVuZFBsYXlpbmdMYWJlbCIsInZhbHVlT2ZmU291bmRQbGF5ZXIiLCJ2YWx1ZU9uU291bmRQbGF5ZXIiLCJ4TWFyZ2luIiwieU1hcmdpbiIsImFzc2VydCIsInBsYXlXaWR0aCIsInBsYXlIZWlnaHQiLCJwbGF5UGF0aCIsImZpbGwiLCJjZW50ZXJYIiwiY2VudGVyWSIsInBsYXlDaXJjbGUiLCJjaGlsZHJlbiIsImVuZFBsYXlpbmdDaXJjbGUiLCJpc1BsYXlpbmdMaXN0ZW5lciIsImlzUGxheWluZyIsIm9sZFZhbHVlIiwiaW5uZXJDb250ZW50IiwicnVubmluZ1NjYWxlIiwic2NhbGUiLCJsaW5rIiwiZ2xvYmFsS2V5Ym9hcmRMaXN0ZW5lciIsImV2ZW50IiwicGhldCIsImNoaXBwZXIiLCJxdWVyeVBhcmFtZXRlcnMiLCJzdXBwb3J0c0ludGVyYWN0aXZlRGVzY3JpcHRpb24iLCJwZG9tRGlzcGxheWVkIiwiYnV0dG9uTW9kZWwiLCJlbmFibGVkUHJvcGVydHkiLCJnZXQiLCJhbHRLZXlEb3duIiwiaXNLZXlFdmVudCIsIktFWV9LIiwic2V0Iiwic291bmRQbGF5ZXIiLCJwbGF5Iiwia2V5dXBFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJkaXNwb3NlUGxheVN0b3BCdXR0b24iLCJoYXNMaXN0ZW5lciIsInVubGluayIsInJlbW92ZUxpc3RlbmVyIiwiZGlzcG9zZSIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiUGxheUNvbnRyb2xCdXR0b24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTQtMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogQSByb3VuZCB0b2dnbGUgYnV0dG9uIHRoYXQgZGlzcGxheXMgc29tZSBjdXN0b20gaWNvbiB3aGVuIHBsYXlpbmcgYW5kIGEgdHJpYW5ndWxhciBcIlBsYXlcIiBpY29uIHdoZW4gbm90IHBsYXlpbmcuXHJcbiAqXHJcbiAqIEBhdXRob3IgU2FtIFJlaWQgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqIEBhdXRob3IgSmVzc2UgR3JlZW5iZXJnIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IG9wdGlvbml6ZSBmcm9tICcuLi8uLi8uLi9waGV0LWNvcmUvanMvb3B0aW9uaXplLmpzJztcclxuaW1wb3J0IHsgQ2lyY2xlLCBnbG9iYWxLZXlTdGF0ZVRyYWNrZXIsIEtleWJvYXJkVXRpbHMsIE5vZGUsIFBhdGgsIFBET01WYWx1ZVR5cGUgfSBmcm9tICcuLi8uLi8uLi9zY2VuZXJ5L2pzL2ltcG9ydHMuanMnO1xyXG5pbXBvcnQgQm9vbGVhblJvdW5kVG9nZ2xlQnV0dG9uLCB7IEJvb2xlYW5Sb3VuZFRvZ2dsZUJ1dHRvbk9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi9zdW4vanMvYnV0dG9ucy9Cb29sZWFuUm91bmRUb2dnbGVCdXR0b24uanMnO1xyXG5pbXBvcnQgVFNvdW5kUGxheWVyIGZyb20gJy4uLy4uLy4uL3RhbWJvL2pzL1RTb3VuZFBsYXllci5qcyc7XHJcbmltcG9ydCBwYXVzZVNvdW5kUGxheWVyIGZyb20gJy4uLy4uLy4uL3RhbWJvL2pzL3NoYXJlZC1zb3VuZC1wbGF5ZXJzL3BhdXNlU291bmRQbGF5ZXIuanMnO1xyXG5pbXBvcnQgcGxheVNvdW5kUGxheWVyIGZyb20gJy4uLy4uLy4uL3RhbWJvL2pzL3NoYXJlZC1zb3VuZC1wbGF5ZXJzL3BsYXlTb3VuZFBsYXllci5qcyc7XHJcbmltcG9ydCBQbGF5SWNvblNoYXBlIGZyb20gJy4uL1BsYXlJY29uU2hhcGUuanMnO1xyXG5pbXBvcnQgc2NlbmVyeVBoZXQgZnJvbSAnLi4vc2NlbmVyeVBoZXQuanMnO1xyXG5pbXBvcnQgU2NlbmVyeVBoZXRDb25zdGFudHMgZnJvbSAnLi4vU2NlbmVyeVBoZXRDb25zdGFudHMuanMnO1xyXG5pbXBvcnQgU2NlbmVyeVBoZXRTdHJpbmdzIGZyb20gJy4uL1NjZW5lcnlQaGV0U3RyaW5ncy5qcyc7XHJcblxyXG50eXBlIFNlbGZPcHRpb25zID0ge1xyXG5cclxuICByYWRpdXM/OiBudW1iZXI7XHJcblxyXG4gIC8vIHtTY2FsZSBmYWN0b3IgYXBwbGllZCB0byB0aGUgYnV0dG9uIHdoZW4gdGhlIFwiUGxheVwiIGJ1dHRvbiBpcyBzaG93biAoaXNQbGF5aW5nUHJvcGVydHkgaXMgZmFsc2UpLlxyXG4gIC8vIFBoRVQgY29udmVudGlvbiBpcyB0byBpbmNyZWFzZSB0aGUgc2l6ZSBvZiB0aGUgXCJQbGF5XCIgYnV0dG9uIHdoZW4gaW50ZXJhY3Rpb24gd2l0aCB0aGUgc2ltIGRvZXMgTk9UIHVucGF1c2UgdGhlIHNpbS5cclxuICBzY2FsZUZhY3RvcldoZW5Ob3RQbGF5aW5nPzogbnVtYmVyO1xyXG5cclxuICAvLyBwZG9tOiBJZiB0cnVlLCBsaXN0ZW5lciBpcyBhZGRlZCB0byB0b2dnbGUgaXNQbGF5aW5nUHJvcGVydHkgd2l0aCBrZXkgY29tbWFuZCBcImFsdCArIGtcIiByZWdhcmRsZXNzXHJcbiAgLy8gb2Ygd2hlcmUgZm9jdXMgaXMgaW4gdGhlIGRvY3VtZW50LlxyXG4gIGluY2x1ZGVHbG9iYWxIb3RrZXk/OiBib29sZWFuO1xyXG5cclxuICAvLyBMYWJlbCBmb3IgdGhlIGJ1dHRvbiBpbiB0aGUgUERPTSB3aGVuIHRoZSBidXR0b24gd2lsbCBzZXQgaXNQbGF5aW5nUHJvcGVydHkgdG8gdHJ1ZVxyXG4gIHN0YXJ0UGxheWluZ0xhYmVsPzogUERPTVZhbHVlVHlwZTtcclxuXHJcbiAgLy8gTGFiZWwgZm9yIHRoZSBidXR0b24gaW4gdGhlIFBET00gd2hlbiB0aGUgYnV0dG9uIHdpbGwgc2V0IGlzUGxheWluZ1Byb3BlcnR5IHRvIGZhbHNlXHJcbiAgZW5kUGxheWluZ0xhYmVsPzogUERPTVZhbHVlVHlwZSB8IG51bGw7XHJcblxyXG4gIC8vIHNvdW5kIGdlbmVyYXRpb25cclxuICB2YWx1ZU9mZlNvdW5kUGxheWVyPzogVFNvdW5kUGxheWVyO1xyXG4gIHZhbHVlT25Tb3VuZFBsYXllcj86IFRTb3VuZFBsYXllcjtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFBsYXlDb250cm9sQnV0dG9uT3B0aW9ucyA9IFNlbGZPcHRpb25zICYgQm9vbGVhblJvdW5kVG9nZ2xlQnV0dG9uT3B0aW9ucztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBsYXlDb250cm9sQnV0dG9uIGV4dGVuZHMgQm9vbGVhblJvdW5kVG9nZ2xlQnV0dG9uIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXNwb3NlUGxheVN0b3BCdXR0b246ICgpID0+IHZvaWQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBpc1BsYXlpbmdQcm9wZXJ0eVxyXG4gICAqIEBwYXJhbSBlbmRQbGF5aW5nSWNvbiAtIGljb24gZm9yIHRoZSBidXR0b24gd2hlbiBwcmVzc2luZyBpdCB3aWxsIHN0b3AgcGxheVxyXG4gICAqIEBwYXJhbSBwcm92aWRlZE9wdGlvbnNcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoIGlzUGxheWluZ1Byb3BlcnR5OiBQcm9wZXJ0eTxib29sZWFuPiwgZW5kUGxheWluZ0ljb246IE5vZGUsIHByb3ZpZGVkT3B0aW9ucz86IFBsYXlDb250cm9sQnV0dG9uT3B0aW9ucyApIHtcclxuXHJcbiAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uaXplPFBsYXlDb250cm9sQnV0dG9uT3B0aW9ucywgU2VsZk9wdGlvbnMsIEJvb2xlYW5Sb3VuZFRvZ2dsZUJ1dHRvbk9wdGlvbnM+KCkoIHtcclxuXHJcbiAgICAgIC8vIFNlbGZPcHRpb25zXHJcbiAgICAgIHJhZGl1czogU2NlbmVyeVBoZXRDb25zdGFudHMuUExBWV9DT05UUk9MX0JVVFRPTl9SQURJVVMsXHJcbiAgICAgIHNjYWxlRmFjdG9yV2hlbk5vdFBsYXlpbmc6IDEsXHJcbiAgICAgIGluY2x1ZGVHbG9iYWxIb3RrZXk6IGZhbHNlLFxyXG4gICAgICBzdGFydFBsYXlpbmdMYWJlbDogU2NlbmVyeVBoZXRTdHJpbmdzLmExMXkucGxheUNvbnRyb2xCdXR0b24ucGxheVN0cmluZ1Byb3BlcnR5LFxyXG4gICAgICBlbmRQbGF5aW5nTGFiZWw6IG51bGwsXHJcbiAgICAgIHZhbHVlT2ZmU291bmRQbGF5ZXI6IHBhdXNlU291bmRQbGF5ZXIsXHJcbiAgICAgIHZhbHVlT25Tb3VuZFBsYXllcjogcGxheVNvdW5kUGxheWVyLFxyXG5cclxuICAgICAgLy8gSXQncyBkaW1lbnNpb25zIGFyZSBjYWxjdWxhdGVkIGR5bmFtaWNhbGx5IGJhc2VkIG9uIHJhZGl1cyBiZWxvdyB0byBtYWtlIHN1cmUgdGhlIHBsYXkgYW5kIHBhdXNlIGJ1dHRvbnMgYXJlXHJcbiAgICAgIC8vIGluIHN5bmMuXHJcbiAgICAgIHhNYXJnaW46IDAsXHJcbiAgICAgIHlNYXJnaW46IDBcclxuXHJcbiAgICB9LCBwcm92aWRlZE9wdGlvbnMgKTtcclxuXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBvcHRpb25zLnNjYWxlRmFjdG9yV2hlbk5vdFBsYXlpbmcgPiAwLCAnYnV0dG9uIHNjYWxlIGZhY3RvciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyApO1xyXG5cclxuICAgIC8vIHBsYXkgYW5kIHBhdXNlIGljb25zIGFyZSBzaXplZCByZWxhdGl2ZSB0byB0aGUgcmFkaXVzXHJcbiAgICBjb25zdCBwbGF5V2lkdGggPSBvcHRpb25zLnJhZGl1cyAqIDAuODtcclxuICAgIGNvbnN0IHBsYXlIZWlnaHQgPSBvcHRpb25zLnJhZGl1cztcclxuXHJcbiAgICBjb25zdCBwbGF5UGF0aCA9IG5ldyBQYXRoKCBuZXcgUGxheUljb25TaGFwZSggcGxheVdpZHRoLCBwbGF5SGVpZ2h0ICksIHtcclxuICAgICAgZmlsbDogJ2JsYWNrJyxcclxuICAgICAgY2VudGVyWDogb3B0aW9ucy5yYWRpdXMgKiAwLjA1LCAvLyBtb3ZlIHRvIHJpZ2h0IHNsaWdodGx5IHNpbmNlIHdlIGRvbid0IHdhbnQgaXQgZXhhY3RseSBjZW50ZXJlZFxyXG4gICAgICBjZW50ZXJZOiAwXHJcbiAgICB9ICk7XHJcblxyXG4gICAgLy8gcHV0IHRoZSBwbGF5IGFuZCBzdG9wIHN5bWJvbHMgaW5zaWRlIGNpcmNsZXMgc28gdGhleSBoYXZlIHRoZSBzYW1lIGJvdW5kcyxcclxuICAgIC8vIG90aGVyd2lzZSBCb29sZWFuVG9nZ2xlTm9kZSB3aWxsIHJlLWFkanVzdCB0aGVpciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gZWFjaCBvdGhlclxyXG4gICAgY29uc3QgcGxheUNpcmNsZSA9IG5ldyBDaXJjbGUoIG9wdGlvbnMucmFkaXVzLCB7XHJcbiAgICAgIGNoaWxkcmVuOiBbIHBsYXlQYXRoIF1cclxuICAgIH0gKTtcclxuXHJcbiAgICBlbmRQbGF5aW5nSWNvbi5jZW50ZXJYID0gMDtcclxuICAgIGVuZFBsYXlpbmdJY29uLmNlbnRlclkgPSAwO1xyXG5cclxuICAgIGNvbnN0IGVuZFBsYXlpbmdDaXJjbGUgPSBuZXcgQ2lyY2xlKCBvcHRpb25zLnJhZGl1cywge1xyXG4gICAgICBjaGlsZHJlbjogWyBlbmRQbGF5aW5nSWNvbiBdXHJcbiAgICB9ICk7XHJcblxyXG4gICAgc3VwZXIoIGlzUGxheWluZ1Byb3BlcnR5LCBlbmRQbGF5aW5nQ2lyY2xlLCBwbGF5Q2lyY2xlLCBvcHRpb25zICk7XHJcblxyXG4gICAgY29uc3QgaXNQbGF5aW5nTGlzdGVuZXIgPSAoIGlzUGxheWluZzogYm9vbGVhbiwgb2xkVmFsdWU6IGJvb2xlYW4gfCBudWxsICkgPT4ge1xyXG5cclxuICAgICAgLy8gcGRvbSAtIGFjY2Vzc2libGUgbmFtZSBmb3IgdGhlIGJ1dHRvblxyXG4gICAgICB0aGlzLmlubmVyQ29udGVudCA9IGlzUGxheWluZyA/IG9wdGlvbnMuZW5kUGxheWluZ0xhYmVsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogb3B0aW9ucy5zdGFydFBsYXlpbmdMYWJlbDtcclxuXHJcbiAgICAgIC8vIHNvIHdlIGRvbid0IHNjYWxlIGRvd24gdGhlIGJ1dHRvbiBpbW1lZGlhdGVseSBpZiBpc1BsYXlpbmdQcm9wZXJ0eSBpcyBpbml0aWFsbHkgZmFsc2VcclxuICAgICAgY29uc3QgcnVubmluZ1NjYWxlID0gb2xkVmFsdWUgPT09IG51bGwgPyAxIDogMSAvIG9wdGlvbnMuc2NhbGVGYWN0b3JXaGVuTm90UGxheWluZztcclxuICAgICAgdGhpcy5zY2FsZSggaXNQbGF5aW5nID8gcnVubmluZ1NjYWxlIDogb3B0aW9ucy5zY2FsZUZhY3RvcldoZW5Ob3RQbGF5aW5nICk7XHJcbiAgICB9O1xyXG4gICAgaXNQbGF5aW5nUHJvcGVydHkubGluayggaXNQbGF5aW5nTGlzdGVuZXIgKTtcclxuXHJcbiAgICAvLyBhIGxpc3RlbmVyIHRoYXQgdG9nZ2xlcyB0aGUgaXNQbGF5aW5nUHJvcGVydHkgd2l0aCBob3RrZXkgQWx0K0ssIHJlZ2FyZGxlc3Mgb2Ygd2hlcmUgZm9jdXMgaXMgaW4gdGhlIGRvY3VtZW50XHJcbiAgICBsZXQgZ2xvYmFsS2V5Ym9hcmRMaXN0ZW5lcjogKCAoIGV2ZW50OiBLZXlib2FyZEV2ZW50ICkgPT4gdm9pZCApIHwgbnVsbDtcclxuICAgIGlmICggb3B0aW9ucy5pbmNsdWRlR2xvYmFsSG90a2V5ICkge1xyXG4gICAgICBnbG9iYWxLZXlib2FyZExpc3RlbmVyID0gKCBldmVudDogS2V5Ym9hcmRFdmVudCApID0+IHtcclxuXHJcbiAgICAgICAgLy8gT25seSBlbmFibGVkIGlmIHRoZSBzaW0gc3VwcG9ydHMgaW50ZXJhY3RpdmUgZGVzY3JpcHRpb25zLCBhbmQgdGhpcyBOb2RlIGlzIGluIHRoZSBQRE9NLlxyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIHBoZXQuY2hpcHBlci5xdWVyeVBhcmFtZXRlcnMuc3VwcG9ydHNJbnRlcmFjdGl2ZURlc2NyaXB0aW9uICYmXHJcbiAgICAgICAgICB0aGlzLnBkb21EaXNwbGF5ZWQgJiZcclxuICAgICAgICAgIHRoaXMuYnV0dG9uTW9kZWwuZW5hYmxlZFByb3BlcnR5LmdldCgpICYmXHJcbiAgICAgICAgICBnbG9iYWxLZXlTdGF0ZVRyYWNrZXIuYWx0S2V5RG93biAmJlxyXG4gICAgICAgICAgS2V5Ym9hcmRVdGlscy5pc0tleUV2ZW50KCBldmVudCwgS2V5Ym9hcmRVdGlscy5LRVlfSyApXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICBpc1BsYXlpbmdQcm9wZXJ0eS5zZXQoICFpc1BsYXlpbmdQcm9wZXJ0eS5nZXQoKSApO1xyXG5cclxuICAgICAgICAgIGNvbnN0IHNvdW5kUGxheWVyID0gaXNQbGF5aW5nUHJvcGVydHkuZ2V0KCkgPyBvcHRpb25zLnZhbHVlT25Tb3VuZFBsYXllciA6IG9wdGlvbnMudmFsdWVPZmZTb3VuZFBsYXllcjtcclxuICAgICAgICAgIGlmICggc291bmRQbGF5ZXIgKSB7IHNvdW5kUGxheWVyLnBsYXkoKTsgfVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgZ2xvYmFsS2V5U3RhdGVUcmFja2VyLmtleXVwRW1pdHRlci5hZGRMaXN0ZW5lciggZ2xvYmFsS2V5Ym9hcmRMaXN0ZW5lciApO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGdsb2JhbEtleWJvYXJkTGlzdGVuZXIgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZGlzcG9zZVBsYXlTdG9wQnV0dG9uID0gKCkgPT4ge1xyXG4gICAgICBpZiAoIGlzUGxheWluZ1Byb3BlcnR5Lmhhc0xpc3RlbmVyKCBpc1BsYXlpbmdMaXN0ZW5lciApICkge1xyXG4gICAgICAgIGlzUGxheWluZ1Byb3BlcnR5LnVubGluayggaXNQbGF5aW5nTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIGdsb2JhbEtleWJvYXJkTGlzdGVuZXIgJiYgZ2xvYmFsS2V5U3RhdGVUcmFja2VyLmtleXVwRW1pdHRlci5oYXNMaXN0ZW5lciggZ2xvYmFsS2V5Ym9hcmRMaXN0ZW5lciApICkge1xyXG4gICAgICAgIGdsb2JhbEtleVN0YXRlVHJhY2tlci5rZXl1cEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoIGdsb2JhbEtleWJvYXJkTGlzdGVuZXIgKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvdmVycmlkZSBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlUGxheVN0b3BCdXR0b24oKTtcclxuICAgIHN1cGVyLmRpc3Bvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbnNjZW5lcnlQaGV0LnJlZ2lzdGVyKCAnUGxheUNvbnRyb2xCdXR0b24nLCBQbGF5Q29udHJvbEJ1dHRvbiApOyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBLE9BQU9BLFNBQVMsTUFBTSxvQ0FBb0M7QUFDMUQsU0FBU0MsTUFBTSxFQUFFQyxxQkFBcUIsRUFBRUMsYUFBYSxFQUFRQyxJQUFJLFFBQXVCLGdDQUFnQztBQUN4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