// Copyright 2019-2022, University of Colorado Boulder

/**
 * Visual representation of the effective E-field (E_effective) between the capacitor plates.
 *
 * @author Chris Malley (PixelZoom, Inc.)
 * @author Emily Randall (PhET Interactive Simulations)
 * @author Jesse Greenberg (PhET Interactive Simulations)
 */

//modules
import Multilink from '../../../axon/js/Multilink.js';
import Dimension2 from '../../../dot/js/Dimension2.js';
import EnumerationDeprecated from '../../../phet-core/js/EnumerationDeprecated.js';
import { CanvasNode } from '../../../scenery/js/imports.js';
import sceneryPhet from '../sceneryPhet.js';

// constants
const ARROW_SIZE = new Dimension2(6, 7);
const LINE_WIDTH = 1;
const ARROW_COLOR = 'black';
const ArrowDirection = EnumerationDeprecated.byKeys(['UP', 'DOWN']);

// determines spacing of electric field lines, chosen by inspection to match spacing from Java
const SPACING_CONSTANT = 0.0258;

/**
 * Draw one EField line with the provided parameters using HTML5 Canvas
 *
 * @param {Vector2} position - origin, at the center of the line
 * @param {number} length length of the line in view coordinates
 * @param {string} direction
 * @param {CanvasRenderingContext2D} context
 */
const drawEFieldLine = (position, length, direction, context) => {
  // line, origin at center
  context.moveTo(position.x, position.y - length / 2 - 3);
  context.lineTo(position.x, position.y + length / 2 - 3);

  // pull out for readability
  const w = ARROW_SIZE.width;
  const h = ARROW_SIZE.height;

  // make sure that the arrow path is centered along the field line.
  // dividing by 4 aligns better than dividing by 2 for the narrow line width.
  const xOffset = LINE_WIDTH / 4;
  const arrowCenter = direction === ArrowDirection.UP ? position.x - xOffset : position.x + xOffset;

  // path for the UP arrow
  if (direction === ArrowDirection.UP) {
    context.moveTo(arrowCenter, position.y - h / 2);
    context.lineTo(arrowCenter + w / 2, position.y + h / 2);
    context.lineTo(arrowCenter - w / 2, position.y + h / 2);
  }

  // path for the DOWN arrow
  else if (direction === ArrowDirection.DOWN) {
    context.moveTo(arrowCenter, position.y + h / 2);
    context.lineTo(arrowCenter - w / 2, position.y - h / 2);
    context.lineTo(arrowCenter + w / 2, position.y - h / 2);
  } else {
    assert && assert(false, 'EFieldLine must be of orientation UP or DOWN');
  }
};
class EFieldNode extends CanvasNode {
  /**
   * @param {Capacitor} capacitor
   * @param {YawPitchModelViewTransform3} modelViewTransform
   * @param {number} maxEffectiveEField
   * @param {Bounds2} canvasBounds
   */
  constructor(capacitor, modelViewTransform, maxEffectiveEField, canvasBounds) {
    super({
      canvasBounds: canvasBounds
    });
    const self = this;

    // @private
    this.capacitor = capacitor;
    this.modelViewTransform = modelViewTransform;
    this.maxEffectiveEField = maxEffectiveEField;
    Multilink.multilink([capacitor.plateSizeProperty, capacitor.plateSeparationProperty, capacitor.plateVoltageProperty], () => {
      if (self.isVisible()) {
        self.invalidatePaint();
      }
    });

    // Update when this Node becomes visible.
    this.visibleProperty.link(visible => visible && this.invalidatePaint());
  }

  /**
   * Rendering
   * @public
   *
   * @param {CanvasRenderingContext2D} context
   */
  paintCanvas(context) {
    // compute density (spacing) of field lines
    const effectiveEField = this.capacitor.getEffectiveEField();
    const lineSpacing = this.getLineSpacing(effectiveEField);
    if (lineSpacing > 0) {
      context.beginPath();

      // relevant model values
      const plateWidth = this.capacitor.plateSizeProperty.value.width;
      const plateDepth = plateWidth;
      const plateSeparation = this.capacitor.plateSeparationProperty.value;

      /*
       * Create field lines, working from the center outwards so that lines appear/disappear at edges of plate as
       * E_effective changes.
       */
      const length = this.modelViewTransform.modelToViewDeltaXYZ(0, plateSeparation, 0).y;
      const direction = effectiveEField >= 0 ? ArrowDirection.DOWN : ArrowDirection.UP;
      let x = lineSpacing / 2;
      while (x <= plateWidth / 2) {
        let z = lineSpacing / 2;
        while (z <= plateDepth / 2) {
          // calculate position for the lines
          const y = 0;
          const line0Translation = this.modelViewTransform.modelToViewXYZ(x, y, z);
          const line1Translation = this.modelViewTransform.modelToViewXYZ(-x, y, z);
          const line2Translation = this.modelViewTransform.modelToViewXYZ(x, y, -z);
          const line3Translation = this.modelViewTransform.modelToViewXYZ(-x, y, -z);

          // add 4 lines, one for each quadrant
          drawEFieldLine(line0Translation, length, direction, context);
          drawEFieldLine(line1Translation, length, direction, context);
          drawEFieldLine(line2Translation, length, direction, context);
          drawEFieldLine(line3Translation, length, direction, context);
          z += lineSpacing;
        }
        x += lineSpacing;
      }
      // stroke the whole path
      context.strokeStyle = ARROW_COLOR;
      context.fillStyle = ARROW_COLOR;
      context.lineWidth = LINE_WIDTH;
      context.fill();
      context.stroke();
    }
  }

  /**
   * Gets the spacing of E-field lines. Higher E-field results in higher density,
   * therefore lower spacing. Density is computed for the minimum plate size.
   * @public
   *
   * @param {number} effectiveEField
   * @returns {number} spacing, in model coordinates
   */
  getLineSpacing(effectiveEField) {
    if (effectiveEField === 0) {
      return 0;
    } else {
      // sqrt looks best for a square plate
      return SPACING_CONSTANT / Math.sqrt(Math.abs(effectiveEField));
    }
  }
}
sceneryPhet.register('EFieldNode', EFieldNode);
export default EFieldNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNdWx0aWxpbmsiLCJEaW1lbnNpb24yIiwiRW51bWVyYXRpb25EZXByZWNhdGVkIiwiQ2FudmFzTm9kZSIsInNjZW5lcnlQaGV0IiwiQVJST1dfU0laRSIsIkxJTkVfV0lEVEgiLCJBUlJPV19DT0xPUiIsIkFycm93RGlyZWN0aW9uIiwiYnlLZXlzIiwiU1BBQ0lOR19DT05TVEFOVCIsImRyYXdFRmllbGRMaW5lIiwicG9zaXRpb24iLCJsZW5ndGgiLCJkaXJlY3Rpb24iLCJjb250ZXh0IiwibW92ZVRvIiwieCIsInkiLCJsaW5lVG8iLCJ3Iiwid2lkdGgiLCJoIiwiaGVpZ2h0IiwieE9mZnNldCIsImFycm93Q2VudGVyIiwiVVAiLCJET1dOIiwiYXNzZXJ0IiwiRUZpZWxkTm9kZSIsImNvbnN0cnVjdG9yIiwiY2FwYWNpdG9yIiwibW9kZWxWaWV3VHJhbnNmb3JtIiwibWF4RWZmZWN0aXZlRUZpZWxkIiwiY2FudmFzQm91bmRzIiwic2VsZiIsIm11bHRpbGluayIsInBsYXRlU2l6ZVByb3BlcnR5IiwicGxhdGVTZXBhcmF0aW9uUHJvcGVydHkiLCJwbGF0ZVZvbHRhZ2VQcm9wZXJ0eSIsImlzVmlzaWJsZSIsImludmFsaWRhdGVQYWludCIsInZpc2libGVQcm9wZXJ0eSIsImxpbmsiLCJ2aXNpYmxlIiwicGFpbnRDYW52YXMiLCJlZmZlY3RpdmVFRmllbGQiLCJnZXRFZmZlY3RpdmVFRmllbGQiLCJsaW5lU3BhY2luZyIsImdldExpbmVTcGFjaW5nIiwiYmVnaW5QYXRoIiwicGxhdGVXaWR0aCIsInZhbHVlIiwicGxhdGVEZXB0aCIsInBsYXRlU2VwYXJhdGlvbiIsIm1vZGVsVG9WaWV3RGVsdGFYWVoiLCJ6IiwibGluZTBUcmFuc2xhdGlvbiIsIm1vZGVsVG9WaWV3WFlaIiwibGluZTFUcmFuc2xhdGlvbiIsImxpbmUyVHJhbnNsYXRpb24iLCJsaW5lM1RyYW5zbGF0aW9uIiwic3Ryb2tlU3R5bGUiLCJmaWxsU3R5bGUiLCJsaW5lV2lkdGgiLCJmaWxsIiwic3Ryb2tlIiwiTWF0aCIsInNxcnQiLCJhYnMiLCJyZWdpc3RlciJdLCJzb3VyY2VzIjpbIkVGaWVsZE5vZGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTktMjAyMiwgVW5pdmVyc2l0eSBvZiBDb2xvcmFkbyBCb3VsZGVyXHJcblxyXG4vKipcclxuICogVmlzdWFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlZmZlY3RpdmUgRS1maWVsZCAoRV9lZmZlY3RpdmUpIGJldHdlZW4gdGhlIGNhcGFjaXRvciBwbGF0ZXMuXHJcbiAqXHJcbiAqIEBhdXRob3IgQ2hyaXMgTWFsbGV5IChQaXhlbFpvb20sIEluYy4pXHJcbiAqIEBhdXRob3IgRW1pbHkgUmFuZGFsbCAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICogQGF1dGhvciBKZXNzZSBHcmVlbmJlcmcgKFBoRVQgSW50ZXJhY3RpdmUgU2ltdWxhdGlvbnMpXHJcbiAqL1xyXG5cclxuXHJcbi8vbW9kdWxlc1xyXG5pbXBvcnQgTXVsdGlsaW5rIGZyb20gJy4uLy4uLy4uL2F4b24vanMvTXVsdGlsaW5rLmpzJztcclxuaW1wb3J0IERpbWVuc2lvbjIgZnJvbSAnLi4vLi4vLi4vZG90L2pzL0RpbWVuc2lvbjIuanMnO1xyXG5pbXBvcnQgRW51bWVyYXRpb25EZXByZWNhdGVkIGZyb20gJy4uLy4uLy4uL3BoZXQtY29yZS9qcy9FbnVtZXJhdGlvbkRlcHJlY2F0ZWQuanMnO1xyXG5pbXBvcnQgeyBDYW52YXNOb2RlIH0gZnJvbSAnLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IHNjZW5lcnlQaGV0IGZyb20gJy4uL3NjZW5lcnlQaGV0LmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBBUlJPV19TSVpFID0gbmV3IERpbWVuc2lvbjIoIDYsIDcgKTtcclxuY29uc3QgTElORV9XSURUSCA9IDE7XHJcbmNvbnN0IEFSUk9XX0NPTE9SID0gJ2JsYWNrJztcclxuY29uc3QgQXJyb3dEaXJlY3Rpb24gPSBFbnVtZXJhdGlvbkRlcHJlY2F0ZWQuYnlLZXlzKCBbICdVUCcsICdET1dOJyBdICk7XHJcblxyXG4vLyBkZXRlcm1pbmVzIHNwYWNpbmcgb2YgZWxlY3RyaWMgZmllbGQgbGluZXMsIGNob3NlbiBieSBpbnNwZWN0aW9uIHRvIG1hdGNoIHNwYWNpbmcgZnJvbSBKYXZhXHJcbmNvbnN0IFNQQUNJTkdfQ09OU1RBTlQgPSAwLjAyNTg7XHJcblxyXG4vKipcclxuICogRHJhdyBvbmUgRUZpZWxkIGxpbmUgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycyB1c2luZyBIVE1MNSBDYW52YXNcclxuICpcclxuICogQHBhcmFtIHtWZWN0b3IyfSBwb3NpdGlvbiAtIG9yaWdpbiwgYXQgdGhlIGNlbnRlciBvZiB0aGUgbGluZVxyXG4gKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIGxlbmd0aCBvZiB0aGUgbGluZSBpbiB2aWV3IGNvb3JkaW5hdGVzXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBkaXJlY3Rpb25cclxuICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHRcclxuICovXHJcbmNvbnN0IGRyYXdFRmllbGRMaW5lID0gKCBwb3NpdGlvbiwgbGVuZ3RoLCBkaXJlY3Rpb24sIGNvbnRleHQgKSA9PiB7XHJcblxyXG4gIC8vIGxpbmUsIG9yaWdpbiBhdCBjZW50ZXJcclxuICBjb250ZXh0Lm1vdmVUbyggcG9zaXRpb24ueCwgcG9zaXRpb24ueSAtIGxlbmd0aCAvIDIgLSAzICk7XHJcbiAgY29udGV4dC5saW5lVG8oIHBvc2l0aW9uLngsIHBvc2l0aW9uLnkgKyBsZW5ndGggLyAyIC0gMyApO1xyXG5cclxuICAvLyBwdWxsIG91dCBmb3IgcmVhZGFiaWxpdHlcclxuICBjb25zdCB3ID0gQVJST1dfU0laRS53aWR0aDtcclxuICBjb25zdCBoID0gQVJST1dfU0laRS5oZWlnaHQ7XHJcblxyXG4gIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBhcnJvdyBwYXRoIGlzIGNlbnRlcmVkIGFsb25nIHRoZSBmaWVsZCBsaW5lLlxyXG4gIC8vIGRpdmlkaW5nIGJ5IDQgYWxpZ25zIGJldHRlciB0aGFuIGRpdmlkaW5nIGJ5IDIgZm9yIHRoZSBuYXJyb3cgbGluZSB3aWR0aC5cclxuICBjb25zdCB4T2Zmc2V0ID0gTElORV9XSURUSCAvIDQ7XHJcbiAgY29uc3QgYXJyb3dDZW50ZXIgPSBkaXJlY3Rpb24gPT09IEFycm93RGlyZWN0aW9uLlVQID8gcG9zaXRpb24ueCAtIHhPZmZzZXQgOiBwb3NpdGlvbi54ICsgeE9mZnNldDtcclxuXHJcbiAgLy8gcGF0aCBmb3IgdGhlIFVQIGFycm93XHJcbiAgaWYgKCBkaXJlY3Rpb24gPT09IEFycm93RGlyZWN0aW9uLlVQICkge1xyXG4gICAgY29udGV4dC5tb3ZlVG8oIGFycm93Q2VudGVyLCBwb3NpdGlvbi55IC0gaCAvIDIgKTtcclxuICAgIGNvbnRleHQubGluZVRvKCBhcnJvd0NlbnRlciArIHcgLyAyLCBwb3NpdGlvbi55ICsgaCAvIDIgKTtcclxuICAgIGNvbnRleHQubGluZVRvKCBhcnJvd0NlbnRlciAtIHcgLyAyLCBwb3NpdGlvbi55ICsgaCAvIDIgKTtcclxuICB9XHJcblxyXG4gIC8vIHBhdGggZm9yIHRoZSBET1dOIGFycm93XHJcbiAgZWxzZSBpZiAoIGRpcmVjdGlvbiA9PT0gQXJyb3dEaXJlY3Rpb24uRE9XTiApIHtcclxuICAgIGNvbnRleHQubW92ZVRvKCBhcnJvd0NlbnRlciwgcG9zaXRpb24ueSArIGggLyAyICk7XHJcbiAgICBjb250ZXh0LmxpbmVUbyggYXJyb3dDZW50ZXIgLSB3IC8gMiwgcG9zaXRpb24ueSAtIGggLyAyICk7XHJcbiAgICBjb250ZXh0LmxpbmVUbyggYXJyb3dDZW50ZXIgKyB3IC8gMiwgcG9zaXRpb24ueSAtIGggLyAyICk7XHJcbiAgfVxyXG5cclxuICBlbHNlIHtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoIGZhbHNlLCAnRUZpZWxkTGluZSBtdXN0IGJlIG9mIG9yaWVudGF0aW9uIFVQIG9yIERPV04nICk7XHJcbiAgfVxyXG59O1xyXG5cclxuY2xhc3MgRUZpZWxkTm9kZSBleHRlbmRzIENhbnZhc05vZGUge1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0ge0NhcGFjaXRvcn0gY2FwYWNpdG9yXHJcbiAgICogQHBhcmFtIHtZYXdQaXRjaE1vZGVsVmlld1RyYW5zZm9ybTN9IG1vZGVsVmlld1RyYW5zZm9ybVxyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhFZmZlY3RpdmVFRmllbGRcclxuICAgKiBAcGFyYW0ge0JvdW5kczJ9IGNhbnZhc0JvdW5kc1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCBjYXBhY2l0b3IsIG1vZGVsVmlld1RyYW5zZm9ybSwgbWF4RWZmZWN0aXZlRUZpZWxkLCBjYW52YXNCb3VuZHMgKSB7XHJcblxyXG4gICAgc3VwZXIoIHsgY2FudmFzQm91bmRzOiBjYW52YXNCb3VuZHMgfSApO1xyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgLy8gQHByaXZhdGVcclxuICAgIHRoaXMuY2FwYWNpdG9yID0gY2FwYWNpdG9yO1xyXG4gICAgdGhpcy5tb2RlbFZpZXdUcmFuc2Zvcm0gPSBtb2RlbFZpZXdUcmFuc2Zvcm07XHJcbiAgICB0aGlzLm1heEVmZmVjdGl2ZUVGaWVsZCA9IG1heEVmZmVjdGl2ZUVGaWVsZDtcclxuXHJcbiAgICBNdWx0aWxpbmsubXVsdGlsaW5rKCBbXHJcbiAgICAgIGNhcGFjaXRvci5wbGF0ZVNpemVQcm9wZXJ0eSxcclxuICAgICAgY2FwYWNpdG9yLnBsYXRlU2VwYXJhdGlvblByb3BlcnR5LFxyXG4gICAgICBjYXBhY2l0b3IucGxhdGVWb2x0YWdlUHJvcGVydHlcclxuICAgIF0sICgpID0+IHtcclxuICAgICAgaWYgKCBzZWxmLmlzVmlzaWJsZSgpICkge1xyXG4gICAgICAgIHNlbGYuaW52YWxpZGF0ZVBhaW50KCk7XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBVcGRhdGUgd2hlbiB0aGlzIE5vZGUgYmVjb21lcyB2aXNpYmxlLlxyXG4gICAgdGhpcy52aXNpYmxlUHJvcGVydHkubGluayggdmlzaWJsZSA9PiB2aXNpYmxlICYmIHRoaXMuaW52YWxpZGF0ZVBhaW50KCkgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbmRlcmluZ1xyXG4gICAqIEBwdWJsaWNcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0XHJcbiAgICovXHJcbiAgcGFpbnRDYW52YXMoIGNvbnRleHQgKSB7XHJcblxyXG4gICAgLy8gY29tcHV0ZSBkZW5zaXR5IChzcGFjaW5nKSBvZiBmaWVsZCBsaW5lc1xyXG4gICAgY29uc3QgZWZmZWN0aXZlRUZpZWxkID0gdGhpcy5jYXBhY2l0b3IuZ2V0RWZmZWN0aXZlRUZpZWxkKCk7XHJcbiAgICBjb25zdCBsaW5lU3BhY2luZyA9IHRoaXMuZ2V0TGluZVNwYWNpbmcoIGVmZmVjdGl2ZUVGaWVsZCApO1xyXG5cclxuICAgIGlmICggbGluZVNwYWNpbmcgPiAwICkge1xyXG5cclxuICAgICAgY29udGV4dC5iZWdpblBhdGgoKTtcclxuXHJcbiAgICAgIC8vIHJlbGV2YW50IG1vZGVsIHZhbHVlc1xyXG4gICAgICBjb25zdCBwbGF0ZVdpZHRoID0gdGhpcy5jYXBhY2l0b3IucGxhdGVTaXplUHJvcGVydHkudmFsdWUud2lkdGg7XHJcbiAgICAgIGNvbnN0IHBsYXRlRGVwdGggPSBwbGF0ZVdpZHRoO1xyXG4gICAgICBjb25zdCBwbGF0ZVNlcGFyYXRpb24gPSB0aGlzLmNhcGFjaXRvci5wbGF0ZVNlcGFyYXRpb25Qcm9wZXJ0eS52YWx1ZTtcclxuXHJcbiAgICAgIC8qXHJcbiAgICAgICAqIENyZWF0ZSBmaWVsZCBsaW5lcywgd29ya2luZyBmcm9tIHRoZSBjZW50ZXIgb3V0d2FyZHMgc28gdGhhdCBsaW5lcyBhcHBlYXIvZGlzYXBwZWFyIGF0IGVkZ2VzIG9mIHBsYXRlIGFzXHJcbiAgICAgICAqIEVfZWZmZWN0aXZlIGNoYW5nZXMuXHJcbiAgICAgICAqL1xyXG4gICAgICBjb25zdCBsZW5ndGggPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld0RlbHRhWFlaKCAwLCBwbGF0ZVNlcGFyYXRpb24sIDAgKS55O1xyXG4gICAgICBjb25zdCBkaXJlY3Rpb24gPSAoIGVmZmVjdGl2ZUVGaWVsZCA+PSAwICkgPyBBcnJvd0RpcmVjdGlvbi5ET1dOIDogQXJyb3dEaXJlY3Rpb24uVVA7XHJcbiAgICAgIGxldCB4ID0gbGluZVNwYWNpbmcgLyAyO1xyXG4gICAgICB3aGlsZSAoIHggPD0gcGxhdGVXaWR0aCAvIDIgKSB7XHJcbiAgICAgICAgbGV0IHogPSBsaW5lU3BhY2luZyAvIDI7XHJcbiAgICAgICAgd2hpbGUgKCB6IDw9IHBsYXRlRGVwdGggLyAyICkge1xyXG5cclxuICAgICAgICAgIC8vIGNhbGN1bGF0ZSBwb3NpdGlvbiBmb3IgdGhlIGxpbmVzXHJcbiAgICAgICAgICBjb25zdCB5ID0gMDtcclxuICAgICAgICAgIGNvbnN0IGxpbmUwVHJhbnNsYXRpb24gPSB0aGlzLm1vZGVsVmlld1RyYW5zZm9ybS5tb2RlbFRvVmlld1hZWiggeCwgeSwgeiApO1xyXG4gICAgICAgICAgY29uc3QgbGluZTFUcmFuc2xhdGlvbiA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WFlaKCAteCwgeSwgeiApO1xyXG4gICAgICAgICAgY29uc3QgbGluZTJUcmFuc2xhdGlvbiA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WFlaKCB4LCB5LCAteiApO1xyXG4gICAgICAgICAgY29uc3QgbGluZTNUcmFuc2xhdGlvbiA9IHRoaXMubW9kZWxWaWV3VHJhbnNmb3JtLm1vZGVsVG9WaWV3WFlaKCAteCwgeSwgLXogKTtcclxuXHJcbiAgICAgICAgICAvLyBhZGQgNCBsaW5lcywgb25lIGZvciBlYWNoIHF1YWRyYW50XHJcbiAgICAgICAgICBkcmF3RUZpZWxkTGluZSggbGluZTBUcmFuc2xhdGlvbiwgbGVuZ3RoLCBkaXJlY3Rpb24sIGNvbnRleHQgKTtcclxuICAgICAgICAgIGRyYXdFRmllbGRMaW5lKCBsaW5lMVRyYW5zbGF0aW9uLCBsZW5ndGgsIGRpcmVjdGlvbiwgY29udGV4dCApO1xyXG4gICAgICAgICAgZHJhd0VGaWVsZExpbmUoIGxpbmUyVHJhbnNsYXRpb24sIGxlbmd0aCwgZGlyZWN0aW9uLCBjb250ZXh0ICk7XHJcbiAgICAgICAgICBkcmF3RUZpZWxkTGluZSggbGluZTNUcmFuc2xhdGlvbiwgbGVuZ3RoLCBkaXJlY3Rpb24sIGNvbnRleHQgKTtcclxuXHJcbiAgICAgICAgICB6ICs9IGxpbmVTcGFjaW5nO1xyXG4gICAgICAgIH1cclxuICAgICAgICB4ICs9IGxpbmVTcGFjaW5nO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIHN0cm9rZSB0aGUgd2hvbGUgcGF0aFxyXG4gICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gQVJST1dfQ09MT1I7XHJcbiAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gQVJST1dfQ09MT1I7XHJcbiAgICAgIGNvbnRleHQubGluZVdpZHRoID0gTElORV9XSURUSDtcclxuICAgICAgY29udGV4dC5maWxsKCk7XHJcbiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXRzIHRoZSBzcGFjaW5nIG9mIEUtZmllbGQgbGluZXMuIEhpZ2hlciBFLWZpZWxkIHJlc3VsdHMgaW4gaGlnaGVyIGRlbnNpdHksXHJcbiAgICogdGhlcmVmb3JlIGxvd2VyIHNwYWNpbmcuIERlbnNpdHkgaXMgY29tcHV0ZWQgZm9yIHRoZSBtaW5pbXVtIHBsYXRlIHNpemUuXHJcbiAgICogQHB1YmxpY1xyXG4gICAqXHJcbiAgICogQHBhcmFtIHtudW1iZXJ9IGVmZmVjdGl2ZUVGaWVsZFxyXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9IHNwYWNpbmcsIGluIG1vZGVsIGNvb3JkaW5hdGVzXHJcbiAgICovXHJcbiAgZ2V0TGluZVNwYWNpbmcoIGVmZmVjdGl2ZUVGaWVsZCApIHtcclxuICAgIGlmICggZWZmZWN0aXZlRUZpZWxkID09PSAwICkge1xyXG4gICAgICByZXR1cm4gMDtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAvLyBzcXJ0IGxvb2tzIGJlc3QgZm9yIGEgc3F1YXJlIHBsYXRlXHJcbiAgICAgIHJldHVybiBTUEFDSU5HX0NPTlNUQU5UIC8gTWF0aC5zcXJ0KCBNYXRoLmFicyggZWZmZWN0aXZlRUZpZWxkICkgKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbnNjZW5lcnlQaGV0LnJlZ2lzdGVyKCAnRUZpZWxkTm9kZScsIEVGaWVsZE5vZGUgKTtcclxuZXhwb3J0IGRlZmF1bHQgRUZpZWxkTm9kZTsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUdBO0FBQ0EsT0FBT0EsU0FBUyxNQUFNLCtCQUErQjtBQUNyRCxPQUFPQyxVQUFVLE1BQU0sK0JBQStCO0FBQ3RELE9BQU9DLHFCQUFxQixNQUFNLGdEQUFnRDtBQUNsRixTQUFTQyxVQUFVLFFBQVEsZ0NBQWdDO0FBQzNELE9BQU9DLFdBQVcsTUFBTSxtQkFBbUI7O0FBRTNDO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLElBQUlKLFVBQVUsQ0FBRSxDQUFDLEVBQUUsQ0FBRSxDQUFDO0FBQ3pDLE1BQU1LLFVBQVUsR0FBRyxDQUFDO0FBQ3BCLE1BQU1DLFdBQVcsR0FBRyxPQUFPO0FBQzNCLE1BQU1DLGNBQWMsR0FBR04scUJBQXFCLENBQUNPLE1BQU0sQ0FBRSxDQUFFLElBQUksRUFBRSxNQUFNLENBQUcsQ0FBQzs7QUFFdkU7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxNQUFNOztBQUUvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTUMsY0FBYyxHQUFHQSxDQUFFQyxRQUFRLEVBQUVDLE1BQU0sRUFBRUMsU0FBUyxFQUFFQyxPQUFPLEtB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