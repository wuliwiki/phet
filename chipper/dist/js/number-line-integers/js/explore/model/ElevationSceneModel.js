// Copyright 2019-2022, University of Colorado Boulder

/**
 * ElevationSceneModel is the model for the "Elevation" scene
 *
 * @author John Blanco (PhET Interactive Simulations)
 */

import createObservableArray from '../../../../axon/js/createObservableArray.js';
import Bounds2 from '../../../../dot/js/Bounds2.js';
import Range from '../../../../dot/js/Range.js';
import Vector2 from '../../../../dot/js/Vector2.js';
import LockToNumberLine from '../../../../number-line-common/js/common/model/LockToNumberLine.js';
import PointController from '../../../../number-line-common/js/common/model/PointController.js';
import Orientation from '../../../../phet-core/js/Orientation.js';
import { Color } from '../../../../scenery/js/imports.js';
import NLIConstants from '../../common/NLIConstants.js';
import numberLineIntegers from '../../numberLineIntegers.js';
import ElevationPointController from './ElevationPointController.js';
import SceneModel from './SceneModel.js';

// constants
const SCENE_BOUNDS = NLIConstants.NLI_LAYOUT_BOUNDS; // bounds for the scenes match the layout bounds

class ElevationSceneModel extends SceneModel {
  /**
   * @public
   */
  constructor() {
    const seaLevel = SCENE_BOUNDS.centerY + 10; // sea level in model coordinates
    const numberLineRange = new Range(-80, 100); // in meters

    // Define the bounds of the area where the interactive elevation area will be shown, values empirically determined
    // to match the design spec.
    const elevationAreaWidth = 600;
    const elevationAreaHeight = 430;
    const elevationAreaCenter = new Vector2(SCENE_BOUNDS.centerX, seaLevel - numberLineRange.getCenter() * elevationAreaHeight / numberLineRange.getLength());
    const elevationAreaBounds = new Bounds2(elevationAreaCenter.x - elevationAreaWidth / 2, elevationAreaCenter.y - elevationAreaHeight / 2, elevationAreaCenter.x + elevationAreaWidth / 2, elevationAreaCenter.y + elevationAreaHeight / 2);
    super({
      numberLineZeroPositions: [new Vector2(elevationAreaBounds.minX / 2, seaLevel)],
      commonNumberLineOptions: {
        initialOrientation: Orientation.VERTICAL,
        initialDisplayedRange: numberLineRange,
        labelsInitiallyVisible: true,
        heightInModelSpace: elevationAreaHeight
      }
    });

    // @public (read-only) {Bounds2} - bounds of the interactive elevation area
    this.elevationAreaBounds = elevationAreaBounds;

    // @public (read-only) {number} - sea level in model coordinates
    this.seaLevel = seaLevel;

    // Specify the position of the box that will hold the elevatable items.
    const boxWidth = elevationAreaWidth * 0.6;
    const boxHeight = (SCENE_BOUNDS.maxY - elevationAreaBounds.maxY) * 0.7;
    const boxCenter = new Vector2(elevationAreaCenter.x, (SCENE_BOUNDS.maxY + elevationAreaBounds.maxY) / 2);

    // @public (read-only) {Bounds2} - holding area for the items that the user can elevate
    this.elevatableItemsBoxBounds = new Bounds2(boxCenter.x - boxWidth / 2, boxCenter.y - boxHeight / 2, boxCenter.x + boxWidth / 2, boxCenter.y + boxHeight / 2);

    // There is only one number line in this scene - create a local reference to it for convenience.
    const numberLine = this.numberLines[0];

    // @public (read-only) - the point controllers that can be moved into the elevation scene
    this.permanentPointControllers = [new ElevationPointController(numberLine, elevationAreaBounds, {
      color: new Color('#EE3937')
    }), new ElevationPointController(numberLine, elevationAreaBounds, {
      color: new Color('black')
    }), new ElevationPointController(numberLine, elevationAreaBounds, {
      color: new Color('#446ab7')
    })];

    // Put the permanent point controllers in their starting positions.
    this.permanentPointControllers.forEach(pointController => {
      this.putPointControllerInBox(pointController);
    });

    // If the point controllers are released outside of the elevation areas, send them home.
    this.permanentPointControllers.forEach(pointController => {
      pointController.isDraggingProperty.lazyLink(isDragging => {
        if (!isDragging && !pointController.overElevationAreaProperty.value && !pointController.isControllingNumberLinePoint()) {
          this.putPointControllerInBox(pointController, true);
        }
      });
    });

    // @public (read-only) - array of point controllers that are attached to the number line when a corresponding
    // elevatable controller is over the elevation area
    this.numberLineAttachedPointControllers = createObservableArray();

    // Watch for points coming and going on the number line and add the additional point controllers for them.
    numberLine.residentPoints.addItemAddedListener(addedPoint => {
      addedPoint.numberLine = numberLine;

      // Add a point controller that will remain attached to the number line that will control this point.
      const pointController = new PointController({
        color: addedPoint.colorProperty.value,
        lockToNumberLine: LockToNumberLine.ALWAYS,
        numberLinePoints: [addedPoint],
        numberLines: [numberLine]
      });
      this.numberLineAttachedPointControllers.push(pointController);

      // Handle removal of this point from the number line.
      const handlePointRemoved = removedPoint => {
        if (addedPoint === removedPoint) {
          pointController.clearNumberLinePoints();
          pointController.dispose();
          numberLine.residentPoints.removeItemRemovedListener(handlePointRemoved);
          this.numberLineAttachedPointControllers.remove(pointController);
        }
      };
      numberLine.residentPoints.addItemRemovedListener(handlePointRemoved);
    });
  }

  /**
   * Place the provided point controller into the holding box. This is generally done on init, reset, and when the user
   * "puts it away".
   * @param {ElevationPointController} pointController
   * @param {boolean} [animate] - controls whether to animate the return to the box or do it instantly
   * @private
   */
  putPointControllerInBox(pointController, animate = false) {
    const index = this.permanentPointControllers.indexOf(pointController);
    const numPositions = this.permanentPointControllers.length;

    // error checking
    assert && assert(index >= 0, 'point controller not found on list');
    assert && assert(!pointController.isControllingNumberLinePoint(), 'point controller should not be put away while controlling a point');
    const spacing = this.elevatableItemsBoxBounds.width / numPositions;
    const destination = new Vector2(this.elevatableItemsBoxBounds.minX + spacing / 2 + spacing * index, this.elevatableItemsBoxBounds.centerY);
    pointController.goToPosition(destination, animate);
  }

  /**
   * Restore initial state to the scene.
   * @override
   * @public
   */
  resetScene() {
    // Put the point controllers back into their starting positions.
    this.permanentPointControllers.forEach(pointController => {
      pointController.removeClearAndDisposePoints();
      this.putPointControllerInBox(pointController);
    });
  }
}
numberLineIntegers.register('ElevationSceneModel', ElevationSceneModel);
export default ElevationSceneModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjcmVhdGVPYnNlcnZhYmxlQXJyYXkiLCJCb3VuZHMyIiwiUmFuZ2UiLCJWZWN0b3IyIiwiTG9ja1RvTnVtYmVyTGluZSIsIlBvaW50Q29udHJvbGxlciIsIk9yaWVudGF0aW9uIiwiQ29sb3IiLCJOTElDb25zdGFudHMiLCJudW1iZXJMaW5lSW50ZWdlcnMiLCJFbGV2YXRpb25Qb2ludENvbnRyb2xsZXIiLCJTY2VuZU1vZGVsIiwiU0NFTkVfQk9VTkRTIiwiTkxJX0xBWU9VVF9CT1VORFMiLCJFbGV2YXRpb25TY2VuZU1vZGVsIiwiY29uc3RydWN0b3IiLCJzZWFMZXZlbCIsImNlbnRlclkiLCJudW1iZXJMaW5lUmFuZ2UiLCJlbGV2YXRpb25BcmVhV2lkdGgiLCJlbGV2YXRpb25BcmVhSGVpZ2h0IiwiZWxldmF0aW9uQXJlYUNlbnRlciIsImNlbnRlclgiLCJnZXRDZW50ZXIiLCJnZXRMZW5ndGgiLCJlbGV2YXRpb25BcmVhQm91bmRzIiwieCIsInkiLCJudW1iZXJMaW5lWmVyb1Bvc2l0aW9ucyIsIm1pblgiLCJjb21tb25OdW1iZXJMaW5lT3B0aW9ucyIsImluaXRpYWxPcmllbnRhdGlvbiIsIlZFUlRJQ0FMIiwiaW5pdGlhbERpc3BsYXllZFJhbmdlIiwibGFiZWxzSW5pdGlhbGx5VmlzaWJsZSIsImhlaWdodEluTW9kZWxTcGFjZSIsImJveFdpZHRoIiwiYm94SGVpZ2h0IiwibWF4WSIsImJveENlbnRlciIsImVsZXZhdGFibGVJdGVtc0JveEJvdW5kcyIsIm51bWJlckxpbmUiLCJudW1iZXJMaW5lcyIsInBlcm1hbmVudFBvaW50Q29udHJvbGxlcnMiLCJjb2xvciIsImZvckVhY2giLCJwb2ludENvbnRyb2xsZXIiLCJwdXRQb2ludENvbnRyb2xsZXJJbkJveCIsImlzRHJhZ2dpbmdQcm9wZXJ0eSIsImxhenlMaW5rIiwiaXNEcmFnZ2luZyIsIm92ZXJFbGV2YXRpb25BcmVhUHJvcGVydHkiLCJ2YWx1ZSIsImlzQ29udHJvbGxpbmdOdW1iZXJMaW5lUG9pbnQiLCJudW1iZXJMaW5lQXR0YWNoZWRQb2ludENvbnRyb2xsZXJzIiwicmVzaWRlbnRQb2ludHMiLCJhZGRJdGVtQWRkZWRMaXN0ZW5lciIsImFkZGVkUG9pbnQiLCJjb2xvclByb3BlcnR5IiwibG9ja1RvTnVtYmVyTGluZSIsIkFMV0FZUyIsIm51bWJlckxpbmVQb2ludHMiLCJwdXNoIiwiaGFuZGxlUG9pbnRSZW1vdmVkIiwicmVtb3ZlZFBvaW50IiwiY2xlYXJOdW1iZXJMaW5lUG9pbnRzIiwiZGlzcG9zZSIsInJlbW92ZUl0ZW1SZW1vdmVkTGlzdGVuZXIiLCJyZW1vdmUiLCJhZGRJdGVtUmVtb3ZlZExpc3RlbmVyIiwiYW5pbWF0ZSIsImluZGV4IiwiaW5kZXhPZiIsIm51bVBvc2l0aW9ucyIsImxlbmd0aCIsImFzc2VydCIsInNwYWNpbmciLCJ3aWR0aCIsImRlc3RpbmF0aW9uIiwiZ29Ub1Bvc2l0aW9uIiwicmVzZXRTY2VuZSIsInJlbW92ZUNsZWFyQW5kRGlzcG9zZVBvaW50cyIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRWxldmF0aW9uU2NlbmVNb2RlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOS0yMDIyLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuXHJcbi8qKlxyXG4gKiBFbGV2YXRpb25TY2VuZU1vZGVsIGlzIHRoZSBtb2RlbCBmb3IgdGhlIFwiRWxldmF0aW9uXCIgc2NlbmVcclxuICpcclxuICogQGF1dGhvciBKb2huIEJsYW5jbyAoUGhFVCBJbnRlcmFjdGl2ZSBTaW11bGF0aW9ucylcclxuICovXHJcblxyXG5pbXBvcnQgY3JlYXRlT2JzZXJ2YWJsZUFycmF5IGZyb20gJy4uLy4uLy4uLy4uL2F4b24vanMvY3JlYXRlT2JzZXJ2YWJsZUFycmF5LmpzJztcclxuaW1wb3J0IEJvdW5kczIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL0JvdW5kczIuanMnO1xyXG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1JhbmdlLmpzJztcclxuaW1wb3J0IFZlY3RvcjIgZnJvbSAnLi4vLi4vLi4vLi4vZG90L2pzL1ZlY3RvcjIuanMnO1xyXG5pbXBvcnQgTG9ja1RvTnVtYmVyTGluZSBmcm9tICcuLi8uLi8uLi8uLi9udW1iZXItbGluZS1jb21tb24vanMvY29tbW9uL21vZGVsL0xvY2tUb051bWJlckxpbmUuanMnO1xyXG5pbXBvcnQgUG9pbnRDb250cm9sbGVyIGZyb20gJy4uLy4uLy4uLy4uL251bWJlci1saW5lLWNvbW1vbi9qcy9jb21tb24vbW9kZWwvUG9pbnRDb250cm9sbGVyLmpzJztcclxuaW1wb3J0IE9yaWVudGF0aW9uIGZyb20gJy4uLy4uLy4uLy4uL3BoZXQtY29yZS9qcy9PcmllbnRhdGlvbi5qcyc7XHJcbmltcG9ydCB7IENvbG9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS9qcy9pbXBvcnRzLmpzJztcclxuaW1wb3J0IE5MSUNvbnN0YW50cyBmcm9tICcuLi8uLi9jb21tb24vTkxJQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IG51bWJlckxpbmVJbnRlZ2VycyBmcm9tICcuLi8uLi9udW1iZXJMaW5lSW50ZWdlcnMuanMnO1xyXG5pbXBvcnQgRWxldmF0aW9uUG9pbnRDb250cm9sbGVyIGZyb20gJy4vRWxldmF0aW9uUG9pbnRDb250cm9sbGVyLmpzJztcclxuaW1wb3J0IFNjZW5lTW9kZWwgZnJvbSAnLi9TY2VuZU1vZGVsLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBTQ0VORV9CT1VORFMgPSBOTElDb25zdGFudHMuTkxJX0xBWU9VVF9CT1VORFM7IC8vIGJvdW5kcyBmb3IgdGhlIHNjZW5lcyBtYXRjaCB0aGUgbGF5b3V0IGJvdW5kc1xyXG5cclxuY2xhc3MgRWxldmF0aW9uU2NlbmVNb2RlbCBleHRlbmRzIFNjZW5lTW9kZWwge1xyXG5cclxuICAvKipcclxuICAgKiBAcHVibGljXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcblxyXG4gICAgY29uc3Qgc2VhTGV2ZWwgPSBTQ0VORV9CT1VORFMuY2VudGVyWSArIDEwOyAvLyBzZWEgbGV2ZWwgaW4gbW9kZWwgY29vcmRpbmF0ZXNcclxuICAgIGNvbnN0IG51bWJlckxpbmVSYW5nZSA9IG5ldyBSYW5nZSggLTgwLCAxMDAgKTsgLy8gaW4gbWV0ZXJzXHJcblxyXG4gICAgLy8gRGVmaW5lIHRoZSBib3VuZHMgb2YgdGhlIGFyZWEgd2hlcmUgdGhlIGludGVyYWN0aXZlIGVsZXZhdGlvbiBhcmVhIHdpbGwgYmUgc2hvd24sIHZhbHVlcyBlbXBpcmljYWxseSBkZXRlcm1pbmVkXHJcbiAgICAvLyB0byBtYXRjaCB0aGUgZGVzaWduIHNwZWMuXHJcbiAgICBjb25zdCBlbGV2YXRpb25BcmVhV2lkdGggPSA2MDA7XHJcbiAgICBjb25zdCBlbGV2YXRpb25BcmVhSGVpZ2h0ID0gNDMwO1xyXG4gICAgY29uc3QgZWxldmF0aW9uQXJlYUNlbnRlciA9IG5ldyBWZWN0b3IyKFxyXG4gICAgICBTQ0VORV9CT1VORFMuY2VudGVyWCxcclxuICAgICAgc2VhTGV2ZWwgLSBudW1iZXJMaW5lUmFuZ2UuZ2V0Q2VudGVyKCkgKiBlbGV2YXRpb25BcmVhSGVpZ2h0IC8gbnVtYmVyTGluZVJhbmdlLmdldExlbmd0aCgpXHJcbiAgICApO1xyXG4gICAgY29uc3QgZWxldmF0aW9uQXJlYUJvdW5kcyA9IG5ldyBCb3VuZHMyKFxyXG4gICAgICBlbGV2YXRpb25BcmVhQ2VudGVyLnggLSBlbGV2YXRpb25BcmVhV2lkdGggLyAyLFxyXG4gICAgICBlbGV2YXRpb25BcmVhQ2VudGVyLnkgLSBlbGV2YXRpb25BcmVhSGVpZ2h0IC8gMixcclxuICAgICAgZWxldmF0aW9uQXJlYUNlbnRlci54ICsgZWxldmF0aW9uQXJlYVdpZHRoIC8gMixcclxuICAgICAgZWxldmF0aW9uQXJlYUNlbnRlci55ICsgZWxldmF0aW9uQXJlYUhlaWdodCAvIDJcclxuICAgICk7XHJcblxyXG4gICAgc3VwZXIoIHtcclxuICAgICAgbnVtYmVyTGluZVplcm9Qb3NpdGlvbnM6IFsgbmV3IFZlY3RvcjIoIGVsZXZhdGlvbkFyZWFCb3VuZHMubWluWCAvIDIsIHNlYUxldmVsICkgXSxcclxuICAgICAgY29tbW9uTnVtYmVyTGluZU9wdGlvbnM6IHtcclxuICAgICAgICBpbml0aWFsT3JpZW50YXRpb246IE9yaWVudGF0aW9uLlZFUlRJQ0FMLFxyXG4gICAgICAgIGluaXRpYWxEaXNwbGF5ZWRSYW5nZTogbnVtYmVyTGluZVJhbmdlLFxyXG4gICAgICAgIGxhYmVsc0luaXRpYWxseVZpc2libGU6IHRydWUsXHJcbiAgICAgICAgaGVpZ2h0SW5Nb2RlbFNwYWNlOiBlbGV2YXRpb25BcmVhSGVpZ2h0XHJcbiAgICAgIH1cclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtCb3VuZHMyfSAtIGJvdW5kcyBvZiB0aGUgaW50ZXJhY3RpdmUgZWxldmF0aW9uIGFyZWFcclxuICAgIHRoaXMuZWxldmF0aW9uQXJlYUJvdW5kcyA9IGVsZXZhdGlvbkFyZWFCb3VuZHM7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAocmVhZC1vbmx5KSB7bnVtYmVyfSAtIHNlYSBsZXZlbCBpbiBtb2RlbCBjb29yZGluYXRlc1xyXG4gICAgdGhpcy5zZWFMZXZlbCA9IHNlYUxldmVsO1xyXG5cclxuICAgIC8vIFNwZWNpZnkgdGhlIHBvc2l0aW9uIG9mIHRoZSBib3ggdGhhdCB3aWxsIGhvbGQgdGhlIGVsZXZhdGFibGUgaXRlbXMuXHJcbiAgICBjb25zdCBib3hXaWR0aCA9IGVsZXZhdGlvbkFyZWFXaWR0aCAqIDAuNjtcclxuICAgIGNvbnN0IGJveEhlaWdodCA9ICggU0NFTkVfQk9VTkRTLm1heFkgLSBlbGV2YXRpb25BcmVhQm91bmRzLm1heFkgKSAqIDAuNztcclxuICAgIGNvbnN0IGJveENlbnRlciA9IG5ldyBWZWN0b3IyKCBlbGV2YXRpb25BcmVhQ2VudGVyLngsICggU0NFTkVfQk9VTkRTLm1heFkgKyBlbGV2YXRpb25BcmVhQm91bmRzLm1heFkgKSAvIDIgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtCb3VuZHMyfSAtIGhvbGRpbmcgYXJlYSBmb3IgdGhlIGl0ZW1zIHRoYXQgdGhlIHVzZXIgY2FuIGVsZXZhdGVcclxuICAgIHRoaXMuZWxldmF0YWJsZUl0ZW1zQm94Qm91bmRzID0gbmV3IEJvdW5kczIoXHJcbiAgICAgIGJveENlbnRlci54IC0gYm94V2lkdGggLyAyLFxyXG4gICAgICBib3hDZW50ZXIueSAtIGJveEhlaWdodCAvIDIsXHJcbiAgICAgIGJveENlbnRlci54ICsgYm94V2lkdGggLyAyLFxyXG4gICAgICBib3hDZW50ZXIueSArIGJveEhlaWdodCAvIDJcclxuICAgICk7XHJcblxyXG4gICAgLy8gVGhlcmUgaXMgb25seSBvbmUgbnVtYmVyIGxpbmUgaW4gdGhpcyBzY2VuZSAtIGNyZWF0ZSBhIGxvY2FsIHJlZmVyZW5jZSB0byBpdCBmb3IgY29udmVuaWVuY2UuXHJcbiAgICBjb25zdCBudW1iZXJMaW5lID0gdGhpcy5udW1iZXJMaW5lc1sgMCBdO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkgLSB0aGUgcG9pbnQgY29udHJvbGxlcnMgdGhhdCBjYW4gYmUgbW92ZWQgaW50byB0aGUgZWxldmF0aW9uIHNjZW5lXHJcbiAgICB0aGlzLnBlcm1hbmVudFBvaW50Q29udHJvbGxlcnMgPSBbXHJcbiAgICAgIG5ldyBFbGV2YXRpb25Qb2ludENvbnRyb2xsZXIoIG51bWJlckxpbmUsIGVsZXZhdGlvbkFyZWFCb3VuZHMsIHsgY29sb3I6IG5ldyBDb2xvciggJyNFRTM5MzcnICkgfSApLFxyXG4gICAgICBuZXcgRWxldmF0aW9uUG9pbnRDb250cm9sbGVyKCBudW1iZXJMaW5lLCBlbGV2YXRpb25BcmVhQm91bmRzLCB7IGNvbG9yOiBuZXcgQ29sb3IoICdibGFjaycgKSB9ICksXHJcbiAgICAgIG5ldyBFbGV2YXRpb25Qb2ludENvbnRyb2xsZXIoIG51bWJlckxpbmUsIGVsZXZhdGlvbkFyZWFCb3VuZHMsIHsgY29sb3I6IG5ldyBDb2xvciggJyM0NDZhYjcnICkgfSApXHJcbiAgICBdO1xyXG5cclxuICAgIC8vIFB1dCB0aGUgcGVybWFuZW50IHBvaW50IGNvbnRyb2xsZXJzIGluIHRoZWlyIHN0YXJ0aW5nIHBvc2l0aW9ucy5cclxuICAgIHRoaXMucGVybWFuZW50UG9pbnRDb250cm9sbGVycy5mb3JFYWNoKCBwb2ludENvbnRyb2xsZXIgPT4ge1xyXG4gICAgICB0aGlzLnB1dFBvaW50Q29udHJvbGxlckluQm94KCBwb2ludENvbnRyb2xsZXIgKTtcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBJZiB0aGUgcG9pbnQgY29udHJvbGxlcnMgYXJlIHJlbGVhc2VkIG91dHNpZGUgb2YgdGhlIGVsZXZhdGlvbiBhcmVhcywgc2VuZCB0aGVtIGhvbWUuXHJcbiAgICB0aGlzLnBlcm1hbmVudFBvaW50Q29udHJvbGxlcnMuZm9yRWFjaCggcG9pbnRDb250cm9sbGVyID0+IHtcclxuICAgICAgcG9pbnRDb250cm9sbGVyLmlzRHJhZ2dpbmdQcm9wZXJ0eS5sYXp5TGluayggaXNEcmFnZ2luZyA9PiB7XHJcbiAgICAgICAgaWYgKCAhaXNEcmFnZ2luZyAmJlxyXG4gICAgICAgICAgICAgIXBvaW50Q29udHJvbGxlci5vdmVyRWxldmF0aW9uQXJlYVByb3BlcnR5LnZhbHVlICYmXHJcbiAgICAgICAgICAgICAhcG9pbnRDb250cm9sbGVyLmlzQ29udHJvbGxpbmdOdW1iZXJMaW5lUG9pbnQoKSApIHtcclxuICAgICAgICAgIHRoaXMucHV0UG9pbnRDb250cm9sbGVySW5Cb3goIHBvaW50Q29udHJvbGxlciwgdHJ1ZSApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSApO1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgKHJlYWQtb25seSkgLSBhcnJheSBvZiBwb2ludCBjb250cm9sbGVycyB0aGF0IGFyZSBhdHRhY2hlZCB0byB0aGUgbnVtYmVyIGxpbmUgd2hlbiBhIGNvcnJlc3BvbmRpbmdcclxuICAgIC8vIGVsZXZhdGFibGUgY29udHJvbGxlciBpcyBvdmVyIHRoZSBlbGV2YXRpb24gYXJlYVxyXG4gICAgdGhpcy5udW1iZXJMaW5lQXR0YWNoZWRQb2ludENvbnRyb2xsZXJzID0gY3JlYXRlT2JzZXJ2YWJsZUFycmF5KCk7XHJcblxyXG4gICAgLy8gV2F0Y2ggZm9yIHBvaW50cyBjb21pbmcgYW5kIGdvaW5nIG9uIHRoZSBudW1iZXIgbGluZSBhbmQgYWRkIHRoZSBhZGRpdGlvbmFsIHBvaW50IGNvbnRyb2xsZXJzIGZvciB0aGVtLlxyXG4gICAgbnVtYmVyTGluZS5yZXNpZGVudFBvaW50cy5hZGRJdGVtQWRkZWRMaXN0ZW5lciggYWRkZWRQb2ludCA9PiB7XHJcblxyXG4gICAgICBhZGRlZFBvaW50Lm51bWJlckxpbmUgPSBudW1iZXJMaW5lO1xyXG5cclxuICAgICAgLy8gQWRkIGEgcG9pbnQgY29udHJvbGxlciB0aGF0IHdpbGwgcmVtYWluIGF0dGFjaGVkIHRvIHRoZSBudW1iZXIgbGluZSB0aGF0IHdpbGwgY29udHJvbCB0aGlzIHBvaW50LlxyXG4gICAgICBjb25zdCBwb2ludENvbnRyb2xsZXIgPSBuZXcgUG9pbnRDb250cm9sbGVyKCB7XHJcbiAgICAgICAgY29sb3I6IGFkZGVkUG9pbnQuY29sb3JQcm9wZXJ0eS52YWx1ZSxcclxuICAgICAgICBsb2NrVG9OdW1iZXJMaW5lOiBMb2NrVG9OdW1iZXJMaW5lLkFMV0FZUyxcclxuICAgICAgICBudW1iZXJMaW5lUG9pbnRzOiBbIGFkZGVkUG9pbnQgXSxcclxuICAgICAgICBudW1iZXJMaW5lczogWyBudW1iZXJMaW5lIF1cclxuICAgICAgfSApO1xyXG4gICAgICB0aGlzLm51bWJlckxpbmVBdHRhY2hlZFBvaW50Q29udHJvbGxlcnMucHVzaCggcG9pbnRDb250cm9sbGVyICk7XHJcblxyXG4gICAgICAvLyBIYW5kbGUgcmVtb3ZhbCBvZiB0aGlzIHBvaW50IGZyb20gdGhlIG51bWJlciBsaW5lLlxyXG4gICAgICBjb25zdCBoYW5kbGVQb2ludFJlbW92ZWQgPSByZW1vdmVkUG9pbnQgPT4ge1xyXG4gICAgICAgIGlmICggYWRkZWRQb2ludCA9PT0gcmVtb3ZlZFBvaW50ICkge1xyXG4gICAgICAgICAgcG9pbnRDb250cm9sbGVyLmNsZWFyTnVtYmVyTGluZVBvaW50cygpO1xyXG4gICAgICAgICAgcG9pbnRDb250cm9sbGVyLmRpc3Bvc2UoKTtcclxuICAgICAgICAgIG51bWJlckxpbmUucmVzaWRlbnRQb2ludHMucmVtb3ZlSXRlbVJlbW92ZWRMaXN0ZW5lciggaGFuZGxlUG9pbnRSZW1vdmVkICk7XHJcbiAgICAgICAgICB0aGlzLm51bWJlckxpbmVBdHRhY2hlZFBvaW50Q29udHJvbGxlcnMucmVtb3ZlKCBwb2ludENvbnRyb2xsZXIgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIG51bWJlckxpbmUucmVzaWRlbnRQb2ludHMuYWRkSXRlbVJlbW92ZWRMaXN0ZW5lciggaGFuZGxlUG9pbnRSZW1vdmVkICk7XHJcbiAgICB9ICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQbGFjZSB0aGUgcHJvdmlkZWQgcG9pbnQgY29udHJvbGxlciBpbnRvIHRoZSBob2xkaW5nIGJveC4gVGhpcyBpcyBnZW5lcmFsbHkgZG9uZSBvbiBpbml0LCByZXNldCwgYW5kIHdoZW4gdGhlIHVzZXJcclxuICAgKiBcInB1dHMgaXQgYXdheVwiLlxyXG4gICAqIEBwYXJhbSB7RWxldmF0aW9uUG9pbnRDb250cm9sbGVyfSBwb2ludENvbnRyb2xsZXJcclxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbmltYXRlXSAtIGNvbnRyb2xzIHdoZXRoZXIgdG8gYW5pbWF0ZSB0aGUgcmV0dXJuIHRvIHRoZSBib3ggb3IgZG8gaXQgaW5zdGFudGx5XHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBwdXRQb2ludENvbnRyb2xsZXJJbkJveCggcG9pbnRDb250cm9sbGVyLCBhbmltYXRlID0gZmFsc2UgKSB7XHJcblxyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnBlcm1hbmVudFBvaW50Q29udHJvbGxlcnMuaW5kZXhPZiggcG9pbnRDb250cm9sbGVyICk7XHJcbiAgICBjb25zdCBudW1Qb3NpdGlvbnMgPSB0aGlzLnBlcm1hbmVudFBvaW50Q29udHJvbGxlcnMubGVuZ3RoO1xyXG5cclxuICAgIC8vIGVycm9yIGNoZWNraW5nXHJcbiAgICBhc3NlcnQgJiYgYXNzZXJ0KCBpbmRleCA+PSAwLCAncG9pbnQgY29udHJvbGxlciBub3QgZm91bmQgb24gbGlzdCcgKTtcclxuICAgIGFzc2VydCAmJiBhc3NlcnQoXHJcbiAgICAgICFwb2ludENvbnRyb2xsZXIuaXNDb250cm9sbGluZ051bWJlckxpbmVQb2ludCgpLFxyXG4gICAgICAncG9pbnQgY29udHJvbGxlciBzaG91bGQgbm90IGJlIHB1dCBhd2F5IHdoaWxlIGNvbnRyb2xsaW5nIGEgcG9pbnQnXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IHNwYWNpbmcgPSB0aGlzLmVsZXZhdGFibGVJdGVtc0JveEJvdW5kcy53aWR0aCAvIG51bVBvc2l0aW9ucztcclxuICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gbmV3IFZlY3RvcjIoXHJcbiAgICAgIHRoaXMuZWxldmF0YWJsZUl0ZW1zQm94Qm91bmRzLm1pblggKyBzcGFjaW5nIC8gMiArIHNwYWNpbmcgKiBpbmRleCxcclxuICAgICAgdGhpcy5lbGV2YXRhYmxlSXRlbXNCb3hCb3VuZHMuY2VudGVyWVxyXG4gICAgKTtcclxuICAgIHBvaW50Q29udHJvbGxlci5nb1RvUG9zaXRpb24oIGRlc3RpbmF0aW9uLCBhbmltYXRlICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0b3JlIGluaXRpYWwgc3RhdGUgdG8gdGhlIHNjZW5lLlxyXG4gICAqIEBvdmVycmlkZVxyXG4gICAqIEBwdWJsaWNcclxuICAgKi9cclxuICByZXNldFNjZW5lKCkge1xyXG5cclxuICAgIC8vIFB1dCB0aGUgcG9pbnQgY29udHJvbGxlcnMgYmFjayBpbnRvIHRoZWlyIHN0YXJ0aW5nIHBvc2l0aW9ucy5cclxuICAgIHRoaXMucGVybWFuZW50UG9pbnRDb250cm9sbGVycy5mb3JFYWNoKCBwb2ludENvbnRyb2xsZXIgPT4ge1xyXG4gICAgICBwb2ludENvbnRyb2xsZXIucmVtb3ZlQ2xlYXJBbmREaXNwb3NlUG9pbnRzKCk7XHJcbiAgICAgIHRoaXMucHV0UG9pbnRDb250cm9sbGVySW5Cb3goIHBvaW50Q29udHJvbGxlciApO1xyXG4gICAgfSApO1xyXG4gIH1cclxufVxyXG5cclxubnVtYmVyTGluZUludGVnZXJzLnJlZ2lzdGVyKCAnRWxldmF0aW9uU2NlbmVNb2RlbCcsIEVsZXZhdGlvblNjZW5lTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgRWxldmF0aW9uU2NlbmVNb2RlbDsiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsT0FBT0EscUJBQXFCLE1BQU0sOENBQThDO0FBQ2hGLE9BQU9DLE9BQU8sTUFBTSwrQkFBK0I7QUFDbkQsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxPQUFPLE1BQU0sK0JBQStCO0FBQ25ELE9BQU9DLGdCQUFnQixNQUFNLG9FQUFvRTtBQUNqRyxPQUFPQyxlQUFlLE1BQU0sbUVBQW1FO0FBQy9GLE9BQU9DLFdBQVcsTUFBTSx5Q0FBeUM7QUFDakUsU0FBU0MsS0FBSyxRQUFRLG1DQUFtQztBQUN6RCxPQUFPQyxZQUFZLE1BQU0sOEJBQThCO0FBQ3ZELE9BQU9DLGtCQUFrQixNQUFNLDZCQUE2QjtBQUM1RCxPQUFPQyx3QkFBd0IsTUFBTSwrQkFBK0I7QUFDcEUsT0FBT0MsVUFBVSxNQUFNLGlCQUFpQjs7QUFFeEM7QUFDQSxNQUFNQyxZQUFZLEdBQUdKLFlBQVksQ0FBQ0ssaUJBQWlCLENBQUMsQ0FBQzs7QUFFckQsTUFBTUMsbUJBQW1CLFNBQVNILFVBQVUsQ0FBQztFQUUzQztBQUNGO0FBQ0E7RUFDRUksV0FBV0EsQ0FBQSxFQUFH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