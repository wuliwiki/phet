// Copyright 2017-2023, University of Colorado Boulder
// @ts-nocheck
/**
 * Model for the Diffraction screen.
 *
 * @author Sam Reid (PhET Interactive Simulations)
 */

import BooleanProperty from '../../../../axon/js/BooleanProperty.js';
import NumberProperty from '../../../../axon/js/NumberProperty.js';
import Property from '../../../../axon/js/Property.js';
import Matrix from '../../../../dot/js/Matrix.js';
import Range from '../../../../dot/js/Range.js';
import VisibleColor from '../../../../scenery-phet/js/VisibleColor.js';
import WaveInterferenceConstants from '../../common/WaveInterferenceConstants.js';
import waveInterference from '../../waveInterference.js';
import CircleSquareScene from './CircleSquareScene.js';
import DisorderScene from './DisorderScene.js';
import EllipseScene from './EllipseScene.js';
import RectangleScene from './RectangleScene.js';
import WavingGirlScene from './WavingGirlScene.js';
// constants
const CONTRAST = 0.01;
const MATRIX_DIMENSION = WaveInterferenceConstants.DIFFRACTION_MATRIX_DIMENSION;

// preallocated to avoid generating garbage
const SHIFTED_MAGNITUDES = new Array(MATRIX_DIMENSION * MATRIX_DIMENSION);
const IMAGINARY_PART = new Array(MATRIX_DIMENSION * MATRIX_DIMENSION);
const REAL_PART = new Array(MATRIX_DIMENSION * MATRIX_DIMENSION);

// initialization for 3rd party library
FFT.init(MATRIX_DIMENSION);
class DiffractionModel {
  constructor() {
    // @public - whether the laser is emitting light
    this.onProperty = new BooleanProperty(false);

    // @public - the wavelength of the laser in nm
    this.wavelengthProperty = new NumberProperty(WaveInterferenceConstants.DEFAULT_WAVELENGTH, {
      range: new Range(VisibleColor.MIN_WAVELENGTH, VisibleColor.MAX_WAVELENGTH),
      units: 'nm'
    });

    // @public (read-only) - scenes
    this.ellipseScene = new EllipseScene();
    this.rectangleScene = new RectangleScene();
    this.circleSquareScene = new CircleSquareScene();
    this.disorderScene = new DisorderScene();
    this.wavingGirlScene = new WavingGirlScene();

    // @public (read-only) {DiffractionScene[]}
    this.scenes = [this.ellipseScene, this.rectangleScene, this.circleSquareScene, this.disorderScene, this.wavingGirlScene];

    // @public - selected aperture type, which is in essence the "scene" for this screen.
    this.sceneProperty = new Property(this.ellipseScene, {
      validValues: this.scenes
    });

    // @public - The displayed aperture, shared by all scenes
    this.apertureMatrix = new Matrix(MATRIX_DIMENSION, MATRIX_DIMENSION);

    // @private - Transformed aperture to account for wavelength changes for the FFT, shared by all scenes
    this.scaledApertureMatrix = new Matrix(MATRIX_DIMENSION, MATRIX_DIMENSION);

    // @public - Result of FFT on the scaledApertureMatrix, shared by all scenes
    this.diffractionMatrix = new Matrix(MATRIX_DIMENSION, MATRIX_DIMENSION);

    /**
     * Update the aperture and FFT result when model characteristics change.
     */
    const update = () => {
      // To give the appearance of the proper diffraction, we scale the aperture size before the FFT
      const scaleFactor = WaveInterferenceConstants.DEFAULT_WAVELENGTH / this.wavelengthProperty.value;
      const scene = this.sceneProperty.value;

      // Compute the aperture that will be rendered
      scene.paintMatrix(this.apertureMatrix, 1);

      // Compute the aperture that will be FFT'ed
      scene.paintMatrix(this.scaledApertureMatrix, scaleFactor);
      if (this.onProperty.value) {
        fftImageProcessingLabs(this.scaledApertureMatrix, this.diffractionMatrix);
      } else {
        this.diffractionMatrix.timesEquals(0);
      }
    };
    this.scenes.forEach(scene => scene.linkToAllProperties(update));
    this.sceneProperty.link(update);
    this.wavelengthProperty.link(update);
    this.onProperty.link(update);
  }

  /**
   * Restore initial conditions.
   */
  reset() {
    this.scenes.forEach(scene => scene.reset());
    this.onProperty.reset();
    this.sceneProperty.reset();
    this.wavelengthProperty.reset();
  }
  step(dt) {

    // Model is static
  }
}

/**
 * Given row/column indices, find the index in the flattened array.  Uses the same strategy as DOT/Matrix.
 * @param i - row index
 * @param j - column index
 */
const getIndex = (i, j) => {
  return i * MATRIX_DIMENSION + j;
};

/**
 * Computes the 2D discrete fourier transform of the aperture, which will be displayed as the diffraction pattern.
 * This method uses a 3rd party library for computing the FFT.  In postprocessing steps, it
 * (a) it swaps the quadrants to put the low frequencies in the center.
 * (b) shows the log of the magnitudes instead of the raw frequencies to have better fidelity
 * see https://www.cs.cmu.edu/afs/andrew/scs/cs/15-463/2001/pub/www/notes/fourier/fourier.pdf
 * @param input - aperture matrix
 * @param output - place to set fft result values
 */
const fftImageProcessingLabs = (input, output) => {
  // Take the values from the aperture
  for (let i = 0; i < input.entries.length; i++) {
    REAL_PART[i] = input.entries[i];
    IMAGINARY_PART[i] = 0;
  }

  // FFT library performs in-place computation.  Result overwrites the input.
  FFT.fft2d(REAL_PART, IMAGINARY_PART);

  // From https://www.cs.cmu.edu/afs/andrew/scs/cs/15-463/2001/pub/www/notes/fourier/fourier.pdf
  // Practical issues: For display purposes, you probably want to cyclically translate the picture so that pixel (0,0)
  // which now contains frequency (ωx, ωy ) = (0, 0), moves to the center of the image. And you probably want to
  // display pixel values proportional to log(magnitude) of each complex number (this looks more interesting than just
  // magnitude). For color images, do the above to each of the three channels (R, G, and B) independently.
  for (let row = 0; row < MATRIX_DIMENSION; row++) {
    for (let col = 0; col < MATRIX_DIMENSION; col++) {
      const source = getIndex(row, col);
      const destination = getIndex((row + MATRIX_DIMENSION / 2) % MATRIX_DIMENSION, (col + MATRIX_DIMENSION / 2) % MATRIX_DIMENSION);
      SHIFTED_MAGNITUDES[destination] = Math.sqrt(REAL_PART[source] * REAL_PART[source] + IMAGINARY_PART[source] * IMAGINARY_PART[source]);
    }
  }

  // Set values to the output Matrix
  const maxMagnitude = _.max(SHIFTED_MAGNITUDES);
  const logOfMaxMag = Math.log(CONTRAST * maxMagnitude + 1);
  for (let i = 0; i < SHIFTED_MAGNITUDES.length; i++) {
    output.entries[i] = Math.log(CONTRAST * SHIFTED_MAGNITUDES[i] + 1) / logOfMaxMag;
  }
};
waveInterference.register('DiffractionModel', DiffractionModel);
export default DiffractionModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29sZWFuUHJvcGVydHkiLCJOdW1iZXJQcm9wZXJ0eSIsIlByb3BlcnR5IiwiTWF0cml4IiwiUmFuZ2UiLCJWaXNpYmxlQ29sb3IiLCJXYXZlSW50ZXJmZXJlbmNlQ29uc3RhbnRzIiwid2F2ZUludGVyZmVyZW5jZSIsIkNpcmNsZVNxdWFyZVNjZW5lIiwiRGlzb3JkZXJTY2VuZSIsIkVsbGlwc2VTY2VuZSIsIlJlY3RhbmdsZVNjZW5lIiwiV2F2aW5nR2lybFNjZW5lIiwiQ09OVFJBU1QiLCJNQVRSSVhfRElNRU5TSU9OIiwiRElGRlJBQ1RJT05fTUFUUklYX0RJTUVOU0lPTiIsIlNISUZURURfTUFHTklUVURFUyIsIkFycmF5IiwiSU1BR0lOQVJZX1BBUlQiLCJSRUFMX1BBUlQiLCJGRlQiLCJpbml0IiwiRGlmZnJhY3Rpb25Nb2RlbCIsImNvbnN0cnVjdG9yIiwib25Qcm9wZXJ0eSIsIndhdmVsZW5ndGhQcm9wZXJ0eSIsIkRFRkFVTFRfV0FWRUxFTkdUSCIsInJhbmdlIiwiTUlOX1dBVkVMRU5HVEgiLCJNQVhfV0FWRUxFTkdUSCIsInVuaXRzIiwiZWxsaXBzZVNjZW5lIiwicmVjdGFuZ2xlU2NlbmUiLCJjaXJjbGVTcXVhcmVTY2VuZSIsImRpc29yZGVyU2NlbmUiLCJ3YXZpbmdHaXJsU2NlbmUiLCJzY2VuZXMiLCJzY2VuZVByb3BlcnR5IiwidmFsaWRWYWx1ZXMiLCJhcGVydHVyZU1hdHJpeCIsInNjYWxlZEFwZXJ0dXJlTWF0cml4IiwiZGlmZnJhY3Rpb25NYXRyaXgiLCJ1cGRhdGUiLCJzY2FsZUZhY3RvciIsInZhbHVlIiwic2NlbmUiLCJwYWludE1hdHJpeCIsImZmdEltYWdlUHJvY2Vzc2luZ0xhYnMiLCJ0aW1lc0VxdWFscyIsImZvckVhY2giLCJsaW5rVG9BbGxQcm9wZXJ0aWVzIiwibGluayIsInJlc2V0Iiwic3RlcCIsImR0IiwiZ2V0SW5kZXgiLCJpIiwiaiIsImlucHV0Iiwib3V0cHV0IiwiZW50cmllcyIsImxlbmd0aCIsImZmdDJkIiwicm93IiwiY29sIiwic291cmNlIiwiZGVzdGluYXRpb24iLCJNYXRoIiwic3FydCIsIm1heE1hZ25pdHVkZSIsIl8iLCJtYXgiLCJsb2dPZk1heE1hZyIsImxvZyIsInJlZ2lzdGVyIl0sInNvdXJjZXMiOlsiRGlmZnJhY3Rpb25Nb2RlbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDIzLCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcclxuLy8gQHRzLW5vY2hlY2tcclxuLyoqXHJcbiAqIE1vZGVsIGZvciB0aGUgRGlmZnJhY3Rpb24gc2NyZWVuLlxyXG4gKlxyXG4gKiBAYXV0aG9yIFNhbSBSZWlkIChQaEVUIEludGVyYWN0aXZlIFNpbXVsYXRpb25zKVxyXG4gKi9cclxuXHJcbmltcG9ydCBCb29sZWFuUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9Cb29sZWFuUHJvcGVydHkuanMnO1xyXG5pbXBvcnQgTnVtYmVyUHJvcGVydHkgZnJvbSAnLi4vLi4vLi4vLi4vYXhvbi9qcy9OdW1iZXJQcm9wZXJ0eS5qcyc7XHJcbmltcG9ydCBQcm9wZXJ0eSBmcm9tICcuLi8uLi8uLi8uLi9heG9uL2pzL1Byb3BlcnR5LmpzJztcclxuaW1wb3J0IE1hdHJpeCBmcm9tICcuLi8uLi8uLi8uLi9kb3QvanMvTWF0cml4LmpzJztcclxuaW1wb3J0IFJhbmdlIGZyb20gJy4uLy4uLy4uLy4uL2RvdC9qcy9SYW5nZS5qcyc7XHJcbmltcG9ydCBWaXNpYmxlQ29sb3IgZnJvbSAnLi4vLi4vLi4vLi4vc2NlbmVyeS1waGV0L2pzL1Zpc2libGVDb2xvci5qcyc7XHJcbmltcG9ydCBXYXZlSW50ZXJmZXJlbmNlQ29uc3RhbnRzIGZyb20gJy4uLy4uL2NvbW1vbi9XYXZlSW50ZXJmZXJlbmNlQ29uc3RhbnRzLmpzJztcclxuaW1wb3J0IHdhdmVJbnRlcmZlcmVuY2UgZnJvbSAnLi4vLi4vd2F2ZUludGVyZmVyZW5jZS5qcyc7XHJcbmltcG9ydCBDaXJjbGVTcXVhcmVTY2VuZSBmcm9tICcuL0NpcmNsZVNxdWFyZVNjZW5lLmpzJztcclxuaW1wb3J0IERpc29yZGVyU2NlbmUgZnJvbSAnLi9EaXNvcmRlclNjZW5lLmpzJztcclxuaW1wb3J0IEVsbGlwc2VTY2VuZSBmcm9tICcuL0VsbGlwc2VTY2VuZS5qcyc7XHJcbmltcG9ydCBSZWN0YW5nbGVTY2VuZSBmcm9tICcuL1JlY3RhbmdsZVNjZW5lLmpzJztcclxuaW1wb3J0IFdhdmluZ0dpcmxTY2VuZSBmcm9tICcuL1dhdmluZ0dpcmxTY2VuZS5qcyc7XHJcbmltcG9ydCBUTW9kZWwgZnJvbSAnLi4vLi4vLi4vLi4vam9pc3QvanMvVE1vZGVsLmpzJztcclxuXHJcbi8vIGNvbnN0YW50c1xyXG5jb25zdCBDT05UUkFTVCA9IDAuMDE7XHJcbmNvbnN0IE1BVFJJWF9ESU1FTlNJT04gPSBXYXZlSW50ZXJmZXJlbmNlQ29uc3RhbnRzLkRJRkZSQUNUSU9OX01BVFJJWF9ESU1FTlNJT047XHJcblxyXG4vLyBwcmVhbGxvY2F0ZWQgdG8gYXZvaWQgZ2VuZXJhdGluZyBnYXJiYWdlXHJcbmNvbnN0IFNISUZURURfTUFHTklUVURFUyA9IG5ldyBBcnJheSggTUFUUklYX0RJTUVOU0lPTiAqIE1BVFJJWF9ESU1FTlNJT04gKTtcclxuY29uc3QgSU1BR0lOQVJZX1BBUlQgPSBuZXcgQXJyYXkoIE1BVFJJWF9ESU1FTlNJT04gKiBNQVRSSVhfRElNRU5TSU9OICk7XHJcbmNvbnN0IFJFQUxfUEFSVCA9IG5ldyBBcnJheSggTUFUUklYX0RJTUVOU0lPTiAqIE1BVFJJWF9ESU1FTlNJT04gKTtcclxuXHJcbi8vIGluaXRpYWxpemF0aW9uIGZvciAzcmQgcGFydHkgbGlicmFyeVxyXG5GRlQuaW5pdCggTUFUUklYX0RJTUVOU0lPTiApO1xyXG5cclxuY2xhc3MgRGlmZnJhY3Rpb25Nb2RlbCBpbXBsZW1lbnRzIFRNb2RlbCB7XHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG5cclxuICAgIC8vIEBwdWJsaWMgLSB3aGV0aGVyIHRoZSBsYXNlciBpcyBlbWl0dGluZyBsaWdodFxyXG4gICAgdGhpcy5vblByb3BlcnR5ID0gbmV3IEJvb2xlYW5Qcm9wZXJ0eSggZmFsc2UgKTtcclxuXHJcbiAgICAvLyBAcHVibGljIC0gdGhlIHdhdmVsZW5ndGggb2YgdGhlIGxhc2VyIGluIG5tXHJcbiAgICB0aGlzLndhdmVsZW5ndGhQcm9wZXJ0eSA9IG5ldyBOdW1iZXJQcm9wZXJ0eSggV2F2ZUludGVyZmVyZW5jZUNvbnN0YW50cy5ERUZBVUxUX1dBVkVMRU5HVEgsIHtcclxuICAgICAgcmFuZ2U6IG5ldyBSYW5nZSggVmlzaWJsZUNvbG9yLk1JTl9XQVZFTEVOR1RILCBWaXNpYmxlQ29sb3IuTUFYX1dBVkVMRU5HVEggKSxcclxuICAgICAgdW5pdHM6ICdubSdcclxuICAgIH0gKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIC0gc2NlbmVzXHJcbiAgICB0aGlzLmVsbGlwc2VTY2VuZSA9IG5ldyBFbGxpcHNlU2NlbmUoKTtcclxuICAgIHRoaXMucmVjdGFuZ2xlU2NlbmUgPSBuZXcgUmVjdGFuZ2xlU2NlbmUoKTtcclxuICAgIHRoaXMuY2lyY2xlU3F1YXJlU2NlbmUgPSBuZXcgQ2lyY2xlU3F1YXJlU2NlbmUoKTtcclxuICAgIHRoaXMuZGlzb3JkZXJTY2VuZSA9IG5ldyBEaXNvcmRlclNjZW5lKCk7XHJcbiAgICB0aGlzLndhdmluZ0dpcmxTY2VuZSA9IG5ldyBXYXZpbmdHaXJsU2NlbmUoKTtcclxuXHJcbiAgICAvLyBAcHVibGljIChyZWFkLW9ubHkpIHtEaWZmcmFjdGlvblNjZW5lW119XHJcbiAgICB0aGlzLnNjZW5lcyA9IFtcclxuICAgICAgdGhpcy5lbGxpcHNlU2NlbmUsXHJcbiAgICAgIHRoaXMucmVjdGFuZ2xlU2NlbmUsXHJcbiAgICAgIHRoaXMuY2lyY2xlU3F1YXJlU2NlbmUsXHJcbiAgICAgIHRoaXMuZGlzb3JkZXJTY2VuZSxcclxuICAgICAgdGhpcy53YXZpbmdHaXJsU2NlbmVcclxuICAgIF07XHJcblxyXG4gICAgLy8gQHB1YmxpYyAtIHNlbGVjdGVkIGFwZXJ0dXJlIHR5cGUsIHdoaWNoIGlzIGluIGVzc2VuY2UgdGhlIFwic2NlbmVcIiBmb3IgdGhpcyBzY3JlZW4uXHJcbiAgICB0aGlzLnNjZW5lUHJvcGVydHkgPSBuZXcgUHJvcGVydHkoIHRoaXMuZWxsaXBzZVNjZW5lLCB7XHJcbiAgICAgIHZhbGlkVmFsdWVzOiB0aGlzLnNjZW5lc1xyXG4gICAgfSApO1xyXG5cclxuICAgIC8vIEBwdWJsaWMgLSBUaGUgZGlzcGxheWVkIGFwZXJ0dXJlLCBzaGFyZWQgYnkgYWxsIHNjZW5lc1xyXG4gICAgdGhpcy5hcGVydHVyZU1hdHJpeCA9IG5ldyBNYXRyaXgoIE1BVFJJWF9ESU1FTlNJT04sIE1BVFJJWF9ESU1FTlNJT04gKTtcclxuXHJcbiAgICAvLyBAcHJpdmF0ZSAtIFRyYW5zZm9ybWVkIGFwZXJ0dXJlIHRvIGFjY291bnQgZm9yIHdhdmVsZW5ndGggY2hhbmdlcyBmb3IgdGhlIEZGVCwgc2hhcmVkIGJ5IGFsbCBzY2VuZXNcclxuICAgIHRoaXMuc2NhbGVkQXBlcnR1cmVNYXRyaXggPSBuZXcgTWF0cml4KCBNQVRSSVhfRElNRU5TSU9OLCBNQVRSSVhfRElNRU5TSU9OICk7XHJcblxyXG4gICAgLy8gQHB1YmxpYyAtIFJlc3VsdCBvZiBGRlQgb24gdGhlIHNjYWxlZEFwZXJ0dXJlTWF0cml4LCBzaGFyZWQgYnkgYWxsIHNjZW5lc1xyXG4gICAgdGhpcy5kaWZmcmFjdGlvbk1hdHJpeCA9IG5ldyBNYXRyaXgoIE1BVFJJWF9ESU1FTlNJT04sIE1BVFJJWF9ESU1FTlNJT04gKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFVwZGF0ZSB0aGUgYXBlcnR1cmUgYW5kIEZGVCByZXN1bHQgd2hlbiBtb2RlbCBjaGFyYWN0ZXJpc3RpY3MgY2hhbmdlLlxyXG4gICAgICovXHJcbiAgICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7XHJcblxyXG4gICAgICAvLyBUbyBnaXZlIHRoZSBhcHBlYXJhbmNlIG9mIHRoZSBwcm9wZXIgZGlmZnJhY3Rpb24sIHdlIHNjYWxlIHRoZSBhcGVydHVyZSBzaXplIGJlZm9yZSB0aGUgRkZUXHJcbiAgICAgIGNvbnN0IHNjYWxlRmFjdG9yID0gV2F2ZUludGVyZmVyZW5jZUNvbnN0YW50cy5ERUZBVUxUX1dBVkVMRU5HVEggLyB0aGlzLndhdmVsZW5ndGhQcm9wZXJ0eS52YWx1ZTtcclxuICAgICAgY29uc3Qgc2NlbmUgPSB0aGlzLnNjZW5lUHJvcGVydHkudmFsdWU7XHJcblxyXG4gICAgICAvLyBDb21wdXRlIHRoZSBhcGVydHVyZSB0aGF0IHdpbGwgYmUgcmVuZGVyZWRcclxuICAgICAgc2NlbmUucGFpbnRNYXRyaXgoIHRoaXMuYXBlcnR1cmVNYXRyaXgsIDEgKTtcclxuXHJcbiAgICAgIC8vIENvbXB1dGUgdGhlIGFwZXJ0dXJlIHRoYXQgd2lsbCBiZSBGRlQnZWRcclxuICAgICAgc2NlbmUucGFpbnRNYXRyaXgoIHRoaXMuc2NhbGVkQXBlcnR1cmVNYXRyaXgsIHNjYWxlRmFjdG9yICk7XHJcblxyXG4gICAgICBpZiAoIHRoaXMub25Qcm9wZXJ0eS52YWx1ZSApIHtcclxuICAgICAgICBmZnRJbWFnZVByb2Nlc3NpbmdMYWJzKCB0aGlzLnNjYWxlZEFwZXJ0dXJlTWF0cml4LCB0aGlzLmRpZmZyYWN0aW9uTWF0cml4ICk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdGhpcy5kaWZmcmFjdGlvbk1hdHJpeC50aW1lc0VxdWFscyggMCApO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgdGhpcy5zY2VuZXMuZm9yRWFjaCggc2NlbmUgPT4gc2NlbmUubGlua1RvQWxsUHJvcGVydGllcyggdXBkYXRlICkgKTtcclxuICAgIHRoaXMuc2NlbmVQcm9wZXJ0eS5saW5rKCB1cGRhdGUgKTtcclxuICAgIHRoaXMud2F2ZWxlbmd0aFByb3BlcnR5LmxpbmsoIHVwZGF0ZSApO1xyXG4gICAgdGhpcy5vblByb3BlcnR5LmxpbmsoIHVwZGF0ZSApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdG9yZSBpbml0aWFsIGNvbmRpdGlvbnMuXHJcbiAgICovXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY2VuZXMuZm9yRWFjaCggc2NlbmUgPT4gc2NlbmUucmVzZXQoKSApO1xyXG4gICAgdGhpcy5vblByb3BlcnR5LnJlc2V0KCk7XHJcbiAgICB0aGlzLnNjZW5lUHJvcGVydHkucmVzZXQoKTtcclxuICAgIHRoaXMud2F2ZWxlbmd0aFByb3BlcnR5LnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RlcCggZHQ6IG51bWJlciApOiB2b2lkIHtcclxuXHJcbiAgICAvLyBNb2RlbCBpcyBzdGF0aWNcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHaXZlbiByb3cvY29sdW1uIGluZGljZXMsIGZpbmQgdGhlIGluZGV4IGluIHRoZSBmbGF0dGVuZWQgYXJyYXkuICBVc2VzIHRoZSBzYW1lIHN0cmF0ZWd5IGFzIERPVC9NYXRyaXguXHJcbiAqIEBwYXJhbSBpIC0gcm93IGluZGV4XHJcbiAqIEBwYXJhbSBqIC0gY29sdW1uIGluZGV4XHJcbiAqL1xyXG5jb25zdCBnZXRJbmRleCA9ICggaTogbnVtYmVyLCBqOiBudW1iZXIgKTogbnVtYmVyID0+IHtcclxuICByZXR1cm4gaSAqIE1BVFJJWF9ESU1FTlNJT04gKyBqO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIENvbXB1dGVzIHRoZSAyRCBkaXNjcmV0ZSBmb3VyaWVyIHRyYW5zZm9ybSBvZiB0aGUgYXBlcnR1cmUsIHdoaWNoIHdpbGwgYmUgZGlzcGxheWVkIGFzIHRoZSBkaWZmcmFjdGlvbiBwYXR0ZXJuLlxyXG4gKiBUaGlzIG1ldGhvZCB1c2VzIGEgM3JkIHBhcnR5IGxpYnJhcnkgZm9yIGNvbXB1dGluZyB0aGUgRkZULiAgSW4gcG9zdHByb2Nlc3Npbmcgc3RlcHMsIGl0XHJcbiAqIChhKSBpdCBzd2FwcyB0aGUgcXVhZHJhbnRzIHRvIHB1dCB0aGUgbG93IGZyZXF1ZW5jaWVzIGluIHRoZSBjZW50ZXIuXHJcbiAqIChiKSBzaG93cyB0aGUgbG9nIG9mIHRoZSBtYWduaXR1ZGVzIGluc3RlYWQgb2YgdGhlIHJhdyBmcmVxdWVuY2llcyB0byBoYXZlIGJldHRlciBmaWRlbGl0eVxyXG4gKiBzZWUgaHR0cHM6Ly93d3cuY3MuY211LmVkdS9hZnMvYW5kcmV3L3Njcy9jcy8xNS00NjMvMjAwMS9wdWIvd3d3L25vdGVzL2ZvdXJpZXIvZm91cmllci5wZGZcclxuICogQHBhcmFtIGlucHV0IC0gYXBlcnR1cmUgbWF0cml4XHJcbiAqIEBwYXJhbSBvdXRwdXQgLSBwbGFjZSB0byBzZXQgZmZ0IHJlc3VsdCB2YWx1ZXNcclxuICovXHJcbmNvbnN0IGZmdEltYWdlUHJvY2Vzc2luZ0xhYnMgPSAoIGlucHV0LCBvdXRwdXQgKSA9PiB7XHJcblxyXG4gIC8vIFRha2UgdGhlIHZhbHVlcyBmcm9tIHRoZSBhcGVydHVyZVxyXG4gIGZvciAoIGxldCBpID0gMDsgaSA8IGlucHV0LmVudHJpZXMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICBSRUFMX1BBUlRbIGkgXSA9IGlucHV0LmVudHJpZXNbIGkgXTtcclxuICAgIElNQUdJTkFSWV9QQVJUWyBpIF0gPSAwO1xyXG4gIH1cclxuXHJcbiAgLy8gRkZUIGxpYnJhcnkgcGVyZm9ybXMgaW4tcGxhY2UgY29tcHV0YXRpb24uICBSZXN1bHQgb3ZlcndyaXRlcyB0aGUgaW5wdXQuXHJcbiAgRkZULmZmdDJkKCBSRUFMX1BBUlQsIElNQUdJTkFSWV9QQVJUICk7XHJcblxyXG4gIC8vIEZyb20gaHR0cHM6Ly93d3cuY3MuY211LmVkdS9hZnMvYW5kcmV3L3Njcy9jcy8xNS00NjMvMjAwMS9wdWIvd3d3L25vdGVzL2ZvdXJpZXIvZm91cmllci5wZGZcclxuICAvLyBQcmFjdGljYWwgaXNzdWVzOiBGb3IgZGlzcGxheSBwdXJwb3NlcywgeW91IHByb2JhYmx5IHdhbnQgdG8gY3ljbGljYWxseSB0cmFuc2xhdGUgdGhlIHBpY3R1cmUgc28gdGhhdCBwaXhlbCAoMCwwKVxyXG4gIC8vIHdoaWNoIG5vdyBjb250YWlucyBmcmVxdWVuY3kgKM+JeCwgz4l5ICkgPSAoMCwgMCksIG1vdmVzIHRvIHRoZSBjZW50ZXIgb2YgdGhlIGltYWdlLiBBbmQgeW91IHByb2JhYmx5IHdhbnQgdG9cclxuICAvLyBkaXNwbGF5IHBpeGVsIHZhbHVlcyBwcm9wb3J0aW9uYWwgdG8gbG9nKG1hZ25pdHVkZSkgb2YgZWFjaCBjb21wbGV4IG51bWJlciAodGhpcyBsb29rcyBtb3JlIGludGVyZXN0aW5nIHRoYW4ganVzdFxyXG4gIC8vIG1hZ25pdHVkZSkuIEZvciBjb2xvciBpbWFnZXMsIGRvIHRoZSBhYm92ZSB0byBlYWNoIG9mIHRoZSB0aHJlZSBjaGFubmVscyAoUiwgRywgYW5kIEIpIGluZGVwZW5kZW50bHkuXHJcbiAgZm9yICggbGV0IHJvdyA9IDA7IHJvdyA8IE1BVFJJWF9ESU1FTlNJT047IHJvdysrICkge1xyXG4gICAgZm9yICggbGV0IGNvbCA9IDA7IGNvbCA8IE1BVFJJWF9ESU1FTlNJT047IGNvbCsrICkge1xyXG4gICAgICBjb25zdCBzb3VyY2UgPSBnZXRJbmRleCggcm93LCBjb2wgKTtcclxuICAgICAgY29uc3QgZGVzdGluYXRpb24gPSBnZXRJbmRleChcclxuICAgICAgICAoIHJvdyArIE1BVFJJWF9ESU1FTlNJT04gLyAyICkgJSBNQVRSSVhfRElNRU5TSU9OLFxyXG4gICAgICAgICggY29sICsgTUFUUklYX0RJTUVOU0lPTiAvIDIgKSAlIE1BVFJJWF9ESU1FTlNJT05cclxuICAgICAgKTtcclxuICAgICAgU0hJRlRFRF9NQUdOSVRVREVTWyBkZXN0aW5hdGlvbiBdID0gTWF0aC5zcXJ0KCBSRUFMX1BBUlRbIHNvdXJjZSBdICogUkVBTF9QQVJUWyBzb3VyY2UgXSArIElNQUdJTkFSWV9QQVJUWyBzb3VyY2UgXSAqIElNQUdJTkFSWV9QQVJUWyBzb3VyY2UgXSApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gU2V0IHZhbHVlcyB0byB0aGUgb3V0cHV0IE1hdHJpeFxyXG4gIGNvbnN0IG1heE1hZ25pdHVkZSA9IF8ubWF4KCBTSElGVEVEX01BR05JVFVERVMgKTtcclxuICBjb25zdCBsb2dPZk1heE1hZyA9IE1hdGgubG9nKCBDT05UUkFTVCAqIG1heE1hZ25pdHVkZSArIDEgKTtcclxuICBmb3IgKCBsZXQgaSA9IDA7IGkgPCBTSElGVEVEX01BR05JVFVERVMubGVuZ3RoOyBpKysgKSB7XHJcbiAgICBvdXRwdXQuZW50cmllc1sgaSBdID0gTWF0aC5sb2coIENPTlRSQVNUICogU0hJRlRFRF9NQUdOSVRVREVTWyBpIF0gKyAxICkgLyBsb2dPZk1heE1hZztcclxuICB9XHJcbn07XHJcblxyXG53YXZlSW50ZXJmZXJlbmNlLnJlZ2lzdGVyKCAnRGlmZnJhY3Rpb25Nb2RlbCcsIERpZmZyYWN0aW9uTW9kZWwgKTtcclxuZXhwb3J0IGRlZmF1bHQgRGlmZnJhY3Rpb25Nb2RlbDsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE9BQU9BLGVBQWUsTUFBTSx3Q0FBd0M7QUFDcEUsT0FBT0MsY0FBYyxNQUFNLHVDQUF1QztBQUNsRSxPQUFPQyxRQUFRLE1BQU0saUNBQWlDO0FBQ3RELE9BQU9DLE1BQU0sTUFBTSw4QkFBOEI7QUFDakQsT0FBT0MsS0FBSyxNQUFNLDZCQUE2QjtBQUMvQyxPQUFPQyxZQUFZLE1BQU0sNkNBQTZDO0FBQ3RFLE9BQU9DLHlCQUF5QixNQUFNLDJDQUEyQztBQUNqRixPQUFPQyxnQkFBZ0IsTUFBTSwyQkFBMkI7QUFDeEQsT0FBT0MsaUJBQWlCLE1BQU0sd0JBQXdCO0FBQ3RELE9BQU9DLGFBQWEsTUFBTSxvQkFBb0I7QUFDOUMsT0FBT0MsWUFBWSxNQUFNLG1CQUFtQjtBQUM1QyxPQUFPQyxjQUFjLE1BQU0scUJBQXFCO0FBQ2hELE9BQU9DLGVBQWUsTUFBTSxzQkFBc0I7QUFHbEQ7QUFDQSxNQUFNQyxRQUFRLEdBQUcsSUFBSTtBQUNyQixN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